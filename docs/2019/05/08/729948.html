<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>SpringCloud微服务如何优雅停机及源码分析   技术头条 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="SpringCloud微服务如何优雅停机及源码分析   技术头条" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="戳蓝字“CSDN云计算”关注我们哦！ 技术头条：干货、简洁、多维全面。更多云计算精华知识尽在眼前，get要点、solve难题，统统不在话下！ 作者：Trust_FreeDom 转自：码农沉思录 本文主要讨论的是微服务注册到Eureka注册中心，并使用Zuul网关负载访问的情况，如何停机可以使用户无感知。 方式一：kill -9 java进程id【不建议】 kill -9&nbsp;属于强杀进程，首先微服务正在执行的任务被强制中断了；其次，没有通过Eureka注册中心服务下线，Zuul网关作为Eureka Client仍保存这个服务的路由信息，会继续调用服务，Http请求返回500，后台异常是Connection refuse连接拒绝。 这种情况默认最长需要等待： 90s（微服务在Eureka Server上租约到期）+30s（Eureka Server服务列表刷新到只读缓存ReadOnlyMap的时间，Eureka Client默认读此缓存）+30s（Zuul作为Eureka Client默认每30秒拉取一次服务列表）+30s（Ribbon默认动态刷新其ServerList的时间间隔）= 180s，即 3分钟 总结： 此种方式既会导致正在执行中的任务无法执行完，又会导致服务没有从Eureka Server摘除，并给Eureka Client时间刷新到服务列表，导致了通过Zuul仍然调用已停掉服务报500错误的情况，不推荐。 方式二：kill -15 java进程id 或 直接使用/shutdown 端点【不建议】 kill 与/shutdown 的含义 首先，kill等于kill -15，根据man kill的描述信息 The command kill sends the specified signal to the specified process or process group. If no signal is specified, the TERM signal is sent. 即kill没有执行信号等同于TERM（终止，termination） 而kill -l查看信号编号与信号之间的关系，kill -15就是&nbsp;SIGTERM，TERM信号 给JVM进程发送TERM终止信号时，会调用其注册的 Shutdown Hook，当SpringBoot微服务启动时也注册了 Shutdown Hook 而直接调用/shutdown端点本质和使用 Shutdown Hook是一样的，所以无论是使用kill或&nbsp;kill -15，还是直接使用/shutdown端点，都会调用到JVM注册的Shutdown Hook 注意： 启用 /shutdown端点，需要如下配置 endpoints.shutdown.enabled = trueendpoints.shutdown.sensitive = false 所有问题都导向了 Shutdown Hook会执行什么？？ Spring注册的Shutdown Hook 通过查询项目组使用Runtime.getRuntime().addShutdownHook(Thread shutdownHook)的地方，发现ribbon注册了一些Shutdown Hook，但这不是我们这次关注的，我们关注的是Spring的应用上下文抽象类AbstractApplicationContext注册了针对整个Spring容器的Shutdown Hook，在执行Shutdown Hook时的逻辑在AbstractApplicationContext#doClose() //## org.springframework.context.support.AbstractApplicationContext#registerShutdownHook /** * Register a shutdown hook with the JVM runtime, closing this context * on JVM shutdown unless it has already been closed at that time. * &lt;p&gt;Delegates to {@code doClose()} for the actual closing procedure. * @see Runtime#addShutdownHook * @see #close() * @see #doClose() */@Overridepublic void registerShutdownHook() {if (this.shutdownHook == null) {// No shutdown hook registered yet.// 注册shutdownHook，线程真正调用的是 doClose()this.shutdownHook = new Thread() {@Overridepublic void run() { synchronized (startupShutdownMonitor) { doClose(); } } }; Runtime.getRuntime().addShutdownHook(this.shutdownHook); }}//## org.springframework.context.support.AbstractApplicationContext#doClose /** * Actually performs context closing: publishes a ContextClosedEvent and * destroys the singletons in the bean factory of this application context. * &lt;p&gt;Called by both {@code close()} and a JVM shutdown hook, if any. * @see org.springframework.context.event.ContextClosedEvent * @see #destroyBeans() * @see #close() * @see #registerShutdownHook() */protected void doClose() {if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) {if (logger.isInfoEnabled()) { logger.info(&quot;Closing &quot; + this); }// 注销注册的MBean LiveBeansView.unregisterApplicationContext(this);try {// Publish shutdown event.// 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑 publishEvent(new ContextClosedEvent(this)); }catch (Throwable ex) { logger.warn(&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;, ex); }// Stop all Lifecycle beans, to avoid delays during individual destruction.// 调用所有 Lifecycle bean 的 stop() 方法try { getLifecycleProcessor().onClose(); }catch (Throwable ex) { logger.warn(&quot;Exception thrown from LifecycleProcessor on context close&quot;, ex); }// Destroy all cached singletons in the context&#39;s BeanFactory.// 销毁所有单实例bean destroyBeans();// Close the state of this context itself. closeBeanFactory();// Let subclasses do some final clean-up if they wish...// 调用子类的 onClose() 方法，比如 EmbeddedWebApplicationContext#onClose() onClose();this.active.set(false); }} AbstractApplicationContext#doClose()&nbsp;的关键点在于 publishEvent(new ContextClosedEvent(this))： 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑 getLifecycleProcessor().onClose()： 调用所有 Lifecycle bean 的 stop() 方法 而ContextClosedEvent事件的Listener有很多，实现了Lifecycle生命周期接口的bean也很多，但其中我们只关心一个，即&nbsp;EurekaAutoServiceRegistration&nbsp;，它即监听了ContextClosedEvent事件，也实现了Lifecycle接口 EurekaAutoServiceRegistration的stop()事件 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaAutoServiceRegistrationpublic class EurekaAutoServiceRegistration implements AutoServiceRegistration, SmartLifecycle, Ordered {// lifecycle接口的 stop()@Overridepublic void stop() {this.serviceRegistry.deregister(this.registration);this.running.set(false); // 设置liffecycle的running标示为false } // ContextClosedEvent事件监听器@EventListener(ContextClosedEvent.class)public void onApplicationEvent(ContextClosedEvent event) {// register in case meta data changed stop(); } } 如上可以看到，EurekaAutoServiceRegistration中对 ContextClosedEvent事件 和 Lifecycle接口 的实现都调用了stop()方法，虽然都调用了stop()方法，但由于各种对于状态的判断导致不会重复执行，如 Lifecycle的running标示置为false，就不会调用到此Lifecycle#stop() EurekaServiceRegistry#deregister()方法包含将实例状态置为DOWN 和 EurekaClient#shutdown() 两个操作，其中状态置为DOWN一次后，下一次只要状态不变就不会触发状态复制请求；EurekaClient#shutdown() 之前也会判断AtomicBoolean isShutdown标志位 下面具体看看EurekaServiceRegistry#deregister()方法 EurekaServiceRegistry#deregister() 注销 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry#deregister@Overridepublic void deregister(EurekaRegistration reg) {if (reg.getApplicationInfoManager().getInfo() != null) {if (log.isInfoEnabled()) {log.info(&quot;Unregistering application &quot; + reg.getInstanceConfig().getAppname() + &quot; with eureka with status DOWN&quot;); }// 更改实例状态，会立即触发状态复制请求 reg.getApplicationInfoManager().setInstanceStatus(InstanceInfo.InstanceStatus.DOWN);//TODO: on deregister or on context shutdown// 关闭EurekaClient reg.getEurekaClient().shutdown(); }} 主要涉及两步： 更新Instance状态为 DOWN： 更新状态会触发StatusChangeListener监听器，状态复制器InstanceInfoReplicator会向Eureka Server发送状态更新请求。实际上状态更新和Eureka Client第一次注册时都是调用的DiscoveryClient.register()，都是发送POST /eureka/apps/appID请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上变成 EurekaClient.shutdown()： 整个Eureka Client的关闭操作包含以下几步 @PreDestroy@Overridepublic synchronized void shutdown() {if (isShutdown.compareAndSet(false, true)) { logger.info(&quot;Shutting down DiscoveryClient ...&quot;);// 1、注销所有 StatusChangeListenerif ( statusChangeListener != null &amp;&amp; applicationInfoManager != null) { applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId()); }// 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程） cancelScheduledTasks();// If APPINFO was registered// 3、向Eureka Server注销实例if (applicationInfoManager != null &amp;&amp; clientConfig.shouldRegisterWithEureka()) { applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN); unregister(); }// 4、各种shutdown关闭if (eurekaTransport != null) { eurekaTransport.shutdown(); } heartbeatStalenessMonitor.shutdown(); registryStalenessMonitor.shutdown(); logger.info(&quot;Completed shut down of DiscoveryClient&quot;); }} 其中应关注unregister()注销，其调用AbstractJerseyEurekaHttpClient#cancel()方法，向Eureka Server发送DELETE /eureka/v2/apps/appID/instanceID请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线 总结 使用kill、kill -15&nbsp;或&nbsp;/shutdown端点都会调用Shutdown Hook，触发Eureka Instance实例的注销操作，这一步是没有问题的，优雅下线的第一步就是从Eureka注册中心注销实例，但关键问题是shutdown操作除了注销Eureka实例，还会马上停止服务，而此时无论Eureka Server端，Zuul作为Eureka Client端都存在陈旧的缓存还未刷新，服务列表中仍然有注销下线的服务，通过zuul再次调用报500错误，后台是connection refuse连接拒绝异常，故不建议使用 另外，由于unregister注销操作涉及状态更新DOWN 和 注销下线 两步操作，且是分两个线程执行的，实际注销时，根据两个线程执行完成的先后顺序，最终在Eureka Server上体现的结果不同，但最终效果是相同的，经过一段时间的缓存刷新后，此服务实例不会再被调用 状态更新DOWN先结束，注销实例后结束： Eureka Server页面清除此服务实例信息 注销实例先结束，状态更新DOWN后结束： Eureka Server页面显示此服务实例状态为DOWN 方式三：/pause 端点【可用，但有缺陷】 /pause 端点 首先，启用/pause端点需要如下配置 endpoints.pause.enabled = trueendpoints.pause.sensitive = false PauseEndpoint是RestartEndPoint的内部类 //## Restart端点@ConfigurationProperties(&quot;endpoints.restart&quot;)@ManagedResourcepublic class RestartEndpoint extends AbstractEndpoint&lt;Boolean&gt;implements ApplicationListener&lt;ApplicationPreparedEvent&gt; { // Pause端点@ConfigurationProperties(&quot;endpoints&quot;)public class PauseEndpoint extends AbstractEndpoint&lt;Boolean&gt; {public PauseEndpoint() {super(&quot;pause&quot;, true, true); }@Overridepublic Boolean invoke() {if (isRunning()) { pause();return true; }return false; } } // 暂停操作@ManagedOperationpublic synchronized void pause() {if (this.context != null) {this.context.stop(); } }} 如上可见，/pause端点最终会调用Spring应用上下文的stop()方法 AbstractApplicationContext#stop() //## org.springframework.context.support.AbstractApplicationContext#stop@Overridepublic void stop() {// 1、所有实现Lifecycle生命周期接口 stop() getLifecycleProcessor().stop(); // 2、触发ContextStoppedEvent事件 publishEvent(new ContextStoppedEvent(this));} 查看源码，并没有发现有用的ContextStoppedEvent事件监听器，故stop的逻辑都在Lifecycle生命周期接口实现类的stop() 而getLifecycleProcessor().stop()&nbsp;与 方式二中shutdown调用的getLifecycleProcessor().doClose()&nbsp;内部逻辑都是一样的，都是调用了DefaultLifecycleProcessor#stopBeans()，进而调用Lifecycle接口实现类的stop()，如下 @Overridepublic void stop() { stopBeans();this.running = false;}@Overridepublic void onClose() { stopBeans();this.running = false;} 所以，执行/pause端点 和 shutdown时的其中一部分逻辑是一样的，依赖于EurekaServiceRegistry#deregister() 注销，会依次执行： 触发状态复制为DOWN，和Eureka Client注册上线register调用方法一样DiscoveryClient#register()，发送POST /eureka/apps/appID请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上实例状态变成DOWN 触发&nbsp;EurekaClient.shutdown 调用AbstractJerseyEurekaHttpClient#cancel()方法，向Eureka Server发送DELETE /eureka/v2/apps/appID/instanceID请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线 1、注销所有 StatusChangeListener 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程） 3、向Eureka Server注销实例 4、各种shutdown关闭 stop()执行完毕后，Eureka Server端当前实例状态是DOWN，还是下线，取决于 状态DOWN的复制线程 和 注销请求 哪个执行快 总结 /pause端点可以用于让服务从Eureka Server下线，且与shutdown不一样的是，其不会停止整个服务，导致整个服务不可用，只会做从Eureka Server注销的操作，最终在Eureka Server上体现的是&nbsp;服务下线&nbsp;或&nbsp;服务状态为DOWN，且eureka client相关的定时线程也都停止了，不会再被定时线程注册上线，所以可以在sleep一段时间，待服务实例下线被像Zuul这种Eureka Client刷新到，再停止微服务，就可以做到优雅下线（停止微服务的时候可以使用/shutdown端点&nbsp;或 直接暴利kill -9） 注意： 我实验的当前版本下，使用/pause端点下线服务后，无法使用/resume端点再次上线，即如果发版过程中想重新注册服务，只有重启微服务。且为了从Eureka Server下线服务，将整个Spring容器stop()，也有点“兴师动众” /resume端点无法让服务再次上线的原因是，虽然此端点会调用AbstractApplicationContext#start()&nbsp;--&gt;EurekaAutoServiceRegistration#start()&nbsp;--&gt;EurekaServiceRegistry#register()，但由于之前已经停止了Eureka Client的所有定时任务线程，比如状态复制 和 心跳线程，重新注册时虽然有maybeInitializeClient(eurekaRegistration)尝试重新启动EurekaClient，但并没有成功（估计是此版本的Bug），导致UP状态并没有发送给Eureka Server 可下线，无法重新上线 方式四：/service-registry 端点【可用，但有坑】 /service-registry 端点 首先，在我使用的版本&nbsp;/service-registry&nbsp;端点默认是启用的，但是是sensitive&nbsp;的，也就是需要认证才能访问 我试图找一个可以单独将/service-registry的sensitive置为false的方式，但在当前我用的版本没有找到，/service-registry端点是通过ServiceRegistryAutoConfiguration自动配置的&nbsp;ServiceRegistryEndpoint，而&nbsp;ServiceRegistryEndpoint这个MvcEndpoint的isSensitive()方法写死了返回true，并没有给可配置的地方或者自定义什么实现，然后在ManagementWebSecurityAutoConfiguration这个安全管理自动配置类中，将所有这些sensitive==true的通过Spring Security的httpSecurity.authorizeRequests().xxx.authenticated()设置为必须认证后才能访问，目前我找到只能通过&nbsp;management.security.enabled=false&nbsp;这种将所有端点都关闭认证的方式才可以无认证访问 # 无认证访问 /service-registry 端点management.security.enabled=false 更新远端实例状态 /service-registry端点的实现类是ServiceRegistryEndpoint，其暴露了两个RequestMapping，分别是GET 和 POST请求的/service-registry，GET请求的用于获取实例本地的status、overriddenStatus，POST请求的用于调用Eureka Server修改当前实例状态 @ManagedResource(description = &quot;Can be used to display and set the service instance status using the service registry&quot;)@SuppressWarnings(&quot;unchecked&quot;)public class ServiceRegistryEndpoint implements MvcEndpoint {private final ServiceRegistry serviceRegistry;private Registration registration;public ServiceRegistryEndpoint(ServiceRegistry&lt;?&gt; serviceRegistry) {this.serviceRegistry = serviceRegistry; }public void setRegistration(Registration registration) {this.registration = registration; }@RequestMapping(path = &quot;instance-status&quot;, method = RequestMethod.POST)@ResponseBody@ManagedOperationpublic ResponseEntity&lt;?&gt; setStatus(@RequestBody String status) { Assert.notNull(status, &quot;status may not by null&quot;);if (this.registration == null) {return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;no registration found&quot;); }this.serviceRegistry.setStatus(this.registration, status);return ResponseEntity.ok().build(); }@RequestMapping(path = &quot;instance-status&quot;, method = RequestMethod.GET)@ResponseBody@ManagedAttributepublic ResponseEntity getStatus() {if (this.registration == null) {return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;no registration found&quot;); }return ResponseEntity.ok().body(this.serviceRegistry.getStatus(this.registration)); }@Overridepublic String getPath() {return &quot;/service-registry&quot;; }@Overridepublic boolean isSensitive() {return true; }@Overridepublic Class&lt;? extends Endpoint&lt;?&gt;&gt; getEndpointType() {return null; }} 我们关注的肯定是POST请求的/service-registry，如上可以看到，其调用了EurekaServiceRegistry.setStatus()&nbsp;方法更新实例状态 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistrypublic class EurekaServiceRegistry implements ServiceRegistry&lt;EurekaRegistration&gt; { // 更新状态@Overridepublic void setStatus(EurekaRegistration registration, String status) { InstanceInfo info = registration.getApplicationInfoManager().getInfo();// 如果更新的status状态为CANCEL_OVERRIDE，调用EurekaClient.cancelOverrideStatus()//TODO: howto deal with delete properly?if (&quot;CANCEL_OVERRIDE&quot;.equalsIgnoreCase(status)) { registration.getEurekaClient().cancelOverrideStatus(info);return; }// 调用EurekaClient.setStatus()//TODO: howto deal with status types across discovery systems? InstanceInfo.InstanceStatus newStatus = InstanceInfo.InstanceStatus.toEnum(status); registration.getEurekaClient().setStatus(newStatus, info); } } EurekaServiceRegistry.setStatus()&nbsp;方法支持像Eureka Server发送两种请求，分别是通过&nbsp;EurekaClient.setStatus()&nbsp;和EurekaClient.cancelOverrideStatus()&nbsp;来支持的，下面分别分析： EurekaClient.setStatus()： 实际是发送&nbsp;PUT /eureka/apps/appID/instanceID/status?value=xxx到Eureka Server，这是注册中心对于&nbsp;Take instance out of service 实例下线&nbsp;而开放的Rest API，可以做到更新Eureka Server端的实例状态（status 和 overriddenstatus），一般会在发版部署时使用，让服务下线，更新为OUT_OF_SERVICE 由于overriddenstatus更新为了OUT_OF_SERVICE，故即使有&nbsp;心跳&nbsp;或&nbsp;UP状态复制，也不会改变其OUT_OF_SERVICE的状态，overriddenstatus覆盖状态就是为了避免服务下线后又被定时线程上线或更新状态而设计的，有很多所谓的 “覆盖策略” 也正是由于overriddenstatus覆盖状态无法被 心跳 和 UP状态复制（其实就是EurekaClient.register()）而影响，故在发版部署完新版本后，最好先调用Rest API清除overriddenstatus，再启动服务，如果直接启动服务，可能导致Server端仍是OUT_OF_SERVICE状态的问题 实验：&nbsp;更新状态为OUT_OF_SERVICE后，直接停服务，只有等到Server端服务租约到期下线后，再启动客户端上线才能成功注册并状态为UP；如果没等Server端下线服务不存在后就启动服务，注册上线后无法改变overriddenstatus==OUT_OF_SERVICE EurekaClient.cancelOverrideStatus()&nbsp;： 实际是发送&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status&nbsp;到Eureka Server，用于清除覆盖状态，其实官方给出的是&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status?value=UP，其中value=UP可选，是删除overriddenstatus为UNKNOWN之后，建议status回滚为什么状态，但我当前使用版本里没有这个&nbsp;value=UP可选参数，就导致发送后，Eureka Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN，但UNKNOWN覆盖状态不同的事，虽然心跳线程仍对其无作用，但注册（等同于UP状态更新）是可以让服务上线的 总结 /service-registry端点可以更新服务实例状态为 OUT_OF_SERVICE，再经过一段Server端、Client端缓存的刷新，使得服务不会再被调用，此时再通过/shutdown端点 或 暴利的kill -9&nbsp;停止服务进程，可以达到优雅下线的效果 如希望回滚，可以通过几种方式 还是/service-registry端点，只不过状态为 CANCEL_OVERRIDE，具体逻辑在&nbsp;EurekaServiceRegistry.setStatus()&nbsp;中，其等同于直接调用Eureka Server API ：&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status，可以让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN 也可以用&nbsp;/service-registry端点，状态为UP，可使得Server端 status=UP且 overriddenstatus=UP，虽然可以临时起到上线目的，但 overriddenstatus=UP 仍需要上一步的DELETE请求才能清楚，很麻烦，不建议使用 不通过Eureka Client的端点，直接调用Eureka Server端点：&nbsp;DELETE /eureka/apps/appID/instanceID/status?value=UP 实际使用过程中建议如下顺序 缓存刷新时间&nbsp;指的是Eureka Server刷新只读缓存、Eureka Client刷新本地服务列表、Ribbon刷新ServerList的时间，默认都是30s，可以适当缩短缓存刷新时间 # Eureka Server端配置eureka.server.responseCacheUpdateIntervalMs=5000eureka.server.eviction-interval-timer-in-ms=5000# Eureka Client端配置eureka.client.registryFetchIntervalSeconds=5ribbon.ServerListRefreshInterval=5000 单个请求处理时间&nbsp;是为了怕服务还有请求没处理完 1、调用/service-registry端点将状态置为 OUT_OF_SERVICE 2、sleep 缓存刷新时间 + 单个请求处理时间 3、调用&nbsp;/service-registry端点将状态置为 CANCEL_OVERRIDE，其实就是向Server端发送DELETE overriddenstatus的请求，这会让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN 4、使用&nbsp;/shutdown端点 或 暴利kill -9终止服务 5、发版部署后，启动服务注册到Eureka Server，服务状态变为UP 方式五： 直接调用Eureka Server Rest API【可用，但URL比较复杂】 上面说了这么多，其实这些都是针对Eureka Server Rest API在Eureka客户端上的封装，即通过Eureka Client服务由于引入了actuator，增加了一系列端点，其实一些端点通过调用Eureka Server暴露的Rest API的方式实现Eureka实例服务下线功能 Eureka Rest API包括： 其中大多数非查询类的操作在之前分析Eureka Client的端点时都分析过了，其实调用Eureka Server的Rest API是最直接的，但由于目前多采用一些类似Jenkins的发版部署工具，其中操作均在脚本中执行，Eureka Server API虽好，但URL中都涉及appID&nbsp;、instanceID，对于制作通用的脚本来说拼接出调用端点的URL有一定难度，且不像调用本地服务端点IP使用localhost 或 127.0.0.1即可，需要指定Eureka Server地址，所以整理略显复杂。不过在比较规范化的公司中，也是不错的选择。 &nbsp; 福利 扫描添加小编微信，备注“姓名+公司职位”，加入【云计算学习交流群】，和志同道合的朋友们共同打卡学习！ 推荐阅读： 太形象了！什么是边缘计算？最有趣的解释没有之一！ 互联网出海十年 华为员工年薪 200 万！真相让人心酸！ 天才程序员：25 岁进贝尔实验室，32 岁创建信息论 &nbsp;琥珀 &nbsp;极客宝宝 &nbsp;5天前 安全顾问反水成黑客, 靠瞎猜盗得5000万美元的以太币, 一个区块链大盗的另类传奇 人造器官新突破！美国科学家3D打印出会“呼吸”的肺 | Science 真香，朕在看了！" />
<meta property="og:description" content="戳蓝字“CSDN云计算”关注我们哦！ 技术头条：干货、简洁、多维全面。更多云计算精华知识尽在眼前，get要点、solve难题，统统不在话下！ 作者：Trust_FreeDom 转自：码农沉思录 本文主要讨论的是微服务注册到Eureka注册中心，并使用Zuul网关负载访问的情况，如何停机可以使用户无感知。 方式一：kill -9 java进程id【不建议】 kill -9&nbsp;属于强杀进程，首先微服务正在执行的任务被强制中断了；其次，没有通过Eureka注册中心服务下线，Zuul网关作为Eureka Client仍保存这个服务的路由信息，会继续调用服务，Http请求返回500，后台异常是Connection refuse连接拒绝。 这种情况默认最长需要等待： 90s（微服务在Eureka Server上租约到期）+30s（Eureka Server服务列表刷新到只读缓存ReadOnlyMap的时间，Eureka Client默认读此缓存）+30s（Zuul作为Eureka Client默认每30秒拉取一次服务列表）+30s（Ribbon默认动态刷新其ServerList的时间间隔）= 180s，即 3分钟 总结： 此种方式既会导致正在执行中的任务无法执行完，又会导致服务没有从Eureka Server摘除，并给Eureka Client时间刷新到服务列表，导致了通过Zuul仍然调用已停掉服务报500错误的情况，不推荐。 方式二：kill -15 java进程id 或 直接使用/shutdown 端点【不建议】 kill 与/shutdown 的含义 首先，kill等于kill -15，根据man kill的描述信息 The command kill sends the specified signal to the specified process or process group. If no signal is specified, the TERM signal is sent. 即kill没有执行信号等同于TERM（终止，termination） 而kill -l查看信号编号与信号之间的关系，kill -15就是&nbsp;SIGTERM，TERM信号 给JVM进程发送TERM终止信号时，会调用其注册的 Shutdown Hook，当SpringBoot微服务启动时也注册了 Shutdown Hook 而直接调用/shutdown端点本质和使用 Shutdown Hook是一样的，所以无论是使用kill或&nbsp;kill -15，还是直接使用/shutdown端点，都会调用到JVM注册的Shutdown Hook 注意： 启用 /shutdown端点，需要如下配置 endpoints.shutdown.enabled = trueendpoints.shutdown.sensitive = false 所有问题都导向了 Shutdown Hook会执行什么？？ Spring注册的Shutdown Hook 通过查询项目组使用Runtime.getRuntime().addShutdownHook(Thread shutdownHook)的地方，发现ribbon注册了一些Shutdown Hook，但这不是我们这次关注的，我们关注的是Spring的应用上下文抽象类AbstractApplicationContext注册了针对整个Spring容器的Shutdown Hook，在执行Shutdown Hook时的逻辑在AbstractApplicationContext#doClose() //## org.springframework.context.support.AbstractApplicationContext#registerShutdownHook /** * Register a shutdown hook with the JVM runtime, closing this context * on JVM shutdown unless it has already been closed at that time. * &lt;p&gt;Delegates to {@code doClose()} for the actual closing procedure. * @see Runtime#addShutdownHook * @see #close() * @see #doClose() */@Overridepublic void registerShutdownHook() {if (this.shutdownHook == null) {// No shutdown hook registered yet.// 注册shutdownHook，线程真正调用的是 doClose()this.shutdownHook = new Thread() {@Overridepublic void run() { synchronized (startupShutdownMonitor) { doClose(); } } }; Runtime.getRuntime().addShutdownHook(this.shutdownHook); }}//## org.springframework.context.support.AbstractApplicationContext#doClose /** * Actually performs context closing: publishes a ContextClosedEvent and * destroys the singletons in the bean factory of this application context. * &lt;p&gt;Called by both {@code close()} and a JVM shutdown hook, if any. * @see org.springframework.context.event.ContextClosedEvent * @see #destroyBeans() * @see #close() * @see #registerShutdownHook() */protected void doClose() {if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) {if (logger.isInfoEnabled()) { logger.info(&quot;Closing &quot; + this); }// 注销注册的MBean LiveBeansView.unregisterApplicationContext(this);try {// Publish shutdown event.// 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑 publishEvent(new ContextClosedEvent(this)); }catch (Throwable ex) { logger.warn(&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;, ex); }// Stop all Lifecycle beans, to avoid delays during individual destruction.// 调用所有 Lifecycle bean 的 stop() 方法try { getLifecycleProcessor().onClose(); }catch (Throwable ex) { logger.warn(&quot;Exception thrown from LifecycleProcessor on context close&quot;, ex); }// Destroy all cached singletons in the context&#39;s BeanFactory.// 销毁所有单实例bean destroyBeans();// Close the state of this context itself. closeBeanFactory();// Let subclasses do some final clean-up if they wish...// 调用子类的 onClose() 方法，比如 EmbeddedWebApplicationContext#onClose() onClose();this.active.set(false); }} AbstractApplicationContext#doClose()&nbsp;的关键点在于 publishEvent(new ContextClosedEvent(this))： 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑 getLifecycleProcessor().onClose()： 调用所有 Lifecycle bean 的 stop() 方法 而ContextClosedEvent事件的Listener有很多，实现了Lifecycle生命周期接口的bean也很多，但其中我们只关心一个，即&nbsp;EurekaAutoServiceRegistration&nbsp;，它即监听了ContextClosedEvent事件，也实现了Lifecycle接口 EurekaAutoServiceRegistration的stop()事件 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaAutoServiceRegistrationpublic class EurekaAutoServiceRegistration implements AutoServiceRegistration, SmartLifecycle, Ordered {// lifecycle接口的 stop()@Overridepublic void stop() {this.serviceRegistry.deregister(this.registration);this.running.set(false); // 设置liffecycle的running标示为false } // ContextClosedEvent事件监听器@EventListener(ContextClosedEvent.class)public void onApplicationEvent(ContextClosedEvent event) {// register in case meta data changed stop(); } } 如上可以看到，EurekaAutoServiceRegistration中对 ContextClosedEvent事件 和 Lifecycle接口 的实现都调用了stop()方法，虽然都调用了stop()方法，但由于各种对于状态的判断导致不会重复执行，如 Lifecycle的running标示置为false，就不会调用到此Lifecycle#stop() EurekaServiceRegistry#deregister()方法包含将实例状态置为DOWN 和 EurekaClient#shutdown() 两个操作，其中状态置为DOWN一次后，下一次只要状态不变就不会触发状态复制请求；EurekaClient#shutdown() 之前也会判断AtomicBoolean isShutdown标志位 下面具体看看EurekaServiceRegistry#deregister()方法 EurekaServiceRegistry#deregister() 注销 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry#deregister@Overridepublic void deregister(EurekaRegistration reg) {if (reg.getApplicationInfoManager().getInfo() != null) {if (log.isInfoEnabled()) {log.info(&quot;Unregistering application &quot; + reg.getInstanceConfig().getAppname() + &quot; with eureka with status DOWN&quot;); }// 更改实例状态，会立即触发状态复制请求 reg.getApplicationInfoManager().setInstanceStatus(InstanceInfo.InstanceStatus.DOWN);//TODO: on deregister or on context shutdown// 关闭EurekaClient reg.getEurekaClient().shutdown(); }} 主要涉及两步： 更新Instance状态为 DOWN： 更新状态会触发StatusChangeListener监听器，状态复制器InstanceInfoReplicator会向Eureka Server发送状态更新请求。实际上状态更新和Eureka Client第一次注册时都是调用的DiscoveryClient.register()，都是发送POST /eureka/apps/appID请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上变成 EurekaClient.shutdown()： 整个Eureka Client的关闭操作包含以下几步 @PreDestroy@Overridepublic synchronized void shutdown() {if (isShutdown.compareAndSet(false, true)) { logger.info(&quot;Shutting down DiscoveryClient ...&quot;);// 1、注销所有 StatusChangeListenerif ( statusChangeListener != null &amp;&amp; applicationInfoManager != null) { applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId()); }// 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程） cancelScheduledTasks();// If APPINFO was registered// 3、向Eureka Server注销实例if (applicationInfoManager != null &amp;&amp; clientConfig.shouldRegisterWithEureka()) { applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN); unregister(); }// 4、各种shutdown关闭if (eurekaTransport != null) { eurekaTransport.shutdown(); } heartbeatStalenessMonitor.shutdown(); registryStalenessMonitor.shutdown(); logger.info(&quot;Completed shut down of DiscoveryClient&quot;); }} 其中应关注unregister()注销，其调用AbstractJerseyEurekaHttpClient#cancel()方法，向Eureka Server发送DELETE /eureka/v2/apps/appID/instanceID请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线 总结 使用kill、kill -15&nbsp;或&nbsp;/shutdown端点都会调用Shutdown Hook，触发Eureka Instance实例的注销操作，这一步是没有问题的，优雅下线的第一步就是从Eureka注册中心注销实例，但关键问题是shutdown操作除了注销Eureka实例，还会马上停止服务，而此时无论Eureka Server端，Zuul作为Eureka Client端都存在陈旧的缓存还未刷新，服务列表中仍然有注销下线的服务，通过zuul再次调用报500错误，后台是connection refuse连接拒绝异常，故不建议使用 另外，由于unregister注销操作涉及状态更新DOWN 和 注销下线 两步操作，且是分两个线程执行的，实际注销时，根据两个线程执行完成的先后顺序，最终在Eureka Server上体现的结果不同，但最终效果是相同的，经过一段时间的缓存刷新后，此服务实例不会再被调用 状态更新DOWN先结束，注销实例后结束： Eureka Server页面清除此服务实例信息 注销实例先结束，状态更新DOWN后结束： Eureka Server页面显示此服务实例状态为DOWN 方式三：/pause 端点【可用，但有缺陷】 /pause 端点 首先，启用/pause端点需要如下配置 endpoints.pause.enabled = trueendpoints.pause.sensitive = false PauseEndpoint是RestartEndPoint的内部类 //## Restart端点@ConfigurationProperties(&quot;endpoints.restart&quot;)@ManagedResourcepublic class RestartEndpoint extends AbstractEndpoint&lt;Boolean&gt;implements ApplicationListener&lt;ApplicationPreparedEvent&gt; { // Pause端点@ConfigurationProperties(&quot;endpoints&quot;)public class PauseEndpoint extends AbstractEndpoint&lt;Boolean&gt; {public PauseEndpoint() {super(&quot;pause&quot;, true, true); }@Overridepublic Boolean invoke() {if (isRunning()) { pause();return true; }return false; } } // 暂停操作@ManagedOperationpublic synchronized void pause() {if (this.context != null) {this.context.stop(); } }} 如上可见，/pause端点最终会调用Spring应用上下文的stop()方法 AbstractApplicationContext#stop() //## org.springframework.context.support.AbstractApplicationContext#stop@Overridepublic void stop() {// 1、所有实现Lifecycle生命周期接口 stop() getLifecycleProcessor().stop(); // 2、触发ContextStoppedEvent事件 publishEvent(new ContextStoppedEvent(this));} 查看源码，并没有发现有用的ContextStoppedEvent事件监听器，故stop的逻辑都在Lifecycle生命周期接口实现类的stop() 而getLifecycleProcessor().stop()&nbsp;与 方式二中shutdown调用的getLifecycleProcessor().doClose()&nbsp;内部逻辑都是一样的，都是调用了DefaultLifecycleProcessor#stopBeans()，进而调用Lifecycle接口实现类的stop()，如下 @Overridepublic void stop() { stopBeans();this.running = false;}@Overridepublic void onClose() { stopBeans();this.running = false;} 所以，执行/pause端点 和 shutdown时的其中一部分逻辑是一样的，依赖于EurekaServiceRegistry#deregister() 注销，会依次执行： 触发状态复制为DOWN，和Eureka Client注册上线register调用方法一样DiscoveryClient#register()，发送POST /eureka/apps/appID请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上实例状态变成DOWN 触发&nbsp;EurekaClient.shutdown 调用AbstractJerseyEurekaHttpClient#cancel()方法，向Eureka Server发送DELETE /eureka/v2/apps/appID/instanceID请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线 1、注销所有 StatusChangeListener 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程） 3、向Eureka Server注销实例 4、各种shutdown关闭 stop()执行完毕后，Eureka Server端当前实例状态是DOWN，还是下线，取决于 状态DOWN的复制线程 和 注销请求 哪个执行快 总结 /pause端点可以用于让服务从Eureka Server下线，且与shutdown不一样的是，其不会停止整个服务，导致整个服务不可用，只会做从Eureka Server注销的操作，最终在Eureka Server上体现的是&nbsp;服务下线&nbsp;或&nbsp;服务状态为DOWN，且eureka client相关的定时线程也都停止了，不会再被定时线程注册上线，所以可以在sleep一段时间，待服务实例下线被像Zuul这种Eureka Client刷新到，再停止微服务，就可以做到优雅下线（停止微服务的时候可以使用/shutdown端点&nbsp;或 直接暴利kill -9） 注意： 我实验的当前版本下，使用/pause端点下线服务后，无法使用/resume端点再次上线，即如果发版过程中想重新注册服务，只有重启微服务。且为了从Eureka Server下线服务，将整个Spring容器stop()，也有点“兴师动众” /resume端点无法让服务再次上线的原因是，虽然此端点会调用AbstractApplicationContext#start()&nbsp;--&gt;EurekaAutoServiceRegistration#start()&nbsp;--&gt;EurekaServiceRegistry#register()，但由于之前已经停止了Eureka Client的所有定时任务线程，比如状态复制 和 心跳线程，重新注册时虽然有maybeInitializeClient(eurekaRegistration)尝试重新启动EurekaClient，但并没有成功（估计是此版本的Bug），导致UP状态并没有发送给Eureka Server 可下线，无法重新上线 方式四：/service-registry 端点【可用，但有坑】 /service-registry 端点 首先，在我使用的版本&nbsp;/service-registry&nbsp;端点默认是启用的，但是是sensitive&nbsp;的，也就是需要认证才能访问 我试图找一个可以单独将/service-registry的sensitive置为false的方式，但在当前我用的版本没有找到，/service-registry端点是通过ServiceRegistryAutoConfiguration自动配置的&nbsp;ServiceRegistryEndpoint，而&nbsp;ServiceRegistryEndpoint这个MvcEndpoint的isSensitive()方法写死了返回true，并没有给可配置的地方或者自定义什么实现，然后在ManagementWebSecurityAutoConfiguration这个安全管理自动配置类中，将所有这些sensitive==true的通过Spring Security的httpSecurity.authorizeRequests().xxx.authenticated()设置为必须认证后才能访问，目前我找到只能通过&nbsp;management.security.enabled=false&nbsp;这种将所有端点都关闭认证的方式才可以无认证访问 # 无认证访问 /service-registry 端点management.security.enabled=false 更新远端实例状态 /service-registry端点的实现类是ServiceRegistryEndpoint，其暴露了两个RequestMapping，分别是GET 和 POST请求的/service-registry，GET请求的用于获取实例本地的status、overriddenStatus，POST请求的用于调用Eureka Server修改当前实例状态 @ManagedResource(description = &quot;Can be used to display and set the service instance status using the service registry&quot;)@SuppressWarnings(&quot;unchecked&quot;)public class ServiceRegistryEndpoint implements MvcEndpoint {private final ServiceRegistry serviceRegistry;private Registration registration;public ServiceRegistryEndpoint(ServiceRegistry&lt;?&gt; serviceRegistry) {this.serviceRegistry = serviceRegistry; }public void setRegistration(Registration registration) {this.registration = registration; }@RequestMapping(path = &quot;instance-status&quot;, method = RequestMethod.POST)@ResponseBody@ManagedOperationpublic ResponseEntity&lt;?&gt; setStatus(@RequestBody String status) { Assert.notNull(status, &quot;status may not by null&quot;);if (this.registration == null) {return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;no registration found&quot;); }this.serviceRegistry.setStatus(this.registration, status);return ResponseEntity.ok().build(); }@RequestMapping(path = &quot;instance-status&quot;, method = RequestMethod.GET)@ResponseBody@ManagedAttributepublic ResponseEntity getStatus() {if (this.registration == null) {return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;no registration found&quot;); }return ResponseEntity.ok().body(this.serviceRegistry.getStatus(this.registration)); }@Overridepublic String getPath() {return &quot;/service-registry&quot;; }@Overridepublic boolean isSensitive() {return true; }@Overridepublic Class&lt;? extends Endpoint&lt;?&gt;&gt; getEndpointType() {return null; }} 我们关注的肯定是POST请求的/service-registry，如上可以看到，其调用了EurekaServiceRegistry.setStatus()&nbsp;方法更新实例状态 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistrypublic class EurekaServiceRegistry implements ServiceRegistry&lt;EurekaRegistration&gt; { // 更新状态@Overridepublic void setStatus(EurekaRegistration registration, String status) { InstanceInfo info = registration.getApplicationInfoManager().getInfo();// 如果更新的status状态为CANCEL_OVERRIDE，调用EurekaClient.cancelOverrideStatus()//TODO: howto deal with delete properly?if (&quot;CANCEL_OVERRIDE&quot;.equalsIgnoreCase(status)) { registration.getEurekaClient().cancelOverrideStatus(info);return; }// 调用EurekaClient.setStatus()//TODO: howto deal with status types across discovery systems? InstanceInfo.InstanceStatus newStatus = InstanceInfo.InstanceStatus.toEnum(status); registration.getEurekaClient().setStatus(newStatus, info); } } EurekaServiceRegistry.setStatus()&nbsp;方法支持像Eureka Server发送两种请求，分别是通过&nbsp;EurekaClient.setStatus()&nbsp;和EurekaClient.cancelOverrideStatus()&nbsp;来支持的，下面分别分析： EurekaClient.setStatus()： 实际是发送&nbsp;PUT /eureka/apps/appID/instanceID/status?value=xxx到Eureka Server，这是注册中心对于&nbsp;Take instance out of service 实例下线&nbsp;而开放的Rest API，可以做到更新Eureka Server端的实例状态（status 和 overriddenstatus），一般会在发版部署时使用，让服务下线，更新为OUT_OF_SERVICE 由于overriddenstatus更新为了OUT_OF_SERVICE，故即使有&nbsp;心跳&nbsp;或&nbsp;UP状态复制，也不会改变其OUT_OF_SERVICE的状态，overriddenstatus覆盖状态就是为了避免服务下线后又被定时线程上线或更新状态而设计的，有很多所谓的 “覆盖策略” 也正是由于overriddenstatus覆盖状态无法被 心跳 和 UP状态复制（其实就是EurekaClient.register()）而影响，故在发版部署完新版本后，最好先调用Rest API清除overriddenstatus，再启动服务，如果直接启动服务，可能导致Server端仍是OUT_OF_SERVICE状态的问题 实验：&nbsp;更新状态为OUT_OF_SERVICE后，直接停服务，只有等到Server端服务租约到期下线后，再启动客户端上线才能成功注册并状态为UP；如果没等Server端下线服务不存在后就启动服务，注册上线后无法改变overriddenstatus==OUT_OF_SERVICE EurekaClient.cancelOverrideStatus()&nbsp;： 实际是发送&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status&nbsp;到Eureka Server，用于清除覆盖状态，其实官方给出的是&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status?value=UP，其中value=UP可选，是删除overriddenstatus为UNKNOWN之后，建议status回滚为什么状态，但我当前使用版本里没有这个&nbsp;value=UP可选参数，就导致发送后，Eureka Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN，但UNKNOWN覆盖状态不同的事，虽然心跳线程仍对其无作用，但注册（等同于UP状态更新）是可以让服务上线的 总结 /service-registry端点可以更新服务实例状态为 OUT_OF_SERVICE，再经过一段Server端、Client端缓存的刷新，使得服务不会再被调用，此时再通过/shutdown端点 或 暴利的kill -9&nbsp;停止服务进程，可以达到优雅下线的效果 如希望回滚，可以通过几种方式 还是/service-registry端点，只不过状态为 CANCEL_OVERRIDE，具体逻辑在&nbsp;EurekaServiceRegistry.setStatus()&nbsp;中，其等同于直接调用Eureka Server API ：&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status，可以让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN 也可以用&nbsp;/service-registry端点，状态为UP，可使得Server端 status=UP且 overriddenstatus=UP，虽然可以临时起到上线目的，但 overriddenstatus=UP 仍需要上一步的DELETE请求才能清楚，很麻烦，不建议使用 不通过Eureka Client的端点，直接调用Eureka Server端点：&nbsp;DELETE /eureka/apps/appID/instanceID/status?value=UP 实际使用过程中建议如下顺序 缓存刷新时间&nbsp;指的是Eureka Server刷新只读缓存、Eureka Client刷新本地服务列表、Ribbon刷新ServerList的时间，默认都是30s，可以适当缩短缓存刷新时间 # Eureka Server端配置eureka.server.responseCacheUpdateIntervalMs=5000eureka.server.eviction-interval-timer-in-ms=5000# Eureka Client端配置eureka.client.registryFetchIntervalSeconds=5ribbon.ServerListRefreshInterval=5000 单个请求处理时间&nbsp;是为了怕服务还有请求没处理完 1、调用/service-registry端点将状态置为 OUT_OF_SERVICE 2、sleep 缓存刷新时间 + 单个请求处理时间 3、调用&nbsp;/service-registry端点将状态置为 CANCEL_OVERRIDE，其实就是向Server端发送DELETE overriddenstatus的请求，这会让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN 4、使用&nbsp;/shutdown端点 或 暴利kill -9终止服务 5、发版部署后，启动服务注册到Eureka Server，服务状态变为UP 方式五： 直接调用Eureka Server Rest API【可用，但URL比较复杂】 上面说了这么多，其实这些都是针对Eureka Server Rest API在Eureka客户端上的封装，即通过Eureka Client服务由于引入了actuator，增加了一系列端点，其实一些端点通过调用Eureka Server暴露的Rest API的方式实现Eureka实例服务下线功能 Eureka Rest API包括： 其中大多数非查询类的操作在之前分析Eureka Client的端点时都分析过了，其实调用Eureka Server的Rest API是最直接的，但由于目前多采用一些类似Jenkins的发版部署工具，其中操作均在脚本中执行，Eureka Server API虽好，但URL中都涉及appID&nbsp;、instanceID，对于制作通用的脚本来说拼接出调用端点的URL有一定难度，且不像调用本地服务端点IP使用localhost 或 127.0.0.1即可，需要指定Eureka Server地址，所以整理略显复杂。不过在比较规范化的公司中，也是不错的选择。 &nbsp; 福利 扫描添加小编微信，备注“姓名+公司职位”，加入【云计算学习交流群】，和志同道合的朋友们共同打卡学习！ 推荐阅读： 太形象了！什么是边缘计算？最有趣的解释没有之一！ 互联网出海十年 华为员工年薪 200 万！真相让人心酸！ 天才程序员：25 岁进贝尔实验室，32 岁创建信息论 &nbsp;琥珀 &nbsp;极客宝宝 &nbsp;5天前 安全顾问反水成黑客, 靠瞎猜盗得5000万美元的以太币, 一个区块链大盗的另类传奇 人造器官新突破！美国科学家3D打印出会“呼吸”的肺 | Science 真香，朕在看了！" />
<link rel="canonical" href="https://mlh.app/2019/05/08/729948.html" />
<meta property="og:url" content="https://mlh.app/2019/05/08/729948.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-05-08T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"戳蓝字“CSDN云计算”关注我们哦！ 技术头条：干货、简洁、多维全面。更多云计算精华知识尽在眼前，get要点、solve难题，统统不在话下！ 作者：Trust_FreeDom 转自：码农沉思录 本文主要讨论的是微服务注册到Eureka注册中心，并使用Zuul网关负载访问的情况，如何停机可以使用户无感知。 方式一：kill -9 java进程id【不建议】 kill -9&nbsp;属于强杀进程，首先微服务正在执行的任务被强制中断了；其次，没有通过Eureka注册中心服务下线，Zuul网关作为Eureka Client仍保存这个服务的路由信息，会继续调用服务，Http请求返回500，后台异常是Connection refuse连接拒绝。 这种情况默认最长需要等待： 90s（微服务在Eureka Server上租约到期）+30s（Eureka Server服务列表刷新到只读缓存ReadOnlyMap的时间，Eureka Client默认读此缓存）+30s（Zuul作为Eureka Client默认每30秒拉取一次服务列表）+30s（Ribbon默认动态刷新其ServerList的时间间隔）= 180s，即 3分钟 总结： 此种方式既会导致正在执行中的任务无法执行完，又会导致服务没有从Eureka Server摘除，并给Eureka Client时间刷新到服务列表，导致了通过Zuul仍然调用已停掉服务报500错误的情况，不推荐。 方式二：kill -15 java进程id 或 直接使用/shutdown 端点【不建议】 kill 与/shutdown 的含义 首先，kill等于kill -15，根据man kill的描述信息 The command kill sends the specified signal to the specified process or process group. If no signal is specified, the TERM signal is sent. 即kill没有执行信号等同于TERM（终止，termination） 而kill -l查看信号编号与信号之间的关系，kill -15就是&nbsp;SIGTERM，TERM信号 给JVM进程发送TERM终止信号时，会调用其注册的 Shutdown Hook，当SpringBoot微服务启动时也注册了 Shutdown Hook 而直接调用/shutdown端点本质和使用 Shutdown Hook是一样的，所以无论是使用kill或&nbsp;kill -15，还是直接使用/shutdown端点，都会调用到JVM注册的Shutdown Hook 注意： 启用 /shutdown端点，需要如下配置 endpoints.shutdown.enabled = trueendpoints.shutdown.sensitive = false 所有问题都导向了 Shutdown Hook会执行什么？？ Spring注册的Shutdown Hook 通过查询项目组使用Runtime.getRuntime().addShutdownHook(Thread shutdownHook)的地方，发现ribbon注册了一些Shutdown Hook，但这不是我们这次关注的，我们关注的是Spring的应用上下文抽象类AbstractApplicationContext注册了针对整个Spring容器的Shutdown Hook，在执行Shutdown Hook时的逻辑在AbstractApplicationContext#doClose() //## org.springframework.context.support.AbstractApplicationContext#registerShutdownHook /** * Register a shutdown hook with the JVM runtime, closing this context * on JVM shutdown unless it has already been closed at that time. * &lt;p&gt;Delegates to {@code doClose()} for the actual closing procedure. * @see Runtime#addShutdownHook * @see #close() * @see #doClose() */@Overridepublic void registerShutdownHook() {if (this.shutdownHook == null) {// No shutdown hook registered yet.// 注册shutdownHook，线程真正调用的是 doClose()this.shutdownHook = new Thread() {@Overridepublic void run() { synchronized (startupShutdownMonitor) { doClose(); } } }; Runtime.getRuntime().addShutdownHook(this.shutdownHook); }}//## org.springframework.context.support.AbstractApplicationContext#doClose /** * Actually performs context closing: publishes a ContextClosedEvent and * destroys the singletons in the bean factory of this application context. * &lt;p&gt;Called by both {@code close()} and a JVM shutdown hook, if any. * @see org.springframework.context.event.ContextClosedEvent * @see #destroyBeans() * @see #close() * @see #registerShutdownHook() */protected void doClose() {if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) {if (logger.isInfoEnabled()) { logger.info(&quot;Closing &quot; + this); }// 注销注册的MBean LiveBeansView.unregisterApplicationContext(this);try {// Publish shutdown event.// 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑 publishEvent(new ContextClosedEvent(this)); }catch (Throwable ex) { logger.warn(&quot;Exception thrown from ApplicationListener handling ContextClosedEvent&quot;, ex); }// Stop all Lifecycle beans, to avoid delays during individual destruction.// 调用所有 Lifecycle bean 的 stop() 方法try { getLifecycleProcessor().onClose(); }catch (Throwable ex) { logger.warn(&quot;Exception thrown from LifecycleProcessor on context close&quot;, ex); }// Destroy all cached singletons in the context&#39;s BeanFactory.// 销毁所有单实例bean destroyBeans();// Close the state of this context itself. closeBeanFactory();// Let subclasses do some final clean-up if they wish...// 调用子类的 onClose() 方法，比如 EmbeddedWebApplicationContext#onClose() onClose();this.active.set(false); }} AbstractApplicationContext#doClose()&nbsp;的关键点在于 publishEvent(new ContextClosedEvent(this))： 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑 getLifecycleProcessor().onClose()： 调用所有 Lifecycle bean 的 stop() 方法 而ContextClosedEvent事件的Listener有很多，实现了Lifecycle生命周期接口的bean也很多，但其中我们只关心一个，即&nbsp;EurekaAutoServiceRegistration&nbsp;，它即监听了ContextClosedEvent事件，也实现了Lifecycle接口 EurekaAutoServiceRegistration的stop()事件 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaAutoServiceRegistrationpublic class EurekaAutoServiceRegistration implements AutoServiceRegistration, SmartLifecycle, Ordered {// lifecycle接口的 stop()@Overridepublic void stop() {this.serviceRegistry.deregister(this.registration);this.running.set(false); // 设置liffecycle的running标示为false } // ContextClosedEvent事件监听器@EventListener(ContextClosedEvent.class)public void onApplicationEvent(ContextClosedEvent event) {// register in case meta data changed stop(); } } 如上可以看到，EurekaAutoServiceRegistration中对 ContextClosedEvent事件 和 Lifecycle接口 的实现都调用了stop()方法，虽然都调用了stop()方法，但由于各种对于状态的判断导致不会重复执行，如 Lifecycle的running标示置为false，就不会调用到此Lifecycle#stop() EurekaServiceRegistry#deregister()方法包含将实例状态置为DOWN 和 EurekaClient#shutdown() 两个操作，其中状态置为DOWN一次后，下一次只要状态不变就不会触发状态复制请求；EurekaClient#shutdown() 之前也会判断AtomicBoolean isShutdown标志位 下面具体看看EurekaServiceRegistry#deregister()方法 EurekaServiceRegistry#deregister() 注销 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry#deregister@Overridepublic void deregister(EurekaRegistration reg) {if (reg.getApplicationInfoManager().getInfo() != null) {if (log.isInfoEnabled()) {log.info(&quot;Unregistering application &quot; + reg.getInstanceConfig().getAppname() + &quot; with eureka with status DOWN&quot;); }// 更改实例状态，会立即触发状态复制请求 reg.getApplicationInfoManager().setInstanceStatus(InstanceInfo.InstanceStatus.DOWN);//TODO: on deregister or on context shutdown// 关闭EurekaClient reg.getEurekaClient().shutdown(); }} 主要涉及两步： 更新Instance状态为 DOWN： 更新状态会触发StatusChangeListener监听器，状态复制器InstanceInfoReplicator会向Eureka Server发送状态更新请求。实际上状态更新和Eureka Client第一次注册时都是调用的DiscoveryClient.register()，都是发送POST /eureka/apps/appID请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上变成 EurekaClient.shutdown()： 整个Eureka Client的关闭操作包含以下几步 @PreDestroy@Overridepublic synchronized void shutdown() {if (isShutdown.compareAndSet(false, true)) { logger.info(&quot;Shutting down DiscoveryClient ...&quot;);// 1、注销所有 StatusChangeListenerif ( statusChangeListener != null &amp;&amp; applicationInfoManager != null) { applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId()); }// 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程） cancelScheduledTasks();// If APPINFO was registered// 3、向Eureka Server注销实例if (applicationInfoManager != null &amp;&amp; clientConfig.shouldRegisterWithEureka()) { applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN); unregister(); }// 4、各种shutdown关闭if (eurekaTransport != null) { eurekaTransport.shutdown(); } heartbeatStalenessMonitor.shutdown(); registryStalenessMonitor.shutdown(); logger.info(&quot;Completed shut down of DiscoveryClient&quot;); }} 其中应关注unregister()注销，其调用AbstractJerseyEurekaHttpClient#cancel()方法，向Eureka Server发送DELETE /eureka/v2/apps/appID/instanceID请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线 总结 使用kill、kill -15&nbsp;或&nbsp;/shutdown端点都会调用Shutdown Hook，触发Eureka Instance实例的注销操作，这一步是没有问题的，优雅下线的第一步就是从Eureka注册中心注销实例，但关键问题是shutdown操作除了注销Eureka实例，还会马上停止服务，而此时无论Eureka Server端，Zuul作为Eureka Client端都存在陈旧的缓存还未刷新，服务列表中仍然有注销下线的服务，通过zuul再次调用报500错误，后台是connection refuse连接拒绝异常，故不建议使用 另外，由于unregister注销操作涉及状态更新DOWN 和 注销下线 两步操作，且是分两个线程执行的，实际注销时，根据两个线程执行完成的先后顺序，最终在Eureka Server上体现的结果不同，但最终效果是相同的，经过一段时间的缓存刷新后，此服务实例不会再被调用 状态更新DOWN先结束，注销实例后结束： Eureka Server页面清除此服务实例信息 注销实例先结束，状态更新DOWN后结束： Eureka Server页面显示此服务实例状态为DOWN 方式三：/pause 端点【可用，但有缺陷】 /pause 端点 首先，启用/pause端点需要如下配置 endpoints.pause.enabled = trueendpoints.pause.sensitive = false PauseEndpoint是RestartEndPoint的内部类 //## Restart端点@ConfigurationProperties(&quot;endpoints.restart&quot;)@ManagedResourcepublic class RestartEndpoint extends AbstractEndpoint&lt;Boolean&gt;implements ApplicationListener&lt;ApplicationPreparedEvent&gt; { // Pause端点@ConfigurationProperties(&quot;endpoints&quot;)public class PauseEndpoint extends AbstractEndpoint&lt;Boolean&gt; {public PauseEndpoint() {super(&quot;pause&quot;, true, true); }@Overridepublic Boolean invoke() {if (isRunning()) { pause();return true; }return false; } } // 暂停操作@ManagedOperationpublic synchronized void pause() {if (this.context != null) {this.context.stop(); } }} 如上可见，/pause端点最终会调用Spring应用上下文的stop()方法 AbstractApplicationContext#stop() //## org.springframework.context.support.AbstractApplicationContext#stop@Overridepublic void stop() {// 1、所有实现Lifecycle生命周期接口 stop() getLifecycleProcessor().stop(); // 2、触发ContextStoppedEvent事件 publishEvent(new ContextStoppedEvent(this));} 查看源码，并没有发现有用的ContextStoppedEvent事件监听器，故stop的逻辑都在Lifecycle生命周期接口实现类的stop() 而getLifecycleProcessor().stop()&nbsp;与 方式二中shutdown调用的getLifecycleProcessor().doClose()&nbsp;内部逻辑都是一样的，都是调用了DefaultLifecycleProcessor#stopBeans()，进而调用Lifecycle接口实现类的stop()，如下 @Overridepublic void stop() { stopBeans();this.running = false;}@Overridepublic void onClose() { stopBeans();this.running = false;} 所以，执行/pause端点 和 shutdown时的其中一部分逻辑是一样的，依赖于EurekaServiceRegistry#deregister() 注销，会依次执行： 触发状态复制为DOWN，和Eureka Client注册上线register调用方法一样DiscoveryClient#register()，发送POST /eureka/apps/appID请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上实例状态变成DOWN 触发&nbsp;EurekaClient.shutdown 调用AbstractJerseyEurekaHttpClient#cancel()方法，向Eureka Server发送DELETE /eureka/v2/apps/appID/instanceID请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线 1、注销所有 StatusChangeListener 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程） 3、向Eureka Server注销实例 4、各种shutdown关闭 stop()执行完毕后，Eureka Server端当前实例状态是DOWN，还是下线，取决于 状态DOWN的复制线程 和 注销请求 哪个执行快 总结 /pause端点可以用于让服务从Eureka Server下线，且与shutdown不一样的是，其不会停止整个服务，导致整个服务不可用，只会做从Eureka Server注销的操作，最终在Eureka Server上体现的是&nbsp;服务下线&nbsp;或&nbsp;服务状态为DOWN，且eureka client相关的定时线程也都停止了，不会再被定时线程注册上线，所以可以在sleep一段时间，待服务实例下线被像Zuul这种Eureka Client刷新到，再停止微服务，就可以做到优雅下线（停止微服务的时候可以使用/shutdown端点&nbsp;或 直接暴利kill -9） 注意： 我实验的当前版本下，使用/pause端点下线服务后，无法使用/resume端点再次上线，即如果发版过程中想重新注册服务，只有重启微服务。且为了从Eureka Server下线服务，将整个Spring容器stop()，也有点“兴师动众” /resume端点无法让服务再次上线的原因是，虽然此端点会调用AbstractApplicationContext#start()&nbsp;--&gt;EurekaAutoServiceRegistration#start()&nbsp;--&gt;EurekaServiceRegistry#register()，但由于之前已经停止了Eureka Client的所有定时任务线程，比如状态复制 和 心跳线程，重新注册时虽然有maybeInitializeClient(eurekaRegistration)尝试重新启动EurekaClient，但并没有成功（估计是此版本的Bug），导致UP状态并没有发送给Eureka Server 可下线，无法重新上线 方式四：/service-registry 端点【可用，但有坑】 /service-registry 端点 首先，在我使用的版本&nbsp;/service-registry&nbsp;端点默认是启用的，但是是sensitive&nbsp;的，也就是需要认证才能访问 我试图找一个可以单独将/service-registry的sensitive置为false的方式，但在当前我用的版本没有找到，/service-registry端点是通过ServiceRegistryAutoConfiguration自动配置的&nbsp;ServiceRegistryEndpoint，而&nbsp;ServiceRegistryEndpoint这个MvcEndpoint的isSensitive()方法写死了返回true，并没有给可配置的地方或者自定义什么实现，然后在ManagementWebSecurityAutoConfiguration这个安全管理自动配置类中，将所有这些sensitive==true的通过Spring Security的httpSecurity.authorizeRequests().xxx.authenticated()设置为必须认证后才能访问，目前我找到只能通过&nbsp;management.security.enabled=false&nbsp;这种将所有端点都关闭认证的方式才可以无认证访问 # 无认证访问 /service-registry 端点management.security.enabled=false 更新远端实例状态 /service-registry端点的实现类是ServiceRegistryEndpoint，其暴露了两个RequestMapping，分别是GET 和 POST请求的/service-registry，GET请求的用于获取实例本地的status、overriddenStatus，POST请求的用于调用Eureka Server修改当前实例状态 @ManagedResource(description = &quot;Can be used to display and set the service instance status using the service registry&quot;)@SuppressWarnings(&quot;unchecked&quot;)public class ServiceRegistryEndpoint implements MvcEndpoint {private final ServiceRegistry serviceRegistry;private Registration registration;public ServiceRegistryEndpoint(ServiceRegistry&lt;?&gt; serviceRegistry) {this.serviceRegistry = serviceRegistry; }public void setRegistration(Registration registration) {this.registration = registration; }@RequestMapping(path = &quot;instance-status&quot;, method = RequestMethod.POST)@ResponseBody@ManagedOperationpublic ResponseEntity&lt;?&gt; setStatus(@RequestBody String status) { Assert.notNull(status, &quot;status may not by null&quot;);if (this.registration == null) {return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;no registration found&quot;); }this.serviceRegistry.setStatus(this.registration, status);return ResponseEntity.ok().build(); }@RequestMapping(path = &quot;instance-status&quot;, method = RequestMethod.GET)@ResponseBody@ManagedAttributepublic ResponseEntity getStatus() {if (this.registration == null) {return ResponseEntity.status(HttpStatus.NOT_FOUND).body(&quot;no registration found&quot;); }return ResponseEntity.ok().body(this.serviceRegistry.getStatus(this.registration)); }@Overridepublic String getPath() {return &quot;/service-registry&quot;; }@Overridepublic boolean isSensitive() {return true; }@Overridepublic Class&lt;? extends Endpoint&lt;?&gt;&gt; getEndpointType() {return null; }} 我们关注的肯定是POST请求的/service-registry，如上可以看到，其调用了EurekaServiceRegistry.setStatus()&nbsp;方法更新实例状态 //## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistrypublic class EurekaServiceRegistry implements ServiceRegistry&lt;EurekaRegistration&gt; { // 更新状态@Overridepublic void setStatus(EurekaRegistration registration, String status) { InstanceInfo info = registration.getApplicationInfoManager().getInfo();// 如果更新的status状态为CANCEL_OVERRIDE，调用EurekaClient.cancelOverrideStatus()//TODO: howto deal with delete properly?if (&quot;CANCEL_OVERRIDE&quot;.equalsIgnoreCase(status)) { registration.getEurekaClient().cancelOverrideStatus(info);return; }// 调用EurekaClient.setStatus()//TODO: howto deal with status types across discovery systems? InstanceInfo.InstanceStatus newStatus = InstanceInfo.InstanceStatus.toEnum(status); registration.getEurekaClient().setStatus(newStatus, info); } } EurekaServiceRegistry.setStatus()&nbsp;方法支持像Eureka Server发送两种请求，分别是通过&nbsp;EurekaClient.setStatus()&nbsp;和EurekaClient.cancelOverrideStatus()&nbsp;来支持的，下面分别分析： EurekaClient.setStatus()： 实际是发送&nbsp;PUT /eureka/apps/appID/instanceID/status?value=xxx到Eureka Server，这是注册中心对于&nbsp;Take instance out of service 实例下线&nbsp;而开放的Rest API，可以做到更新Eureka Server端的实例状态（status 和 overriddenstatus），一般会在发版部署时使用，让服务下线，更新为OUT_OF_SERVICE 由于overriddenstatus更新为了OUT_OF_SERVICE，故即使有&nbsp;心跳&nbsp;或&nbsp;UP状态复制，也不会改变其OUT_OF_SERVICE的状态，overriddenstatus覆盖状态就是为了避免服务下线后又被定时线程上线或更新状态而设计的，有很多所谓的 “覆盖策略” 也正是由于overriddenstatus覆盖状态无法被 心跳 和 UP状态复制（其实就是EurekaClient.register()）而影响，故在发版部署完新版本后，最好先调用Rest API清除overriddenstatus，再启动服务，如果直接启动服务，可能导致Server端仍是OUT_OF_SERVICE状态的问题 实验：&nbsp;更新状态为OUT_OF_SERVICE后，直接停服务，只有等到Server端服务租约到期下线后，再启动客户端上线才能成功注册并状态为UP；如果没等Server端下线服务不存在后就启动服务，注册上线后无法改变overriddenstatus==OUT_OF_SERVICE EurekaClient.cancelOverrideStatus()&nbsp;： 实际是发送&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status&nbsp;到Eureka Server，用于清除覆盖状态，其实官方给出的是&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status?value=UP，其中value=UP可选，是删除overriddenstatus为UNKNOWN之后，建议status回滚为什么状态，但我当前使用版本里没有这个&nbsp;value=UP可选参数，就导致发送后，Eureka Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN，但UNKNOWN覆盖状态不同的事，虽然心跳线程仍对其无作用，但注册（等同于UP状态更新）是可以让服务上线的 总结 /service-registry端点可以更新服务实例状态为 OUT_OF_SERVICE，再经过一段Server端、Client端缓存的刷新，使得服务不会再被调用，此时再通过/shutdown端点 或 暴利的kill -9&nbsp;停止服务进程，可以达到优雅下线的效果 如希望回滚，可以通过几种方式 还是/service-registry端点，只不过状态为 CANCEL_OVERRIDE，具体逻辑在&nbsp;EurekaServiceRegistry.setStatus()&nbsp;中，其等同于直接调用Eureka Server API ：&nbsp;DELETE /eureka/v2/apps/appID/instanceID/status，可以让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN 也可以用&nbsp;/service-registry端点，状态为UP，可使得Server端 status=UP且 overriddenstatus=UP，虽然可以临时起到上线目的，但 overriddenstatus=UP 仍需要上一步的DELETE请求才能清楚，很麻烦，不建议使用 不通过Eureka Client的端点，直接调用Eureka Server端点：&nbsp;DELETE /eureka/apps/appID/instanceID/status?value=UP 实际使用过程中建议如下顺序 缓存刷新时间&nbsp;指的是Eureka Server刷新只读缓存、Eureka Client刷新本地服务列表、Ribbon刷新ServerList的时间，默认都是30s，可以适当缩短缓存刷新时间 # Eureka Server端配置eureka.server.responseCacheUpdateIntervalMs=5000eureka.server.eviction-interval-timer-in-ms=5000# Eureka Client端配置eureka.client.registryFetchIntervalSeconds=5ribbon.ServerListRefreshInterval=5000 单个请求处理时间&nbsp;是为了怕服务还有请求没处理完 1、调用/service-registry端点将状态置为 OUT_OF_SERVICE 2、sleep 缓存刷新时间 + 单个请求处理时间 3、调用&nbsp;/service-registry端点将状态置为 CANCEL_OVERRIDE，其实就是向Server端发送DELETE overriddenstatus的请求，这会让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN 4、使用&nbsp;/shutdown端点 或 暴利kill -9终止服务 5、发版部署后，启动服务注册到Eureka Server，服务状态变为UP 方式五： 直接调用Eureka Server Rest API【可用，但URL比较复杂】 上面说了这么多，其实这些都是针对Eureka Server Rest API在Eureka客户端上的封装，即通过Eureka Client服务由于引入了actuator，增加了一系列端点，其实一些端点通过调用Eureka Server暴露的Rest API的方式实现Eureka实例服务下线功能 Eureka Rest API包括： 其中大多数非查询类的操作在之前分析Eureka Client的端点时都分析过了，其实调用Eureka Server的Rest API是最直接的，但由于目前多采用一些类似Jenkins的发版部署工具，其中操作均在脚本中执行，Eureka Server API虽好，但URL中都涉及appID&nbsp;、instanceID，对于制作通用的脚本来说拼接出调用端点的URL有一定难度，且不像调用本地服务端点IP使用localhost 或 127.0.0.1即可，需要指定Eureka Server地址，所以整理略显复杂。不过在比较规范化的公司中，也是不错的选择。 &nbsp; 福利 扫描添加小编微信，备注“姓名+公司职位”，加入【云计算学习交流群】，和志同道合的朋友们共同打卡学习！ 推荐阅读： 太形象了！什么是边缘计算？最有趣的解释没有之一！ 互联网出海十年 华为员工年薪 200 万！真相让人心酸！ 天才程序员：25 岁进贝尔实验室，32 岁创建信息论 &nbsp;琥珀 &nbsp;极客宝宝 &nbsp;5天前 安全顾问反水成黑客, 靠瞎猜盗得5000万美元的以太币, 一个区块链大盗的另类传奇 人造器官新突破！美国科学家3D打印出会“呼吸”的肺 | Science 真香，朕在看了！","@type":"BlogPosting","url":"https://mlh.app/2019/05/08/729948.html","headline":"SpringCloud微服务如何优雅停机及源码分析   技术头条","dateModified":"2019-05-08T00:00:00+08:00","datePublished":"2019-05-08T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2019/05/08/729948.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>SpringCloud微服务如何优雅停机及源码分析&nbsp;|&nbsp;技术头条</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <section class="xmteditor" style="display:none;" data-tools="新媒体管家" data-label="powered by xmt.cn"> 
 <br> 
</section> 
<p style="text-align: right;margin-left: 8px;margin-right: 8px;"><strong><span style="font-size: 15px;">戳蓝字“</span><span style="color: rgb(0, 82, 255);font-size: 15px;">CSDN云</span><span style="font-size: 15px;color: rgb(0, 82, 255);">计算</span><span style="font-size: 15px;">”关注我们哦！</span></strong><br></p> 
<p style="text-align: center;margin-left: 8px;margin-right: 8px;"><img class="rich_pages" data-ratio="0.665" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/zxoLaeCI28S1tkxyCkxyN9YP7bx0ntDqp2AjJ6Nw5AsFNIahpj6cr0Q49ib21ibibMEibqRVOSQpQWOGvBb5vq0sBg/640?wx_fmt=jpeg" data-type="jpeg" data-w="600" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/zxoLaeCI28S1tkxyCkxyN9YP7bx0ntDqp2AjJ6Nw5AsFNIahpj6cr0Q49ib21ibibMEibqRVOSQpQWOGvBb5vq0sBg/640?wx_fmt=jpeg"></p> 
<section powered-by="xiumi.us" style="white-space: normal;max-width: 100%;box-sizing: border-box;font-size: 15px;letter-spacing: 0.544px;line-height: 30px;widows: 1;background-color: rgb(255, 255, 255);word-wrap: break-word !important;"> 
 <section style="max-width: 100%;box-sizing: border-box;word-wrap: break-word !important;"> 
  <section> 
   <section powered-by="xiumi.us" style="box-sizing: border-box;line-height: 30px;max-width: 100%;letter-spacing: 0.54px;word-wrap: break-word !important;"> 
    <section style="box-sizing: border-box;max-width: 100%;word-wrap: break-word !important;"> 
     <section> 
      <section powered-by="xiumi.us" style="box-sizing: border-box;line-height: 30px;max-width: 100%;letter-spacing: 0.54px;word-wrap: break-word !important;"> 
       <section style="box-sizing: border-box;max-width: 100%;word-wrap: break-word !important;"> 
        <section> 
         <blockquote> 
          <p style="margin-right: 8px;margin-bottom: 15px;margin-left: 8px;line-height: 1.75em;min-height: 1em;max-width: 100%;letter-spacing: 1px;text-indent: 0em;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="letter-spacing: 0.54px;color: rgb(0, 82, 255);"></span><strong style="color: rgb(0, 82, 255);font-size: 15px;letter-spacing: 0.54px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);"><strong style="max-width: 100%;color: rgba(0, 0, 0, 0.5);font-size: 15px;letter-spacing: 1px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;letter-spacing: 0.54px;color: rgb(0, 82, 255);box-sizing: border-box !important;word-wrap: break-word !important;">技术头条：干货、简洁、多维全面。更多云计算精华知识尽在眼前，get要点、solve难题，统统不在话下！</span></strong></strong></p> 
         </blockquote> 
        </section> 
       </section> 
      </section> 
     </section> 
    </section> 
   </section> 
  </section> 
 </section> 
</section> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;box-sizing: border-box !important;word-wrap: break-word !important;"><br></span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;color: rgb(136, 136, 136);box-sizing: border-box !important;word-wrap: break-word !important;">作者：Trust_FreeDom</span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 14px;color: rgb(136, 136, 136);box-sizing: border-box !important;word-wrap: break-word !important;">转自：码农沉思录</span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 16px;letter-spacing: 0.544px;text-indent: 2em;"><br></span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="letter-spacing: 0.544px;text-indent: 2em;font-size: 15px;">本文主要讨论的是微服务注册到Eureka注册中心，并使用Zuul网关负载访问的情况，如何停机可以使用户无感知。</span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="letter-spacing: 0.544px;text-indent: 2em;font-size: 15px;"><br></span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">方式一：kill -9 java进程id【不建议】</strong></span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -9</span></code><span style="font-size: 15px;">&nbsp;属于强杀进程，首先微服务正在执行的任务被强制中断了；其次，没有通过Eureka注册中心服务下线，Zuul网关作为Eureka Client仍保存这个服务的路由信息，会继续调用服务，Http请求返回500，后台异常是Connection refuse连接拒绝。</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">这种情况默认最长需要等待：</span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="go"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">90s（微服务在Eureka Server上租约到期）</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">+</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">30s（Eureka Server服务列表刷新到只读缓存ReadOnlyMap的时间，Eureka Client默认读此缓存）</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">+</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">30s（Zuul作为Eureka Client默认每30秒拉取一次服务列表）</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">+</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">30s（Ribbon默认动态刷新其ServerList的时间间隔）</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">= 180s，即 3分钟</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">总结：</strong></span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">此种方式既会导致正在执行中的任务无法执行完，又会导致服务没有从Eureka Server摘除，并给Eureka Client时间刷新到服务列表，导致了通过Zuul仍然调用已停掉服务报500错误的情况，不推荐。</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">方式二：kill -15 java进程id 或 直接使用/shutdown 端点【不建议】</strong></span></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">kill 与/shutdown 的含义</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">首先，</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill</span></code><span style="font-size: 15px;">等于</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -15</span></code><span style="font-size: 15px;">，根据</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">man kill</span></code><span style="font-size: 15px;">的描述信息</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">The command kill sends the specified signal to the specified process or process group. If no signal is specified, the TERM signal is sent.</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">即kill没有执行信号等同于TERM（终止，termination）</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">而</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -l</span></code><span style="font-size: 15px;">查看信号编号与信号之间的关系，</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -15</span></code><span style="font-size: 15px;">就是&nbsp;<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">SIGTERM</strong>，TERM信号</span></p> 
<p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><img class="" data-ratio="0.2948539638386648" data-w="719" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/US10Gcd0tQGIC7rQHL9WFiauWrSFbkVlOtib0Bact7ibId25HUs19fPaicT8qjia3zk8VpXePZpC2icr6KwtVIL1pCiag/640?" style="margin: 20px auto 30px;display: block;box-sizing: border-box !important;word-wrap: break-word !important;width: 677px !important;visibility: visible !important;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/US10Gcd0tQGIC7rQHL9WFiauWrSFbkVlOtib0Bact7ibId25HUs19fPaicT8qjia3zk8VpXePZpC2icr6KwtVIL1pCiag/640?"></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">给JVM进程发送TERM终止信号时，会调用其注册的 Shutdown Hook，当SpringBoot微服务启动时也注册了 Shutdown Hook</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">而直接调用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/shutdown</span></code><span style="font-size: 15px;">端点本质和使用 Shutdown Hook是一样的，<span color="red" style="font-size: 15px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">所以无论是使用</strong><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">kill</code>或&nbsp;<code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">kill -15</code>，还是直接使用<code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">/shutdown</code>端点，都会调用到JVM注册的Shutdown Hook</strong></span></span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">注意：</strong></span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">启用 /shutdown端点，需要如下配置</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">endpoints.shutdown.enabled = true<br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">endpoints.shutdown.sensitive = false</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">所有问题都导向了 Shutdown Hook会执行什么？？</strong></span></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">Spring注册的Shutdown Hook</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">通过查询项目组使用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">Runtime.getRuntime().addShutdownHook(Thread shutdownHook)</span></code><span style="font-size: 15px;">的地方，发现ribbon注册了一些Shutdown Hook，但这不是我们这次关注的，我们关注的是Spring的应用上下文抽象类</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">AbstractApplicationContext</span></code><span style="font-size: 15px;">注册了针对整个Spring容器的Shutdown Hook，在执行Shutdown Hook时的逻辑在<span color="blue" style="font-size: 15px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">AbstractApplicationContext#doClose()</code></strong></span></span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="kotlin"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## org.springframework.context.support.AbstractApplicationContext#registerShutdownHook </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">/**</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * Register a shutdown hook with the JVM runtime, closing this context</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * on JVM shutdown unless it has already been closed at that time.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * &lt;p&gt;Delegates to {@code doClose()} for the actual closing procedure.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see Runtime#addShutdownHook</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see #close()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see #doClose()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> */</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void registerShutdownHook() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (this.shutdownHook == null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// No shutdown hook registered yet.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 注册shutdownHook，线程真正调用的是 doClose()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.shutdownHook = new Thread() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void run() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> synchronized (startupShutdownMonitor) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> doClose();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> };</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> Runtime.getRuntime().addShutdownHook(this.shutdownHook);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## org.springframework.context.support.AbstractApplicationContext#doClose </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">/**</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * Actually performs context closing: publishes a ContextClosedEvent and</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * destroys the singletons in the bean factory of this application context.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * &lt;p&gt;Called by both {@code close()} and a JVM shutdown hook, if any.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see org.springframework.context.event.ContextClosedEvent</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see #destroyBeans()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see #close()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> * @see #registerShutdownHook()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> */</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">protected void doClose() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (logger.isInfoEnabled()) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> logger.info("Closing " + this);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 注销注册的MBean</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> LiveBeansView.unregisterApplicationContext(this);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">try {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// Publish shutdown event.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> publishEvent(new ContextClosedEvent(this));</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">catch (Throwable ex) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> logger.warn("Exception thrown from ApplicationListener handling ContextClosedEvent", ex);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// Stop all Lifecycle beans, to avoid delays during individual destruction.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 调用所有 Lifecycle bean 的 stop() 方法</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">try {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> getLifecycleProcessor().onClose();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">catch (Throwable ex) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> logger.warn("Exception thrown from LifecycleProcessor on context close", ex);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// Destroy all cached singletons in the context's BeanFactory.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 销毁所有单实例bean</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> destroyBeans();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// Close the state of this context itself.</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> closeBeanFactory();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// Let subclasses do some final clean-up if they wish...</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 调用子类的 onClose() 方法，比如 EmbeddedWebApplicationContext#onClose()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> onClose();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.active.set(false);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">AbstractApplicationContext#doClose()</code></strong>&nbsp;的关键点在于</span></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">publishEvent(new ContextClosedEvent(this))： 发送ContextClosedEvent事件，会有对应此事件的Listener处理相应的逻辑</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">getLifecycleProcessor().onClose()： 调用所有 Lifecycle bean 的 stop() 方法</span></p></li> 
</ul> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">而ContextClosedEvent事件的Listener有很多，实现了Lifecycle生命周期接口的bean也很多，但其中我们只关心一个，即&nbsp;<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaAutoServiceRegistration</code></strong>&nbsp;，它即监听了ContextClosedEvent事件，也实现了Lifecycle接口</span></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaAutoServiceRegistration的stop()事件</strong></span></h2> 
<pre style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"></pre> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="kotlin"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaAutoServiceRegistration</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public class EurekaAutoServiceRegistration implements AutoServiceRegistration, SmartLifecycle, Ordered {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// lifecycle接口的 stop()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void stop() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.serviceRegistry.deregister(this.registration);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.running.set(false); // 设置liffecycle的running标示为false</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// ContextClosedEvent事件监听器</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@EventListener(ContextClosedEvent.class)</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void onApplicationEvent(ContextClosedEvent event) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// register in case meta data changed</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> stop();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">如上可以看到，</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaAutoServiceRegistration</span></code><span style="font-size: 15px;">中对 ContextClosedEvent事件 和 Lifecycle接口 的实现都调用了</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">stop()</span></code><span style="font-size: 15px;">方法，虽然都调用了</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">stop()</span></code><span style="font-size: 15px;">方法，但由于各种对于状态的判断导致不会重复执行，如</span></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">Lifecycle的running标示置为false，就不会调用到此Lifecycle#stop()</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaServiceRegistry#deregister()</span></code><span style="font-size: 15px;">方法包含将实例状态置为DOWN 和 EurekaClient#shutdown() 两个操作，其中状态置为DOWN一次后，下一次只要状态不变就不会触发状态复制请求；EurekaClient#shutdown() 之前也会判断</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">AtomicBoolean isShutdown</span></code><span style="font-size: 15px;">标志位</span></p></li> 
</ul> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">下面具体看看<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaServiceRegistry#deregister()</code></strong>方法</span></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaServiceRegistry#deregister() 注销</strong></span></h2> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="cpp"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry#deregister</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void deregister(EurekaRegistration reg) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (reg.getApplicationInfoManager().getInfo() != null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (log.isInfoEnabled()) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">log.info("Unregistering application " + reg.getInstanceConfig().getAppname()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> + " with eureka with status DOWN");</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 更改实例状态，会立即触发状态复制请求</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> reg.getApplicationInfoManager().setInstanceStatus(InstanceInfo.InstanceStatus.DOWN);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//TODO: on deregister or on context shutdown</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 关闭EurekaClient</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> reg.getEurekaClient().shutdown();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">主要涉及两步：</span></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">更新Instance状态为 DOWN</strong>： 更新状态会触发</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">StatusChangeListener</span></code><span style="font-size: 15px;">监听器，状态复制器</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">InstanceInfoReplicator</span></code><span style="font-size: 15px;">会向Eureka Server发送状态更新请求。实际上状态更新和Eureka Client第一次注册时都是调用的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DiscoveryClient.register()</span></code><span style="font-size: 15px;">，都是发送</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">POST /eureka/apps/appID</span></code><span style="font-size: 15px;">请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上变成</span></p></li> 
</ul> 
<p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><img class="" data-ratio="0.10925925925925926" data-w="1080" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/US10Gcd0tQGIC7rQHL9WFiauWrSFbkVlOpO8oDgicd8Md3ROf6Hshgzb0HcgQXDfckIiauAmjXEngO2somIw7qLxw/640?" style="margin: 20px auto 30px;display: block;box-sizing: border-box !important;word-wrap: break-word !important;width: 677px !important;visibility: visible !important;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/US10Gcd0tQGIC7rQHL9WFiauWrSFbkVlOpO8oDgicd8Md3ROf6Hshgzb0HcgQXDfckIiauAmjXEngO2somIw7qLxw/640?"></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaClient.shutdown()</strong>： 整个Eureka Client的关闭操作包含以下几步</span></p></li> 
 <section class="code-snippet__fix code-snippet__js"> 
  <ul class="code-snippet__line-index code-snippet__js"> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
   <li></li> 
  </ul> 
  <pre class="code-snippet__js" data-lang="java"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@PreDestroy</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public synchronized void shutdown() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (isShutdown.compareAndSet(false, true)) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> logger.info("Shutting down DiscoveryClient ...");</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 1、注销所有 StatusChangeListener</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if ( statusChangeListener != null &amp;&amp; applicationInfoManager != null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> applicationInfoManager.unregisterStatusChangeListener(statusChangeListener.getId());</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程）</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> cancelScheduledTasks();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// If APPINFO was registered</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 3、向Eureka Server注销实例</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (applicationInfoManager != null &amp;&amp; clientConfig.shouldRegisterWithEureka()) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> applicationInfoManager.setInstanceStatus(InstanceStatus.DOWN);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> unregister();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 4、各种shutdown关闭</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (eurekaTransport != null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> eurekaTransport.shutdown();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> heartbeatStalenessMonitor.shutdown();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> registryStalenessMonitor.shutdown();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> logger.info("Completed shut down of DiscoveryClient");</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></pre> 
 </section> 
 <p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">其中应关注</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">unregister()</span></code><span style="font-size: 15px;">注销，其调用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">AbstractJerseyEurekaHttpClient#cancel()</span></code><span style="font-size: 15px;">方法，向Eureka Server发送</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DELETE /eureka/v2/apps/appID/instanceID</span></code><span style="font-size: 15px;">请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线<br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></span></p> 
</ul> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">总结</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">使用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill</span></code><span style="font-size: 15px;">、</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -15</span></code><span style="font-size: 15px;">&nbsp;或&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/shutdown</span></code><span style="font-size: 15px;">端点都会调用Shutdown Hook，触发Eureka Instance实例的注销操作，这一步是没有问题的，优雅下线的第一步就是从Eureka注册中心注销实例，但关键问题是shutdown操作除了注销Eureka实例，还会马上停止服务，而此时无论Eureka Server端，Zuul作为Eureka Client端都存在陈旧的缓存还未刷新，服务列表中仍然有注销下线的服务，通过zuul再次调用报500错误，后台是connection refuse连接拒绝异常，故不建议使用</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">另外，由于</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">unregister</span></code><span style="font-size: 15px;">注销操作涉及状态更新DOWN 和 注销下线 两步操作，且是分两个线程执行的，实际注销时，根据两个线程执行完成的先后顺序，最终在Eureka Server上体现的结果不同，但最终效果是相同的，经过一段时间的缓存刷新后，此服务实例不会再被调用</span></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">状态更新DOWN先结束，注销实例后结束： Eureka Server页面清除此服务实例信息</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">注销实例先结束，状态更新DOWN后结束： Eureka Server页面显示此服务实例状态为DOWN</span></p></li> 
</ul> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">方式三：/pause 端点【可用，但有缺陷】</strong></span></h2> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></h2> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">/pause 端点</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">首先，启用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/pause</span></code><span style="font-size: 15px;">端点需要如下配置</span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="javascript"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">endpoints.pause.enabled = true</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">endpoints.pause.sensitive = false</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">PauseEndpoint</span></code><span style="font-size: 15px;">是</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">RestartEndPoint</span></code><span style="font-size: 15px;">的内部类<br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="java"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## Restart端点</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ConfigurationProperties("endpoints.restart")</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ManagedResource</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public class RestartEndpoint extends AbstractEndpoint&lt;Boolean&gt;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">implements ApplicationListener&lt;ApplicationPreparedEvent&gt; {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// Pause端点</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ConfigurationProperties("endpoints")</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public class PauseEndpoint extends AbstractEndpoint&lt;Boolean&gt; {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public PauseEndpoint() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">super("pause", true, true);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public Boolean invoke() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (isRunning()) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> pause();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return true;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return false;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 暂停操作</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ManagedOperation</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public synchronized void pause() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (this.context != null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.context.stop();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">如上可见，</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/pause</span></code><span style="font-size: 15px;">端点最终会调用Spring应用上下文的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">stop()</span></code><span style="font-size: 15px;">方法</span></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">AbstractApplicationContext#stop()</strong></span></h2> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="java"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## org.springframework.context.support.AbstractApplicationContext#stop</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void stop() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 1、所有实现Lifecycle生命周期接口 stop()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> getLifecycleProcessor().stop();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 2、触发ContextStoppedEvent事件</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> publishEvent(new ContextStoppedEvent(this));</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">查看源码，并没有发现有用的ContextStoppedEvent事件监听器，故stop的逻辑都在<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">Lifecycle生命周期接口实现类</strong>的stop()</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">而</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">getLifecycleProcessor().stop()</span></code><span style="font-size: 15px;">&nbsp;与 方式二中shutdown调用的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">getLifecycleProcessor().doClose()</span></code><span style="font-size: 15px;">&nbsp;内部逻辑都是一样的，都是调用了</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DefaultLifecycleProcessor#stopBeans()</span></code><span style="font-size: 15px;">，进而调用Lifecycle接口实现类的stop()，如下</span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="java"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void stop() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> stopBeans();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.running = false;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void onClose() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> stopBeans();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.running = false;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">所以，执行</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/pause</span></code><span style="font-size: 15px;">端点 和 shutdown时的其中一部分逻辑是一样的，依赖于</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaServiceRegistry#deregister() 注销</span></code><span style="font-size: 15px;">，会依次执行：</span></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">触发状态复制为DOWN，和Eureka Client注册上线register调用方法一样</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DiscoveryClient#register()</span></code><span style="font-size: 15px;">，发送</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">POST /eureka/apps/appID</span></code><span style="font-size: 15px;">请求到Eureka Server，只不过请求Body中的Instance实例状态不同。执行完此步骤后，Eureka Server页面上实例状态变成DOWN</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">触发&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaClient.shutdown</span></code></p></li> 
 <ul class=" list-paddingleft-2" style="list-style-type: square;"> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">调用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">AbstractJerseyEurekaHttpClient#cancel()</span></code><span style="font-size: 15px;">方法，向Eureka Server发送</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DELETE /eureka/v2/apps/appID/instanceID</span></code><span style="font-size: 15px;">请求，DELETE请求成功后，Eureka Server页面上服务列表就没有当前实例信息了。注意： 由于在注销上一步已经停掉了定时心跳线程，否则注销后的下次心跳又会导致服务上线</span></p></li> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">1、注销所有 StatusChangeListener</span></p></li> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">2、停掉所有定时线程（实例状态复制、心跳、client缓存刷新、监督线程）</span></p></li> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">3、向Eureka Server注销实例</span></p></li> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">4、各种shutdown关闭</span></p></li> 
 </ul> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">stop()执行完毕后，Eureka Server端当前实例状态是DOWN，还是下线，取决于 状态DOWN的复制线程 和 注销请求 哪个执行快</span></p></li> 
</ul> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">总结</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/pause</span></code><span style="font-size: 15px;">端点可以用于让服务从Eureka Server下线，且与shutdown不一样的是，其不会停止整个服务，导致整个服务不可用，只会做从Eureka Server注销的操作，最终在Eureka Server上体现的是&nbsp;<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">服务下线</strong>&nbsp;或&nbsp;<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">服务状态为DOWN</strong>，且eureka client相关的定时线程也都停止了，不会再被定时线程注册上线，所以可以在sleep一段时间，待服务实例下线被像Zuul这种Eureka Client刷新到，再停止微服务，就可以做到优雅下线（停止微服务的时候可以使用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/shutdown端点</span></code><span style="font-size: 15px;">&nbsp;或 直接暴利</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -9</span></code><span style="font-size: 15px;">）</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">注意：</strong></span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">我实验的当前版本下，使用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/pause</span></code><span style="font-size: 15px;">端点下线服务后，无法使用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/resume</span></code><span style="font-size: 15px;">端点再次上线，即如果发版过程中想重新注册服务，只有重启微服务。且为了从Eureka Server下线服务，将整个Spring容器stop()，也有点“兴师动众”</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/resume</span></code><span style="font-size: 15px;">端点无法让服务再次上线的原因是，虽然此端点会调用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">AbstractApplicationContext#start()</span></code><span style="font-size: 15px;">&nbsp;--&gt;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaAutoServiceRegistration#start()</span></code><span style="font-size: 15px;">&nbsp;--&gt;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaServiceRegistry#register()</span></code><span style="font-size: 15px;">，但由于之前已经停止了Eureka Client的所有定时任务线程，比如状态复制 和 心跳线程，重新注册时虽然有</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">maybeInitializeClient(eurekaRegistration)</span></code><span style="font-size: 15px;">尝试重新启动EurekaClient，但并没有成功（估计是此版本的Bug），导致UP状态并没有发送给Eureka Server</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">可下线，无法重新上线</strong></span></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">方式四：/service-registry 端点【可用，但有坑】</strong></span></h2> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">/service-registry 端点</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">首先，在我使用的版本&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">&nbsp;端点默认是启用的，但是是</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">sensitive</span></code><span style="font-size: 15px;">&nbsp;的，也就是需要认证才能访问</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">我试图找一个可以单独将</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">sensitive</span></code><span style="font-size: 15px;">置为false的方式，但在当前我用的版本没有找到，</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">端点是通过</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">ServiceRegistryAutoConfiguration</span></code><span style="font-size: 15px;">自动配置的&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">ServiceRegistryEndpoint</span></code><span style="font-size: 15px;">，而&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">ServiceRegistryEndpoint</span></code><span style="font-size: 15px;">这个MvcEndpoint的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">isSensitive()</span></code><span style="font-size: 15px;">方法写死了返回true，并没有给可配置的地方或者自定义什么实现，然后在</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">ManagementWebSecurityAutoConfiguration</span></code><span style="font-size: 15px;">这个安全管理自动配置类中，将所有这些</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">sensitive==true</span></code><span style="font-size: 15px;">的通过Spring Security的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">httpSecurity.authorizeRequests().xxx.authenticated()</span></code><span style="font-size: 15px;">设置为必须认证后才能访问，目前我找到只能通过&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">management.security.enabled=false</span></code><span style="font-size: 15px;">&nbsp;这种将所有端点都关闭认证的方式才可以无认证访问</span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="bash"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"># 无认证访问 /service-registry 端点</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">management.security.enabled=false</span></span></code></p></pre> 
</section> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">更新远端实例状态</strong></span></h2> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry端点的实现类是</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">ServiceRegistryEndpoint</span></code><span style="font-size: 15px;">，其暴露了两个RequestMapping，分别是GET 和 POST请求的/service-registry，GET请求的用于获取实例本地的status、overriddenStatus，POST请求的用于调用Eureka Server修改当前实例状态</span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="kotlin"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ManagedResource(description = "Can be used to display and set the service instance status using the service registry")</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@SuppressWarnings("unchecked")</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public class ServiceRegistryEndpoint implements MvcEndpoint {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">private final ServiceRegistry serviceRegistry;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">private Registration registration;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public ServiceRegistryEndpoint(ServiceRegistry&lt;?&gt; serviceRegistry) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.serviceRegistry = serviceRegistry;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void setRegistration(Registration registration) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.registration = registration;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@RequestMapping(path = "instance-status", method = RequestMethod.POST)</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ResponseBody</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ManagedOperation</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public ResponseEntity&lt;?&gt; setStatus(@RequestBody String status) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> Assert.notNull(status, "status may not by null");</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (this.registration == null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return ResponseEntity.status(HttpStatus.NOT_FOUND).body("no registration found");</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">this.serviceRegistry.setStatus(this.registration, status);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return ResponseEntity.ok().build();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@RequestMapping(path = "instance-status", method = RequestMethod.GET)</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ResponseBody</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@ManagedAttribute</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public ResponseEntity getStatus() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if (this.registration == null) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return ResponseEntity.status(HttpStatus.NOT_FOUND).body("no registration found");</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return ResponseEntity.ok().body(this.serviceRegistry.getStatus(this.registration));</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public String getPath() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return "/service-registry";</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public boolean isSensitive() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return true;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public Class&lt;? extends Endpoint&lt;?&gt;&gt; getEndpointType() {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return null;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">我们关注的肯定是POST请求的/service-registry，如上可以看到，其调用了</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaServiceRegistry.setStatus()</span></code><span style="font-size: 15px;">&nbsp;方法更新实例状态</span></p> 
<section class="code-snippet__fix code-snippet__js"> 
 <ul class="code-snippet__line-index code-snippet__js"> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
  <li></li> 
 </ul> 
 <pre class="code-snippet__js" data-lang="java"><p style="margin-left: 8px;margin-right: 8px;"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//## org.springframework.cloud.netflix.eureka.serviceregistry.EurekaServiceRegistry</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public class EurekaServiceRegistry implements ServiceRegistry&lt;EurekaRegistration&gt; {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 更新状态</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">@Override</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">public void setStatus(EurekaRegistration registration, String status) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> InstanceInfo info = registration.getApplicationInfoManager().getInfo();</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 如果更新的status状态为CANCEL_OVERRIDE，调用EurekaClient.cancelOverrideStatus()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//TODO: howto deal with delete properly?</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">if ("CANCEL_OVERRIDE".equalsIgnoreCase(status)) {</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> registration.getEurekaClient().cancelOverrideStatus(info);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">return;</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">// 调用EurekaClient.setStatus()</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">//TODO: howto deal with status types across discovery systems?</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> InstanceInfo.InstanceStatus newStatus = InstanceInfo.InstanceStatus.toEnum(status);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> registration.getEurekaClient().setStatus(newStatus, info);</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> }</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"> </span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">}</span></span></code></p></pre> 
</section> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaServiceRegistry.setStatus()</span></code><span style="font-size: 15px;">&nbsp;方法支持像Eureka Server发送两种请求，分别是通过&nbsp;<span color="blue" style="font-size: 15px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaClient.setStatus()</code></span>&nbsp;和<span color="blue" style="font-size: 15px;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaClient.cancelOverrideStatus()</code></span>&nbsp;来支持的，下面分别分析：</span></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaClient.setStatus()</code></strong>：</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">实际是发送&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">PUT /eureka/apps/appID/instanceID/status?value=xxx</span></code><span style="font-size: 15px;">到Eureka Server，这是注册中心对于&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">Take instance out of service 实例下线</span></code><span style="font-size: 15px;">&nbsp;而开放的Rest API，可以做到更新Eureka Server端的实例状态（status 和 overriddenstatus），一般会在发版部署时使用，让服务下线，更新为<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">OUT_OF_SERVICE</strong></span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">由于overriddenstatus更新为了OUT_OF_SERVICE，故即使有&nbsp;<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">心跳</strong>&nbsp;或&nbsp;<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">UP状态复制</strong>，也不会改变其OUT_OF_SERVICE的状态，overriddenstatus覆盖状态就是为了避免服务下线后又被定时线程上线或更新状态而设计的，有很多所谓的 “覆盖策略”</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">也正是由于overriddenstatus覆盖状态无法被 心跳 和 UP状态复制（其实就是EurekaClient.register()）而影响，故在发版部署完新版本后，最好先调用Rest API清除overriddenstatus，再启动服务，如果直接启动服务，可能导致Server端仍是OUT_OF_SERVICE状态的问题</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">实验：</strong>&nbsp;更新状态为OUT_OF_SERVICE后，直接停服务，只有等到Server端服务租约到期下线后，再启动客户端上线才能成功注册并状态为UP；如果没等Server端下线服务不存在后就启动服务，注册上线后无法改变overriddenstatus==OUT_OF_SERVICE</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">EurekaClient.cancelOverrideStatus()</code></strong>&nbsp;：</span></p></li> 
 <p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">实际是发送&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DELETE /eureka/v2/apps/appID/instanceID/status</span></code><span style="font-size: 15px;">&nbsp;到Eureka Server，用于清除覆盖状态，其实官方给出的是&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DELETE /eureka/v2/apps/appID/instanceID/status?value=UP</span></code><span style="font-size: 15px;">，其中</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">value=UP</span></code><span style="font-size: 15px;">可选，是删除overriddenstatus为UNKNOWN之后，建议status回滚为什么状态，但我当前使用版本里没有这个&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">value=UP</span></code><span style="font-size: 15px;">可选参数，就导致发送后，Eureka Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN，但UNKNOWN覆盖状态不同的事，虽然心跳线程仍对其无作用，但注册（等同于UP状态更新）是可以让服务上线的</span></p> 
</ul> 
<h2 style="max-width: 100%;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">总结</strong></span></h2> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">端点可以更新服务实例状态为 OUT_OF_SERVICE，再经过一段Server端、Client端缓存的刷新，使得服务不会再被调用，此时再通过</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/shutdown</span></code><span style="font-size: 15px;">端点 或 暴利的</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -9</span></code><span style="font-size: 15px;">&nbsp;停止服务进程，可以达到优雅下线的效果</span></p></li> 
 <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">如希望回滚，可以通过几种方式</span></p></li> 
 <ul class=" list-paddingleft-2" style="list-style-type: square;"> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">还是</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">端点，只不过状态为 CANCEL_OVERRIDE，具体逻辑在&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">EurekaServiceRegistry.setStatus()</span></code><span style="font-size: 15px;">&nbsp;中，其等同于直接调用Eureka Server API ：&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DELETE /eureka/v2/apps/appID/instanceID/status</span></code><span style="font-size: 15px;">，可以让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN</span></p></li> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">也可以用&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">端点，状态为UP，可使得Server端 status=UP且 overriddenstatus=UP，虽然可以临时起到上线目的，但 overriddenstatus=UP 仍需要上一步的DELETE请求才能清楚，很麻烦，不建议使用</span></p></li> 
  <li><p style="max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">不通过Eureka Client的端点，直接调用Eureka Server端点：&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">DELETE /eureka/apps/appID/instanceID/status?value=UP</span></code></p></li> 
 </ul> 
 <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">实际使用过程中建议如下顺序</span></p></li> 
 <ul class=" list-paddingleft-2" style="list-style-type: square;"> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">缓存刷新时间</strong>&nbsp;指的是Eureka Server刷新只读缓存、Eureka Client刷新本地服务列表、Ribbon刷新ServerList的时间，默认都是30s，可以适当缩短缓存刷新时间</span></p> 
   <section class="code-snippet__fix code-snippet__js"> 
    <ul class="code-snippet__line-index code-snippet__js"> 
     <li></li> 
     <li></li> 
     <li></li> 
     <li></li> 
     <li></li> 
     <li></li> 
     <li></li> 
    </ul> 
    <pre class="code-snippet__js" data-lang="cs"><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"># Eureka Server端配置</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">eureka.server.responseCacheUpdateIntervalMs=5000</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">eureka.server.eviction-interval-timer-in-ms=5000</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><br></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"># Eureka Client端配置</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">eureka.client.registryFetchIntervalSeconds=5</span></span></code><code style="max-width: 1000%;text-align: left;white-space: pre;display: flex;font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace;box-sizing: border-box !important;word-wrap: break-word !important;"><span class="code-snippet_outer"><span style="max-width: 1000%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">ribbon.ServerListRefreshInterval=5000</span></span></code></pre> 
   </section></li> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">单个请求处理时间</strong>&nbsp;是为了怕服务还有请求没处理完</span></p></li> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">1、调用</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">端点将状态置为 OUT_OF_SERVICE</span></p></li> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">2、sleep 缓存刷新时间 + 单个请求处理时间</span></p></li> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">3、调用&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/service-registry</span></code><span style="font-size: 15px;">端点将状态置为 CANCEL_OVERRIDE，其实就是向Server端发送DELETE overriddenstatus的请求，这会让Server端 status=UNKNOWN 且 overriddenstatus=UNKNOWN</span></p></li> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">4、使用&nbsp;</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">/shutdown</span></code><span style="font-size: 15px;">端点 或 暴利</span><code style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">kill -9</span></code><span style="font-size: 15px;">终止服务</span></p></li> 
  <li><p style="margin-top: 20px;margin-bottom: 20px;max-width: 100%;min-height: 1em;font-size: 16px;line-height: 1.7;box-sizing: border-box !important;word-wrap: break-word !important;text-align: justify;"><span style="font-size: 15px;">5、发版部署后，启动服务注册到Eureka Server，服务状态变为UP</span></p></li> 
 </ul> 
</ul> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);text-align: justify;margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">方式五： 直接调用Eureka Server Rest API【可用，但URL比较复杂】</strong></span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">上面说了这么多，其实这些都是针对Eureka Server Rest API在Eureka客户端上的封装，即通过Eureka Client服务由于引入了actuator，增加了一系列端点，其实一些端点通过调用Eureka Server暴露的Rest API的方式实现Eureka实例服务下线功能</span></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">Eureka Rest API包括：</strong></span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;text-align: justify;background-color: rgb(255, 255, 255);margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><img class="rich_pages" data-ratio="0.4419672131147541" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/XA3sPCPib1l4dFVGEcnAhUMMj3zrfLiclwaSd5KFqZFZV58IXw11zCesc6xuhtnA4FuDQQHahYaG0yh90RzHNu6Q/640?wx_fmt=png" data-type="png" data-w="1525" style="box-sizing: border-box !important;word-wrap: break-word !important;width: 677px !important;visibility: visible !important;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/XA3sPCPib1l4dFVGEcnAhUMMj3zrfLiclwaSd5KFqZFZV58IXw11zCesc6xuhtnA4FuDQQHahYaG0yh90RzHNu6Q/640?wx_fmt=png"></p> 
<p style="margin: 20px 8px;max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 1.7;white-space: normal;widows: 1;font-size: 16px;background-color: rgb(255, 255, 255);text-align: justify;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="font-size: 15px;">其中大多数非查询类的操作在之前分析Eureka Client的端点时都分析过了，其实调用Eureka Server的Rest API是最直接的，但由于目前多采用一些类似Jenkins的发版部署工具，其中操作均在脚本中执行，Eureka Server API虽好，但URL中都涉及<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">appID</strong>&nbsp;、<strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;">instanceID</strong>，对于制作通用的脚本来说拼接出调用端点的URL有一定难度，且不像调用本地服务端点IP使用localhost 或 127.0.0.1即可，需要指定Eureka Server地址，所以整理略显复杂。不过在比较规范化的公司中，也是不错的选择。</span></p> 
<p style="max-width: 100%;min-height: 1em;font-variant-numeric: normal;font-variant-east-asian: normal;letter-spacing: 0.544px;line-height: 27.2px;white-space: normal;widows: 1;background-color: rgb(255, 255, 255);margin-left: 8px;margin-right: 8px;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="color: rgb(0, 0, 0);font-family: 微软雅黑;text-align: center;text-indent: 32px;font-size: 16px;letter-spacing: 0.544px;white-space: pre-line;">&nbsp;</span><br></p> 
<p style="text-align: center;margin-left: 8px;margin-right: 8px;"><img class="" data-copyright="0" data-ratio="0.04523809523809524" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/1hReHaqafafJYoFH7OAhmUdTjo35vvJTy1lRVjG2CzFP3arfVRDqI7a8PSS6Sx5LialaFTE1HFu2N4OIhL8jP9g/640?wx_fmt=png" data-type="png" data-w="420" style="letter-spacing: 0.544px;line-height: 29.75px;box-sizing: border-box !important;word-wrap: break-word !important;width: 420px !important;visibility: visible !important;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/1hReHaqafafJYoFH7OAhmUdTjo35vvJTy1lRVjG2CzFP3arfVRDqI7a8PSS6Sx5LialaFTE1HFu2N4OIhL8jP9g/640?wx_fmt=png"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
<p style="text-align: center;margin-left: 8px;margin-right: 8px;"><br></p> 
<p style="margin-right: 8px;margin-left: 8px;white-space: normal;max-width: 100%;min-height: 1em;letter-spacing: 0.544px;widows: 1;line-height: 1.4;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"><span style="padding: 0.2em 0.5em;max-width: 100%;border-radius: 0.3em;color: white;font-size: 1em;font-family: inherit;font-weight: inherit;text-align: inherit;text-decoration: inherit;background-color: rgb(255, 105, 31);box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;">福利</span></strong></p> 
<section class="" style="margin-top: -0.7em;font-size: 1em;white-space: normal;max-width: 100%;letter-spacing: 0.544px;line-height: 27.2px;widows: 1;border-width: 1px;border-style: solid;border-color: rgb(255, 105, 31);border-radius: 0.4em;background-color: rgb(255, 255, 255);box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"> 
 <section style="padding: 1.4em 1em 1em;max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"> 
  <section style="max-width: 100%;font-size: 1em;font-family: inherit;text-align: inherit;text-decoration: inherit;box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"> 
   <p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">扫描添加小编微信，备注“</span></strong><span style="max-width: 100%;color: rgb(255, 104, 39);box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">姓名+公司职位</span></strong></span><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">”，加入【</span></strong><span style="max-width: 100%;color: rgb(255, 104, 39);box-sizing: border-box !important;word-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">云计算学习交流群</span></strong></span><strong style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">】，和志同道合的朋友们共同打卡学习！</span></strong></p> 
   <p style="margin-right: 8px;margin-left: 8px;max-width: 100%;min-height: 1em;box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"><br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"></p> 
   <p style="text-align: center;"><img class="rich_pages" data-copyright="0" data-ratio="1.005813953488372" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/zxoLaeCI28QDZW3ZeMemRs5PPyI20qxP8zicUCD67ia0kT4tk9BTQ6OaiaGTrvMQzl6sfmlRmFhKBcuibvRsxg3ktA/640?wx_fmt=jpeg" data-type="jpeg" data-w="516" style="height: 156px;width: 155px;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/zxoLaeCI28QDZW3ZeMemRs5PPyI20qxP8zicUCD67ia0kT4tk9BTQ6OaiaGTrvMQzl6sfmlRmFhKBcuibvRsxg3ktA/640?wx_fmt=jpeg"></p> 
  </section> 
 </section> 
</section> 
<p style="text-align: center;margin-left: 8px;margin-right: 8px;"><br></p> 
<p style="margin-right: 8px;margin-left: 8px;white-space: normal;max-width: 100%;min-height: 1em;font-size: 15px;letter-spacing: 0.544px;line-height: 1.75em;box-sizing: border-box !important;word-wrap: break-word !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;text-indent: 28px;font-family: arial, 宋体, sans-serif;letter-spacing: 1px;overflow-wrap: break-word;box-sizing: border-box !important;word-wrap: break-word !important;"><span style="max-width: 100%;letter-spacing: 0.5px;overflow-wrap: break-word;box-sizing: border-box !important;word-wrap: break-word !important;">推荐阅读：</span></strong></p> 
<ul class=" list-paddingleft-2" style="margin-left: 8px;margin-right: 8px;"> 
 <li><h2 style="max-width: 100%;letter-spacing: 0.54px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="https://mp.weixin.qq.com/s?__biz=MzA3MjY1MTQwNQ==&amp;mid=2649827524&amp;idx=2&amp;sn=4e4ef8fb348292834fc6cdb5d991abbe&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px;text-decoration: underline;" data-linktype="2"><span style="font-size: 15px;">太形象了！什么是边缘计算？最有趣的解释没有之一！</span></a></h2></li> 
 <li><h2 style="max-width: 100%;letter-spacing: 0.54px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="https://mp.weixin.qq.com/s?__biz=MjM5MjAwODM4MA==&amp;mid=2650719490&amp;idx=1&amp;sn=dc628b2516de6aaf4d458bfad0e4ad1a&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px;text-decoration: underline;" data-linktype="2"><span style="font-size: 15px;">互联网出海十年</span></a></h2></li> 
 <li><h2 style="max-width: 100%;letter-spacing: 0.54px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="https://mp.weixin.qq.com/s?__biz=MzA5MzY4NTQwMA==&amp;mid=2651010707&amp;idx=1&amp;sn=aeca20839d93b82db6b7f654b60b9b49&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px;text-decoration: underline;" data-linktype="2"><span style="font-size: 15px;">华为员工年薪 200 万！真相让人心酸！</span></a></h2></li> 
 <li><h2 style="max-width: 100%;letter-spacing: 0.54px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="https://mp.weixin.qq.com/s?__biz=Mzg3MDA4NDkxMQ==&amp;mid=2247483906&amp;idx=1&amp;sn=028974f5b9a583116b453ea947113916&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px;text-decoration: underline;" data-linktype="2"><span style="font-size: 15px;">天才程序员：25 岁进贝尔实验室，32 岁创建信息论 &nbsp;琥珀 &nbsp;极客宝宝 &nbsp;5天前</span></a></h2></li> 
 <li><h2 style="max-width: 100%;letter-spacing: 0.54px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="https://mp.weixin.qq.com/s?__biz=MzU2MTE1NDk2Mg==&amp;mid=2247494919&amp;idx=1&amp;sn=5874d3b2eaf4cda3d6ff74d2aba97a30&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px;text-decoration: underline;" data-linktype="2"><span style="font-size: 15px;">安全顾问反水成黑客, 靠瞎猜盗得5000万美元的以太币, 一个区块链大盗的另类传奇</span></a></h2></li> 
 <li><h2 style="max-width: 100%;letter-spacing: 0.54px;box-sizing: border-box !important;word-wrap: break-word !important;"><a href="https://mp.weixin.qq.com/s?__biz=MzI0ODcxODk5OA==&amp;mid=2247504798&amp;idx=1&amp;sn=fab3271deb222c619046e123186307e3&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 15px;text-decoration: underline;" data-linktype="2"><span style="font-size: 15px;">人造器官新突破！美国科学家3D打印出会“呼吸”的肺 | Science</span></a><br></h2></li> 
</ul> 
<section data-role="outer" label="Powered by 135editor.com" style="white-space: normal;max-width: 100%;font-size: 15px;letter-spacing: 0.544px;line-height: 27.2px;box-sizing: border-box !important;word-wrap: break-word !important;"> 
 <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
  <section class="" data-tools="135编辑器" data-id="94174" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
   <section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
    <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;letter-spacing: 0.544px;line-height: 27.2px;box-sizing: border-box !important;word-wrap: break-word !important;"> 
     <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
      <section class="" data-tools="135编辑器" data-id="94174" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
       <section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
        <section style="max-width: 100%;text-align: right;box-sizing: border-box !important;word-wrap: break-word !important;"> 
         <br style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
        </section> 
        <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;letter-spacing: 0.544px;line-height: 27.2px;box-sizing: border-box !important;word-wrap: break-word !important;"> 
         <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
          <section class="" data-tools="135编辑器" data-id="94174" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
           <section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
            <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;letter-spacing: 0.544px;line-height: 27.2px;box-sizing: border-box !important;word-wrap: break-word !important;"> 
             <section data-role="outer" label="Powered by 135editor.com" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
              <section class="" data-tools="135编辑器" data-id="94174" style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
               <section style="max-width: 100%;box-sizing: border-box !important;word-wrap: break-word !important;"> 
                <section style="max-width: 100%;text-align: right;box-sizing: border-box !important;word-wrap: break-word !important;"> 
                 <section style="margin-top: -6.4px;margin-left: -16px;max-width: 197px;font-family: 微软雅黑;font-size: 16px;letter-spacing: 0.544px;line-height: 25.6px;float: right;transform: matrix(1, 0, 0, 1, 0, 0);width: 16px;box-sizing: border-box !important;word-wrap: break-word !important;"> 
                  <img class="" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_png/Pn4Sm0RsAujO0pvtNCLzZCiaWxGBfq2xaPwze1NRLTSQZYbzWNnTJwDwsReHiam91Wojzvw3RLibjicWkLWJjicgsvw/640?wx_fmt=png" data-type="png" data-w="23" data-width="100%" style="max-width: 16px;display: block;box-sizing: border-box !important;word-wrap: break-word !important;visibility: visible !important;width: 15.99px !important;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/Pn4Sm0RsAujO0pvtNCLzZCiaWxGBfq2xaPwze1NRLTSQZYbzWNnTJwDwsReHiam91Wojzvw3RLibjicWkLWJjicgsvw/640?wx_fmt=png"> 
                 </section> 
                 <section data-brushtype="text" style="padding: 10px 16px;max-width: 197px;font-family: 微软雅黑;font-size: 16px;line-height: 25.6px;border-radius: 10px;color: rgb(73, 73, 72);display: inline-block;font-weight: 700;letter-spacing: 1.5px;text-align: center;background: none 0% 0% / auto repeat scroll padding-box border-box rgb(253, 245, 13);box-sizing: border-box !important;word-wrap: break-word !important;"> 
                  <span style="max-width: 100%;font-size: 15px;box-sizing: border-box !important;word-wrap: break-word !important;">真香，朕在看了！</span> 
                 </section> 
                </section> 
               </section> 
              </section> 
             </section> 
            </section> 
           </section> 
          </section> 
         </section> 
        </section> 
       </section> 
      </section> 
     </section> 
    </section> 
   </section> 
  </section> 
 </section> 
</section>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
