<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>LVS 负载均衡原理及安装配置简明指南 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="LVS 负载均衡原理及安装配置简明指南" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Linux编程 点击右侧关注，免费入门到精通！ 作者丨肖邦Linux http://www.cnblogs.com/liwei0526vip/p/6370103.html 负载均衡集群是 load balance 集群的简写，翻译成中文就是负载均衡集群。常用的负载均衡开源软件有nginx、lvs、haproxy，商业的硬件负载均衡设备F5、Netscale。这里主要是学习 LVS 并对其进行了详细的总结记录。 一、负载均衡LVS基本介绍 LB集群的架构和原理很简单，就是当用户的请求过来时，会直接分发到Director Server上，然后它把用户的请求根据设置好的调度算法，智能均衡地分发到后端真正服务器(real server)上。为了避免不同机器上用户请求得到的数据不一样，需要用到了共享存储，这样保证所有用户请求的数据是一样的。 LVS是 Linux Virtual Server 的简称，也就是Linux虚拟服务器。这是一个由章文嵩博士发起的一个开源项目，它的官方网是&nbsp;http://www.linuxvirtualserver.org&nbsp;现在 LVS 已经是 Linux 内核标准的一部分。使用 LVS 可以达到的技术目标是：通过 LVS 达到的负载均衡技术和 Linux 操作系统实现一个高性能高可用的 Linux 服务器集群，它具有良好的可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的性能。LVS 是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上可分为调度层、Server集群层和共享存储。 二、LVS的基本工作原理 1. 当用户向负载均衡调度器（Director Server）发起请求，调度器将请求发往至内核空间 2.&nbsp;PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链 3.&nbsp;IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链 4.&nbsp;POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器 三、LVS的组成 LVS 由2部分程序组成，包括 ipvs 和 ipvsadm。 1.ipvs(ip virtual server)：一段代码工作在内核空间，叫ipvs，是真正生效实现调度的代码。 2. ipvsadm：另外一段是工作在用户空间，叫ipvsadm，负责为ipvs内核框架编写规则，定义谁是集群服务，而谁是后端真实的服务器(Real Server) 四、LVS相关术语 1. DS：Director Server。指的是前端负载均衡器节点。2. RS：Real Server。后端真实的工作服务器。3. VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。4. DIP：Director Server IP，主要用于和内部主机通讯的IP地址。5. RIP：Real Server IP，后端服务器的IP地址。6. CIP：Client IP，访问客户端的IP地址。 下边是三种工作模式的原理和特点总结。 五、LVS/NAT原理和特点 1. 重点理解NAT方式的实现原理和数据包的改变。 (a). 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP (b). PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c). IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，然后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP (d). POSTROUTING链通过选路，将数据包发送给Real Server (e). Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP (f). Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP 2. LVS-NAT模型的特性 RS应该使用私有地址，RS的网关必须指向DIP DIP和RIP必须在同一个网段内 请求和响应报文都需要经过Director Server，高负载场景中，Director Server易成为性能瓶颈 支持端口映射 RS可以使用任意操作系统 缺陷：对Director Server压力会比较大，请求和响应都需经过director server 六、LVS/DR原理和特点 1.重将请求报文的目标MAC地址设定为挑选出的RS的MAC地址 (a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP (b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址 (d)&nbsp;由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。 (e)&nbsp;RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP (f)&nbsp;响应报文最终送达至客户端 2. LVS-DR模型的特性 特点1：保证前端路由将目标地址为VIP报文统统发给Director Server，而不是RS RS可以使用私有地址；也可以是公网地址，如果使用公网地址，此时可以通过互联网对RIP进行直接访问 RS跟Director Server必须在同一个物理网络中 所有的请求报文经由Director Server，但响应报文必须不能进过Director Server 不支持地址转换，也不支持端口映射 RS可以是大多数常见的操作系统 RS的网关绝不允许指向DIP(因为我们不允许他经过director) RS上的lo接口配置VIP的IP地址 缺陷：RS和DS必须在同一机房中 3. 特点1的解决方案： 在前端路由器做静态地址路由绑定，将对于VIP的地址仅路由到Director Server 存在问题：用户未必有路由操作权限，因为有可能是运营商提供的，所以这个方法未必实用 arptables：在arp的层次上实现在ARP解析时做防火墙规则，过滤RS响应ARP请求。这是由iptables提供的 修改RS上内核参数（arp_ignore和arp_announce）将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。 七、LVS/Tun原理和特点 在原有的IP报文外再次封装多一层IP首部，内部IP首部(源地址为CIP，目标IIP为VIP)，外层IP首部(源地址为DIP，目标IP为RIP) (a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。 (b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP (d)&nbsp;POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP (e)&nbsp;RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP (f)&nbsp;响应报文最终送达至客户端 LVS-Tun模型特性 RIP、VIP、DIP全是公网地址 RS的网关不会也不可能指向DIP 所有的请求报文经由Director Server，但响应报文必须不能进过Director Server 不支持端口映射 RS的系统必须支持隧道 其实企业中最常用的是 DR 实现方式，而 NAT 配置上比较简单和方便，后边实践中会总结 DR 和 NAT 具体使用配置过程。 八、LVS的八种调度算法 1.轮叫调度 rr 这种算法是最简单的，就是按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点就是简单。轮询算法假设所有的服务器处理请求的能力都是一样的，调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。 2. 加权轮叫 wrr 这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加要给权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。 3. 最少链接 lc 这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1 4. 加权最少链接 wlc 这个算法比 lc 多了一个权重的概念。 5. 基于局部性的最少连接调度算法 lblc 这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器 6. 复杂的基于局部性最少的连接算法 lblcr 记录的不是要给目标 IP 与一台服务器之间的连接记录，它会维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。 7. 目标地址散列调度算法 dh 该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。 8. 源地址散列调度算法 sh 与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。 九、实践LVS的NAT模式 1、实验环境 三台服务器，一台作为 director，两台作为 real server，director 有一个外网网卡(172.16.254.200) 和一个内网ip(192.168.0.8)，两个 real server 上只有内网 ip (192.168.0.18) 和 (192.168.0.28)，并且需要把两个 real server 的内网网关设置为 director 的内网 ip(192.168.0.8) 2、安装和配置 两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginxDirector&nbsp;上安装&nbsp;ipvsadm#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm Director 上编辑 nat 实现脚本 #&nbsp;vim&nbsp;/usr/local/sbin/lvs_nat.sh#&nbsp;编辑写入如下内容：#!&nbsp;/bin/bash#&nbsp;director服务器上开启路由转发功能:echo&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward#&nbsp;关闭&nbsp;icmp&nbsp;的重定向echo&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/all/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/default/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth0/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth1/send_redirects#&nbsp;director设置&nbsp;nat&nbsp;防火墙iptables&nbsp;-t&nbsp;nat&nbsp;-Fiptables&nbsp;-t&nbsp;nat&nbsp;-Xiptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;POSTROUTING&nbsp;-s&nbsp;192.168.0.0/24&nbsp;-j&nbsp;MASQUERADE#&nbsp;director设置&nbsp;ipvsadmIPVSADM=&#39;/sbin/ipvsadm&#39;$IPVSADM&nbsp;-C$IPVSADM&nbsp;-A&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-s&nbsp;wrr$IPVSADM&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.18:80&nbsp;-m&nbsp;-w&nbsp;1$IPVSADM&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.28:80&nbsp;-m&nbsp;-w&nbsp;1 保存后，在 Director 上直接运行这个脚本就可以完成 lvs/nat 的配置 /bin/bash&nbsp;/usr/local/sbin/lvs_nat.sh 查看ipvsadm设置的规则 ipvsadm&nbsp;-ln 3、测试LVS的效果 通过浏览器测试2台机器上的web内容&nbsp;http://172.16.254.200&nbsp;。为了区分开，我们可以把 nginx 的默认页修改一下： 在&nbsp;RS1&nbsp;上执行#&nbsp;echo&nbsp;&quot;rs1rs1&quot;&nbsp;&gt;/usr/share/nginx/html/index.html在&nbsp;RS2&nbsp;上执行#&nbsp;echo&nbsp;&quot;rs2rs2&quot;&nbsp;&gt;/usr/share/nginx/html/index.html 注意，切记一定要在两台 RS 上设置网关的 IP 为 director 的内网 IP。 十、实践LVS的DR模式 1、实验环境 三台机器： Director节点： &nbsp;(eth0 192.168.0.8&nbsp; vip eth0:0 192.168.0.38) Real server1： (eth0 192.168.0.18 vip lo:0 192.168.0.38) Real server2： (eth0 192.168.0.28 vip lo:0 192.168.0.38) 2、安装 两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginxDirector&nbsp;上安装&nbsp;ipvsadm#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm 3、Director 上配置脚本 #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr.sh#!&nbsp;/bin/bashecho&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forwardipv=/sbin/ipvsadmvip=192.168.0.38rs1=192.168.0.18rs2=192.168.0.28ifconfig&nbsp;eth0:0&nbsp;downifconfig&nbsp;eth0:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;dev&nbsp;eth0:0$ipv&nbsp;-C$ipv&nbsp;-A&nbsp;-t&nbsp;$vip:80&nbsp;-s&nbsp;wrr$ipv&nbsp;-a&nbsp;-t&nbsp;$vip:80&nbsp;-r&nbsp;$rs1:80&nbsp;-g&nbsp;-w&nbsp;3$ipv&nbsp;-a&nbsp;-t&nbsp;$vip:80&nbsp;-r&nbsp;$rs2:80&nbsp;-g&nbsp;-w&nbsp;1 执行脚本： #&nbsp;bash&nbsp;/usr/local/sbin/lvs_dr.sh 4、在2台 rs 上配置脚本： #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh#!&nbsp;/bin/bashvip=192.168.0.38ifconfig&nbsp;lo:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;lo:0echo&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce rs 上分别执行脚本： bash&nbsp;/usr/local/sbin/lvs_dr_rs.sh 5、实验测试 测试方式同上，浏览器访问&nbsp;http://192.168.0.38 注意：在 DR 模式下，2台 rs 节点的 gateway 不需要设置成 dir 节点的 IP 。 参考链接地址： http://www.cnblogs.com/lgfeng/archive/2012/10/16/2726308.html 十一、LVS结合keepalive LVS可以实现负载均衡，但是不能够进行健康检查，比如一个rs出现故障，LVS 仍然会把请求转发给故障的rs服务器，这样就会导致请求的无效性。keepalive 软件可以进行健康检查，而且能同时实现 LVS 的高可用性，解决 LVS 单点故障的问题，其实 keepalive 就是为 LVS 而生的。 1、实验环境 4台节点 Keepalived1 + lvs1(Director1)：192.168.0.48 Keepalived2 + lvs2(Director2)：192.168.0.58 Real server1：192.168.0.18 Real server2：192.168.0.28 IP: 192.168.0.38 2、安装系统软件 Lvs + keepalived的2个节点安装 #&nbsp;yum&nbsp;install&nbsp;ipvsadm&nbsp;keepalived&nbsp;-y Real server + nginx服务的2个节点安装 #&nbsp;yum&nbsp;install&nbsp;epel-release&nbsp;-y#&nbsp;yum&nbsp;install&nbsp;nginx&nbsp;-y 3、设置配置脚本 Real server节点2台配置脚本： #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh#!&nbsp;/bin/bashvip=192.168.0.38ifconfig&nbsp;lo:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;lo:0echo&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce2节点rs&nbsp;上分别执行脚本：bash&nbsp;/usr/local/sbin/lvs_dr_rs.sh keepalived节点配置(2节点)： 主节点(&nbsp;MASTER&nbsp;)配置文件vim&nbsp;/etc/keepalived/keepalived.confvrrp_instance&nbsp;VI_1&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;MASTER&nbsp;&nbsp;&nbsp;&nbsp;interface&nbsp;eth0&nbsp;&nbsp;&nbsp;&nbsp;virtual_router_id&nbsp;51&nbsp;&nbsp;&nbsp;&nbsp;priority&nbsp;100&nbsp;&nbsp;&nbsp;&nbsp;advert_int&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;authentication&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_type&nbsp;PASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_pass&nbsp;1111&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;virtual_ipaddress&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;192.168.0.38&nbsp;&nbsp;&nbsp;&nbsp;}}virtual_server&nbsp;192.168.0.38&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;delay_loop&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;lb_algo&nbsp;rr&nbsp;&nbsp;&nbsp;&nbsp;lb_kind&nbsp;DR&nbsp;&nbsp;&nbsp;&nbsp;persistence_timeout&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;protocol&nbsp;TCP&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;192.168.0.18&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;192.168.0.28&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}} 从节点( BACKUP )配置文件 拷贝主节点的配置文件keepalived.conf，然后修改如下内容： state&nbsp;MASTER&nbsp;-&gt;&nbsp;state&nbsp;BACKUPpriority&nbsp;100&nbsp;-&gt;&nbsp;priority&nbsp;90 keepalived的2个节点执行如下命令，开启转发功能： #&nbsp;echo&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward 4、启动keepalive &lt;strong&gt;先主后从分别启动keepalive&lt;/strong&gt;service&nbsp;keepalived&nbsp;start 5、验证结果 实验1 手动关闭192.168.0.18节点的nginx，service&nbsp;nginx stop 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，不会出现访问18节点，一直访问的是28节点的内容。 实验2 手动重新开启 192.168.0.18 节点的nginx，&nbsp;service&nbsp;nginx start 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，按照 rr 调度算法访问18节点和28节点。 实验3 测试 keepalived 的HA特性，首先在master上执行命令 ip addr ，可以看到38的vip在master节点上的；这时如果在master上执行&nbsp;service&nbsp;keepalived stop 命令，这时vip已经不再master上，在slave节点上执行 ip addr 命令可以看到 vip 已经正确漂到slave节点，这时客户端去访问&nbsp;http://192.168.0.38&nbsp;访问依然正常，验证了 keepalived的HA特性。 lvs 介绍： http://www.it165.net/admin/html/201401/2248.html &nbsp;推荐↓↓↓&nbsp; 长 按 关 注 👉【16个技术公众号】都在这里！ 涵盖：程序员大咖、源码共读、程序员共读、数据结构与算法、黑客技术和网络安全、大数据科技、编程前端、Java、Python、Web编程开发、Android、iOS开发、Linux、数据库研发、幽默程序员等。 万水千山总是情，点个 “ 好看” 行不行" />
<meta property="og:description" content="Linux编程 点击右侧关注，免费入门到精通！ 作者丨肖邦Linux http://www.cnblogs.com/liwei0526vip/p/6370103.html 负载均衡集群是 load balance 集群的简写，翻译成中文就是负载均衡集群。常用的负载均衡开源软件有nginx、lvs、haproxy，商业的硬件负载均衡设备F5、Netscale。这里主要是学习 LVS 并对其进行了详细的总结记录。 一、负载均衡LVS基本介绍 LB集群的架构和原理很简单，就是当用户的请求过来时，会直接分发到Director Server上，然后它把用户的请求根据设置好的调度算法，智能均衡地分发到后端真正服务器(real server)上。为了避免不同机器上用户请求得到的数据不一样，需要用到了共享存储，这样保证所有用户请求的数据是一样的。 LVS是 Linux Virtual Server 的简称，也就是Linux虚拟服务器。这是一个由章文嵩博士发起的一个开源项目，它的官方网是&nbsp;http://www.linuxvirtualserver.org&nbsp;现在 LVS 已经是 Linux 内核标准的一部分。使用 LVS 可以达到的技术目标是：通过 LVS 达到的负载均衡技术和 Linux 操作系统实现一个高性能高可用的 Linux 服务器集群，它具有良好的可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的性能。LVS 是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上可分为调度层、Server集群层和共享存储。 二、LVS的基本工作原理 1. 当用户向负载均衡调度器（Director Server）发起请求，调度器将请求发往至内核空间 2.&nbsp;PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链 3.&nbsp;IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链 4.&nbsp;POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器 三、LVS的组成 LVS 由2部分程序组成，包括 ipvs 和 ipvsadm。 1.ipvs(ip virtual server)：一段代码工作在内核空间，叫ipvs，是真正生效实现调度的代码。 2. ipvsadm：另外一段是工作在用户空间，叫ipvsadm，负责为ipvs内核框架编写规则，定义谁是集群服务，而谁是后端真实的服务器(Real Server) 四、LVS相关术语 1. DS：Director Server。指的是前端负载均衡器节点。2. RS：Real Server。后端真实的工作服务器。3. VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。4. DIP：Director Server IP，主要用于和内部主机通讯的IP地址。5. RIP：Real Server IP，后端服务器的IP地址。6. CIP：Client IP，访问客户端的IP地址。 下边是三种工作模式的原理和特点总结。 五、LVS/NAT原理和特点 1. 重点理解NAT方式的实现原理和数据包的改变。 (a). 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP (b). PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c). IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，然后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP (d). POSTROUTING链通过选路，将数据包发送给Real Server (e). Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP (f). Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP 2. LVS-NAT模型的特性 RS应该使用私有地址，RS的网关必须指向DIP DIP和RIP必须在同一个网段内 请求和响应报文都需要经过Director Server，高负载场景中，Director Server易成为性能瓶颈 支持端口映射 RS可以使用任意操作系统 缺陷：对Director Server压力会比较大，请求和响应都需经过director server 六、LVS/DR原理和特点 1.重将请求报文的目标MAC地址设定为挑选出的RS的MAC地址 (a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP (b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址 (d)&nbsp;由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。 (e)&nbsp;RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP (f)&nbsp;响应报文最终送达至客户端 2. LVS-DR模型的特性 特点1：保证前端路由将目标地址为VIP报文统统发给Director Server，而不是RS RS可以使用私有地址；也可以是公网地址，如果使用公网地址，此时可以通过互联网对RIP进行直接访问 RS跟Director Server必须在同一个物理网络中 所有的请求报文经由Director Server，但响应报文必须不能进过Director Server 不支持地址转换，也不支持端口映射 RS可以是大多数常见的操作系统 RS的网关绝不允许指向DIP(因为我们不允许他经过director) RS上的lo接口配置VIP的IP地址 缺陷：RS和DS必须在同一机房中 3. 特点1的解决方案： 在前端路由器做静态地址路由绑定，将对于VIP的地址仅路由到Director Server 存在问题：用户未必有路由操作权限，因为有可能是运营商提供的，所以这个方法未必实用 arptables：在arp的层次上实现在ARP解析时做防火墙规则，过滤RS响应ARP请求。这是由iptables提供的 修改RS上内核参数（arp_ignore和arp_announce）将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。 七、LVS/Tun原理和特点 在原有的IP报文外再次封装多一层IP首部，内部IP首部(源地址为CIP，目标IIP为VIP)，外层IP首部(源地址为DIP，目标IP为RIP) (a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。 (b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP (d)&nbsp;POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP (e)&nbsp;RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP (f)&nbsp;响应报文最终送达至客户端 LVS-Tun模型特性 RIP、VIP、DIP全是公网地址 RS的网关不会也不可能指向DIP 所有的请求报文经由Director Server，但响应报文必须不能进过Director Server 不支持端口映射 RS的系统必须支持隧道 其实企业中最常用的是 DR 实现方式，而 NAT 配置上比较简单和方便，后边实践中会总结 DR 和 NAT 具体使用配置过程。 八、LVS的八种调度算法 1.轮叫调度 rr 这种算法是最简单的，就是按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点就是简单。轮询算法假设所有的服务器处理请求的能力都是一样的，调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。 2. 加权轮叫 wrr 这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加要给权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。 3. 最少链接 lc 这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1 4. 加权最少链接 wlc 这个算法比 lc 多了一个权重的概念。 5. 基于局部性的最少连接调度算法 lblc 这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器 6. 复杂的基于局部性最少的连接算法 lblcr 记录的不是要给目标 IP 与一台服务器之间的连接记录，它会维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。 7. 目标地址散列调度算法 dh 该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。 8. 源地址散列调度算法 sh 与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。 九、实践LVS的NAT模式 1、实验环境 三台服务器，一台作为 director，两台作为 real server，director 有一个外网网卡(172.16.254.200) 和一个内网ip(192.168.0.8)，两个 real server 上只有内网 ip (192.168.0.18) 和 (192.168.0.28)，并且需要把两个 real server 的内网网关设置为 director 的内网 ip(192.168.0.8) 2、安装和配置 两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginxDirector&nbsp;上安装&nbsp;ipvsadm#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm Director 上编辑 nat 实现脚本 #&nbsp;vim&nbsp;/usr/local/sbin/lvs_nat.sh#&nbsp;编辑写入如下内容：#!&nbsp;/bin/bash#&nbsp;director服务器上开启路由转发功能:echo&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward#&nbsp;关闭&nbsp;icmp&nbsp;的重定向echo&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/all/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/default/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth0/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth1/send_redirects#&nbsp;director设置&nbsp;nat&nbsp;防火墙iptables&nbsp;-t&nbsp;nat&nbsp;-Fiptables&nbsp;-t&nbsp;nat&nbsp;-Xiptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;POSTROUTING&nbsp;-s&nbsp;192.168.0.0/24&nbsp;-j&nbsp;MASQUERADE#&nbsp;director设置&nbsp;ipvsadmIPVSADM=&#39;/sbin/ipvsadm&#39;$IPVSADM&nbsp;-C$IPVSADM&nbsp;-A&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-s&nbsp;wrr$IPVSADM&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.18:80&nbsp;-m&nbsp;-w&nbsp;1$IPVSADM&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.28:80&nbsp;-m&nbsp;-w&nbsp;1 保存后，在 Director 上直接运行这个脚本就可以完成 lvs/nat 的配置 /bin/bash&nbsp;/usr/local/sbin/lvs_nat.sh 查看ipvsadm设置的规则 ipvsadm&nbsp;-ln 3、测试LVS的效果 通过浏览器测试2台机器上的web内容&nbsp;http://172.16.254.200&nbsp;。为了区分开，我们可以把 nginx 的默认页修改一下： 在&nbsp;RS1&nbsp;上执行#&nbsp;echo&nbsp;&quot;rs1rs1&quot;&nbsp;&gt;/usr/share/nginx/html/index.html在&nbsp;RS2&nbsp;上执行#&nbsp;echo&nbsp;&quot;rs2rs2&quot;&nbsp;&gt;/usr/share/nginx/html/index.html 注意，切记一定要在两台 RS 上设置网关的 IP 为 director 的内网 IP。 十、实践LVS的DR模式 1、实验环境 三台机器： Director节点： &nbsp;(eth0 192.168.0.8&nbsp; vip eth0:0 192.168.0.38) Real server1： (eth0 192.168.0.18 vip lo:0 192.168.0.38) Real server2： (eth0 192.168.0.28 vip lo:0 192.168.0.38) 2、安装 两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginxDirector&nbsp;上安装&nbsp;ipvsadm#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm 3、Director 上配置脚本 #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr.sh#!&nbsp;/bin/bashecho&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forwardipv=/sbin/ipvsadmvip=192.168.0.38rs1=192.168.0.18rs2=192.168.0.28ifconfig&nbsp;eth0:0&nbsp;downifconfig&nbsp;eth0:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;dev&nbsp;eth0:0$ipv&nbsp;-C$ipv&nbsp;-A&nbsp;-t&nbsp;$vip:80&nbsp;-s&nbsp;wrr$ipv&nbsp;-a&nbsp;-t&nbsp;$vip:80&nbsp;-r&nbsp;$rs1:80&nbsp;-g&nbsp;-w&nbsp;3$ipv&nbsp;-a&nbsp;-t&nbsp;$vip:80&nbsp;-r&nbsp;$rs2:80&nbsp;-g&nbsp;-w&nbsp;1 执行脚本： #&nbsp;bash&nbsp;/usr/local/sbin/lvs_dr.sh 4、在2台 rs 上配置脚本： #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh#!&nbsp;/bin/bashvip=192.168.0.38ifconfig&nbsp;lo:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;lo:0echo&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce rs 上分别执行脚本： bash&nbsp;/usr/local/sbin/lvs_dr_rs.sh 5、实验测试 测试方式同上，浏览器访问&nbsp;http://192.168.0.38 注意：在 DR 模式下，2台 rs 节点的 gateway 不需要设置成 dir 节点的 IP 。 参考链接地址： http://www.cnblogs.com/lgfeng/archive/2012/10/16/2726308.html 十一、LVS结合keepalive LVS可以实现负载均衡，但是不能够进行健康检查，比如一个rs出现故障，LVS 仍然会把请求转发给故障的rs服务器，这样就会导致请求的无效性。keepalive 软件可以进行健康检查，而且能同时实现 LVS 的高可用性，解决 LVS 单点故障的问题，其实 keepalive 就是为 LVS 而生的。 1、实验环境 4台节点 Keepalived1 + lvs1(Director1)：192.168.0.48 Keepalived2 + lvs2(Director2)：192.168.0.58 Real server1：192.168.0.18 Real server2：192.168.0.28 IP: 192.168.0.38 2、安装系统软件 Lvs + keepalived的2个节点安装 #&nbsp;yum&nbsp;install&nbsp;ipvsadm&nbsp;keepalived&nbsp;-y Real server + nginx服务的2个节点安装 #&nbsp;yum&nbsp;install&nbsp;epel-release&nbsp;-y#&nbsp;yum&nbsp;install&nbsp;nginx&nbsp;-y 3、设置配置脚本 Real server节点2台配置脚本： #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh#!&nbsp;/bin/bashvip=192.168.0.38ifconfig&nbsp;lo:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;lo:0echo&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce2节点rs&nbsp;上分别执行脚本：bash&nbsp;/usr/local/sbin/lvs_dr_rs.sh keepalived节点配置(2节点)： 主节点(&nbsp;MASTER&nbsp;)配置文件vim&nbsp;/etc/keepalived/keepalived.confvrrp_instance&nbsp;VI_1&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;MASTER&nbsp;&nbsp;&nbsp;&nbsp;interface&nbsp;eth0&nbsp;&nbsp;&nbsp;&nbsp;virtual_router_id&nbsp;51&nbsp;&nbsp;&nbsp;&nbsp;priority&nbsp;100&nbsp;&nbsp;&nbsp;&nbsp;advert_int&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;authentication&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_type&nbsp;PASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_pass&nbsp;1111&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;virtual_ipaddress&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;192.168.0.38&nbsp;&nbsp;&nbsp;&nbsp;}}virtual_server&nbsp;192.168.0.38&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;delay_loop&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;lb_algo&nbsp;rr&nbsp;&nbsp;&nbsp;&nbsp;lb_kind&nbsp;DR&nbsp;&nbsp;&nbsp;&nbsp;persistence_timeout&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;protocol&nbsp;TCP&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;192.168.0.18&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;192.168.0.28&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}} 从节点( BACKUP )配置文件 拷贝主节点的配置文件keepalived.conf，然后修改如下内容： state&nbsp;MASTER&nbsp;-&gt;&nbsp;state&nbsp;BACKUPpriority&nbsp;100&nbsp;-&gt;&nbsp;priority&nbsp;90 keepalived的2个节点执行如下命令，开启转发功能： #&nbsp;echo&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward 4、启动keepalive &lt;strong&gt;先主后从分别启动keepalive&lt;/strong&gt;service&nbsp;keepalived&nbsp;start 5、验证结果 实验1 手动关闭192.168.0.18节点的nginx，service&nbsp;nginx stop 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，不会出现访问18节点，一直访问的是28节点的内容。 实验2 手动重新开启 192.168.0.18 节点的nginx，&nbsp;service&nbsp;nginx start 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，按照 rr 调度算法访问18节点和28节点。 实验3 测试 keepalived 的HA特性，首先在master上执行命令 ip addr ，可以看到38的vip在master节点上的；这时如果在master上执行&nbsp;service&nbsp;keepalived stop 命令，这时vip已经不再master上，在slave节点上执行 ip addr 命令可以看到 vip 已经正确漂到slave节点，这时客户端去访问&nbsp;http://192.168.0.38&nbsp;访问依然正常，验证了 keepalived的HA特性。 lvs 介绍： http://www.it165.net/admin/html/201401/2248.html &nbsp;推荐↓↓↓&nbsp; 长 按 关 注 👉【16个技术公众号】都在这里！ 涵盖：程序员大咖、源码共读、程序员共读、数据结构与算法、黑客技术和网络安全、大数据科技、编程前端、Java、Python、Web编程开发、Android、iOS开发、Linux、数据库研发、幽默程序员等。 万水千山总是情，点个 “ 好看” 行不行" />
<link rel="canonical" href="https://mlh.app/2019/02/01/ebe70e544cd2ba7b3817ebc2bff25af0.html" />
<meta property="og:url" content="https://mlh.app/2019/02/01/ebe70e544cd2ba7b3817ebc2bff25af0.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-01T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"Linux编程 点击右侧关注，免费入门到精通！ 作者丨肖邦Linux http://www.cnblogs.com/liwei0526vip/p/6370103.html 负载均衡集群是 load balance 集群的简写，翻译成中文就是负载均衡集群。常用的负载均衡开源软件有nginx、lvs、haproxy，商业的硬件负载均衡设备F5、Netscale。这里主要是学习 LVS 并对其进行了详细的总结记录。 一、负载均衡LVS基本介绍 LB集群的架构和原理很简单，就是当用户的请求过来时，会直接分发到Director Server上，然后它把用户的请求根据设置好的调度算法，智能均衡地分发到后端真正服务器(real server)上。为了避免不同机器上用户请求得到的数据不一样，需要用到了共享存储，这样保证所有用户请求的数据是一样的。 LVS是 Linux Virtual Server 的简称，也就是Linux虚拟服务器。这是一个由章文嵩博士发起的一个开源项目，它的官方网是&nbsp;http://www.linuxvirtualserver.org&nbsp;现在 LVS 已经是 Linux 内核标准的一部分。使用 LVS 可以达到的技术目标是：通过 LVS 达到的负载均衡技术和 Linux 操作系统实现一个高性能高可用的 Linux 服务器集群，它具有良好的可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的性能。LVS 是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上可分为调度层、Server集群层和共享存储。 二、LVS的基本工作原理 1. 当用户向负载均衡调度器（Director Server）发起请求，调度器将请求发往至内核空间 2.&nbsp;PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链 3.&nbsp;IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链 4.&nbsp;POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器 三、LVS的组成 LVS 由2部分程序组成，包括 ipvs 和 ipvsadm。 1.ipvs(ip virtual server)：一段代码工作在内核空间，叫ipvs，是真正生效实现调度的代码。 2. ipvsadm：另外一段是工作在用户空间，叫ipvsadm，负责为ipvs内核框架编写规则，定义谁是集群服务，而谁是后端真实的服务器(Real Server) 四、LVS相关术语 1. DS：Director Server。指的是前端负载均衡器节点。2. RS：Real Server。后端真实的工作服务器。3. VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。4. DIP：Director Server IP，主要用于和内部主机通讯的IP地址。5. RIP：Real Server IP，后端服务器的IP地址。6. CIP：Client IP，访问客户端的IP地址。 下边是三种工作模式的原理和特点总结。 五、LVS/NAT原理和特点 1. 重点理解NAT方式的实现原理和数据包的改变。 (a). 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP (b). PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c). IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，然后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP (d). POSTROUTING链通过选路，将数据包发送给Real Server (e). Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP (f). Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP 2. LVS-NAT模型的特性 RS应该使用私有地址，RS的网关必须指向DIP DIP和RIP必须在同一个网段内 请求和响应报文都需要经过Director Server，高负载场景中，Director Server易成为性能瓶颈 支持端口映射 RS可以使用任意操作系统 缺陷：对Director Server压力会比较大，请求和响应都需经过director server 六、LVS/DR原理和特点 1.重将请求报文的目标MAC地址设定为挑选出的RS的MAC地址 (a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP (b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址 (d)&nbsp;由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。 (e)&nbsp;RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP (f)&nbsp;响应报文最终送达至客户端 2. LVS-DR模型的特性 特点1：保证前端路由将目标地址为VIP报文统统发给Director Server，而不是RS RS可以使用私有地址；也可以是公网地址，如果使用公网地址，此时可以通过互联网对RIP进行直接访问 RS跟Director Server必须在同一个物理网络中 所有的请求报文经由Director Server，但响应报文必须不能进过Director Server 不支持地址转换，也不支持端口映射 RS可以是大多数常见的操作系统 RS的网关绝不允许指向DIP(因为我们不允许他经过director) RS上的lo接口配置VIP的IP地址 缺陷：RS和DS必须在同一机房中 3. 特点1的解决方案： 在前端路由器做静态地址路由绑定，将对于VIP的地址仅路由到Director Server 存在问题：用户未必有路由操作权限，因为有可能是运营商提供的，所以这个方法未必实用 arptables：在arp的层次上实现在ARP解析时做防火墙规则，过滤RS响应ARP请求。这是由iptables提供的 修改RS上内核参数（arp_ignore和arp_announce）将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。 七、LVS/Tun原理和特点 在原有的IP报文外再次封装多一层IP首部，内部IP首部(源地址为CIP，目标IIP为VIP)，外层IP首部(源地址为DIP，目标IP为RIP) (a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。 (b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链 (c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP (d)&nbsp;POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP (e)&nbsp;RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP (f)&nbsp;响应报文最终送达至客户端 LVS-Tun模型特性 RIP、VIP、DIP全是公网地址 RS的网关不会也不可能指向DIP 所有的请求报文经由Director Server，但响应报文必须不能进过Director Server 不支持端口映射 RS的系统必须支持隧道 其实企业中最常用的是 DR 实现方式，而 NAT 配置上比较简单和方便，后边实践中会总结 DR 和 NAT 具体使用配置过程。 八、LVS的八种调度算法 1.轮叫调度 rr 这种算法是最简单的，就是按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点就是简单。轮询算法假设所有的服务器处理请求的能力都是一样的，调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。 2. 加权轮叫 wrr 这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加要给权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。 3. 最少链接 lc 这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1 4. 加权最少链接 wlc 这个算法比 lc 多了一个权重的概念。 5. 基于局部性的最少连接调度算法 lblc 这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器 6. 复杂的基于局部性最少的连接算法 lblcr 记录的不是要给目标 IP 与一台服务器之间的连接记录，它会维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。 7. 目标地址散列调度算法 dh 该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。 8. 源地址散列调度算法 sh 与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。 九、实践LVS的NAT模式 1、实验环境 三台服务器，一台作为 director，两台作为 real server，director 有一个外网网卡(172.16.254.200) 和一个内网ip(192.168.0.8)，两个 real server 上只有内网 ip (192.168.0.18) 和 (192.168.0.28)，并且需要把两个 real server 的内网网关设置为 director 的内网 ip(192.168.0.8) 2、安装和配置 两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginxDirector&nbsp;上安装&nbsp;ipvsadm#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm Director 上编辑 nat 实现脚本 #&nbsp;vim&nbsp;/usr/local/sbin/lvs_nat.sh#&nbsp;编辑写入如下内容：#!&nbsp;/bin/bash#&nbsp;director服务器上开启路由转发功能:echo&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward#&nbsp;关闭&nbsp;icmp&nbsp;的重定向echo&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/all/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/default/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth0/send_redirectsecho&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth1/send_redirects#&nbsp;director设置&nbsp;nat&nbsp;防火墙iptables&nbsp;-t&nbsp;nat&nbsp;-Fiptables&nbsp;-t&nbsp;nat&nbsp;-Xiptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;POSTROUTING&nbsp;-s&nbsp;192.168.0.0/24&nbsp;-j&nbsp;MASQUERADE#&nbsp;director设置&nbsp;ipvsadmIPVSADM=&#39;/sbin/ipvsadm&#39;$IPVSADM&nbsp;-C$IPVSADM&nbsp;-A&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-s&nbsp;wrr$IPVSADM&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.18:80&nbsp;-m&nbsp;-w&nbsp;1$IPVSADM&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.28:80&nbsp;-m&nbsp;-w&nbsp;1 保存后，在 Director 上直接运行这个脚本就可以完成 lvs/nat 的配置 /bin/bash&nbsp;/usr/local/sbin/lvs_nat.sh 查看ipvsadm设置的规则 ipvsadm&nbsp;-ln 3、测试LVS的效果 通过浏览器测试2台机器上的web内容&nbsp;http://172.16.254.200&nbsp;。为了区分开，我们可以把 nginx 的默认页修改一下： 在&nbsp;RS1&nbsp;上执行#&nbsp;echo&nbsp;&quot;rs1rs1&quot;&nbsp;&gt;/usr/share/nginx/html/index.html在&nbsp;RS2&nbsp;上执行#&nbsp;echo&nbsp;&quot;rs2rs2&quot;&nbsp;&gt;/usr/share/nginx/html/index.html 注意，切记一定要在两台 RS 上设置网关的 IP 为 director 的内网 IP。 十、实践LVS的DR模式 1、实验环境 三台机器： Director节点： &nbsp;(eth0 192.168.0.8&nbsp; vip eth0:0 192.168.0.38) Real server1： (eth0 192.168.0.18 vip lo:0 192.168.0.38) Real server2： (eth0 192.168.0.28 vip lo:0 192.168.0.38) 2、安装 两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginxDirector&nbsp;上安装&nbsp;ipvsadm#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm 3、Director 上配置脚本 #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr.sh#!&nbsp;/bin/bashecho&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forwardipv=/sbin/ipvsadmvip=192.168.0.38rs1=192.168.0.18rs2=192.168.0.28ifconfig&nbsp;eth0:0&nbsp;downifconfig&nbsp;eth0:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;dev&nbsp;eth0:0$ipv&nbsp;-C$ipv&nbsp;-A&nbsp;-t&nbsp;$vip:80&nbsp;-s&nbsp;wrr$ipv&nbsp;-a&nbsp;-t&nbsp;$vip:80&nbsp;-r&nbsp;$rs1:80&nbsp;-g&nbsp;-w&nbsp;3$ipv&nbsp;-a&nbsp;-t&nbsp;$vip:80&nbsp;-r&nbsp;$rs2:80&nbsp;-g&nbsp;-w&nbsp;1 执行脚本： #&nbsp;bash&nbsp;/usr/local/sbin/lvs_dr.sh 4、在2台 rs 上配置脚本： #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh#!&nbsp;/bin/bashvip=192.168.0.38ifconfig&nbsp;lo:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;lo:0echo&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce rs 上分别执行脚本： bash&nbsp;/usr/local/sbin/lvs_dr_rs.sh 5、实验测试 测试方式同上，浏览器访问&nbsp;http://192.168.0.38 注意：在 DR 模式下，2台 rs 节点的 gateway 不需要设置成 dir 节点的 IP 。 参考链接地址： http://www.cnblogs.com/lgfeng/archive/2012/10/16/2726308.html 十一、LVS结合keepalive LVS可以实现负载均衡，但是不能够进行健康检查，比如一个rs出现故障，LVS 仍然会把请求转发给故障的rs服务器，这样就会导致请求的无效性。keepalive 软件可以进行健康检查，而且能同时实现 LVS 的高可用性，解决 LVS 单点故障的问题，其实 keepalive 就是为 LVS 而生的。 1、实验环境 4台节点 Keepalived1 + lvs1(Director1)：192.168.0.48 Keepalived2 + lvs2(Director2)：192.168.0.58 Real server1：192.168.0.18 Real server2：192.168.0.28 IP: 192.168.0.38 2、安装系统软件 Lvs + keepalived的2个节点安装 #&nbsp;yum&nbsp;install&nbsp;ipvsadm&nbsp;keepalived&nbsp;-y Real server + nginx服务的2个节点安装 #&nbsp;yum&nbsp;install&nbsp;epel-release&nbsp;-y#&nbsp;yum&nbsp;install&nbsp;nginx&nbsp;-y 3、设置配置脚本 Real server节点2台配置脚本： #&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh#!&nbsp;/bin/bashvip=192.168.0.38ifconfig&nbsp;lo:0&nbsp;$vip&nbsp;broadcast&nbsp;$vip&nbsp;netmask&nbsp;255.255.255.255&nbsp;uproute&nbsp;add&nbsp;-host&nbsp;$vip&nbsp;lo:0echo&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho&nbsp;&quot;1&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho&nbsp;&quot;2&quot;&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce2节点rs&nbsp;上分别执行脚本：bash&nbsp;/usr/local/sbin/lvs_dr_rs.sh keepalived节点配置(2节点)： 主节点(&nbsp;MASTER&nbsp;)配置文件vim&nbsp;/etc/keepalived/keepalived.confvrrp_instance&nbsp;VI_1&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;MASTER&nbsp;&nbsp;&nbsp;&nbsp;interface&nbsp;eth0&nbsp;&nbsp;&nbsp;&nbsp;virtual_router_id&nbsp;51&nbsp;&nbsp;&nbsp;&nbsp;priority&nbsp;100&nbsp;&nbsp;&nbsp;&nbsp;advert_int&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;authentication&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_type&nbsp;PASS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_pass&nbsp;1111&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;virtual_ipaddress&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;192.168.0.38&nbsp;&nbsp;&nbsp;&nbsp;}}virtual_server&nbsp;192.168.0.38&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;delay_loop&nbsp;6&nbsp;&nbsp;&nbsp;&nbsp;lb_algo&nbsp;rr&nbsp;&nbsp;&nbsp;&nbsp;lb_kind&nbsp;DR&nbsp;&nbsp;&nbsp;&nbsp;persistence_timeout&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;protocol&nbsp;TCP&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;192.168.0.18&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;192.168.0.28&nbsp;80&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;80&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;}} 从节点( BACKUP )配置文件 拷贝主节点的配置文件keepalived.conf，然后修改如下内容： state&nbsp;MASTER&nbsp;-&gt;&nbsp;state&nbsp;BACKUPpriority&nbsp;100&nbsp;-&gt;&nbsp;priority&nbsp;90 keepalived的2个节点执行如下命令，开启转发功能： #&nbsp;echo&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward 4、启动keepalive &lt;strong&gt;先主后从分别启动keepalive&lt;/strong&gt;service&nbsp;keepalived&nbsp;start 5、验证结果 实验1 手动关闭192.168.0.18节点的nginx，service&nbsp;nginx stop 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，不会出现访问18节点，一直访问的是28节点的内容。 实验2 手动重新开启 192.168.0.18 节点的nginx，&nbsp;service&nbsp;nginx start 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，按照 rr 调度算法访问18节点和28节点。 实验3 测试 keepalived 的HA特性，首先在master上执行命令 ip addr ，可以看到38的vip在master节点上的；这时如果在master上执行&nbsp;service&nbsp;keepalived stop 命令，这时vip已经不再master上，在slave节点上执行 ip addr 命令可以看到 vip 已经正确漂到slave节点，这时客户端去访问&nbsp;http://192.168.0.38&nbsp;访问依然正常，验证了 keepalived的HA特性。 lvs 介绍： http://www.it165.net/admin/html/201401/2248.html &nbsp;推荐↓↓↓&nbsp; 长 按 关 注 👉【16个技术公众号】都在这里！ 涵盖：程序员大咖、源码共读、程序员共读、数据结构与算法、黑客技术和网络安全、大数据科技、编程前端、Java、Python、Web编程开发、Android、iOS开发、Linux、数据库研发、幽默程序员等。 万水千山总是情，点个 “ 好看” 行不行","@type":"BlogPosting","url":"https://mlh.app/2019/02/01/ebe70e544cd2ba7b3817ebc2bff25af0.html","headline":"LVS 负载均衡原理及安装配置简明指南","dateModified":"2019-02-01T00:00:00+08:00","datePublished":"2019-02-01T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2019/02/01/ebe70e544cd2ba7b3817ebc2bff25af0.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>LVS 负载均衡原理及安装配置简明指南</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="rich_media_content" id="js_content"> 
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/XUfq62QbuNhyG8Y9IxZUNMLyjv7k7dsq3bia9CRMmdkOM1WyLYEHlib4MFfrqRE97iaUqJ7NwhZEoHu0U8NCXWzsA/640?wx_fmt=gif" alt="640?wx_fmt=gif"></p>
   <p style="min-height:1em;text-align:center;"><a href="https://mp.weixin.qq.com/s?__biz=MzU2MzcxNzgwMg==&amp;mid=2247483650&amp;idx=3&amp;sn=7d8d32410010e2f58a8b0e9b15fa23ec&amp;scene=21#wechat_redirect" rel="nofollow"><span class="js_jump_icon h5_image_link"><img style="letter-spacing:.544px;text-align:justify;color:rgb(62,62,62);width:76px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/XUfq62QbuNiaFZIbV1icByYIGKRlUcFt6IBMGhWJcyxibORgs6MEmSnJlA3ibibR7ibpudwZAbFZdqISttPaQTBkPPtQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></span></a></p>
   <a href="https://mp.weixin.qq.com/s?__biz=MzU2MzcxNzgwMg==&amp;mid=2247483650&amp;idx=3&amp;sn=7d8d32410010e2f58a8b0e9b15fa23ec&amp;scene=21#wechat_redirect" rel="nofollow"><span style="font-family:'宋体', SimSun;"><strong><span style="letter-spacing:.544px;color:rgb(31,73,125);"><strong>Linux编程</strong></span></strong></span></a>
   <span style="font-family:'黑体', SimHei;"><strong><span style="letter-spacing:.544px;color:rgb(31,73,125);"></span></strong><strong><span style="letter-spacing:.544px;color:rgb(31,73,125);"></span></strong><strong><span style="letter-spacing:.544px;color:rgb(31,73,125);"></span></strong></span>
   <a href="https://mp.weixin.qq.com/s?__biz=MzU2MzcxNzgwMg==&amp;mid=2247483650&amp;idx=3&amp;sn=7d8d32410010e2f58a8b0e9b15fa23ec&amp;scene=21#wechat_redirect" rel="nofollow"><span style="letter-spacing:.544px;color:rgb(165,165,165);font-family:'黑体', SimHei;"><span>点击右侧关注，免费入门到精通！</span></span></a>
   <a href="https://mp.weixin.qq.com/s?__biz=MzU2MzcxNzgwMg==&amp;mid=2247483650&amp;idx=3&amp;sn=7d8d32410010e2f58a8b0e9b15fa23ec&amp;scene=21#wechat_redirect" rel="nofollow"><span class="js_jump_icon h5_image_link"><img style="width:56px;" title="1081255447.jpg" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/XUfq62QbuNiaFZIbV1icByYIGKRlUcFt6IldAicZsKdD8KXBZkWQz1eHWULt7Sy2XUdKWbFt8oY6f6nL5deCuF9yg/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></span></a>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:14px;color:rgb(136,136,136);">作者丨肖邦Linux</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:14px;color:rgb(136,136,136);">http://www.cnblogs.com/liwei0526vip/p/6370103.html</span></p>
   <p style="letter-spacing:1px;"><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">负载均衡集群是 load balance 集群的简写，翻译成中文就是负载均衡集群。常用的负载均衡开源软件有nginx、lvs、haproxy，商业的硬件负载均衡设备F5、Netscale。这里主要是学习 LVS 并对其进行了详细的总结记录。</span></p>
   <p><br></p>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">一、负载均衡LVS基本介绍</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">LB集群的架构和原理很简单，就是当用户的请求过来时，会直接分发到Director Server上，然后它把用户的请求根据设置好的调度算法，智能均衡地分发到后端真正服务器(real server)上。为了避免不同机器上用户请求得到的数据不一样，需要用到了共享存储，这样保证所有用户请求的数据是一样的。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">LVS是 Linux Virtual Server 的简称，也就是Linux虚拟服务器。这是一个由章文嵩博士发起的一个开源项目，它的官方网是&nbsp;http://www.linuxvirtualserver.org&nbsp;现在 LVS 已经是 Linux 内核标准的一部分。使用 LVS 可以达到的技术目标是：通过 LVS 达到的负载均衡技术和 Linux 操作系统实现一个高性能高可用的 Linux 服务器集群，它具有良好的可靠性、可扩展性和可操作性。从而以低廉的成本实现最优的性能。LVS 是一个实现负载均衡集群的开源软件项目，LVS架构从逻辑上可分为调度层、Server集群层和共享存储。</span></p>
   <p><br></p>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">二、LVS的基本工作原理</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/9aPYe0E1fb31UibvdoplmjjVPM87UZ7xUbnjtA3Z67ZHXHLUUibz8QevDr4m31hzxJK8sceZ6zSj4icdOruibPVj4w/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1. 当用户向负载均衡调度器（Director Server）发起请求，调度器将请求发往至内核空间</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2.&nbsp;PREROUTING链首先会接收到用户请求，判断目标IP确定是本机IP，将数据包发往INPUT链</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">3.&nbsp;IPVS是工作在INPUT链上的，当用户请求到达INPUT时，IPVS会将用户请求和自己已定义好的集群服务进行比对，如果用户请求的就是定义的集群服务，那么此时IPVS会强行修改数据包里的目标IP地址及端口，并将新的数据包发往POSTROUTING链</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">4.&nbsp;POSTROUTING链接收数据包后发现目标IP地址刚好是自己的后端服务器，那么此时通过选路，将数据包最终发送给后端的服务器</span></p>
   <p><br></p>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">三、LVS的组成</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">LVS 由2部分程序组成，包括 ipvs 和 ipvsadm。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1.ipvs(ip virtual server)：一段代码工作在内核空间，叫ipvs，是真正生效实现调度的代码。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2. ipvsadm：另外一段是工作在用户空间，叫ipvsadm，负责为ipvs内核框架编写规则，定义谁是集群服务，而谁是后端真实的服务器(Real Server)</span></p>
   <h2><br></h2>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">四、LVS相关术语</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1. DS：Director Server。指的是前端负载均衡器节点。<br>2. RS：Real Server。后端真实的工作服务器。<br>3. VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。<br>4. DIP：Director Server IP，主要用于和内部主机通讯的IP地址。<br>5. RIP：Real Server IP，后端服务器的IP地址。<br>6. CIP：Client IP，访问客户端的IP地址。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">下边是三种工作模式的原理和特点总结。</span></p>
   <h2><br></h2>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">五、LVS/NAT原理和特点</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1. 重点理解NAT方式的实现原理和数据包的改变。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/9aPYe0E1fb31UibvdoplmjjVPM87UZ7xUiagzhFwc3xweprtlT94l6RbibTV6Ojs2NLcenpmOYop7GiaG4JqrNfn1g/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">(a). 当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(b). PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(c). IPVS比对数据包请求的服务是否为集群服务，若是，修改数据包的目标IP地址为后端服务器IP，然后将数据包发至POSTROUTING链。 此时报文的源IP为CIP，目标IP为RIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(d). POSTROUTING链通过选路，将数据包发送给Real Server</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(e). Real Server比对发现目标为自己的IP，开始构建响应报文发回给Director Server。 此时报文的源IP为RIP，目标IP为CIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(f). Director Server在响应客户端前，此时会将源IP地址修改为自己的VIP地址，然后响应给客户端。 此时报文的源IP为VIP，目标IP为CIP</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2. LVS-NAT模型的特性</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS应该使用私有地址，RS的网关必须指向DIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">DIP和RIP必须在同一个网段内</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">请求和响应报文都需要经过Director Server，高负载场景中，Director Server易成为性能瓶颈</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">支持端口映射</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS可以使用任意操作系统</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">缺陷：对Director Server压力会比较大，请求和响应都需经过director server</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">六、LVS/DR原理和特点</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1.重将请求报文的目标MAC地址设定为挑选出的RS的MAC地址</span></p>
   <p><br></p>
   <p><img style="border:0px;font-size:0px;vertical-align:middle;text-align:center;clear:both;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/9aPYe0E1fb31UibvdoplmjjVPM87UZ7xUUpQ7OCz2x1iaV4ibGF1ic5anU6iaRguk6YMIr6Pq63Mu7HvVe2Sn7YcIDQ/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">(a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，将请求报文中的源MAC地址修改为DIP的MAC地址，将目标MAC地址修改RIP的MAC地址，然后将数据包发至POSTROUTING链。 此时的源IP和目的IP均未修改，仅修改了源MAC地址为DIP的MAC地址，目标MAC地址为RIP的MAC地址</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(d)&nbsp;由于DS和RS在同一个网络中，所以是通过二层来传输。POSTROUTING链检查目标MAC地址为RIP的MAC地址，那么此时数据包将会发至Real Server。</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(e)&nbsp;RS发现请求报文的MAC地址是自己的MAC地址，就接收此报文。处理完成之后，将响应报文通过lo接口传送给eth0网卡然后向外发出。 此时的源IP地址为VIP，目标IP为CIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(f)&nbsp;响应报文最终送达至客户端</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2. LVS-DR模型的特性</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">特点1：保证前端路由将目标地址为VIP报文统统发给Director Server，而不是RS</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS可以使用私有地址；也可以是公网地址，如果使用公网地址，此时可以通过互联网对RIP进行直接访问</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS跟Director Server必须在同一个物理网络中</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">所有的请求报文经由Director Server，但响应报文必须不能进过Director Server</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">不支持地址转换，也不支持端口映射</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS可以是大多数常见的操作系统</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS的网关绝不允许指向DIP(因为我们不允许他经过director)</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS上的lo接口配置VIP的IP地址</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">缺陷：RS和DS必须在同一机房中</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">3. 特点1的解决方案：</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">在前端路由器做静态地址路由绑定，将对于VIP的地址仅路由到Director Server</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">存在问题：用户未必有路由操作权限，因为有可能是运营商提供的，所以这个方法未必实用</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">arptables：在arp的层次上实现在ARP解析时做防火墙规则，过滤RS响应ARP请求。这是由iptables提供的</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">修改RS上内核参数（arp_ignore和arp_announce）将RS上的VIP配置在lo接口的别名上，并限制其不能响应对VIP地址解析请求。</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">七、LVS/Tun原理和特点</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">在原有的IP报文外再次封装多一层IP首部，内部IP首部(源地址为CIP，目标IIP为VIP)，外层IP首部(源地址为DIP，目标IP为RIP)</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/9aPYe0E1fb31UibvdoplmjjVPM87UZ7xUoATXK0VaPToR6gicj03yK764ycVohjibjX2pUxSLLFfQvLouWqRCxdzg/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">(a)&nbsp;当用户请求到达Director Server，此时请求的数据报文会先到内核空间的PREROUTING链。 此时报文的源IP为CIP，目标IP为VIP 。</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(b)&nbsp;PREROUTING检查发现数据包的目标IP是本机，将数据包送至INPUT链</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(c)&nbsp;IPVS比对数据包请求的服务是否为集群服务，若是，在请求报文的首部再次封装一层IP报文，封装源IP为为DIP，目标IP为RIP。然后发至POSTROUTING链。 此时源IP为DIP，目标IP为RIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(d)&nbsp;POSTROUTING链根据最新封装的IP报文，将数据包发至RS（因为在外层封装多了一层IP首部，所以可以理解为此时通过隧道传输）。 此时源IP为DIP，目标IP为RIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(e)&nbsp;RS接收到报文后发现是自己的IP地址，就将报文接收下来，拆除掉最外层的IP后，会发现里面还有一层IP首部，而且目标是自己的lo接口VIP，那么此时RS开始处理此请求，处理完成之后，通过lo接口送给eth0网卡，然后向外传递。 此时的源IP地址为VIP，目标IP为CIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br>(f)&nbsp;响应报文最终送达至客户端</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">LVS-Tun模型特性</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RIP、VIP、DIP全是公网地址</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS的网关不会也不可能指向DIP</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">所有的请求报文经由Director Server，但响应报文必须不能进过Director Server</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">不支持端口映射</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">RS的系统必须支持隧道</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">其实企业中最常用的是 DR 实现方式，而 NAT 配置上比较简单和方便，后边实践中会总结 DR 和 NAT 具体使用配置过程。</span></p>
   <p><br></p>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">八、LVS的八种调度算法</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1.轮叫调度 rr<br><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">这种算法是最简单的，就是按依次循环的方式将请求调度到不同的服务器上，该算法最大的特点就是简单。轮询算法假设所有的服务器处理请求的能力都是一样的，调度器会将所有的请求平均分配给每个真实服务器，不管后端 RS 配置和处理能力，非常均衡地分发下去。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2. 加权轮叫 wrr</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">这种算法比 rr 的算法多了一个权重的概念，可以给 RS 设置权重，权重越高，那么分发的请求数越多，权重的取值范围 0 – 100。主要是对rr算法的一种优化和补充， LVS 会考虑每台服务器的性能，并给每台服务器添加要给权值，如果服务器A的权值为1，服务器B的权值为2，则调度到服务器B的请求会是服务器A的2倍。权值越高的服务器，处理的请求越多。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">3. 最少链接 lc</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">这个算法会根据后端 RS 的连接数来决定把请求分发给谁，比如 RS1 连接数比 RS2 连接数少，那么请求就优先发给 RS1</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">4. 加权最少链接 wlc<br><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">这个算法比 lc 多了一个权重的概念。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">5. 基于局部性的最少连接调度算法 lblc</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">这个算法是请求数据包的目标 IP 地址的一种调度算法，该算法先根据请求的目标 IP 地址寻找最近的该目标 IP 地址所有使用的服务器，如果这台服务器依然可用，并且有能力处理该请求，调度器会尽量选择相同的服务器，否则会继续选择其它可行的服务器</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">6. 复杂的基于局部性最少的连接算法 lblcr</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">记录的不是要给目标 IP 与一台服务器之间的连接记录，它会维护一个目标 IP 到一组服务器之间的映射关系，防止单点服务器负载过高。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">7. 目标地址散列调度算法 dh</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">该算法是根据目标 IP 地址通过散列函数将目标 IP 与服务器建立映射关系，出现服务器不可用或负载过高的情况下，发往该目标 IP 的请求会固定发给该服务器。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">8. 源地址散列调度算法 sh<br><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">与目标地址散列调度算法类似，但它是根据源地址散列算法进行静态分配固定的服务器资源。</span></p>
   <h2><br></h2>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">九、实践LVS的NAT模式</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1、实验环境</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">三台服务器，一台作为 director，两台作为 real server，director 有一个外网网卡(172.16.254.200) 和一个内网ip(192.168.0.8)，两个 real server 上只有内网 ip (192.168.0.18) 和 (192.168.0.28)，并且需要把两个 real server 的内网网关设置为 director 的内网 ip(192.168.0.8)</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2、安装和配置</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);">两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginx</span><br><br>Director&nbsp;上安装&nbsp;ipvsadm<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm</span><br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Director 上编辑 nat 实现脚本</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;vim&nbsp;/usr/local/sbin/lvs_nat.sh</span><br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;编辑写入如下内容：</span><br><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#!&nbsp;/bin/bash</span><br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;director服务器上开启路由转发功能:</span><br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;关闭&nbsp;icmp&nbsp;的重定向</span><br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/all/send_redirects<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/default/send_redirects<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth0/send_redirects<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;0&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/conf/eth1/send_redirects<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;director设置&nbsp;nat&nbsp;防火墙</span><br>iptables&nbsp;-t&nbsp;nat&nbsp;-F<br>iptables&nbsp;-t&nbsp;nat&nbsp;-X<br>iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;POSTROUTING&nbsp;-s&nbsp;192.168.0.0/24&nbsp;-j&nbsp;MASQUERADE<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;director设置&nbsp;ipvsadm</span><br>IPVSADM=<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">'/sbin/ipvsadm'</span><br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$IPVSADM</span>&nbsp;-C<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$IPVSADM</span>&nbsp;-A&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-s&nbsp;wrr<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$IPVSADM</span>&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.18:80&nbsp;-m&nbsp;-w&nbsp;1<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$IPVSADM</span>&nbsp;-a&nbsp;-t&nbsp;172.16.254.200:80&nbsp;-r&nbsp;192.168.0.28:80&nbsp;-m&nbsp;-w&nbsp;1<br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">保存后，在 Director 上直接运行这个脚本就可以完成 lvs/nat 的配置</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);">/bin/bash&nbsp;/usr/<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">local</span>/sbin/lvs_nat.sh<br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">查看ipvsadm设置的规则</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs nginx" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-attribute" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">ipvsadm</span>&nbsp;-ln<br></code></pre>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">3、测试LVS的效果</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">通过浏览器测试2台机器上的web内容&nbsp;http://172.16.254.200&nbsp;。为了区分开，我们可以把 nginx 的默认页修改一下：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs shell" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);">在&nbsp;RS1&nbsp;上执行<br><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#</span><span class="bash" style="font-size:inherit;color:inherit;line-height:inherit;">&nbsp;<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"rs1rs1"</span>&nbsp;&gt;/usr/share/nginx/html/index.html</span><br><br>在&nbsp;RS2&nbsp;上执行<br><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#</span><span class="bash" style="font-size:inherit;color:inherit;line-height:inherit;">&nbsp;<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"rs2rs2"</span>&nbsp;&gt;/usr/share/nginx/html/index.html</span><br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">注意，切记一定要在两台 RS 上设置网关的 IP 为 director 的内网 IP。</span></p>
   <h2><br></h2>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">十、实践LVS的DR模式</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1、实验环境</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">三台机器：</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Director节点： &nbsp;(eth0 192.168.0.8&nbsp; vip eth0:0 192.168.0.38)</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Real server1： (eth0 192.168.0.18 vip lo:0 192.168.0.38)</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Real server2： (eth0 192.168.0.28 vip lo:0 192.168.0.38)</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2、安装</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);">两个&nbsp;real&nbsp;server&nbsp;上都安装&nbsp;nginx&nbsp;服务<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;nginx</span><br><br>Director&nbsp;上安装&nbsp;ipvsadm<br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;-y&nbsp;ipvsadm</span><br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">3、Director 上配置脚本</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr.sh</span><br><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#!&nbsp;/bin/bash</span><br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward<br>ipv=/sbin/ipvsadm<br>vip=192.168.0.38<br>rs1=192.168.0.18<br>rs2=192.168.0.28<br>ifconfig&nbsp;eth0:0&nbsp;down<br>ifconfig&nbsp;eth0:0&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;broadcast&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;netmask&nbsp;255.255.255.255&nbsp;up<br>route&nbsp;add&nbsp;-host&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;dev&nbsp;eth0:0<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$ipv</span>&nbsp;-C<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$ipv</span>&nbsp;-A&nbsp;-t&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>:80&nbsp;-s&nbsp;wrr<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$ipv</span>&nbsp;-a&nbsp;-t&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>:80&nbsp;-r&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$rs1</span>:80&nbsp;-g&nbsp;-w&nbsp;3<br><span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$ipv</span>&nbsp;-a&nbsp;-t&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>:80&nbsp;-r&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$rs2</span>:80&nbsp;-g&nbsp;-w&nbsp;1<br></code></pre>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">执行脚本：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs shell" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#</span><span class="bash" style="font-size:inherit;color:inherit;line-height:inherit;">&nbsp;bash&nbsp;/usr/<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">local</span>/sbin/lvs_dr.sh</span><br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">4、在2台 rs 上配置脚本：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh</span><br><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#!&nbsp;/bin/bash</span><br>vip=192.168.0.38<br>ifconfig&nbsp;lo:0&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;broadcast&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;netmask&nbsp;255.255.255.255&nbsp;up<br>route&nbsp;add&nbsp;-host&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;lo:0<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"1"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignore<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"2"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announce<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"1"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignore<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"2"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce<br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">rs 上分别执行脚本：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);">bash&nbsp;/usr/<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">local</span>/sbin/lvs_dr_rs.sh<br></code></pre>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">5、实验测试</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">测试方式同上，浏览器访问&nbsp;http://192.168.0.38</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">注意：在 DR 模式下，2台 rs 节点的 gateway 不需要设置成 dir 节点的 IP 。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">参考链接地址：</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);">http://www.cnblogs.com/lgfeng/archive/2012/10/16/2726308.html</span></p>
   <h2><br></h2>
   <h2 style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><img class="__bg_gif" style="font-size:8px;color:rgb(0,128,255);font-family:'宋体';text-align:center;vertical-align:middle;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_gif/IwiaNBuWUDUw4OUxv50sClowAsFgibBOT8DicW3x9nlUu6buibjSVPyf3vst4EuG4dZOZcB2P62icZnyEMeP8eqoYog/640?wx_fmt=gif" alt="640?wx_fmt=gif">十一、LVS结合keepalive</span></h2>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">LVS可以实现负载均衡，但是不能够进行健康检查，比如一个rs出现故障，LVS 仍然会把请求转发给故障的rs服务器，这样就会导致请求的无效性。keepalive 软件可以进行健康检查，而且能同时实现 LVS 的高可用性，解决 LVS 单点故障的问题，其实 keepalive 就是为 LVS 而生的。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">1、实验环境</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">4台节点</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Keepalived1 + lvs1(Director1)：192.168.0.48</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Keepalived2 + lvs2(Director2)：192.168.0.58</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Real server1：192.168.0.18</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Real server2：192.168.0.28</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">IP: 192.168.0.38</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">2、安装系统软件</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Lvs + keepalived的2个节点安装</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs apache" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;ipvsadm&nbsp;keepalived&nbsp;-y</span><br></code></pre>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Real server + nginx服务的2个节点安装</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs apache" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;epel-release&nbsp;-y</span><br><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;yum&nbsp;install&nbsp;nginx&nbsp;-y</span><br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">3、设置配置脚本</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">Real server节点2台配置脚本：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs bash" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-comment" style="font-size:inherit;line-height:inherit;color:rgb(128,128,128);">#&nbsp;vim&nbsp;/usr/local/sbin/lvs_dr_rs.sh</span><br><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#!&nbsp;/bin/bash</span><br>vip=192.168.0.38<br>ifconfig&nbsp;lo:0&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;broadcast&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;netmask&nbsp;255.255.255.255&nbsp;up<br>route&nbsp;add&nbsp;-host&nbsp;<span class="hljs-variable" style="font-size:inherit;line-height:inherit;color:rgb(98,151,85);">$vip</span>&nbsp;lo:0<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"1"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_ignore<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"2"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/lo/arp_announce<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"1"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_ignore<br><span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;<span class="hljs-string" style="font-size:inherit;line-height:inherit;color:rgb(238,220,112);">"2"</span>&nbsp;&gt;/proc/sys/net/ipv4/conf/all/arp_announce<br><br>2节点rs&nbsp;上分别执行脚本：<br>bash&nbsp;/usr/<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">local</span>/sbin/lvs_dr_rs.sh<br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">keepalived节点配置(2节点)：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs java" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);">主节点(&nbsp;MASTER&nbsp;)配置文件<br>vim&nbsp;/etc/keepalived/keepalived.conf<br>vrrp_instance&nbsp;VI_1&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;state&nbsp;MASTER<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-class" style="font-size:inherit;color:inherit;line-height:inherit;"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">interface</span>&nbsp;<span class="hljs-title" style="font-size:inherit;line-height:inherit;color:rgb(165,218,45);">eth0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size:inherit;line-height:inherit;color:rgb(165,218,45);">virtual_router_id</span>&nbsp;51<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size:inherit;line-height:inherit;color:rgb(165,218,45);">priority</span>&nbsp;100<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size:inherit;line-height:inherit;color:rgb(165,218,45);">advert_int</span>&nbsp;1<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-title" style="font-size:inherit;line-height:inherit;color:rgb(165,218,45);">authentication</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_type&nbsp;PASS<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_pass&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">1111</span><br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;virtual_ipaddress&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">192.168</span>.0.38<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br>virtual_server&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">192.168</span>.0.38&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">80</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;delay_loop&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">6</span><br>&nbsp;&nbsp;&nbsp;&nbsp;lb_algo&nbsp;rr<br>&nbsp;&nbsp;&nbsp;&nbsp;lb_kind&nbsp;DR<br>&nbsp;&nbsp;&nbsp;&nbsp;persistence_timeout&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">0</span><br>&nbsp;&nbsp;&nbsp;&nbsp;protocol&nbsp;TCP<br><br>&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">192.168</span>.0.18&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">80</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">10</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">3</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">3</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">80</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;real_server&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">192.168</span>.0.28&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">80</span>&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;weight&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">1</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCP_CHECK&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_timeout&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">10</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nb_get_retry&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">3</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delay_before_retry&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">3</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connect_port&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">80</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">从节点( BACKUP )配置文件</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">拷贝主节点的配置文件keepalived.conf，然后修改如下内容：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs perl" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-keyword" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">state</span>&nbsp;MASTER&nbsp;-&gt;&nbsp;<span class="hljs-keyword" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">state</span>&nbsp;BACKUP<br>priority&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">100</span>&nbsp;-&gt;&nbsp;priority&nbsp;<span class="hljs-number" style="font-size:inherit;line-height:inherit;color:rgb(174,135,250);">90</span><br></code></pre>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">keepalived的2个节点执行如下命令，开启转发功能：</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs shell" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-meta" style="font-size:inherit;line-height:inherit;color:rgb(91,218,237);">#</span><span class="bash" style="font-size:inherit;color:inherit;line-height:inherit;">&nbsp;<span class="hljs-built_in" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">echo</span>&nbsp;1&nbsp;&gt;&nbsp;/proc/sys/net/ipv4/ip_forward</span><br></code></pre>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">4、启动keepalive</span></p>
   <p><br></p>
   <pre style="font-size:inherit;color:inherit;line-height:inherit;"><code class="hljs xml" style="margin-left:2px;line-height:18px;font-size:14px;letter-spacing:0px;font-family:Consolas, Inconsolata, Courier, monospace;color:rgb(169,183,198);background:rgb(40,43,46);"><span class="hljs-tag" style="font-size:inherit;color:inherit;line-height:inherit;">&lt;<span class="hljs-name" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">strong</span>&gt;</span>先主后从分别启动keepalive<span class="hljs-tag" style="font-size:inherit;color:inherit;line-height:inherit;">&lt;/<span class="hljs-name" style="font-size:inherit;line-height:inherit;color:rgb(248,35,117);">strong</span>&gt;</span><br>service&nbsp;keepalived&nbsp;start<br></code></pre>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);"><br></span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">5、验证结果</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">实验1</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">手动关闭192.168.0.18节点的nginx，service&nbsp;nginx stop 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，不会出现访问18节点，一直访问的是28节点的内容。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">实验2</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">手动重新开启 192.168.0.18 节点的nginx，&nbsp;service&nbsp;nginx start 在客户端上去测试访问&nbsp;http://192.168.0.38&nbsp;结果正常，按照 rr 调度算法访问18节点和28节点。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">实验3</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">测试 keepalived 的HA特性，首先在master上执行命令 ip addr ，可以看到38的vip在master节点上的；这时如果在master上执行&nbsp;service&nbsp;keepalived stop 命令，这时vip已经不再master上，在slave节点上执行 ip addr 命令可以看到 vip 已经正确漂到slave节点，这时客户端去访问&nbsp;http://192.168.0.38&nbsp;访问依然正常，验证了 keepalived的HA特性。</span></p>
   <p><br></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(74,74,74);">lvs 介绍：</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);">http://www.it165.net/admin/html/201401/2248.html</span></p>
   <p style="letter-spacing:1px;"><span style="font-size:16px;color:rgb(0,82,255);"><br></span></p>
   <p style="text-align:center;letter-spacing:1.5px;"><span style="color:rgb(255,255,255);"><strong><span style="font-size:20px;">&nbsp;推荐↓↓↓&nbsp;</span></strong></span></p>
   <img style="vertical-align:middle;width:313px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/IwiaNBuWUDUzX3vMCt57DzWD1FUkicYK3C3VObzhyt4YU3rXujLwMXHoHqpB6B72h44DNib9J9jbQHk3giaxAeABWg/640?wx_fmt=png" alt="640?wx_fmt=png">
   <p><strong>长</strong></p>
   <p><strong>按</strong></p>
   <p><strong>关</strong></p>
   <p><strong>注</strong></p>
   <p style="letter-spacing:0px;"><strong><span style="font-size:18px;">👉</span></strong><span style="font-size:17px;"><strong>【</strong></span><a href="https://mp.weixin.qq.com/s?__biz=MzUzMDc0NzU4Nw==&amp;mid=2247483768&amp;idx=1&amp;sn=4ef4f1510616baa395c507e32bb439d7&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;color:rgb(255,79,121);font-size:17px;"><span style="color:rgb(255,79,121);font-size:17px;"><strong>16个技术公众号</strong></span></a><span style="font-size:17px;"><strong>】都在这里！</strong></span></p>
   <p><span style="color:rgb(136,136,136);font-size:15px;">涵盖：程序员大咖、源码共读、程序员共读、数据结构与算法、黑客技术和网络安全、大数据科技、编程前端、Java、Python、Web编程开发、Android、iOS开发、Linux、数据库研发、幽默程序员等。</span></p>
   <img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/ol72Wnba7fLkfGhCjKwHfZOmHMkVTIomtmHARHGo86u52ZIGicxfPPFBQ85dBUWf3trqDHPUuN7E2e26DpvfJdQ/640?wx_fmt=png" alt="640?wx_fmt=png">万水千山总是情，点个 “
   <strong><span style="color:rgb(0,112,192);">好看</span></strong>” 行不行
  </div> 
 </div> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
