<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>实战演练丨SCN太大引发ORA-600[2252] | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="实战演练丨SCN太大引发ORA-600[2252]" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="作者 | 张维照，云和恩墨技术专家，Oracle ACEA，2006年起从事数据库管理工作，2009年转Oracle，从事过多套TB级省级工商、医疗、交通、人社、电信运营等数据库维护优化工作，擅长Oracle数据库性能问题的分析与解决、故障分析、升级迁移。个人博客：www.anbob.com 案例背景 前段时间有个朋友遇到的问题，让我协助分析，现象是一个地市的数据库与省级数据库通过DBLINK连接时提示ORA-600 2252，但是其它地市与省级的DBLINK正常。 案例详情 具体分析，错误如下： SQL&gt; select sysdate from dual@ANBOB_RMTORA-00600: 内部错误代码, 参数: [2252], [3985], [1364216517], [], [], [], [], [] ORA-600 [2252] [A] [B] [] [] [] 原因：Oracle将给定的SCN值与基于系统日期，如果Oracle检测到提供的SCN太大，则会引发ORA-600[2252]。ARGS:参数A：SCN WRAP参数B：SCN BASE修复：症状：两台机器的系统日期不同症状：在两台机器之间使用数据库链接的查询失败原因： ORA-00600的参数[2252]表示Oracle为事务计算的系统更改号（SCN）是一个不合理的数字。SCN部分基于主机系统日期进行计算。如果系统日期相差很远，则为SCN计算的最大可能值可能不可能大，这将导致ORA-600[2252]。 总结：数据库当前的请求SCN大于当前最大允许SCN时会提示ORA-600[2252]，最大允许SCN是有本地系统时间决定。一个可能性是本地库主机时间向前调了，还有个可能性是通过DBLINK分布式事务同步SCN时，远程库SCN大于本地允许的最大SCN。 SQL@ANBOB&gt;&nbsp;select&nbsp;3985*power(2,32)+1364216517&nbsp;from&nbsp;dual;3985*POWER(2,32)+1364216517---------------------------17116808891077SQL@ANBOB&gt; select dbms_flashback.get_system_change_number scn from dual;SCN----------15756464714sys@ANBOB&gt;select current_scn,dbms_flashback.get_system_change_number scn from v$database;CURRENT_SCN SCN-------------------- --------------------15756464716 15756464716-- 确认时间,时区select CURRENT_TIMESTAMP, LOCALTIMESTAMP FROM DUAL;-- 现场的人整理了本地(DBa)、远程(DBb)库的系统时间和SCN.DBa DBb-------- ----------OS date: 20171204 15:50 20171204 15:48sysdate: 20171204 .. 20171204 ..scn: 15756464722 17117005290806DB ver: 11.2.0.1 11.2.0.3OS Plat: Windows Aix 注意：本地库和远程库的SCN不在一个数量级，相差1000倍，其实我们可以根据当前的时间计算一下SCN 的最大允许值，远程库的SCN 远大于本地库的最大允许SCN（简称RSL，下面会补充相关知识）。关于SCN可以查阅MOS note &lt;&lt;System Change Number（SCN）, Headroom, Security and Patch Information（文档 ID 1376995.1）&gt;&gt; — 查询远程库的SCN Headroom SQL&gt; select2 version,3 to_char(SYSDATE, &#39;YYYY/MM/DD HH24:MI:SS&#39;) DATE_TIME,4 ((((5 ((to_number(to_char(sysdate, &#39;YYYY&#39;)) - 1988) * 12 * 31 * 24 * 60 * 60) +6 ((to_number(to_char(sysdate, &#39;MM&#39;)) - 1) * 31 * 24 * 60 * 60) +7 (((to_number(to_char(sysdate, &#39;DD&#39;)) - 1)) * 24 * 60 * 60) +8 (to_number(to_char(sysdate, &#39;HH24&#39;)) * 60 * 60) +9 (to_number(to_char(sysdate, &#39;MI&#39;)) * 60) +10 (to_number(to_char(sysdate, &#39;SS&#39;)))11 ) * (16 * 1024)) - dbms_flashback.get_system_change_number)12 / (16 * 1024 * 60 * 60 * 24)13 ) indicator14 from v$instance15 ;VERSION DATE_TIME INDICATOR----------------- ------------------- ----------11.2.0.3.0 2017/12/04 17:15:26 -959.18726 注意： Oops!!!&nbsp; 上面的脚本也较常见来自官方的scnhealthcheck.sql， INDICATOR是距离SCN Headroom（天花板）的天数，是负数说明已经超过天花板上天了。当然SCN限制是决定不会也不允许超过天花板的。 那会不会是远程库有问题？为什么其它地市的库可以跟这个远程库查询？负数的原因是什么？ 基实上面的脚本对于11.2.0.2以后的数据库还需要确认另一处，就是每秒16K的限制从11G R2（11.2.0.2）起已经改变为32K（我查了11.2.0.3 11.2.0.4 12.2.0.1默认都是32K）, 有隐藏参数”_max_reasonable_scn_rate”控制，同时需要使用下面的SQL语句实际确认是16K还是32K（只对11.2.0.2以后的版本有意义），因为我发现有些11.2的数据库仍然使用的是16K（也许是低版本直接升级原因，也许是某个PSU临时回归了16K的增速）： sys@ANBOB_RMT&gt;@pd _max_reasonable_scn_rateShow all parameters and session values from x$ksppi/x$ksppcv...INDX I_HEX NAME VALUE DESCRIPTION-------------------- ----- ---------------------------- ---------- ---------------------------978 3D2 _max_reasonable_scn_rate 32768 Max reasonable SCN ratesys@ANBOB_RMT&gt;select decode(bitand(DI2FLAG,65536),65536,&#39;Y&#39;,&#39;N&#39;) using16 from x$kccdi2;U-Nsys@ANBOB_RMT&gt;selectversion,to_char(SYSDATE, &#39;YYYY/MM/DD HH24:MI:SS&#39;) DATE_TIME,((((((to_number(to_char(sysdate, &#39;YYYY&#39;)) - 1988) * 12 * 31 * 24 * 60 * 60) +((to_number(to_char(sysdate, &#39;MM&#39;)) - 1) * 31 * 24 * 60 * 60) +(((to_number(to_char(sysdate, &#39;DD&#39;)) - 1)) * 24 * 60 * 60) +(to_number(to_char(sysdate, &#39;HH24&#39;)) * 60 * 60) +(to_number(to_char(sysdate, &#39;MI&#39;)) * 60) +(to_number(to_char(sysdate, &#39;SS&#39;)))) * (32 * 1024)) - dbms_flashback.get_system_change_number)/ (32 * 1024 * 60 * 60 * 24)) indicatorfrom v$instance;VERSION DATE_TIME INDICATOR----------------- ------------------- ----------11.2.0.3.0 2017/12/04 17:35:26 5087.41908 现在总结一下这个问题： 本地库是11.2.0.1 scn 的频率限制还是16K； 远程库是11.2.0.3，并且从x$kccdi2确认了当前使用的频率限制是32K； 远程库当前的SCN已经超过了本地库16K允许的上限所以使用DBLINK 同步SCN 会出现ora-600 [2252]； 远程库查询天花板需要修改脚本中16为32； 其它地市能访问远程库是因为他们的数据库也是11.2.0.2版本以后，且同样使用的是32K的限制。 SCN增长速率加快了，如果32k的速度使用6bytes的scn总上限也就不是过去说的可用500年了，所以从12.2又引入了big scn加到了8bytes。且在12.2版本中对于SCN传播跳跃，增加了2个视图可以定位源头， 使用DBA_EXTERNAL_SCN_ACTIVITY&nbsp; DBA_DB_LINK_SOURCES and DBA_DB_LINK关连就可以，2012年1月以后的PSU起或在11G的部份版本中提供了控制SCN相关参数： SCN rejected due to request for high SCN increment（controlled by _external_scn_rejection_threshold_hours）限制最多用到多少，保留时间； SCN rejected due to request in certain DELTA of changes（controlled by _external_scn_rejection_delta_threshold_minutes）限制一次最多变化多少，如果请求超过会失败，提示ORA-19706； SCN accepted but with a warning（controlled by _external_scn_logging_threshold_seconds）增长超过一定阀值时，写ALERT LOG。 SCN相关知识点： SCN是Oracle数据库单向增长的”时钟”,广泛用于数据库一致性恢复和分布式事务（如dblink）； SCN有两部分组成 wrap.base， 在数据库中占用8bytes，在12c r2前预留2bytes，是一个6bytes（48bit）的Integer类型的数字，[16bit SCN Wrap].[32bit SCN Base]，在12c R2起引入big scn，启用了原来预留的2bytes, 总长限有原来的2^48增长到2^64； 为了限制SCN无限增长，在程序的代码级设计了一个当前时间点的允许的最大SCN（Maximum Reasonable SCN）的软限制，Reasonable SCN Limit简称RSL，这个值是有一个工式计算出来的RSL=（从1988年1月1日起到当前时间） * 24 * 3600 * 每秒允许的最大增长率， 需要注意的是并不是简单的当前时间和1988-1-1两个时间点相减，可能是出于计算的简单，每个月是按31天计算的，从上面MOS中提供的脚本也可以看出。 每秒允许的最大增长率在11.2.0.2之前是16384（16K）11.2.0.2及以后的版本是32768（32K），有隐藏参数_max_reasonable_scn_rate控制； SCN Headroom是一个最重要的检查项，值是当前时间点的允许的最大SCN与当前数据库SCN的差值，为了方便阅读以”天“为单位，SCN Headroom天数=（Maximum Reasonable SCN-Current SCN） /（每秒允许的最大增长率） /3600/24； SCN异常增长通常是有DBLINK、人为前推SCN、oracle bug，SCN的历史变化可以从V$ARCHIVED_LOG得到， 最近5天的SCN也可以尝试从smon_scn_time得到。 数据库自身的增长可以从从dba_hist_sysstat得到’calls to kcmgas’的变化，SCN通过DBLINK 的传播可以通过上面提到的参数控制，和12c 中提供的新视图； 数据库11.2.0.2及以后的版本默认是允许32K的增长速率，所以就会像本案例以上产生较大的SCN, 这就意味着11.2.0.2可能不能再与低版本的数据库或是使用16K增长速率的数据库通过DBLINK。 作者文章 新补丁更新（RU和RUR），新的版本（Release 18和19） Oracle 12c 关于密码（password）的几个新特性小结 故障诊断：12cR2 &nbsp;Flex ASM 环境中节点启动失败的诊断和分析 资源下载 关注公众号：数据和云（OraNews）回复关键字获取 2018DTCC&nbsp;,&nbsp;数据库大会PPT 2018DTC，2018 DTC 大会 PPT ENMOBK，《Oracle性能优化与诊断案例》 DBALIFE&nbsp;，“DBA 的一天”海报 DBA04&nbsp;，DBA 手记4 电子书 122ARCH&nbsp;，Oracle 12.2体系结构图 2018OOW&nbsp;，Oracle OpenWorld 资料 产品推荐 云和恩墨Bethune Pro企业版，集监控、巡检、安全于一身，你的专属数据库实时监控和智能巡检平台，漂亮的不像实力派，你值得拥有！ 云和恩墨zData一体机现已发布超融合版本和精简版，支持各种简化场景部署，零数据丢失备份一体机ZDBM也已发布，欢迎关注。" />
<meta property="og:description" content="作者 | 张维照，云和恩墨技术专家，Oracle ACEA，2006年起从事数据库管理工作，2009年转Oracle，从事过多套TB级省级工商、医疗、交通、人社、电信运营等数据库维护优化工作，擅长Oracle数据库性能问题的分析与解决、故障分析、升级迁移。个人博客：www.anbob.com 案例背景 前段时间有个朋友遇到的问题，让我协助分析，现象是一个地市的数据库与省级数据库通过DBLINK连接时提示ORA-600 2252，但是其它地市与省级的DBLINK正常。 案例详情 具体分析，错误如下： SQL&gt; select sysdate from dual@ANBOB_RMTORA-00600: 内部错误代码, 参数: [2252], [3985], [1364216517], [], [], [], [], [] ORA-600 [2252] [A] [B] [] [] [] 原因：Oracle将给定的SCN值与基于系统日期，如果Oracle检测到提供的SCN太大，则会引发ORA-600[2252]。ARGS:参数A：SCN WRAP参数B：SCN BASE修复：症状：两台机器的系统日期不同症状：在两台机器之间使用数据库链接的查询失败原因： ORA-00600的参数[2252]表示Oracle为事务计算的系统更改号（SCN）是一个不合理的数字。SCN部分基于主机系统日期进行计算。如果系统日期相差很远，则为SCN计算的最大可能值可能不可能大，这将导致ORA-600[2252]。 总结：数据库当前的请求SCN大于当前最大允许SCN时会提示ORA-600[2252]，最大允许SCN是有本地系统时间决定。一个可能性是本地库主机时间向前调了，还有个可能性是通过DBLINK分布式事务同步SCN时，远程库SCN大于本地允许的最大SCN。 SQL@ANBOB&gt;&nbsp;select&nbsp;3985*power(2,32)+1364216517&nbsp;from&nbsp;dual;3985*POWER(2,32)+1364216517---------------------------17116808891077SQL@ANBOB&gt; select dbms_flashback.get_system_change_number scn from dual;SCN----------15756464714sys@ANBOB&gt;select current_scn,dbms_flashback.get_system_change_number scn from v$database;CURRENT_SCN SCN-------------------- --------------------15756464716 15756464716-- 确认时间,时区select CURRENT_TIMESTAMP, LOCALTIMESTAMP FROM DUAL;-- 现场的人整理了本地(DBa)、远程(DBb)库的系统时间和SCN.DBa DBb-------- ----------OS date: 20171204 15:50 20171204 15:48sysdate: 20171204 .. 20171204 ..scn: 15756464722 17117005290806DB ver: 11.2.0.1 11.2.0.3OS Plat: Windows Aix 注意：本地库和远程库的SCN不在一个数量级，相差1000倍，其实我们可以根据当前的时间计算一下SCN 的最大允许值，远程库的SCN 远大于本地库的最大允许SCN（简称RSL，下面会补充相关知识）。关于SCN可以查阅MOS note &lt;&lt;System Change Number（SCN）, Headroom, Security and Patch Information（文档 ID 1376995.1）&gt;&gt; — 查询远程库的SCN Headroom SQL&gt; select2 version,3 to_char(SYSDATE, &#39;YYYY/MM/DD HH24:MI:SS&#39;) DATE_TIME,4 ((((5 ((to_number(to_char(sysdate, &#39;YYYY&#39;)) - 1988) * 12 * 31 * 24 * 60 * 60) +6 ((to_number(to_char(sysdate, &#39;MM&#39;)) - 1) * 31 * 24 * 60 * 60) +7 (((to_number(to_char(sysdate, &#39;DD&#39;)) - 1)) * 24 * 60 * 60) +8 (to_number(to_char(sysdate, &#39;HH24&#39;)) * 60 * 60) +9 (to_number(to_char(sysdate, &#39;MI&#39;)) * 60) +10 (to_number(to_char(sysdate, &#39;SS&#39;)))11 ) * (16 * 1024)) - dbms_flashback.get_system_change_number)12 / (16 * 1024 * 60 * 60 * 24)13 ) indicator14 from v$instance15 ;VERSION DATE_TIME INDICATOR----------------- ------------------- ----------11.2.0.3.0 2017/12/04 17:15:26 -959.18726 注意： Oops!!!&nbsp; 上面的脚本也较常见来自官方的scnhealthcheck.sql， INDICATOR是距离SCN Headroom（天花板）的天数，是负数说明已经超过天花板上天了。当然SCN限制是决定不会也不允许超过天花板的。 那会不会是远程库有问题？为什么其它地市的库可以跟这个远程库查询？负数的原因是什么？ 基实上面的脚本对于11.2.0.2以后的数据库还需要确认另一处，就是每秒16K的限制从11G R2（11.2.0.2）起已经改变为32K（我查了11.2.0.3 11.2.0.4 12.2.0.1默认都是32K）, 有隐藏参数”_max_reasonable_scn_rate”控制，同时需要使用下面的SQL语句实际确认是16K还是32K（只对11.2.0.2以后的版本有意义），因为我发现有些11.2的数据库仍然使用的是16K（也许是低版本直接升级原因，也许是某个PSU临时回归了16K的增速）： sys@ANBOB_RMT&gt;@pd _max_reasonable_scn_rateShow all parameters and session values from x$ksppi/x$ksppcv...INDX I_HEX NAME VALUE DESCRIPTION-------------------- ----- ---------------------------- ---------- ---------------------------978 3D2 _max_reasonable_scn_rate 32768 Max reasonable SCN ratesys@ANBOB_RMT&gt;select decode(bitand(DI2FLAG,65536),65536,&#39;Y&#39;,&#39;N&#39;) using16 from x$kccdi2;U-Nsys@ANBOB_RMT&gt;selectversion,to_char(SYSDATE, &#39;YYYY/MM/DD HH24:MI:SS&#39;) DATE_TIME,((((((to_number(to_char(sysdate, &#39;YYYY&#39;)) - 1988) * 12 * 31 * 24 * 60 * 60) +((to_number(to_char(sysdate, &#39;MM&#39;)) - 1) * 31 * 24 * 60 * 60) +(((to_number(to_char(sysdate, &#39;DD&#39;)) - 1)) * 24 * 60 * 60) +(to_number(to_char(sysdate, &#39;HH24&#39;)) * 60 * 60) +(to_number(to_char(sysdate, &#39;MI&#39;)) * 60) +(to_number(to_char(sysdate, &#39;SS&#39;)))) * (32 * 1024)) - dbms_flashback.get_system_change_number)/ (32 * 1024 * 60 * 60 * 24)) indicatorfrom v$instance;VERSION DATE_TIME INDICATOR----------------- ------------------- ----------11.2.0.3.0 2017/12/04 17:35:26 5087.41908 现在总结一下这个问题： 本地库是11.2.0.1 scn 的频率限制还是16K； 远程库是11.2.0.3，并且从x$kccdi2确认了当前使用的频率限制是32K； 远程库当前的SCN已经超过了本地库16K允许的上限所以使用DBLINK 同步SCN 会出现ora-600 [2252]； 远程库查询天花板需要修改脚本中16为32； 其它地市能访问远程库是因为他们的数据库也是11.2.0.2版本以后，且同样使用的是32K的限制。 SCN增长速率加快了，如果32k的速度使用6bytes的scn总上限也就不是过去说的可用500年了，所以从12.2又引入了big scn加到了8bytes。且在12.2版本中对于SCN传播跳跃，增加了2个视图可以定位源头， 使用DBA_EXTERNAL_SCN_ACTIVITY&nbsp; DBA_DB_LINK_SOURCES and DBA_DB_LINK关连就可以，2012年1月以后的PSU起或在11G的部份版本中提供了控制SCN相关参数： SCN rejected due to request for high SCN increment（controlled by _external_scn_rejection_threshold_hours）限制最多用到多少，保留时间； SCN rejected due to request in certain DELTA of changes（controlled by _external_scn_rejection_delta_threshold_minutes）限制一次最多变化多少，如果请求超过会失败，提示ORA-19706； SCN accepted but with a warning（controlled by _external_scn_logging_threshold_seconds）增长超过一定阀值时，写ALERT LOG。 SCN相关知识点： SCN是Oracle数据库单向增长的”时钟”,广泛用于数据库一致性恢复和分布式事务（如dblink）； SCN有两部分组成 wrap.base， 在数据库中占用8bytes，在12c r2前预留2bytes，是一个6bytes（48bit）的Integer类型的数字，[16bit SCN Wrap].[32bit SCN Base]，在12c R2起引入big scn，启用了原来预留的2bytes, 总长限有原来的2^48增长到2^64； 为了限制SCN无限增长，在程序的代码级设计了一个当前时间点的允许的最大SCN（Maximum Reasonable SCN）的软限制，Reasonable SCN Limit简称RSL，这个值是有一个工式计算出来的RSL=（从1988年1月1日起到当前时间） * 24 * 3600 * 每秒允许的最大增长率， 需要注意的是并不是简单的当前时间和1988-1-1两个时间点相减，可能是出于计算的简单，每个月是按31天计算的，从上面MOS中提供的脚本也可以看出。 每秒允许的最大增长率在11.2.0.2之前是16384（16K）11.2.0.2及以后的版本是32768（32K），有隐藏参数_max_reasonable_scn_rate控制； SCN Headroom是一个最重要的检查项，值是当前时间点的允许的最大SCN与当前数据库SCN的差值，为了方便阅读以”天“为单位，SCN Headroom天数=（Maximum Reasonable SCN-Current SCN） /（每秒允许的最大增长率） /3600/24； SCN异常增长通常是有DBLINK、人为前推SCN、oracle bug，SCN的历史变化可以从V$ARCHIVED_LOG得到， 最近5天的SCN也可以尝试从smon_scn_time得到。 数据库自身的增长可以从从dba_hist_sysstat得到’calls to kcmgas’的变化，SCN通过DBLINK 的传播可以通过上面提到的参数控制，和12c 中提供的新视图； 数据库11.2.0.2及以后的版本默认是允许32K的增长速率，所以就会像本案例以上产生较大的SCN, 这就意味着11.2.0.2可能不能再与低版本的数据库或是使用16K增长速率的数据库通过DBLINK。 作者文章 新补丁更新（RU和RUR），新的版本（Release 18和19） Oracle 12c 关于密码（password）的几个新特性小结 故障诊断：12cR2 &nbsp;Flex ASM 环境中节点启动失败的诊断和分析 资源下载 关注公众号：数据和云（OraNews）回复关键字获取 2018DTCC&nbsp;,&nbsp;数据库大会PPT 2018DTC，2018 DTC 大会 PPT ENMOBK，《Oracle性能优化与诊断案例》 DBALIFE&nbsp;，“DBA 的一天”海报 DBA04&nbsp;，DBA 手记4 电子书 122ARCH&nbsp;，Oracle 12.2体系结构图 2018OOW&nbsp;，Oracle OpenWorld 资料 产品推荐 云和恩墨Bethune Pro企业版，集监控、巡检、安全于一身，你的专属数据库实时监控和智能巡检平台，漂亮的不像实力派，你值得拥有！ 云和恩墨zData一体机现已发布超融合版本和精简版，支持各种简化场景部署，零数据丢失备份一体机ZDBM也已发布，欢迎关注。" />
<link rel="canonical" href="https://mlh.app/2019/04/07/728672.html" />
<meta property="og:url" content="https://mlh.app/2019/04/07/728672.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-07T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"作者 | 张维照，云和恩墨技术专家，Oracle ACEA，2006年起从事数据库管理工作，2009年转Oracle，从事过多套TB级省级工商、医疗、交通、人社、电信运营等数据库维护优化工作，擅长Oracle数据库性能问题的分析与解决、故障分析、升级迁移。个人博客：www.anbob.com 案例背景 前段时间有个朋友遇到的问题，让我协助分析，现象是一个地市的数据库与省级数据库通过DBLINK连接时提示ORA-600 2252，但是其它地市与省级的DBLINK正常。 案例详情 具体分析，错误如下： SQL&gt; select sysdate from dual@ANBOB_RMTORA-00600: 内部错误代码, 参数: [2252], [3985], [1364216517], [], [], [], [], [] ORA-600 [2252] [A] [B] [] [] [] 原因：Oracle将给定的SCN值与基于系统日期，如果Oracle检测到提供的SCN太大，则会引发ORA-600[2252]。ARGS:参数A：SCN WRAP参数B：SCN BASE修复：症状：两台机器的系统日期不同症状：在两台机器之间使用数据库链接的查询失败原因： ORA-00600的参数[2252]表示Oracle为事务计算的系统更改号（SCN）是一个不合理的数字。SCN部分基于主机系统日期进行计算。如果系统日期相差很远，则为SCN计算的最大可能值可能不可能大，这将导致ORA-600[2252]。 总结：数据库当前的请求SCN大于当前最大允许SCN时会提示ORA-600[2252]，最大允许SCN是有本地系统时间决定。一个可能性是本地库主机时间向前调了，还有个可能性是通过DBLINK分布式事务同步SCN时，远程库SCN大于本地允许的最大SCN。 SQL@ANBOB&gt;&nbsp;select&nbsp;3985*power(2,32)+1364216517&nbsp;from&nbsp;dual;3985*POWER(2,32)+1364216517---------------------------17116808891077SQL@ANBOB&gt; select dbms_flashback.get_system_change_number scn from dual;SCN----------15756464714sys@ANBOB&gt;select current_scn,dbms_flashback.get_system_change_number scn from v$database;CURRENT_SCN SCN-------------------- --------------------15756464716 15756464716-- 确认时间,时区select CURRENT_TIMESTAMP, LOCALTIMESTAMP FROM DUAL;-- 现场的人整理了本地(DBa)、远程(DBb)库的系统时间和SCN.DBa DBb-------- ----------OS date: 20171204 15:50 20171204 15:48sysdate: 20171204 .. 20171204 ..scn: 15756464722 17117005290806DB ver: 11.2.0.1 11.2.0.3OS Plat: Windows Aix 注意：本地库和远程库的SCN不在一个数量级，相差1000倍，其实我们可以根据当前的时间计算一下SCN 的最大允许值，远程库的SCN 远大于本地库的最大允许SCN（简称RSL，下面会补充相关知识）。关于SCN可以查阅MOS note &lt;&lt;System Change Number（SCN）, Headroom, Security and Patch Information（文档 ID 1376995.1）&gt;&gt; — 查询远程库的SCN Headroom SQL&gt; select2 version,3 to_char(SYSDATE, &#39;YYYY/MM/DD HH24:MI:SS&#39;) DATE_TIME,4 ((((5 ((to_number(to_char(sysdate, &#39;YYYY&#39;)) - 1988) * 12 * 31 * 24 * 60 * 60) +6 ((to_number(to_char(sysdate, &#39;MM&#39;)) - 1) * 31 * 24 * 60 * 60) +7 (((to_number(to_char(sysdate, &#39;DD&#39;)) - 1)) * 24 * 60 * 60) +8 (to_number(to_char(sysdate, &#39;HH24&#39;)) * 60 * 60) +9 (to_number(to_char(sysdate, &#39;MI&#39;)) * 60) +10 (to_number(to_char(sysdate, &#39;SS&#39;)))11 ) * (16 * 1024)) - dbms_flashback.get_system_change_number)12 / (16 * 1024 * 60 * 60 * 24)13 ) indicator14 from v$instance15 ;VERSION DATE_TIME INDICATOR----------------- ------------------- ----------11.2.0.3.0 2017/12/04 17:15:26 -959.18726 注意： Oops!!!&nbsp; 上面的脚本也较常见来自官方的scnhealthcheck.sql， INDICATOR是距离SCN Headroom（天花板）的天数，是负数说明已经超过天花板上天了。当然SCN限制是决定不会也不允许超过天花板的。 那会不会是远程库有问题？为什么其它地市的库可以跟这个远程库查询？负数的原因是什么？ 基实上面的脚本对于11.2.0.2以后的数据库还需要确认另一处，就是每秒16K的限制从11G R2（11.2.0.2）起已经改变为32K（我查了11.2.0.3 11.2.0.4 12.2.0.1默认都是32K）, 有隐藏参数”_max_reasonable_scn_rate”控制，同时需要使用下面的SQL语句实际确认是16K还是32K（只对11.2.0.2以后的版本有意义），因为我发现有些11.2的数据库仍然使用的是16K（也许是低版本直接升级原因，也许是某个PSU临时回归了16K的增速）： sys@ANBOB_RMT&gt;@pd _max_reasonable_scn_rateShow all parameters and session values from x$ksppi/x$ksppcv...INDX I_HEX NAME VALUE DESCRIPTION-------------------- ----- ---------------------------- ---------- ---------------------------978 3D2 _max_reasonable_scn_rate 32768 Max reasonable SCN ratesys@ANBOB_RMT&gt;select decode(bitand(DI2FLAG,65536),65536,&#39;Y&#39;,&#39;N&#39;) using16 from x$kccdi2;U-Nsys@ANBOB_RMT&gt;selectversion,to_char(SYSDATE, &#39;YYYY/MM/DD HH24:MI:SS&#39;) DATE_TIME,((((((to_number(to_char(sysdate, &#39;YYYY&#39;)) - 1988) * 12 * 31 * 24 * 60 * 60) +((to_number(to_char(sysdate, &#39;MM&#39;)) - 1) * 31 * 24 * 60 * 60) +(((to_number(to_char(sysdate, &#39;DD&#39;)) - 1)) * 24 * 60 * 60) +(to_number(to_char(sysdate, &#39;HH24&#39;)) * 60 * 60) +(to_number(to_char(sysdate, &#39;MI&#39;)) * 60) +(to_number(to_char(sysdate, &#39;SS&#39;)))) * (32 * 1024)) - dbms_flashback.get_system_change_number)/ (32 * 1024 * 60 * 60 * 24)) indicatorfrom v$instance;VERSION DATE_TIME INDICATOR----------------- ------------------- ----------11.2.0.3.0 2017/12/04 17:35:26 5087.41908 现在总结一下这个问题： 本地库是11.2.0.1 scn 的频率限制还是16K； 远程库是11.2.0.3，并且从x$kccdi2确认了当前使用的频率限制是32K； 远程库当前的SCN已经超过了本地库16K允许的上限所以使用DBLINK 同步SCN 会出现ora-600 [2252]； 远程库查询天花板需要修改脚本中16为32； 其它地市能访问远程库是因为他们的数据库也是11.2.0.2版本以后，且同样使用的是32K的限制。 SCN增长速率加快了，如果32k的速度使用6bytes的scn总上限也就不是过去说的可用500年了，所以从12.2又引入了big scn加到了8bytes。且在12.2版本中对于SCN传播跳跃，增加了2个视图可以定位源头， 使用DBA_EXTERNAL_SCN_ACTIVITY&nbsp; DBA_DB_LINK_SOURCES and DBA_DB_LINK关连就可以，2012年1月以后的PSU起或在11G的部份版本中提供了控制SCN相关参数： SCN rejected due to request for high SCN increment（controlled by _external_scn_rejection_threshold_hours）限制最多用到多少，保留时间； SCN rejected due to request in certain DELTA of changes（controlled by _external_scn_rejection_delta_threshold_minutes）限制一次最多变化多少，如果请求超过会失败，提示ORA-19706； SCN accepted but with a warning（controlled by _external_scn_logging_threshold_seconds）增长超过一定阀值时，写ALERT LOG。 SCN相关知识点： SCN是Oracle数据库单向增长的”时钟”,广泛用于数据库一致性恢复和分布式事务（如dblink）； SCN有两部分组成 wrap.base， 在数据库中占用8bytes，在12c r2前预留2bytes，是一个6bytes（48bit）的Integer类型的数字，[16bit SCN Wrap].[32bit SCN Base]，在12c R2起引入big scn，启用了原来预留的2bytes, 总长限有原来的2^48增长到2^64； 为了限制SCN无限增长，在程序的代码级设计了一个当前时间点的允许的最大SCN（Maximum Reasonable SCN）的软限制，Reasonable SCN Limit简称RSL，这个值是有一个工式计算出来的RSL=（从1988年1月1日起到当前时间） * 24 * 3600 * 每秒允许的最大增长率， 需要注意的是并不是简单的当前时间和1988-1-1两个时间点相减，可能是出于计算的简单，每个月是按31天计算的，从上面MOS中提供的脚本也可以看出。 每秒允许的最大增长率在11.2.0.2之前是16384（16K）11.2.0.2及以后的版本是32768（32K），有隐藏参数_max_reasonable_scn_rate控制； SCN Headroom是一个最重要的检查项，值是当前时间点的允许的最大SCN与当前数据库SCN的差值，为了方便阅读以”天“为单位，SCN Headroom天数=（Maximum Reasonable SCN-Current SCN） /（每秒允许的最大增长率） /3600/24； SCN异常增长通常是有DBLINK、人为前推SCN、oracle bug，SCN的历史变化可以从V$ARCHIVED_LOG得到， 最近5天的SCN也可以尝试从smon_scn_time得到。 数据库自身的增长可以从从dba_hist_sysstat得到’calls to kcmgas’的变化，SCN通过DBLINK 的传播可以通过上面提到的参数控制，和12c 中提供的新视图； 数据库11.2.0.2及以后的版本默认是允许32K的增长速率，所以就会像本案例以上产生较大的SCN, 这就意味着11.2.0.2可能不能再与低版本的数据库或是使用16K增长速率的数据库通过DBLINK。 作者文章 新补丁更新（RU和RUR），新的版本（Release 18和19） Oracle 12c 关于密码（password）的几个新特性小结 故障诊断：12cR2 &nbsp;Flex ASM 环境中节点启动失败的诊断和分析 资源下载 关注公众号：数据和云（OraNews）回复关键字获取 2018DTCC&nbsp;,&nbsp;数据库大会PPT 2018DTC，2018 DTC 大会 PPT ENMOBK，《Oracle性能优化与诊断案例》 DBALIFE&nbsp;，“DBA 的一天”海报 DBA04&nbsp;，DBA 手记4 电子书 122ARCH&nbsp;，Oracle 12.2体系结构图 2018OOW&nbsp;，Oracle OpenWorld 资料 产品推荐 云和恩墨Bethune Pro企业版，集监控、巡检、安全于一身，你的专属数据库实时监控和智能巡检平台，漂亮的不像实力派，你值得拥有！ 云和恩墨zData一体机现已发布超融合版本和精简版，支持各种简化场景部署，零数据丢失备份一体机ZDBM也已发布，欢迎关注。","@type":"BlogPosting","url":"https://mlh.app/2019/04/07/728672.html","headline":"实战演练丨SCN太大引发ORA-600[2252]","dateModified":"2019-04-07T00:00:00+08:00","datePublished":"2019-04-07T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2019/04/07/728672.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>实战演练丨SCN太大引发ORA-600[2252]</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="rich_media_content" id="js_content"> 
   <img style="vertical-align:middle;width:216px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/bURPjgFpGMTnq0Jmu0O92VdUQ5R8Ebj2McPckBPT0xIotUIibb9PNx6khhUgRzl445A7RDiayHgUbzJjibbhgT9QQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p style="clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:14px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:.544000029563904px;line-height:27.2000007629395px;text-align:justify;text-indent:0px;text-transform:none;word-spacing:0px;">作者 | 张维照，云和恩墨技术专家，Oracle ACEA，2006年起从事数据库管理工作，2009年转Oracle，从事过多套TB级省级工商、医疗、交通、人社、电信运营等数据库维护优化工作，擅长Oracle数据库性能问题的分析与解决、故障分析、升级迁移。个人博客：<span style="color:rgb(136,136,136);">www.anbob.com</span></p>
   <p style="letter-spacing:3px;"><strong><span style="font-size:17px;"><br></span></strong></p>
   <p style="letter-spacing:3px;"><strong><span style="font-size:17px;">案例背景</span></strong></p>
   <p><span style="font-size:15px;"></span><br></p>
   <p><span style="font-size:15px;">前段时间有个朋友遇到的问题，让我协助分析，现象是一个地市的数据库与省级数据库通过DBLINK连接时提示ORA-600 2252，但是其它地市与省级的DBLINK正常。</span></p>
   <p style="letter-spacing:3px;"><strong><span style="font-size:17px;"><br></span></strong></p>
   <p style="letter-spacing:3px;"><strong><span style="font-size:17px;">案例详情</span></strong></p>
   <p style="line-height:normal;"><span style="font-size:15px;"></span><br></p>
   <p><span style="font-size:15px;">具体分析，错误如下：</span><br></p>
   <ul class="code-snippet__line-index code-snippet__js">
    <li></li>
    <li></li>
    <li></li>
   </ul>
   <pre class="code-snippet__js"><code><span class="code-snippet_outer">SQL&gt; <span class="code-snippet__keyword">select</span> sysdate <span class="code-snippet__keyword">from</span> dual@ANBOB_RMT</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">ORA<span class="code-snippet__number">-00600</span>: 内部错误代码, 参数: [<span class="code-snippet__number">2252</span>], [<span class="code-snippet__number">3985</span>], [<span class="code-snippet__number">1364216517</span>], [], [], [], [], []</span></code></pre>
   <p><span style="font-size:15px;"><strong>ORA-600 [2252] [A] [B] [] [] []</strong></span></p>
   <p><br></p>
   <p><strong><span style="font-size:15px;">原因：</span></strong><span style="font-size:15px;">Oracle将给定的SCN值与基于系统日期，如果Oracle检测到提供的SCN太大，则会引发ORA-600[2252]。<br><br><strong>ARGS:</strong><br><br>参数A：SCN WRAP<br>参数B：SCN BASE<br><br><strong>修复：</strong><br><br>症状：两台机器的系统日期不同<br>症状：在两台机器之间使用数据库链接的查询失败<br><br><strong>原因：</strong><br></span></p>
   <p><span style="font-size:15px;"><br></span></p>
   <p><span style="font-size:15px;">ORA-00600的参数[2252]表示Oracle为事务计算的系统更改号（SCN）是一个不合理的数字。SCN部分基于主机系统日期进行计算。如果系统日期相差很远，则为SCN计算的最大可能值可能不可能大，这将导致ORA-600[2252]。</span></p>
   <p><br></p>
   <p><strong><span style="font-size:15px;">总结：</span></strong><span style="font-size:15px;">数据库当前的请求SCN大于当前最大允许SCN时会提示ORA-600[2252]，最大允许SCN是有本地系统时间决定。一个可能性是本地库主机时间向前调了，还有个可能性是通过DBLINK分布式事务同步SCN时，远程库SCN大于本地允许的最大<span style="font-size:15px;">SCN</span>。</span></p>
   <p><br></p>
   <ul class="code-snippet__line-index code-snippet__js">
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
   </ul>
   <pre class="code-snippet__js"><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">SQL</span>@<span class="code-snippet__keyword">ANBOB</span>&gt;&nbsp;select&nbsp;<span class="code-snippet__number">3985</span>*power(<span class="code-snippet__number">2</span>,<span class="code-snippet__number">32</span>)+<span class="code-snippet__number">1364216517</span>&nbsp;from&nbsp;dual;</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">3985*<span class="code-snippet__selector-tag">POWER</span>(2,32)+1364216517</span></code><code><span class="code-snippet_outer">---------------------------</span></code><code><span class="code-snippet_outer">17116808891077</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">SQL</span>@<span class="code-snippet__keyword">ANBOB</span>&gt; select dbms_flashback.get_system_change_number scn from dual;</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">SCN</span></code><code><span class="code-snippet_outer">----------</span></code><code><span class="code-snippet_outer">15756464714</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">sys</span>@<span class="code-snippet__keyword">ANBOB</span>&gt;<span class="code-snippet__keyword">select</span> current_scn,dbms_flashback.get_system_change_number scn from v$database;</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">CURRENT_SCN</span> <span class="code-snippet__selector-tag">SCN</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">--------------------</span> <span class="code-snippet__selector-tag">--------------------</span></span></code><code><span class="code-snippet_outer">15756464716 15756464716</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">--</span> 确认时间,时区</span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">select</span> <span class="code-snippet__selector-tag">CURRENT_TIMESTAMP</span>, <span class="code-snippet__selector-tag">LOCALTIMESTAMP</span> <span class="code-snippet__selector-tag">FROM</span> <span class="code-snippet__selector-tag">DUAL</span>;</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">--</span> 现场的人整理了本地(<span class="code-snippet__selector-tag">DBa</span>)、远程(<span class="code-snippet__selector-tag">DBb</span>)库的系统时间和<span class="code-snippet__selector-tag">SCN</span>.</span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">DBa</span> <span class="code-snippet__selector-tag">DBb</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">--------</span> <span class="code-snippet__selector-tag">----------</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">OS</span> <span class="code-snippet__selector-tag">date</span>: 20171204 15<span class="code-snippet__selector-pseudo">:50</span> 20171204 15<span class="code-snippet__selector-pseudo">:48</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">sysdate</span>: 20171204 .. 20171204 ..</span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">scn</span>: 15756464722 17117005290806</span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">DB</span> <span class="code-snippet__selector-tag">ver</span>: 11<span class="code-snippet__selector-class">.2.0.1</span> 11<span class="code-snippet__selector-class">.2.0.3</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__selector-tag">OS</span> <span class="code-snippet__selector-tag">Plat</span>: <span class="code-snippet__selector-tag">Windows</span> <span class="code-snippet__selector-tag">Aix</span></span></code></pre>
   <p><br></p>
   <p style="text-align:left;"><span style="font-size:15px;"><strong>注意：</strong><br>本地库和远程库的SCN不在一个数量级，相差1000倍，其实我们可以根据当前的时间计算一下SCN 的最大允许值，远程库的SCN 远大于本地库的最大允许SCN（简称RSL，下面会补充相关知识）。关于SCN可以查阅MOS note &lt;&lt;System Change Number（SCN）, Headroom, Security and Patch Information（文档 ID 1376995.1）&gt;&gt;</span></p>
   <p><br></p>
   <p><span style="font-size:15px;">— <strong>查询远程库的SCN Headroom</strong></span></p>
   <ul class="code-snippet__line-index code-snippet__js">
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
   </ul>
   <pre class="code-snippet__js"><code><span class="code-snippet_outer"><span class="code-snippet__meta">SQL&gt;</span> <span class="code-snippet__string">select</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">2</span> <span class="code-snippet__string">version,</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">3</span> <span class="code-snippet__string">to_char(SYSDATE, 'YYYY/MM/DD HH24:MI:SS') DATE_TIME,</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">4</span> <span class="code-snippet__string">((((</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">5</span> <span class="code-snippet__string">((to_number(to_char(sysdate, 'YYYY')) - 1988) * 12 * 31 * 24 * 60 * 60) +</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">6</span> <span class="code-snippet__string">((to_number(to_char(sysdate, 'MM')) - 1) * 31 * 24 * 60 * 60) +</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">7</span> <span class="code-snippet__string">(((to_number(to_char(sysdate, 'DD')) - 1)) * 24 * 60 * 60) +</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">8</span> <span class="code-snippet__string">(to_number(to_char(sysdate, 'HH24')) * 60 * 60) +</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">9</span> <span class="code-snippet__string">(to_number(to_char(sysdate, 'MI')) * 60) +</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">10</span> <span class="code-snippet__string">(to_number(to_char(sysdate, 'SS')))</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">11</span> <span class="code-snippet__string">) * (16 * 1024)) - dbms_flashback.get_system_change_number)</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">12</span> <span class="code-snippet__string">/ (16 * 1024 * 60 * 60 * 24)</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">13</span> <span class="code-snippet__string">) indicator</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">14</span> <span class="code-snippet__string">from v$instance</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">15</span> <span class="code-snippet__string">;</span></span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer"><span class="code-snippet__attr">VERSION</span> <span class="code-snippet__string">DATE_TIME INDICATOR</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__meta">-----------------</span> <span class="code-snippet__string">------------------- ----------</span></span></code><code><span class="code-snippet_outer"><span class="code-snippet__meta">11.2.0.3.0</span> <span class="code-snippet__string">2017/12/04 17:15:26 -959.18726</span></span></code></pre>
   <pre><strong><span style="color:#ff0000;"></span></strong><br><strong>注意：</strong><br></pre>
   <p style="text-align:left;"><span style="font-size:15px;">Oops!!!&nbsp; 上面的脚本也较常见来自官方的scnhealthcheck.sql， INDICATOR是距离SCN Headroom（天花板）的天数，是负数说明已经超过天花板上天了。当然SCN限制是决定不会也不允许超过天花板的。 那会不会是远程库有问题？为什么其它地市的库可以跟这个远程库查询？负数的原因是什么？</span></p>
   <p><br></p>
   <p style="text-align:left;"><span style="font-size:15px;">基实上面的脚本对于11.2.0.2以后的数据库还需要确认另一处，就是每秒16K的限制从11G R2（11.2.0.2）起已经改变为32K（我查了11.2.0.3 11.2.0.4 12.2.0.1默认都是32K）, 有隐藏参数”_max_reasonable_scn_rate”控制，同时需要使用下面的SQL语句实际确认是16K还是32K（只对11.2.0.2以后的版本有意义），因为我发现有些11.2的数据库仍然使用的是16K（也许是低版本直接升级原因，也许是某个PSU临时回归了16K的增速）：</span></p>
   <p><br></p>
   <ul class="code-snippet__line-index code-snippet__js">
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
   </ul>
   <pre class="code-snippet__js"><code><span class="code-snippet_outer">sys@ANBOB_RMT&gt;@pd _max_reasonable_scn_rate</span></code><code><span class="code-snippet_outer">Show all parameters <span class="code-snippet__keyword">and</span> session <span class="code-snippet__keyword">values</span> from <span class="code-snippet__keyword">x</span>$ksppi/<span class="code-snippet__keyword">x</span>$ksppcv...</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">INDX I_HEX NAME VALUE DESCRIPTION</span></code><code><span class="code-snippet_outer">-------------------- ----- ---------------------------- ---------- ---------------------------</span></code><code><span class="code-snippet_outer"><span class="code-snippet__number">978</span> <span class="code-snippet__number">3</span>D2 _max_reasonable_scn_rate <span class="code-snippet__number">32768</span> Max reasonable SCN rate</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">sys@ANBOB_RMT&gt;<span class="code-snippet__keyword">select</span> decode(bitand(DI2FLAG,<span class="code-snippet__number">65536</span>),<span class="code-snippet__number">65536</span>,<span class="code-snippet__string">'Y'</span>,<span class="code-snippet__string">'N'</span>) using16 from <span class="code-snippet__keyword">x</span>$kccdi2;</span></code><code><span class="code-snippet_outer">U</span></code><code><span class="code-snippet_outer">-</span></code><code><span class="code-snippet_outer">N</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">sys@ANBOB_RMT&gt;<span class="code-snippet__keyword">select</span></span></code><code><span class="code-snippet_outer">version,</span></code><code><span class="code-snippet_outer">to_char(SYSDATE, <span class="code-snippet__string">'YYYY/MM/DD HH24:MI:SS'</span>) DATE_TIME,</span></code><code><span class="code-snippet_outer">((((</span></code><code><span class="code-snippet_outer">((to_number(to_char(sysdate, <span class="code-snippet__string">'YYYY'</span>)) - <span class="code-snippet__number">1988</span>) * <span class="code-snippet__number">12</span> * <span class="code-snippet__number">31</span> * <span class="code-snippet__number">24</span> * <span class="code-snippet__number">60</span> * <span class="code-snippet__number">60</span>) +</span></code><code><span class="code-snippet_outer">((to_number(to_char(sysdate, <span class="code-snippet__string">'MM'</span>)) - <span class="code-snippet__number">1</span>) * <span class="code-snippet__number">31</span> * <span class="code-snippet__number">24</span> * <span class="code-snippet__number">60</span> * <span class="code-snippet__number">60</span>) +</span></code><code><span class="code-snippet_outer">(((to_number(to_char(sysdate, <span class="code-snippet__string">'DD'</span>)) - <span class="code-snippet__number">1</span>)) * <span class="code-snippet__number">24</span> * <span class="code-snippet__number">60</span> * <span class="code-snippet__number">60</span>) +</span></code><code><span class="code-snippet_outer">(to_number(to_char(sysdate, <span class="code-snippet__string">'HH24'</span>)) * <span class="code-snippet__number">60</span> * <span class="code-snippet__number">60</span>) +</span></code><code><span class="code-snippet_outer">(to_number(to_char(sysdate, <span class="code-snippet__string">'MI'</span>)) * <span class="code-snippet__number">60</span>) +</span></code><code><span class="code-snippet_outer">(to_number(to_char(sysdate, <span class="code-snippet__string">'SS'</span>)))</span></code><code><span class="code-snippet_outer">) * (<span class="code-snippet__number">32</span> * <span class="code-snippet__number">1024</span>)) - dbms_flashback.get_system_change_number)</span></code><code><span class="code-snippet_outer">/ (<span class="code-snippet__number">32</span> * <span class="code-snippet__number">1024</span> * <span class="code-snippet__number">60</span> * <span class="code-snippet__number">60</span> * <span class="code-snippet__number">24</span>)</span></code><code><span class="code-snippet_outer">) indicator</span></code><code><span class="code-snippet_outer">from v$instance;</span></code><code><span class="code-snippet_outer"><br></span></code><code><span class="code-snippet_outer">VERSION DATE_TIME INDICATOR</span></code><code><span class="code-snippet_outer">----------------- ------------------- ----------</span></code><code><span class="code-snippet_outer"><span class="code-snippet__number">11.2</span>.<span class="code-snippet__number">0</span>.<span class="code-snippet__number">3.0</span> <span class="code-snippet__number">2017</span>/<span class="code-snippet__number">12</span>/<span class="code-snippet__number">04</span> <span class="code-snippet__number">17</span>:<span class="code-snippet__number">35</span>:<span class="code-snippet__number">26</span> <span class="code-snippet__number">5087.41908</span></span></code></pre>
   <h4><br></h4>
   <h4><span style="font-size:15px;"><strong>现在总结一下这个问题：</strong></span></h4>
   <p><br></p>
   <ul style="list-style-type:square;" class="list-paddingleft-2">
    <li><p><span style="font-size:15px;">本地库是11.2.0.1 scn 的频率限制还是16K；</span></p></li>
    <li><p><span style="font-size:15px;">远程库是11.2.0.3，并且从x$kccdi2确认了当前使用的频率限制是32K；</span></p></li>
    <li><p><span style="font-size:15px;">远程库当前的SCN已经超过了本地库16K允许的上限所以使用DBLINK 同步SCN 会出现ora-600 [2252]；</span></p></li>
    <li><p><span style="font-size:15px;">远程库查询天花板需要修改脚本中16为32；</span></p></li>
    <li><p><span style="font-size:15px;">其它地市能访问远程库是因为他们的数据库也是11.2.0.2版本以后，且同样使用的是32K的限制。</span></p></li>
   </ul>
   <p><br></p>
   <p style="text-align:left;"><span style="font-size:15px;">SCN增长速率加快了，如果32k的速度使用6bytes的scn总上限也就不是过去说的可用500年了，所以从12.2又引入了big scn加到了8bytes。且在12.2版本中对于SCN传播跳跃，增加了2个视图可以定位源头， 使用DBA_EXTERNAL_SCN_ACTIVITY&nbsp; DBA_DB_LINK_SOURCES and DBA_DB_LINK关连就可以，2012年1月以后的PSU起或在11G的部份版本中提供了控制SCN相关参数：</span></p>
   <p style="text-align:left;"><span style="font-size:15px;"><br></span></p>
   <ul style="list-style-type:square;" class="list-paddingleft-2">
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN rejected due to request for high SCN increment（controlled by _external_scn_rejection_threshold_hours）限制最多用到多少，保留时间；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN rejected due to request in certain DELTA of changes（controlled by _external_scn_rejection_delta_threshold_minutes）限制一次最多变化多少，如果请求超过会失败，提示ORA-19706；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN accepted but with a warning（controlled by _external_scn_logging_threshold_seconds）增长超过一定阀值时，写ALERT LOG。</span></p></li>
   </ul>
   <h4><br></h4>
   <h4><span style="font-size:15px;"><strong>SCN相关知识点：</strong></span></h4>
   <p><br></p>
   <ul style="list-style-type:square;" class="list-paddingleft-2">
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN是Oracle数据库单向增长的”时钟”,广泛用于数据库一致性恢复和分布式事务（如dblink）；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN有两部分组成 wrap.base， 在数据库中占用8bytes，在12c r2前预留2bytes，是一个6bytes（48bit）的Integer类型的数字，[16bit SCN Wrap].[32bit SCN Base]，在12c R2起引入big scn，启用了原来预留的2bytes, 总长限有原来的2^48增长到2^64；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;">为了限制SCN无限增长，在程序的代码级设计了一个当前时间点的允许的最大SCN（Maximum Reasonable SCN）的软限制，Reasonable SCN Limit简称RSL，这个值是有一个工式计算出来的RSL=（从1988年1月1日起到当前时间） * 24 * 3600 * 每秒允许的最大增长率， 需要注意的是并不是简单的当前时间和1988-1-1两个时间点相减，可能是出于计算的简单，每个月是按31天计算的，从上面MOS中提供的脚本也可以看出。 每秒允许的最大增长率在11.2.0.2之前是16384（16K）11.2.0.2及以后的版本是32768（32K），有隐藏参数_max_reasonable_scn_rate控制；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN Headroom是一个最重要的检查项，值是当前时间点的允许的最大SCN与当前数据库SCN的差值，为了方便阅读以”天“为单位，SCN Headroom天数=（Maximum Reasonable SCN-Current SCN） /（每秒允许的最大增长率） /3600/24；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;">SCN异常增长通常是有DBLINK、人为前推SCN、oracle bug，SCN的历史变化可以从V$ARCHIVED_LOG得到， 最近5天的SCN也可以尝试从smon_scn_time得到。 数据库自身的增长可以从从dba_hist_sysstat得到’calls to kcmgas’的变化，SCN通过DBLINK 的传播可以通过上面提到的参数控制，和12c 中提供的新视图；</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:15px;"> 数据库11.2.0.2及以后的版本默认是允许32K的增长速率，所以就会像本案例以上产生较大的SCN, 这就意味着11.2.0.2可能不能再与低版本的数据库或是使用16K增长速率的数据库通过DBLINK。</span></p></li>
   </ul>
   <p style="line-height:normal;"><span style="color:rgb(136,136,136);"><br></span></p>
   <p style="letter-spacing:3px;"><strong><span style="font-size:17px;">作者文章</span></strong><span style="font-size:17px;"><br></span></p>
   <p><span style="color:rgb(136,136,136);"></span><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650280552&amp;idx=2&amp;sn=d6dfd720a544e32182f8e90f5fa6a836&amp;chksm=be478a7e893003683caddefc72d2b43d49dc3cb57aa5cc64d82f2a1343072570111e1a6176d7&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;"><span style="font-size:15px;">新补丁更新（RU和RUR），新的版本（Release 18和19）</span></a></p>
   <p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650280571&amp;idx=2&amp;sn=c2767111aee6f0d161d896dab335a4d5&amp;chksm=be478a6d8930037b75dbd285a80ee84a9c9adbb971fc44f0ef0654f8c6ed4a2d88a71e2ec361&amp;scene=21#wechat_redirect" rel="nofollow" style="font-size:15px;text-decoration:underline;"><span style="font-size:15px;">Oracle 12c 关于密码（password）的几个新特性小结</span></a></p>
   <p><a href="http://mp.weixin.qq.com/s?__biz=MjM5MDAxOTk2MQ==&amp;mid=2650280985&amp;idx=1&amp;sn=b313f3dee8994961939310a10b9a2a28&amp;chksm=be478c0f893005193ebba30aeaea5d7584cfeac239884de4a8f5beb64098299d236c62577b11&amp;scene=21#wechat_redirect" rel="nofollow" style="font-size:15px;text-decoration:underline;"><span style="font-size:15px;">故障诊断：12cR2 &nbsp;Flex ASM 环境中节点启动失败的诊断和分析</span></a><br></p>
   <p><br></p>
   <p><span style="font-size:15px;">资源下载</span></p>
   <p style="margin-left:8px;font-size:1em;line-height:1.75em;"><span style="font-size:15px;letter-spacing:.5px;">关注公众号：数据和云（</span><span style="font-size:15px;letter-spacing:.5px;color:rgb(255,0,0);">OraNews</span><span style="font-size:15px;letter-spacing:.5px;">）回复关键字获取</span></p>
   <p style="margin-left:8px;font-size:1em;line-height:normal;"><span style="font-size:12px;color:rgb(255,0,0);"><strong><span style="letter-spacing:.5px;"><strong style="color:rgb(62,62,62);"><span>2018DTCC&nbsp;</span></strong><span style="color:rgb(62,62,62);">,&nbsp;数据库大会PPT</span></span></strong></span></p>
   <p style="margin-left:8px;font-size:1em;line-height:normal;"><span style="font-size:12px;color:rgb(0,0,0);"><strong><span style="letter-spacing:.5px;">2018DTC</span></strong></span><span style="font-size:12px;letter-spacing:.5px;">，2018 DTC 大会 PPT<br></span></p>
   <p style="margin-left:8px;font-size:1em;line-height:normal;"><span style="font-size:12px;color:rgb(255,76,65);"><strong><span style="letter-spacing:.5px;">ENMOBK</span></strong></span><span style="color:rgb(0,0,0);font-size:12px;letter-spacing:.5px;">，</span><span style="letter-spacing:.5px;font-size:12px;">《Oracle性能优化与诊断案例》</span></p>
   <p style="margin-left:8px;font-size:1em;line-height:normal;"><span style="font-size:12px;"><strong><span style="letter-spacing:.5px;">DBALIFE&nbsp;</span></strong><span style="letter-spacing:.5px;">，“DBA 的一天”海报</span></span><br></p>
   <p style="margin-left:8px;line-height:normal;"><span style="font-size:12px;"><strong><span style="letter-spacing:.5px;">DBA04&nbsp;</span></strong><span style="letter-spacing:.5px;">，DBA 手记4 电子书</span></span></p>
   <p style="margin-left:8px;font-size:1em;line-height:normal;"><span style="font-size:14px;"><strong><span style="font-size:12px;letter-spacing:.5px;">122ARCH&nbsp;</span></strong><span style="font-size:12px;letter-spacing:.5px;">，Oracle 12.2体系结构图</span><br></span></p>
   <p style="margin-left:8px;font-size:1em;line-height:normal;"><span style="font-size:12px;"><strong><span style="letter-spacing:.5px;">2018OOW&nbsp;</span></strong><span style="letter-spacing:.5px;">，Oracle OpenWorld 资料</span></span></p>
   <span style="font-size:14.08px;color:rgb(255,255,255);"><span style="text-decoration:underline;font-size:14px;">产品推荐</span></span>
   <p style="line-height:25.6px;"><span style="font-size:14px;">云和恩墨Bethune Pro企业版，集监控、巡检、安全于一身，你的专属数据库实时监控和智能巡检平台，漂亮的不像实力派，你值得拥有！</span></p>
   <p style="line-height:25.6px;"><br></p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/bURPjgFpGMQeBr2mMtwEBXuibZnibpsIlCa3JpiaCpPvOCOZh45T4hptKSDcIFQKS39lpREoUuBrVZDO9nINpftvg/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p style="line-height:25.6px;"><br></p>
   <p style="line-height:25.6px;"><span style="font-size:14px;">云和恩墨zData一体机现已发布超融合版本和精简版，支持各种简化场景部署，零数据丢失备份一体机ZDBM也已发布，欢迎关注。</span></p>
   <p style="line-height:25.6px;"><br></p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/bURPjgFpGMSicPibiaGY7OYr1EZA17NLMdsLIokheXK6Wo7xyyW0Q7BQY9SjnOuzuFxETiaLTqKCjhIl4ZfBvqEK6A/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/bURPjgFpGMR9eQdKVbZ63OX9tOiccdmE2A0yzWOd7gB0JBC7JWaKX0TrutNQH5icqIdkgEPUUk8OSy782LD1dvjQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"><br></p>
  </div> 
 </div> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
