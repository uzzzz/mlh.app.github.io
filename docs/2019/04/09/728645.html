<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>【Openstack】实录手动部署Openstack Rocky 双节点（4）- Nova | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="【Openstack】实录手动部署Openstack Rocky 双节点（4）- Nova" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="第一篇：实录手动部署Openstack Rocky 双节点（1）- 基础服务 上一篇：实录手动部署Openstack Rocky 双节点（3）- Glance 下一篇：实录手动部署Openstack Rocky 双节点（5）- Neutron 文章目录 参考文档 Nova (controller) 关闭防火墙 设置admin的鉴权信息 添加Nova账户及其鉴权信息 创建compute类型的服务 创建nova账户并设置密码 给nova账户赋予service项目的admin角色 创建endpoint 创建placement类型服务 创建placement账户 创建endpoint 检查当前controller机器上的catalog 安装软件包 Nova配置文件 创建Nova相关的数据库及权限设定 初始化Nova API与Placement数据库 初始化Nova数据库 注册cell0数据库 创建cell1 验证cell0与cell1 注册Placement Web Server到httpd 启动nova服务 验证Nova服务 部署nova-compute包 修改配置文件 启动服务 将Controller Node注册到Cell 验证controller机器上的compute服务 验证cells和placement API正常工作 Nova (Compute) 关闭防火墙 安装软件包 结语 参考文档 手动部署OpenStack Rocky双节点 Nova (controller) 关闭防火墙 [tony@controller ~]$ sudo systemctl stop firewalld [tony@controller ~]$ sudo systemctl disable firewalld Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service. Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 设置admin的鉴权信息 [tony@controller ~]$ cat adminrc export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=$password export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 [tony@controller ~]$ source adminrc 添加Nova账户及其鉴权信息 创建compute类型的服务 [tony@controller ~]$ openstack service create --name nova --description &quot;OpenStack Compute&quot; compute +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Compute | | enabled | True | | id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | name | nova | | type | compute | +-------------+----------------------------------+ 创建nova账户并设置密码 [tony@controller ~]$ openstack user create --domain default --password-prompt nova User Password: &lt;Enter password&gt; Repeat User Password: &lt;Repeat password&gt; ±--------------------±---------------------------------+ | Field | Value | ±--------------------±---------------------------------+ | domain_id | default | | enabled | True | | id | 4ecb248c39df4f368a2a4c07805ab784 | | name | nova | | options | {} | | password_expires_at | None | ±--------------------±---------------------------------+ 给nova账户赋予service项目的admin角色 [tony@controller ~]$ openstack role add --project service --user nova admin 创建endpoint [tony@controller ~]$ openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 2e937f5e7a2942418fc759ddcf7bb042 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 69d1fd19e43e47cc978d758ef7aaf7a2 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 631f58379ade4eb4ae42c743ee2b57e8 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ 创建placement类型服务 [tony@controller ~]$ openstack service create --name placement --description &quot;Placement API&quot; placement +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Placement API | | enabled | True | | id | 1b43d96cb1e7407f994189fbe77f6724 | | name | placement | | type | placement | +-------------+----------------------------------+ 创建placement账户 [tony@controller ~]$ openstack user create --domain default --password-prompt placement User Password: &lt;Enter password&gt; Repeat User Password: &lt;Repeat password&gt; +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 828b032a6cfb467ab98a5986b1168ab3 | | name | placement | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ [tony@controller ~]$ openstack role add --project service --user placement admin 创建endpoint [tony@controller ~]$ openstack endpoint create --region RegionOne placement public http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 36ef3c5e2b6f45a79651717e07e308ce | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne placement internal http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | ffa9735e7353483dba0360e23d3078e4 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne placement admin http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 13b5952a556e485aa1ebc93badf77485 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ 检查当前controller机器上的catalog [tony@controller ~]$ [tony@controller ~]$ openstack catalog list +-----------+-----------+-----------------------------------------+ | Name | Type | Endpoints | +-----------+-----------+-----------------------------------------+ | placement | placement | RegionOne | | | | admin: http://controller:8778 | | | | RegionOne | | | | public: http://controller:8778 | | | | RegionOne | | | | internal: http://controller:8778 | | | | | | keystone | identity | RegionOne | | | | admin: http://controller:5000/v3/ | | | | RegionOne | | | | internal: http://controller:5000/v3/ | | | | RegionOne | | | | public: http://controller:5000/v3/ | | | | | | nova | compute | RegionOne | | | | public: http://controller:8774/v2.1 | | | | RegionOne | | | | admin: http://controller:8774/v2.1 | | | | RegionOne | | | | internal: http://controller:8774/v2.1 | | | | | | glance | image | RegionOne | | | | public: http://controller:9292 | | | | RegionOne | | | | internal: http://controller:9292 | | | | RegionOne | | | | admin: http://controller:9292 | | | | | +-----------+-----------+-----------------------------------------+ 安装软件包 [tony@controller ~]$ sudo yum install -y openstack-nova-api openstack-nova-conductor openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler openstack-nova-placement-api Nova配置文件 原始默认配置文件 # 事实上，原始配置文件所有的配置选项都是注释掉的。 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] ... [zvm] 修改后的配置文件 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] my_ip = 172.18.22.231 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] [cache] [cells] [cinder] [compute] [conductor] [console] [consoleauth] [cors] [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] [ephemeral_storage_encryption] [filter_scheduler] [glance] api_servers = http://controller:9292 [guestfs] [healthcheck] [hyperv] [ironic] [key_manager] [keystone] [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] [matchmaker_redis] [metrics] [mks] [neutron] [notifications] [osapi_v21] [oslo_concurrency] lock_path = /var/lib/nova/tmp [oslo_messaging_amqp] [oslo_messaging_kafka] [oslo_messaging_notifications] [oslo_messaging_rabbit] [oslo_messaging_zmq] [oslo_middleware] [oslo_policy] [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] [powervm] [profiler] [quota] [rdp] [remote_debug] [scheduler] [serial_console] [service_user] [spice] [upgrade_levels] [vault] [vendordata_dynamic_auth] [vmware] [vnc] enabled = true server_listen = $my_ip server_proxyclient_address = $my_ip [workarounds] [wsgi] [xenserver] [xvp] [zvm] 创建Nova相关的数据库及权限设定 [tony@controller ~]$ mysql -u root -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 55 Server version: 10.1.20-MariaDB MariaDB Server &nbsp; Copyright © 2000, 2016, Oracle, MariaDB Corporation Ab and others. &nbsp; Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement. &nbsp; MariaDB [(none)]&gt; create database nova_api; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database nova; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database nova_cell0; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database placement; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_api.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_api.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_cell0.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_cell0.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on placement.* to ‘placement’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on placement.* to ‘placement’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; quit Bye 初始化Nova API与Placement数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova 初始化Nova数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova WARNING: cell0 mapping not found - not syncing cell0. /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index block_device_mapping_instance_uuid_virtual_name_device_name_idx. This is deprecated and will be disallowed in a future release.’) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index uniq_instances0uuid. This is deprecated and will be disallowed in a future release.’) result = self._query(query) 注：第一次执行本步骤，可以忽略下面的注释 后续步骤中 $sudo nova-status upgrade check 命令报错，又重新初始化了一次数据库，就没有第一个红色的Warning了。nova-status命令也正常执行了。具体原因待查。 # 命令出错 [tony@tony-controller ~]$ sudo nova-status upgrade check Error: Traceback (most recent call last): File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 795, in main ret = fn(*fn_args, **fn_kwargs) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 725, in check result = func(self) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 206, in _check_placement versions = self._placement_get(&quot;/&quot;) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 196, in _placement_get return client.get(path, raise_exc=True).json() File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py&quot;, line 328, in get return self.request(url, &#39;GET&#39;, **kwargs) File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py&quot;, line 213, in request return self.session.request(url, method, **kwargs) File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/session.py&quot;, line 869, in request raise exceptions.from_response(resp, method, url) InternalServerError: Internal Server Error (HTTP 500) # 重新初始化数据库 [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova # 程序正常执行 [tony@tony-controller ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ 注册cell0数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova 注：在注册cell0数据库之后，重新初始化一下Nova数据库，也就没有第一个Warning了。 [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u&#39;Duplicate index `block_device_mapping_instance_uuid_virtual_name_device_name_idx`. This is deprecated and will be disallowed in a future release.&#39;) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u&#39;Duplicate index `uniq_instances0uuid`. This is deprecated and will be disallowed in a future release.&#39;) result = self._query(query) 创建cell1 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova c1a3197c-cbd1-4554-881b-f405ea4b1c74 验证cell0与cell1 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ | Name | UUID | Transport URL | Database Connection | Disabled | ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ | cell0 | 00000000-0000-0000-0000-000000000000 | none:/ | mysql+pymysql://nova:@controller/nova_cell0 | False | | cell1 | c1a3197c-cbd1-4554-881b-f405ea4b1c74 | rabbit://openstack:@controller | mysql+pymysql://nova:****@controller/nova | False | ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ 注册Placement Web Server到httpd 修改配置文件 [tony@controller ~]$ sudo cat /etc/httpd/conf.d/00-nova-placement-api.conf Listen 8778 &nbsp; &lt;VirtualHost *:8778&gt; WSGIProcessGroup nova-placement-api WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On WSGIDaemonProcess nova-placement-api processes=3 threads=1 user=nova group=nova WSGIScriptAlias / /usr/bin/nova-placement-api &lt;IfVersion &gt;= 2.4&gt; ErrorLogFormat “%M” &lt;/IfVersion&gt; ErrorLog /var/log/nova/nova-placement-api.log #SSLEngine On #SSLCertificateFile … #SSLCertificateKeyFile … &nbsp; &lt;Directory /usr/bin&gt; &lt;IfVersion &gt;= 2.4&gt; Require all granted &lt;/IfVersion&gt; &lt;IfVersion &lt; 2.4&gt; Order allow, deny Allow from all &lt;/IfVersion&gt; &lt;/Directory&gt; &lt;/VirtualHost&gt; &nbsp; Alias /nova-placement-api /usr/bin/nova-placement-api &lt;Location /nova-placement-api&gt; SetHandler wsgi-script Options +ExecCGI WSGIProcessGroup nova-placement-api WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On &lt;/Location&gt; 重启httpd服务 [tony@controller ~]$ sudo systemctl restart httpd [tony@controller ~]$ sudo systemctl status httpd ● httpd.service - The Apache HTTP Server Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:01:19 EDT; 8s ago Docs: man:httpd(8) man:apachectl(8) Process: 95486 ExecStop=/bin/kill -WINCH ${MAINPID} (code=exited, status=0/SUCCESS) Main PID: 95497 (httpd) Status: &quot;Processing requests...&quot; CGroup: /system.slice/httpd.service ├─95497 /usr/sbin/httpd -DFOREGROUND ├─95498 /usr/sbin/httpd -DFOREGROUND ├─95499 /usr/sbin/httpd -DFOREGROUND ├─95500 /usr/sbin/httpd -DFOREGROUND ├─95501 (wsgi:keystone- -DFOREGROUND ├─95502 (wsgi:keystone- -DFOREGROUND ├─95503 (wsgi:keystone- -DFOREGROUND ├─95504 (wsgi:keystone- -DFOREGROUND ├─95505 (wsgi:keystone- -DFOREGROUND ├─95506 /usr/sbin/httpd -DFOREGROUND ├─95507 /usr/sbin/httpd -DFOREGROUND ├─95508 /usr/sbin/httpd -DFOREGROUND ├─95509 /usr/sbin/httpd -DFOREGROUND └─95510 /usr/sbin/httpd -DFOREGROUND Apr 08 03:01:19 controller systemd[1]: Starting The Apache HTTP Server... Apr 08 03:01:19 controller systemd[1]: Started The Apache HTTP Server. 启动nova服务 # 启用服务 [tony@controller ~]$ sudo systemctl enable openstack-nova-api.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-api.service to /usr/lib/systemd/system/openstack-nova-api.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-consoleauth Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-consoleauth.service to /usr/lib/systemd/system/openstack-nova-consoleauth.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-scheduler.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-scheduler.service to /usr/lib/systemd/system/openstack-nova-scheduler.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-conductor.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-conductor.service to /usr/lib/systemd/system/openstack-nova-conductor.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-novncproxy.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-novncproxy.service to /usr/lib/systemd/system/openstack-nova-novncproxy.service. # 启动服务 [tony@controller ~]$ sudo systemctl start openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service # 检查服务状态 [tony@controller ~]$ sudo systemctl status openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service ● openstack-nova-api.service - OpenStack Nova API Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-api.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:24 EDT; 7s ago Main PID: 96191 (nova-api) CGroup: /system.slice/openstack-nova-api.service ├─96191 /usr/bin/python2 /usr/bin/nova-api ├─96271 /usr/bin/python2 /usr/bin/nova-api ├─96272 /usr/bin/python2 /usr/bin/nova-api ├─96273 /usr/bin/python2 /usr/bin/nova-api ├─96274 /usr/bin/python2 /usr/bin/nova-api ├─96279 /usr/bin/python2 /usr/bin/nova-api ├─96281 /usr/bin/python2 /usr/bin/nova-api ├─96282 /usr/bin/python2 /usr/bin/nova-api └─96283 /usr/bin/python2 /usr/bin/nova-api Apr 08 03:07:15 controller systemd[1]: Starting OpenStack Nova API Server... Apr 08 03:07:24 controller systemd[1]: Started OpenStack Nova API Server. ● openstack-nova-consoleauth.service - OpenStack Nova VNC console auth Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-consoleauth.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:19 EDT; 11s ago Main PID: 96192 (nova-consoleaut) CGroup: /system.slice/openstack-nova-consoleauth.service └─96192 /usr/bin/python2 /usr/bin/nova-consoleauth Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova VNC console auth Server... Apr 08 03:07:19 controller systemd[1]: Started OpenStack Nova VNC console auth Server. ● openstack-nova-scheduler.service - OpenStack Nova Scheduler Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-scheduler.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:21 EDT; 9s ago Main PID: 96193 (nova-scheduler) CGroup: /system.slice/openstack-nova-scheduler.service ├─96193 /usr/bin/python2 /usr/bin/nova-scheduler ├─96258 /usr/bin/python2 /usr/bin/nova-scheduler ├─96259 /usr/bin/python2 /usr/bin/nova-scheduler ├─96260 /usr/bin/python2 /usr/bin/nova-scheduler └─96262 /usr/bin/python2 /usr/bin/nova-scheduler Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Scheduler Server... Apr 08 03:07:21 controller systemd[1]: Started OpenStack Nova Scheduler Server. ● openstack-nova-conductor.service - OpenStack Nova Conductor Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-conductor.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:20 EDT; 10s ago Main PID: 96194 (nova-conductor) CGroup: /system.slice/openstack-nova-conductor.service ├─96194 /usr/bin/python2 /usr/bin/nova-conductor ├─96248 /usr/bin/python2 /usr/bin/nova-conductor ├─96250 /usr/bin/python2 /usr/bin/nova-conductor ├─96251 /usr/bin/python2 /usr/bin/nova-conductor └─96252 /usr/bin/python2 /usr/bin/nova-conductor Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Conductor Server... Apr 08 03:07:20 controller systemd[1]: Started OpenStack Nova Conductor Server. ● openstack-nova-novncproxy.service - OpenStack Nova NoVNC Proxy Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-novncproxy.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:16 EDT; 15s ago Main PID: 96195 (nova-novncproxy) CGroup: /system.slice/openstack-nova-novncproxy.service └─96195 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/ Apr 08 03:07:16 controller systemd[1]: Started OpenStack Nova NoVNC Proxy Server. 验证Nova服务 [tony@controller ~]$ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:10:35.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:10:26.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:10:27.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ 部署nova-compute包 [tony@controller ~]$ sudo yum -y install openstack-nova-compute 修改配置文件 [tony@controller ~]$ diff /tmp/nova.origin.conf /tmp/nova.new.conf 6a7,8 &gt; compute_driver = libvirt.LibvirtDriver &gt; instances_path = /var/lib/nova/instances 24a27,31 &gt; [vnc] &gt; enabled = true &gt; server_listen = 0.0.0.0 &gt; server_proxyclient_address = $my_ip &gt; novncproxy_base_url = http://controller:6080/vnc_auto.html 42a50 &gt; virt_type = qemu 68a77 &gt; connection = mysql+pymysql://placement:$password@controller/placement 新的配置文件 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] my_ip = 172.18.22.231 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver compute_driver = libvirt.LibvirtDriver instances_path = /var/lib/nova/instances [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] … [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] … [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html [glance] api_servers = http://controller:9292 [guestfs] … [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] virt_type = qemu [matchmaker_redis] … [oslo_concurrency] lock_path = /var/lib/nova/tmp [oslo_messaging_amqp] … [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] connection = mysql+pymysql://placement:$password@controller/placement [powervm] … [workarounds] 启动服务 [tony@controller ~]$ sudo systemctl enable libvirtd.service openstack-nova-compute.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service. [tony@controller ~]$ sudo systemctl start libvirtd.service openstack-nova-compute.service [tony@controller ~]$ sudo systemctl status libvirtd.service openstack-nova-compute.service ● libvirtd.service - Virtualization daemon Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled) Active: active (running) since Mon 2019-04-08 03:41:40 EDT; 9s ago Docs: man:libvirtd(8) https://libvirt.org Main PID: 102617 (libvirtd) Tasks: 17 (limit: 32768) CGroup: /system.slice/libvirtd.service └─102617 /usr/sbin/libvirtd Apr 08 03:41:40 controller systemd[1]: Starting Virtualization daemon... Apr 08 03:41:40 controller systemd[1]: Started Virtualization daemon. ● openstack-nova-compute.service - OpenStack Nova Compute Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:41:43 EDT; 6s ago Main PID: 102635 (nova-compute) Tasks: 22 CGroup: /system.slice/openstack-nova-compute.service └─102635 /usr/bin/python2 /usr/bin/nova-compute Apr 08 03:41:40 controller systemd[1]: Starting OpenStack Nova Compute Server... Apr 08 03:41:43 controller systemd[1]: Started OpenStack Nova Compute Server. 将Controller Node注册到Cell [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell &#39;cell1&#39;: c1a3197c-cbd1-4554-881b-f405ea4b1c74 Checking host mapping for compute host &#39;controller&#39;: 090c321b-7c7d-496f-bbcb-1f5360034cc8 Creating host mapping for compute host &#39;controller&#39;: 090c321b-7c7d-496f-bbcb-1f5360034cc8 Found 1 unmapped computes in cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74 验证controller机器上的compute服务 [tony@controller ~]$ openstack compute service list ±—±-----------------±-----------±---------±--------±------±---------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | ±—±-----------------±-----------±---------±--------±------±---------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:46:37.000000 | | 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T07:46:42.000000 | ±—±-----------------±-----------±---------±--------±------±---------------------------+ 验证cells和placement API正常工作 [tony@controller ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ Nova (Compute) 关闭防火墙 [tony@compute ~]$ sudo systemctl stop firewalld [tony@compute ~]$ sudo systemctl disable firewalld Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service. Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 安装软件包 # 安装软件包 [tony@compute ~]$ sudo yum install -y openstack-nova-compute # 设置配置文件 [tony@compute ~]$ sudo cp /etc/nova/nova.conf /etc/nova/nova.conf.origin [tony@compute ~]$ sudo vim /etc/nova/nova.conf [DEFAULT] my_ip = 172.18.22.232 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver compute_driver = libvirt.LibvirtDriver instances_path = /var/lib/nova/instances [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] [cache] [cells] [cinder] [compute] [conductor] [console] [consoleauth] [cors] [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] [ephemeral_storage_encryption] [filter_scheduler] [glance] api_servers = http://controller:9292 [guestfs] [healthcheck] [hyperv] [ironic] [key_manager] [keystone] [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] virt_type = qemu [matchmaker_redis] [metrics] [mks] [neutron] [notifications] [osapi_v21] [oslo_concurrency] [oslo_messaging_amqp] [oslo_messaging_kafka] [oslo_messaging_notifications] [oslo_messaging_rabbit] [oslo_messaging_zmq] [oslo_middleware] [oslo_policy] [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] connection = mysql+pymysql://placement:$password@controller/placement [powervm] [profiler] [quota] [rdp] [remote_debug] [scheduler] [serial_console] [service_user] [spice] [upgrade_levels] [vault] [vendordata_dynamic_auth] [vmware] [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html [workarounds] [wsgi] [xenserver] [xvp] [zvm] # 启用并启动服务 [tony@compute ~]$ sudo systemctl enable libvirtd.service openstack-nova-compute.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service. [tony@compute ~]$ sudo systemctl start libvirtd.service openstack-nova-compute.service [tony@compute ~]$ sudo systemctl status libvirtd.service openstack-nova-compute.service ● libvirtd.service - Virtualization daemon Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled) Active: active (running) since Mon 2019-04-08 04:31:49 EDT; 9s ago Docs: man:libvirtd(8) https://libvirt.org Main PID: 33687 (libvirtd) Tasks: 17 (limit: 32768) CGroup: /system.slice/libvirtd.service └─33687 /usr/sbin/libvirtd Apr 08 04:31:49 compute systemd[1]: Starting Virtualization daemon... Apr 08 04:31:49 compute systemd[1]: Started Virtualization daemon. ● openstack-nova-compute.service - OpenStack Nova Compute Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 04:31:52 EDT; 6s ago Main PID: 33705 (nova-compute) Tasks: 22 CGroup: /system.slice/openstack-nova-compute.service └─33705 /usr/bin/python2 /usr/bin/nova-compute Apr 08 04:31:49 compute systemd[1]: Starting OpenStack Nova Compute Server... Apr 08 04:31:52 compute systemd[1]: Started OpenStack Nova Compute Server. # 注册 [tony@compute ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell &#39;cell1&#39;: c1a3197c-cbd1-4554-881b-f405ea4b1c74 Checking host mapping for compute host &#39;compute&#39;: 005dfe34-54f3-4982-b2f8-43b81ae673fd Creating host mapping for compute host &#39;compute&#39;: 005dfe34-54f3-4982-b2f8-43b81ae673fd Found 1 unmapped computes in cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74 # 忘记设置admin鉴权信息了 [tony@compute ~]$ openstack compute service list Missing value auth-url required for auth plugin password [tony@compute ~]$ vim adminrc export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=$password export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 [tony@compute ~]$ source adminrc [tony@compute ~]$ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T08:33:17.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T08:33:21.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T08:33:12.000000 | | 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T08:33:21.000000 | | 8 | nova-compute | compute | nova | enabled | up | 2019-04-08T08:33:18.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ [tony@compute ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ 结语 自此，controller与compute1机器上的nova模块安装成功。 第一篇：实录手动部署Openstack Rocky 双节点（1）- 基础服务 上一篇：实录手动部署Openstack Rocky 双节点（3）- Glance 下一篇：实录手动部署Openstack Rocky 双节点（5）- Neutron" />
<meta property="og:description" content="第一篇：实录手动部署Openstack Rocky 双节点（1）- 基础服务 上一篇：实录手动部署Openstack Rocky 双节点（3）- Glance 下一篇：实录手动部署Openstack Rocky 双节点（5）- Neutron 文章目录 参考文档 Nova (controller) 关闭防火墙 设置admin的鉴权信息 添加Nova账户及其鉴权信息 创建compute类型的服务 创建nova账户并设置密码 给nova账户赋予service项目的admin角色 创建endpoint 创建placement类型服务 创建placement账户 创建endpoint 检查当前controller机器上的catalog 安装软件包 Nova配置文件 创建Nova相关的数据库及权限设定 初始化Nova API与Placement数据库 初始化Nova数据库 注册cell0数据库 创建cell1 验证cell0与cell1 注册Placement Web Server到httpd 启动nova服务 验证Nova服务 部署nova-compute包 修改配置文件 启动服务 将Controller Node注册到Cell 验证controller机器上的compute服务 验证cells和placement API正常工作 Nova (Compute) 关闭防火墙 安装软件包 结语 参考文档 手动部署OpenStack Rocky双节点 Nova (controller) 关闭防火墙 [tony@controller ~]$ sudo systemctl stop firewalld [tony@controller ~]$ sudo systemctl disable firewalld Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service. Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 设置admin的鉴权信息 [tony@controller ~]$ cat adminrc export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=$password export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 [tony@controller ~]$ source adminrc 添加Nova账户及其鉴权信息 创建compute类型的服务 [tony@controller ~]$ openstack service create --name nova --description &quot;OpenStack Compute&quot; compute +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Compute | | enabled | True | | id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | name | nova | | type | compute | +-------------+----------------------------------+ 创建nova账户并设置密码 [tony@controller ~]$ openstack user create --domain default --password-prompt nova User Password: &lt;Enter password&gt; Repeat User Password: &lt;Repeat password&gt; ±--------------------±---------------------------------+ | Field | Value | ±--------------------±---------------------------------+ | domain_id | default | | enabled | True | | id | 4ecb248c39df4f368a2a4c07805ab784 | | name | nova | | options | {} | | password_expires_at | None | ±--------------------±---------------------------------+ 给nova账户赋予service项目的admin角色 [tony@controller ~]$ openstack role add --project service --user nova admin 创建endpoint [tony@controller ~]$ openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 2e937f5e7a2942418fc759ddcf7bb042 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 69d1fd19e43e47cc978d758ef7aaf7a2 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 631f58379ade4eb4ae42c743ee2b57e8 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ 创建placement类型服务 [tony@controller ~]$ openstack service create --name placement --description &quot;Placement API&quot; placement +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Placement API | | enabled | True | | id | 1b43d96cb1e7407f994189fbe77f6724 | | name | placement | | type | placement | +-------------+----------------------------------+ 创建placement账户 [tony@controller ~]$ openstack user create --domain default --password-prompt placement User Password: &lt;Enter password&gt; Repeat User Password: &lt;Repeat password&gt; +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 828b032a6cfb467ab98a5986b1168ab3 | | name | placement | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ [tony@controller ~]$ openstack role add --project service --user placement admin 创建endpoint [tony@controller ~]$ openstack endpoint create --region RegionOne placement public http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 36ef3c5e2b6f45a79651717e07e308ce | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne placement internal http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | ffa9735e7353483dba0360e23d3078e4 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne placement admin http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 13b5952a556e485aa1ebc93badf77485 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ 检查当前controller机器上的catalog [tony@controller ~]$ [tony@controller ~]$ openstack catalog list +-----------+-----------+-----------------------------------------+ | Name | Type | Endpoints | +-----------+-----------+-----------------------------------------+ | placement | placement | RegionOne | | | | admin: http://controller:8778 | | | | RegionOne | | | | public: http://controller:8778 | | | | RegionOne | | | | internal: http://controller:8778 | | | | | | keystone | identity | RegionOne | | | | admin: http://controller:5000/v3/ | | | | RegionOne | | | | internal: http://controller:5000/v3/ | | | | RegionOne | | | | public: http://controller:5000/v3/ | | | | | | nova | compute | RegionOne | | | | public: http://controller:8774/v2.1 | | | | RegionOne | | | | admin: http://controller:8774/v2.1 | | | | RegionOne | | | | internal: http://controller:8774/v2.1 | | | | | | glance | image | RegionOne | | | | public: http://controller:9292 | | | | RegionOne | | | | internal: http://controller:9292 | | | | RegionOne | | | | admin: http://controller:9292 | | | | | +-----------+-----------+-----------------------------------------+ 安装软件包 [tony@controller ~]$ sudo yum install -y openstack-nova-api openstack-nova-conductor openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler openstack-nova-placement-api Nova配置文件 原始默认配置文件 # 事实上，原始配置文件所有的配置选项都是注释掉的。 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] ... [zvm] 修改后的配置文件 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] my_ip = 172.18.22.231 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] [cache] [cells] [cinder] [compute] [conductor] [console] [consoleauth] [cors] [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] [ephemeral_storage_encryption] [filter_scheduler] [glance] api_servers = http://controller:9292 [guestfs] [healthcheck] [hyperv] [ironic] [key_manager] [keystone] [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] [matchmaker_redis] [metrics] [mks] [neutron] [notifications] [osapi_v21] [oslo_concurrency] lock_path = /var/lib/nova/tmp [oslo_messaging_amqp] [oslo_messaging_kafka] [oslo_messaging_notifications] [oslo_messaging_rabbit] [oslo_messaging_zmq] [oslo_middleware] [oslo_policy] [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] [powervm] [profiler] [quota] [rdp] [remote_debug] [scheduler] [serial_console] [service_user] [spice] [upgrade_levels] [vault] [vendordata_dynamic_auth] [vmware] [vnc] enabled = true server_listen = $my_ip server_proxyclient_address = $my_ip [workarounds] [wsgi] [xenserver] [xvp] [zvm] 创建Nova相关的数据库及权限设定 [tony@controller ~]$ mysql -u root -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \g. Your MariaDB connection id is 55 Server version: 10.1.20-MariaDB MariaDB Server &nbsp; Copyright © 2000, 2016, Oracle, MariaDB Corporation Ab and others. &nbsp; Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement. &nbsp; MariaDB [(none)]&gt; create database nova_api; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database nova; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database nova_cell0; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database placement; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_api.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_api.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_cell0.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_cell0.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on placement.* to ‘placement’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on placement.* to ‘placement’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; quit Bye 初始化Nova API与Placement数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova 初始化Nova数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova WARNING: cell0 mapping not found - not syncing cell0. /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index block_device_mapping_instance_uuid_virtual_name_device_name_idx. This is deprecated and will be disallowed in a future release.’) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index uniq_instances0uuid. This is deprecated and will be disallowed in a future release.’) result = self._query(query) 注：第一次执行本步骤，可以忽略下面的注释 后续步骤中 $sudo nova-status upgrade check 命令报错，又重新初始化了一次数据库，就没有第一个红色的Warning了。nova-status命令也正常执行了。具体原因待查。 # 命令出错 [tony@tony-controller ~]$ sudo nova-status upgrade check Error: Traceback (most recent call last): File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 795, in main ret = fn(*fn_args, **fn_kwargs) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 725, in check result = func(self) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 206, in _check_placement versions = self._placement_get(&quot;/&quot;) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 196, in _placement_get return client.get(path, raise_exc=True).json() File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py&quot;, line 328, in get return self.request(url, &#39;GET&#39;, **kwargs) File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py&quot;, line 213, in request return self.session.request(url, method, **kwargs) File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/session.py&quot;, line 869, in request raise exceptions.from_response(resp, method, url) InternalServerError: Internal Server Error (HTTP 500) # 重新初始化数据库 [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova # 程序正常执行 [tony@tony-controller ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ 注册cell0数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova 注：在注册cell0数据库之后，重新初始化一下Nova数据库，也就没有第一个Warning了。 [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u&#39;Duplicate index `block_device_mapping_instance_uuid_virtual_name_device_name_idx`. This is deprecated and will be disallowed in a future release.&#39;) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u&#39;Duplicate index `uniq_instances0uuid`. This is deprecated and will be disallowed in a future release.&#39;) result = self._query(query) 创建cell1 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova c1a3197c-cbd1-4554-881b-f405ea4b1c74 验证cell0与cell1 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ | Name | UUID | Transport URL | Database Connection | Disabled | ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ | cell0 | 00000000-0000-0000-0000-000000000000 | none:/ | mysql+pymysql://nova:@controller/nova_cell0 | False | | cell1 | c1a3197c-cbd1-4554-881b-f405ea4b1c74 | rabbit://openstack:@controller | mysql+pymysql://nova:****@controller/nova | False | ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ 注册Placement Web Server到httpd 修改配置文件 [tony@controller ~]$ sudo cat /etc/httpd/conf.d/00-nova-placement-api.conf Listen 8778 &nbsp; &lt;VirtualHost *:8778&gt; WSGIProcessGroup nova-placement-api WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On WSGIDaemonProcess nova-placement-api processes=3 threads=1 user=nova group=nova WSGIScriptAlias / /usr/bin/nova-placement-api &lt;IfVersion &gt;= 2.4&gt; ErrorLogFormat “%M” &lt;/IfVersion&gt; ErrorLog /var/log/nova/nova-placement-api.log #SSLEngine On #SSLCertificateFile … #SSLCertificateKeyFile … &nbsp; &lt;Directory /usr/bin&gt; &lt;IfVersion &gt;= 2.4&gt; Require all granted &lt;/IfVersion&gt; &lt;IfVersion &lt; 2.4&gt; Order allow, deny Allow from all &lt;/IfVersion&gt; &lt;/Directory&gt; &lt;/VirtualHost&gt; &nbsp; Alias /nova-placement-api /usr/bin/nova-placement-api &lt;Location /nova-placement-api&gt; SetHandler wsgi-script Options +ExecCGI WSGIProcessGroup nova-placement-api WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On &lt;/Location&gt; 重启httpd服务 [tony@controller ~]$ sudo systemctl restart httpd [tony@controller ~]$ sudo systemctl status httpd ● httpd.service - The Apache HTTP Server Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:01:19 EDT; 8s ago Docs: man:httpd(8) man:apachectl(8) Process: 95486 ExecStop=/bin/kill -WINCH ${MAINPID} (code=exited, status=0/SUCCESS) Main PID: 95497 (httpd) Status: &quot;Processing requests...&quot; CGroup: /system.slice/httpd.service ├─95497 /usr/sbin/httpd -DFOREGROUND ├─95498 /usr/sbin/httpd -DFOREGROUND ├─95499 /usr/sbin/httpd -DFOREGROUND ├─95500 /usr/sbin/httpd -DFOREGROUND ├─95501 (wsgi:keystone- -DFOREGROUND ├─95502 (wsgi:keystone- -DFOREGROUND ├─95503 (wsgi:keystone- -DFOREGROUND ├─95504 (wsgi:keystone- -DFOREGROUND ├─95505 (wsgi:keystone- -DFOREGROUND ├─95506 /usr/sbin/httpd -DFOREGROUND ├─95507 /usr/sbin/httpd -DFOREGROUND ├─95508 /usr/sbin/httpd -DFOREGROUND ├─95509 /usr/sbin/httpd -DFOREGROUND └─95510 /usr/sbin/httpd -DFOREGROUND Apr 08 03:01:19 controller systemd[1]: Starting The Apache HTTP Server... Apr 08 03:01:19 controller systemd[1]: Started The Apache HTTP Server. 启动nova服务 # 启用服务 [tony@controller ~]$ sudo systemctl enable openstack-nova-api.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-api.service to /usr/lib/systemd/system/openstack-nova-api.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-consoleauth Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-consoleauth.service to /usr/lib/systemd/system/openstack-nova-consoleauth.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-scheduler.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-scheduler.service to /usr/lib/systemd/system/openstack-nova-scheduler.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-conductor.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-conductor.service to /usr/lib/systemd/system/openstack-nova-conductor.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-novncproxy.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-novncproxy.service to /usr/lib/systemd/system/openstack-nova-novncproxy.service. # 启动服务 [tony@controller ~]$ sudo systemctl start openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service # 检查服务状态 [tony@controller ~]$ sudo systemctl status openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service ● openstack-nova-api.service - OpenStack Nova API Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-api.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:24 EDT; 7s ago Main PID: 96191 (nova-api) CGroup: /system.slice/openstack-nova-api.service ├─96191 /usr/bin/python2 /usr/bin/nova-api ├─96271 /usr/bin/python2 /usr/bin/nova-api ├─96272 /usr/bin/python2 /usr/bin/nova-api ├─96273 /usr/bin/python2 /usr/bin/nova-api ├─96274 /usr/bin/python2 /usr/bin/nova-api ├─96279 /usr/bin/python2 /usr/bin/nova-api ├─96281 /usr/bin/python2 /usr/bin/nova-api ├─96282 /usr/bin/python2 /usr/bin/nova-api └─96283 /usr/bin/python2 /usr/bin/nova-api Apr 08 03:07:15 controller systemd[1]: Starting OpenStack Nova API Server... Apr 08 03:07:24 controller systemd[1]: Started OpenStack Nova API Server. ● openstack-nova-consoleauth.service - OpenStack Nova VNC console auth Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-consoleauth.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:19 EDT; 11s ago Main PID: 96192 (nova-consoleaut) CGroup: /system.slice/openstack-nova-consoleauth.service └─96192 /usr/bin/python2 /usr/bin/nova-consoleauth Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova VNC console auth Server... Apr 08 03:07:19 controller systemd[1]: Started OpenStack Nova VNC console auth Server. ● openstack-nova-scheduler.service - OpenStack Nova Scheduler Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-scheduler.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:21 EDT; 9s ago Main PID: 96193 (nova-scheduler) CGroup: /system.slice/openstack-nova-scheduler.service ├─96193 /usr/bin/python2 /usr/bin/nova-scheduler ├─96258 /usr/bin/python2 /usr/bin/nova-scheduler ├─96259 /usr/bin/python2 /usr/bin/nova-scheduler ├─96260 /usr/bin/python2 /usr/bin/nova-scheduler └─96262 /usr/bin/python2 /usr/bin/nova-scheduler Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Scheduler Server... Apr 08 03:07:21 controller systemd[1]: Started OpenStack Nova Scheduler Server. ● openstack-nova-conductor.service - OpenStack Nova Conductor Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-conductor.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:20 EDT; 10s ago Main PID: 96194 (nova-conductor) CGroup: /system.slice/openstack-nova-conductor.service ├─96194 /usr/bin/python2 /usr/bin/nova-conductor ├─96248 /usr/bin/python2 /usr/bin/nova-conductor ├─96250 /usr/bin/python2 /usr/bin/nova-conductor ├─96251 /usr/bin/python2 /usr/bin/nova-conductor └─96252 /usr/bin/python2 /usr/bin/nova-conductor Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Conductor Server... Apr 08 03:07:20 controller systemd[1]: Started OpenStack Nova Conductor Server. ● openstack-nova-novncproxy.service - OpenStack Nova NoVNC Proxy Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-novncproxy.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:16 EDT; 15s ago Main PID: 96195 (nova-novncproxy) CGroup: /system.slice/openstack-nova-novncproxy.service └─96195 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/ Apr 08 03:07:16 controller systemd[1]: Started OpenStack Nova NoVNC Proxy Server. 验证Nova服务 [tony@controller ~]$ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:10:35.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:10:26.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:10:27.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ 部署nova-compute包 [tony@controller ~]$ sudo yum -y install openstack-nova-compute 修改配置文件 [tony@controller ~]$ diff /tmp/nova.origin.conf /tmp/nova.new.conf 6a7,8 &gt; compute_driver = libvirt.LibvirtDriver &gt; instances_path = /var/lib/nova/instances 24a27,31 &gt; [vnc] &gt; enabled = true &gt; server_listen = 0.0.0.0 &gt; server_proxyclient_address = $my_ip &gt; novncproxy_base_url = http://controller:6080/vnc_auto.html 42a50 &gt; virt_type = qemu 68a77 &gt; connection = mysql+pymysql://placement:$password@controller/placement 新的配置文件 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] my_ip = 172.18.22.231 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver compute_driver = libvirt.LibvirtDriver instances_path = /var/lib/nova/instances [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] … [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] … [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html [glance] api_servers = http://controller:9292 [guestfs] … [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] virt_type = qemu [matchmaker_redis] … [oslo_concurrency] lock_path = /var/lib/nova/tmp [oslo_messaging_amqp] … [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] connection = mysql+pymysql://placement:$password@controller/placement [powervm] … [workarounds] 启动服务 [tony@controller ~]$ sudo systemctl enable libvirtd.service openstack-nova-compute.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service. [tony@controller ~]$ sudo systemctl start libvirtd.service openstack-nova-compute.service [tony@controller ~]$ sudo systemctl status libvirtd.service openstack-nova-compute.service ● libvirtd.service - Virtualization daemon Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled) Active: active (running) since Mon 2019-04-08 03:41:40 EDT; 9s ago Docs: man:libvirtd(8) https://libvirt.org Main PID: 102617 (libvirtd) Tasks: 17 (limit: 32768) CGroup: /system.slice/libvirtd.service └─102617 /usr/sbin/libvirtd Apr 08 03:41:40 controller systemd[1]: Starting Virtualization daemon... Apr 08 03:41:40 controller systemd[1]: Started Virtualization daemon. ● openstack-nova-compute.service - OpenStack Nova Compute Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:41:43 EDT; 6s ago Main PID: 102635 (nova-compute) Tasks: 22 CGroup: /system.slice/openstack-nova-compute.service └─102635 /usr/bin/python2 /usr/bin/nova-compute Apr 08 03:41:40 controller systemd[1]: Starting OpenStack Nova Compute Server... Apr 08 03:41:43 controller systemd[1]: Started OpenStack Nova Compute Server. 将Controller Node注册到Cell [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell &#39;cell1&#39;: c1a3197c-cbd1-4554-881b-f405ea4b1c74 Checking host mapping for compute host &#39;controller&#39;: 090c321b-7c7d-496f-bbcb-1f5360034cc8 Creating host mapping for compute host &#39;controller&#39;: 090c321b-7c7d-496f-bbcb-1f5360034cc8 Found 1 unmapped computes in cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74 验证controller机器上的compute服务 [tony@controller ~]$ openstack compute service list ±—±-----------------±-----------±---------±--------±------±---------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | ±—±-----------------±-----------±---------±--------±------±---------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:46:37.000000 | | 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T07:46:42.000000 | ±—±-----------------±-----------±---------±--------±------±---------------------------+ 验证cells和placement API正常工作 [tony@controller ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ Nova (Compute) 关闭防火墙 [tony@compute ~]$ sudo systemctl stop firewalld [tony@compute ~]$ sudo systemctl disable firewalld Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service. Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 安装软件包 # 安装软件包 [tony@compute ~]$ sudo yum install -y openstack-nova-compute # 设置配置文件 [tony@compute ~]$ sudo cp /etc/nova/nova.conf /etc/nova/nova.conf.origin [tony@compute ~]$ sudo vim /etc/nova/nova.conf [DEFAULT] my_ip = 172.18.22.232 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver compute_driver = libvirt.LibvirtDriver instances_path = /var/lib/nova/instances [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] [cache] [cells] [cinder] [compute] [conductor] [console] [consoleauth] [cors] [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] [ephemeral_storage_encryption] [filter_scheduler] [glance] api_servers = http://controller:9292 [guestfs] [healthcheck] [hyperv] [ironic] [key_manager] [keystone] [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] virt_type = qemu [matchmaker_redis] [metrics] [mks] [neutron] [notifications] [osapi_v21] [oslo_concurrency] [oslo_messaging_amqp] [oslo_messaging_kafka] [oslo_messaging_notifications] [oslo_messaging_rabbit] [oslo_messaging_zmq] [oslo_middleware] [oslo_policy] [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] connection = mysql+pymysql://placement:$password@controller/placement [powervm] [profiler] [quota] [rdp] [remote_debug] [scheduler] [serial_console] [service_user] [spice] [upgrade_levels] [vault] [vendordata_dynamic_auth] [vmware] [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html [workarounds] [wsgi] [xenserver] [xvp] [zvm] # 启用并启动服务 [tony@compute ~]$ sudo systemctl enable libvirtd.service openstack-nova-compute.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service. [tony@compute ~]$ sudo systemctl start libvirtd.service openstack-nova-compute.service [tony@compute ~]$ sudo systemctl status libvirtd.service openstack-nova-compute.service ● libvirtd.service - Virtualization daemon Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled) Active: active (running) since Mon 2019-04-08 04:31:49 EDT; 9s ago Docs: man:libvirtd(8) https://libvirt.org Main PID: 33687 (libvirtd) Tasks: 17 (limit: 32768) CGroup: /system.slice/libvirtd.service └─33687 /usr/sbin/libvirtd Apr 08 04:31:49 compute systemd[1]: Starting Virtualization daemon... Apr 08 04:31:49 compute systemd[1]: Started Virtualization daemon. ● openstack-nova-compute.service - OpenStack Nova Compute Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 04:31:52 EDT; 6s ago Main PID: 33705 (nova-compute) Tasks: 22 CGroup: /system.slice/openstack-nova-compute.service └─33705 /usr/bin/python2 /usr/bin/nova-compute Apr 08 04:31:49 compute systemd[1]: Starting OpenStack Nova Compute Server... Apr 08 04:31:52 compute systemd[1]: Started OpenStack Nova Compute Server. # 注册 [tony@compute ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell &#39;cell1&#39;: c1a3197c-cbd1-4554-881b-f405ea4b1c74 Checking host mapping for compute host &#39;compute&#39;: 005dfe34-54f3-4982-b2f8-43b81ae673fd Creating host mapping for compute host &#39;compute&#39;: 005dfe34-54f3-4982-b2f8-43b81ae673fd Found 1 unmapped computes in cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74 # 忘记设置admin鉴权信息了 [tony@compute ~]$ openstack compute service list Missing value auth-url required for auth plugin password [tony@compute ~]$ vim adminrc export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=$password export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 [tony@compute ~]$ source adminrc [tony@compute ~]$ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T08:33:17.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T08:33:21.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T08:33:12.000000 | | 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T08:33:21.000000 | | 8 | nova-compute | compute | nova | enabled | up | 2019-04-08T08:33:18.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ [tony@compute ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ 结语 自此，controller与compute1机器上的nova模块安装成功。 第一篇：实录手动部署Openstack Rocky 双节点（1）- 基础服务 上一篇：实录手动部署Openstack Rocky 双节点（3）- Glance 下一篇：实录手动部署Openstack Rocky 双节点（5）- Neutron" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-09T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"第一篇：实录手动部署Openstack Rocky 双节点（1）- 基础服务 上一篇：实录手动部署Openstack Rocky 双节点（3）- Glance 下一篇：实录手动部署Openstack Rocky 双节点（5）- Neutron 文章目录 参考文档 Nova (controller) 关闭防火墙 设置admin的鉴权信息 添加Nova账户及其鉴权信息 创建compute类型的服务 创建nova账户并设置密码 给nova账户赋予service项目的admin角色 创建endpoint 创建placement类型服务 创建placement账户 创建endpoint 检查当前controller机器上的catalog 安装软件包 Nova配置文件 创建Nova相关的数据库及权限设定 初始化Nova API与Placement数据库 初始化Nova数据库 注册cell0数据库 创建cell1 验证cell0与cell1 注册Placement Web Server到httpd 启动nova服务 验证Nova服务 部署nova-compute包 修改配置文件 启动服务 将Controller Node注册到Cell 验证controller机器上的compute服务 验证cells和placement API正常工作 Nova (Compute) 关闭防火墙 安装软件包 结语 参考文档 手动部署OpenStack Rocky双节点 Nova (controller) 关闭防火墙 [tony@controller ~]$ sudo systemctl stop firewalld [tony@controller ~]$ sudo systemctl disable firewalld Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service. Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 设置admin的鉴权信息 [tony@controller ~]$ cat adminrc export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=$password export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 [tony@controller ~]$ source adminrc 添加Nova账户及其鉴权信息 创建compute类型的服务 [tony@controller ~]$ openstack service create --name nova --description &quot;OpenStack Compute&quot; compute +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | OpenStack Compute | | enabled | True | | id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | name | nova | | type | compute | +-------------+----------------------------------+ 创建nova账户并设置密码 [tony@controller ~]$ openstack user create --domain default --password-prompt nova User Password: &lt;Enter password&gt; Repeat User Password: &lt;Repeat password&gt; ±--------------------±---------------------------------+ | Field | Value | ±--------------------±---------------------------------+ | domain_id | default | | enabled | True | | id | 4ecb248c39df4f368a2a4c07805ab784 | | name | nova | | options | {} | | password_expires_at | None | ±--------------------±---------------------------------+ 给nova账户赋予service项目的admin角色 [tony@controller ~]$ openstack role add --project service --user nova admin 创建endpoint [tony@controller ~]$ openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 2e937f5e7a2942418fc759ddcf7bb042 | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 69d1fd19e43e47cc978d758ef7aaf7a2 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 631f58379ade4eb4ae42c743ee2b57e8 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 5c2b7c41e83f4e8ca7118c0097248cf5 | | service_name | nova | | service_type | compute | | url | http://controller:8774/v2.1 | +--------------+----------------------------------+ 创建placement类型服务 [tony@controller ~]$ openstack service create --name placement --description &quot;Placement API&quot; placement +-------------+----------------------------------+ | Field | Value | +-------------+----------------------------------+ | description | Placement API | | enabled | True | | id | 1b43d96cb1e7407f994189fbe77f6724 | | name | placement | | type | placement | +-------------+----------------------------------+ 创建placement账户 [tony@controller ~]$ openstack user create --domain default --password-prompt placement User Password: &lt;Enter password&gt; Repeat User Password: &lt;Repeat password&gt; +---------------------+----------------------------------+ | Field | Value | +---------------------+----------------------------------+ | domain_id | default | | enabled | True | | id | 828b032a6cfb467ab98a5986b1168ab3 | | name | placement | | options | {} | | password_expires_at | None | +---------------------+----------------------------------+ [tony@controller ~]$ openstack role add --project service --user placement admin 创建endpoint [tony@controller ~]$ openstack endpoint create --region RegionOne placement public http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 36ef3c5e2b6f45a79651717e07e308ce | | interface | public | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne placement internal http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | ffa9735e7353483dba0360e23d3078e4 | | interface | internal | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ [tony@controller ~]$ openstack endpoint create --region RegionOne placement admin http://controller:8778 +--------------+----------------------------------+ | Field | Value | +--------------+----------------------------------+ | enabled | True | | id | 13b5952a556e485aa1ebc93badf77485 | | interface | admin | | region | RegionOne | | region_id | RegionOne | | service_id | 1b43d96cb1e7407f994189fbe77f6724 | | service_name | placement | | service_type | placement | | url | http://controller:8778 | +--------------+----------------------------------+ 检查当前controller机器上的catalog [tony@controller ~]$ [tony@controller ~]$ openstack catalog list +-----------+-----------+-----------------------------------------+ | Name | Type | Endpoints | +-----------+-----------+-----------------------------------------+ | placement | placement | RegionOne | | | | admin: http://controller:8778 | | | | RegionOne | | | | public: http://controller:8778 | | | | RegionOne | | | | internal: http://controller:8778 | | | | | | keystone | identity | RegionOne | | | | admin: http://controller:5000/v3/ | | | | RegionOne | | | | internal: http://controller:5000/v3/ | | | | RegionOne | | | | public: http://controller:5000/v3/ | | | | | | nova | compute | RegionOne | | | | public: http://controller:8774/v2.1 | | | | RegionOne | | | | admin: http://controller:8774/v2.1 | | | | RegionOne | | | | internal: http://controller:8774/v2.1 | | | | | | glance | image | RegionOne | | | | public: http://controller:9292 | | | | RegionOne | | | | internal: http://controller:9292 | | | | RegionOne | | | | admin: http://controller:9292 | | | | | +-----------+-----------+-----------------------------------------+ 安装软件包 [tony@controller ~]$ sudo yum install -y openstack-nova-api openstack-nova-conductor openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler openstack-nova-placement-api Nova配置文件 原始默认配置文件 # 事实上，原始配置文件所有的配置选项都是注释掉的。 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] ... [zvm] 修改后的配置文件 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] my_ip = 172.18.22.231 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] [cache] [cells] [cinder] [compute] [conductor] [console] [consoleauth] [cors] [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] [ephemeral_storage_encryption] [filter_scheduler] [glance] api_servers = http://controller:9292 [guestfs] [healthcheck] [hyperv] [ironic] [key_manager] [keystone] [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] [matchmaker_redis] [metrics] [mks] [neutron] [notifications] [osapi_v21] [oslo_concurrency] lock_path = /var/lib/nova/tmp [oslo_messaging_amqp] [oslo_messaging_kafka] [oslo_messaging_notifications] [oslo_messaging_rabbit] [oslo_messaging_zmq] [oslo_middleware] [oslo_policy] [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] [powervm] [profiler] [quota] [rdp] [remote_debug] [scheduler] [serial_console] [service_user] [spice] [upgrade_levels] [vault] [vendordata_dynamic_auth] [vmware] [vnc] enabled = true server_listen = $my_ip server_proxyclient_address = $my_ip [workarounds] [wsgi] [xenserver] [xvp] [zvm] 创建Nova相关的数据库及权限设定 [tony@controller ~]$ mysql -u root -p Enter password: Welcome to the MariaDB monitor. Commands end with ; or \\g. Your MariaDB connection id is 55 Server version: 10.1.20-MariaDB MariaDB Server &nbsp; Copyright © 2000, 2016, Oracle, MariaDB Corporation Ab and others. &nbsp; Type ‘help;’ or ‘\\h’ for help. Type ‘\\c’ to clear the current input statement. &nbsp; MariaDB [(none)]&gt; create database nova_api; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database nova; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database nova_cell0; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; create database placement; Query OK, 1 row affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_api.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_api.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_cell0.* to ‘nova’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on nova_cell0.* to ‘nova’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on placement.* to ‘placement’@‘localhost’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; grant all privileges on placement.* to ‘placement’@’%’ identified by ‘$password’; Query OK, 0 rows affected (0.00 sec) &nbsp; MariaDB [(none)]&gt; quit Bye 初始化Nova API与Placement数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova 初始化Nova数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova WARNING: cell0 mapping not found - not syncing cell0. /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index block_device_mapping_instance_uuid_virtual_name_device_name_idx. This is deprecated and will be disallowed in a future release.’) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index uniq_instances0uuid. This is deprecated and will be disallowed in a future release.’) result = self._query(query) 注：第一次执行本步骤，可以忽略下面的注释 后续步骤中 $sudo nova-status upgrade check 命令报错，又重新初始化了一次数据库，就没有第一个红色的Warning了。nova-status命令也正常执行了。具体原因待查。 # 命令出错 [tony@tony-controller ~]$ sudo nova-status upgrade check Error: Traceback (most recent call last): File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 795, in main ret = fn(*fn_args, **fn_kwargs) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 725, in check result = func(self) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 206, in _check_placement versions = self._placement_get(&quot;/&quot;) File &quot;/usr/lib/python2.7/site-packages/nova/cmd/status.py&quot;, line 196, in _placement_get return client.get(path, raise_exc=True).json() File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py&quot;, line 328, in get return self.request(url, &#39;GET&#39;, **kwargs) File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py&quot;, line 213, in request return self.session.request(url, method, **kwargs) File &quot;/usr/lib/python2.7/site-packages/keystoneauth1/session.py&quot;, line 869, in request raise exceptions.from_response(resp, method, url) InternalServerError: Internal Server Error (HTTP 500) # 重新初始化数据库 [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage api_db sync&quot; nova [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova # 程序正常执行 [tony@tony-controller ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ 注册cell0数据库 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 map_cell0&quot; nova 注：在注册cell0数据库之后，重新初始化一下Nova数据库，也就没有第一个Warning了。 [tony@tony-controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage db sync&quot; nova /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u&#39;Duplicate index `block_device_mapping_instance_uuid_virtual_name_device_name_idx`. This is deprecated and will be disallowed in a future release.&#39;) result = self._query(query) /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u&#39;Duplicate index `uniq_instances0uuid`. This is deprecated and will be disallowed in a future release.&#39;) result = self._query(query) 创建cell1 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 create_cell --name=cell1 --verbose&quot; nova c1a3197c-cbd1-4554-881b-f405ea4b1c74 验证cell0与cell1 [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 list_cells&quot; nova ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ | Name | UUID | Transport URL | Database Connection | Disabled | ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ | cell0 | 00000000-0000-0000-0000-000000000000 | none:/ | mysql+pymysql://nova:@controller/nova_cell0 | False | | cell1 | c1a3197c-cbd1-4554-881b-f405ea4b1c74 | rabbit://openstack:@controller | mysql+pymysql://nova:****@controller/nova | False | ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+ 注册Placement Web Server到httpd 修改配置文件 [tony@controller ~]$ sudo cat /etc/httpd/conf.d/00-nova-placement-api.conf Listen 8778 &nbsp; &lt;VirtualHost *:8778&gt; WSGIProcessGroup nova-placement-api WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On WSGIDaemonProcess nova-placement-api processes=3 threads=1 user=nova group=nova WSGIScriptAlias / /usr/bin/nova-placement-api &lt;IfVersion &gt;= 2.4&gt; ErrorLogFormat “%M” &lt;/IfVersion&gt; ErrorLog /var/log/nova/nova-placement-api.log #SSLEngine On #SSLCertificateFile … #SSLCertificateKeyFile … &nbsp; &lt;Directory /usr/bin&gt; &lt;IfVersion &gt;= 2.4&gt; Require all granted &lt;/IfVersion&gt; &lt;IfVersion &lt; 2.4&gt; Order allow, deny Allow from all &lt;/IfVersion&gt; &lt;/Directory&gt; &lt;/VirtualHost&gt; &nbsp; Alias /nova-placement-api /usr/bin/nova-placement-api &lt;Location /nova-placement-api&gt; SetHandler wsgi-script Options +ExecCGI WSGIProcessGroup nova-placement-api WSGIApplicationGroup %{GLOBAL} WSGIPassAuthorization On &lt;/Location&gt; 重启httpd服务 [tony@controller ~]$ sudo systemctl restart httpd [tony@controller ~]$ sudo systemctl status httpd ● httpd.service - The Apache HTTP Server Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:01:19 EDT; 8s ago Docs: man:httpd(8) man:apachectl(8) Process: 95486 ExecStop=/bin/kill -WINCH ${MAINPID} (code=exited, status=0/SUCCESS) Main PID: 95497 (httpd) Status: &quot;Processing requests...&quot; CGroup: /system.slice/httpd.service ├─95497 /usr/sbin/httpd -DFOREGROUND ├─95498 /usr/sbin/httpd -DFOREGROUND ├─95499 /usr/sbin/httpd -DFOREGROUND ├─95500 /usr/sbin/httpd -DFOREGROUND ├─95501 (wsgi:keystone- -DFOREGROUND ├─95502 (wsgi:keystone- -DFOREGROUND ├─95503 (wsgi:keystone- -DFOREGROUND ├─95504 (wsgi:keystone- -DFOREGROUND ├─95505 (wsgi:keystone- -DFOREGROUND ├─95506 /usr/sbin/httpd -DFOREGROUND ├─95507 /usr/sbin/httpd -DFOREGROUND ├─95508 /usr/sbin/httpd -DFOREGROUND ├─95509 /usr/sbin/httpd -DFOREGROUND └─95510 /usr/sbin/httpd -DFOREGROUND Apr 08 03:01:19 controller systemd[1]: Starting The Apache HTTP Server... Apr 08 03:01:19 controller systemd[1]: Started The Apache HTTP Server. 启动nova服务 # 启用服务 [tony@controller ~]$ sudo systemctl enable openstack-nova-api.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-api.service to /usr/lib/systemd/system/openstack-nova-api.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-consoleauth Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-consoleauth.service to /usr/lib/systemd/system/openstack-nova-consoleauth.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-scheduler.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-scheduler.service to /usr/lib/systemd/system/openstack-nova-scheduler.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-conductor.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-conductor.service to /usr/lib/systemd/system/openstack-nova-conductor.service. [tony@controller ~]$ sudo systemctl enable openstack-nova-novncproxy.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-novncproxy.service to /usr/lib/systemd/system/openstack-nova-novncproxy.service. # 启动服务 [tony@controller ~]$ sudo systemctl start openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service # 检查服务状态 [tony@controller ~]$ sudo systemctl status openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service ● openstack-nova-api.service - OpenStack Nova API Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-api.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:24 EDT; 7s ago Main PID: 96191 (nova-api) CGroup: /system.slice/openstack-nova-api.service ├─96191 /usr/bin/python2 /usr/bin/nova-api ├─96271 /usr/bin/python2 /usr/bin/nova-api ├─96272 /usr/bin/python2 /usr/bin/nova-api ├─96273 /usr/bin/python2 /usr/bin/nova-api ├─96274 /usr/bin/python2 /usr/bin/nova-api ├─96279 /usr/bin/python2 /usr/bin/nova-api ├─96281 /usr/bin/python2 /usr/bin/nova-api ├─96282 /usr/bin/python2 /usr/bin/nova-api └─96283 /usr/bin/python2 /usr/bin/nova-api Apr 08 03:07:15 controller systemd[1]: Starting OpenStack Nova API Server... Apr 08 03:07:24 controller systemd[1]: Started OpenStack Nova API Server. ● openstack-nova-consoleauth.service - OpenStack Nova VNC console auth Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-consoleauth.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:19 EDT; 11s ago Main PID: 96192 (nova-consoleaut) CGroup: /system.slice/openstack-nova-consoleauth.service └─96192 /usr/bin/python2 /usr/bin/nova-consoleauth Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova VNC console auth Server... Apr 08 03:07:19 controller systemd[1]: Started OpenStack Nova VNC console auth Server. ● openstack-nova-scheduler.service - OpenStack Nova Scheduler Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-scheduler.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:21 EDT; 9s ago Main PID: 96193 (nova-scheduler) CGroup: /system.slice/openstack-nova-scheduler.service ├─96193 /usr/bin/python2 /usr/bin/nova-scheduler ├─96258 /usr/bin/python2 /usr/bin/nova-scheduler ├─96259 /usr/bin/python2 /usr/bin/nova-scheduler ├─96260 /usr/bin/python2 /usr/bin/nova-scheduler └─96262 /usr/bin/python2 /usr/bin/nova-scheduler Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Scheduler Server... Apr 08 03:07:21 controller systemd[1]: Started OpenStack Nova Scheduler Server. ● openstack-nova-conductor.service - OpenStack Nova Conductor Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-conductor.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:20 EDT; 10s ago Main PID: 96194 (nova-conductor) CGroup: /system.slice/openstack-nova-conductor.service ├─96194 /usr/bin/python2 /usr/bin/nova-conductor ├─96248 /usr/bin/python2 /usr/bin/nova-conductor ├─96250 /usr/bin/python2 /usr/bin/nova-conductor ├─96251 /usr/bin/python2 /usr/bin/nova-conductor └─96252 /usr/bin/python2 /usr/bin/nova-conductor Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Conductor Server... Apr 08 03:07:20 controller systemd[1]: Started OpenStack Nova Conductor Server. ● openstack-nova-novncproxy.service - OpenStack Nova NoVNC Proxy Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-novncproxy.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:07:16 EDT; 15s ago Main PID: 96195 (nova-novncproxy) CGroup: /system.slice/openstack-nova-novncproxy.service └─96195 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/ Apr 08 03:07:16 controller systemd[1]: Started OpenStack Nova NoVNC Proxy Server. 验证Nova服务 [tony@controller ~]$ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:10:35.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:10:26.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:10:27.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ 部署nova-compute包 [tony@controller ~]$ sudo yum -y install openstack-nova-compute 修改配置文件 [tony@controller ~]$ diff /tmp/nova.origin.conf /tmp/nova.new.conf 6a7,8 &gt; compute_driver = libvirt.LibvirtDriver &gt; instances_path = /var/lib/nova/instances 24a27,31 &gt; [vnc] &gt; enabled = true &gt; server_listen = 0.0.0.0 &gt; server_proxyclient_address = $my_ip &gt; novncproxy_base_url = http://controller:6080/vnc_auto.html 42a50 &gt; virt_type = qemu 68a77 &gt; connection = mysql+pymysql://placement:$password@controller/placement 新的配置文件 [tony@controller ~]$ sudo cat /etc/nova/nova.conf | grep -v -E &#39;^$|^#&#39; [DEFAULT] my_ip = 172.18.22.231 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver compute_driver = libvirt.LibvirtDriver instances_path = /var/lib/nova/instances [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] … [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] … [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html [glance] api_servers = http://controller:9292 [guestfs] … [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] virt_type = qemu [matchmaker_redis] … [oslo_concurrency] lock_path = /var/lib/nova/tmp [oslo_messaging_amqp] … [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] connection = mysql+pymysql://placement:$password@controller/placement [powervm] … [workarounds] 启动服务 [tony@controller ~]$ sudo systemctl enable libvirtd.service openstack-nova-compute.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service. [tony@controller ~]$ sudo systemctl start libvirtd.service openstack-nova-compute.service [tony@controller ~]$ sudo systemctl status libvirtd.service openstack-nova-compute.service ● libvirtd.service - Virtualization daemon Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled) Active: active (running) since Mon 2019-04-08 03:41:40 EDT; 9s ago Docs: man:libvirtd(8) https://libvirt.org Main PID: 102617 (libvirtd) Tasks: 17 (limit: 32768) CGroup: /system.slice/libvirtd.service └─102617 /usr/sbin/libvirtd Apr 08 03:41:40 controller systemd[1]: Starting Virtualization daemon... Apr 08 03:41:40 controller systemd[1]: Started Virtualization daemon. ● openstack-nova-compute.service - OpenStack Nova Compute Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 03:41:43 EDT; 6s ago Main PID: 102635 (nova-compute) Tasks: 22 CGroup: /system.slice/openstack-nova-compute.service └─102635 /usr/bin/python2 /usr/bin/nova-compute Apr 08 03:41:40 controller systemd[1]: Starting OpenStack Nova Compute Server... Apr 08 03:41:43 controller systemd[1]: Started OpenStack Nova Compute Server. 将Controller Node注册到Cell [tony@controller ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell &#39;cell1&#39;: c1a3197c-cbd1-4554-881b-f405ea4b1c74 Checking host mapping for compute host &#39;controller&#39;: 090c321b-7c7d-496f-bbcb-1f5360034cc8 Creating host mapping for compute host &#39;controller&#39;: 090c321b-7c7d-496f-bbcb-1f5360034cc8 Found 1 unmapped computes in cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74 验证controller机器上的compute服务 [tony@controller ~]$ openstack compute service list ±—±-----------------±-----------±---------±--------±------±---------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | ±—±-----------------±-----------±---------±--------±------±---------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:46:37.000000 | | 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T07:46:42.000000 | ±—±-----------------±-----------±---------±--------±------±---------------------------+ 验证cells和placement API正常工作 [tony@controller ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ Nova (Compute) 关闭防火墙 [tony@compute ~]$ sudo systemctl stop firewalld [tony@compute ~]$ sudo systemctl disable firewalld Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service. Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service. 安装软件包 # 安装软件包 [tony@compute ~]$ sudo yum install -y openstack-nova-compute # 设置配置文件 [tony@compute ~]$ sudo cp /etc/nova/nova.conf /etc/nova/nova.conf.origin [tony@compute ~]$ sudo vim /etc/nova/nova.conf [DEFAULT] my_ip = 172.18.22.232 enabled_apis = osapi_compute,metadata transport_url = rabbit://openstack:$password@controller use_neutron = true firewall_driver = nova.virt.firewall.NoopFirewallDriver compute_driver = libvirt.LibvirtDriver instances_path = /var/lib/nova/instances [api] auth_strategy = keystone [api_database] connection = mysql+pymysql://nova:$password@controller/nova_api [barbican] [cache] [cells] [cinder] [compute] [conductor] [console] [consoleauth] [cors] [database] connection = mysql+pymysql://nova:$password@controller/nova [devices] [ephemeral_storage_encryption] [filter_scheduler] [glance] api_servers = http://controller:9292 [guestfs] [healthcheck] [hyperv] [ironic] [key_manager] [keystone] [keystone_authtoken] auth_url = http://controller:5000/v3 memcached_servers = controller:11211 auth_type = password project_domain_name = default user_domain_name = default project_name = service username = nova password = $password [libvirt] virt_type = qemu [matchmaker_redis] [metrics] [mks] [neutron] [notifications] [osapi_v21] [oslo_concurrency] [oslo_messaging_amqp] [oslo_messaging_kafka] [oslo_messaging_notifications] [oslo_messaging_rabbit] [oslo_messaging_zmq] [oslo_middleware] [oslo_policy] [pci] [placement] region_name = RegionOne project_domain_name = Default project_name = service user_domain_name = Default auth_type = password auth_url = http://controller:5000/v3 username = placement password = $password [placement_database] connection = mysql+pymysql://placement:$password@controller/placement [powervm] [profiler] [quota] [rdp] [remote_debug] [scheduler] [serial_console] [service_user] [spice] [upgrade_levels] [vault] [vendordata_dynamic_auth] [vmware] [vnc] enabled = true server_listen = 0.0.0.0 server_proxyclient_address = $my_ip novncproxy_base_url = http://controller:6080/vnc_auto.html [workarounds] [wsgi] [xenserver] [xvp] [zvm] # 启用并启动服务 [tony@compute ~]$ sudo systemctl enable libvirtd.service openstack-nova-compute.service Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service. [tony@compute ~]$ sudo systemctl start libvirtd.service openstack-nova-compute.service [tony@compute ~]$ sudo systemctl status libvirtd.service openstack-nova-compute.service ● libvirtd.service - Virtualization daemon Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled) Active: active (running) since Mon 2019-04-08 04:31:49 EDT; 9s ago Docs: man:libvirtd(8) https://libvirt.org Main PID: 33687 (libvirtd) Tasks: 17 (limit: 32768) CGroup: /system.slice/libvirtd.service └─33687 /usr/sbin/libvirtd Apr 08 04:31:49 compute systemd[1]: Starting Virtualization daemon... Apr 08 04:31:49 compute systemd[1]: Started Virtualization daemon. ● openstack-nova-compute.service - OpenStack Nova Compute Server Loaded: loaded (/usr/lib/systemd/system/openstack-nova-compute.service; enabled; vendor preset: disabled) Active: active (running) since Mon 2019-04-08 04:31:52 EDT; 6s ago Main PID: 33705 (nova-compute) Tasks: 22 CGroup: /system.slice/openstack-nova-compute.service └─33705 /usr/bin/python2 /usr/bin/nova-compute Apr 08 04:31:49 compute systemd[1]: Starting OpenStack Nova Compute Server... Apr 08 04:31:52 compute systemd[1]: Started OpenStack Nova Compute Server. # 注册 [tony@compute ~]$ sudo su -s /bin/sh -c &quot;nova-manage cell_v2 discover_hosts --verbose&quot; nova Found 2 cell mappings. Skipping cell0 since it does not contain hosts. Getting computes from cell &#39;cell1&#39;: c1a3197c-cbd1-4554-881b-f405ea4b1c74 Checking host mapping for compute host &#39;compute&#39;: 005dfe34-54f3-4982-b2f8-43b81ae673fd Creating host mapping for compute host &#39;compute&#39;: 005dfe34-54f3-4982-b2f8-43b81ae673fd Found 1 unmapped computes in cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74 # 忘记设置admin鉴权信息了 [tony@compute ~]$ openstack compute service list Missing value auth-url required for auth plugin password [tony@compute ~]$ vim adminrc export OS_PROJECT_DOMAIN_NAME=Default export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_NAME=admin export OS_USERNAME=admin export OS_PASSWORD=$password export OS_AUTH_URL=http://controller:5000/v3 export OS_IDENTITY_API_VERSION=3 export OS_IMAGE_API_VERSION=2 [tony@compute ~]$ source adminrc [tony@compute ~]$ openstack compute service list +----+------------------+------------+----------+---------+-------+----------------------------+ | ID | Binary | Host | Zone | Status | State | Updated At | +----+------------------+------------+----------+---------+-------+----------------------------+ | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T08:33:17.000000 | | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T08:33:21.000000 | | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T08:33:12.000000 | | 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T08:33:21.000000 | | 8 | nova-compute | compute | nova | enabled | up | 2019-04-08T08:33:18.000000 | +----+------------------+------------+----------+---------+-------+----------------------------+ [tony@compute ~]$ sudo nova-status upgrade check +--------------------------------+ | Upgrade Check Results | +--------------------------------+ | Check: Cells v2 | | Result: Success | | Details: None | +--------------------------------+ | Check: Placement API | | Result: Success | | Details: None | +--------------------------------+ | Check: Resource Providers | | Result: Success | | Details: None | +--------------------------------+ | Check: Ironic Flavor Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: API Service Version | | Result: Success | | Details: None | +--------------------------------+ | Check: Request Spec Migration | | Result: Success | | Details: None | +--------------------------------+ | Check: Console Auths | | Result: Success | | Details: None | +--------------------------------+ 结语 自此，controller与compute1机器上的nova模块安装成功。 第一篇：实录手动部署Openstack Rocky 双节点（1）- 基础服务 上一篇：实录手动部署Openstack Rocky 双节点（3）- Glance 下一篇：实录手动部署Openstack Rocky 双节点（5）- Neutron","@type":"BlogPosting","url":"/2019/04/09/728645.html","headline":"【Openstack】实录手动部署Openstack Rocky 双节点（4）- Nova","dateModified":"2019-04-09T00:00:00+08:00","datePublished":"2019-04-09T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/04/09/728645.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>【Openstack】实录手动部署Openstack Rocky 双节点（4）- Nova</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">  
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div id="content_views" class="markdown_views prism-tomorrow-night-eighties"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <p>第一篇：<a href="https://blog.csdn.net/qq_43401808/article/details/88991015" rel="nofollow">实录手动部署Openstack Rocky 双节点（1）- 基础服务</a><br> 上一篇：<a href="https://blog.csdn.net/qq_43401808/article/details/89082634" rel="nofollow">实录手动部署Openstack Rocky 双节点（3）- Glance</a><br> 下一篇：<a href="https://blog.csdn.net/qq_43401808/article/details/89282462" rel="nofollow">实录手动部署Openstack Rocky 双节点（5）- Neutron</a><br> </p>
  <div class="toc">
   <h3>文章目录</h3>
   <ul>
    <li><a href="#_4" rel="nofollow">参考文档</a></li>
    <li><a href="#Nova_controller_7" rel="nofollow">Nova (controller)</a></li>
    <ul>
     <li><a href="#_8" rel="nofollow">关闭防火墙</a></li>
     <li><a href="#admin_15" rel="nofollow">设置admin的鉴权信息</a></li>
     <li><a href="#Nova_30" rel="nofollow">添加Nova账户及其鉴权信息</a></li>
     <ul>
      <li><a href="#compute_31" rel="nofollow">创建compute类型的服务</a></li>
      <li><a href="#nova_44" rel="nofollow">创建nova账户并设置密码</a></li>
      <li><a href="#novaserviceadmin_61" rel="nofollow">给nova账户赋予service项目的admin角色</a></li>
      <li><a href="#endpoint_66" rel="nofollow">创建endpoint</a></li>
      <li><a href="#placement_114" rel="nofollow">创建placement类型服务</a></li>
      <li><a href="#placement_128" rel="nofollow">创建placement账户</a></li>
      <li><a href="#endpoint_147" rel="nofollow">创建endpoint</a></li>
      <li><a href="#controllercatalog_195" rel="nofollow">检查当前controller机器上的catalog</a></li>
     </ul>
     <li><a href="#_233" rel="nofollow">安装软件包</a></li>
     <li><a href="#Nova_238" rel="nofollow">Nova配置文件</a></li>
     <li><a href="#Nova_342" rel="nofollow">创建Nova相关的数据库及权限设定</a></li>
     <li><a href="#Nova_APIPlacement_394" rel="nofollow">初始化Nova API与Placement数据库</a></li>
     <li><a href="#Nova_399" rel="nofollow">初始化Nova数据库</a></li>
     <li><a href="#cell0_470" rel="nofollow">注册cell0数据库</a></li>
     <li><a href="#cell1_484" rel="nofollow">创建cell1</a></li>
     <li><a href="#cell0cell1_490" rel="nofollow">验证cell0与cell1</a></li>
     <li><a href="#Placement_Web_Serverhttpd_501" rel="nofollow">注册Placement Web Server到httpd</a></li>
     <li><a href="#nova_573" rel="nofollow">启动nova服务</a></li>
     <li><a href="#Nova_662" rel="nofollow">验证Nova服务</a></li>
     <li><a href="#novacompute_674" rel="nofollow">部署nova-compute包</a></li>
     <li><a href="#_679" rel="nofollow">修改配置文件</a></li>
     <li><a href="#_761" rel="nofollow">启动服务</a></li>
     <li><a href="#Controller_NodeCell_793" rel="nofollow">将Controller Node注册到Cell</a></li>
     <li><a href="#controllercompute_804" rel="nofollow">验证controller机器上的compute服务</a></li>
     <li><a href="#cellsplacement_API_817" rel="nofollow">验证cells和placement API正常工作</a></li>
    </ul>
    <li><a href="#Nova_Compute_853" rel="nofollow">Nova (Compute)</a></li>
    <ul>
     <li><a href="#_854" rel="nofollow">关闭防火墙</a></li>
     <li><a href="#_861" rel="nofollow">安装软件包</a></li>
    </ul>
    <li><a href="#_1063" rel="nofollow">结语</a></li>
   </ul>
  </div>
  <p></p> 
  <h1><a id="_4"></a>参考文档</h1> 
  <p><a href="https://mp.weixin.qq.com/s?__biz=MzAwOTE3NTg0MQ==&amp;mid=2649648013&amp;idx=1&amp;sn=3bb6e5340042464677c381426754ae9b&amp;chksm=83795dc3b40ed4d592d22400d91324a691f304bc8fbd0819878306255006d00a0beb1efbcacb&amp;mpshare=1&amp;scene=1&amp;srcid=&amp;pass_ticket=yuF7xANgK%2F8TSxNP5rIxTOhoFlHNAXNwnXbEB2RG0lFzzFVQIszDhOJz3kgzjNGA#rd" rel="nofollow">手动部署OpenStack Rocky双节点</a></p> 
  <h1><a id="Nova_controller_7"></a>Nova (controller)</h1> 
  <h2><a id="_8"></a>关闭防火墙</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl stop firewalld
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
</code></pre> 
  <h2><a id="admin_15"></a>设置admin的鉴权信息</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">cat</span> adminrc
<span class="token function">export</span> OS_PROJECT_DOMAIN_NAME<span class="token operator">=</span>Default
<span class="token function">export</span> OS_USER_DOMAIN_NAME<span class="token operator">=</span>Default
<span class="token function">export</span> OS_PROJECT_NAME<span class="token operator">=</span>admin
<span class="token function">export</span> OS_USERNAME<span class="token operator">=</span>admin
<span class="token function">export</span> OS_PASSWORD<span class="token operator">=</span><span class="token variable">$password</span>
<span class="token function">export</span> OS_AUTH_URL<span class="token operator">=</span>http://controller:5000/v3
<span class="token function">export</span> OS_IDENTITY_API_VERSION<span class="token operator">=</span>3
<span class="token function">export</span> OS_IMAGE_API_VERSION<span class="token operator">=</span>2

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">source</span> adminrc
</code></pre> 
  <h2><a id="Nova_30"></a>添加Nova账户及其鉴权信息</h2> 
  <h3><a id="compute_31"></a>创建compute类型的服务</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack <span class="token function">service</span> create --name nova --description <span class="token string">"OpenStack Compute"</span> compute
+-------------+----------------------------------+
<span class="token operator">|</span> Field       <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+-------------+----------------------------------+
<span class="token operator">|</span> description <span class="token operator">|</span> OpenStack Compute                <span class="token operator">|</span>
<span class="token operator">|</span> enabled     <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>          <span class="token operator">|</span> 5c2b7c41e83f4e8ca7118c0097248cf5 <span class="token operator">|</span>
<span class="token operator">|</span> name        <span class="token operator">|</span> nova                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">type</span>        <span class="token operator">|</span> compute                          <span class="token operator">|</span>
+-------------+----------------------------------+
</code></pre> 
  <h3><a id="nova_44"></a>创建nova账户并设置密码</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack user create --domain default --password-prompt nova
</code></pre> 
  <blockquote> 
   <p>User Password: <font color="red">&lt;Enter password&gt;</font><br> Repeat User Password: <font color="red">&lt;Repeat password&gt;</font><br> ±--------------------±---------------------------------+<br> | Field | Value |<br> ±--------------------±---------------------------------+<br> | domain_id | default |<br> | enabled | True |<br> | id | 4ecb248c39df4f368a2a4c07805ab784 |<br> | name | nova |<br> | options | {} |<br> | password_expires_at | None |<br> ±--------------------±---------------------------------+</p> 
  </blockquote> 
  <h3><a id="novaserviceadmin_61"></a>给nova账户赋予service项目的admin角色</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack role add --project <span class="token function">service</span> --user nova admin
</code></pre> 
  <h3><a id="endpoint_66"></a>创建endpoint</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> 2e937f5e7a2942418fc759ddcf7bb042 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> public                           <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> 5c2b7c41e83f4e8ca7118c0097248cf5 <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> nova                             <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> compute                          <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:8774/v2.1      <span class="token operator">|</span>
+--------------+----------------------------------+

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> 69d1fd19e43e47cc978d758ef7aaf7a2 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> internal                         <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> 5c2b7c41e83f4e8ca7118c0097248cf5 <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> nova                             <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> compute                          <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:8774/v2.1      <span class="token operator">|</span>
+--------------+----------------------------------+

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> 631f58379ade4eb4ae42c743ee2b57e8 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> admin                            <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> 5c2b7c41e83f4e8ca7118c0097248cf5 <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> nova                             <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> compute                          <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:8774/v2.1      <span class="token operator">|</span>
+--------------+----------------------------------+
</code></pre> 
  <h3><a id="placement_114"></a>创建placement类型服务</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack <span class="token function">service</span> create --name placement --description <span class="token string">"Placement API"</span> placement
+-------------+----------------------------------+
<span class="token operator">|</span> Field       <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+-------------+----------------------------------+
<span class="token operator">|</span> description <span class="token operator">|</span> Placement API                    <span class="token operator">|</span>
<span class="token operator">|</span> enabled     <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>          <span class="token operator">|</span> 1b43d96cb1e7407f994189fbe77f6724 <span class="token operator">|</span>
<span class="token operator">|</span> name        <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">type</span>        <span class="token operator">|</span> placement                        <span class="token operator">|</span>
+-------------+----------------------------------+
</code></pre> 
  <h3><a id="placement_128"></a>创建placement账户</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack user create --domain default --password-prompt placement
User Password: <span class="token operator">&lt;</span>Enter password<span class="token operator">&gt;</span>
Repeat User Password: <span class="token operator">&lt;</span>Repeat password<span class="token operator">&gt;</span>
+---------------------+----------------------------------+
<span class="token operator">|</span> Field               <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+---------------------+----------------------------------+
<span class="token operator">|</span> domain_id           <span class="token operator">|</span> default                          <span class="token operator">|</span>
<span class="token operator">|</span> enabled             <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>                  <span class="token operator">|</span> 828b032a6cfb467ab98a5986b1168ab3 <span class="token operator">|</span>
<span class="token operator">|</span> name                <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> options             <span class="token operator">|</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                               <span class="token operator">|</span>
<span class="token operator">|</span> password_expires_at <span class="token operator">|</span> None                             <span class="token operator">|</span>
+---------------------+----------------------------------+

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack role add --project <span class="token function">service</span> --user placement admin
</code></pre> 
  <h3><a id="endpoint_147"></a>创建endpoint</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack endpoint create --region RegionOne placement public http://controller:8778
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> 36ef3c5e2b6f45a79651717e07e308ce <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> public                           <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> 1b43d96cb1e7407f994189fbe77f6724 <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:8778           <span class="token operator">|</span>
+--------------+----------------------------------+

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack endpoint create --region RegionOne placement internal http://controller:8778
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> ffa9735e7353483dba0360e23d3078e4 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> internal                         <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> 1b43d96cb1e7407f994189fbe77f6724 <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:8778           <span class="token operator">|</span>
+--------------+----------------------------------+

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack endpoint create --region RegionOne placement admin http://controller:8778
+--------------+----------------------------------+
<span class="token operator">|</span> Field        <span class="token operator">|</span> Value                            <span class="token operator">|</span>
+--------------+----------------------------------+
<span class="token operator">|</span> enabled      <span class="token operator">|</span> True                             <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token function">id</span>           <span class="token operator">|</span> 13b5952a556e485aa1ebc93badf77485 <span class="token operator">|</span>
<span class="token operator">|</span> interface    <span class="token operator">|</span> admin                            <span class="token operator">|</span>
<span class="token operator">|</span> region       <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> region_id    <span class="token operator">|</span> RegionOne                        <span class="token operator">|</span>
<span class="token operator">|</span> service_id   <span class="token operator">|</span> 1b43d96cb1e7407f994189fbe77f6724 <span class="token operator">|</span>
<span class="token operator">|</span> service_name <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> service_type <span class="token operator">|</span> placement                        <span class="token operator">|</span>
<span class="token operator">|</span> url          <span class="token operator">|</span> http://controller:8778           <span class="token operator">|</span>
+--------------+----------------------------------+
</code></pre> 
  <h3><a id="controllercatalog_195"></a>检查当前controller机器上的catalog</h3> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack catalog list
+-----------+-----------+-----------------------------------------+
<span class="token operator">|</span> Name      <span class="token operator">|</span> Type      <span class="token operator">|</span> Endpoints                               <span class="token operator">|</span>
+-----------+-----------+-----------------------------------------+
<span class="token operator">|</span> placement <span class="token operator">|</span> placement <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   admin: http://controller:8778         <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   public: http://controller:8778        <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   internal: http://controller:8778      <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>                                         <span class="token operator">|</span>
<span class="token operator">|</span> keystone  <span class="token operator">|</span> identity  <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   admin: http://controller:5000/v3/     <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   internal: http://controller:5000/v3/  <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   public: http://controller:5000/v3/    <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>                                         <span class="token operator">|</span>
<span class="token operator">|</span> nova      <span class="token operator">|</span> compute   <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   public: http://controller:8774/v2.1   <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   admin: http://controller:8774/v2.1    <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   internal: http://controller:8774/v2.1 <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>                                         <span class="token operator">|</span>
<span class="token operator">|</span> glance    <span class="token operator">|</span> image     <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   public: http://controller:9292        <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   internal: http://controller:9292      <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span> RegionOne                               <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>   admin: http://controller:9292         <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>           <span class="token operator">|</span>                                         <span class="token operator">|</span>
+-----------+-----------+-----------------------------------------+
</code></pre> 
  <h2><a id="_233"></a>安装软件包</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y openstack-nova-api openstack-nova-conductor openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler openstack-nova-placement-api
</code></pre> 
  <h2><a id="Nova_238"></a>Nova配置文件</h2> 
  <ul> 
   <li>原始默认配置文件</li> 
  </ul> 
  <pre><code class="prism language-bash"><span class="token comment"># 事实上，原始配置文件所有的配置选项都是注释掉的。</span>
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">cat</span> /etc/nova/nova.conf <span class="token operator">|</span> <span class="token function">grep</span> -v -E <span class="token string">'^$|^#'</span>
<span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>zvm<span class="token punctuation">]</span>
</code></pre> 
  <ul> 
   <li>修改后的配置文件</li> 
  </ul> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">cat</span> /etc/nova/nova.conf <span class="token operator">|</span> <span class="token function">grep</span> -v -E <span class="token string">'^$|^#'</span>
</code></pre> 
  <blockquote> 
   <p><font color="blue">[DEFAULT]</font><br> <font color="red">my_ip = 172.18.22.231<br> enabled_apis = osapi_compute,metadata<br> transport_url = rabbit://openstack:$password@controller<br> use_neutron = true<br> firewall_driver = nova.virt.firewall.NoopFirewallDriver</font><br> <font color="blue">[api]</font><br> <font color="red">auth_strategy = keystone</font><br> <font color="blue">[api_database]</font><br> <font color="red">connection = mysql+pymysql://nova:$password@controller/nova_api</font><br> [barbican]<br> [cache]<br> [cells]<br> [cinder]<br> [compute]<br> [conductor]<br> [console]<br> [consoleauth]<br> [cors]<br> <font color="blue">[database]</font><br> <font color="red">connection = mysql+pymysql://nova:$password@controller/nova</font><br> [devices]<br> [ephemeral_storage_encryption]<br> [filter_scheduler]<br> <font color="blue">[glance]</font><br> <font color="red">api_servers = <a href="http://controller:9292" rel="nofollow">http://controller:9292</a></font><br> [guestfs]<br> [healthcheck]<br> [hyperv]<br> [ironic]<br> [key_manager]<br> [keystone]<br> <font color="blue">[keystone_authtoken]</font><br> <font color="red">auth_url = <a href="http://controller:5000/v3" rel="nofollow">http://controller:5000/v3</a><br> memcached_servers = controller:11211<br> auth_type = password<br> project_domain_name = default<br> user_domain_name = default<br> project_name = service<br> username = nova<br> password = $password</font><br> [libvirt]<br> [matchmaker_redis]<br> [metrics]<br> [mks]<br> [neutron]<br> [notifications]<br> [osapi_v21]<br> [oslo_concurrency]<br> lock_path = /var/lib/nova/tmp<br> [oslo_messaging_amqp]<br> [oslo_messaging_kafka]<br> [oslo_messaging_notifications]<br> [oslo_messaging_rabbit]<br> [oslo_messaging_zmq]<br> [oslo_middleware]<br> [oslo_policy]<br> [pci]<br> <font color="blue">[placement]</font><br> <font color="red">region_name = RegionOne<br> project_domain_name = Default<br> project_name = service<br> user_domain_name = Default<br> auth_type = password<br> auth_url = <a href="http://controller:5000/v3" rel="nofollow">http://controller:5000/v3</a><br> username = placement<br> password = $password</font><br> [placement_database]<br> [powervm]<br> [profiler]<br> [quota]<br> [rdp]<br> [remote_debug]<br> [scheduler]<br> [serial_console]<br> [service_user]<br> [spice]<br> [upgrade_levels]<br> [vault]<br> [vendordata_dynamic_auth]<br> [vmware]<br> <font color="blue">[vnc]</font><br> <font color="red">enabled = true<br> server_listen = $my_ip<br> server_proxyclient_address = $my_ip</font><br> [workarounds]<br> [wsgi]<br> [xenserver]<br> [xvp]<br> [zvm]</p> 
  </blockquote> 
  <h2><a id="Nova_342"></a>创建Nova相关的数据库及权限设定</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ mysql -u root -p
Enter password:
</code></pre> 
  <blockquote> 
   <p>Welcome to the MariaDB monitor. Commands end with ; or \g.<br> Your MariaDB connection id is 55<br> Server version: 10.1.20-MariaDB MariaDB Server<br> &nbsp;<br> Copyright © 2000, 2016, Oracle, MariaDB Corporation Ab and others.<br> &nbsp;<br> Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">create database nova_api;</font><br> Query OK, 1 row affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">create database nova;</font><br> Query OK, 1 row affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">create database nova_cell0;</font><br> Query OK, 1 row affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">create database placement;</font><br> Query OK, 1 row affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on nova_api.* to ‘nova’@‘localhost’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on nova_api.* to ‘nova’@’%’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on nova.* to ‘nova’@‘localhost’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on nova.* to ‘nova’@’%’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on nova_cell0.* to ‘nova’@‘localhost’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on nova_cell0.* to ‘nova’@’%’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt;<font color="red"> grant all privileges on placement.* to ‘placement’@‘localhost’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">grant all privileges on placement.* to ‘placement’@’%’ identified by ‘$password’;</font><br> Query OK, 0 rows affected (0.00 sec)<br> &nbsp;<br> MariaDB [(none)]&gt; <font color="red">quit</font><br> Bye</p> 
  </blockquote> 
  <h2><a id="Nova_APIPlacement_394"></a>初始化Nova API与Placement数据库</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage api_db sync"</span> nova
</code></pre> 
  <h2><a id="Nova_399"></a>初始化Nova数据库</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage db sync"</span> nova
</code></pre> 
  <blockquote> 
   <p><font color="red">WARNING: cell0 mapping not found - not syncing cell0.</font><br> /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index <code>block_device_mapping_instance_uuid_virtual_name_device_name_idx</code>. This is deprecated and will be disallowed in a future release.’)<br> result = self._query(query)<br> /usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: (1831, u’Duplicate index <code>uniq_instances0uuid</code>. This is deprecated and will be disallowed in a future release.’)<br> result = self._query(query)</p> 
  </blockquote> 
  <p><strong>注：第一次执行本步骤，可以忽略下面的注释</strong><br> <strong>后续步骤中 $sudo nova-status upgrade check 命令报错，又重新初始化了一次数据库，就没有第一个红色的Warning了。nova-status命令也正常执行了。具体原因待查。</strong></p> 
  <pre><code class="prism language-bash"><span class="token comment"># 命令出错</span>
<span class="token punctuation">[</span>tony@tony-controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> nova-status upgrade check
Error:
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"/usr/lib/python2.7/site-packages/nova/cmd/status.py"</span>, line 795, <span class="token keyword">in</span> main
    ret <span class="token operator">=</span> fn<span class="token punctuation">(</span>*fn_args, **fn_kwargs<span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/python2.7/site-packages/nova/cmd/status.py"</span>, line 725, <span class="token keyword">in</span> check
    result <span class="token operator">=</span> func<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/python2.7/site-packages/nova/cmd/status.py"</span>, line 206, <span class="token keyword">in</span> _check_placement
    versions <span class="token operator">=</span> self._placement_get<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/python2.7/site-packages/nova/cmd/status.py"</span>, line 196, <span class="token keyword">in</span> _placement_get
    <span class="token keyword">return</span> client.get<span class="token punctuation">(</span>path, raise_exc<span class="token operator">=</span>True<span class="token punctuation">)</span>.json<span class="token punctuation">(</span><span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py"</span>, line 328, <span class="token keyword">in</span> get
    <span class="token keyword">return</span> self.request<span class="token punctuation">(</span>url, <span class="token string">'GET'</span>, **kwargs<span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/python2.7/site-packages/keystoneauth1/adapter.py"</span>, line 213, <span class="token keyword">in</span> request
    <span class="token keyword">return</span> self.session.request<span class="token punctuation">(</span>url, method, **kwargs<span class="token punctuation">)</span>
  File <span class="token string">"/usr/lib/python2.7/site-packages/keystoneauth1/session.py"</span>, line 869, <span class="token keyword">in</span> request
    raise exceptions.from_response<span class="token punctuation">(</span>resp, method, url<span class="token punctuation">)</span>
InternalServerError: Internal Server Error <span class="token punctuation">(</span>HTTP 500<span class="token punctuation">)</span>

<span class="token comment"># 重新初始化数据库</span>
<span class="token punctuation">[</span>tony@tony-controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage api_db sync"</span> nova
<span class="token punctuation">[</span>tony@tony-controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage db sync"</span> nova

<span class="token comment"># 程序正常执行</span>
<span class="token punctuation">[</span>tony@tony-controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> nova-status upgrade check
+--------------------------------+
<span class="token operator">|</span> Upgrade Check Results          <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Cells v2                <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Placement API           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Resource Providers      <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Ironic Flavor Migration <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: API Service Version     <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Request Spec Migration  <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Console Auths           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
</code></pre> 
  <h2><a id="cell0_470"></a>注册cell0数据库</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage cell_v2 map_cell0"</span> nova
</code></pre> 
  <p><strong>注：在注册cell0数据库之后，重新初始化一下Nova数据库，也就没有第一个Warning了。</strong></p> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@tony-controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage db sync"</span> nova
/usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: <span class="token punctuation">(</span>1831, u<span class="token string">'Duplicate index <span class="token variable"><span class="token variable">`</span>block_device_mapping_instance_uuid_virtual_name_device_name_idx<span class="token variable">`</span></span>. This is deprecated and will be disallowed in a future release.'</span><span class="token punctuation">)</span>
  result <span class="token operator">=</span> self._query<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
/usr/lib/python2.7/site-packages/pymysql/cursors.py:170: Warning: <span class="token punctuation">(</span>1831, u<span class="token string">'Duplicate index <span class="token variable"><span class="token variable">`</span>uniq_instances0uuid<span class="token variable">`</span></span>. This is deprecated and will be disallowed in a future release.'</span><span class="token punctuation">)</span>
  result <span class="token operator">=</span> self._query<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
</code></pre> 
  <h2><a id="cell1_484"></a>创建cell1</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage cell_v2 create_cell --name=cell1 --verbose"</span> nova
c1a3197c-cbd1-4554-881b-f405ea4b1c74
</code></pre> 
  <h2><a id="cell0cell1_490"></a>验证cell0与cell1</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage cell_v2 list_cells"</span> nova
</code></pre> 
  <blockquote> 
   <p>±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+<br> | Name | UUID | Transport URL | Database Connection | Disabled |<br> ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+<br> | cell0 | 00000000-0000-0000-0000-000000000000 | none:/ | mysql+pymysql://nova:<strong><strong>@controller/nova_cell0 | False |<br> | cell1 | c1a3197c-cbd1-4554-881b-f405ea4b1c74 | rabbit://openstack:</strong></strong>@controller | mysql+pymysql://nova:****@controller/nova | False |<br> ±------±-------------------------------------±-----------------------------------±------------------------------------------------±---------+</p> 
  </blockquote> 
  <h2><a id="Placement_Web_Serverhttpd_501"></a>注册Placement Web Server到httpd</h2> 
  <ul> 
   <li>修改配置文件</li> 
  </ul> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">cat</span> /etc/httpd/conf.d/00-nova-placement-api.conf
</code></pre> 
  <blockquote> 
   <p>Listen 8778<br> &nbsp;<br> &lt;VirtualHost *:8778&gt;<br> WSGIProcessGroup nova-placement-api<br> WSGIApplicationGroup %{GLOBAL}<br> WSGIPassAuthorization On<br> WSGIDaemonProcess nova-placement-api processes=3 threads=1 user=nova group=nova<br> WSGIScriptAlias / /usr/bin/nova-placement-api<br> &lt;IfVersion &gt;= 2.4&gt;<br> ErrorLogFormat “%M”<br> &lt;/IfVersion&gt;<br> ErrorLog /var/log/nova/nova-placement-api.log<br> #SSLEngine On<br> #SSLCertificateFile …<br> #SSLCertificateKeyFile …<br> &nbsp;<br> <font color="red">&lt;Directory /usr/bin&gt;<br> &lt;IfVersion &gt;= 2.4&gt;<br> Require all granted<br> &lt;/IfVersion&gt;<br> &lt;IfVersion &lt; 2.4&gt;<br> Order allow, deny<br> Allow from all<br> &lt;/IfVersion&gt;<br> &lt;/Directory&gt;</font><br> &lt;/VirtualHost&gt;<br> &nbsp;<br> Alias /nova-placement-api /usr/bin/nova-placement-api<br> &lt;Location /nova-placement-api&gt;<br> SetHandler wsgi-script<br> Options +ExecCGI<br> WSGIProcessGroup nova-placement-api<br> WSGIApplicationGroup %{GLOBAL}<br> WSGIPassAuthorization On<br> &lt;/Location&gt;</p> 
  </blockquote> 
  <ul> 
   <li>重启httpd服务</li> 
  </ul> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl restart httpd
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl status httpd
● httpd.service - The Apache HTTP Server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/httpd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2019-04-08 03:01:19 EDT<span class="token punctuation">;</span> 8s ago
     Docs: man:httpd<span class="token punctuation">(</span>8<span class="token punctuation">)</span>
           man:apachectl<span class="token punctuation">(</span>8<span class="token punctuation">)</span>
  Process: 95486 ExecStop<span class="token operator">=</span>/bin/kill -WINCH <span class="token variable">${MAINPID}</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>
 Main PID: 95497 <span class="token punctuation">(</span>httpd<span class="token punctuation">)</span>
   Status: <span class="token string">"Processing requests..."</span>
   CGroup: /system.slice/httpd.service
           ├─95497 /usr/sbin/httpd -DFOREGROUND
           ├─95498 /usr/sbin/httpd -DFOREGROUND
           ├─95499 /usr/sbin/httpd -DFOREGROUND
           ├─95500 /usr/sbin/httpd -DFOREGROUND
           ├─95501 <span class="token punctuation">(</span>wsgi:keystone- -DFOREGROUND
           ├─95502 <span class="token punctuation">(</span>wsgi:keystone- -DFOREGROUND
           ├─95503 <span class="token punctuation">(</span>wsgi:keystone- -DFOREGROUND
           ├─95504 <span class="token punctuation">(</span>wsgi:keystone- -DFOREGROUND
           ├─95505 <span class="token punctuation">(</span>wsgi:keystone- -DFOREGROUND
           ├─95506 /usr/sbin/httpd -DFOREGROUND
           ├─95507 /usr/sbin/httpd -DFOREGROUND
           ├─95508 /usr/sbin/httpd -DFOREGROUND
           ├─95509 /usr/sbin/httpd -DFOREGROUND
           └─95510 /usr/sbin/httpd -DFOREGROUND

Apr 08 03:01:19 controller systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting The Apache HTTP Server<span class="token punctuation">..</span>.
Apr 08 03:01:19 controller systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started The Apache HTTP Server.
</code></pre> 
  <h2><a id="nova_573"></a>启动nova服务</h2> 
  <pre><code class="prism language-bash"><span class="token comment"># 启用服务</span>
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> openstack-nova-api.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-api.service to /usr/lib/systemd/system/openstack-nova-api.service.

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> openstack-nova-consoleauth
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-consoleauth.service to /usr/lib/systemd/system/openstack-nova-consoleauth.service.

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> openstack-nova-scheduler.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-scheduler.service to /usr/lib/systemd/system/openstack-nova-scheduler.service.

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> openstack-nova-conductor.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-conductor.service to /usr/lib/systemd/system/openstack-nova-conductor.service.

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> openstack-nova-novncproxy.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-novncproxy.service to /usr/lib/systemd/system/openstack-nova-novncproxy.service.

<span class="token comment"># 启动服务</span>
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl start openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service

<span class="token comment"># 检查服务状态</span>
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl status openstack-nova-api.service openstack-nova-consoleauth openstack-nova-scheduler.service openstack-nova-conductor.service openstack-nova-novncproxy.service
</code></pre> 
  <pre><code>● openstack-nova-api.service - OpenStack Nova API Server
   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-api.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2019-04-08 03:07:24 EDT; 7s ago
 Main PID: 96191 (nova-api)
   CGroup: /system.slice/openstack-nova-api.service
           ├─96191 /usr/bin/python2 /usr/bin/nova-api
           ├─96271 /usr/bin/python2 /usr/bin/nova-api
           ├─96272 /usr/bin/python2 /usr/bin/nova-api
           ├─96273 /usr/bin/python2 /usr/bin/nova-api
           ├─96274 /usr/bin/python2 /usr/bin/nova-api
           ├─96279 /usr/bin/python2 /usr/bin/nova-api
           ├─96281 /usr/bin/python2 /usr/bin/nova-api
           ├─96282 /usr/bin/python2 /usr/bin/nova-api
           └─96283 /usr/bin/python2 /usr/bin/nova-api

Apr 08 03:07:15 controller systemd[1]: Starting OpenStack Nova API Server...
Apr 08 03:07:24 controller systemd[1]: Started OpenStack Nova API Server.

● openstack-nova-consoleauth.service - OpenStack Nova VNC console auth Server
   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-consoleauth.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2019-04-08 03:07:19 EDT; 11s ago
 Main PID: 96192 (nova-consoleaut)
   CGroup: /system.slice/openstack-nova-consoleauth.service
           └─96192 /usr/bin/python2 /usr/bin/nova-consoleauth

Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova VNC console auth Server...
Apr 08 03:07:19 controller systemd[1]: Started OpenStack Nova VNC console auth Server.

● openstack-nova-scheduler.service - OpenStack Nova Scheduler Server
   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-scheduler.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2019-04-08 03:07:21 EDT; 9s ago
 Main PID: 96193 (nova-scheduler)
   CGroup: /system.slice/openstack-nova-scheduler.service
           ├─96193 /usr/bin/python2 /usr/bin/nova-scheduler
           ├─96258 /usr/bin/python2 /usr/bin/nova-scheduler
           ├─96259 /usr/bin/python2 /usr/bin/nova-scheduler
           ├─96260 /usr/bin/python2 /usr/bin/nova-scheduler
           └─96262 /usr/bin/python2 /usr/bin/nova-scheduler

Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Scheduler Server...
Apr 08 03:07:21 controller systemd[1]: Started OpenStack Nova Scheduler Server.

● openstack-nova-conductor.service - OpenStack Nova Conductor Server
   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-conductor.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2019-04-08 03:07:20 EDT; 10s ago
 Main PID: 96194 (nova-conductor)
   CGroup: /system.slice/openstack-nova-conductor.service
           ├─96194 /usr/bin/python2 /usr/bin/nova-conductor
           ├─96248 /usr/bin/python2 /usr/bin/nova-conductor
           ├─96250 /usr/bin/python2 /usr/bin/nova-conductor
           ├─96251 /usr/bin/python2 /usr/bin/nova-conductor
           └─96252 /usr/bin/python2 /usr/bin/nova-conductor

Apr 08 03:07:16 controller systemd[1]: Starting OpenStack Nova Conductor Server...
Apr 08 03:07:20 controller systemd[1]: Started OpenStack Nova Conductor Server.

● openstack-nova-novncproxy.service - OpenStack Nova NoVNC Proxy Server
   Loaded: loaded (/usr/lib/systemd/system/openstack-nova-novncproxy.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2019-04-08 03:07:16 EDT; 15s ago
 Main PID: 96195 (nova-novncproxy)
   CGroup: /system.slice/openstack-nova-novncproxy.service
           └─96195 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/

Apr 08 03:07:16 controller systemd[1]: Started OpenStack Nova NoVNC Proxy Server.
</code></pre> 
  <h2><a id="Nova_662"></a>验证Nova服务</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack compute <span class="token function">service</span> list
+----+------------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Binary           <span class="token operator">|</span> Host       <span class="token operator">|</span> Zone     <span class="token operator">|</span> Status  <span class="token operator">|</span> State <span class="token operator">|</span> Updated At                 <span class="token operator">|</span>
+----+------------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span>  1 <span class="token operator">|</span> nova-consoleauth <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T07:10:35.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  2 <span class="token operator">|</span> nova-conductor   <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T07:10:26.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  3 <span class="token operator">|</span> nova-scheduler   <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T07:10:27.000000 <span class="token operator">|</span>
+----+------------------+------------+----------+---------+-------+----------------------------+
</code></pre> 
  <h2><a id="novacompute_674"></a>部署nova-compute包</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> yum -y <span class="token function">install</span> openstack-nova-compute
</code></pre> 
  <h2><a id="_679"></a>修改配置文件</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">diff</span> /tmp/nova.origin.conf /tmp/nova.new.conf
6a7,8
<span class="token operator">&gt;</span> compute_driver <span class="token operator">=</span> libvirt.LibvirtDriver
<span class="token operator">&gt;</span> instances_path <span class="token operator">=</span> /var/lib/nova/instances
24a27,31
<span class="token operator">&gt;</span> <span class="token punctuation">[</span>vnc<span class="token punctuation">]</span>
<span class="token operator">&gt;</span> enabled <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token operator">&gt;</span> server_listen <span class="token operator">=</span> 0.0.0.0
<span class="token operator">&gt;</span> server_proxyclient_address <span class="token operator">=</span> <span class="token variable">$my_ip</span>
<span class="token operator">&gt;</span> novncproxy_base_url <span class="token operator">=</span> http://controller:6080/vnc_auto.html
42a50
<span class="token operator">&gt;</span> virt_type <span class="token operator">=</span> qemu
68a77
<span class="token operator">&gt;</span> connection <span class="token operator">=</span> mysql+pymysql://placement:<span class="token variable">$password@controller</span>/placement
</code></pre> 
  <ul> 
   <li>新的配置文件</li> 
  </ul> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">cat</span> /etc/nova/nova.conf <span class="token operator">|</span> <span class="token function">grep</span> -v -E  <span class="token string">'^$|^#'</span>
</code></pre> 
  <blockquote> 
   <p><font color="blue">[DEFAULT]</font><br> my_ip = 172.18.22.231<br> enabled_apis = osapi_compute,metadata<br> transport_url = rabbit://openstack:$password@controller<br> use_neutron = true<br> firewall_driver = nova.virt.firewall.NoopFirewallDriver<br> <font color="red"><strong>compute_driver = libvirt.LibvirtDriver<br> instances_path = /var/lib/nova/instances</strong></font><br> [api]<br> auth_strategy = keystone<br> [api_database]<br> connection = mysql+pymysql://nova:$password@controller/nova_api<br> [barbican]<br> …<br> [database]<br> connection = mysql+pymysql://nova:$password@controller/nova<br> [devices]<br> …<br> <strong><font color="blue">[vnc]</font><br> enabled = true<br> <font color="red">server_listen = 0.0.0.0</font><br> server_proxyclient_address = $my_ip<br> <font color="red">novncproxy_base_url = <a href="http://controller:6080/vnc_auto.html" rel="nofollow">http://controller:6080/vnc_auto.html</a></font></strong><br> [glance]<br> api_servers = <a href="http://controller:9292" rel="nofollow">http://controller:9292</a><br> [guestfs]<br> …<br> [keystone_authtoken]<br> auth_url = <a href="http://controller:5000/v3" rel="nofollow">http://controller:5000/v3</a><br> memcached_servers = controller:11211<br> auth_type = password<br> project_domain_name = default<br> user_domain_name = default<br> project_name = service<br> username = nova<br> password = $password<br> <font color="blue">[libvirt]</font><br> <font color="red"><strong>virt_type = qemu</strong></font><br> [matchmaker_redis]<br> …<br> [oslo_concurrency]<br> lock_path = /var/lib/nova/tmp<br> [oslo_messaging_amqp]<br> …<br> [pci]<br> [placement]<br> region_name = RegionOne<br> project_domain_name = Default<br> project_name = service<br> user_domain_name = Default<br> auth_type = password<br> auth_url = <a href="http://controller:5000/v3" rel="nofollow">http://controller:5000/v3</a><br> username = placement<br> password = $password<br> <font color="blue">[placement_database]</font><br> <font color="red"><strong>connection = mysql+pymysql://placement:$password@controller/placement</strong></font><br> [powervm]<br> …<br> [workarounds]</p> 
  </blockquote> 
  <h2><a id="_761"></a>启动服务</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> libvirtd.service openstack-nova-compute.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service.

<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl start libvirtd.service openstack-nova-compute.service
<span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl status libvirtd.service openstack-nova-compute.service
● libvirtd.service - Virtualization daemon
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/libvirtd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2019-04-08 03:41:40 EDT<span class="token punctuation">;</span> 9s ago
     Docs: man:libvirtd<span class="token punctuation">(</span>8<span class="token punctuation">)</span>
           https://libvirt.org
 Main PID: 102617 <span class="token punctuation">(</span>libvirtd<span class="token punctuation">)</span>
    Tasks: 17 <span class="token punctuation">(</span>limit: 32768<span class="token punctuation">)</span>
   CGroup: /system.slice/libvirtd.service
           └─102617 /usr/sbin/libvirtd

Apr 08 03:41:40 controller systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting Virtualization daemon<span class="token punctuation">..</span>.
Apr 08 03:41:40 controller systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started Virtualization daemon.

● openstack-nova-compute.service - OpenStack Nova Compute Server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/openstack-nova-compute.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2019-04-08 03:41:43 EDT<span class="token punctuation">;</span> 6s ago
 Main PID: 102635 <span class="token punctuation">(</span>nova-compute<span class="token punctuation">)</span>
    Tasks: 22
   CGroup: /system.slice/openstack-nova-compute.service
           └─102635 /usr/bin/python2 /usr/bin/nova-compute

Apr 08 03:41:40 controller systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting OpenStack Nova Compute Server<span class="token punctuation">..</span>.
Apr 08 03:41:43 controller systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started OpenStack Nova Compute Server.
</code></pre> 
  <h2><a id="Controller_NodeCell_793"></a>将Controller Node注册到Cell</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage cell_v2 discover_hosts --verbose"</span> nova
Found 2 cell mappings.
Skipping cell0 since it does not contain hosts.
Getting computes from cell <span class="token string">'cell1'</span><span class="token keyword">:</span> c1a3197c-cbd1-4554-881b-f405ea4b1c74
Checking host mapping <span class="token keyword">for</span> compute host <span class="token string">'controller'</span><span class="token keyword">:</span> 090c321b-7c7d-496f-bbcb-1f5360034cc8
Creating host mapping <span class="token keyword">for</span> compute host <span class="token string">'controller'</span><span class="token keyword">:</span> 090c321b-7c7d-496f-bbcb-1f5360034cc8
Found 1 unmapped computes <span class="token keyword">in</span> cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74
</code></pre> 
  <h2><a id="controllercompute_804"></a>验证controller机器上的compute服务</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ openstack compute <span class="token function">service</span> list
</code></pre> 
  <blockquote> 
   <p>±—±-----------------±-----------±---------±--------±------±---------------------------+<br> | ID | Binary | Host | Zone | Status | State | Updated At |<br> ±—±-----------------±-----------±---------±--------±------±---------------------------+<br> | 1 | nova-consoleauth | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 |<br> | 2 | nova-conductor | controller | internal | enabled | up | 2019-04-08T07:46:36.000000 |<br> | 3 | nova-scheduler | controller | internal | enabled | up | 2019-04-08T07:46:37.000000 |<br> <font color="red"><strong>| 7 | nova-compute | controller | nova | enabled | up | 2019-04-08T07:46:42.000000 |</strong></font><br> ±—±-----------------±-----------±---------±--------±------±---------------------------+</p> 
  </blockquote> 
  <h2><a id="cellsplacement_API_817"></a>验证cells和placement API正常工作</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@controller ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> nova-status upgrade check
+--------------------------------+
<span class="token operator">|</span> Upgrade Check Results          <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Cells v2                <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Placement API           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Resource Providers      <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Ironic Flavor Migration <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: API Service Version     <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Request Spec Migration  <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Console Auths           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
</code></pre> 
  <h1><a id="Nova_Compute_853"></a>Nova (Compute)</h1> 
  <h2><a id="_854"></a>关闭防火墙</h2> 
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl stop firewalld
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl disable firewalld
Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.
Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.
</code></pre> 
  <h2><a id="_861"></a>安装软件包</h2> 
  <pre><code class="prism language-bash"><span class="token comment"># 安装软件包</span>
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> yum <span class="token function">install</span> -y openstack-nova-compute

<span class="token comment"># 设置配置文件</span>
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">cp</span> /etc/nova/nova.conf  /etc/nova/nova.conf.origin
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> vim /etc/nova/nova.conf
<span class="token punctuation">[</span>DEFAULT<span class="token punctuation">]</span>
my_ip <span class="token operator">=</span> 172.18.22.232
enabled_apis <span class="token operator">=</span> osapi_compute,metadata
transport_url <span class="token operator">=</span> rabbit://openstack:<span class="token variable">$password@controller</span>
use_neutron <span class="token operator">=</span> <span class="token boolean">true</span>
firewall_driver <span class="token operator">=</span> nova.virt.firewall.NoopFirewallDriver
compute_driver <span class="token operator">=</span> libvirt.LibvirtDriver
instances_path <span class="token operator">=</span> /var/lib/nova/instances
<span class="token punctuation">[</span>api<span class="token punctuation">]</span>
auth_strategy <span class="token operator">=</span> keystone
<span class="token punctuation">[</span>api_database<span class="token punctuation">]</span>
connection <span class="token operator">=</span> mysql+pymysql://nova:<span class="token variable">$password@controller</span>/nova_api
<span class="token punctuation">[</span>barbican<span class="token punctuation">]</span>
<span class="token punctuation">[</span>cache<span class="token punctuation">]</span>
<span class="token punctuation">[</span>cells<span class="token punctuation">]</span>
<span class="token punctuation">[</span>cinder<span class="token punctuation">]</span>
<span class="token punctuation">[</span>compute<span class="token punctuation">]</span>
<span class="token punctuation">[</span>conductor<span class="token punctuation">]</span>
<span class="token punctuation">[</span>console<span class="token punctuation">]</span>
<span class="token punctuation">[</span>consoleauth<span class="token punctuation">]</span>
<span class="token punctuation">[</span>cors<span class="token punctuation">]</span>
<span class="token punctuation">[</span>database<span class="token punctuation">]</span>
connection <span class="token operator">=</span> mysql+pymysql://nova:<span class="token variable">$password@controller</span>/nova
<span class="token punctuation">[</span>devices<span class="token punctuation">]</span>
<span class="token punctuation">[</span>ephemeral_storage_encryption<span class="token punctuation">]</span>
<span class="token punctuation">[</span>filter_scheduler<span class="token punctuation">]</span>
<span class="token punctuation">[</span>glance<span class="token punctuation">]</span>
api_servers <span class="token operator">=</span> http://controller:9292
<span class="token punctuation">[</span>guestfs<span class="token punctuation">]</span>
<span class="token punctuation">[</span>healthcheck<span class="token punctuation">]</span>
<span class="token punctuation">[</span>hyperv<span class="token punctuation">]</span>
<span class="token punctuation">[</span>ironic<span class="token punctuation">]</span>
<span class="token punctuation">[</span>key_manager<span class="token punctuation">]</span>
<span class="token punctuation">[</span>keystone<span class="token punctuation">]</span>
<span class="token punctuation">[</span>keystone_authtoken<span class="token punctuation">]</span>
auth_url <span class="token operator">=</span> http://controller:5000/v3
memcached_servers <span class="token operator">=</span> controller:11211
auth_type <span class="token operator">=</span> password
project_domain_name <span class="token operator">=</span> default
user_domain_name <span class="token operator">=</span> default
project_name <span class="token operator">=</span> <span class="token function">service</span>
username <span class="token operator">=</span> nova
password <span class="token operator">=</span> <span class="token variable">$password</span>
<span class="token punctuation">[</span>libvirt<span class="token punctuation">]</span>
virt_type <span class="token operator">=</span> qemu
<span class="token punctuation">[</span>matchmaker_redis<span class="token punctuation">]</span>
<span class="token punctuation">[</span>metrics<span class="token punctuation">]</span>
<span class="token punctuation">[</span>mks<span class="token punctuation">]</span>
<span class="token punctuation">[</span>neutron<span class="token punctuation">]</span>
<span class="token punctuation">[</span>notifications<span class="token punctuation">]</span>
<span class="token punctuation">[</span>osapi_v21<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_concurrency<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_messaging_amqp<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_messaging_kafka<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_messaging_notifications<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_messaging_rabbit<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_messaging_zmq<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_middleware<span class="token punctuation">]</span>
<span class="token punctuation">[</span>oslo_policy<span class="token punctuation">]</span>
<span class="token punctuation">[</span>pci<span class="token punctuation">]</span>
<span class="token punctuation">[</span>placement<span class="token punctuation">]</span>
region_name <span class="token operator">=</span> RegionOne
project_domain_name <span class="token operator">=</span> Default
project_name <span class="token operator">=</span> <span class="token function">service</span>
user_domain_name <span class="token operator">=</span> Default
auth_type <span class="token operator">=</span> password
auth_url <span class="token operator">=</span> http://controller:5000/v3
username <span class="token operator">=</span> placement
password <span class="token operator">=</span> <span class="token variable">$password</span>
<span class="token punctuation">[</span>placement_database<span class="token punctuation">]</span>
connection <span class="token operator">=</span> mysql+pymysql://placement:<span class="token variable">$password@controller</span>/placement
<span class="token punctuation">[</span>powervm<span class="token punctuation">]</span>
<span class="token punctuation">[</span>profiler<span class="token punctuation">]</span>
<span class="token punctuation">[</span>quota<span class="token punctuation">]</span>
<span class="token punctuation">[</span>rdp<span class="token punctuation">]</span>
<span class="token punctuation">[</span>remote_debug<span class="token punctuation">]</span>
<span class="token punctuation">[</span>scheduler<span class="token punctuation">]</span>
<span class="token punctuation">[</span>serial_console<span class="token punctuation">]</span>
<span class="token punctuation">[</span>service_user<span class="token punctuation">]</span>
<span class="token punctuation">[</span>spice<span class="token punctuation">]</span>
<span class="token punctuation">[</span>upgrade_levels<span class="token punctuation">]</span>
<span class="token punctuation">[</span>vault<span class="token punctuation">]</span>
<span class="token punctuation">[</span>vendordata_dynamic_auth<span class="token punctuation">]</span>
<span class="token punctuation">[</span>vmware<span class="token punctuation">]</span>
<span class="token punctuation">[</span>vnc<span class="token punctuation">]</span>
enabled <span class="token operator">=</span> <span class="token boolean">true</span>
server_listen <span class="token operator">=</span> 0.0.0.0
server_proxyclient_address <span class="token operator">=</span> <span class="token variable">$my_ip</span>
novncproxy_base_url <span class="token operator">=</span> http://controller:6080/vnc_auto.html
<span class="token punctuation">[</span>workarounds<span class="token punctuation">]</span>
<span class="token punctuation">[</span>wsgi<span class="token punctuation">]</span>
<span class="token punctuation">[</span>xenserver<span class="token punctuation">]</span>
<span class="token punctuation">[</span>xvp<span class="token punctuation">]</span>
<span class="token punctuation">[</span>zvm<span class="token punctuation">]</span>

<span class="token comment"># 启用并启动服务</span>
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl <span class="token function">enable</span> libvirtd.service openstack-nova-compute.service
Created symlink from /etc/systemd/system/multi-user.target.wants/openstack-nova-compute.service to /usr/lib/systemd/system/openstack-nova-compute.service.

<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl start libvirtd.service openstack-nova-compute.service
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl status libvirtd.service openstack-nova-compute.service
● libvirtd.service - Virtualization daemon
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/libvirtd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2019-04-08 04:31:49 EDT<span class="token punctuation">;</span> 9s ago
     Docs: man:libvirtd<span class="token punctuation">(</span>8<span class="token punctuation">)</span>
           https://libvirt.org
 Main PID: 33687 <span class="token punctuation">(</span>libvirtd<span class="token punctuation">)</span>
    Tasks: 17 <span class="token punctuation">(</span>limit: 32768<span class="token punctuation">)</span>
   CGroup: /system.slice/libvirtd.service
           └─33687 /usr/sbin/libvirtd

Apr 08 04:31:49 compute systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting Virtualization daemon<span class="token punctuation">..</span>.
Apr 08 04:31:49 compute systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started Virtualization daemon.

● openstack-nova-compute.service - OpenStack Nova Compute Server
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/openstack-nova-compute.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2019-04-08 04:31:52 EDT<span class="token punctuation">;</span> 6s ago
 Main PID: 33705 <span class="token punctuation">(</span>nova-compute<span class="token punctuation">)</span>
    Tasks: 22
   CGroup: /system.slice/openstack-nova-compute.service
           └─33705 /usr/bin/python2 /usr/bin/nova-compute

Apr 08 04:31:49 compute systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting OpenStack Nova Compute Server<span class="token punctuation">..</span>.
Apr 08 04:31:52 compute systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started OpenStack Nova Compute Server.

<span class="token comment"># 注册</span>
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">su</span> -s /bin/sh -c <span class="token string">"nova-manage cell_v2 discover_hosts --verbose"</span> nova
Found 2 cell mappings.
Skipping cell0 since it does not contain hosts.
Getting computes from cell <span class="token string">'cell1'</span><span class="token keyword">:</span> c1a3197c-cbd1-4554-881b-f405ea4b1c74
Checking host mapping <span class="token keyword">for</span> compute host <span class="token string">'compute'</span><span class="token keyword">:</span> 005dfe34-54f3-4982-b2f8-43b81ae673fd
Creating host mapping <span class="token keyword">for</span> compute host <span class="token string">'compute'</span><span class="token keyword">:</span> 005dfe34-54f3-4982-b2f8-43b81ae673fd
Found 1 unmapped computes <span class="token keyword">in</span> cell: c1a3197c-cbd1-4554-881b-f405ea4b1c74

<span class="token comment"># 忘记设置admin鉴权信息了</span>
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ openstack compute <span class="token function">service</span> list
Missing value auth-url required <span class="token keyword">for</span> auth plugin password
<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ vim adminrc
<span class="token function">export</span> OS_PROJECT_DOMAIN_NAME<span class="token operator">=</span>Default
<span class="token function">export</span> OS_USER_DOMAIN_NAME<span class="token operator">=</span>Default
<span class="token function">export</span> OS_PROJECT_NAME<span class="token operator">=</span>admin
<span class="token function">export</span> OS_USERNAME<span class="token operator">=</span>admin
<span class="token function">export</span> OS_PASSWORD<span class="token operator">=</span><span class="token variable">$password</span>
<span class="token function">export</span> OS_AUTH_URL<span class="token operator">=</span>http://controller:5000/v3
<span class="token function">export</span> OS_IDENTITY_API_VERSION<span class="token operator">=</span>3
<span class="token function">export</span> OS_IMAGE_API_VERSION<span class="token operator">=</span>2

<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">source</span> adminrc

<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ openstack compute <span class="token function">service</span> list
+----+------------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span> ID <span class="token operator">|</span> Binary           <span class="token operator">|</span> Host       <span class="token operator">|</span> Zone     <span class="token operator">|</span> Status  <span class="token operator">|</span> State <span class="token operator">|</span> Updated At                 <span class="token operator">|</span>
+----+------------------+------------+----------+---------+-------+----------------------------+
<span class="token operator">|</span>  1 <span class="token operator">|</span> nova-consoleauth <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T08:33:17.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  2 <span class="token operator">|</span> nova-conductor   <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T08:33:21.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  3 <span class="token operator">|</span> nova-scheduler   <span class="token operator">|</span> controller <span class="token operator">|</span> internal <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T08:33:12.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  7 <span class="token operator">|</span> nova-compute     <span class="token operator">|</span> controller <span class="token operator">|</span> nova     <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T08:33:21.000000 <span class="token operator">|</span>
<span class="token operator">|</span>  8 <span class="token operator">|</span> nova-compute     <span class="token operator">|</span> compute    <span class="token operator">|</span> nova     <span class="token operator">|</span> enabled <span class="token operator">|</span> up    <span class="token operator">|</span> 2019-04-08T08:33:18.000000 <span class="token operator">|</span>
+----+------------------+------------+----------+---------+-------+----------------------------+

<span class="token punctuation">[</span>tony@compute ~<span class="token punctuation">]</span>$ <span class="token function">sudo</span> nova-status upgrade check
+--------------------------------+
<span class="token operator">|</span> Upgrade Check Results          <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Cells v2                <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Placement API           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Resource Providers      <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Ironic Flavor Migration <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: API Service Version     <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Request Spec Migration  <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
<span class="token operator">|</span> Check: Console Auths           <span class="token operator">|</span>
<span class="token operator">|</span> Result: Success                <span class="token operator">|</span>
<span class="token operator">|</span> Details: None                  <span class="token operator">|</span>
+--------------------------------+
</code></pre> 
  <h1><a id="_1063"></a>结语</h1> 
  <p>自此，controller与compute1机器上的nova模块安装成功。</p> 
  <p>第一篇：<a href="https://blog.csdn.net/qq_43401808/article/details/88991015" rel="nofollow">实录手动部署Openstack Rocky 双节点（1）- 基础服务</a><br> 上一篇：<a href="https://blog.csdn.net/qq_43401808/article/details/89082634" rel="nofollow">实录手动部署Openstack Rocky 双节点（3）- Glance</a><br> 下一篇：<a href="https://blog.csdn.net/qq_43401808/article/details/89282462" rel="nofollow">实录手动部署Openstack Rocky 双节点（5）- Neutron</a></p> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-258a4616f7.css" rel="stylesheet"> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
