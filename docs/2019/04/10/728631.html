<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>用JavaScript打造AI应用-从Nodejs SDK 看DuerOS的技能开发 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="用JavaScript打造AI应用-从Nodejs SDK 看DuerOS的技能开发" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="为什么要掌握JavaScript呢？ 使用JavaScript能能否开发AI应用么？ 答案是肯定的。 全栈语言JavaScript 就全栈编程语言而言，与python 并驾齐驱的要算是JavaScript了： 基于JavaScript的前端框架百花齐放，Vue、React、Angular都有广泛的应用； 桌面应用有NW.js(Node +webkit)，以及现在的Electron; 嵌入式系统中，也有着Espruino(被称为微控制器的 JavaScript),Tessel (一个集成了Wi-Fi的JavaScript 微处理器)以及国内的ruff.io，详见拙文《探索嵌入式应用框架（EAF）》； 后台服务基本上就是Nodejs的世界，有着丰富的工具集； 在人工智能领域，就机器学习而言，Javascript也有着诸多的开源框架，TensorFlow.js， Brain.js ， Synaptic.js等 ...... 关于JavaScript 的一些编程基础，可以参见《全栈必备JavaScript基础》。 那对于JavaScript的开发者如何开发人工智能相关的应用呢？ 这还是需要明确具体的应用场景，但是人工智能操作系统（可参见《感知人工智能操作系统》一文）的产生扩大了AI应用的领域。就对话式AI系统（例如DuerOS）而言，平台化更是Javascript开发者的福音。基于AI操作系统和开发平台，Javascript开发者可以更加高效地开发AI应用。 DuerOS 的 Nodejs 应用示例 关于DuerOS的详细介绍，可以参见《面向接口/协议？看DuerOS的技能开发》，当然对NLP的更多理解（可以参见《感知自然语言理解（NLU）》一文），对于开发对话式AI系统上的技能应用，是大有裨益的。DuerOS提供的Javascript支持是开发技能服务（Skill Bot）的SDK，采用npm加载 , 支持node.js 6.10及以上版本。 构建一个DuerOS的技能服务，一般如下步骤：&nbsp; 1）在DBP（DuerOS Bot Platform）创建并配置技能服务&nbsp; 2）构建基于Nodejs的开发环境 3）创建web服务及调用入口&nbsp; 4）编辑具体的业务逻辑&nbsp; 5）调试后发布技能服务 关于在DBP平台创建和配置技能，以及调试和发布技能，可以具体参见官网说明dueros.baidu.com/dbp。 环境构建 基于DuerOS的技能服务开发，基本上只需要安装Node，Javascript bot SDK，以及相应的httpserver模块例如express，koa等，就可以完成开发环境的搭建： cd /myworkspacemkdir js-bot-testcd js-bot-testnpm initnpm install express --savenpm install bot-sdk --save Web 服务入口 和Java 开发技能服务类似（参见《从Java SDK看DuerOS的技能开发》），需要创建一个服务启动的入口，在这里是index.js: const express = require(&#39;express&#39;);const Bot = require(&#39;./Bot&#39;);let myapp = express();myapp.post(&#39;/&#39;, (req, res) =&gt; { req.rawBody = &#39;&#39;; req.setEncoding(&#39;utf8&#39;); req.on(&#39;data&#39;, chunk =&gt; { req.rawBody += chunk; }); req.on(&#39;end&#39;, () =&gt; { let mybot = new Bot(JSON.parse(req.rawBody)); mybot.run().then(result =&gt; { res.send(result); }); });}).listen(8888); 使用express 构建了一个监听8888端口的web服务，完成与DuerOS平台之间的通信，在生产环境中，要增加证书的验证。 编写Bot的业务逻辑 最重要的，需要创建具体的技能服务，实现具体的业务逻辑，示例的Bot.js 文件组织结构如下： const BaseBot = require(&#39;bot-sdk&#39;);class Bot extends BaseBot { constructor(postData) { super(postData); //服务入口请求的处理 this.addLaunchHandler(() =&gt; { return { outputSpeech: &#39;欢迎使用!&#39; }; }); //相关意图处理 this.addIntentHandler(&#39;myintent1&#39;, () =&gt; { let targetSlot1 = this.getSlot(&#39;slot1&#39;); // 意图1 的逻辑处理以及槽位填充，return 相应的 directives 和 outspeech等 }); this.addIntentHandler(&#39;myintent1&#39;, () =&gt; { let targetSlot2 = this.getSlot(&#39;slot2&#39;); }); //事件处理 this.addEventListener（‘event1’，() =&gt; { //对于于事件1的相关处理，return 相应的 directives 和 outspeech等 }); //...... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 退出会话 this.addSessionEndedHandler(function({ // clear status // 清空状态，结束会话。 return null; }); } //其他业务逻辑的相关方法 主要的框架还是对话的开启和关闭，以及对意图和事件的处理。所有的逻辑处理函数的返回结果可以是json Object 也可以是Promise包裹的json Object。 至此，就可以运行服务来调试技能了，一旦验证完成，即可在DBP 发布自己的技能了。 DuerOS Javascript Bot SDK 代码浅析 “磨刀不误砍柴功”，理解JS Bot SDK的源代码，对基于Nodejs开发DuerOS的技能服务大有裨益。 在github上bot-sdk-node.js/lib/ 的目录下，是JS bot sdk 的核心代码，主要是6个文件： Bot.js Certificate.js NLU.js Request.js Response.js session.js NLU 模块 NLU 模块主要完成槽位的设置\获取\确认，以及通过ask（）方法完成槽位填充。同时，可以获取意图的名称并确认意图及确认意图状态。需要注意的是setDelegate（）方法的使用，只有在DBP平台完成了意图配置，setDelegate（）才有效，该方法只是将明确的意图判断交给了DuerOS代为处理。 Session 模块 正像《面向接口/协议？看DuerOS的技能开发》一文中指出的，Session 和浏览器中的cookie 非常类似，用于在客户端和服务器之间传递持久化数据。Javascript bot sdk 中的Session 模块主要提供了getData（）和setData（）两个方法，用于存储/读取key/value形式的数据。 Certificate 模块 安全性一直是DuerOS 平台所关注的一个重要方面，在DuerOS 与技能服务bot之间是安全通信，尽管在技能调试的时候可以关闭证书的验证。Certificate 模块通过enableVerifyRequestSign()方法开启验证请求参数签名，阻止非法请求， disableVerifyRequestSign()关闭验证请求参数签名，verifyRequest()验证发送请求者是否合法。 关于DBP 平台的安全性，可以以后专门研究讨论。 Request 模块 Request 模块完成了对DBP协议request 请求的封装，主要功能包括： 获取数据对象：getData()，getSession()，getNlu()&nbsp; 根据上下文获取终端状态信息和事件信息：getAudioPlayerContext()，getVideoPlayerContext()， getScreenContext() 和getEventData() 获取用户信息： getUserId()，getQuery()，getLocation() 获取应用信息： getBotId()，getApiAccessToken() ，getApiEndPoint() ，getExternalAccessTokens() 判断对话状态：isLaunchRequest() ，isSessionEndedRequest() ，isDialogStateCompleted()&nbsp; Response 模块 Response 模块完成了对DBP协议Response响应的封装，主要功能包括： 返回结果封装：buildResult(data)，buildResult(data)，defaultResult()是默认结果 对话相关：setShouldEndSession（）， 异常处理：illegalRequest()，setFallBack() 是兜底话术 麦克风控制： setExpectSpeech(expectSpeech) 设置指令次序：setAutoDirectivesArrangement（），setStrictDirectivesArrangement() 设置expectResponse：addExpectTextResponse(text)， addExpectSlotResponse(slot) expectResponse用于推测用户可能的回复，开发者的技能Bot在响应DuerOS请求时，可以添加expectResponse 信息，告诉DuerOS用户在下次交互时可能话术的某些关键词，DuerOS将在下一轮对话中提高语音识别能力，进而提高了意图的准确性，从而提高了用户使用该技能的用户体验。 还有一个语音播报相关的方法formatSpeech(mix) ，该方法自动识别SSML和纯文体，另外在extension 目录下还有还TTS相关的模块，以后可以对TTS和SSML做更多的探讨。 Bot模块 Bot 模块是所有技能bot的基类，实现了一个典型技能服务的基础功能和逻辑框架。Bot 类的构造函数如下： constructor(postData) { this.request = new Request(postData); this.session = this.request.getSession(); this.nlu = this.request.getNlu(); this.response = new Response(this.request, this.session, this.nlu); this._eventHandler = new Map(); this._intentHandler = new Map(); this.botMonitor = new BotMonitor(postData); } Bot的构造以request为参数，完成对request，NLU和Session的获取，生成Response对象，创建意图和事件的处理映射，并且构建了技能服务的监控器。 Bot 类中的主要方法分类如下： 对话相关：addLaunchHandler(handler) ，addSessionEndedHandler(handler) ，waitAnswer() ，endDialog()&nbsp; 意图相关：addIntentHandler(intent, handler)，getIntentName()，getSlot(field, index = 0)， setSlot(field, value, index = 0) 事件相关：addDefaultEventListener(handler) 安全相关：initCertificate(headers, body)，setPrivateKey(filename) 会话相关：endSession() ，getSessionAttribute(field = null, defaultValue = null)，setSessionAttribute(field, value, defaultValue = null)和setSessionAttribute(field, value, defaultValue = null)， 设备属性判断：isSupportDisplay()，isSupportAudioPlayer()，isSupportVideoPlayer()&nbsp; 对Response中expectResponse的封装：addExpectSlotResponse(slot) 应用相关，对request中的方法封装： getApiAccessToken()，getApiEndPoint() ，sendMateappNotification(data) 用户相关：getUserProfile()，getRecordSpeech(audioToken)，getDeviceLocation() Run（）方法是Bot 执行的主体，流程如下： 为了简洁起见，流程图中忽略了botMonitor的相关操作。 另外， Bot类中还实现了对音视频播放器指令，以及展示卡片和模版的处理。 Directive 指令实现 DuerOS JS Bot SDK 对DBP协议中的Directive指令实现了较为完整的封装。所有的指令都派生自BaseDirective类，指令的种类包括： 启动app指令 录音指令 支付指令 授权指令 音频播放器指令 视频播放器指令 显示指令及相关模版 指令相关源代码位于https://github.com/dueros/bot-sdk-node.js/tree/master/lib/directive。 展示模版和卡片 针对有屏设备，DuerOS Bot SDK 提供了较为丰富的展现模版和展示卡片。 展现模板分body template和list template两种类型。其中body template由图片和文字组成，list template由一系列list item组成，每个list item由图片和文字组成。不同的展现模板适合不同的场景，开发者可以根据技能展现的需求选择合适的模板。模版指令示意如下： { &quot;directives&quot;: [ { &quot;type&quot;: &quot;Display.RenderTemplate&quot;, &quot;template&quot;: { &quot;type&quot;: &quot;{{STRING}}&quot;, &quot;token&quot;: &quot;{{STRING}}&quot;, &quot;backgroundImage&quot;: {{ImageStructure}}, &quot;title&quot;: &quot;{{STRING}}&quot;, &quot;textContent&quot;: { &quot;position&quot;: &quot;{{ENUM}}&quot;, &quot;text&quot;: {{TextStructure}} } } } ]} 当技能服务回复用户的时候，可以通过使用卡片形式来展现更生动、丰富的内容。常用的展现卡片类型有文本卡片、标准卡片、标准列表卡片、图片卡片。展现卡片随Response消息一起发送给DuerOS。卡片在response中的json格式如下： &quot;card&quot;: { &quot;type&quot;:&quot;txt&quot;, &quot;token&quot;:&quot;{{STRING}}&quot;, &quot;content&quot;:&quot;{{STRING}}&quot;, &quot;url&quot;:&quot;{{STRING}}&quot;, &quot;anchorText&quot;: &quot;{{STRING}}&quot;, &quot;cueWords&quot;:[ &quot;{{STRING}}&quot;, &quot;{{STRING}}&quot;, &quot;{{STRING}}&quot;, ... ]} 针对展现模版和展示卡片，github上给出了比较详细的示例，在DuerOS官网上则给出了具体的布局示意例子。 示例代码 作为一个Javascript开发者，如果开发基于DuerOS的技能服务的话， 从示例代码开始往往是个不错的选择。在github上（https://github.com/dueros/bot-sdk-node.js/tree/master/samples），给出了10多个示例代码，有音乐播放的技能服务，个税计算器，历史上的今天等等。 其中的多个示例代码就是DBP官网上的技能模版，猜一猜是哪几个呢？ 参考资料： https://www.robinwieruch.de/machine-learning-javascript-web-developers/ https://github.com/dueros/bot-sdk-node.js https://dueros.baidu.com/dbp" />
<meta property="og:description" content="为什么要掌握JavaScript呢？ 使用JavaScript能能否开发AI应用么？ 答案是肯定的。 全栈语言JavaScript 就全栈编程语言而言，与python 并驾齐驱的要算是JavaScript了： 基于JavaScript的前端框架百花齐放，Vue、React、Angular都有广泛的应用； 桌面应用有NW.js(Node +webkit)，以及现在的Electron; 嵌入式系统中，也有着Espruino(被称为微控制器的 JavaScript),Tessel (一个集成了Wi-Fi的JavaScript 微处理器)以及国内的ruff.io，详见拙文《探索嵌入式应用框架（EAF）》； 后台服务基本上就是Nodejs的世界，有着丰富的工具集； 在人工智能领域，就机器学习而言，Javascript也有着诸多的开源框架，TensorFlow.js， Brain.js ， Synaptic.js等 ...... 关于JavaScript 的一些编程基础，可以参见《全栈必备JavaScript基础》。 那对于JavaScript的开发者如何开发人工智能相关的应用呢？ 这还是需要明确具体的应用场景，但是人工智能操作系统（可参见《感知人工智能操作系统》一文）的产生扩大了AI应用的领域。就对话式AI系统（例如DuerOS）而言，平台化更是Javascript开发者的福音。基于AI操作系统和开发平台，Javascript开发者可以更加高效地开发AI应用。 DuerOS 的 Nodejs 应用示例 关于DuerOS的详细介绍，可以参见《面向接口/协议？看DuerOS的技能开发》，当然对NLP的更多理解（可以参见《感知自然语言理解（NLU）》一文），对于开发对话式AI系统上的技能应用，是大有裨益的。DuerOS提供的Javascript支持是开发技能服务（Skill Bot）的SDK，采用npm加载 , 支持node.js 6.10及以上版本。 构建一个DuerOS的技能服务，一般如下步骤：&nbsp; 1）在DBP（DuerOS Bot Platform）创建并配置技能服务&nbsp; 2）构建基于Nodejs的开发环境 3）创建web服务及调用入口&nbsp; 4）编辑具体的业务逻辑&nbsp; 5）调试后发布技能服务 关于在DBP平台创建和配置技能，以及调试和发布技能，可以具体参见官网说明dueros.baidu.com/dbp。 环境构建 基于DuerOS的技能服务开发，基本上只需要安装Node，Javascript bot SDK，以及相应的httpserver模块例如express，koa等，就可以完成开发环境的搭建： cd /myworkspacemkdir js-bot-testcd js-bot-testnpm initnpm install express --savenpm install bot-sdk --save Web 服务入口 和Java 开发技能服务类似（参见《从Java SDK看DuerOS的技能开发》），需要创建一个服务启动的入口，在这里是index.js: const express = require(&#39;express&#39;);const Bot = require(&#39;./Bot&#39;);let myapp = express();myapp.post(&#39;/&#39;, (req, res) =&gt; { req.rawBody = &#39;&#39;; req.setEncoding(&#39;utf8&#39;); req.on(&#39;data&#39;, chunk =&gt; { req.rawBody += chunk; }); req.on(&#39;end&#39;, () =&gt; { let mybot = new Bot(JSON.parse(req.rawBody)); mybot.run().then(result =&gt; { res.send(result); }); });}).listen(8888); 使用express 构建了一个监听8888端口的web服务，完成与DuerOS平台之间的通信，在生产环境中，要增加证书的验证。 编写Bot的业务逻辑 最重要的，需要创建具体的技能服务，实现具体的业务逻辑，示例的Bot.js 文件组织结构如下： const BaseBot = require(&#39;bot-sdk&#39;);class Bot extends BaseBot { constructor(postData) { super(postData); //服务入口请求的处理 this.addLaunchHandler(() =&gt; { return { outputSpeech: &#39;欢迎使用!&#39; }; }); //相关意图处理 this.addIntentHandler(&#39;myintent1&#39;, () =&gt; { let targetSlot1 = this.getSlot(&#39;slot1&#39;); // 意图1 的逻辑处理以及槽位填充，return 相应的 directives 和 outspeech等 }); this.addIntentHandler(&#39;myintent1&#39;, () =&gt; { let targetSlot2 = this.getSlot(&#39;slot2&#39;); }); //事件处理 this.addEventListener（‘event1’，() =&gt; { //对于于事件1的相关处理，return 相应的 directives 和 outspeech等 }); //...... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 退出会话 this.addSessionEndedHandler(function({ // clear status // 清空状态，结束会话。 return null; }); } //其他业务逻辑的相关方法 主要的框架还是对话的开启和关闭，以及对意图和事件的处理。所有的逻辑处理函数的返回结果可以是json Object 也可以是Promise包裹的json Object。 至此，就可以运行服务来调试技能了，一旦验证完成，即可在DBP 发布自己的技能了。 DuerOS Javascript Bot SDK 代码浅析 “磨刀不误砍柴功”，理解JS Bot SDK的源代码，对基于Nodejs开发DuerOS的技能服务大有裨益。 在github上bot-sdk-node.js/lib/ 的目录下，是JS bot sdk 的核心代码，主要是6个文件： Bot.js Certificate.js NLU.js Request.js Response.js session.js NLU 模块 NLU 模块主要完成槽位的设置\获取\确认，以及通过ask（）方法完成槽位填充。同时，可以获取意图的名称并确认意图及确认意图状态。需要注意的是setDelegate（）方法的使用，只有在DBP平台完成了意图配置，setDelegate（）才有效，该方法只是将明确的意图判断交给了DuerOS代为处理。 Session 模块 正像《面向接口/协议？看DuerOS的技能开发》一文中指出的，Session 和浏览器中的cookie 非常类似，用于在客户端和服务器之间传递持久化数据。Javascript bot sdk 中的Session 模块主要提供了getData（）和setData（）两个方法，用于存储/读取key/value形式的数据。 Certificate 模块 安全性一直是DuerOS 平台所关注的一个重要方面，在DuerOS 与技能服务bot之间是安全通信，尽管在技能调试的时候可以关闭证书的验证。Certificate 模块通过enableVerifyRequestSign()方法开启验证请求参数签名，阻止非法请求， disableVerifyRequestSign()关闭验证请求参数签名，verifyRequest()验证发送请求者是否合法。 关于DBP 平台的安全性，可以以后专门研究讨论。 Request 模块 Request 模块完成了对DBP协议request 请求的封装，主要功能包括： 获取数据对象：getData()，getSession()，getNlu()&nbsp; 根据上下文获取终端状态信息和事件信息：getAudioPlayerContext()，getVideoPlayerContext()， getScreenContext() 和getEventData() 获取用户信息： getUserId()，getQuery()，getLocation() 获取应用信息： getBotId()，getApiAccessToken() ，getApiEndPoint() ，getExternalAccessTokens() 判断对话状态：isLaunchRequest() ，isSessionEndedRequest() ，isDialogStateCompleted()&nbsp; Response 模块 Response 模块完成了对DBP协议Response响应的封装，主要功能包括： 返回结果封装：buildResult(data)，buildResult(data)，defaultResult()是默认结果 对话相关：setShouldEndSession（）， 异常处理：illegalRequest()，setFallBack() 是兜底话术 麦克风控制： setExpectSpeech(expectSpeech) 设置指令次序：setAutoDirectivesArrangement（），setStrictDirectivesArrangement() 设置expectResponse：addExpectTextResponse(text)， addExpectSlotResponse(slot) expectResponse用于推测用户可能的回复，开发者的技能Bot在响应DuerOS请求时，可以添加expectResponse 信息，告诉DuerOS用户在下次交互时可能话术的某些关键词，DuerOS将在下一轮对话中提高语音识别能力，进而提高了意图的准确性，从而提高了用户使用该技能的用户体验。 还有一个语音播报相关的方法formatSpeech(mix) ，该方法自动识别SSML和纯文体，另外在extension 目录下还有还TTS相关的模块，以后可以对TTS和SSML做更多的探讨。 Bot模块 Bot 模块是所有技能bot的基类，实现了一个典型技能服务的基础功能和逻辑框架。Bot 类的构造函数如下： constructor(postData) { this.request = new Request(postData); this.session = this.request.getSession(); this.nlu = this.request.getNlu(); this.response = new Response(this.request, this.session, this.nlu); this._eventHandler = new Map(); this._intentHandler = new Map(); this.botMonitor = new BotMonitor(postData); } Bot的构造以request为参数，完成对request，NLU和Session的获取，生成Response对象，创建意图和事件的处理映射，并且构建了技能服务的监控器。 Bot 类中的主要方法分类如下： 对话相关：addLaunchHandler(handler) ，addSessionEndedHandler(handler) ，waitAnswer() ，endDialog()&nbsp; 意图相关：addIntentHandler(intent, handler)，getIntentName()，getSlot(field, index = 0)， setSlot(field, value, index = 0) 事件相关：addDefaultEventListener(handler) 安全相关：initCertificate(headers, body)，setPrivateKey(filename) 会话相关：endSession() ，getSessionAttribute(field = null, defaultValue = null)，setSessionAttribute(field, value, defaultValue = null)和setSessionAttribute(field, value, defaultValue = null)， 设备属性判断：isSupportDisplay()，isSupportAudioPlayer()，isSupportVideoPlayer()&nbsp; 对Response中expectResponse的封装：addExpectSlotResponse(slot) 应用相关，对request中的方法封装： getApiAccessToken()，getApiEndPoint() ，sendMateappNotification(data) 用户相关：getUserProfile()，getRecordSpeech(audioToken)，getDeviceLocation() Run（）方法是Bot 执行的主体，流程如下： 为了简洁起见，流程图中忽略了botMonitor的相关操作。 另外， Bot类中还实现了对音视频播放器指令，以及展示卡片和模版的处理。 Directive 指令实现 DuerOS JS Bot SDK 对DBP协议中的Directive指令实现了较为完整的封装。所有的指令都派生自BaseDirective类，指令的种类包括： 启动app指令 录音指令 支付指令 授权指令 音频播放器指令 视频播放器指令 显示指令及相关模版 指令相关源代码位于https://github.com/dueros/bot-sdk-node.js/tree/master/lib/directive。 展示模版和卡片 针对有屏设备，DuerOS Bot SDK 提供了较为丰富的展现模版和展示卡片。 展现模板分body template和list template两种类型。其中body template由图片和文字组成，list template由一系列list item组成，每个list item由图片和文字组成。不同的展现模板适合不同的场景，开发者可以根据技能展现的需求选择合适的模板。模版指令示意如下： { &quot;directives&quot;: [ { &quot;type&quot;: &quot;Display.RenderTemplate&quot;, &quot;template&quot;: { &quot;type&quot;: &quot;{{STRING}}&quot;, &quot;token&quot;: &quot;{{STRING}}&quot;, &quot;backgroundImage&quot;: {{ImageStructure}}, &quot;title&quot;: &quot;{{STRING}}&quot;, &quot;textContent&quot;: { &quot;position&quot;: &quot;{{ENUM}}&quot;, &quot;text&quot;: {{TextStructure}} } } } ]} 当技能服务回复用户的时候，可以通过使用卡片形式来展现更生动、丰富的内容。常用的展现卡片类型有文本卡片、标准卡片、标准列表卡片、图片卡片。展现卡片随Response消息一起发送给DuerOS。卡片在response中的json格式如下： &quot;card&quot;: { &quot;type&quot;:&quot;txt&quot;, &quot;token&quot;:&quot;{{STRING}}&quot;, &quot;content&quot;:&quot;{{STRING}}&quot;, &quot;url&quot;:&quot;{{STRING}}&quot;, &quot;anchorText&quot;: &quot;{{STRING}}&quot;, &quot;cueWords&quot;:[ &quot;{{STRING}}&quot;, &quot;{{STRING}}&quot;, &quot;{{STRING}}&quot;, ... ]} 针对展现模版和展示卡片，github上给出了比较详细的示例，在DuerOS官网上则给出了具体的布局示意例子。 示例代码 作为一个Javascript开发者，如果开发基于DuerOS的技能服务的话， 从示例代码开始往往是个不错的选择。在github上（https://github.com/dueros/bot-sdk-node.js/tree/master/samples），给出了10多个示例代码，有音乐播放的技能服务，个税计算器，历史上的今天等等。 其中的多个示例代码就是DBP官网上的技能模版，猜一猜是哪几个呢？ 参考资料： https://www.robinwieruch.de/machine-learning-javascript-web-developers/ https://github.com/dueros/bot-sdk-node.js https://dueros.baidu.com/dbp" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-10T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"为什么要掌握JavaScript呢？ 使用JavaScript能能否开发AI应用么？ 答案是肯定的。 全栈语言JavaScript 就全栈编程语言而言，与python 并驾齐驱的要算是JavaScript了： 基于JavaScript的前端框架百花齐放，Vue、React、Angular都有广泛的应用； 桌面应用有NW.js(Node +webkit)，以及现在的Electron; 嵌入式系统中，也有着Espruino(被称为微控制器的 JavaScript),Tessel (一个集成了Wi-Fi的JavaScript 微处理器)以及国内的ruff.io，详见拙文《探索嵌入式应用框架（EAF）》； 后台服务基本上就是Nodejs的世界，有着丰富的工具集； 在人工智能领域，就机器学习而言，Javascript也有着诸多的开源框架，TensorFlow.js， Brain.js ， Synaptic.js等 ...... 关于JavaScript 的一些编程基础，可以参见《全栈必备JavaScript基础》。 那对于JavaScript的开发者如何开发人工智能相关的应用呢？ 这还是需要明确具体的应用场景，但是人工智能操作系统（可参见《感知人工智能操作系统》一文）的产生扩大了AI应用的领域。就对话式AI系统（例如DuerOS）而言，平台化更是Javascript开发者的福音。基于AI操作系统和开发平台，Javascript开发者可以更加高效地开发AI应用。 DuerOS 的 Nodejs 应用示例 关于DuerOS的详细介绍，可以参见《面向接口/协议？看DuerOS的技能开发》，当然对NLP的更多理解（可以参见《感知自然语言理解（NLU）》一文），对于开发对话式AI系统上的技能应用，是大有裨益的。DuerOS提供的Javascript支持是开发技能服务（Skill Bot）的SDK，采用npm加载 , 支持node.js 6.10及以上版本。 构建一个DuerOS的技能服务，一般如下步骤：&nbsp; 1）在DBP（DuerOS Bot Platform）创建并配置技能服务&nbsp; 2）构建基于Nodejs的开发环境 3）创建web服务及调用入口&nbsp; 4）编辑具体的业务逻辑&nbsp; 5）调试后发布技能服务 关于在DBP平台创建和配置技能，以及调试和发布技能，可以具体参见官网说明dueros.baidu.com/dbp。 环境构建 基于DuerOS的技能服务开发，基本上只需要安装Node，Javascript bot SDK，以及相应的httpserver模块例如express，koa等，就可以完成开发环境的搭建： cd /myworkspacemkdir js-bot-testcd js-bot-testnpm initnpm install express --savenpm install bot-sdk --save Web 服务入口 和Java 开发技能服务类似（参见《从Java SDK看DuerOS的技能开发》），需要创建一个服务启动的入口，在这里是index.js: const express = require(&#39;express&#39;);const Bot = require(&#39;./Bot&#39;);let myapp = express();myapp.post(&#39;/&#39;, (req, res) =&gt; { req.rawBody = &#39;&#39;; req.setEncoding(&#39;utf8&#39;); req.on(&#39;data&#39;, chunk =&gt; { req.rawBody += chunk; }); req.on(&#39;end&#39;, () =&gt; { let mybot = new Bot(JSON.parse(req.rawBody)); mybot.run().then(result =&gt; { res.send(result); }); });}).listen(8888); 使用express 构建了一个监听8888端口的web服务，完成与DuerOS平台之间的通信，在生产环境中，要增加证书的验证。 编写Bot的业务逻辑 最重要的，需要创建具体的技能服务，实现具体的业务逻辑，示例的Bot.js 文件组织结构如下： const BaseBot = require(&#39;bot-sdk&#39;);class Bot extends BaseBot { constructor(postData) { super(postData); //服务入口请求的处理 this.addLaunchHandler(() =&gt; { return { outputSpeech: &#39;欢迎使用!&#39; }; }); //相关意图处理 this.addIntentHandler(&#39;myintent1&#39;, () =&gt; { let targetSlot1 = this.getSlot(&#39;slot1&#39;); // 意图1 的逻辑处理以及槽位填充，return 相应的 directives 和 outspeech等 }); this.addIntentHandler(&#39;myintent1&#39;, () =&gt; { let targetSlot2 = this.getSlot(&#39;slot2&#39;); }); //事件处理 this.addEventListener（‘event1’，() =&gt; { //对于于事件1的相关处理，return 相应的 directives 和 outspeech等 }); //...... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 退出会话 this.addSessionEndedHandler(function({ // clear status // 清空状态，结束会话。 return null; }); } //其他业务逻辑的相关方法 主要的框架还是对话的开启和关闭，以及对意图和事件的处理。所有的逻辑处理函数的返回结果可以是json Object 也可以是Promise包裹的json Object。 至此，就可以运行服务来调试技能了，一旦验证完成，即可在DBP 发布自己的技能了。 DuerOS Javascript Bot SDK 代码浅析 “磨刀不误砍柴功”，理解JS Bot SDK的源代码，对基于Nodejs开发DuerOS的技能服务大有裨益。 在github上bot-sdk-node.js/lib/ 的目录下，是JS bot sdk 的核心代码，主要是6个文件： Bot.js Certificate.js NLU.js Request.js Response.js session.js NLU 模块 NLU 模块主要完成槽位的设置\\获取\\确认，以及通过ask（）方法完成槽位填充。同时，可以获取意图的名称并确认意图及确认意图状态。需要注意的是setDelegate（）方法的使用，只有在DBP平台完成了意图配置，setDelegate（）才有效，该方法只是将明确的意图判断交给了DuerOS代为处理。 Session 模块 正像《面向接口/协议？看DuerOS的技能开发》一文中指出的，Session 和浏览器中的cookie 非常类似，用于在客户端和服务器之间传递持久化数据。Javascript bot sdk 中的Session 模块主要提供了getData（）和setData（）两个方法，用于存储/读取key/value形式的数据。 Certificate 模块 安全性一直是DuerOS 平台所关注的一个重要方面，在DuerOS 与技能服务bot之间是安全通信，尽管在技能调试的时候可以关闭证书的验证。Certificate 模块通过enableVerifyRequestSign()方法开启验证请求参数签名，阻止非法请求， disableVerifyRequestSign()关闭验证请求参数签名，verifyRequest()验证发送请求者是否合法。 关于DBP 平台的安全性，可以以后专门研究讨论。 Request 模块 Request 模块完成了对DBP协议request 请求的封装，主要功能包括： 获取数据对象：getData()，getSession()，getNlu()&nbsp; 根据上下文获取终端状态信息和事件信息：getAudioPlayerContext()，getVideoPlayerContext()， getScreenContext() 和getEventData() 获取用户信息： getUserId()，getQuery()，getLocation() 获取应用信息： getBotId()，getApiAccessToken() ，getApiEndPoint() ，getExternalAccessTokens() 判断对话状态：isLaunchRequest() ，isSessionEndedRequest() ，isDialogStateCompleted()&nbsp; Response 模块 Response 模块完成了对DBP协议Response响应的封装，主要功能包括： 返回结果封装：buildResult(data)，buildResult(data)，defaultResult()是默认结果 对话相关：setShouldEndSession（）， 异常处理：illegalRequest()，setFallBack() 是兜底话术 麦克风控制： setExpectSpeech(expectSpeech) 设置指令次序：setAutoDirectivesArrangement（），setStrictDirectivesArrangement() 设置expectResponse：addExpectTextResponse(text)， addExpectSlotResponse(slot) expectResponse用于推测用户可能的回复，开发者的技能Bot在响应DuerOS请求时，可以添加expectResponse 信息，告诉DuerOS用户在下次交互时可能话术的某些关键词，DuerOS将在下一轮对话中提高语音识别能力，进而提高了意图的准确性，从而提高了用户使用该技能的用户体验。 还有一个语音播报相关的方法formatSpeech(mix) ，该方法自动识别SSML和纯文体，另外在extension 目录下还有还TTS相关的模块，以后可以对TTS和SSML做更多的探讨。 Bot模块 Bot 模块是所有技能bot的基类，实现了一个典型技能服务的基础功能和逻辑框架。Bot 类的构造函数如下： constructor(postData) { this.request = new Request(postData); this.session = this.request.getSession(); this.nlu = this.request.getNlu(); this.response = new Response(this.request, this.session, this.nlu); this._eventHandler = new Map(); this._intentHandler = new Map(); this.botMonitor = new BotMonitor(postData); } Bot的构造以request为参数，完成对request，NLU和Session的获取，生成Response对象，创建意图和事件的处理映射，并且构建了技能服务的监控器。 Bot 类中的主要方法分类如下： 对话相关：addLaunchHandler(handler) ，addSessionEndedHandler(handler) ，waitAnswer() ，endDialog()&nbsp; 意图相关：addIntentHandler(intent, handler)，getIntentName()，getSlot(field, index = 0)， setSlot(field, value, index = 0) 事件相关：addDefaultEventListener(handler) 安全相关：initCertificate(headers, body)，setPrivateKey(filename) 会话相关：endSession() ，getSessionAttribute(field = null, defaultValue = null)，setSessionAttribute(field, value, defaultValue = null)和setSessionAttribute(field, value, defaultValue = null)， 设备属性判断：isSupportDisplay()，isSupportAudioPlayer()，isSupportVideoPlayer()&nbsp; 对Response中expectResponse的封装：addExpectSlotResponse(slot) 应用相关，对request中的方法封装： getApiAccessToken()，getApiEndPoint() ，sendMateappNotification(data) 用户相关：getUserProfile()，getRecordSpeech(audioToken)，getDeviceLocation() Run（）方法是Bot 执行的主体，流程如下： 为了简洁起见，流程图中忽略了botMonitor的相关操作。 另外， Bot类中还实现了对音视频播放器指令，以及展示卡片和模版的处理。 Directive 指令实现 DuerOS JS Bot SDK 对DBP协议中的Directive指令实现了较为完整的封装。所有的指令都派生自BaseDirective类，指令的种类包括： 启动app指令 录音指令 支付指令 授权指令 音频播放器指令 视频播放器指令 显示指令及相关模版 指令相关源代码位于https://github.com/dueros/bot-sdk-node.js/tree/master/lib/directive。 展示模版和卡片 针对有屏设备，DuerOS Bot SDK 提供了较为丰富的展现模版和展示卡片。 展现模板分body template和list template两种类型。其中body template由图片和文字组成，list template由一系列list item组成，每个list item由图片和文字组成。不同的展现模板适合不同的场景，开发者可以根据技能展现的需求选择合适的模板。模版指令示意如下： { &quot;directives&quot;: [ { &quot;type&quot;: &quot;Display.RenderTemplate&quot;, &quot;template&quot;: { &quot;type&quot;: &quot;{{STRING}}&quot;, &quot;token&quot;: &quot;{{STRING}}&quot;, &quot;backgroundImage&quot;: {{ImageStructure}}, &quot;title&quot;: &quot;{{STRING}}&quot;, &quot;textContent&quot;: { &quot;position&quot;: &quot;{{ENUM}}&quot;, &quot;text&quot;: {{TextStructure}} } } } ]} 当技能服务回复用户的时候，可以通过使用卡片形式来展现更生动、丰富的内容。常用的展现卡片类型有文本卡片、标准卡片、标准列表卡片、图片卡片。展现卡片随Response消息一起发送给DuerOS。卡片在response中的json格式如下： &quot;card&quot;: { &quot;type&quot;:&quot;txt&quot;, &quot;token&quot;:&quot;{{STRING}}&quot;, &quot;content&quot;:&quot;{{STRING}}&quot;, &quot;url&quot;:&quot;{{STRING}}&quot;, &quot;anchorText&quot;: &quot;{{STRING}}&quot;, &quot;cueWords&quot;:[ &quot;{{STRING}}&quot;, &quot;{{STRING}}&quot;, &quot;{{STRING}}&quot;, ... ]} 针对展现模版和展示卡片，github上给出了比较详细的示例，在DuerOS官网上则给出了具体的布局示意例子。 示例代码 作为一个Javascript开发者，如果开发基于DuerOS的技能服务的话， 从示例代码开始往往是个不错的选择。在github上（https://github.com/dueros/bot-sdk-node.js/tree/master/samples），给出了10多个示例代码，有音乐播放的技能服务，个税计算器，历史上的今天等等。 其中的多个示例代码就是DBP官网上的技能模版，猜一猜是哪几个呢？ 参考资料： https://www.robinwieruch.de/machine-learning-javascript-web-developers/ https://github.com/dueros/bot-sdk-node.js https://dueros.baidu.com/dbp","@type":"BlogPosting","url":"/2019/04/10/728631.html","headline":"用JavaScript打造AI应用-从Nodejs SDK 看DuerOS的技能开发","dateModified":"2019-04-10T00:00:00+08:00","datePublished":"2019-04-10T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/04/10/728631.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>用JavaScript打造AI应用-从Nodejs SDK 看DuerOS的技能开发</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">  
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="rich_media_content" id="js_content"> 
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">为什么要掌握JavaScript呢？ 使用JavaScript能能否开发AI应用么？</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">答案是肯定的。</p>
   <h3 style="font-weight:bold;font-size:18px;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">全栈语言JavaScript</h3>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">就全栈编程语言而言，与python 并驾齐驱的要算是JavaScript了：</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">基于JavaScript的前端框架百花齐放，Vue、React、Angular都有广泛的应用；</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">桌面应用有NW.js(Node +webkit)，以及现在的Electron;</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">嵌入式系统中，也有着Espruino(被称为微控制器的 JavaScript),Tessel (一个集成了Wi-Fi的JavaScript 微处理器)以及国内的ruff.io，详见拙文《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658972846&amp;idx=1&amp;sn=c14af87e9fffcc3d971ee2a492259824&amp;chksm=80d32988b7a4a09ed7281c8b384385e6e913a14d3c413f003a746726ae33a1f5b0ed607c0107&amp;scene=21#wechat_redirect" rel="nofollow">探索嵌入式应用框架（EAF）</a>》；</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">后台服务基本上就是Nodejs的世界，有着丰富的工具集；</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">在人工智能领域，就机器学习而言，Javascript也有着诸多的开源框架，TensorFlow.js， Brain.js ， Synaptic.js等</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">......</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">关于JavaScript 的一些编程基础，可以参见《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658971386&amp;idx=1&amp;sn=d5b529569c01a1f43b9629bea10542af&amp;chksm=80d333dcb7a4baca756bba381a6bbf47f34eb83326cdd4ebe36573984f67e5f53ff49801f3fc&amp;scene=21#wechat_redirect" rel="nofollow">全栈必备JavaScript基础</a>》。</p>
   <p style="text-align:center;"><img class="rich_pages" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/DE2dk1GjczqB1TsX9ibW8GkT7CKAXZHNgtKEicnoFrgRsT5v6BibJyfYGxqCe2qhWVXH4bvPrUbHicUTfeb59iaS1PQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">那对于JavaScript的开发者如何开发人工智能相关的应用呢？</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">这还是需要明确具体的应用场景，但是人工智能操作系统（可参见《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658974036&amp;idx=1&amp;sn=95c6ecf9a6462f06f2ce9dcba453e64b&amp;chksm=80d32472b7a4ad649ca242ff41116d46c95e9a49545d4dbc68470680f9e5684781ecda260ea9&amp;scene=21#wechat_redirect" rel="nofollow">感知人工智能操作系统</a>》一文）的产生扩大了AI应用的领域。就对话式AI系统（例如DuerOS）而言，平台化更是Javascript开发者的福音。基于AI操作系统和开发平台，Javascript开发者可以更加高效地开发AI应用。</p>
   <h3 style="font-weight:bold;font-size:18px;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">DuerOS 的 Nodejs 应用示例</h3>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">关于DuerOS的详细介绍，可以参见《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658974063&amp;idx=1&amp;sn=8d15d4d764f6237a359556e6714e7943&amp;chksm=80d32449b7a4ad5f43da9ce81a684d01795c2a8e40d27807dc036f661a9d7dadd2432e2cffd5&amp;scene=21#wechat_redirect" rel="nofollow">面向接口/协议？看DuerOS的技能开发</a>》，当然对NLP的更多理解（可以参见《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658974048&amp;idx=1&amp;sn=8890276ba789c43d295333f4d926f282&amp;chksm=80d32446b7a4ad502d94271f67c96c55371db52df85963367c0b65ec5dbfa77477ff56f30b81&amp;scene=21#wechat_redirect" rel="nofollow">感知自然语言理解（NLU）</a>》一文），对于开发对话式AI系统上的技能应用，是大有裨益的。DuerOS提供的Javascript支持是开发技能服务（Skill Bot）的SDK，采用npm加载 , 支持node.js 6.10及以上版本。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">构建一个DuerOS的技能服务，一般如下步骤：&nbsp;</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">1）在DBP（DuerOS Bot Platform）创建并配置技能服务&nbsp;</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">2）构建基于Nodejs的开发环境</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">3）创建web服务及调用入口&nbsp;</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">4）编辑具体的业务逻辑&nbsp;</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">5）调试后发布技能服务</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">关于在DBP平台创建和配置技能，以及调试和发布技能，可以具体参见<span style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">官网说明</span>dueros.baidu.com/dbp。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">环境构建</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">基于DuerOS的技能服务开发，基本上只需要安装Node，Javascript bot SDK，以及相应的httpserver模块例如express，koa等，就可以完成开发环境的搭建：</p>
   <pre style="border-width:1px;border-style:solid;border-color:rgb(204,204,204);font-size:13px;line-height:19px;"><code class="language-none" style="border-style:none;">cd /myworkspace<br>mkdir js-bot-test<br>cd js-bot-test<br>npm init<br>npm install express --save<br>npm install bot-sdk --save</code></pre>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Web 服务入口</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">和Java 开发技能服务类似（参见《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658974092&amp;idx=1&amp;sn=729894c83d899dda2659c57c1a34e4ea&amp;chksm=80d324aab7a4adbc33676269f5d63ce03a9ca633bb99c3d6a055e28c435fde993c9cd66cda0f&amp;scene=21#wechat_redirect" rel="nofollow">从Java SDK看DuerOS的技能开发</a>》），需要创建一个服务启动的入口，在这里是index.js:</p>
   <pre style="border-width:1px;border-style:solid;border-color:rgb(204,204,204);font-size:13px;line-height:19px;"><code class="language-none" style="border-style:none;">const express = require('express');<br><br>const Bot = require('./Bot');<br>let myapp = express();<br><br>myapp.post('/', (req, res) =&gt; {<br>    req.rawBody = '';<br><br>    req.setEncoding('utf8');<br>    req.on('data', chunk =&gt; {<br>        req.rawBody += chunk;<br>    });<br><br>    req.on('end', () =&gt; {<br>        let mybot = new Bot(JSON.parse(req.rawBody));<br><br>        mybot.run().then(result =&gt; {<br>            res.send(result);<br>        });<br>    });<br>}).listen(8888);<br></code></pre>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">使用express 构建了一个监听8888端口的web服务，完成与DuerOS平台之间的通信，在生产环境中，要增加证书的验证。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">编写Bot的业务逻辑</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">最重要的，需要创建具体的技能服务，实现具体的业务逻辑，示例的Bot.js 文件组织结构如下：</p>
   <pre style="border-width:1px;border-style:solid;border-color:rgb(204,204,204);font-size:13px;line-height:19px;"><code class="language-none" style="border-style:none;"><span style="font-size:12px;">const BaseBot = require('bot-sdk');<br>class Bot extends BaseBot {<br></span></code><code class="language-none" style="border-style:none;"><br><span style="font-size:12px;"> constructor(postData) {<br> super(postData);<br> //服务入口请求的处理<br> this.addLaunchHandler(() =&gt; {<br> return {<br> outputSpeech: '欢迎使用!'<br> };<br> });<br> //相关意图处理<br> this.addIntentHandler('myintent1', () =&gt; {<br> let targetSlot1 = this.getSlot('slot1');<br> // 意图1 的逻辑处理以及槽位填充，return 相应的 directives 和 outspeech等<br> }); <br> this.addIntentHandler('myintent1', () =&gt; {<br> let targetSlot2 = this.getSlot('slot2');<br> });<br> //事件处理<br> this.addEventListener（‘event1’，() =&gt; {<br> //对于于事件1的相关处理，return 相应的 directives 和 outspeech等<br> });<br></span></code></pre>
   <p><code class="language-none" style="border-style:none;"><span style="font-size:12px;"> //...... </span></code></p>
   <p><code class="language-none" style="border-style:none;"><span style="font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 退出会话<br> this.addSessionEndedHandler(function({<br> // clear status<br> // 清空状态，结束会话。 <br> return null; <br> });<br> }<br></span></code></p>
   <code class="language-none" style="border-style:none;"><span style="font-size:12px;"> //其他业务逻辑的相关方法</span></code>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">主要的框架还是对话的开启和关闭，以及对意图和事件的处理。所有的逻辑处理函数的返回结果可以是json Object 也可以是Promise包裹的json Object。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">至此，就可以运行服务来调试技能了，一旦验证完成，即可在DBP 发布自己的技能了。</p>
   <p style="text-align:center;"><img class="rich_pages" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/DE2dk1GjczqB1TsX9ibW8GkT7CKAXZHNgJCWh8MHvcPiaxYJ93Tr4WzqffZX2jsXb0NpHghLMv8uk4ibWQntneIVg/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <h3 style="font-weight:bold;font-size:18px;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">DuerOS Javascript Bot SDK 代码浅析</h3>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">“磨刀不误砍柴功”，理解JS Bot SDK的源代码，对基于Nodejs开发DuerOS的技能服务大有裨益。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">在github上bot-sdk-node.js/lib/ 的目录下，是JS bot sdk 的核心代码，主要是6个文件：</p>
   <ul class="list-paddingleft-2">
    <li><p><span style="font-size:14px;">Bot.js</span></p></li>
    <li><p><span style="font-size:14px;">Certificate.js</span></p></li>
    <li><p><span style="font-size:14px;">NLU.js</span></p></li>
    <li><p><span style="font-size:14px;">Request.js</span></p></li>
    <li><p><span style="font-size:14px;">Response.js</span></p></li>
    <li><p><span style="font-size:14px;">session.js</span></p></li>
   </ul>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">NLU 模块</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">NLU 模块主要完成槽位的设置\获取\确认，以及通过ask（）方法完成槽位填充。同时，可以获取意图的名称并确认意图及确认意图状态。需要注意的是setDelegate（）方法的使用，只有在DBP平台完成了意图配置，setDelegate（）才有效，该方法只是将明确的意图判断交给了DuerOS代为处理。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Session 模块</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">正像《<a href="http://mp.weixin.qq.com/s?__biz=MzAwOTcyNzA0OQ==&amp;mid=2658974063&amp;idx=1&amp;sn=8d15d4d764f6237a359556e6714e7943&amp;chksm=80d32449b7a4ad5f43da9ce81a684d01795c2a8e40d27807dc036f661a9d7dadd2432e2cffd5&amp;scene=21#wechat_redirect" rel="nofollow">面向接口/协议？看DuerOS的技能开发</a>》一文中指出的，Session 和浏览器中的cookie 非常类似，用于在客户端和服务器之间传递持久化数据。Javascript bot sdk 中的Session 模块主要提供了getData（）和setData（）两个方法，用于存储/读取key/value形式的数据。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Certificate 模块</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">安全性一直是DuerOS 平台所关注的一个重要方面，在DuerOS 与技能服务bot之间是安全通信，尽管在技能调试的时候可以关闭证书的验证。Certificate 模块通过enableVerifyRequestSign()方法开启验证请求参数签名，阻止非法请求， disableVerifyRequestSign()关闭验证请求参数签名，verifyRequest()验证发送请求者是否合法。 关于DBP 平台的安全性，可以以后专门研究讨论。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Request 模块</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">Request 模块完成了对DBP协议request 请求的封装，主要功能包括：</p>
   <ul class="list-paddingleft-2">
    <li><p style="text-align:left;"><span style="font-size:14px;">获取数据对象：getData()，getSession()，getNlu()&nbsp;</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">根据上下文获取终端状态信息和事件信息：getAudioPlayerContext()，getVideoPlayerContext()， getScreenContext() 和getEventData()</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">获取用户信息： getUserId()，getQuery()，getLocation()</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">获取应用信息： getBotId()，getApiAccessToken() ，getApiEndPoint() ，getExternalAccessTokens()</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">判断对话状态：isLaunchRequest() ，isSessionEndedRequest() ，isDialogStateCompleted()&nbsp;</span></p></li>
   </ul>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Response 模块</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">Response 模块完成了对DBP协议Response响应的封装，主要功能包括：</p>
   <ul class="list-paddingleft-2">
    <li><p style="text-align:left;"><span style="font-size:14px;">返回结果封装：buildResult(data)，buildResult(data)，defaultResult()是默认结果</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">对话相关：setShouldEndSession（），</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">异常处理：illegalRequest()，setFallBack() 是兜底话术</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">麦克风控制： setExpectSpeech(expectSpeech)</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">设置指令次序：setAutoDirectivesArrangement（），setStrictDirectivesArrangement()</span></p></li>
    <li><p style="text-align:left;"><span style="font-size:14px;">设置expectResponse：addExpectTextResponse(text)， addExpectSlotResponse(slot)</span></p></li>
   </ul>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">expectResponse用于推测用户可能的回复，开发者的技能Bot在响应DuerOS请求时，可以添加expectResponse 信息，告诉DuerOS用户在下次交互时可能话术的某些关键词，DuerOS将在下一轮对话中提高语音识别能力，进而提高了意图的准确性，从而提高了用户使用该技能的用户体验。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">还有一个语音播报相关的方法formatSpeech(mix) ，该方法自动识别SSML和纯文体，另外在extension 目录下还有还TTS相关的模块，以后可以对TTS和SSML做更多的探讨。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Bot模块</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">Bot 模块是所有技能bot的基类，实现了一个典型技能服务的基础功能和逻辑框架。Bot 类的构造函数如下：</p>
   <pre style="border-width:1px;border-style:solid;border-color:rgb(204,204,204);font-size:13px;line-height:19px;"><code class="language-none" style="border-style:none;"><span style="font-size:12px;">constructor(postData) {<br> this.request = new Request(postData);<br><br> this.session = this.request.getSession();<br><br> this.nlu = this.request.getNlu();<br> this.response = new Response(this.request, this.session, this.nlu);<br><br> this._eventHandler = new Map();<br> this._intentHandler = new Map();<br><br> this.botMonitor = new BotMonitor(postData);<br> }</span></code></pre>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">Bot的构造以request为参数，完成对request，NLU和Session的获取，生成Response对象，创建意图和事件的处理映射，并且构建了技能服务的监控器。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">Bot 类中的主要方法分类如下：</p>
   <ul class="list-paddingleft-2">
    <li><p><span style="font-size:14px;">对话相关：addLaunchHandler(handler) ，addSessionEndedHandler(handler) ，waitAnswer() ，endDialog()&nbsp;</span></p></li>
    <li><p><span style="font-size:14px;">意图相关：addIntentHandler(intent, handler)，getIntentName()，getSlot(field, index = 0)， setSlot(field, value, index = 0)</span></p></li>
    <li><p><span style="font-size:14px;">事件相关：addDefaultEventListener(handler)</span></p></li>
    <li><p><span style="font-size:14px;">安全相关：initCertificate(headers, body)，setPrivateKey(filename)</span></p></li>
    <li><p><span style="font-size:14px;">会话相关：endSession() ，getSessionAttribute(field = null, defaultValue = null)，setSessionAttribute(field, value, defaultValue = null)和setSessionAttribute(field, value, defaultValue = null)，</span></p></li>
    <li><p><span style="font-size:14px;">设备属性判断：isSupportDisplay()，isSupportAudioPlayer()，isSupportVideoPlayer()&nbsp;</span></p></li>
    <li><p><span style="font-size:14px;">对Response中expectResponse的封装：addExpectSlotResponse(slot)</span></p></li>
    <li><p><span style="font-size:14px;">应用相关，对request中的方法封装： getApiAccessToken()，getApiEndPoint() ，sendMateappNotification(data)</span></p></li>
    <li><p><span style="font-size:14px;">用户相关：getUserProfile()，getRecordSpeech(audioToken)，getDeviceLocation()</span></p></li>
   </ul>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">Run（）方法是Bot 执行的主体，流程如下：</p>
   <p style="text-align:center;"><img class="rich_pages" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/DE2dk1GjczqB1TsX9ibW8GkT7CKAXZHNgzsxKibN6cSuWnnBwH1myVMXOSWaFSZSGs2YXicCLa3wBCB2490zaBV2A/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">为了简洁起见，流程图中忽略了botMonitor的相关操作。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">另外， Bot类中还实现了对音视频播放器指令，以及展示卡片和模版的处理。</p>
   <h4 style="font-weight:bold;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">Directive 指令实现</h4>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">DuerOS JS Bot SDK 对DBP协议中的Directive指令实现了较为完整的封装。所有的指令都派生自BaseDirective类，指令的种类包括：</p>
   <ul class="list-paddingleft-2">
    <li><p><span style="font-size:14px;">启动app指令</span></p></li>
    <li><p><span style="font-size:14px;">录音指令</span></p></li>
    <li><p><span style="font-size:14px;">支付指令</span></p></li>
    <li><p><span style="font-size:14px;">授权指令</span></p></li>
    <li><p><span style="font-size:14px;">音频播放器指令</span></p></li>
    <li><p><span style="font-size:14px;">视频播放器指令</span></p></li>
    <li><p><span style="font-size:14px;">显示指令及相关模版</span></p></li>
   </ul>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">指令相关源代码位于https://github.com/dueros/bot-sdk-node.js/tree/master/lib/directive。</p>
   <p style="text-align:center;"><img class="rich_pages" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/DE2dk1GjczqB1TsX9ibW8GkT7CKAXZHNgjXUCA1k0xViciaubjedicqC8tqvOxsUs7Pv0oC25Oj8fwkq3lW12jvI2w/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <h3 style="font-weight:bold;font-size:18px;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">展示模版和卡片</h3>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">针对有屏设备，DuerOS Bot SDK 提供了较为丰富的展现模版和展示卡片。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">展现模板分body template和list template两种类型。其中body template由图片和文字组成，list template由一系列list item组成，每个list item由图片和文字组成。不同的展现模板适合不同的场景，开发者可以根据技能展现的需求选择合适的模板。模版指令示意如下：</p>
   <pre style="border-width:1px;border-style:solid;border-color:rgb(204,204,204);font-size:13px;line-height:19px;"><code class="language-none" style="border-style:none;"><span style="font-size:12px;">{<br> "directives": [<br> {<br> "type": "Display.RenderTemplate",<br> "template": {<br> "type": "{{STRING}}",<br> "token": "{{STRING}}", <br> "backgroundImage": {{ImageStructure}},<br> "title": "{{STRING}}",<br> "textContent": {<br> "position": "{{ENUM}}",<br> "text": {{TextStructure}}<br> }<br> }<br> }<br> ]<br>}</span></code></pre>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">当技能服务回复用户的时候，可以通过使用卡片形式来展现更生动、丰富的内容。常用的展现卡片类型有文本卡片、标准卡片、标准列表卡片、图片卡片。展现卡片随Response消息一起发送给DuerOS。卡片在response中的json格式如下：</p>
   <pre style="border-width:1px;border-style:solid;border-color:rgb(204,204,204);font-size:13px;line-height:19px;"><code class="language-none" style="border-style:none;"><span style="font-size:12px;">"card": {<br> "type":"txt",<br> "token":"{{STRING}}",<br> "content":"{{STRING}}",<br> "url":"{{STRING}}",<br> "anchorText": "{{STRING}}",<br> "cueWords":[<br> "{{STRING}}",<br> "{{STRING}}",<br> "{{STRING}}",<br> ...<br> ]<br>}</span></code></pre>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">针对展现模版和展示卡片，github上给出了比较详细的示例，在DuerOS官网上则给出了具体的布局示意例子。</p>
   <h3 style="font-weight:bold;font-size:18px;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">示例代码</h3>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">作为一个Javascript开发者，如果开发基于DuerOS的技能服务的话， 从示例代码开始往往是个不错的选择。在github上（https://github.com/dueros/bot-sdk-node.js/tree/master/samples），给出了10多个示例代码，有音乐播放的技能服务，个税计算器，历史上的今天等等。</p>
   <p style="color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;font-size:14px;">其中的多个示例代码就是DBP官网上的技能模版，猜一猜是哪几个呢？</p>
   <p style="text-align:center;"><img class="rich_pages" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/DE2dk1GjczqB1TsX9ibW8GkT7CKAXZHNgByjickHhnZZLCek1lINxS6KZeGFwHorC7dglrgIrecTrsy8aMDCbXBA/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <h5 style="font-weight:bold;font-size:14px;color:rgb(0,0,0);font-family:Helvetica, arial, sans-serif;">参考资料：</h5>
   <ul class="list-paddingleft-2">
    <li><p><span style="font-size:12px;">https://www.robinwieruch.de/machine-learning-javascript-web-developers/</span></p></li>
    <li><p><span style="font-size:12px;">https://github.com/dueros/bot-sdk-node.js</span></p></li>
    <li><p><span style="font-size:12px;">https://dueros.baidu.com/dbp</span></p></li>
   </ul>
   <p><br></p> 
  </div> 
 </div> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
