<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>MapReduce应用案例6：二度好友发现 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="MapReduce应用案例6：二度好友发现" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1.应用场景 二度好友发现在社交网络中大量使用，QQ、微博、微信、社交网站等经常会推荐添加好友，其依据就是用户之间的好友关系。 几个概念： 一度好友是你的好友 二度好友是好友的好友，二度好友发现是社交网络关系发现中的重要问题。 从数据库设计的角度出发，即所谓的第三范式，尽量避免冗余，好友关系的表结构一般被设计为“用户-好友”，且一般用id来描述关系。如 user friend A B B C A D D C C D E F E A E B B D 二度好友关系发现的即找到A、C的共同好友B、D，找到二度好友关系后就可以根据共同好友的多少给相应的用户推荐好友了。 注：有些文章把好友关系的数据结构描述成“A:B,C,D,F,E”，这是已经预处理的结果，一般不会直接这么存储。 2.实现分析 （1）数据预处理 场景描述中的数据，如果是设计良好的数据表结构，A和B是好友，则代表着B和A也是好友，但有很大可能在实际业务过程中造成了好友关系表中同时维护了A-B和B-A，而其他好友关系则是单向关系，这就为数据分析带来了一定的麻烦，针对这一问题，我们可以在数据预处理阶段先对双向关系进行数据去重，只保留单向关系，然后统一输出双向关系。结果如 A B B A B C C B A D D A C D D C E F F E E A A E E B B E B D D B （2）数据分析 a.首先找到每个用户的所有好友，即以用户为Key进行聚合，产生“（用户，（友，友，友，…））”的中间结果，输出如： A:E,D,B B:D,E,A,C C:D,B D:B,A,C E:A,B,F F:E b.循环地对上一步输出的每对关系中的“（友，友，友，…）”两两配对进行输出“（（友-友），用户）”，Mapper之后由Shuffle机制合并成“（（友-友），（用户，用户，用户，…））”的结果，在Reducer中按照将聚合结果后循环输出即可实现。输出结果 A-B 2:E D A-C 2:D B A-D 1:B A-E 1:B A-F 1:E B-C 1:D B-D 2:C A B-E 1:A B-F 1:E C-D 1:B C-E 1:B D-E 2:A B 3.关键代码分析 3.1数据去重 使用组合键对A-B、B-A进行去重，对象O1（A-B）跟对象O2（B-A）使用compareTo方法比较时返回0，其他情况不相等即可。 public int compareTo(RelationKey o) { if (o.b.equals(a) &amp;&amp; o.a.equals(b)) { return 0; } return 1; } 3.2二度好友两两匹配 根据用户聚合后，两两匹配输出二度好友关系。 /** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */ static class FriendMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;:&quot;); String user = words[0]; String[] friends = words[1].split(&quot;,&quot;); //排序：避免出现A-B、B-A重复输出的情况 Arrays.sort(friends); //循环两两匹配 for (int i = 0; i &lt; friends.length - 1; i++) { for (int j = i + 1; j &lt; friends.length; j++) { context.write(new Text(friends[i] + &quot;-&quot; + friends[j]), new Text(user)); } } } } 4.完整代码 完整代码见：https://github.com/majxbear/mapreduce-applications 4.1预处理：数据去重 4.1.1组合键定义 /** * 好友关系组合键，用于去重 */ public class RelationKey implements WritableComparable&lt;RelationKey&gt; { private String a; private String b; /** * 默认构造方法必须有，否则会报&lt;init&gt;失败 * java.lang.NoSuchMethodException: .&lt;init&gt;() */ public RelationKey() { } public RelationKey(String a, String b) { this.a = a; this.b = b; } public String getA() { return a; } public void setA(String a) { this.a = a; } public String getB() { return b; } public void setB(String b) { this.b = b; } public void write(DataOutput dataOutput) throws IOException { dataOutput.writeUTF(a); dataOutput.writeUTF(b); } public void readFields(DataInput dataInput) throws IOException { a = dataInput.readUTF(); b = dataInput.readUTF(); } @Override public int hashCode() { return a.hashCode() + b.hashCode(); } @Override public boolean equals(Object obj) { if (obj instanceof RelationKey) { RelationKey k = (RelationKey) obj; return k.a == a &amp;&amp; k.b == b; } return false; } public int compareTo(RelationKey o) { if (o.b.equals(a) &amp;&amp; o.a.equals(b)) { return 0; } return 1; } } 4.1.2 数据去重实现 /** * 去除好友关系中的重复关系 * A C * C A * 只保留一份 * */ public class FriendClean { static class CleanMapper extends Mapper&lt;Object, Text, RelationKey, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { context.write(new RelationKey(value.toString().split(&quot; &quot;)[0], value.toString().split(&quot; &quot;)[1]), new Text(&quot;&quot;)); } } static class CleanReducer extends Reducer&lt;RelationKey, Text, Text, Text&gt; { @Override protected void reduce(RelationKey key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { context.write(new Text(key.getA()), new Text(key.getB())); context.write(new Text(key.getB()), new Text(key.getA())); } } public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException { if (args.length &lt; 2) { System.out.println(&quot;参数不足&quot;); System.exit(1); } String inputPath = args[0]; String outputPath = args[1]; Configuration conf = new Configuration(); Job job = Job.getInstance(conf); job.setJarByClass(FriendClean.class); job.setMapperClass(CleanMapper.class); job.setCombinerClass(CleanReducer.class); job.setReducerClass(CleanReducer.class); job.setMapOutputKeyClass(RelationKey.class); job.setMapOutputValueClass(Text.class); job.setOutputKeyClass(Text.class); job.setOutputValueClass(Text.class); FileInputFormat.setInputPaths(job, new Path(inputPath)); FileOutputFormat.setOutputPath(job, new Path(outputPath)); job.waitForCompletion(true); } } 4.2分析阶段 /** * 数据格式如下 * A B * B C * A D * D C * 输出A-C 2:B,D * 业务场景：二度好友发现，A和B的共同好友有几个，都是谁 */ public class CommonFriends { static class RelationMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;\\s&quot;); //原样输出 context.write(new Text(words[0].trim()), new Text(words[1].trim())); } } static class RelationReducer extends Reducer&lt;Text, Text, Text, Text&gt; { @Override protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { List&lt;Text&gt; friends = new ArrayList&lt;Text&gt;(); for (Text val : values) { friends.add(new Text(val.toString())); } StringBuilder builder = new StringBuilder(); for (Text f : friends) { builder.append(f.toString()).append(&quot;,&quot;); } //去除末尾的, builder = new StringBuilder(builder.substring(0, builder.length() - 1)); context.write(new Text(key.toString() + &quot;:&quot; + builder.toString()), null); } } /** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */ static class FriendMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;:&quot;); String user = words[0]; String[] friends = words[1].split(&quot;,&quot;); //排序：避免出现A-B、B-A重复输出的情况 Arrays.sort(friends); //循环两两匹配 for (int i = 0; i &lt; friends.length - 1; i++) { for (int j = i + 1; j &lt; friends.length; j++) { context.write(new Text(friends[i] + &quot;-&quot; + friends[j]), new Text(user)); } } } } static class FriendReducer extends Reducer&lt;Text, Text, Text, Text&gt; { @Override protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { int count = 0; StringBuilder builder = new StringBuilder(); for (Text val : values) { count += 1; builder.append(val.toString()).append(&quot; &quot;); } //去除末尾的空格 builder = new StringBuilder(builder.substring(0, builder.length() - 1)); String output = key + &quot; &quot; + count + &quot;:&quot; + builder.toString(); context.write(new Text(output), null); } } public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException { if (args.length &lt; AppConstants.PARAMS_MIN_2) { System.out.println(&quot;参数不足&quot;); System.exit(1); } String inputPath = args[0]; String outputPath = args[1]; String tempPath = &quot;tmp&quot;; Configuration conf = new Configuration(); //job1 Job job = Job.getInstance(conf); job.setJobName(&quot;relation analysis&quot;); job.setJarByClass(CommonFriends.class); job.setMapperClass(CommonFriends.RelationMapper.class); job.setReducerClass(CommonFriends.RelationReducer.class); job.setMapOutputKeyClass(Text.class); job.setMapOutputValueClass(Text.class); job.setOutputValueClass(Text.class); job.setOutputKeyClass(Text.class); FileInputFormat.setInputPaths(job, new Path(inputPath)); FileOutputFormat.setOutputPath(job, new Path(tempPath)); job.waitForCompletion(true); //job2 聚合 Job job2 = Job.getInstance(conf); job2.setJobName(&quot;relation analysis&quot;); job2.setJarByClass(CommonFriends.class); job2.setMapperClass(FriendMapper.class); job2.setReducerClass(FriendReducer.class); job2.setMapOutputKeyClass(Text.class); job2.setMapOutputValueClass(Text.class); job2.setOutputValueClass(Text.class); job2.setOutputKeyClass(Text.class); //在实际生产环境中，如果文件较多，会使用HDFS的合并api将其合并，存放在hdfs的指定目录下供本阶段使用 FileInputFormat.setInputPaths(job2, new Path(tempPath + &quot;/part-r-00000&quot;)); FileOutputFormat.setOutputPath(job2, new Path(outputPath)); job2.waitForCompletion(true); } }" />
<meta property="og:description" content="1.应用场景 二度好友发现在社交网络中大量使用，QQ、微博、微信、社交网站等经常会推荐添加好友，其依据就是用户之间的好友关系。 几个概念： 一度好友是你的好友 二度好友是好友的好友，二度好友发现是社交网络关系发现中的重要问题。 从数据库设计的角度出发，即所谓的第三范式，尽量避免冗余，好友关系的表结构一般被设计为“用户-好友”，且一般用id来描述关系。如 user friend A B B C A D D C C D E F E A E B B D 二度好友关系发现的即找到A、C的共同好友B、D，找到二度好友关系后就可以根据共同好友的多少给相应的用户推荐好友了。 注：有些文章把好友关系的数据结构描述成“A:B,C,D,F,E”，这是已经预处理的结果，一般不会直接这么存储。 2.实现分析 （1）数据预处理 场景描述中的数据，如果是设计良好的数据表结构，A和B是好友，则代表着B和A也是好友，但有很大可能在实际业务过程中造成了好友关系表中同时维护了A-B和B-A，而其他好友关系则是单向关系，这就为数据分析带来了一定的麻烦，针对这一问题，我们可以在数据预处理阶段先对双向关系进行数据去重，只保留单向关系，然后统一输出双向关系。结果如 A B B A B C C B A D D A C D D C E F F E E A A E E B B E B D D B （2）数据分析 a.首先找到每个用户的所有好友，即以用户为Key进行聚合，产生“（用户，（友，友，友，…））”的中间结果，输出如： A:E,D,B B:D,E,A,C C:D,B D:B,A,C E:A,B,F F:E b.循环地对上一步输出的每对关系中的“（友，友，友，…）”两两配对进行输出“（（友-友），用户）”，Mapper之后由Shuffle机制合并成“（（友-友），（用户，用户，用户，…））”的结果，在Reducer中按照将聚合结果后循环输出即可实现。输出结果 A-B 2:E D A-C 2:D B A-D 1:B A-E 1:B A-F 1:E B-C 1:D B-D 2:C A B-E 1:A B-F 1:E C-D 1:B C-E 1:B D-E 2:A B 3.关键代码分析 3.1数据去重 使用组合键对A-B、B-A进行去重，对象O1（A-B）跟对象O2（B-A）使用compareTo方法比较时返回0，其他情况不相等即可。 public int compareTo(RelationKey o) { if (o.b.equals(a) &amp;&amp; o.a.equals(b)) { return 0; } return 1; } 3.2二度好友两两匹配 根据用户聚合后，两两匹配输出二度好友关系。 /** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */ static class FriendMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;:&quot;); String user = words[0]; String[] friends = words[1].split(&quot;,&quot;); //排序：避免出现A-B、B-A重复输出的情况 Arrays.sort(friends); //循环两两匹配 for (int i = 0; i &lt; friends.length - 1; i++) { for (int j = i + 1; j &lt; friends.length; j++) { context.write(new Text(friends[i] + &quot;-&quot; + friends[j]), new Text(user)); } } } } 4.完整代码 完整代码见：https://github.com/majxbear/mapreduce-applications 4.1预处理：数据去重 4.1.1组合键定义 /** * 好友关系组合键，用于去重 */ public class RelationKey implements WritableComparable&lt;RelationKey&gt; { private String a; private String b; /** * 默认构造方法必须有，否则会报&lt;init&gt;失败 * java.lang.NoSuchMethodException: .&lt;init&gt;() */ public RelationKey() { } public RelationKey(String a, String b) { this.a = a; this.b = b; } public String getA() { return a; } public void setA(String a) { this.a = a; } public String getB() { return b; } public void setB(String b) { this.b = b; } public void write(DataOutput dataOutput) throws IOException { dataOutput.writeUTF(a); dataOutput.writeUTF(b); } public void readFields(DataInput dataInput) throws IOException { a = dataInput.readUTF(); b = dataInput.readUTF(); } @Override public int hashCode() { return a.hashCode() + b.hashCode(); } @Override public boolean equals(Object obj) { if (obj instanceof RelationKey) { RelationKey k = (RelationKey) obj; return k.a == a &amp;&amp; k.b == b; } return false; } public int compareTo(RelationKey o) { if (o.b.equals(a) &amp;&amp; o.a.equals(b)) { return 0; } return 1; } } 4.1.2 数据去重实现 /** * 去除好友关系中的重复关系 * A C * C A * 只保留一份 * */ public class FriendClean { static class CleanMapper extends Mapper&lt;Object, Text, RelationKey, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { context.write(new RelationKey(value.toString().split(&quot; &quot;)[0], value.toString().split(&quot; &quot;)[1]), new Text(&quot;&quot;)); } } static class CleanReducer extends Reducer&lt;RelationKey, Text, Text, Text&gt; { @Override protected void reduce(RelationKey key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { context.write(new Text(key.getA()), new Text(key.getB())); context.write(new Text(key.getB()), new Text(key.getA())); } } public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException { if (args.length &lt; 2) { System.out.println(&quot;参数不足&quot;); System.exit(1); } String inputPath = args[0]; String outputPath = args[1]; Configuration conf = new Configuration(); Job job = Job.getInstance(conf); job.setJarByClass(FriendClean.class); job.setMapperClass(CleanMapper.class); job.setCombinerClass(CleanReducer.class); job.setReducerClass(CleanReducer.class); job.setMapOutputKeyClass(RelationKey.class); job.setMapOutputValueClass(Text.class); job.setOutputKeyClass(Text.class); job.setOutputValueClass(Text.class); FileInputFormat.setInputPaths(job, new Path(inputPath)); FileOutputFormat.setOutputPath(job, new Path(outputPath)); job.waitForCompletion(true); } } 4.2分析阶段 /** * 数据格式如下 * A B * B C * A D * D C * 输出A-C 2:B,D * 业务场景：二度好友发现，A和B的共同好友有几个，都是谁 */ public class CommonFriends { static class RelationMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;\\s&quot;); //原样输出 context.write(new Text(words[0].trim()), new Text(words[1].trim())); } } static class RelationReducer extends Reducer&lt;Text, Text, Text, Text&gt; { @Override protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { List&lt;Text&gt; friends = new ArrayList&lt;Text&gt;(); for (Text val : values) { friends.add(new Text(val.toString())); } StringBuilder builder = new StringBuilder(); for (Text f : friends) { builder.append(f.toString()).append(&quot;,&quot;); } //去除末尾的, builder = new StringBuilder(builder.substring(0, builder.length() - 1)); context.write(new Text(key.toString() + &quot;:&quot; + builder.toString()), null); } } /** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */ static class FriendMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;:&quot;); String user = words[0]; String[] friends = words[1].split(&quot;,&quot;); //排序：避免出现A-B、B-A重复输出的情况 Arrays.sort(friends); //循环两两匹配 for (int i = 0; i &lt; friends.length - 1; i++) { for (int j = i + 1; j &lt; friends.length; j++) { context.write(new Text(friends[i] + &quot;-&quot; + friends[j]), new Text(user)); } } } } static class FriendReducer extends Reducer&lt;Text, Text, Text, Text&gt; { @Override protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { int count = 0; StringBuilder builder = new StringBuilder(); for (Text val : values) { count += 1; builder.append(val.toString()).append(&quot; &quot;); } //去除末尾的空格 builder = new StringBuilder(builder.substring(0, builder.length() - 1)); String output = key + &quot; &quot; + count + &quot;:&quot; + builder.toString(); context.write(new Text(output), null); } } public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException { if (args.length &lt; AppConstants.PARAMS_MIN_2) { System.out.println(&quot;参数不足&quot;); System.exit(1); } String inputPath = args[0]; String outputPath = args[1]; String tempPath = &quot;tmp&quot;; Configuration conf = new Configuration(); //job1 Job job = Job.getInstance(conf); job.setJobName(&quot;relation analysis&quot;); job.setJarByClass(CommonFriends.class); job.setMapperClass(CommonFriends.RelationMapper.class); job.setReducerClass(CommonFriends.RelationReducer.class); job.setMapOutputKeyClass(Text.class); job.setMapOutputValueClass(Text.class); job.setOutputValueClass(Text.class); job.setOutputKeyClass(Text.class); FileInputFormat.setInputPaths(job, new Path(inputPath)); FileOutputFormat.setOutputPath(job, new Path(tempPath)); job.waitForCompletion(true); //job2 聚合 Job job2 = Job.getInstance(conf); job2.setJobName(&quot;relation analysis&quot;); job2.setJarByClass(CommonFriends.class); job2.setMapperClass(FriendMapper.class); job2.setReducerClass(FriendReducer.class); job2.setMapOutputKeyClass(Text.class); job2.setMapOutputValueClass(Text.class); job2.setOutputValueClass(Text.class); job2.setOutputKeyClass(Text.class); //在实际生产环境中，如果文件较多，会使用HDFS的合并api将其合并，存放在hdfs的指定目录下供本阶段使用 FileInputFormat.setInputPaths(job2, new Path(tempPath + &quot;/part-r-00000&quot;)); FileOutputFormat.setOutputPath(job2, new Path(outputPath)); job2.waitForCompletion(true); } }" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-06T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"1.应用场景 二度好友发现在社交网络中大量使用，QQ、微博、微信、社交网站等经常会推荐添加好友，其依据就是用户之间的好友关系。 几个概念： 一度好友是你的好友 二度好友是好友的好友，二度好友发现是社交网络关系发现中的重要问题。 从数据库设计的角度出发，即所谓的第三范式，尽量避免冗余，好友关系的表结构一般被设计为“用户-好友”，且一般用id来描述关系。如 user friend A B B C A D D C C D E F E A E B B D 二度好友关系发现的即找到A、C的共同好友B、D，找到二度好友关系后就可以根据共同好友的多少给相应的用户推荐好友了。 注：有些文章把好友关系的数据结构描述成“A:B,C,D,F,E”，这是已经预处理的结果，一般不会直接这么存储。 2.实现分析 （1）数据预处理 场景描述中的数据，如果是设计良好的数据表结构，A和B是好友，则代表着B和A也是好友，但有很大可能在实际业务过程中造成了好友关系表中同时维护了A-B和B-A，而其他好友关系则是单向关系，这就为数据分析带来了一定的麻烦，针对这一问题，我们可以在数据预处理阶段先对双向关系进行数据去重，只保留单向关系，然后统一输出双向关系。结果如 A B B A B C C B A D D A C D D C E F F E E A A E E B B E B D D B （2）数据分析 a.首先找到每个用户的所有好友，即以用户为Key进行聚合，产生“（用户，（友，友，友，…））”的中间结果，输出如： A:E,D,B B:D,E,A,C C:D,B D:B,A,C E:A,B,F F:E b.循环地对上一步输出的每对关系中的“（友，友，友，…）”两两配对进行输出“（（友-友），用户）”，Mapper之后由Shuffle机制合并成“（（友-友），（用户，用户，用户，…））”的结果，在Reducer中按照将聚合结果后循环输出即可实现。输出结果 A-B 2:E D A-C 2:D B A-D 1:B A-E 1:B A-F 1:E B-C 1:D B-D 2:C A B-E 1:A B-F 1:E C-D 1:B C-E 1:B D-E 2:A B 3.关键代码分析 3.1数据去重 使用组合键对A-B、B-A进行去重，对象O1（A-B）跟对象O2（B-A）使用compareTo方法比较时返回0，其他情况不相等即可。 public int compareTo(RelationKey o) { if (o.b.equals(a) &amp;&amp; o.a.equals(b)) { return 0; } return 1; } 3.2二度好友两两匹配 根据用户聚合后，两两匹配输出二度好友关系。 /** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */ static class FriendMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;:&quot;); String user = words[0]; String[] friends = words[1].split(&quot;,&quot;); //排序：避免出现A-B、B-A重复输出的情况 Arrays.sort(friends); //循环两两匹配 for (int i = 0; i &lt; friends.length - 1; i++) { for (int j = i + 1; j &lt; friends.length; j++) { context.write(new Text(friends[i] + &quot;-&quot; + friends[j]), new Text(user)); } } } } 4.完整代码 完整代码见：https://github.com/majxbear/mapreduce-applications 4.1预处理：数据去重 4.1.1组合键定义 /** * 好友关系组合键，用于去重 */ public class RelationKey implements WritableComparable&lt;RelationKey&gt; { private String a; private String b; /** * 默认构造方法必须有，否则会报&lt;init&gt;失败 * java.lang.NoSuchMethodException: .&lt;init&gt;() */ public RelationKey() { } public RelationKey(String a, String b) { this.a = a; this.b = b; } public String getA() { return a; } public void setA(String a) { this.a = a; } public String getB() { return b; } public void setB(String b) { this.b = b; } public void write(DataOutput dataOutput) throws IOException { dataOutput.writeUTF(a); dataOutput.writeUTF(b); } public void readFields(DataInput dataInput) throws IOException { a = dataInput.readUTF(); b = dataInput.readUTF(); } @Override public int hashCode() { return a.hashCode() + b.hashCode(); } @Override public boolean equals(Object obj) { if (obj instanceof RelationKey) { RelationKey k = (RelationKey) obj; return k.a == a &amp;&amp; k.b == b; } return false; } public int compareTo(RelationKey o) { if (o.b.equals(a) &amp;&amp; o.a.equals(b)) { return 0; } return 1; } } 4.1.2 数据去重实现 /** * 去除好友关系中的重复关系 * A C * C A * 只保留一份 * */ public class FriendClean { static class CleanMapper extends Mapper&lt;Object, Text, RelationKey, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { context.write(new RelationKey(value.toString().split(&quot; &quot;)[0], value.toString().split(&quot; &quot;)[1]), new Text(&quot;&quot;)); } } static class CleanReducer extends Reducer&lt;RelationKey, Text, Text, Text&gt; { @Override protected void reduce(RelationKey key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { context.write(new Text(key.getA()), new Text(key.getB())); context.write(new Text(key.getB()), new Text(key.getA())); } } public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException { if (args.length &lt; 2) { System.out.println(&quot;参数不足&quot;); System.exit(1); } String inputPath = args[0]; String outputPath = args[1]; Configuration conf = new Configuration(); Job job = Job.getInstance(conf); job.setJarByClass(FriendClean.class); job.setMapperClass(CleanMapper.class); job.setCombinerClass(CleanReducer.class); job.setReducerClass(CleanReducer.class); job.setMapOutputKeyClass(RelationKey.class); job.setMapOutputValueClass(Text.class); job.setOutputKeyClass(Text.class); job.setOutputValueClass(Text.class); FileInputFormat.setInputPaths(job, new Path(inputPath)); FileOutputFormat.setOutputPath(job, new Path(outputPath)); job.waitForCompletion(true); } } 4.2分析阶段 /** * 数据格式如下 * A B * B C * A D * D C * 输出A-C 2:B,D * 业务场景：二度好友发现，A和B的共同好友有几个，都是谁 */ public class CommonFriends { static class RelationMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;\\\\s&quot;); //原样输出 context.write(new Text(words[0].trim()), new Text(words[1].trim())); } } static class RelationReducer extends Reducer&lt;Text, Text, Text, Text&gt; { @Override protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { List&lt;Text&gt; friends = new ArrayList&lt;Text&gt;(); for (Text val : values) { friends.add(new Text(val.toString())); } StringBuilder builder = new StringBuilder(); for (Text f : friends) { builder.append(f.toString()).append(&quot;,&quot;); } //去除末尾的, builder = new StringBuilder(builder.substring(0, builder.length() - 1)); context.write(new Text(key.toString() + &quot;:&quot; + builder.toString()), null); } } /** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */ static class FriendMapper extends Mapper&lt;Object, Text, Text, Text&gt; { @Override protected void map(Object key, Text value, Context context) throws IOException, InterruptedException { String[] words = value.toString().split(&quot;:&quot;); String user = words[0]; String[] friends = words[1].split(&quot;,&quot;); //排序：避免出现A-B、B-A重复输出的情况 Arrays.sort(friends); //循环两两匹配 for (int i = 0; i &lt; friends.length - 1; i++) { for (int j = i + 1; j &lt; friends.length; j++) { context.write(new Text(friends[i] + &quot;-&quot; + friends[j]), new Text(user)); } } } } static class FriendReducer extends Reducer&lt;Text, Text, Text, Text&gt; { @Override protected void reduce(Text key, Iterable&lt;Text&gt; values, Context context) throws IOException, InterruptedException { int count = 0; StringBuilder builder = new StringBuilder(); for (Text val : values) { count += 1; builder.append(val.toString()).append(&quot; &quot;); } //去除末尾的空格 builder = new StringBuilder(builder.substring(0, builder.length() - 1)); String output = key + &quot; &quot; + count + &quot;:&quot; + builder.toString(); context.write(new Text(output), null); } } public static void main(String[] args) throws IOException, ClassNotFoundException, InterruptedException { if (args.length &lt; AppConstants.PARAMS_MIN_2) { System.out.println(&quot;参数不足&quot;); System.exit(1); } String inputPath = args[0]; String outputPath = args[1]; String tempPath = &quot;tmp&quot;; Configuration conf = new Configuration(); //job1 Job job = Job.getInstance(conf); job.setJobName(&quot;relation analysis&quot;); job.setJarByClass(CommonFriends.class); job.setMapperClass(CommonFriends.RelationMapper.class); job.setReducerClass(CommonFriends.RelationReducer.class); job.setMapOutputKeyClass(Text.class); job.setMapOutputValueClass(Text.class); job.setOutputValueClass(Text.class); job.setOutputKeyClass(Text.class); FileInputFormat.setInputPaths(job, new Path(inputPath)); FileOutputFormat.setOutputPath(job, new Path(tempPath)); job.waitForCompletion(true); //job2 聚合 Job job2 = Job.getInstance(conf); job2.setJobName(&quot;relation analysis&quot;); job2.setJarByClass(CommonFriends.class); job2.setMapperClass(FriendMapper.class); job2.setReducerClass(FriendReducer.class); job2.setMapOutputKeyClass(Text.class); job2.setMapOutputValueClass(Text.class); job2.setOutputValueClass(Text.class); job2.setOutputKeyClass(Text.class); //在实际生产环境中，如果文件较多，会使用HDFS的合并api将其合并，存放在hdfs的指定目录下供本阶段使用 FileInputFormat.setInputPaths(job2, new Path(tempPath + &quot;/part-r-00000&quot;)); FileOutputFormat.setOutputPath(job2, new Path(outputPath)); job2.waitForCompletion(true); } }","@type":"BlogPosting","url":"/2019/04/06/728613.html","headline":"MapReduce应用案例6：二度好友发现","dateModified":"2019-04-06T00:00:00+08:00","datePublished":"2019-04-06T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2019/04/06/728613.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>MapReduce应用案例6：二度好友发现</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div id="content_views" class="markdown_views prism-github-gist"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <h2><a id="1_0"></a>1.应用场景</h2> 
  <p>二度好友发现在社交网络中大量使用，QQ、微博、微信、社交网站等经常会推荐添加好友，其依据就是用户之间的好友关系。<br> <img src="https://uzshare.com/_p?https://img-blog.csdnimg.cn/20190405223315175.jpg#pic_center" alt="在这里插入图片描述"><br> 几个概念：</p> 
  <blockquote> 
   <p>一度好友是你的好友<br> 二度好友是好友的好友，二度好友发现是社交网络关系发现中的重要问题。<br> 从数据库设计的角度出发，即所谓的第三范式，尽量避免冗余，好友关系的表结构一般被设计为“用户-好友”，且一般用id来描述关系。如</p> 
  </blockquote> 
  <pre><code>user friend
A B
B C
A D
D C
C D
E F
E A
E B
B D
</code></pre> 
  <p>二度好友关系发现的即找到A、C的共同好友B、D，找到二度好友关系后就可以根据共同好友的多少给相应的用户推荐好友了。<br> 注：有些文章把好友关系的数据结构描述成“A:B,C,D,F,E”，这是已经预处理的结果，一般不会直接这么存储。</p> 
  <h2><a id="2_22"></a>2.实现分析</h2> 
  <p>（1）数据预处理<br> 场景描述中的数据，如果是设计良好的数据表结构，A和B是好友，则代表着B和A也是好友，但有很大可能在实际业务过程中造成了好友关系表中同时维护了A-B和B-A，而其他好友关系则是单向关系，这就为数据分析带来了一定的麻烦，针对这一问题，我们可以在数据预处理阶段先对双向关系进行数据去重，只保留单向关系，然后统一输出双向关系。结果如</p> 
  <pre><code>A	B
B	A
B	C
C	B
A	D
D	A
C	D
D	C
E	F
F	E
E	A
A	E
E	B
B	E
B	D
D	B
</code></pre> 
  <p>（2）数据分析<br> a.首先找到每个用户的所有好友，即以用户为Key进行聚合，产生“（用户，（友，友，友，…））”的中间结果，输出如：</p> 
  <pre><code>A:E,D,B
B:D,E,A,C
C:D,B
D:B,A,C
E:A,B,F
F:E
</code></pre> 
  <p>b.循环地对上一步输出的每对关系中的“（友，友，友，…）”两两配对进行输出“（（友-友），用户）”，Mapper之后由Shuffle机制合并成“（（友-友），（用户，用户，用户，…））”的结果，在Reducer中按照将聚合结果后循环输出即可实现。输出结果</p> 
  <pre><code>A-B 2:E D
A-C 2:D B
A-D 1:B
A-E 1:B
A-F 1:E
B-C 1:D
B-D 2:C A
B-E 1:A
B-F 1:E
C-D 1:B
C-E 1:B
D-E 2:A B
</code></pre> 
  <h2><a id="3_68"></a>3.关键代码分析</h2> 
  <h3><a id="31_69"></a>3.1数据去重</h3> 
  <p>使用组合键对A-B、B-A进行去重，对象O1（A-B）跟对象O2（B-A）使用compareTo方法比较时返回0，其他情况不相等即可。</p> 
  <pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>RelationKey o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>a<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
  <h3><a id="32_79"></a>3.2二度好友两两匹配</h3> 
  <p>根据用户聚合后，两两匹配输出二度好友关系。</p> 
  <pre><code class="prism language-java">    <span class="token comment">/** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FriendMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span>Object key<span class="token punctuation">,</span> Text value<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String user <span class="token operator">=</span> words<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> friends <span class="token operator">=</span> words<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//排序：避免出现A-B、B-A重复输出的情况</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>friends<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//循环两两匹配</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> friends<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> friends<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>friends<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> friends<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="4_105"></a>4.完整代码</h2> 
  <p>完整代码见：<a href="https://github.com/majxbear/mapreduce-applications" rel="nofollow">https://github.com/majxbear/mapreduce-applications</a></p> 
  <h3><a id="41_107"></a>4.1预处理：数据去重</h3> 
  <h4><a id="411_108"></a>4.1.1组合键定义</h4> 
  <pre><code class="prism language-java"><span class="token comment">/** * 好友关系组合键，用于去重 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RelationKey</span> <span class="token keyword">implements</span> <span class="token class-name">WritableComparable</span><span class="token generics function"><span class="token punctuation">&lt;</span>RelationKey<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> String a<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String b<span class="token punctuation">;</span>

    <span class="token comment">/** * 默认构造方法必须有，否则会报&lt;init&gt;失败 * java.lang.NoSuchMethodException: .&lt;init&gt;() */</span>
    <span class="token keyword">public</span> <span class="token function">RelationKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">RelationKey</span><span class="token punctuation">(</span>String a<span class="token punctuation">,</span> String b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setA</span><span class="token punctuation">(</span>String a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>a <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> String <span class="token function">getB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setB</span><span class="token punctuation">(</span>String b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>b <span class="token operator">=</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span>DataOutput dataOutput<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        dataOutput<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataOutput<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readFields</span><span class="token punctuation">(</span>DataInput dataInput<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        a <span class="token operator">=</span> dataInput<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> dataInput<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">RelationKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            RelationKey k <span class="token operator">=</span> <span class="token punctuation">(</span>RelationKey<span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
            <span class="token keyword">return</span> k<span class="token punctuation">.</span>a <span class="token operator">==</span> a <span class="token operator">&amp;&amp;</span> k<span class="token punctuation">.</span>b <span class="token operator">==</span> b<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>RelationKey o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>a<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h4><a id="412__180"></a>4.1.2 数据去重实现</h4> 
  <pre><code class="prism language-java"><span class="token comment">/** * 去除好友关系中的重复关系 * A C * C A * 只保留一份 * */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FriendClean</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CleanMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> RelationKey<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span>Object key<span class="token punctuation">,</span> Text value<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>

            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RelationKey</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CleanReducer</span> <span class="token keyword">extends</span> <span class="token class-name">Reducer</span><span class="token generics function"><span class="token punctuation">&lt;</span>RelationKey<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span>RelationKey key<span class="token punctuation">,</span> Iterable<span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> 
    <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"参数不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String inputPath <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String outputPath <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        Configuration conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Job job <span class="token operator">=</span> Job<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span>FriendClean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span>CleanMapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setCombinerClass</span><span class="token punctuation">(</span>CleanReducer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span>CleanReducer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span>RelationKey<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job<span class="token punctuation">.</span><span class="token function">setOutputKeyClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setOutputValueClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileInputFormat<span class="token punctuation">.</span><span class="token function">setInputPaths</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileOutputFormat<span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <h3><a id="42_237"></a>4.2分析阶段</h3> 
  <pre><code class="prism language-java"><span class="token comment">/** * 数据格式如下 * A B * B C * A D * D C * 输出A-C 2:B,D * 业务场景：二度好友发现，A和B的共同好友有几个，都是谁 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommonFriends</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RelationMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span>Object key<span class="token punctuation">,</span> Text value<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//原样输出</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>words<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>words<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RelationReducer</span> <span class="token keyword">extends</span> <span class="token class-name">Reducer</span><span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span>Text key<span class="token punctuation">,</span> Iterable<span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
            List<span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">&gt;</span></span> friends <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Text val <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                friends<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            StringBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Text f <span class="token operator">:</span> friends<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//去除末尾的,</span>
            builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** * 输入：A：B,C,D * 输出:((B-C),A)((B-D),A)((C-D),A) */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FriendMapper</span> <span class="token keyword">extends</span> <span class="token class-name">Mapper</span><span class="token generics function"><span class="token punctuation">&lt;</span>Object<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">map</span><span class="token punctuation">(</span>Object key<span class="token punctuation">,</span> Text value<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String user <span class="token operator">=</span> words<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> friends <span class="token operator">=</span> words<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//排序：避免出现A-B、B-A重复输出的情况</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>friends<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//循环两两匹配</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> friends<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> friends<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>friends<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> friends<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FriendReducer</span> <span class="token keyword">extends</span> <span class="token class-name">Reducer</span><span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Text<span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">reduce</span><span class="token punctuation">(</span>Text key<span class="token punctuation">,</span> Iterable<span class="token generics function"><span class="token punctuation">&lt;</span>Text<span class="token punctuation">&gt;</span></span> values<span class="token punctuation">,</span> Context context<span class="token punctuation">)</span> 
        <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            StringBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Text val <span class="token operator">:</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                count <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//去除末尾的空格</span>
            builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String output <span class="token operator">=</span> key <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> builder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Text</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> 
    <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> AppConstants<span class="token punctuation">.</span>PARAMS_MIN_2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"参数不足"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String inputPath <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String outputPath <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        String tempPath <span class="token operator">=</span> <span class="token string">"tmp"</span><span class="token punctuation">;</span>
        Configuration conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//job1</span>
        Job job <span class="token operator">=</span> Job<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">"relation analysis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span>CommonFriends<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span>CommonFriends<span class="token punctuation">.</span>RelationMapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span>CommonFriends<span class="token punctuation">.</span>RelationReducer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setOutputValueClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">setOutputKeyClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileInputFormat<span class="token punctuation">.</span><span class="token function">setInputPaths</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>inputPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileOutputFormat<span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>tempPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//job2 聚合</span>
        Job job2 <span class="token operator">=</span> Job<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setJobName</span><span class="token punctuation">(</span><span class="token string">"relation analysis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setJarByClass</span><span class="token punctuation">(</span>CommonFriends<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setMapperClass</span><span class="token punctuation">(</span>FriendMapper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setReducerClass</span><span class="token punctuation">(</span>FriendReducer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        job2<span class="token punctuation">.</span><span class="token function">setMapOutputKeyClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setMapOutputValueClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setOutputValueClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">setOutputKeyClass</span><span class="token punctuation">(</span>Text<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//在实际生产环境中，如果文件较多，会使用HDFS的合并api将其合并，存放在hdfs的指定目录下供本阶段使用</span>
        FileInputFormat<span class="token punctuation">.</span><span class="token function">setInputPaths</span><span class="token punctuation">(</span>job2<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>tempPath <span class="token operator">+</span> <span class="token string">"/part-r-00000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileOutputFormat<span class="token punctuation">.</span><span class="token function">setOutputPath</span><span class="token punctuation">(</span>job2<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Path</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        job2<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-258a4616f7.css" rel="stylesheet"> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
