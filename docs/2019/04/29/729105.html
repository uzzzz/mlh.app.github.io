<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>美团开源Graver框架：用“雕刻”诠释iOS端UI界面的高效渲染 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="美团开源Graver框架：用“雕刻”诠释iOS端UI界面的高效渲染" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="总第316篇 2018年 第108篇 Graver是一款高效的UI渲染框架，现已开源，它能以更低的资源消耗来构建十分流畅的UI界面。 美团外卖长期招聘 Android、iOS、FE 高级/资深工程师和技术专家，Base北京、上海、成都，欢迎有兴趣的同学扫描下方二维码查看职位详情，或者直接投递简历到chenhang03#meituan.com。 扫码查看职位详情，和面试官0距离交流 Graver 是一款高效的 UI 渲染框架，它以更低的资源消耗来构建十分流畅的 UI 界面。Graver 独创性的采用了基于绘制的视觉元素分解方式来构建界面，得益于此，该框架能让 UI 渲染过程变得更加简单、灵活。目前，该框架已经在美团 App 的外卖频道、独立外卖 App 核心业务场景的大多数业务中进行了应用，同时也得到美团外卖内部技术团队的认可和肯定。 App 渲染性能优化是一个普遍存在的问题，为了惠及更多的前端开发同学，美团外卖 iOS 开发团队将其进行开源，Github 项目地址与使用文档详见：https://github.com/Meituan-Dianping/Graver 。我们希望该框架能够应用到更广阔的业务场景。当然，我们也知道该框架尚有待完善之处，也希望能与更多技术同行一起交流、探讨、共建。 前言 我们为什么需要关注界面的渲染性能？App 使用体验主要包含产品功能、交互视觉、前端性能，而使用体验的好与坏，直接影响用户持续使用还是转而使用其他 App，所以我们非常关注 App 的渲染性能。而且在互联网产品流量竞争愈发激烈的大背景下，优质的使用体验可以为现有用户提供更好的服务，进而提高用户转化和留存，这也意味着创收、盈利。 图1 使用体验与转化、留存 背景 美团外卖 App 从2013年成立至今，已经走过了五个春秋，在技术层面先后经历了快速验证、模块化、精细化和平台化四个阶段，产品形态上也日趋成熟。在此期间，我们构建并完善了监控、报警、容灾、备份等各项基础设施，Metrics 即是其中的性能监控系统。 曾经一段时间，我们以外卖 App 首页商家卡片列表为例，通过 Metrics 性能监控系统发现它在 FPS、CPU、Memory 等方面的各项指标并不理想。于是，通过 Xcode 自带的 TimeProfile 等性能检测工具，然后结合代码分析等手段找到了现存性能瓶颈。与此同时，我们梳理其近半年的迭代版本需求发现，UI往往需要根据不同场景甚至不同用户展示不同的内容。为了不断迎合用户的需求，快速应对市场变化，这种特征还会持续存在。然而，它会带来以下问题： 视图层级愈加复杂、视图数量愈加众多，从版本长期迭代来看是潜在的性能瓶颈点。 如何快速、高效支撑UI变化，同时保证不会二次引入性能瓶颈。 图2 影响渲染性能、研发效率的瓶颈点 Graver 介绍 为了解决现存的性能瓶颈以及后续潜在的性能瓶颈，我们期望构建一套解决方案，该方案能在充分满足外卖业务特征的前提下，以标准化、一站式的方式解决 iOS 端 App 的渲染性能问题，并且对研发效率有一定提升， Graver（雕工）框架应运而生。 因为 Graver 独创性地采用了全新的视觉元素分解思路，所以该框架使用起来十分灵活、简单。我们先来看一下 Graver 的主要特点： 性能表现优异 以外卖 App 首页商家列表为例，应用 Graver 之后5分位滚动帧率从满帧的84%提升至96%，50分位几乎满帧；CPU 占用率下降了近6个百分点，有效提升了空闲 CPU 的资源利用率，降低了峰值 CPU 的占用率。如图3所示： 图3 优化前后技术指标对比 “一站式”异步化 Graver 从文本计算、样式排版渲染、图片解码，再到绘制，实现了全程异步化，并且是线程安全的。使用 Graver 可以一站式获得全部性能优化点，可以让我们： 不再担心散点式的“遇见一处改一处”的麻烦。 不再担心离屏渲染等各种可能导致性能瓶颈的问题，以及令人头痛的解决办法。 不再担心优化会有遗漏、优化不到位。 不再担心未来变化可能带来的任何性能瓶颈。 性能消耗的“边际成本”几乎为零 Graver 渲染整个过程除画板视图外完全没有使用 UIKit 控件，最终产出的结果是一张位图（Bitmap），视图层级、数量大幅降低。以外卖 App 首页铂金展位视图为例，原有方案由58个控件、12层级拼接而成；而应用 Graver 后仅需1个视图、1级层级绘制而成。 伴随着需求迭代、视觉元素变化，性能消耗恒属常数级。如图4所示： 图4 外卖 App 铂金展位应用 Graver 前后对比 渲染速度快 Graver 并发进行多个画板视图的渲染、显示工作。得益于图文混排技术的应用，达到了内存占用低，渲染速度快的效果。由于排版数据是不变的，所以内部会进行缓存、复用，这又进一步促进了整体渲染效率。Graver 既做到了高效渲染，又保证了低时延页面加载。 图5 渲染效率说明 以“少”胜“繁” Graver 重新抽象封装 CoreText、CoreGraphic 等系统基础能力，通过少量系统标准图形绘制接口即可实现复杂界面展示。 基于位图（Bitmap）的轻量事件交互系统 如上述所说，界面展示从传统的视图树转变为一张位图，而位图不能响应、区分内部具体位置的点击事件。Graver 提供了基于位图的轻量事件交互系统，可以准确识别点击位置发生在位图的哪一块“绘制单元”内。该“绘制单元”可以理解为与我们一贯使用的某个具体 UI 控件相对应的视觉展示。使用 Graver 为某一视觉展示添加事件如同使用系统 UIButton 添加事件一样简单。 全新的视觉元素分解思路 Graver 一改界面编程思路，与传统的通过控件“拼接”、“添加”，视图排列组合方式构建界面不同，它提供了灵活、便捷的接口让我们以“视觉所见”的方式构建界面。这一特点在下文Graver使用中详细阐述，正是因为该特点实现了研发效率的提升。 Graver 使用 Graver 引入了全新的视觉元素分解的思路。借助该思路可以实现通过一种对象来表达任一视觉元素、甚至是任一视觉元素的组合，从而消除界面布局的复杂性。 我们先来回顾下传统界面的构建方式，以外卖 App 商家卡片其中一种样式为例，如图6所示： 图6 外卖 App 商家卡片 在实现商家卡片的界面样式时，通常会根据视觉上的识别、交互要求来建立界面展示与系统提供的 UI 控件间的映射关系。以标号②位置的样式为例，在考虑复用的情况下通常这部分会使用三个系统控件来完成，分别是左侧蓝底的“预订”使用 UILabel 控件、右侧的蓝色边框“2.26.21:30起送”使用 UILabel 控件、把左右两侧 UILabel 控件装起来的 UIView 控件；在确定好采用的 UI 控件之后，需要针对展示样式分门别类的设置各个控件的渲染属性来实现图示 UI 效果，渲染属性通常一部分预设，一部分根据业务数据的不同再进行二次设置；其次，设置各个控件的内容属性实现业务数据内容的展示，展示的内容一般是网络业务数据经逻辑处理、加工后的数据。如果涉及到点击事件，还需要添加手势或者更换成 UIButton 控件。接下来，需要根据视觉要求实现排版逻辑，以标号⑧⑨为例，当标号⑧位置的数据没有的情况下，需要上提标号⑨位置的“美团专送”到图示标号⑧位置。诸如类似的排版逻辑随处可见。对于图示任一位置的展示内容都存在上述的循环思考、编写工作。随着界面元素的增加、变化，问题会变得更加复杂。 传统的界面构建方式其实是在UI控件的维度去分解视觉元素，具体是做以下四方面的编写工作： 控件选择：根据展示内容、样式、交互要求确定采用哪种系统控件。 布局信息：UI 控件的大小、位置，即 Frame。 内容信息：UI 控件展示出来的业务数据，如标号①位置的“星巴克咖啡店”。 渲染信息：UI 控件展示出来的效果，如字体、字号、透明度、边框、颜色等。 最后，将各个控件以排列组合方式合成为一棵视图树。 Graver 框架提供了以画板视图为基础，通过对更底层的 CoreText、CoreGraphic 框架封装，以更贴近“视觉所见”的角度定义了全新视觉元素分解、界面展示构建的过程。 通常“视觉所见”可划分为两部分：静态展示、动态展示。静态展示包含图片、文本；动态展示包含视频、动画等。在视觉展示全部为静态内容的时候，一个 Cell 即是一个画布，除此以外没有任何 UI 控件；否则，可以按需灵活的进行画布拆分来满足动画、视频等需要。 图7 画板和传统视图树 以图6商家卡片中标号②⑧为例，新实现方式的伪代码是这样的： 上述实现方式即是把标号②⑧部分作为一个整体来实现，任何单一系统控件都无法做到这一点。 Graver 渲染原理 图8 Graver 工作时序 如图8所示，Graver 涉及多个队列间的交互，以外卖App商家列表为例，整体流程如下： 主线程构建请求参数，创建请求任务并放入网络线程队列中，发起网络请求。 网络线程向后端服务发起请求，获得对应的业务模型数据（如包含了店铺名称，商家头图，评分，配送时长，客单价，优惠活动等店铺属性的商家卡片列表）。 网络线程创建包含业务模型数据（如商家卡片列表）的排版任务，提交到预排版线程处理，进入预排版流程。预排版队列取出排版任务，交由布局引擎计算UI布局，将业务模型解析成可被渲染引擎直接处理的，包含布局、层级、渲染信息的排版模型。解析结束后，通知主线程排版完成。 主线程获取排版模型后，随即触发内容显示。根据相对屏幕位置及出现的先后顺序，创建包含将需要显示区域信息的绘制任务，放入异步绘制线程队列中，发起绘制流程。 异步绘制线程队列取出绘制任务，进行图文绘制，最终输出一张包含了图文内容（如商家卡片）的图片。绘制任务结束后，通知主线程队绘制完成，主线程随后展示绘制区域。 整体按照队列间串行、队列内并行的方式执行。 业务应用 Graver 在外卖内部发布之后，我们也将其推广到更多的业务线，并希望 Graver 能够成为对业务开展有重要保障的一项基础服务。经过半年多的内部试用，Graver 的可靠性、渲染性能、业务适应能力也受到外卖内部的肯定和认可。截止发稿时，Graver 已经基本覆盖了美团App的外卖频道、独立外卖App核心业务场景的大多数业务。下面列举 Graver 在外卖业务的部分应用案例： 图9 Graver 业务应用 经验总结 总结一下，对于界面渲染性能优化而言，要站在一个更高角度来思考问题的解决方案。横向上，从普适性角度解决性能瓶颈点，避免其他人遇到类似问题的重复工作；纵向上，从长远考虑问题做到防微杜渐，一次优化，长期受益。基于此，我们提出一站式、标准化的渲染性能解决方案。诚然，这会遇到很多难点。面对界面样式构建的问题，系统 UIKit 框架着实为我们提供了便利，然而有时候我们需要跳出固有思维，尝试建立一套全新界面构建、视觉元素分解的思路。 参考资料 前端感官性能的衡量和优化实践 作者简介 洋洋，美团高级工程师。2018年加入美团，目前负责【美团外卖】和【美团外卖频道】的 iOS 客户端首页业务，以及支撑首页业务的技术架构、工具和系统的开发和维护工作。 欢迎加入美团开源框架Graver技术交流群，跟项目维护者零距离交流。进群方式：请加美美同学微信（微信号：MTDPtech02），回复：Graver，美美会自动拉你进群。 ----------&nbsp; END&nbsp; ---------- 也许你还想看 开源实时监控系统CAT 3.0发布：多语言客户端及多项性能提升 Logan：美团点评的开源移动端基础日志库 WMRouter：美团外卖Android开源路由框架" />
<meta property="og:description" content="总第316篇 2018年 第108篇 Graver是一款高效的UI渲染框架，现已开源，它能以更低的资源消耗来构建十分流畅的UI界面。 美团外卖长期招聘 Android、iOS、FE 高级/资深工程师和技术专家，Base北京、上海、成都，欢迎有兴趣的同学扫描下方二维码查看职位详情，或者直接投递简历到chenhang03#meituan.com。 扫码查看职位详情，和面试官0距离交流 Graver 是一款高效的 UI 渲染框架，它以更低的资源消耗来构建十分流畅的 UI 界面。Graver 独创性的采用了基于绘制的视觉元素分解方式来构建界面，得益于此，该框架能让 UI 渲染过程变得更加简单、灵活。目前，该框架已经在美团 App 的外卖频道、独立外卖 App 核心业务场景的大多数业务中进行了应用，同时也得到美团外卖内部技术团队的认可和肯定。 App 渲染性能优化是一个普遍存在的问题，为了惠及更多的前端开发同学，美团外卖 iOS 开发团队将其进行开源，Github 项目地址与使用文档详见：https://github.com/Meituan-Dianping/Graver 。我们希望该框架能够应用到更广阔的业务场景。当然，我们也知道该框架尚有待完善之处，也希望能与更多技术同行一起交流、探讨、共建。 前言 我们为什么需要关注界面的渲染性能？App 使用体验主要包含产品功能、交互视觉、前端性能，而使用体验的好与坏，直接影响用户持续使用还是转而使用其他 App，所以我们非常关注 App 的渲染性能。而且在互联网产品流量竞争愈发激烈的大背景下，优质的使用体验可以为现有用户提供更好的服务，进而提高用户转化和留存，这也意味着创收、盈利。 图1 使用体验与转化、留存 背景 美团外卖 App 从2013年成立至今，已经走过了五个春秋，在技术层面先后经历了快速验证、模块化、精细化和平台化四个阶段，产品形态上也日趋成熟。在此期间，我们构建并完善了监控、报警、容灾、备份等各项基础设施，Metrics 即是其中的性能监控系统。 曾经一段时间，我们以外卖 App 首页商家卡片列表为例，通过 Metrics 性能监控系统发现它在 FPS、CPU、Memory 等方面的各项指标并不理想。于是，通过 Xcode 自带的 TimeProfile 等性能检测工具，然后结合代码分析等手段找到了现存性能瓶颈。与此同时，我们梳理其近半年的迭代版本需求发现，UI往往需要根据不同场景甚至不同用户展示不同的内容。为了不断迎合用户的需求，快速应对市场变化，这种特征还会持续存在。然而，它会带来以下问题： 视图层级愈加复杂、视图数量愈加众多，从版本长期迭代来看是潜在的性能瓶颈点。 如何快速、高效支撑UI变化，同时保证不会二次引入性能瓶颈。 图2 影响渲染性能、研发效率的瓶颈点 Graver 介绍 为了解决现存的性能瓶颈以及后续潜在的性能瓶颈，我们期望构建一套解决方案，该方案能在充分满足外卖业务特征的前提下，以标准化、一站式的方式解决 iOS 端 App 的渲染性能问题，并且对研发效率有一定提升， Graver（雕工）框架应运而生。 因为 Graver 独创性地采用了全新的视觉元素分解思路，所以该框架使用起来十分灵活、简单。我们先来看一下 Graver 的主要特点： 性能表现优异 以外卖 App 首页商家列表为例，应用 Graver 之后5分位滚动帧率从满帧的84%提升至96%，50分位几乎满帧；CPU 占用率下降了近6个百分点，有效提升了空闲 CPU 的资源利用率，降低了峰值 CPU 的占用率。如图3所示： 图3 优化前后技术指标对比 “一站式”异步化 Graver 从文本计算、样式排版渲染、图片解码，再到绘制，实现了全程异步化，并且是线程安全的。使用 Graver 可以一站式获得全部性能优化点，可以让我们： 不再担心散点式的“遇见一处改一处”的麻烦。 不再担心离屏渲染等各种可能导致性能瓶颈的问题，以及令人头痛的解决办法。 不再担心优化会有遗漏、优化不到位。 不再担心未来变化可能带来的任何性能瓶颈。 性能消耗的“边际成本”几乎为零 Graver 渲染整个过程除画板视图外完全没有使用 UIKit 控件，最终产出的结果是一张位图（Bitmap），视图层级、数量大幅降低。以外卖 App 首页铂金展位视图为例，原有方案由58个控件、12层级拼接而成；而应用 Graver 后仅需1个视图、1级层级绘制而成。 伴随着需求迭代、视觉元素变化，性能消耗恒属常数级。如图4所示： 图4 外卖 App 铂金展位应用 Graver 前后对比 渲染速度快 Graver 并发进行多个画板视图的渲染、显示工作。得益于图文混排技术的应用，达到了内存占用低，渲染速度快的效果。由于排版数据是不变的，所以内部会进行缓存、复用，这又进一步促进了整体渲染效率。Graver 既做到了高效渲染，又保证了低时延页面加载。 图5 渲染效率说明 以“少”胜“繁” Graver 重新抽象封装 CoreText、CoreGraphic 等系统基础能力，通过少量系统标准图形绘制接口即可实现复杂界面展示。 基于位图（Bitmap）的轻量事件交互系统 如上述所说，界面展示从传统的视图树转变为一张位图，而位图不能响应、区分内部具体位置的点击事件。Graver 提供了基于位图的轻量事件交互系统，可以准确识别点击位置发生在位图的哪一块“绘制单元”内。该“绘制单元”可以理解为与我们一贯使用的某个具体 UI 控件相对应的视觉展示。使用 Graver 为某一视觉展示添加事件如同使用系统 UIButton 添加事件一样简单。 全新的视觉元素分解思路 Graver 一改界面编程思路，与传统的通过控件“拼接”、“添加”，视图排列组合方式构建界面不同，它提供了灵活、便捷的接口让我们以“视觉所见”的方式构建界面。这一特点在下文Graver使用中详细阐述，正是因为该特点实现了研发效率的提升。 Graver 使用 Graver 引入了全新的视觉元素分解的思路。借助该思路可以实现通过一种对象来表达任一视觉元素、甚至是任一视觉元素的组合，从而消除界面布局的复杂性。 我们先来回顾下传统界面的构建方式，以外卖 App 商家卡片其中一种样式为例，如图6所示： 图6 外卖 App 商家卡片 在实现商家卡片的界面样式时，通常会根据视觉上的识别、交互要求来建立界面展示与系统提供的 UI 控件间的映射关系。以标号②位置的样式为例，在考虑复用的情况下通常这部分会使用三个系统控件来完成，分别是左侧蓝底的“预订”使用 UILabel 控件、右侧的蓝色边框“2.26.21:30起送”使用 UILabel 控件、把左右两侧 UILabel 控件装起来的 UIView 控件；在确定好采用的 UI 控件之后，需要针对展示样式分门别类的设置各个控件的渲染属性来实现图示 UI 效果，渲染属性通常一部分预设，一部分根据业务数据的不同再进行二次设置；其次，设置各个控件的内容属性实现业务数据内容的展示，展示的内容一般是网络业务数据经逻辑处理、加工后的数据。如果涉及到点击事件，还需要添加手势或者更换成 UIButton 控件。接下来，需要根据视觉要求实现排版逻辑，以标号⑧⑨为例，当标号⑧位置的数据没有的情况下，需要上提标号⑨位置的“美团专送”到图示标号⑧位置。诸如类似的排版逻辑随处可见。对于图示任一位置的展示内容都存在上述的循环思考、编写工作。随着界面元素的增加、变化，问题会变得更加复杂。 传统的界面构建方式其实是在UI控件的维度去分解视觉元素，具体是做以下四方面的编写工作： 控件选择：根据展示内容、样式、交互要求确定采用哪种系统控件。 布局信息：UI 控件的大小、位置，即 Frame。 内容信息：UI 控件展示出来的业务数据，如标号①位置的“星巴克咖啡店”。 渲染信息：UI 控件展示出来的效果，如字体、字号、透明度、边框、颜色等。 最后，将各个控件以排列组合方式合成为一棵视图树。 Graver 框架提供了以画板视图为基础，通过对更底层的 CoreText、CoreGraphic 框架封装，以更贴近“视觉所见”的角度定义了全新视觉元素分解、界面展示构建的过程。 通常“视觉所见”可划分为两部分：静态展示、动态展示。静态展示包含图片、文本；动态展示包含视频、动画等。在视觉展示全部为静态内容的时候，一个 Cell 即是一个画布，除此以外没有任何 UI 控件；否则，可以按需灵活的进行画布拆分来满足动画、视频等需要。 图7 画板和传统视图树 以图6商家卡片中标号②⑧为例，新实现方式的伪代码是这样的： 上述实现方式即是把标号②⑧部分作为一个整体来实现，任何单一系统控件都无法做到这一点。 Graver 渲染原理 图8 Graver 工作时序 如图8所示，Graver 涉及多个队列间的交互，以外卖App商家列表为例，整体流程如下： 主线程构建请求参数，创建请求任务并放入网络线程队列中，发起网络请求。 网络线程向后端服务发起请求，获得对应的业务模型数据（如包含了店铺名称，商家头图，评分，配送时长，客单价，优惠活动等店铺属性的商家卡片列表）。 网络线程创建包含业务模型数据（如商家卡片列表）的排版任务，提交到预排版线程处理，进入预排版流程。预排版队列取出排版任务，交由布局引擎计算UI布局，将业务模型解析成可被渲染引擎直接处理的，包含布局、层级、渲染信息的排版模型。解析结束后，通知主线程排版完成。 主线程获取排版模型后，随即触发内容显示。根据相对屏幕位置及出现的先后顺序，创建包含将需要显示区域信息的绘制任务，放入异步绘制线程队列中，发起绘制流程。 异步绘制线程队列取出绘制任务，进行图文绘制，最终输出一张包含了图文内容（如商家卡片）的图片。绘制任务结束后，通知主线程队绘制完成，主线程随后展示绘制区域。 整体按照队列间串行、队列内并行的方式执行。 业务应用 Graver 在外卖内部发布之后，我们也将其推广到更多的业务线，并希望 Graver 能够成为对业务开展有重要保障的一项基础服务。经过半年多的内部试用，Graver 的可靠性、渲染性能、业务适应能力也受到外卖内部的肯定和认可。截止发稿时，Graver 已经基本覆盖了美团App的外卖频道、独立外卖App核心业务场景的大多数业务。下面列举 Graver 在外卖业务的部分应用案例： 图9 Graver 业务应用 经验总结 总结一下，对于界面渲染性能优化而言，要站在一个更高角度来思考问题的解决方案。横向上，从普适性角度解决性能瓶颈点，避免其他人遇到类似问题的重复工作；纵向上，从长远考虑问题做到防微杜渐，一次优化，长期受益。基于此，我们提出一站式、标准化的渲染性能解决方案。诚然，这会遇到很多难点。面对界面样式构建的问题，系统 UIKit 框架着实为我们提供了便利，然而有时候我们需要跳出固有思维，尝试建立一套全新界面构建、视觉元素分解的思路。 参考资料 前端感官性能的衡量和优化实践 作者简介 洋洋，美团高级工程师。2018年加入美团，目前负责【美团外卖】和【美团外卖频道】的 iOS 客户端首页业务，以及支撑首页业务的技术架构、工具和系统的开发和维护工作。 欢迎加入美团开源框架Graver技术交流群，跟项目维护者零距离交流。进群方式：请加美美同学微信（微信号：MTDPtech02），回复：Graver，美美会自动拉你进群。 ----------&nbsp; END&nbsp; ---------- 也许你还想看 开源实时监控系统CAT 3.0发布：多语言客户端及多项性能提升 Logan：美团点评的开源移动端基础日志库 WMRouter：美团外卖Android开源路由框架" />
<link rel="canonical" href="https://mlh.app/2019/04/29/729105.html" />
<meta property="og:url" content="https://mlh.app/2019/04/29/729105.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-04-29T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"总第316篇 2018年 第108篇 Graver是一款高效的UI渲染框架，现已开源，它能以更低的资源消耗来构建十分流畅的UI界面。 美团外卖长期招聘 Android、iOS、FE 高级/资深工程师和技术专家，Base北京、上海、成都，欢迎有兴趣的同学扫描下方二维码查看职位详情，或者直接投递简历到chenhang03#meituan.com。 扫码查看职位详情，和面试官0距离交流 Graver 是一款高效的 UI 渲染框架，它以更低的资源消耗来构建十分流畅的 UI 界面。Graver 独创性的采用了基于绘制的视觉元素分解方式来构建界面，得益于此，该框架能让 UI 渲染过程变得更加简单、灵活。目前，该框架已经在美团 App 的外卖频道、独立外卖 App 核心业务场景的大多数业务中进行了应用，同时也得到美团外卖内部技术团队的认可和肯定。 App 渲染性能优化是一个普遍存在的问题，为了惠及更多的前端开发同学，美团外卖 iOS 开发团队将其进行开源，Github 项目地址与使用文档详见：https://github.com/Meituan-Dianping/Graver 。我们希望该框架能够应用到更广阔的业务场景。当然，我们也知道该框架尚有待完善之处，也希望能与更多技术同行一起交流、探讨、共建。 前言 我们为什么需要关注界面的渲染性能？App 使用体验主要包含产品功能、交互视觉、前端性能，而使用体验的好与坏，直接影响用户持续使用还是转而使用其他 App，所以我们非常关注 App 的渲染性能。而且在互联网产品流量竞争愈发激烈的大背景下，优质的使用体验可以为现有用户提供更好的服务，进而提高用户转化和留存，这也意味着创收、盈利。 图1 使用体验与转化、留存 背景 美团外卖 App 从2013年成立至今，已经走过了五个春秋，在技术层面先后经历了快速验证、模块化、精细化和平台化四个阶段，产品形态上也日趋成熟。在此期间，我们构建并完善了监控、报警、容灾、备份等各项基础设施，Metrics 即是其中的性能监控系统。 曾经一段时间，我们以外卖 App 首页商家卡片列表为例，通过 Metrics 性能监控系统发现它在 FPS、CPU、Memory 等方面的各项指标并不理想。于是，通过 Xcode 自带的 TimeProfile 等性能检测工具，然后结合代码分析等手段找到了现存性能瓶颈。与此同时，我们梳理其近半年的迭代版本需求发现，UI往往需要根据不同场景甚至不同用户展示不同的内容。为了不断迎合用户的需求，快速应对市场变化，这种特征还会持续存在。然而，它会带来以下问题： 视图层级愈加复杂、视图数量愈加众多，从版本长期迭代来看是潜在的性能瓶颈点。 如何快速、高效支撑UI变化，同时保证不会二次引入性能瓶颈。 图2 影响渲染性能、研发效率的瓶颈点 Graver 介绍 为了解决现存的性能瓶颈以及后续潜在的性能瓶颈，我们期望构建一套解决方案，该方案能在充分满足外卖业务特征的前提下，以标准化、一站式的方式解决 iOS 端 App 的渲染性能问题，并且对研发效率有一定提升， Graver（雕工）框架应运而生。 因为 Graver 独创性地采用了全新的视觉元素分解思路，所以该框架使用起来十分灵活、简单。我们先来看一下 Graver 的主要特点： 性能表现优异 以外卖 App 首页商家列表为例，应用 Graver 之后5分位滚动帧率从满帧的84%提升至96%，50分位几乎满帧；CPU 占用率下降了近6个百分点，有效提升了空闲 CPU 的资源利用率，降低了峰值 CPU 的占用率。如图3所示： 图3 优化前后技术指标对比 “一站式”异步化 Graver 从文本计算、样式排版渲染、图片解码，再到绘制，实现了全程异步化，并且是线程安全的。使用 Graver 可以一站式获得全部性能优化点，可以让我们： 不再担心散点式的“遇见一处改一处”的麻烦。 不再担心离屏渲染等各种可能导致性能瓶颈的问题，以及令人头痛的解决办法。 不再担心优化会有遗漏、优化不到位。 不再担心未来变化可能带来的任何性能瓶颈。 性能消耗的“边际成本”几乎为零 Graver 渲染整个过程除画板视图外完全没有使用 UIKit 控件，最终产出的结果是一张位图（Bitmap），视图层级、数量大幅降低。以外卖 App 首页铂金展位视图为例，原有方案由58个控件、12层级拼接而成；而应用 Graver 后仅需1个视图、1级层级绘制而成。 伴随着需求迭代、视觉元素变化，性能消耗恒属常数级。如图4所示： 图4 外卖 App 铂金展位应用 Graver 前后对比 渲染速度快 Graver 并发进行多个画板视图的渲染、显示工作。得益于图文混排技术的应用，达到了内存占用低，渲染速度快的效果。由于排版数据是不变的，所以内部会进行缓存、复用，这又进一步促进了整体渲染效率。Graver 既做到了高效渲染，又保证了低时延页面加载。 图5 渲染效率说明 以“少”胜“繁” Graver 重新抽象封装 CoreText、CoreGraphic 等系统基础能力，通过少量系统标准图形绘制接口即可实现复杂界面展示。 基于位图（Bitmap）的轻量事件交互系统 如上述所说，界面展示从传统的视图树转变为一张位图，而位图不能响应、区分内部具体位置的点击事件。Graver 提供了基于位图的轻量事件交互系统，可以准确识别点击位置发生在位图的哪一块“绘制单元”内。该“绘制单元”可以理解为与我们一贯使用的某个具体 UI 控件相对应的视觉展示。使用 Graver 为某一视觉展示添加事件如同使用系统 UIButton 添加事件一样简单。 全新的视觉元素分解思路 Graver 一改界面编程思路，与传统的通过控件“拼接”、“添加”，视图排列组合方式构建界面不同，它提供了灵活、便捷的接口让我们以“视觉所见”的方式构建界面。这一特点在下文Graver使用中详细阐述，正是因为该特点实现了研发效率的提升。 Graver 使用 Graver 引入了全新的视觉元素分解的思路。借助该思路可以实现通过一种对象来表达任一视觉元素、甚至是任一视觉元素的组合，从而消除界面布局的复杂性。 我们先来回顾下传统界面的构建方式，以外卖 App 商家卡片其中一种样式为例，如图6所示： 图6 外卖 App 商家卡片 在实现商家卡片的界面样式时，通常会根据视觉上的识别、交互要求来建立界面展示与系统提供的 UI 控件间的映射关系。以标号②位置的样式为例，在考虑复用的情况下通常这部分会使用三个系统控件来完成，分别是左侧蓝底的“预订”使用 UILabel 控件、右侧的蓝色边框“2.26.21:30起送”使用 UILabel 控件、把左右两侧 UILabel 控件装起来的 UIView 控件；在确定好采用的 UI 控件之后，需要针对展示样式分门别类的设置各个控件的渲染属性来实现图示 UI 效果，渲染属性通常一部分预设，一部分根据业务数据的不同再进行二次设置；其次，设置各个控件的内容属性实现业务数据内容的展示，展示的内容一般是网络业务数据经逻辑处理、加工后的数据。如果涉及到点击事件，还需要添加手势或者更换成 UIButton 控件。接下来，需要根据视觉要求实现排版逻辑，以标号⑧⑨为例，当标号⑧位置的数据没有的情况下，需要上提标号⑨位置的“美团专送”到图示标号⑧位置。诸如类似的排版逻辑随处可见。对于图示任一位置的展示内容都存在上述的循环思考、编写工作。随着界面元素的增加、变化，问题会变得更加复杂。 传统的界面构建方式其实是在UI控件的维度去分解视觉元素，具体是做以下四方面的编写工作： 控件选择：根据展示内容、样式、交互要求确定采用哪种系统控件。 布局信息：UI 控件的大小、位置，即 Frame。 内容信息：UI 控件展示出来的业务数据，如标号①位置的“星巴克咖啡店”。 渲染信息：UI 控件展示出来的效果，如字体、字号、透明度、边框、颜色等。 最后，将各个控件以排列组合方式合成为一棵视图树。 Graver 框架提供了以画板视图为基础，通过对更底层的 CoreText、CoreGraphic 框架封装，以更贴近“视觉所见”的角度定义了全新视觉元素分解、界面展示构建的过程。 通常“视觉所见”可划分为两部分：静态展示、动态展示。静态展示包含图片、文本；动态展示包含视频、动画等。在视觉展示全部为静态内容的时候，一个 Cell 即是一个画布，除此以外没有任何 UI 控件；否则，可以按需灵活的进行画布拆分来满足动画、视频等需要。 图7 画板和传统视图树 以图6商家卡片中标号②⑧为例，新实现方式的伪代码是这样的： 上述实现方式即是把标号②⑧部分作为一个整体来实现，任何单一系统控件都无法做到这一点。 Graver 渲染原理 图8 Graver 工作时序 如图8所示，Graver 涉及多个队列间的交互，以外卖App商家列表为例，整体流程如下： 主线程构建请求参数，创建请求任务并放入网络线程队列中，发起网络请求。 网络线程向后端服务发起请求，获得对应的业务模型数据（如包含了店铺名称，商家头图，评分，配送时长，客单价，优惠活动等店铺属性的商家卡片列表）。 网络线程创建包含业务模型数据（如商家卡片列表）的排版任务，提交到预排版线程处理，进入预排版流程。预排版队列取出排版任务，交由布局引擎计算UI布局，将业务模型解析成可被渲染引擎直接处理的，包含布局、层级、渲染信息的排版模型。解析结束后，通知主线程排版完成。 主线程获取排版模型后，随即触发内容显示。根据相对屏幕位置及出现的先后顺序，创建包含将需要显示区域信息的绘制任务，放入异步绘制线程队列中，发起绘制流程。 异步绘制线程队列取出绘制任务，进行图文绘制，最终输出一张包含了图文内容（如商家卡片）的图片。绘制任务结束后，通知主线程队绘制完成，主线程随后展示绘制区域。 整体按照队列间串行、队列内并行的方式执行。 业务应用 Graver 在外卖内部发布之后，我们也将其推广到更多的业务线，并希望 Graver 能够成为对业务开展有重要保障的一项基础服务。经过半年多的内部试用，Graver 的可靠性、渲染性能、业务适应能力也受到外卖内部的肯定和认可。截止发稿时，Graver 已经基本覆盖了美团App的外卖频道、独立外卖App核心业务场景的大多数业务。下面列举 Graver 在外卖业务的部分应用案例： 图9 Graver 业务应用 经验总结 总结一下，对于界面渲染性能优化而言，要站在一个更高角度来思考问题的解决方案。横向上，从普适性角度解决性能瓶颈点，避免其他人遇到类似问题的重复工作；纵向上，从长远考虑问题做到防微杜渐，一次优化，长期受益。基于此，我们提出一站式、标准化的渲染性能解决方案。诚然，这会遇到很多难点。面对界面样式构建的问题，系统 UIKit 框架着实为我们提供了便利，然而有时候我们需要跳出固有思维，尝试建立一套全新界面构建、视觉元素分解的思路。 参考资料 前端感官性能的衡量和优化实践 作者简介 洋洋，美团高级工程师。2018年加入美团，目前负责【美团外卖】和【美团外卖频道】的 iOS 客户端首页业务，以及支撑首页业务的技术架构、工具和系统的开发和维护工作。 欢迎加入美团开源框架Graver技术交流群，跟项目维护者零距离交流。进群方式：请加美美同学微信（微信号：MTDPtech02），回复：Graver，美美会自动拉你进群。 ----------&nbsp; END&nbsp; ---------- 也许你还想看 开源实时监控系统CAT 3.0发布：多语言客户端及多项性能提升 Logan：美团点评的开源移动端基础日志库 WMRouter：美团外卖Android开源路由框架","@type":"BlogPosting","url":"https://mlh.app/2019/04/29/729105.html","headline":"美团开源Graver框架：用“雕刻”诠释iOS端UI界面的高效渲染","dateModified":"2019-04-29T00:00:00+08:00","datePublished":"2019-04-29T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2019/04/29/729105.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>美团开源Graver框架：用“雕刻”诠释iOS端UI界面的高效渲染</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <section class="xmteditor" style="display:none;" data-tools="新媒体管家" data-label="powered by xmt.cn" data-mpa-powered-by="yiban.io"></section> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.10546875" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsV6LYkM3uK5TAnl8DxXwdR4zA3FUoOfW6b1icLsE77CELpkNLzriajHTdibqkqVFYoldIoffibgkOslZA/640?wx_fmt=png" data-type="png" data-w="1280" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsV6LYkM3uK5TAnl8DxXwdR4zA3FUoOfW6b1icLsE77CELpkNLzriajHTdibqkqVFYoldIoffibgkOslZA/640?wx_fmt=png"></p> 
<p style="white-space: normal;text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><strong><span style="color: rgb(136, 136, 136);font-size: 12px;letter-spacing: 1px;">总第316篇</span></strong></p> 
<p style="white-space: normal;text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><strong><span style="color: rgb(136, 136, 136);font-size: 12px;letter-spacing: 1px;">2018年 第108篇</span></strong></p> 
<p style="white-space: normal;text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><strong><span style="color: rgb(136, 136, 136);font-size: 12px;letter-spacing: 1px;"><br></span></strong></p> 
<section data-role="outer" label="Powered by 135editor.com" style="font-size:16px;font-family:微软雅黑;"> 
 <section data-role="outer" label="Powered by 135editor.com"> 
  <section class="_135editor" data-tools="135编辑器" data-id="127" style="border-width: 0px;border-style: none;border-color: initial;"> 
   <section class="_135editor" data-tools="135编辑器" data-id="127" style="border-width: 0px;border-style: none;border-color: initial;"> 
    <section style="margin: 60px 16px 16px;border-width: 1px;border-style: solid;border-color: rgb(235, 234, 225);text-align: center;border-radius: 8px;font-size: 18px;font-weight: inherit;text-decoration: inherit;"> 
     <section style="margin-top: -3.3em;margin-right: 5px;margin-left: 5px;color: inherit;"> 
      <section style="border-width: 2px;border-style: solid;border-color: rgb(235, 234, 225);width: 108px;clear: both;margin-right: auto;margin-left: auto;height: 108px;border-radius: 50%;box-shadow: rgb(201, 201, 201) 0px 2px 2px 2px;background-color: rgb(254, 254, 254);"> 
       <img border="0" class="" data-ratio="1" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/hEx03cFgUsXJmHS8siaz48xKOxGqQehNLTxRksdCy2Dx2gicW703xibBiaLbsw7PMztZv3Wtz5icy12gOE4CBcYELqg/640?wx_fmt=jpeg" data-type="jpeg" data-w="800" data-width="100%" height="auto" opacity="" style="border-radius: 50%;color: inherit;display: inline-block;" title="undefined" width="100%" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/hEx03cFgUsXJmHS8siaz48xKOxGqQehNLTxRksdCy2Dx2gicW703xibBiaLbsw7PMztZv3Wtz5icy12gOE4CBcYELqg/640?wx_fmt=jpeg"> 
      </section> 
     </section> 
     <section class="135brush" data-brushtype="text" data-style="text-align: left; font-size: 14px; color: inherit;" style="margin: 8px 15px;line-height: 1.4;color: inherit;"> 
      <p style="text-align: left;margin-bottom: 10px;"><span style="font-family: Helvetica, Arial, sans-serif;font-size: 13px;color: rgb(127, 127, 127);">Graver是一款高效的UI渲染框架，现已开源，它能以更低的资源消耗来构建十分流畅的UI界面。</span></p> 
      <p style="text-align: left;"><span style="font-size: 13px;color: rgb(127, 127, 127);">美团外卖长期招聘 Android、iOS、FE 高级/资深工程师和技术专家，Base北京、上海、成都，欢迎有兴趣的同学扫描下方二维码查看职位详情，或者直接投递简历到chenhang03#meituan.com。</span></p> 
     </section> 
     <section style="margin: 10px 15px;border-top: 1px solid rgb(235, 234, 225);border-right-color: rgb(235, 234, 225);border-bottom-color: rgb(235, 234, 225);border-left-color: rgb(235, 234, 225);color: inherit;"> 
      <p style="color: inherit;"><strong><span style="font-size: 13px;color: #25b7a7;">扫码查看职位详情，和面试官0距离交流</span><br></strong></p> 
     </section> 
     <img class="" data-ratio="1.0061443932411673" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/hEx03cFgUsXJmHS8siaz48xKOxGqQehNLEIuMrVER7nC6s8VzDjtxLpLll1Nql512bLFRUBk6dwxiboHPw4n0kuw/640?wx_fmt=jpeg" data-type="jpeg" data-w="651" height="138" style="color: inherit;margin-bottom: 5.4px;width: 85px;height: 86px;visibility: visible !important;" title="洋洋5.jpeg" width="137" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/hEx03cFgUsXJmHS8siaz48xKOxGqQehNLEIuMrVER7nC6s8VzDjtxLpLll1Nql512bLFRUBk6dwxiboHPw4n0kuw/640?wx_fmt=jpeg"> 
    </section> 
   </section> 
  </section> 
 </section> 
</section> 
<p style="white-space: normal;color: rgb(51, 51, 51);margin-left: 0.5em;margin-right: 0.5em;"><span style="color: rgb(136, 136, 136);"></span></p> 
<p style="font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;margin-bottom: 15px;">Graver 是一款高效的 UI 渲染框架，它以更低的资源消耗来构建十分流畅的 UI 界面。Graver 独创性的采用了基于绘制的视觉元素分解方式来构建界面，得益于此，该框架能让 UI 渲染过程变得更加简单、灵活。目前，该框架已经在美团 App 的外卖频道、独立外卖 App 核心业务场景的大多数业务中进行了应用，同时也得到美团外卖内部技术团队的认可和肯定。</p> 
<p style="text-align: center;"><img class="" data-copyright="0" data-cropselx1="0" data-cropselx2="558" data-cropsely1="0" data-cropsely2="199" data-ratio="0.1492753623188406" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsVuRXU4VdnDNpVsXG22sGGre4YV4JlygvNboUFRyIIyARYuZaZ4MHGl6Miasc4ldOCEo5RPd1sU2qg/640?wx_fmt=png" data-type="png" data-w="2760" style="width: 558px;height: 83px;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsVuRXU4VdnDNpVsXG22sGGre4YV4JlygvNboUFRyIIyARYuZaZ4MHGl6Miasc4ldOCEo5RPd1sU2qg/640?wx_fmt=png"></p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">App 渲染性能优化是一个普遍存在的问题，为了惠及更多的前端开发同学，美团外卖 iOS 开发团队将其进行开源，Github 项目地址与使用文档详见：<a href="https://github.com/Meituan-Dianping/Graver" target="_blank" data-linktype="2">https://github.com/Meituan-Dianping/Graver</a> 。我们希望该框架能够应用到更广阔的业务场景。当然，我们也知道该框架尚有待完善之处，也希望能与更多技术同行一起交流、探讨、共建。</p> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">前言</span></h2> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">我们为什么需要关注界面的渲染性能？App 使用体验主要包含产品功能、交互视觉、前端性能，而使用体验的好与坏，直接影响用户持续使用还是转而使用其他 App，所以我们非常关注 App 的渲染性能。而且在互联网产品流量竞争愈发激烈的大背景下，优质的使用体验可以为现有用户提供更好的服务，进而提高用户转化和留存，这也意味着创收、盈利。</p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.3070607553366174" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4a3vwmiawFjVzR9U3QzUgibKQtYia8E7tibEkErUCISgg8XTicypI0BJW2pPQ/640?wx_fmt=png" data-type="png" data-w="2436" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4a3vwmiawFjVzR9U3QzUgibKQtYia8E7tibEkErUCISgg8XTicypI0BJW2pPQ/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图1 使用体验与转化、留存</span> 
</center> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">背景</span></h2> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">美团外卖 App 从2013年成立至今，已经走过了五个春秋，在技术层面先后经历了快速验证、模块化、精细化和平台化四个阶段，产品形态上也日趋成熟。在此期间，我们构建并完善了监控、报警、容灾、备份等各项基础设施，Metrics 即是其中的性能监控系统。</p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">曾经一段时间，我们以外卖 App 首页商家卡片列表为例，通过 Metrics 性能监控系统发现它在 FPS、CPU、Memory 等方面的各项指标并不理想。于是，通过 Xcode 自带的 TimeProfile 等性能检测工具，然后结合代码分析等手段找到了现存性能瓶颈。与此同时，我们梳理其近半年的迭代版本需求发现，UI往往需要根据不同场景甚至不同用户展示不同的内容。为了不断迎合用户的需求，快速应对市场变化，这种特征还会持续存在。然而，它会带来以下问题：</p> 
<ul style="margin-left: 0.5em;margin-right: 0.5em;" class=" list-paddingleft-2"> 
 <li><p><span style="font-size: 14px;">视图层级愈加复杂、视图数量愈加众多，从版本长期迭代来看是潜在的性能瓶颈点。</span></p></li> 
 <li><p style="margin-bottom: 15px;"><span style="font-size: 14px;">如何快速、高效支撑UI变化，同时保证不会二次引入性能瓶颈。</span></p></li> 
</ul> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.36221837088388215" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4a7HEGia8m2lwaPPumNv2NN2nKwKsQ1k9unponSJqmpKefbanIArIBf3g/640?wx_fmt=png" data-type="png" data-w="2308" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4a7HEGia8m2lwaPPumNv2NN2nKwKsQ1k9unponSJqmpKefbanIArIBf3g/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图2 影响渲染性能、研发效率的瓶颈点</span> 
</center> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">Graver 介绍</span></h2> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">为了解决现存的性能瓶颈以及后续潜在的性能瓶颈，我们期望构建一套解决方案，该方案能在充分满足外卖业务特征的前提下，以标准化、一站式的方式解决 iOS 端 App 的渲染性能问题，并且对研发效率有一定提升， Graver（<span style="color: rgb(136, 136, 136);">雕工</span>）框架应运而生。</p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">因为 Graver 独创性地采用了全新的视觉元素分解思路，所以该框架使用起来十分灵活、简单。我们先来看一下 Graver 的主要特点：</p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><strong>性能表现优异</strong></p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">以外卖 App 首页商家列表为例，应用 Graver 之后5分位滚动帧率从满帧的<span style="color: red;font-size: 15px;">84%</span>提升至<span style="color: red;font-size: 15px;">96%</span>，50分位几乎满帧；CPU 占用率下降了近<span style="color: red;font-size: 15px;">6个百分点</span>，有效提升了空闲 CPU 的资源利用率，降低了峰值 CPU 的占用率。如图3所示：</p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.5767195767195767" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4aJuiaQgcwU5B1vM9tEh08mOMibJiaEcxNf8Yt6ZoCuI19vvbtqhPtIXDRQ/640?wx_fmt=png" data-type="png" data-w="1512" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4aJuiaQgcwU5B1vM9tEh08mOMibJiaEcxNf8Yt6ZoCuI19vvbtqhPtIXDRQ/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图3 优化前后技术指标对比</span> 
</center> 
<p style="margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="font-size: 16px;"><strong>“一站式”异步化</strong></span></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">Graver 从文本计算、样式排版渲染、图片解码，再到绘制，实现了全程异步化，并且是线程安全的。使用 Graver 可以一站式获得全部性能优化点，可以让我们：</p> 
<ul style="margin-left: 0.5em;margin-right: 0.5em;" class=" list-paddingleft-2"> 
 <li><p><span style="font-size: 14px;">不再担心散点式的“遇见一处改一处”的麻烦。</span></p></li> 
 <li><p><span style="font-size: 14px;">不再担心离屏渲染等各种可能导致性能瓶颈的问题，以及令人头痛的解决办法。</span></p></li> 
 <li><p><span style="font-size: 14px;">不再担心优化会有遗漏、优化不到位。</span></p></li> 
 <li><p><span style="font-size: 14px;">不再担心未来变化可能带来的任何性能瓶颈。</span></p></li> 
</ul> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="font-size: 16px;"><strong>性能消耗的“边际成本”几乎为零</strong></span></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">Graver 渲染整个过程除画板视图外完全没有使用 UIKit 控件，最终产出的结果是一张位图（<span style="color: rgb(136, 136, 136);">Bitmap</span>），视图层级、数量大幅降低。以外卖 App 首页铂金展位视图为例，原有方案由58个控件、12层级拼接而成；而应用 Graver 后仅需1个视图、1级层级绘制而成。 伴随着需求迭代、视觉元素变化，性能消耗恒属常数级。如图4所示：</p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.24172185430463577" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4akPdtzFj7N5m8LNzzhd1dO2eeIXOVtIoSkRyib7cyvvTEGyCU61PSvlg/640?wx_fmt=png" data-type="png" data-w="1812" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4akPdtzFj7N5m8LNzzhd1dO2eeIXOVtIoSkRyib7cyvvTEGyCU61PSvlg/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图4 外卖 App 铂金展位应用 Graver 前后对比</span> 
</center> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="font-size: 16px;"><strong>渲染速度快</strong></span></p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">Graver 并发进行多个画板视图的渲染、显示工作。得益于图文混排技术的应用，达到了内存占用低，渲染速度快的效果。由于排版数据是不变的，所以内部会进行缓存、复用，这又进一步促进了整体渲染效率。Graver 既做到了高效渲染，又保证了低时延页面加载。</p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.4147018030513176" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4ahMmIzL99bSa3HnI4GyjNFAtlzTh93icATCcT7ObmpiaKicHayic590xG8g/640?wx_fmt=png" data-type="png" data-w="1442" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4ahMmIzL99bSa3HnI4GyjNFAtlzTh93icATCcT7ObmpiaKicHayic590xG8g/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图5 渲染效率说明</span> 
</center> 
<p style="margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="font-size: 16px;"><strong>以“少”胜“繁”</strong></span></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">Graver 重新抽象封装 CoreText、CoreGraphic 等系统基础能力，通过少量系统标准图形绘制接口即可实现复杂界面展示。</p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><strong>基于位图（Bitmap）的轻量事件交互系统</strong></p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">如上述所说，界面展示从传统的视图树转变为一张位图，而位图不能响应、区分内部具体位置的点击事件。Graver 提供了基于位图的轻量事件交互系统，可以准确识别点击位置发生在位图的哪一块“绘制单元”内。该“绘制单元”可以理解为与我们一贯使用的某个具体 UI 控件相对应的视觉展示。使用 Graver 为某一视觉展示添加事件如同使用系统 UIButton 添加事件一样简单。</p> 
<p style="font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin: 15px 0.5em;"><strong>全新的视觉元素分解思路</strong></p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">Graver 一改界面编程思路，与传统的通过控件“拼接”、“添加”，视图排列组合方式构建界面不同，它提供了灵活、便捷的接口让我们以“视觉所见”的方式构建界面。这一特点在下文<strong>Graver使用</strong>中详细阐述，正是因为该特点实现了研发效率的提升。</p> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">Graver 使用</span></h2> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">Graver 引入了全新的视觉元素分解的思路。借助该思路可以实现通过一种对象来表达任一视觉元素、甚至是任一视觉元素的组合，从而消除界面布局的复杂性。</p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">我们先来回顾下传统界面的构建方式，以外卖 App 商家卡片其中一种样式为例，如图6所示：</p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-cropselx1="0" data-cropselx2="541" data-cropsely1="0" data-cropsely2="216" data-ratio="0.365625" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/hEx03cFgUsVuRXU4VdnDNpVsXG22sGGrebWeAmecn57LkF0pKLpk98PjM3vle8icia7VkXxicic0BTUmibkoIl9ANyw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1280" style="width: 558px;height: 204px;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_jpg/hEx03cFgUsVuRXU4VdnDNpVsXG22sGGrebWeAmecn57LkF0pKLpk98PjM3vle8icia7VkXxicic0BTUmibkoIl9ANyw/640?wx_fmt=jpeg"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图6 外卖 App 商家卡片</span> 
</center> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">在实现商家卡片的界面样式时，通常会根据视觉上的识别、交互要求来建立界面展示与系统提供的 UI 控件间的映射关系。以标号②位置的样式为例，在考虑复用的情况下通常这部分会使用三个系统控件来完成，分别是左侧蓝底的“预订”使用 UILabel 控件、右侧的蓝色边框“2.26.21:30起送”使用 UILabel 控件、把左右两侧 UILabel 控件装起来的 UIView 控件；在确定好采用的 UI 控件之后，需要针对展示样式分门别类的设置各个控件的渲染属性来实现图示 UI 效果，渲染属性通常一部分预设，一部分根据业务数据的不同再进行二次设置；其次，设置各个控件的内容属性实现业务数据内容的展示，展示的内容一般是网络业务数据经逻辑处理、加工后的数据。如果涉及到点击事件，还需要添加手势或者更换成 UIButton 控件。接下来，需要根据视觉要求实现排版逻辑，以标号⑧⑨为例，当标号⑧位置的数据没有的情况下，需要上提标号⑨位置的“美团专送”到图示标号⑧位置。诸如类似的排版逻辑随处可见。对于图示任一位置的展示内容都存在上述的循环思考、编写工作。随着界面元素的增加、变化，问题会变得更加复杂。</p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">传统的界面构建方式其实是在UI控件的维度去分解视觉元素，具体是做以下四方面的编写工作：</p> 
<ul style="margin-left: 0.5em;margin-right: 0.5em;" class=" list-paddingleft-2"> 
 <li><p><span style="font-size: 14px;"><strong>控件选择</strong>：根据展示内容、样式、交互要求确定采用哪种系统控件。</span></p></li> 
 <li><p><span style="font-size: 14px;"><strong>布局信息</strong>：UI 控件的大小、位置，即 Frame。</span></p></li> 
 <li><p><span style="font-size: 14px;"><strong>内容信息</strong>：UI 控件展示出来的业务数据，如标号①位置的“星巴克咖啡店”。</span></p></li> 
 <li><p><span style="font-size: 14px;"><strong>渲染信息</strong>：UI 控件展示出来的效果，如字体、字号、透明度、边框、颜色等。</span></p></li> 
</ul> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">最后，将各个控件以排列组合方式合成为一棵视图树。</p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;"><strong>Graver 框架提供了以画板视图为基础，通过对更底层的 CoreText、CoreGraphic 框架封装，以更贴近“视觉所见”的角度定义了全新视觉元素分解、界面展示构建的过程。</strong></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">通常“视觉所见”可划分为两部分：静态展示、动态展示。静态展示包含图片、文本；动态展示包含视频、动画等。在视觉展示全部为静态内容的时候，一个 Cell 即是一个画布，除此以外没有任何 UI 控件；否则，可以按需灵活的进行画布拆分来满足动画、视频等需要。</p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.3163596966413868" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4aybbl8lpibyXD8RRicAlPZdK8JGiakl1mojBxvJSWExhcszEfYTgsKbAmA/640?wx_fmt=png" data-type="png" data-w="1846" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4aybbl8lpibyXD8RRicAlPZdK8JGiakl1mojBxvJSWExhcszEfYTgsKbAmA/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图7 画板和传统视图树</span> 
</center> 
<p style="margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">以图6商家卡片中标号②⑧为例，新实现方式的伪代码是这样的：</p> 
<p style="text-align: center;"><img class="" data-copyright="0" data-cropselx1="0" data-cropselx2="558" data-cropsely1="0" data-cropsely2="74" data-ratio="0.12208398133748057" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsVuRXU4VdnDNpVsXG22sGGrXGw9GhqpHzxnca2zV8aHiaCjwicgsxT7epgUWRjt4M2icyDg5R58RxAAg/640?wx_fmt=png" data-type="png" data-w="2572" style="width: 558px;height: 68px;" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsVuRXU4VdnDNpVsXG22sGGrXGw9GhqpHzxnca2zV8aHiaCjwicgsxT7epgUWRjt4M2icyDg5R58RxAAg/640?wx_fmt=png"></p> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">上述实现方式即是把标号②⑧部分作为一个整体来实现，任何单一系统控件都无法做到这一点。</p> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">Graver 渲染原理</span></h2> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="0.6296296296296297" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4a3ZibZOkrKjVrbyFQabGPcDwGrWicD8iaxBFXY4nvoPyI5LOXrpkicLqI3A/640?wx_fmt=png" data-type="png" data-w="1404" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXQz8Kq5ibuicSEnPJFYFHy4a3ZibZOkrKjVrbyFQabGPcDwGrWicD8iaxBFXY4nvoPyI5LOXrpkicLqI3A/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图8 Graver 工作时序</span> 
</center> 
<p style="margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">如图8所示，Graver 涉及多个队列间的交互，以外卖App商家列表为例，整体流程如下：</p> 
<p style="margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<ul style="margin-left: 0.5em;margin-right: 0.5em;" class=" list-paddingleft-2"> 
 <li><p><span style="font-size: 14px;">主线程构建请求参数，创建请求任务并放入网络线程队列中，发起网络请求。</span></p></li> 
 <li><p><span style="font-size: 14px;">网络线程向后端服务发起请求，获得对应的业务模型数据（</span><span style="font-size: 14px;color: rgb(136, 136, 136);">如包含了店铺名称，商家头图，评分，配送时长，客单价，优惠活动等店铺属性的商家卡片列表</span><span style="font-size: 14px;">）。</span></p></li> 
 <li><p><span style="font-size: 14px;">网络线程创建包含业务模型数据（</span><span style="font-size: 14px;color: rgb(136, 136, 136);">如商家卡片列表</span><span style="font-size: 14px;">）的排版任务，提交到预排版线程处理，进入预排版流程。预排版队列取出排版任务，交由布局引擎计算UI布局，将业务模型解析成可被渲染引擎直接处理的，包含布局、层级、渲染信息的排版模型。解析结束后，通知主线程排版完成。</span></p></li> 
 <li><p><span style="font-size: 14px;">主线程获取排版模型后，随即触发内容显示。根据相对屏幕位置及出现的先后顺序，创建包含将需要显示区域信息的绘制任务，放入异步绘制线程队列中，发起绘制流程。</span></p></li> 
 <li><p><span style="font-size: 14px;">异步绘制线程队列取出绘制任务，进行图文绘制，最终输出一张包含了图文内容（</span><span style="font-size: 14px;color: rgb(136, 136, 136);">如商家卡片</span><span style="font-size: 14px;">）的图片。绘制任务结束后，通知主线程队绘制完成，主线程随后展示绘制区域。</span></p></li> 
</ul> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">整体按照队列间串行、队列内并行的方式执行。</p> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">业务应用</span></h2> 
<p style="margin: 10px 0.5em 15px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;">Graver 在外卖内部发布之后，我们也将其推广到更多的业务线，并希望 Graver 能够成为对业务开展有重要保障的一项基础服务。经过半年多的内部试用，Graver 的可靠性、渲染性能、业务适应能力也受到外卖内部的肯定和认可。截止发稿时，Graver 已经基本覆盖了美团App的外卖频道、独立外卖App核心业务场景的大多数业务。下面列举 Graver 在外卖业务的部分应用案例：</p> 
<p style="text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><img class="" data-copyright="0" data-ratio="1.25" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXJmHS8siaz48xKOxGqQehNLJIbS85STicn19o2glUwTliajUfLNk5Ic8PVdQ5vA1HFr1NtzDmgPIEag/640?wx_fmt=png" data-type="png" data-w="1884" style="" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsXJmHS8siaz48xKOxGqQehNLJIbS85STicn19o2glUwTliajUfLNk5Ic8PVdQ5vA1HFr1NtzDmgPIEag/640?wx_fmt=png"></p> 
<center style="color: rgb(51, 51, 51);font-family: Arial, sans-serif;font-size: 14px;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"> 
 <span style="color: gray;font-size: 13px;">图9 Graver 业务应用</span> 
</center> 
<h2 style="margin: 30px 0.5em 15px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;"><span style="color: rgb(37, 183, 167);font-size: 20px;">经验总结</span></h2> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">总结一下，对于界面渲染性能优化而言，要站在一个更高角度来思考问题的解决方案。横向上，从普适性角度解决性能瓶颈点，避免其他人遇到类似问题的重复工作；纵向上，从长远考虑问题做到防微杜渐，一次优化，长期受益。基于此，我们提出一站式、标准化的渲染性能解决方案。诚然，这会遇到很多难点。面对界面样式构建的问题，系统 UIKit 框架着实为我们提供了便利，然而有时候我们需要跳出固有思维，尝试建立一套全新界面构建、视觉元素分解的思路。</p> 
<h2 style="margin-top: 30px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"><span style="color: rgb(37, 183, 167);">参考资料</span></h2> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"><a href="https://tech.meituan.com/Optimization_of_front_end_sensory_properties.html" style="color: rgb(53, 114, 176);font-size: 14px;text-decoration: underline;" data-linktype="2"><span style="font-size: 14px;">前端感官性能的衡量和优化实践</span></a></p> 
<h2 style="margin-top: 30px;font-size: 18px;font-weight: bold;line-height: 1.25;font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"><span style="color: rgb(37, 183, 167);">作者简介</span></h2> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;">洋洋，美团高级工程师。2018年加入美团，目前负责【美团外卖】和【美团外卖频道】的 iOS 客户端首页业务，以及支撑首页业务的技术架构、工具和系统的开发和维护工作。</p> 
<p style="margin-top: 10px;font-size: 15px;color: rgb(51, 51, 51);font-family: Arial, sans-serif;white-space: pre-wrap;margin-left: 0.5em;margin-right: 0.5em;"><span style="max-width: 100%;color: rgb(51, 51, 51);font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;letter-spacing: 0.544px;text-align: justify;background-color: rgb(255, 255, 255);font-size: 15px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(136, 136, 136);box-sizing: border-box !important;overflow-wrap: break-word !important;">欢迎加入<strong style="max-width: 100%;color: rgb(51, 51, 51);box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="max-width: 100%;color: rgb(0, 0, 0);box-sizing: border-box !important;overflow-wrap: break-word !important;">美团开源框架Graver技术交流群</span></strong>，跟项目维护者零距离交流。进群方式：请加美美同学<span style="max-width: 100%;letter-spacing: 0px;box-sizing: border-box !important;overflow-wrap: break-word !important;">微信（微信号：</span></span><span style="max-width: 100%;letter-spacing: 0px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;color: rgb(136, 136, 136);box-sizing: border-box !important;overflow-wrap: break-word !important;">MTDPtech02</strong><strong style="max-width: 100%;color: rgb(136, 136, 136);box-sizing: border-box !important;overflow-wrap: break-word !important;">）</strong><span style="max-width: 100%;color: rgb(136, 136, 136);box-sizing: border-box !important;overflow-wrap: break-word !important;">，回复：</span><span style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;">Graver</strong></span></span></span><span style="max-width: 100%;font-family: -apple-system-font, system-ui, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei UI&quot;, &quot;Microsoft YaHei&quot;, Arial, sans-serif;text-align: justify;color: rgb(136, 136, 136);letter-spacing: 0px;font-size: 15px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;">，美美会自动拉你进群。</span></p> 
<p style="margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="white-space: normal;color: rgb(51, 51, 51);text-align: center;margin-left: 0.5em;margin-right: 0.5em;"><span style="font-size: 15px;color: rgb(136, 136, 136);">----------&nbsp; END&nbsp; ----------</span></p> 
<p data-source-line="194" style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><span style="font-size: 16px;"><strong><span style="color: rgb(49, 188, 173);">也许你还想看</span></strong></span></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&amp;mid=2651749250&amp;idx=2&amp;sn=704a3c8b92e8221f0a0dfdbd947d9f85&amp;chksm=bd12a2cf8a652bd9d1e1286c6dfb3ca85d46c1e83e958dc594bc21f74ea1a3181866a7e6edab&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 14px;text-decoration: underline;" data-linktype="2"><span style="font-size: 14px;">开源实时监控系统CAT 3.0发布：多语言客户端及多项性能提升</span></a></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&amp;mid=2651748960&amp;idx=1&amp;sn=2bd11c883ecc787e634bc3c29dfbbe50&amp;chksm=bd12a32d8a652a3b25f26de739555341937697e02f2f01017129514624cdb0dd2e2bdd844acb&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 14px;text-decoration: underline;" data-linktype="2"><span style="font-size: 14px;">Logan：美团点评的开源移动端基础日志库</span></a></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><a href="http://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&amp;mid=2651748649&amp;idx=1&amp;sn=0a2724141fb8b2a16ad88c614db9209d&amp;chksm=bd12a0648a652972649fd3defec48bd205b26b6ab4f5be107895ebde9533677c3cabe704cc3e&amp;scene=21#wechat_redirect" target="_blank" style="font-size: 14px;text-decoration: underline;" data-linktype="2"><span style="font-size: 14px;">WMRouter：美团外卖Android开源路由框架</span></a><br></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;"><br></p> 
<p style="white-space: normal;margin-left: 0.5em;margin-right: 0.5em;text-align: center;"><img class="" data-copyright="0" data-ratio="0.44533333333333336" data-s="300,640" data-src="https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsV6LYkM3uK5TAnl8DxXwdR4YOAKWmYSpAtzV3P359bDG3cn3Vr4T6HMkvDSI8icUYsejmDnfa5CdpQ/640?wx_fmt=png" data-type="png" data-w="1875" src="https://uzshare.com/_p?https://mmbiz.qpic.cn/mmbiz_png/hEx03cFgUsV6LYkM3uK5TAnl8DxXwdR4YOAKWmYSpAtzV3P359bDG3cn3Vr4T6HMkvDSI8icUYsejmDnfa5CdpQ/640?wx_fmt=png"></p>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
