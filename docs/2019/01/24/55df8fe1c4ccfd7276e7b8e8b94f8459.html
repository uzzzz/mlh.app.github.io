<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>GBDT回归的原理及Python实现 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="GBDT回归的原理及Python实现" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="提到GBDT回归相信大家应该都不会觉得陌生（不陌生你点进来干嘛[捂脸]），本文就GBDT回归的基本原理进行讲解，并手把手、肩并肩地带您实现这一算法。 完整实现代码请参考本人的p...哦不是...github： https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_base.py https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_regressor.py https://github.com/tushushu/imylu/blob/master/examples/gbdt_regressor_example.py 1. 原理篇 我们用人话而不是大段的数学公式来讲讲GBDT回归是怎么一回事。 1.1 温故知新 回归树是GBDT的基础，之前的一篇文章曾经讲过回归树的原理和实现。链接如下：回归树的原理及Python实现 1.2 预测年龄 仍然以预测同事年龄来举例，从《回归树》那篇文章中我们可以知道，如果需要通过一个常量来预测同事的年龄，平均值是最佳选择之一。 1.3 年龄的残差 我们不妨假设同事的年龄分别为5岁、6岁、7岁，那么同事的平均年龄就是6岁。所以我们用6岁这个常量来预测同事的年龄，即[6, 6, 6]。每个同事年龄的残差 = 年龄 - 预测值 = [5, 6, 7] - [6, 6, 6]，所以残差为[-1, 0, 1] 1.4 预测年龄的残差 为了让模型更加准确，其中一个思路是让残差变小。如何减少残差呢？我们不妨对残差建立一颗回归树，然后预测出准确的残差。假设这棵树预测的残差是[-0.9, 0, 0.9]，将上一轮的预测值和这一轮的预测值求和，每个同事的年龄 = [6, 6, 6] + [-0.9, 0, 0.9] = [5.1, 6, 6.9]，显然与真实值[5, 6, 7]更加接近了， 年龄的残差此时变为[-0.1, 0, 0.1]，预测的准确性得到了提升。 1.5 GBDT 重新整理一下思路，假设我们的预测一共迭代3轮 年龄：[5, 6, 7] 第1轮预测：[6, 6, 6] (平均值) 第1轮残差：[-1, 0, 1] 第2轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) = [5.1, 6, 6.9] 第2轮残差：[-0.1, 0, 0.1] 第3轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) + [-0.08, 0, 0.07] (第2颗回归树) = [5.02, 6, 6.97] 第3轮残差：[-0.08, 0, 0.03] 看上去残差越来越小，而这种预测方式就是GBDT算法。 1.6 公式推导 看到这里，相信您对GBDT已经有了直观的认识。这么做有什么科学依据么，为什么残差可以越来越小呢？前方小段数学公式低能预警。 因此，我们需要通过用第m-1轮残差的均值来得到函数fm，进而优化函数Fm。而回归树的原理就是通过最佳划分区域的均值来进行预测。所以fm可以选用回归树作为基础模型，将初始值，m-1颗回归树的预测值相加便可以预测y。 2. 实现篇 本人用全宇宙最简单的编程语言——Python实现了GBDT回归算法，没有依赖任何第三方库，便于学习和使用。简单说明一下实现过程，更详细的注释请参考本人github上的代码。 2.1 导入回归树类 回归树是我之前已经写好的一个类，在之前的文章详细介绍过，代码请参考： https://github.com/tushushu/imylu/blob/master/imylu/tree/regression_tree.py from ..tree.regression_tree import RegressionTree 2.2 创建GradientBoostingBase类 初始化，存储回归树、学习率、初始预测值和变换函数。（注：回归不需要做变换，因此函数的返回值等于参数） class GradientBoostingBase(object): &nbsp; &nbsp;def __init__(self): &nbsp; &nbsp; &nbsp; &nbsp;self.trees = None &nbsp; &nbsp; &nbsp; &nbsp;self.lr = None &nbsp; &nbsp; &nbsp; &nbsp;self.init_val = None &nbsp; &nbsp; &nbsp; &nbsp;self.fn = lambda x: x 2.3 计算初始预测值 初始预测值即y的平均值。 def _get_init_val(self, y): &nbsp; &nbsp;return sum(y) / len(y) 2.4 计算残差 def _get_residuals(self, y, y_hat): &nbsp; &nbsp;return [yi - self.fn(y_hat_i) for yi, y_hat_i in zip(y, y_hat)] 2.5 训练模型 训练模型的时候需要注意以下几点： 1. 控制树的最大深度max_depth； 2. 控制分裂时最少的样本量min_samples_split； 3. 训练每一棵回归树的时候要乘以一个学习率lr，防止模型过拟合； 4. 对样本进行抽样的时候要采用有放回的抽样方式。 def fit(self, X, y, n_estimators, lr, max_depth, min_samples_split, subsample=None): &nbsp; &nbsp;self.init_val = self._get_init_val(y) &nbsp; &nbsp;n = len(y) &nbsp; &nbsp;y_hat = [self.init_val] * n &nbsp; &nbsp;residuals = self._get_residuals(y, y_hat) &nbsp; &nbsp;self.trees = [] &nbsp; &nbsp;self.lr = lr &nbsp; &nbsp;for _ in range(n_estimators): &nbsp; &nbsp; &nbsp; &nbsp;idx = range(n) &nbsp; &nbsp; &nbsp; &nbsp;if subsample is not None: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;k = int(subsample * n) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;idx = choices(population=idx, k=k) &nbsp; &nbsp; &nbsp; &nbsp;X_sub = [X[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;residuals_sub = [residuals[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;y_hat_sub = [y_hat[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;tree = RegressionTree() &nbsp; &nbsp; &nbsp; &nbsp;tree.fit(X_sub, residuals_sub, max_depth, min_samples_split) &nbsp; &nbsp; &nbsp; &nbsp;self._update_score(tree, X_sub, y_hat_sub, residuals_sub) &nbsp; &nbsp; &nbsp; &nbsp;y_hat = [y_hat_i + lr * res_hat_i for y_hat_i, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;res_hat_i in zip(y_hat, tree.predict(X))] &nbsp; &nbsp; &nbsp; &nbsp;residuals = self._get_residuals(y, y_hat) &nbsp; &nbsp; &nbsp; &nbsp;self.trees.append(tree) 2.6 预测一个样本 def _predict(self, Xi): &nbsp; &nbsp;return self.fn(self.init_val + sum(self.lr * tree._predict(Xi) for tree in self.trees)) 2.7 预测多个样本 def predict(self, X): &nbsp; &nbsp;return [self._predict(Xi) for Xi in X] 3 效果评估 3.1 main函数 使用著名的波士顿房价数据集，按照7:3的比例拆分为训练集和测试集，训练模型，并统计准确度。 @run_timedef main(): &nbsp; &nbsp;print(&quot;Tesing the accuracy of GBDT regressor...&quot;) &nbsp; &nbsp;X, y = load_boston_house_prices() &nbsp; &nbsp;X_train, X_test, y_train, y_test = train_test_split( &nbsp; &nbsp; &nbsp; &nbsp;X, y, random_state=10) &nbsp; &nbsp;reg = GradientBoostingRegressor() &nbsp; &nbsp;reg.fit(X=X_train, y=y_train, n_estimators=4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lr=0.5, max_depth=2, min_samples_split=2) &nbsp; &nbsp;get_r2(reg, X_test, y_test) 3.2 效果展示 最终拟合优度0.851，运行时间5.0秒，效果还算不错~ 3.3 工具函数 本人自定义了一些工具函数，可以在github上查看 https://github.com/tushushu/imylu/tree/master/imylu/utils 1. run_time - 测试函数运行时间 2. load_boston_house_prices - 加载波士顿房价数据 3. train_test_split - 拆分训练集、测试集 4. get_r2 - 计算拟合优度 总结 GBDT回归的原理：平均值加回归树 GBDT回归的实现：加加减减for循环 作者：李小文&nbsp;&nbsp;&nbsp; 算法工程师&nbsp; 知乎专栏： https://zhuanlan.zhihu.com/lixiaowen ∞∞∞∞∞ 公众号回复“IT派”， 邀你加入&nbsp;IT派&nbsp;{ 深广创投圈 }&nbsp;" />
<meta property="og:description" content="提到GBDT回归相信大家应该都不会觉得陌生（不陌生你点进来干嘛[捂脸]），本文就GBDT回归的基本原理进行讲解，并手把手、肩并肩地带您实现这一算法。 完整实现代码请参考本人的p...哦不是...github： https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_base.py https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_regressor.py https://github.com/tushushu/imylu/blob/master/examples/gbdt_regressor_example.py 1. 原理篇 我们用人话而不是大段的数学公式来讲讲GBDT回归是怎么一回事。 1.1 温故知新 回归树是GBDT的基础，之前的一篇文章曾经讲过回归树的原理和实现。链接如下：回归树的原理及Python实现 1.2 预测年龄 仍然以预测同事年龄来举例，从《回归树》那篇文章中我们可以知道，如果需要通过一个常量来预测同事的年龄，平均值是最佳选择之一。 1.3 年龄的残差 我们不妨假设同事的年龄分别为5岁、6岁、7岁，那么同事的平均年龄就是6岁。所以我们用6岁这个常量来预测同事的年龄，即[6, 6, 6]。每个同事年龄的残差 = 年龄 - 预测值 = [5, 6, 7] - [6, 6, 6]，所以残差为[-1, 0, 1] 1.4 预测年龄的残差 为了让模型更加准确，其中一个思路是让残差变小。如何减少残差呢？我们不妨对残差建立一颗回归树，然后预测出准确的残差。假设这棵树预测的残差是[-0.9, 0, 0.9]，将上一轮的预测值和这一轮的预测值求和，每个同事的年龄 = [6, 6, 6] + [-0.9, 0, 0.9] = [5.1, 6, 6.9]，显然与真实值[5, 6, 7]更加接近了， 年龄的残差此时变为[-0.1, 0, 0.1]，预测的准确性得到了提升。 1.5 GBDT 重新整理一下思路，假设我们的预测一共迭代3轮 年龄：[5, 6, 7] 第1轮预测：[6, 6, 6] (平均值) 第1轮残差：[-1, 0, 1] 第2轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) = [5.1, 6, 6.9] 第2轮残差：[-0.1, 0, 0.1] 第3轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) + [-0.08, 0, 0.07] (第2颗回归树) = [5.02, 6, 6.97] 第3轮残差：[-0.08, 0, 0.03] 看上去残差越来越小，而这种预测方式就是GBDT算法。 1.6 公式推导 看到这里，相信您对GBDT已经有了直观的认识。这么做有什么科学依据么，为什么残差可以越来越小呢？前方小段数学公式低能预警。 因此，我们需要通过用第m-1轮残差的均值来得到函数fm，进而优化函数Fm。而回归树的原理就是通过最佳划分区域的均值来进行预测。所以fm可以选用回归树作为基础模型，将初始值，m-1颗回归树的预测值相加便可以预测y。 2. 实现篇 本人用全宇宙最简单的编程语言——Python实现了GBDT回归算法，没有依赖任何第三方库，便于学习和使用。简单说明一下实现过程，更详细的注释请参考本人github上的代码。 2.1 导入回归树类 回归树是我之前已经写好的一个类，在之前的文章详细介绍过，代码请参考： https://github.com/tushushu/imylu/blob/master/imylu/tree/regression_tree.py from ..tree.regression_tree import RegressionTree 2.2 创建GradientBoostingBase类 初始化，存储回归树、学习率、初始预测值和变换函数。（注：回归不需要做变换，因此函数的返回值等于参数） class GradientBoostingBase(object): &nbsp; &nbsp;def __init__(self): &nbsp; &nbsp; &nbsp; &nbsp;self.trees = None &nbsp; &nbsp; &nbsp; &nbsp;self.lr = None &nbsp; &nbsp; &nbsp; &nbsp;self.init_val = None &nbsp; &nbsp; &nbsp; &nbsp;self.fn = lambda x: x 2.3 计算初始预测值 初始预测值即y的平均值。 def _get_init_val(self, y): &nbsp; &nbsp;return sum(y) / len(y) 2.4 计算残差 def _get_residuals(self, y, y_hat): &nbsp; &nbsp;return [yi - self.fn(y_hat_i) for yi, y_hat_i in zip(y, y_hat)] 2.5 训练模型 训练模型的时候需要注意以下几点： 1. 控制树的最大深度max_depth； 2. 控制分裂时最少的样本量min_samples_split； 3. 训练每一棵回归树的时候要乘以一个学习率lr，防止模型过拟合； 4. 对样本进行抽样的时候要采用有放回的抽样方式。 def fit(self, X, y, n_estimators, lr, max_depth, min_samples_split, subsample=None): &nbsp; &nbsp;self.init_val = self._get_init_val(y) &nbsp; &nbsp;n = len(y) &nbsp; &nbsp;y_hat = [self.init_val] * n &nbsp; &nbsp;residuals = self._get_residuals(y, y_hat) &nbsp; &nbsp;self.trees = [] &nbsp; &nbsp;self.lr = lr &nbsp; &nbsp;for _ in range(n_estimators): &nbsp; &nbsp; &nbsp; &nbsp;idx = range(n) &nbsp; &nbsp; &nbsp; &nbsp;if subsample is not None: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;k = int(subsample * n) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;idx = choices(population=idx, k=k) &nbsp; &nbsp; &nbsp; &nbsp;X_sub = [X[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;residuals_sub = [residuals[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;y_hat_sub = [y_hat[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;tree = RegressionTree() &nbsp; &nbsp; &nbsp; &nbsp;tree.fit(X_sub, residuals_sub, max_depth, min_samples_split) &nbsp; &nbsp; &nbsp; &nbsp;self._update_score(tree, X_sub, y_hat_sub, residuals_sub) &nbsp; &nbsp; &nbsp; &nbsp;y_hat = [y_hat_i + lr * res_hat_i for y_hat_i, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;res_hat_i in zip(y_hat, tree.predict(X))] &nbsp; &nbsp; &nbsp; &nbsp;residuals = self._get_residuals(y, y_hat) &nbsp; &nbsp; &nbsp; &nbsp;self.trees.append(tree) 2.6 预测一个样本 def _predict(self, Xi): &nbsp; &nbsp;return self.fn(self.init_val + sum(self.lr * tree._predict(Xi) for tree in self.trees)) 2.7 预测多个样本 def predict(self, X): &nbsp; &nbsp;return [self._predict(Xi) for Xi in X] 3 效果评估 3.1 main函数 使用著名的波士顿房价数据集，按照7:3的比例拆分为训练集和测试集，训练模型，并统计准确度。 @run_timedef main(): &nbsp; &nbsp;print(&quot;Tesing the accuracy of GBDT regressor...&quot;) &nbsp; &nbsp;X, y = load_boston_house_prices() &nbsp; &nbsp;X_train, X_test, y_train, y_test = train_test_split( &nbsp; &nbsp; &nbsp; &nbsp;X, y, random_state=10) &nbsp; &nbsp;reg = GradientBoostingRegressor() &nbsp; &nbsp;reg.fit(X=X_train, y=y_train, n_estimators=4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lr=0.5, max_depth=2, min_samples_split=2) &nbsp; &nbsp;get_r2(reg, X_test, y_test) 3.2 效果展示 最终拟合优度0.851，运行时间5.0秒，效果还算不错~ 3.3 工具函数 本人自定义了一些工具函数，可以在github上查看 https://github.com/tushushu/imylu/tree/master/imylu/utils 1. run_time - 测试函数运行时间 2. load_boston_house_prices - 加载波士顿房价数据 3. train_test_split - 拆分训练集、测试集 4. get_r2 - 计算拟合优度 总结 GBDT回归的原理：平均值加回归树 GBDT回归的实现：加加减减for循环 作者：李小文&nbsp;&nbsp;&nbsp; 算法工程师&nbsp; 知乎专栏： https://zhuanlan.zhihu.com/lixiaowen ∞∞∞∞∞ 公众号回复“IT派”， 邀你加入&nbsp;IT派&nbsp;{ 深广创投圈 }&nbsp;" />
<link rel="canonical" href="https://mlh.app/2019/01/24/55df8fe1c4ccfd7276e7b8e8b94f8459.html" />
<meta property="og:url" content="https://mlh.app/2019/01/24/55df8fe1c4ccfd7276e7b8e8b94f8459.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-24T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"提到GBDT回归相信大家应该都不会觉得陌生（不陌生你点进来干嘛[捂脸]），本文就GBDT回归的基本原理进行讲解，并手把手、肩并肩地带您实现这一算法。 完整实现代码请参考本人的p...哦不是...github： https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_base.py https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_regressor.py https://github.com/tushushu/imylu/blob/master/examples/gbdt_regressor_example.py 1. 原理篇 我们用人话而不是大段的数学公式来讲讲GBDT回归是怎么一回事。 1.1 温故知新 回归树是GBDT的基础，之前的一篇文章曾经讲过回归树的原理和实现。链接如下：回归树的原理及Python实现 1.2 预测年龄 仍然以预测同事年龄来举例，从《回归树》那篇文章中我们可以知道，如果需要通过一个常量来预测同事的年龄，平均值是最佳选择之一。 1.3 年龄的残差 我们不妨假设同事的年龄分别为5岁、6岁、7岁，那么同事的平均年龄就是6岁。所以我们用6岁这个常量来预测同事的年龄，即[6, 6, 6]。每个同事年龄的残差 = 年龄 - 预测值 = [5, 6, 7] - [6, 6, 6]，所以残差为[-1, 0, 1] 1.4 预测年龄的残差 为了让模型更加准确，其中一个思路是让残差变小。如何减少残差呢？我们不妨对残差建立一颗回归树，然后预测出准确的残差。假设这棵树预测的残差是[-0.9, 0, 0.9]，将上一轮的预测值和这一轮的预测值求和，每个同事的年龄 = [6, 6, 6] + [-0.9, 0, 0.9] = [5.1, 6, 6.9]，显然与真实值[5, 6, 7]更加接近了， 年龄的残差此时变为[-0.1, 0, 0.1]，预测的准确性得到了提升。 1.5 GBDT 重新整理一下思路，假设我们的预测一共迭代3轮 年龄：[5, 6, 7] 第1轮预测：[6, 6, 6] (平均值) 第1轮残差：[-1, 0, 1] 第2轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) = [5.1, 6, 6.9] 第2轮残差：[-0.1, 0, 0.1] 第3轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) + [-0.08, 0, 0.07] (第2颗回归树) = [5.02, 6, 6.97] 第3轮残差：[-0.08, 0, 0.03] 看上去残差越来越小，而这种预测方式就是GBDT算法。 1.6 公式推导 看到这里，相信您对GBDT已经有了直观的认识。这么做有什么科学依据么，为什么残差可以越来越小呢？前方小段数学公式低能预警。 因此，我们需要通过用第m-1轮残差的均值来得到函数fm，进而优化函数Fm。而回归树的原理就是通过最佳划分区域的均值来进行预测。所以fm可以选用回归树作为基础模型，将初始值，m-1颗回归树的预测值相加便可以预测y。 2. 实现篇 本人用全宇宙最简单的编程语言——Python实现了GBDT回归算法，没有依赖任何第三方库，便于学习和使用。简单说明一下实现过程，更详细的注释请参考本人github上的代码。 2.1 导入回归树类 回归树是我之前已经写好的一个类，在之前的文章详细介绍过，代码请参考： https://github.com/tushushu/imylu/blob/master/imylu/tree/regression_tree.py from ..tree.regression_tree import RegressionTree 2.2 创建GradientBoostingBase类 初始化，存储回归树、学习率、初始预测值和变换函数。（注：回归不需要做变换，因此函数的返回值等于参数） class GradientBoostingBase(object): &nbsp; &nbsp;def __init__(self): &nbsp; &nbsp; &nbsp; &nbsp;self.trees = None &nbsp; &nbsp; &nbsp; &nbsp;self.lr = None &nbsp; &nbsp; &nbsp; &nbsp;self.init_val = None &nbsp; &nbsp; &nbsp; &nbsp;self.fn = lambda x: x 2.3 计算初始预测值 初始预测值即y的平均值。 def _get_init_val(self, y): &nbsp; &nbsp;return sum(y) / len(y) 2.4 计算残差 def _get_residuals(self, y, y_hat): &nbsp; &nbsp;return [yi - self.fn(y_hat_i) for yi, y_hat_i in zip(y, y_hat)] 2.5 训练模型 训练模型的时候需要注意以下几点： 1. 控制树的最大深度max_depth； 2. 控制分裂时最少的样本量min_samples_split； 3. 训练每一棵回归树的时候要乘以一个学习率lr，防止模型过拟合； 4. 对样本进行抽样的时候要采用有放回的抽样方式。 def fit(self, X, y, n_estimators, lr, max_depth, min_samples_split, subsample=None): &nbsp; &nbsp;self.init_val = self._get_init_val(y) &nbsp; &nbsp;n = len(y) &nbsp; &nbsp;y_hat = [self.init_val] * n &nbsp; &nbsp;residuals = self._get_residuals(y, y_hat) &nbsp; &nbsp;self.trees = [] &nbsp; &nbsp;self.lr = lr &nbsp; &nbsp;for _ in range(n_estimators): &nbsp; &nbsp; &nbsp; &nbsp;idx = range(n) &nbsp; &nbsp; &nbsp; &nbsp;if subsample is not None: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;k = int(subsample * n) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;idx = choices(population=idx, k=k) &nbsp; &nbsp; &nbsp; &nbsp;X_sub = [X[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;residuals_sub = [residuals[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;y_hat_sub = [y_hat[i] for i in idx] &nbsp; &nbsp; &nbsp; &nbsp;tree = RegressionTree() &nbsp; &nbsp; &nbsp; &nbsp;tree.fit(X_sub, residuals_sub, max_depth, min_samples_split) &nbsp; &nbsp; &nbsp; &nbsp;self._update_score(tree, X_sub, y_hat_sub, residuals_sub) &nbsp; &nbsp; &nbsp; &nbsp;y_hat = [y_hat_i + lr * res_hat_i for y_hat_i, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;res_hat_i in zip(y_hat, tree.predict(X))] &nbsp; &nbsp; &nbsp; &nbsp;residuals = self._get_residuals(y, y_hat) &nbsp; &nbsp; &nbsp; &nbsp;self.trees.append(tree) 2.6 预测一个样本 def _predict(self, Xi): &nbsp; &nbsp;return self.fn(self.init_val + sum(self.lr * tree._predict(Xi) for tree in self.trees)) 2.7 预测多个样本 def predict(self, X): &nbsp; &nbsp;return [self._predict(Xi) for Xi in X] 3 效果评估 3.1 main函数 使用著名的波士顿房价数据集，按照7:3的比例拆分为训练集和测试集，训练模型，并统计准确度。 @run_timedef main(): &nbsp; &nbsp;print(&quot;Tesing the accuracy of GBDT regressor...&quot;) &nbsp; &nbsp;X, y = load_boston_house_prices() &nbsp; &nbsp;X_train, X_test, y_train, y_test = train_test_split( &nbsp; &nbsp; &nbsp; &nbsp;X, y, random_state=10) &nbsp; &nbsp;reg = GradientBoostingRegressor() &nbsp; &nbsp;reg.fit(X=X_train, y=y_train, n_estimators=4, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lr=0.5, max_depth=2, min_samples_split=2) &nbsp; &nbsp;get_r2(reg, X_test, y_test) 3.2 效果展示 最终拟合优度0.851，运行时间5.0秒，效果还算不错~ 3.3 工具函数 本人自定义了一些工具函数，可以在github上查看 https://github.com/tushushu/imylu/tree/master/imylu/utils 1. run_time - 测试函数运行时间 2. load_boston_house_prices - 加载波士顿房价数据 3. train_test_split - 拆分训练集、测试集 4. get_r2 - 计算拟合优度 总结 GBDT回归的原理：平均值加回归树 GBDT回归的实现：加加减减for循环 作者：李小文&nbsp;&nbsp;&nbsp; 算法工程师&nbsp; 知乎专栏： https://zhuanlan.zhihu.com/lixiaowen ∞∞∞∞∞ 公众号回复“IT派”， 邀你加入&nbsp;IT派&nbsp;{ 深广创投圈 }&nbsp;","@type":"BlogPosting","url":"https://mlh.app/2019/01/24/55df8fe1c4ccfd7276e7b8e8b94f8459.html","headline":"GBDT回归的原理及Python实现","dateModified":"2019-01-24T00:00:00+08:00","datePublished":"2019-01-24T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2019/01/24/55df8fe1c4ccfd7276e7b8e8b94f8459.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>GBDT回归的原理及Python实现</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f57960eb32.css"> 
 <div class="htmledit_views" id="content_views"> 
  <div class="rich_media_content" id="js_content"> 
   <p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/tvEoHIulOU43YE1qOU8Vd6BLcuLMMibeNibqicibO1dbuF9v1zK6mRakK0y6nEU5lFf34iawGw99mGDcfFeLPlEmRLA/640?wx_fmt=png" alt="640?wx_fmt=png"><br></p>
   <p><br></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">提到GBDT回归相信大家应该都不会觉得陌生（不陌生你点进来干嘛[捂脸]），本文就GBDT回归的基本原理进行讲解，并手把手、肩并肩地带您实现这一算法。</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">完整实现代码请参考本人的p...哦不是...github：</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_base.py</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">https://github.com/tushushu/imylu/blob/master/imylu/ensemble/gbdt_regressor.py</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">https://github.com/tushushu/imylu/blob/master/examples/gbdt_regressor_example.py</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1. 原理篇</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">我们用人话而不是大段的数学公式来讲讲GBDT回归是怎么一回事。</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1.1 温故知新</span></h2>
   <p style="line-height:1.5em;margin-left:8px;"><span style="font-size:14px;letter-spacing:1px;">回归树是GBDT的基础，之前的一篇文章曾经讲过回归树的原理和实现。链接如下：</span><a href="http://mp.weixin.qq.com/s?__biz=MzI5NDY1MjQzNA==&amp;mid=2247488358&amp;idx=1&amp;sn=cdf27f1b70577ef159ffd806facc186b&amp;chksm=ec5ecc1bdb29450dfe32651a07caab10b88518de1947c406e212ad0aae688cd43dfc8d83d9a2&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:14px;letter-spacing:1px;"><span style="font-size:14px;letter-spacing:1px;">回归树的原理及Python实现</span></a></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1.2 预测年龄</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">仍然以预测同事年龄来举例，从《回归树》那篇文章中我们可以知道，如果需要通过一个常量来预测同事的年龄，平均值是最佳选择之一。</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1.3 年龄的残差</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">我们不妨假设同事的年龄分别为5岁、6岁、7岁，那么同事的平均年龄就是6岁。所以我们用6岁这个常量来预测同事的年龄，即[6, 6, 6]。每个同事年龄的残差 = 年龄 - 预测值 = [5, 6, 7] - [6, 6, 6]，所以残差为[-1, 0, 1]</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1.4 预测年龄的残差</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">为了让模型更加准确，其中一个思路是让残差变小。如何减少残差呢？我们不妨对残差建立一颗回归树，然后预测出准确的残差。假设这棵树预测的残差是[-0.9, 0, 0.9]，将上一轮的预测值和这一轮的预测值求和，每个同事的年龄 = [6, 6, 6] + [-0.9, 0, 0.9] = [5.1, 6, 6.9]，显然与真实值[5, 6, 7]更加接近了， 年龄的残差此时变为[-0.1, 0, 0.1]，预测的准确性得到了提升。</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1.5 GBDT</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">重新整理一下思路，假设我们的预测一共迭代3轮 年龄：[5, 6, 7]</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">第1轮预测：[6, 6, 6] (平均值)</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">第1轮残差：[-1, 0, 1]</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">第2轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) = [5.1, 6, 6.9]</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">第2轮残差：[-0.1, 0, 0.1]</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">第3轮预测：[6, 6, 6] (平均值) + [-0.9, 0, 0.9] (第1颗回归树) + [-0.08, 0, 0.07] (第2颗回归树) = [5.02, 6, 6.97]</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">第3轮残差：[-0.08, 0, 0.03]</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">看上去残差越来越小，而这种预测方式就是GBDT算法。</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1.6 公式推导</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">看到这里，相信您对GBDT已经有了直观的认识。这么做有什么科学依据么，为什么残差可以越来越小呢？前方小段数学公式低能预警。</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/LiaGhAsRNtttViaAcia3J1ZoYrnB12qANG1J1AvP6jonZFq4el5ajqc1hCwia55vsDh3urHW1tehsru0iag9svPl2eg/640?wx_fmt=png" alt="640?wx_fmt=png"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/LiaGhAsRNtttViaAcia3J1ZoYrnB12qANG1CvDNMFnz8KHHvlv0iaxn270mvhKj0yibOwKd2bFOXByEiaacneib0jseOA/640?wx_fmt=png" alt="640?wx_fmt=png"><span style="font-size:14px;letter-spacing:1px;">因此，我们需要通过用第m-1轮残差的均值来得到函数fm，进而优化函数Fm。而回归树的原理就是通过最佳划分区域的均值来进行预测。所以fm可以选用回归树作为基础模型，将初始值，m-1颗回归树的预测值相加便可以预测y。</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2. 实现篇</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">本人用全宇宙最简单的编程语言——Python实现了GBDT回归算法，没有依赖任何第三方库，便于学习和使用。简单说明一下实现过程，更详细的注释请参考本人github上的代码。</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.1 导入回归树类</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">回归树是我之前已经写好的一个类，在之前的文章详细介绍过，代码请参考：</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">https://github.com/tushushu/imylu/blob/master/imylu/tree/regression_tree.py</span></p>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="kn" style="font-size:14px;letter-spacing:1px;font-weight:600;">from</span> <span class="nn" style="font-size:14px;letter-spacing:1px;color:rgb(100,100,100);">..tree.regression_tree</span> <span class="kn" style="font-size:14px;letter-spacing:1px;font-weight:600;">import</span> RegressionTree</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.2 创建GradientBoostingBase类</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">初始化，存储回归树、学习率、初始预测值和变换函数。（注：回归不需要做变换，因此函数的返回值等于参数）</span></p>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">class</span> <span class="nc" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(23,81,153);">GradientBoostingBase</span>(<span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">object</span>): &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> __init__(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span>): &nbsp; &nbsp; &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>trees <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">None</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>lr <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">None</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>init_val <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">None</span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>fn <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">lambda</span> x: x</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.3 计算初始预测值</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">初始预测值即y的平均值。</span></p>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> <span class="nf" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(241,64,60);">_get_init_val</span>(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span>, y): &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">return</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">sum</span>(y) <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">/</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">len</span>(y)</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.4 计算残差</span></h2>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> <span class="nf" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(241,64,60);">_get_residuals</span>(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span>, y, y_hat): &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">return</span> [yi <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">-</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>fn(y_hat_i) <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> yi, y_hat_i <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">zip</span>(y, y_hat)]</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.5 训练模型</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">训练模型的时候需要注意以下几点：</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1. 控制树的最大深度max_depth；</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2. 控制分裂时最少的样本量min_samples_split；</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">3. 训练每一棵回归树的时候要乘以一个学习率lr，防止模型过拟合；</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">4. 对样本进行抽样的时候要采用有放回的抽样方式。</span></p>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> <span class="nf" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(241,64,60);">fit</span>(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span>, X, y, n_estimators, lr, max_depth, min_samples_split, subsample<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span><span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">None</span>): &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>init_val <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>_get_init_val(y) &nbsp; &nbsp;n <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">len</span>(y) &nbsp; &nbsp;y_hat <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> [<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>init_val] <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">*</span> n &nbsp; &nbsp;residuals <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>_get_residuals(y, y_hat) &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>trees <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> [] &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>lr <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> lr &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> _ <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">range</span>(n_estimators): &nbsp; &nbsp; &nbsp; &nbsp;idx <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">range</span>(n) &nbsp; &nbsp; &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">if</span> subsample <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">is</span> <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">not</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">None</span>: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;k <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">int</span>(subsample <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">*</span> n) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;idx <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> choices(population<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span>idx, k<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span>k) &nbsp; &nbsp; &nbsp; &nbsp;X_sub <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> [X[i] <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> i <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> idx] &nbsp; &nbsp; &nbsp; &nbsp;residuals_sub <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> [residuals[i] <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> i <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> idx] &nbsp; &nbsp; &nbsp; &nbsp;y_hat_sub <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> [y_hat[i] <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> i <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> idx] &nbsp; &nbsp; &nbsp; &nbsp;tree <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> RegressionTree() &nbsp; &nbsp; &nbsp; &nbsp;tree<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>fit(X_sub, residuals_sub, max_depth, min_samples_split) &nbsp; &nbsp; &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>_update_score(tree, X_sub, y_hat_sub, residuals_sub) &nbsp; &nbsp; &nbsp; &nbsp;y_hat <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> [y_hat_i <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">+</span> lr <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">*</span> res_hat_i <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> y_hat_i, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;res_hat_i <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">zip</span>(y_hat, tree<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>predict(X))] &nbsp; &nbsp; &nbsp; &nbsp;residuals <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>_get_residuals(y, y_hat) &nbsp; &nbsp; &nbsp; &nbsp;<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>trees<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>append(tree)</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.6 预测一个样本</span></h2>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> <span class="nf" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(241,64,60);">_predict</span>(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span>, Xi): &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">return</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>fn(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>init_val <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">+</span> <span class="nb" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">sum</span>(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>lr <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">*</span> tree<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>_predict(Xi) <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> tree <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> <span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>trees))</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2.7 预测多个样本</span></h2>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;"><span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> <span class="nf" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(241,64,60);">predict</span>(<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span>, X): &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">return</span> [<span class="bp" style="font-size:14px;letter-spacing:1px;color:rgb(153,153,153);">self</span><span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>_predict(Xi) <span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">for</span> Xi <span class="ow" style="font-size:14px;letter-spacing:1px;font-weight:600;">in</span> X]</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">3 效果评估</span></h2>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">3.1 main函数</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">使用著名的波士顿房价数据集，按照7:3的比例拆分为训练集和测试集，训练模型，并统计准确度。</span></p>
   <p style="line-height:1.5em;margin-left:8px;"><code class="language-python" style="font-family:Menlo, Monaco, Consolas, 'Andale Mono', 'lucida console', 'Courier New', monospace;font-size:inherit;"><span style="font-size:14px;letter-spacing:1px;">@run_time<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">def</span> <span class="nf" style="font-size:14px;letter-spacing:1px;font-weight:600;color:rgb(241,64,60);">main</span>(): &nbsp; &nbsp;<span class="k" style="font-size:14px;letter-spacing:1px;font-weight:600;">print</span>(<span class="s2" style="font-size:14px;letter-spacing:1px;color:rgb(241,64,60);">"Tesing the accuracy of GBDT regressor..."</span>) &nbsp; &nbsp;X, y <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> load_boston_house_prices() &nbsp; &nbsp;X_train, X_test, y_train, y_test <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> train_test_split( &nbsp; &nbsp; &nbsp; &nbsp;X, y, random_state<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span><span class="mi" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">10</span>) &nbsp; &nbsp;reg <span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span> GradientBoostingRegressor() &nbsp; &nbsp;reg<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">.</span>fit(X<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span>X_train, y<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span>y_train, n_estimators<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span><span class="mi" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">4</span>, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lr<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span><span class="mf" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">0.5</span>, max_depth<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span><span class="mi" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">2</span>, min_samples_split<span class="o" style="font-size:14px;letter-spacing:1px;font-weight:600;">=</span><span class="mi" style="font-size:14px;letter-spacing:1px;color:rgb(0,132,255);">2</span>) &nbsp; &nbsp;get_r2(reg, X_test, y_test)</span></code></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">3.2 效果展示</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">最终拟合优度0.851，运行时间5.0秒，效果还算不错~</span></p>
   <figure style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:25.6px;text-indent:0px;text-transform:none;word-spacing:0px;">
    <img class="origin_image zh-lightbox-thumb lazy" width="440" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/LiaGhAsRNtttViaAcia3J1ZoYrnB12qANG1k7w2kBMYpRyexBdnKQibcAn1u9ttloX9XeGlVLFRB8NibwMMjibiaA2oiaw/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   </figure>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">3.3 工具函数</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">本人自定义了一些工具函数，可以在github上查看</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">https://github.com/tushushu/imylu/tree/master/imylu/utils</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">1. run_time - 测试函数运行时间</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">2. load_boston_house_prices - 加载波士顿房价数据</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">3. train_test_split - 拆分训练集、测试集</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">4. get_r2 - 计算拟合优度</span></p>
   <h2 style="font-style:normal;font-variant:normal;font-weight:600;font-size:1.2em;font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;color:rgb(26,26,26);letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">总结</span></h2>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">GBDT回归的原理：平均值加回归树</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;">GBDT回归的实现：加加减减for循环</span></p>
   <p style="color:rgb(26,26,26);font-family:'-apple-system', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Microsoft YaHei', 'Source Han Sans SC', 'Noto Sans CJK SC', 'WenQuanYi Micro Hei', sans-serif;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;text-indent:0px;text-transform:none;word-spacing:0px;line-height:1.5em;"><span style="font-size:14px;letter-spacing:1px;"><br></span></p>
   <blockquote>
    <p style="margin-left:.5em;"><span style="font-size:14px;color:rgb(153,153,153);">作者：李小文&nbsp;&nbsp;&nbsp; 算法工程师&nbsp;<br></span></p>
    <p><br></p>
    <p style="margin-left:.5em;"><span style="font-size:14px;color:rgb(153,153,153);">知乎专栏：</span></p>
    <p style="margin-left:.5em;"><span style="font-size:14px;color:rgb(153,153,153);">https://zhuanlan.zhihu.com/lixiaowen</span></p>
   </blockquote>
   <p style="min-height:1em;font-family:Arial, sans-serif;font-size:17px;letter-spacing:1.5px;line-height:1.75em;text-align:center;"><span style="text-align:center;letter-spacing:.5px;font-size:15px;color:rgb(51,102,255);">∞</span><span style="text-align:center;letter-spacing:.5px;font-size:15px;color:rgb(153,153,153);">∞∞∞</span><span style="text-align:center;letter-spacing:.5px;font-size:15px;color:rgb(255,153,0);">∞</span></p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/HM0Eu5N4Zuiacvcicgib2daRQ8m8nR6VfjiblOWQ0eXDjQMw0libYaW3EkCtq3U9tdgh2iagv3KpFkYpxUlSWdC3icYQg/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="margin-left:8px;text-align:center;line-height:1.75em;"><span style="font-size:18px;letter-spacing:.5px;color:rgb(51,51,51);">公众号回复</span><span style="font-size:18px;letter-spacing:.5px;color:rgb(54,65,173);">“IT派”</span><span style="font-size:18px;letter-spacing:.5px;color:rgb(51,51,51);">，</span></p>
   <p style="margin-left:8px;text-align:center;line-height:1.75em;"><span style="font-size:18px;"><span style="letter-spacing:.5px;color:rgb(51,51,51);">邀你加入&nbsp;</span></span><span style="font-size:18px;color:rgb(255,153,0);letter-spacing:.5px;">IT派&nbsp;{</span><span style="font-size:18px;color:rgb(255,153,0);letter-spacing:.5px;"> 深广创投圈 }&nbsp;</span></p> 
  </div> 
 </div> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
