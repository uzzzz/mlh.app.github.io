<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>fabric-ca 部署环境 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="fabric-ca 部署环境" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="fabric 中证书的生成可以采用官方提供的工具cryptogen命令生成，一种是通过fabric-ca服务生成。 准备： fabric 环境中有一个order，两个org，每个org 中有两个peer（同fabric exmaples/e2e-cli） 备注：后面涉及到的/opt/gopath/src/github.com/hyperledger/fabric 都替换成自己fabric源码的地址 开启fabric-ca 编译fabric-ca $ sudo apt install libtool libltdl-dev $ go get -u github.com/hyperledger/fabric-ca/cmd/... $ cd $GOPATH/bin 该命令执行完毕后，我们应该在~/go/bin下面看到生成的2个文件： fabric-ca-client&nbsp; fabric-ca-server 这里将fabric-ca部署在/opt/app/fabric-ca/server目录中： $ mkdir -p /opt/app/fabric-ca/server $ cp -rf /opt/gopath/bin/*&nbsp; /opt/app/fabric-ca/server $ ln -s /opt/app/fabric-ca/server/fabric-ca-client /usr/bin/fabric-ca-client 直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置) cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove --cfg.identities.allowremove &amp; 注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：HyperLedger FabricCA Config Database and LDAP。 生成fabric-ca admin的证书 cd ~ mkdir fabriccert mkdir fabric-ca-files 生成fabric-ca admin的凭证，用-H参数指定client目录： mkdir -p `pwd`/fabric-ca-files/admin fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin 也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。 export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin mkdir -p $FABRIC_CA_CLIENT_HOME fabric-ca-client enroll -u http://admin:pass@localhost:7054 为了防止混乱，后面的演示操作中，都直接用-H指定目录。 创建联盟 上面的启动方式默认会创建两个组织： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot; affiliation: . affiliation: org2 affiliation: org2.department1 affiliation: org1 affiliation: org1.department1 affiliation: org1.department2 为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org2 执行下面命令创建联盟： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org2 创建联盟如下： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 为每个组织准备msp 为example.com准备msp，将ca证书等存放example.com组织的目录中: mkdir -p ./fabric-ca-files/example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp 命令执行结束后，会在 fabric-ca-files/example.com/msp 得到文件： $ tree fabric-ca-files/example.com/msp/ example.com/msp/ |-- cacerts | `-- localhost-7054.pem |-- intermediatecerts | `-- localhost-7054.pem |-- keystore `-- signcerts 注意通过getcacert得到msp目录中只有CA证书。 同样的方式为org1.example.com获取msp: mkdir -p fabric-ca-files/org1.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp 为org2.example.com准备msp: mkdir -p ./fabric-ca-files/org2.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp 这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。 在1.1.0版本的fabric-ca中，只会生成组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书（tls证书）。这里继续沿用之前cryptogen生成的tls证书，在最后的重新部署操作，只会替换msp目录。 但是需要将验证tls证书的ca添加到msp目录中，如下： cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/ordererOrganizations/example.com/msp/tlscacerts&nbsp; fabric-ca-files/example.com/msp/ cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/ cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/ 如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。 注册example.com的管理员Admin@example.com 将 fabric-ca-files/admin/fabric-ca-client-config.yaml 其中的 id 部分修改为： id: name: Admin@example.com type: client affiliation: com.example maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀:ecert表示true 直接执行下面的命令，即可完成用户Admin@example.com注册，注意这时候的注册使用fabricCA的admin账号完成的： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 如果不用--id.secret指定密码，会自动生成密码。 其它配置的含义是用户名为Admin@example.com，类型是client，它能够管理com.example.*下的用户，如下: --id.name Admin@example.com //用户名 --id.type client //类型为client --id.affiliation &quot;com.example&quot; //权利访问 hf.Registrar.Roles=client,orderer,peer,user //能够管理的用户类型 hf.Registrar.DelegateRoles=client,orderer,peer,user //可以授权给子用户管理的用户类型 hf.Registrar.Attributes=* //可以为子用户设置所有属性 hf.GenCRL=true //可以生成撤销证书列表 hf.Revoker=true //可以撤销用户 hf.AffiliationMgr=true //能够管理联盟 hf.IntermediateCA=true //可以作为中间CA role=admin:ecert //自定义属性 生成Admin@example.com凭证： $ mkdir -p ./fabric-ca-files/example.com/admin $ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ 这时候可以用Admin@example.com的身份查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin 2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ mkdir fabric-ca-files/example.com/msp/admincerts/ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/msp/admincerts/ 只有这样，才能具备管理员权限。 注册org1.example.com的管理员Admin@org1.example.com 为org1.example.com的管理员Admin@org1.example.com准备一个目录: cd ~/fabriccert mkdir -p ./fabric-ca-files/org1.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org1.example.com type: client affiliation: com.example.org1 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/admin $ ls ./fabric-ca-files/org1.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin 2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 注意与Admin@example.com的区别，这里只能看到组织com.example.org1 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： mkdir fabric-ca-files/org1.example.com/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/msp/admincerts/ 在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* 注册org2.example.com的管理员Admin@org2.example.com 为org2.example.com的管理员Admin@org2.example.com准备一个目录: cd ~/fabriccert mkdir -p ./fabric-ca-files/org2.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org2.example.com type: client affiliation: com.example.org2 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/admin $ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin 2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org2 Admin@org2.example.com只能看到组织com.example.org2。 将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： mkdir fabric-ca-files/org2.example.com/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/msp/admincerts/ 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* 各个组织分别使用自己的Admin账户创建其它账号 example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 orderer.example.com 使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml: id: name: orderer.example.com type: orderer affiliation: com.example maxenrollments: 0 attributes: - name: role value: orderer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password mkdir ./fabric-ca-files/example.com/orderer fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer 将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： mkdir fabric-ca-files/example.com/orderer/msp/admincerts cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/ peer0.org1.example.com 使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer0 fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/ peer1.org1.example.com 使用Admin@org1.example.com注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer1 fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/ peer0.org2.example.com 使用Admin@org2.example.com注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer0 fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/ peer1.org2.example.com 使用Admin@org2.example.com注册账号peer1.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer1 fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer1/msp/admincerts/ 重新部署 修改configtx.yaml，将其中的msp路径修改为通过fabric-ca创建的msp目录: Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: /root/fabriccert/fabric-ca-files/example.com/msp - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: /root/fabriccert/fabric-ca-files/org1.example.com/msp AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: /root/fabriccert/fabric-ca-files/org2.example.com/msp AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations: 注意configtx.yaml中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。 更新orderer.example.com/中的msp： rm -rf orderer.example.com/msp/ cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/ 更新peer0.org1.example.com的msp: rm -rf peer0.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer0/msp peer0.org1.example.com/ 更新peer1.org1.example.com的msp: rm -rf peer1.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer1/msp peer1.org1.example.com/ 更新peer0.org2.example.com的msp: rm -rf peer0.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer0.org2.example.com/ 更新peer1.org2.example.com的msp: rm -rf peer1.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer1.org2.example.com/ 更新org1.example.com 的 admin cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/users rm -rf Admin@org1.example.com/ msp cp -rf /root/fabriccert/fabric-ca-files/org1.example.com/admin/msp Admin@org1.example.com 更新org2.example.com的admin cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/users rm -rf Admin@org2.example.com/ msp cp -rf /root/fabriccert/fabric-ca-files/org2.example.com/admin/msp Admin@org2.example.com fabric-ca 部署证书过程完成，可以启动网络，执行其他的操作了， 在执行创建channel过程中报错，Error: got unexpected status: BAD_REQUEST -- error authorizing update: error validating DeltaSet: policy for [Group]&nbsp; /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required 1 remaining 错误原因是cli 连接的peer0@org1.example.com 本地admin没有设置成ca生成的证书，还是使用之前的证书，替换之后不再报错。 在执行替换证书的过程中，一定要清楚要替换的证书的目录，否则很容易出现替换不完全，报错的情况 阅读更多" />
<meta property="og:description" content="fabric 中证书的生成可以采用官方提供的工具cryptogen命令生成，一种是通过fabric-ca服务生成。 准备： fabric 环境中有一个order，两个org，每个org 中有两个peer（同fabric exmaples/e2e-cli） 备注：后面涉及到的/opt/gopath/src/github.com/hyperledger/fabric 都替换成自己fabric源码的地址 开启fabric-ca 编译fabric-ca $ sudo apt install libtool libltdl-dev $ go get -u github.com/hyperledger/fabric-ca/cmd/... $ cd $GOPATH/bin 该命令执行完毕后，我们应该在~/go/bin下面看到生成的2个文件： fabric-ca-client&nbsp; fabric-ca-server 这里将fabric-ca部署在/opt/app/fabric-ca/server目录中： $ mkdir -p /opt/app/fabric-ca/server $ cp -rf /opt/gopath/bin/*&nbsp; /opt/app/fabric-ca/server $ ln -s /opt/app/fabric-ca/server/fabric-ca-client /usr/bin/fabric-ca-client 直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置) cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove --cfg.identities.allowremove &amp; 注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：HyperLedger FabricCA Config Database and LDAP。 生成fabric-ca admin的证书 cd ~ mkdir fabriccert mkdir fabric-ca-files 生成fabric-ca admin的凭证，用-H参数指定client目录： mkdir -p `pwd`/fabric-ca-files/admin fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin 也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。 export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin mkdir -p $FABRIC_CA_CLIENT_HOME fabric-ca-client enroll -u http://admin:pass@localhost:7054 为了防止混乱，后面的演示操作中，都直接用-H指定目录。 创建联盟 上面的启动方式默认会创建两个组织： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot; affiliation: . affiliation: org2 affiliation: org2.department1 affiliation: org1 affiliation: org1.department1 affiliation: org1.department2 为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org2 执行下面命令创建联盟： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org2 创建联盟如下： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 为每个组织准备msp 为example.com准备msp，将ca证书等存放example.com组织的目录中: mkdir -p ./fabric-ca-files/example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp 命令执行结束后，会在 fabric-ca-files/example.com/msp 得到文件： $ tree fabric-ca-files/example.com/msp/ example.com/msp/ |-- cacerts | `-- localhost-7054.pem |-- intermediatecerts | `-- localhost-7054.pem |-- keystore `-- signcerts 注意通过getcacert得到msp目录中只有CA证书。 同样的方式为org1.example.com获取msp: mkdir -p fabric-ca-files/org1.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp 为org2.example.com准备msp: mkdir -p ./fabric-ca-files/org2.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp 这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。 在1.1.0版本的fabric-ca中，只会生成组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书（tls证书）。这里继续沿用之前cryptogen生成的tls证书，在最后的重新部署操作，只会替换msp目录。 但是需要将验证tls证书的ca添加到msp目录中，如下： cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/ordererOrganizations/example.com/msp/tlscacerts&nbsp; fabric-ca-files/example.com/msp/ cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/ cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/ 如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。 注册example.com的管理员Admin@example.com 将 fabric-ca-files/admin/fabric-ca-client-config.yaml 其中的 id 部分修改为： id: name: Admin@example.com type: client affiliation: com.example maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀:ecert表示true 直接执行下面的命令，即可完成用户Admin@example.com注册，注意这时候的注册使用fabricCA的admin账号完成的： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 如果不用--id.secret指定密码，会自动生成密码。 其它配置的含义是用户名为Admin@example.com，类型是client，它能够管理com.example.*下的用户，如下: --id.name Admin@example.com //用户名 --id.type client //类型为client --id.affiliation &quot;com.example&quot; //权利访问 hf.Registrar.Roles=client,orderer,peer,user //能够管理的用户类型 hf.Registrar.DelegateRoles=client,orderer,peer,user //可以授权给子用户管理的用户类型 hf.Registrar.Attributes=* //可以为子用户设置所有属性 hf.GenCRL=true //可以生成撤销证书列表 hf.Revoker=true //可以撤销用户 hf.AffiliationMgr=true //能够管理联盟 hf.IntermediateCA=true //可以作为中间CA role=admin:ecert //自定义属性 生成Admin@example.com凭证： $ mkdir -p ./fabric-ca-files/example.com/admin $ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ 这时候可以用Admin@example.com的身份查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin 2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ mkdir fabric-ca-files/example.com/msp/admincerts/ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/msp/admincerts/ 只有这样，才能具备管理员权限。 注册org1.example.com的管理员Admin@org1.example.com 为org1.example.com的管理员Admin@org1.example.com准备一个目录: cd ~/fabriccert mkdir -p ./fabric-ca-files/org1.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org1.example.com type: client affiliation: com.example.org1 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/admin $ ls ./fabric-ca-files/org1.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin 2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 注意与Admin@example.com的区别，这里只能看到组织com.example.org1 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： mkdir fabric-ca-files/org1.example.com/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/msp/admincerts/ 在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* 注册org2.example.com的管理员Admin@org2.example.com 为org2.example.com的管理员Admin@org2.example.com准备一个目录: cd ~/fabriccert mkdir -p ./fabric-ca-files/org2.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org2.example.com type: client affiliation: com.example.org2 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/admin $ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin 2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org2 Admin@org2.example.com只能看到组织com.example.org2。 将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： mkdir fabric-ca-files/org2.example.com/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/msp/admincerts/ 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* 各个组织分别使用自己的Admin账户创建其它账号 example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 orderer.example.com 使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml: id: name: orderer.example.com type: orderer affiliation: com.example maxenrollments: 0 attributes: - name: role value: orderer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password mkdir ./fabric-ca-files/example.com/orderer fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer 将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： mkdir fabric-ca-files/example.com/orderer/msp/admincerts cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/ peer0.org1.example.com 使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer0 fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/ peer1.org1.example.com 使用Admin@org1.example.com注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer1 fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/ peer0.org2.example.com 使用Admin@org2.example.com注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer0 fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/ peer1.org2.example.com 使用Admin@org2.example.com注册账号peer1.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer1 fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer1/msp/admincerts/ 重新部署 修改configtx.yaml，将其中的msp路径修改为通过fabric-ca创建的msp目录: Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: /root/fabriccert/fabric-ca-files/example.com/msp - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: /root/fabriccert/fabric-ca-files/org1.example.com/msp AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: /root/fabriccert/fabric-ca-files/org2.example.com/msp AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations: 注意configtx.yaml中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。 更新orderer.example.com/中的msp： rm -rf orderer.example.com/msp/ cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/ 更新peer0.org1.example.com的msp: rm -rf peer0.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer0/msp peer0.org1.example.com/ 更新peer1.org1.example.com的msp: rm -rf peer1.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer1/msp peer1.org1.example.com/ 更新peer0.org2.example.com的msp: rm -rf peer0.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer0.org2.example.com/ 更新peer1.org2.example.com的msp: rm -rf peer1.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer1.org2.example.com/ 更新org1.example.com 的 admin cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/users rm -rf Admin@org1.example.com/ msp cp -rf /root/fabriccert/fabric-ca-files/org1.example.com/admin/msp Admin@org1.example.com 更新org2.example.com的admin cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/users rm -rf Admin@org2.example.com/ msp cp -rf /root/fabriccert/fabric-ca-files/org2.example.com/admin/msp Admin@org2.example.com fabric-ca 部署证书过程完成，可以启动网络，执行其他的操作了， 在执行创建channel过程中报错，Error: got unexpected status: BAD_REQUEST -- error authorizing update: error validating DeltaSet: policy for [Group]&nbsp; /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required 1 remaining 错误原因是cli 连接的peer0@org1.example.com 本地admin没有设置成ca生成的证书，还是使用之前的证书，替换之后不再报错。 在执行替换证书的过程中，一定要清楚要替换的证书的目录，否则很容易出现替换不完全，报错的情况 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-20T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"fabric 中证书的生成可以采用官方提供的工具cryptogen命令生成，一种是通过fabric-ca服务生成。 准备： fabric 环境中有一个order，两个org，每个org 中有两个peer（同fabric exmaples/e2e-cli） 备注：后面涉及到的/opt/gopath/src/github.com/hyperledger/fabric 都替换成自己fabric源码的地址 开启fabric-ca 编译fabric-ca $ sudo apt install libtool libltdl-dev $ go get -u github.com/hyperledger/fabric-ca/cmd/... $ cd $GOPATH/bin 该命令执行完毕后，我们应该在~/go/bin下面看到生成的2个文件： fabric-ca-client&nbsp; fabric-ca-server 这里将fabric-ca部署在/opt/app/fabric-ca/server目录中： $ mkdir -p /opt/app/fabric-ca/server $ cp -rf /opt/gopath/bin/*&nbsp; /opt/app/fabric-ca/server $ ln -s /opt/app/fabric-ca/server/fabric-ca-client /usr/bin/fabric-ca-client 直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置) cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove --cfg.identities.allowremove &amp; 注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：HyperLedger FabricCA Config Database and LDAP。 生成fabric-ca admin的证书 cd ~ mkdir fabriccert mkdir fabric-ca-files 生成fabric-ca admin的凭证，用-H参数指定client目录： mkdir -p `pwd`/fabric-ca-files/admin fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin 也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。 export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin mkdir -p $FABRIC_CA_CLIENT_HOME fabric-ca-client enroll -u http://admin:pass@localhost:7054 为了防止混乱，后面的演示操作中，都直接用-H指定目录。 创建联盟 上面的启动方式默认会创建两个组织： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot; affiliation: . affiliation: org2 affiliation: org2.department1 affiliation: org1 affiliation: org1.department1 affiliation: org1.department2 为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org2 执行下面命令创建联盟： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org2 创建联盟如下： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 为每个组织准备msp 为example.com准备msp，将ca证书等存放example.com组织的目录中: mkdir -p ./fabric-ca-files/example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp 命令执行结束后，会在 fabric-ca-files/example.com/msp 得到文件： $ tree fabric-ca-files/example.com/msp/ example.com/msp/ |-- cacerts | `-- localhost-7054.pem |-- intermediatecerts | `-- localhost-7054.pem |-- keystore `-- signcerts 注意通过getcacert得到msp目录中只有CA证书。 同样的方式为org1.example.com获取msp: mkdir -p fabric-ca-files/org1.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp 为org2.example.com准备msp: mkdir -p ./fabric-ca-files/org2.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp 这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。 在1.1.0版本的fabric-ca中，只会生成组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书（tls证书）。这里继续沿用之前cryptogen生成的tls证书，在最后的重新部署操作，只会替换msp目录。 但是需要将验证tls证书的ca添加到msp目录中，如下： cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/ordererOrganizations/example.com/msp/tlscacerts&nbsp; fabric-ca-files/example.com/msp/ cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/ cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/ 如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。 注册example.com的管理员Admin@example.com 将 fabric-ca-files/admin/fabric-ca-client-config.yaml 其中的 id 部分修改为： id: name: Admin@example.com type: client affiliation: com.example maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀:ecert表示true 直接执行下面的命令，即可完成用户Admin@example.com注册，注意这时候的注册使用fabricCA的admin账号完成的： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 如果不用--id.secret指定密码，会自动生成密码。 其它配置的含义是用户名为Admin@example.com，类型是client，它能够管理com.example.*下的用户，如下: --id.name Admin@example.com //用户名 --id.type client //类型为client --id.affiliation &quot;com.example&quot; //权利访问 hf.Registrar.Roles=client,orderer,peer,user //能够管理的用户类型 hf.Registrar.DelegateRoles=client,orderer,peer,user //可以授权给子用户管理的用户类型 hf.Registrar.Attributes=* //可以为子用户设置所有属性 hf.GenCRL=true //可以生成撤销证书列表 hf.Revoker=true //可以撤销用户 hf.AffiliationMgr=true //能够管理联盟 hf.IntermediateCA=true //可以作为中间CA role=admin:ecert //自定义属性 生成Admin@example.com凭证： $ mkdir -p ./fabric-ca-files/example.com/admin $ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ 这时候可以用Admin@example.com的身份查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin 2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ mkdir fabric-ca-files/example.com/msp/admincerts/ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/msp/admincerts/ 只有这样，才能具备管理员权限。 注册org1.example.com的管理员Admin@org1.example.com 为org1.example.com的管理员Admin@org1.example.com准备一个目录: cd ~/fabriccert mkdir -p ./fabric-ca-files/org1.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org1.example.com type: client affiliation: com.example.org1 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/admin $ ls ./fabric-ca-files/org1.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin 2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 注意与Admin@example.com的区别，这里只能看到组织com.example.org1 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： mkdir fabric-ca-files/org1.example.com/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/msp/admincerts/ 在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* 注册org2.example.com的管理员Admin@org2.example.com 为org2.example.com的管理员Admin@org2.example.com准备一个目录: cd ~/fabriccert mkdir -p ./fabric-ca-files/org2.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org2.example.com type: client affiliation: com.example.org2 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/admin $ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin 2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org2 Admin@org2.example.com只能看到组织com.example.org2。 将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： mkdir fabric-ca-files/org2.example.com/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/msp/admincerts/ 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* 各个组织分别使用自己的Admin账户创建其它账号 example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 orderer.example.com 使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml: id: name: orderer.example.com type: orderer affiliation: com.example maxenrollments: 0 attributes: - name: role value: orderer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password mkdir ./fabric-ca-files/example.com/orderer fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer 将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： mkdir fabric-ca-files/example.com/orderer/msp/admincerts cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/ peer0.org1.example.com 使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer0 fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/ peer1.org1.example.com 使用Admin@org1.example.com注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer1 fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/ peer0.org2.example.com 使用Admin@org2.example.com注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer0 fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/ peer1.org2.example.com 使用Admin@org2.example.com注册账号peer1.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer1 fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer1/msp/admincerts/ 重新部署 修改configtx.yaml，将其中的msp路径修改为通过fabric-ca创建的msp目录: Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: /root/fabriccert/fabric-ca-files/example.com/msp - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: /root/fabriccert/fabric-ca-files/org1.example.com/msp AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: /root/fabriccert/fabric-ca-files/org2.example.com/msp AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations: 注意configtx.yaml中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。 更新orderer.example.com/中的msp： rm -rf orderer.example.com/msp/ cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/ 更新peer0.org1.example.com的msp: rm -rf peer0.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer0/msp peer0.org1.example.com/ 更新peer1.org1.example.com的msp: rm -rf peer1.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer1/msp peer1.org1.example.com/ 更新peer0.org2.example.com的msp: rm -rf peer0.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer0.org2.example.com/ 更新peer1.org2.example.com的msp: rm -rf peer1.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer1.org2.example.com/ 更新org1.example.com 的 admin cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/users rm -rf Admin@org1.example.com/ msp cp -rf /root/fabriccert/fabric-ca-files/org1.example.com/admin/msp Admin@org1.example.com 更新org2.example.com的admin cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/users rm -rf Admin@org2.example.com/ msp cp -rf /root/fabriccert/fabric-ca-files/org2.example.com/admin/msp Admin@org2.example.com fabric-ca 部署证书过程完成，可以启动网络，执行其他的操作了， 在执行创建channel过程中报错，Error: got unexpected status: BAD_REQUEST -- error authorizing update: error validating DeltaSet: policy for [Group]&nbsp; /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required 1 remaining 错误原因是cli 连接的peer0@org1.example.com 本地admin没有设置成ca生成的证书，还是使用之前的证书，替换之后不再报错。 在执行替换证书的过程中，一定要清楚要替换的证书的目录，否则很容易出现替换不完全，报错的情况 阅读更多","@type":"BlogPosting","url":"/2018/06/20/ccdd5828dcb9dbf11b05ca483247e304.html","headline":"fabric-ca 部署环境","dateModified":"2018-06-20T00:00:00+08:00","datePublished":"2018-06-20T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/06/20/ccdd5828dcb9dbf11b05ca483247e304.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>fabric-ca 部署环境</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>fabric 中证书的生成可以采用官方提供的工具<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;">cryptogen</code><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">命令生成，一种是通过</span><code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;">fabric-ca服务</code><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">生成。</span></p>
  <h2><span style="color:rgb(51,51,51);background-color:rgb(255,255,255);"><span style="font-family:Arial;font-size:24px;">准备：</span></span></h2>
  <p><span style="font-family:'宋体';color:#333333;"><span style="font-size:15px;background-color:rgb(255,255,255);">fabric 环境中有一个order，两个org，每个org 中有两个peer（同fabric exmaples/e2e-cli）</span></span></p>
  <p><span style="font-family:'宋体';"><span style="font-size:15px;background-color:rgb(255,255,255);"><span style="color:#ff0000;">备注：后面涉及到的/opt/gopath/src/github.com/hyperledger/fabric 都替换成自己fabric源码的地址</span></span></span></p>
  <h2><span style="font-family:'Arial Black';font-size:24px;">开启fabric-ca</span></h2>
  <p>编译fabric-ca</p>
  <p><span style="font-family:'Courier New';font-size:12px;text-align:left;line-height:1.5;color:rgb(0,0,255);"></span></p>
  <pre><code class="language-html">$ sudo apt install libtool libltdl-dev

$ go get -u github.com/hyperledger/fabric-ca/cmd/... 
$ cd $GOPATH/bin</code></pre>
  <br>
  <pre style="text-align:left;font-family:'Courier New';"></pre>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);"><span style="background-color:rgb(245,250,254);color:rgb(0,0,0);font-family:Consolas, Inconsolata, Courier, monospace;font-size:12px;text-align:left;">该命令执行完毕后，我们应该在~/go/bin下面看到生成的2个文件：</span></p>
  <pre style="text-align:left;background-color:rgb(245,250,254);">fabric-ca-client&nbsp; fabric-ca-server</pre>
  <br>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">这里将fabric-ca部署在<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">/opt/app/fabric-ca/server</code>目录中：</p>
  <pre><code class="language-html">$ mkdir -p /opt/app/fabric-ca/server
$ cp -rf /opt/gopath/bin/*&nbsp; /opt/app/fabric-ca/server
$ ln -s /opt/app/fabric-ca/server/fabric-ca-client  /usr/bin/fabric-ca-client</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置)</span></p>
  <pre><code class="language-html">cd /opt/app/fabric-ca/server
./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove  --cfg.identities.allowremove &amp;</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：</span><a href="https://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html#configuring-the-database" rel="nofollow" title="HyperLedger FabricCA Config Database and LDAP" style="color:rgb(51,122,183);font-family:'宋体';font-size:15px;">HyperLedger FabricCA Config Database and LDAP</a><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">。</span></p>
  <h2><span style="color:rgb(51,51,51);background-color:rgb(255,255,255);"><span style="font-family:'Microsoft YaHei';font-size:24px;">生成fabric-ca admin的证书</span></span></h2>
  <pre><code class="language-html">cd ~
mkdir fabriccert
mkdir fabric-ca-files</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">生成fabric-ca admin的凭证，用</span><code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">-H</code><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">参数指定client目录：</span></p>
  <pre><code class="language-html">mkdir -p `pwd`/fabric-ca-files/admin
fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">也可以用环境变量</span><code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">FABRIC_CA_CLIENT_HOME</code><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">指定了client的工作目录，生成的用户凭证将存放在这个目录中。</span></p>
  <pre><code class="language-html">export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin
mkdir -p $FABRIC_CA_CLIENT_HOME
fabric-ca-client enroll -u http://admin:pass@localhost:7054</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">为了防止混乱，后面的演示操作中，都直接用</span><code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">-H</code><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">指定目录。</span></p>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';background-color:rgb(255,255,255);"></span></p>
  <h2 style="color:rgb(0,0,0);line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><span style="font-size:24px;">创建联盟</span></h2>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">上面的启动方式默认会创建两个组织：</p>
  <pre><code class="language-html">$ fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation list
2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 "OK"
affiliation: .
   affiliation: org2
      affiliation: org2.department1
   affiliation: org1
      affiliation: org1.department1
      affiliation: org1.department2</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';background-color:rgb(255,255,255);"><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除：</span></span></p>
  <pre><code class="language-html">fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation remove --force  org1
fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation remove --force  org2</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">执行下面命令创建联盟：</span></p>
  <pre><code class="language-html">fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com 
fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example
fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example.org1
fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example.org2</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">创建联盟如下：</span></p>
  <pre><code class="language-html">$ fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation list
2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org1
      affiliation: com.example.org2</code></pre>
  <h2 style="color:rgb(0,0,0);line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><span style="font-size:24px;">为每个组织准备msp</span></h2>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">为example.com准备msp，将ca证书等存放example.com组织的目录中:</span></p>
  <pre><code class="language-html">mkdir -p ./fabric-ca-files/example.com/msp
fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp    </code></pre>
  <span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">命令执行结束后，会在</span>
  <code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">fabric-ca-files/example.com/msp</code>
  <span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">得到文件：</span>
  <br>
  <pre><code class="language-html">$ tree fabric-ca-files/example.com/msp/
example.com/msp/
|-- cacerts
|   `-- localhost-7054.pem
|-- intermediatecerts
|   `-- localhost-7054.pem
|-- keystore
`-- signcerts</code></pre>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注意通过getcacert得到msp目录中只有CA证书。</p>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">同样的方式为org1.example.com获取msp:</p>
  <pre><code class="language-html">mkdir -p fabric-ca-files/org1.example.com/msp
fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp</code></pre>
  <span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">为org2.example.com准备msp:</span>
  <br>
  <pre><code class="language-html">mkdir -p ./fabric-ca-files/org2.example.com/msp
fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp</code></pre>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">这里是用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">getcacert</code>为每个组织准备需要的ca文件，在生成创始块的时候会用到。</p>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">在1.1.0版本的fabric-ca中，只会生成组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书（tls证书）。这里继续沿用之前<span style="color:rgb(199,37,78);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;background-color:rgb(249,242,244);">cryptogen生成</span>的tls证书，在最后的重新部署操作，只会替换msp目录。</p>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">但是需要将验证tls证书的ca添加到msp目录中，如下：</p>
  <pre><code class="language-html">cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/ordererOrganizations/example.com/msp/tlscacerts&nbsp; fabric-ca-files/example.com/msp/
cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/
cp -rf /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中</span><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);font-family:'宋体';font-size:15px;">。</span></p>
  <p><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);font-family:'宋体';"></span></p>
  <h2 style="color:rgb(0,0,0);line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><span style="font-size:24px;">注册example.com的管理员Admin@example.com</span></h2>
  <span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">将</span>
  <code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">fabric-ca-files/admin/fabric-ca-client-config.yaml</code>
  <span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">其中的</span>
  <code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">id</code>
  <span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">部分修改为：</span>
  <br>
  <pre><code class="language-html">id:
  name: Admin@example.com
  type: client
  affiliation: com.example
  maxenrollments: 0
  attributes:
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    - name: role
      value: admin
      ecert: true</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀</span><code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">:ecert</code><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">表示true</span></p>
  <p><span style="font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);"></span></p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">直接执行下面的命令，即可完成用户<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@example.com</code>注册，注意这时候的注册使用fabricCA的admin账号完成的：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">如果不用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">--id.secret</code>指定密码，会自动生成密码。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">其它配置的含义是用户名为<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@example.com</code>，类型是<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">client</code>，它能够管理<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">com.example.*</code>下的用户，如下:</p>
  <pre><code class="language-html">--id.name  Admin@example.com                           //用户名
--id.type client                                       //类型为client
--id.affiliation "com.example"                         //权利访问
hf.Registrar.Roles=client,orderer,peer,user            //能够管理的用户类型
hf.Registrar.DelegateRoles=client,orderer,peer,user    //可以授权给子用户管理的用户类型
hf.Registrar.Attributes=*                              //可以为子用户设置所有属性
hf.GenCRL=true                                         //可以生成撤销证书列表
hf.Revoker=true                                        //可以撤销用户
hf.AffiliationMgr=true                                 //能够管理联盟
hf.IntermediateCA=true                                 //可以作为中间CA
role=admin:ecert                                       //自定义属性</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">生成Admin@example.com凭证：</p>
  <pre><code class="language-html">$ mkdir -p ./fabric-ca-files/example.com/admin
$ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/example.com/admin
$ ls ./fabric-ca-files/example.com/admin
fabric-ca-client-config.yaml  msp/</code></pre>
  <br>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">这时候可以用Admin@example.com的身份查看联盟：</p>
  <pre><code class="language-html">$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin
2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org1
      affiliation: com.example.org2</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/</p>
  <pre><code class="language-html">mkdir fabric-ca-files/example.com/msp/admincerts/
cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/example.com/msp/admincerts/</code></pre>
  <br>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);"><span style="font-weight:700;">只有这样，才能具备管理员权限</span>。</p>
  <h2 style="color:rgb(0,0,0);font-size:22px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>注册org1.example.com的管理员Admin@org1.example.com</h2>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">为org1.example.com的管理员Admin@org1.example.com准备一个目录:</p>
  <pre><code class="language-html">cd ~/fabriccert
mkdir -p ./fabric-ca-files/org1.example.com/admin</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">id</code>部分修改为：</p>
  <pre><code class="language-html">id:
  name: Admin@org1.example.com
  type: client
  affiliation: com.example.org1
  maxenrollments: 0
  attributes:
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    - name: role
      value: admin
      ecert: true</code></pre>
  <br>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">生成凭证：</p>
  <pre><code class="language-html">$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/org1.example.com/admin
$ ls ./fabric-ca-files/org1.example.com/admin
fabric-ca-client-config.yaml  msp/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">查看联盟：</p>
  <pre><code class="language-html">$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin
2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org1</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注意与<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@example.com</code>的区别，这里只能看到组织com.example.org1</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org1.example.com/msp/admincerts/
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org1.example.com/msp/admincerts/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org1.example.com/admin/msp/admincerts/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</p>
  <pre><code class="language-html">rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/*</code></pre>
  <h2 style="color:rgb(0,0,0);font-size:22px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>注册org2.example.com的管理员Admin@org2.example.com</h2>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">为org2.example.com的管理员Admin@org2.example.com准备一个目录:</p>
  <pre><code class="language-html">cd ~/fabriccert
mkdir -p ./fabric-ca-files/org2.example.com/admin</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">id</code>部分修改为：</p>
  <pre><code class="language-html">id:
  name: Admin@org2.example.com
  type: client
  affiliation: com.example.org2
  maxenrollments: 0
  attributes:
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    - name: role
      value: admin
      ecert: true</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">生成凭证：</p>
  <pre><code class="language-html">$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/org2.example.com/admin
$ ls ./fabric-ca-files/org2.example.com/admin
fabric-ca-client-config.yaml  msp/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">查看联盟：</p>
  <pre><code class="language-html">$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin
2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org2</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">Admin@org2.example.com只能看到组织<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">com.example.org2</code>。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org2.example.com/msp/admincerts/
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org2.example.com/msp/admincerts/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org2.example.com/admin/msp/admincerts/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</p>
  <pre><code class="language-html">rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/*</code></pre>
  <h2 style="color:rgb(0,0,0);font-size:22px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>各个组织分别使用自己的Admin账户创建其它账号</h2>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。</p>
  <h3 style="color:rgb(0,0,0);font-size:20px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>orderer.example.com</h3>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">使用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@example.com</code>注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">example.com</code>/admin/。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml:</p>
  <pre><code class="language-html">id:
  name: orderer.example.com
  type: orderer
  affiliation: com.example
  maxenrollments: 0
  attributes:
    - name: role
      value: orderer
      ecert: true</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册以及生成凭证：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password
mkdir ./fabric-ca-files/example.com/orderer
fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@example.com</code>的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/example.com/orderer/msp/admincerts
cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/</code></pre>
  <h3 style="color:rgb(0,0,0);font-size:20px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>peer0.org1.example.com</h3>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">使用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org1.example.com</code>注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">org1.example.com</code>/admin/。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml:</p>
  <pre><code class="language-html">id:
  name: peer0.org1.example.com
  type: peer
  affiliation: com.example.org1
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册以及生成凭证：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org1.example.com/peer0
fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org1.example.com</code>的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/</code></pre>
  <h3 style="color:rgb(0,0,0);font-size:20px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>peer1.org1.example.com</h3>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">使用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org1.example.com</code>注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">org1.example.com</code>/admin/。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml:</p>
  <pre><code class="language-html">id:
  name: peer1.org1.example.com
  type: peer
  affiliation: com.example.org1
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册以及生成凭证：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org1.example.com/peer1
fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org1.example.com</code>的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/</code></pre>
  <h3 style="color:rgb(0,0,0);font-size:20px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a>peer0.org2.example.com</h3>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">使用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org2.example.com</code>注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">org2.example.com</code>/admin/。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml:</p>
  <pre><code class="language-html">id:
  name: peer0.org2.example.com
  type: peer
  affiliation: com.example.org2
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册以及生成凭证：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org2.example.com/peer0
fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org2.example.com</code>的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/</code></pre>
  <h2 style="color:rgb(0,0,0);font-size:22px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);"><a></a><br></h2>
  <p></p>
  <h3 style="color:rgb(0,0,0);font-size:20px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);">peer1.org2.example.com</h3>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">使用<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org2.example.com</code>注册账号peer1.org2.example.com。这时候指定的目录是fabric-ca-files/<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">org2.example.com</code>/admin/。</p>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml:</p>
  <pre><code class="language-html">id:
  name: peer1.org2.example.com
  type: peer
  affiliation: com.example.org2
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true</code></pre>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注册以及生成凭证：</p>
  <pre><code class="language-html">fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org2.example.com/peer1
fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1</code></pre>
  <p style="font-size:15px;color:rgb(51,51,51);line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">将<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">Admin@org2.example.com</code>的证书复制到fabric-ca-files/org2.example.com/peer1/msp/admincerts：</p>
  <pre><code class="language-html">mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer1/msp/admincerts/</code></pre>
  <h2 style="color:rgb(0,0,0);font-size:22px;line-height:1.1;font-family:'宋体';background-color:rgb(255,255,255);">重新部署</h2>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">修改<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">configtx.yaml</code>，将其中的msp路径修改为通过fabric-ca创建的msp目录:</p>
  <pre><code class="language-html"><span style="color:#333333;">Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: </span><span style="color:#ff0000;">/root/fabriccert/fabric-ca-files/example.com/msp</span><span style="color:#333333;"> - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: </span><span style="color:#ff0000;">/root/fabriccert/fabric-ca-files/org1.example.com/msp</span><span style="color:#333333;"> AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: </span><span style="color:#ff0000;">/root/fabriccert/fabric-ca-files/org2.example.com/msp</span><span style="color:#333333;"> AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations:</span></code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">注意<code class="highlighter-rouge" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13.5px;line-height:22px;">configtx.yaml</code>中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。</p>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">更新orderer.example.com/中的msp：</p>
  <pre><code class="language-html">rm -rf orderer.example.com/msp/ 
cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">更新peer0.org1.example.com的msp:</p>
  <pre><code class="language-html">rm -rf peer0.org1.example.com/msp/
cp -rf fabric-ca-files/org1.example.com/peer0/msp  peer0.org1.example.com/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">更新peer1.org1.example.com的msp:</p>
  <pre><code class="language-html">rm -rf peer1.org1.example.com/msp/
cp -rf fabric-ca-files/org1.example.com/peer1/msp  peer1.org1.example.com/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">更新peer0.org2.example.com的msp:</p>
  <pre><code class="language-html">rm -rf peer0.org2.example.com/msp/
cp -rf fabric-ca-files/org2.example.com/peer0/msp   peer0.org2.example.com/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">更新peer1.org2.example.com的msp:</p>
  <pre><code class="language-html">rm -rf peer1.org2.example.com/msp/
cp -rf fabric-ca-files/org2.example.com/peer0/msp   peer1.org2.example.com/</code></pre>
  <p style="color:rgb(51,51,51);font-size:15px;line-height:27px;font-family:'宋体';background-color:rgb(255,255,255);">更新org1.example.com 的 admin</p>
  <pre><code class="language-html">cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org1.example.com/users
rm -rf Admin@org1.example.com/ msp
cp -rf /root/fabriccert/fabric-ca-files/org1.example.com/admin/msp Admin@org1.example.com</code></pre>
  <p><span style="color:rgb(51,51,51);font-family:'宋体';font-size:15px;background-color:rgb(255,255,255);">更新org2.example.com的admin</span></p>
  <pre><code class="language-html">cd /opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/crypto-config/peerOrganizations/org2.example.com/users
rm -rf Admin@org2.example.com/ msp
cp -rf /root/fabriccert/fabric-ca-files/org2.example.com/admin/msp Admin@org2.example.com</code></pre>
  <p>fabric-ca 部署证书过程完成，可以启动网络，执行其他的操作了，</p>
  <p>在执行创建channel过程中报错，Error: got unexpected status: BAD_REQUEST -- error authorizing update: error validating DeltaSet: policy for [Group]&nbsp; /Channel/Application not satisfied: Failed to reach implicit threshold of 1 sub-policies, required 1 remaining</p>
  <p>错误原因是cli 连接的peer0@org1.example.com 本地admin没有设置成ca生成的证书，还是使用之前的证书，替换之后不再报错。</p>
  <p>在执行替换证书的过程中，一定要清楚要替换的证书的目录，否则很容易出现替换不完全，报错的情况</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/xxzjwdnlwx/article/details/80736670,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/xxzjwdnlwx/article/details/80736670,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
