<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>多机上启动多组织（4org）的fabric网络 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="多机上启动多组织（4org）的fabric网络" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="启动命令与过程与官方2org的相似，但由于组织增至了4个，所以无法用官方提供的scripts/scripts.sh脚本一键启动网络，具体分步操作如下： 一、初始化fabric环境 1.1 启动Fabric环境的容器 首先来启动orderer节点，在orderer服务器上运行： docker-compose -f docker-compose-orderer.yaml up –d 运行完毕后我们可以使用docker ps看到运行了一个名字为orderer.example.com的节点。 然后我们切换到peer0.org1.example.com服务器，启动本服务器的peer节点和cli，命令为： docker-compose -f docker-compose-peer.yaml up –d 运行完毕后我们使用docker ps应该可以看到2个正在运行的容器。 接下来依次在另外3台服务器运行启动peer节点容器的命令： docker-compose -f docker-compose-peer.yaml up –d 现在我们整个Fabric4+1服务器网络已经成型。 1.2 创建channel 切换到peer0.org1.example.com服务器上，使用该服务器上的cli来运行创建Channel和运行ChainCode的操作。首先进入cli容器： docker exec -it cli bash 进入容器后我们可以看到命令提示变为： root@b41e67d40583:/opt/gopath/src/github.com/hyperledger/fabric/peer# 说明我们已经以root的身份进入到cli容器内部。 创建Channel的命令是peer channel create，我们前面创建Channel的配置区块时，指定了Channel的名字是mychannel，那么这里我们必须创建同样名字的Channel。 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true --cafile $ORDERER_CA 执行该命令后，系统会提示： 2017-08-29 20:36:47.486 UTC [channelCmd] readBlock -&gt; DEBU 020 Received block:0 系统会在cli内部的当前目录创建一个mychannel.block文件，这个文件非常重要，接下来其他节点要加入这个Channel就必须使用这个文件。 1.3 各个peer加入channel #peer1加入channel peer channel join -b mychannel.block #修改环境变量，使peer2加入channel CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel join -b mychannel.block #修改环境变量，使peer3加入channel CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer channel join -b mychannel.block #修改环境变量，使peer4加入channel CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer channel join -b mychannel.block 1.4 更新锚节点 对于Org1来说，peer0.org1是锚节点，我们需要连接上它并更新锚节点，其他组织同理，peer0为锚节点： #更新org1的锚节点 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org2的锚节点 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org3的锚节点 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org3MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org4的锚节点 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org4MSPanchors.tx --tls true --cafile $ORDERER_CA 二、链上代码的安装与运行 以上，整个Fabric网络和Channel都准备完毕，接下来我们来安装和运行ChainCode。这里我们不用官方提供的Example02等链码，而是自己实现了一个招标投标的合约链码，放在/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go/mychaincode 目录下。该链码可以实现一个公司提出一条链路需求，其他公司针对该链路的每一段进行投标，最后招标公司每一段选出一个投标公司达成合约，或者关闭合约的功能。 2.1 Install ChainCode安装链上代码 #在peer1上安装链码 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer2上安装链码 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer3上安装链码 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer4上安装链码 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode 2.2 Instantiate ChainCode 实例化链上代码 实例化链上代码主要是在Peer所在的机器上对前面安装好的链上代码进行包装，生成对应Channel的Docker镜像和Docker容器。并且在实例化时我们可以指定背书策略。注意：一定要记得指定背书策略，且只有指定可以背书的组织才有写入账本的权利。实测4个组织时如果只指定Org1MSP和Org2MSP背书的话，则org3和org4无法写入账本。我们运行以下命令完成实例化： peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;,&#39;Org4MSP.member&#39;)&quot; 2.3升级链码 当需要对链码进行修改时，可以安装新的链码并进行升级。 注意：如果直接修改存放链码的目录或者修改链码文件本身，可能运行docker时链码并不会被修改，本人也很困惑。这种方法目前是可行的修改链码的方式。 2.3.1 安装新版本的链码 下面的命令跟之前的安装链码的命令相比，修改了-p后链码的路径，和-v后链码的版本，这里也说明1.0版本和1是不同的。 #在peer1上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer2上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer3上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer4上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu 2.3.2 升级链码 升级链码的命令和初始化类似，同样需要指定背书策略。 peer chaincode upgrade -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;,&#39;Org4MSP.member&#39;)&quot; 2.4 调用链码 2.4.1 合约创建 首先在peer1（192.168.3.222）上发起（创建）一个链路交易，Args为需要传入的json格式的参数，因为含有双引号，且不能用单引号和三引号替代，所以需有转义字符。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_create&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112000\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;:\&quot;lc1522512008\&quot;,\&quot;purchaser_user_code\&quot;:\&quot;CMCC\&quot;,\&quot;biding_start_time\&quot;: \&quot;1525104000\&quot;,\&quot;biding_end_time\&quot;:\&quot;1525881600\&quot;,\&quot;deal_time\&quot;:\&quot;\&quot;,\&quot;close_time\&quot;:\&quot;\&quot;,\&quot;contract_start_time\&quot;: \&quot;1527782400\&quot;,\&quot;contract_end_time\&quot;:\&quot;1559318400\&quot;,\&quot;link_start\&quot;: \&quot;Beijing\&quot;,\&quot;link_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_list\&quot;:[{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;:\&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;:\&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;:[]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;:\&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;:\&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;:[]}],\&quot;contract_status\&quot;:\&quot;yes\&quot;}&quot;]}&#39; -C mychannel 2.4.2 合约投标 接着在peer2（192.168.3.224）、peer3（192.168.3.225）、peer4（192.168.3.228）上依此对合约进行投标，投标的函数名为link_contract_biding，投标的参数内包含了投标公司的名称，价格，及可以提供的链路资源，如丢包率、带宽、传输速率等。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112006\&quot;,\&quot;user_code\&quot;: \&quot;CTCC\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;path_list\&quot;: [{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;: \&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CTCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CTCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]}],\&quot;contract_status\&quot;: \&quot;\&quot;}&quot;]}&#39; -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112006\&quot;,\&quot;user_code\&quot;: \&quot;CUCC\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;path_list\&quot;: [{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;: \&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CUCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CUCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]}],\&quot;contract_status\&quot;: \&quot;\&quot;}&quot;]}&#39; -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112006\&quot;,\&quot;user_code\&quot;: \&quot;algoblu\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;path_list\&quot;: [{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;: \&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;algoblu\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;algoblu\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]}],\&quot;contract_status\&quot;: \&quot;\&quot;}&quot;]}&#39; -C mychannel 2.4.3 合约达成 发起合约的公司对投标方进行选择，每段链路有且只有一个投标方中标。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;link_contract_deal&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112000\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;:\&quot;lc1522512008\&quot;,\&quot;deal_time\&quot;:\&quot;\&quot;,\&quot;path_list\&quot;:[{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;:\&quot;Tokyo\&quot;,\&quot;path_resource_list\&quot;:[{\&quot;supplyer_user_code\&quot;: \&quot;CTCC\&quot;,\&quot;path_deal_status\&quot;: \&quot;yes\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;:\&quot;NewYork\&quot;,\&quot;path_resource_list\&quot;:[{\&quot;supplyer_user_code\&quot;: \&quot;algoblu\&quot;,\&quot;path_deal_status\&quot;: \&quot;yes\&quot;}]}],\&quot;contract_status\&quot;:\&quot;deal\&quot;}&quot;]}&#39; 2.4.4 合约关闭 如果没有人投标或者投标没有合适的，则发起方关闭合约。一个合约的最终状态为达成/关闭。已经达成/关闭的合约无法再进行投标。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;link_contract_close&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112000\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;:\&quot;lc1522512008\&quot;,\&quot;close_time\&quot;: \&quot;1525881600\&quot;,\&quot;contract_status\&quot;:\&quot;close\&quot;}&quot;]}&#39; 2.4.5 查询合约 查询分为两种，查询全部和查询合约的最新状态，&quot;version_type&quot; 的值分别为last和whole 。如果是发起方进行查询，则可以查出该合约所有相关的投标招标信息，如果是投标方进行查询，则只能查到和自己有关的投标招标信息，而不能查出其他投标方的信息。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1527228705614\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;version_type\&quot;: \&quot;last\&quot;}&quot;]}&#39; 在一个peer上操作，在任意的peer上都可以查询出合约账本的内容，且每一个peer都可以进行读写操作，四个org的网络才算正常配置并启动。 三、遇到的问题 Error: exspect MspId Org4MSP, receice org4MSP 原因：Org4的docker-compose-peer.yaml把环境变量CORE_PEER_LOCALMSPID=“Org4MSP”错写成小写的org4MSP了。 chaincode error (status: 500, message: Cannot create ledger from genesis block, due to LedgerID already exists)) 原因：重复加入同一个channel Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err Could not load a valid signer certificate from directory /etc/hyperledger/fabric/msp/signcerts, err stat /etc/hyperledger/fabric/msp/signcerts: no such file or directory 原因：MSP证书没有生成或者和不对应 Error: Error endorsing invoke: rpc error: code = Unknown desc = Error executing chaincode: Failed to execute transaction (Timeout expired while executing transaction) -nil 原因：输入的参数格式不正确或者网络不好网速太慢 参考网址： 深入理解Fabric环境搭建的详细过程（步骤非常详细） Hyperledger Fabric 链码的介绍（讲了如何升级链码） Hyperledger Fabric Business Network 4 Organizations（我找到唯一一篇4个组织的参考，步骤也很细，讲了如何不用generateArtifacts.sh自己用命令行生成证书公私钥等） 阅读更多" />
<meta property="og:description" content="启动命令与过程与官方2org的相似，但由于组织增至了4个，所以无法用官方提供的scripts/scripts.sh脚本一键启动网络，具体分步操作如下： 一、初始化fabric环境 1.1 启动Fabric环境的容器 首先来启动orderer节点，在orderer服务器上运行： docker-compose -f docker-compose-orderer.yaml up –d 运行完毕后我们可以使用docker ps看到运行了一个名字为orderer.example.com的节点。 然后我们切换到peer0.org1.example.com服务器，启动本服务器的peer节点和cli，命令为： docker-compose -f docker-compose-peer.yaml up –d 运行完毕后我们使用docker ps应该可以看到2个正在运行的容器。 接下来依次在另外3台服务器运行启动peer节点容器的命令： docker-compose -f docker-compose-peer.yaml up –d 现在我们整个Fabric4+1服务器网络已经成型。 1.2 创建channel 切换到peer0.org1.example.com服务器上，使用该服务器上的cli来运行创建Channel和运行ChainCode的操作。首先进入cli容器： docker exec -it cli bash 进入容器后我们可以看到命令提示变为： root@b41e67d40583:/opt/gopath/src/github.com/hyperledger/fabric/peer# 说明我们已经以root的身份进入到cli容器内部。 创建Channel的命令是peer channel create，我们前面创建Channel的配置区块时，指定了Channel的名字是mychannel，那么这里我们必须创建同样名字的Channel。 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true --cafile $ORDERER_CA 执行该命令后，系统会提示： 2017-08-29 20:36:47.486 UTC [channelCmd] readBlock -&gt; DEBU 020 Received block:0 系统会在cli内部的当前目录创建一个mychannel.block文件，这个文件非常重要，接下来其他节点要加入这个Channel就必须使用这个文件。 1.3 各个peer加入channel #peer1加入channel peer channel join -b mychannel.block #修改环境变量，使peer2加入channel CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel join -b mychannel.block #修改环境变量，使peer3加入channel CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer channel join -b mychannel.block #修改环境变量，使peer4加入channel CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer channel join -b mychannel.block 1.4 更新锚节点 对于Org1来说，peer0.org1是锚节点，我们需要连接上它并更新锚节点，其他组织同理，peer0为锚节点： #更新org1的锚节点 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org2的锚节点 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org3的锚节点 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org3MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org4的锚节点 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org4MSPanchors.tx --tls true --cafile $ORDERER_CA 二、链上代码的安装与运行 以上，整个Fabric网络和Channel都准备完毕，接下来我们来安装和运行ChainCode。这里我们不用官方提供的Example02等链码，而是自己实现了一个招标投标的合约链码，放在/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go/mychaincode 目录下。该链码可以实现一个公司提出一条链路需求，其他公司针对该链路的每一段进行投标，最后招标公司每一段选出一个投标公司达成合约，或者关闭合约的功能。 2.1 Install ChainCode安装链上代码 #在peer1上安装链码 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer2上安装链码 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer3上安装链码 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer4上安装链码 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode 2.2 Instantiate ChainCode 实例化链上代码 实例化链上代码主要是在Peer所在的机器上对前面安装好的链上代码进行包装，生成对应Channel的Docker镜像和Docker容器。并且在实例化时我们可以指定背书策略。注意：一定要记得指定背书策略，且只有指定可以背书的组织才有写入账本的权利。实测4个组织时如果只指定Org1MSP和Org2MSP背书的话，则org3和org4无法写入账本。我们运行以下命令完成实例化： peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;,&#39;Org4MSP.member&#39;)&quot; 2.3升级链码 当需要对链码进行修改时，可以安装新的链码并进行升级。 注意：如果直接修改存放链码的目录或者修改链码文件本身，可能运行docker时链码并不会被修改，本人也很困惑。这种方法目前是可行的修改链码的方式。 2.3.1 安装新版本的链码 下面的命令跟之前的安装链码的命令相比，修改了-p后链码的路径，和-v后链码的版本，这里也说明1.0版本和1是不同的。 #在peer1上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer2上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer3上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer4上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu 2.3.2 升级链码 升级链码的命令和初始化类似，同样需要指定背书策略。 peer chaincode upgrade -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;,&#39;Org4MSP.member&#39;)&quot; 2.4 调用链码 2.4.1 合约创建 首先在peer1（192.168.3.222）上发起（创建）一个链路交易，Args为需要传入的json格式的参数，因为含有双引号，且不能用单引号和三引号替代，所以需有转义字符。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_create&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112000\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;:\&quot;lc1522512008\&quot;,\&quot;purchaser_user_code\&quot;:\&quot;CMCC\&quot;,\&quot;biding_start_time\&quot;: \&quot;1525104000\&quot;,\&quot;biding_end_time\&quot;:\&quot;1525881600\&quot;,\&quot;deal_time\&quot;:\&quot;\&quot;,\&quot;close_time\&quot;:\&quot;\&quot;,\&quot;contract_start_time\&quot;: \&quot;1527782400\&quot;,\&quot;contract_end_time\&quot;:\&quot;1559318400\&quot;,\&quot;link_start\&quot;: \&quot;Beijing\&quot;,\&quot;link_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_list\&quot;:[{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;:\&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;:\&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;:[]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;:\&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;:\&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;:[]}],\&quot;contract_status\&quot;:\&quot;yes\&quot;}&quot;]}&#39; -C mychannel 2.4.2 合约投标 接着在peer2（192.168.3.224）、peer3（192.168.3.225）、peer4（192.168.3.228）上依此对合约进行投标，投标的函数名为link_contract_biding，投标的参数内包含了投标公司的名称，价格，及可以提供的链路资源，如丢包率、带宽、传输速率等。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112006\&quot;,\&quot;user_code\&quot;: \&quot;CTCC\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;path_list\&quot;: [{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;: \&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CTCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CTCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]}],\&quot;contract_status\&quot;: \&quot;\&quot;}&quot;]}&#39; -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112006\&quot;,\&quot;user_code\&quot;: \&quot;CUCC\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;path_list\&quot;: [{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;: \&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CUCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;CUCC\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]}],\&quot;contract_status\&quot;: \&quot;\&quot;}&quot;]}&#39; -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112006\&quot;,\&quot;user_code\&quot;: \&quot;algoblu\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;path_list\&quot;: [{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;: \&quot;Tokyo\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;algoblu\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;: \&quot;NewYork\&quot;,\&quot;path_bandwidth\&quot;: \&quot;50Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_resource_list\&quot;: [{\&quot;supplyer_user_code\&quot;: \&quot;algoblu\&quot;,\&quot;path_bandwidth\&quot;: \&quot;100Mbps\&quot;,\&quot;path_packet_loss_rate\&quot;: \&quot;5%\&quot;,\&quot;path_avg_rtt\&quot;: \&quot;200ms\&quot;,\&quot;path_bandwidth_unit_price\&quot;: \&quot;200yuan\&quot;,\&quot;path_deal_status\&quot;: \&quot;\&quot;}]}],\&quot;contract_status\&quot;: \&quot;\&quot;}&quot;]}&#39; -C mychannel 2.4.3 合约达成 发起合约的公司对投标方进行选择，每段链路有且只有一个投标方中标。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;link_contract_deal&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112000\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;:\&quot;lc1522512008\&quot;,\&quot;deal_time\&quot;:\&quot;\&quot;,\&quot;path_list\&quot;:[{\&quot;path_start\&quot;: \&quot;Beijing\&quot;,\&quot;path_end\&quot;:\&quot;Tokyo\&quot;,\&quot;path_resource_list\&quot;:[{\&quot;supplyer_user_code\&quot;: \&quot;CTCC\&quot;,\&quot;path_deal_status\&quot;: \&quot;yes\&quot;}]},{\&quot;path_start\&quot;: \&quot;Tokyo\&quot;,\&quot;path_end\&quot;:\&quot;NewYork\&quot;,\&quot;path_resource_list\&quot;:[{\&quot;supplyer_user_code\&quot;: \&quot;algoblu\&quot;,\&quot;path_deal_status\&quot;: \&quot;yes\&quot;}]}],\&quot;contract_status\&quot;:\&quot;deal\&quot;}&quot;]}&#39; 2.4.4 合约关闭 如果没有人投标或者投标没有合适的，则发起方关闭合约。一个合约的最终状态为达成/关闭。已经达成/关闭的合约无法再进行投标。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;link_contract_close&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1522112000\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;:\&quot;lc1522512008\&quot;,\&quot;close_time\&quot;: \&quot;1525881600\&quot;,\&quot;contract_status\&quot;:\&quot;close\&quot;}&quot;]}&#39; 2.4.5 查询合约 查询分为两种，查询全部和查询合约的最新状态，&quot;version_type&quot; 的值分别为last和whole 。如果是发起方进行查询，则可以查出该合约所有相关的投标招标信息，如果是投标方进行查询，则只能查到和自己有关的投标招标信息，而不能查出其他投标方的信息。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;{\&quot;task_id\&quot;: \&quot;1527228705614\&quot;,\&quot;user_code\&quot;: \&quot;CMCC\&quot;,\&quot;contract_code\&quot;: \&quot;lc1522512008\&quot;,\&quot;version_type\&quot;: \&quot;last\&quot;}&quot;]}&#39; 在一个peer上操作，在任意的peer上都可以查询出合约账本的内容，且每一个peer都可以进行读写操作，四个org的网络才算正常配置并启动。 三、遇到的问题 Error: exspect MspId Org4MSP, receice org4MSP 原因：Org4的docker-compose-peer.yaml把环境变量CORE_PEER_LOCALMSPID=“Org4MSP”错写成小写的org4MSP了。 chaincode error (status: 500, message: Cannot create ledger from genesis block, due to LedgerID already exists)) 原因：重复加入同一个channel Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err Could not load a valid signer certificate from directory /etc/hyperledger/fabric/msp/signcerts, err stat /etc/hyperledger/fabric/msp/signcerts: no such file or directory 原因：MSP证书没有生成或者和不对应 Error: Error endorsing invoke: rpc error: code = Unknown desc = Error executing chaincode: Failed to execute transaction (Timeout expired while executing transaction) -nil 原因：输入的参数格式不正确或者网络不好网速太慢 参考网址： 深入理解Fabric环境搭建的详细过程（步骤非常详细） Hyperledger Fabric 链码的介绍（讲了如何升级链码） Hyperledger Fabric Business Network 4 Organizations（我找到唯一一篇4个组织的参考，步骤也很细，讲了如何不用generateArtifacts.sh自己用命令行生成证书公私钥等） 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/06/06/71fd6ce09a2e8e32065a912f9d356c36.html" />
<meta property="og:url" content="https://mlh.app/2018/06/06/71fd6ce09a2e8e32065a912f9d356c36.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-06T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"启动命令与过程与官方2org的相似，但由于组织增至了4个，所以无法用官方提供的scripts/scripts.sh脚本一键启动网络，具体分步操作如下： 一、初始化fabric环境 1.1 启动Fabric环境的容器 首先来启动orderer节点，在orderer服务器上运行： docker-compose -f docker-compose-orderer.yaml up –d 运行完毕后我们可以使用docker ps看到运行了一个名字为orderer.example.com的节点。 然后我们切换到peer0.org1.example.com服务器，启动本服务器的peer节点和cli，命令为： docker-compose -f docker-compose-peer.yaml up –d 运行完毕后我们使用docker ps应该可以看到2个正在运行的容器。 接下来依次在另外3台服务器运行启动peer节点容器的命令： docker-compose -f docker-compose-peer.yaml up –d 现在我们整个Fabric4+1服务器网络已经成型。 1.2 创建channel 切换到peer0.org1.example.com服务器上，使用该服务器上的cli来运行创建Channel和运行ChainCode的操作。首先进入cli容器： docker exec -it cli bash 进入容器后我们可以看到命令提示变为： root@b41e67d40583:/opt/gopath/src/github.com/hyperledger/fabric/peer# 说明我们已经以root的身份进入到cli容器内部。 创建Channel的命令是peer channel create，我们前面创建Channel的配置区块时，指定了Channel的名字是mychannel，那么这里我们必须创建同样名字的Channel。 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true --cafile $ORDERER_CA 执行该命令后，系统会提示： 2017-08-29 20:36:47.486 UTC [channelCmd] readBlock -&gt; DEBU 020 Received block:0 系统会在cli内部的当前目录创建一个mychannel.block文件，这个文件非常重要，接下来其他节点要加入这个Channel就必须使用这个文件。 1.3 各个peer加入channel #peer1加入channel peer channel join -b mychannel.block #修改环境变量，使peer2加入channel CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel join -b mychannel.block #修改环境变量，使peer3加入channel CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer channel join -b mychannel.block #修改环境变量，使peer4加入channel CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer channel join -b mychannel.block 1.4 更新锚节点 对于Org1来说，peer0.org1是锚节点，我们需要连接上它并更新锚节点，其他组织同理，peer0为锚节点： #更新org1的锚节点 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org2的锚节点 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org3的锚节点 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org3MSPanchors.tx --tls true --cafile $ORDERER_CA #更新org4的锚节点 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org4MSPanchors.tx --tls true --cafile $ORDERER_CA 二、链上代码的安装与运行 以上，整个Fabric网络和Channel都准备完毕，接下来我们来安装和运行ChainCode。这里我们不用官方提供的Example02等链码，而是自己实现了一个招标投标的合约链码，放在/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go/mychaincode 目录下。该链码可以实现一个公司提出一条链路需求，其他公司针对该链路的每一段进行投标，最后招标公司每一段选出一个投标公司达成合约，或者关闭合约的功能。 2.1 Install ChainCode安装链上代码 #在peer1上安装链码 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer2上安装链码 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer3上安装链码 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode #在peer4上安装链码 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/mychaincode 2.2 Instantiate ChainCode 实例化链上代码 实例化链上代码主要是在Peer所在的机器上对前面安装好的链上代码进行包装，生成对应Channel的Docker镜像和Docker容器。并且在实例化时我们可以指定背书策略。注意：一定要记得指定背书策略，且只有指定可以背书的组织才有写入账本的权利。实测4个组织时如果只指定Org1MSP和Org2MSP背书的话，则org3和org4无法写入账本。我们运行以下命令完成实例化： peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;,&#39;Org4MSP.member&#39;)&quot; 2.3升级链码 当需要对链码进行修改时，可以安装新的链码并进行升级。 注意：如果直接修改存放链码的目录或者修改链码文件本身，可能运行docker时链码并不会被修改，本人也很困惑。这种方法目前是可行的修改链码的方式。 2.3.1 安装新版本的链码 下面的命令跟之前的安装链码的命令相比，修改了-p后链码的路径，和-v后链码的版本，这里也说明1.0版本和1是不同的。 #在peer1上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer2上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer3上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org3MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer0.org3.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/users/Admin@org3.example.com/msp CORE_PEER_ADDRESS=peer0.org3.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu #在peer4上安装新版本的链码 CORE_PEER_LOCALMSPID=&quot;Org4MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/peers/peer0.org4.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org4.example.com/users/Admin@org4.example.com/msp CORE_PEER_ADDRESS=peer0.org4.example.com:7051 peer chaincode install -n mycc -v 1 -p github.com/hyperledger/fabric/examples/chaincode/go/algoblu 2.3.2 升级链码 升级链码的命令和初始化类似，同样需要指定背书策略。 peer chaincode upgrade -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;,&#39;Org4MSP.member&#39;)&quot; 2.4 调用链码 2.4.1 合约创建 首先在peer1（192.168.3.222）上发起（创建）一个链路交易，Args为需要传入的json格式的参数，因为含有双引号，且不能用单引号和三引号替代，所以需有转义字符。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_create&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1522112000\\&quot;,\\&quot;user_code\\&quot;: \\&quot;CMCC\\&quot;,\\&quot;contract_code\\&quot;:\\&quot;lc1522512008\\&quot;,\\&quot;purchaser_user_code\\&quot;:\\&quot;CMCC\\&quot;,\\&quot;biding_start_time\\&quot;: \\&quot;1525104000\\&quot;,\\&quot;biding_end_time\\&quot;:\\&quot;1525881600\\&quot;,\\&quot;deal_time\\&quot;:\\&quot;\\&quot;,\\&quot;close_time\\&quot;:\\&quot;\\&quot;,\\&quot;contract_start_time\\&quot;: \\&quot;1527782400\\&quot;,\\&quot;contract_end_time\\&quot;:\\&quot;1559318400\\&quot;,\\&quot;link_start\\&quot;: \\&quot;Beijing\\&quot;,\\&quot;link_end\\&quot;: \\&quot;NewYork\\&quot;,\\&quot;path_list\\&quot;:[{\\&quot;path_start\\&quot;: \\&quot;Beijing\\&quot;,\\&quot;path_end\\&quot;:\\&quot;Tokyo\\&quot;,\\&quot;path_bandwidth\\&quot;:\\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;:[]},{\\&quot;path_start\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_end\\&quot;:\\&quot;NewYork\\&quot;,\\&quot;path_bandwidth\\&quot;:\\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;:[]}],\\&quot;contract_status\\&quot;:\\&quot;yes\\&quot;}&quot;]}&#39; -C mychannel 2.4.2 合约投标 接着在peer2（192.168.3.224）、peer3（192.168.3.225）、peer4（192.168.3.228）上依此对合约进行投标，投标的函数名为link_contract_biding，投标的参数内包含了投标公司的名称，价格，及可以提供的链路资源，如丢包率、带宽、传输速率等。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1522112006\\&quot;,\\&quot;user_code\\&quot;: \\&quot;CTCC\\&quot;,\\&quot;contract_code\\&quot;: \\&quot;lc1522512008\\&quot;,\\&quot;path_list\\&quot;: [{\\&quot;path_start\\&quot;: \\&quot;Beijing\\&quot;,\\&quot;path_end\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;: [{\\&quot;supplyer_user_code\\&quot;: \\&quot;CTCC\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;100Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_bandwidth_unit_price\\&quot;: \\&quot;200yuan\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;\\&quot;}]},{\\&quot;path_start\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_end\\&quot;: \\&quot;NewYork\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;: [{\\&quot;supplyer_user_code\\&quot;: \\&quot;CTCC\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;100Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_bandwidth_unit_price\\&quot;: \\&quot;200yuan\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;\\&quot;}]}],\\&quot;contract_status\\&quot;: \\&quot;\\&quot;}&quot;]}&#39; -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1522112006\\&quot;,\\&quot;user_code\\&quot;: \\&quot;CUCC\\&quot;,\\&quot;contract_code\\&quot;: \\&quot;lc1522512008\\&quot;,\\&quot;path_list\\&quot;: [{\\&quot;path_start\\&quot;: \\&quot;Beijing\\&quot;,\\&quot;path_end\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;: [{\\&quot;supplyer_user_code\\&quot;: \\&quot;CUCC\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;100Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_bandwidth_unit_price\\&quot;: \\&quot;200yuan\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;\\&quot;}]},{\\&quot;path_start\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_end\\&quot;: \\&quot;NewYork\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;: [{\\&quot;supplyer_user_code\\&quot;: \\&quot;CUCC\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;100Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_bandwidth_unit_price\\&quot;: \\&quot;200yuan\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;\\&quot;}]}],\\&quot;contract_status\\&quot;: \\&quot;\\&quot;}&quot;]}&#39; -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;link_contract_biding&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1522112006\\&quot;,\\&quot;user_code\\&quot;: \\&quot;algoblu\\&quot;,\\&quot;contract_code\\&quot;: \\&quot;lc1522512008\\&quot;,\\&quot;path_list\\&quot;: [{\\&quot;path_start\\&quot;: \\&quot;Beijing\\&quot;,\\&quot;path_end\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;: [{\\&quot;supplyer_user_code\\&quot;: \\&quot;algoblu\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;100Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_bandwidth_unit_price\\&quot;: \\&quot;200yuan\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;\\&quot;}]},{\\&quot;path_start\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_end\\&quot;: \\&quot;NewYork\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;50Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_resource_list\\&quot;: [{\\&quot;supplyer_user_code\\&quot;: \\&quot;algoblu\\&quot;,\\&quot;path_bandwidth\\&quot;: \\&quot;100Mbps\\&quot;,\\&quot;path_packet_loss_rate\\&quot;: \\&quot;5%\\&quot;,\\&quot;path_avg_rtt\\&quot;: \\&quot;200ms\\&quot;,\\&quot;path_bandwidth_unit_price\\&quot;: \\&quot;200yuan\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;\\&quot;}]}],\\&quot;contract_status\\&quot;: \\&quot;\\&quot;}&quot;]}&#39; -C mychannel 2.4.3 合约达成 发起合约的公司对投标方进行选择，每段链路有且只有一个投标方中标。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;link_contract_deal&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1522112000\\&quot;,\\&quot;user_code\\&quot;: \\&quot;CMCC\\&quot;,\\&quot;contract_code\\&quot;:\\&quot;lc1522512008\\&quot;,\\&quot;deal_time\\&quot;:\\&quot;\\&quot;,\\&quot;path_list\\&quot;:[{\\&quot;path_start\\&quot;: \\&quot;Beijing\\&quot;,\\&quot;path_end\\&quot;:\\&quot;Tokyo\\&quot;,\\&quot;path_resource_list\\&quot;:[{\\&quot;supplyer_user_code\\&quot;: \\&quot;CTCC\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;yes\\&quot;}]},{\\&quot;path_start\\&quot;: \\&quot;Tokyo\\&quot;,\\&quot;path_end\\&quot;:\\&quot;NewYork\\&quot;,\\&quot;path_resource_list\\&quot;:[{\\&quot;supplyer_user_code\\&quot;: \\&quot;algoblu\\&quot;,\\&quot;path_deal_status\\&quot;: \\&quot;yes\\&quot;}]}],\\&quot;contract_status\\&quot;:\\&quot;deal\\&quot;}&quot;]}&#39; 2.4.4 合约关闭 如果没有人投标或者投标没有合适的，则发起方关闭合约。一个合约的最终状态为达成/关闭。已经达成/关闭的合约无法再进行投标。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;link_contract_close&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1522112000\\&quot;,\\&quot;user_code\\&quot;: \\&quot;CMCC\\&quot;,\\&quot;contract_code\\&quot;:\\&quot;lc1522512008\\&quot;,\\&quot;close_time\\&quot;: \\&quot;1525881600\\&quot;,\\&quot;contract_status\\&quot;:\\&quot;close\\&quot;}&quot;]}&#39; 2.4.5 查询合约 查询分为两种，查询全部和查询合约的最新状态，&quot;version_type&quot; 的值分别为last和whole 。如果是发起方进行查询，则可以查出该合约所有相关的投标招标信息，如果是投标方进行查询，则只能查到和自己有关的投标招标信息，而不能查出其他投标方的信息。 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1 -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;{\\&quot;task_id\\&quot;: \\&quot;1527228705614\\&quot;,\\&quot;user_code\\&quot;: \\&quot;CMCC\\&quot;,\\&quot;contract_code\\&quot;: \\&quot;lc1522512008\\&quot;,\\&quot;version_type\\&quot;: \\&quot;last\\&quot;}&quot;]}&#39; 在一个peer上操作，在任意的peer上都可以查询出合约账本的内容，且每一个peer都可以进行读写操作，四个org的网络才算正常配置并启动。 三、遇到的问题 Error: exspect MspId Org4MSP, receice org4MSP 原因：Org4的docker-compose-peer.yaml把环境变量CORE_PEER_LOCALMSPID=“Org4MSP”错写成小写的org4MSP了。 chaincode error (status: 500, message: Cannot create ledger from genesis block, due to LedgerID already exists)) 原因：重复加入同一个channel Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err Could not load a valid signer certificate from directory /etc/hyperledger/fabric/msp/signcerts, err stat /etc/hyperledger/fabric/msp/signcerts: no such file or directory 原因：MSP证书没有生成或者和不对应 Error: Error endorsing invoke: rpc error: code = Unknown desc = Error executing chaincode: Failed to execute transaction (Timeout expired while executing transaction) -nil 原因：输入的参数格式不正确或者网络不好网速太慢 参考网址： 深入理解Fabric环境搭建的详细过程（步骤非常详细） Hyperledger Fabric 链码的介绍（讲了如何升级链码） Hyperledger Fabric Business Network 4 Organizations（我找到唯一一篇4个组织的参考，步骤也很细，讲了如何不用generateArtifacts.sh自己用命令行生成证书公私钥等） 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/06/06/71fd6ce09a2e8e32065a912f9d356c36.html","headline":"多机上启动多组织（4org）的fabric网络","dateModified":"2018-06-06T00:00:00+08:00","datePublished":"2018-06-06T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/06/06/71fd6ce09a2e8e32065a912f9d356c36.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>多机上启动多组织（4org）的fabric网络</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <p>启动命令与过程与官方2org的相似，但由于组织增至了4个，所以无法用官方提供的scripts/scripts.sh脚本一键启动网络，具体分步操作如下：</p> 
  <h2 id="一初始化fabric环境">一、初始化fabric环境</h2> 
  <h3 id="11-启动fabric环境的容器">1.1 启动Fabric环境的容器</h3> 
  <p>首先来启动orderer节点，在orderer服务器上运行：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">docker<span class="hljs-attribute">-compose</span> <span class="hljs-attribute">-f</span> docker<span class="hljs-attribute">-compose</span><span class="hljs-attribute">-orderer</span><span class="hljs-built_in">.</span>yaml up –d</code></pre> 
  <p>运行完毕后我们可以使用docker ps看到运行了一个名字为orderer.example.com的节点。 <br> 然后我们切换到peer0.org1.example.com服务器，启动本服务器的peer节点和cli，命令为：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">docker<span class="hljs-attribute">-compose</span> <span class="hljs-attribute">-f</span> docker<span class="hljs-attribute">-compose</span><span class="hljs-attribute">-peer</span><span class="hljs-built_in">.</span>yaml up –d</code></pre> 
  <p>运行完毕后我们使用docker ps应该可以看到2个正在运行的容器。 <br> 接下来依次在另外3台服务器运行启动peer节点容器的命令：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">docker<span class="hljs-attribute">-compose</span> <span class="hljs-attribute">-f</span> docker<span class="hljs-attribute">-compose</span><span class="hljs-attribute">-peer</span><span class="hljs-built_in">.</span>yaml up –d</code></pre> 
  <p>现在我们整个Fabric4+1服务器网络已经成型。</p> 
  <h3 id="12-创建channel">1.2 创建channel</h3> 
  <p>切换到peer0.org1.example.com服务器上，使用该服务器上的cli来运行创建Channel和运行ChainCode的操作。首先进入cli容器：</p> 
  <pre class="prettyprint"><code class=" hljs bash">docker <span class="hljs-keyword">exec</span> -it cli bash</code></pre> 
  <p>进入容器后我们可以看到命令提示变为：</p> 
  <pre class="prettyprint"><code class=" hljs ruby">root<span class="hljs-variable">@b41e67d40583</span><span class="hljs-symbol">:/opt/gopath/src/github</span>.com/hyperledger/fabric/peer<span class="hljs-comment">#</span></code></pre> 
  <p>说明我们已经以root的身份进入到cli容器内部。 <br> 创建Channel的命令是peer channel create，我们前面创建Channel的配置区块时，指定了Channel的名字是mychannel，那么这里我们必须创建同样名字的Channel。</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">ORDERER_CA=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/ordererOrganizations/example<span class="hljs-preprocessor">.com</span>/orderers/orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/tlscacerts/tlsca<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-cert<span class="hljs-preprocessor">.pem</span>

peer channel create -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/channel<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA</code></pre> 
  <p>执行该命令后，系统会提示：</p> 
  <p>2017-08-29 20:36:47.486 UTC [channelCmd] readBlock -&gt; DEBU 020 Received block:0</p> 
  <p>系统会在cli内部的当前目录创建一个mychannel.block文件，这个文件非常重要，接下来其他节点要加入这个Channel就必须使用这个文件。</p> 
  <h3 id="13-各个peer加入channel">1.3 各个peer加入channel</h3> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor">#peer1加入channel</span>
peer channel join -b mychannel<span class="hljs-preprocessor">.block</span>

<span class="hljs-preprocessor">#修改环境变量，使peer2加入channel</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel join -b mychannel<span class="hljs-preprocessor">.block</span>

<span class="hljs-preprocessor">#修改环境变量，使peer3加入channel</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org3MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel join -b mychannel<span class="hljs-preprocessor">.block</span>

<span class="hljs-preprocessor">#修改环境变量，使peer4加入channel</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org4MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel join -b mychannel<span class="hljs-preprocessor">.block</span></code></pre> 
  <h3 id="14-更新锚节点">1.4 更新锚节点</h3> 
  <p>对于Org1来说，peer0.org1是锚节点，我们需要连接上它并更新锚节点，其他组织同理，peer0为锚节点：</p> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor">#更新org1的锚节点</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel update -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/Org1MSPanchors<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA

<span class="hljs-preprocessor">#更新org2的锚节点</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel update -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/Org2MSPanchors<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA

<span class="hljs-preprocessor">#更新org3的锚节点</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org3MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel update -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/Org3MSPanchors<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA

<span class="hljs-preprocessor">#更新org4的锚节点</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org4MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer channel update -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/Org4MSPanchors<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA</code></pre> 
  <h2 id="二链上代码的安装与运行">二、链上代码的安装与运行</h2> 
  <p>以上，整个Fabric网络和Channel都准备完毕，接下来我们来安装和运行ChainCode。这里我们不用官方提供的Example02等链码，而是自己实现了一个招标投标的合约链码，放在<code>/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go/mychaincode</code> 目录下。该链码可以实现一个公司提出一条链路需求，其他公司针对该链路的每一段进行投标，最后招标公司每一段选出一个投标公司达成合约，或者关闭合约的功能。</p> 
  <h3 id="21-install-chaincode安装链上代码">2.1 Install ChainCode安装链上代码</h3> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor">#在peer1上安装链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer chaincode install -n mycc -v <span class="hljs-number">1.0</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/mychaincode

<span class="hljs-preprocessor">#在peer2上安装链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer chaincode install -n mycc -v <span class="hljs-number">1.0</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/mychaincode

<span class="hljs-preprocessor">#在peer3上安装链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org3MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer chaincode install -n mycc -v <span class="hljs-number">1.0</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/mychaincode

<span class="hljs-preprocessor">#在peer4上安装链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org4MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer chaincode install -n mycc -v <span class="hljs-number">1.0</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/mychaincode</code></pre> 
  <h3 id="22-instantiate-chaincode-实例化链上代码">2.2 Instantiate ChainCode 实例化链上代码</h3> 
  <p>实例化链上代码主要是在Peer所在的机器上对前面安装好的链上代码进行包装，生成对应Channel的Docker镜像和Docker容器。并且在实例化时我们可以指定背书策略。<strong>注意：一定要记得指定背书策略，且只有指定可以背书的组织才有写入账本的权利。实测4个组织时如果只指定Org1MSP和Org2MSP背书的话，则org3和org4无法写入账本。</strong>我们运行以下命令完成实例化：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">peer chaincode instantiate <span class="hljs-attribute">-o</span> orderer<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com:<span class="hljs-number">7050</span> <span class="hljs-subst">--</span>tls <span class="hljs-literal">true</span> <span class="hljs-subst">--</span>cafile <span class="hljs-variable">$ORDERER_CA</span> <span class="hljs-attribute">-C</span> mychannel <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-v</span> <span class="hljs-number">1.0</span> <span class="hljs-attribute">-c</span> <span class="hljs-string">'{"Args":[]}'</span> <span class="hljs-attribute">-P</span> <span class="hljs-string">"OR ('Org1MSP.member','Org2MSP.member','Org3MSP.member','Org4MSP.member')"</span></code></pre> 
  <h3 id="23升级链码">2.3升级链码</h3> 
  <p>当需要对链码进行修改时，可以安装新的链码并进行升级。 <br> 注意：如果直接修改存放链码的目录或者修改链码文件本身，可能运行docker时链码并不会被修改，本人也很困惑。这种方法目前是可行的修改链码的方式。</p> 
  <h4 id="231-安装新版本的链码">2.3.1 安装新版本的链码</h4> 
  <p>下面的命令跟之前的安装链码的命令相比，修改了-p后链码的路径，和-v后链码的版本，这里也说明1.0版本和1是不同的。</p> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-preprocessor">#在peer1上安装新版本的链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer chaincode install -n mycc -v <span class="hljs-number">1</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/algoblu

<span class="hljs-preprocessor">#在peer2上安装新版本的链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer chaincode install -n mycc -v <span class="hljs-number">1</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/algoblu

<span class="hljs-preprocessor">#在peer3上安装新版本的链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org3MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>3<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer chaincode install -n mycc -v <span class="hljs-number">1</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/algoblu

<span class="hljs-preprocessor">#在peer4上安装新版本的链码</span>
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org4MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>4<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>

peer chaincode install -n mycc -v <span class="hljs-number">1</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/algoblu</code></pre> 
  <h4 id="232-升级链码">2.3.2 升级链码</h4> 
  <p>升级链码的命令和初始化类似，同样需要指定背书策略。</p> 
  <pre class="prettyprint"><code class=" hljs lasso">peer chaincode upgrade <span class="hljs-attribute">-o</span> orderer<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com:<span class="hljs-number">7050</span> <span class="hljs-subst">--</span>tls <span class="hljs-literal">true</span> <span class="hljs-subst">--</span>cafile <span class="hljs-variable">$ORDERER_CA</span> <span class="hljs-attribute">-C</span> mychannel <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-v</span> <span class="hljs-number">1</span> <span class="hljs-attribute">-c</span> <span class="hljs-string">'{"Args":[]}'</span> <span class="hljs-attribute">-P</span> <span class="hljs-string">"OR ('Org1MSP.member','Org2MSP.member','Org3MSP.member','Org4MSP.member')"</span></code></pre> 
  <h3 id="24-调用链码">2.4 调用链码</h3> 
  <h4 id="241-合约创建">2.4.1 合约创建</h4> 
  <p>首先在peer1（192.168.3.222）上发起（创建）一个链路交易，Args为需要传入的json格式的参数，因为含有双引号，且不能用单引号和三引号替代，所以需有转义字符。</p> 
  <pre class="prettyprint"><code class=" hljs tex">peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile <span class="hljs-formula">$ORDERER_CA -C mychannel -n mycc -v 1 -c '<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"link_contract_create","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1522112000<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CMCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>purchaser_user_code<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>CMCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>biding_start_time<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1525104000<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>biding_end_time<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>1525881600<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>deal_time<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span><span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>close_time<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span><span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_start_time<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1527782400<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_end_time<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>1559318400<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>link_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Beijing<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>link_end<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>NewYork<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Beijing<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-special">]</span><span class="hljs-special">}</span>,<span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>NewYork<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-special">]</span><span class="hljs-special">}</span><span class="hljs-special">]</span>,<span class="hljs-command">\"</span>contract_status<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>yes<span class="hljs-command">\"</span><span class="hljs-special">}</span>"<span class="hljs-special">]</span><span class="hljs-special">}</span>' -C mychannel</span></code></pre> 
  <h4 id="242-合约投标">2.4.2 合约投标</h4> 
  <p>接着在peer2（192.168.3.224）、peer3（192.168.3.225）、peer4（192.168.3.228）上依此对合约进行投标，投标的函数名为<code>link_contract_biding</code>，投标的参数内包含了投标公司的名称，价格，及可以提供的链路资源，如丢包率、带宽、传输速率等。</p> 
  <pre class="prettyprint"><code class=" hljs tex">peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile <span class="hljs-formula">$ORDERER_CA -n mycc -v 1 -c '<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"link_contract_biding","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1522112006<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CTCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Beijing<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>supplyer_user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CTCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>100Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth_unit_price<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200yuan<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_deal_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span><span class="hljs-command">\"</span><span class="hljs-special">}</span><span class="hljs-special">]</span><span class="hljs-special">}</span>,<span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>NewYork<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>supplyer_user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CTCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>100Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth_unit_price<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200yuan<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_deal_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span><span class="hljs-command">\"</span><span class="hljs-special">}</span><span class="hljs-special">]</span><span class="hljs-special">}</span><span class="hljs-special">]</span>,<span class="hljs-command">\"</span>contract_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span><span class="hljs-command">\"</span><span class="hljs-special">}</span>"<span class="hljs-special">]</span><span class="hljs-special">}</span>' -C mychannel peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $</span>ORDERER_CA -n mycc -v 1 -c '<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"link_contract_biding","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1522112006<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CUCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Beijing<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5<span class="hljs-comment">%\",\"path_avg_rtt\": \"200ms\",\"path_resource_list\": [{\"supplyer_user_code\": \"CUCC\",\"path_bandwidth\": \"100Mbps\",\"path_packet_loss_rate\": \"5%\",\"path_avg_rtt\": \"200ms\",\"path_bandwidth_unit_price\": \"200yuan\",\"path_deal_status\": \"\"}]},{\"path_start\": \"Tokyo\",\"path_end\": \"NewYork\",\"path_bandwidth\": \"50Mbps\",\"path_packet_loss_rate\": \"5%\",\"path_avg_rtt\": \"200ms\",\"path_resource_list\": [{\"supplyer_user_code\": \"CUCC\",\"path_bandwidth\": \"100Mbps\",\"path_packet_loss_rate\": \"5%\",\"path_avg_rtt\": \"200ms\",\"path_bandwidth_unit_price\": \"200yuan\",\"path_deal_status\": \"\"}]}],\"contract_status\": \"\"}"]}' -C mychannel</span>

peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile <span class="hljs-formula">$ORDERER_CA -n mycc -v 1 -c '<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"link_contract_biding","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1522112006<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>algoblu<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Beijing<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>supplyer_user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>algoblu<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>100Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth_unit_price<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200yuan<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_deal_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span><span class="hljs-command">\"</span><span class="hljs-special">}</span><span class="hljs-special">]</span><span class="hljs-special">}</span>,<span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>NewYork<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>50Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>: <span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>supplyer_user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>algoblu<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>100Mbps<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_packet_loss_rate<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>5%<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_avg_rtt<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200ms<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_bandwidth_unit_price<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>200yuan<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_deal_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span><span class="hljs-command">\"</span><span class="hljs-special">}</span><span class="hljs-special">]</span><span class="hljs-special">}</span><span class="hljs-special">]</span>,<span class="hljs-command">\"</span>contract_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span><span class="hljs-command">\"</span><span class="hljs-special">}</span>"<span class="hljs-special">]</span><span class="hljs-special">}</span>' -C mychannel</span></code></pre> 
  <h4 id="243-合约达成">2.4.3 合约达成</h4> 
  <p>发起合约的公司对投标方进行选择，每段链路有且只有一个投标方中标。</p> 
  <pre class="prettyprint"><code class=" hljs tex">peer chaincode invoke -o orderer.example.com:7050  --tls true --cafile <span class="hljs-formula">$ORDERER_CA -C mychannel -n mycc -v 1.0 -c'<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"link_contract_deal","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1522112000<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CMCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>deal_time<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span><span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Beijing<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>supplyer_user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CTCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_deal_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>yes<span class="hljs-command">\"</span><span class="hljs-special">}</span><span class="hljs-special">]</span><span class="hljs-special">}</span>,<span class="hljs-special">{</span><span class="hljs-command">\"</span>path_start<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>Tokyo<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_end<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>NewYork<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_resource_list<span class="hljs-command">\"</span>:<span class="hljs-special">[</span><span class="hljs-special">{</span><span class="hljs-command">\"</span>supplyer_user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>algoblu<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>path_deal_status<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>yes<span class="hljs-command">\"</span><span class="hljs-special">}</span><span class="hljs-special">]</span><span class="hljs-special">}</span><span class="hljs-special">]</span>,<span class="hljs-command">\"</span>contract_status<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>deal<span class="hljs-command">\"</span><span class="hljs-special">}</span>"<span class="hljs-special">]</span><span class="hljs-special">}</span>' </span></code></pre> 
  <h4 id="244-合约关闭">2.4.4 合约关闭</h4> 
  <p>如果没有人投标或者投标没有合适的，则发起方关闭合约。一个合约的最终状态为达成/关闭。已经达成/关闭的合约无法再进行投标。</p> 
  <pre class="prettyprint"><code class=" hljs tex">peer chaincode invoke -o orderer.example.com:7050  --tls true --cafile <span class="hljs-formula">$ORDERER_CA -C mychannel -n mycc -v 1.0 -c'<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"link_contract_close","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1522112000<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CMCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>close_time<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1525881600<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_status<span class="hljs-command">\"</span>:<span class="hljs-command">\"</span>close<span class="hljs-command">\"</span><span class="hljs-special">}</span>"<span class="hljs-special">]</span><span class="hljs-special">}</span>'</span></code></pre> 
  <h4 id="245-查询合约">2.4.5 查询合约</h4> 
  <p>查询分为两种，查询全部和查询合约的最新状态，<code>"version_type"</code> 的值分别为<code>last</code>和<code>whole</code> 。如果是发起方进行查询，则可以查出该合约所有相关的投标招标信息，如果是投标方进行查询，则只能查到和自己有关的投标招标信息，而不能查出其他投标方的信息。</p> 
  <pre class="prettyprint"><code class=" hljs tex">peer chaincode invoke -o orderer.example.com:7050  --tls true --cafile <span class="hljs-formula">$ORDERER_CA -C mychannel -n mycc -v 1 -c '<span class="hljs-special">{</span>"Args":<span class="hljs-special">[</span>"query","<span class="hljs-special">{</span><span class="hljs-command">\"</span>task_id<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>1527228705614<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>user_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>CMCC<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>contract_code<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>lc1522512008<span class="hljs-command">\"</span>,<span class="hljs-command">\"</span>version_type<span class="hljs-command">\"</span>: <span class="hljs-command">\"</span>last<span class="hljs-command">\"</span><span class="hljs-special">}</span>"<span class="hljs-special">]</span><span class="hljs-special">}</span>'</span></code></pre> 
  <p>在一个peer上操作，在任意的peer上都可以查询出合约账本的内容，且每一个peer都可以进行读写操作，四个org的网络才算正常配置并启动。</p> 
  <h2 id="三遇到的问题">三、遇到的问题</h2> 
  <blockquote> 
   <p>Error: exspect MspId Org4MSP, receice org4MSP</p> 
  </blockquote> 
  <p>原因：Org4的docker-compose-peer.yaml把环境变量<code>CORE_PEER_LOCALMSPID=“Org4MSP”</code>错写成小写的org4MSP了。</p> 
  <blockquote> 
   <p>chaincode error (status: 500, message: Cannot create ledger from genesis block, due to LedgerID already exists))</p> 
  </blockquote> 
  <p>原因：重复加入同一个channel</p> 
  <blockquote> 
   <p>Cannot run peer because error when setting up MSP from directory /etc/hyperledger/fabric/msp: err Could not load a valid signer certificate from directory /etc/hyperledger/fabric/msp/signcerts, err stat /etc/hyperledger/fabric/msp/signcerts: no such file or directory</p> 
  </blockquote> 
  <p>原因：MSP证书没有生成或者和不对应</p> 
  <blockquote> 
   <p>Error: Error endorsing invoke: rpc error: code = Unknown desc = Error executing chaincode: Failed to execute transaction (Timeout expired while executing transaction) -nil</p> 
  </blockquote> 
  <p>原因：输入的参数格式不正确或者网络不好网速太慢 <br> <strong>参考网址：</strong> <br> <a href="http://www.cnblogs.com/studyzy/p/7451276.html" rel="nofollow">深入理解Fabric环境搭建的详细过程</a>（步骤非常详细） <br> <a href="http://www.fujinliang.top/2018/02/03/Hyperledger-Fabric-%E9%93%BE%E7%A0%81%E7%9A%84%E4%BB%8B%E7%BB%8D/" rel="nofollow">Hyperledger Fabric 链码的介绍</a>（讲了如何升级链码） <br> <a href="https://github.com/PENHCHET/hyperledger-fabric-four-orgs" rel="nofollow">Hyperledger Fabric Business Network 4 Organizations</a>（我找到唯一一篇4个组织的参考，步骤也很细，讲了如何不用generateArtifacts.sh自己用命令行生成证书公私钥等）</p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/vivian_ll/article/details/80597668,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/vivian_ll/article/details/80597668,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
