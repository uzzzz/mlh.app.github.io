<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>fabric-1.0.6，多通道实现 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="fabric-1.0.6，多通道实现" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="原创文章，未经同意不得转载 fabric从1.0.0起就支持多通道技术，关于多通道的解释，本文不多赘述，可以自行google。 本文以 example的e2e_cli 为基础，在此上进行修改 需要注意的是，我在e2e_cli的基础上做了一定修改来启动fabric，如果照搬一下脚本，是运行不起来的，以下仅供参考 说明一下思路： 1、一条链对应：至少一个org，至少一个peer，至少一个chaincode 2、在一条链对应的基础上，对script.sh脚本进行修改 步骤： 1、已经执行 ./network_setup.sh up 2、修改 e2e_cli下&nbsp;generateArtifacts.sh 为 generateNewChannel.sh（见下文） 3、修改 e2e_cli下script文件夹内的script.sh 为 script_new_channel.sh（见下文） 4、先在虚拟机上直接运行&nbsp; ./generateNewChannel.sh [新通道名] &nbsp; &nbsp; &nbsp;后进入cli容器执行 ./script/script_new_channel.sh&nbsp;[新通道名] [新智能合约名] generateNewChannel.sh # author: Logan Tang 20180607-11:37 mail:39522361@qq.com # usage: Generate configuration for new channel CHANNEL_NAME=$1 DATE=`date &#39;+%Y%m%d_%H%M%S&#39;` echo echo &quot; *** start create new channel configuration,time: $DATE,CHANNEL_NAME:$CHANNEL_NAME ***&quot; echo export FABRIC_ROOT=$PWD/../.. export FABRIC_CFG_PATH=$PWD OS_ARCH=$(echo &quot;$(uname -s|tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;|sed &#39;s/mingw64_nt.*/windows/&#39;)-$(uname -m | sed &#39;s/x86_64/amd64/g&#39;)&quot; | awk &#39;{print tolower($0)}&#39;) function printHelp () { echo &quot;params error: arg1 should not be empty,arg1 for channel name&quot; } function validateArgs () { if [ -z &quot;${CHANNEL_NAME}&quot; ]; then printHelp exit 1 fi } ## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions function generateChannelArtifacts() { CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen if [ -f &quot;$CONFIGTXGEN&quot; ]; then echo &quot;Using configtxgen -&gt; $CONFIGTXGEN&quot; else echo &quot;Building configtxgen&quot; make -C $FABRIC_ROOT release fi echo &quot;##########################################################&quot; echo &quot;######### Generating Orderer Genesis block ##############&quot; echo &quot;##########################################################&quot; # Note: For some unknown reason (at least for now) the block file can&#39;t be # named orderer.genesis.block or the orderer will fail to launch! $CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block echo echo &quot;#################################################################&quot; echo &quot;### Generating channel configuration transaction &#39;channel.tx&#39; ###&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for HealthMSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/HealthMSPanchors.tx -channelID $CHANNEL_NAME -asOrg HealthMSP echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org2MSP ##########&quot; echo &quot;#################################################################&quot; echo } validateArgs generateChannelArtifacts echo echo &quot; *** create new channel configuration success *** &quot; echo script_new_channel.sh # author: Logan Tang 20180607-11:37 mail:39522361@qq.com # usage: Create new channel to container CHANNEL_NAME=&quot;$1&quot; CHAINCODE_NAME=&quot;$2&quot; #: ${CHANNEL_NAME:=&quot;bgilifechain&quot;} : ${TIMEOUT:=&quot;60&quot;} COUNTER=1 MAX_RETRY=5 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/bgiblockchain.com/orderers/orderer.bgiblockchain.com/msp/tlscacerts/tlsca.bgiblockchain.com-cert.pem echo echo &quot;====== start create new channel ======&quot; echo &quot;CHANNEL_NAME name : &quot;$CHANNEL_NAME echo &quot;CHAINCODE_NAME name : &quot;$CHAINCODE_NAME echo function printHelp () { echo &quot;arg1/arg2 should not be empty,arg1 for channel name,arg2 for chaincode name&quot; } function validateArgs () { if [ -z &quot;${CHANNEL_NAME}&quot; ]; then printHelp exit 1 fi if [ -z &quot;${CHAINCODE_NAME}&quot; ]; then printHelp exit 1 fi } verifyResult () { if [ $1 -ne 0 ] ; then echo &quot;!!!!!!!!!!!!!!! &quot;$2&quot; !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } setGlobals () { CORE_PEER_LOCALMSPID=&quot;HealthMSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/peers/peer0.health.bgiblockchain.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/users/Admin@health.bgiblockchain.com/msp if [ $1 -eq 0 ]; then CORE_PEER_ADDRESS=peer0.health.bgiblockchain.com:7051 elif [ $1 -eq 1 ]; then CORE_PEER_ADDRESS=peer1.health.bgiblockchain.com:7051 elif [ $1 -eq 2 ]; then CORE_PEER_ADDRESS=peer2.health.bgiblockchain.com:7151 elif [ $1 -eq 3 ]; then CORE_PEER_ADDRESS=peer3.health.bgiblockchain.com:7151 elif [ $1 -eq 4 ]; then CORE_PEER_ADDRESS=peer4.health.bgiblockchain.com:7251 elif [ $1 -eq 5 ]; then CORE_PEER_ADDRESS=peer5.health.bgiblockchain.com:7251 elif [ $1 -eq 6 ]; then CORE_PEER_ADDRESS=peer6.health.bgiblockchain.com:7351 else CORE_PEER_ADDRESS=peer7.health.bgiblockchain.com:7351 fi env |grep CORE } createChannel() { setGlobals 0 if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt else peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Channel creation failed&quot; echo &quot;===================== Channel \&quot;$CHANNEL_NAME\&quot; is created successfully ===================== &quot; echo } updateAnchorPeers() { PEER=$1 setGlobals $PEER if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt else peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Anchor peer update failed&quot; echo &quot;===================== Anchor peers for org \&quot;$CORE_PEER_LOCALMSPID\&quot; on \&quot;$CHANNEL_NAME\&quot; is updated successfully ===================== &quot; sleep 5 echo } ## Sometimes Join takes time hence RETRY atleast for 5 times joinWithRetry () { peer channel join -b $CHANNEL_NAME.block &gt;&amp;log.txt res=$? cat log.txt if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then COUNTER=` expr $COUNTER + 1` echo &quot;PEER$1 failed to join the channel, Retry after 2 seconds&quot; sleep 2 joinWithRetry $1 else COUNTER=1 fi verifyResult $res &quot;After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel&quot; } joinChannel () { for ch in 0 1 2 3 4 5 6 7; do setGlobals $ch joinWithRetry $ch echo &quot;===================== PEER$ch joined on the channel \&quot;$CHANNEL_NAME\&quot; ===================== &quot; sleep 2 echo done } installChaincode () { PEER=$1 setGlobals $PEER peer chaincode install -n $CHAINCODE_NAME -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt res=$? cat log.txt verifyResult $res &quot;Chaincode installation on remote peer PEER$PEER has Failed&quot; echo &quot;===================== Chaincode is installed on remote peer PEER$PEER ===================== &quot; echo } instantiateChaincode () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode instantiate -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;HealthMSP.member&#39;)&quot; &gt;&amp;log.txt else peer chaincode instantiate -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;HealthMSP.member&#39;)&quot; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Chaincode instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; failed&quot; echo &quot;===================== Chaincode Instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } chaincodeQuery () { PEER=$1 echo &quot;===================== Querying on PEER$PEER on channel &#39;$CHANNEL_NAME&#39;... ===================== &quot; setGlobals $PEER local rc=1 local starttime=$(date +%s) # continue to poll # we either get a successful response, or reach TIMEOUT while test &quot;$(($(date +%s)-starttime))&quot; -lt &quot;$TIMEOUT&quot; -a $rc -ne 0 do sleep 3 echo &quot;Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs&quot; peer chaincode query -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &gt;&amp;log.txt test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk &#39;/Query Result/ {print $NF}&#39;) test &quot;$VALUE&quot; = &quot;$2&quot; &amp;&amp; let rc=0 done echo cat log.txt if test $rc -eq 0 ; then echo &quot;===================== Query on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; else echo &quot;!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } chaincodeInvoke () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode invoke -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt else peer chaincode invoke -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Invoke execution on PEER$PEER failed &quot; echo &quot;===================== Invoke transaction on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } validateArgs ## Create channel echo &quot;Creating channel...&quot; createChannel ## Join all the peers to the channel echo &quot;Having all peers join the channel...&quot; joinChannel ## Set the anchor peers for each org in the channel echo &quot;Updating anchor peers for org1...&quot; updateAnchorPeers 0 echo &quot;Updating anchor peers for org2...&quot; #updateAnchorPeers 2 ## Install chaincode on Peer0/Health and Peer2/Org2 echo &quot;Installing chaincode on org1/peer0...&quot; installChaincode 0 echo &quot;Install chaincode on org2/peer2...&quot; installChaincode 2 #Instantiate chaincode on Peer2/Org2 echo &quot;Instantiating chaincode on org2/peer2...&quot; instantiateChaincode 2 #Query on chaincode on Peer0/Health echo &quot;Querying chaincode on org1/peer0...&quot; chaincodeQuery 0 100 #Invoke on chaincode on Peer0/Health echo &quot;Sending invoke transaction on org1/peer0...&quot; chaincodeInvoke 0 ## Install chaincode on Peer3/Org2 echo &quot;Installing chaincode on org2/peer3...&quot; installChaincode 1 installChaincode 3 installChaincode 4 installChaincode 5 installChaincode 6 installChaincode 7 #Query on chaincode on Peer3/Org2, check if the result is 90 echo &quot;Querying chaincode on org2/peer3...&quot; chaincodeQuery 1 90 echo echo &quot;===================== All GOOD ===================== &quot; echo exit 0 阅读更多" />
<meta property="og:description" content="原创文章，未经同意不得转载 fabric从1.0.0起就支持多通道技术，关于多通道的解释，本文不多赘述，可以自行google。 本文以 example的e2e_cli 为基础，在此上进行修改 需要注意的是，我在e2e_cli的基础上做了一定修改来启动fabric，如果照搬一下脚本，是运行不起来的，以下仅供参考 说明一下思路： 1、一条链对应：至少一个org，至少一个peer，至少一个chaincode 2、在一条链对应的基础上，对script.sh脚本进行修改 步骤： 1、已经执行 ./network_setup.sh up 2、修改 e2e_cli下&nbsp;generateArtifacts.sh 为 generateNewChannel.sh（见下文） 3、修改 e2e_cli下script文件夹内的script.sh 为 script_new_channel.sh（见下文） 4、先在虚拟机上直接运行&nbsp; ./generateNewChannel.sh [新通道名] &nbsp; &nbsp; &nbsp;后进入cli容器执行 ./script/script_new_channel.sh&nbsp;[新通道名] [新智能合约名] generateNewChannel.sh # author: Logan Tang 20180607-11:37 mail:39522361@qq.com # usage: Generate configuration for new channel CHANNEL_NAME=$1 DATE=`date &#39;+%Y%m%d_%H%M%S&#39;` echo echo &quot; *** start create new channel configuration,time: $DATE,CHANNEL_NAME:$CHANNEL_NAME ***&quot; echo export FABRIC_ROOT=$PWD/../.. export FABRIC_CFG_PATH=$PWD OS_ARCH=$(echo &quot;$(uname -s|tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;|sed &#39;s/mingw64_nt.*/windows/&#39;)-$(uname -m | sed &#39;s/x86_64/amd64/g&#39;)&quot; | awk &#39;{print tolower($0)}&#39;) function printHelp () { echo &quot;params error: arg1 should not be empty,arg1 for channel name&quot; } function validateArgs () { if [ -z &quot;${CHANNEL_NAME}&quot; ]; then printHelp exit 1 fi } ## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions function generateChannelArtifacts() { CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen if [ -f &quot;$CONFIGTXGEN&quot; ]; then echo &quot;Using configtxgen -&gt; $CONFIGTXGEN&quot; else echo &quot;Building configtxgen&quot; make -C $FABRIC_ROOT release fi echo &quot;##########################################################&quot; echo &quot;######### Generating Orderer Genesis block ##############&quot; echo &quot;##########################################################&quot; # Note: For some unknown reason (at least for now) the block file can&#39;t be # named orderer.genesis.block or the orderer will fail to launch! $CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block echo echo &quot;#################################################################&quot; echo &quot;### Generating channel configuration transaction &#39;channel.tx&#39; ###&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for HealthMSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/HealthMSPanchors.tx -channelID $CHANNEL_NAME -asOrg HealthMSP echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org2MSP ##########&quot; echo &quot;#################################################################&quot; echo } validateArgs generateChannelArtifacts echo echo &quot; *** create new channel configuration success *** &quot; echo script_new_channel.sh # author: Logan Tang 20180607-11:37 mail:39522361@qq.com # usage: Create new channel to container CHANNEL_NAME=&quot;$1&quot; CHAINCODE_NAME=&quot;$2&quot; #: ${CHANNEL_NAME:=&quot;bgilifechain&quot;} : ${TIMEOUT:=&quot;60&quot;} COUNTER=1 MAX_RETRY=5 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/bgiblockchain.com/orderers/orderer.bgiblockchain.com/msp/tlscacerts/tlsca.bgiblockchain.com-cert.pem echo echo &quot;====== start create new channel ======&quot; echo &quot;CHANNEL_NAME name : &quot;$CHANNEL_NAME echo &quot;CHAINCODE_NAME name : &quot;$CHAINCODE_NAME echo function printHelp () { echo &quot;arg1/arg2 should not be empty,arg1 for channel name,arg2 for chaincode name&quot; } function validateArgs () { if [ -z &quot;${CHANNEL_NAME}&quot; ]; then printHelp exit 1 fi if [ -z &quot;${CHAINCODE_NAME}&quot; ]; then printHelp exit 1 fi } verifyResult () { if [ $1 -ne 0 ] ; then echo &quot;!!!!!!!!!!!!!!! &quot;$2&quot; !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } setGlobals () { CORE_PEER_LOCALMSPID=&quot;HealthMSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/peers/peer0.health.bgiblockchain.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/users/Admin@health.bgiblockchain.com/msp if [ $1 -eq 0 ]; then CORE_PEER_ADDRESS=peer0.health.bgiblockchain.com:7051 elif [ $1 -eq 1 ]; then CORE_PEER_ADDRESS=peer1.health.bgiblockchain.com:7051 elif [ $1 -eq 2 ]; then CORE_PEER_ADDRESS=peer2.health.bgiblockchain.com:7151 elif [ $1 -eq 3 ]; then CORE_PEER_ADDRESS=peer3.health.bgiblockchain.com:7151 elif [ $1 -eq 4 ]; then CORE_PEER_ADDRESS=peer4.health.bgiblockchain.com:7251 elif [ $1 -eq 5 ]; then CORE_PEER_ADDRESS=peer5.health.bgiblockchain.com:7251 elif [ $1 -eq 6 ]; then CORE_PEER_ADDRESS=peer6.health.bgiblockchain.com:7351 else CORE_PEER_ADDRESS=peer7.health.bgiblockchain.com:7351 fi env |grep CORE } createChannel() { setGlobals 0 if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt else peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Channel creation failed&quot; echo &quot;===================== Channel \&quot;$CHANNEL_NAME\&quot; is created successfully ===================== &quot; echo } updateAnchorPeers() { PEER=$1 setGlobals $PEER if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt else peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Anchor peer update failed&quot; echo &quot;===================== Anchor peers for org \&quot;$CORE_PEER_LOCALMSPID\&quot; on \&quot;$CHANNEL_NAME\&quot; is updated successfully ===================== &quot; sleep 5 echo } ## Sometimes Join takes time hence RETRY atleast for 5 times joinWithRetry () { peer channel join -b $CHANNEL_NAME.block &gt;&amp;log.txt res=$? cat log.txt if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then COUNTER=` expr $COUNTER + 1` echo &quot;PEER$1 failed to join the channel, Retry after 2 seconds&quot; sleep 2 joinWithRetry $1 else COUNTER=1 fi verifyResult $res &quot;After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel&quot; } joinChannel () { for ch in 0 1 2 3 4 5 6 7; do setGlobals $ch joinWithRetry $ch echo &quot;===================== PEER$ch joined on the channel \&quot;$CHANNEL_NAME\&quot; ===================== &quot; sleep 2 echo done } installChaincode () { PEER=$1 setGlobals $PEER peer chaincode install -n $CHAINCODE_NAME -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt res=$? cat log.txt verifyResult $res &quot;Chaincode installation on remote peer PEER$PEER has Failed&quot; echo &quot;===================== Chaincode is installed on remote peer PEER$PEER ===================== &quot; echo } instantiateChaincode () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode instantiate -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;HealthMSP.member&#39;)&quot; &gt;&amp;log.txt else peer chaincode instantiate -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;HealthMSP.member&#39;)&quot; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Chaincode instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; failed&quot; echo &quot;===================== Chaincode Instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } chaincodeQuery () { PEER=$1 echo &quot;===================== Querying on PEER$PEER on channel &#39;$CHANNEL_NAME&#39;... ===================== &quot; setGlobals $PEER local rc=1 local starttime=$(date +%s) # continue to poll # we either get a successful response, or reach TIMEOUT while test &quot;$(($(date +%s)-starttime))&quot; -lt &quot;$TIMEOUT&quot; -a $rc -ne 0 do sleep 3 echo &quot;Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs&quot; peer chaincode query -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &gt;&amp;log.txt test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk &#39;/Query Result/ {print $NF}&#39;) test &quot;$VALUE&quot; = &quot;$2&quot; &amp;&amp; let rc=0 done echo cat log.txt if test $rc -eq 0 ; then echo &quot;===================== Query on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; else echo &quot;!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } chaincodeInvoke () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode invoke -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt else peer chaincode invoke -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Invoke execution on PEER$PEER failed &quot; echo &quot;===================== Invoke transaction on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } validateArgs ## Create channel echo &quot;Creating channel...&quot; createChannel ## Join all the peers to the channel echo &quot;Having all peers join the channel...&quot; joinChannel ## Set the anchor peers for each org in the channel echo &quot;Updating anchor peers for org1...&quot; updateAnchorPeers 0 echo &quot;Updating anchor peers for org2...&quot; #updateAnchorPeers 2 ## Install chaincode on Peer0/Health and Peer2/Org2 echo &quot;Installing chaincode on org1/peer0...&quot; installChaincode 0 echo &quot;Install chaincode on org2/peer2...&quot; installChaincode 2 #Instantiate chaincode on Peer2/Org2 echo &quot;Instantiating chaincode on org2/peer2...&quot; instantiateChaincode 2 #Query on chaincode on Peer0/Health echo &quot;Querying chaincode on org1/peer0...&quot; chaincodeQuery 0 100 #Invoke on chaincode on Peer0/Health echo &quot;Sending invoke transaction on org1/peer0...&quot; chaincodeInvoke 0 ## Install chaincode on Peer3/Org2 echo &quot;Installing chaincode on org2/peer3...&quot; installChaincode 1 installChaincode 3 installChaincode 4 installChaincode 5 installChaincode 6 installChaincode 7 #Query on chaincode on Peer3/Org2, check if the result is 90 echo &quot;Querying chaincode on org2/peer3...&quot; chaincodeQuery 1 90 echo echo &quot;===================== All GOOD ===================== &quot; echo exit 0 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/06/07/a4b68d02132d478bd72fffdfc17fe101.html" />
<meta property="og:url" content="https://mlh.app/2018/06/07/a4b68d02132d478bd72fffdfc17fe101.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-07T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"原创文章，未经同意不得转载 fabric从1.0.0起就支持多通道技术，关于多通道的解释，本文不多赘述，可以自行google。 本文以 example的e2e_cli 为基础，在此上进行修改 需要注意的是，我在e2e_cli的基础上做了一定修改来启动fabric，如果照搬一下脚本，是运行不起来的，以下仅供参考 说明一下思路： 1、一条链对应：至少一个org，至少一个peer，至少一个chaincode 2、在一条链对应的基础上，对script.sh脚本进行修改 步骤： 1、已经执行 ./network_setup.sh up 2、修改 e2e_cli下&nbsp;generateArtifacts.sh 为 generateNewChannel.sh（见下文） 3、修改 e2e_cli下script文件夹内的script.sh 为 script_new_channel.sh（见下文） 4、先在虚拟机上直接运行&nbsp; ./generateNewChannel.sh [新通道名] &nbsp; &nbsp; &nbsp;后进入cli容器执行 ./script/script_new_channel.sh&nbsp;[新通道名] [新智能合约名] generateNewChannel.sh # author: Logan Tang 20180607-11:37 mail:39522361@qq.com # usage: Generate configuration for new channel CHANNEL_NAME=$1 DATE=`date &#39;+%Y%m%d_%H%M%S&#39;` echo echo &quot; *** start create new channel configuration,time: $DATE,CHANNEL_NAME:$CHANNEL_NAME ***&quot; echo export FABRIC_ROOT=$PWD/../.. export FABRIC_CFG_PATH=$PWD OS_ARCH=$(echo &quot;$(uname -s|tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;|sed &#39;s/mingw64_nt.*/windows/&#39;)-$(uname -m | sed &#39;s/x86_64/amd64/g&#39;)&quot; | awk &#39;{print tolower($0)}&#39;) function printHelp () { echo &quot;params error: arg1 should not be empty,arg1 for channel name&quot; } function validateArgs () { if [ -z &quot;${CHANNEL_NAME}&quot; ]; then printHelp exit 1 fi } ## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions function generateChannelArtifacts() { CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen if [ -f &quot;$CONFIGTXGEN&quot; ]; then echo &quot;Using configtxgen -&gt; $CONFIGTXGEN&quot; else echo &quot;Building configtxgen&quot; make -C $FABRIC_ROOT release fi echo &quot;##########################################################&quot; echo &quot;######### Generating Orderer Genesis block ##############&quot; echo &quot;##########################################################&quot; # Note: For some unknown reason (at least for now) the block file can&#39;t be # named orderer.genesis.block or the orderer will fail to launch! $CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block echo echo &quot;#################################################################&quot; echo &quot;### Generating channel configuration transaction &#39;channel.tx&#39; ###&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for HealthMSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/HealthMSPanchors.tx -channelID $CHANNEL_NAME -asOrg HealthMSP echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org2MSP ##########&quot; echo &quot;#################################################################&quot; echo } validateArgs generateChannelArtifacts echo echo &quot; *** create new channel configuration success *** &quot; echo script_new_channel.sh # author: Logan Tang 20180607-11:37 mail:39522361@qq.com # usage: Create new channel to container CHANNEL_NAME=&quot;$1&quot; CHAINCODE_NAME=&quot;$2&quot; #: ${CHANNEL_NAME:=&quot;bgilifechain&quot;} : ${TIMEOUT:=&quot;60&quot;} COUNTER=1 MAX_RETRY=5 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/bgiblockchain.com/orderers/orderer.bgiblockchain.com/msp/tlscacerts/tlsca.bgiblockchain.com-cert.pem echo echo &quot;====== start create new channel ======&quot; echo &quot;CHANNEL_NAME name : &quot;$CHANNEL_NAME echo &quot;CHAINCODE_NAME name : &quot;$CHAINCODE_NAME echo function printHelp () { echo &quot;arg1/arg2 should not be empty,arg1 for channel name,arg2 for chaincode name&quot; } function validateArgs () { if [ -z &quot;${CHANNEL_NAME}&quot; ]; then printHelp exit 1 fi if [ -z &quot;${CHAINCODE_NAME}&quot; ]; then printHelp exit 1 fi } verifyResult () { if [ $1 -ne 0 ] ; then echo &quot;!!!!!!!!!!!!!!! &quot;$2&quot; !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } setGlobals () { CORE_PEER_LOCALMSPID=&quot;HealthMSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/peers/peer0.health.bgiblockchain.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/users/Admin@health.bgiblockchain.com/msp if [ $1 -eq 0 ]; then CORE_PEER_ADDRESS=peer0.health.bgiblockchain.com:7051 elif [ $1 -eq 1 ]; then CORE_PEER_ADDRESS=peer1.health.bgiblockchain.com:7051 elif [ $1 -eq 2 ]; then CORE_PEER_ADDRESS=peer2.health.bgiblockchain.com:7151 elif [ $1 -eq 3 ]; then CORE_PEER_ADDRESS=peer3.health.bgiblockchain.com:7151 elif [ $1 -eq 4 ]; then CORE_PEER_ADDRESS=peer4.health.bgiblockchain.com:7251 elif [ $1 -eq 5 ]; then CORE_PEER_ADDRESS=peer5.health.bgiblockchain.com:7251 elif [ $1 -eq 6 ]; then CORE_PEER_ADDRESS=peer6.health.bgiblockchain.com:7351 else CORE_PEER_ADDRESS=peer7.health.bgiblockchain.com:7351 fi env |grep CORE } createChannel() { setGlobals 0 if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt else peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Channel creation failed&quot; echo &quot;===================== Channel \\&quot;$CHANNEL_NAME\\&quot; is created successfully ===================== &quot; echo } updateAnchorPeers() { PEER=$1 setGlobals $PEER if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt else peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Anchor peer update failed&quot; echo &quot;===================== Anchor peers for org \\&quot;$CORE_PEER_LOCALMSPID\\&quot; on \\&quot;$CHANNEL_NAME\\&quot; is updated successfully ===================== &quot; sleep 5 echo } ## Sometimes Join takes time hence RETRY atleast for 5 times joinWithRetry () { peer channel join -b $CHANNEL_NAME.block &gt;&amp;log.txt res=$? cat log.txt if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then COUNTER=` expr $COUNTER + 1` echo &quot;PEER$1 failed to join the channel, Retry after 2 seconds&quot; sleep 2 joinWithRetry $1 else COUNTER=1 fi verifyResult $res &quot;After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel&quot; } joinChannel () { for ch in 0 1 2 3 4 5 6 7; do setGlobals $ch joinWithRetry $ch echo &quot;===================== PEER$ch joined on the channel \\&quot;$CHANNEL_NAME\\&quot; ===================== &quot; sleep 2 echo done } installChaincode () { PEER=$1 setGlobals $PEER peer chaincode install -n $CHAINCODE_NAME -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt res=$? cat log.txt verifyResult $res &quot;Chaincode installation on remote peer PEER$PEER has Failed&quot; echo &quot;===================== Chaincode is installed on remote peer PEER$PEER ===================== &quot; echo } instantiateChaincode () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode instantiate -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;HealthMSP.member&#39;)&quot; &gt;&amp;log.txt else peer chaincode instantiate -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;HealthMSP.member&#39;)&quot; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Chaincode instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; failed&quot; echo &quot;===================== Chaincode Instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } chaincodeQuery () { PEER=$1 echo &quot;===================== Querying on PEER$PEER on channel &#39;$CHANNEL_NAME&#39;... ===================== &quot; setGlobals $PEER local rc=1 local starttime=$(date +%s) # continue to poll # we either get a successful response, or reach TIMEOUT while test &quot;$(($(date +%s)-starttime))&quot; -lt &quot;$TIMEOUT&quot; -a $rc -ne 0 do sleep 3 echo &quot;Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs&quot; peer chaincode query -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &gt;&amp;log.txt test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk &#39;/Query Result/ {print $NF}&#39;) test &quot;$VALUE&quot; = &quot;$2&quot; &amp;&amp; let rc=0 done echo cat log.txt if test $rc -eq 0 ; then echo &quot;===================== Query on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; else echo &quot;!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } chaincodeInvoke () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode invoke -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt else peer chaincode invoke -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Invoke execution on PEER$PEER failed &quot; echo &quot;===================== Invoke transaction on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } validateArgs ## Create channel echo &quot;Creating channel...&quot; createChannel ## Join all the peers to the channel echo &quot;Having all peers join the channel...&quot; joinChannel ## Set the anchor peers for each org in the channel echo &quot;Updating anchor peers for org1...&quot; updateAnchorPeers 0 echo &quot;Updating anchor peers for org2...&quot; #updateAnchorPeers 2 ## Install chaincode on Peer0/Health and Peer2/Org2 echo &quot;Installing chaincode on org1/peer0...&quot; installChaincode 0 echo &quot;Install chaincode on org2/peer2...&quot; installChaincode 2 #Instantiate chaincode on Peer2/Org2 echo &quot;Instantiating chaincode on org2/peer2...&quot; instantiateChaincode 2 #Query on chaincode on Peer0/Health echo &quot;Querying chaincode on org1/peer0...&quot; chaincodeQuery 0 100 #Invoke on chaincode on Peer0/Health echo &quot;Sending invoke transaction on org1/peer0...&quot; chaincodeInvoke 0 ## Install chaincode on Peer3/Org2 echo &quot;Installing chaincode on org2/peer3...&quot; installChaincode 1 installChaincode 3 installChaincode 4 installChaincode 5 installChaincode 6 installChaincode 7 #Query on chaincode on Peer3/Org2, check if the result is 90 echo &quot;Querying chaincode on org2/peer3...&quot; chaincodeQuery 1 90 echo echo &quot;===================== All GOOD ===================== &quot; echo exit 0 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/06/07/a4b68d02132d478bd72fffdfc17fe101.html","headline":"fabric-1.0.6，多通道实现","dateModified":"2018-06-07T00:00:00+08:00","datePublished":"2018-06-07T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/06/07/a4b68d02132d478bd72fffdfc17fe101.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>fabric-1.0.6，多通道实现</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>原创文章，未经同意不得转载</p>
  <p>fabric从1.0.0起就支持多通道技术，关于多通道的解释，本文不多赘述，可以自行google。</p>
  <p>本文以 example的e2e_cli 为基础，在此上进行修改</p>
  <p>需要注意的是，我在e2e_cli的基础上做了一定修改来启动fabric，如果照搬一下脚本，是运行不起来的，以下仅供参考</p>
  <p><br></p>
  <p>说明一下思路：</p>
  <p>1、一条链对应：至少一个org，至少一个peer，至少一个chaincode</p>
  <p>2、在一条链对应的基础上，对script.sh脚本进行修改</p>
  <p><br></p>
  <p>步骤：</p>
  <p>1、已经执行 ./network_setup.sh up</p>
  <p>2、修改 e2e_cli下&nbsp;generateArtifacts.sh 为 generateNewChannel.sh（见下文）</p>
  <p>3、修改 e2e_cli下script文件夹内的script.sh 为 script_new_channel.sh（见下文）</p>
  <p>4、先在虚拟机上直接运行&nbsp; ./generateNewChannel.sh [新通道名]</p>
  <p>&nbsp; &nbsp; &nbsp;后进入cli容器执行 ./script/script_new_channel.sh&nbsp;[新通道名] [新智能合约名]</p>
  <p><br></p>
  <p>generateNewChannel.sh<br></p>
  <pre><code class="language-plain"># author: Logan Tang 20180607-11:37 mail:39522361@qq.com
# usage: Generate configuration for new channel

CHANNEL_NAME=$1
DATE=`date '+%Y%m%d_%H%M%S'`

echo
echo " *** start create new channel configuration,time: $DATE,CHANNEL_NAME:$CHANNEL_NAME ***"
echo

export FABRIC_ROOT=$PWD/../..
export FABRIC_CFG_PATH=$PWD


OS_ARCH=$(echo "$(uname -s|tr '[:upper:]' '[:lower:]'|sed 's/mingw64_nt.*/windows/')-$(uname -m | sed 's/x86_64/amd64/g')" | awk '{print tolower($0)}')

function printHelp () {
	echo "params error: arg1 should not be empty,arg1 for channel name"
}

function validateArgs () {
	if [ -z "${CHANNEL_NAME}" ]; then
				printHelp
		exit 1
	fi
}


## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions
function generateChannelArtifacts() {

	CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen
	if [ -f "$CONFIGTXGEN" ]; then
            echo "Using configtxgen -&gt; $CONFIGTXGEN"
	else
	    echo "Building configtxgen"
	    make -C $FABRIC_ROOT release
	fi

	echo "##########################################################"
	echo "#########  Generating Orderer Genesis block ##############"
	echo "##########################################################"
	# Note: For some unknown reason (at least for now) the block file can't be
	# named orderer.genesis.block or the orderer will fail to launch!
	$CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block

	echo
	echo "#################################################################"
	echo "### Generating channel configuration transaction 'channel.tx' ###"
	echo "#################################################################"
	$CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME

	echo
	echo "#################################################################"
	echo "#######    Generating anchor peer update for HealthMSP   ##########"
	echo "#################################################################"
	$CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/HealthMSPanchors.tx -channelID $CHANNEL_NAME -asOrg HealthMSP

	echo
	echo "#################################################################"
	echo "#######    Generating anchor peer update for Org2MSP   ##########"
	echo "#################################################################"
	echo
}

validateArgs
generateChannelArtifacts

echo
echo " *** create new channel configuration success *** "
echo</code></pre>
  <p>script_new_channel.sh</p>
  <pre><code class="language-plain"># author: Logan Tang 20180607-11:37 mail:39522361@qq.com
# usage: Create new channel to container

CHANNEL_NAME="$1"
CHAINCODE_NAME="$2"
#: ${CHANNEL_NAME:="bgilifechain"}
: ${TIMEOUT:="60"}
COUNTER=1
MAX_RETRY=5
ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/bgiblockchain.com/orderers/orderer.bgiblockchain.com/msp/tlscacerts/tlsca.bgiblockchain.com-cert.pem

echo
echo "====== start create new channel ======"
echo "CHANNEL_NAME name : "$CHANNEL_NAME
echo "CHAINCODE_NAME name : "$CHAINCODE_NAME
echo

function printHelp () {
	echo "arg1/arg2 should not be empty,arg1 for channel name,arg2 for chaincode name"
}

function validateArgs () {
	if [ -z "${CHANNEL_NAME}" ]; then
				printHelp
		exit 1
	fi
	if [ -z "${CHAINCODE_NAME}" ]; then
				printHelp
		exit 1
	fi
}

verifyResult () {
	if [ $1 -ne 0 ] ; then
		echo "!!!!!!!!!!!!!!! "$2" !!!!!!!!!!!!!!!!"
                echo "================== ERROR !!! FAILED to execute End-2-End Scenario =================="
		echo
   		exit 1
	fi
}

setGlobals () {
		CORE_PEER_LOCALMSPID="HealthMSP"
		CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/peers/peer0.health.bgiblockchain.com/tls/ca.crt
		CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/health.bgiblockchain.com/users/Admin@health.bgiblockchain.com/msp
		if [ $1 -eq 0 ]; then 
			CORE_PEER_ADDRESS=peer0.health.bgiblockchain.com:7051
		elif [ $1 -eq 1 ]; then
			CORE_PEER_ADDRESS=peer1.health.bgiblockchain.com:7051
		elif [ $1 -eq 2 ]; then
			CORE_PEER_ADDRESS=peer2.health.bgiblockchain.com:7151
		elif [ $1 -eq 3 ]; then
			CORE_PEER_ADDRESS=peer3.health.bgiblockchain.com:7151
		elif [ $1 -eq 4 ]; then
			CORE_PEER_ADDRESS=peer4.health.bgiblockchain.com:7251
		elif [ $1 -eq 5 ]; then
			CORE_PEER_ADDRESS=peer5.health.bgiblockchain.com:7251
		elif [ $1 -eq 6 ]; then
			CORE_PEER_ADDRESS=peer6.health.bgiblockchain.com:7351
		else
			CORE_PEER_ADDRESS=peer7.health.bgiblockchain.com:7351
		fi
	env |grep CORE
}

createChannel() {
	setGlobals 0
    if [ -z "$CORE_PEER_TLS_ENABLED" -o "$CORE_PEER_TLS_ENABLED" = "false" ]; then
		peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt
	else
		peer channel create -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt
	fi
	res=$?
	cat log.txt
	verifyResult $res "Channel creation failed"
	echo "===================== Channel \"$CHANNEL_NAME\" is created successfully ===================== "
	echo
}

updateAnchorPeers() {
    PEER=$1
    setGlobals $PEER
    if [ -z "$CORE_PEER_TLS_ENABLED" -o "$CORE_PEER_TLS_ENABLED" = "false" ]; then
		peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt
	else
		peer channel update -o orderer.bgiblockchain.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt
	fi
	res=$?
	cat log.txt
	verifyResult $res "Anchor peer update failed"
	echo "===================== Anchor peers for org \"$CORE_PEER_LOCALMSPID\" on \"$CHANNEL_NAME\" is updated successfully ===================== "
	sleep 5
	echo
}

## Sometimes Join takes time hence RETRY atleast for 5 times
joinWithRetry () {
	peer channel join -b $CHANNEL_NAME.block  &gt;&amp;log.txt
	res=$?
	cat log.txt
	if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then
		COUNTER=` expr $COUNTER + 1`
		echo "PEER$1 failed to join the channel, Retry after 2 seconds"
		sleep 2
		joinWithRetry $1
	else
		COUNTER=1
	fi
        verifyResult $res "After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel"
}

joinChannel () {
	for ch in 0 1 2 3 4 5 6 7; do
		setGlobals $ch
		joinWithRetry $ch
		echo "===================== PEER$ch joined on the channel \"$CHANNEL_NAME\" ===================== "
		sleep 2
		echo
	done
}

installChaincode () {
	PEER=$1
	setGlobals $PEER
	peer chaincode install -n $CHAINCODE_NAME -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt
	res=$?
	cat log.txt
        verifyResult $res "Chaincode installation on remote peer PEER$PEER has Failed"
	echo "===================== Chaincode is installed on remote peer PEER$PEER ===================== "
	echo
}

instantiateChaincode () {
	PEER=$1
	setGlobals $PEER
	# while 'peer chaincode' command can get the orderer endpoint from the peer (if join was successful),
	# lets supply it directly as we know it using the "-o" option
	if [ -z "$CORE_PEER_TLS_ENABLED" -o "$CORE_PEER_TLS_ENABLED" = "false" ]; then
		peer chaincode instantiate -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c '{"Args":["init","a","100","b","200"]}' -P "OR	('HealthMSP.member')" &gt;&amp;log.txt
	else
		peer chaincode instantiate -o orderer.bgiblockchain.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -v 1.0 -c '{"Args":["init","a","100","b","200"]}' -P "OR	('HealthMSP.member')" &gt;&amp;log.txt
	fi
	res=$?
	cat log.txt
	verifyResult $res "Chaincode instantiation on PEER$PEER on channel '$CHANNEL_NAME' failed"
	echo "===================== Chaincode Instantiation on PEER$PEER on channel '$CHANNEL_NAME' is successful ===================== "
	echo
}

chaincodeQuery () {
  PEER=$1
  echo "===================== Querying on PEER$PEER on channel '$CHANNEL_NAME'... ===================== "
  setGlobals $PEER
  local rc=1
  local starttime=$(date +%s)

  # continue to poll
  # we either get a successful response, or reach TIMEOUT
  while test "$(($(date +%s)-starttime))" -lt "$TIMEOUT" -a $rc -ne 0
  do
     sleep 3
     echo "Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs"
     peer chaincode query -C $CHANNEL_NAME -n $CHAINCODE_NAME -c '{"Args":["query","a"]}' &gt;&amp;log.txt
     test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk '/Query Result/ {print $NF}')
     test "$VALUE" = "$2" &amp;&amp; let rc=0
  done
  echo
  cat log.txt
  if test $rc -eq 0 ; then
	echo "===================== Query on PEER$PEER on channel '$CHANNEL_NAME' is successful ===================== "
  else
	echo "!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!"
        echo "================== ERROR !!! FAILED to execute End-2-End Scenario =================="
	echo
	exit 1
  fi
}

chaincodeInvoke () {
	PEER=$1
	setGlobals $PEER
	# while 'peer chaincode' command can get the orderer endpoint from the peer (if join was successful),
	# lets supply it directly as we know it using the "-o" option
	if [ -z "$CORE_PEER_TLS_ENABLED" -o "$CORE_PEER_TLS_ENABLED" = "false" ]; then
		peer chaincode invoke -o orderer.bgiblockchain.com:7050 -C $CHANNEL_NAME -n $CHAINCODE_NAME -c '{"Args":["invoke","a","b","10"]}' &gt;&amp;log.txt
	else
		peer chaincode invoke -o orderer.bgiblockchain.com:7050  --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n $CHAINCODE_NAME -c '{"Args":["invoke","a","b","10"]}' &gt;&amp;log.txt
	fi
	res=$?
	cat log.txt
	verifyResult $res "Invoke execution on PEER$PEER failed "
	echo "===================== Invoke transaction on PEER$PEER on channel '$CHANNEL_NAME' is successful ===================== "
	echo
}

validateArgs

## Create channel
echo "Creating channel..."
createChannel

## Join all the peers to the channel
echo "Having all peers join the channel..."
joinChannel

## Set the anchor peers for each org in the channel
echo "Updating anchor peers for org1..."
updateAnchorPeers 0
echo "Updating anchor peers for org2..."
#updateAnchorPeers 2

## Install chaincode on Peer0/Health and Peer2/Org2
echo "Installing chaincode on org1/peer0..."
installChaincode 0
echo "Install chaincode on org2/peer2..."
installChaincode 2

#Instantiate chaincode on Peer2/Org2
echo "Instantiating chaincode on org2/peer2..."
instantiateChaincode 2

#Query on chaincode on Peer0/Health
echo "Querying chaincode on org1/peer0..."
chaincodeQuery 0 100

#Invoke on chaincode on Peer0/Health
echo "Sending invoke transaction on org1/peer0..."
chaincodeInvoke 0

## Install chaincode on Peer3/Org2
echo "Installing chaincode on org2/peer3..."
installChaincode 1
installChaincode 3
installChaincode 4
installChaincode 5
installChaincode 6
installChaincode 7

#Query on chaincode on Peer3/Org2, check if the result is 90
echo "Querying chaincode on org2/peer3..."
chaincodeQuery 1 90


echo
echo "===================== All GOOD ===================== "
echo

exit 0</code></pre> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/kidoo1012/article/details/80607546,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/kidoo1012/article/details/80607546,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
