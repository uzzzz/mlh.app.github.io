<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>fabric e2e_cli例子手动用CA签证书并验证 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="fabric e2e_cli例子手动用CA签证书并验证" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="一：简介 &nbsp;&nbsp;&nbsp;在e2e_cli的例子中，所有用到的证书和私钥都是由cryptogen这个工具根据crypto-config.yaml而生成的。但是在实际的生产环境中，我们需要给每个org都建立自己的CA，用来管理本org的用户。本次是以e2e_cli为例子，然后手动的生成所有的证书和私钥，并进行手动的执行例子进行验证。 二：环境准备 &nbsp;&nbsp;&nbsp;1：linux环境（我的是vmware虚拟机， ubuntu16.04） &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Go 1.9+ &nbsp;&nbsp;&nbsp;GOPATH环境变量安装成功 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Libtool和libtdhl-dev需要安装 (ubuntu：sudo&nbsp;apt&nbsp;install&nbsp;libtool&nbsp;libltdl-dev) &nbsp;&nbsp;&nbsp;2：可以成功执行e2e_cli例子（这是基本，毕竟在上面进行验证） &nbsp;&nbsp;&nbsp;3：安装fabric-ca-server和fabric-ca-client的可执行文件到$GOPATH/bin目录下 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(go&nbsp;get&nbsp;-u&nbsp;github.com/hyperledger/fabric-ca/cmd/...) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我是直接进行复制的，这样下不下来。 三：生成根CA的证书 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;生成自签CA证书有两种形式：通过可执行文件和镜像，下面进行分别的说明： &nbsp; &nbsp; &nbsp;1：命令行形式 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;执行fabric-ca-server start -b admin:adminpw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前没有被初始化init，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成ca-cert.pem和ca-key.pem文件(msp文件夹下)，并且如果该文件不存在，还会创建一个默认配置文件fabric-ca-server-config.yaml。&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;注意： &nbsp; （1）：首先可以通过fabric-ca-server init进行初始化，创建证书和私钥以及配置文件，也可以直接进行start，第一次start时会自动执行init的操作。 &nbsp; （2）：这种操作产生的根证书是自签的。可以进行验证：（openssl verify -CAfile ca-cert.pem ca-cert.pem &nbsp;返回ok） &nbsp; （3）：证书可以通过openssl x509 -in ca-cert.pem &nbsp;-text进行查看。 &nbsp;&nbsp; &nbsp; 2：使用镜像启动 &nbsp;进入到$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server目录下然后对docker-compose.yaml文件进行编辑。 &nbsp; &nbsp; &nbsp;fabric-ca-server: &nbsp; &nbsp; &nbsp;image: hyperledger/fabric-ca:x86_64-1.0.0-beta &nbsp; &nbsp; &nbsp;container_name: fabric-ca-server &nbsp; &nbsp; &nbsp;ports: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;&quot;7054:7054&quot; &nbsp; &nbsp; &nbsp;environment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server &nbsp; &nbsp; &nbsp; volumes: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;&quot;./fabric-ca-server:/etc/hyperledger/fabric-ca-server&quot; &nbsp; &nbsp; &nbsp; &nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;（注意：自己的ca image的版本根据自己机器中的进行修改）&nbsp; &nbsp; &nbsp; &nbsp; 2.&nbsp;然后执行 docker-compose up -d 启动容器。 &nbsp;&nbsp;（&nbsp;fabric-ca docker 镜像包含了fabric-ca-server和fabric-ca-client两部分。然后会在该目录下生成自签的CA证书和密钥以及fabric ca server的配置文件。）&nbsp; 如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。 &nbsp; &nbsp; 1：配置文件 &nbsp; &nbsp;如果需要CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。 &nbsp; &nbsp; 2：命令行 &nbsp; fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d &nbsp; &nbsp; &nbsp; &nbsp;Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。 &nbsp; &nbsp; 3：镜像 &nbsp; &nbsp; &nbsp; docker-compose.yaml文件中的&nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39;命令行修改为 fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d 四：对应e2e_cli生成对应的证书 &nbsp; &nbsp;1：结构分析 &nbsp; &nbsp;我们的目的是生成对应的证书然后使得e2e_cli能够顺利的跑起来。 &nbsp; &nbsp; &nbsp; &nbsp; 我们可以使用下面的部署方式： &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;这里做了简化，只部署了一个Fabric-CA作为rootCA。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 将创建一个由两个组织org1.example.com和org2.example.com组成的的联盟。 &nbsp; 另外还有一个组织example.com用来部署orderer。 &nbsp; &nbsp; &nbsp;example.com部署了一个solo模式的orderer。（多个orderer的部署方式，其实是一样的） &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; orderer.example.com &nbsp; &nbsp; &nbsp;org1.example.com部署了两个peer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org1.example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org1.example.com &nbsp; &nbsp; &nbsp; org2.example.com部署了两个个peer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org2.example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org2.example.com &nbsp; 每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建8个用户： &nbsp; &nbsp; &nbsp; example.com: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Admin@example.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orderer.example.com &nbsp; &nbsp; &nbsp; org1.example.com: &nbsp;Admin@org1.example.com &nbsp;peer0.org1.example.com &nbsp;peer1.org1.example.com &nbsp; &nbsp; &nbsp; &nbsp; org2.example.com: &nbsp;Admin@org2.example.com &nbsp;peer0.org2.example.com &nbsp;peer1.org2.example.com &nbsp; 这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。 &nbsp; &nbsp; 2：生成fabric-ca admin的凭证 &nbsp; &nbsp;在/opt/gopath/bin下面执行：mkdir fabric-ca-files&nbsp;生成fabric-ca admin的凭证，用-H参数指定client目录： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p `pwd`/fabric-ca-files/admin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;这时候/opt/gopath/bin/fabric-ca-files下面有一个admin的文件夹（里面是管理员的证书和私钥等信息）： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3：创建联盟 &nbsp; &nbsp; 通过上面的启动，会默认创建两个组织： &nbsp; melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;（这是fabric-ca-server配置文件中默认的配置，可以在配置文件上进行修改） &nbsp; &nbsp; &nbsp;但是通过我们的结构分析，这种联盟以及名称不是我们需要的，我们需要进行修改。首先将其删除： &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org1 &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org2 &nbsp; &nbsp; &nbsp; 然后创建我们需要的联盟： &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org1 &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org2 &nbsp; &nbsp; &nbsp; 创建联盟如下： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;4：为每个联盟创建msp，将根证书放入到对应的位置 &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/example.com/msp &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp &nbsp;&nbsp;&nbsp;//-M需要指定绝对路径 &nbsp; 命令执行结束后，会在fabric-ca-files/example.com/msp得到文件： &nbsp; &nbsp; &nbsp; $ tree fabric-ca-files/example.com/msp/ &nbsp; &nbsp; &nbsp; &nbsp;example.com/msp/ &nbsp; &nbsp; &nbsp; &nbsp; |-- cacerts &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem &nbsp; &nbsp; &nbsp; &nbsp; |-- intermediatecerts &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem &nbsp; &nbsp; &nbsp; &nbsp; |-- keystore &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;`-- signcerts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;注意：getcacert得到msp目录中只有CA证书。这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到！ &nbsp; &nbsp;用同样的方式分别为org1和org2进行操作： &nbsp; &nbsp; &nbsp; &nbsp; mkdir -p fabric-ca-files/org1.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/org2.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tls在配置文件中设置为false不需要了。 &nbsp; &nbsp; &nbsp; &nbsp; 5：&nbsp;注册example.com的管理员Admin@example.com &nbsp; &nbsp; $ fabric-ca-client register --id.name Admin@example.com --id.type c&nbsp;--id.affiliation &quot;com.example&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; &nbsp; &nbsp; &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/example.com/admin &nbsp; $ fabric-ca-client enroll -u http://Admin@example.com:(password)@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin &nbsp; &nbsp; &nbsp; &nbsp; $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ &nbsp;这时候可以用Admin@example.com的身份查看联盟：(可以全部看到) &nbsp; &nbsp; &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin &nbsp; &nbsp; &nbsp;返回： &nbsp; &nbsp; &nbsp;affiliation: com &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2&nbsp; &nbsp; 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ &nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem &nbsp;fabric-ca-files/example.com/msp/admincerts/ &nbsp; &nbsp;只有这样，才能具备管理员权限。&nbsp; &nbsp; &nbsp;6： 注册org1.example.com的管理员Admin@org1.example.com &nbsp; &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org1.example.com --id.type client --id.affiliation &quot;com.example.org1&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39;&nbsp; &nbsp; &nbsp;$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org1.example.com/admin&nbsp; &nbsp; 只能查看org1和example的联盟。 &nbsp; 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： &nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/msp/admincerts/ &nbsp; &nbsp;&nbsp;在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在 &nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ &nbsp; &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org1.example.com/admin/msp/admincerts/ &nbsp; 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning &nbsp; &nbsp; $ rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* &nbsp; 7：注册org2.example.com的管理员Admin@org2.example.com &nbsp; &nbsp;为org2.example.com的管理员Admin@org2.example.com准备一个目录: &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org2.example.com --id.type client --id.affiliation &quot;com.example.org2&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; &nbsp;$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;$ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml &nbsp;msp/ &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;返回结果： &nbsp; &nbsp;affiliation: com &nbsp; &nbsp; &nbsp; affiliation: com.example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2 &nbsp; &nbsp;Admin@org2.example.com只能看到组织com.example.org2。 &nbsp;将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; 、 &nbsp; &nbsp; &nbsp;fabric-ca-files/org2.example.com/msp/admincerts/ &nbsp; 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-files/org2.example.com/admin/msp/admincerts/ &nbsp;另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： &nbsp; &nbsp; $ rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* &nbsp; 8：各个组织分别使用自己的Admin账户创建其它账号 &nbsp; &nbsp; &nbsp;//order &nbsp; &nbsp; example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 &nbsp; &nbsp; orderer.example.com &nbsp;使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 &nbsp;$ fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password &nbsp;--id.name orderer.example.com --id.type orderer --id.affiliation &quot;com.example&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=orderer:ecert&#39; &nbsp; &nbsp;$ mkdir ./fabric-ca-files/example.com/orderer &nbsp; &nbsp;$ fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H&nbsp; &nbsp; &nbsp; &nbsp;`pwd`/fabric-ca-files/example.com/orderer &nbsp;将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： &nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/orderer/msp/admincerts &nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/example.com/orderer/msp/admincerts/ &nbsp; &nbsp; &nbsp; &nbsp;//peer0org1 &nbsp;使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin/ --id.secret=password &nbsp;--id.name peer0.org1.example.com --id.type peer --id.affiliation &quot;com.example.org1&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp;$ mkdir ./fabric-ca-files/org1.example.com/peer0 &nbsp;$ fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer0/msp/admincerts/ &nbsp; &nbsp; //peer1org1 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password &nbsp;--id.name peer1.org1.example.com --id.type peer --id.affiliation &quot;com.example.org1&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org1.example.com/peer1 &nbsp;$ fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer1/msp/admincerts/ &nbsp;&nbsp; &nbsp; //peer0org2 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer0.org2.example.com --id.type peer --id.affiliation &quot;com.example.org2&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer0 &nbsp;$ fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 &nbsp; &nbsp;$ mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer0/msp/admincerts/ &nbsp; &nbsp; &nbsp; //peer1org2 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer1.org2.example.com --id.type peer --id.affiliation &quot;com.example.org2&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer1 &nbsp;$ fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1 &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer1/msp/admincerts/ &nbsp; 五：进行替换然后手动执行验证 &nbsp; &nbsp; 1：替换 &nbsp; 根据原来通过generateArtifacts.sh脚本生成的crypto-config文件夹的结构进行分析，只需要将我们生成的msp更新对应的msp即可： &nbsp; &nbsp;Example.com的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;Order的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user下的admin的msp &nbsp; &nbsp;Org1 的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer0的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer1的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;User的admin的msp &nbsp; Org2的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer0的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer1的msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; user的admin的msp &nbsp; &nbsp; &nbsp;&nbsp;主要操作，删除原crypto-config文件夹中对应的msp，然后从自己生成的/opt/gopath/fabric-ca-files文件夹中进行复制。&nbsp; 2：验证： &nbsp; &nbsp; 1：修改generateArtifacts.sh，注释掉倒数第二第三行： &nbsp; &nbsp;#generateCerts &nbsp; &nbsp;#replacePrivateKey &nbsp; &nbsp;不生成证书和密钥 &nbsp; &nbsp;2：network_start &nbsp;中down的时候不删除这个存证书和密钥的文件夹 &nbsp; 修改为：rm -rf channel-artifacts/*.block channel-artifacts/*.tx &nbsp; &nbsp;3：直接执行sudo ./network_setup.sh up启动网络 &nbsp; &nbsp;4：手动执行e2e_cli的例子进行： &nbsp; &nbsp; 命令行： &nbsp; &nbsp; //进入cli容器进行操作 &nbsp; &nbsp; docker exec -it cli bash &nbsp; &nbsp; export CHANNEL_NAME=mychannel &nbsp; &nbsp;//创建channel &nbsp; &nbsp;peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx&nbsp; &nbsp; &nbsp;//peer0.org1.example.com加入channel &nbsp; &nbsp;peer channel join -b mychannel.block &nbsp;&nbsp;&nbsp;//peer0.org2.example.com 加入channel CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; &nbsp;peer channel join -b mychannel.block&nbsp; &nbsp; //anchor peer for Org1 as&nbsp;peer0.org1.example.com &nbsp; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org1MSPanchors.tx &nbsp; //peer0.org2.example.com CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org2MSPanchors.tx&nbsp; &nbsp; &nbsp;//安装链码 &nbsp;peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/ &nbsp; &nbsp;//初始化链码 peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]}&#39; &nbsp;//进行查询操作 peer chaincode query -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &nbsp;//进行交易 peer chaincode invoke -o orderer.example.com:7050 &nbsp;-C $CHANNEL_NAME -n mycc &nbsp;&nbsp;-c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39;&nbsp; 如果执行正常，说明证书生成以及替换是正确的。 &nbsp; 六：参考文档： &nbsp; &nbsp;&nbsp;https://www.cnblogs.com/studyzy/p/7482451.html &nbsp; &nbsp;&nbsp;http://hyperledger-fabric-ca.readthedocs.io/en/latest/ &nbsp; &nbsp;&nbsp;https://blog.csdn.net/lijiaocn/article/details/80261529 &nbsp; &nbsp; 七：遇到的问题 &nbsp; &nbsp; 1：melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client affiliation list [sudo] melly 的密码： Error: Failed to parse response: 404 page not found : invalid character &#39;p&#39; after top-level value &nbsp; &nbsp;查看fabric-ca默认注册了几个联盟 &nbsp; &nbsp;查看失败，但是可以去fabric-server的配置文件看即可：（默认如下） &nbsp; &nbsp; &nbsp;或者：修改路径 &nbsp; &nbsp; &nbsp; &nbsp;sudo ./fabric-ca-client &nbsp;-H /home/melly/.fabric-ca-client/ &nbsp;affiliation list &nbsp; &nbsp; &nbsp; affiliation: . &nbsp; &nbsp; &nbsp; &nbsp;affiliation: org2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org2.department1 &nbsp; &nbsp; &nbsp; &nbsp;affiliation: org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department2 &nbsp; 2： [INFO] 127.0.0.1:47924 POST /register 401 42 &quot;Failed to register attribute: Failed to get attribute &#39;hf.Registrar.Attributes&#39;: User does not have attribute &#39;hf.Registrar.Attributes&#39;&quot; 解决： &nbsp; &nbsp; 如下示例，使用 admin 的身份及其配套证书，登记了一个名称为 &quot;admin2&quot;、类型为 &quot;user&quot;、组织关系为&nbsp; &nbsp;&quot;org1.department1&quot;、&quot;hf.Revoker&quot; 属性为 &quot;true&quot; 的新角色： # export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin # fabric-ca-client register --id.name admin2 --id.type user --id.affiliation org1.department1 --id.attr hf.Revoker=true &nbsp;&nbsp; &nbsp; &nbsp; 3：peer create channel grpc: addrConn.resetTransport failed to create client transport: connection error: desc = &quot;transport: failed to write window update: write tcp 172.20.0.7:57304-&gt;172.20.0.3:7050: write: broken pipe&quot;; Reconnecting to {orderer.example.com:7050 &lt;nil&gt;} Error: Error connecting due to &nbsp;rpc error: code = Unavailable desc = grpc: the connection is unavailable &nbsp; &nbsp; &nbsp;grpc：Server.Serve未能完成来自“172.20.0.7:48830”的安全握手：tls：第一条记录看起来不像TLS握手 &nbsp; 解决：去docker-compse-cli.yaml文件中关闭tls &nbsp; &nbsp; &nbsp;4：HYPERLEDGER FABRIC网络搭建之network e2ecli_default not found&nbsp; &nbsp; 原因是：&nbsp; e2e_cli目录是固定的，启动后会创建一个docker network以此为名字，这里是e2e_cli。如果修改该目录，要修&nbsp; &nbsp; &nbsp;改/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/base目录下的peer-base.yaml将网络名修改一下： &nbsp;我的目录是e2e_cli2 &nbsp;- CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli2_default &nbsp; &nbsp; 5：Error: Response from server: Error Code: 20 - Authorization failure &nbsp; 授权失败： &nbsp; 需要重新：授权一下： &nbsp; &nbsp; export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin &nbsp; &nbsp; sudo ./fabric-ca-client enroll -u http://admin:pass@localhost:7054 &nbsp; 阅读更多" />
<meta property="og:description" content="一：简介 &nbsp;&nbsp;&nbsp;在e2e_cli的例子中，所有用到的证书和私钥都是由cryptogen这个工具根据crypto-config.yaml而生成的。但是在实际的生产环境中，我们需要给每个org都建立自己的CA，用来管理本org的用户。本次是以e2e_cli为例子，然后手动的生成所有的证书和私钥，并进行手动的执行例子进行验证。 二：环境准备 &nbsp;&nbsp;&nbsp;1：linux环境（我的是vmware虚拟机， ubuntu16.04） &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Go 1.9+ &nbsp;&nbsp;&nbsp;GOPATH环境变量安装成功 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Libtool和libtdhl-dev需要安装 (ubuntu：sudo&nbsp;apt&nbsp;install&nbsp;libtool&nbsp;libltdl-dev) &nbsp;&nbsp;&nbsp;2：可以成功执行e2e_cli例子（这是基本，毕竟在上面进行验证） &nbsp;&nbsp;&nbsp;3：安装fabric-ca-server和fabric-ca-client的可执行文件到$GOPATH/bin目录下 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(go&nbsp;get&nbsp;-u&nbsp;github.com/hyperledger/fabric-ca/cmd/...) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我是直接进行复制的，这样下不下来。 三：生成根CA的证书 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;生成自签CA证书有两种形式：通过可执行文件和镜像，下面进行分别的说明： &nbsp; &nbsp; &nbsp;1：命令行形式 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;执行fabric-ca-server start -b admin:adminpw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前没有被初始化init，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成ca-cert.pem和ca-key.pem文件(msp文件夹下)，并且如果该文件不存在，还会创建一个默认配置文件fabric-ca-server-config.yaml。&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;注意： &nbsp; （1）：首先可以通过fabric-ca-server init进行初始化，创建证书和私钥以及配置文件，也可以直接进行start，第一次start时会自动执行init的操作。 &nbsp; （2）：这种操作产生的根证书是自签的。可以进行验证：（openssl verify -CAfile ca-cert.pem ca-cert.pem &nbsp;返回ok） &nbsp; （3）：证书可以通过openssl x509 -in ca-cert.pem &nbsp;-text进行查看。 &nbsp;&nbsp; &nbsp; 2：使用镜像启动 &nbsp;进入到$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server目录下然后对docker-compose.yaml文件进行编辑。 &nbsp; &nbsp; &nbsp;fabric-ca-server: &nbsp; &nbsp; &nbsp;image: hyperledger/fabric-ca:x86_64-1.0.0-beta &nbsp; &nbsp; &nbsp;container_name: fabric-ca-server &nbsp; &nbsp; &nbsp;ports: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;&quot;7054:7054&quot; &nbsp; &nbsp; &nbsp;environment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server &nbsp; &nbsp; &nbsp; volumes: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;&quot;./fabric-ca-server:/etc/hyperledger/fabric-ca-server&quot; &nbsp; &nbsp; &nbsp; &nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;（注意：自己的ca image的版本根据自己机器中的进行修改）&nbsp; &nbsp; &nbsp; &nbsp; 2.&nbsp;然后执行 docker-compose up -d 启动容器。 &nbsp;&nbsp;（&nbsp;fabric-ca docker 镜像包含了fabric-ca-server和fabric-ca-client两部分。然后会在该目录下生成自签的CA证书和密钥以及fabric ca server的配置文件。）&nbsp; 如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。 &nbsp; &nbsp; 1：配置文件 &nbsp; &nbsp;如果需要CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。 &nbsp; &nbsp; 2：命令行 &nbsp; fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d &nbsp; &nbsp; &nbsp; &nbsp;Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。 &nbsp; &nbsp; 3：镜像 &nbsp; &nbsp; &nbsp; docker-compose.yaml文件中的&nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39;命令行修改为 fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d 四：对应e2e_cli生成对应的证书 &nbsp; &nbsp;1：结构分析 &nbsp; &nbsp;我们的目的是生成对应的证书然后使得e2e_cli能够顺利的跑起来。 &nbsp; &nbsp; &nbsp; &nbsp; 我们可以使用下面的部署方式： &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;这里做了简化，只部署了一个Fabric-CA作为rootCA。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 将创建一个由两个组织org1.example.com和org2.example.com组成的的联盟。 &nbsp; 另外还有一个组织example.com用来部署orderer。 &nbsp; &nbsp; &nbsp;example.com部署了一个solo模式的orderer。（多个orderer的部署方式，其实是一样的） &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; orderer.example.com &nbsp; &nbsp; &nbsp;org1.example.com部署了两个peer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org1.example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org1.example.com &nbsp; &nbsp; &nbsp; org2.example.com部署了两个个peer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org2.example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org2.example.com &nbsp; 每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建8个用户： &nbsp; &nbsp; &nbsp; example.com: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Admin@example.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orderer.example.com &nbsp; &nbsp; &nbsp; org1.example.com: &nbsp;Admin@org1.example.com &nbsp;peer0.org1.example.com &nbsp;peer1.org1.example.com &nbsp; &nbsp; &nbsp; &nbsp; org2.example.com: &nbsp;Admin@org2.example.com &nbsp;peer0.org2.example.com &nbsp;peer1.org2.example.com &nbsp; 这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。 &nbsp; &nbsp; 2：生成fabric-ca admin的凭证 &nbsp; &nbsp;在/opt/gopath/bin下面执行：mkdir fabric-ca-files&nbsp;生成fabric-ca admin的凭证，用-H参数指定client目录： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p `pwd`/fabric-ca-files/admin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;这时候/opt/gopath/bin/fabric-ca-files下面有一个admin的文件夹（里面是管理员的证书和私钥等信息）： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3：创建联盟 &nbsp; &nbsp; 通过上面的启动，会默认创建两个组织： &nbsp; melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;（这是fabric-ca-server配置文件中默认的配置，可以在配置文件上进行修改） &nbsp; &nbsp; &nbsp;但是通过我们的结构分析，这种联盟以及名称不是我们需要的，我们需要进行修改。首先将其删除： &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org1 &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org2 &nbsp; &nbsp; &nbsp; 然后创建我们需要的联盟： &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org1 &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org2 &nbsp; &nbsp; &nbsp; 创建联盟如下： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;4：为每个联盟创建msp，将根证书放入到对应的位置 &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/example.com/msp &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp &nbsp;&nbsp;&nbsp;//-M需要指定绝对路径 &nbsp; 命令执行结束后，会在fabric-ca-files/example.com/msp得到文件： &nbsp; &nbsp; &nbsp; $ tree fabric-ca-files/example.com/msp/ &nbsp; &nbsp; &nbsp; &nbsp;example.com/msp/ &nbsp; &nbsp; &nbsp; &nbsp; |-- cacerts &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem &nbsp; &nbsp; &nbsp; &nbsp; |-- intermediatecerts &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem &nbsp; &nbsp; &nbsp; &nbsp; |-- keystore &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;`-- signcerts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;注意：getcacert得到msp目录中只有CA证书。这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到！ &nbsp; &nbsp;用同样的方式分别为org1和org2进行操作： &nbsp; &nbsp; &nbsp; &nbsp; mkdir -p fabric-ca-files/org1.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/org2.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tls在配置文件中设置为false不需要了。 &nbsp; &nbsp; &nbsp; &nbsp; 5：&nbsp;注册example.com的管理员Admin@example.com &nbsp; &nbsp; $ fabric-ca-client register --id.name Admin@example.com --id.type c&nbsp;--id.affiliation &quot;com.example&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; &nbsp; &nbsp; &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/example.com/admin &nbsp; $ fabric-ca-client enroll -u http://Admin@example.com:(password)@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin &nbsp; &nbsp; &nbsp; &nbsp; $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ &nbsp;这时候可以用Admin@example.com的身份查看联盟：(可以全部看到) &nbsp; &nbsp; &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin &nbsp; &nbsp; &nbsp;返回： &nbsp; &nbsp; &nbsp;affiliation: com &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2&nbsp; &nbsp; 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ &nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem &nbsp;fabric-ca-files/example.com/msp/admincerts/ &nbsp; &nbsp;只有这样，才能具备管理员权限。&nbsp; &nbsp; &nbsp;6： 注册org1.example.com的管理员Admin@org1.example.com &nbsp; &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org1.example.com --id.type client --id.affiliation &quot;com.example.org1&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39;&nbsp; &nbsp; &nbsp;$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org1.example.com/admin&nbsp; &nbsp; 只能查看org1和example的联盟。 &nbsp; 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： &nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/msp/admincerts/ &nbsp; &nbsp;&nbsp;在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在 &nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ &nbsp; &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org1.example.com/admin/msp/admincerts/ &nbsp; 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning &nbsp; &nbsp; $ rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* &nbsp; 7：注册org2.example.com的管理员Admin@org2.example.com &nbsp; &nbsp;为org2.example.com的管理员Admin@org2.example.com准备一个目录: &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org2.example.com --id.type client --id.affiliation &quot;com.example.org2&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; &nbsp;$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;$ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml &nbsp;msp/ &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;返回结果： &nbsp; &nbsp;affiliation: com &nbsp; &nbsp; &nbsp; affiliation: com.example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2 &nbsp; &nbsp;Admin@org2.example.com只能看到组织com.example.org2。 &nbsp;将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; 、 &nbsp; &nbsp; &nbsp;fabric-ca-files/org2.example.com/msp/admincerts/ &nbsp; 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-files/org2.example.com/admin/msp/admincerts/ &nbsp;另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： &nbsp; &nbsp; $ rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* &nbsp; 8：各个组织分别使用自己的Admin账户创建其它账号 &nbsp; &nbsp; &nbsp;//order &nbsp; &nbsp; example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 &nbsp; &nbsp; orderer.example.com &nbsp;使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 &nbsp;$ fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password &nbsp;--id.name orderer.example.com --id.type orderer --id.affiliation &quot;com.example&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=orderer:ecert&#39; &nbsp; &nbsp;$ mkdir ./fabric-ca-files/example.com/orderer &nbsp; &nbsp;$ fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H&nbsp; &nbsp; &nbsp; &nbsp;`pwd`/fabric-ca-files/example.com/orderer &nbsp;将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： &nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/orderer/msp/admincerts &nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/example.com/orderer/msp/admincerts/ &nbsp; &nbsp; &nbsp; &nbsp;//peer0org1 &nbsp;使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin/ --id.secret=password &nbsp;--id.name peer0.org1.example.com --id.type peer --id.affiliation &quot;com.example.org1&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp;$ mkdir ./fabric-ca-files/org1.example.com/peer0 &nbsp;$ fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer0/msp/admincerts/ &nbsp; &nbsp; //peer1org1 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password &nbsp;--id.name peer1.org1.example.com --id.type peer --id.affiliation &quot;com.example.org1&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org1.example.com/peer1 &nbsp;$ fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer1/msp/admincerts/ &nbsp;&nbsp; &nbsp; //peer0org2 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer0.org2.example.com --id.type peer --id.affiliation &quot;com.example.org2&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer0 &nbsp;$ fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 &nbsp; &nbsp;$ mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer0/msp/admincerts/ &nbsp; &nbsp; &nbsp; //peer1org2 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer1.org2.example.com --id.type peer --id.affiliation &quot;com.example.org2&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer1 &nbsp;$ fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1 &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer1/msp/admincerts/ &nbsp; 五：进行替换然后手动执行验证 &nbsp; &nbsp; 1：替换 &nbsp; 根据原来通过generateArtifacts.sh脚本生成的crypto-config文件夹的结构进行分析，只需要将我们生成的msp更新对应的msp即可： &nbsp; &nbsp;Example.com的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;Order的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user下的admin的msp &nbsp; &nbsp;Org1 的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer0的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer1的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;User的admin的msp &nbsp; Org2的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer0的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer1的msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; user的admin的msp &nbsp; &nbsp; &nbsp;&nbsp;主要操作，删除原crypto-config文件夹中对应的msp，然后从自己生成的/opt/gopath/fabric-ca-files文件夹中进行复制。&nbsp; 2：验证： &nbsp; &nbsp; 1：修改generateArtifacts.sh，注释掉倒数第二第三行： &nbsp; &nbsp;#generateCerts &nbsp; &nbsp;#replacePrivateKey &nbsp; &nbsp;不生成证书和密钥 &nbsp; &nbsp;2：network_start &nbsp;中down的时候不删除这个存证书和密钥的文件夹 &nbsp; 修改为：rm -rf channel-artifacts/*.block channel-artifacts/*.tx &nbsp; &nbsp;3：直接执行sudo ./network_setup.sh up启动网络 &nbsp; &nbsp;4：手动执行e2e_cli的例子进行： &nbsp; &nbsp; 命令行： &nbsp; &nbsp; //进入cli容器进行操作 &nbsp; &nbsp; docker exec -it cli bash &nbsp; &nbsp; export CHANNEL_NAME=mychannel &nbsp; &nbsp;//创建channel &nbsp; &nbsp;peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx&nbsp; &nbsp; &nbsp;//peer0.org1.example.com加入channel &nbsp; &nbsp;peer channel join -b mychannel.block &nbsp;&nbsp;&nbsp;//peer0.org2.example.com 加入channel CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; &nbsp;peer channel join -b mychannel.block&nbsp; &nbsp; //anchor peer for Org1 as&nbsp;peer0.org1.example.com &nbsp; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org1MSPanchors.tx &nbsp; //peer0.org2.example.com CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org2MSPanchors.tx&nbsp; &nbsp; &nbsp;//安装链码 &nbsp;peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/ &nbsp; &nbsp;//初始化链码 peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]}&#39; &nbsp;//进行查询操作 peer chaincode query -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &nbsp;//进行交易 peer chaincode invoke -o orderer.example.com:7050 &nbsp;-C $CHANNEL_NAME -n mycc &nbsp;&nbsp;-c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39;&nbsp; 如果执行正常，说明证书生成以及替换是正确的。 &nbsp; 六：参考文档： &nbsp; &nbsp;&nbsp;https://www.cnblogs.com/studyzy/p/7482451.html &nbsp; &nbsp;&nbsp;http://hyperledger-fabric-ca.readthedocs.io/en/latest/ &nbsp; &nbsp;&nbsp;https://blog.csdn.net/lijiaocn/article/details/80261529 &nbsp; &nbsp; 七：遇到的问题 &nbsp; &nbsp; 1：melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client affiliation list [sudo] melly 的密码： Error: Failed to parse response: 404 page not found : invalid character &#39;p&#39; after top-level value &nbsp; &nbsp;查看fabric-ca默认注册了几个联盟 &nbsp; &nbsp;查看失败，但是可以去fabric-server的配置文件看即可：（默认如下） &nbsp; &nbsp; &nbsp;或者：修改路径 &nbsp; &nbsp; &nbsp; &nbsp;sudo ./fabric-ca-client &nbsp;-H /home/melly/.fabric-ca-client/ &nbsp;affiliation list &nbsp; &nbsp; &nbsp; affiliation: . &nbsp; &nbsp; &nbsp; &nbsp;affiliation: org2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org2.department1 &nbsp; &nbsp; &nbsp; &nbsp;affiliation: org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department2 &nbsp; 2： [INFO] 127.0.0.1:47924 POST /register 401 42 &quot;Failed to register attribute: Failed to get attribute &#39;hf.Registrar.Attributes&#39;: User does not have attribute &#39;hf.Registrar.Attributes&#39;&quot; 解决： &nbsp; &nbsp; 如下示例，使用 admin 的身份及其配套证书，登记了一个名称为 &quot;admin2&quot;、类型为 &quot;user&quot;、组织关系为&nbsp; &nbsp;&quot;org1.department1&quot;、&quot;hf.Revoker&quot; 属性为 &quot;true&quot; 的新角色： # export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin # fabric-ca-client register --id.name admin2 --id.type user --id.affiliation org1.department1 --id.attr hf.Revoker=true &nbsp;&nbsp; &nbsp; &nbsp; 3：peer create channel grpc: addrConn.resetTransport failed to create client transport: connection error: desc = &quot;transport: failed to write window update: write tcp 172.20.0.7:57304-&gt;172.20.0.3:7050: write: broken pipe&quot;; Reconnecting to {orderer.example.com:7050 &lt;nil&gt;} Error: Error connecting due to &nbsp;rpc error: code = Unavailable desc = grpc: the connection is unavailable &nbsp; &nbsp; &nbsp;grpc：Server.Serve未能完成来自“172.20.0.7:48830”的安全握手：tls：第一条记录看起来不像TLS握手 &nbsp; 解决：去docker-compse-cli.yaml文件中关闭tls &nbsp; &nbsp; &nbsp;4：HYPERLEDGER FABRIC网络搭建之network e2ecli_default not found&nbsp; &nbsp; 原因是：&nbsp; e2e_cli目录是固定的，启动后会创建一个docker network以此为名字，这里是e2e_cli。如果修改该目录，要修&nbsp; &nbsp; &nbsp;改/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/base目录下的peer-base.yaml将网络名修改一下： &nbsp;我的目录是e2e_cli2 &nbsp;- CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli2_default &nbsp; &nbsp; 5：Error: Response from server: Error Code: 20 - Authorization failure &nbsp; 授权失败： &nbsp; 需要重新：授权一下： &nbsp; &nbsp; export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin &nbsp; &nbsp; sudo ./fabric-ca-client enroll -u http://admin:pass@localhost:7054 &nbsp; 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-21T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"一：简介 &nbsp;&nbsp;&nbsp;在e2e_cli的例子中，所有用到的证书和私钥都是由cryptogen这个工具根据crypto-config.yaml而生成的。但是在实际的生产环境中，我们需要给每个org都建立自己的CA，用来管理本org的用户。本次是以e2e_cli为例子，然后手动的生成所有的证书和私钥，并进行手动的执行例子进行验证。 二：环境准备 &nbsp;&nbsp;&nbsp;1：linux环境（我的是vmware虚拟机， ubuntu16.04） &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Go 1.9+ &nbsp;&nbsp;&nbsp;GOPATH环境变量安装成功 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Libtool和libtdhl-dev需要安装 (ubuntu：sudo&nbsp;apt&nbsp;install&nbsp;libtool&nbsp;libltdl-dev) &nbsp;&nbsp;&nbsp;2：可以成功执行e2e_cli例子（这是基本，毕竟在上面进行验证） &nbsp;&nbsp;&nbsp;3：安装fabric-ca-server和fabric-ca-client的可执行文件到$GOPATH/bin目录下 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(go&nbsp;get&nbsp;-u&nbsp;github.com/hyperledger/fabric-ca/cmd/...) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我是直接进行复制的，这样下不下来。 三：生成根CA的证书 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;生成自签CA证书有两种形式：通过可执行文件和镜像，下面进行分别的说明： &nbsp; &nbsp; &nbsp;1：命令行形式 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;执行fabric-ca-server start -b admin:adminpw &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前没有被初始化init，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成ca-cert.pem和ca-key.pem文件(msp文件夹下)，并且如果该文件不存在，还会创建一个默认配置文件fabric-ca-server-config.yaml。&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;注意： &nbsp; （1）：首先可以通过fabric-ca-server init进行初始化，创建证书和私钥以及配置文件，也可以直接进行start，第一次start时会自动执行init的操作。 &nbsp; （2）：这种操作产生的根证书是自签的。可以进行验证：（openssl verify -CAfile ca-cert.pem ca-cert.pem &nbsp;返回ok） &nbsp; （3）：证书可以通过openssl x509 -in ca-cert.pem &nbsp;-text进行查看。 &nbsp;&nbsp; &nbsp; 2：使用镜像启动 &nbsp;进入到$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server目录下然后对docker-compose.yaml文件进行编辑。 &nbsp; &nbsp; &nbsp;fabric-ca-server: &nbsp; &nbsp; &nbsp;image: hyperledger/fabric-ca:x86_64-1.0.0-beta &nbsp; &nbsp; &nbsp;container_name: fabric-ca-server &nbsp; &nbsp; &nbsp;ports: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;&quot;7054:7054&quot; &nbsp; &nbsp; &nbsp;environment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server &nbsp; &nbsp; &nbsp; volumes: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&nbsp;&quot;./fabric-ca-server:/etc/hyperledger/fabric-ca-server&quot; &nbsp; &nbsp; &nbsp; &nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;（注意：自己的ca image的版本根据自己机器中的进行修改）&nbsp; &nbsp; &nbsp; &nbsp; 2.&nbsp;然后执行 docker-compose up -d 启动容器。 &nbsp;&nbsp;（&nbsp;fabric-ca docker 镜像包含了fabric-ca-server和fabric-ca-client两部分。然后会在该目录下生成自签的CA证书和密钥以及fabric ca server的配置文件。）&nbsp; 如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。 &nbsp; &nbsp; 1：配置文件 &nbsp; &nbsp;如果需要CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。 &nbsp; &nbsp; 2：命令行 &nbsp; fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d &nbsp; &nbsp; &nbsp; &nbsp;Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。 &nbsp; &nbsp; 3：镜像 &nbsp; &nbsp; &nbsp; docker-compose.yaml文件中的&nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39;命令行修改为 fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d 四：对应e2e_cli生成对应的证书 &nbsp; &nbsp;1：结构分析 &nbsp; &nbsp;我们的目的是生成对应的证书然后使得e2e_cli能够顺利的跑起来。 &nbsp; &nbsp; &nbsp; &nbsp; 我们可以使用下面的部署方式： &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;这里做了简化，只部署了一个Fabric-CA作为rootCA。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 将创建一个由两个组织org1.example.com和org2.example.com组成的的联盟。 &nbsp; 另外还有一个组织example.com用来部署orderer。 &nbsp; &nbsp; &nbsp;example.com部署了一个solo模式的orderer。（多个orderer的部署方式，其实是一样的） &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; orderer.example.com &nbsp; &nbsp; &nbsp;org1.example.com部署了两个peer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org1.example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org1.example.com &nbsp; &nbsp; &nbsp; org2.example.com部署了两个个peer: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org2.example.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org2.example.com &nbsp; 每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建8个用户： &nbsp; &nbsp; &nbsp; example.com: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Admin@example.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;orderer.example.com &nbsp; &nbsp; &nbsp; org1.example.com: &nbsp;Admin@org1.example.com &nbsp;peer0.org1.example.com &nbsp;peer1.org1.example.com &nbsp; &nbsp; &nbsp; &nbsp; org2.example.com: &nbsp;Admin@org2.example.com &nbsp;peer0.org2.example.com &nbsp;peer1.org2.example.com &nbsp; 这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。 &nbsp; &nbsp; 2：生成fabric-ca admin的凭证 &nbsp; &nbsp;在/opt/gopath/bin下面执行：mkdir fabric-ca-files&nbsp;生成fabric-ca admin的凭证，用-H参数指定client目录： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p `pwd`/fabric-ca-files/admin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;这时候/opt/gopath/bin/fabric-ca-files下面有一个admin的文件夹（里面是管理员的证书和私钥等信息）： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3：创建联盟 &nbsp; &nbsp; 通过上面的启动，会默认创建两个组织： &nbsp; melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp;（这是fabric-ca-server配置文件中默认的配置，可以在配置文件上进行修改） &nbsp; &nbsp; &nbsp;但是通过我们的结构分析，这种联盟以及名称不是我们需要的，我们需要进行修改。首先将其删除： &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org1 &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org2 &nbsp; &nbsp; &nbsp; 然后创建我们需要的联盟： &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org1 &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org2 &nbsp; &nbsp; &nbsp; 创建联盟如下： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;4：为每个联盟创建msp，将根证书放入到对应的位置 &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/example.com/msp &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp &nbsp;&nbsp;&nbsp;//-M需要指定绝对路径 &nbsp; 命令执行结束后，会在fabric-ca-files/example.com/msp得到文件： &nbsp; &nbsp; &nbsp; $ tree fabric-ca-files/example.com/msp/ &nbsp; &nbsp; &nbsp; &nbsp;example.com/msp/ &nbsp; &nbsp; &nbsp; &nbsp; |-- cacerts &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem &nbsp; &nbsp; &nbsp; &nbsp; |-- intermediatecerts &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem &nbsp; &nbsp; &nbsp; &nbsp; |-- keystore &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;`-- signcerts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;注意：getcacert得到msp目录中只有CA证书。这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到！ &nbsp; &nbsp;用同样的方式分别为org1和org2进行操作： &nbsp; &nbsp; &nbsp; &nbsp; mkdir -p fabric-ca-files/org1.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/org2.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tls在配置文件中设置为false不需要了。 &nbsp; &nbsp; &nbsp; &nbsp; 5：&nbsp;注册example.com的管理员Admin@example.com &nbsp; &nbsp; $ fabric-ca-client register --id.name Admin@example.com --id.type c&nbsp;--id.affiliation &quot;com.example&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; &nbsp; &nbsp; &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/example.com/admin &nbsp; $ fabric-ca-client enroll -u http://Admin@example.com:(password)@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin &nbsp; &nbsp; &nbsp; &nbsp; $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ &nbsp;这时候可以用Admin@example.com的身份查看联盟：(可以全部看到) &nbsp; &nbsp; &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin &nbsp; &nbsp; &nbsp;返回： &nbsp; &nbsp; &nbsp;affiliation: com &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2&nbsp; &nbsp; 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ &nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem &nbsp;fabric-ca-files/example.com/msp/admincerts/ &nbsp; &nbsp;只有这样，才能具备管理员权限。&nbsp; &nbsp; &nbsp;6： 注册org1.example.com的管理员Admin@org1.example.com &nbsp; &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org1.example.com --id.type client --id.affiliation &quot;com.example.org1&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39;&nbsp; &nbsp; &nbsp;$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org1.example.com/admin&nbsp; &nbsp; 只能查看org1和example的联盟。 &nbsp; 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： &nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/msp/admincerts/ &nbsp; &nbsp;&nbsp;在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在 &nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ &nbsp; &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org1.example.com/admin/msp/admincerts/ &nbsp; 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning &nbsp; &nbsp; $ rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* &nbsp; 7：注册org2.example.com的管理员Admin@org2.example.com &nbsp; &nbsp;为org2.example.com的管理员Admin@org2.example.com准备一个目录: &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org2.example.com --id.type client --id.affiliation &quot;com.example.org2&quot; --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; &nbsp;$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;$ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml &nbsp;msp/ &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin &nbsp; &nbsp;返回结果： &nbsp; &nbsp;affiliation: com &nbsp; &nbsp; &nbsp; affiliation: com.example &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2 &nbsp; &nbsp;Admin@org2.example.com只能看到组织com.example.org2。 &nbsp;将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; 、 &nbsp; &nbsp; &nbsp;fabric-ca-files/org2.example.com/msp/admincerts/ &nbsp; 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-files/org2.example.com/admin/msp/admincerts/ &nbsp;另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： &nbsp; &nbsp; $ rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* &nbsp; 8：各个组织分别使用自己的Admin账户创建其它账号 &nbsp; &nbsp; &nbsp;//order &nbsp; &nbsp; example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 &nbsp; &nbsp; orderer.example.com &nbsp;使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 &nbsp;$ fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password &nbsp;--id.name orderer.example.com --id.type orderer --id.affiliation &quot;com.example&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=orderer:ecert&#39; &nbsp; &nbsp;$ mkdir ./fabric-ca-files/example.com/orderer &nbsp; &nbsp;$ fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H&nbsp; &nbsp; &nbsp; &nbsp;`pwd`/fabric-ca-files/example.com/orderer &nbsp;将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： &nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/orderer/msp/admincerts &nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/example.com/orderer/msp/admincerts/ &nbsp; &nbsp; &nbsp; &nbsp;//peer0org1 &nbsp;使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin/ --id.secret=password &nbsp;--id.name peer0.org1.example.com --id.type peer --id.affiliation &quot;com.example.org1&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp;$ mkdir ./fabric-ca-files/org1.example.com/peer0 &nbsp;$ fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer0/msp/admincerts/ &nbsp; &nbsp; //peer1org1 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password &nbsp;--id.name peer1.org1.example.com --id.type peer --id.affiliation &quot;com.example.org1&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org1.example.com/peer1 &nbsp;$ fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer1/msp/admincerts/ &nbsp;&nbsp; &nbsp; //peer0org2 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer0.org2.example.com --id.type peer --id.affiliation &quot;com.example.org2&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer0 &nbsp;$ fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 &nbsp; &nbsp;$ mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts &nbsp; &nbsp;$ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer0/msp/admincerts/ &nbsp; &nbsp; &nbsp; //peer1org2 &nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer1.org2.example.com --id.type peer --id.affiliation &quot;com.example.org2&quot; --id.maxenrollments &quot;0&quot; --id.attrs &#39;role=peer:ecert&#39; &nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer1 &nbsp;$ fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1 &nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts &nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer1/msp/admincerts/ &nbsp; 五：进行替换然后手动执行验证 &nbsp; &nbsp; 1：替换 &nbsp; 根据原来通过generateArtifacts.sh脚本生成的crypto-config文件夹的结构进行分析，只需要将我们生成的msp更新对应的msp即可： &nbsp; &nbsp;Example.com的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;Order的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;user下的admin的msp &nbsp; &nbsp;Org1 的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer0的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer1的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;User的admin的msp &nbsp; Org2的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer0的msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;Peer1的msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; user的admin的msp &nbsp; &nbsp; &nbsp;&nbsp;主要操作，删除原crypto-config文件夹中对应的msp，然后从自己生成的/opt/gopath/fabric-ca-files文件夹中进行复制。&nbsp; 2：验证： &nbsp; &nbsp; 1：修改generateArtifacts.sh，注释掉倒数第二第三行： &nbsp; &nbsp;#generateCerts &nbsp; &nbsp;#replacePrivateKey &nbsp; &nbsp;不生成证书和密钥 &nbsp; &nbsp;2：network_start &nbsp;中down的时候不删除这个存证书和密钥的文件夹 &nbsp; 修改为：rm -rf channel-artifacts/*.block channel-artifacts/*.tx &nbsp; &nbsp;3：直接执行sudo ./network_setup.sh up启动网络 &nbsp; &nbsp;4：手动执行e2e_cli的例子进行： &nbsp; &nbsp; 命令行： &nbsp; &nbsp; //进入cli容器进行操作 &nbsp; &nbsp; docker exec -it cli bash &nbsp; &nbsp; export CHANNEL_NAME=mychannel &nbsp; &nbsp;//创建channel &nbsp; &nbsp;peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx&nbsp; &nbsp; &nbsp;//peer0.org1.example.com加入channel &nbsp; &nbsp;peer channel join -b mychannel.block &nbsp;&nbsp;&nbsp;//peer0.org2.example.com 加入channel CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; &nbsp;peer channel join -b mychannel.block&nbsp; &nbsp; //anchor peer for Org1 as&nbsp;peer0.org1.example.com &nbsp; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org1MSPanchors.tx &nbsp; //peer0.org2.example.com CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org2MSPanchors.tx&nbsp; &nbsp; &nbsp;//安装链码 &nbsp;peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/ &nbsp; &nbsp;//初始化链码 peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]}&#39; &nbsp;//进行查询操作 peer chaincode query -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &nbsp;//进行交易 peer chaincode invoke -o orderer.example.com:7050 &nbsp;-C $CHANNEL_NAME -n mycc &nbsp;&nbsp;-c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39;&nbsp; 如果执行正常，说明证书生成以及替换是正确的。 &nbsp; 六：参考文档： &nbsp; &nbsp;&nbsp;https://www.cnblogs.com/studyzy/p/7482451.html &nbsp; &nbsp;&nbsp;http://hyperledger-fabric-ca.readthedocs.io/en/latest/ &nbsp; &nbsp;&nbsp;https://blog.csdn.net/lijiaocn/article/details/80261529 &nbsp; &nbsp; 七：遇到的问题 &nbsp; &nbsp; 1：melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client affiliation list [sudo] melly 的密码： Error: Failed to parse response: 404 page not found : invalid character &#39;p&#39; after top-level value &nbsp; &nbsp;查看fabric-ca默认注册了几个联盟 &nbsp; &nbsp;查看失败，但是可以去fabric-server的配置文件看即可：（默认如下） &nbsp; &nbsp; &nbsp;或者：修改路径 &nbsp; &nbsp; &nbsp; &nbsp;sudo ./fabric-ca-client &nbsp;-H /home/melly/.fabric-ca-client/ &nbsp;affiliation list &nbsp; &nbsp; &nbsp; affiliation: . &nbsp; &nbsp; &nbsp; &nbsp;affiliation: org2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org2.department1 &nbsp; &nbsp; &nbsp; &nbsp;affiliation: org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department2 &nbsp; 2： [INFO] 127.0.0.1:47924 POST /register 401 42 &quot;Failed to register attribute: Failed to get attribute &#39;hf.Registrar.Attributes&#39;: User does not have attribute &#39;hf.Registrar.Attributes&#39;&quot; 解决： &nbsp; &nbsp; 如下示例，使用 admin 的身份及其配套证书，登记了一个名称为 &quot;admin2&quot;、类型为 &quot;user&quot;、组织关系为&nbsp; &nbsp;&quot;org1.department1&quot;、&quot;hf.Revoker&quot; 属性为 &quot;true&quot; 的新角色： # export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin # fabric-ca-client register --id.name admin2 --id.type user --id.affiliation org1.department1 --id.attr hf.Revoker=true &nbsp;&nbsp; &nbsp; &nbsp; 3：peer create channel grpc: addrConn.resetTransport failed to create client transport: connection error: desc = &quot;transport: failed to write window update: write tcp 172.20.0.7:57304-&gt;172.20.0.3:7050: write: broken pipe&quot;; Reconnecting to {orderer.example.com:7050 &lt;nil&gt;} Error: Error connecting due to &nbsp;rpc error: code = Unavailable desc = grpc: the connection is unavailable &nbsp; &nbsp; &nbsp;grpc：Server.Serve未能完成来自“172.20.0.7:48830”的安全握手：tls：第一条记录看起来不像TLS握手 &nbsp; 解决：去docker-compse-cli.yaml文件中关闭tls &nbsp; &nbsp; &nbsp;4：HYPERLEDGER FABRIC网络搭建之network e2ecli_default not found&nbsp; &nbsp; 原因是：&nbsp; e2e_cli目录是固定的，启动后会创建一个docker network以此为名字，这里是e2e_cli。如果修改该目录，要修&nbsp; &nbsp; &nbsp;改/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/base目录下的peer-base.yaml将网络名修改一下： &nbsp;我的目录是e2e_cli2 &nbsp;- CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli2_default &nbsp; &nbsp; 5：Error: Response from server: Error Code: 20 - Authorization failure &nbsp; 授权失败： &nbsp; 需要重新：授权一下： &nbsp; &nbsp; export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin &nbsp; &nbsp; sudo ./fabric-ca-client enroll -u http://admin:pass@localhost:7054 &nbsp; 阅读更多","@type":"BlogPosting","url":"/2018/06/21/189a81f5f4834e8875170e5588fb5673.html","headline":"fabric e2e_cli例子手动用CA签证书并验证","dateModified":"2018-06-21T00:00:00+08:00","datePublished":"2018-06-21T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/06/21/189a81f5f4834e8875170e5588fb5673.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>fabric e2e_cli例子手动用CA签证书并验证</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p><span style="font-weight:bold;"><span style="font-size:18px;">一：简介</span></span></p>
  <p>&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">在</span>e2e_cli<span style="font-family:'宋体';">的例子中，所有用到的证书和私钥都是由</span><strong>cryptogen<span style="font-family:'宋体';">这个工具</span></strong>根据<strong>crypto-config.yaml</strong><span style="font-family:'宋体';">而生成的。但是在实际的生产环境中，我们需要给每个</span>org<span style="font-family:'宋体';">都建立自己的</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">，用来管理本</span><span style="font-family:Calibri;">org</span><span style="font-family:'宋体';">的用户。本次是以</span><span style="font-family:Calibri;">e2e_cli</span><span style="font-family:'宋体';">为例子，然后手动的生成所有的证书和私钥，并进行手动的执行例子进行验证。</span></p>
  <p><strong><span style="font-size:18px;">二：环境准备</span></strong></p>
  <p>&nbsp;<strong>&nbsp;&nbsp;1<span style="font-family:'宋体';">：</span><span style="font-family:Calibri;">linux</span><span style="font-family:'宋体';">环境（我的是</span><span style="font-family:Calibri;">vmware</span><span style="font-family:'宋体';">虚拟机， </span><span style="font-family:Calibri;">ubuntu16.04</span><span style="font-family:'宋体';">）</span></strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Go 1.9+ </strong>&nbsp;&nbsp;&nbsp;GOPATH<span style="font-family:'宋体';">环境变量安装成功 &nbsp;&nbsp;&nbsp;</span></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>Libtool<span style="font-family:'宋体';">和</span><span style="font-family:'Courier New';">libtdhl-dev</span></strong>需要安装</p>
  <p>(ubuntu<span style="font-family:'宋体';">：</span><span style="color:rgb(51,51,51);">sudo</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">apt</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">install</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">libtool</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">libltdl</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">dev</span><span style="color:rgb(51,51,51);">)</span></p>
  <p>&nbsp;&nbsp;&nbsp;<strong>2<span style="font-family:'宋体';">：可以成功执行</span><span style="font-family:Calibri;">e2e_cli</span><span style="font-family:'宋体';">例子</span></strong>（这是基本，毕竟在上面进行验证）</p>
  <p>&nbsp;&nbsp;&nbsp;<strong>3<span style="font-family:'宋体';">：安装</span><span style="font-family:Calibri;">fabric-ca-server</span><span style="font-family:'宋体';">和</span><span style="font-family:Calibri;">fabric-ca-client</span><span style="font-family:'宋体';">的可执行文件</span></strong><span style="font-family:'宋体';">到</span>$GOPATH/bin<span style="font-family:'宋体';">目录下</span></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span style="color:rgb(51,51,51);">go</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">get</span><span style="color:rgb(64,64,64);">&nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">u</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">github</span><strong><span style="color:rgb(64,64,64);">.</span></strong><span style="color:rgb(51,51,51);">com</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">hyperledger</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">fabric</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">ca</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">cmd</span><strong><span style="color:rgb(64,64,64);">/...</span></strong>)</p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">我是直接进行复制的，这样下不下来。</span></p>
  <p><strong><span style="font-size:18px;"><span style="font-family:'宋体';">三：生成根</span>CA<span style="font-family:'宋体';">的证书</span></span></strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;<strong>&nbsp;</strong>生成<strong><span style="font-family:'新宋体';">自签</span>CA证书</strong>有两种形式：通过可执行文件和镜像，下面进行分别的说明：</p>
  <p><strong>&nbsp; &nbsp; &nbsp;1：命令行形式</strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<strong><span style="font-family:'新宋体';">执行</span>fabric-ca-server start -b admin:adminpw</strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前<strong><span style="font-family:'新宋体';">没有被初始化</span>init，它将在第一次启动时自行初始化</strong><span style="font-family:'新宋体';">。</span> <span style="font-family:'新宋体';">在初始化期间，如果服务器尚不存在，服务器将生成</span><strong>ca-cert.pem和ca-key.pem文件(msp文件夹下)</strong>，并且如果该文件不存在，还会创建一个<strong><span style="font-family:'新宋体';">默认配置文件</span>fabric-ca-server-config.yaml</strong>。<span style="color:rgb(51,51,51);">&nbsp;&nbsp;</span></p>
  <p>&nbsp;&nbsp;&nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621200857402?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="">&nbsp;</p>
  <p><strong>&nbsp; &nbsp;&nbsp;<span style="font-family:'宋体';">注意：</span></strong></p>
  <p><span style="font-family:'宋体';">&nbsp; （</span>1<span style="font-family:'宋体';">）：首先可以通过</span><strong>fabric-ca-server init<span style="font-family:'宋体';">进行初始化</span></strong><span style="font-family:'宋体';">，创建证书和私钥以及配置文件，也可以直接进行</span>start<span style="font-family:'宋体';">，第一次</span><span style="font-family:Calibri;">start</span><span style="font-family:'宋体';">时会自动执行</span><span style="font-family:Calibri;">init</span><span style="font-family:'宋体';">的操作。</span></p>
  <p><span style="font-family:'宋体';">&nbsp; （</span>2<span style="font-family:'宋体';">）：这种操作产生的根证书是</span><strong>自签的</strong><span style="font-family:'宋体';">。可以进行验证：（</span>openssl verify -CAfile ca-cert.pem ca-cert.pem &nbsp;<span style="font-family:'宋体';">返回</span><span style="font-family:Calibri;">ok</span><span style="font-family:'宋体';">）</span></p>
  <p><span style="font-family:'宋体';">&nbsp; （</span>3<span style="font-family:'宋体';">）：证书可以通过</span><span style="font-family:Calibri;">openssl x509 -in ca-cert.pem &nbsp;-text</span><span style="font-family:'宋体';">进行查看。</span></p>
  <p>&nbsp;<span style="font-weight:bold;">&nbsp; &nbsp; 2：使用镜像启动</span></p>
  <p></p>
  <ol>
   <li>&nbsp;进入到$GOPATH/src/github.com/hyperledger/fabric-ca/docker/server目录下然后对<strong>docker-compose.yaml</strong>文件进行编辑。</li>
  </ol>
  <p><span style="color:rgb(51,51,51);">&nbsp; &nbsp; &nbsp;fabric</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">ca</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">server</span><span style="color:rgb(64,64,64);">:</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp;</span><span style="color:rgb(51,51,51);">image</span><span style="color:rgb(64,64,64);">: </span><span style="color:rgb(51,51,51);">hyperledger</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">fabric</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">ca</span><span style="color:rgb(64,64,64);">:</span><span style="color:rgb(51,51,51);">x86_64</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(0,153,153);">1.0</span><strong><span style="color:rgb(64,64,64);">.</span></strong><span style="color:rgb(0,153,153);">0</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">beta</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp;</span><span style="color:rgb(51,51,51);">container_name</span><span style="color:rgb(64,64,64);">: </span><span style="color:rgb(51,51,51);">fabric</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">ca</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">server</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp;</span><span style="color:rgb(51,51,51);">ports</span><span style="color:rgb(64,64,64);">:</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(221,17,68);">"7054:7054"</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp;</span><span style="color:rgb(51,51,51);">environment</span><span style="color:rgb(64,64,64);">:</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">FABRIC_CA_HOME</span><strong><span style="color:rgb(64,64,64);">=/</span></strong><span style="color:rgb(51,51,51);">etc</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">hyperledger</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">fabric</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">ca</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">server</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp; </span><span style="color:rgb(51,51,51);">volumes</span><span style="color:rgb(64,64,64);">:</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(221,17,68);">"./fabric-ca-server:/etc/hyperledger/fabric-ca-server"</span></p>
  <p><span style="color:rgb(64,64,64);">&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color:rgb(51,51,51);">command</span><span style="color:rgb(64,64,64);">: </span><span style="color:rgb(51,51,51);">sh</span><span style="color:rgb(64,64,64);">&nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">c</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(221,17,68);">'fabric-ca-server start -b admin:adminpw'</span></p>
  <p><span style="color:rgb(221,17,68);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="font-family:'宋体';">（注意：自己的</span>ca </span><span style="color:rgb(51,51,51);">image</span><span style="color:rgb(51,51,51);">的版本根据自己机器中的进行修改</span><span style="color:rgb(221,17,68);">）</span>&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp; 2.&nbsp;<span style="font-family:'新宋体';">然后执行</span> <strong>docker-compose up -d 启动容</strong>器。</p>
  <p>&nbsp;&nbsp;<span style="font-family:'新宋体';">（&nbsp;</span>fabric-ca docker 镜像包含了fabric-ca-server和fabric-ca-client两部分。然后会在该目录下生成自签的CA证书和密钥以及fabric ca server的配置文件。）<span style="font-weight:bold;">&nbsp;</span></p>
  <p><strong>如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。</strong></p>
  <p><strong>&nbsp; &nbsp; 1：配置文件</strong></p>
  <p><span style="font-family:'新宋体';">&nbsp; &nbsp;如果需要</span>CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。</p>
  <p><strong>&nbsp; &nbsp; 2：命令行</strong></p>
  <p>&nbsp; fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。</p>
  <p><strong>&nbsp; &nbsp; 3：镜像</strong></p>
  <p><strong>&nbsp; &nbsp; &nbsp; docker-compose.yaml</strong>文件中的<span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">command</span><span style="color:rgb(64,64,64);">: </span><span style="color:rgb(51,51,51);">sh</span><span style="color:rgb(64,64,64);">&nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">c</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(221,17,68);">'fabric-ca-server start -b admin:adminpw'</span><span style="font-family:'新宋体';">命令行修改为</span> fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d</p>
  <p><br></p>
  <p><strong><span style="font-family:'宋体';"><span style="font-size:18px;">四：对应</span></span><span style="font-size:18px;">e2e_cli<span style="font-family:'宋体';">生成对应的证书</span></span></strong></p>
  <p><strong>&nbsp; &nbsp;<span style="font-size:16px;">1：结构分析</span></strong></p>
  <p><span style="color:rgb(0,0,0);"><span style="font-family:'宋体';">&nbsp; &nbsp;我们的目的是生成对应的证书然后使得</span>e2e_cli<span style="font-family:'宋体';">能够顺利的跑起来。</span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; &nbsp; 我们可以使用下面的部署方式：</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621200946608?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; &nbsp;这里做了简化，只部署了一个</span>Fabric-CA作为rootCA。</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621201003940?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 将创建一个由两个组织</span>org1.example.com和org2.example.com组成的的联盟。</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 另外还有一个组织</span>example.com用来部署orderer。</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp;example.com部署了一个solo模式的orderer</span></strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">。（多个</span>orderer的部署方式，其实是一样的）</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; orderer.example.com</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp;org1.example.com部署了两个peer</span></strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">:</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org1.example.com</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org1.example.com</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; org2.example.com部署了两个个peer:</span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer0.org2.example.com</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;peer1.org2.example.com</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 每个组织都要有一个</span></span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">Admin用户</span></strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">，每个组件</span>(peer/orderer)也需要一个账号，因此需要通过</span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">fabric-ca创建8个用户</span></strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">：</span></span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; example.com: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">Admin@example.com</span></strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">orderer.example.com</span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; org1.example.com: &nbsp;</span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">Admin@org1.example.com &nbsp;peer0.org1.example.com &nbsp;peer1.org1.example.com &nbsp;</span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; org2.example.com: &nbsp;</span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">Admin@org2.example.com &nbsp;peer0.org2.example.com &nbsp;peer1.org2.example.com</span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 这里只创建了</span>Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></p>
  <p><strong><span style="font-size:16px;">&nbsp; 2<span style="font-family:'宋体';">：生成</span><span style="font-family:Calibri;">fabric-ca admin</span><span style="font-family:'宋体';">的凭证</span></span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; &nbsp;在</span>/opt/gopath/bin下面执行：</span><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">mkdir fabric-ca-files&nbsp;</span></strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">生成</span>fabric-ca admin的凭证，用</span><span style="color:rgb(199,37,78);background:rgb(249,242,244);">-H</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">参数指定</span>client目录：</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p `pwd`/fabric-ca-files/admin</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin</span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="font-family:'宋体';">这时候</span>/opt/gopath/bin/fabric-ca-files下面有一个admin的文件夹（里面是管理员的证书和私钥等信息）：</span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621201226489?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p><strong>&nbsp;<span style="font-size:16px;"> &nbsp; 3<span style="font-family:'宋体';">：创建联盟</span></span></strong></p>
  <p>&nbsp; &nbsp; 通过上面的启动，会默认创建两个组织：</p>
  <p><strong>&nbsp; melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list</strong></p>
  <p>&nbsp; &nbsp; &nbsp;&nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621201304784?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p>&nbsp; &nbsp; &nbsp;（这是fabric-ca-server配置文件中默认的配置，可以在配置文件上进行修改）</p>
  <p>&nbsp; &nbsp; &nbsp;但是通过我们的结构分析，这种联盟以及名称不是我们需要的，我们需要进行修改。首先将其删除：</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org1</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client -H `pwd`/fabric-ca-files/admin &nbsp;affiliation remove --force &nbsp;org2</p>
  <p>&nbsp; &nbsp; &nbsp; 然后创建我们需要的联盟：</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com </p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org1</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation add com.example.org2</p>
  <p>&nbsp; &nbsp; &nbsp; 创建联盟如下：</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client &nbsp;-H `pwd`/fabric-ca-files/admin &nbsp;affiliation list</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621201454230?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p>&nbsp; &nbsp;<span style="font-size:16px;">&nbsp;<span style="font-weight:bold;">4</span><span style="font-family:'宋体';"><strong>：为每个联盟创建</strong></span><span style="font-family:Calibri;"><strong>msp</strong></span><span style="font-family:'宋体';"><strong>，将根证书放入到对应的位置</strong></span></span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/example.com/msp</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp &nbsp;&nbsp;&nbsp;//-M<span style="font-family:'宋体';">需要指定绝对路径</span></p>
  <p><span style="font-family:'宋体';">&nbsp; 命令执行结束后，会在</span>fabric-ca-files/example.com/msp<span style="font-family:'宋体';">得到文件：</span></p>
  <p>&nbsp; &nbsp; &nbsp; $ tree fabric-ca-files/example.com/msp/</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;example.com/msp/</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; |-- cacerts</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; |-- intermediatecerts</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;&nbsp;`-- localhost-7054.pem</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; |-- keystore</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;`-- signcerts</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="font-family:'宋体';">注意：</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);">getcacert得到msp目录中只有CA证书</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">。</span></span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">这里是用</span></span><span style="color:rgb(199,37,78);background:rgb(249,242,244);">getcacert</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">为每个组织准备需要的</span>ca文件，在生成创始块的时候会用到</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">！</span></span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; &nbsp;用同样的方式分别为</span>org1和org2进行操作：</span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; mkdir -p fabric-ca-files/org1.example.com/msp</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mkdir -p ./fabric-ca-files/org2.example.com/msp</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp</p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tls在配置文件中设置为false不需要了。</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; <span style="font-size:16px;">&nbsp; 5：</span></span></strong><span style="font-size:16px;"><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span><strong><span style="color:rgb(0,0,0);background:rgb(255,255,255);"><span style="font-family:'宋体';">注册</span>example.com的管理员Admin@example.com</span></strong></span></p>
  <p>&nbsp; &nbsp; $ fabric-ca-client register --id.name Admin@example.com --id.type c&nbsp;--id.affiliation "com.example" --id.attrs '"hf.Registrar.Roles=client,orderer,peer,user","hf.Registrar.DelegateRoles=client,orderer,peer,user",hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert'</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/example.com/admin </p>
  <p>&nbsp; $ fabric-ca-client enroll -u http://Admin@example.com:(password)@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin </p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ </p>
  <p><span style="font-family:'宋体';">&nbsp;这时候可以用</span>Admin@example.com<span style="font-family:'宋体';">的身份查看联盟：</span><span style="font-family:'Courier New';">(</span><span style="font-family:'宋体';">可以全部看到</span><span style="font-family:'Courier New';">)</span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin</p>
  <p>&nbsp; &nbsp; &nbsp;返回：</p>
  <p>&nbsp; &nbsp; &nbsp;affiliation: com</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: com.example.org1</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2&nbsp;</p>
  <p><strong><span style="font-family:'宋体';">&nbsp; 最后需要将</span>Admin@example.com<span style="font-family:'宋体';">的证书复制到</span><span style="font-family:'Courier New';">example.com/msp/admincerts/</span></strong></p>
  <p>&nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/msp/admincerts/</p>
  <p>&nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem &nbsp;fabric-ca-files/example.com/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);">&nbsp; &nbsp;只有这样，才能具备管理员权限</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">。</span></span></strong><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);">&nbsp;</span></p>
  <p><span style="font-size:18px;"><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></span></p>
  <p><span style="font-size:16px;"><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;6： </span><span style="color:rgb(0,0,0);background:rgb(255,255,255);"><span style="font-family:'宋体';">注册</span></span><span style="color:rgb(0,0,0);background:rgb(255,255,255);">org1.</span><span style="color:rgb(0,0,0);background:rgb(255,255,255);">example.com的管理员Admin@</span><span style="color:rgb(0,0,0);background:rgb(255,255,255);">org1.</span><span style="color:rgb(0,0,0);background:rgb(255,255,255);">example.com</span></strong></span></p>
  <p>&nbsp; &nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org1.example.com --id.type client --id.affiliation "com.example.org1" --id.attrs '"hf.Registrar.Roles=client,orderer,peer,user","hf.Registrar.DelegateRoles=client,orderer,peer,user",hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert'&nbsp;</p>
  <p>&nbsp; &nbsp;$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org1.example.com/admin<span style="background-color:rgb(255,255,255);color:rgb(51,51,51);font-weight:bold;">&nbsp;</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 只能查看</span>org1和example的联盟。</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 将</span>Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中：</span></strong></p>
  <p>&nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/msp/admincerts/</p>
  <p>&nbsp; &nbsp; $ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp;&nbsp;</span></strong><span style="color:rgb(51,51,51);font-family:'宋体';"><strong>在</strong></span><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);font-weight:bold;">Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在</span></p>
  <p>&nbsp; &nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/</p>
  <p>&nbsp; &nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem &nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp; fabric-ca-files/org1.example.com/admin/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 另外，这里没有使用中间</span>CA，将intermediatecerts中的空文件删除，否则peer会提示Warning</span></strong></p>
  <p>&nbsp; &nbsp; $ rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/*</p>
  <p><br></p>
  <h2 style="background:rgb(255,255,255);"><span style="font-size:16px;"><strong><span style="color:rgb(51,51,51);">&nbsp; 7：</span></strong><a href="mailto:%E6%B3%A8%E5%86%8Corg2.example.com%E7%9A%84%E7%AE%A1%E7%90%86%E5%91%98Admin@org2.example.com" rel="nofollow"><strong><span style="color:rgb(51,51,51);"><span style="font-family:'宋体';">注册</span>org2.example.com的管理员Admin@org2.example.com</span></strong></a></span></h2>
  <p>&nbsp; &nbsp;<strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">为</span>org2.example.com的管理员Admin@org2.example.com准备一个目录:</span></strong></p>
  <p>&nbsp; &nbsp;$ mkdir -p ./fabric-ca-files/org2.example.com/admin</p>
  <p>&nbsp; &nbsp;$ fabric-ca-client register --id.name Admin@org2.example.com --id.type client --id.affiliation "com.example.org2" --id.attrs '"hf.Registrar.Roles=client,orderer,peer,user","hf.Registrar.DelegateRoles=client,orderer,peer,user",hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert'</p>
  <p>&nbsp;$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 &nbsp;-H `pwd`/fabric-ca-files/org2.example.com/admin</p>
  <p>&nbsp; &nbsp;$ ls ./fabric-ca-files/org2.example.com/admin</p>
  <p>fabric-ca-client-config.yaml &nbsp;msp/</p>
  <p>&nbsp; &nbsp;$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin</p>
  <p>&nbsp; &nbsp;返回结果：</p>
  <p>&nbsp; &nbsp;affiliation: com</p>
  <p>&nbsp; &nbsp; &nbsp; affiliation: com.example</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;affiliation: com.example.org2</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp;Admin@org2.example.com只能看到组织com.example.org2。</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp;将</span>Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中：</span></strong></p>
  <p>&nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/msp/admincerts/</p>
  <p>&nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp; 、</p>
  <p>&nbsp; &nbsp; &nbsp;fabric-ca-files/org2.example.com/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 在</span>Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</span></strong></p>
  <p>&nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/</p>
  <p>&nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp;&nbsp;<strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">fabric-ca-files/org2.example.com/admin/msp/admincerts/</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp;另外，这里没有使用中间</span>CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</span></strong></p>
  <p>&nbsp; &nbsp; $ rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/*</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></strong></p>
  <p><span style="font-size:18px;background-color:rgb(255,255,255);color:rgb(0,0,0);"><strong>8：</strong></span><span style="font-size:18px;background-color:rgb(255,255,255);color:rgb(0,0,0);"><strong><span style="font-family:'宋体';">各个组织分别使用自己的</span>Admin账户创建其它账号</strong></span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp;//order</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; orderer.example.com</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp;使用</span>Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。</span></strong></p>
  <p>&nbsp;$ fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password &nbsp;--id.name orderer.example.com --id.type orderer --id.affiliation "com.example" --id.maxenrollments "0" --id.attrs 'role=orderer:ecert'</p>
  <p>&nbsp; &nbsp;$ mkdir ./fabric-ca-files/example.com/orderer</p>
  <p>&nbsp; &nbsp;$ fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp;`pwd`/fabric-ca-files/example.com/orderer</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp;将</span>Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts：</span></strong></p>
  <p>&nbsp; &nbsp; $ mkdir fabric-ca-files/example.com/orderer/msp/admincerts</p>
  <p>&nbsp; &nbsp; $ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/example.com/orderer/msp/admincer<strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">ts/</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp;//peer0org1</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp;使用</span>Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。</span></strong></p>
  <p>&nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin/ --id.secret=password &nbsp;--id.name peer0.org1.example.com --id.type peer --id.affiliation "com.example.org1" --id.maxenrollments "0" --id.attrs 'role=peer:ecert'</p>
  <p>&nbsp; &nbsp;$ mkdir ./fabric-ca-files/org1.example.com/peer0</p>
  <p>&nbsp;$ fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0</p>
  <p>&nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts</p>
  <p>&nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer0/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></strong></p>
  <p><strong>&nbsp; //peer1org1</strong></p>
  <p>&nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password &nbsp;--id.name peer1.org1.example.com --id.type peer --id.affiliation "com.example.org1" --id.maxenrollments "0" --id.attrs 'role=peer:ecert'</p>
  <p>&nbsp; &nbsp; $ mkdir ./fabric-ca-files/org1.example.com/peer1</p>
  <p>&nbsp;$ fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1</p>
  <p>&nbsp; &nbsp;$ mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts</p>
  <p>&nbsp; &nbsp;$ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp;fabric-ca-files/org1.example.com/peer1/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></strong><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);font-weight:bold;">&nbsp;</span></p>
  <p><strong>&nbsp; //peer0org2</strong></p>
  <p>&nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer0.org2.example.com --id.type peer --id.affiliation "com.example.org2" --id.maxenrollments "0" --id.attrs 'role=peer:ecert'</p>
  <p>&nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer0</p>
  <p>&nbsp;$ fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0</p>
  <p>&nbsp; &nbsp;$ mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts</p>
  <p>&nbsp; &nbsp;$ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer0/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></strong></p>
  <p>&nbsp; <strong>&nbsp; //peer1org2</strong></p>
  <p>&nbsp; $ fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password &nbsp;--id.name peer1.org2.example.com --id.type peer --id.affiliation "com.example.org2" --id.maxenrollments "0" --id.attrs 'role=peer:ecert'</p>
  <p>&nbsp; &nbsp; $ mkdir ./fabric-ca-files/org2.example.com/peer1</p>
  <p>&nbsp;$ fabric-ca-client enroll -u http://peer1.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer1</p>
  <p>&nbsp; &nbsp; $ mkdir fabric-ca-files/org2.example.com/peer1/msp/admincerts</p>
  <p>&nbsp; &nbsp; $ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem&nbsp;</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-files/org2.example.com/peer1/msp/admincerts/</p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></strong></p>
  <p><strong><span style="font-size:18px;">五：进行替换然后手动执行验证</span></strong></p>
  <p><strong><span style="font-size:16px;">&nbsp; &nbsp; 1<span style="font-family:'宋体';">：替换</span></span></strong></p>
  <p><span style="font-family:'宋体';">&nbsp; 根据原来通过</span>generateArtifacts.sh<span style="font-family:'宋体';">脚本生成的</span><span style="font-family:Calibri;">crypto-config</span><span style="font-family:'宋体';">文件夹的结构进行分析，只需要将我们生成的</span><span style="font-family:Calibri;">msp</span><span style="font-family:'宋体';">更新对应的</span><span style="font-family:Calibri;">msp</span><span style="font-family:'宋体';">即可：</span></p>
  <p>&nbsp; &nbsp;Example.com<span style="font-family:'宋体';">的</span><strong>msp</strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong>&nbsp;Order<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<strong>user<span style="font-family:'宋体';">下的</span><span style="font-family:Calibri;">admin</span><span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp; &nbsp;Org1 <span style="font-family:'宋体';">的</span><strong>msp</strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong>Peer0<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong>Peer1<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong>User<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">admin</span><span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp; Org2<span style="font-family:'宋体';">的</span><strong>msp</strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong>Peer0<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<strong>&nbsp;Peer1<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>&nbsp; &nbsp; user<span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">admin</span><span style="font-family:'宋体';">的</span><span style="font-family:Calibri;">msp</span></strong></p>
  <p><strong>&nbsp; &nbsp; &nbsp;&nbsp;</strong><span style="font-family:'宋体';">主要操作，删除原</span>crypto-config<span style="font-family:'宋体';">文件夹中对应的</span><span style="font-family:Calibri;">msp</span><span style="font-family:'宋体';">，然后从自己生成的</span><span style="font-family:Calibri;">/opt/gopath/fabric-ca-files</span><span style="font-family:'宋体';">文件夹中进行复制。</span>&nbsp;</p>
  <p><strong><span style="font-size:16px;">2<span style="font-family:'宋体';">：验证：</span></span></strong></p>
  <p><strong>&nbsp; &nbsp; 1<span style="font-family:'宋体';">：修改</span><span style="font-family:Calibri;">generateArtifacts.sh</span></strong>，注释掉倒数第二第三行：</p>
  <p>&nbsp; &nbsp;#generateCerts</p>
  <p>&nbsp; &nbsp;#replacePrivateKey</p>
  <p>&nbsp; &nbsp;不生成证书和密钥</p>
  <p><strong>&nbsp; &nbsp;2<span style="font-family:'宋体';">：</span><span style="font-family:Calibri;">network_start &nbsp;</span><span style="font-family:'宋体';">中</span><span style="font-family:Calibri;">down</span><span style="font-family:'宋体';">的时候不删除这个存证书和密钥的文件夹</span></strong></p>
  <p><span style="font-family:'宋体';">&nbsp; 修改为：</span>rm -rf channel-artifacts/*.block channel-artifacts/*.tx</p>
  <p><strong>&nbsp; &nbsp;3<span style="font-family:'宋体';">：</span></strong>直接执行<strong>sudo ./network_setup.sh up</strong>启动网络</p>
  <p>&nbsp; &nbsp;<strong>4<span style="font-family:'宋体';">：手动执行</span><span style="font-family:Calibri;">e2e_cli</span><span style="font-family:'宋体';">的例子进行</span></strong>：</p>
  <p>&nbsp; &nbsp; 命令行：</p>
  <p>&nbsp; &nbsp;<strong> //<span style="font-family:'宋体';">进入</span><span style="font-family:Calibri;">cli</span><span style="font-family:'宋体';">容器进行操作</span></strong></p>
  <p>&nbsp; &nbsp; docker exec -it cli bash</p>
  <p>&nbsp; &nbsp; export CHANNEL_NAME=mychannel</p>
  <p>&nbsp; <strong>&nbsp;//<span style="font-family:'宋体';">创建</span><span style="font-family:Calibri;">channel</span></strong></p>
  <p>&nbsp; &nbsp;peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx&nbsp;</p>
  <p>&nbsp; <strong>&nbsp;//peer0.org1.example.com<span style="font-family:'宋体';">加入</span><span style="font-family:Calibri;">channe</span>l</strong></p>
  <p>&nbsp; &nbsp;peer channel join -b mychannel.block</p>
  <p>&nbsp;&nbsp;&nbsp;<strong>//peer0.org2.example.com <span style="font-family:'宋体';">加入</span><span style="font-family:Calibri;">channel</span></strong></p>
  <p>CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID="Org2MSP" &nbsp;peer channel join -b mychannel.block&nbsp;</p>
  <p>&nbsp; /<strong>/anchor peer for Org1 as&nbsp;peer0.org1.example.com</strong></p>
  <p>&nbsp; peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org1MSPanchors.tx </p>
  <p><strong>&nbsp; //peer0.org2.example.com</strong></p>
  <p>CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 CORE_PEER_LOCALMSPID="Org2MSP" peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/Org2MSPanchors.tx&nbsp;</p>
  <p>&nbsp; <strong>&nbsp;//<span style="font-family:'宋体';">安装链码</span></strong></p>
  <p>&nbsp;peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02/</p>
  <p>&nbsp;<strong> &nbsp;//<span style="font-family:'宋体';">初始化链码</span></strong></p>
  <p>peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c '{"Args":["init","a", "100", "b","200"]}'</p>
  <p><strong>&nbsp;//<span style="font-family:'宋体';">进行查询操作</span></strong></p>
  <p>peer chaincode query -C $CHANNEL_NAME -n mycc -c '{"Args":["query","a"]}'</p>
  <p><strong>&nbsp;//<span style="font-family:'宋体';">进行交易</span></strong></p>
  <p>peer chaincode invoke -o orderer.example.com:7050 &nbsp;-C $CHANNEL_NAME -n mycc &nbsp;&nbsp;-c '{"Args":["invoke","a","b","10"]}'&nbsp;</p>
  <p><strong>如果执行正常，说明证书生成以及替换是正确的。</strong></p>
  <p><strong>&nbsp;</strong></p>
  <p><strong><span style="font-size:18px;">六：参考文档：</span></strong></p>
  <p><u><span style="color:rgb(0,0,255);">&nbsp; &nbsp;&nbsp;<a href="https://www.cnblogs.com/studyzy/p/7482451.html" rel="nofollow">https://www.cnblogs.com/studyzy/p/7482451.html</a></span></u></p>
  <p><u><span style="color:rgb(0,0,255);">&nbsp; &nbsp;&nbsp;<a href="http://hyperledger-fabric-ca.readthedocs.io/en/latest/" rel="nofollow">http://hyperledger-fabric-ca.readthedocs.io/en/latest/</a></span></u></p>
  <p><u><span style="color:rgb(0,0,255);">&nbsp; &nbsp;&nbsp;<a href="https://blog.csdn.net/lijiaocn/article/details/80261529" rel="nofollow">https://blog.csdn.net/lijiaocn/article/details/80261529</a></span></u></p>
  <p>&nbsp;</p>
  <p>&nbsp;</p>
  <p><strong><span style="font-size:18px;">七：遇到的问题</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; 1：melly@melly-virtual-machine:/opt/gopath/bin$ sudo ./fabric-ca-client affiliation list</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">[sudo] melly 的密码： </span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">Error: Failed to parse response: 404 page not found</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">: invalid character 'p' after top-level value</span></strong></p>
  <p><span style="color:rgb(0,0,0);background:rgb(245,250,254);"><span style="font-family:'宋体';">&nbsp; &nbsp;查看</span></span><span style="color:rgb(51,51,51);background:rgb(255,255,255);">fabric-ca默认注册了几个联盟</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; &nbsp;查看失败，但是可以去</span>fabric-server的配置文件看即可：（默认如下）</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; &nbsp;或者：修改路径</span></span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;sudo ./fabric-ca-client &nbsp;-H /home/melly/.fabric-ca-client/ &nbsp;affiliation list</p>
  <p>&nbsp; &nbsp; &nbsp; affiliation: .</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;affiliation: org2</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org2.department1</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp;affiliation: org1</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department1</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; affiliation: org1.department2</p>
  <p><br></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; 2： [INFO] 127.0.0.1:47924 POST /register 401 42 "Failed to register attribute: Failed to get attribute 'hf.Registrar.Attributes': User does not have attribute 'hf.Registrar.Attributes'"</span></strong></p>
  <p style="background:rgb(255,255,255);"><span style="color:rgb(51,51,51);"><span style="font-family:'宋体';">解决：</span></span></p>
  <p style="background:rgb(255,255,255);"><span style="color:rgb(51,51,51);"><span style="font-family:'宋体';">&nbsp; &nbsp; 如下示例，使用</span> admin 的身份及其配套证书，登记了一个名称为 "admin2"、类型为 "user"、组织关系为&nbsp; &nbsp;"org1.department1"、"hf.Revoker" 属性为 "true" 的新角色：</span></p>
  <p># export FABRIC_CA_CLIENT_HOME=$HOME/fabric-ca/clients/admin</p>
  <p># fabric-ca-client register --id.name admin2 --id.type user --id.affiliation org1.department1 --id.attr hf.Revoker=true</p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);">&nbsp;</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; 3：peer create channel</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">grpc: addrConn.resetTransport failed to create client transport: connection error: desc = "transport: failed to write window update: write tcp 172.20.0.7:57304-&gt;172.20.0.3:7050: write: broken pipe"; Reconnecting to {orderer.example.com:7050 &lt;nil&gt;}</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">Error: Error connecting due to &nbsp;rpc error: code = Unavailable desc = grpc: the connection is unavailable</span></strong></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp; &nbsp;</span></strong><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);">grpc：Server.Serve未能完成来自“172.20.0.7:48830”的安全握手：tls：第一条记录看起来不像TLS握手</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 解决：去</span>docker-compse-cli.yaml文件中关闭tls</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;</span></p>
  <p><strong><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; &nbsp;4：</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);">HYPERLEDGER FABRIC网络搭建之network e2ecli_default not found</span></strong><span style="background-color:rgb(255,255,255);color:rgb(51,51,51);">&nbsp;</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 原因是：</span></span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><br></span><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp; e2e_cli目录是固定的，启动后会创建一个docker network以此为名字，这里是e2e_cli。如果修改该目录，要修&nbsp; &nbsp; &nbsp;改/opt/gopath/src/github.com/hyperledger/fabric/examples/e2e_cli/base目录下的peer-base.yaml</span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><br></span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">将网络名</span></span><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">修改一下：</span></span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp;我的目录是</span>e2e_cli2</span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);">&nbsp;- CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli2_default</span></p>
  <p><span style="color:rgb(102,102,102);background:rgb(210,216,222);">&nbsp;</span></p>
  <p align="justify" style="background:rgb(255,255,255);"><strong><span style="color:rgb(51,51,51);">&nbsp; 5</span><span style="color:rgb(51,51,51);"><span style="font-family:'宋体';">：</span>Error: Response from server: Error Code: 20 - Authorization failure</span></strong></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 授权失败：</span></span></p>
  <p><span style="color:rgb(51,51,51);background:rgb(255,255,255);"><span style="font-family:'宋体';">&nbsp; 需要重新：授权一下：</span></span></p>
  <p>&nbsp; &nbsp; export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin</p>
  <p>&nbsp; &nbsp; sudo ./fabric-ca-client enroll -u <a href="http://localhost:7054" rel="nofollow">http://admin:pass@localhost:7054</a></p>
  <p><strong>&nbsp;</strong></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/mellymengyan/article/details/80765472,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/mellymengyan/article/details/80765472,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
