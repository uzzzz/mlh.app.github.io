<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Fabric CA的基础知识 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Fabric CA的基础知识" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="一:简介 &nbsp;在e2e_cli的例子中，所有用到的证书和私钥都是由cryptogen这个工具根据crypto-config.yaml而生成的。但是在实际的生产环境中，我们需要给每个org都建立自己的CA，用来管理本org的用户。所以需要部署ca server和client去进行操作。本文就是进行fabric CA的知识点整理。Fabric CA的整体结构如下所示： &nbsp; 从图中可以知道：和ca server进行交互可以通过两种途径，fabric-CA-client和SDK。所有和fabric CA server进行交互都是通过调用REST APIs进行操作的。 Hyperledger Fabric CA客户端或SDK可能连接到Hyperledger Fabric CA服务器集群时。 这在图的右上部分中说明。 客户端路由到HA代理端点，该端点将流量负载平衡到fabric-ca-server集群成员之一。 集群中的所有Hyperledger Fabric CA服务器都共享相同的数据库以跟踪身份和证书。 如果配置了LDAP，则身份信息将保存在LDAP中而不是数据库中。 一台服务器可能包含多个CA。 每个CA都是根CA或中间CA. 每个中间CA都有一个父CA，它是根CA或另一个中间CA. 二：使用(命令) (1)&nbsp;准备 &nbsp;&nbsp;&nbsp;需要下载fabric ca server和fabric ca client的可执行文件，然后将其放到/opt/gopath/bin的路径下面。 &nbsp;&nbsp;&nbsp;可以通过两种方式： &nbsp;&nbsp;&nbsp;1：自己编译： &nbsp;&nbsp;&nbsp;&nbsp;$ go get -u github.com/hyperledger/fabric-ca &nbsp; &nbsp;$ cd $GOPATH/src/github.com/hyperledger/fabric-ca &nbsp; &nbsp;$ make fabric-ca-server &nbsp; &nbsp;$ make fabric-ca-client &nbsp; &nbsp;$ ls bin/fabric-ca-client &nbsp;fabric-ca-server &nbsp;&nbsp;&nbsp;2：直接下载 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;get&nbsp;-u&nbsp;github.com/hyperledger/fabric-ca/cmd/ (2)&nbsp;启动server &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fabric-ca-server start -b admin:adminpw &nbsp; &nbsp; &nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前没有被初始化，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成ca-cert.pem和ca-key.pem文件，并且如果该文件不存在，还会创建一个默认配置文件。 &nbsp; &nbsp;启动Fabric CA服务器至少需要一个引导程序标识; 这个身份是服务器管理员（admin:adminpw）。如果没有指定--ca.certfile和--ca.keyfile 参数，那么生成的证书和私钥是自签的。 &nbsp; &nbsp;除非Fabric CA服务器配置为使用LDAP，否则必须至少配置一个预先注册的引导身份identity，以便您注册和注册其他身份identity。&nbsp;-b选项指定引导身份的名称和密码。&nbsp; 如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。 &nbsp; &nbsp; 1：配置文件 &nbsp; &nbsp; &nbsp;如果需要CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。 &nbsp; &nbsp; 2：命令行 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。 &nbsp; &nbsp; &nbsp;3：镜像 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;docker-compose.yaml文件中的&nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39;命令行修改为&nbsp;fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d (3)&nbsp;启动client然后生成管理员的证书和私钥 &nbsp; 通过调用在7054端口本地运行的Fabric CA服务器来登录其标识为admin且密码为adminpw的标识。也是管理员身份。 &nbsp; &nbsp; &nbsp;export FABRIC_CA_CLIENT_HOME=$HOME/ca &nbsp; &nbsp; &nbsp; fabric-ca-client enroll -u http://admin:adminpw@localhost:7054 &nbsp; 登记命令，会在fabric CA 客户端的msp目录的子目录中存储注册证书（ECert），相应的私钥和CA证书链PEM文件。 &nbsp; &nbsp;（openssl verify -CAfile localhost-7054.pem localhost-7054.pem验证是否是自签名证书：localhost-7054.pem: OK） (4)&nbsp;用管理员身份签其他用户 &nbsp; &nbsp; 我们用该管理员身份去注册一个普通的user用户名为devun，属于org1.department1联盟： &nbsp;fabric-ca-client register --id.name devin --id.type user --id.affiliation org1.department1 --id.attrs &#39;hf.Revoker=true,foo=bar&#39; &nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] User provided config file: /home/studyzy/ca/fabric-ca-client-config.yaml &nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] Configuration file location: /home/studyzy/ca/fabric-ca-client-config.yaml &nbsp; &nbsp; Password: GOuMzkcGgGzq &nbsp; &nbsp;我们拿到这个密码以后就可以再次使用enroll命令，给devin这个用户生成msp的私钥和证书： &nbsp; &nbsp;fabric-ca-client enroll -u http://devin:GOuMzkcGgGzq@localhost:7054 -M $FABRIC_CA_CLIENT_HOME/devinmsp &nbsp;现在新用户devin的私钥和证书就在$HOME/ca/devinmsp目录下，我们可以使用tree命令查看一下： &nbsp; &nbsp;devinmsp/ &nbsp; &nbsp;├── cacerts &nbsp; &nbsp;│ &nbsp;&nbsp;└── localhost-7054.pem &nbsp; &nbsp;├── keystore &nbsp; &nbsp;│ &nbsp;&nbsp;└a044e43ad1fd7cdfd1fd995abaef53895534bd70e8cdfdb665430d12665f2041_sk &nbsp; &nbsp;└── signcerts &nbsp; &nbsp; &nbsp; &nbsp;└── cert.pem &nbsp; 通常，MSP目录的cacerts目录必须包含其他证书颁发机构的证书颁发机构链，表示对等体的所有信任根。 &nbsp; 其中这些属性以hf开头的，是需要进行了解的，表示的是用户是否拥有相关的权限: &nbsp; &nbsp; &nbsp; hf.Registrar.Roles该用户可以增加的新用户类型，用户类型都有：client、orderer、peer、user。 &nbsp; &nbsp; &nbsp; hf.Registrar.DelegateRoles该用户可以设置的新用户的hf.Registrar.Roles属性。 &nbsp; &nbsp; &nbsp; hf.Registrar.Attributes该用户可以为新用户设置的保留属性和自定义属性。 &nbsp; &nbsp; &nbsp; hf.GenCRL该用户是否可以获取CRL列表，已经撤销的证书列表。 &nbsp; &nbsp; &nbsp; hf.Revoker该用户是否能够撤销其它用户。 &nbsp; &nbsp; &nbsp; hf.AffiliationMgr该用户是否可以管理联盟。 &nbsp; &nbsp; &nbsp; hf.IntermediateCA该用户是否可以作为中间CA。 &nbsp; &nbsp; &nbsp; 除了这些以hf.开头的属性外，还可以自定义属性，例如下面的admin=true: (5)&nbsp;查看联盟以及成员 &nbsp; &nbsp; &nbsp; fabric-ca默认注册了几个联盟，可以用affiliation list查看： &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-client affiliation list &nbsp; &nbsp; &nbsp;affiliation: . &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org1 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org1.department1 &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;affiliation: org1.department2 &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;affiliation: org2.department1 &nbsp; &nbsp;添加/删除联盟成员，也是通过这个命令进行： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-client affiliation add another &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client affiliation remove another &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 可以用fabric-ca-client identity list查看有权限查看的用户的详情： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client identity list &nbsp; &nbsp; &nbsp;列出已经签的所有的实体 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;并且进行删除以及修改实体用户。具体参考官方文档。 &nbsp;三：升级 &nbsp; 在升级Fabric CA客户端之前，必须升级Fabric CA服务器。 升级之前，建议备份当前数据库： &nbsp; 要升级Fabric CA服务器的单个实例： &nbsp; 停止fabric-ca-server进程。 &nbsp; &nbsp; &nbsp;确保当前数据库已备份。 &nbsp; 将之前的fabric-ca-server二进制文件替换为升级版本。 &nbsp; 启动fabric-ca-server进程。 &nbsp; 使用以下命令验证fabric-ca-server进程是否可用，其中&lt;host&gt;是启动服务器的主机名： &nbsp; &nbsp; &nbsp;fabric-ca-client getcainfo -u http：// &lt;host&gt;：7054 &nbsp; 要使用MySQL或Postgres数据库升级fabric-ca-server实例的集群，请执行以下步骤。 我们假设您正在使用haproxy为host1和host2上的两个fabric-ca-server群集成员（分别在端口7054上侦听）负载均衡。完成此过程后，您将对升级的fabric-ca-server群集成员进行负载平衡 在host3和host4上分别监听端口7054。具体参考官方文档。&nbsp; 四：参考文档 http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html https://www.cnblogs.com/studyzy/p/7482451.html http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html 阅读更多" />
<meta property="og:description" content="一:简介 &nbsp;在e2e_cli的例子中，所有用到的证书和私钥都是由cryptogen这个工具根据crypto-config.yaml而生成的。但是在实际的生产环境中，我们需要给每个org都建立自己的CA，用来管理本org的用户。所以需要部署ca server和client去进行操作。本文就是进行fabric CA的知识点整理。Fabric CA的整体结构如下所示： &nbsp; 从图中可以知道：和ca server进行交互可以通过两种途径，fabric-CA-client和SDK。所有和fabric CA server进行交互都是通过调用REST APIs进行操作的。 Hyperledger Fabric CA客户端或SDK可能连接到Hyperledger Fabric CA服务器集群时。 这在图的右上部分中说明。 客户端路由到HA代理端点，该端点将流量负载平衡到fabric-ca-server集群成员之一。 集群中的所有Hyperledger Fabric CA服务器都共享相同的数据库以跟踪身份和证书。 如果配置了LDAP，则身份信息将保存在LDAP中而不是数据库中。 一台服务器可能包含多个CA。 每个CA都是根CA或中间CA. 每个中间CA都有一个父CA，它是根CA或另一个中间CA. 二：使用(命令) (1)&nbsp;准备 &nbsp;&nbsp;&nbsp;需要下载fabric ca server和fabric ca client的可执行文件，然后将其放到/opt/gopath/bin的路径下面。 &nbsp;&nbsp;&nbsp;可以通过两种方式： &nbsp;&nbsp;&nbsp;1：自己编译： &nbsp;&nbsp;&nbsp;&nbsp;$ go get -u github.com/hyperledger/fabric-ca &nbsp; &nbsp;$ cd $GOPATH/src/github.com/hyperledger/fabric-ca &nbsp; &nbsp;$ make fabric-ca-server &nbsp; &nbsp;$ make fabric-ca-client &nbsp; &nbsp;$ ls bin/fabric-ca-client &nbsp;fabric-ca-server &nbsp;&nbsp;&nbsp;2：直接下载 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;get&nbsp;-u&nbsp;github.com/hyperledger/fabric-ca/cmd/ (2)&nbsp;启动server &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fabric-ca-server start -b admin:adminpw &nbsp; &nbsp; &nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前没有被初始化，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成ca-cert.pem和ca-key.pem文件，并且如果该文件不存在，还会创建一个默认配置文件。 &nbsp; &nbsp;启动Fabric CA服务器至少需要一个引导程序标识; 这个身份是服务器管理员（admin:adminpw）。如果没有指定--ca.certfile和--ca.keyfile 参数，那么生成的证书和私钥是自签的。 &nbsp; &nbsp;除非Fabric CA服务器配置为使用LDAP，否则必须至少配置一个预先注册的引导身份identity，以便您注册和注册其他身份identity。&nbsp;-b选项指定引导身份的名称和密码。&nbsp; 如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。 &nbsp; &nbsp; 1：配置文件 &nbsp; &nbsp; &nbsp;如果需要CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。 &nbsp; &nbsp; 2：命令行 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。 &nbsp; &nbsp; &nbsp;3：镜像 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;docker-compose.yaml文件中的&nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39;命令行修改为&nbsp;fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d (3)&nbsp;启动client然后生成管理员的证书和私钥 &nbsp; 通过调用在7054端口本地运行的Fabric CA服务器来登录其标识为admin且密码为adminpw的标识。也是管理员身份。 &nbsp; &nbsp; &nbsp;export FABRIC_CA_CLIENT_HOME=$HOME/ca &nbsp; &nbsp; &nbsp; fabric-ca-client enroll -u http://admin:adminpw@localhost:7054 &nbsp; 登记命令，会在fabric CA 客户端的msp目录的子目录中存储注册证书（ECert），相应的私钥和CA证书链PEM文件。 &nbsp; &nbsp;（openssl verify -CAfile localhost-7054.pem localhost-7054.pem验证是否是自签名证书：localhost-7054.pem: OK） (4)&nbsp;用管理员身份签其他用户 &nbsp; &nbsp; 我们用该管理员身份去注册一个普通的user用户名为devun，属于org1.department1联盟： &nbsp;fabric-ca-client register --id.name devin --id.type user --id.affiliation org1.department1 --id.attrs &#39;hf.Revoker=true,foo=bar&#39; &nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] User provided config file: /home/studyzy/ca/fabric-ca-client-config.yaml &nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] Configuration file location: /home/studyzy/ca/fabric-ca-client-config.yaml &nbsp; &nbsp; Password: GOuMzkcGgGzq &nbsp; &nbsp;我们拿到这个密码以后就可以再次使用enroll命令，给devin这个用户生成msp的私钥和证书： &nbsp; &nbsp;fabric-ca-client enroll -u http://devin:GOuMzkcGgGzq@localhost:7054 -M $FABRIC_CA_CLIENT_HOME/devinmsp &nbsp;现在新用户devin的私钥和证书就在$HOME/ca/devinmsp目录下，我们可以使用tree命令查看一下： &nbsp; &nbsp;devinmsp/ &nbsp; &nbsp;├── cacerts &nbsp; &nbsp;│ &nbsp;&nbsp;└── localhost-7054.pem &nbsp; &nbsp;├── keystore &nbsp; &nbsp;│ &nbsp;&nbsp;└a044e43ad1fd7cdfd1fd995abaef53895534bd70e8cdfdb665430d12665f2041_sk &nbsp; &nbsp;└── signcerts &nbsp; &nbsp; &nbsp; &nbsp;└── cert.pem &nbsp; 通常，MSP目录的cacerts目录必须包含其他证书颁发机构的证书颁发机构链，表示对等体的所有信任根。 &nbsp; 其中这些属性以hf开头的，是需要进行了解的，表示的是用户是否拥有相关的权限: &nbsp; &nbsp; &nbsp; hf.Registrar.Roles该用户可以增加的新用户类型，用户类型都有：client、orderer、peer、user。 &nbsp; &nbsp; &nbsp; hf.Registrar.DelegateRoles该用户可以设置的新用户的hf.Registrar.Roles属性。 &nbsp; &nbsp; &nbsp; hf.Registrar.Attributes该用户可以为新用户设置的保留属性和自定义属性。 &nbsp; &nbsp; &nbsp; hf.GenCRL该用户是否可以获取CRL列表，已经撤销的证书列表。 &nbsp; &nbsp; &nbsp; hf.Revoker该用户是否能够撤销其它用户。 &nbsp; &nbsp; &nbsp; hf.AffiliationMgr该用户是否可以管理联盟。 &nbsp; &nbsp; &nbsp; hf.IntermediateCA该用户是否可以作为中间CA。 &nbsp; &nbsp; &nbsp; 除了这些以hf.开头的属性外，还可以自定义属性，例如下面的admin=true: (5)&nbsp;查看联盟以及成员 &nbsp; &nbsp; &nbsp; fabric-ca默认注册了几个联盟，可以用affiliation list查看： &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-client affiliation list &nbsp; &nbsp; &nbsp;affiliation: . &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org1 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org1.department1 &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;affiliation: org1.department2 &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;affiliation: org2.department1 &nbsp; &nbsp;添加/删除联盟成员，也是通过这个命令进行： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-client affiliation add another &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client affiliation remove another &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 可以用fabric-ca-client identity list查看有权限查看的用户的详情： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client identity list &nbsp; &nbsp; &nbsp;列出已经签的所有的实体 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;并且进行删除以及修改实体用户。具体参考官方文档。 &nbsp;三：升级 &nbsp; 在升级Fabric CA客户端之前，必须升级Fabric CA服务器。 升级之前，建议备份当前数据库： &nbsp; 要升级Fabric CA服务器的单个实例： &nbsp; 停止fabric-ca-server进程。 &nbsp; &nbsp; &nbsp;确保当前数据库已备份。 &nbsp; 将之前的fabric-ca-server二进制文件替换为升级版本。 &nbsp; 启动fabric-ca-server进程。 &nbsp; 使用以下命令验证fabric-ca-server进程是否可用，其中&lt;host&gt;是启动服务器的主机名： &nbsp; &nbsp; &nbsp;fabric-ca-client getcainfo -u http：// &lt;host&gt;：7054 &nbsp; 要使用MySQL或Postgres数据库升级fabric-ca-server实例的集群，请执行以下步骤。 我们假设您正在使用haproxy为host1和host2上的两个fabric-ca-server群集成员（分别在端口7054上侦听）负载均衡。完成此过程后，您将对升级的fabric-ca-server群集成员进行负载平衡 在host3和host4上分别监听端口7054。具体参考官方文档。&nbsp; 四：参考文档 http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html https://www.cnblogs.com/studyzy/p/7482451.html http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/06/21/c40badefe56c41cee74a669193c177a8.html" />
<meta property="og:url" content="https://mlh.app/2018/06/21/c40badefe56c41cee74a669193c177a8.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-21T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"一:简介 &nbsp;在e2e_cli的例子中，所有用到的证书和私钥都是由cryptogen这个工具根据crypto-config.yaml而生成的。但是在实际的生产环境中，我们需要给每个org都建立自己的CA，用来管理本org的用户。所以需要部署ca server和client去进行操作。本文就是进行fabric CA的知识点整理。Fabric CA的整体结构如下所示： &nbsp; 从图中可以知道：和ca server进行交互可以通过两种途径，fabric-CA-client和SDK。所有和fabric CA server进行交互都是通过调用REST APIs进行操作的。 Hyperledger Fabric CA客户端或SDK可能连接到Hyperledger Fabric CA服务器集群时。 这在图的右上部分中说明。 客户端路由到HA代理端点，该端点将流量负载平衡到fabric-ca-server集群成员之一。 集群中的所有Hyperledger Fabric CA服务器都共享相同的数据库以跟踪身份和证书。 如果配置了LDAP，则身份信息将保存在LDAP中而不是数据库中。 一台服务器可能包含多个CA。 每个CA都是根CA或中间CA. 每个中间CA都有一个父CA，它是根CA或另一个中间CA. 二：使用(命令) (1)&nbsp;准备 &nbsp;&nbsp;&nbsp;需要下载fabric ca server和fabric ca client的可执行文件，然后将其放到/opt/gopath/bin的路径下面。 &nbsp;&nbsp;&nbsp;可以通过两种方式： &nbsp;&nbsp;&nbsp;1：自己编译： &nbsp;&nbsp;&nbsp;&nbsp;$ go get -u github.com/hyperledger/fabric-ca &nbsp; &nbsp;$ cd $GOPATH/src/github.com/hyperledger/fabric-ca &nbsp; &nbsp;$ make fabric-ca-server &nbsp; &nbsp;$ make fabric-ca-client &nbsp; &nbsp;$ ls bin/fabric-ca-client &nbsp;fabric-ca-server &nbsp;&nbsp;&nbsp;2：直接下载 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;get&nbsp;-u&nbsp;github.com/hyperledger/fabric-ca/cmd/ (2)&nbsp;启动server &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fabric-ca-server start -b admin:adminpw &nbsp; &nbsp; &nbsp;-b选项为引导管理员提供注册ID和密码; 如果LDAP未启用“ldap.enabled”设置，则这是必需的。如果服务器以前没有被初始化，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成ca-cert.pem和ca-key.pem文件，并且如果该文件不存在，还会创建一个默认配置文件。 &nbsp; &nbsp;启动Fabric CA服务器至少需要一个引导程序标识; 这个身份是服务器管理员（admin:adminpw）。如果没有指定--ca.certfile和--ca.keyfile 参数，那么生成的证书和私钥是自签的。 &nbsp; &nbsp;除非Fabric CA服务器配置为使用LDAP，否则必须至少配置一个预先注册的引导身份identity，以便您注册和注册其他身份identity。&nbsp;-b选项指定引导身份的名称和密码。&nbsp; 如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。 &nbsp; &nbsp; 1：配置文件 &nbsp; &nbsp; &nbsp;如果需要CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。 &nbsp; &nbsp; 2：命令行 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。 &nbsp; &nbsp; &nbsp;3：镜像 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;docker-compose.yaml文件中的&nbsp;command: sh&nbsp;-c&nbsp;&#39;fabric-ca-server start -b admin:adminpw&#39;命令行修改为&nbsp;fabric-ca-server&nbsp;start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d (3)&nbsp;启动client然后生成管理员的证书和私钥 &nbsp; 通过调用在7054端口本地运行的Fabric CA服务器来登录其标识为admin且密码为adminpw的标识。也是管理员身份。 &nbsp; &nbsp; &nbsp;export FABRIC_CA_CLIENT_HOME=$HOME/ca &nbsp; &nbsp; &nbsp; fabric-ca-client enroll -u http://admin:adminpw@localhost:7054 &nbsp; 登记命令，会在fabric CA 客户端的msp目录的子目录中存储注册证书（ECert），相应的私钥和CA证书链PEM文件。 &nbsp; &nbsp;（openssl verify -CAfile localhost-7054.pem localhost-7054.pem验证是否是自签名证书：localhost-7054.pem: OK） (4)&nbsp;用管理员身份签其他用户 &nbsp; &nbsp; 我们用该管理员身份去注册一个普通的user用户名为devun，属于org1.department1联盟： &nbsp;fabric-ca-client register --id.name devin --id.type user --id.affiliation org1.department1 --id.attrs &#39;hf.Revoker=true,foo=bar&#39; &nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] User provided config file: /home/studyzy/ca/fabric-ca-client-config.yaml &nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] Configuration file location: /home/studyzy/ca/fabric-ca-client-config.yaml &nbsp; &nbsp; Password: GOuMzkcGgGzq &nbsp; &nbsp;我们拿到这个密码以后就可以再次使用enroll命令，给devin这个用户生成msp的私钥和证书： &nbsp; &nbsp;fabric-ca-client enroll -u http://devin:GOuMzkcGgGzq@localhost:7054 -M $FABRIC_CA_CLIENT_HOME/devinmsp &nbsp;现在新用户devin的私钥和证书就在$HOME/ca/devinmsp目录下，我们可以使用tree命令查看一下： &nbsp; &nbsp;devinmsp/ &nbsp; &nbsp;├── cacerts &nbsp; &nbsp;│ &nbsp;&nbsp;└── localhost-7054.pem &nbsp; &nbsp;├── keystore &nbsp; &nbsp;│ &nbsp;&nbsp;└a044e43ad1fd7cdfd1fd995abaef53895534bd70e8cdfdb665430d12665f2041_sk &nbsp; &nbsp;└── signcerts &nbsp; &nbsp; &nbsp; &nbsp;└── cert.pem &nbsp; 通常，MSP目录的cacerts目录必须包含其他证书颁发机构的证书颁发机构链，表示对等体的所有信任根。 &nbsp; 其中这些属性以hf开头的，是需要进行了解的，表示的是用户是否拥有相关的权限: &nbsp; &nbsp; &nbsp; hf.Registrar.Roles该用户可以增加的新用户类型，用户类型都有：client、orderer、peer、user。 &nbsp; &nbsp; &nbsp; hf.Registrar.DelegateRoles该用户可以设置的新用户的hf.Registrar.Roles属性。 &nbsp; &nbsp; &nbsp; hf.Registrar.Attributes该用户可以为新用户设置的保留属性和自定义属性。 &nbsp; &nbsp; &nbsp; hf.GenCRL该用户是否可以获取CRL列表，已经撤销的证书列表。 &nbsp; &nbsp; &nbsp; hf.Revoker该用户是否能够撤销其它用户。 &nbsp; &nbsp; &nbsp; hf.AffiliationMgr该用户是否可以管理联盟。 &nbsp; &nbsp; &nbsp; hf.IntermediateCA该用户是否可以作为中间CA。 &nbsp; &nbsp; &nbsp; 除了这些以hf.开头的属性外，还可以自定义属性，例如下面的admin=true: (5)&nbsp;查看联盟以及成员 &nbsp; &nbsp; &nbsp; fabric-ca默认注册了几个联盟，可以用affiliation list查看： &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-client affiliation list &nbsp; &nbsp; &nbsp;affiliation: . &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org1 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org1.department1 &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;affiliation: org1.department2 &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;affiliation: org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;affiliation: org2.department1 &nbsp; &nbsp;添加/删除联盟成员，也是通过这个命令进行： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;fabric-ca-client affiliation add another &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client affiliation remove another &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 可以用fabric-ca-client identity list查看有权限查看的用户的详情： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client identity list &nbsp; &nbsp; &nbsp;列出已经签的所有的实体 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;并且进行删除以及修改实体用户。具体参考官方文档。 &nbsp;三：升级 &nbsp; 在升级Fabric CA客户端之前，必须升级Fabric CA服务器。 升级之前，建议备份当前数据库： &nbsp; 要升级Fabric CA服务器的单个实例： &nbsp; 停止fabric-ca-server进程。 &nbsp; &nbsp; &nbsp;确保当前数据库已备份。 &nbsp; 将之前的fabric-ca-server二进制文件替换为升级版本。 &nbsp; 启动fabric-ca-server进程。 &nbsp; 使用以下命令验证fabric-ca-server进程是否可用，其中&lt;host&gt;是启动服务器的主机名： &nbsp; &nbsp; &nbsp;fabric-ca-client getcainfo -u http：// &lt;host&gt;：7054 &nbsp; 要使用MySQL或Postgres数据库升级fabric-ca-server实例的集群，请执行以下步骤。 我们假设您正在使用haproxy为host1和host2上的两个fabric-ca-server群集成员（分别在端口7054上侦听）负载均衡。完成此过程后，您将对升级的fabric-ca-server群集成员进行负载平衡 在host3和host4上分别监听端口7054。具体参考官方文档。&nbsp; 四：参考文档 http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html https://www.cnblogs.com/studyzy/p/7482451.html http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/06/21/c40badefe56c41cee74a669193c177a8.html","headline":"Fabric CA的基础知识","dateModified":"2018-06-21T00:00:00+08:00","datePublished":"2018-06-21T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/06/21/c40badefe56c41cee74a669193c177a8.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>Fabric CA的基础知识</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p><strong><span style="font-size:18px;"><span style="font-family:'宋体';">一</span>:<span style="font-family:'宋体';">简介 </span></span></strong></p>
  <p>&nbsp;<span style="font-family:'宋体';">在</span>e2e_cli<span style="font-family:'宋体';">的例子中，所有用到的证书和私钥都是由</span><strong>cryptogen<span style="font-family:'宋体';">这个工具</span></strong>根据<strong>crypto-config.yaml</strong><span style="font-family:'宋体';">而生成的。但是在实际的生产环境中，我们需要给每个</span>org<span style="font-family:'宋体';">都建立自己的</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">，用来管理本</span><span style="font-family:Calibri;">org</span><span style="font-family:'宋体';">的用户。所以需要部署</span><span style="font-family:Calibri;">ca server</span><span style="font-family:'宋体';">和</span><span style="font-family:Calibri;">client</span><span style="font-family:'宋体';">去进行操作。本文就是进行</span><span style="font-family:Calibri;">fabric CA</span><span style="font-family:'宋体';">的知识点整理。</span><span style="font-family:Calibri;">Fabric CA</span><span style="font-family:'宋体';">的整体结构如下所示：</span></p>
  <p>&nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180621195653585?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L21lbGx5bWVuZ3lhbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p><span style="font-family:'宋体';">从图中可以知道：和</span>ca server<span style="font-family:'宋体';">进行交互可以通过两种途径，</span><span style="font-family:Calibri;">fabric-CA-client</span><span style="font-family:'宋体';">和</span><span style="font-family:Calibri;">SDK</span><span style="font-family:'宋体';">。所有和</span><span style="font-family:Calibri;">fabric CA server</span><span style="font-family:'宋体';">进行交互都是通过调用</span><span style="font-family:Calibri;">REST APIs</span><span style="font-family:'宋体';">进行操作的。</span></p>
  <p>Hyperledger Fabric CA<span style="font-family:'宋体';">客户端或</span><span style="font-family:Calibri;">SDK</span><span style="font-family:'宋体';">可能连接到</span><span style="font-family:Calibri;">Hyperledger Fabric CA</span><span style="font-family:'宋体';">服务器集群时。 这在图的右上部分中说明。 客户端路由到</span><span style="font-family:Calibri;">HA</span><span style="font-family:'宋体';">代理端点，该端点将流量负载平衡到</span><span style="font-family:Calibri;">fabric-ca-server</span><span style="font-family:'宋体';">集群成员之一。</span></p>
  <p><span style="font-family:'宋体';">集群中的所有</span>Hyperledger Fabric CA<span style="font-family:'宋体';">服务器都共享相同的数据库以跟踪身份和证书。 如果配置了</span><span style="font-family:Calibri;">LDAP</span><span style="font-family:'宋体';">，则身份信息将保存在</span><span style="font-family:Calibri;">LDAP</span><span style="font-family:'宋体';">中而不是数据库中。</span></p>
  <p><span style="font-family:'宋体';">一台服务器可能包含多个</span>CA<span style="font-family:'宋体';">。 每个</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">都是根</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">或中间</span><span style="font-family:Calibri;">CA. </span><span style="font-family:'宋体';">每个中间</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">都有一个父</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">，它是根</span><span style="font-family:Calibri;">CA</span><span style="font-family:'宋体';">或另一个中间</span><span style="font-family:Calibri;">CA.</span></p>
  <p><strong><span style="font-size:18px;"><span style="font-family:'宋体';">二：使用</span>(<span style="font-family:'宋体';">命令</span><span style="font-family:Calibri;">)</span></span></strong></p>
  <p>(1)&nbsp;<strong>准备</strong></p>
  <p><strong>&nbsp;&nbsp;&nbsp;</strong><span style="font-family:'宋体';">需要下载</span>fabric ca server<span style="font-family:'宋体';">和</span><span style="font-family:Calibri;">fabric ca client</span><span style="font-family:'宋体';">的可执行文件，然后将其放到</span><span style="font-family:Calibri;">/opt/gopath/bin</span><span style="font-family:'宋体';">的路径下面。</span></p>
  <p>&nbsp;&nbsp;&nbsp;<span style="font-family:'宋体';">可以通过两种方式：</span></p>
  <p>&nbsp;&nbsp;<strong>&nbsp;1<span style="font-family:'宋体';">：自己编译：</span></strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;$ go get -u github.com/hyperledger/fabric-ca</p>
  <p>&nbsp; &nbsp;$ cd $GOPATH/src/github.com/hyperledger/fabric-ca</p>
  <p>&nbsp; &nbsp;$ make fabric-ca-server</p>
  <p>&nbsp; &nbsp;$ make fabric-ca-client</p>
  <p>&nbsp; &nbsp;$ ls bin/fabric-ca-client &nbsp;fabric-ca-server</p>
  <p>&nbsp;&nbsp;<strong>&nbsp;2<span style="font-family:'宋体';">：直接下载</span></strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:rgb(51,51,51);">go</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">get</span><span style="color:rgb(64,64,64);">&nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">u</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">github</span><strong><span style="color:rgb(64,64,64);">.</span></strong><span style="color:rgb(51,51,51);">com</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">hyperledger</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">fabric</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">ca</span><strong><span style="color:rgb(64,64,64);">/</span></strong><span style="color:rgb(51,51,51);">cmd</span><strong><span style="color:rgb(64,64,64);">/</span></strong></p>
  <p>(2)&nbsp;<strong><span style="font-family:'宋体';">启动</span>server</strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fabric-ca-server start -b admin:adminpw</p>
  <p>&nbsp; &nbsp; &nbsp;-b<span style="font-family:'宋体';">选项为引导管理员提供注册</span><span style="font-family:Calibri;">ID</span><span style="font-family:'宋体';">和密码</span><span style="font-family:Calibri;">; </span><span style="font-family:'宋体';">如果</span><span style="font-family:Calibri;">LDAP</span><span style="font-family:'宋体';">未启用“</span><span style="font-family:Calibri;">ldap.enabled</span><span style="font-family:'宋体';">”设置，则这是必需的。如果服务器以前没有被初始化，它将在第一次启动时自行初始化。 在初始化期间，如果服务器尚不存在，服务器将生成</span><span style="font-family:Calibri;">ca-cert.pem</span><span style="font-family:'宋体';">和</span><span style="font-family:Calibri;">ca-key.pem</span><span style="font-family:'宋体';">文件，并且如果该文件不存在，还会创建一个默认配置文件。</span></p>
  <p><span style="font-family:'宋体';">&nbsp; &nbsp;启动</span>Fabric CA<span style="font-family:'宋体';">服务器至少需要一个引导程序标识</span><span style="font-family:Calibri;">; </span><span style="font-family:'宋体';">这个身份是服务器管理员（</span>admin:adminpw）。如果没有指定--ca.certfile和--ca.keyfile 参数，那么生成的证书和私钥是自签的。</p>
  <p><span style="font-family:'宋体';">&nbsp; &nbsp;除非</span>Fabric CA<span style="font-family:'宋体';">服务器配置为使用</span><span style="font-family:Calibri;">LDAP</span><span style="font-family:'宋体';">，否则必须至少配置一个预先注册的</span><span style="font-family:'宋体';">引导身份</span>identity<span style="font-family:'宋体';">，以便您注册和注册其他</span><span style="font-family:'宋体';">身份</span>identity<span style="font-family:'宋体';">。</span>&nbsp;-b<span style="font-family:'宋体';">选项指定引导</span>身份<span style="font-family:'宋体';">的名称和密码。</span>&nbsp;</p>
  <p><strong>如果不想自签，使用自己准备的证书和密钥，可以通过下面三种方式进行指定。</strong></p>
  <p><strong>&nbsp; &nbsp; 1：配置文件</strong></p>
  <p><span style="font-family:'新宋体';">&nbsp; &nbsp; &nbsp;如果需要</span>CSR的自定义值，则可以自定义配置文件，修改ca.certfile和ca.keyfile配置项指定的文件，然后再次运行fabric-ca-server init -b admin：adminpw命令。</p>
  <p><strong>&nbsp; &nbsp; 2：命令行</strong></p>
  <p><span style="color:rgb(51,51,51);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fabric-ca-server</span><span style="color:rgb(51,51,51);">&nbsp;</span><span style="color:rgb(51,51,51);">start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d</span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fabric CA Server启动的时候，带了3个重要的参数：ca.certfile 指定了CA的根证书，ca.keyfile 指定了接下来给新用户签发证书时的私钥。另外就是-b参数，指定了CA Client连接CA Server时使用的用户名密码。其中证书和密钥两个文件都必须是PEM编码的，并且不得加密。更具体地说，CA证书文件的内容必须以----- BEGIN CERTIFICATE -----开头，并且密钥文件的内容必须以----- BEGIN PRIVATE KEY -----开头，而不是-----开始加密私钥-----。</p>
  <p><strong>&nbsp; &nbsp; &nbsp;3：镜像</strong></p>
  <p><strong>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;docker-compose.yaml</strong>文件中的<span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(51,51,51);">command</span><span style="color:rgb(64,64,64);">: </span><span style="color:rgb(51,51,51);">sh</span><span style="color:rgb(64,64,64);">&nbsp;</span><strong><span style="color:rgb(64,64,64);">-</span></strong><span style="color:rgb(51,51,51);">c</span><span style="color:rgb(64,64,64);">&nbsp;</span><span style="color:rgb(221,17,68);">'fabric-ca-server start -b admin:adminpw'</span>命令行修改为<span style="color:rgb(51,51,51);">&nbsp;</span><span style="color:rgb(51,51,51);">fabric-ca-server</span><span style="color:rgb(51,51,51);">&nbsp;</span><span style="color:rgb(51,51,51);">start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/${PRIVATE_KEY} -b admin:adminpw -d</span></p>
  <p><span style="color:rgb(51,51,51);"><br></span></p>
  <p>(3)&nbsp;<strong><span style="font-family:'宋体';">启动</span>client<span style="font-family:'宋体';">然后生成管理员的证书和私钥</span></strong></p>
  <p><span style="font-family:'新宋体';">&nbsp; 通过调用在</span>7054端口本地运行的Fabric CA服务器来登录其标识为admin且密码为adminpw的标识。也是管理员身份。</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp;export FABRIC_CA_CLIENT_HOME=$HOME/ca</span></p>
  <p><span style="color:rgb(51,51,51);">&nbsp; &nbsp; &nbsp; fabric-ca-client enroll -u http://admin:adminpw@localhost:7054</span></p>
  <p><span style="font-family:'新宋体';">&nbsp; 登记命令，会在</span>fabric CA 客户端的msp目录的子目录中存储注册证书（ECert），相应的私钥和CA证书链PEM文件。</p>
  <p><span style="font-family:'新宋体';">&nbsp; &nbsp;（</span>o<span style="color:rgb(51,51,51);">penssl verify -CAfile localhost-7054.pem localhost-7054.pem</span>验证是否是自签名证书：<span style="color:rgb(51,51,51);">localhost-7054.pem: OK</span>）</p>
  <p><strong></strong></p>
  <p>(4)&nbsp;<strong>用管理员身份签其他用户</strong></p>
  <p>&nbsp; &nbsp; 我们用该管理员身份去<strong>注册</strong><span style="font-family:'新宋体';">一个普通的</span>user用户名为devun，属于org1.department1联盟：</p>
  <p><span style="color:rgb(0,0,0);">&nbsp;fabric-ca-client register --</span><span style="color:rgb(0,0,255);">id</span><span style="color:rgb(0,0,0);">.name devin --</span><span style="color:rgb(0,0,255);">id</span><span style="color:rgb(0,0,0);">.type user --</span><span style="color:rgb(0,0,255);">id</span><span style="color:rgb(0,0,0);">.affiliation org1.department1 --</span><span style="color:rgb(0,0,255);">id</span><span style="color:rgb(0,0,0);">.attrs </span><span style="color:rgb(128,0,0);">'hf.Revoker=true,foo=bar'</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] User provided config file: /home/studyzy/ca/fabric-ca-client-config.yaml </span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; 2017/09/05 22:20:41 [INFO] Configuration file location: /home/studyzy/ca/fabric-ca-client-config.yaml </span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; Password: GOuMzkcGgGzq</span></p>
  <p>&nbsp; &nbsp;我们拿到这个密码以后就可以再次<strong><span style="font-family:'新宋体';">使用</span>enroll命令</strong><span style="font-family:'新宋体';">，给</span>devin这个用户生<strong><span style="font-family:'新宋体';">成</span>msp的私钥和证书：</strong></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;fabric-ca-client enroll -u http://devin:GOuMzkcGgGzq@localhost:7054 -M $FABRIC_CA_CLIENT_HOME/devinmsp</span></p>
  <p><span style="font-family:'新宋体';">&nbsp;现在新用户</span>devin的私钥和证书就在$HOME/ca/devinmsp目录下，我们可以使用tree命令查看一下：</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;devinmsp/ </span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;├── <span style="font-family:'Courier New';">cacerts </span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;│ &nbsp;&nbsp;└── <span style="font-family:'Courier New';">localhost-7054.pem </span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;├── <span style="font-family:'Courier New';">keystore </span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;│ &nbsp;&nbsp;└<span style="font-family:'Courier New';">a044e43ad1fd7cdfd1fd995abaef53895534bd70e8cdfdb665430d12665f2041_sk </span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp;└── <span style="font-family:'Courier New';">signcerts </span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; &nbsp;└── <span style="font-family:'Courier New';">cert.pem</span></span></p>
  <p><strong><span style="font-family:'新宋体';">&nbsp; 通常，</span>MSP目录的cacerts目录必须包含其他证书颁发机构的证书颁发机构链，表示对等体的所有信任根。</strong></p>
  <p><span style="font-family:'新宋体';">&nbsp; 其中这些属性以</span>hf开头的，是需要进行了解的，表示的是用户是否拥有相关的权限:</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.Registrar.Roles</span>该用户可以增加的新用户类型，用户类型都有：<span style="color:rgb(0,0,0);">client<span style="font-family:'宋体';">、</span><span style="font-family:'Courier New';">orderer</span><span style="font-family:'宋体';">、</span><span style="font-family:'Courier New';">peer</span><span style="font-family:'宋体';">、</span><span style="font-family:'Courier New';">user</span><span style="font-family:'宋体';">。</span></span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.Registrar.DelegateRoles</span>该用户可以设置的新用户的<span style="color:rgb(0,0,0);">hf.Registrar.Roles</span>属性。</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.Registrar.Attributes</span>该用户可以为新用户设置的保留属性和自定义属性。</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.GenCRL</span><span style="font-family:'新宋体';">该用户是否可以获取</span>CRL列表，已经撤销的证书列表。</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.Revoker</span>该用户是否能够撤销其它用户。</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.AffiliationMgr</span>该用户是否可以管理联盟。</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; hf.IntermediateCA</span><span style="font-family:'新宋体';">该用户是否可以作为中间</span>CA。</p>
  <p>&nbsp; &nbsp; &nbsp; 除了这些以hf.开头的属性外，还可以自定义属性，例如下面的<span style="color:rgb(0,0,0);">admin=true</span>:</p>
  <p>(5)&nbsp;<strong>查看联盟以及成员</strong></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; fabric-ca</span>默认注册了几个联盟，可以用<strong><span style="color:rgb(0,0,0);">affiliation list</span>查看：</strong></p>
  <p>&nbsp; &nbsp; &nbsp;&nbsp;<span style="color:rgb(0,0,0);">fabric-ca-client affiliation list</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp;affiliation: .</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp;affiliation: org1</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; &nbsp;</span><span style="color:rgb(0,0,0);">&nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">affiliation: org1.department1</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp;affiliation: org1.department2</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp;affiliation: org2</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">&nbsp; &nbsp;&nbsp;</span><span style="color:rgb(0,0,0);">affiliation: org2.department1</span></p>
  <p><strong><span style="font-family:'新宋体';">&nbsp; &nbsp;添加</span>/删除联盟成员，</strong>也是通过这个命令进行：</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color:rgb(0,0,0);">fabric-ca-client affiliation add another</span></p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client affiliation remove another</span></p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 可以用<span style="color:rgb(0,0,0);">fabric-ca-client identity lis</span><strong><span style="color:rgb(0,0,0);">t</span>查看有权限查看的用户的详情</strong>：</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fabric-ca-client identity list</span></p>
  <p>&nbsp; &nbsp; &nbsp;列出已经签的所有的实体</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="font-family:'新宋体';">并且进行删除以及修改实体用户。具体参考官方文档。</span></p>
  <p><span style="font-size:18px;">&nbsp;<span style="font-weight:bold;">三：升级</span></span></p>
  <p><span style="font-family:'新宋体';">&nbsp; 在升级</span>Fabric CA客户端之前，必须<strong><span style="font-family:'新宋体';">升级</span>Fabric CA服务器</strong><span style="font-family:'新宋体';">。</span> <span style="font-family:'新宋体';">升级之前，建议备份当前数据库：</span></p>
  <p><span style="font-family:'新宋体';">&nbsp; 要升级</span>Fabric CA服务器的单个实例：</p>
  <p><span style="font-family:'新宋体';">&nbsp; 停止</span>fabric-ca-server进程。</p>
  <p>&nbsp; &nbsp; &nbsp;确保当前数据库已备份。</p>
  <p><span style="font-family:'新宋体';">&nbsp; 将之前的</span>fabric-ca-server二进制文件替换为升级版本。</p>
  <p><span style="font-family:'新宋体';">&nbsp; 启动</span>fabric-ca-server进程。</p>
  <p><span style="font-family:'新宋体';">&nbsp; 使用以下命令验证</span>fabric-ca-server进程是否可用，其中&lt;host&gt;是启动服务器的主机名：</p>
  <p><span style="color:rgb(0,0,0);">&nbsp; &nbsp; &nbsp;fabric-ca-client getcainfo -u http<span style="font-family:'宋体';">：</span><span style="font-family:'Courier New';">// &lt;host&gt;</span><span style="font-family:'宋体';">：</span><span style="font-family:'Courier New';">7054</span></span></p>
  <p><span style="font-family:'新宋体';">&nbsp; 要使用</span>MySQL或Postgres数据库升级fabric-ca-server实例的集群，请执行以下步骤。 我们假设您正在使用haproxy为host1和host2上的两个fabric-ca-server群集成员（分别在端口7054上侦听）负载均衡。完成此过程后，您将对升级的fabric-ca-server群集成员进行负载平衡 在host3和host4上分别监听端口7054。<strong>具体参考官方文档。</strong><span style="font-weight:bold;">&nbsp;</span></p>
  <p><strong><span style="font-size:18px;">四：参考文档</span></strong></p>
  <p><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html" rel="nofollow"><u><span style="color:rgb(0,0,255);">http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html</span></u></a></p>
  <p><a href="https://www.cnblogs.com/studyzy/p/7482451.html" rel="nofollow"><u><span style="color:rgb(0,0,255);">https://www.cnblogs.com/studyzy/p/7482451.html</span></u></a></p>
  <p><a href="http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html" rel="nofollow"><u><span style="color:rgb(0,0,255);">http://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html</span></u></a></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/mellymengyan/article/details/80765385,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/mellymengyan/article/details/80765385,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
