<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>账务实时交易系统设计思考 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="账务实时交易系统设计思考" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="【思考点滴】 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。 &nbsp; &nbsp; 1.概念 账务交易主要是指，在资金流发生的时候，需要根据资金的流入和流出情况，对涉及的账户金额进行增加和减少操作，更新资金的时候，同时需要生成相应的账单，以便后续查询和对账等使用。 提及账务交易，大家并不陌生，古代就开始有账务的概念，小到家庭，大到公司，差别在于记账方式不同而已，家庭一般都只记录流水，而大的公司，账务会有多个掌柜管理，同时根据业务会细分账务类型，完善记账流水，实现资金无缝监控。 &nbsp; 1.1 账务类型和账单 &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; 1.2 资金流、账户、账单概念 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.3 资金流的多种表现形式 1.3.1 资金流多样性 1) 多样性是资金流的一个典型特征， &nbsp; &nbsp; &nbsp; 1.1) 资金有流向， &nbsp; &nbsp; &nbsp; 1.2) 有金额， &nbsp; &nbsp; &nbsp; 1.3) 有流入对象， &nbsp; &nbsp; &nbsp; 1.4) 可以收回资金， &nbsp; &nbsp; &nbsp; 1.5) 资金错误的时候，可以进行调账或者各种形式补偿。 2) 资金链的关联 &nbsp; &nbsp; &nbsp; 2.1) 资金流可以在一个链条上， &nbsp; &nbsp; &nbsp; 2.2) 也可以在不同的链条上， &nbsp; &nbsp; &nbsp; 2.3) 不同链条上的资金流通过账单进行关联 1.3.2 资金流的模型(有向图:线型、树形、网状) 1) 资金流简单模型是线型， 2) 复杂一点是树形， 3) 最复杂的是网状， 用专业术语一句话概括描述，资金流的模型就是一个有向图 1.3.3 账单(只读) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1) 资金流处理的时候，需要生成相应的账单，用来记录每个账户中出、入资金额度，用途描述，以及账户剩余资金的详细信息记录 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2) 账单严格意义来讲，一旦生成，不能修改，如果发生退款或者金额错误，如何进行处理呢？ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.1) &nbsp;发生退款，原账单保留不变，生成一个退款交易账单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.2) 发现金额错误，可以生成一个补偿账单或者调账账单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;总之，账单是只读，不做任何修改，这是账单的特征 &nbsp; &nbsp; 1.4 账务实时交易系统需要做什么? 账务实时交易系统，就是一个万能掌柜，首先能处理各种业务，其次是实时，最重要的是准确、可靠。 如何做到实时和准确，下图有详细信息可供参考。 2.业务分析 &nbsp; &nbsp; 如上图示，简单总结了账务实时交易系统所处的位置， 所有的业务交易都可以虚拟为订单，订单再经过账务实时交易系统的处理，就可以将金额分配到相应的账户。 如下是外卖的账务交易业务模型，现在需要思考如何根据订单的状态，实现金额的更新、分账和账单的生成。 &nbsp; &nbsp; 2.1业务模型汇总 上面讲了这么多，看看需要接入的实际业务业务有哪些？业务特征是什么？业务模型是否符合理论分析(有向图)？ 在线支持业务 订单分类 外卖平台单 &nbsp; &nbsp; &nbsp; &nbsp; 物流订单 物流外单 随意购 自配送 百度快递 骑士打赏 CPC推广费用管理 &nbsp; 虚拟订单 CPT费用管理 用户提现、打款 用户订单 用户订单 … … … … &nbsp; 如下图示是业务模型的一个汇总， 1) 树形， 2) 包含多个账户，业务众多，角色众多 3) 多层、多级分账， 4) 任何一个层级都可以发生取消分账，或者取消部分或者全部分账 5) 单账户的交易类型丰富(如:骑士账户的申诉、奖励、补账、餐损、惩罚 ...) 6) 如果一个账户存在多种交易类型，可以通过业务或者描述信息来区分每个交易。(将图转化为树，或者将子树连接到整棵资金流树上) 总结:虽然账务交易角色众多，交易类型丰富，但是模型还是很典型的树状模型，当前接入的业务是如下图示模型，或者如下图示模型的子树。 &nbsp; &nbsp; &nbsp; &nbsp; 而且新的业务也不局限于如下模型，凡是资金流无论交易层级有多少，都可以被归结为如下模型的处理范围。 &nbsp; 2.2 业务模型分解 2.2.1 业务典型操作归纳 针对业务模型，业务操作很简单的可以归纳为如下几个典型操作： 1)入账、 2)出账、 3) 转账、 4) 分账、 5) 取消 2.2.2 资金流的状态(无状态和有状态) 另外通过资金的依赖，可以分为无状态依赖和有状态依赖两种： 1) 无状态资金处理-没有任何的状态依赖，即罚款， 2) 有状态资金处理-用户的支付金额，需要为业务进行细分再分给相应的商户和骑士等账户， 2.2.3 账户操作: 1) 金额的增加 2) 金额的扣减 &nbsp; 总结，业务和账户操作呈现喇叭型业务模型，或者倒锥形型业务模型 1) 底层操作接口简单 2) 生成数据格式统一 3) 支撑业务多样化 &nbsp; &nbsp; 2.3 账户多样性 2.3.1 账户构建元素满足账户多样性 要接入业务众多，因此账户也变得异常的丰富。 如:青岛众包配送收入账户, 实际来讲，就是青岛市(城市)的众包配送(业务)收入账户(主体:财务) 简单的账户构建元素组合，即可完成丰富的账户信息描述。 2.3.2 账户类型是账务交易方式的体现 至于每个账户，因为金额操作的需求，需要设定不同的账户类型， 1) 现金账户，完成现金业务交易； 2) 冻结账户和淘宝的交易资金冻结功能相同，订单下单，资金入冻结账户，交易完成资金从冻结账户转出到现金账户; 3) 监察账户,提现账户...等就不做详细介绍了。 2.4 账务实时交易系统设计目标 &nbsp; 3. 功能设计 设计的几个原则， 1) 功能、准确、实时是基础， 2) 性能、效率是关键， 3) 健壮和可扩展是平台化所需。 &nbsp; &nbsp; 3.1 接口数据设计 3.2 资金操作 资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。 3.3 数据记录 对内使用：生成交易明细、提供交易记录实时查询 对外输出：为对账、查账、打款等提供数据支持 &nbsp; 3.4 算法选择 3.4.1数据唯一性(四元组) &nbsp; 数据唯一性是数据准确性的保证 数据唯一性是数据关系、数据关联的前提 &nbsp; 账户操作的唯一性实现，如下四元组详述 1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，订单不一定局限在百度外卖，可以是任何平台的订单【如下示例的 order_id】 2）业务描述 &nbsp; &nbsp; &nbsp; 如&quot;百度外卖用户订单&quot;，&quot;百度外卖商户订单&quot;，&quot;百度糯米&quot;, ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】 3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】 4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如&quot;点击消费扣费&quot;，&quot;转账入账&quot;，&quot;转账出账&quot;,&quot;充值入账&quot; 等 【如下示例的 trade_desc】 &nbsp; 订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性 账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分） 保证了资金操作的最小可查询粒度和资金监控的最小粒度 &nbsp; order_no&nbsp; : 业务订单号 &nbsp; order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据 account_id : 账户ID op_code : 操作码，去重；该订单该账户的唯一标识；可配置；可控； 如下图示，就是典型的，同账户通过op_code去重的方式。 &nbsp; 3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存) &nbsp; 绝对父子关系和相对父子关系并存 1) 提升操作效率(有效树在一棵绝对树上) 2) 提供按业务分段存储(查询子树即可) 3) 维护一棵整树(资金流完整统一，资金关系简单化) 4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。 3.4.3 数据唯一性支撑了图到树的转换 资金流是有向图，需要完成图到树的转换处理 &nbsp; &nbsp; 3.4.4 分账模型表述 &nbsp; 3.4.4.1 分账模型 &nbsp; 3.4.4.2 分账配置命令格式（分账模型表述） $postData = array(&nbsp; &nbsp; &#39;trade_commands&#39; =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;第一组分账操作命令 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;商户接单&#39;, // 备注信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;split_formula&#39; =&gt; array(//&nbsp;入账账户信息配置 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;55555666666666&#39; =&gt; array( // 入账账户1的账户ID，以及配置信息&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shopOrder_jljljljlljl&#39;, // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户外卖订单&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 55555666666666, //入账账户1的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户营业输入&#39;, //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;222222233333333&#39; =&gt; array( //&nbsp;入账账户2的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;logistics_5245787854745&#39;, // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖物流冻结账户&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 222222233333333, //入账账户2的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt;&nbsp;&#39;物流接单&#39;, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1000, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;新用户补贴出账&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -1500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;优质用户嘉奖&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -800, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// .... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp;), ); &nbsp; &nbsp; &nbsp; &nbsp; 3.4.5 资金关系存储算法选择： 3.4.5.1 资金关系存储模型 3.4.5.2 资金关系存储示例: array( &nbsp; &nbsp; // 资金交易上游账户唯一信息 &nbsp; &nbsp;&nbsp;&#39;absolute_parent&#39; =&gt; array( &nbsp;&nbsp;// 绝对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; ), &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作 &nbsp; &nbsp;&nbsp;&#39;relative_parent&#39; =&gt; array(), &nbsp; &nbsp;// 相对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;2500 = 2300+200 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;is_split&#39; =&gt; 1, // 0:可以分账 1:已分账 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;child_details&#39; =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;8888888888881111&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;8888888888883333&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; ) ); 基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。 1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一 2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一 优化点：建立绝对上下游关系和相对上游关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点 &nbsp; 3.4.5.3 账单格式 array( // 账单1 &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, // 余额出账账户的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, // 金额操作描述 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;out&#39;, // 资金出账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易出账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单2 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单3 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); &nbsp; &nbsp; &nbsp; 3.4.7 资金流按业务分区块 &nbsp; 1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金 2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向 &nbsp; 3.4.8&nbsp;资金操作接口API 3.4.8.1 完善的API接口 入账、出账、分账、调账和撤销等，实现资金操作接口统一化， &nbsp; 3.4.8.2 规范、丰富的交易类型 交易类型场景化和统一化 交易类型可定制 丰富交易类型，实现按类型归纳、追踪、查询和统计等 &nbsp; 3.4.8.3 资金分配状态机 资金操作API的背后，是规范化了的资金分配关系数据 资金分配关系数据，可以确保资金的准确分配 记录资金分配的完整过程 资金分配状态机的载体 同时通过资金分配关系，可以复盘、回放资金交易的完整过程 &nbsp; 3.4.8.4 资金撤回 1、支持取消任意账户分账（单节点取消分账） 2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账） 3、支持递归取消整个资金流的分账（取消整棵资金分配过程） &nbsp; &nbsp; &nbsp; 3.5 资源管理 支持批量请求:支持单个请求处理，也支持批量请求处理， 统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚 统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。 统一异常处理:错误抛异常，异常格式统一化... &nbsp; &nbsp; &nbsp; 3.6 设计回顾总结 赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。 账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。 上面说了一大堆，如下图示简单总结，小清新一下。 &nbsp; &nbsp; 4 热点问题 &nbsp; 如下是几大热点问题:每个问题的具体处理方案在后面有详述。 4.1 大并发 简要解析：同步和异步并存，是一个综合方案，可以保证账务处理的实时性，如下方案的优、缺点以及引发的问题，在下图有详述。 &nbsp; 4.2 大数据量 &nbsp; 4.3 热点账户 &nbsp; 4.3.1热点账户的概念:&nbsp; &nbsp; &nbsp; &nbsp;热点账户就是在交易过程中，出现频次特别高的账户，交易频次指的是某个时间段的交易频次一直保持在比较高的次数。 &nbsp; &nbsp; &nbsp;如果是数据操作错误重试导致某账户瞬时出现高频操作，则不属于热点账户范畴。 &nbsp; 4.3.2 热点账户的判别标准 &nbsp; &nbsp; 1) 账户每秒有10次以上更新需求 &nbsp; &nbsp; 2) 串行化时账户处理延迟高于1秒以上 &nbsp; 4.3.3 热点账户的处理方案 &nbsp; 热点账户类型 账户属性 实时需求 锁需求 处理方式 性能 业务大账户 内部账户 无实时余额查询 无实时提现 无需加锁 异步 满足 大代理商账户 &nbsp; 对外账户 无实时余额查询 无实时提现 没有加锁需求 异步 满足 热门商户(推广) 对外账户 商户账户 实时余额查询 实时提现 有加锁需求 串行化同步 亟待提升 &nbsp; 4.3.4 热点账户总结 1) 在异步化背景(账户实时处理的上游，如果已经存在了异步化的处理)下，此时业务所需要的下游的实时性是不可能完全实时的 2) 对于热点账户而言，问题在于一条数据表项的更新频次已经达到了上线，所以解决热点账户的方案可以从解决数据读取的瓶颈出发。 &nbsp; 4.5 实时性-high-实时账务更新 &nbsp; &nbsp; &nbsp; &nbsp; 4.5.1 实时账务更新 4.5.2.1 完全实时设计实现 业务直接调用账务系统交易的API接口，实时处理账务交易，所谓的实时交易，也是进行了一定的优化（同步和异步相结合）。 1) 商户账户扣费，使用的是实时扣费 &nbsp; &nbsp; a）账户更新使用redis锁代替数据库锁，同样也是悲观锁，不过请求不阻塞，请求延迟很小 &nbsp; &nbsp; b ) 请求锁失败，业务继续重试请求。 &nbsp; &nbsp; c ) 平台内部账户仍然采用异步余额更新，减少了分账的锁阻塞几率，有效保证了同步更新的成功率，即减少了锁请求失败的概率。 &nbsp; 2) 百度外卖推广收入账户，同样采用的是异步更新账户金额的方式。因为这个账户是平台共用，属于热点账户，锁阻塞很严重，但是该账户的任何行为和表现不会影响到商户账户余额更新，所以这里使用异步更新的方式，消除了热点账户的影响。 4.5.2.2 完全实时场景 CPC（按点击扣费）业务，账户提现等 &nbsp; 4.5.2 上游调用方对用户或者账户进行分桶，防止同一账户被同时更新而造成的冲突 &nbsp; &nbsp; 4.6 实时性-middle-非实时的准实时更新 &nbsp; &nbsp; &nbsp; &nbsp; 4.6.1 准实时的实现 &nbsp; &nbsp; 各业务的资金分账，入消息队列，调用账务交易平台资金操作接口，账务平台按分账需求和分账状态处理账务消息 4.6.2 准实时性能 通过消息队列处理账务交易信息，QPS基本不是瓶颈 通过对业务和订单散列细分，账务交易系统可以有序、快速处理资金， 支持批量请求，从业务层解除数据依赖和状态依赖 最终测试结果：账户余额更新最差延迟时间控制在15秒内。 &nbsp; 4.6.3 准实时业务场景 用户订单，物流订单等账务处理都是非实时需求场景 &nbsp; &nbsp; 5.准确性 &nbsp; &nbsp; 5.1 业务监控 &nbsp; 1、账务交易异常，MQ堵塞 &nbsp; 2、业务订单异常监控 &nbsp; 3、涉及账户人员入账错误会第一时间联系客服(仅限于少入账 J) &nbsp; 4、业务通过订单数据可以修复账务交易错误 &nbsp; 5.2 平台对账 &nbsp; 1、交易维度 : 上条记录余额 = 当前发生额 + 当前余额 &nbsp; 2、按订单维度 : 该订单的所有账户的发生额总支出=发生而总收入 &nbsp; 3、余额快照 : 账户当日的期末余额=期末余额+发生额 &nbsp; 4、余额快照 : 当日所有账户的期期末余额=期末余额+发生额 &nbsp; 5、常规对账 &nbsp; &nbsp; 6. 使用建议 &nbsp; 6.1 业务接入建议 6.2 使用建议 &nbsp; &nbsp; &nbsp; 7 总结思考 &nbsp; 7.1 思考 设计是一个找平衡点的过程， 一条是功能线，(概要如下图) 一条是性能线，(概要如下图) 寻找功能和性能的平衡，如果有任何一点出了问题，就无法支撑业务的需求。 最终的原则，就是在支撑业务需求的前提下，进一步提升性能和可扩展性。 7.2 总结 &nbsp; 7.3 收尾 找好平衡点 抽象、统一、数据化 深入、专一、平台化 &nbsp; 谢谢！ &nbsp; &nbsp; &nbsp; 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 阅读更多" />
<meta property="og:description" content="【思考点滴】 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。 &nbsp; &nbsp; 1.概念 账务交易主要是指，在资金流发生的时候，需要根据资金的流入和流出情况，对涉及的账户金额进行增加和减少操作，更新资金的时候，同时需要生成相应的账单，以便后续查询和对账等使用。 提及账务交易，大家并不陌生，古代就开始有账务的概念，小到家庭，大到公司，差别在于记账方式不同而已，家庭一般都只记录流水，而大的公司，账务会有多个掌柜管理，同时根据业务会细分账务类型，完善记账流水，实现资金无缝监控。 &nbsp; 1.1 账务类型和账单 &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; 1.2 资金流、账户、账单概念 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.3 资金流的多种表现形式 1.3.1 资金流多样性 1) 多样性是资金流的一个典型特征， &nbsp; &nbsp; &nbsp; 1.1) 资金有流向， &nbsp; &nbsp; &nbsp; 1.2) 有金额， &nbsp; &nbsp; &nbsp; 1.3) 有流入对象， &nbsp; &nbsp; &nbsp; 1.4) 可以收回资金， &nbsp; &nbsp; &nbsp; 1.5) 资金错误的时候，可以进行调账或者各种形式补偿。 2) 资金链的关联 &nbsp; &nbsp; &nbsp; 2.1) 资金流可以在一个链条上， &nbsp; &nbsp; &nbsp; 2.2) 也可以在不同的链条上， &nbsp; &nbsp; &nbsp; 2.3) 不同链条上的资金流通过账单进行关联 1.3.2 资金流的模型(有向图:线型、树形、网状) 1) 资金流简单模型是线型， 2) 复杂一点是树形， 3) 最复杂的是网状， 用专业术语一句话概括描述，资金流的模型就是一个有向图 1.3.3 账单(只读) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1) 资金流处理的时候，需要生成相应的账单，用来记录每个账户中出、入资金额度，用途描述，以及账户剩余资金的详细信息记录 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2) 账单严格意义来讲，一旦生成，不能修改，如果发生退款或者金额错误，如何进行处理呢？ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.1) &nbsp;发生退款，原账单保留不变，生成一个退款交易账单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.2) 发现金额错误，可以生成一个补偿账单或者调账账单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;总之，账单是只读，不做任何修改，这是账单的特征 &nbsp; &nbsp; 1.4 账务实时交易系统需要做什么? 账务实时交易系统，就是一个万能掌柜，首先能处理各种业务，其次是实时，最重要的是准确、可靠。 如何做到实时和准确，下图有详细信息可供参考。 2.业务分析 &nbsp; &nbsp; 如上图示，简单总结了账务实时交易系统所处的位置， 所有的业务交易都可以虚拟为订单，订单再经过账务实时交易系统的处理，就可以将金额分配到相应的账户。 如下是外卖的账务交易业务模型，现在需要思考如何根据订单的状态，实现金额的更新、分账和账单的生成。 &nbsp; &nbsp; 2.1业务模型汇总 上面讲了这么多，看看需要接入的实际业务业务有哪些？业务特征是什么？业务模型是否符合理论分析(有向图)？ 在线支持业务 订单分类 外卖平台单 &nbsp; &nbsp; &nbsp; &nbsp; 物流订单 物流外单 随意购 自配送 百度快递 骑士打赏 CPC推广费用管理 &nbsp; 虚拟订单 CPT费用管理 用户提现、打款 用户订单 用户订单 … … … … &nbsp; 如下图示是业务模型的一个汇总， 1) 树形， 2) 包含多个账户，业务众多，角色众多 3) 多层、多级分账， 4) 任何一个层级都可以发生取消分账，或者取消部分或者全部分账 5) 单账户的交易类型丰富(如:骑士账户的申诉、奖励、补账、餐损、惩罚 ...) 6) 如果一个账户存在多种交易类型，可以通过业务或者描述信息来区分每个交易。(将图转化为树，或者将子树连接到整棵资金流树上) 总结:虽然账务交易角色众多，交易类型丰富，但是模型还是很典型的树状模型，当前接入的业务是如下图示模型，或者如下图示模型的子树。 &nbsp; &nbsp; &nbsp; &nbsp; 而且新的业务也不局限于如下模型，凡是资金流无论交易层级有多少，都可以被归结为如下模型的处理范围。 &nbsp; 2.2 业务模型分解 2.2.1 业务典型操作归纳 针对业务模型，业务操作很简单的可以归纳为如下几个典型操作： 1)入账、 2)出账、 3) 转账、 4) 分账、 5) 取消 2.2.2 资金流的状态(无状态和有状态) 另外通过资金的依赖，可以分为无状态依赖和有状态依赖两种： 1) 无状态资金处理-没有任何的状态依赖，即罚款， 2) 有状态资金处理-用户的支付金额，需要为业务进行细分再分给相应的商户和骑士等账户， 2.2.3 账户操作: 1) 金额的增加 2) 金额的扣减 &nbsp; 总结，业务和账户操作呈现喇叭型业务模型，或者倒锥形型业务模型 1) 底层操作接口简单 2) 生成数据格式统一 3) 支撑业务多样化 &nbsp; &nbsp; 2.3 账户多样性 2.3.1 账户构建元素满足账户多样性 要接入业务众多，因此账户也变得异常的丰富。 如:青岛众包配送收入账户, 实际来讲，就是青岛市(城市)的众包配送(业务)收入账户(主体:财务) 简单的账户构建元素组合，即可完成丰富的账户信息描述。 2.3.2 账户类型是账务交易方式的体现 至于每个账户，因为金额操作的需求，需要设定不同的账户类型， 1) 现金账户，完成现金业务交易； 2) 冻结账户和淘宝的交易资金冻结功能相同，订单下单，资金入冻结账户，交易完成资金从冻结账户转出到现金账户; 3) 监察账户,提现账户...等就不做详细介绍了。 2.4 账务实时交易系统设计目标 &nbsp; 3. 功能设计 设计的几个原则， 1) 功能、准确、实时是基础， 2) 性能、效率是关键， 3) 健壮和可扩展是平台化所需。 &nbsp; &nbsp; 3.1 接口数据设计 3.2 资金操作 资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。 3.3 数据记录 对内使用：生成交易明细、提供交易记录实时查询 对外输出：为对账、查账、打款等提供数据支持 &nbsp; 3.4 算法选择 3.4.1数据唯一性(四元组) &nbsp; 数据唯一性是数据准确性的保证 数据唯一性是数据关系、数据关联的前提 &nbsp; 账户操作的唯一性实现，如下四元组详述 1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，订单不一定局限在百度外卖，可以是任何平台的订单【如下示例的 order_id】 2）业务描述 &nbsp; &nbsp; &nbsp; 如&quot;百度外卖用户订单&quot;，&quot;百度外卖商户订单&quot;，&quot;百度糯米&quot;, ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】 3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】 4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如&quot;点击消费扣费&quot;，&quot;转账入账&quot;，&quot;转账出账&quot;,&quot;充值入账&quot; 等 【如下示例的 trade_desc】 &nbsp; 订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性 账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分） 保证了资金操作的最小可查询粒度和资金监控的最小粒度 &nbsp; order_no&nbsp; : 业务订单号 &nbsp; order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据 account_id : 账户ID op_code : 操作码，去重；该订单该账户的唯一标识；可配置；可控； 如下图示，就是典型的，同账户通过op_code去重的方式。 &nbsp; 3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存) &nbsp; 绝对父子关系和相对父子关系并存 1) 提升操作效率(有效树在一棵绝对树上) 2) 提供按业务分段存储(查询子树即可) 3) 维护一棵整树(资金流完整统一，资金关系简单化) 4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。 3.4.3 数据唯一性支撑了图到树的转换 资金流是有向图，需要完成图到树的转换处理 &nbsp; &nbsp; 3.4.4 分账模型表述 &nbsp; 3.4.4.1 分账模型 &nbsp; 3.4.4.2 分账配置命令格式（分账模型表述） $postData = array(&nbsp; &nbsp; &#39;trade_commands&#39; =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;第一组分账操作命令 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;商户接单&#39;, // 备注信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;split_formula&#39; =&gt; array(//&nbsp;入账账户信息配置 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;55555666666666&#39; =&gt; array( // 入账账户1的账户ID，以及配置信息&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shopOrder_jljljljlljl&#39;, // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户外卖订单&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 55555666666666, //入账账户1的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户营业输入&#39;, //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;222222233333333&#39; =&gt; array( //&nbsp;入账账户2的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;logistics_5245787854745&#39;, // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖物流冻结账户&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 222222233333333, //入账账户2的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt;&nbsp;&#39;物流接单&#39;, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1000, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;新用户补贴出账&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -1500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;优质用户嘉奖&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -800, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// .... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp;), ); &nbsp; &nbsp; &nbsp; &nbsp; 3.4.5 资金关系存储算法选择： 3.4.5.1 资金关系存储模型 3.4.5.2 资金关系存储示例: array( &nbsp; &nbsp; // 资金交易上游账户唯一信息 &nbsp; &nbsp;&nbsp;&#39;absolute_parent&#39; =&gt; array( &nbsp;&nbsp;// 绝对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; ), &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作 &nbsp; &nbsp;&nbsp;&#39;relative_parent&#39; =&gt; array(), &nbsp; &nbsp;// 相对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;2500 = 2300+200 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;is_split&#39; =&gt; 1, // 0:可以分账 1:已分账 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;child_details&#39; =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;8888888888881111&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;8888888888883333&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; ) ); 基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。 1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一 2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一 优化点：建立绝对上下游关系和相对上游关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点 &nbsp; 3.4.5.3 账单格式 array( // 账单1 &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, // 余额出账账户的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, // 金额操作描述 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;out&#39;, // 资金出账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易出账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单2 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单3 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); &nbsp; &nbsp; &nbsp; 3.4.7 资金流按业务分区块 &nbsp; 1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金 2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向 &nbsp; 3.4.8&nbsp;资金操作接口API 3.4.8.1 完善的API接口 入账、出账、分账、调账和撤销等，实现资金操作接口统一化， &nbsp; 3.4.8.2 规范、丰富的交易类型 交易类型场景化和统一化 交易类型可定制 丰富交易类型，实现按类型归纳、追踪、查询和统计等 &nbsp; 3.4.8.3 资金分配状态机 资金操作API的背后，是规范化了的资金分配关系数据 资金分配关系数据，可以确保资金的准确分配 记录资金分配的完整过程 资金分配状态机的载体 同时通过资金分配关系，可以复盘、回放资金交易的完整过程 &nbsp; 3.4.8.4 资金撤回 1、支持取消任意账户分账（单节点取消分账） 2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账） 3、支持递归取消整个资金流的分账（取消整棵资金分配过程） &nbsp; &nbsp; &nbsp; 3.5 资源管理 支持批量请求:支持单个请求处理，也支持批量请求处理， 统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚 统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。 统一异常处理:错误抛异常，异常格式统一化... &nbsp; &nbsp; &nbsp; 3.6 设计回顾总结 赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。 账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。 上面说了一大堆，如下图示简单总结，小清新一下。 &nbsp; &nbsp; 4 热点问题 &nbsp; 如下是几大热点问题:每个问题的具体处理方案在后面有详述。 4.1 大并发 简要解析：同步和异步并存，是一个综合方案，可以保证账务处理的实时性，如下方案的优、缺点以及引发的问题，在下图有详述。 &nbsp; 4.2 大数据量 &nbsp; 4.3 热点账户 &nbsp; 4.3.1热点账户的概念:&nbsp; &nbsp; &nbsp; &nbsp;热点账户就是在交易过程中，出现频次特别高的账户，交易频次指的是某个时间段的交易频次一直保持在比较高的次数。 &nbsp; &nbsp; &nbsp;如果是数据操作错误重试导致某账户瞬时出现高频操作，则不属于热点账户范畴。 &nbsp; 4.3.2 热点账户的判别标准 &nbsp; &nbsp; 1) 账户每秒有10次以上更新需求 &nbsp; &nbsp; 2) 串行化时账户处理延迟高于1秒以上 &nbsp; 4.3.3 热点账户的处理方案 &nbsp; 热点账户类型 账户属性 实时需求 锁需求 处理方式 性能 业务大账户 内部账户 无实时余额查询 无实时提现 无需加锁 异步 满足 大代理商账户 &nbsp; 对外账户 无实时余额查询 无实时提现 没有加锁需求 异步 满足 热门商户(推广) 对外账户 商户账户 实时余额查询 实时提现 有加锁需求 串行化同步 亟待提升 &nbsp; 4.3.4 热点账户总结 1) 在异步化背景(账户实时处理的上游，如果已经存在了异步化的处理)下，此时业务所需要的下游的实时性是不可能完全实时的 2) 对于热点账户而言，问题在于一条数据表项的更新频次已经达到了上线，所以解决热点账户的方案可以从解决数据读取的瓶颈出发。 &nbsp; 4.5 实时性-high-实时账务更新 &nbsp; &nbsp; &nbsp; &nbsp; 4.5.1 实时账务更新 4.5.2.1 完全实时设计实现 业务直接调用账务系统交易的API接口，实时处理账务交易，所谓的实时交易，也是进行了一定的优化（同步和异步相结合）。 1) 商户账户扣费，使用的是实时扣费 &nbsp; &nbsp; a）账户更新使用redis锁代替数据库锁，同样也是悲观锁，不过请求不阻塞，请求延迟很小 &nbsp; &nbsp; b ) 请求锁失败，业务继续重试请求。 &nbsp; &nbsp; c ) 平台内部账户仍然采用异步余额更新，减少了分账的锁阻塞几率，有效保证了同步更新的成功率，即减少了锁请求失败的概率。 &nbsp; 2) 百度外卖推广收入账户，同样采用的是异步更新账户金额的方式。因为这个账户是平台共用，属于热点账户，锁阻塞很严重，但是该账户的任何行为和表现不会影响到商户账户余额更新，所以这里使用异步更新的方式，消除了热点账户的影响。 4.5.2.2 完全实时场景 CPC（按点击扣费）业务，账户提现等 &nbsp; 4.5.2 上游调用方对用户或者账户进行分桶，防止同一账户被同时更新而造成的冲突 &nbsp; &nbsp; 4.6 实时性-middle-非实时的准实时更新 &nbsp; &nbsp; &nbsp; &nbsp; 4.6.1 准实时的实现 &nbsp; &nbsp; 各业务的资金分账，入消息队列，调用账务交易平台资金操作接口，账务平台按分账需求和分账状态处理账务消息 4.6.2 准实时性能 通过消息队列处理账务交易信息，QPS基本不是瓶颈 通过对业务和订单散列细分，账务交易系统可以有序、快速处理资金， 支持批量请求，从业务层解除数据依赖和状态依赖 最终测试结果：账户余额更新最差延迟时间控制在15秒内。 &nbsp; 4.6.3 准实时业务场景 用户订单，物流订单等账务处理都是非实时需求场景 &nbsp; &nbsp; 5.准确性 &nbsp; &nbsp; 5.1 业务监控 &nbsp; 1、账务交易异常，MQ堵塞 &nbsp; 2、业务订单异常监控 &nbsp; 3、涉及账户人员入账错误会第一时间联系客服(仅限于少入账 J) &nbsp; 4、业务通过订单数据可以修复账务交易错误 &nbsp; 5.2 平台对账 &nbsp; 1、交易维度 : 上条记录余额 = 当前发生额 + 当前余额 &nbsp; 2、按订单维度 : 该订单的所有账户的发生额总支出=发生而总收入 &nbsp; 3、余额快照 : 账户当日的期末余额=期末余额+发生额 &nbsp; 4、余额快照 : 当日所有账户的期期末余额=期末余额+发生额 &nbsp; 5、常规对账 &nbsp; &nbsp; 6. 使用建议 &nbsp; 6.1 业务接入建议 6.2 使用建议 &nbsp; &nbsp; &nbsp; 7 总结思考 &nbsp; 7.1 思考 设计是一个找平衡点的过程， 一条是功能线，(概要如下图) 一条是性能线，(概要如下图) 寻找功能和性能的平衡，如果有任何一点出了问题，就无法支撑业务的需求。 最终的原则，就是在支撑业务需求的前提下，进一步提升性能和可扩展性。 7.2 总结 &nbsp; 7.3 收尾 找好平衡点 抽象、统一、数据化 深入、专一、平台化 &nbsp; 谢谢！ &nbsp; &nbsp; &nbsp; 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-06-21T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"【思考点滴】 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。 &nbsp; &nbsp; 1.概念 账务交易主要是指，在资金流发生的时候，需要根据资金的流入和流出情况，对涉及的账户金额进行增加和减少操作，更新资金的时候，同时需要生成相应的账单，以便后续查询和对账等使用。 提及账务交易，大家并不陌生，古代就开始有账务的概念，小到家庭，大到公司，差别在于记账方式不同而已，家庭一般都只记录流水，而大的公司，账务会有多个掌柜管理，同时根据业务会细分账务类型，完善记账流水，实现资金无缝监控。 &nbsp; 1.1 账务类型和账单 &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; 1.2 资金流、账户、账单概念 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.3 资金流的多种表现形式 1.3.1 资金流多样性 1) 多样性是资金流的一个典型特征， &nbsp; &nbsp; &nbsp; 1.1) 资金有流向， &nbsp; &nbsp; &nbsp; 1.2) 有金额， &nbsp; &nbsp; &nbsp; 1.3) 有流入对象， &nbsp; &nbsp; &nbsp; 1.4) 可以收回资金， &nbsp; &nbsp; &nbsp; 1.5) 资金错误的时候，可以进行调账或者各种形式补偿。 2) 资金链的关联 &nbsp; &nbsp; &nbsp; 2.1) 资金流可以在一个链条上， &nbsp; &nbsp; &nbsp; 2.2) 也可以在不同的链条上， &nbsp; &nbsp; &nbsp; 2.3) 不同链条上的资金流通过账单进行关联 1.3.2 资金流的模型(有向图:线型、树形、网状) 1) 资金流简单模型是线型， 2) 复杂一点是树形， 3) 最复杂的是网状， 用专业术语一句话概括描述，资金流的模型就是一个有向图 1.3.3 账单(只读) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1) 资金流处理的时候，需要生成相应的账单，用来记录每个账户中出、入资金额度，用途描述，以及账户剩余资金的详细信息记录 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2) 账单严格意义来讲，一旦生成，不能修改，如果发生退款或者金额错误，如何进行处理呢？ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.1) &nbsp;发生退款，原账单保留不变，生成一个退款交易账单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.2) 发现金额错误，可以生成一个补偿账单或者调账账单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;总之，账单是只读，不做任何修改，这是账单的特征 &nbsp; &nbsp; 1.4 账务实时交易系统需要做什么? 账务实时交易系统，就是一个万能掌柜，首先能处理各种业务，其次是实时，最重要的是准确、可靠。 如何做到实时和准确，下图有详细信息可供参考。 2.业务分析 &nbsp; &nbsp; 如上图示，简单总结了账务实时交易系统所处的位置， 所有的业务交易都可以虚拟为订单，订单再经过账务实时交易系统的处理，就可以将金额分配到相应的账户。 如下是外卖的账务交易业务模型，现在需要思考如何根据订单的状态，实现金额的更新、分账和账单的生成。 &nbsp; &nbsp; 2.1业务模型汇总 上面讲了这么多，看看需要接入的实际业务业务有哪些？业务特征是什么？业务模型是否符合理论分析(有向图)？ 在线支持业务 订单分类 外卖平台单 &nbsp; &nbsp; &nbsp; &nbsp; 物流订单 物流外单 随意购 自配送 百度快递 骑士打赏 CPC推广费用管理 &nbsp; 虚拟订单 CPT费用管理 用户提现、打款 用户订单 用户订单 … … … … &nbsp; 如下图示是业务模型的一个汇总， 1) 树形， 2) 包含多个账户，业务众多，角色众多 3) 多层、多级分账， 4) 任何一个层级都可以发生取消分账，或者取消部分或者全部分账 5) 单账户的交易类型丰富(如:骑士账户的申诉、奖励、补账、餐损、惩罚 ...) 6) 如果一个账户存在多种交易类型，可以通过业务或者描述信息来区分每个交易。(将图转化为树，或者将子树连接到整棵资金流树上) 总结:虽然账务交易角色众多，交易类型丰富，但是模型还是很典型的树状模型，当前接入的业务是如下图示模型，或者如下图示模型的子树。 &nbsp; &nbsp; &nbsp; &nbsp; 而且新的业务也不局限于如下模型，凡是资金流无论交易层级有多少，都可以被归结为如下模型的处理范围。 &nbsp; 2.2 业务模型分解 2.2.1 业务典型操作归纳 针对业务模型，业务操作很简单的可以归纳为如下几个典型操作： 1)入账、 2)出账、 3) 转账、 4) 分账、 5) 取消 2.2.2 资金流的状态(无状态和有状态) 另外通过资金的依赖，可以分为无状态依赖和有状态依赖两种： 1) 无状态资金处理-没有任何的状态依赖，即罚款， 2) 有状态资金处理-用户的支付金额，需要为业务进行细分再分给相应的商户和骑士等账户， 2.2.3 账户操作: 1) 金额的增加 2) 金额的扣减 &nbsp; 总结，业务和账户操作呈现喇叭型业务模型，或者倒锥形型业务模型 1) 底层操作接口简单 2) 生成数据格式统一 3) 支撑业务多样化 &nbsp; &nbsp; 2.3 账户多样性 2.3.1 账户构建元素满足账户多样性 要接入业务众多，因此账户也变得异常的丰富。 如:青岛众包配送收入账户, 实际来讲，就是青岛市(城市)的众包配送(业务)收入账户(主体:财务) 简单的账户构建元素组合，即可完成丰富的账户信息描述。 2.3.2 账户类型是账务交易方式的体现 至于每个账户，因为金额操作的需求，需要设定不同的账户类型， 1) 现金账户，完成现金业务交易； 2) 冻结账户和淘宝的交易资金冻结功能相同，订单下单，资金入冻结账户，交易完成资金从冻结账户转出到现金账户; 3) 监察账户,提现账户...等就不做详细介绍了。 2.4 账务实时交易系统设计目标 &nbsp; 3. 功能设计 设计的几个原则， 1) 功能、准确、实时是基础， 2) 性能、效率是关键， 3) 健壮和可扩展是平台化所需。 &nbsp; &nbsp; 3.1 接口数据设计 3.2 资金操作 资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。 3.3 数据记录 对内使用：生成交易明细、提供交易记录实时查询 对外输出：为对账、查账、打款等提供数据支持 &nbsp; 3.4 算法选择 3.4.1数据唯一性(四元组) &nbsp; 数据唯一性是数据准确性的保证 数据唯一性是数据关系、数据关联的前提 &nbsp; 账户操作的唯一性实现，如下四元组详述 1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，订单不一定局限在百度外卖，可以是任何平台的订单【如下示例的 order_id】 2）业务描述 &nbsp; &nbsp; &nbsp; 如&quot;百度外卖用户订单&quot;，&quot;百度外卖商户订单&quot;，&quot;百度糯米&quot;, ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】 3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】 4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如&quot;点击消费扣费&quot;，&quot;转账入账&quot;，&quot;转账出账&quot;,&quot;充值入账&quot; 等 【如下示例的 trade_desc】 &nbsp; 订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性 账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分） 保证了资金操作的最小可查询粒度和资金监控的最小粒度 &nbsp; order_no&nbsp; : 业务订单号 &nbsp; order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据 account_id : 账户ID op_code : 操作码，去重；该订单该账户的唯一标识；可配置；可控； 如下图示，就是典型的，同账户通过op_code去重的方式。 &nbsp; 3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存) &nbsp; 绝对父子关系和相对父子关系并存 1) 提升操作效率(有效树在一棵绝对树上) 2) 提供按业务分段存储(查询子树即可) 3) 维护一棵整树(资金流完整统一，资金关系简单化) 4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。 3.4.3 数据唯一性支撑了图到树的转换 资金流是有向图，需要完成图到树的转换处理 &nbsp; &nbsp; 3.4.4 分账模型表述 &nbsp; 3.4.4.1 分账模型 &nbsp; 3.4.4.2 分账配置命令格式（分账模型表述） $postData = array(&nbsp; &nbsp; &#39;trade_commands&#39; =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;第一组分账操作命令 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;商户接单&#39;, // 备注信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;split_formula&#39; =&gt; array(//&nbsp;入账账户信息配置 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;55555666666666&#39; =&gt; array( // 入账账户1的账户ID，以及配置信息&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shopOrder_jljljljlljl&#39;, // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户外卖订单&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 55555666666666, //入账账户1的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户营业输入&#39;, //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;222222233333333&#39; =&gt; array( //&nbsp;入账账户2的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;logistics_5245787854745&#39;, // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖物流冻结账户&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 222222233333333, //入账账户2的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt;&nbsp;&#39;物流接单&#39;, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1000, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;新用户补贴出账&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -1500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;优质用户嘉奖&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -800, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// .... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp;), ); &nbsp; &nbsp; &nbsp; &nbsp; 3.4.5 资金关系存储算法选择： 3.4.5.1 资金关系存储模型 3.4.5.2 资金关系存储示例: array( &nbsp; &nbsp; // 资金交易上游账户唯一信息 &nbsp; &nbsp;&nbsp;&#39;absolute_parent&#39; =&gt; array( &nbsp;&nbsp;// 绝对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; ), &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作 &nbsp; &nbsp;&nbsp;&#39;relative_parent&#39; =&gt; array(), &nbsp; &nbsp;// 相对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;2500 = 2300+200 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;is_split&#39; =&gt; 1, // 0:可以分账 1:已分账 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;child_details&#39; =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;8888888888881111&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;8888888888883333&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; ) ); 基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。 1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一 2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一 优化点：建立绝对上下游关系和相对上游关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点 &nbsp; 3.4.5.3 账单格式 array( // 账单1 &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, // 余额出账账户的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, // 金额操作描述 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;out&#39;, // 资金出账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易出账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单2 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单3 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); &nbsp; &nbsp; &nbsp; 3.4.7 资金流按业务分区块 &nbsp; 1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金 2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向 &nbsp; 3.4.8&nbsp;资金操作接口API 3.4.8.1 完善的API接口 入账、出账、分账、调账和撤销等，实现资金操作接口统一化， &nbsp; 3.4.8.2 规范、丰富的交易类型 交易类型场景化和统一化 交易类型可定制 丰富交易类型，实现按类型归纳、追踪、查询和统计等 &nbsp; 3.4.8.3 资金分配状态机 资金操作API的背后，是规范化了的资金分配关系数据 资金分配关系数据，可以确保资金的准确分配 记录资金分配的完整过程 资金分配状态机的载体 同时通过资金分配关系，可以复盘、回放资金交易的完整过程 &nbsp; 3.4.8.4 资金撤回 1、支持取消任意账户分账（单节点取消分账） 2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账） 3、支持递归取消整个资金流的分账（取消整棵资金分配过程） &nbsp; &nbsp; &nbsp; 3.5 资源管理 支持批量请求:支持单个请求处理，也支持批量请求处理， 统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚 统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。 统一异常处理:错误抛异常，异常格式统一化... &nbsp; &nbsp; &nbsp; 3.6 设计回顾总结 赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。 账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。 上面说了一大堆，如下图示简单总结，小清新一下。 &nbsp; &nbsp; 4 热点问题 &nbsp; 如下是几大热点问题:每个问题的具体处理方案在后面有详述。 4.1 大并发 简要解析：同步和异步并存，是一个综合方案，可以保证账务处理的实时性，如下方案的优、缺点以及引发的问题，在下图有详述。 &nbsp; 4.2 大数据量 &nbsp; 4.3 热点账户 &nbsp; 4.3.1热点账户的概念:&nbsp; &nbsp; &nbsp; &nbsp;热点账户就是在交易过程中，出现频次特别高的账户，交易频次指的是某个时间段的交易频次一直保持在比较高的次数。 &nbsp; &nbsp; &nbsp;如果是数据操作错误重试导致某账户瞬时出现高频操作，则不属于热点账户范畴。 &nbsp; 4.3.2 热点账户的判别标准 &nbsp; &nbsp; 1) 账户每秒有10次以上更新需求 &nbsp; &nbsp; 2) 串行化时账户处理延迟高于1秒以上 &nbsp; 4.3.3 热点账户的处理方案 &nbsp; 热点账户类型 账户属性 实时需求 锁需求 处理方式 性能 业务大账户 内部账户 无实时余额查询 无实时提现 无需加锁 异步 满足 大代理商账户 &nbsp; 对外账户 无实时余额查询 无实时提现 没有加锁需求 异步 满足 热门商户(推广) 对外账户 商户账户 实时余额查询 实时提现 有加锁需求 串行化同步 亟待提升 &nbsp; 4.3.4 热点账户总结 1) 在异步化背景(账户实时处理的上游，如果已经存在了异步化的处理)下，此时业务所需要的下游的实时性是不可能完全实时的 2) 对于热点账户而言，问题在于一条数据表项的更新频次已经达到了上线，所以解决热点账户的方案可以从解决数据读取的瓶颈出发。 &nbsp; 4.5 实时性-high-实时账务更新 &nbsp; &nbsp; &nbsp; &nbsp; 4.5.1 实时账务更新 4.5.2.1 完全实时设计实现 业务直接调用账务系统交易的API接口，实时处理账务交易，所谓的实时交易，也是进行了一定的优化（同步和异步相结合）。 1) 商户账户扣费，使用的是实时扣费 &nbsp; &nbsp; a）账户更新使用redis锁代替数据库锁，同样也是悲观锁，不过请求不阻塞，请求延迟很小 &nbsp; &nbsp; b ) 请求锁失败，业务继续重试请求。 &nbsp; &nbsp; c ) 平台内部账户仍然采用异步余额更新，减少了分账的锁阻塞几率，有效保证了同步更新的成功率，即减少了锁请求失败的概率。 &nbsp; 2) 百度外卖推广收入账户，同样采用的是异步更新账户金额的方式。因为这个账户是平台共用，属于热点账户，锁阻塞很严重，但是该账户的任何行为和表现不会影响到商户账户余额更新，所以这里使用异步更新的方式，消除了热点账户的影响。 4.5.2.2 完全实时场景 CPC（按点击扣费）业务，账户提现等 &nbsp; 4.5.2 上游调用方对用户或者账户进行分桶，防止同一账户被同时更新而造成的冲突 &nbsp; &nbsp; 4.6 实时性-middle-非实时的准实时更新 &nbsp; &nbsp; &nbsp; &nbsp; 4.6.1 准实时的实现 &nbsp; &nbsp; 各业务的资金分账，入消息队列，调用账务交易平台资金操作接口，账务平台按分账需求和分账状态处理账务消息 4.6.2 准实时性能 通过消息队列处理账务交易信息，QPS基本不是瓶颈 通过对业务和订单散列细分，账务交易系统可以有序、快速处理资金， 支持批量请求，从业务层解除数据依赖和状态依赖 最终测试结果：账户余额更新最差延迟时间控制在15秒内。 &nbsp; 4.6.3 准实时业务场景 用户订单，物流订单等账务处理都是非实时需求场景 &nbsp; &nbsp; 5.准确性 &nbsp; &nbsp; 5.1 业务监控 &nbsp; 1、账务交易异常，MQ堵塞 &nbsp; 2、业务订单异常监控 &nbsp; 3、涉及账户人员入账错误会第一时间联系客服(仅限于少入账 J) &nbsp; 4、业务通过订单数据可以修复账务交易错误 &nbsp; 5.2 平台对账 &nbsp; 1、交易维度 : 上条记录余额 = 当前发生额 + 当前余额 &nbsp; 2、按订单维度 : 该订单的所有账户的发生额总支出=发生而总收入 &nbsp; 3、余额快照 : 账户当日的期末余额=期末余额+发生额 &nbsp; 4、余额快照 : 当日所有账户的期期末余额=期末余额+发生额 &nbsp; 5、常规对账 &nbsp; &nbsp; 6. 使用建议 &nbsp; 6.1 业务接入建议 6.2 使用建议 &nbsp; &nbsp; &nbsp; 7 总结思考 &nbsp; 7.1 思考 设计是一个找平衡点的过程， 一条是功能线，(概要如下图) 一条是性能线，(概要如下图) 寻找功能和性能的平衡，如果有任何一点出了问题，就无法支撑业务的需求。 最终的原则，就是在支撑业务需求的前提下，进一步提升性能和可扩展性。 7.2 总结 &nbsp; 7.3 收尾 找好平衡点 抽象、统一、数据化 深入、专一、平台化 &nbsp; 谢谢！ &nbsp; &nbsp; &nbsp; 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 阅读更多","@type":"BlogPosting","url":"/2018/06/21/5cca82b3d288031ebccfc3d2d7c2f740.html","headline":"账务实时交易系统设计思考","dateModified":"2018-06-21T00:00:00+08:00","datePublished":"2018-06-21T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/06/21/5cca82b3d288031ebccfc3d2d7c2f740.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>账务实时交易系统设计思考</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e4c7a3727d.css"> 
 <div class="htmledit_views"> 
  <h1>【思考点滴】</h1> 
  <p><strong>作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16</strong></p> 
  <p><strong>本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。</strong></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h1>1.概念</h1> 
  <p><img alt="" class="has" height="264" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810182807453?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="358"></p> 
  <p><img alt="" class="confluence-embedded-image" height="250" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A7%3A36.png?version=1&amp;modificationDate=1495192084000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>账务交易主要是指，在资金流发生的时候，需要根据资金的流入和流出情况，对涉及的账户金额进行增加和减少操作，更新资金的时候，同时需要生成相应的账单，以便后续查询和对账等使用。</p> 
  <p>提及账务交易，大家并不陌生，古代就开始有账务的概念，小到家庭，大到公司，差别在于记账方式不同而已，家庭一般都只记录流水，而大的公司，账务会有多个掌柜管理，同时根据业务会细分账务类型，完善记账流水，实现资金无缝监控。</p> 
  <p>&nbsp;</p> 
  <h2>1.1 账务类型和账单</h2> 
  <p><img alt="" class="confluence-embedded-image" height="250" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A14%3A16.png?version=1&amp;modificationDate=1495192484000&amp;api=v2" style="margin-left:2px;">&nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A14%3A33.png?version=1&amp;modificationDate=1495192500000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="261" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094119721?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="606"></p> 
  <p>&nbsp; &nbsp;<img alt="" class="has" height="245" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094136267?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="806"></p> 
  <p>&nbsp;</p> 
  <h2>1.2 资金流、账户、账单概念</h2> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A15%3A36.png?version=1&amp;modificationDate=1495192563000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>&nbsp; &nbsp; &nbsp;<img alt="" class="has" height="647" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810183530809?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="937"></p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A16%3A12.png?version=1&amp;modificationDate=1495192599000&amp;api=v2" style="margin-left:2px;" width="563"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>1.3 资金流的多种表现形式</h2> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A16%3A42.png?version=1&amp;modificationDate=1495192630000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <h3><img alt="" class="has" height="427" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810183715868?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="820"></h3> 
  <h3>1.3.1 资金流多样性</h3> 
  <ol>
   <li> <p>1) 多样性是资金流的一个典型特征，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 1.1) 资金有流向，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 1.2) 有金额，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 1.3) 有流入对象，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 1.4) 可以收回资金，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 1.5) 资金错误的时候，可以进行调账或者各种形式补偿。</p> </li> 
   <li> <p>2) 资金链的关联</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 2.1) 资金流可以在一个链条上，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 2.2) 也可以在不同的链条上，</p> </li> 
   <li> <p>&nbsp; &nbsp; &nbsp; 2.3) 不同链条上的资金流通过账单进行关联</p> </li> 
  </ol>
  <h3>1.3.2 资金流的模型(有向图:线型、树形、网状)</h3> 
  <ol>
   <li> <p>1) 资金流简单模型是线型，</p> </li> 
   <li> <p>2) 复杂一点是树形，</p> </li> 
   <li> <p>3) 最复杂的是网状，</p> </li> 
   <li> <p>用专业术语一句话概括描述，资金流的模型就是一个有向图</p> </li> 
  </ol>
  <h3>1.3.3 账单(只读)</h3> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1) 资金流处理的时候，需要生成相应的账单，用来记录每个账户中出、入资金额度，用途描述，以及账户剩余资金的详细信息记录</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2) 账单严格意义来讲，一旦生成，不能修改，如果发生退款或者金额错误，如何进行处理呢？</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.1) &nbsp;发生退款，原账单保留不变，生成一个退款交易账单</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2.2) 发现金额错误，可以生成一个补偿账单或者调账账单</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;总之，账单是只读，不做任何修改，这是账单的特征</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <ul>
   <li> <h2>1.4 账务实时交易系统需要做什么?</h2> </li> 
  </ul>
  <p>账务实时交易系统，就是一个万能掌柜，首先能处理各种业务，其次是实时，最重要的是准确、可靠。</p> 
  <p>如何做到实时和准确，下图有详细信息可供参考。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A17%3A32.png?version=1&amp;modificationDate=1495192679000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="521" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018374614?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="843"></p> 
  <h1>2.业务分析</h1> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" height="158" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810183808176?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="652"></p> 
  <p>如上图示，简单总结了账务实时交易系统所处的位置，</p> 
  <p>所有的业务交易都可以虚拟为订单，订单再经过账务实时交易系统的处理，就可以将金额分配到相应的账户。</p> 
  <p>如下是外卖的账务交易业务模型，现在需要思考如何根据订单的状态，实现金额的更新、分账和账单的生成。</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" height="447" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094217759?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="919"></p> 
  <p>&nbsp;</p> 
  <h2>2.1业务模型汇总</h2> 
  <p>上面讲了这么多，看看需要接入的实际业务业务有哪些？业务特征是什么？业务模型是否符合理论分析(有向图)？</p> 
  <table>
   <tbody>
    <tr>
     <td style="vertical-align:top;"> <p>在线支持业务</p> </td> 
     <td style="vertical-align:top;"> <p>订单分类</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>外卖平台单</p> </td> 
     <td rowspan="6" style="vertical-align:top;"> <p>&nbsp;</p> <p>&nbsp;</p> <p>&nbsp;</p> <p>&nbsp;</p> <p>物流订单</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>物流外单</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>随意购</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>自配送</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>百度快递</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>骑士打赏</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>CPC推广费用管理</p> </td> 
     <td rowspan="3" style="vertical-align:top;"> <p>&nbsp;</p> <p>虚拟订单</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>CPT费用管理</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>用户提现、打款</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>用户订单</p> </td> 
     <td style="vertical-align:top;"> <p>用户订单</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>… …</p> </td> 
     <td style="vertical-align:top;"> <p>… …</p> </td> 
    </tr>
   </tbody>
  </table>
  <p>&nbsp;</p> 
  <p>如下图示是业务模型的一个汇总，</p> 
  <p>1) 树形，</p> 
  <p>2) 包含多个账户，业务众多，角色众多</p> 
  <p>3) 多层、多级分账，</p> 
  <p>4) 任何一个层级都可以发生取消分账，或者取消部分或者全部分账</p> 
  <p>5) 单账户的交易类型丰富(如:骑士账户的申诉、奖励、补账、餐损、惩罚 ...)</p> 
  <p>6) 如果一个账户存在多种交易类型，可以通过业务或者描述信息来区分每个交易。(将图转化为树，或者将子树连接到整棵资金流树上)</p> 
  <p>总结:虽然账务交易角色众多，交易类型丰富，但是模型还是很典型的树状模型，当前接入的业务是如下图示模型，或者如下图示模型的子树。</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; 而且新的业务也不局限于如下模型，凡是资金流无论交易层级有多少，都可以被归结为如下模型的处理范围。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A43%3A38.png?version=1&amp;modificationDate=1495194245000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="699" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810183934862?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="579"></p> 
  <p>&nbsp;</p> 
  <h2>2.2 业务模型分解</h2> 
  <h3>2.2.1 业务典型操作归纳</h3> 
  <p>针对业务模型，业务操作很简单的可以归纳为如下几个典型操作：</p> 
  <p>1)入账、</p> 
  <p>2)出账、</p> 
  <p>3) 转账、</p> 
  <p>4) 分账、</p> 
  <p>5) 取消</p> 
  <h3>2.2.2 资金流的状态(无状态和有状态)</h3> 
  <p>另外通过资金的依赖，可以分为无状态依赖和有状态依赖两种：</p> 
  <p>1) 无状态资金处理-没有任何的状态依赖，即罚款，</p> 
  <p>2) 有状态资金处理-用户的支付金额，需要为业务进行细分再分给相应的商户和骑士等账户，</p> 
  <h3>2.2.3 账户操作:</h3> 
  <p>1) 金额的增加</p> 
  <p>2) 金额的扣减</p> 
  <p>&nbsp;</p> 
  <p>总结，业务和账户操作呈现喇叭型业务模型，或者倒锥形型业务模型</p> 
  <p>1) 底层操作接口简单</p> 
  <p>2) 生成数据格式统一</p> 
  <p>3) 支撑业务多样化</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A44%3A26.png?version=1&amp;modificationDate=1495194293000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="538" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018402827?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="818"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>2.3 账户多样性</h2> 
  <h3>2.3.1 账户构建元素满足账户多样性</h3> 
  <p>要接入业务众多，因此账户也变得异常的丰富。</p> 
  <p>如:青岛众包配送收入账户, 实际来讲，就是青岛市(城市)的众包配送(业务)收入账户(主体:财务)</p> 
  <p>简单的账户构建元素组合，即可完成丰富的账户信息描述。</p> 
  <h3>2.3.2 账户类型是账务交易方式的体现</h3> 
  <p>至于每个账户，因为金额操作的需求，需要设定不同的账户类型，</p> 
  <p>1) 现金账户，完成现金业务交易；</p> 
  <p>2) 冻结账户和淘宝的交易资金冻结功能相同，订单下单，资金入冻结账户，交易完成资金从冻结账户转出到现金账户;</p> 
  <p>3) 监察账户,提现账户...等就不做详细介绍了。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A44%3A41.png?version=1&amp;modificationDate=1495194309000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="512" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018405434?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="806"></p> 
  <h2>2.4 账务实时交易系统设计目标</h2> 
  <p><img alt="" class="has" height="426" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184132921?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="813"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A45%3A35.png?version=1&amp;modificationDate=1495194363000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p>&nbsp;</p> 
  <h1>3. 功能设计</h1> 
  <p><img alt="" class="has" height="376" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184151325?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="435"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A46%3A6.png?version=1&amp;modificationDate=1495194393000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>设计的几个原则，</p> 
  <p>1) 功能、准确、实时是基础，</p> 
  <p>2) 性能、效率是关键，</p> 
  <p>3) 健壮和可扩展是平台化所需。</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>3.1 接口数据设计</h2> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A46%3A30.png?version=1&amp;modificationDate=1495194417000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="363" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184216854?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="771"></p> 
  <h2>3.2 资金操作</h2> 
  <p>资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。</p> 
  <h2>3.3 数据记录</h2> 
  <p>对内使用：生成交易明细、提供交易记录实时查询</p> 
  <p>对外输出：为对账、查账、打款等提供数据支持</p> 
  <p>&nbsp;</p> 
  <h2>3.4 算法选择</h2> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A46%3A50.png?version=1&amp;modificationDate=1495194438000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="409" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184237566?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="693"></p> 
  <h3>3.4.1数据唯一性(四元组)</h3> 
  <p><img alt="" class="has" height="488" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018425540?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="381"></p> 
  <p>&nbsp;</p> 
  <p>数据唯一性是数据<strong><span style="color:#0000ff;">准确性</span></strong>的保证</p> 
  <p>数据唯一性是数据关系、<strong><span style="color:#0000ff;">数据关联</span></strong>的前提</p> 
  <p>&nbsp;</p> 
  <p>账户操作的唯一性实现，如下四元组详述</p> 
  <p>1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，<strong><span style="color:#0000ff;">订单不一定局限在百度外卖</span></strong>，可以是任何平台的订单【如下示例的 order_id】</p> 
  <p>2）业务描述 &nbsp; &nbsp; &nbsp; 如"百度外卖<strong><span style="color:#0000ff;">用户订单</span></strong>"，"百度外卖<strong><span style="color:#0000ff;">商户订单</span></strong>"，"<strong><span style="color:#0000ff;">百度</span><span style="color:#0000ff;">糯米</span></strong>", ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】</p> 
  <p>3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】</p> 
  <p>4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如"点击消费扣费"，"转账入账"，"转账出账","充值入账" 等 【如下示例的 trade_desc】</p> 
  <p>&nbsp;</p> 
  <p>订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性</p> 
  <p>账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分）</p> 
  <p>保证了资金操作的最小可查询粒度和资金监控的最小粒度</p> 
  <p>&nbsp;</p> 
  <p>order_no&nbsp; : 业务订单号</p> 
  <p>&nbsp;</p> 
  <p>order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据</p> 
  <p>account_id : 账户ID</p> 
  <p><span style="color:#333333;">op_code : 操作码，去重；该订单该账户的</span><strong><em><span style="color:#ff0000;">唯一标识</span></em></strong><span style="color:#333333;">；可配置；可控；</span></p> 
  <p>如下图示，就是典型的，同账户通过op_code去重的方式。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-22%2011%3A12%3A13.png?version=1&amp;modificationDate=1495422768000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>&nbsp;</p> 
  <h3>3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存)</h3> 
  <p>&nbsp;</p> 
  <p>绝对父子关系和相对父子关系并存</p> 
  <p>1) 提升操作效率(有效树在一棵绝对树上)</p> 
  <p>2) 提供按业务分段存储(查询子树即可)</p> 
  <p>3) 维护一棵整树(资金流完整统一，资金关系简单化)</p> 
  <p>4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-22%2011%3A12%3A22.png?version=1&amp;modificationDate=1495422777000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="247" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184318372?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="365"></p> 
  <h3>3.4.3 数据唯一性支撑了图到树的转换</h3> 
  <p>资金流是有向图，需要完成图到树的转换处理</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h3>3.4.4 分账模型表述</h3> 
  <p>&nbsp;</p> 
  <p>3.4.4.1 分账模型</p> 
  <p><img alt="" class="has" height="302" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094327946?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="538"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-14%2021%3A23%3A59.png?version=1&amp;modificationDate=1502717045000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>&nbsp;</p> 
  <p>3.4.4.2 分账配置命令格式（分账模型表述）</p> 
  <p>$postData = array(<br><span style="color:#0000ff;"><strong>&nbsp; &nbsp; 'trade_commands' =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置</strong></span><br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;<strong><span style="color:#0000ff;">第一组分账操作命令</span></strong><br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'trade_method' =&gt; 'splitAccount', // 金额操作方法-分账<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong><em><span style="color:#0000ff;">// order_id, business_desc, account_id, trade_desc 四元组，本次操作<span style="color:#ff0000;">出账</span>的唯一标识，在整个数据表的唯一标识</span></em></strong><br><span style="color:#0000ff;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'userOrder_150121548745', // 业务订单ID，用户订单</span><br><span style="color:#0000ff;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖用户外卖订单', // 业务描述</span><br><span style="color:#0000ff;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 98989777783780001, //余额<strong><span style="color:#ff0000;">出账</span></strong>账户的账户ID</span><br><span style="color:#0000ff;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '用户下单', //金额操作描述</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;<strong><span style="color:#0000ff;">1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系</span></strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '商户接单', // 备注信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'split_formula' =&gt; array(//&nbsp;<strong><span style="color:#0000ff;"><span style="color:#ff0000;">入账</span>账户信息配置</span></strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作<span style="color:#ff0000;">入账</span>的唯一标识，在整个数据表的唯一标识</strong></span></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'55555666666666' =&gt; array( // 入账账户1的账户ID，以及配置信息<br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'order_id' =&gt; 'shopOrder_jljljljlljl', // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '<span style="color:#0000ff;">百度外卖商户外卖订单</span>', // 业务描述</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 55555666666666, //<strong><span style="color:#ff0000;">入账</span></strong>账户1的账户ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '<strong><span style="color:#0000ff;">商户营业输入</span></strong>', //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 2500,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作<span style="color:#ff0000;">入账</span>的唯一标识，在整个数据表的唯一标识</strong></span></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'222222233333333' =&gt; array( //&nbsp;<strong><span style="color:#ff0000;">入账</span></strong>账户2的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color:#ff9900;">'order_id' =&gt; 'logistics_5245787854745', // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '<span style="color:#0000ff;">百度外卖物流冻结账户</span>', // 业务描述</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 222222233333333, //<strong><span style="color:#ff0000;">入账</span></strong>账户2的账户ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt;&nbsp;<strong>'<span style="color:#0000ff;">物流接单</span>'</strong>, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 1000,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作<span style="color:#ff0000;">入账</span>的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同)</strong></span></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '1111111111777777' =&gt; array( //&nbsp;<strong><span style="color:#ff0000;">入账</span></strong>账户3的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#ff9900;">&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '<span style="color:#0000ff;">百度外卖新用户补贴</span>', // 业务描述</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt;&nbsp;<strong><span style="color:#0000ff;">1111111111777777</span></strong>, //<strong><span style="color:#ff0000;">入账</span></strong>账户3的账户ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '<span style="color:#0000ff;"><strong>新用户补贴出账</strong></span>', //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; -1500,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作<span style="color:#ff0000;">入账</span>的唯一标识，在整个数据表的唯一标识<em><strong>(本资金流中，1111111111777777两次操作的trade_desc不同)</strong></em></strong></span></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '1111111111777777' =&gt; array( //&nbsp;<strong><span style="color:#ff0000;">入账</span></strong>账户3的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<span style="color:#ff9900;">'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '<span style="color:#0000ff;">百度外卖新用户补贴</span>', // 业务描述</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt;&nbsp;<span style="color:#0000ff;"><strong>1111111111777777</strong></span>, //<strong><span style="color:#ff0000;">入账</span></strong>账户3的账户ID</span><br><span style="color:#ff9900;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '<span style="color:#0000ff;"><strong>优质用户嘉奖</strong></span>', //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; -800,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;<span style="color:#0000ff;">第二组分账操作命令</span><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_method' =&gt; 'splitAccount', // 金额操作方法-分账<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// ....<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;),<br> );</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p><br> &nbsp;</p> 
  <p>&nbsp;</p> 
  <h3>3.4.5 资金关系存储算法选择：</h3> 
  <p>3.4.5.1 资金关系存储模型</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-10%2016%3A38%3A4.png?version=1&amp;modificationDate=1502354339000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="604" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094354760?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="351"></p> 
  <p>3.4.5.2 资金关系存储示例:</p> 
  <p>array(<br> &nbsp; &nbsp; // 资金交易上游账户唯一信息<br> &nbsp; &nbsp;&nbsp;<strong><span style="color:#0000ff;">'absolute_parent' =&gt; array( &nbsp;&nbsp;// 绝对上游信息</span></strong><br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组的唯一性</strong></span></em></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; 'order_id' =&gt; 'userOrder_150121548745', // 业务订单ID，用户订单</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖用户外卖订单', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 98989777783780001, //余额出账账户的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '用户下单', //金额操作描述<br> &nbsp; &nbsp; ),<br> &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作<br> &nbsp; &nbsp;&nbsp;<strong><span style="color:#0000ff;">'relative_parent' =&gt; array(), &nbsp; &nbsp;// 相对上游信息</span></strong><br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;<strong><span style="color:#0000ff;">2500 = 2300+200</span></strong><br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'is_split' =&gt; 1, // 0:可以分账 1:已分账<br> &nbsp; &nbsp; &nbsp; &nbsp;<strong><span style="color:#0000ff;">&nbsp;'child_details' =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息</span></strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组的唯一性</strong></span></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '8888888888881111' =&gt; array( // 入账账户<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'order_id' =&gt; 'shop_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户净收', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888881111, //入账账户3的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '商户净收入', //金额操作描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'amount' =&gt; 2300,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><span style="color:#ff9900;"><strong>// order_id, business_desc, account_id, trade_desc 四元组的唯一性</strong></span></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'8888888888883333' =&gt; array( // 入账账户<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户抽佣', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888883333, //入账账户3的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '平台抽佣金额', //金额操作描述,&nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'amount' =&gt; 200,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;),<br> &nbsp; &nbsp; &nbsp; &nbsp; )<br> );</p> 
  <p>基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。</p> 
  <p>1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一</p> 
  <p>2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一</p> 
  <p>优化点：建立<span style="color:#0000ff;"><strong>绝对上下游关系</strong></span>和<span style="color:#0000ff;"><strong>相对上游</strong></span>关系</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点</p> 
  <p>&nbsp;</p> 
  <p>3.4.5.3 账单格式</p> 
  <p>array( // 账单1<br> &nbsp; &nbsp; 'order_id' =&gt; 'userOrder_150121548745', // 业务订单ID，用户订单<br> &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖用户外卖订单', // 业务描述<br> &nbsp; &nbsp;&nbsp;'account_id' =&gt; 98989777783780001, // 余额出账账户的账户ID<br> &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '用户下单', // 金额操作描述<br> &nbsp; &nbsp;&nbsp;'flow_type' =&gt; 'out', // 资金出账<br> &nbsp; &nbsp;&nbsp;'trade_type' =&gt; '交易出账', // 交易类型<br> &nbsp; &nbsp;&nbsp;'amount' =&gt; 2500,</p> 
  <p>&nbsp; &nbsp; 'remark' =&gt; '',<br> );</p> 
  <p>array( // 账单2<br> &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'shop_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户净收', // 业务描述<br> &nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888881111, //入账账户3的账户ID<br> &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '商户净收入', //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同<br> &nbsp; &nbsp;&nbsp;'flow_type' =&gt; 'in', // 资金入账<br> &nbsp; &nbsp;&nbsp;'trade_type' =&gt; '交易入账', // 交易类型<br> &nbsp; &nbsp;&nbsp;'amount' =&gt; 2300,<br> &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> );</p> 
  <p>array( // 账单3<br> &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户抽佣', // 业务描述<br> &nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888883333, //入账账户3的账户ID<br> &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '平台抽佣金额', //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同<br> &nbsp; &nbsp;&nbsp;'flow_type' =&gt; 'in', // 资金入账<br> &nbsp; &nbsp;&nbsp;'trade_type' =&gt; '交易入账', // 交易类型<br> &nbsp; &nbsp;&nbsp;'amount' =&gt; 200,<br> &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> );</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h3>3.4.7 资金流按业务分区块</h3> 
  <p>&nbsp;</p> 
  <p>1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金</p> 
  <p>2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向</p> 
  <p>&nbsp;</p> 
  <h3>3.4.8&nbsp;资金操作接口API</h3> 
  <p>3.4.8.1 完善的API接口</p> 
  <p>入账、出账、分账、调账和撤销等，实现资金操作接口统一化，</p> 
  <p>&nbsp;</p> 
  <p>3.4.8.2 规范、丰富的交易类型</p> 
  <p>交易类型场景化和统一化</p> 
  <p>交易类型可定制</p> 
  <p>丰富交易类型，实现按类型归纳、追踪、查询和统计等</p> 
  <p>&nbsp;</p> 
  <p>3.4.8.3 资金分配状态机</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-10%2016%3A50%3A11.png?version=1&amp;modificationDate=1502355066000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="574" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094423806?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="230"></p> 
  <p>资金操作API的背后，是规范化了的资金分配关系数据</p> 
  <p>资金分配关系数据，可以确保资金的准确分配</p> 
  <p>记录资金分配的完整过程</p> 
  <p>资金分配<strong><span style="color:#0000ff;">状态机</span></strong>的载体</p> 
  <p>同时通过资金分配关系，可以复盘、<strong><span style="color:#0000ff;">回放资金交易</span></strong>的完整过程</p> 
  <p>&nbsp;</p> 
  <p>3.4.8.4 资金撤回</p> 
  <p>1、支持取消任意账户分账（单节点取消分账）</p> 
  <p>2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账）</p> 
  <p>3、支持递归取消整个资金流的分账（取消整棵资金分配过程）</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>3.5 资源管理</h2> 
  <p>支持批量请求:支持单个请求处理，也支持批量请求处理，</p> 
  <p>统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚</p> 
  <p>统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。</p> 
  <p>统一异常处理:错误抛异常，异常格式统一化...</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" height="466" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184352492?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="557"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A49%3A48.png?version=1&amp;modificationDate=1495194616000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>3.6 设计回顾总结</h2> 
  <p>赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。</p> 
  <p>账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。</p> 
  <p>上面说了一大堆，如下图示简单总结，小清新一下。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A48%3A53.png?version=1&amp;modificationDate=1495194561000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="714" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018442527?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="820"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h1>4 热点问题</h1> 
  <p>&nbsp;</p> 
  <p>如下是几大热点问题:每个问题的具体处理方案在后面有详述。</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-22%2011%3A27%3A23.png?version=1&amp;modificationDate=1495423678000&amp;api=v2" style="margin-left:2px;"></p> 
  <p><img alt="" class="has" height="200" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094509801?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="226"></p> 
  <h2>4.1 大并发</h2> 
  <p>简要解析：同步和异步并存，是一个综合方案，可以保证账务处理的实时性，如下方案的优、缺点以及引发的问题，在下图有详述。</p> 
  <p><img alt="" class="has" height="346" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094540419?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="828"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A51%3A12.png?version=1&amp;modificationDate=1495194699000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p>&nbsp;</p> 
  <h2>4.2 大数据量</h2> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A51%3A48.png?version=1&amp;modificationDate=1495194736000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="473" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094615937?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="820"></p> 
  <p>&nbsp;</p> 
  <h2>4.3 热点账户</h2> 
  <p>&nbsp;</p> 
  <h3>4.3.1热点账户的概念:&nbsp;</h3> 
  <p>&nbsp; &nbsp; &nbsp;热点账户就是在交易过程中，出现频次特别高的账户，交易频次指的是某个时间段的交易频次一直保持在比较高的次数。</p> 
  <p>&nbsp; &nbsp; &nbsp;如果是数据操作错误重试导致某账户瞬时出现高频操作，则不属于热点账户范畴。</p> 
  <p>&nbsp;</p> 
  <h3>4.3.2 热点账户的判别标准</h3> 
  <p>&nbsp; &nbsp; 1) 账户每秒有10次以上更新需求</p> 
  <p>&nbsp; &nbsp; 2) 串行化时账户处理延迟高于1秒以上</p> 
  <p>&nbsp;</p> 
  <h3>4.3.3 热点账户的处理方案</h3> 
  <p>&nbsp;</p> 
  <table>
   <tbody>
    <tr>
     <td style="vertical-align:top;"> <p>热点账户类型</p> </td> 
     <td style="vertical-align:top;"> <p>账户属性</p> </td> 
     <td style="vertical-align:top;"> <p>实时需求</p> </td> 
     <td style="vertical-align:top;"> <p>锁需求</p> </td> 
     <td style="vertical-align:top;"> <p>处理方式</p> </td> 
     <td style="vertical-align:top;"> <p>性能</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>业务大账户</p> </td> 
     <td style="vertical-align:top;"> <p>内部账户</p> </td> 
     <td style="vertical-align:top;"> <p>无实时余额查询</p> <p>无实时提现</p> </td> 
     <td style="vertical-align:top;"> <p>无需加锁</p> </td> 
     <td style="vertical-align:top;"> <p>异步</p> </td> 
     <td style="vertical-align:top;"> <p>满足</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>大代理商账户</p> <p>&nbsp;</p> </td> 
     <td style="vertical-align:top;"> <p>对外账户</p> </td> 
     <td style="vertical-align:top;"> <p>无实时余额查询</p> <p>无实时提现</p> </td> 
     <td style="vertical-align:top;"> <p>没有加锁需求</p> </td> 
     <td style="vertical-align:top;"> <p>异步</p> </td> 
     <td style="vertical-align:top;"> <p>满足</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;"> <p>热门商户(推广)</p> </td> 
     <td style="vertical-align:top;"> <p>对外账户</p> <p>商户账户</p> </td> 
     <td style="vertical-align:top;"> <p>实时余额查询</p> <p>实时提现</p> </td> 
     <td style="vertical-align:top;"> <p>有加锁需求</p> </td> 
     <td style="vertical-align:top;"> <p>串行化同步</p> </td> 
     <td style="vertical-align:top;"> <p>亟待提升</p> </td> 
    </tr>
   </tbody>
  </table>
  <p>&nbsp;</p> 
  <h3><strong>4.3.4 热点账户总结</strong></h3> 
  <p>1) 在异步化背景(账户实时处理的上游，如果已经存在了异步化的处理)下，此时业务所需要的下游的实时性是不可能完全实时的</p> 
  <p>2) 对于热点账户而言，问题在于一条数据表项的更新频次已经达到了上线，所以解决热点账户的方案可以从解决数据读取的瓶颈出发。</p> 
  <p>&nbsp;</p> 
  <h2>4.5 实时性-high-实时账务更新</h2> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" height="424" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094653684?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="795"></p> 
  <p>&nbsp;</p> 
  <h3>&nbsp;</h3> 
  <h3>4.5.1 实时账务更新</h3> 
  <p>4.5.2.1 完全实时设计实现</p> 
  <p>业务直接调用账务系统交易的API接口，实时处理账务交易，所谓的实时交易，也是进行了一定的优化（同步和异步相结合）。</p> 
  <p><img alt="" class="has" height="289" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081309472651?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="781"></p> 
  <p>1) 商户账户扣费，使用的是实时扣费</p> 
  <p>&nbsp; &nbsp; a）账户更新使用redis锁代替数据库锁，同样也是悲观锁，不过请求不阻塞，请求延迟很小</p> 
  <p>&nbsp; &nbsp; b ) 请求锁失败，业务继续重试请求。</p> 
  <p>&nbsp; &nbsp; c ) 平台内部账户仍然采用异步余额更新，减少了分账的锁阻塞几率，有效保证了同步更新的成功率，即减少了锁请求失败的概率。</p> 
  <p>&nbsp;</p> 
  <p>2) 百度外卖推广收入账户，同样采用的是异步更新账户金额的方式。因为这个账户是平台共用，属于热点账户，锁阻塞很严重，但是该账户的任何行为和表现不会影响到商户账户余额更新，所以这里使用异步更新的方式，消除了热点账户的影响。</p> 
  <p>4.5.2.2 完全实时场景</p> 
  <p>CPC（按点击扣费）业务，账户提现等</p> 
  <p><img alt="" class="has" height="252" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094748244?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="245"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-14%2022%3A29%3A0.png?version=1&amp;modificationDate=1502720946000&amp;api=v2" style="margin-left:2px;"></p> 
  <p>&nbsp;</p> 
  <h3>4.5.2 上游调用方对用户或者账户进行分桶，防止同一账户被同时更新而造成的冲突</h3> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>4.6 实时性-middle-非实时的准实时更新</h2> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" height="298" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094817209?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="807"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h3>4.6.1 准实时的实现</h3> 
  <p><img alt="" class="has" height="360" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081309483861?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="875"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>各业务的资金分账，入消息队列，调用账务交易平台资金操作接口，账务平台按分账需求和分账状态处理账务消息</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-14%2022%3A50%3A11.png?version=1&amp;modificationDate=1502722217000&amp;api=v2" style="margin-left:2px;"></p> 
  <h3>4.6.2 准实时性能</h3> 
  <p>通过消息队列处理账务交易信息，QPS基本不是瓶颈</p> 
  <p>通过对业务和订单散列细分，账务交易系统可以有序、快速处理资金，</p> 
  <p>支持批量请求，从业务层解除数据依赖和状态依赖</p> 
  <p>最终测试结果：账户余额更新最差延迟时间控制在15秒内。</p> 
  <p>&nbsp;</p> 
  <h3>4.6.3 准实时业务场景</h3> 
  <p>用户订单，物流订单等账务处理都是非实时需求场景</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h1>5.准确性</h1> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2>5.1 业务监控</h2> 
  <p>&nbsp;</p> 
  <p>1、账务交易异常，MQ堵塞</p> 
  <p>&nbsp;</p> 
  <p>2、业务订单异常监控</p> 
  <p>&nbsp;</p> 
  <p>3、涉及账户人员入账错误会第一时间联系客服(仅限于少入账 J)</p> 
  <p>&nbsp;</p> 
  <p>4、业务通过订单数据可以修复账务交易错误</p> 
  <p>&nbsp;</p> 
  <h2>5.2 平台对账</h2> 
  <p>&nbsp;</p> 
  <p>1、交易维度 : 上条记录余额 = 当前发生额 + 当前余额</p> 
  <p>&nbsp;</p> 
  <p>2、按订单维度 : 该订单的所有账户的发生额总支出=发生而总收入</p> 
  <p>&nbsp;</p> 
  <p>3、余额快照 : 账户当日的期末余额=期末余额+发生额</p> 
  <p>&nbsp;</p> 
  <p>4、余额快照 : 当日所有账户的期期末余额=期末余额+发生额</p> 
  <p>&nbsp;</p> 
  <p>5、常规对账</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h1>6. 使用建议</h1> 
  <p>&nbsp;</p> 
  <h2>6.1 业务接入建议</h2> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A53%3A55.png?version=1&amp;modificationDate=1495194862000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="376" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094859954?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="803"></p> 
  <h2>6.2 使用建议</h2> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" height="483" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094920365?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="790"></p> 
  <p>&nbsp;</p> 
  <h1>7 总结思考</h1> 
  <p>&nbsp;</p> 
  <h2>7.1 思考</h2> 
  <p>设计是一个找平衡点的过程，</p> 
  <p>一条是功能线，(概要如下图)</p> 
  <p>一条是性能线，(概要如下图)</p> 
  <p>寻找功能和性能的平衡，如果有任何一点出了问题，就无法支撑业务的需求。</p> 
  <p>最终的原则，就是在支撑业务需求的前提下，进一步提升性能和可扩展性。</p> 
  <p><img alt="" class="has" height="488" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094940417?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="809"></p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-25%209%3A45%3A30.png?version=1&amp;modificationDate=1495676773000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <h2>7.2 总结</h2> 
  <p>&nbsp;</p> 
  <p><img alt="" class="confluence-embedded-image" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A57%3A5.png?version=1&amp;modificationDate=1495195053000&amp;api=v2" style="margin-left:2px;" width="800"></p> 
  <p><img alt="" class="has" height="576" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813095004615?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="817"></p> 
  <h2>7.3 收尾</h2> 
  <p>找好平衡点</p> 
  <p>抽象、统一、数据化</p> 
  <p>深入、专一、平台化</p> 
  <p>&nbsp;</p> 
  <p>谢谢！</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h1><span style="color:#333333;">作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16</span></h1> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/yk200808/article/details/80755459,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/yk200808/article/details/80755459,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
