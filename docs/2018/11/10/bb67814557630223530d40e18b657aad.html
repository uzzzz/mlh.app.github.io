<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>以太坊钱包开发系列4 - 发送Token(代币） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="以太坊钱包开发系列4 - 发送Token(代币）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="版权声明：本文为博主原创文章，转载请注明出处。 https://blog.csdn.net/xilibi2003/article/details/83932241 以太坊去中心化网页钱包开发系列，将从零开始开发出一个可以实际使用的钱包，本系列文章是理论与实战相结合，一共有四篇：创建钱包账号、账号Keystore文件导入导出、展示钱包信息及发起签名交易、发送Token(代币），本文是第四篇，Token（代币、通证）是以太坊的一大特色，既然开发钱包，则发送Token 功能必不可少。 合约 ABI 信息 首先我们需要明白，进行Token转账的时候，其实是在调用合约的转账函数，而要调用一个合约的函数，需要知道合约的 ABI 信息。 其次 通常我们所说的Token， 其实指的是符合 ERC20 标准接口的合约， ERC20 接口定义如下： contract ERC20Interface { string public constant name = &quot;Token Name&quot;; string public constant symbol = &quot;SYM&quot;; uint8 public constant decimals = 0; function totalSupply() public constant returns (uint); function balanceOf(address tokenOwner) public constant returns (uint balance); function allowance(address tokenOwner, address spender) public constant returns (uint remaining); function approve(address spender, uint tokens) public returns (bool success); function transfer(address to, uint tokens) public returns (bool success); function transferFrom(address from, address to, uint tokens) public returns (bool success); event Transfer(address indexed from, address indexed to, uint tokens); event Approval(address indexed tokenOwner, address indexed spender, uint tokens); } ABI 全称是 Application Binary Interface，它就是合约接口的描述，因此有了合约的接口定义，就可以很容易通过编译拿到ABI 信息，比如像下图在Remix 的编译选项卡就可以直接复制ABI。 生成的 ABI 描述大概长这样： [ ... { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;totalSupply&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;tokenOwner&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;balanceOf&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;balance&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot; }, ... ] 它是一个JSON形式的数组，数组里每一个元素，都是对函数接口的描述，在外部调用合约的时候就需要遵从这个接口，以上面的接口为例，通常一个接口描述包含下述几个字段： name: 函数会事件的名称 type: 可取值有function，constructor，fallback，event inputs: 函数的输入参数，每个参数对象包含下述属性： name: 参数名称 type: 参数的规范型(Canonical Type)。 outputs: 一系列的类似inputs的对象，如果无返回值时，可以省略。 constant: true表示函数声明自己不会改变状态变量的值。 payable: true表示函数可以接收ether，否则表示不能。 接下来在构造合约对象就需要是使用ABI。 构造合约对象 ethers.js 构造合约对象很简单，仅需要提供三个参数给ethers.Contract构造函数，代码如下： var abi = [...]; var addr = &quot;0x...&quot;; var contract = new ethers.Contract(address, abi, provider); 合约的地址在合约部署之后，可以获得，关于Token合约部署及ERC20相关的概念，这里不展开讲，不熟悉的同学，可以参考我另一篇文章创建自己的数字货币。 只有就可以是使用 contract 对象来调用Token合约的函数。 获取Token余额及转移Token 获取Token余额 结合UI来实现以下获取Token余额，UI如下： 在HTML里，定义的标签如下： &lt;tr&gt; &lt;th&gt;TT Token:&lt;/th&gt; &lt;td&gt; &lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;readonly&quot; id=&quot;wallet-token-balance&quot; value=&quot;0.0&quot; /&gt;&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt; 对应的逻辑代码也很简单： var tokenBalance = $(&#39;#wallet-token-balance&#39;); // 直接调用合约方法 contract.balanceOf(activeWallet.address).then(function(balance){ tokenBalance.val(balance); }); 转移Token 转移Token的UI效果如下： 界面的HTML代码如下： &lt;h3&gt;转移代币:&lt;/h3&gt; &lt;table&gt; &lt;tr&gt; &lt;th&gt;发送至:&lt;/th&gt; &lt;td&gt;&lt;input type=&quot;text&quot; placeholder=&quot;(target address)&quot; id=&quot;wallet-token-send-target-address&quot; /&gt;&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;金额:&lt;/th&gt; &lt;td&gt;&lt;input type=&quot;text&quot; placeholder=&quot;(amount)&quot; id=&quot;wallet-token-send-amount&quot; /&gt;&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;/td&gt; &lt;td&gt; &lt;div id=&quot;wallet-token-submit-send&quot; class=&quot;submit disable&quot;&gt;发送&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/table&gt; 上面定义了两个文本输入框及一个“发送“按钮，在逻辑处理部分，转移Token代币尽管和获取余额类似，同样是调用合约的方法，不过转移代币需要发起一个交易，因此需要测量gas 消耗。 点击发送时运行一下（关键）代码： var inputTargetAddress = $(&#39;#wallet-token-send-target-address&#39;); var inputAmount = $(&#39;#wallet-token-send-amount&#39;); var submit = $(&#39;#wallet-token-submit-send&#39;); var targetAddress = ethers.utils.getAddress(inputTargetAddress.val()); var amount = inputAmount.val(); submit.click(function() { // 先计算transfer 需要的gas 消耗量，这一步有默认值，非必须。 contract.estimate.transfer(targetAddress, amount) .then(function(gas) { // 必须关联一个有过签名钱包对象 let contractWithSigner = contract.connect(activeWallet); // 发起交易，前面2个参数是函数的参数，第3个是交易参数 contractWithSigner.transfer(targetAddress, amount, { gasLimit: gas, // 偷懒，直接是用 2gwei gasPrice: ethers.utils.parseUnits(&quot;2&quot;, &quot;gwei&quot;), }).then(function(tx) { console.log(tx); // 介绍刷新上面的Token余额，重置输入框 }); }); } 上述有一个地方都要注意一下，在合约调用 transfer 之前， 需要连接一个signer，因为发起交易的时候需要用它来进行签名，在ethers.js API里 Wallet 是 signer（抽象类）的实现类。 所有会更改区块链数据的函数都需要关联签名器，如果是视图函数则只需要连接provider。 ethers.js 的 Contract 提供了一个非常方便方法：contract.estimate.functionName 来计算预测交易的gasLimit。 在发起交易的时候，可以提供一个可选的Overrides参数，在这个参数里可以指定如交易的 gasLimit 、 gasPrice，如果我们不指定这个参数时，会默认使用 contract.estimate 获得的值作为 gasLimit，以及 provider.getGasPrice() 的值来指定 gasPrice。 哈哈，恭喜大家，到这里这里就完整的实现了一个基于以太坊去中心化网页钱包。 这是一条硬广，欢迎订阅深入浅出区块链技术小专栏，目前仅需69元， 订阅就可以查看完整源码，还有其他惊喜哦~。 戳链接收看详细的视频课程讲解。 参考文档 Ethers.js 深入浅出区块链 - 系统学习区块链，打造最好的区块链技术博客。 深入浅出区块链知识星球最专业技术问答社区，加入社区还可以在微信群里和300多位区块链技术爱好者一起交流。 阅读更多" />
<meta property="og:description" content="版权声明：本文为博主原创文章，转载请注明出处。 https://blog.csdn.net/xilibi2003/article/details/83932241 以太坊去中心化网页钱包开发系列，将从零开始开发出一个可以实际使用的钱包，本系列文章是理论与实战相结合，一共有四篇：创建钱包账号、账号Keystore文件导入导出、展示钱包信息及发起签名交易、发送Token(代币），本文是第四篇，Token（代币、通证）是以太坊的一大特色，既然开发钱包，则发送Token 功能必不可少。 合约 ABI 信息 首先我们需要明白，进行Token转账的时候，其实是在调用合约的转账函数，而要调用一个合约的函数，需要知道合约的 ABI 信息。 其次 通常我们所说的Token， 其实指的是符合 ERC20 标准接口的合约， ERC20 接口定义如下： contract ERC20Interface { string public constant name = &quot;Token Name&quot;; string public constant symbol = &quot;SYM&quot;; uint8 public constant decimals = 0; function totalSupply() public constant returns (uint); function balanceOf(address tokenOwner) public constant returns (uint balance); function allowance(address tokenOwner, address spender) public constant returns (uint remaining); function approve(address spender, uint tokens) public returns (bool success); function transfer(address to, uint tokens) public returns (bool success); function transferFrom(address from, address to, uint tokens) public returns (bool success); event Transfer(address indexed from, address indexed to, uint tokens); event Approval(address indexed tokenOwner, address indexed spender, uint tokens); } ABI 全称是 Application Binary Interface，它就是合约接口的描述，因此有了合约的接口定义，就可以很容易通过编译拿到ABI 信息，比如像下图在Remix 的编译选项卡就可以直接复制ABI。 生成的 ABI 描述大概长这样： [ ... { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;totalSupply&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;tokenOwner&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;balanceOf&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;balance&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot; }, ... ] 它是一个JSON形式的数组，数组里每一个元素，都是对函数接口的描述，在外部调用合约的时候就需要遵从这个接口，以上面的接口为例，通常一个接口描述包含下述几个字段： name: 函数会事件的名称 type: 可取值有function，constructor，fallback，event inputs: 函数的输入参数，每个参数对象包含下述属性： name: 参数名称 type: 参数的规范型(Canonical Type)。 outputs: 一系列的类似inputs的对象，如果无返回值时，可以省略。 constant: true表示函数声明自己不会改变状态变量的值。 payable: true表示函数可以接收ether，否则表示不能。 接下来在构造合约对象就需要是使用ABI。 构造合约对象 ethers.js 构造合约对象很简单，仅需要提供三个参数给ethers.Contract构造函数，代码如下： var abi = [...]; var addr = &quot;0x...&quot;; var contract = new ethers.Contract(address, abi, provider); 合约的地址在合约部署之后，可以获得，关于Token合约部署及ERC20相关的概念，这里不展开讲，不熟悉的同学，可以参考我另一篇文章创建自己的数字货币。 只有就可以是使用 contract 对象来调用Token合约的函数。 获取Token余额及转移Token 获取Token余额 结合UI来实现以下获取Token余额，UI如下： 在HTML里，定义的标签如下： &lt;tr&gt; &lt;th&gt;TT Token:&lt;/th&gt; &lt;td&gt; &lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;readonly&quot; id=&quot;wallet-token-balance&quot; value=&quot;0.0&quot; /&gt;&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt; 对应的逻辑代码也很简单： var tokenBalance = $(&#39;#wallet-token-balance&#39;); // 直接调用合约方法 contract.balanceOf(activeWallet.address).then(function(balance){ tokenBalance.val(balance); }); 转移Token 转移Token的UI效果如下： 界面的HTML代码如下： &lt;h3&gt;转移代币:&lt;/h3&gt; &lt;table&gt; &lt;tr&gt; &lt;th&gt;发送至:&lt;/th&gt; &lt;td&gt;&lt;input type=&quot;text&quot; placeholder=&quot;(target address)&quot; id=&quot;wallet-token-send-target-address&quot; /&gt;&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;金额:&lt;/th&gt; &lt;td&gt;&lt;input type=&quot;text&quot; placeholder=&quot;(amount)&quot; id=&quot;wallet-token-send-amount&quot; /&gt;&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;/td&gt; &lt;td&gt; &lt;div id=&quot;wallet-token-submit-send&quot; class=&quot;submit disable&quot;&gt;发送&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/table&gt; 上面定义了两个文本输入框及一个“发送“按钮，在逻辑处理部分，转移Token代币尽管和获取余额类似，同样是调用合约的方法，不过转移代币需要发起一个交易，因此需要测量gas 消耗。 点击发送时运行一下（关键）代码： var inputTargetAddress = $(&#39;#wallet-token-send-target-address&#39;); var inputAmount = $(&#39;#wallet-token-send-amount&#39;); var submit = $(&#39;#wallet-token-submit-send&#39;); var targetAddress = ethers.utils.getAddress(inputTargetAddress.val()); var amount = inputAmount.val(); submit.click(function() { // 先计算transfer 需要的gas 消耗量，这一步有默认值，非必须。 contract.estimate.transfer(targetAddress, amount) .then(function(gas) { // 必须关联一个有过签名钱包对象 let contractWithSigner = contract.connect(activeWallet); // 发起交易，前面2个参数是函数的参数，第3个是交易参数 contractWithSigner.transfer(targetAddress, amount, { gasLimit: gas, // 偷懒，直接是用 2gwei gasPrice: ethers.utils.parseUnits(&quot;2&quot;, &quot;gwei&quot;), }).then(function(tx) { console.log(tx); // 介绍刷新上面的Token余额，重置输入框 }); }); } 上述有一个地方都要注意一下，在合约调用 transfer 之前， 需要连接一个signer，因为发起交易的时候需要用它来进行签名，在ethers.js API里 Wallet 是 signer（抽象类）的实现类。 所有会更改区块链数据的函数都需要关联签名器，如果是视图函数则只需要连接provider。 ethers.js 的 Contract 提供了一个非常方便方法：contract.estimate.functionName 来计算预测交易的gasLimit。 在发起交易的时候，可以提供一个可选的Overrides参数，在这个参数里可以指定如交易的 gasLimit 、 gasPrice，如果我们不指定这个参数时，会默认使用 contract.estimate 获得的值作为 gasLimit，以及 provider.getGasPrice() 的值来指定 gasPrice。 哈哈，恭喜大家，到这里这里就完整的实现了一个基于以太坊去中心化网页钱包。 这是一条硬广，欢迎订阅深入浅出区块链技术小专栏，目前仅需69元， 订阅就可以查看完整源码，还有其他惊喜哦~。 戳链接收看详细的视频课程讲解。 参考文档 Ethers.js 深入浅出区块链 - 系统学习区块链，打造最好的区块链技术博客。 深入浅出区块链知识星球最专业技术问答社区，加入社区还可以在微信群里和300多位区块链技术爱好者一起交流。 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/11/10/bb67814557630223530d40e18b657aad.html" />
<meta property="og:url" content="https://mlh.app/2018/11/10/bb67814557630223530d40e18b657aad.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-10T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"版权声明：本文为博主原创文章，转载请注明出处。 https://blog.csdn.net/xilibi2003/article/details/83932241 以太坊去中心化网页钱包开发系列，将从零开始开发出一个可以实际使用的钱包，本系列文章是理论与实战相结合，一共有四篇：创建钱包账号、账号Keystore文件导入导出、展示钱包信息及发起签名交易、发送Token(代币），本文是第四篇，Token（代币、通证）是以太坊的一大特色，既然开发钱包，则发送Token 功能必不可少。 合约 ABI 信息 首先我们需要明白，进行Token转账的时候，其实是在调用合约的转账函数，而要调用一个合约的函数，需要知道合约的 ABI 信息。 其次 通常我们所说的Token， 其实指的是符合 ERC20 标准接口的合约， ERC20 接口定义如下： contract ERC20Interface { string public constant name = &quot;Token Name&quot;; string public constant symbol = &quot;SYM&quot;; uint8 public constant decimals = 0; function totalSupply() public constant returns (uint); function balanceOf(address tokenOwner) public constant returns (uint balance); function allowance(address tokenOwner, address spender) public constant returns (uint remaining); function approve(address spender, uint tokens) public returns (bool success); function transfer(address to, uint tokens) public returns (bool success); function transferFrom(address from, address to, uint tokens) public returns (bool success); event Transfer(address indexed from, address indexed to, uint tokens); event Approval(address indexed tokenOwner, address indexed spender, uint tokens); } ABI 全称是 Application Binary Interface，它就是合约接口的描述，因此有了合约的接口定义，就可以很容易通过编译拿到ABI 信息，比如像下图在Remix 的编译选项卡就可以直接复制ABI。 生成的 ABI 描述大概长这样： [ ... { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;totalSupply&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;tokenOwner&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;balanceOf&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;balance&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot; }, ... ] 它是一个JSON形式的数组，数组里每一个元素，都是对函数接口的描述，在外部调用合约的时候就需要遵从这个接口，以上面的接口为例，通常一个接口描述包含下述几个字段： name: 函数会事件的名称 type: 可取值有function，constructor，fallback，event inputs: 函数的输入参数，每个参数对象包含下述属性： name: 参数名称 type: 参数的规范型(Canonical Type)。 outputs: 一系列的类似inputs的对象，如果无返回值时，可以省略。 constant: true表示函数声明自己不会改变状态变量的值。 payable: true表示函数可以接收ether，否则表示不能。 接下来在构造合约对象就需要是使用ABI。 构造合约对象 ethers.js 构造合约对象很简单，仅需要提供三个参数给ethers.Contract构造函数，代码如下： var abi = [...]; var addr = &quot;0x...&quot;; var contract = new ethers.Contract(address, abi, provider); 合约的地址在合约部署之后，可以获得，关于Token合约部署及ERC20相关的概念，这里不展开讲，不熟悉的同学，可以参考我另一篇文章创建自己的数字货币。 只有就可以是使用 contract 对象来调用Token合约的函数。 获取Token余额及转移Token 获取Token余额 结合UI来实现以下获取Token余额，UI如下： 在HTML里，定义的标签如下： &lt;tr&gt; &lt;th&gt;TT Token:&lt;/th&gt; &lt;td&gt; &lt;input type=&quot;text&quot; readonly=&quot;readonly&quot; class=&quot;readonly&quot; id=&quot;wallet-token-balance&quot; value=&quot;0.0&quot; /&gt;&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt; 对应的逻辑代码也很简单： var tokenBalance = $(&#39;#wallet-token-balance&#39;); // 直接调用合约方法 contract.balanceOf(activeWallet.address).then(function(balance){ tokenBalance.val(balance); }); 转移Token 转移Token的UI效果如下： 界面的HTML代码如下： &lt;h3&gt;转移代币:&lt;/h3&gt; &lt;table&gt; &lt;tr&gt; &lt;th&gt;发送至:&lt;/th&gt; &lt;td&gt;&lt;input type=&quot;text&quot; placeholder=&quot;(target address)&quot; id=&quot;wallet-token-send-target-address&quot; /&gt;&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;th&gt;金额:&lt;/th&gt; &lt;td&gt;&lt;input type=&quot;text&quot; placeholder=&quot;(amount)&quot; id=&quot;wallet-token-send-amount&quot; /&gt;&lt;/td&gt; &lt;/tr&gt; &lt;tr&gt; &lt;td&gt; &lt;/td&gt; &lt;td&gt; &lt;div id=&quot;wallet-token-submit-send&quot; class=&quot;submit disable&quot;&gt;发送&lt;/div&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/table&gt; 上面定义了两个文本输入框及一个“发送“按钮，在逻辑处理部分，转移Token代币尽管和获取余额类似，同样是调用合约的方法，不过转移代币需要发起一个交易，因此需要测量gas 消耗。 点击发送时运行一下（关键）代码： var inputTargetAddress = $(&#39;#wallet-token-send-target-address&#39;); var inputAmount = $(&#39;#wallet-token-send-amount&#39;); var submit = $(&#39;#wallet-token-submit-send&#39;); var targetAddress = ethers.utils.getAddress(inputTargetAddress.val()); var amount = inputAmount.val(); submit.click(function() { // 先计算transfer 需要的gas 消耗量，这一步有默认值，非必须。 contract.estimate.transfer(targetAddress, amount) .then(function(gas) { // 必须关联一个有过签名钱包对象 let contractWithSigner = contract.connect(activeWallet); // 发起交易，前面2个参数是函数的参数，第3个是交易参数 contractWithSigner.transfer(targetAddress, amount, { gasLimit: gas, // 偷懒，直接是用 2gwei gasPrice: ethers.utils.parseUnits(&quot;2&quot;, &quot;gwei&quot;), }).then(function(tx) { console.log(tx); // 介绍刷新上面的Token余额，重置输入框 }); }); } 上述有一个地方都要注意一下，在合约调用 transfer 之前， 需要连接一个signer，因为发起交易的时候需要用它来进行签名，在ethers.js API里 Wallet 是 signer（抽象类）的实现类。 所有会更改区块链数据的函数都需要关联签名器，如果是视图函数则只需要连接provider。 ethers.js 的 Contract 提供了一个非常方便方法：contract.estimate.functionName 来计算预测交易的gasLimit。 在发起交易的时候，可以提供一个可选的Overrides参数，在这个参数里可以指定如交易的 gasLimit 、 gasPrice，如果我们不指定这个参数时，会默认使用 contract.estimate 获得的值作为 gasLimit，以及 provider.getGasPrice() 的值来指定 gasPrice。 哈哈，恭喜大家，到这里这里就完整的实现了一个基于以太坊去中心化网页钱包。 这是一条硬广，欢迎订阅深入浅出区块链技术小专栏，目前仅需69元， 订阅就可以查看完整源码，还有其他惊喜哦~。 戳链接收看详细的视频课程讲解。 参考文档 Ethers.js 深入浅出区块链 - 系统学习区块链，打造最好的区块链技术博客。 深入浅出区块链知识星球最专业技术问答社区，加入社区还可以在微信群里和300多位区块链技术爱好者一起交流。 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/11/10/bb67814557630223530d40e18b657aad.html","headline":"以太坊钱包开发系列4 - 发送Token(代币）","dateModified":"2018-11-10T00:00:00+08:00","datePublished":"2018-11-10T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/11/10/bb67814557630223530d40e18b657aad.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>以太坊钱包开发系列4 - 发送Token(代币）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="article-copyright"> 
  <svg class="icon" title="CSDN认证原创" aria-hidden="true" style="width:53px; height: 18px; vertical-align: -4px;"> 
   <use xlink:href="#CSDN_Cert"></use> 
  </svg> 版权声明：本文为博主原创文章，转载请注明出处。 https://blog.csdn.net/xilibi2003/article/details/83932241 
 </div> 
 <div id="content_views" class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <p>以太坊去中心化网页钱包开发系列，将从零开始开发出一个可以实际使用的钱包，本系列文章是理论与实战相结合，一共有四篇：<a href="https://learnblockchain.cn/2018/10/25/eth-web-wallet_1/" rel="nofollow">创建钱包账号</a>、<a href="https://learnblockchain.cn/2018/10/25/eth-web-wallet_2/" rel="nofollow">账号Keystore文件导入导出</a>、<a href="https://learnblockchain.cn/2018/10/26/eth-web-wallet_3/" rel="nofollow">展示钱包信息及发起签名交易</a>、<a href="https://learnblockchain.cn/2018/10/26/eth-web-wallet_4/" rel="nofollow">发送Token(代币）</a>，本文是第四篇，Token（代币、通证）是以太坊的一大特色，既然开发钱包，则发送Token 功能必不可少。</p> 
  <h2><a id="_ABI__3"></a>合约 ABI 信息</h2> 
  <p>首先我们需要明白，进行Token转账的时候，其实是在调用合约的转账函数，而要调用一个合约的函数，需要知道合约的 ABI 信息。</p> 
  <p>其次 通常我们所说的Token， 其实指的是符合 ERC20 标准接口的合约， <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md" rel="nofollow">ERC20</a> 接口定义如下：</p> 
  <pre><code class="prism language-js">contract ERC20Interface <span class="token punctuation">{</span>

    string <span class="token keyword">public</span> constant name <span class="token operator">=</span> <span class="token string">"Token Name"</span><span class="token punctuation">;</span>
    string <span class="token keyword">public</span> constant symbol <span class="token operator">=</span> <span class="token string">"SYM"</span><span class="token punctuation">;</span>
    uint8 <span class="token keyword">public</span> constant decimals <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">totalSupply</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> constant <span class="token function">returns</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span>address tokenOwner<span class="token punctuation">)</span> <span class="token keyword">public</span> constant <span class="token function">returns</span> <span class="token punctuation">(</span>uint balance<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">allowance</span><span class="token punctuation">(</span>address tokenOwner<span class="token punctuation">,</span> address spender<span class="token punctuation">)</span> <span class="token keyword">public</span> constant <span class="token function">returns</span> <span class="token punctuation">(</span>uint remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span>address spender<span class="token punctuation">,</span> uint tokens<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span> <span class="token punctuation">(</span>bool success<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">transfer</span><span class="token punctuation">(</span>address to<span class="token punctuation">,</span> uint tokens<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span> <span class="token punctuation">(</span>bool success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">transferFrom</span><span class="token punctuation">(</span>address <span class="token keyword">from</span><span class="token punctuation">,</span> address to<span class="token punctuation">,</span> uint tokens<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token function">returns</span> <span class="token punctuation">(</span>bool success<span class="token punctuation">)</span><span class="token punctuation">;</span>


    event <span class="token function">Transfer</span><span class="token punctuation">(</span>address indexed <span class="token keyword">from</span><span class="token punctuation">,</span> address indexed to<span class="token punctuation">,</span> uint tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
    event <span class="token function">Approval</span><span class="token punctuation">(</span>address indexed tokenOwner<span class="token punctuation">,</span> address indexed spender<span class="token punctuation">,</span> uint tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>ABI 全称是 Application Binary Interface，它就是合约接口的描述，因此有了合约的接口定义，就可以很容易通过编译拿到ABI 信息，比如像下图在Remix 的编译选项卡就可以直接复制ABI。</p> 
  <p><img src="https://learnblockchain.cn/media/15403775499051.jpg" alt=""></p> 
  <p>生成的 ABI 描述大概长这样：</p> 
  <pre><code class="prism language-js"><span class="token punctuation">[</span>
<span class="token operator">...</span>
	<span class="token punctuation">{</span>
		<span class="token string">"constant"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token string">"inputs"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"totalSupply"</span><span class="token punctuation">,</span>
		<span class="token string">"outputs"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span>
				<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
				<span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"uint256"</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">"payable"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token string">"stateMutability"</span><span class="token punctuation">:</span> <span class="token string">"view"</span><span class="token punctuation">,</span>
		<span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"function"</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span>
		<span class="token string">"constant"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
		<span class="token string">"inputs"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span>
				<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"tokenOwner"</span><span class="token punctuation">,</span>
				<span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"address"</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"balanceOf"</span><span class="token punctuation">,</span>
		<span class="token string">"outputs"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
			<span class="token punctuation">{</span>
				<span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"balance"</span><span class="token punctuation">,</span>
				<span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"uint256"</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">]</span><span class="token punctuation">,</span>
		<span class="token string">"payable"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
		<span class="token string">"stateMutability"</span><span class="token punctuation">:</span> <span class="token string">"view"</span><span class="token punctuation">,</span>
		<span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"function"</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token operator">...</span>
<span class="token punctuation">]</span>
</code></pre> 
  <p>它是一个JSON形式的数组，数组里每一个元素，都是对函数接口的描述，在外部调用合约的时候就需要遵从这个接口，以上面的接口为例，通常一个接口描述包含下述几个字段：</p> 
  <ul> 
   <li>name: 函数会事件的名称</li> 
   <li>type: 可取值有function，constructor，fallback，event</li> 
   <li>inputs: 函数的输入参数，每个参数对象包含下述属性： 
    <ul> 
     <li>name: 参数名称</li> 
     <li>type: 参数的规范型(Canonical Type)。</li> 
    </ul> </li> 
   <li>outputs: 一系列的类似inputs的对象，如果无返回值时，可以省略。</li> 
   <li>constant: true表示函数声明自己不会改变状态变量的值。</li> 
   <li>payable: true表示函数可以接收ether，否则表示不能。</li> 
  </ul> 
  <p>接下来在构造合约对象就需要是使用ABI。</p> 
  <h2><a id="_91"></a>构造合约对象</h2> 
  <p>ethers.js 构造合约对象很简单，仅需要提供三个参数给ethers.Contract构造函数，代码如下：</p> 
  <pre><code class="prism language-js"> <span class="token keyword">var</span> abi <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> addr <span class="token operator">=</span> <span class="token string">"0x..."</span><span class="token punctuation">;</span>
 <span class="token keyword">var</span> contract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers<span class="token punctuation">.</span>Contract</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> abi<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
  <p>合约的地址在合约部署之后，可以获得，关于Token合约部署及ERC20相关的概念，这里不展开讲，不熟悉的同学，可以参考我另一篇文章<a href="https://learnblockchain.cn/2018/01/12/create_token/" rel="nofollow">创建自己的数字货币</a>。</p> 
  <p>只有就可以是使用 <code>contract</code> 对象来调用Token合约的函数。</p> 
  <h2><a id="TokenToken_106"></a>获取Token余额及转移Token</h2> 
  <h3><a id="Token_108"></a>获取Token余额</h3> 
  <p>结合UI来实现以下获取Token余额，UI如下：</p> 
  <p><img src="https://learnblockchain.cn/media/15405195250777.jpg" alt=""></p> 
  <p>在HTML里，定义的标签如下：</p> 
  <pre><code class="prism language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>TT Token:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">readonly</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readonly<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>readonly<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wallet-token-balance<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0.0<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
  <p>对应的逻辑代码也很简单：</p> 
  <pre><code class="prism language-js">     <span class="token keyword">var</span> tokenBalance <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#wallet-token-balance'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 直接调用合约方法</span>
    contract<span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span>activeWallet<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span><span class="token punctuation">{</span>
        tokenBalance<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
  <h3><a id="Token_136"></a>转移Token</h3> 
  <p>转移Token的UI效果如下：</p> 
  <p><img src="https://learnblockchain.cn/media/15405195493994.jpg" alt=""></p> 
  <p>界面的HTML代码如下：</p> 
  <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>转移代币:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>发送至:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(target address)<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wallet-token-send-target-address<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>th</span><span class="token punctuation">&gt;</span></span>金额:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>th</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>(amount)<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wallet-token-send-amount<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>wallet-token-submit-send<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit disable<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>发送<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
  <p>上面定义了两个文本输入框及一个“发送“按钮，在逻辑处理部分，转移Token代币尽管和获取余额类似，同样是调用合约的方法，不过转移代币需要发起一个交易，因此需要测量gas 消耗。<br> 点击发送时运行一下（关键）代码：</p> 
  <pre><code class="prism language-js"><span class="token keyword">var</span> inputTargetAddress <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#wallet-token-send-target-address'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> inputAmount <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#wallet-token-send-amount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> submit <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#wallet-token-submit-send'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> targetAddress <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span>inputTargetAddress<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> amount <span class="token operator">=</span> inputAmount<span class="token punctuation">.</span><span class="token function">val</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

submit<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 先计算transfer 需要的gas 消耗量，这一步有默认值，非必须。</span>
    contract<span class="token punctuation">.</span>estimate<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>targetAddress<span class="token punctuation">,</span> amount<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>gas<span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token comment">// 必须关联一个有过签名钱包对象</span>
          <span class="token keyword">let</span> contractWithSigner <span class="token operator">=</span> contract<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>activeWallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 发起交易，前面2个参数是函数的参数，第3个是交易参数</span>
          contractWithSigner<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>targetAddress<span class="token punctuation">,</span> amount<span class="token punctuation">,</span> <span class="token punctuation">{</span>
              gasLimit<span class="token punctuation">:</span> gas<span class="token punctuation">,</span>
              <span class="token comment">// 偷懒，直接是用 2gwei</span>
              gasPrice<span class="token punctuation">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseUnits</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token string">"gwei"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 介绍刷新上面的Token余额，重置输入框</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>上述有一个地方都要注意一下，在合约调用 transfer 之前， 需要连接一个<strong>signer</strong>，因为发起交易的时候需要用它来进行签名，在ethers.js API里 Wallet 是 signer（抽象类）的实现类。</p> 
  <blockquote> 
   <p>所有会更改区块链数据的函数都需要关联签名器，如果是视图函数则只需要连接provider。</p> 
  </blockquote> 
  <p>ethers.js 的 Contract 提供了一个非常方便方法：<code>contract.estimate.functionName</code> 来计算预测交易的gasLimit。</p> 
  <p>在发起交易的时候，可以提供一个可选的<a href="https://docs.ethers.io/ethers.js/html/api-contract.html?highlight=estimate#overrides" rel="nofollow">Overrides</a>参数，在这个参数里可以指定如交易的 gasLimit 、 gasPrice，如果我们不指定这个参数时，会默认使用 contract.estimate 获得的值作为 gasLimit，以及 provider.getGasPrice() 的值来指定 gasPrice。</p> 
  <p>哈哈，恭喜大家，到这里这里就完整的实现了一个基于以太坊去中心化网页钱包。</p> 
  <p>这是一条硬广，欢迎订阅<a href="https://xiaozhuanlan.com/blockchaincore" rel="nofollow">深入浅出区块链技术小专栏</a>，目前仅需69元， 订阅就可以查看完整源码，还有其他惊喜哦~。<br> 戳链接收看<a href="https://ke.qq.com/course/356068?tuin=bd898bbf" rel="nofollow">详细的视频课程讲解</a>。</p> 
  <h2><a id="_209"></a>参考文档</h2> 
  <ol> 
   <li><a href="https://docs.ethers.io/ethers.js/html" rel="nofollow">Ethers.js</a></li> 
  </ol> 
  <p><a href="https://learnblockchain.cn/" rel="nofollow">深入浅出区块链</a> - 系统学习区块链，打造最好的区块链技术博客。</p> 
  <p><a href="https://t.xiaomiquan.com/RfAu7uj" rel="nofollow">深入浅出区块链知识星球</a>最专业技术问答社区，加入社区还可以在微信群里和300多位区块链技术爱好者一起交流。</p> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-2b43bc2447.css" rel="stylesheet"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/xilibi2003/article/details/83932241,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/xilibi2003/article/details/83932241,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										if(typeof window.localStorage === "object" && typeof window.csdn.anonymousUserLimit === "object"){
											if(!window.csdn.anonymousUserLimit.judgment()){
												window.csdn.anonymousUserLimit.Jumplogin();
												return false;
											}else if(!currentUserName){
												window.csdn.anonymousUserLimit.updata();
											}
										}
										
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
