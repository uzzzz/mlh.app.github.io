<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>以太坊众筹项目合约以及部署01 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="以太坊众筹项目合约以及部署01" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="智能合约众筹实战 ###淘宝众筹, 京东众筹 https://izhongchou.taobao.com/index.htm https://kickstarter.com ###分析商业模式 解决京东众筹的痛点 https://z.jd.com/project/details/105705.html 期望的金钱流动 真实的金钱流动 控制金钱流动的方向, 速度. 众筹的金钱 进入智能合约中 每一笔开销,都要发起付款申请 投资人support付款申请. 带界面的众筹交互项目-React -&gt; 3 web3js操作以太坊网络 -&gt; 2 众筹合约 -&gt; 1 智能合约的其他扩展设计 选举投票决定项目是否继续进行 任何众筹项目都面临团队不负责任或者项目仅仅是一个骗局的风险，任何中心化投票系统都面临安全问题、贿赂选票和其他博弈上的缺陷。在 区块链系统中，这些风险都得到了最小化。 https://baijiahao.baidu.com/s?id=1606757323732765805&amp;wfr=spider 成员变量设计 名称 数据类型 说明 manager address 众筹发起人地址(众筹发起人) projectName string 项目名称 supportMoney uint 众筹参与人需要付的钱 endTime uint 默认众筹结束的时间,为众筹发起后的一个月 goalMoney uint 目标募集的资金(endTime后,达不到目标则众筹失败) players address[] 众筹参与人的数组 requests Request[] 付款请求申请的数组 ###函数设计 函数名称 函数说明 Funding 构造函数 support 我要支持(需要付钱) createRequest 付款申请函数,由众筹发起人调用 approveRequest 付款批准函数, 由众筹参与人调用 finalizeRequest 众筹发起人调用, 可以调用完成付款 moneyBack 退钱函数, 由众筹发起人调用(众筹未成功时调用) 众筹智能合约的构造函数 pragma solidity ^0.4.17; contract Funding{ address public manager; string public projectName; uint public supportMoney; uint public endTime; uint public goalMoney; address[] public players; function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; manager = msg.sender; } } 众筹支持逻辑 address[] public players; function support() public payable{ require(msg.value == supportMoney ); players.push(msg.sender); } #测试一下support函数 查看当前智能合约余额 查看当前众筹参与人员players信息 查看当前众筹参与人员players的个数 获取剩余天数 检查众筹状态 付款的Request结构体 name type 说明 description string 描述这笔付款请求是干啥的 money uint 花多少钱, 钱要少于balance shopAddress address 钱汇给谁. 真正的收钱方 complete bool true代表当前付款请求已经处理完毕 ??? ??? 投票机制(大家先思考, 由众筹参与者决定) struct Request{ string description; uint money; address shopAddress; bool complete; } createRequest 只有经理可以createRequest function createRequest(string _description, uint _money, address _shopAddress) public{ Request request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false }); requests.push(request); } memory和storage storage memory ##两种概念 智能合约如何存储数据, 是在memory还是storage solidity变量如何存储数据, 是在memory还是在storage ##智能合约的数据存储 storage : 成员变量. 可以跨函数调用. 有点类似于硬盘 memory: 临时数据存储, 类似于电脑的内存 函数的参数可以理解为memory类型 ##solidity变量的数据存储 值传递和引用传递 memory值传递 storage引用传递 pragma solidity ^0.4.25; contract Test{ uint[] public array; function test() public{ array.push(11); array.push(22); // 引用传递 默认是storage, aa修改值会改变原来的数组值 uint[] aa = array; aa[0] = 666; // change(array); } // 值传递 默认 memory 内存复制的新对象, arr修改值不会改变原数组 function change(uint[] arr) { arr[0] = 888; } // 强制改成storage类型, 必须声明成private, 合约内部函数才可调用, 此时可以修改原数组array的内容 function change2(uint[] storage arr) private{ arr[0] = 888; } function getArray() public view returns(uint[]) { uint i = 9; return array; } } 投票系统需求 防止一个人重复投票 投票的人可能有很多(成千上万人) 投票系统设计稿 业务逻辑 检查某个人是否已经在众筹参与人列表里面 没参与众筹没给钱,投个屁的票啊 检查某个人是不是已经投过票了 一人一票不得违反 #投票逻辑的致命问题 有一些小砖（每块1英寸）和大砖（每块5英寸）,我们想砌出来指定长度的墙， 如果用我们选择的砖块的数量能够拼接成功，则返回true；否则返回false， 例如：makeBricks(3, 1, 8) → true 测试用例 (每行显示一条测试用例，格式为(参数1,参数2) -&gt; 期望结果) [test.suits] (3, 1, 8) -&gt; true (3, 1, 9) -&gt; false (3, 2, 10) -&gt; true (3, 2, 8) -&gt; true (3, 2, 9) -&gt; false (6, 1, 11) -&gt; true (6, 0, 11) -&gt; false (1, 4, 11) -&gt; true (0, 3, 10) -&gt; true (1, 4, 12) -&gt; false (3, 1, 7) -&gt; true (1, 1, 7) -&gt; false (2, 1, 7) -&gt; true (7, 1, 11) -&gt; true (7, 1, 8) -&gt; true (7, 1, 13) -&gt; false (43, 1, 46) -&gt; true (40, 1, 46) -&gt; false (40, 2, 47) -&gt; true (40, 2, 50) -&gt; true (40, 2, 52) -&gt; false (22, 2, 33) -&gt; false (0, 2, 10) -&gt; true (1000000, 1000, 1000100) -&gt; true (2, 1000000, 100003) -&gt; false (20, 0, 19) -&gt; true (20, 0, 21) -&gt; false (20, 4, 51) -&gt; false (20, 4, 39) -&gt; true 代码运行的效率 vs 手续费 时间和金钱 #mapping重构代码 pragma solidity ^0.4.17; contract Funding{ address public manager; string public projectName; uint public supportMoney; uint public endTime; uint public goalMoney; address[] public players; mapping(address =&gt; bool) playersMap; Request[] public requests; struct Request{ string description; uint money; address shopAddress; bool complete; mapping(address=&gt;bool) approvedPlayers; uint count; } function createRequest(string _description, uint _money, address _shopAddress) public{ require(msg.sender == manager); Request memory request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false, count:0 }); requests.push(request); } function approveRequest(uint id) public{ require(playersMap[msg.sender]); require(!requests[id].approvedPlayers[msg.sender]); requests[id].count++; requests[id].approvedPlayers[msg.sender] = true; } function finalizeRequest(uint id) public{ require(msg.sender == manager); require(requests[id].count*2&gt;players.length); require(requests[id].money&lt;=this.balance); require(!requests[id].complete ); requests[id].shopAddress.transfer(requests[id].money); requests[id].complete = true; } function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; manager = msg.sender; } function support() public payable{ require(msg.value == supportMoney ); players.push(msg.sender); playersMap[msg.sender] = true; } function getAccountBalance() public view returns(uint){ return this.balance; } } #智能合约的部署 代理模式, 服务器代理部署(钱服务器花) 用户直接模式, 用户直接部署.(钱用户花) contract FundingFactory{ address[] public fundingAddress; function createFunding(string _projectName,uint _supportMoney,uint _goalMoney) public{ address funding = new Funding(_projectName,_supportMoney,_goalMoney,msg.sender); fundingAddress.push(funding); } } web3js 的函数封装 #附件 第一版 pragma solidity ^0.4.17; contract Funding{ bool flag = false; //众筹发起人地址(众筹发起人) address public manager; //项目名称 string public projectName; //众筹参与人需要付的钱 uint public supportMoney; // 众筹结束的时间 uint public endTime; // 目标募集的资金(endTime后,达不到目标则众筹失败) uint public goalMoney; // 众筹参与人的数组 address[] public players; //付款请求申请的数组(由众筹发起人申请) Request[] public requets; // 付款请求的结构体 struct Request{ string description; // 为什么要付款 uint money; // 花多少钱 address shopAddress; // 卖家的钱包 地址 bool complete; // 付款是否已经完成 address[] votedAddress; // 哪些已经投过票的人 uint voteCount; // 投票的总的总数 } function createRequest( string _description, uint _money, address _shopAddress) public onlyManagerCanCall{ require(this.balance &gt;= _money); Request memory request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false, votedAddress: new address[](0), voteCount : 0 }); requets.push(request); } // 众筹参与人员批准某一笔付款 ( index数组的下标 ) function approveRequest(uint index) public { Request storage request = requets[index]; bool supporter = false; //1. 检查某个人是否已经在众筹参与人列表里面 for(uint i = 0;i&lt;players.length;i++){ if( players[i] == msg.sender){ supporter = true; } } require(supporter); //2 .检查某个人是不是已经投过票了 bool voted = false; for(uint j = 0; j&lt;request.votedAddress.length;j++){ if( request.votedAddress[j] == msg.sender){ voted = true; } } require(!voted); request. voteCount ++; request.votedAddress.push(msg.sender); } // 构造函数 function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ manager = msg.sender; projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; } // 参与人支持众筹 function support() public payable{ require(msg.value == 79); players.push(msg.sender); } // 返回参与人的数量 function getPlayersCount() public view returns(uint){ return players.length; } function getPlayers() public view returns(address[]){ return players; } function getTotalBalance() public view returns (uint){ return this.balance; } function getRemainDays() public view returns(uint){ return (endTime - now)/24/60/60; } function checkStatus() public { require(!flag); require(now &gt; endTime); require(this.balance &gt; goalMoney); flag = true; } modifier onlyManagerCanCall(){ require(msg.sender == manager); _; } } ##全套代码 pragma solidity ^0.4.25; contract FundingFactory { //存储所有已经部署的智能合约的地址 address[] public fundings; function createFunding(string _projectName, uint _supportMoney, uint _goalMoney) public { address funding = new Funding(_projectName, _supportMoney, _goalMoney, msg.sender); fundings.push(funding); } function getFundings() public view returns(address[]){ return fundings; } } contract Funding { // 众筹成功标记 bool public flag = false; // 众筹发起人地址(众筹发起人) address public manager; // 项目名称 string public projectName; // 众筹参与人需要付的钱 uint public supportMoney; // 目标募集的资金(endTime后,达不到目标则众筹失败) uint public goalMoney; // 默认众筹结束的时间,为众筹发起后的一个月 uint public endTime; // 众筹参与人的数组 address[] public players; mapping(address=&gt;bool) playersMap; // 付款请求的数组 Request[] public requests; struct Request { // 描述这笔付款请求是干啥的 string description; // 花多少钱, 钱要少于balance uint money; // 钱汇给谁. 真正的收钱方 address shopAddress; // 代表当前付款请求已经处理完毕 bool complete; // 已投票的用户地址 mapping(address=&gt;bool) votedMap; uint votedCount; } //构造函数 constructor(string _projectName, uint _supportMoney, uint _goalMoney, address sender) public{ manager = sender; projectName =_projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; } // 我要支持(需要付钱) function support() public payable{ require(msg.value == supportMoney); // 放进集合中 players.push(msg.sender); playersMap[msg.sender] = true; } // 付款申请函数,由众筹发起人调用 function createRequest(string _description, uint _money, address _shopAddress) public onlyManagerCanCall{ // 余额大于等于付款请求 require(address(this).balance &gt;= _money); Request memory request = Request({ description: _description, money: _money, shopAddress: _shopAddress, complete: false, votedCount: 0 }); requests.push(request); } // 付款批准函数, 由众筹参与人调用 function approveRequest(uint index) public { // 是否是众筹参与者 require(playersMap[msg.sender]); // 防止一个人重复投票 Request storage request = requests[index]; require(!request.votedMap[msg.sender]); request.votedMap[msg.sender] = true; request.votedCount++; } // 众筹发起人调用, 可以调用完成付款 function finalizeRequest(uint index) public onlyManagerCanCall{ Request storage request = requests[index]; require(!request.complete); // 钱够 require(address(this).balance &gt;= request.money); // 人数过半 require(request.votedCount * 2 &gt;= getPlayersCount()); // 执行转账操作 request.shopAddress.transfer(request.money); request.complete = true; } // 所有参与者 function getPlayers() public view returns(address[]){ return players; } // 所有参与者个数 function getPlayersCount() public view returns(uint){ return players.length; } // 获取合约的余额 function getTotalBalance() public view returns(uint){ return address(this).balance; } // 获取剩余天数 function getRemainDays() public view returns(uint) { return (endTime - now) / 60 / 60 / 24; } // 检查众筹状态 function checkStatus() public onlyManagerCanCall { require(!flag); // 到期 require(now &gt;= endTime); // getTotalBalance金额&gt;= goalMoney require(address(this).balance &gt;= goalMoney); flag = true; } modifier onlyManagerCanCall { require(msg.sender == manager); _; } } es6 大神阮一峰的文章 http://es6.ruanyifeng.com/#docs/module#export-default-命令 代码战争: https://www.codewars.com 阅读更多" />
<meta property="og:description" content="智能合约众筹实战 ###淘宝众筹, 京东众筹 https://izhongchou.taobao.com/index.htm https://kickstarter.com ###分析商业模式 解决京东众筹的痛点 https://z.jd.com/project/details/105705.html 期望的金钱流动 真实的金钱流动 控制金钱流动的方向, 速度. 众筹的金钱 进入智能合约中 每一笔开销,都要发起付款申请 投资人support付款申请. 带界面的众筹交互项目-React -&gt; 3 web3js操作以太坊网络 -&gt; 2 众筹合约 -&gt; 1 智能合约的其他扩展设计 选举投票决定项目是否继续进行 任何众筹项目都面临团队不负责任或者项目仅仅是一个骗局的风险，任何中心化投票系统都面临安全问题、贿赂选票和其他博弈上的缺陷。在 区块链系统中，这些风险都得到了最小化。 https://baijiahao.baidu.com/s?id=1606757323732765805&amp;wfr=spider 成员变量设计 名称 数据类型 说明 manager address 众筹发起人地址(众筹发起人) projectName string 项目名称 supportMoney uint 众筹参与人需要付的钱 endTime uint 默认众筹结束的时间,为众筹发起后的一个月 goalMoney uint 目标募集的资金(endTime后,达不到目标则众筹失败) players address[] 众筹参与人的数组 requests Request[] 付款请求申请的数组 ###函数设计 函数名称 函数说明 Funding 构造函数 support 我要支持(需要付钱) createRequest 付款申请函数,由众筹发起人调用 approveRequest 付款批准函数, 由众筹参与人调用 finalizeRequest 众筹发起人调用, 可以调用完成付款 moneyBack 退钱函数, 由众筹发起人调用(众筹未成功时调用) 众筹智能合约的构造函数 pragma solidity ^0.4.17; contract Funding{ address public manager; string public projectName; uint public supportMoney; uint public endTime; uint public goalMoney; address[] public players; function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; manager = msg.sender; } } 众筹支持逻辑 address[] public players; function support() public payable{ require(msg.value == supportMoney ); players.push(msg.sender); } #测试一下support函数 查看当前智能合约余额 查看当前众筹参与人员players信息 查看当前众筹参与人员players的个数 获取剩余天数 检查众筹状态 付款的Request结构体 name type 说明 description string 描述这笔付款请求是干啥的 money uint 花多少钱, 钱要少于balance shopAddress address 钱汇给谁. 真正的收钱方 complete bool true代表当前付款请求已经处理完毕 ??? ??? 投票机制(大家先思考, 由众筹参与者决定) struct Request{ string description; uint money; address shopAddress; bool complete; } createRequest 只有经理可以createRequest function createRequest(string _description, uint _money, address _shopAddress) public{ Request request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false }); requests.push(request); } memory和storage storage memory ##两种概念 智能合约如何存储数据, 是在memory还是storage solidity变量如何存储数据, 是在memory还是在storage ##智能合约的数据存储 storage : 成员变量. 可以跨函数调用. 有点类似于硬盘 memory: 临时数据存储, 类似于电脑的内存 函数的参数可以理解为memory类型 ##solidity变量的数据存储 值传递和引用传递 memory值传递 storage引用传递 pragma solidity ^0.4.25; contract Test{ uint[] public array; function test() public{ array.push(11); array.push(22); // 引用传递 默认是storage, aa修改值会改变原来的数组值 uint[] aa = array; aa[0] = 666; // change(array); } // 值传递 默认 memory 内存复制的新对象, arr修改值不会改变原数组 function change(uint[] arr) { arr[0] = 888; } // 强制改成storage类型, 必须声明成private, 合约内部函数才可调用, 此时可以修改原数组array的内容 function change2(uint[] storage arr) private{ arr[0] = 888; } function getArray() public view returns(uint[]) { uint i = 9; return array; } } 投票系统需求 防止一个人重复投票 投票的人可能有很多(成千上万人) 投票系统设计稿 业务逻辑 检查某个人是否已经在众筹参与人列表里面 没参与众筹没给钱,投个屁的票啊 检查某个人是不是已经投过票了 一人一票不得违反 #投票逻辑的致命问题 有一些小砖（每块1英寸）和大砖（每块5英寸）,我们想砌出来指定长度的墙， 如果用我们选择的砖块的数量能够拼接成功，则返回true；否则返回false， 例如：makeBricks(3, 1, 8) → true 测试用例 (每行显示一条测试用例，格式为(参数1,参数2) -&gt; 期望结果) [test.suits] (3, 1, 8) -&gt; true (3, 1, 9) -&gt; false (3, 2, 10) -&gt; true (3, 2, 8) -&gt; true (3, 2, 9) -&gt; false (6, 1, 11) -&gt; true (6, 0, 11) -&gt; false (1, 4, 11) -&gt; true (0, 3, 10) -&gt; true (1, 4, 12) -&gt; false (3, 1, 7) -&gt; true (1, 1, 7) -&gt; false (2, 1, 7) -&gt; true (7, 1, 11) -&gt; true (7, 1, 8) -&gt; true (7, 1, 13) -&gt; false (43, 1, 46) -&gt; true (40, 1, 46) -&gt; false (40, 2, 47) -&gt; true (40, 2, 50) -&gt; true (40, 2, 52) -&gt; false (22, 2, 33) -&gt; false (0, 2, 10) -&gt; true (1000000, 1000, 1000100) -&gt; true (2, 1000000, 100003) -&gt; false (20, 0, 19) -&gt; true (20, 0, 21) -&gt; false (20, 4, 51) -&gt; false (20, 4, 39) -&gt; true 代码运行的效率 vs 手续费 时间和金钱 #mapping重构代码 pragma solidity ^0.4.17; contract Funding{ address public manager; string public projectName; uint public supportMoney; uint public endTime; uint public goalMoney; address[] public players; mapping(address =&gt; bool) playersMap; Request[] public requests; struct Request{ string description; uint money; address shopAddress; bool complete; mapping(address=&gt;bool) approvedPlayers; uint count; } function createRequest(string _description, uint _money, address _shopAddress) public{ require(msg.sender == manager); Request memory request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false, count:0 }); requests.push(request); } function approveRequest(uint id) public{ require(playersMap[msg.sender]); require(!requests[id].approvedPlayers[msg.sender]); requests[id].count++; requests[id].approvedPlayers[msg.sender] = true; } function finalizeRequest(uint id) public{ require(msg.sender == manager); require(requests[id].count*2&gt;players.length); require(requests[id].money&lt;=this.balance); require(!requests[id].complete ); requests[id].shopAddress.transfer(requests[id].money); requests[id].complete = true; } function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; manager = msg.sender; } function support() public payable{ require(msg.value == supportMoney ); players.push(msg.sender); playersMap[msg.sender] = true; } function getAccountBalance() public view returns(uint){ return this.balance; } } #智能合约的部署 代理模式, 服务器代理部署(钱服务器花) 用户直接模式, 用户直接部署.(钱用户花) contract FundingFactory{ address[] public fundingAddress; function createFunding(string _projectName,uint _supportMoney,uint _goalMoney) public{ address funding = new Funding(_projectName,_supportMoney,_goalMoney,msg.sender); fundingAddress.push(funding); } } web3js 的函数封装 #附件 第一版 pragma solidity ^0.4.17; contract Funding{ bool flag = false; //众筹发起人地址(众筹发起人) address public manager; //项目名称 string public projectName; //众筹参与人需要付的钱 uint public supportMoney; // 众筹结束的时间 uint public endTime; // 目标募集的资金(endTime后,达不到目标则众筹失败) uint public goalMoney; // 众筹参与人的数组 address[] public players; //付款请求申请的数组(由众筹发起人申请) Request[] public requets; // 付款请求的结构体 struct Request{ string description; // 为什么要付款 uint money; // 花多少钱 address shopAddress; // 卖家的钱包 地址 bool complete; // 付款是否已经完成 address[] votedAddress; // 哪些已经投过票的人 uint voteCount; // 投票的总的总数 } function createRequest( string _description, uint _money, address _shopAddress) public onlyManagerCanCall{ require(this.balance &gt;= _money); Request memory request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false, votedAddress: new address[](0), voteCount : 0 }); requets.push(request); } // 众筹参与人员批准某一笔付款 ( index数组的下标 ) function approveRequest(uint index) public { Request storage request = requets[index]; bool supporter = false; //1. 检查某个人是否已经在众筹参与人列表里面 for(uint i = 0;i&lt;players.length;i++){ if( players[i] == msg.sender){ supporter = true; } } require(supporter); //2 .检查某个人是不是已经投过票了 bool voted = false; for(uint j = 0; j&lt;request.votedAddress.length;j++){ if( request.votedAddress[j] == msg.sender){ voted = true; } } require(!voted); request. voteCount ++; request.votedAddress.push(msg.sender); } // 构造函数 function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ manager = msg.sender; projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; } // 参与人支持众筹 function support() public payable{ require(msg.value == 79); players.push(msg.sender); } // 返回参与人的数量 function getPlayersCount() public view returns(uint){ return players.length; } function getPlayers() public view returns(address[]){ return players; } function getTotalBalance() public view returns (uint){ return this.balance; } function getRemainDays() public view returns(uint){ return (endTime - now)/24/60/60; } function checkStatus() public { require(!flag); require(now &gt; endTime); require(this.balance &gt; goalMoney); flag = true; } modifier onlyManagerCanCall(){ require(msg.sender == manager); _; } } ##全套代码 pragma solidity ^0.4.25; contract FundingFactory { //存储所有已经部署的智能合约的地址 address[] public fundings; function createFunding(string _projectName, uint _supportMoney, uint _goalMoney) public { address funding = new Funding(_projectName, _supportMoney, _goalMoney, msg.sender); fundings.push(funding); } function getFundings() public view returns(address[]){ return fundings; } } contract Funding { // 众筹成功标记 bool public flag = false; // 众筹发起人地址(众筹发起人) address public manager; // 项目名称 string public projectName; // 众筹参与人需要付的钱 uint public supportMoney; // 目标募集的资金(endTime后,达不到目标则众筹失败) uint public goalMoney; // 默认众筹结束的时间,为众筹发起后的一个月 uint public endTime; // 众筹参与人的数组 address[] public players; mapping(address=&gt;bool) playersMap; // 付款请求的数组 Request[] public requests; struct Request { // 描述这笔付款请求是干啥的 string description; // 花多少钱, 钱要少于balance uint money; // 钱汇给谁. 真正的收钱方 address shopAddress; // 代表当前付款请求已经处理完毕 bool complete; // 已投票的用户地址 mapping(address=&gt;bool) votedMap; uint votedCount; } //构造函数 constructor(string _projectName, uint _supportMoney, uint _goalMoney, address sender) public{ manager = sender; projectName =_projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; } // 我要支持(需要付钱) function support() public payable{ require(msg.value == supportMoney); // 放进集合中 players.push(msg.sender); playersMap[msg.sender] = true; } // 付款申请函数,由众筹发起人调用 function createRequest(string _description, uint _money, address _shopAddress) public onlyManagerCanCall{ // 余额大于等于付款请求 require(address(this).balance &gt;= _money); Request memory request = Request({ description: _description, money: _money, shopAddress: _shopAddress, complete: false, votedCount: 0 }); requests.push(request); } // 付款批准函数, 由众筹参与人调用 function approveRequest(uint index) public { // 是否是众筹参与者 require(playersMap[msg.sender]); // 防止一个人重复投票 Request storage request = requests[index]; require(!request.votedMap[msg.sender]); request.votedMap[msg.sender] = true; request.votedCount++; } // 众筹发起人调用, 可以调用完成付款 function finalizeRequest(uint index) public onlyManagerCanCall{ Request storage request = requests[index]; require(!request.complete); // 钱够 require(address(this).balance &gt;= request.money); // 人数过半 require(request.votedCount * 2 &gt;= getPlayersCount()); // 执行转账操作 request.shopAddress.transfer(request.money); request.complete = true; } // 所有参与者 function getPlayers() public view returns(address[]){ return players; } // 所有参与者个数 function getPlayersCount() public view returns(uint){ return players.length; } // 获取合约的余额 function getTotalBalance() public view returns(uint){ return address(this).balance; } // 获取剩余天数 function getRemainDays() public view returns(uint) { return (endTime - now) / 60 / 60 / 24; } // 检查众筹状态 function checkStatus() public onlyManagerCanCall { require(!flag); // 到期 require(now &gt;= endTime); // getTotalBalance金额&gt;= goalMoney require(address(this).balance &gt;= goalMoney); flag = true; } modifier onlyManagerCanCall { require(msg.sender == manager); _; } } es6 大神阮一峰的文章 http://es6.ruanyifeng.com/#docs/module#export-default-命令 代码战争: https://www.codewars.com 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-10T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"智能合约众筹实战 ###淘宝众筹, 京东众筹 https://izhongchou.taobao.com/index.htm https://kickstarter.com ###分析商业模式 解决京东众筹的痛点 https://z.jd.com/project/details/105705.html 期望的金钱流动 真实的金钱流动 控制金钱流动的方向, 速度. 众筹的金钱 进入智能合约中 每一笔开销,都要发起付款申请 投资人support付款申请. 带界面的众筹交互项目-React -&gt; 3 web3js操作以太坊网络 -&gt; 2 众筹合约 -&gt; 1 智能合约的其他扩展设计 选举投票决定项目是否继续进行 任何众筹项目都面临团队不负责任或者项目仅仅是一个骗局的风险，任何中心化投票系统都面临安全问题、贿赂选票和其他博弈上的缺陷。在 区块链系统中，这些风险都得到了最小化。 https://baijiahao.baidu.com/s?id=1606757323732765805&amp;wfr=spider 成员变量设计 名称 数据类型 说明 manager address 众筹发起人地址(众筹发起人) projectName string 项目名称 supportMoney uint 众筹参与人需要付的钱 endTime uint 默认众筹结束的时间,为众筹发起后的一个月 goalMoney uint 目标募集的资金(endTime后,达不到目标则众筹失败) players address[] 众筹参与人的数组 requests Request[] 付款请求申请的数组 ###函数设计 函数名称 函数说明 Funding 构造函数 support 我要支持(需要付钱) createRequest 付款申请函数,由众筹发起人调用 approveRequest 付款批准函数, 由众筹参与人调用 finalizeRequest 众筹发起人调用, 可以调用完成付款 moneyBack 退钱函数, 由众筹发起人调用(众筹未成功时调用) 众筹智能合约的构造函数 pragma solidity ^0.4.17; contract Funding{ address public manager; string public projectName; uint public supportMoney; uint public endTime; uint public goalMoney; address[] public players; function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; manager = msg.sender; } } 众筹支持逻辑 address[] public players; function support() public payable{ require(msg.value == supportMoney ); players.push(msg.sender); } #测试一下support函数 查看当前智能合约余额 查看当前众筹参与人员players信息 查看当前众筹参与人员players的个数 获取剩余天数 检查众筹状态 付款的Request结构体 name type 说明 description string 描述这笔付款请求是干啥的 money uint 花多少钱, 钱要少于balance shopAddress address 钱汇给谁. 真正的收钱方 complete bool true代表当前付款请求已经处理完毕 ??? ??? 投票机制(大家先思考, 由众筹参与者决定) struct Request{ string description; uint money; address shopAddress; bool complete; } createRequest 只有经理可以createRequest function createRequest(string _description, uint _money, address _shopAddress) public{ Request request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false }); requests.push(request); } memory和storage storage memory ##两种概念 智能合约如何存储数据, 是在memory还是storage solidity变量如何存储数据, 是在memory还是在storage ##智能合约的数据存储 storage : 成员变量. 可以跨函数调用. 有点类似于硬盘 memory: 临时数据存储, 类似于电脑的内存 函数的参数可以理解为memory类型 ##solidity变量的数据存储 值传递和引用传递 memory值传递 storage引用传递 pragma solidity ^0.4.25; contract Test{ uint[] public array; function test() public{ array.push(11); array.push(22); // 引用传递 默认是storage, aa修改值会改变原来的数组值 uint[] aa = array; aa[0] = 666; // change(array); } // 值传递 默认 memory 内存复制的新对象, arr修改值不会改变原数组 function change(uint[] arr) { arr[0] = 888; } // 强制改成storage类型, 必须声明成private, 合约内部函数才可调用, 此时可以修改原数组array的内容 function change2(uint[] storage arr) private{ arr[0] = 888; } function getArray() public view returns(uint[]) { uint i = 9; return array; } } 投票系统需求 防止一个人重复投票 投票的人可能有很多(成千上万人) 投票系统设计稿 业务逻辑 检查某个人是否已经在众筹参与人列表里面 没参与众筹没给钱,投个屁的票啊 检查某个人是不是已经投过票了 一人一票不得违反 #投票逻辑的致命问题 有一些小砖（每块1英寸）和大砖（每块5英寸）,我们想砌出来指定长度的墙， 如果用我们选择的砖块的数量能够拼接成功，则返回true；否则返回false， 例如：makeBricks(3, 1, 8) → true 测试用例 (每行显示一条测试用例，格式为(参数1,参数2) -&gt; 期望结果) [test.suits] (3, 1, 8) -&gt; true (3, 1, 9) -&gt; false (3, 2, 10) -&gt; true (3, 2, 8) -&gt; true (3, 2, 9) -&gt; false (6, 1, 11) -&gt; true (6, 0, 11) -&gt; false (1, 4, 11) -&gt; true (0, 3, 10) -&gt; true (1, 4, 12) -&gt; false (3, 1, 7) -&gt; true (1, 1, 7) -&gt; false (2, 1, 7) -&gt; true (7, 1, 11) -&gt; true (7, 1, 8) -&gt; true (7, 1, 13) -&gt; false (43, 1, 46) -&gt; true (40, 1, 46) -&gt; false (40, 2, 47) -&gt; true (40, 2, 50) -&gt; true (40, 2, 52) -&gt; false (22, 2, 33) -&gt; false (0, 2, 10) -&gt; true (1000000, 1000, 1000100) -&gt; true (2, 1000000, 100003) -&gt; false (20, 0, 19) -&gt; true (20, 0, 21) -&gt; false (20, 4, 51) -&gt; false (20, 4, 39) -&gt; true 代码运行的效率 vs 手续费 时间和金钱 #mapping重构代码 pragma solidity ^0.4.17; contract Funding{ address public manager; string public projectName; uint public supportMoney; uint public endTime; uint public goalMoney; address[] public players; mapping(address =&gt; bool) playersMap; Request[] public requests; struct Request{ string description; uint money; address shopAddress; bool complete; mapping(address=&gt;bool) approvedPlayers; uint count; } function createRequest(string _description, uint _money, address _shopAddress) public{ require(msg.sender == manager); Request memory request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false, count:0 }); requests.push(request); } function approveRequest(uint id) public{ require(playersMap[msg.sender]); require(!requests[id].approvedPlayers[msg.sender]); requests[id].count++; requests[id].approvedPlayers[msg.sender] = true; } function finalizeRequest(uint id) public{ require(msg.sender == manager); require(requests[id].count*2&gt;players.length); require(requests[id].money&lt;=this.balance); require(!requests[id].complete ); requests[id].shopAddress.transfer(requests[id].money); requests[id].complete = true; } function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; manager = msg.sender; } function support() public payable{ require(msg.value == supportMoney ); players.push(msg.sender); playersMap[msg.sender] = true; } function getAccountBalance() public view returns(uint){ return this.balance; } } #智能合约的部署 代理模式, 服务器代理部署(钱服务器花) 用户直接模式, 用户直接部署.(钱用户花) contract FundingFactory{ address[] public fundingAddress; function createFunding(string _projectName,uint _supportMoney,uint _goalMoney) public{ address funding = new Funding(_projectName,_supportMoney,_goalMoney,msg.sender); fundingAddress.push(funding); } } web3js 的函数封装 #附件 第一版 pragma solidity ^0.4.17; contract Funding{ bool flag = false; //众筹发起人地址(众筹发起人) address public manager; //项目名称 string public projectName; //众筹参与人需要付的钱 uint public supportMoney; // 众筹结束的时间 uint public endTime; // 目标募集的资金(endTime后,达不到目标则众筹失败) uint public goalMoney; // 众筹参与人的数组 address[] public players; //付款请求申请的数组(由众筹发起人申请) Request[] public requets; // 付款请求的结构体 struct Request{ string description; // 为什么要付款 uint money; // 花多少钱 address shopAddress; // 卖家的钱包 地址 bool complete; // 付款是否已经完成 address[] votedAddress; // 哪些已经投过票的人 uint voteCount; // 投票的总的总数 } function createRequest( string _description, uint _money, address _shopAddress) public onlyManagerCanCall{ require(this.balance &gt;= _money); Request memory request = Request({ description:_description, money:_money, shopAddress:_shopAddress, complete:false, votedAddress: new address[](0), voteCount : 0 }); requets.push(request); } // 众筹参与人员批准某一笔付款 ( index数组的下标 ) function approveRequest(uint index) public { Request storage request = requets[index]; bool supporter = false; //1. 检查某个人是否已经在众筹参与人列表里面 for(uint i = 0;i&lt;players.length;i++){ if( players[i] == msg.sender){ supporter = true; } } require(supporter); //2 .检查某个人是不是已经投过票了 bool voted = false; for(uint j = 0; j&lt;request.votedAddress.length;j++){ if( request.votedAddress[j] == msg.sender){ voted = true; } } require(!voted); request. voteCount ++; request.votedAddress.push(msg.sender); } // 构造函数 function Funding(string _projectName,uint _supportMoney,uint _goalMoney) public{ manager = msg.sender; projectName = _projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; } // 参与人支持众筹 function support() public payable{ require(msg.value == 79); players.push(msg.sender); } // 返回参与人的数量 function getPlayersCount() public view returns(uint){ return players.length; } function getPlayers() public view returns(address[]){ return players; } function getTotalBalance() public view returns (uint){ return this.balance; } function getRemainDays() public view returns(uint){ return (endTime - now)/24/60/60; } function checkStatus() public { require(!flag); require(now &gt; endTime); require(this.balance &gt; goalMoney); flag = true; } modifier onlyManagerCanCall(){ require(msg.sender == manager); _; } } ##全套代码 pragma solidity ^0.4.25; contract FundingFactory { //存储所有已经部署的智能合约的地址 address[] public fundings; function createFunding(string _projectName, uint _supportMoney, uint _goalMoney) public { address funding = new Funding(_projectName, _supportMoney, _goalMoney, msg.sender); fundings.push(funding); } function getFundings() public view returns(address[]){ return fundings; } } contract Funding { // 众筹成功标记 bool public flag = false; // 众筹发起人地址(众筹发起人) address public manager; // 项目名称 string public projectName; // 众筹参与人需要付的钱 uint public supportMoney; // 目标募集的资金(endTime后,达不到目标则众筹失败) uint public goalMoney; // 默认众筹结束的时间,为众筹发起后的一个月 uint public endTime; // 众筹参与人的数组 address[] public players; mapping(address=&gt;bool) playersMap; // 付款请求的数组 Request[] public requests; struct Request { // 描述这笔付款请求是干啥的 string description; // 花多少钱, 钱要少于balance uint money; // 钱汇给谁. 真正的收钱方 address shopAddress; // 代表当前付款请求已经处理完毕 bool complete; // 已投票的用户地址 mapping(address=&gt;bool) votedMap; uint votedCount; } //构造函数 constructor(string _projectName, uint _supportMoney, uint _goalMoney, address sender) public{ manager = sender; projectName =_projectName; supportMoney = _supportMoney; goalMoney = _goalMoney; endTime = now + 4 weeks; } // 我要支持(需要付钱) function support() public payable{ require(msg.value == supportMoney); // 放进集合中 players.push(msg.sender); playersMap[msg.sender] = true; } // 付款申请函数,由众筹发起人调用 function createRequest(string _description, uint _money, address _shopAddress) public onlyManagerCanCall{ // 余额大于等于付款请求 require(address(this).balance &gt;= _money); Request memory request = Request({ description: _description, money: _money, shopAddress: _shopAddress, complete: false, votedCount: 0 }); requests.push(request); } // 付款批准函数, 由众筹参与人调用 function approveRequest(uint index) public { // 是否是众筹参与者 require(playersMap[msg.sender]); // 防止一个人重复投票 Request storage request = requests[index]; require(!request.votedMap[msg.sender]); request.votedMap[msg.sender] = true; request.votedCount++; } // 众筹发起人调用, 可以调用完成付款 function finalizeRequest(uint index) public onlyManagerCanCall{ Request storage request = requests[index]; require(!request.complete); // 钱够 require(address(this).balance &gt;= request.money); // 人数过半 require(request.votedCount * 2 &gt;= getPlayersCount()); // 执行转账操作 request.shopAddress.transfer(request.money); request.complete = true; } // 所有参与者 function getPlayers() public view returns(address[]){ return players; } // 所有参与者个数 function getPlayersCount() public view returns(uint){ return players.length; } // 获取合约的余额 function getTotalBalance() public view returns(uint){ return address(this).balance; } // 获取剩余天数 function getRemainDays() public view returns(uint) { return (endTime - now) / 60 / 60 / 24; } // 检查众筹状态 function checkStatus() public onlyManagerCanCall { require(!flag); // 到期 require(now &gt;= endTime); // getTotalBalance金额&gt;= goalMoney require(address(this).balance &gt;= goalMoney); flag = true; } modifier onlyManagerCanCall { require(msg.sender == manager); _; } } es6 大神阮一峰的文章 http://es6.ruanyifeng.com/#docs/module#export-default-命令 代码战争: https://www.codewars.com 阅读更多","@type":"BlogPosting","url":"/2018/11/10/c8a08baad430c68ff655b8c7ca0fb386.html","headline":"以太坊众筹项目合约以及部署01","dateModified":"2018-11-10T00:00:00+08:00","datePublished":"2018-11-10T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/11/10/c8a08baad430c68ff655b8c7ca0fb386.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>以太坊众筹项目合约以及部署01</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div id="content_views" class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <h1><a id="_0"></a>智能合约众筹实战</h1> 
  <p>###淘宝众筹, 京东众筹<br> <a href="https://izhongchou.taobao.com/index.htm" rel="nofollow">https://izhongchou.taobao.com/index.htm</a></p> 
  <p><a href="https://kickstarter.com" rel="nofollow">https://kickstarter.com</a></p> 
  <p>###分析商业模式</p> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-e667d25c639fa9b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <h1><a id="_12"></a>解决京东众筹的痛点</h1> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-6b0d4645002b48a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p><a href="https://z.jd.com/project/details/105705.html" rel="nofollow">https://z.jd.com/project/details/105705.html</a></p> 
  <ol> 
   <li> <p>期望的金钱流动<br> <img src="https://upload-images.jianshu.io/upload_images/4499731-43c1a551408b12aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> </li> 
   <li> <p>真实的金钱流动<br> <img src="https://upload-images.jianshu.io/upload_images/4499731-a558c314ba8d8a7e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> </li> 
  </ol> 
  <p>控制金钱流动的方向, 速度.</p> 
  <p>众筹的金钱 进入智能合约中</p> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-e49a16a2ff5c9ff1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p>每一笔开销,都要发起付款申请<br> <img src="https://upload-images.jianshu.io/upload_images/4499731-d944dd17aee366ed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p>投资人support付款申请.<br> <img src="https://upload-images.jianshu.io/upload_images/4499731-4557ae97a5bdcf3e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <ul> 
   <li>带界面的众筹交互项目-React -&gt; 3</li> 
   <li>web3js操作以太坊网络 -&gt; 2</li> 
   <li>众筹合约 -&gt; 1</li> 
  </ul> 
  <h1><a id="_44"></a>智能合约的其他扩展设计</h1> 
  <p>选举投票决定项目是否继续进行</p> 
  <p>任何众筹项目都面临团队不负责任或者项目仅仅是一个骗局的风险，任何中心化投票系统都面临安全问题、贿赂选票和其他博弈上的缺陷。在 区块链系统中，这些风险都得到了最小化。</p> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-941259ff580c2490.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p><a href="https://baijiahao.baidu.com/s?id=1606757323732765805&amp;wfr=spider" rel="nofollow">https://baijiahao.baidu.com/s?id=1606757323732765805&amp;wfr=spider</a></p> 
  <h1><a id="_54"></a>成员变量设计</h1> 
  <table> 
   <thead> 
    <tr> 
     <th align="left">名称</th> 
     <th align="left">数据类型</th> 
     <th align="left">说明</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td align="left">manager</td> 
     <td align="left">address</td> 
     <td align="left">众筹发起人地址(众筹发起人)</td> 
    </tr> 
    <tr> 
     <td align="left">projectName</td> 
     <td align="left">string</td> 
     <td align="left">项目名称</td> 
    </tr> 
    <tr> 
     <td align="left">supportMoney</td> 
     <td align="left">uint</td> 
     <td align="left">众筹参与人需要付的钱</td> 
    </tr> 
    <tr> 
     <td align="left">endTime</td> 
     <td align="left">uint</td> 
     <td align="left">默认众筹结束的时间,为众筹发起后的一个月</td> 
    </tr> 
    <tr> 
     <td align="left">goalMoney</td> 
     <td align="left">uint</td> 
     <td align="left">目标募集的资金(endTime后,达不到目标则众筹失败)</td> 
    </tr> 
    <tr> 
     <td align="left">players</td> 
     <td align="left">address[]</td> 
     <td align="left">众筹参与人的数组</td> 
    </tr> 
    <tr> 
     <td align="left">requests</td> 
     <td align="left">Request[]</td> 
     <td align="left">付款请求申请的数组</td> 
    </tr> 
   </tbody> 
  </table>
  <p>###函数设计</p> 
  <table> 
   <thead> 
    <tr> 
     <th align="left">函数名称</th> 
     <th align="left">函数说明</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td align="left">Funding</td> 
     <td align="left">构造函数</td> 
    </tr> 
    <tr> 
     <td align="left">support</td> 
     <td align="left">我要支持(需要付钱)</td> 
    </tr> 
    <tr> 
     <td align="left">createRequest</td> 
     <td align="left">付款申请函数,由众筹发起人调用</td> 
    </tr> 
    <tr> 
     <td align="left">approveRequest</td> 
     <td align="left">付款批准函数, 由众筹参与人调用</td> 
    </tr> 
    <tr> 
     <td align="left">finalizeRequest</td> 
     <td align="left">众筹发起人调用, 可以调用完成付款</td> 
    </tr> 
    <tr> 
     <td align="left">moneyBack</td> 
     <td align="left">退钱函数, 由众筹发起人调用(众筹未成功时调用)</td> 
    </tr> 
   </tbody> 
  </table>
  <h1><a id="_80"></a>众筹智能合约的构造函数</h1> 
  <pre><code class="prism language-js">pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.17</span><span class="token punctuation">;</span>

contract Funding<span class="token punctuation">{</span>
    address <span class="token keyword">public</span> manager<span class="token punctuation">;</span>
    string <span class="token keyword">public</span> projectName<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> supportMoney<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> endTime<span class="token punctuation">;</span>	
    uint <span class="token keyword">public</span> goalMoney<span class="token punctuation">;</span>
    address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> players<span class="token punctuation">;</span>
     
    <span class="token keyword">function</span> <span class="token function">Funding</span><span class="token punctuation">(</span>string _projectName<span class="token punctuation">,</span>uint _supportMoney<span class="token punctuation">,</span>uint _goalMoney<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        projectName <span class="token operator">=</span> _projectName<span class="token punctuation">;</span>
        supportMoney <span class="token operator">=</span> _supportMoney<span class="token punctuation">;</span>
        goalMoney <span class="token operator">=</span> _goalMoney<span class="token punctuation">;</span>
        endTime <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token number">4</span> weeks<span class="token punctuation">;</span>
        manager <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
  <h1><a id="_103"></a>众筹支持逻辑</h1> 
  <pre><code class="prism language-js">	address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> players<span class="token punctuation">;</span>
	
	<span class="token keyword">function</span> <span class="token function">support</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable<span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> supportMoney <span class="token punctuation">)</span><span class="token punctuation">;</span>
        players<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre> 
  <p>#测试一下support函数</p> 
  <ul> 
   <li>查看当前智能合约余额</li> 
   <li>查看当前众筹参与人员players信息</li> 
   <li>查看当前众筹参与人员players的个数</li> 
  </ul> 
  <blockquote> 
   <p>获取剩余天数</p> 
   <p>检查众筹状态</p> 
  </blockquote> 
  <h1><a id="Request_124"></a>付款的Request结构体</h1> 
  <table> 
   <thead> 
    <tr> 
     <th align="left">name</th> 
     <th align="left">type</th> 
     <th align="left">说明</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td align="left">description</td> 
     <td align="left">string</td> 
     <td align="left">描述这笔付款请求是干啥的</td> 
    </tr> 
    <tr> 
     <td align="left">money</td> 
     <td align="left">uint</td> 
     <td align="left">花多少钱, 钱要少于balance</td> 
    </tr> 
    <tr> 
     <td align="left">shopAddress</td> 
     <td align="left">address</td> 
     <td align="left">钱汇给谁. 真正的收钱方</td> 
    </tr> 
    <tr> 
     <td align="left">complete</td> 
     <td align="left">bool</td> 
     <td align="left">true代表当前付款请求已经处理完毕</td> 
    </tr> 
    <tr> 
     <td align="left">???</td> 
     <td align="left">???</td> 
     <td align="left">投票机制(大家先思考, 由众筹参与者决定)</td> 
    </tr> 
   </tbody> 
  </table>
  <pre><code class="prism language-js">struct Request<span class="token punctuation">{</span>
        string description<span class="token punctuation">;</span>
        uint money<span class="token punctuation">;</span>
        address shopAddress<span class="token punctuation">;</span>
        bool complete<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
  <h1><a id="createRequest_144"></a>createRequest</h1> 
  <p>只有经理可以createRequest</p> 
  <pre><code class="prism language-js">    <span class="token keyword">function</span> <span class="token function">createRequest</span><span class="token punctuation">(</span>string _description<span class="token punctuation">,</span> uint _money<span class="token punctuation">,</span> address _shopAddress<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        Request request <span class="token operator">=</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            description<span class="token punctuation">:</span>_description<span class="token punctuation">,</span>
            money<span class="token punctuation">:</span>_money<span class="token punctuation">,</span>
            shopAddress<span class="token punctuation">:</span>_shopAddress<span class="token punctuation">,</span>
            complete<span class="token punctuation">:</span><span class="token boolean">false</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
  <h1><a id="memorystorage_160"></a>memory和storage</h1> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-22a92f7161445d05.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <ul> 
   <li>storage</li> 
   <li>memory</li> 
  </ul> 
  <p>##两种概念</p> 
  <ol> 
   <li>智能合约如何存储数据, 是在memory还是storage</li> 
   <li>solidity变量如何存储数据, 是在memory还是在storage</li> 
  </ol> 
  <p>##智能合约的数据存储</p> 
  <ol> 
   <li>storage : 成员变量. 可以跨函数调用. 有点类似于硬盘</li> 
   <li>memory: 临时数据存储, 类似于电脑的内存 函数的参数可以理解为memory类型<br> <img src="https://upload-images.jianshu.io/upload_images/4499731-a531de19a32268b5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></li> 
  </ol> 
  <p>##solidity变量的数据存储<br> 值传递和引用传递<br> memory值传递<br> storage引用传递</p> 
  <pre><code class="prism language-js">pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.25</span><span class="token punctuation">;</span>

contract Test<span class="token punctuation">{</span>
    
    uint<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> array<span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        array<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
       <span class="token comment">// 引用传递 默认是storage, aa修改值会改变原来的数组值</span>
       uint<span class="token punctuation">[</span><span class="token punctuation">]</span> aa <span class="token operator">=</span> array<span class="token punctuation">;</span>
       aa<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">666</span><span class="token punctuation">;</span>
       
    	<span class="token comment">// change(array);</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 值传递 默认 memory 内存复制的新对象, arr修改值不会改变原数组</span>
    <span class="token keyword">function</span> <span class="token function">change</span><span class="token punctuation">(</span>uint<span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">888</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 强制改成storage类型, 必须声明成private, 合约内部函数才可调用, 此时可以修改原数组array的内容</span>
    <span class="token keyword">function</span> <span class="token function">change2</span><span class="token punctuation">(</span>uint<span class="token punctuation">[</span><span class="token punctuation">]</span> storage arr<span class="token punctuation">)</span> <span class="token keyword">private</span><span class="token punctuation">{</span>
        arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">888</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        uint i <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> array<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
  <h1><a id="_217"></a>投票系统需求</h1> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-dff6748b17e52fa5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <ul> 
   <li> <p>防止一个人重复投票<br> <img src="https://upload-images.jianshu.io/upload_images/4499731-0fd9d608178317ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> </li> 
   <li> <p>投票的人可能有很多(成千上万人)</p> </li> 
  </ul> 
  <h3><a id="__227"></a>投票系统设计稿 业务逻辑</h3> 
  <ul> 
   <li>检查某个人是否已经在众筹参与人列表里面</li> 
  </ul> 
  <blockquote> 
   <p>没参与众筹没给钱,投个屁的票啊</p> 
  </blockquote> 
  <ul> 
   <li>检查某个人是不是已经投过票了</li> 
  </ul> 
  <blockquote> 
   <p>一人一票不得违反</p> 
  </blockquote> 
  <p>#投票逻辑的致命问题</p> 
  <p>有一些小砖（每块1英寸）和大砖（每块5英寸）,我们想砌出来指定长度的墙，<br> 如果用我们选择的砖块的数量能够拼接成功，则返回true；否则返回false，<br> 例如：makeBricks(3, 1, 8) → true</p> 
  <h2><a id="_12___242"></a>测试用例 (每行显示一条测试用例，格式为(参数1,参数2) -&gt; 期望结果)</h2> 
  <pre><code class="prism language-js"><span class="token punctuation">[</span>test<span class="token punctuation">.</span>suits<span class="token punctuation">]</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>		
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>		
<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>		
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>		
<span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>		
<span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000100</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">,</span> <span class="token number">100003</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>	
<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>	
<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
</code></pre> 
  <p>代码运行的效率 vs 手续费<br> 时间和金钱</p> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-a4940aff9132c2b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p><img src="https://upload-images.jianshu.io/upload_images/4499731-8a6c981a1b95bb2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p>#mapping重构代码</p> 
  <pre><code class="prism language-js">pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.17</span><span class="token punctuation">;</span>

contract Funding<span class="token punctuation">{</span>
    address <span class="token keyword">public</span> manager<span class="token punctuation">;</span>
    string <span class="token keyword">public</span> projectName<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span>  supportMoney<span class="token punctuation">;</span>
    uint <span class="token keyword">public</span> endTime<span class="token punctuation">;</span>	
    uint <span class="token keyword">public</span> goalMoney<span class="token punctuation">;</span>
    address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> players<span class="token punctuation">;</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span>address <span class="token operator">=&gt;</span> bool<span class="token punctuation">)</span> playersMap<span class="token punctuation">;</span>
    Request<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> requests<span class="token punctuation">;</span>
    
    struct Request<span class="token punctuation">{</span>
        string description<span class="token punctuation">;</span>
        uint money<span class="token punctuation">;</span>
        address shopAddress<span class="token punctuation">;</span>
        bool complete<span class="token punctuation">;</span>
        <span class="token function">mapping</span><span class="token punctuation">(</span>address<span class="token operator">=&gt;</span>bool<span class="token punctuation">)</span> approvedPlayers<span class="token punctuation">;</span>
        uint count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">function</span> <span class="token function">createRequest</span><span class="token punctuation">(</span>string _description<span class="token punctuation">,</span> uint _money<span class="token punctuation">,</span> address _shopAddress<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Request memory request <span class="token operator">=</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            description<span class="token punctuation">:</span>_description<span class="token punctuation">,</span>
            money<span class="token punctuation">:</span>_money<span class="token punctuation">,</span>
            shopAddress<span class="token punctuation">:</span>_shopAddress<span class="token punctuation">,</span>
            complete<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            count<span class="token punctuation">:</span><span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
    <span class="token keyword">function</span> <span class="token function">approveRequest</span><span class="token punctuation">(</span>uint id<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
          <span class="token function">require</span><span class="token punctuation">(</span>playersMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>approvedPlayers<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
          requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>approvedPlayers<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
     
    <span class="token keyword">function</span> <span class="token function">finalizeRequest</span><span class="token punctuation">(</span>uint id<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>count<span class="token operator">*</span><span class="token number">2</span><span class="token operator">&gt;</span>players<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>money<span class="token operator">&lt;=</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>complete <span class="token punctuation">)</span><span class="token punctuation">;</span>
        requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>shopAddress<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        requests<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">.</span>complete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
     
    <span class="token keyword">function</span> <span class="token function">Funding</span><span class="token punctuation">(</span>string _projectName<span class="token punctuation">,</span>uint _supportMoney<span class="token punctuation">,</span>uint _goalMoney<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        projectName <span class="token operator">=</span> _projectName<span class="token punctuation">;</span>
        supportMoney <span class="token operator">=</span> _supportMoney<span class="token punctuation">;</span>
        goalMoney <span class="token operator">=</span> _goalMoney<span class="token punctuation">;</span>
        endTime <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token number">4</span> weeks<span class="token punctuation">;</span>
        manager <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">function</span> <span class="token function">support</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable<span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> supportMoney <span class="token punctuation">)</span><span class="token punctuation">;</span>
        players<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        playersMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">function</span> <span class="token function">getAccountBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">{</span>
	    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
  <p>#智能合约的部署</p> 
  <ol> 
   <li>代理模式, 服务器代理部署(钱服务器花)</li> 
   <li>用户直接模式, 用户直接部署.(钱用户花)</li> 
  </ol> 
  <pre><code class="prism language-js">contract FundingFactory<span class="token punctuation">{</span>
    
    address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> fundingAddress<span class="token punctuation">;</span> 
    <span class="token keyword">function</span> <span class="token function">createFunding</span><span class="token punctuation">(</span>string _projectName<span class="token punctuation">,</span>uint _supportMoney<span class="token punctuation">,</span>uint _goalMoney<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        address funding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Funding</span><span class="token punctuation">(</span>_projectName<span class="token punctuation">,</span>_supportMoney<span class="token punctuation">,</span>_goalMoney<span class="token punctuation">,</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fundingAddress<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>funding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
  <h2><a id="web3js__373"></a>web3js 的函数封装</h2> 
  <p>#附件</p> 
  <pre><code class="prism language-js">第一版
pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.17</span><span class="token punctuation">;</span>

contract Funding<span class="token punctuation">{</span>
    
    bool flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
     <span class="token comment">//众筹发起人地址(众筹发起人)</span>
     address <span class="token keyword">public</span> manager<span class="token punctuation">;</span>
     <span class="token comment">//项目名称</span>
     string <span class="token keyword">public</span> projectName<span class="token punctuation">;</span>
     <span class="token comment">//众筹参与人需要付的钱</span>
     uint <span class="token keyword">public</span> supportMoney<span class="token punctuation">;</span>
     <span class="token comment">// 众筹结束的时间 </span>
     uint <span class="token keyword">public</span> endTime<span class="token punctuation">;</span>
     <span class="token comment">// 目标募集的资金(endTime后,达不到目标则众筹失败)</span>
     uint <span class="token keyword">public</span> goalMoney<span class="token punctuation">;</span>
     <span class="token comment">// 众筹参与人的数组</span>
     address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> players<span class="token punctuation">;</span>
     <span class="token comment">//付款请求申请的数组(由众筹发起人申请)</span>
     Request<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> requets<span class="token punctuation">;</span>
     
     <span class="token comment">// 付款请求的结构体 </span>
     struct Request<span class="token punctuation">{</span>
          string description<span class="token punctuation">;</span> <span class="token comment">// 为什么要付款 </span>
          uint money<span class="token punctuation">;</span> <span class="token comment">// 花多少钱 </span>
          address shopAddress<span class="token punctuation">;</span> <span class="token comment">// 卖家的钱包 地址 </span>
          bool complete<span class="token punctuation">;</span>  <span class="token comment">// 付款是否已经完成 </span>
          address<span class="token punctuation">[</span><span class="token punctuation">]</span> votedAddress<span class="token punctuation">;</span> <span class="token comment">// 哪些已经投过票的人 </span>
          uint  voteCount<span class="token punctuation">;</span> <span class="token comment">// 投票的总的总数 </span>
     <span class="token punctuation">}</span>
     
     <span class="token keyword">function</span> <span class="token function">createRequest</span><span class="token punctuation">(</span> string _description<span class="token punctuation">,</span> uint _money<span class="token punctuation">,</span> address _shopAddress<span class="token punctuation">)</span> <span class="token keyword">public</span>  onlyManagerCanCall<span class="token punctuation">{</span>
     
         <span class="token function">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">&gt;=</span> _money<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
         Request memory request <span class="token operator">=</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
             description<span class="token punctuation">:</span>_description<span class="token punctuation">,</span>
             money<span class="token punctuation">:</span>_money<span class="token punctuation">,</span>
             shopAddress<span class="token punctuation">:</span>_shopAddress<span class="token punctuation">,</span>
             complete<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
             votedAddress<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             voteCount <span class="token punctuation">:</span> <span class="token number">0</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         requets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
     <span class="token comment">// 众筹参与人员批准某一笔付款 ( index数组的下标 ) </span>
     <span class="token keyword">function</span> <span class="token function">approveRequest</span><span class="token punctuation">(</span>uint index<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
         Request storage request <span class="token operator">=</span> requets<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
         bool supporter <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token comment">//1. 检查某个人是否已经在众筹参与人列表里面</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span>uint i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>players<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span> players<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">{</span>
                  supporter <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token function">require</span><span class="token punctuation">(</span>supporter<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//2 .检查某个人是不是已经投过票了</span>
         bool voted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         <span class="token keyword">for</span><span class="token punctuation">(</span>uint j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>request<span class="token punctuation">.</span>votedAddress<span class="token punctuation">.</span>length<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span> request<span class="token punctuation">.</span>votedAddress<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">==</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">{</span>
                  voted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
          <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>voted<span class="token punctuation">)</span><span class="token punctuation">;</span>
          request<span class="token punctuation">.</span> voteCount <span class="token operator">++</span><span class="token punctuation">;</span>
          request<span class="token punctuation">.</span>votedAddress<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
     
     <span class="token comment">// 构造函数 </span>
     <span class="token keyword">function</span> <span class="token function">Funding</span><span class="token punctuation">(</span>string _projectName<span class="token punctuation">,</span>uint _supportMoney<span class="token punctuation">,</span>uint _goalMoney<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
         manager <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
         projectName <span class="token operator">=</span> _projectName<span class="token punctuation">;</span>
         supportMoney <span class="token operator">=</span> _supportMoney<span class="token punctuation">;</span>
         goalMoney <span class="token operator">=</span> _goalMoney<span class="token punctuation">;</span>
         endTime <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token number">4</span> weeks<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 参与人支持众筹 </span>
     <span class="token keyword">function</span> <span class="token function">support</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable<span class="token punctuation">{</span>
         <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">79</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         players<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 返回参与人的数量 </span>
     <span class="token keyword">function</span> <span class="token function">getPlayersCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> players<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
     <span class="token keyword">function</span> <span class="token function">getPlayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> players<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
     <span class="token keyword">function</span> <span class="token function">getTotalBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
     <span class="token keyword">function</span> <span class="token function">getRemainDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> now<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">24</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
    <span class="token keyword">function</span> <span class="token function">checkStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span>now <span class="token operator">&gt;</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>balance <span class="token operator">&gt;</span> goalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
     modifier <span class="token function">onlyManagerCanCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
         _<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     
<span class="token punctuation">}</span>

</code></pre> 
  <p>##全套代码</p> 
  <pre><code class="prism language-js">pragma solidity <span class="token operator">^</span><span class="token number">0.4</span><span class="token number">.25</span><span class="token punctuation">;</span>

contract FundingFactory <span class="token punctuation">{</span>
    
    <span class="token comment">//存储所有已经部署的智能合约的地址 </span>
    address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> fundings<span class="token punctuation">;</span>
    
    <span class="token keyword">function</span> <span class="token function">createFunding</span><span class="token punctuation">(</span>string _projectName<span class="token punctuation">,</span> uint _supportMoney<span class="token punctuation">,</span> uint _goalMoney<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        address funding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Funding</span><span class="token punctuation">(</span>_projectName<span class="token punctuation">,</span> _supportMoney<span class="token punctuation">,</span> _goalMoney<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fundings<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>funding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">getFundings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> fundings<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

contract Funding <span class="token punctuation">{</span>
    
    <span class="token comment">// 众筹成功标记</span>
    bool <span class="token keyword">public</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 众筹发起人地址(众筹发起人)</span>
    address <span class="token keyword">public</span> manager<span class="token punctuation">;</span>
    <span class="token comment">// 项目名称</span>
    string <span class="token keyword">public</span> projectName<span class="token punctuation">;</span>
    <span class="token comment">// 众筹参与人需要付的钱</span>
    uint <span class="token keyword">public</span> supportMoney<span class="token punctuation">;</span>
    <span class="token comment">// 目标募集的资金(endTime后,达不到目标则众筹失败)</span>
    uint <span class="token keyword">public</span> goalMoney<span class="token punctuation">;</span>
    <span class="token comment">// 默认众筹结束的时间,为众筹发起后的一个月</span>
    uint <span class="token keyword">public</span> endTime<span class="token punctuation">;</span>
    <span class="token comment">// 众筹参与人的数组</span>
    address<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> players<span class="token punctuation">;</span>
    <span class="token function">mapping</span><span class="token punctuation">(</span>address<span class="token operator">=&gt;</span>bool<span class="token punctuation">)</span> playersMap<span class="token punctuation">;</span>
    
    <span class="token comment">// 付款请求的数组</span>
    Request<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">public</span> requests<span class="token punctuation">;</span> 
    
    struct Request <span class="token punctuation">{</span>
        <span class="token comment">// 描述这笔付款请求是干啥的</span>
        string description<span class="token punctuation">;</span>
        <span class="token comment">// 花多少钱, 钱要少于balance</span>
        uint money<span class="token punctuation">;</span>
        <span class="token comment">// 钱汇给谁. 真正的收钱方</span>
        address shopAddress<span class="token punctuation">;</span>
        <span class="token comment">// 代表当前付款请求已经处理完毕</span>
        bool complete<span class="token punctuation">;</span>
        <span class="token comment">// 已投票的用户地址</span>
        <span class="token function">mapping</span><span class="token punctuation">(</span>address<span class="token operator">=&gt;</span>bool<span class="token punctuation">)</span> votedMap<span class="token punctuation">;</span>
        uint votedCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    
    <span class="token comment">//构造函数</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>string _projectName<span class="token punctuation">,</span> uint _supportMoney<span class="token punctuation">,</span> uint _goalMoney<span class="token punctuation">,</span> address sender<span class="token punctuation">)</span> <span class="token keyword">public</span><span class="token punctuation">{</span>
        manager <span class="token operator">=</span> sender<span class="token punctuation">;</span>
        projectName <span class="token operator">=</span>_projectName<span class="token punctuation">;</span>
        supportMoney <span class="token operator">=</span> _supportMoney<span class="token punctuation">;</span>
        goalMoney <span class="token operator">=</span> _goalMoney<span class="token punctuation">;</span>
        endTime <span class="token operator">=</span> now <span class="token operator">+</span> <span class="token number">4</span> weeks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 我要支持(需要付钱)</span>
    <span class="token keyword">function</span> <span class="token function">support</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> payable<span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">==</span> supportMoney<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 放进集合中</span>
        players<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
        playersMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 付款申请函数,由众筹发起人调用</span>
    <span class="token keyword">function</span> <span class="token function">createRequest</span><span class="token punctuation">(</span>string _description<span class="token punctuation">,</span> uint _money<span class="token punctuation">,</span> address _shopAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyManagerCanCall<span class="token punctuation">{</span>
        <span class="token comment">// 余额大于等于付款请求 </span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">&gt;=</span> _money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        Request memory request <span class="token operator">=</span> <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            description<span class="token punctuation">:</span> _description<span class="token punctuation">,</span>
            money<span class="token punctuation">:</span> _money<span class="token punctuation">,</span>
            shopAddress<span class="token punctuation">:</span> _shopAddress<span class="token punctuation">,</span>
            complete<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            votedCount<span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        requests<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 付款批准函数, 由众筹参与人调用</span>
    <span class="token keyword">function</span> <span class="token function">approveRequest</span><span class="token punctuation">(</span>uint index<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
        <span class="token comment">// 是否是众筹参与者</span>
        <span class="token function">require</span><span class="token punctuation">(</span>playersMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 防止一个人重复投票</span>
        Request storage request <span class="token operator">=</span> requests<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>votedMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        request<span class="token punctuation">.</span>votedMap<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>votedCount<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 众筹发起人调用, 可以调用完成付款</span>
    <span class="token keyword">function</span> <span class="token function">finalizeRequest</span><span class="token punctuation">(</span>uint index<span class="token punctuation">)</span> <span class="token keyword">public</span> onlyManagerCanCall<span class="token punctuation">{</span>
        
        Request storage request <span class="token operator">=</span> requests<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token punctuation">.</span>complete<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 钱够</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">&gt;=</span> request<span class="token punctuation">.</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 人数过半</span>
        <span class="token function">require</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>votedCount <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">&gt;=</span> <span class="token function">getPlayersCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 执行转账操作</span>
        request<span class="token punctuation">.</span>shopAddress<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        request<span class="token punctuation">.</span>complete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    
    <span class="token comment">// 所有参与者</span>
    <span class="token keyword">function</span> <span class="token function">getPlayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>address<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> players<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 所有参与者个数</span>
    <span class="token keyword">function</span> <span class="token function">getPlayersCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> players<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取合约的余额</span>
    <span class="token keyword">function</span> <span class="token function">getTotalBalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取剩余天数</span>
    <span class="token keyword">function</span> <span class="token function">getRemainDays</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> view <span class="token function">returns</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>endTime <span class="token operator">-</span> now<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">60</span> <span class="token operator">/</span> <span class="token number">24</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 检查众筹状态</span>
    <span class="token keyword">function</span> <span class="token function">checkStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> onlyManagerCanCall <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 到期</span>
        <span class="token function">require</span><span class="token punctuation">(</span>now <span class="token operator">&gt;=</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// getTotalBalance金额&gt;= goalMoney</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>balance <span class="token operator">&gt;=</span> goalMoney<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    modifier onlyManagerCanCall <span class="token punctuation">{</span>
        <span class="token function">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> manager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre> 
  <ul> 
   <li>es6 大神阮一峰的文章 <a href="http://es6.ruanyifeng.com/#docs/module#export-default-%E5%91%BD%E4%BB%A4" rel="nofollow">http://es6.ruanyifeng.com/#docs/module#export-default-命令</a></li> 
   <li>代码战争: <a href="https://www.codewars.com" rel="nofollow">https://www.codewars.com</a></li> 
  </ul> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-a47e74522c.css" rel="stylesheet"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/www294993741/article/details/83933113,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/www294993741/article/details/83933113,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										if(typeof window.localStorage === "object" && typeof window.csdn.anonymousUserLimit === "object"){
											if(!window.csdn.anonymousUserLimit.judgment()){
												window.csdn.anonymousUserLimit.Jumplogin();
												return false;
											}else if(!currentUserName){
												window.csdn.anonymousUserLimit.updata();
											}
										}
										
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
