<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>é‡åŒ–äº¤æ˜“-MACDç­–ç•¥å­¦ä¹  | æœ‰ç»„ç»‡åœ¨ï¼</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="é‡åŒ–äº¤æ˜“-MACDç­–ç•¥å­¦ä¹ " />
<meta property="og:locale" content="en_US" />
<meta name="description" content="MACDçš„åŸºæœ¬æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒ https://www.joinquant.com/post/7095?f=18newyearjx ï¼Œæ„Ÿè°¢ Quantä¸­æ‰¾ç±³åƒçš„é˜¿é¼  å’Œ èšå®½å°ç§˜ä¹¦ Thanksâ™ª(ï½¥Ï‰ï½¥)ï¾‰ æˆ‘è®¤ä¸ºMACDä¸é€‚åˆé‡‡ç”¨è½®åŠ¨ç­–ç•¥ï¼Œç»è¿‡å›æµ‹ï¼Œæˆ‘å°†ç­–ç•¥æ”¹æˆä»¥ä¸‹æ¨¡å¼ï¼šğŸ˜† é€‰å‡ºåŸºæœ¬é¢è¾ƒå¥½çš„è‚¡ç¥¨ å‰”é™¤STã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨ åœ¨DIFå’ŒDEAåœ¨0è½´ä¸Šå½¢æˆé‡‘å‰æ—¶ä¹°å…¥ åœ¨DIFä»–DEAçš„0è½´ä¸‹å½¢æˆæ­»å‰æ—¶å–å‡º åŠ å…¥æ­¢æŸï¼šè¿™æ¬¡çš„æ­¢æŸä¹°æœ‰æ ¹æ®è‚¡ç¥¨çš„ç›ˆäºæ¥åˆ¤æ–­ï¼Œè€Œæ˜¯ï¼š è®°å½•æŒä»“è‚¡ç¥¨çš„æ¯å¤©çš„ç›ˆåˆ©ï¼Œå¦‚æœå½“å¤©ç›ˆåˆ©æ¯”ä¹‹å‰çš„ç›ˆåˆ©å°ï¼Œåˆ™ä¸è®°å½• å¦‚æœå½“å¤©åˆ¤æ–­çš„ç›ˆåˆ©å·²ç»æ¯”è®°å½•çš„æœ€å¤§ç›ˆåˆ©å°20%ï¼Œåˆ™æ­¢æŸå–å‡º ä¸‹é¢ğŸ‘‡æ˜¯å›æµ‹ç»“æœå’Œæºä»£ç  import numpy as np import pandas as pd # å¯¼å…¥æŠ€æœ¯åˆ†æåº“ import talib as tb def initialize(context): &quot;&quot;&quot;åˆå§‹åŒ–å‡½æ•°&quot;&quot;&quot; # è®°å½•è‚¡ç¥¨çš„æ”¶ç›Šç‡ g.retio = {} # è®¾ç½®ä¸­è¯500ä¸ºå‚è€ƒåŸºå‡† set_benchmark(&#39;000905.XSHG&#39;) # ä½¿ç”¨çœŸå®ä»·æ ¼äº¤æ˜“ set_option(&#39;use_real_price&#39;, True) # è®¾å®šæ—¥å¿—çº§åˆ« log.set_level(&#39;order&#39;, &#39;error&#39;) # æŒ‡å®šå‘¨æœŸæ€§äº¤æ˜“å‡½æ•° run_daily(trade, &#39;every_bar&#39;) def before_trading_start(context): &quot;&quot;&quot;å¼€ç›˜å‰è®¾ç½®äº¤æ˜“è´¹ç”¨&quot;&quot;&quot; # è®¾å®šæ‰€æœ‰ç±»å‹çš„äº¤æ˜“å“ç§çš„äº¤æ˜“æ»‘ç‚¹ä¸º0.02 set_slippage(FixedSlippage(0.02)) # è®¾å®š2013å¹´å‰ä¸2013å¹´åçš„äº¤æ˜“è´¹ç”¨ dt = context.current_dt if dt&gt;datetime.datetime(2013,1, 1): set_order_cost(OrderCost( open_tax=0, close_tax=0.001, open_commission=0.0003, close_commission=0.0003, close_today_commission=0, min_commission=5), type=&#39;stock&#39;) else: set_order_cost(OrderCost( open_tax=0, open_commission=0.003, close_commission=0.003, close_tax=0.001, min_commission=5), type=&#39;stock&#39;) def trade(context): &quot;&quot;&quot;äº¤æ˜“å‡½æ•°&quot;&quot;&quot; # g.days += 1 # if g.days % g.refresh_rate != 1: # return &#39;&#39;&#39;ä¸€ã€æŒ‘é€‰å‡ºé«˜è´¨é‡çš„è‚¡ç¥¨&#39;&#39;&#39; stocks_choose = get_fundamentals( query( valuation.code ).filter( valuation.pe_ratio &lt; 40, valuation.pe_ratio &gt; 10, indicator.eps &gt; 0.3, indicator.inc_net_profit_annual &gt; 0.30, indicator.roe &gt; 15 ).order_by( valuation.pb_ratio.asc() ).limit(50), date=None) # å°†è‚¡ç¥¨ä»£ç é›†è½¬æˆndarray,å› ä¸ºå®ƒæ¯”åˆ—è¡¨çš„è®¡ç®—é€Ÿåº¦æ›´å¿« stocks_pool = stocks_choose[&#39;code&#39;].values &#39;&#39;&#39;äºŒã€å‰”é™¤stã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨&#39;&#39;&#39; current_data = get_current_data() # å‰”é™¤åœç‰Œ stocks_pool = [stock for stock in stocks_pool if not current_data[stock].paused] # å‰”é™¤st stocks_pool = [stock for stock in stocks_pool if not current_data[stock].is_st] # å‰”é™¤é€€å¸‚ stocks_pool = [stock for stock in stocks_pool if not &#39;é€€&#39; in current_data[stock].name] &#39;&#39;&#39;ä¸‰ã€è‚¡ç¥¨äº¤æ˜“æ¡ä»¶åˆ¤æ–­&#39;&#39;&#39; # ä¹°å…¥åˆ—è¡¨ stocks_long = [] # å–å‡ºåˆ—è¡¨ stocks_short = [] # ç»§ç»­æŒæœ‰åˆ—è¡¨ stocks_hold = [] #MACDåˆ¤æ–­ for stock in stocks_pool: # è·å¾—ä¹‹å‰300å¤©çš„æ”¶ç›˜ä»· prices = attribute_history(stock, 300, &#39;1d&#39;, [&#39;close&#39;]) # å°†ä»·æ ¼å€¼è½¬æ¢æˆndarray price = np.array(prices[&#39;close&#39;]) # è®¡ç®—MACDå€¼ DIF, DEA, MACD = tb.MACD( price, fastperiod=12, slowperiod=26, signalperiod=20) # åœ¨0è½´ä¸Šé‡‘å‰ä¹°å…¥ if DIF[-1] &gt; 0 and DEA[-1] &gt; 0: if (DIF[-2] &lt;= DEA[-2]) and (DIF[-1] &gt; DEA[-1]): stocks_long.append(stock) # åœ¨0è½´ä¹‹ä¸‹æ­»å‰å–å‡º elif DIF[-1] &lt; 0 and DEA[-1] &lt; 0: if (DIF[-2] &gt;= DEA[-2]) and (DIF[-1] &lt; DEA[-1]): stocks_long.append(stock) &#39;&#39;&#39;å››ã€å–å‡ºæŒä»“ä¸­ç¬¦åˆå–å‡ºæ¡ä»¶çš„è‚¡ç¥¨&#39;&#39;&#39; # æŒä»“ hold_list = list(context.portfolio.positions.keys()) # åˆ¤æ–­ for stock in hold_list: # è®¡ç®—æŒä»“è‚¡ç¥¨çš„æ”¶ç›Šç‡ cost = context.portfolio.positions[stock].avg_cost price = context.portfolio.positions[stock].price ret = (price/cost) - 1 # è®°å½•æ”¶ç›Šç‡ï¼Œå¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”ä¹‹å‰å¤§ï¼Œæ›¿æ¢ä¹‹å‰çš„è®°å½• # å¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”è®°å½•çš„æœ€å¤§æ”¶ç›Šç‡å°20%ï¼Œæ­¢æŸï¼Œå–å‡º if stock in g.retio.keys(): if ret &gt; g.retio[stock]: g.retio[stock] = ret elif (ret - g.retio[stock]) &lt; -0.2: order_target_value(stock, 0) del g.retio[stock] else: g.retio[stock] = ret # å°†åœ¨å–å‡ºåˆ—è¡¨ä¸­çš„è‚¡ç¥¨å–å‡º if stock in stocks_short: order_target_value(stock, 0) # ç»§ç»­æŒä»“çš„è‚¡ç¥¨ else: stocks_hold.append(stock) &#39;&#39;&#39;äº”ã€ä¹°å…¥ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨&#39;&#39;&#39; # ä¹°å…¥åˆ—è¡¨ï¼Œå·²ç»æŒä»“çš„ä¸å†é‡å¤ä¹°å…¥ buy_list = list(set(stocks_long) - set(stocks_hold)) # ä¹°å…¥ if len(buy_list) &gt; 0: Cash = context.portfolio.available_cash / len(buy_list) for stock in buy_list: order_value(stock, Cash)" />
<meta property="og:description" content="MACDçš„åŸºæœ¬æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒ https://www.joinquant.com/post/7095?f=18newyearjx ï¼Œæ„Ÿè°¢ Quantä¸­æ‰¾ç±³åƒçš„é˜¿é¼  å’Œ èšå®½å°ç§˜ä¹¦ Thanksâ™ª(ï½¥Ï‰ï½¥)ï¾‰ æˆ‘è®¤ä¸ºMACDä¸é€‚åˆé‡‡ç”¨è½®åŠ¨ç­–ç•¥ï¼Œç»è¿‡å›æµ‹ï¼Œæˆ‘å°†ç­–ç•¥æ”¹æˆä»¥ä¸‹æ¨¡å¼ï¼šğŸ˜† é€‰å‡ºåŸºæœ¬é¢è¾ƒå¥½çš„è‚¡ç¥¨ å‰”é™¤STã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨ åœ¨DIFå’ŒDEAåœ¨0è½´ä¸Šå½¢æˆé‡‘å‰æ—¶ä¹°å…¥ åœ¨DIFä»–DEAçš„0è½´ä¸‹å½¢æˆæ­»å‰æ—¶å–å‡º åŠ å…¥æ­¢æŸï¼šè¿™æ¬¡çš„æ­¢æŸä¹°æœ‰æ ¹æ®è‚¡ç¥¨çš„ç›ˆäºæ¥åˆ¤æ–­ï¼Œè€Œæ˜¯ï¼š è®°å½•æŒä»“è‚¡ç¥¨çš„æ¯å¤©çš„ç›ˆåˆ©ï¼Œå¦‚æœå½“å¤©ç›ˆåˆ©æ¯”ä¹‹å‰çš„ç›ˆåˆ©å°ï¼Œåˆ™ä¸è®°å½• å¦‚æœå½“å¤©åˆ¤æ–­çš„ç›ˆåˆ©å·²ç»æ¯”è®°å½•çš„æœ€å¤§ç›ˆåˆ©å°20%ï¼Œåˆ™æ­¢æŸå–å‡º ä¸‹é¢ğŸ‘‡æ˜¯å›æµ‹ç»“æœå’Œæºä»£ç  import numpy as np import pandas as pd # å¯¼å…¥æŠ€æœ¯åˆ†æåº“ import talib as tb def initialize(context): &quot;&quot;&quot;åˆå§‹åŒ–å‡½æ•°&quot;&quot;&quot; # è®°å½•è‚¡ç¥¨çš„æ”¶ç›Šç‡ g.retio = {} # è®¾ç½®ä¸­è¯500ä¸ºå‚è€ƒåŸºå‡† set_benchmark(&#39;000905.XSHG&#39;) # ä½¿ç”¨çœŸå®ä»·æ ¼äº¤æ˜“ set_option(&#39;use_real_price&#39;, True) # è®¾å®šæ—¥å¿—çº§åˆ« log.set_level(&#39;order&#39;, &#39;error&#39;) # æŒ‡å®šå‘¨æœŸæ€§äº¤æ˜“å‡½æ•° run_daily(trade, &#39;every_bar&#39;) def before_trading_start(context): &quot;&quot;&quot;å¼€ç›˜å‰è®¾ç½®äº¤æ˜“è´¹ç”¨&quot;&quot;&quot; # è®¾å®šæ‰€æœ‰ç±»å‹çš„äº¤æ˜“å“ç§çš„äº¤æ˜“æ»‘ç‚¹ä¸º0.02 set_slippage(FixedSlippage(0.02)) # è®¾å®š2013å¹´å‰ä¸2013å¹´åçš„äº¤æ˜“è´¹ç”¨ dt = context.current_dt if dt&gt;datetime.datetime(2013,1, 1): set_order_cost(OrderCost( open_tax=0, close_tax=0.001, open_commission=0.0003, close_commission=0.0003, close_today_commission=0, min_commission=5), type=&#39;stock&#39;) else: set_order_cost(OrderCost( open_tax=0, open_commission=0.003, close_commission=0.003, close_tax=0.001, min_commission=5), type=&#39;stock&#39;) def trade(context): &quot;&quot;&quot;äº¤æ˜“å‡½æ•°&quot;&quot;&quot; # g.days += 1 # if g.days % g.refresh_rate != 1: # return &#39;&#39;&#39;ä¸€ã€æŒ‘é€‰å‡ºé«˜è´¨é‡çš„è‚¡ç¥¨&#39;&#39;&#39; stocks_choose = get_fundamentals( query( valuation.code ).filter( valuation.pe_ratio &lt; 40, valuation.pe_ratio &gt; 10, indicator.eps &gt; 0.3, indicator.inc_net_profit_annual &gt; 0.30, indicator.roe &gt; 15 ).order_by( valuation.pb_ratio.asc() ).limit(50), date=None) # å°†è‚¡ç¥¨ä»£ç é›†è½¬æˆndarray,å› ä¸ºå®ƒæ¯”åˆ—è¡¨çš„è®¡ç®—é€Ÿåº¦æ›´å¿« stocks_pool = stocks_choose[&#39;code&#39;].values &#39;&#39;&#39;äºŒã€å‰”é™¤stã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨&#39;&#39;&#39; current_data = get_current_data() # å‰”é™¤åœç‰Œ stocks_pool = [stock for stock in stocks_pool if not current_data[stock].paused] # å‰”é™¤st stocks_pool = [stock for stock in stocks_pool if not current_data[stock].is_st] # å‰”é™¤é€€å¸‚ stocks_pool = [stock for stock in stocks_pool if not &#39;é€€&#39; in current_data[stock].name] &#39;&#39;&#39;ä¸‰ã€è‚¡ç¥¨äº¤æ˜“æ¡ä»¶åˆ¤æ–­&#39;&#39;&#39; # ä¹°å…¥åˆ—è¡¨ stocks_long = [] # å–å‡ºåˆ—è¡¨ stocks_short = [] # ç»§ç»­æŒæœ‰åˆ—è¡¨ stocks_hold = [] #MACDåˆ¤æ–­ for stock in stocks_pool: # è·å¾—ä¹‹å‰300å¤©çš„æ”¶ç›˜ä»· prices = attribute_history(stock, 300, &#39;1d&#39;, [&#39;close&#39;]) # å°†ä»·æ ¼å€¼è½¬æ¢æˆndarray price = np.array(prices[&#39;close&#39;]) # è®¡ç®—MACDå€¼ DIF, DEA, MACD = tb.MACD( price, fastperiod=12, slowperiod=26, signalperiod=20) # åœ¨0è½´ä¸Šé‡‘å‰ä¹°å…¥ if DIF[-1] &gt; 0 and DEA[-1] &gt; 0: if (DIF[-2] &lt;= DEA[-2]) and (DIF[-1] &gt; DEA[-1]): stocks_long.append(stock) # åœ¨0è½´ä¹‹ä¸‹æ­»å‰å–å‡º elif DIF[-1] &lt; 0 and DEA[-1] &lt; 0: if (DIF[-2] &gt;= DEA[-2]) and (DIF[-1] &lt; DEA[-1]): stocks_long.append(stock) &#39;&#39;&#39;å››ã€å–å‡ºæŒä»“ä¸­ç¬¦åˆå–å‡ºæ¡ä»¶çš„è‚¡ç¥¨&#39;&#39;&#39; # æŒä»“ hold_list = list(context.portfolio.positions.keys()) # åˆ¤æ–­ for stock in hold_list: # è®¡ç®—æŒä»“è‚¡ç¥¨çš„æ”¶ç›Šç‡ cost = context.portfolio.positions[stock].avg_cost price = context.portfolio.positions[stock].price ret = (price/cost) - 1 # è®°å½•æ”¶ç›Šç‡ï¼Œå¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”ä¹‹å‰å¤§ï¼Œæ›¿æ¢ä¹‹å‰çš„è®°å½• # å¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”è®°å½•çš„æœ€å¤§æ”¶ç›Šç‡å°20%ï¼Œæ­¢æŸï¼Œå–å‡º if stock in g.retio.keys(): if ret &gt; g.retio[stock]: g.retio[stock] = ret elif (ret - g.retio[stock]) &lt; -0.2: order_target_value(stock, 0) del g.retio[stock] else: g.retio[stock] = ret # å°†åœ¨å–å‡ºåˆ—è¡¨ä¸­çš„è‚¡ç¥¨å–å‡º if stock in stocks_short: order_target_value(stock, 0) # ç»§ç»­æŒä»“çš„è‚¡ç¥¨ else: stocks_hold.append(stock) &#39;&#39;&#39;äº”ã€ä¹°å…¥ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨&#39;&#39;&#39; # ä¹°å…¥åˆ—è¡¨ï¼Œå·²ç»æŒä»“çš„ä¸å†é‡å¤ä¹°å…¥ buy_list = list(set(stocks_long) - set(stocks_hold)) # ä¹°å…¥ if len(buy_list) &gt; 0: Cash = context.portfolio.available_cash / len(buy_list) for stock in buy_list: order_value(stock, Cash)" />
<meta property="og:site_name" content="æœ‰ç»„ç»‡åœ¨ï¼" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-04T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"MACDçš„åŸºæœ¬æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒ https://www.joinquant.com/post/7095?f=18newyearjx ï¼Œæ„Ÿè°¢ Quantä¸­æ‰¾ç±³åƒçš„é˜¿é¼  å’Œ èšå®½å°ç§˜ä¹¦ Thanksâ™ª(ï½¥Ï‰ï½¥)ï¾‰ æˆ‘è®¤ä¸ºMACDä¸é€‚åˆé‡‡ç”¨è½®åŠ¨ç­–ç•¥ï¼Œç»è¿‡å›æµ‹ï¼Œæˆ‘å°†ç­–ç•¥æ”¹æˆä»¥ä¸‹æ¨¡å¼ï¼šğŸ˜† é€‰å‡ºåŸºæœ¬é¢è¾ƒå¥½çš„è‚¡ç¥¨ å‰”é™¤STã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨ åœ¨DIFå’ŒDEAåœ¨0è½´ä¸Šå½¢æˆé‡‘å‰æ—¶ä¹°å…¥ åœ¨DIFä»–DEAçš„0è½´ä¸‹å½¢æˆæ­»å‰æ—¶å–å‡º åŠ å…¥æ­¢æŸï¼šè¿™æ¬¡çš„æ­¢æŸä¹°æœ‰æ ¹æ®è‚¡ç¥¨çš„ç›ˆäºæ¥åˆ¤æ–­ï¼Œè€Œæ˜¯ï¼š è®°å½•æŒä»“è‚¡ç¥¨çš„æ¯å¤©çš„ç›ˆåˆ©ï¼Œå¦‚æœå½“å¤©ç›ˆåˆ©æ¯”ä¹‹å‰çš„ç›ˆåˆ©å°ï¼Œåˆ™ä¸è®°å½• å¦‚æœå½“å¤©åˆ¤æ–­çš„ç›ˆåˆ©å·²ç»æ¯”è®°å½•çš„æœ€å¤§ç›ˆåˆ©å°20%ï¼Œåˆ™æ­¢æŸå–å‡º ä¸‹é¢ğŸ‘‡æ˜¯å›æµ‹ç»“æœå’Œæºä»£ç  import numpy as np import pandas as pd # å¯¼å…¥æŠ€æœ¯åˆ†æåº“ import talib as tb def initialize(context): &quot;&quot;&quot;åˆå§‹åŒ–å‡½æ•°&quot;&quot;&quot; # è®°å½•è‚¡ç¥¨çš„æ”¶ç›Šç‡ g.retio = {} # è®¾ç½®ä¸­è¯500ä¸ºå‚è€ƒåŸºå‡† set_benchmark(&#39;000905.XSHG&#39;) # ä½¿ç”¨çœŸå®ä»·æ ¼äº¤æ˜“ set_option(&#39;use_real_price&#39;, True) # è®¾å®šæ—¥å¿—çº§åˆ« log.set_level(&#39;order&#39;, &#39;error&#39;) # æŒ‡å®šå‘¨æœŸæ€§äº¤æ˜“å‡½æ•° run_daily(trade, &#39;every_bar&#39;) def before_trading_start(context): &quot;&quot;&quot;å¼€ç›˜å‰è®¾ç½®äº¤æ˜“è´¹ç”¨&quot;&quot;&quot; # è®¾å®šæ‰€æœ‰ç±»å‹çš„äº¤æ˜“å“ç§çš„äº¤æ˜“æ»‘ç‚¹ä¸º0.02 set_slippage(FixedSlippage(0.02)) # è®¾å®š2013å¹´å‰ä¸2013å¹´åçš„äº¤æ˜“è´¹ç”¨ dt = context.current_dt if dt&gt;datetime.datetime(2013,1, 1): set_order_cost(OrderCost( open_tax=0, close_tax=0.001, open_commission=0.0003, close_commission=0.0003, close_today_commission=0, min_commission=5), type=&#39;stock&#39;) else: set_order_cost(OrderCost( open_tax=0, open_commission=0.003, close_commission=0.003, close_tax=0.001, min_commission=5), type=&#39;stock&#39;) def trade(context): &quot;&quot;&quot;äº¤æ˜“å‡½æ•°&quot;&quot;&quot; # g.days += 1 # if g.days % g.refresh_rate != 1: # return &#39;&#39;&#39;ä¸€ã€æŒ‘é€‰å‡ºé«˜è´¨é‡çš„è‚¡ç¥¨&#39;&#39;&#39; stocks_choose = get_fundamentals( query( valuation.code ).filter( valuation.pe_ratio &lt; 40, valuation.pe_ratio &gt; 10, indicator.eps &gt; 0.3, indicator.inc_net_profit_annual &gt; 0.30, indicator.roe &gt; 15 ).order_by( valuation.pb_ratio.asc() ).limit(50), date=None) # å°†è‚¡ç¥¨ä»£ç é›†è½¬æˆndarray,å› ä¸ºå®ƒæ¯”åˆ—è¡¨çš„è®¡ç®—é€Ÿåº¦æ›´å¿« stocks_pool = stocks_choose[&#39;code&#39;].values &#39;&#39;&#39;äºŒã€å‰”é™¤stã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨&#39;&#39;&#39; current_data = get_current_data() # å‰”é™¤åœç‰Œ stocks_pool = [stock for stock in stocks_pool if not current_data[stock].paused] # å‰”é™¤st stocks_pool = [stock for stock in stocks_pool if not current_data[stock].is_st] # å‰”é™¤é€€å¸‚ stocks_pool = [stock for stock in stocks_pool if not &#39;é€€&#39; in current_data[stock].name] &#39;&#39;&#39;ä¸‰ã€è‚¡ç¥¨äº¤æ˜“æ¡ä»¶åˆ¤æ–­&#39;&#39;&#39; # ä¹°å…¥åˆ—è¡¨ stocks_long = [] # å–å‡ºåˆ—è¡¨ stocks_short = [] # ç»§ç»­æŒæœ‰åˆ—è¡¨ stocks_hold = [] #MACDåˆ¤æ–­ for stock in stocks_pool: # è·å¾—ä¹‹å‰300å¤©çš„æ”¶ç›˜ä»· prices = attribute_history(stock, 300, &#39;1d&#39;, [&#39;close&#39;]) # å°†ä»·æ ¼å€¼è½¬æ¢æˆndarray price = np.array(prices[&#39;close&#39;]) # è®¡ç®—MACDå€¼ DIF, DEA, MACD = tb.MACD( price, fastperiod=12, slowperiod=26, signalperiod=20) # åœ¨0è½´ä¸Šé‡‘å‰ä¹°å…¥ if DIF[-1] &gt; 0 and DEA[-1] &gt; 0: if (DIF[-2] &lt;= DEA[-2]) and (DIF[-1] &gt; DEA[-1]): stocks_long.append(stock) # åœ¨0è½´ä¹‹ä¸‹æ­»å‰å–å‡º elif DIF[-1] &lt; 0 and DEA[-1] &lt; 0: if (DIF[-2] &gt;= DEA[-2]) and (DIF[-1] &lt; DEA[-1]): stocks_long.append(stock) &#39;&#39;&#39;å››ã€å–å‡ºæŒä»“ä¸­ç¬¦åˆå–å‡ºæ¡ä»¶çš„è‚¡ç¥¨&#39;&#39;&#39; # æŒä»“ hold_list = list(context.portfolio.positions.keys()) # åˆ¤æ–­ for stock in hold_list: # è®¡ç®—æŒä»“è‚¡ç¥¨çš„æ”¶ç›Šç‡ cost = context.portfolio.positions[stock].avg_cost price = context.portfolio.positions[stock].price ret = (price/cost) - 1 # è®°å½•æ”¶ç›Šç‡ï¼Œå¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”ä¹‹å‰å¤§ï¼Œæ›¿æ¢ä¹‹å‰çš„è®°å½• # å¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”è®°å½•çš„æœ€å¤§æ”¶ç›Šç‡å°20%ï¼Œæ­¢æŸï¼Œå–å‡º if stock in g.retio.keys(): if ret &gt; g.retio[stock]: g.retio[stock] = ret elif (ret - g.retio[stock]) &lt; -0.2: order_target_value(stock, 0) del g.retio[stock] else: g.retio[stock] = ret # å°†åœ¨å–å‡ºåˆ—è¡¨ä¸­çš„è‚¡ç¥¨å–å‡º if stock in stocks_short: order_target_value(stock, 0) # ç»§ç»­æŒä»“çš„è‚¡ç¥¨ else: stocks_hold.append(stock) &#39;&#39;&#39;äº”ã€ä¹°å…¥ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨&#39;&#39;&#39; # ä¹°å…¥åˆ—è¡¨ï¼Œå·²ç»æŒä»“çš„ä¸å†é‡å¤ä¹°å…¥ buy_list = list(set(stocks_long) - set(stocks_hold)) # ä¹°å…¥ if len(buy_list) &gt; 0: Cash = context.portfolio.available_cash / len(buy_list) for stock in buy_list: order_value(stock, Cash)","@type":"BlogPosting","url":"/2018/11/04/400a1d79aeaa6d36e44589607bd56c5d.html","headline":"é‡åŒ–äº¤æ˜“-MACDç­–ç•¥å­¦ä¹ ","dateModified":"2018-11-04T00:00:00+08:00","datePublished":"2018-11-04T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/11/04/400a1d79aeaa6d36e44589607bd56c5d.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>é‡åŒ–äº¤æ˜“-MACDç­–ç•¥å­¦ä¹ </h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>æŸšå­ç¤¾åŒº</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div id="content_views" class="markdown_views prism-tomorrow-night"> 
  <!-- flowchart ç®­å¤´å›¾æ ‡ å‹¿åˆ  --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <p><img src="https://upload-images.jianshu.io/upload_images/5787343-377cb45b49b56b3c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <p>MACDçš„åŸºæœ¬æ¦‚å¿µï¼Œå¯ä»¥å‚è€ƒ <a href="https://www.joinquant.com/post/7095?f=18newyearjx" rel="nofollow">https://www.joinquant.com/post/7095?f=18newyearjx</a> ï¼Œæ„Ÿè°¢ Quantä¸­æ‰¾ç±³åƒçš„é˜¿é¼  å’Œ èšå®½å°ç§˜ä¹¦ Thanksâ™ª(ï½¥Ï‰ï½¥)ï¾‰</p> 
  <p>æˆ‘è®¤ä¸ºMACDä¸é€‚åˆé‡‡ç”¨è½®åŠ¨ç­–ç•¥ï¼Œç»è¿‡å›æµ‹ï¼Œæˆ‘å°†ç­–ç•¥æ”¹æˆä»¥ä¸‹æ¨¡å¼ï¼šğŸ˜†</p> 
  <ul> 
   <li>é€‰å‡ºåŸºæœ¬é¢è¾ƒå¥½çš„è‚¡ç¥¨</li> 
   <li>å‰”é™¤STã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨</li> 
   <li>åœ¨DIFå’ŒDEAåœ¨0è½´ä¸Šå½¢æˆé‡‘å‰æ—¶ä¹°å…¥</li> 
   <li>åœ¨DIFä»–DEAçš„0è½´ä¸‹å½¢æˆæ­»å‰æ—¶å–å‡º</li> 
   <li>åŠ å…¥æ­¢æŸï¼šè¿™æ¬¡çš„æ­¢æŸä¹°æœ‰æ ¹æ®è‚¡ç¥¨çš„ç›ˆäºæ¥åˆ¤æ–­ï¼Œè€Œæ˜¯ï¼š 
    <ul> 
     <li>è®°å½•æŒä»“è‚¡ç¥¨çš„æ¯å¤©çš„ç›ˆåˆ©ï¼Œå¦‚æœå½“å¤©ç›ˆåˆ©æ¯”ä¹‹å‰çš„ç›ˆåˆ©å°ï¼Œåˆ™ä¸è®°å½•</li> 
     <li>å¦‚æœå½“å¤©åˆ¤æ–­çš„ç›ˆåˆ©å·²ç»æ¯”è®°å½•çš„æœ€å¤§ç›ˆåˆ©å°20%ï¼Œåˆ™æ­¢æŸå–å‡º</li> 
    </ul> </li> 
  </ul> 
  <p>ä¸‹é¢ğŸ‘‡æ˜¯å›æµ‹ç»“æœå’Œæºä»£ç </p> 
  <p><img src="https://upload-images.jianshu.io/upload_images/5787343-98a08a6cebf096b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> 
  <pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token comment"># å¯¼å…¥æŠ€æœ¯åˆ†æåº“</span>
<span class="token keyword">import</span> talib <span class="token keyword">as</span> tb

<span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""åˆå§‹åŒ–å‡½æ•°"""</span>
    
    <span class="token comment"># è®°å½•è‚¡ç¥¨çš„æ”¶ç›Šç‡</span>
    g<span class="token punctuation">.</span>retio <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token comment"># è®¾ç½®ä¸­è¯500ä¸ºå‚è€ƒåŸºå‡†</span>
    set_benchmark<span class="token punctuation">(</span><span class="token string">'000905.XSHG'</span><span class="token punctuation">)</span>
    <span class="token comment"># ä½¿ç”¨çœŸå®ä»·æ ¼äº¤æ˜“</span>
    set_option<span class="token punctuation">(</span><span class="token string">'use_real_price'</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># è®¾å®šæ—¥å¿—çº§åˆ«</span>
    log<span class="token punctuation">.</span>set_level<span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">,</span> <span class="token string">'error'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># æŒ‡å®šå‘¨æœŸæ€§äº¤æ˜“å‡½æ•°</span>
    run_daily<span class="token punctuation">(</span>trade<span class="token punctuation">,</span> <span class="token string">'every_bar'</span><span class="token punctuation">)</span>
    

<span class="token keyword">def</span> <span class="token function">before_trading_start</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""å¼€ç›˜å‰è®¾ç½®äº¤æ˜“è´¹ç”¨"""</span>
    
    <span class="token comment"># è®¾å®šæ‰€æœ‰ç±»å‹çš„äº¤æ˜“å“ç§çš„äº¤æ˜“æ»‘ç‚¹ä¸º0.02</span>
    set_slippage<span class="token punctuation">(</span>FixedSlippage<span class="token punctuation">(</span><span class="token number">0.02</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># è®¾å®š2013å¹´å‰ä¸2013å¹´åçš„äº¤æ˜“è´¹ç”¨</span>
    dt <span class="token operator">=</span> context<span class="token punctuation">.</span>current_dt
    <span class="token keyword">if</span> dt<span class="token operator">&gt;</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2013</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        set_order_cost<span class="token punctuation">(</span>OrderCost<span class="token punctuation">(</span>
            open_tax<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
            close_tax<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span> 
            open_commission<span class="token operator">=</span><span class="token number">0.0003</span><span class="token punctuation">,</span> 
            close_commission<span class="token operator">=</span><span class="token number">0.0003</span><span class="token punctuation">,</span> 
            close_today_commission<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
            min_commission<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'stock'</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        set_order_cost<span class="token punctuation">(</span>OrderCost<span class="token punctuation">(</span>
            open_tax<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> 
            open_commission<span class="token operator">=</span><span class="token number">0.003</span><span class="token punctuation">,</span>
            close_commission<span class="token operator">=</span><span class="token number">0.003</span><span class="token punctuation">,</span> 
            close_tax<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>
            min_commission<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">'stock'</span><span class="token punctuation">)</span>

    
<span class="token keyword">def</span> <span class="token function">trade</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""äº¤æ˜“å‡½æ•°"""</span>
    
    <span class="token comment"># g.days += 1</span>
    <span class="token comment"># if g.days % g.refresh_rate != 1:</span>
    <span class="token comment"># return</span>
    
    <span class="token triple-quoted-string string">'''ä¸€ã€æŒ‘é€‰å‡ºé«˜è´¨é‡çš„è‚¡ç¥¨'''</span>
    stocks_choose <span class="token operator">=</span> get_fundamentals<span class="token punctuation">(</span>
        query<span class="token punctuation">(</span>
            valuation<span class="token punctuation">.</span>code
            <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>
                valuation<span class="token punctuation">.</span>pe_ratio <span class="token operator">&lt;</span> <span class="token number">40</span><span class="token punctuation">,</span>
                valuation<span class="token punctuation">.</span>pe_ratio <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">,</span>
                indicator<span class="token punctuation">.</span>eps <span class="token operator">&gt;</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                indicator<span class="token punctuation">.</span>inc_net_profit_annual <span class="token operator">&gt;</span> <span class="token number">0.30</span><span class="token punctuation">,</span>
                indicator<span class="token punctuation">.</span>roe <span class="token operator">&gt;</span> <span class="token number">15</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>
                    valuation<span class="token punctuation">.</span>pb_ratio<span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        date<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
    
    <span class="token comment"># å°†è‚¡ç¥¨ä»£ç é›†è½¬æˆndarray,å› ä¸ºå®ƒæ¯”åˆ—è¡¨çš„è®¡ç®—é€Ÿåº¦æ›´å¿«</span>
    stocks_pool <span class="token operator">=</span> stocks_choose<span class="token punctuation">[</span><span class="token string">'code'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values
    
    <span class="token triple-quoted-string string">'''äºŒã€å‰”é™¤stã€åœç‰Œã€é€€å¸‚çš„è‚¡ç¥¨'''</span>
    current_data <span class="token operator">=</span> get_current_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># å‰”é™¤åœç‰Œ</span>
    stocks_pool <span class="token operator">=</span> <span class="token punctuation">[</span>stock <span class="token keyword">for</span> stock <span class="token keyword">in</span> stocks_pool <span class="token keyword">if</span> <span class="token operator">not</span> current_data<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">.</span>paused<span class="token punctuation">]</span>
    <span class="token comment"># å‰”é™¤st</span>
    stocks_pool <span class="token operator">=</span> <span class="token punctuation">[</span>stock <span class="token keyword">for</span> stock <span class="token keyword">in</span> stocks_pool <span class="token keyword">if</span> <span class="token operator">not</span> current_data<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">.</span>is_st<span class="token punctuation">]</span>
    <span class="token comment"># å‰”é™¤é€€å¸‚</span>
    stocks_pool <span class="token operator">=</span> <span class="token punctuation">[</span>stock <span class="token keyword">for</span> stock <span class="token keyword">in</span> stocks_pool <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token string">'é€€'</span> <span class="token keyword">in</span> current_data<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span>
    
    <span class="token triple-quoted-string string">'''ä¸‰ã€è‚¡ç¥¨äº¤æ˜“æ¡ä»¶åˆ¤æ–­'''</span>
    <span class="token comment"># ä¹°å…¥åˆ—è¡¨</span>
    stocks_long <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># å–å‡ºåˆ—è¡¨</span>
    stocks_short <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># ç»§ç»­æŒæœ‰åˆ—è¡¨</span>
    stocks_hold <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">#MACDåˆ¤æ–­</span>
    <span class="token keyword">for</span> stock <span class="token keyword">in</span> stocks_pool<span class="token punctuation">:</span>
        <span class="token comment"># è·å¾—ä¹‹å‰300å¤©çš„æ”¶ç›˜ä»·</span>
        prices <span class="token operator">=</span> attribute_history<span class="token punctuation">(</span>stock<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token string">'1d'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># å°†ä»·æ ¼å€¼è½¬æ¢æˆndarray</span>
        price <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>prices<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># è®¡ç®—MACDå€¼</span>
        DIF<span class="token punctuation">,</span> DEA<span class="token punctuation">,</span> MACD <span class="token operator">=</span> tb<span class="token punctuation">.</span>MACD<span class="token punctuation">(</span>
            price<span class="token punctuation">,</span> 
            fastperiod<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span> 
            slowperiod<span class="token operator">=</span><span class="token number">26</span><span class="token punctuation">,</span> 
            signalperiod<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
            
        <span class="token comment"># åœ¨0è½´ä¸Šé‡‘å‰ä¹°å…¥</span>
        <span class="token keyword">if</span> DIF<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">and</span> DEA<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DIF<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> DEA<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>DIF<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> DEA<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                stocks_long<span class="token punctuation">.</span>append<span class="token punctuation">(</span>stock<span class="token punctuation">)</span>
        <span class="token comment"># åœ¨0è½´ä¹‹ä¸‹æ­»å‰å–å‡º</span>
        <span class="token keyword">elif</span> DIF<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">and</span> DEA<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DIF<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> DEA<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">and</span> <span class="token punctuation">(</span>DIF<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> DEA<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                stocks_long<span class="token punctuation">.</span>append<span class="token punctuation">(</span>stock<span class="token punctuation">)</span>
            
    
    <span class="token triple-quoted-string string">'''å››ã€å–å‡ºæŒä»“ä¸­ç¬¦åˆå–å‡ºæ¡ä»¶çš„è‚¡ç¥¨'''</span>
    <span class="token comment"># æŒä»“</span>
    hold_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>portfolio<span class="token punctuation">.</span>positions<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># åˆ¤æ–­</span>
    <span class="token keyword">for</span> stock <span class="token keyword">in</span> hold_list<span class="token punctuation">:</span>
        <span class="token comment"># è®¡ç®—æŒä»“è‚¡ç¥¨çš„æ”¶ç›Šç‡</span>
        cost <span class="token operator">=</span> context<span class="token punctuation">.</span>portfolio<span class="token punctuation">.</span>positions<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">.</span>avg_cost
        price <span class="token operator">=</span> context<span class="token punctuation">.</span>portfolio<span class="token punctuation">.</span>positions<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">.</span>price
        ret <span class="token operator">=</span> <span class="token punctuation">(</span>price<span class="token operator">/</span>cost<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
        
        <span class="token comment"># è®°å½•æ”¶ç›Šç‡ï¼Œå¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”ä¹‹å‰å¤§ï¼Œæ›¿æ¢ä¹‹å‰çš„è®°å½•</span>
        <span class="token comment"># å¦‚æœå½“å‰æ”¶ç›Šç‡æ¯”è®°å½•çš„æœ€å¤§æ”¶ç›Šç‡å°20%ï¼Œæ­¢æŸï¼Œå–å‡º</span>
        <span class="token keyword">if</span> stock <span class="token keyword">in</span> g<span class="token punctuation">.</span>retio<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> ret <span class="token operator">&gt;</span> g<span class="token punctuation">.</span>retio<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">:</span>
                g<span class="token punctuation">.</span>retio<span class="token punctuation">[</span>stock<span class="token punctuation">]</span> <span class="token operator">=</span> ret
            <span class="token keyword">elif</span> <span class="token punctuation">(</span>ret <span class="token operator">-</span> g<span class="token punctuation">.</span>retio<span class="token punctuation">[</span>stock<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">0.2</span><span class="token punctuation">:</span>
                order_target_value<span class="token punctuation">(</span>stock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">del</span> g<span class="token punctuation">.</span>retio<span class="token punctuation">[</span>stock<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            g<span class="token punctuation">.</span>retio<span class="token punctuation">[</span>stock<span class="token punctuation">]</span> <span class="token operator">=</span> ret
        
        <span class="token comment"># å°†åœ¨å–å‡ºåˆ—è¡¨ä¸­çš„è‚¡ç¥¨å–å‡º</span>
        <span class="token keyword">if</span> stock <span class="token keyword">in</span> stocks_short<span class="token punctuation">:</span>
            order_target_value<span class="token punctuation">(</span>stock<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># ç»§ç»­æŒä»“çš„è‚¡ç¥¨</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            stocks_hold<span class="token punctuation">.</span>append<span class="token punctuation">(</span>stock<span class="token punctuation">)</span>
            
    <span class="token triple-quoted-string string">'''äº”ã€ä¹°å…¥ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨'''</span>
    <span class="token comment"># ä¹°å…¥åˆ—è¡¨ï¼Œå·²ç»æŒä»“çš„ä¸å†é‡å¤ä¹°å…¥</span>
    buy_list <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>stocks_long<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span>stocks_hold<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># ä¹°å…¥</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>buy_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        Cash <span class="token operator">=</span> context<span class="token punctuation">.</span>portfolio<span class="token punctuation">.</span>available_cash <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>buy_list<span class="token punctuation">)</span>
        <span class="token keyword">for</span> stock <span class="token keyword">in</span> buy_list<span class="token punctuation">:</span>
            order_value<span class="token punctuation">(</span>stock<span class="token punctuation">,</span> Cash<span class="token punctuation">)</span>
</code></pre> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-2b43bc2447.css" rel="stylesheet"> 
</div> 
<div class="hide-article-box text-center">  
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- è‡ªå®šä¹‰å¹¿å‘Š -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">æ›´å¤šç²¾å½©å†…å®¹</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">å›é¦–é¡µ</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
