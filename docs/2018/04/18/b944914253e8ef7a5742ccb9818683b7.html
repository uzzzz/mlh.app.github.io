<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>从区块链游戏 CryptoKitties 中，学习区块链技 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="从区块链游戏 CryptoKitties 中，学习区块链技" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="本文来自作者&nbsp;崔广斌&nbsp;在&nbsp;GitChat&nbsp;上分享 「玩区块链游戏谜恋猫 CryptoKitties， 学习区块链技术赚 ETH」 编辑 | Mc Jin 便于读者更清晰阅读本文，先列出本文的内容大纲： 1.以太坊开发技术基础 2.&nbsp;谜恋猫系统结构 3. 谜恋猫游戏规则 4. 使用 web3js 读写区块链上的谜恋猫数据 5. 使用 api.cryptokitties.co 读取数据 6. 通过程序赚 ETH 7. 谜恋猫的一些统计数据 8. 玩谜恋猫的一些启发 9. 开发时遇到问题怎么办？ 1. 以太坊开发技术基础 1.1 以太坊概述 以太坊是可编程的区块链，是业内公认的区块链 2.0 代表项目。可以将以太坊理解为一个操作系统，使用 Solidity 等语言编写智能合约发布应用到链上，使用 Go、Java、Python、JavaScript 等语言在链下调用链上的智能合约读写区块链数据，通过这种方式实现各种各样的区块链应用。 比特币的总上限是2100万，而以太坊的内置代币以太币（Ether）没有确切的总量上限。目前以太坊大概每15秒出一个新块，一个新块奖励矿工 3 ETH 。 以太坊的设计者认为随着时间流逝总会发生因为粗心和死亡等原因带来的币的遗失，假设币的遗失是每年货币供应量的一个固定比例，则最终总的流通中的货币供应量会稳定在一个等于年货币发行量除以遗失率的值上，使得供应量会趋于稳定。 比特币缺少图灵完备性，尽管比特币脚本语言可以支持多种计算，但是它不能支持所有的计算，如不支持 for 循环。以太坊是准图灵完备的，之所以增加“准”，是因为智能合约在以太坊区块链上执行时是受限的。 在以太坊区块链上执行交易（转账、调用智能合约）需要消耗 Gas ，一般来说操作步骤越复杂需要的 Gas 越多，而一个块有 Gas 上限（目前约为 800万）。向普通账户做1次转账操作目前消耗 2.1 万 Gas。 在块 Gas 上限为 800 万时，假设调用一个智能合约中某个函数时会向400个账户转账，因为会至少消耗 400 * 2.1 万 = 820 万 Gas，超出块的 Gas 上限 800 万，合约调用会失败。 关于以太坊更详细的介绍可以参考：以太坊白皮书和以太坊黄皮书。 1.2 Solidity Solidity 是一种在语法上类似 JavaScript 的高级语言，编译 Solidity 代码可以生成以太坊虚拟机代码。 Solidity 是静态类型语言，支持继承、库和复杂的用户定义类型等特性。 使用 Solidity 可以很容易创建投票、众筹、封闭拍卖、多重签名钱包、谜恋猫游戏之类的智能合约。 由于以太坊区块链的限制，在链上无法读取链下数据，使用 Solidity 你也无法来调用传统的 API，例如你无法调用某天气网站提供的天气 API。 另外在以太坊区块链上，无法让程序在指定时间自动运行。 谜恋猫游戏为了真实性，在猫怀孕后不是立即生出小猫，而是需要在满足一定条件后由外部来触发生猫函数为猫提供接生服务，一些开发者根据游戏的这个特性还可以赚猫的接生费，后文会有详细说明。 etherscan.io&nbsp;提供了验证程序源码的服务。原理是使用公开的代码及指定的编译器版本再编译一次程序。 然后和发布到区块链的以太坊的二进制代码做比对，如果一致说明公开的代码就是在区块链上运行的那份代码。 下图是一份通过验证的代码截图。 可以访问这里，进一步了解 Solidity。 1.3 ERC-20 和 ERC-721 ERC-20&nbsp;和&nbsp;ERC-721&nbsp;都是以太坊 EIP（Ethereum Improvement Proposal，以太坊改进协议），更多 EIP 见这里。 ERC-20 定义了一份代币标准，可以理解为定义了一个接口类，在实现具体的 ERC-20 代币时，要给出各个接口的具体实现，如获取代币名称、代币符号、总供应量、小数位数、转账等。 使用 ERC-20，可以大幅度降低发币成本，发币方无需开发钱包和区块链浏览器，交易所也可以轻松支持新的代币充值提现等操作。 ERC-20 币是同质的，你的一个币和我的一个币是等价的。ERC-721 是非同质代币（Non-fungible Tokens），每个 ERC-721 有唯一的 ID，转账时，不再是转多少币，而是转某个tokenId，如 transferFrom： 谜恋猫实现了 ERC-721 规范，每个猫有一个唯一的 ID，玩家花 ETH 买猫时，智能合约会调用 transferFrom 修改猫的所有者。 1.4 搭建以太坊全节点 我使用了以太坊 Go 客户端搭建的全节点，参考文档见(https://github.com/ethereum/go-ethereum)，几个注意事项如下： 电脑配置不能太低。我刚开始使用的是阿里云1核 CPU、2500 MHz 的 ECS，发现怎么也同步不到最新块，升级到了4核后同步正常了； 第一次同步时使用&nbsp;- -fast&nbsp;选项，可以更快地同步到最新块，目前（2018-04-02）使用&nbsp;- -fast&nbsp;选项同步到最新块后预计占用 60G 空间； geth 运行时间长了可能会有问题，我使用守护进程启动 geth，每 4 个小时 kill 掉 geth，目前基本上能一直同步到最新块； 硬盘空间要足够大，建议至少1T以上。我3个月前使用&nbsp;- -fast&nbsp;同步完成后才占 40 多 G 空间，之后正常模式同步后硬盘占用空间快速增长，运行3个月左右已经 500G 了。 为了更方便、更快速的调用相关 API，建议在本地服务器上搭建一个以太坊全节点，并保持同步到最新区块高度。 如果想通过程序买卖猫但又不想自己搭建全节点，可以使用 MetaMask 的节点，API 地址请访问(mainnet.infura.io/metamask)，使用 MetaMask 的节点 API，监听事件可能会受到影响，一个方法是遍历某个区块的所有交易信息，然后选择自己关注的交易信息再做相关处理。 2. 谜恋猫系统结构 如果你还没有在&nbsp;www.cryptokitties.co&nbsp;买过猫，建议先买只猫后再阅读后续内容。一些入门攻略见(http://www.maomao123.co/faq)，遇到问题可通过谜恋猫 QQ 群（728507998）咨询。 2.1 谜恋猫 DApp 谜恋猫是一个 DApp（Decentralized Application），部分程序部署在区块链上，部分程序部署在中心化的服务器上，总体架构如下图： 2.2 谜恋猫智能合约 谜恋猫在以太坊区块链上一共有4个智能合约： CryptoKittiesCore&nbsp;：核心代码，已开源，2016行代码； CryptoKittiesSalesAuction&nbsp;：猫拍卖机制，已开源，604行代码； CryptoKittiesSiringAuction&nbsp;：配种拍卖机制，已开源，589行代码； geneScience&nbsp;：基因工程，未开源。 以玩家挂单卖猫为例，说明相关步骤： 玩家在自己某只猫的页面点击出售按钮，设置出售价格，通过 MetaMask 钱包操作后等待（页面上猫的状态是非在售；MetaMask 交易状态是 pending 中）； MetaMask 将交易广播出去（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）； 交易被矿工打包到区块中（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）； 谜恋猫的以太坊节点监听到卖猫事件，更新数据库中猫的信息、更新缓存数据、更新搜索索引数据；MetaMask 的以太坊节点更新交易状态（页面上猫的状态是在售；MetaMask 交易状态是已完成）； 用户卖猫后，在页面上不是立即可以看到猫处于在售中，而是需要等待一会儿才能看到，整个过程是异步的。 这也为懂技术的玩家留下机会，可以在猫刚开卖还未在页面上显示出售中就能立即买下猫，详细方法见后文。 3. 谜恋猫游戏规则 3.1 以太坊钱包就是用户的 ID 一般涉及到用户数据的网站或 App，都会要用户注册帐号，哪怕是使用第三方授权。 而对于谜恋猫游戏，即使你之前从未访问过网站，只要有你的以太坊钱包地址，其他人就可以给你送猫。 安装&nbsp;MetaMask&nbsp;插件后第一次登陆网站，需要你按提示点击一个消息签名按钮，以便验证当前用户身份。 原理是椭圆曲线加密算法，相关函数为 web3.eth.sign(address, dataToSign)、ecRecover，具体用法可以搜索下。 3.2 买猫 在谜恋猫页面，点击顶部导航“猫市”，默认就是待收养的猫猫。点击“筛选猫咪”可以通过多种方式做筛选，找到自己的目标猫咪。初期玩建议按价格从低到高排序，选两三只便宜的猫咪。 搜索功能并不是直接从区块链读取数据的，而是通过同步区块链数据后在中心化服务器中建立的索引。 点击一只猫咪后，进入单个猫咪页面，再点击“立即购买”就可以买猫了。 在点击“立即购买”按钮时，会调用 web3js，触发弹出 MetaMask 插件窗口。MetaMask 插件中会显示 Amount（转账额度）、GasLimit（燃料上限）、GasPrice（燃料价格）等参数，部分数据做了隐藏，如购买猫调用的是 bid(uint256 _tokenId) 函数。 点击“submit”按钮后，MetaMask 会将交易数据提交到以太坊网络，等待矿工打包确认，当矿工将交易数据打包到某个区块中才算真正完成相关函数执行。 但成功打包到区块中不一定能成功买到猫，因为交易过程是异步的，在这个过程中也可能有其他人购买同一只猫，如果他人的交易比你的交易优先被矿工打包，你就买不到猫了。另外，卖家也可以取消卖猫。 在此简单说下以太坊的 Gas 机制，在以太坊中涉及到任何写数据的操作都有消耗 Gas，矿工打包一般优先打包 gasPrice 高的交易。 gas * gasPrice&nbsp;表示在操作过程中消耗的以太币，剩余的以太币&nbsp;（gasLimit - gas）* gasPrice&nbsp;会返回给用户。 一般来做操作越复杂，消耗的 Gas 越多，占用的存储空间越大，消耗的 Gas 越多。 3.3 卖猫和出租种猫 你买卖达成后后，平台会收取交易的 3.75% 作为手续费。因以太坊区块链上的数据对所有可见，卖猫不支持暗拍（备注：&nbsp;ENS支持安排，但相对复杂，不合适面向普通用户）。 为了让买家以相对和合适的价格找到相对合适的卖家，卖猫时，可以设置起始价、结束价、价格变化时间段（出售期限），价格变化时间段结束后，还会处于出售状态，价格保持为结束价。 当前价格的计算方法： &nbsp; &nbsp;/// @dev Computes the current price of an auction. Factored out &nbsp; &nbsp;/// &nbsp;from _currentPrice so we can run extensive unit tests. &nbsp; &nbsp;/// &nbsp;When testing, make this function public and turn on &nbsp; &nbsp;/// &nbsp;`Current price computation` test suite. &nbsp; &nbsp;function _computeCurrentPrice( &nbsp; &nbsp; &nbsp; &nbsp;uint256 _startingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _endingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _duration, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _secondsPassed ) &nbsp; &nbsp;internal &nbsp; &nbsp;pure &nbsp; &nbsp;returns (uint256) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;// NOTE: We don&#39;t use SafeMath (or similar) in this function because &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;all of our public functions carefully cap the maximum values for &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;time (at 64-bits) and currency (at 128-bits). _duration is &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;also known to be non-zero (see the require() statement in &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;_addAuction()) &nbsp; &nbsp; &nbsp; &nbsp;if (_secondsPassed &gt;= _duration) { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;ve reached the end of the dynamic pricing portion &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// of the auction, just return the end price. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return _endingPrice; &nbsp; &nbsp; &nbsp; &nbsp;} else { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Starting price can be higher than ending price (and often is!), so &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// this delta can be negative. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 totalPriceChange = int256(_endingPrice) - int256(_startingPrice); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// This multiplication can&#39;t overflow, _secondsPassed will easily fit within &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 64-bits, and totalPriceChange will easily fit within 128-bits, their product &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// will always fit within 256-bits. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPriceChange = totalPriceChange * int256(_secondsPassed) / int256(_duration); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// currentPriceChange can be negative, but if so, will have a magnitude &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// less that _startingPrice. Thus, this result will always end up positive. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPrice = int256(_startingPrice) + currentPriceChange; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return uint256(currentPrice); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} 3.4 出租种猫 出租种猫和卖猫类似，可以通过出租种猫赚钱，但所有权还是原主人的。相关合约见&nbsp;CryptoKittiesSiringAuction&nbsp;。 3.5 生猫 生猫规则如下： 任意猫都可以充当爸爸或妈妈的角色； 交配时不能乱伦； 每生育一次，恢复时间变长，直到需要7天时间恢复； 孕期 = 怀孕后妈妈的恢复时间，想尽快生出小猫的话，应该使用休息时间短的猫做妈妈； 小猫代数 = max(爸爸的代数，妈妈的代数) + 1； 小猫恢复时间 cooldown_index = min( 小猫代数 / 2 ,13)； 不同 cooldonw_index 对应的时间见下面内容。 生猫函数如下： ..... 扫码阅读全文 并与作者交流 近期热文 《区块链在哪些案例上发挥着重大作用》 《区块链落地中的九大问题与解法》 《比特币和区块链基础》 《穷人入门区块链指南》 阅读更多" />
<meta property="og:description" content="本文来自作者&nbsp;崔广斌&nbsp;在&nbsp;GitChat&nbsp;上分享 「玩区块链游戏谜恋猫 CryptoKitties， 学习区块链技术赚 ETH」 编辑 | Mc Jin 便于读者更清晰阅读本文，先列出本文的内容大纲： 1.以太坊开发技术基础 2.&nbsp;谜恋猫系统结构 3. 谜恋猫游戏规则 4. 使用 web3js 读写区块链上的谜恋猫数据 5. 使用 api.cryptokitties.co 读取数据 6. 通过程序赚 ETH 7. 谜恋猫的一些统计数据 8. 玩谜恋猫的一些启发 9. 开发时遇到问题怎么办？ 1. 以太坊开发技术基础 1.1 以太坊概述 以太坊是可编程的区块链，是业内公认的区块链 2.0 代表项目。可以将以太坊理解为一个操作系统，使用 Solidity 等语言编写智能合约发布应用到链上，使用 Go、Java、Python、JavaScript 等语言在链下调用链上的智能合约读写区块链数据，通过这种方式实现各种各样的区块链应用。 比特币的总上限是2100万，而以太坊的内置代币以太币（Ether）没有确切的总量上限。目前以太坊大概每15秒出一个新块，一个新块奖励矿工 3 ETH 。 以太坊的设计者认为随着时间流逝总会发生因为粗心和死亡等原因带来的币的遗失，假设币的遗失是每年货币供应量的一个固定比例，则最终总的流通中的货币供应量会稳定在一个等于年货币发行量除以遗失率的值上，使得供应量会趋于稳定。 比特币缺少图灵完备性，尽管比特币脚本语言可以支持多种计算，但是它不能支持所有的计算，如不支持 for 循环。以太坊是准图灵完备的，之所以增加“准”，是因为智能合约在以太坊区块链上执行时是受限的。 在以太坊区块链上执行交易（转账、调用智能合约）需要消耗 Gas ，一般来说操作步骤越复杂需要的 Gas 越多，而一个块有 Gas 上限（目前约为 800万）。向普通账户做1次转账操作目前消耗 2.1 万 Gas。 在块 Gas 上限为 800 万时，假设调用一个智能合约中某个函数时会向400个账户转账，因为会至少消耗 400 * 2.1 万 = 820 万 Gas，超出块的 Gas 上限 800 万，合约调用会失败。 关于以太坊更详细的介绍可以参考：以太坊白皮书和以太坊黄皮书。 1.2 Solidity Solidity 是一种在语法上类似 JavaScript 的高级语言，编译 Solidity 代码可以生成以太坊虚拟机代码。 Solidity 是静态类型语言，支持继承、库和复杂的用户定义类型等特性。 使用 Solidity 可以很容易创建投票、众筹、封闭拍卖、多重签名钱包、谜恋猫游戏之类的智能合约。 由于以太坊区块链的限制，在链上无法读取链下数据，使用 Solidity 你也无法来调用传统的 API，例如你无法调用某天气网站提供的天气 API。 另外在以太坊区块链上，无法让程序在指定时间自动运行。 谜恋猫游戏为了真实性，在猫怀孕后不是立即生出小猫，而是需要在满足一定条件后由外部来触发生猫函数为猫提供接生服务，一些开发者根据游戏的这个特性还可以赚猫的接生费，后文会有详细说明。 etherscan.io&nbsp;提供了验证程序源码的服务。原理是使用公开的代码及指定的编译器版本再编译一次程序。 然后和发布到区块链的以太坊的二进制代码做比对，如果一致说明公开的代码就是在区块链上运行的那份代码。 下图是一份通过验证的代码截图。 可以访问这里，进一步了解 Solidity。 1.3 ERC-20 和 ERC-721 ERC-20&nbsp;和&nbsp;ERC-721&nbsp;都是以太坊 EIP（Ethereum Improvement Proposal，以太坊改进协议），更多 EIP 见这里。 ERC-20 定义了一份代币标准，可以理解为定义了一个接口类，在实现具体的 ERC-20 代币时，要给出各个接口的具体实现，如获取代币名称、代币符号、总供应量、小数位数、转账等。 使用 ERC-20，可以大幅度降低发币成本，发币方无需开发钱包和区块链浏览器，交易所也可以轻松支持新的代币充值提现等操作。 ERC-20 币是同质的，你的一个币和我的一个币是等价的。ERC-721 是非同质代币（Non-fungible Tokens），每个 ERC-721 有唯一的 ID，转账时，不再是转多少币，而是转某个tokenId，如 transferFrom： 谜恋猫实现了 ERC-721 规范，每个猫有一个唯一的 ID，玩家花 ETH 买猫时，智能合约会调用 transferFrom 修改猫的所有者。 1.4 搭建以太坊全节点 我使用了以太坊 Go 客户端搭建的全节点，参考文档见(https://github.com/ethereum/go-ethereum)，几个注意事项如下： 电脑配置不能太低。我刚开始使用的是阿里云1核 CPU、2500 MHz 的 ECS，发现怎么也同步不到最新块，升级到了4核后同步正常了； 第一次同步时使用&nbsp;- -fast&nbsp;选项，可以更快地同步到最新块，目前（2018-04-02）使用&nbsp;- -fast&nbsp;选项同步到最新块后预计占用 60G 空间； geth 运行时间长了可能会有问题，我使用守护进程启动 geth，每 4 个小时 kill 掉 geth，目前基本上能一直同步到最新块； 硬盘空间要足够大，建议至少1T以上。我3个月前使用&nbsp;- -fast&nbsp;同步完成后才占 40 多 G 空间，之后正常模式同步后硬盘占用空间快速增长，运行3个月左右已经 500G 了。 为了更方便、更快速的调用相关 API，建议在本地服务器上搭建一个以太坊全节点，并保持同步到最新区块高度。 如果想通过程序买卖猫但又不想自己搭建全节点，可以使用 MetaMask 的节点，API 地址请访问(mainnet.infura.io/metamask)，使用 MetaMask 的节点 API，监听事件可能会受到影响，一个方法是遍历某个区块的所有交易信息，然后选择自己关注的交易信息再做相关处理。 2. 谜恋猫系统结构 如果你还没有在&nbsp;www.cryptokitties.co&nbsp;买过猫，建议先买只猫后再阅读后续内容。一些入门攻略见(http://www.maomao123.co/faq)，遇到问题可通过谜恋猫 QQ 群（728507998）咨询。 2.1 谜恋猫 DApp 谜恋猫是一个 DApp（Decentralized Application），部分程序部署在区块链上，部分程序部署在中心化的服务器上，总体架构如下图： 2.2 谜恋猫智能合约 谜恋猫在以太坊区块链上一共有4个智能合约： CryptoKittiesCore&nbsp;：核心代码，已开源，2016行代码； CryptoKittiesSalesAuction&nbsp;：猫拍卖机制，已开源，604行代码； CryptoKittiesSiringAuction&nbsp;：配种拍卖机制，已开源，589行代码； geneScience&nbsp;：基因工程，未开源。 以玩家挂单卖猫为例，说明相关步骤： 玩家在自己某只猫的页面点击出售按钮，设置出售价格，通过 MetaMask 钱包操作后等待（页面上猫的状态是非在售；MetaMask 交易状态是 pending 中）； MetaMask 将交易广播出去（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）； 交易被矿工打包到区块中（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）； 谜恋猫的以太坊节点监听到卖猫事件，更新数据库中猫的信息、更新缓存数据、更新搜索索引数据；MetaMask 的以太坊节点更新交易状态（页面上猫的状态是在售；MetaMask 交易状态是已完成）； 用户卖猫后，在页面上不是立即可以看到猫处于在售中，而是需要等待一会儿才能看到，整个过程是异步的。 这也为懂技术的玩家留下机会，可以在猫刚开卖还未在页面上显示出售中就能立即买下猫，详细方法见后文。 3. 谜恋猫游戏规则 3.1 以太坊钱包就是用户的 ID 一般涉及到用户数据的网站或 App，都会要用户注册帐号，哪怕是使用第三方授权。 而对于谜恋猫游戏，即使你之前从未访问过网站，只要有你的以太坊钱包地址，其他人就可以给你送猫。 安装&nbsp;MetaMask&nbsp;插件后第一次登陆网站，需要你按提示点击一个消息签名按钮，以便验证当前用户身份。 原理是椭圆曲线加密算法，相关函数为 web3.eth.sign(address, dataToSign)、ecRecover，具体用法可以搜索下。 3.2 买猫 在谜恋猫页面，点击顶部导航“猫市”，默认就是待收养的猫猫。点击“筛选猫咪”可以通过多种方式做筛选，找到自己的目标猫咪。初期玩建议按价格从低到高排序，选两三只便宜的猫咪。 搜索功能并不是直接从区块链读取数据的，而是通过同步区块链数据后在中心化服务器中建立的索引。 点击一只猫咪后，进入单个猫咪页面，再点击“立即购买”就可以买猫了。 在点击“立即购买”按钮时，会调用 web3js，触发弹出 MetaMask 插件窗口。MetaMask 插件中会显示 Amount（转账额度）、GasLimit（燃料上限）、GasPrice（燃料价格）等参数，部分数据做了隐藏，如购买猫调用的是 bid(uint256 _tokenId) 函数。 点击“submit”按钮后，MetaMask 会将交易数据提交到以太坊网络，等待矿工打包确认，当矿工将交易数据打包到某个区块中才算真正完成相关函数执行。 但成功打包到区块中不一定能成功买到猫，因为交易过程是异步的，在这个过程中也可能有其他人购买同一只猫，如果他人的交易比你的交易优先被矿工打包，你就买不到猫了。另外，卖家也可以取消卖猫。 在此简单说下以太坊的 Gas 机制，在以太坊中涉及到任何写数据的操作都有消耗 Gas，矿工打包一般优先打包 gasPrice 高的交易。 gas * gasPrice&nbsp;表示在操作过程中消耗的以太币，剩余的以太币&nbsp;（gasLimit - gas）* gasPrice&nbsp;会返回给用户。 一般来做操作越复杂，消耗的 Gas 越多，占用的存储空间越大，消耗的 Gas 越多。 3.3 卖猫和出租种猫 你买卖达成后后，平台会收取交易的 3.75% 作为手续费。因以太坊区块链上的数据对所有可见，卖猫不支持暗拍（备注：&nbsp;ENS支持安排，但相对复杂，不合适面向普通用户）。 为了让买家以相对和合适的价格找到相对合适的卖家，卖猫时，可以设置起始价、结束价、价格变化时间段（出售期限），价格变化时间段结束后，还会处于出售状态，价格保持为结束价。 当前价格的计算方法： &nbsp; &nbsp;/// @dev Computes the current price of an auction. Factored out &nbsp; &nbsp;/// &nbsp;from _currentPrice so we can run extensive unit tests. &nbsp; &nbsp;/// &nbsp;When testing, make this function public and turn on &nbsp; &nbsp;/// &nbsp;`Current price computation` test suite. &nbsp; &nbsp;function _computeCurrentPrice( &nbsp; &nbsp; &nbsp; &nbsp;uint256 _startingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _endingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _duration, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _secondsPassed ) &nbsp; &nbsp;internal &nbsp; &nbsp;pure &nbsp; &nbsp;returns (uint256) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;// NOTE: We don&#39;t use SafeMath (or similar) in this function because &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;all of our public functions carefully cap the maximum values for &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;time (at 64-bits) and currency (at 128-bits). _duration is &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;also known to be non-zero (see the require() statement in &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;_addAuction()) &nbsp; &nbsp; &nbsp; &nbsp;if (_secondsPassed &gt;= _duration) { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;ve reached the end of the dynamic pricing portion &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// of the auction, just return the end price. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return _endingPrice; &nbsp; &nbsp; &nbsp; &nbsp;} else { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Starting price can be higher than ending price (and often is!), so &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// this delta can be negative. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 totalPriceChange = int256(_endingPrice) - int256(_startingPrice); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// This multiplication can&#39;t overflow, _secondsPassed will easily fit within &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 64-bits, and totalPriceChange will easily fit within 128-bits, their product &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// will always fit within 256-bits. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPriceChange = totalPriceChange * int256(_secondsPassed) / int256(_duration); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// currentPriceChange can be negative, but if so, will have a magnitude &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// less that _startingPrice. Thus, this result will always end up positive. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPrice = int256(_startingPrice) + currentPriceChange; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return uint256(currentPrice); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} 3.4 出租种猫 出租种猫和卖猫类似，可以通过出租种猫赚钱，但所有权还是原主人的。相关合约见&nbsp;CryptoKittiesSiringAuction&nbsp;。 3.5 生猫 生猫规则如下： 任意猫都可以充当爸爸或妈妈的角色； 交配时不能乱伦； 每生育一次，恢复时间变长，直到需要7天时间恢复； 孕期 = 怀孕后妈妈的恢复时间，想尽快生出小猫的话，应该使用休息时间短的猫做妈妈； 小猫代数 = max(爸爸的代数，妈妈的代数) + 1； 小猫恢复时间 cooldown_index = min( 小猫代数 / 2 ,13)； 不同 cooldonw_index 对应的时间见下面内容。 生猫函数如下： ..... 扫码阅读全文 并与作者交流 近期热文 《区块链在哪些案例上发挥着重大作用》 《区块链落地中的九大问题与解法》 《比特币和区块链基础》 《穷人入门区块链指南》 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/04/18/b944914253e8ef7a5742ccb9818683b7.html" />
<meta property="og:url" content="https://mlh.app/2018/04/18/b944914253e8ef7a5742ccb9818683b7.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-18T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"本文来自作者&nbsp;崔广斌&nbsp;在&nbsp;GitChat&nbsp;上分享 「玩区块链游戏谜恋猫 CryptoKitties， 学习区块链技术赚 ETH」 编辑 | Mc Jin 便于读者更清晰阅读本文，先列出本文的内容大纲： 1.以太坊开发技术基础 2.&nbsp;谜恋猫系统结构 3. 谜恋猫游戏规则 4. 使用 web3js 读写区块链上的谜恋猫数据 5. 使用 api.cryptokitties.co 读取数据 6. 通过程序赚 ETH 7. 谜恋猫的一些统计数据 8. 玩谜恋猫的一些启发 9. 开发时遇到问题怎么办？ 1. 以太坊开发技术基础 1.1 以太坊概述 以太坊是可编程的区块链，是业内公认的区块链 2.0 代表项目。可以将以太坊理解为一个操作系统，使用 Solidity 等语言编写智能合约发布应用到链上，使用 Go、Java、Python、JavaScript 等语言在链下调用链上的智能合约读写区块链数据，通过这种方式实现各种各样的区块链应用。 比特币的总上限是2100万，而以太坊的内置代币以太币（Ether）没有确切的总量上限。目前以太坊大概每15秒出一个新块，一个新块奖励矿工 3 ETH 。 以太坊的设计者认为随着时间流逝总会发生因为粗心和死亡等原因带来的币的遗失，假设币的遗失是每年货币供应量的一个固定比例，则最终总的流通中的货币供应量会稳定在一个等于年货币发行量除以遗失率的值上，使得供应量会趋于稳定。 比特币缺少图灵完备性，尽管比特币脚本语言可以支持多种计算，但是它不能支持所有的计算，如不支持 for 循环。以太坊是准图灵完备的，之所以增加“准”，是因为智能合约在以太坊区块链上执行时是受限的。 在以太坊区块链上执行交易（转账、调用智能合约）需要消耗 Gas ，一般来说操作步骤越复杂需要的 Gas 越多，而一个块有 Gas 上限（目前约为 800万）。向普通账户做1次转账操作目前消耗 2.1 万 Gas。 在块 Gas 上限为 800 万时，假设调用一个智能合约中某个函数时会向400个账户转账，因为会至少消耗 400 * 2.1 万 = 820 万 Gas，超出块的 Gas 上限 800 万，合约调用会失败。 关于以太坊更详细的介绍可以参考：以太坊白皮书和以太坊黄皮书。 1.2 Solidity Solidity 是一种在语法上类似 JavaScript 的高级语言，编译 Solidity 代码可以生成以太坊虚拟机代码。 Solidity 是静态类型语言，支持继承、库和复杂的用户定义类型等特性。 使用 Solidity 可以很容易创建投票、众筹、封闭拍卖、多重签名钱包、谜恋猫游戏之类的智能合约。 由于以太坊区块链的限制，在链上无法读取链下数据，使用 Solidity 你也无法来调用传统的 API，例如你无法调用某天气网站提供的天气 API。 另外在以太坊区块链上，无法让程序在指定时间自动运行。 谜恋猫游戏为了真实性，在猫怀孕后不是立即生出小猫，而是需要在满足一定条件后由外部来触发生猫函数为猫提供接生服务，一些开发者根据游戏的这个特性还可以赚猫的接生费，后文会有详细说明。 etherscan.io&nbsp;提供了验证程序源码的服务。原理是使用公开的代码及指定的编译器版本再编译一次程序。 然后和发布到区块链的以太坊的二进制代码做比对，如果一致说明公开的代码就是在区块链上运行的那份代码。 下图是一份通过验证的代码截图。 可以访问这里，进一步了解 Solidity。 1.3 ERC-20 和 ERC-721 ERC-20&nbsp;和&nbsp;ERC-721&nbsp;都是以太坊 EIP（Ethereum Improvement Proposal，以太坊改进协议），更多 EIP 见这里。 ERC-20 定义了一份代币标准，可以理解为定义了一个接口类，在实现具体的 ERC-20 代币时，要给出各个接口的具体实现，如获取代币名称、代币符号、总供应量、小数位数、转账等。 使用 ERC-20，可以大幅度降低发币成本，发币方无需开发钱包和区块链浏览器，交易所也可以轻松支持新的代币充值提现等操作。 ERC-20 币是同质的，你的一个币和我的一个币是等价的。ERC-721 是非同质代币（Non-fungible Tokens），每个 ERC-721 有唯一的 ID，转账时，不再是转多少币，而是转某个tokenId，如 transferFrom： 谜恋猫实现了 ERC-721 规范，每个猫有一个唯一的 ID，玩家花 ETH 买猫时，智能合约会调用 transferFrom 修改猫的所有者。 1.4 搭建以太坊全节点 我使用了以太坊 Go 客户端搭建的全节点，参考文档见(https://github.com/ethereum/go-ethereum)，几个注意事项如下： 电脑配置不能太低。我刚开始使用的是阿里云1核 CPU、2500 MHz 的 ECS，发现怎么也同步不到最新块，升级到了4核后同步正常了； 第一次同步时使用&nbsp;- -fast&nbsp;选项，可以更快地同步到最新块，目前（2018-04-02）使用&nbsp;- -fast&nbsp;选项同步到最新块后预计占用 60G 空间； geth 运行时间长了可能会有问题，我使用守护进程启动 geth，每 4 个小时 kill 掉 geth，目前基本上能一直同步到最新块； 硬盘空间要足够大，建议至少1T以上。我3个月前使用&nbsp;- -fast&nbsp;同步完成后才占 40 多 G 空间，之后正常模式同步后硬盘占用空间快速增长，运行3个月左右已经 500G 了。 为了更方便、更快速的调用相关 API，建议在本地服务器上搭建一个以太坊全节点，并保持同步到最新区块高度。 如果想通过程序买卖猫但又不想自己搭建全节点，可以使用 MetaMask 的节点，API 地址请访问(mainnet.infura.io/metamask)，使用 MetaMask 的节点 API，监听事件可能会受到影响，一个方法是遍历某个区块的所有交易信息，然后选择自己关注的交易信息再做相关处理。 2. 谜恋猫系统结构 如果你还没有在&nbsp;www.cryptokitties.co&nbsp;买过猫，建议先买只猫后再阅读后续内容。一些入门攻略见(http://www.maomao123.co/faq)，遇到问题可通过谜恋猫 QQ 群（728507998）咨询。 2.1 谜恋猫 DApp 谜恋猫是一个 DApp（Decentralized Application），部分程序部署在区块链上，部分程序部署在中心化的服务器上，总体架构如下图： 2.2 谜恋猫智能合约 谜恋猫在以太坊区块链上一共有4个智能合约： CryptoKittiesCore&nbsp;：核心代码，已开源，2016行代码； CryptoKittiesSalesAuction&nbsp;：猫拍卖机制，已开源，604行代码； CryptoKittiesSiringAuction&nbsp;：配种拍卖机制，已开源，589行代码； geneScience&nbsp;：基因工程，未开源。 以玩家挂单卖猫为例，说明相关步骤： 玩家在自己某只猫的页面点击出售按钮，设置出售价格，通过 MetaMask 钱包操作后等待（页面上猫的状态是非在售；MetaMask 交易状态是 pending 中）； MetaMask 将交易广播出去（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）； 交易被矿工打包到区块中（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）； 谜恋猫的以太坊节点监听到卖猫事件，更新数据库中猫的信息、更新缓存数据、更新搜索索引数据；MetaMask 的以太坊节点更新交易状态（页面上猫的状态是在售；MetaMask 交易状态是已完成）； 用户卖猫后，在页面上不是立即可以看到猫处于在售中，而是需要等待一会儿才能看到，整个过程是异步的。 这也为懂技术的玩家留下机会，可以在猫刚开卖还未在页面上显示出售中就能立即买下猫，详细方法见后文。 3. 谜恋猫游戏规则 3.1 以太坊钱包就是用户的 ID 一般涉及到用户数据的网站或 App，都会要用户注册帐号，哪怕是使用第三方授权。 而对于谜恋猫游戏，即使你之前从未访问过网站，只要有你的以太坊钱包地址，其他人就可以给你送猫。 安装&nbsp;MetaMask&nbsp;插件后第一次登陆网站，需要你按提示点击一个消息签名按钮，以便验证当前用户身份。 原理是椭圆曲线加密算法，相关函数为 web3.eth.sign(address, dataToSign)、ecRecover，具体用法可以搜索下。 3.2 买猫 在谜恋猫页面，点击顶部导航“猫市”，默认就是待收养的猫猫。点击“筛选猫咪”可以通过多种方式做筛选，找到自己的目标猫咪。初期玩建议按价格从低到高排序，选两三只便宜的猫咪。 搜索功能并不是直接从区块链读取数据的，而是通过同步区块链数据后在中心化服务器中建立的索引。 点击一只猫咪后，进入单个猫咪页面，再点击“立即购买”就可以买猫了。 在点击“立即购买”按钮时，会调用 web3js，触发弹出 MetaMask 插件窗口。MetaMask 插件中会显示 Amount（转账额度）、GasLimit（燃料上限）、GasPrice（燃料价格）等参数，部分数据做了隐藏，如购买猫调用的是 bid(uint256 _tokenId) 函数。 点击“submit”按钮后，MetaMask 会将交易数据提交到以太坊网络，等待矿工打包确认，当矿工将交易数据打包到某个区块中才算真正完成相关函数执行。 但成功打包到区块中不一定能成功买到猫，因为交易过程是异步的，在这个过程中也可能有其他人购买同一只猫，如果他人的交易比你的交易优先被矿工打包，你就买不到猫了。另外，卖家也可以取消卖猫。 在此简单说下以太坊的 Gas 机制，在以太坊中涉及到任何写数据的操作都有消耗 Gas，矿工打包一般优先打包 gasPrice 高的交易。 gas * gasPrice&nbsp;表示在操作过程中消耗的以太币，剩余的以太币&nbsp;（gasLimit - gas）* gasPrice&nbsp;会返回给用户。 一般来做操作越复杂，消耗的 Gas 越多，占用的存储空间越大，消耗的 Gas 越多。 3.3 卖猫和出租种猫 你买卖达成后后，平台会收取交易的 3.75% 作为手续费。因以太坊区块链上的数据对所有可见，卖猫不支持暗拍（备注：&nbsp;ENS支持安排，但相对复杂，不合适面向普通用户）。 为了让买家以相对和合适的价格找到相对合适的卖家，卖猫时，可以设置起始价、结束价、价格变化时间段（出售期限），价格变化时间段结束后，还会处于出售状态，价格保持为结束价。 当前价格的计算方法： &nbsp; &nbsp;/// @dev Computes the current price of an auction. Factored out &nbsp; &nbsp;/// &nbsp;from _currentPrice so we can run extensive unit tests. &nbsp; &nbsp;/// &nbsp;When testing, make this function public and turn on &nbsp; &nbsp;/// &nbsp;`Current price computation` test suite. &nbsp; &nbsp;function _computeCurrentPrice( &nbsp; &nbsp; &nbsp; &nbsp;uint256 _startingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _endingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _duration, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _secondsPassed ) &nbsp; &nbsp;internal &nbsp; &nbsp;pure &nbsp; &nbsp;returns (uint256) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;// NOTE: We don&#39;t use SafeMath (or similar) in this function because &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;all of our public functions carefully cap the maximum values for &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;time (at 64-bits) and currency (at 128-bits). _duration is &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;also known to be non-zero (see the require() statement in &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;_addAuction()) &nbsp; &nbsp; &nbsp; &nbsp;if (_secondsPassed &gt;= _duration) { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;ve reached the end of the dynamic pricing portion &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// of the auction, just return the end price. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return _endingPrice; &nbsp; &nbsp; &nbsp; &nbsp;} else { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Starting price can be higher than ending price (and often is!), so &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// this delta can be negative. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 totalPriceChange = int256(_endingPrice) - int256(_startingPrice); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// This multiplication can&#39;t overflow, _secondsPassed will easily fit within &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 64-bits, and totalPriceChange will easily fit within 128-bits, their product &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// will always fit within 256-bits. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPriceChange = totalPriceChange * int256(_secondsPassed) / int256(_duration); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// currentPriceChange can be negative, but if so, will have a magnitude &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// less that _startingPrice. Thus, this result will always end up positive. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPrice = int256(_startingPrice) + currentPriceChange; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return uint256(currentPrice); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} 3.4 出租种猫 出租种猫和卖猫类似，可以通过出租种猫赚钱，但所有权还是原主人的。相关合约见&nbsp;CryptoKittiesSiringAuction&nbsp;。 3.5 生猫 生猫规则如下： 任意猫都可以充当爸爸或妈妈的角色； 交配时不能乱伦； 每生育一次，恢复时间变长，直到需要7天时间恢复； 孕期 = 怀孕后妈妈的恢复时间，想尽快生出小猫的话，应该使用休息时间短的猫做妈妈； 小猫代数 = max(爸爸的代数，妈妈的代数) + 1； 小猫恢复时间 cooldown_index = min( 小猫代数 / 2 ,13)； 不同 cooldonw_index 对应的时间见下面内容。 生猫函数如下： ..... 扫码阅读全文 并与作者交流 近期热文 《区块链在哪些案例上发挥着重大作用》 《区块链落地中的九大问题与解法》 《比特币和区块链基础》 《穷人入门区块链指南》 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/04/18/b944914253e8ef7a5742ccb9818683b7.html","headline":"从区块链游戏 CryptoKitties 中，学习区块链技","dateModified":"2018-04-18T00:00:00+08:00","datePublished":"2018-04-18T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/04/18/b944914253e8ef7a5742ccb9818683b7.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>从区块链游戏 CryptoKitties 中，学习区块链技</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div class="rich_media_content"> 
   <p style="margin-left:8px;"><img class="__bg_gif" style="color:rgb(62,62,62);" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_gif/0vU1ia3htaaNkJ6m9xkicNHd7rK9UzHjm9gI3jwia6gHYKpYUUyjsTjDp9xfMO9PzMuQ45fTwA8FicB0DmFyQAG5mg/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" alt="640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1"><br></p>
   <p style="min-height:1em;color:rgb(62,62,62);margin-left:8px;"><span style="font-size:13px;"><span style="color:rgb(178,178,178);">本文来自作者</span><span>&nbsp;</span><span style="color:rgb(85,85,85);">崔广斌</span><span>&nbsp;</span><span style="color:rgb(178,178,178);">在<strong>&nbsp;GitChat&nbsp;</strong>上分享 「玩区块链游戏谜恋猫 CryptoKitties， 学习区块链技术赚 ETH」</span></span></p>
   <p style="min-height:1em;color:rgb(62,62,62);margin-left:8px;"><span style="color:rgb(178,178,178);font-size:13px;">编辑 | Mc Jin</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">便于读者更清晰阅读本文，先列出本文的内容大纲：</span></p>
   <blockquote>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">1.以太坊开发技术基础</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">2.&nbsp;谜恋猫系统结构</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">3. 谜恋猫游戏规则</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">4. 使用 web3js 读写区块链上的谜恋猫数据</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">5. 使用 api.cryptokitties.co 读取数据</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">6. 通过程序赚 ETH</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">7. 谜恋猫的一些统计数据</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">8. 玩谜恋猫的一些启发</span></p>
    <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;">9. 开发时遇到问题怎么办？</span></p>
   </blockquote>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:12px;"></span></p>
   <h3 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);font-size:16px;"><strong>1. 以太坊开发技术基础</strong></span></h3>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><strong><span style="font-size:14px;color:rgb(239,154,0);">1.1 以太坊概述</span></strong></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">以太坊是可编程的区块链，是业内公认的区块链 2.0 代表项目。可以将以太坊理解为一个操作系统，使用 Solidity 等语言编写智能合约发布应用到链上，使用 Go、Java、Python、JavaScript 等语言在链下调用链上的智能合约读写区块链数据，通过这种方式实现各种各样的区块链应用。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">比特币的总上限是2100万，而以太坊的内置代币以太币（Ether）没有确切的总量上限。目前以太坊大概每15秒出一个新块，一个新块奖励矿工 3 ETH 。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">以太坊的设计者认为随着时间流逝总会发生因为粗心和死亡等原因带来的币的遗失，假设币的遗失是每年货币供应量的一个固定比例，则最终总的流通中的货币供应量会稳定在一个等于年货币发行量除以遗失率的值上，使得供应量会趋于稳定。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">比特币缺少图灵完备性，尽管比特币脚本语言可以支持多种计算，但是它不能支持所有的计算，如不支持 for 循环。以太坊是准图灵完备的，之所以增加“准”，是因为智能合约在以太坊区块链上执行时是受限的。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">在以太坊区块链上执行交易（转账、调用智能合约）需要消耗 Gas ，一般来说操作步骤越复杂需要的 Gas 越多，而一个块有 Gas 上限（目前约为 800万）。向普通账户做1次转账操作目前消耗 2.1 万 Gas。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">在块 Gas 上限为 800 万时，假设调用一个智能合约中某个函数时会向400个账户转账，因为会至少消耗 400 * 2.1 万 = 820 万 Gas，超出块的 Gas 上限 800 万，合约调用会失败。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">关于以太坊更详细的介绍可以参考：以太坊白皮书和以太坊黄皮书。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><strong><span style="font-size:14px;color:rgb(239,154,0);">1.2 Solidity</span></strong></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">Solidity 是一种在语法上类似 JavaScript 的高级语言，编译 Solidity 代码可以生成以太坊虚拟机代码。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">Solidity 是静态类型语言，支持继承、库和复杂的用户定义类型等特性。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">使用 Solidity 可以很容易创建投票、众筹、封闭拍卖、多重签名钱包、谜恋猫游戏之类的智能合约。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">由于以太坊区块链的限制，在链上无法读取链下数据，使用 Solidity 你也无法来调用传统的 API，例如你无法调用某天气网站提供的天气 API。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">另外在以太坊区块链上，无法让程序在指定时间自动运行。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">谜恋猫游戏为了真实性，在猫怀孕后不是立即生出小猫，而是需要在满足一定条件后由外部来触发生猫函数为猫提供接生服务，一些开发者根据游戏的这个特性还可以赚猫的接生费，后文会有详细说明。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">etherscan.io&nbsp;提供了验证程序源码的服务。原理是使用公开的代码及指定的编译器版本再编译一次程序。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">然后和发布到区块链的以太坊的二进制代码做比对，如果一致说明公开的代码就是在区块链上运行的那份代码。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">下图是一份通过验证的代码截图。</span></p>
   <p style="text-align:center;"><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:636.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXcMDCE4ZfRQ5gumkibc2PqdaaFcIGPiaUPicibq6LRwy8VsYWqF2lsbcmzQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">可以访问这里，进一步了解 Solidity。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">1.3 ERC-20 和 ERC-721</span></strong></span></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">ERC-20&nbsp;和&nbsp;ERC-721&nbsp;都是以太坊 EIP（Ethereum Improvement Proposal，以太坊改进协议），更多 EIP 见这里。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">ERC-20 定义了一份代币标准，可以理解为定义了一个接口类，在实现具体的 ERC-20 代币时，要给出各个接口的具体实现，如获取代币名称、代币符号、总供应量、小数位数、转账等。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">使用 ERC-20，可以大幅度降低发币成本，发币方无需开发钱包和区块链浏览器，交易所也可以轻松支持新的代币充值提现等操作。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">ERC-20 币是同质的，你的一个币和我的一个币是等价的。ERC-721 是非同质代币（Non-fungible Tokens），每个 ERC-721 有唯一的 ID，转账时，不再是转多少币，而是转某个tokenId，如 transferFrom：</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;"></span></p>
   <p style="text-align:center;margin-left:8px;"><img class="img_loading" style="width:588.59375px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXcfFfgdIrsUhfibeJvc6b59iccrt12jvnER0sP7t9IWjX4klMW0Yzaa0A/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">谜恋猫实现了 ERC-721 规范，每个猫有一个唯一的 ID，玩家花 ETH 买猫时，智能合约会调用 transferFrom 修改猫的所有者。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">1.4 搭建以太坊全节点</span></strong></span></h4>
   <p style="letter-spacing:1px;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">我使用了以太坊 Go 客户端搭建的全节点，参考文档见</span><span style="font-size:14px;color:rgb(136,136,136);">(https://github.com/ethereum/go-ethereum)</span><span style="color:rgb(68,68,68);font-size:14px;">，几个注意事项如下：</span></p>
   <ul style="margin-left:8px;" class="list-paddingleft-2">
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">电脑配置不能太低。我刚开始使用的是阿里云1核 CPU、2500 MHz 的 ECS，发现怎么也同步不到最新块，升级到了4核后同步正常了；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">第一次同步时使用&nbsp;- -fast&nbsp;选项，可以更快地同步到最新块，目前（2018-04-02）使用&nbsp;- -fast&nbsp;选项同步到最新块后预计占用 60G 空间；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">geth 运行时间长了可能会有问题，我使用守护进程启动 geth，每 4 个小时 kill 掉 geth，目前基本上能一直同步到最新块；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">硬盘空间要足够大，建议至少1T以上。我3个月前使用&nbsp;- -fast&nbsp;同步完成后才占 40 多 G 空间，之后正常模式同步后硬盘占用空间快速增长，运行3个月左右已经 500G 了。</span></p></li>
   </ul>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">为了更方便、更快速的调用相关 API，建议在本地服务器上搭建一个以太坊全节点，并保持同步到最新区块高度。</span></p>
   <p style="letter-spacing:1.5px;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">如果想通过程序买卖猫但又不想自己搭建全节点，可以使用 MetaMask 的节点，API 地址请访问</span><span style="color:rgb(136,136,136);font-size:14px;">(mainnet.infura.io/metamask)</span><span style="color:rgb(68,68,68);font-size:14px;">，使用 MetaMask 的节点 API，监听事件可能会受到影响，一个方法是遍历某个区块的所有交易信息，然后选择自己关注的交易信息再做相关处理。</span></p>
   <h3 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);font-size:16px;"><strong>2. 谜恋猫系统结构</strong></span></h3>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">如果你还没有在&nbsp;www.cryptokitties.co&nbsp;买过猫，建议先买只猫后再阅读后续内容。一些入门攻略见</span><span style="font-size:14px;color:rgb(136,136,136);">(http://www.maomao123.co/faq)</span><span style="color:rgb(68,68,68);font-size:14px;">，遇到问题可通过谜恋猫 QQ 群（728507998）咨询。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">2.1 谜恋猫 DApp</span></strong></span></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">谜恋猫是一个 DApp（Decentralized Application），部分程序部署在区块链上，部分程序部署在中心化的服务器上，总体架构如下图：</span></p>
   <p style="text-align:center;"><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:636.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDX4SRAKX4VgTXxvxkWLpcYsN3PTVibThNvibAuYfkeNDVXfGhyibLmPZvTg/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p style="text-align:center;"><br></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">2.2 谜恋猫智能合约</span></strong></span></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">谜恋猫在以太坊区块链上一共有4个智能合约：</span></p>
   <ul style="margin-left:8px;" class="list-paddingleft-2">
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">CryptoKittiesCore&nbsp;：核心代码，已开源，2016行代码；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">CryptoKittiesSalesAuction&nbsp;：猫拍卖机制，已开源，604行代码；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">CryptoKittiesSiringAuction&nbsp;：配种拍卖机制，已开源，589行代码；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">geneScience&nbsp;：基因工程，未开源。</span></p></li>
   </ul>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">以玩家挂单卖猫为例，说明相关步骤：</span></p>
   <ol style="margin-left:8px;" class="list-paddingleft-2">
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">玩家在自己某只猫的页面点击出售按钮，设置出售价格，通过 MetaMask 钱包操作后等待（页面上猫的状态是非在售；MetaMask 交易状态是 pending 中）；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">MetaMask 将交易广播出去（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">交易被矿工打包到区块中（页面上猫的状态是非在售；MetaMask 交易状态是 pending中）；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="color:rgb(68,68,68);font-size:14px;">谜恋猫的以太坊节点监听到卖猫事件，更新数据库中猫的信息、更新缓存数据、更新搜索索引数据；MetaMask 的以太坊节点更新交易状态（页面上猫的状态是在售；MetaMask 交易状态是已完成）；</span></p></li>
   </ol>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">用户卖猫后，在页面上不是立即可以看到猫处于在售中，而是需要等待一会儿才能看到，整个过程是异步的。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">这也为懂技术的玩家留下机会，可以在猫刚开卖还未在页面上显示出售中就能立即买下猫，详细方法见后文。</span></p>
   <h3 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:16px;color:rgb(239,154,0);"><strong>3. 谜恋猫游戏规则</strong></span></h3>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><strong><span style="font-size:14px;color:rgb(239,154,0);">3.1 以太坊钱包就是用户的 ID</span></strong></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">一般涉及到用户数据的网站或 App，都会要用户注册帐号，哪怕是使用第三方授权。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">而对于谜恋猫游戏，即使你之前从未访问过网站，只要有你的以太坊钱包地址，其他人就可以给你送猫。</span></p>
   <p><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:636.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXwSqfMPxePl1SpFmIF0jrKDo6bvgGp4lGdmgr0M1lYicB7JoQExDyPxQ/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">安装&nbsp;MetaMask&nbsp;插件后第一次登陆网站，需要你按提示点击一个消息签名按钮，以便验证当前用户身份。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">原理是椭圆曲线加密算法，相关函数为 web3.eth.sign(address, dataToSign)、ecRecover，具体用法可以搜索下。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><strong><span style="font-size:14px;color:rgb(239,154,0);">3.2 买猫</span></strong></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">在谜恋猫页面，点击顶部导航“猫市”，默认就是待收养的猫猫。点击“筛选猫咪”可以通过多种方式做筛选，找到自己的目标猫咪。初期玩建议按价格从低到高排序，选两三只便宜的猫咪。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">搜索功能并不是直接从区块链读取数据的，而是通过同步区块链数据后在中心化服务器中建立的索引。</span></p>
   <p><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:636.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXzG1K4NwadvfrY7n3F23IKuicbZV6knqvBa6UibQXfibLfpGgZcn7E3uhg/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">点击一只猫咪后，进入单个猫咪页面，再点击“立即购买”就可以买猫了。</span></p>
   <p><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:636.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXlbMJ2OeDSe56CUuPh5WQicHSe2Q3FlLYCKa9Lia3SXjRQicicFCLMzJFicQ/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">在点击“立即购买”按钮时，会调用 web3js，触发弹出 MetaMask 插件窗口。MetaMask 插件中会显示 Amount（转账额度）、GasLimit（燃料上限）、GasPrice（燃料价格）等参数，部分数据做了隐藏，如购买猫调用的是 bid(uint256 _tokenId) 函数。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">点击“submit”按钮后，MetaMask 会将交易数据提交到以太坊网络，等待矿工打包确认，当矿工将交易数据打包到某个区块中才算真正完成相关函数执行。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">但成功打包到区块中不一定能成功买到猫，因为交易过程是异步的，在这个过程中也可能有其他人购买同一只猫，如果他人的交易比你的交易优先被矿工打包，你就买不到猫了。另外，卖家也可以取消卖猫。</span></p>
   <p><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:569.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXL44T1HHouxkcRnzwusLf6Rk5zhImU9YX2ibeTrXCgRfPjkPn4qCaIIw/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">在此简单说下以太坊的 Gas 机制，在以太坊中涉及到任何写数据的操作都有消耗 Gas，矿工打包一般优先打包 gasPrice 高的交易。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">gas * gasPrice&nbsp;表示在操作过程中消耗的以太币，剩余的以太币&nbsp;（gasLimit - gas）* gasPrice&nbsp;会返回给用户。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">一般来做操作越复杂，消耗的 Gas 越多，占用的存储空间越大，消耗的 Gas 越多。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">3.3 卖猫和出租种猫</span></strong></span></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">你买卖达成后后，平台会收取交易的 3.75% 作为手续费。因以太坊区块链上的数据对所有可见，卖猫不支持暗拍（备注：&nbsp;ENS支持安排，但相对复杂，不合适面向普通用户）。</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">为了让买家以相对和合适的价格找到相对合适的卖家，卖猫时，可以设置起始价、结束价、价格变化时间段（出售期限），价格变化时间段结束后，还会处于出售状态，价格保持为结束价。</span></p>
   <p><img class="img_loading" style="vertical-align:middle;margin-left:auto;width:636.5px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXv4pmriaonibwFww8vYTEvJjDuI56A7icN3jXC6UhczqH7Jy5YlYAUWSQg/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;">当前价格的计算方法：</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;"></span></p>
   <pre style="font-size:1em;font-family:Consolas, Inconsolata, Courier, monospace;line-height:1.2em;"></pre>
   <p style="font-size:.85em;font-family:Consolas, Inconsolata, Courier, monospace;border-width:1px;border-style:solid;border-color:rgb(204,204,204);margin-left:8px;">&nbsp; &nbsp;/// @dev Computes the current price of an auction. Factored out &nbsp; &nbsp;/// &nbsp;from _currentPrice so we can run extensive unit tests. &nbsp; &nbsp;/// &nbsp;When testing, make this function public and turn on &nbsp; &nbsp;/// &nbsp;`Current price computation` test suite. &nbsp; &nbsp;function _computeCurrentPrice( &nbsp; &nbsp; &nbsp; &nbsp;uint256 _startingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _endingPrice, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _duration, &nbsp; &nbsp; &nbsp; &nbsp;uint256 _secondsPassed ) &nbsp; &nbsp;internal &nbsp; &nbsp;pure &nbsp; &nbsp;returns (uint256) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;// NOTE: We don't use SafeMath (or similar) in this function because &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;all of our public functions carefully cap the maximum values for &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;time (at 64-bits) and currency (at 128-bits). _duration is &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;also known to be non-zero (see the require() statement in &nbsp; &nbsp; &nbsp; &nbsp;// &nbsp;_addAuction()) &nbsp; &nbsp; &nbsp; &nbsp;if (_secondsPassed &gt;= _duration) { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We've reached the end of the dynamic pricing portion &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// of the auction, just return the end price. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return _endingPrice; &nbsp; &nbsp; &nbsp; &nbsp;} else { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Starting price can be higher than ending price (and often is!), so &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// this delta can be negative. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 totalPriceChange = int256(_endingPrice) - int256(_startingPrice); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// This multiplication can't overflow, _secondsPassed will easily fit within &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 64-bits, and totalPriceChange will easily fit within 128-bits, their product &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// will always fit within 256-bits. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPriceChange = totalPriceChange * int256(_secondsPassed) / int256(_duration); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// currentPriceChange can be negative, but if so, will have a magnitude &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// less that _startingPrice. Thus, this result will always end up positive. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int256 currentPrice = int256(_startingPrice) + currentPriceChange; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return uint256(currentPrice); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;}</p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">3.4 出租种猫</span></strong></span></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">出租种猫和卖猫类似，可以通过出租种猫赚钱，但所有权还是原主人的。相关合约见&nbsp;CryptoKittiesSiringAuction&nbsp;。</span></p>
   <h4 style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(239,154,0);"><strong><span style="font-size:14px;">3.5 生猫</span></strong></span></h4>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">生猫规则如下：</span></p>
   <ul style="margin-left:8px;" class="list-paddingleft-2">
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">任意猫都可以充当爸爸或妈妈的角色；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">交配时不能乱伦；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">每生育一次，恢复时间变长，直到需要7天时间恢复；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">孕期 = 怀孕后妈妈的恢复时间，想尽快生出小猫的话，应该使用休息时间短的猫做妈妈；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">小猫代数 = max(爸爸的代数，妈妈的代数) + 1；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">小猫恢复时间 cooldown_index = min( 小猫代数 / 2 ,13)；</span></p></li>
    <li><p style="letter-spacing:1.5px;line-height:1.75em;"><span style="font-size:14px;color:rgb(68,68,68);">不同 cooldonw_index 对应的时间见下面内容。</span></p></li>
   </ul>
   <p style="letter-spacing:1.5px;line-height:1.75em;text-align:center;margin-left:8px;"><img class="img_loading" style="width:621.296875px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDX0tXBmutlMlZJVAOq9FRkrqzTXdo5l7qQbuSLcKgpUVbzIwqIQoNp4g/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">生猫函数如下：</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(68,68,68);">.....</span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;text-align:center;margin-left:8px;"><strong><span style="font-size:14px;color:rgb(255,76,65);">扫码阅读全文</span></strong></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;text-align:center;margin-left:8px;"><strong><span style="color:#444444;"><span style="font-size:14px;color:rgb(255,76,65);">并与作者交流</span></span></strong></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;text-align:center;margin-left:8px;"><img class="img_loading" style="width:228.890625px;" src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/0vU1ia3htaaNfuyQ4lWictkNPUMAaC4iaDXQjlA7ENXhNE4dxp217gxuaMcFALQHlTp00zIXMkVLY69U3uBpuaIVw/640?wx_fmt=png" alt="640?wx_fmt=png"></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;text-align:left;margin-left:8px;"><span style="color:rgb(68,68,68);font-size:14px;"></span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><strong><span style="font-size:15px;color:rgb(239,154,0);">近期热文</span></strong></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(136,136,136);"><strong>《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNjEwNTQ4Mw==&amp;mid=2651579440&amp;idx=3&amp;sn=54310f2da6b5079feb7ce71c84a1b884&amp;chksm=8cd9fad4bbae73c2486198336eaaa5e186d80d2bd8f6563df0b09c2e908b8484a6aa0579a3ac&amp;scene=21#wechat_redirect" rel="nofollow">区块链在哪些案例上发挥着重大作用</a>》</strong></span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="font-size:14px;color:rgb(136,136,136);"><strong>《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNjEwNTQ4Mw==&amp;mid=2651578006&amp;idx=1&amp;sn=ae3f15a0a566c0bea7ecd3c638c19c06&amp;chksm=8cd9c072bbae4964c0063aeee3b42df1e71b6a15a474a912921bfd17f39b7621acea8d70c0b3&amp;scene=21#wechat_redirect" rel="nofollow">区块链落地中的九大问题与解法</a>》</strong></span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:14px;"><strong>《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNjEwNTQ4Mw==&amp;mid=2651577783&amp;idx=1&amp;sn=1e4da4500a0952741e16a9bcab905d9d&amp;chksm=8cd9c353bbae4a45c753c06b2c42f2d968b62bf5fed76f454e68f5ab17ac9c87e0b59d606122&amp;scene=21#wechat_redirect" rel="nofollow">比特币和区块链基础</a>》</strong></span></p>
   <p style="letter-spacing:1.5px;line-height:1.75em;margin-left:8px;"><span style="color:rgb(136,136,136);font-size:14px;"><strong>《<a href="http://mp.weixin.qq.com/s?__biz=MzIwNjEwNTQ4Mw==&amp;mid=2651581217&amp;idx=1&amp;sn=110143ef0484719ac93ca508941835bc&amp;chksm=8cd9f5c5bbae7cd357225685a88b095602bf4faa87801caf60b449b1b77d7e30b43cdc811352&amp;scene=21#wechat_redirect" rel="nofollow">穷人入门区块链指南</a>》</strong></span></p> 
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/GitChat/article/details/79987373,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/GitChat/article/details/79987373,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
