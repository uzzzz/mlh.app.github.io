<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>智能卡 复旦卡 电子钱包圈存 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="智能卡 复旦卡 电子钱包圈存" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="在之前的开卡实验的基础上继续开卡： https://blog.csdn.net/wowocpp/article/details/80018122 SmartCard Reader Cnt dw =1, i=0,Gemplus USB Smart Card Reader 0 Gemplus USB Smart Card Reader 0 连接读卡器: Gemplus USB Smart Card Reader 0 通讯协议: T0 1，外部认证 Send Data : 00 84 00 00 04 Recv Data : 73 66 BE 39 90 00 Send Data : 00 82 00 00 08 9C A5 30 B8 D3 81 CB F0 Recv Data : 90 00 2，选择MF Send Data : 00 A4 00 00 00 Recv Data : 61 17 Send Data : 00 C0 00 00 17 Recv Data : 6F 15 84 0E 31 50 41 59 2E 53 59 53 2E 44 44 46 30 31 A5 03 88 01 01 90 00 3，创建3F01目录失败 Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 Recv Data : 69 82 4，再次外部认证 Send Data : 00 84 00 00 04 Recv Data : F3 6F 75 46 90 00 Send Data : 00 82 00 00 08 8F 82 A0 24 59 65 55 53 Recv Data : 90 00 5，创建3F01目录成功 Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 Recv Data : 90 00 6，选择3F01目录 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 0D Send Data : 00 C0 00 00 0D Recv Data : 6F 0B 84 09 A0 00 00 00 03 86 98 07 01 90 00 7，创建密钥文件，位于3F01目录下面 Send Data : 80 E0 00 00 07 3F 01 8F 95 F0 FF FF Recv Data : 90 00 8，装载密钥 到密钥文件 Send Data : 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 Recv Data : 90 00 Send Data : 80 D4 01 00 15 36 F0 02 FF 33 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 Recv Data : 90 00 Send Data : 80 D4 01 00 15 37 F0 02 FF 33 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 Recv Data : 90 00 Send Data : 80 D4 01 00 15 38 F0 02 FF 33 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 Recv Data : 90 00 Send Data : 80 D4 01 00 15 39 F0 02 44 33 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3E F0 02 00 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3E F0 02 00 01 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3F F0 02 00 01 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3D F0 02 01 00 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3D F0 02 01 00 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3C F0 02 01 00 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3C F0 02 01 00 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 Recv Data : 90 00 Send Data : 80 D4 01 00 0D 3A F0 EF 01 33 12 34 5F FF FF FF FF FF Recv Data : 90 00 9，创建15号文件（二进制文件）建立二进制文件(线路保护读写) Send Data : 80 E0 00 15 07 A8 00 1E F0 F0 FF FF Recv Data : 90 00 10 ,创建16号文件（二进制文件） Send Data : 80 E0 00 16 07 A8 00 27 F0 F0 FF FF Recv Data : 90 00 11 ,创建17号文件（二进制文件） Send Data : 80 E0 00 17 07 28 05 DC F0 F0 FF FF Recv Data : 6A 84 12 ,创建18号文件（循环文件） Send Data : 80 E0 00 18 07 2E 0A 17 F0 EF FF FF Recv Data : 90 00 13 ,创建钱包文件(电子存折) Send Data : 80 E0 00 01 07 2F 02 08 F1 00 FF 18 Recv Data : 90 00 14 ,创建钱包文件(电子钱包) Send Data : 80 E0 00 02 07 2F 02 08 F0 00 FF 18 Recv Data : 90 00 验证PIN码： Send Data : 00 84 00 00 04 Recv Data : 56 14 5E 12 90 00 Send Data : 00 82 00 00 08 8E 69 F2 24 E5 4B A7 B4 Recv Data : 90 00 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 34 Send Data : 00 C0 00 00 34 Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 Send Data : 00 20 00 00 03 12 34 5F Recv Data : 90 00 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 10 初始化圈存 重新插拔卡片： Gemplus USB Smart Card Reader 0 连接读卡器: Gemplus USB Smart Card Reader 0 通讯协议: T0 外部认证 Send Data : 00 84 00 00 04 Recv Data : 0A F3 B2 B5 90 00 Send Data : 00 82 00 00 08 D8 9D DB 8F 53 F5 08 19 Recv Data : 90 00 进入目录3F01 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 34 Send Data : 00 C0 00 00 34 Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 校验pin码 Send Data : 00 20 00 00 03 12 34 5F Recv Data : 90 00 读余额 Send Data : 80 5C 00 01 04 Recv Data : 00 00 00 00 90 00 初始化圈存 Send Data : 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 Recv Data : 61 10 Send Data : 00 C0 00 00 10 Recv Data : 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 90 00 圈存： Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 Recv Data : 61 04 Send Data : 00 C0 00 00 04 Recv Data : 0E C7 8E 36 90 00 读余额 Send Data : 80 5C 00 02 04 Recv Data : 00 00 12 34 90 00 说明圈存成功了 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 CLA INS P1 P2 LC 密钥标识符 交易金额 终端机编号 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 密钥标识01 交易金额 00001234 终端机编号 000000000001 返回16个字节: 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 卡片余额 交易序号 密钥版本号 算法标识 随机数 MAC1 21, 圈存密钥 圈存密钥01 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 内部密钥的装载： 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 装载不同的消费密钥根据密钥版本号来区分，CPU卡中消费密钥密钥版本要和PSAM卡中密钥版本相同 还有算法标识 00-3DES 01-DES 02-255保留 注意：消费密钥的密钥版本是在消费过程中标识密钥版本，其他的密钥的密钥版本作为密钥标识使用 校验一下 MAC1： 2F 73 55 FC 0000 8000 (8bytes) 随机数 交易序号 填充数据 inputdata: 2F7355FC00008000 LoadKey = 3F013F013F013F013F013F013F013F01 SessionKey = 3DES_Enypt(InputData, LoadKey) = D1C6AEAD4E49990F 用LoadKey对InputData 做3DES加密得到D1C6AEAD4E49990F 密钥: 3F013F013F013F013F013F013F013F01 数据： 2F7355FC00008000 加密： D1C6AEAD4E49990F 2.计算MAC1（4字节） 00000000 00 00 12 34 02 00 00 00 00 00 01 卡片余额 交易金额 交易类型 终端机编号 密钥 : D1C6AEAD4E49990F 初始向量： 0000000000000000 InputData1 ： 000000000000123402000000000001 计算MAC1值： 5FC1AEE43854A977 验证正确： 计算MAC2 00 00 12 34 02 00 00 00 00 00 01 20180425 155922 交易金额 交易类型 终端机编号 交易日期 交易时间 InputData2=000012340200000000000120180425155922 密钥： D1C6AEAD4E49990F 初始向量： 0000000000000000 数据 ： 000012340200000000000120180425155922 计算MAC: 2541D84488CC8BB0 取前4个字节： MAC2 = 2541D844 发送圈存命令： Apdu: CLA INS P1 P2 LC 交易日期 交易时间 MAC2 80 52 00 00 0B 20180425 155922 2541D844 80 52 00 00 0B 20180425 155922 2541D844 发送之后得到回应： Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 Recv Data : 61 04 Send Data : 00 C0 00 00 04 Recv Data : 0E C7 8E 36 90 00 TAC : 0EC78E36 : 进行校验： 内部密钥为：34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 TacKey.Left(8) = 3434343434343434 TacKey.Right(8) = 3434343434343434 XOR 结果 = 0000000000000000 00 00 12 34 0000 00 00 12 34 02 00 00 00 00 00 01 20180425 155922 新余额 交易序号旧 交易金额 交易类型 终端机编号 交易日期 交易时间 InputData3=000012340000000012340200000000000120180425155922 密钥： 0000000000000000 初始向量： 0000000000000000 数据： 000012340000000012340200000000000120180425155922 计算MAC ： 0EC78E36AB07F7FF TAC : 0EC78E36 : 阅读更多" />
<meta property="og:description" content="在之前的开卡实验的基础上继续开卡： https://blog.csdn.net/wowocpp/article/details/80018122 SmartCard Reader Cnt dw =1, i=0,Gemplus USB Smart Card Reader 0 Gemplus USB Smart Card Reader 0 连接读卡器: Gemplus USB Smart Card Reader 0 通讯协议: T0 1，外部认证 Send Data : 00 84 00 00 04 Recv Data : 73 66 BE 39 90 00 Send Data : 00 82 00 00 08 9C A5 30 B8 D3 81 CB F0 Recv Data : 90 00 2，选择MF Send Data : 00 A4 00 00 00 Recv Data : 61 17 Send Data : 00 C0 00 00 17 Recv Data : 6F 15 84 0E 31 50 41 59 2E 53 59 53 2E 44 44 46 30 31 A5 03 88 01 01 90 00 3，创建3F01目录失败 Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 Recv Data : 69 82 4，再次外部认证 Send Data : 00 84 00 00 04 Recv Data : F3 6F 75 46 90 00 Send Data : 00 82 00 00 08 8F 82 A0 24 59 65 55 53 Recv Data : 90 00 5，创建3F01目录成功 Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 Recv Data : 90 00 6，选择3F01目录 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 0D Send Data : 00 C0 00 00 0D Recv Data : 6F 0B 84 09 A0 00 00 00 03 86 98 07 01 90 00 7，创建密钥文件，位于3F01目录下面 Send Data : 80 E0 00 00 07 3F 01 8F 95 F0 FF FF Recv Data : 90 00 8，装载密钥 到密钥文件 Send Data : 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 Recv Data : 90 00 Send Data : 80 D4 01 00 15 36 F0 02 FF 33 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 Recv Data : 90 00 Send Data : 80 D4 01 00 15 37 F0 02 FF 33 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 Recv Data : 90 00 Send Data : 80 D4 01 00 15 38 F0 02 FF 33 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 Recv Data : 90 00 Send Data : 80 D4 01 00 15 39 F0 02 44 33 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3E F0 02 00 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3E F0 02 00 01 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3F F0 02 00 01 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3D F0 02 01 00 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3D F0 02 01 00 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3C F0 02 01 00 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3C F0 02 01 00 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 Recv Data : 90 00 Send Data : 80 D4 01 00 0D 3A F0 EF 01 33 12 34 5F FF FF FF FF FF Recv Data : 90 00 9，创建15号文件（二进制文件）建立二进制文件(线路保护读写) Send Data : 80 E0 00 15 07 A8 00 1E F0 F0 FF FF Recv Data : 90 00 10 ,创建16号文件（二进制文件） Send Data : 80 E0 00 16 07 A8 00 27 F0 F0 FF FF Recv Data : 90 00 11 ,创建17号文件（二进制文件） Send Data : 80 E0 00 17 07 28 05 DC F0 F0 FF FF Recv Data : 6A 84 12 ,创建18号文件（循环文件） Send Data : 80 E0 00 18 07 2E 0A 17 F0 EF FF FF Recv Data : 90 00 13 ,创建钱包文件(电子存折) Send Data : 80 E0 00 01 07 2F 02 08 F1 00 FF 18 Recv Data : 90 00 14 ,创建钱包文件(电子钱包) Send Data : 80 E0 00 02 07 2F 02 08 F0 00 FF 18 Recv Data : 90 00 验证PIN码： Send Data : 00 84 00 00 04 Recv Data : 56 14 5E 12 90 00 Send Data : 00 82 00 00 08 8E 69 F2 24 E5 4B A7 B4 Recv Data : 90 00 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 34 Send Data : 00 C0 00 00 34 Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 Send Data : 00 20 00 00 03 12 34 5F Recv Data : 90 00 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 10 初始化圈存 重新插拔卡片： Gemplus USB Smart Card Reader 0 连接读卡器: Gemplus USB Smart Card Reader 0 通讯协议: T0 外部认证 Send Data : 00 84 00 00 04 Recv Data : 0A F3 B2 B5 90 00 Send Data : 00 82 00 00 08 D8 9D DB 8F 53 F5 08 19 Recv Data : 90 00 进入目录3F01 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 34 Send Data : 00 C0 00 00 34 Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 校验pin码 Send Data : 00 20 00 00 03 12 34 5F Recv Data : 90 00 读余额 Send Data : 80 5C 00 01 04 Recv Data : 00 00 00 00 90 00 初始化圈存 Send Data : 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 Recv Data : 61 10 Send Data : 00 C0 00 00 10 Recv Data : 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 90 00 圈存： Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 Recv Data : 61 04 Send Data : 00 C0 00 00 04 Recv Data : 0E C7 8E 36 90 00 读余额 Send Data : 80 5C 00 02 04 Recv Data : 00 00 12 34 90 00 说明圈存成功了 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 CLA INS P1 P2 LC 密钥标识符 交易金额 终端机编号 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 密钥标识01 交易金额 00001234 终端机编号 000000000001 返回16个字节: 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 卡片余额 交易序号 密钥版本号 算法标识 随机数 MAC1 21, 圈存密钥 圈存密钥01 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 内部密钥的装载： 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 装载不同的消费密钥根据密钥版本号来区分，CPU卡中消费密钥密钥版本要和PSAM卡中密钥版本相同 还有算法标识 00-3DES 01-DES 02-255保留 注意：消费密钥的密钥版本是在消费过程中标识密钥版本，其他的密钥的密钥版本作为密钥标识使用 校验一下 MAC1： 2F 73 55 FC 0000 8000 (8bytes) 随机数 交易序号 填充数据 inputdata: 2F7355FC00008000 LoadKey = 3F013F013F013F013F013F013F013F01 SessionKey = 3DES_Enypt(InputData, LoadKey) = D1C6AEAD4E49990F 用LoadKey对InputData 做3DES加密得到D1C6AEAD4E49990F 密钥: 3F013F013F013F013F013F013F013F01 数据： 2F7355FC00008000 加密： D1C6AEAD4E49990F 2.计算MAC1（4字节） 00000000 00 00 12 34 02 00 00 00 00 00 01 卡片余额 交易金额 交易类型 终端机编号 密钥 : D1C6AEAD4E49990F 初始向量： 0000000000000000 InputData1 ： 000000000000123402000000000001 计算MAC1值： 5FC1AEE43854A977 验证正确： 计算MAC2 00 00 12 34 02 00 00 00 00 00 01 20180425 155922 交易金额 交易类型 终端机编号 交易日期 交易时间 InputData2=000012340200000000000120180425155922 密钥： D1C6AEAD4E49990F 初始向量： 0000000000000000 数据 ： 000012340200000000000120180425155922 计算MAC: 2541D84488CC8BB0 取前4个字节： MAC2 = 2541D844 发送圈存命令： Apdu: CLA INS P1 P2 LC 交易日期 交易时间 MAC2 80 52 00 00 0B 20180425 155922 2541D844 80 52 00 00 0B 20180425 155922 2541D844 发送之后得到回应： Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 Recv Data : 61 04 Send Data : 00 C0 00 00 04 Recv Data : 0E C7 8E 36 90 00 TAC : 0EC78E36 : 进行校验： 内部密钥为：34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 TacKey.Left(8) = 3434343434343434 TacKey.Right(8) = 3434343434343434 XOR 结果 = 0000000000000000 00 00 12 34 0000 00 00 12 34 02 00 00 00 00 00 01 20180425 155922 新余额 交易序号旧 交易金额 交易类型 终端机编号 交易日期 交易时间 InputData3=000012340000000012340200000000000120180425155922 密钥： 0000000000000000 初始向量： 0000000000000000 数据： 000012340000000012340200000000000120180425155922 计算MAC ： 0EC78E36AB07F7FF TAC : 0EC78E36 : 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-04-20T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"在之前的开卡实验的基础上继续开卡： https://blog.csdn.net/wowocpp/article/details/80018122 SmartCard Reader Cnt dw =1, i=0,Gemplus USB Smart Card Reader 0 Gemplus USB Smart Card Reader 0 连接读卡器: Gemplus USB Smart Card Reader 0 通讯协议: T0 1，外部认证 Send Data : 00 84 00 00 04 Recv Data : 73 66 BE 39 90 00 Send Data : 00 82 00 00 08 9C A5 30 B8 D3 81 CB F0 Recv Data : 90 00 2，选择MF Send Data : 00 A4 00 00 00 Recv Data : 61 17 Send Data : 00 C0 00 00 17 Recv Data : 6F 15 84 0E 31 50 41 59 2E 53 59 53 2E 44 44 46 30 31 A5 03 88 01 01 90 00 3，创建3F01目录失败 Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 Recv Data : 69 82 4，再次外部认证 Send Data : 00 84 00 00 04 Recv Data : F3 6F 75 46 90 00 Send Data : 00 82 00 00 08 8F 82 A0 24 59 65 55 53 Recv Data : 90 00 5，创建3F01目录成功 Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 Recv Data : 90 00 6，选择3F01目录 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 0D Send Data : 00 C0 00 00 0D Recv Data : 6F 0B 84 09 A0 00 00 00 03 86 98 07 01 90 00 7，创建密钥文件，位于3F01目录下面 Send Data : 80 E0 00 00 07 3F 01 8F 95 F0 FF FF Recv Data : 90 00 8，装载密钥 到密钥文件 Send Data : 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 Recv Data : 90 00 Send Data : 80 D4 01 00 15 36 F0 02 FF 33 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 Recv Data : 90 00 Send Data : 80 D4 01 00 15 37 F0 02 FF 33 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 Recv Data : 90 00 Send Data : 80 D4 01 00 15 38 F0 02 FF 33 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 Recv Data : 90 00 Send Data : 80 D4 01 00 15 39 F0 02 44 33 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3E F0 02 00 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3E F0 02 00 01 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3F F0 02 00 01 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3D F0 02 01 00 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3D F0 02 01 00 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 Recv Data : 90 00 Send Data : 80 D4 01 01 15 3C F0 02 01 00 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 Recv Data : 90 00 Send Data : 80 D4 01 02 15 3C F0 02 01 00 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 Recv Data : 90 00 Send Data : 80 D4 01 00 0D 3A F0 EF 01 33 12 34 5F FF FF FF FF FF Recv Data : 90 00 9，创建15号文件（二进制文件）建立二进制文件(线路保护读写) Send Data : 80 E0 00 15 07 A8 00 1E F0 F0 FF FF Recv Data : 90 00 10 ,创建16号文件（二进制文件） Send Data : 80 E0 00 16 07 A8 00 27 F0 F0 FF FF Recv Data : 90 00 11 ,创建17号文件（二进制文件） Send Data : 80 E0 00 17 07 28 05 DC F0 F0 FF FF Recv Data : 6A 84 12 ,创建18号文件（循环文件） Send Data : 80 E0 00 18 07 2E 0A 17 F0 EF FF FF Recv Data : 90 00 13 ,创建钱包文件(电子存折) Send Data : 80 E0 00 01 07 2F 02 08 F1 00 FF 18 Recv Data : 90 00 14 ,创建钱包文件(电子钱包) Send Data : 80 E0 00 02 07 2F 02 08 F0 00 FF 18 Recv Data : 90 00 验证PIN码： Send Data : 00 84 00 00 04 Recv Data : 56 14 5E 12 90 00 Send Data : 00 82 00 00 08 8E 69 F2 24 E5 4B A7 B4 Recv Data : 90 00 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 34 Send Data : 00 C0 00 00 34 Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 Send Data : 00 20 00 00 03 12 34 5F Recv Data : 90 00 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 10 初始化圈存 重新插拔卡片： Gemplus USB Smart Card Reader 0 连接读卡器: Gemplus USB Smart Card Reader 0 通讯协议: T0 外部认证 Send Data : 00 84 00 00 04 Recv Data : 0A F3 B2 B5 90 00 Send Data : 00 82 00 00 08 D8 9D DB 8F 53 F5 08 19 Recv Data : 90 00 进入目录3F01 Send Data : 00 A4 00 00 02 3F 01 Recv Data : 61 34 Send Data : 00 C0 00 00 34 Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 校验pin码 Send Data : 00 20 00 00 03 12 34 5F Recv Data : 90 00 读余额 Send Data : 80 5C 00 01 04 Recv Data : 00 00 00 00 90 00 初始化圈存 Send Data : 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 Recv Data : 61 10 Send Data : 00 C0 00 00 10 Recv Data : 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 90 00 圈存： Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 Recv Data : 61 04 Send Data : 00 C0 00 00 04 Recv Data : 0E C7 8E 36 90 00 读余额 Send Data : 80 5C 00 02 04 Recv Data : 00 00 12 34 90 00 说明圈存成功了 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 CLA INS P1 P2 LC 密钥标识符 交易金额 终端机编号 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 密钥标识01 交易金额 00001234 终端机编号 000000000001 返回16个字节: 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 卡片余额 交易序号 密钥版本号 算法标识 随机数 MAC1 21, 圈存密钥 圈存密钥01 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 内部密钥的装载： 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 装载不同的消费密钥根据密钥版本号来区分，CPU卡中消费密钥密钥版本要和PSAM卡中密钥版本相同 还有算法标识 00-3DES 01-DES 02-255保留 注意：消费密钥的密钥版本是在消费过程中标识密钥版本，其他的密钥的密钥版本作为密钥标识使用 校验一下 MAC1： 2F 73 55 FC 0000 8000 (8bytes) 随机数 交易序号 填充数据 inputdata: 2F7355FC00008000 LoadKey = 3F013F013F013F013F013F013F013F01 SessionKey = 3DES_Enypt(InputData, LoadKey) = D1C6AEAD4E49990F 用LoadKey对InputData 做3DES加密得到D1C6AEAD4E49990F 密钥: 3F013F013F013F013F013F013F013F01 数据： 2F7355FC00008000 加密： D1C6AEAD4E49990F 2.计算MAC1（4字节） 00000000 00 00 12 34 02 00 00 00 00 00 01 卡片余额 交易金额 交易类型 终端机编号 密钥 : D1C6AEAD4E49990F 初始向量： 0000000000000000 InputData1 ： 000000000000123402000000000001 计算MAC1值： 5FC1AEE43854A977 验证正确： 计算MAC2 00 00 12 34 02 00 00 00 00 00 01 20180425 155922 交易金额 交易类型 终端机编号 交易日期 交易时间 InputData2=000012340200000000000120180425155922 密钥： D1C6AEAD4E49990F 初始向量： 0000000000000000 数据 ： 000012340200000000000120180425155922 计算MAC: 2541D84488CC8BB0 取前4个字节： MAC2 = 2541D844 发送圈存命令： Apdu: CLA INS P1 P2 LC 交易日期 交易时间 MAC2 80 52 00 00 0B 20180425 155922 2541D844 80 52 00 00 0B 20180425 155922 2541D844 发送之后得到回应： Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 Recv Data : 61 04 Send Data : 00 C0 00 00 04 Recv Data : 0E C7 8E 36 90 00 TAC : 0EC78E36 : 进行校验： 内部密钥为：34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 TacKey.Left(8) = 3434343434343434 TacKey.Right(8) = 3434343434343434 XOR 结果 = 0000000000000000 00 00 12 34 0000 00 00 12 34 02 00 00 00 00 00 01 20180425 155922 新余额 交易序号旧 交易金额 交易类型 终端机编号 交易日期 交易时间 InputData3=000012340000000012340200000000000120180425155922 密钥： 0000000000000000 初始向量： 0000000000000000 数据： 000012340000000012340200000000000120180425155922 计算MAC ： 0EC78E36AB07F7FF TAC : 0EC78E36 : 阅读更多","@type":"BlogPosting","url":"/2018/04/20/5fdaf0b5132150bfd0d8aaa82546d48a.html","headline":"智能卡 复旦卡 电子钱包圈存","dateModified":"2018-04-20T00:00:00+08:00","datePublished":"2018-04-20T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/04/20/5fdaf0b5132150bfd0d8aaa82546d48a.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>智能卡 复旦卡 电子钱包圈存</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <p>在之前的开卡实验的基础上继续开卡：</p> 
  <p><a href="https://blog.csdn.net/wowocpp/article/details/80018122" rel="nofollow">https://blog.csdn.net/wowocpp/article/details/80018122</a></p> 
  <p>SmartCard Reader Cnt dw =1, <br> i=0,Gemplus USB Smart Card Reader 0 <br> Gemplus USB Smart Card Reader 0 <br> 连接读卡器: Gemplus USB Smart Card Reader 0 <br> 通讯协议: T0</p> 
  <h4 id="1外部认证">1，外部认证</h4> 
  <p>Send Data : 00 84 00 00 04 <br> Recv Data : 73 66 BE 39 90 00 <br> Send Data : 00 82 00 00 08 9C A5 30 B8 D3 81 CB F0 <br> Recv Data : 90 00 </p> 
  <h4 id="2选择mf">2，选择MF</h4> 
  <p>Send Data : 00 A4 00 00 00 <br> Recv Data : 61 17 <br> Send Data : 00 C0 00 00 17 <br> Recv Data : 6F 15 84 0E 31 50 41 59 2E 53 59 53 2E 44 44 46 30 31 A5 03 88 01 01 90 00 </p> 
  <h4 id="3创建3f01目录失败">3，创建3F01目录失败</h4> 
  <p>Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 <br> Recv Data : 69 82 </p> 
  <h4 id="4再次外部认证">4，再次外部认证</h4> 
  <p>Send Data : 00 84 00 00 04 <br> Recv Data : F3 6F 75 46 90 00 <br> Send Data : 00 82 00 00 08 8F 82 A0 24 59 65 55 53 <br> Recv Data : 90 00 </p> 
  <h4 id="5创建3f01目录成功">5，创建3F01目录成功</h4> 
  <p>Send Data : 80 E0 3F 01 11 38 03 6F F0 F0 95 FF FF A0 00 00 00 03 86 98 07 01 <br> Recv Data : 90 00 </p> 
  <h4 id="6选择3f01目录">6，选择3F01目录</h4> 
  <p>Send Data : 00 A4 00 00 02 3F 01 <br> Recv Data : 61 0D <br> Send Data : 00 C0 00 00 0D <br> Recv Data : 6F 0B 84 09 A0 00 00 00 03 86 98 07 01 90 00 </p> 
  <h4 id="7创建密钥文件位于3f01目录下面">7，创建密钥文件，位于3F01目录下面</h4> 
  <p>Send Data : 80 E0 00 00 07 3F 01 8F 95 F0 FF FF <br> Recv Data : 90 00 </p> 
  <h4 id="8装载密钥-到密钥文件">8，装载密钥 到密钥文件</h4> 
  <p>Send Data : 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 00 15 36 F0 02 FF 33 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 36 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 00 15 37 F0 02 FF 33 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 37 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 00 15 38 F0 02 FF 33 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 38 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 00 15 39 F0 02 44 33 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 39 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 01 15 3E F0 02 00 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 3E 01 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 02 15 3E F0 02 00 01 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 3E 02 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 02 15 3F F0 02 00 01 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 3F 02 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 01 15 3D F0 02 01 00 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 3D 01 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 02 15 3D F0 02 01 00 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 3D 02 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 01 15 3C F0 02 01 00 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 3C 01 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 02 15 3C F0 02 01 00 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 3C 02 <br> Recv Data : 90 00 <br> Send Data : 80 D4 01 00 0D 3A F0 EF 01 33 12 34 5F FF FF FF FF FF <br> Recv Data : 90 00 </p> 
  <h4 id="9创建15号文件二进制文件建立二进制文件线路保护读写">9，创建15号文件（二进制文件）建立二进制文件(线路保护读写)</h4> 
  <p>Send Data : 80 E0 00 15 07 A8 00 1E F0 F0 FF FF <br> Recv Data : 90 00 </p> 
  <h4 id="10-创建16号文件二进制文件">10 ,创建16号文件（二进制文件）</h4> 
  <p>Send Data : 80 E0 00 16 07 A8 00 27 F0 F0 FF FF <br> Recv Data : 90 00 </p> 
  <h4 id="11-创建17号文件二进制文件">11 ,创建17号文件（二进制文件）</h4> 
  <p>Send Data : 80 E0 00 17 07 28 05 DC F0 F0 FF FF <br> Recv Data : 6A 84 </p> 
  <h4 id="12-创建18号文件循环文件">12 ,创建18号文件（循环文件）</h4> 
  <p>Send Data : 80 E0 00 18 07 2E 0A 17 F0 EF FF FF <br> Recv Data : 90 00 </p> 
  <h4 id="13-创建钱包文件电子存折">13 ,创建钱包文件(电子存折)</h4> 
  <p>Send Data : 80 E0 00 01 07 2F 02 08 F1 00 FF 18 <br> Recv Data : 90 00 </p> 
  <h4 id="14-创建钱包文件电子钱包">14 ,创建钱包文件(电子钱包)</h4> 
  <p>Send Data : 80 E0 00 02 07 2F 02 08 F0 00 FF 18 <br> Recv Data : 90 00 </p> 
  <h1 id="验证pin码">验证PIN码：</h1> 
  <p>Send Data : 00 84 00 00 04 <br> Recv Data : 56 14 5E 12 90 00 </p> 
  <p>Send Data : 00 82 00 00 08 8E 69 F2 24 E5 4B A7 B4 <br> Recv Data : 90 00 </p> 
  <p>Send Data : 00 A4 00 00 02 3F 01 <br> Recv Data : 61 34 <br> Send Data : 00 C0 00 00 34 <br> Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 </p> 
  <p>Send Data : 00 20 00 00 03 12 34 5F <br> Recv Data : 90 00 </p> 
  <p>80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 10</p> 
  <h1 id="初始化圈存">初始化圈存</h1> 
  <p>重新插拔卡片：</p> 
  <p>Gemplus USB Smart Card Reader 0 <br> 连接读卡器: Gemplus USB Smart Card Reader 0 <br> 通讯协议: T0</p> 
  <h5 id="外部认证">外部认证</h5> 
  <p>Send Data : 00 84 00 00 04 <br> Recv Data : 0A F3 B2 B5 90 00 <br> Send Data : 00 82 00 00 08 D8 9D DB 8F 53 F5 08 19 <br> Recv Data : 90 00 </p> 
  <h5 id="进入目录3f01">进入目录3F01</h5> 
  <p>Send Data : 00 A4 00 00 02 3F 01 <br> Recv Data : 61 34 <br> Send Data : 00 C0 00 00 34 <br> Recv Data : 6F 32 84 09 A0 00 00 00 03 86 98 07 01 A5 25 9F 08 01 02 9F 0C 1E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 90 00 </p> 
  <h5 id="校验pin码">校验pin码</h5> 
  <p>Send Data : 00 20 00 00 03 12 34 5F <br> Recv Data : 90 00 </p> 
  <h5 id="读余额">读余额</h5> 
  <p>Send Data : 80 5C 00 01 04 <br> Recv Data : 00 00 00 00 90 00 </p> 
  <h5 id="初始化圈存-1">初始化圈存</h5> 
  <p>Send Data : 80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01 <br> Recv Data : 61 10 <br> Send Data : 00 C0 00 00 10 <br> Recv Data : 00 00 00 00 00 00 00 01 2F 73 55 FC 5F C1 AE E4 90 00 </p> 
  <h5 id="圈存">圈存：</h5> 
  <p>Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 <br> Recv Data : 61 04 <br> Send Data : 00 C0 00 00 04 <br> Recv Data : 0E C7 8E 36 90 00</p> 
  <h4 id="读余额-1">读余额</h4> 
  <p>Send Data : 80 5C 00 02 04 <br> Recv Data : 00 00 12 34 90 00 </p> 
  <p>说明圈存成功了</p> 
  <h3 id="80-50-00-02-0b-01-00-00-12-34-00-00-00-00-00-01">80 50 00 02 0B 01 00 00 12 34 00 00 00 00 00 01</h3> 
  <table> 
   <thead> 
    <tr> 
     <th>CLA</th> 
     <th>INS</th> 
     <th>P1</th> 
     <th>P2</th> 
     <th>LC</th> 
     <th>密钥标识符</th> 
     <th>交易金额</th> 
     <th>终端机编号</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>80</td> 
     <td>50</td> 
     <td>00</td> 
     <td>02</td> 
     <td>0B</td> 
     <td>01</td> 
     <td>00 00 12 34</td> 
     <td>00 00 00 00 00 01</td> 
    </tr> 
   </tbody>
  </table> 
  <p>密钥标识01 交易金额 00001234 终端机编号 000000000001 <br> <img src="https://img-blog.csdn.net/20180420164630381?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>返回16个字节: <br> <img src="https://img-blog.csdn.net/20180420164829553?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <table> 
   <thead> 
    <tr> 
     <th>00 00 00 00</th> 
     <th>00 00</th> 
     <th>00</th> 
     <th>01</th> 
     <th>2F 73 55 FC</th> 
     <th>5F C1 AE E4</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>卡片余额</td> 
     <td>交易序号</td> 
     <td>密钥版本号</td> 
     <td>算法标识</td> 
     <td>随机数</td> 
     <td>MAC1</td> 
    </tr> 
   </tbody>
  </table> 
  <p><img src="https://img-blog.csdn.net/20180425152549556?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <h5 id="21-圈存密钥-圈存密钥01">21, 圈存密钥 圈存密钥01</h5> 
  <p>80 D4 01 01 15 3F F0 02 00 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01 3F 01</p> 
  <p>内部密钥的装载： <br> 80 D4 01 00 15 34 F0 02 00 01 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 <br> <img src="https://img-blog.csdn.net/20180425153634782?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>装载不同的消费密钥根据密钥版本号来区分，CPU卡中消费密钥密钥版本要和PSAM卡中密钥版本相同</p> 
  <p>还有算法标识</p> 
  <p>00-3DES</p> 
  <p>01-DES</p> 
  <p>02-255保留</p> 
  <p>注意：消费密钥的密钥版本是在消费过程中标识密钥版本，其他的密钥的密钥版本作为密钥标识使用</p> 
  <p>校验一下 MAC1：</p> 
  <table> 
   <thead> 
    <tr> 
     <th>2F 73 55 FC</th> 
     <th>0000</th> 
     <th>8000 (8bytes)</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>随机数</td> 
     <td>交易序号</td> 
     <td>填充数据</td> 
    </tr> 
   </tbody>
  </table> 
  <p>inputdata: 2F7355FC00008000</p> 
  <p>LoadKey = 3F013F013F013F013F013F013F013F01</p> 
  <p>SessionKey = 3DES_Enypt(InputData, LoadKey) = D1C6AEAD4E49990F</p> 
  <p>用LoadKey对InputData 做3DES加密得到D1C6AEAD4E49990F <br> <img src="https://img-blog.csdn.net/20180425155002629?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>密钥: 3F013F013F013F013F013F013F013F01 <br> 数据： 2F7355FC00008000 <br> 加密： D1C6AEAD4E49990F</p> 
  <p>2.计算MAC1（4字节）</p> 
  <table> 
   <thead> 
    <tr> 
     <th>00000000</th> 
     <th>00 00 12 34</th> 
     <th>02</th> 
     <th>00 00 00 00 00 01</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>卡片余额</td> 
     <td>交易金额</td> 
     <td>交易类型</td> 
     <td>终端机编号</td> 
    </tr> 
   </tbody>
  </table> 
  <p>密钥 : D1C6AEAD4E49990F <br> 初始向量： 0000000000000000 <br> InputData1 ： 000000000000123402000000000001</p> 
  <p>计算MAC1值： <br> 5FC1AEE43854A977</p> 
  <p><img src="https://img-blog.csdn.net/20180425154743625?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>验证正确：</p> 
  <h4 id="计算mac2">计算MAC2</h4> 
  <table> 
   <thead> 
    <tr> 
     <th>00 00 12 34</th> 
     <th>02</th> 
     <th>00 00 00 00 00 01</th> 
     <th>20180425</th> 
     <th>155922</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>交易金额</td> 
     <td>交易类型</td> 
     <td>终端机编号</td> 
     <td>交易日期</td> 
     <td>交易时间</td> 
    </tr> 
   </tbody>
  </table> 
  <p>InputData2=000012340200000000000120180425155922</p> 
  <p>密钥： D1C6AEAD4E49990F <br> 初始向量： 0000000000000000 <br> 数据 ： 000012340200000000000120180425155922 <br> 计算MAC: 2541D84488CC8BB0 <br> 取前4个字节： <br> MAC2 = 2541D844</p> 
  <h3 id="发送圈存命令">发送圈存命令：</h3> 
  <p><img src="https://img-blog.csdn.net/20180425160650307?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>Apdu: </p> 
  <table> 
   <thead> 
    <tr> 
     <th>CLA</th> 
     <th>INS</th> 
     <th>P1</th> 
     <th>P2</th> 
     <th>LC</th> 
     <th>交易日期</th> 
     <th>交易时间</th> 
     <th>MAC2</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>80</td> 
     <td>52</td> 
     <td>00</td> 
     <td>00</td> 
     <td>0B</td> 
     <td>20180425</td> 
     <td>155922</td> 
     <td>2541D844</td> 
    </tr> 
   </tbody>
  </table> 
  <p>80 52 00 00 0B 20180425 155922 2541D844</p> 
  <p>发送之后得到回应： <br> Send Data : 80 52 00 00 0B 20 18 04 25 15 59 22 25 41 D8 44 <br> Recv Data : 61 04 <br> Send Data : 00 C0 00 00 04 <br> Recv Data : 0E C7 8E 36 90 00 </p> 
  <p><img src="https://img-blog.csdn.net/2018042516111980?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>TAC : 0EC78E36 : <br> 进行校验：</p> 
  <p>内部密钥为：34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 34 <br> TacKey.Left(8) = 3434343434343434 <br> TacKey.Right(8) = 3434343434343434 <br> XOR 结果 = 0000000000000000</p> 
  <table> 
   <thead> 
    <tr> 
     <th>00 00 12 34</th> 
     <th>0000</th> 
     <th>00 00 12 34</th> 
     <th>02</th> 
     <th>00 00 00 00 00 01</th> 
     <th>20180425</th> 
     <th>155922</th> 
    </tr> 
   </thead> 
   <tbody>
    <tr> 
     <td>新余额</td> 
     <td>交易序号旧</td> 
     <td>交易金额</td> 
     <td>交易类型</td> 
     <td>终端机编号</td> 
     <td>交易日期</td> 
     <td>交易时间</td> 
    </tr> 
   </tbody>
  </table> 
  <p>InputData3=000012340000000012340200000000000120180425155922</p> 
  <p>密钥： 0000000000000000 <br> 初始向量： 0000000000000000 <br> 数据： 000012340000000012340200000000000120180425155922 <br> 计算MAC ： 0EC78E36AB07F7FF</p> 
  <p>TAC : 0EC78E36 :</p> 
  <p><img src="https://img-blog.csdn.net/20180425162241804?/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvd29jcHA=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wowocpp/article/details/80019538,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wowocpp/article/details/80019538,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
