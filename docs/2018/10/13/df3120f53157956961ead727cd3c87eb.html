<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>CentOS7中hyperledger-fabric1.1 - 2+6多机安装部署、部分异常处理以及使用configtxlator对区块基本信息查询（kafka共识，手动非docker方式） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="CentOS7中hyperledger-fabric1.1 - 2+6多机安装部署、部分异常处理以及使用configtxlator对区块基本信息查询（kafka共识，手动非docker方式）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="版权声明：转载请注明来源 https://blog.csdn.net/qq_38591756/article/details/83040322 根据搜集的资料安装测试并在安装测试过程中整理的文档，如有不足希望不吝赐教。 本文介绍CentOS7中hyperledger-fabric1.1多机部署使用kafka共识非docker方式，大体上与之前solo共识的步骤类似，（solo共识：《CentOS7中hyperledger-fabric1.1 - 1+4多机安装部署及部分异常处理（solo共识，手动非docker方式）》）只是在其基础上将网络结构部署为2orderer+6peer结构，修改默认的solo共识为kafka共识，添加了使用configtxlator工具对区块信息查询，并且对部分不合理或冗余位置做了修改。kafka与zookeeper安装可以参考《CentOS7安装zookeeper》《CentOS7安装kafka》或者自行搜索安装方式。 目录 一、环境介绍 Fabric相关组件以及工具介绍： - orderer 共识节点。为交易排序，并生成区块 - peer共识节点。为交易背书，并记录区块信息 - crypto用于生成区块链网络中相应用户的相关证书文件 - configtxgen 用于生成区块链系统链码的创世区块、新建通道的配置文件、以及组织中锚节点的配置文件 &nbsp; 本次Fabric区块链网络部署环境：8台 Centos 7系统的虚拟机。 其中golang、docker、内核升级等安装配置全部是使用单机测试（https://blog.csdn.net/qq_38591756/article/details/82826979）的配置，相关的安装配置步骤可以参考下面给出的链接或者自行搜索相关安装配置资料。 相关环境版本如下： golang：【go version】《CentOS7安装golang》 &nbsp; &nbsp; go version go1.10.2 linux/amd64 docker：【docker --version】《CentOS7 - Docker&amp;Docker-Compose安装》 &nbsp; &nbsp; Docker version 18.03.1-ce, build 9ee9f40 docker-compose：【docker-compose --version】《CentOS7 - Docker&amp;Docker-Compose安装》 &nbsp; &nbsp; docker-compose version 1.21.2, build a133471 linux：【rpm -q centos-release】 &nbsp; &nbsp; centos-release-7-5.1804.el7.centos.2.x86_64 linux内核：【uname -a】《CentOS7修改内核版本》 &nbsp; &nbsp; Linux localhost.localdomain 4.16.13-1.el7.elrepo.x86_64 #1 SMP Wed May 30 14:31:51 EDT 2018 x86_64 x86_64 x86_64 GNU/Linux 2个 orderer 节点，6个 peer 节点，使用 kafka共识算法 172.17.3.207，208，209，211，212，213部署peer节点 172.17.3.205，206部署orderer节点 &nbsp; 二、源码编译、以及fabric 区块链网络部署环境准备 单机部署测试时，go、docker、docker-compose、git等应该已经安装完成并且已经完成环境变量等配置，fabric源码已经下载，此处不再赘述。如果后面步骤碰到未安装的依赖等可自行安装后继续。 注意：以下环境构建需要在每台机器上完成。 安装编译相关的依赖包 snappy-devel.x86_64、zlib-devel.x86_64、bzip2-devel.x86_64、libtoo-ltdl-devel.x86_64、libtool 可以使用命令直接安装，命令如下： yum -y install snappy-devel.x86_64 zlib-devel.x86_64 bzip2-devel.x86_64 libtoo-ltdl-devel.x86_64 libtool 从 github.com 上下载 go 语言编译相关环境 gotools（golang.org 需要翻墙，所以从 github 上获取） 在目录$GOPATH/src/golang.org/x/下执行： git clone https://github.com/golang/tools.git &nbsp; 三、编译 fabric区块链相关可执行程序 切换到 fabric 源码的目录下面，通过 makefile 文件，可以编译出 fabric 项目的全部可执行文件。 这次的演示例子中，只需要编译部分必要文件即可：orderer、peer、configtxgen、cryptogen。 注：以下命令，全部在$GOPATH/src/github.com/hyperledger/fabric 目录下执行。 1.编译go相关工具 cp -r $GOPATH/src/golang.org/x/tools/ $GOPATH/src/github.com/hyperledger/fabric/gotools/build/gopath/src 完成后执行： make gotools 在执行make命令时可能会遇到的异常信息（一）： can&#39;t load package: package golang.org/x/lint/golint: no Go files in /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/golang.org/x/lint/golint 或 package golang.org/x/tools/go/ast/astutil: unrecognized import path &quot;golang.org/x/tools/go/ast/astutil&quot; (https fetch: Get https://golang.org/x/tools/go/ast/astutil?go-get=1: dial tcp 216.239.37.1:443: i/o timeout) 或 package golang.org/x/tools/go/gcexportdata: unrecognized import path &quot;golang.org/x/tools/go/gcexportdata&quot; (https fetch: Get https://golang.org/x/tools/go/gcexportdata?go-get=1: dial tcp 216.239.37.1:443: i/o timeout) 例如： 解决办法： 下载安装golang.org/x/net、golint cd $GOPATH/src/golang.org/x/ git clone https://github.com/golang/net.git net git clone https://github.com/golang/tools.git git clone https://github.com/golang/lint.git go install net go get golang.org/x/lint/golint 然后执行如下命令，如果出现没有文件夹的异常，根据命令在相应位置创建即可。 在执行make命令时异常信息（二）： 解决办法： 重试或者手动执行报错的git命令（如下）再重试。 git clone https://github.com/kardianos/govendor /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/github.com/kardianos/govendor 成功后类似如下截图： &nbsp; 2.编译 fabric基础环境 make buildenv 在执行make命令时可能会遇到的异常信息（一）： [root@localhost fabric]# make buildenv (cd build/docker/gotools/bin &amp;&amp; tar -jc *) &gt; build/gotools.tar.bz2 tar: *: Cannot stat: No such file or directory tar: Exiting with failure status due to previous errors make: *** [build/gotools.tar.bz2] Error 2 或 [root@localhost fabric]# make buildenv mkdir -p build/image/buildenv/payload cp build/gotools.tar.bz2 build/docker/gotools/bin/protoc-gen-go build/image/buildenv/payload cp: cannot stat ‘build/docker/gotools/bin/protoc-gen-go’: No such file or directory make: *** [build/image/buildenv/payload] Error 1 解决办法： 在出现错误1、2，3（截图中标注）时重试，每次错误不同，当出现第三次报错，如图，进行如下操作： 执行命令： go get -u github.com/golang/protobuf/protoc-gen-go 执行完成后可以在$GOPATH/bin/路径下看到protoc-gen-go文件，然后再执行命令： cp /opt/gopath/bin/protoc-gen-go /opt/gopath/src/github.com/hyperledger/fabric/build/docker/gotools/bin/ 针对上述异常，将其拷贝至指定目录，再次执行make buildenv，成功截图如下： &nbsp; 3.编译区块链服务相关工具 分别执行下面四条命令： make orderer make peer make configtxgen make cryptogen 编译的可执行程序生成在./fabric/build/bin目录下，设置该目录至 PATH环境变量。可以修改/etc/profile文件，在PATH后追加： :/opt/gopath/src/github.com/hyperledger/fabric/build/bin&nbsp; 注意前面的冒号 在执行make命令时可能会遇到的异常信息（一）： vendor/github.com/miekg/pkcs11/pkcs11.go:26:18: fatal error: ltdl.h: No such file or directory &nbsp;#include &lt;ltdl.h&gt; 解决办法： 安装ltdl，命令如下： yum -y install libtool-ltdl-devel 安装完成后重试即可。 在执行make peer命令时可能会遇到的异常信息： curl: (6) Could not resolve host: services.gradle.org The command &#39;/bin/sh -c curl -sSL https://services.gradle.org/distributions/gradle-2.12-bin.zip &gt; /tmp/gradle-2.12-bin.zip&#39; returned a non-zero code: 6 make: *** [build/image/javaenv/.dummy-x86_64-1.1.1-snapshot-ff5e861] Error 6 解决办法： 根据网上查找的资料，需要修改dns，但是本次问题并没有解决，而是重启docker。以下为两种方法，请自行测试。 1）修改DNS： 修改/etc/NetworkManager/NetworkManager.conf文件，在main部分添加 “dns=none” 选项，如图： 然后重新装载上面修改的配置： systemctl restart NetworkManager.service 再修改/etc/resolv.conf文件，将dns改为114.114.114.114以及8.8.8.8， &nbsp; 2）重启docker： 本次使用上面方法没有解决，最后使用重启docker的方法解决，重启命令: service docker restart 编译成功截图： 再次提示：以上环境需要在每台机器上构建完成。 &nbsp; 四、多机部署fabric网络(kafka共识) 注意：以下步骤执行之前需要做一些检查： 检查orderer节点上7050端口是否开放、4个peer节点的7051、7052、7053端口是否打开。然后用telnet（telnet IP port）命令或其他方法检查端口是否可以访问（可能需要安装telnet）。或者直接关闭所有防火墙。 如果之前执行过操作，没有成功而回头重复以下步骤（尤其重新生成证书、重启orderer、peer节点等操作），需要删除所有机器上/var/hyperledger目录下所有文件。本路径在配置文件orderer节点上的orderer.yaml（FileLedger标签下Location值）、peer节点上core.yaml（fileSystemPath值）中。否则在两个peer从节点以及在执行某些操作时会提示包含“X509”的错误。 因为用到了kafka集群，因此与Ⅱ类似的，如果已经执行了“orderer start“命令，在回头重复执行的时候需要删除fabric在kafka中创建的topic，具体删除方法请自行搜索或者参考《centos7安装kafka》。 检查所有机器的时区时间是否一致，如果不一致在后面启动等步骤会有类似类似超时或者过期的异常。查看时区及同步网络时间方法请自行搜索。 基本环境已经完成，下面将使用编译出来的可执行程序及相关工具，来搭建一个 fabric 区块链网络，并实现链码的部署以及测试。 首先，分别在五台虚拟机中创建目录/etc/hyperledger/fabric，以下的命令 全部在该目录下执行，并且需要设置 fabric 网络执行的环境变量： FABRIC_CFG_PATH=/etc/hyperledger/fabric 可以直接在/etc/profile中添加，如图： &nbsp; 1.配置 fabric 网络用户拓扑关系 通过配置文件 crypto-config.yaml配置fabric 网络用户拓扑关系。crypto-config.yaml 内容如下（crypto-config.yaml文件可以从e2e目录复制一份文件到当前目录）: OrdererOrgs: - Name: Orderer Domain: example.com Specs: - Hostname: orderer0 - Hostname: orderer1 PeerOrgs: - Name: Org1 Domain: org1.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 - Name: Org2 Domain: org2.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 - Name: Org3 Domain: org3.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 如果设置了EnableNodeOUs，就在msp下生成config.yaml文件。 该配置文件，包含一个 orderer 节点，以及两个 peer组织，两个 peer 组织又分别包含了两个 peer 节点。 使用 cryptogen 工具，从crypto-config.yaml配置文件中生成用户相应的秘钥和证书文件 命令如下： cryptogen generate --config=./crypto-config.yaml --output ./crypto-config 成功后截图如下： 执行命令后，会在当前目录下生成文件夹 crypto-config，包含节点用户的秘钥以及证书文件，如图： 通过scp命令分发 crypto-config文件夹，至其他7台虚拟机的/etc/hyperledger/fabric 目录下（以下为例，根据实际修改主机ip）： scp -r crypto-config root@172.17.0.206:/etc/hyperledger/fabric/ &nbsp; 2.配置Orderer 节点的启动创世区块，新建通道交易的相关配置 通过配置文件 configtx.yaml 配置ordere 节点启动需要的创始区块信息，以及新建应用通道的交易信息。最初记录时使用的是word，配置文件内容太长，因此没有全部记录，以下截图仅为部分，完整配置文件统一放在附件（CentOS7 - hyperledger fabric1.1 - 1+4多机部署（kafka共识）配置文件）中，请自取，如果积分不足请留言。 修改完成后执行下面命令： 使用工具configtxgen生成 orderer 节点启动所需的创世区块： configtxgen -profile TwoOrgsOrdererGenesis -outputBlock genesis.block 使用工具 configtxgen生成创建应用通道的交易配置文件： configtxgen -profile TwoOrgsChannel -outputCreateChannelTx testchannel.tx -channelID testchannel 使用工具 configtxgen 生成更新组织锚节点的配置信息文件： configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org1MSPanchors.tx -channelID testchannel -asOrg Org1MSP configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org2MSPanchors.tx -channelID testchannel -asOrg Org2MSP configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org3MSPanchors.tx -channelID testchannel -asOrg Org3MSP 执行命令后，在当前目录下会生成如下文件： genesis.block、testchannel.tx、Org1MSPanchors.tx、Org2MSPanchors.tx、Org3MSPanchors.tx 通过 scp 命令发送genesis.block文件至172.17.3.206 通过 scp 命令发送Org1MSPanchors.tx文件至172.17.3.207 通过 scp 命令发送Org2MSPanchors.tx文件至172.17.3.209 通过 scp 命令发送Org3MSPanchors.tx文件至172.17.3.212 通过 scp 命令发送 testchannel.tx文件至全部六台peer主机 &nbsp; 3.设置虚拟机 Hosts 文件 由于 fabric 网络启动相关的配置文件中，与网络地址相关的信息都是填写的域名，所以需要在 hosts 文件中配置域名与 ip 的对应关系， orderer 节点和其他的4个 peer 节点的虚拟机都需要配置相关的 hosts 信息：vim /etc/hosts 172.17.3.205 orderer0.example.com 172.17.3.206 orderer1.example.com 172.17.3.207 peer0.org1.example.com 172.17.3.208 peer1.org1.example.com 172.17.1.136 peer0.org2.example.com 172.17.3.211 peer1.org2.example.com 172.17.3.212 peer0.org3.example.com 172.17.3.213 peer1.org3.example.com 其中域名是根据 cryprto-config.yaml 的配置信息得来。 &nbsp; 4.配置 orderer 启动环境 在orderer节点的虚拟机配置orderer节点启动相关配置信息 orderer.yaml，并保存在/etc/hyperledger/fabric目录下。需要注意的是：在orderer.yaml配置文件kafka配置标签中，最后有一个Version参数项，默认为空，默认的版本为0.10.2.0，因为本次安装kafka版本为2.1.1-1.1.0，因此需要修改此处的配置参数为实际安装的版本号：1.1.0。 相关配置文件内容见附件，因为文件不能重名并且为了区分，orderer和peer配置文件后面都加了数字编号以区分，实际使用时要去掉文件名后面的数字编号。 从 cypto-config 文件夹下，拷贝 orderer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下（两个orderer节点都需要执行，操作步骤类似）： cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp ./ cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls ./ 根据前文的操作，fabric 网络 orderer 节点的执行环境目录下应该有以下文件及文件夹： ./crypto-config、./msp、./tls、orderer.yaml、genesis.block 启动 orderer 节点： orderer start 上面配置文件中，日志级别为debug（可以根据自己实际情况修改），因此orderer节点启动之后会在控制台看到相关可以看到与kafka相关的日志输出， &nbsp; 5.配置 peer 启动环境 在 peer 节点的虚拟机配置 peer 节点启动相关配置信息 core.yaml，并保存在/etc/hyperledger/fabric 目录下。相关配置文件内容见附件。 从 crypto-config 文件夹下，拷贝 peer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下： cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp ./ cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls ./ 注意标记部分应该在对应的目录下拷贝对应的文件信息（可以参考 hosts 配置信息的内容和本机ip区分） 根据前文的操作，fabric 网络 peer 节点的执行环境目录下必须有以下文件及文件夹： /crypto-config.tx、./msp、./tls、testchannel.tx、core.yaml、 Org1MSPanchors.tx（.3.207虚拟机）、 Org2MSPanchors.tx（.3.209虚拟机)、 Org3MSPanchors.tx（.3.212虚拟机)、 启动 peer 节点： peer node start 注意，拷贝 msp、tls 文件夹的动作可以不需要操作，只需要在对应的 orderer.yaml 以及 core.yaml 配置文件中设置相应的路径即可，这里为了能够与附件中的配置信息一致，故把相应的秘钥与证书文件拷贝至fabric 网络执行环境变量的目录下 &nbsp; 6.创建应用通道 设置相应环境变量，6台peer节点都需要设置（根据相应环境修改配置中相应的位置,后面测试连码时也会用到，因此可以直接修改/etc/profile文件，在后面使用时可以不用重复设置） CORE_PEER_LOCALMSPID=Org1MSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp 例如： 执行命令创建应用通道（在peer0org1上执行即可）： peer channel create -o orderer0.example.com:7050 -c testchannel -f ./testchannel.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -t 3000 命令执行成功以后，会在当前目录下生成 应用通道的创世区块testchannel.block 文件，只有使用该文件，才可以加入对应的应用通道。 【注意】最后-t命令可以指定通道创建的超时时间，debug下如果不指定一个较大的超时时间，很大程度上会因为超时创建失败。 【注意】以上命令需要根据实际环境修改，比如orderer0.example.com:7050，如果与实际配置不一致（假如实际中为orderera,但命令使用orderer0）会出现“context deadline exceeded” 异常。 使用 scp命令分发至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量下(/etc/hyperledger/fabric)。以下为例： scp -r testchannel.block root@172.17.0.208:/etc/hyperledger/fabric/ &nbsp; 7.加入应用通道 执行命令加入应用通道（6台peer节点都可以执行一遍）： peer channel join -b testchannel.block 加入应用通道的peer 节点虚拟机都可以通过终端命令查看加入的通过信息，如图，如果所有peer节点都执行了加入命令，都可以看到如下类似信息： peer channel list &nbsp; 8.更新锚节点配置 执行命令更新负责代表组织与其他节点通信的锚节点（每个组织只需要在一台（peer0org1/peer0org2/peer0org3）上执行即可）。每个组织指定一个anchor peer，anchor peer是组织用来接收orderer下发的区块的peer。以org1为例： peer channel update -o orderer0.example.com:7050 -c testchannel -f ./Org1MSPanchors.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem &nbsp; 锚节点负责代表组织与其他组织中的节点进行 Gossip 通信。 &nbsp; 五、测试链码 1.安装链码 设置相应环境变量（根据相应环境修改配置）： 如果在四.6步骤中已经修改过配置文件（/etc/profile），则此处不需要重复操作。 &nbsp; 打包链码，由于这次的例子是基于 go 语言开发的智能合约，会依赖 go 的开发环境进行安装，如果使用 peer chaincode install 命令指定链码路径安装，可能会造成其他虚拟上安装的同样的链码无法同步实例化（go 开发环境不一致引起的问题），所以这里使用 go chaincode package 打包链码，然后通过安装打包链码文件进行链码的安装。 注意：如果是自定义的源码，最好在打包前在源码目录执行一次go build以检查代码是否有错误。 注意：这里进行测试的链码是 fabric 源码中的样例-p 指定的路径在命令执行的时候会自动根据 GOPATH 环境变量自动补全前缀，所以路径一个在 $GOPATH/src/目录下： peer chaincode package -n test -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -v 1.0 test.pak 使用 scp 命令分发 test.pak 文件至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量路径下。例如： scp -r test.pak root@172.17.0.208:/etc/hyperledger/fabric/ 安装链码 peer chaincode install test.pak 安装链码的 peer 节点服务器可以通过终端命令查看已安装的链码信息，如图： peer chaincode -C testchannel list --installed &nbsp; 2.初始化链码 初始化链码，只需要在一台 peer 节点的服务器上执行实例化后自动创建链码容器，其他 peer 节点服务器会同步该实例化的链码信息，并创建链码容器（需要启动docker容器：service docker start） peer chaincode instantiate -o orderer0.example.com:7050 -C testchannel -n test -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;1000&quot;,&quot;b&quot;,&quot;2000&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)&quot; --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 命令执行后对交易用户 a赋值100，交易用户 b 赋值200代币。 &nbsp; -P指定的参数OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)是CLI endorsement policy语法，其作用是设置背书策略，表示需要请求三个组织的任何一个签名即可，类似的，如果设置AND (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)则表示需要三个组织签名，如果设置OR (&#39;Org1MSP.member&#39;,AND(&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;))则表示需要组织一或者组织二和三的签名。 使用命令查看链码容器信息：docker ps。如图： 使用命令： peer chaincode query -n test -C testchannel -c&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 查看用户a（b）初始值： &nbsp; 3.测试交易 执行命令发送一笔交易，命令 b 向 a 转账 40个代币： peer chaincode invoke -o orderer0.example.com:7050 -C testchannel -n test -c&#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;b&quot;,&quot;a&quot;,&quot;40&quot;]}&#39; --tls ture --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 再次查询a、b余额命令与五.2查询命令相同： 查询转账命令可以在任意peer节点执行，上面查询在.3.207节点（日志级别debug），其他节点类似。 &nbsp; &nbsp; 六、区块基本信息查询 在peer节点执行，以下以207为例。 需要使用configtxlator工具，参考《使用一个简单工具向现有的 Hyperledger Fabric 区块链网络添加一个组织》，简介如下： configtxlator 工具提供了一个与 SDK 独立的真正无状态的 REST API，以简化 Hyperledger Fabric 区块链网络中的配置任务。该工具能够在不同的等效数据表示/格式之间轻松转换。例如，在工具操作的一种模式中，该工具在二进制 protobuf 格式与人类可读的 JSON 文本格式间来回转换。此外，该工具可以基于两组不同的配置交易之间的区别来计算配置更新。 &nbsp; 1.设置环境 确保您至少安装了 Hyperledger Fabric 的 1.1.0 预览版，命令行输入如下命令： peer --version 本文使用开源的 jq 工具来通过脚本处理与 configtxlator 返回的 JSON 的交互。这些 JSON 操作也可以手动或通过其他 JSON 工具执行。centos使用如下命令安装jq工具： 安装源： yum install epel-release 查看jq列表： yum list jq 执行安装： yun install jq 验证： 后台启动 configtxlator工具： 要启动configtxlator首先要编译configtxlator可执行程序，编译方法类似第三部分： 首先进入$GOPATH/src/github.com/hyperledger/fabric目录： cd $GOPATH/src/github.com/hyperledger/fabric 然后执行编译命令： make configtxlator 如下： 使用如下命令在后台启动configtxlator： configtxlator start &amp; 验证（查看）configtxlator是否启动： netstat -lnp | grep 7059 &nbsp; 2.检索区块 切换目录到/etc/hyperledger/fabric cd /etc/hyperledger/fabric 执行以下命令检索应用通道testchannel上最新的区块，因为订购者端点受 TLS 保护，所以以参数形式提供证书颁发机构身份。 peer channel fetch newest newest_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pen 可以看到目前最新的区块高度为229。 也可以指定区块高度，只需要修改命令中fetch后的参数即可，以区块高度228为例如下： peer channel fetch 228 228_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 命令执行完成后可以在当前文件夹看到newest_block.pb（228_block.pb）文件。 &nbsp; 3.使用configtxlator解码pb文件 以newest_block.pb为例： curl -X POST --data-binary @newest_block.pb http://127.0.0.1:7059/protolator/decode/common.Block &gt; newest_block.json 完成后会在当前目录看到生成的newest_block.json文件，即可使用其他编辑软件打开查看。 &nbsp; 七、其他 1.git查看远程的所有分支列表 git branch -a *表示当前使用分支 如果上面命令不加参数（git branch），则为查看本地的git分支 END&nbsp; 阅读更多" />
<meta property="og:description" content="版权声明：转载请注明来源 https://blog.csdn.net/qq_38591756/article/details/83040322 根据搜集的资料安装测试并在安装测试过程中整理的文档，如有不足希望不吝赐教。 本文介绍CentOS7中hyperledger-fabric1.1多机部署使用kafka共识非docker方式，大体上与之前solo共识的步骤类似，（solo共识：《CentOS7中hyperledger-fabric1.1 - 1+4多机安装部署及部分异常处理（solo共识，手动非docker方式）》）只是在其基础上将网络结构部署为2orderer+6peer结构，修改默认的solo共识为kafka共识，添加了使用configtxlator工具对区块信息查询，并且对部分不合理或冗余位置做了修改。kafka与zookeeper安装可以参考《CentOS7安装zookeeper》《CentOS7安装kafka》或者自行搜索安装方式。 目录 一、环境介绍 Fabric相关组件以及工具介绍： - orderer 共识节点。为交易排序，并生成区块 - peer共识节点。为交易背书，并记录区块信息 - crypto用于生成区块链网络中相应用户的相关证书文件 - configtxgen 用于生成区块链系统链码的创世区块、新建通道的配置文件、以及组织中锚节点的配置文件 &nbsp; 本次Fabric区块链网络部署环境：8台 Centos 7系统的虚拟机。 其中golang、docker、内核升级等安装配置全部是使用单机测试（https://blog.csdn.net/qq_38591756/article/details/82826979）的配置，相关的安装配置步骤可以参考下面给出的链接或者自行搜索相关安装配置资料。 相关环境版本如下： golang：【go version】《CentOS7安装golang》 &nbsp; &nbsp; go version go1.10.2 linux/amd64 docker：【docker --version】《CentOS7 - Docker&amp;Docker-Compose安装》 &nbsp; &nbsp; Docker version 18.03.1-ce, build 9ee9f40 docker-compose：【docker-compose --version】《CentOS7 - Docker&amp;Docker-Compose安装》 &nbsp; &nbsp; docker-compose version 1.21.2, build a133471 linux：【rpm -q centos-release】 &nbsp; &nbsp; centos-release-7-5.1804.el7.centos.2.x86_64 linux内核：【uname -a】《CentOS7修改内核版本》 &nbsp; &nbsp; Linux localhost.localdomain 4.16.13-1.el7.elrepo.x86_64 #1 SMP Wed May 30 14:31:51 EDT 2018 x86_64 x86_64 x86_64 GNU/Linux 2个 orderer 节点，6个 peer 节点，使用 kafka共识算法 172.17.3.207，208，209，211，212，213部署peer节点 172.17.3.205，206部署orderer节点 &nbsp; 二、源码编译、以及fabric 区块链网络部署环境准备 单机部署测试时，go、docker、docker-compose、git等应该已经安装完成并且已经完成环境变量等配置，fabric源码已经下载，此处不再赘述。如果后面步骤碰到未安装的依赖等可自行安装后继续。 注意：以下环境构建需要在每台机器上完成。 安装编译相关的依赖包 snappy-devel.x86_64、zlib-devel.x86_64、bzip2-devel.x86_64、libtoo-ltdl-devel.x86_64、libtool 可以使用命令直接安装，命令如下： yum -y install snappy-devel.x86_64 zlib-devel.x86_64 bzip2-devel.x86_64 libtoo-ltdl-devel.x86_64 libtool 从 github.com 上下载 go 语言编译相关环境 gotools（golang.org 需要翻墙，所以从 github 上获取） 在目录$GOPATH/src/golang.org/x/下执行： git clone https://github.com/golang/tools.git &nbsp; 三、编译 fabric区块链相关可执行程序 切换到 fabric 源码的目录下面，通过 makefile 文件，可以编译出 fabric 项目的全部可执行文件。 这次的演示例子中，只需要编译部分必要文件即可：orderer、peer、configtxgen、cryptogen。 注：以下命令，全部在$GOPATH/src/github.com/hyperledger/fabric 目录下执行。 1.编译go相关工具 cp -r $GOPATH/src/golang.org/x/tools/ $GOPATH/src/github.com/hyperledger/fabric/gotools/build/gopath/src 完成后执行： make gotools 在执行make命令时可能会遇到的异常信息（一）： can&#39;t load package: package golang.org/x/lint/golint: no Go files in /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/golang.org/x/lint/golint 或 package golang.org/x/tools/go/ast/astutil: unrecognized import path &quot;golang.org/x/tools/go/ast/astutil&quot; (https fetch: Get https://golang.org/x/tools/go/ast/astutil?go-get=1: dial tcp 216.239.37.1:443: i/o timeout) 或 package golang.org/x/tools/go/gcexportdata: unrecognized import path &quot;golang.org/x/tools/go/gcexportdata&quot; (https fetch: Get https://golang.org/x/tools/go/gcexportdata?go-get=1: dial tcp 216.239.37.1:443: i/o timeout) 例如： 解决办法： 下载安装golang.org/x/net、golint cd $GOPATH/src/golang.org/x/ git clone https://github.com/golang/net.git net git clone https://github.com/golang/tools.git git clone https://github.com/golang/lint.git go install net go get golang.org/x/lint/golint 然后执行如下命令，如果出现没有文件夹的异常，根据命令在相应位置创建即可。 在执行make命令时异常信息（二）： 解决办法： 重试或者手动执行报错的git命令（如下）再重试。 git clone https://github.com/kardianos/govendor /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/github.com/kardianos/govendor 成功后类似如下截图： &nbsp; 2.编译 fabric基础环境 make buildenv 在执行make命令时可能会遇到的异常信息（一）： [root@localhost fabric]# make buildenv (cd build/docker/gotools/bin &amp;&amp; tar -jc *) &gt; build/gotools.tar.bz2 tar: *: Cannot stat: No such file or directory tar: Exiting with failure status due to previous errors make: *** [build/gotools.tar.bz2] Error 2 或 [root@localhost fabric]# make buildenv mkdir -p build/image/buildenv/payload cp build/gotools.tar.bz2 build/docker/gotools/bin/protoc-gen-go build/image/buildenv/payload cp: cannot stat ‘build/docker/gotools/bin/protoc-gen-go’: No such file or directory make: *** [build/image/buildenv/payload] Error 1 解决办法： 在出现错误1、2，3（截图中标注）时重试，每次错误不同，当出现第三次报错，如图，进行如下操作： 执行命令： go get -u github.com/golang/protobuf/protoc-gen-go 执行完成后可以在$GOPATH/bin/路径下看到protoc-gen-go文件，然后再执行命令： cp /opt/gopath/bin/protoc-gen-go /opt/gopath/src/github.com/hyperledger/fabric/build/docker/gotools/bin/ 针对上述异常，将其拷贝至指定目录，再次执行make buildenv，成功截图如下： &nbsp; 3.编译区块链服务相关工具 分别执行下面四条命令： make orderer make peer make configtxgen make cryptogen 编译的可执行程序生成在./fabric/build/bin目录下，设置该目录至 PATH环境变量。可以修改/etc/profile文件，在PATH后追加： :/opt/gopath/src/github.com/hyperledger/fabric/build/bin&nbsp; 注意前面的冒号 在执行make命令时可能会遇到的异常信息（一）： vendor/github.com/miekg/pkcs11/pkcs11.go:26:18: fatal error: ltdl.h: No such file or directory &nbsp;#include &lt;ltdl.h&gt; 解决办法： 安装ltdl，命令如下： yum -y install libtool-ltdl-devel 安装完成后重试即可。 在执行make peer命令时可能会遇到的异常信息： curl: (6) Could not resolve host: services.gradle.org The command &#39;/bin/sh -c curl -sSL https://services.gradle.org/distributions/gradle-2.12-bin.zip &gt; /tmp/gradle-2.12-bin.zip&#39; returned a non-zero code: 6 make: *** [build/image/javaenv/.dummy-x86_64-1.1.1-snapshot-ff5e861] Error 6 解决办法： 根据网上查找的资料，需要修改dns，但是本次问题并没有解决，而是重启docker。以下为两种方法，请自行测试。 1）修改DNS： 修改/etc/NetworkManager/NetworkManager.conf文件，在main部分添加 “dns=none” 选项，如图： 然后重新装载上面修改的配置： systemctl restart NetworkManager.service 再修改/etc/resolv.conf文件，将dns改为114.114.114.114以及8.8.8.8， &nbsp; 2）重启docker： 本次使用上面方法没有解决，最后使用重启docker的方法解决，重启命令: service docker restart 编译成功截图： 再次提示：以上环境需要在每台机器上构建完成。 &nbsp; 四、多机部署fabric网络(kafka共识) 注意：以下步骤执行之前需要做一些检查： 检查orderer节点上7050端口是否开放、4个peer节点的7051、7052、7053端口是否打开。然后用telnet（telnet IP port）命令或其他方法检查端口是否可以访问（可能需要安装telnet）。或者直接关闭所有防火墙。 如果之前执行过操作，没有成功而回头重复以下步骤（尤其重新生成证书、重启orderer、peer节点等操作），需要删除所有机器上/var/hyperledger目录下所有文件。本路径在配置文件orderer节点上的orderer.yaml（FileLedger标签下Location值）、peer节点上core.yaml（fileSystemPath值）中。否则在两个peer从节点以及在执行某些操作时会提示包含“X509”的错误。 因为用到了kafka集群，因此与Ⅱ类似的，如果已经执行了“orderer start“命令，在回头重复执行的时候需要删除fabric在kafka中创建的topic，具体删除方法请自行搜索或者参考《centos7安装kafka》。 检查所有机器的时区时间是否一致，如果不一致在后面启动等步骤会有类似类似超时或者过期的异常。查看时区及同步网络时间方法请自行搜索。 基本环境已经完成，下面将使用编译出来的可执行程序及相关工具，来搭建一个 fabric 区块链网络，并实现链码的部署以及测试。 首先，分别在五台虚拟机中创建目录/etc/hyperledger/fabric，以下的命令 全部在该目录下执行，并且需要设置 fabric 网络执行的环境变量： FABRIC_CFG_PATH=/etc/hyperledger/fabric 可以直接在/etc/profile中添加，如图： &nbsp; 1.配置 fabric 网络用户拓扑关系 通过配置文件 crypto-config.yaml配置fabric 网络用户拓扑关系。crypto-config.yaml 内容如下（crypto-config.yaml文件可以从e2e目录复制一份文件到当前目录）: OrdererOrgs: - Name: Orderer Domain: example.com Specs: - Hostname: orderer0 - Hostname: orderer1 PeerOrgs: - Name: Org1 Domain: org1.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 - Name: Org2 Domain: org2.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 - Name: Org3 Domain: org3.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 如果设置了EnableNodeOUs，就在msp下生成config.yaml文件。 该配置文件，包含一个 orderer 节点，以及两个 peer组织，两个 peer 组织又分别包含了两个 peer 节点。 使用 cryptogen 工具，从crypto-config.yaml配置文件中生成用户相应的秘钥和证书文件 命令如下： cryptogen generate --config=./crypto-config.yaml --output ./crypto-config 成功后截图如下： 执行命令后，会在当前目录下生成文件夹 crypto-config，包含节点用户的秘钥以及证书文件，如图： 通过scp命令分发 crypto-config文件夹，至其他7台虚拟机的/etc/hyperledger/fabric 目录下（以下为例，根据实际修改主机ip）： scp -r crypto-config root@172.17.0.206:/etc/hyperledger/fabric/ &nbsp; 2.配置Orderer 节点的启动创世区块，新建通道交易的相关配置 通过配置文件 configtx.yaml 配置ordere 节点启动需要的创始区块信息，以及新建应用通道的交易信息。最初记录时使用的是word，配置文件内容太长，因此没有全部记录，以下截图仅为部分，完整配置文件统一放在附件（CentOS7 - hyperledger fabric1.1 - 1+4多机部署（kafka共识）配置文件）中，请自取，如果积分不足请留言。 修改完成后执行下面命令： 使用工具configtxgen生成 orderer 节点启动所需的创世区块： configtxgen -profile TwoOrgsOrdererGenesis -outputBlock genesis.block 使用工具 configtxgen生成创建应用通道的交易配置文件： configtxgen -profile TwoOrgsChannel -outputCreateChannelTx testchannel.tx -channelID testchannel 使用工具 configtxgen 生成更新组织锚节点的配置信息文件： configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org1MSPanchors.tx -channelID testchannel -asOrg Org1MSP configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org2MSPanchors.tx -channelID testchannel -asOrg Org2MSP configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org3MSPanchors.tx -channelID testchannel -asOrg Org3MSP 执行命令后，在当前目录下会生成如下文件： genesis.block、testchannel.tx、Org1MSPanchors.tx、Org2MSPanchors.tx、Org3MSPanchors.tx 通过 scp 命令发送genesis.block文件至172.17.3.206 通过 scp 命令发送Org1MSPanchors.tx文件至172.17.3.207 通过 scp 命令发送Org2MSPanchors.tx文件至172.17.3.209 通过 scp 命令发送Org3MSPanchors.tx文件至172.17.3.212 通过 scp 命令发送 testchannel.tx文件至全部六台peer主机 &nbsp; 3.设置虚拟机 Hosts 文件 由于 fabric 网络启动相关的配置文件中，与网络地址相关的信息都是填写的域名，所以需要在 hosts 文件中配置域名与 ip 的对应关系， orderer 节点和其他的4个 peer 节点的虚拟机都需要配置相关的 hosts 信息：vim /etc/hosts 172.17.3.205 orderer0.example.com 172.17.3.206 orderer1.example.com 172.17.3.207 peer0.org1.example.com 172.17.3.208 peer1.org1.example.com 172.17.1.136 peer0.org2.example.com 172.17.3.211 peer1.org2.example.com 172.17.3.212 peer0.org3.example.com 172.17.3.213 peer1.org3.example.com 其中域名是根据 cryprto-config.yaml 的配置信息得来。 &nbsp; 4.配置 orderer 启动环境 在orderer节点的虚拟机配置orderer节点启动相关配置信息 orderer.yaml，并保存在/etc/hyperledger/fabric目录下。需要注意的是：在orderer.yaml配置文件kafka配置标签中，最后有一个Version参数项，默认为空，默认的版本为0.10.2.0，因为本次安装kafka版本为2.1.1-1.1.0，因此需要修改此处的配置参数为实际安装的版本号：1.1.0。 相关配置文件内容见附件，因为文件不能重名并且为了区分，orderer和peer配置文件后面都加了数字编号以区分，实际使用时要去掉文件名后面的数字编号。 从 cypto-config 文件夹下，拷贝 orderer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下（两个orderer节点都需要执行，操作步骤类似）： cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp ./ cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls ./ 根据前文的操作，fabric 网络 orderer 节点的执行环境目录下应该有以下文件及文件夹： ./crypto-config、./msp、./tls、orderer.yaml、genesis.block 启动 orderer 节点： orderer start 上面配置文件中，日志级别为debug（可以根据自己实际情况修改），因此orderer节点启动之后会在控制台看到相关可以看到与kafka相关的日志输出， &nbsp; 5.配置 peer 启动环境 在 peer 节点的虚拟机配置 peer 节点启动相关配置信息 core.yaml，并保存在/etc/hyperledger/fabric 目录下。相关配置文件内容见附件。 从 crypto-config 文件夹下，拷贝 peer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下： cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp ./ cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls ./ 注意标记部分应该在对应的目录下拷贝对应的文件信息（可以参考 hosts 配置信息的内容和本机ip区分） 根据前文的操作，fabric 网络 peer 节点的执行环境目录下必须有以下文件及文件夹： /crypto-config.tx、./msp、./tls、testchannel.tx、core.yaml、 Org1MSPanchors.tx（.3.207虚拟机）、 Org2MSPanchors.tx（.3.209虚拟机)、 Org3MSPanchors.tx（.3.212虚拟机)、 启动 peer 节点： peer node start 注意，拷贝 msp、tls 文件夹的动作可以不需要操作，只需要在对应的 orderer.yaml 以及 core.yaml 配置文件中设置相应的路径即可，这里为了能够与附件中的配置信息一致，故把相应的秘钥与证书文件拷贝至fabric 网络执行环境变量的目录下 &nbsp; 6.创建应用通道 设置相应环境变量，6台peer节点都需要设置（根据相应环境修改配置中相应的位置,后面测试连码时也会用到，因此可以直接修改/etc/profile文件，在后面使用时可以不用重复设置） CORE_PEER_LOCALMSPID=Org1MSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp 例如： 执行命令创建应用通道（在peer0org1上执行即可）： peer channel create -o orderer0.example.com:7050 -c testchannel -f ./testchannel.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -t 3000 命令执行成功以后，会在当前目录下生成 应用通道的创世区块testchannel.block 文件，只有使用该文件，才可以加入对应的应用通道。 【注意】最后-t命令可以指定通道创建的超时时间，debug下如果不指定一个较大的超时时间，很大程度上会因为超时创建失败。 【注意】以上命令需要根据实际环境修改，比如orderer0.example.com:7050，如果与实际配置不一致（假如实际中为orderera,但命令使用orderer0）会出现“context deadline exceeded” 异常。 使用 scp命令分发至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量下(/etc/hyperledger/fabric)。以下为例： scp -r testchannel.block root@172.17.0.208:/etc/hyperledger/fabric/ &nbsp; 7.加入应用通道 执行命令加入应用通道（6台peer节点都可以执行一遍）： peer channel join -b testchannel.block 加入应用通道的peer 节点虚拟机都可以通过终端命令查看加入的通过信息，如图，如果所有peer节点都执行了加入命令，都可以看到如下类似信息： peer channel list &nbsp; 8.更新锚节点配置 执行命令更新负责代表组织与其他节点通信的锚节点（每个组织只需要在一台（peer0org1/peer0org2/peer0org3）上执行即可）。每个组织指定一个anchor peer，anchor peer是组织用来接收orderer下发的区块的peer。以org1为例： peer channel update -o orderer0.example.com:7050 -c testchannel -f ./Org1MSPanchors.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem &nbsp; 锚节点负责代表组织与其他组织中的节点进行 Gossip 通信。 &nbsp; 五、测试链码 1.安装链码 设置相应环境变量（根据相应环境修改配置）： 如果在四.6步骤中已经修改过配置文件（/etc/profile），则此处不需要重复操作。 &nbsp; 打包链码，由于这次的例子是基于 go 语言开发的智能合约，会依赖 go 的开发环境进行安装，如果使用 peer chaincode install 命令指定链码路径安装，可能会造成其他虚拟上安装的同样的链码无法同步实例化（go 开发环境不一致引起的问题），所以这里使用 go chaincode package 打包链码，然后通过安装打包链码文件进行链码的安装。 注意：如果是自定义的源码，最好在打包前在源码目录执行一次go build以检查代码是否有错误。 注意：这里进行测试的链码是 fabric 源码中的样例-p 指定的路径在命令执行的时候会自动根据 GOPATH 环境变量自动补全前缀，所以路径一个在 $GOPATH/src/目录下： peer chaincode package -n test -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -v 1.0 test.pak 使用 scp 命令分发 test.pak 文件至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量路径下。例如： scp -r test.pak root@172.17.0.208:/etc/hyperledger/fabric/ 安装链码 peer chaincode install test.pak 安装链码的 peer 节点服务器可以通过终端命令查看已安装的链码信息，如图： peer chaincode -C testchannel list --installed &nbsp; 2.初始化链码 初始化链码，只需要在一台 peer 节点的服务器上执行实例化后自动创建链码容器，其他 peer 节点服务器会同步该实例化的链码信息，并创建链码容器（需要启动docker容器：service docker start） peer chaincode instantiate -o orderer0.example.com:7050 -C testchannel -n test -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;1000&quot;,&quot;b&quot;,&quot;2000&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)&quot; --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 命令执行后对交易用户 a赋值100，交易用户 b 赋值200代币。 &nbsp; -P指定的参数OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)是CLI endorsement policy语法，其作用是设置背书策略，表示需要请求三个组织的任何一个签名即可，类似的，如果设置AND (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)则表示需要三个组织签名，如果设置OR (&#39;Org1MSP.member&#39;,AND(&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;))则表示需要组织一或者组织二和三的签名。 使用命令查看链码容器信息：docker ps。如图： 使用命令： peer chaincode query -n test -C testchannel -c&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 查看用户a（b）初始值： &nbsp; 3.测试交易 执行命令发送一笔交易，命令 b 向 a 转账 40个代币： peer chaincode invoke -o orderer0.example.com:7050 -C testchannel -n test -c&#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;b&quot;,&quot;a&quot;,&quot;40&quot;]}&#39; --tls ture --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 再次查询a、b余额命令与五.2查询命令相同： 查询转账命令可以在任意peer节点执行，上面查询在.3.207节点（日志级别debug），其他节点类似。 &nbsp; &nbsp; 六、区块基本信息查询 在peer节点执行，以下以207为例。 需要使用configtxlator工具，参考《使用一个简单工具向现有的 Hyperledger Fabric 区块链网络添加一个组织》，简介如下： configtxlator 工具提供了一个与 SDK 独立的真正无状态的 REST API，以简化 Hyperledger Fabric 区块链网络中的配置任务。该工具能够在不同的等效数据表示/格式之间轻松转换。例如，在工具操作的一种模式中，该工具在二进制 protobuf 格式与人类可读的 JSON 文本格式间来回转换。此外，该工具可以基于两组不同的配置交易之间的区别来计算配置更新。 &nbsp; 1.设置环境 确保您至少安装了 Hyperledger Fabric 的 1.1.0 预览版，命令行输入如下命令： peer --version 本文使用开源的 jq 工具来通过脚本处理与 configtxlator 返回的 JSON 的交互。这些 JSON 操作也可以手动或通过其他 JSON 工具执行。centos使用如下命令安装jq工具： 安装源： yum install epel-release 查看jq列表： yum list jq 执行安装： yun install jq 验证： 后台启动 configtxlator工具： 要启动configtxlator首先要编译configtxlator可执行程序，编译方法类似第三部分： 首先进入$GOPATH/src/github.com/hyperledger/fabric目录： cd $GOPATH/src/github.com/hyperledger/fabric 然后执行编译命令： make configtxlator 如下： 使用如下命令在后台启动configtxlator： configtxlator start &amp; 验证（查看）configtxlator是否启动： netstat -lnp | grep 7059 &nbsp; 2.检索区块 切换目录到/etc/hyperledger/fabric cd /etc/hyperledger/fabric 执行以下命令检索应用通道testchannel上最新的区块，因为订购者端点受 TLS 保护，所以以参数形式提供证书颁发机构身份。 peer channel fetch newest newest_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pen 可以看到目前最新的区块高度为229。 也可以指定区块高度，只需要修改命令中fetch后的参数即可，以区块高度228为例如下： peer channel fetch 228 228_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 命令执行完成后可以在当前文件夹看到newest_block.pb（228_block.pb）文件。 &nbsp; 3.使用configtxlator解码pb文件 以newest_block.pb为例： curl -X POST --data-binary @newest_block.pb http://127.0.0.1:7059/protolator/decode/common.Block &gt; newest_block.json 完成后会在当前目录看到生成的newest_block.json文件，即可使用其他编辑软件打开查看。 &nbsp; 七、其他 1.git查看远程的所有分支列表 git branch -a *表示当前使用分支 如果上面命令不加参数（git branch），则为查看本地的git分支 END&nbsp; 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-13T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"版权声明：转载请注明来源 https://blog.csdn.net/qq_38591756/article/details/83040322 根据搜集的资料安装测试并在安装测试过程中整理的文档，如有不足希望不吝赐教。 本文介绍CentOS7中hyperledger-fabric1.1多机部署使用kafka共识非docker方式，大体上与之前solo共识的步骤类似，（solo共识：《CentOS7中hyperledger-fabric1.1 - 1+4多机安装部署及部分异常处理（solo共识，手动非docker方式）》）只是在其基础上将网络结构部署为2orderer+6peer结构，修改默认的solo共识为kafka共识，添加了使用configtxlator工具对区块信息查询，并且对部分不合理或冗余位置做了修改。kafka与zookeeper安装可以参考《CentOS7安装zookeeper》《CentOS7安装kafka》或者自行搜索安装方式。 目录 一、环境介绍 Fabric相关组件以及工具介绍： - orderer 共识节点。为交易排序，并生成区块 - peer共识节点。为交易背书，并记录区块信息 - crypto用于生成区块链网络中相应用户的相关证书文件 - configtxgen 用于生成区块链系统链码的创世区块、新建通道的配置文件、以及组织中锚节点的配置文件 &nbsp; 本次Fabric区块链网络部署环境：8台 Centos 7系统的虚拟机。 其中golang、docker、内核升级等安装配置全部是使用单机测试（https://blog.csdn.net/qq_38591756/article/details/82826979）的配置，相关的安装配置步骤可以参考下面给出的链接或者自行搜索相关安装配置资料。 相关环境版本如下： golang：【go version】《CentOS7安装golang》 &nbsp; &nbsp; go version go1.10.2 linux/amd64 docker：【docker --version】《CentOS7 - Docker&amp;Docker-Compose安装》 &nbsp; &nbsp; Docker version 18.03.1-ce, build 9ee9f40 docker-compose：【docker-compose --version】《CentOS7 - Docker&amp;Docker-Compose安装》 &nbsp; &nbsp; docker-compose version 1.21.2, build a133471 linux：【rpm -q centos-release】 &nbsp; &nbsp; centos-release-7-5.1804.el7.centos.2.x86_64 linux内核：【uname -a】《CentOS7修改内核版本》 &nbsp; &nbsp; Linux localhost.localdomain 4.16.13-1.el7.elrepo.x86_64 #1 SMP Wed May 30 14:31:51 EDT 2018 x86_64 x86_64 x86_64 GNU/Linux 2个 orderer 节点，6个 peer 节点，使用 kafka共识算法 172.17.3.207，208，209，211，212，213部署peer节点 172.17.3.205，206部署orderer节点 &nbsp; 二、源码编译、以及fabric 区块链网络部署环境准备 单机部署测试时，go、docker、docker-compose、git等应该已经安装完成并且已经完成环境变量等配置，fabric源码已经下载，此处不再赘述。如果后面步骤碰到未安装的依赖等可自行安装后继续。 注意：以下环境构建需要在每台机器上完成。 安装编译相关的依赖包 snappy-devel.x86_64、zlib-devel.x86_64、bzip2-devel.x86_64、libtoo-ltdl-devel.x86_64、libtool 可以使用命令直接安装，命令如下： yum -y install snappy-devel.x86_64 zlib-devel.x86_64 bzip2-devel.x86_64 libtoo-ltdl-devel.x86_64 libtool 从 github.com 上下载 go 语言编译相关环境 gotools（golang.org 需要翻墙，所以从 github 上获取） 在目录$GOPATH/src/golang.org/x/下执行： git clone https://github.com/golang/tools.git &nbsp; 三、编译 fabric区块链相关可执行程序 切换到 fabric 源码的目录下面，通过 makefile 文件，可以编译出 fabric 项目的全部可执行文件。 这次的演示例子中，只需要编译部分必要文件即可：orderer、peer、configtxgen、cryptogen。 注：以下命令，全部在$GOPATH/src/github.com/hyperledger/fabric 目录下执行。 1.编译go相关工具 cp -r $GOPATH/src/golang.org/x/tools/ $GOPATH/src/github.com/hyperledger/fabric/gotools/build/gopath/src 完成后执行： make gotools 在执行make命令时可能会遇到的异常信息（一）： can&#39;t load package: package golang.org/x/lint/golint: no Go files in /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/golang.org/x/lint/golint 或 package golang.org/x/tools/go/ast/astutil: unrecognized import path &quot;golang.org/x/tools/go/ast/astutil&quot; (https fetch: Get https://golang.org/x/tools/go/ast/astutil?go-get=1: dial tcp 216.239.37.1:443: i/o timeout) 或 package golang.org/x/tools/go/gcexportdata: unrecognized import path &quot;golang.org/x/tools/go/gcexportdata&quot; (https fetch: Get https://golang.org/x/tools/go/gcexportdata?go-get=1: dial tcp 216.239.37.1:443: i/o timeout) 例如： 解决办法： 下载安装golang.org/x/net、golint cd $GOPATH/src/golang.org/x/ git clone https://github.com/golang/net.git net git clone https://github.com/golang/tools.git git clone https://github.com/golang/lint.git go install net go get golang.org/x/lint/golint 然后执行如下命令，如果出现没有文件夹的异常，根据命令在相应位置创建即可。 在执行make命令时异常信息（二）： 解决办法： 重试或者手动执行报错的git命令（如下）再重试。 git clone https://github.com/kardianos/govendor /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/github.com/kardianos/govendor 成功后类似如下截图： &nbsp; 2.编译 fabric基础环境 make buildenv 在执行make命令时可能会遇到的异常信息（一）： [root@localhost fabric]# make buildenv (cd build/docker/gotools/bin &amp;&amp; tar -jc *) &gt; build/gotools.tar.bz2 tar: *: Cannot stat: No such file or directory tar: Exiting with failure status due to previous errors make: *** [build/gotools.tar.bz2] Error 2 或 [root@localhost fabric]# make buildenv mkdir -p build/image/buildenv/payload cp build/gotools.tar.bz2 build/docker/gotools/bin/protoc-gen-go build/image/buildenv/payload cp: cannot stat ‘build/docker/gotools/bin/protoc-gen-go’: No such file or directory make: *** [build/image/buildenv/payload] Error 1 解决办法： 在出现错误1、2，3（截图中标注）时重试，每次错误不同，当出现第三次报错，如图，进行如下操作： 执行命令： go get -u github.com/golang/protobuf/protoc-gen-go 执行完成后可以在$GOPATH/bin/路径下看到protoc-gen-go文件，然后再执行命令： cp /opt/gopath/bin/protoc-gen-go /opt/gopath/src/github.com/hyperledger/fabric/build/docker/gotools/bin/ 针对上述异常，将其拷贝至指定目录，再次执行make buildenv，成功截图如下： &nbsp; 3.编译区块链服务相关工具 分别执行下面四条命令： make orderer make peer make configtxgen make cryptogen 编译的可执行程序生成在./fabric/build/bin目录下，设置该目录至 PATH环境变量。可以修改/etc/profile文件，在PATH后追加： :/opt/gopath/src/github.com/hyperledger/fabric/build/bin&nbsp; 注意前面的冒号 在执行make命令时可能会遇到的异常信息（一）： vendor/github.com/miekg/pkcs11/pkcs11.go:26:18: fatal error: ltdl.h: No such file or directory &nbsp;#include &lt;ltdl.h&gt; 解决办法： 安装ltdl，命令如下： yum -y install libtool-ltdl-devel 安装完成后重试即可。 在执行make peer命令时可能会遇到的异常信息： curl: (6) Could not resolve host: services.gradle.org The command &#39;/bin/sh -c curl -sSL https://services.gradle.org/distributions/gradle-2.12-bin.zip &gt; /tmp/gradle-2.12-bin.zip&#39; returned a non-zero code: 6 make: *** [build/image/javaenv/.dummy-x86_64-1.1.1-snapshot-ff5e861] Error 6 解决办法： 根据网上查找的资料，需要修改dns，但是本次问题并没有解决，而是重启docker。以下为两种方法，请自行测试。 1）修改DNS： 修改/etc/NetworkManager/NetworkManager.conf文件，在main部分添加 “dns=none” 选项，如图： 然后重新装载上面修改的配置： systemctl restart NetworkManager.service 再修改/etc/resolv.conf文件，将dns改为114.114.114.114以及8.8.8.8， &nbsp; 2）重启docker： 本次使用上面方法没有解决，最后使用重启docker的方法解决，重启命令: service docker restart 编译成功截图： 再次提示：以上环境需要在每台机器上构建完成。 &nbsp; 四、多机部署fabric网络(kafka共识) 注意：以下步骤执行之前需要做一些检查： 检查orderer节点上7050端口是否开放、4个peer节点的7051、7052、7053端口是否打开。然后用telnet（telnet IP port）命令或其他方法检查端口是否可以访问（可能需要安装telnet）。或者直接关闭所有防火墙。 如果之前执行过操作，没有成功而回头重复以下步骤（尤其重新生成证书、重启orderer、peer节点等操作），需要删除所有机器上/var/hyperledger目录下所有文件。本路径在配置文件orderer节点上的orderer.yaml（FileLedger标签下Location值）、peer节点上core.yaml（fileSystemPath值）中。否则在两个peer从节点以及在执行某些操作时会提示包含“X509”的错误。 因为用到了kafka集群，因此与Ⅱ类似的，如果已经执行了“orderer start“命令，在回头重复执行的时候需要删除fabric在kafka中创建的topic，具体删除方法请自行搜索或者参考《centos7安装kafka》。 检查所有机器的时区时间是否一致，如果不一致在后面启动等步骤会有类似类似超时或者过期的异常。查看时区及同步网络时间方法请自行搜索。 基本环境已经完成，下面将使用编译出来的可执行程序及相关工具，来搭建一个 fabric 区块链网络，并实现链码的部署以及测试。 首先，分别在五台虚拟机中创建目录/etc/hyperledger/fabric，以下的命令 全部在该目录下执行，并且需要设置 fabric 网络执行的环境变量： FABRIC_CFG_PATH=/etc/hyperledger/fabric 可以直接在/etc/profile中添加，如图： &nbsp; 1.配置 fabric 网络用户拓扑关系 通过配置文件 crypto-config.yaml配置fabric 网络用户拓扑关系。crypto-config.yaml 内容如下（crypto-config.yaml文件可以从e2e目录复制一份文件到当前目录）: OrdererOrgs: - Name: Orderer Domain: example.com Specs: - Hostname: orderer0 - Hostname: orderer1 PeerOrgs: - Name: Org1 Domain: org1.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 - Name: Org2 Domain: org2.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 - Name: Org3 Domain: org3.example.com EnableNodeOUs: true Template: Count: 2 Users: Count: 1 Specs: - Hostname: peer0 - Hostname: peer1 如果设置了EnableNodeOUs，就在msp下生成config.yaml文件。 该配置文件，包含一个 orderer 节点，以及两个 peer组织，两个 peer 组织又分别包含了两个 peer 节点。 使用 cryptogen 工具，从crypto-config.yaml配置文件中生成用户相应的秘钥和证书文件 命令如下： cryptogen generate --config=./crypto-config.yaml --output ./crypto-config 成功后截图如下： 执行命令后，会在当前目录下生成文件夹 crypto-config，包含节点用户的秘钥以及证书文件，如图： 通过scp命令分发 crypto-config文件夹，至其他7台虚拟机的/etc/hyperledger/fabric 目录下（以下为例，根据实际修改主机ip）： scp -r crypto-config root@172.17.0.206:/etc/hyperledger/fabric/ &nbsp; 2.配置Orderer 节点的启动创世区块，新建通道交易的相关配置 通过配置文件 configtx.yaml 配置ordere 节点启动需要的创始区块信息，以及新建应用通道的交易信息。最初记录时使用的是word，配置文件内容太长，因此没有全部记录，以下截图仅为部分，完整配置文件统一放在附件（CentOS7 - hyperledger fabric1.1 - 1+4多机部署（kafka共识）配置文件）中，请自取，如果积分不足请留言。 修改完成后执行下面命令： 使用工具configtxgen生成 orderer 节点启动所需的创世区块： configtxgen -profile TwoOrgsOrdererGenesis -outputBlock genesis.block 使用工具 configtxgen生成创建应用通道的交易配置文件： configtxgen -profile TwoOrgsChannel -outputCreateChannelTx testchannel.tx -channelID testchannel 使用工具 configtxgen 生成更新组织锚节点的配置信息文件： configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org1MSPanchors.tx -channelID testchannel -asOrg Org1MSP configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org2MSPanchors.tx -channelID testchannel -asOrg Org2MSP configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org3MSPanchors.tx -channelID testchannel -asOrg Org3MSP 执行命令后，在当前目录下会生成如下文件： genesis.block、testchannel.tx、Org1MSPanchors.tx、Org2MSPanchors.tx、Org3MSPanchors.tx 通过 scp 命令发送genesis.block文件至172.17.3.206 通过 scp 命令发送Org1MSPanchors.tx文件至172.17.3.207 通过 scp 命令发送Org2MSPanchors.tx文件至172.17.3.209 通过 scp 命令发送Org3MSPanchors.tx文件至172.17.3.212 通过 scp 命令发送 testchannel.tx文件至全部六台peer主机 &nbsp; 3.设置虚拟机 Hosts 文件 由于 fabric 网络启动相关的配置文件中，与网络地址相关的信息都是填写的域名，所以需要在 hosts 文件中配置域名与 ip 的对应关系， orderer 节点和其他的4个 peer 节点的虚拟机都需要配置相关的 hosts 信息：vim /etc/hosts 172.17.3.205 orderer0.example.com 172.17.3.206 orderer1.example.com 172.17.3.207 peer0.org1.example.com 172.17.3.208 peer1.org1.example.com 172.17.1.136 peer0.org2.example.com 172.17.3.211 peer1.org2.example.com 172.17.3.212 peer0.org3.example.com 172.17.3.213 peer1.org3.example.com 其中域名是根据 cryprto-config.yaml 的配置信息得来。 &nbsp; 4.配置 orderer 启动环境 在orderer节点的虚拟机配置orderer节点启动相关配置信息 orderer.yaml，并保存在/etc/hyperledger/fabric目录下。需要注意的是：在orderer.yaml配置文件kafka配置标签中，最后有一个Version参数项，默认为空，默认的版本为0.10.2.0，因为本次安装kafka版本为2.1.1-1.1.0，因此需要修改此处的配置参数为实际安装的版本号：1.1.0。 相关配置文件内容见附件，因为文件不能重名并且为了区分，orderer和peer配置文件后面都加了数字编号以区分，实际使用时要去掉文件名后面的数字编号。 从 cypto-config 文件夹下，拷贝 orderer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下（两个orderer节点都需要执行，操作步骤类似）： cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp ./ cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls ./ 根据前文的操作，fabric 网络 orderer 节点的执行环境目录下应该有以下文件及文件夹： ./crypto-config、./msp、./tls、orderer.yaml、genesis.block 启动 orderer 节点： orderer start 上面配置文件中，日志级别为debug（可以根据自己实际情况修改），因此orderer节点启动之后会在控制台看到相关可以看到与kafka相关的日志输出， &nbsp; 5.配置 peer 启动环境 在 peer 节点的虚拟机配置 peer 节点启动相关配置信息 core.yaml，并保存在/etc/hyperledger/fabric 目录下。相关配置文件内容见附件。 从 crypto-config 文件夹下，拷贝 peer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下： cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp ./ cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls ./ 注意标记部分应该在对应的目录下拷贝对应的文件信息（可以参考 hosts 配置信息的内容和本机ip区分） 根据前文的操作，fabric 网络 peer 节点的执行环境目录下必须有以下文件及文件夹： /crypto-config.tx、./msp、./tls、testchannel.tx、core.yaml、 Org1MSPanchors.tx（.3.207虚拟机）、 Org2MSPanchors.tx（.3.209虚拟机)、 Org3MSPanchors.tx（.3.212虚拟机)、 启动 peer 节点： peer node start 注意，拷贝 msp、tls 文件夹的动作可以不需要操作，只需要在对应的 orderer.yaml 以及 core.yaml 配置文件中设置相应的路径即可，这里为了能够与附件中的配置信息一致，故把相应的秘钥与证书文件拷贝至fabric 网络执行环境变量的目录下 &nbsp; 6.创建应用通道 设置相应环境变量，6台peer节点都需要设置（根据相应环境修改配置中相应的位置,后面测试连码时也会用到，因此可以直接修改/etc/profile文件，在后面使用时可以不用重复设置） CORE_PEER_LOCALMSPID=Org1MSP CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp 例如： 执行命令创建应用通道（在peer0org1上执行即可）： peer channel create -o orderer0.example.com:7050 -c testchannel -f ./testchannel.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -t 3000 命令执行成功以后，会在当前目录下生成 应用通道的创世区块testchannel.block 文件，只有使用该文件，才可以加入对应的应用通道。 【注意】最后-t命令可以指定通道创建的超时时间，debug下如果不指定一个较大的超时时间，很大程度上会因为超时创建失败。 【注意】以上命令需要根据实际环境修改，比如orderer0.example.com:7050，如果与实际配置不一致（假如实际中为orderera,但命令使用orderer0）会出现“context deadline exceeded” 异常。 使用 scp命令分发至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量下(/etc/hyperledger/fabric)。以下为例： scp -r testchannel.block root@172.17.0.208:/etc/hyperledger/fabric/ &nbsp; 7.加入应用通道 执行命令加入应用通道（6台peer节点都可以执行一遍）： peer channel join -b testchannel.block 加入应用通道的peer 节点虚拟机都可以通过终端命令查看加入的通过信息，如图，如果所有peer节点都执行了加入命令，都可以看到如下类似信息： peer channel list &nbsp; 8.更新锚节点配置 执行命令更新负责代表组织与其他节点通信的锚节点（每个组织只需要在一台（peer0org1/peer0org2/peer0org3）上执行即可）。每个组织指定一个anchor peer，anchor peer是组织用来接收orderer下发的区块的peer。以org1为例： peer channel update -o orderer0.example.com:7050 -c testchannel -f ./Org1MSPanchors.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem &nbsp; 锚节点负责代表组织与其他组织中的节点进行 Gossip 通信。 &nbsp; 五、测试链码 1.安装链码 设置相应环境变量（根据相应环境修改配置）： 如果在四.6步骤中已经修改过配置文件（/etc/profile），则此处不需要重复操作。 &nbsp; 打包链码，由于这次的例子是基于 go 语言开发的智能合约，会依赖 go 的开发环境进行安装，如果使用 peer chaincode install 命令指定链码路径安装，可能会造成其他虚拟上安装的同样的链码无法同步实例化（go 开发环境不一致引起的问题），所以这里使用 go chaincode package 打包链码，然后通过安装打包链码文件进行链码的安装。 注意：如果是自定义的源码，最好在打包前在源码目录执行一次go build以检查代码是否有错误。 注意：这里进行测试的链码是 fabric 源码中的样例-p 指定的路径在命令执行的时候会自动根据 GOPATH 环境变量自动补全前缀，所以路径一个在 $GOPATH/src/目录下： peer chaincode package -n test -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -v 1.0 test.pak 使用 scp 命令分发 test.pak 文件至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量路径下。例如： scp -r test.pak root@172.17.0.208:/etc/hyperledger/fabric/ 安装链码 peer chaincode install test.pak 安装链码的 peer 节点服务器可以通过终端命令查看已安装的链码信息，如图： peer chaincode -C testchannel list --installed &nbsp; 2.初始化链码 初始化链码，只需要在一台 peer 节点的服务器上执行实例化后自动创建链码容器，其他 peer 节点服务器会同步该实例化的链码信息，并创建链码容器（需要启动docker容器：service docker start） peer chaincode instantiate -o orderer0.example.com:7050 -C testchannel -n test -v 1.0 -c&#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;1000&quot;,&quot;b&quot;,&quot;2000&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)&quot; --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 命令执行后对交易用户 a赋值100，交易用户 b 赋值200代币。 &nbsp; -P指定的参数OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)是CLI endorsement policy语法，其作用是设置背书策略，表示需要请求三个组织的任何一个签名即可，类似的，如果设置AND (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;)则表示需要三个组织签名，如果设置OR (&#39;Org1MSP.member&#39;,AND(&#39;Org2MSP.member&#39;,&#39;Org3MSP.member&#39;))则表示需要组织一或者组织二和三的签名。 使用命令查看链码容器信息：docker ps。如图： 使用命令： peer chaincode query -n test -C testchannel -c&#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 查看用户a（b）初始值： &nbsp; 3.测试交易 执行命令发送一笔交易，命令 b 向 a 转账 40个代币： peer chaincode invoke -o orderer0.example.com:7050 -C testchannel -n test -c&#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;b&quot;,&quot;a&quot;,&quot;40&quot;]}&#39; --tls ture --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 再次查询a、b余额命令与五.2查询命令相同： 查询转账命令可以在任意peer节点执行，上面查询在.3.207节点（日志级别debug），其他节点类似。 &nbsp; &nbsp; 六、区块基本信息查询 在peer节点执行，以下以207为例。 需要使用configtxlator工具，参考《使用一个简单工具向现有的 Hyperledger Fabric 区块链网络添加一个组织》，简介如下： configtxlator 工具提供了一个与 SDK 独立的真正无状态的 REST API，以简化 Hyperledger Fabric 区块链网络中的配置任务。该工具能够在不同的等效数据表示/格式之间轻松转换。例如，在工具操作的一种模式中，该工具在二进制 protobuf 格式与人类可读的 JSON 文本格式间来回转换。此外，该工具可以基于两组不同的配置交易之间的区别来计算配置更新。 &nbsp; 1.设置环境 确保您至少安装了 Hyperledger Fabric 的 1.1.0 预览版，命令行输入如下命令： peer --version 本文使用开源的 jq 工具来通过脚本处理与 configtxlator 返回的 JSON 的交互。这些 JSON 操作也可以手动或通过其他 JSON 工具执行。centos使用如下命令安装jq工具： 安装源： yum install epel-release 查看jq列表： yum list jq 执行安装： yun install jq 验证： 后台启动 configtxlator工具： 要启动configtxlator首先要编译configtxlator可执行程序，编译方法类似第三部分： 首先进入$GOPATH/src/github.com/hyperledger/fabric目录： cd $GOPATH/src/github.com/hyperledger/fabric 然后执行编译命令： make configtxlator 如下： 使用如下命令在后台启动configtxlator： configtxlator start &amp; 验证（查看）configtxlator是否启动： netstat -lnp | grep 7059 &nbsp; 2.检索区块 切换目录到/etc/hyperledger/fabric cd /etc/hyperledger/fabric 执行以下命令检索应用通道testchannel上最新的区块，因为订购者端点受 TLS 保护，所以以参数形式提供证书颁发机构身份。 peer channel fetch newest newest_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pen 可以看到目前最新的区块高度为229。 也可以指定区块高度，只需要修改命令中fetch后的参数即可，以区块高度228为例如下： peer channel fetch 228 228_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem 命令执行完成后可以在当前文件夹看到newest_block.pb（228_block.pb）文件。 &nbsp; 3.使用configtxlator解码pb文件 以newest_block.pb为例： curl -X POST --data-binary @newest_block.pb http://127.0.0.1:7059/protolator/decode/common.Block &gt; newest_block.json 完成后会在当前目录看到生成的newest_block.json文件，即可使用其他编辑软件打开查看。 &nbsp; 七、其他 1.git查看远程的所有分支列表 git branch -a *表示当前使用分支 如果上面命令不加参数（git branch），则为查看本地的git分支 END&nbsp; 阅读更多","@type":"BlogPosting","url":"/2018/10/13/df3120f53157956961ead727cd3c87eb.html","headline":"CentOS7中hyperledger-fabric1.1 - 2+6多机安装部署、部分异常处理以及使用configtxlator对区块基本信息查询（kafka共识，手动非docker方式）","dateModified":"2018-10-13T00:00:00+08:00","datePublished":"2018-10-13T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/10/13/df3120f53157956961ead727cd3c87eb.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>CentOS7中hyperledger-fabric1.1 - 2+6多机安装部署、部分异常处理以及使用configtxlator对区块基本信息查询（kafka共识，手动非docker方式）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="article-copyright">
   版权声明：转载请注明来源 https://blog.csdn.net/qq_38591756/article/details/83040322 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css"> 
 <div class="htmledit_views"> 
  <p>根据搜集的资料安装测试并在安装测试过程中整理的文档，如有不足希望不吝赐教。</p> 
  <hr>
  <blockquote> 
   <p>本文介绍CentOS7中hyperledger-fabric1.1多机部署使用kafka共识非docker方式，大体上与之前solo共识的步骤类似，（solo共识：《<a href="https://blog.csdn.net/qq_38591756/article/details/82959236" rel="nofollow">CentOS7中hyperledger-fabric1.1 - 1+4多机安装部署及部分异常处理（solo共识，手动非docker方式）</a>》）只是在其基础上将网络结构部署为2orderer+6peer结构，修改默认的solo共识为kafka共识，添加了使用configtxlator工具对区块信息查询，并且对部分不合理或冗余位置做了修改。kafka与zookeeper安装可以参考《<a href="https://blog.csdn.net/qq_38591756/article/details/82828993" rel="nofollow">CentOS7安装zookeeper</a>》《<a href="https://blog.csdn.net/qq_38591756/article/details/82829102" rel="nofollow">CentOS7安装kafka</a>》或者自行搜索安装方式。</p> 
  </blockquote> 
  <hr>
  <p>目录</p> 
  <h1 id="%E4%B8%80%E3%80%81%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D">一、环境介绍</h1> 
  <p>Fabric相关组件以及工具介绍：</p> 
  <p>- orderer 共识节点。为交易排序，并生成区块</p> 
  <p>- peer共识节点。为交易背书，并记录区块信息</p> 
  <p>- crypto用于生成区块链网络中相应用户的相关证书文件</p> 
  <p>- configtxgen 用于生成区块链系统链码的创世区块、新建通道的配置文件、以及组织中锚节点的配置文件</p> 
  <p>&nbsp;</p> 
  <p>本次Fabric区块链网络部署环境：8台 Centos 7系统的虚拟机。</p> 
  <p>其中golang、docker、内核升级等安装配置全部是使用<a href="https://blog.csdn.net/qq_38591756/article/details/82826979" rel="nofollow">单机测试</a>（<a href="https://blog.csdn.net/qq_38591756/article/details/82826979" rel="nofollow">https://blog.csdn.net/qq_38591756/article/details/82826979</a>）的配置，相关的安装配置步骤可以参考下面给出的链接或者自行搜索相关安装配置资料。</p> 
  <p>相关环境版本如下：</p> 
  <blockquote> 
   <p>golang：【go version】《<a href="https://blog.csdn.net/qq_38591756/article/details/81045613" rel="nofollow">CentOS7安装golang</a>》</p> 
   <p>&nbsp; &nbsp; go version go1.10.2 linux/amd64</p> 
   <p>docker：【docker --version】《<a href="https://blog.csdn.net/qq_38591756/article/details/82828130" rel="nofollow">CentOS7 - Docker&amp;Docker-Compose安装</a>》</p> 
   <p>&nbsp; &nbsp; Docker version 18.03.1-ce, build 9ee9f40</p> 
   <p>docker-compose：【docker-compose --version】《<a href="https://blog.csdn.net/qq_38591756/article/details/82828130" rel="nofollow">CentOS7 - Docker&amp;Docker-Compose安装</a>》</p> 
   <p>&nbsp; &nbsp; docker-compose version 1.21.2, build a133471</p> 
   <p>linux：【rpm -q centos-release】</p> 
   <p>&nbsp; &nbsp; centos-release-7-5.1804.el7.centos.2.x86_64</p> 
   <p>linux内核：【uname -a】《<a href="https://blog.csdn.net/qq_38591756/article/details/82829398" rel="nofollow">CentOS7修改内核版本</a>》</p> 
   <p>&nbsp; &nbsp; Linux localhost.localdomain 4.16.13-1.el7.elrepo.x86_64 #1 SMP Wed May 30 14:31:51 EDT 2018 x86_64 x86_64 x86_64 GNU/Linux</p> 
  </blockquote> 
  <p>2个 orderer 节点，6个 peer 节点，使用 kafka共识算法</p> 
  <p>172.17.3.207，208，209，211，212，213部署peer节点</p> 
  <p>172.17.3.205，206部署orderer节点</p> 
  <p>&nbsp;</p> 
  <h1 id="%E4%BA%8C%E3%80%81%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E3%80%81%E4%BB%A5%E5%8F%8Afabric%20%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BD%91%E7%BB%9C%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">二、<strong>源码编译、以及fabric 区块链网络部署环境准备</strong></h1> 
  <p>单机部署测试时，go、docker、docker-compose、git等应该已经安装完成并且已经完成环境变量等配置，fabric源码已经下载，此处不再赘述。如果后面步骤碰到未安装的依赖等可自行安装后继续。</p> 
  <blockquote> 
   <p><strong>注意：以下环境构建需要在每台机器上完成。</strong></p> 
  </blockquote> 
  <p>安装编译相关的依赖包 snappy-devel.x86_64、zlib-devel.x86_64、bzip2-devel.x86_64、libtoo-ltdl-devel.x86_64、libtool</p> 
  <p>可以使用命令直接安装，命令如下：</p> 
  <pre class="has">
<code>yum -y install snappy-devel.x86_64 zlib-devel.x86_64 bzip2-devel.x86_64 libtoo-ltdl-devel.x86_64 libtool</code></pre> 
  <p>从 github.com 上下载 go 语言编译相关环境 gotools（golang.org 需要翻墙，所以从 github 上获取）</p> 
  <p>在目录$GOPATH/src/golang.org/x/下执行：</p> 
  <pre class="has">
<code>git clone https://github.com/golang/tools.git</code></pre> 
  <p>&nbsp;</p> 
  <h1 id="%E4%B8%89%E3%80%81%E7%BC%96%E8%AF%91%20fabric%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9B%B8%E5%85%B3%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F">三、编译 fabric区块链相关可执行程序</h1> 
  <p>切换到 fabric 源码的目录下面，通过 makefile 文件，可以编译出 fabric 项目的全部可执行文件。</p> 
  <p>这次的演示例子中，只需要编译部分必要文件即可：orderer、peer、configtxgen、cryptogen。</p> 
  <blockquote> 
   <p><strong><em>注：以下命令，全部在</em><em>$GOPATH/src/github.com/hyperledger/fabric </em><em>目录下执行。</em></strong></p> 
  </blockquote> 
  <h2 id="1.%E7%BC%96%E8%AF%91go%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7">1.编译go相关工具</h2> 
  <pre class="has">
<code>cp -r $GOPATH/src/golang.org/x/tools/ $GOPATH/src/github.com/hyperledger/fabric/gotools/build/gopath/src</code></pre> 
  <p>完成后执行：</p> 
  <pre class="has">
<code>make gotools</code></pre> 
  <blockquote> 
   <p><strong>在执行</strong><strong>make</strong><strong>命令时可能会遇到的异常信息（一）：</strong></p> 
   <p>can't load package: package golang.org/x/lint/golint: no Go files in /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/golang.org/x/lint/golint</p> 
   <p>或</p> 
   <p>package golang.org/x/tools/go/ast/astutil: unrecognized import path "golang.org/x/tools/go/ast/astutil" (https fetch: Get https://golang.org/x/tools/go/ast/astutil?go-get=1: dial tcp 216.239.37.1:443: i/o timeout)</p> 
   <p>或</p> 
   <p>package golang.org/x/tools/go/gcexportdata: unrecognized import path "golang.org/x/tools/go/gcexportdata" (https fetch: Get https://golang.org/x/tools/go/gcexportdata?go-get=1: dial tcp 216.239.37.1:443: i/o timeout)</p> 
   <p>例如：</p> 
   <p style="text-align:center;"><img alt="" class="has" height="80" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007164200641?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
   <p><strong>解决办法：</strong></p> 
   <p>下载安装golang.org/x/net、golint</p> 
   <pre class="has">
<code>cd $GOPATH/src/golang.org/x/
git clone https://github.com/golang/net.git net
git clone https://github.com/golang/tools.git
git clone https://github.com/golang/lint.git
go install net
go get golang.org/x/lint/golint</code></pre> 
   <p>然后执行如下命令，如果出现没有文件夹的异常，根据命令在相应位置创建即可。</p> 
  </blockquote> 
  <blockquote> 
   <p><strong>在执行</strong><strong>make</strong><strong>命令时异常信息（二）：</strong></p> 
   <p style="text-align:center;"><img alt="" class="has" height="136" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007164325777?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
   <p><strong>解决办法：</strong></p> 
   <p>重试或者手动执行报错的git命令（如下）再重试。</p> 
   <pre class="has">
<code>git clone https://github.com/kardianos/govendor /opt/gopath/src/github.com/hyperledger/fabric/gotools/build/gopath/src/github.com/kardianos/govendor</code></pre> 
   <p>成功后类似如下截图：</p> 
   <p style="text-align:center;"><img alt="" class="has" height="144" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007164431235?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  </blockquote> 
  <p>&nbsp;</p> 
  <h2 id="2.%E7%BC%96%E8%AF%91%20fabric%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83">2.编译 fabric基础环境</h2> 
  <pre class="has">
<code>make buildenv</code></pre> 
  <blockquote> 
   <p><strong>在执行</strong><strong>make</strong><strong>命令时可能会遇到的异常信息（一）：</strong></p> 
   <p>[root@localhost fabric]# make buildenv</p> 
   <p>(cd build/docker/gotools/bin &amp;&amp; tar -jc *) &gt; build/gotools.tar.bz2</p> 
   <p>tar: *: Cannot stat: No such file or directory</p> 
   <p>tar: Exiting with failure status due to previous errors</p> 
   <p>make: *** [build/gotools.tar.bz2] Error 2</p> 
   <p>或</p> 
   <p>[root@localhost fabric]# make buildenv</p> 
   <p>mkdir -p build/image/buildenv/payload</p> 
   <p>cp build/gotools.tar.bz2 build/docker/gotools/bin/protoc-gen-go build/image/buildenv/payload</p> 
   <p>cp: cannot stat ‘build/docker/gotools/bin/protoc-gen-go’: No such file or directory</p> 
   <p>make: *** [build/image/buildenv/payload] Error 1</p> 
   <p style="text-align:center;"><img alt="" class="has" height="219" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007165250757?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
   <p><strong>解决办法：</strong></p> 
   <p>在出现错误1、2，3（截图中标注）时重试，每次错误不同，当出现第三次报错，如图，进行如下操作：</p> 
   <p>执行命令：</p> 
   <pre class="has">
<code>go get -u github.com/golang/protobuf/protoc-gen-go</code></pre> 
   <p>执行完成后可以在$GOPATH/bin/路径下看到protoc-gen-go文件，然后再执行命令：</p> 
   <pre class="has">
<code>cp /opt/gopath/bin/protoc-gen-go /opt/gopath/src/github.com/hyperledger/fabric/build/docker/gotools/bin/</code></pre> 
  </blockquote> 
  <p>针对上述异常，将其拷贝至指定目录，再次执行make buildenv，成功截图如下：</p> 
  <p style="text-align:center;"><img alt="" class="has" height="233" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007165414286?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p>&nbsp;</p> 
  <h2 id="3.%E7%BC%96%E8%AF%91%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9C%8D%E5%8A%A1%E7%9B%B8%E5%85%B3%E5%B7%A5%E5%85%B7">3.编译区块链服务相关工具</h2> 
  <p>分别执行下面四条命令：</p> 
  <pre class="has">
<code>make orderer
make peer
make configtxgen
make cryptogen</code></pre> 
  <p>编译的可执行程序生成在./fabric/build/bin目录下，设置该目录至 PATH环境变量。可以修改/etc/profile文件，在PATH后追加：</p> 
  <blockquote> 
   <p>:/opt/gopath/src/github.com/hyperledger/fabric/build/bin&nbsp; <em><u>注意前面的冒号</u></em></p> 
  </blockquote> 
  <p style="text-align:center;"><img alt="" class="has" height="31" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007165532503" width="781"></p> 
  <blockquote> 
   <p><strong>在执行</strong><strong>make</strong><strong>命令时可能会遇到的异常信息（一）：</strong></p> 
   <p>vendor/github.com/miekg/pkcs11/pkcs11.go:26:18: fatal error: ltdl.h: No such file or directory</p> 
   <p>&nbsp;#include &lt;ltdl.h&gt;</p> 
   <p><img alt="" class="has" height="137" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007165607258?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
   <p><strong>解决办法：</strong></p> 
   <p>安装ltdl，命令如下：</p> 
   <pre class="has">
<code>yum -y install libtool-ltdl-devel</code></pre> 
   <p>安装完成后重试即可。</p> 
  </blockquote> 
  <blockquote> 
   <p><strong>在执行</strong><strong>make peer</strong><strong>命令时可能会遇到的异常信息：</strong></p> 
   <p>curl: (6) Could not resolve host: services.gradle.org</p> 
   <p>The command '/bin/sh -c curl -sSL https://services.gradle.org/distributions/gradle-2.12-bin.zip &gt; /tmp/gradle-2.12-bin.zip' returned a non-zero code: 6</p> 
   <p>make: *** [build/image/javaenv/.dummy-x86_64-1.1.1-snapshot-ff5e861] Error 6</p> 
   <p><img alt="" class="has" height="56" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007165640541?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
   <p><strong>解决办法：</strong></p> 
   <p>根据网上查找的资料，需要修改dns，但是本次问题并没有解决，而是重启docker。以下为两种方法，请自行测试。</p> 
   <p>1）修改DNS：</p> 
   <p>修改/etc/NetworkManager/NetworkManager.conf文件，在main部分添加 “dns=none” 选项，如图：</p> 
   <p><img alt="" class="has" height="85" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007165706644?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="225"></p> 
   <p>然后重新装载上面修改的配置：</p> 
   <pre class="has">
<code>systemctl restart NetworkManager.service</code></pre> 
   <p>再修改/etc/resolv.conf文件，将dns改为114.114.114.114以及8.8.8.8，</p> 
   <p>&nbsp;</p> 
   <p>2）重启docker：</p> 
   <p>本次使用上面方法没有解决，最后使用重启docker的方法解决，重启命令:</p> 
   <pre class="has">
<code>service docker restart</code></pre> 
  </blockquote> 
  <p>编译成功截图：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007170015809?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <blockquote> 
   <p style="margin-left:0cm;"><strong>再次提示：</strong>以上环境需要在每台机器上构建完成。</p> 
  </blockquote> 
  <p>&nbsp;</p> 
  <h1 id="%E5%9B%9B%E3%80%81%E5%A4%9A%E6%9C%BA%E9%83%A8%E7%BD%B2fabric%E7%BD%91%E7%BB%9C(solo%E5%85%B1%E8%AF%86)">四、<strong>多机部署fabric网络(kafka共识)</strong></h1> 
  <blockquote> 
   <p><strong>注意：以下步骤执行之前需要做一些检查：</strong></p> 
   <ol>
    <li><strong>检查</strong><strong>orderer</strong><strong>节点上</strong><strong>7050</strong><strong>端口是否开放、</strong><strong>4</strong><strong>个</strong><strong>peer</strong><strong>节点的</strong><strong>7051</strong><strong>、</strong><strong>7052</strong><strong>、</strong><strong>7053</strong><strong>端口是否打开。然后用</strong><strong>telnet</strong><strong>（</strong><strong>telnet IP port</strong><strong>）命令或其他方法检查端口是否可以访问（可能需要安装</strong><strong>telnet</strong><strong>）。或者直接关闭所有防火墙。</strong></li> 
    <li><strong>如果之前执行过操作，没有成功而回头重复以下步骤（尤其重新生成证书、重启</strong><strong>orderer</strong><strong>、</strong><strong>peer</strong><strong>节点等操作），需要删除所有机器上</strong><strong>/var/hyperledger</strong><strong>目录下所有文件。本路径在配置文件</strong><strong>orderer</strong><strong>节点上的</strong><strong>orderer.yaml</strong><strong>（</strong><strong>FileLedger</strong><strong>标签下</strong><strong>Location</strong><strong>值）、</strong><strong>peer</strong><strong>节点上</strong><strong>core.yaml</strong><strong>（</strong><strong>fileSystemPath</strong><strong>值）中。否则在两个</strong><strong>peer</strong><strong>从节点以及在执行某些操作时会提示包含“</strong><strong>X509</strong><strong>”的错误。</strong></li> 
    <li><strong>因为用到了kafka集群，因此与Ⅱ类似的，如果已经执行了“<span style="color:#ff0000;">orderer start</span>“命令，在回头重复执行的时候需要删除fabric在kafka中创建的topic，具体删除方法请自行搜索或者参考《centos7安装kafka》。</strong></li> 
    <li><strong>检查所有机器的时区时间是否一致，如果不一致在后面启动等步骤会有类似类似超时或者过期的异常。查看时区及同步网络时间方法请自行搜索。</strong></li> 
   </ol>
  </blockquote> 
  <p>基本环境已经完成，下面将使用编译出来的可执行程序及相关工具，来搭建一个 fabric 区块链网络，并实现链码的部署以及测试。</p> 
  <p>首先，分别在五台虚拟机中创建目录/etc/hyperledger/fabric，以下的命令 全部在该目录下执行，并且需要设置 fabric 网络执行的环境变量：</p> 
  <p>FABRIC_CFG_PATH=/etc/hyperledger/fabric</p> 
  <p>可以直接在/etc/profile中添加，如图：</p> 
  <p><img alt="" class="has" height="21" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007170243879?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="351"></p> 
  <p>&nbsp;</p> 
  <h2 id="1.%E9%85%8D%E7%BD%AE%20fabric%20%E7%BD%91%E7%BB%9C%E7%94%A8%E6%88%B7%E6%8B%93%E6%89%91%E5%85%B3%E7%B3%BB">1.配置 fabric 网络用户拓扑关系</h2> 
  <p>通过配置文件 crypto-config.yaml配置fabric 网络用户拓扑关系。crypto-config.yaml 内容如下（crypto-config.yaml文件可以从e2e目录复制一份文件到当前目录）:</p> 
  <pre class="has">
<code>OrdererOrgs:
  - Name: Orderer
    Domain: example.com
    Specs:
      - Hostname: orderer0
      - Hostname: orderer1

PeerOrgs:
  - Name: Org1
    Domain: org1.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
    Specs:
      - Hostname: peer0
      - Hostname: peer1

  - Name: Org2
    Domain: org2.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
    Specs:
      - Hostname: peer0
      - Hostname: peer1

  - Name: Org3
    Domain: org3.example.com
    EnableNodeOUs: true
    Template:
      Count: 2
    Users:
      Count: 1
    Specs:
      - Hostname: peer0
      - Hostname: peer1</code></pre> 
  <p>如果设置了EnableNodeOUs，就在msp下生成config.yaml文件。</p> 
  <p>该配置文件，包含一个 orderer 节点，以及两个 peer组织，两个 peer 组织又分别包含了两个 peer 节点。</p> 
  <p>使用 cryptogen 工具，从crypto-config.yaml配置文件中生成用户相应的秘钥和证书文件 命令如下：</p> 
  <pre class="has">
<code>cryptogen generate --config=./crypto-config.yaml --output ./crypto-config</code></pre> 
  <p>成功后截图如下：</p> 
  <p style="text-align:center;"><img alt="" class="has" height="55" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018101317293691?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p>执行命令后，会在当前目录下生成文件夹 crypto-config，包含节点用户的秘钥以及证书文件，如图：</p> 
  <p style="text-align:center;"><img alt="" class="has" height="356" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013173031904?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p>通过scp命令分发 crypto-config文件夹，至其他7台虚拟机的/etc/hyperledger/fabric 目录下（以下为例，根据实际修改主机ip）：</p> 
  <pre class="has">
<code>scp -r crypto-config root@172.17.0.206:/etc/hyperledger/fabric/</code></pre> 
  <p>&nbsp;</p> 
  <h2 id="2.%E9%85%8D%E7%BD%AEOrderer%20%E8%8A%82%E7%82%B9%E7%9A%84%E5%90%AF%E5%8A%A8%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%96%B0%E5%BB%BA%E9%80%9A%E9%81%93%E4%BA%A4%E6%98%93%E7%9A%84%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE">2.配置Orderer 节点的启动创世区块，新建通道交易的相关配置</h2> 
  <p>通过配置文件 configtx.yaml 配置ordere 节点启动需要的创始区块信息，以及新建应用通道的交易信息。最初记录时使用的是word，配置文件内容太长，因此没有全部记录，以下截图仅为部分，完整配置文件统一放在附件（<a href="https://download.csdn.net/download/qq_38591756/10541424" rel="nofollow">CentOS7 - hyperledger fabric1.1 - 1+4多机部署（kafka共识）配置文件</a>）中，请自取，如果积分不足请留言。</p> 
  <p style="text-align:center;"><img alt="" class="has" height="597" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013173305367?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="497"></p> 
  <p>修改完成后执行下面命令：</p> 
  <p>使用工具configtxgen生成 orderer 节点启动所需的创世区块：</p> 
  <pre class="has">
<code>configtxgen -profile TwoOrgsOrdererGenesis -outputBlock genesis.block</code></pre> 
  <p>使用工具 configtxgen生成创建应用通道的交易配置文件：</p> 
  <pre class="has">
<code>configtxgen -profile TwoOrgsChannel -outputCreateChannelTx testchannel.tx -channelID testchannel</code></pre> 
  <p>使用工具 configtxgen 生成更新组织锚节点的配置信息文件：</p> 
  <pre class="has">
<code>configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org1MSPanchors.tx -channelID testchannel -asOrg Org1MSP

configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org2MSPanchors.tx -channelID testchannel -asOrg Org2MSP

configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./Org3MSPanchors.tx -channelID testchannel -asOrg Org3MSP</code></pre> 
  <p>执行命令后，在当前目录下会生成如下文件：</p> 
  <p>genesis.block、testchannel.tx、Org1MSPanchors.tx、Org2MSPanchors.tx、Org3MSPanchors.tx</p> 
  <p style="margin-left:0cm;">通过 scp 命令发送genesis.block文件至172.17.3.206</p> 
  <p style="margin-left:0cm;">通过 scp 命令发送Org1MSPanchors.tx文件至172.17.3.207</p> 
  <p style="margin-left:0cm;">通过 scp 命令发送Org2MSPanchors.tx文件至172.17.3.209</p> 
  <p style="margin-left:0cm;">通过 scp 命令发送Org3MSPanchors.tx文件至172.17.3.212</p> 
  <p style="margin-left:0cm;">通过 scp 命令发送 testchannel.tx文件至全部六台peer主机</p> 
  <p>&nbsp;</p> 
  <h2 id="3.%E8%AE%BE%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA%20Hosts%20%E6%96%87%E4%BB%B6">3.设置虚拟机 Hosts 文件</h2> 
  <p>由于 fabric 网络启动相关的配置文件中，与网络地址相关的信息都是填写的域名，所以需要在 hosts 文件中配置域名与 ip 的对应关系， orderer 节点和其他的4个 peer 节点的虚拟机都需要配置相关的 hosts 信息：vim /etc/hosts</p> 
  <blockquote> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.205 orderer0.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.206 orderer1.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.207 peer0.org1.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.208 peer1.org1.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.1.136 peer0.org2.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.211 peer1.org2.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.212 peer0.org3.example.com</span></p> 
   <p style="margin-left:0cm;"><span style="color:#7030a0;">172.17.3.213 peer1.org3.example.com</span></p> 
  </blockquote> 
  <p style="text-align:center;"><img alt="" class="has" height="162" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013173604531?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p>其中域名是根据 cryprto-config.yaml 的配置信息得来。</p> 
  <p>&nbsp;</p> 
  <h2 id="4.%E9%85%8D%E7%BD%AE%20orderer%20%E5%90%AF%E5%8A%A8%E7%8E%AF%E5%A2%83">4.配置 orderer 启动环境</h2> 
  <p style="text-indent:50px;">在orderer节点的虚拟机配置orderer节点启动相关配置信息 orderer.yaml，并保存在/etc/hyperledger/fabric目录下。<strong>需要注意的是：</strong>在orderer.yaml配置文件kafka配置标签中，最后有一个Version参数项，默认为空，默认的版本为0.10.2.0，因为本次安装kafka版本为2.1.1-1.1.0，因此需要修改此处的配置参数为实际安装的版本号：1.1.0。</p> 
  <p style="text-indent:50px;">相关配置文件内容见附件，因为文件不能重名并且为了区分，orderer和peer配置文件后面都加了数字编号以区分，实际使用时要去掉文件名后面的数字编号。</p> 
  <p>从 cypto-config 文件夹下，拷贝 orderer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下（<strong>两个orderer节点都需要执行，操作步骤类似</strong>）：</p> 
  <pre class="has">
<code>cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp ./

cp -r ./crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls ./</code></pre> 
  <p>根据前文的操作，fabric 网络 orderer 节点的执行环境目录下应该有以下文件及文件夹：</p> 
  <p>./crypto-config、./msp、./tls、orderer.yaml、genesis.block</p> 
  <p>启动 orderer 节点：</p> 
  <pre class="has">
<code>orderer start</code></pre> 
  <p>上面配置文件中，日志级别为debug（可以根据自己实际情况修改），因此orderer节点启动之后会在控制台看到相关可以看到与kafka相关的日志输出，</p> 
  <p>&nbsp;</p> 
  <h2 id="5.%E9%85%8D%E7%BD%AE%20peer%20%E5%90%AF%E5%8A%A8%E7%8E%AF%E5%A2%83">5.配置 peer 启动环境</h2> 
  <p>在 peer 节点的虚拟机配置 peer 节点启动相关配置信息 core.yaml，并保存在/etc/hyperledger/fabric 目录下。相关配置文件内容见附件。</p> 
  <p>从 crypto-config 文件夹下，拷贝 peer 节点的秘钥以及证书文件至 fabric 启动环境变量目录下：</p> 
  <pre class="has">
<code>cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp ./

cp -r ./crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls ./</code></pre> 
  <blockquote> 
   <p><span style="color:#4472c4;">注意标记部分应该在对应的目录下拷贝对应的文件信息（可以参考 hosts 配置信息的内容和本机ip区分）</span></p> 
  </blockquote> 
  <p>根据前文的操作，fabric 网络 peer 节点的执行环境目录下必须有以下文件及文件夹：</p> 
  <p>/crypto-config.tx、./msp、./tls、testchannel.tx、core.yaml、</p> 
  <p style="margin-left:0cm;">Org1MSPanchors.tx（.3.207虚拟机）、</p> 
  <p style="margin-left:0cm;">Org2MSPanchors.tx（.3.209虚拟机)、</p> 
  <p style="margin-left:0cm;">Org3MSPanchors.tx（.3.212虚拟机)、</p> 
  <p>启动 peer 节点：</p> 
  <pre class="has">
<code>peer node start</code></pre> 
  <blockquote> 
   <p><em>注意，拷贝</em><em> msp</em><em>、</em><em>tls </em><em>文件夹的动作可以不需要操作，只需要在对应的</em><em> orderer.yaml </em><em>以及</em><em> core.yaml </em><em>配置文件中设置相应的路径即可，这里为了能够与附件中的配置信息一致，故把相应的秘钥与证书文件拷贝至</em><em>fabric </em><em>网络执行环境变量的目录下</em></p> 
  </blockquote> 
  <p>&nbsp;</p> 
  <h2 id="6.%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E9%80%9A%E9%81%93">6.创建应用通道</h2> 
  <p>设置相应环境变量，6台peer节点都需要设置（根据相应环境修改配置中相应的位置,后面测试连码时也会用到，因此可以直接修改/etc/profile文件，在后面使用时可以不用重复设置）</p> 
  <blockquote> 
   <p>CORE_PEER_LOCALMSPID=Org1MSP</p> 
   <p>CORE_PEER_MSPCONFIGPATH=/etc/hyperledger/fabric/crypto-config/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp</p> 
  </blockquote> 
  <p>例如：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007171522184?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>执行命令创建应用通道（在peer0org1上执行即可）：</p> 
  <pre class="has">
<code>peer channel create -o orderer0.example.com:7050 -c testchannel -f ./testchannel.tx  --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem -t 3000</code></pre> 
  <p>命令执行成功以后，会在当前目录下生成 应用通道的创世区块testchannel.block 文件，只有使用该文件，才可以加入对应的应用通道。</p> 
  <blockquote> 
   <p style="margin-left:0cm;"><strong>【注意】</strong>最后-t命令可以指定通道创建的超时时间，debug下如果不指定一个较大的超时时间，很大程度上会因为超时创建失败。</p> 
  </blockquote> 
  <blockquote> 
   <p style="margin-left:0cm;"><strong>【注意】</strong>以上命令需要根据实际环境修改，比如orderer0.example.com:7050，如果与实际配置不一致（假如实际中为orderer<span style="color:#ff0000;">a</span>,但命令使用orderer0）会出现“context deadline exceeded” 异常。</p> 
  </blockquote> 
  <p>使用 scp命令分发至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量下(/etc/hyperledger/fabric)。以下为例：</p> 
  <pre class="has">
<code>scp -r testchannel.block root@172.17.0.208:/etc/hyperledger/fabric/</code></pre> 
  <p>&nbsp;</p> 
  <h2 id="7.%E5%8A%A0%E5%85%A5%E5%BA%94%E7%94%A8%E9%80%9A%E9%81%93">7.加入应用通道</h2> 
  <p>执行命令加入应用通道（6台peer节点都可以执行一遍）：</p> 
  <pre class="has">
<code>peer channel join -b testchannel.block</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007171652732?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>加入应用通道的peer 节点虚拟机都可以通过终端命令查看加入的通过信息，如图，如果所有peer节点都执行了加入命令，都可以看到如下类似信息：</p> 
  <pre class="has">
<code>peer channel list</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007171732623?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <h2 id="8.%E6%9B%B4%E6%96%B0%E9%94%9A%E8%8A%82%E7%82%B9%E9%85%8D%E7%BD%AE">8.更新锚节点配置</h2> 
  <p>执行命令更新负责代表组织与其他节点通信的锚节点（每个组织只需要在一台（peer0org1/peer0org2/peer0org3）上执行即可）。<em>每个组织指定一个anchor peer，anchor peer是组织用来接收orderer下发的区块的peer。</em>以org1为例：</p> 
  <pre class="has">
<code>peer channel update -o orderer0.example.com:7050 -c testchannel -f ./Org1MSPanchors.tx --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</code></pre> 
  <p>&nbsp;</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018101317444222?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>锚节点负责代表组织与其他组织中的节点进行 Gossip 通信。</p> 
  <p>&nbsp;</p> 
  <h1 id="%E4%BA%94%E3%80%81%E6%B5%8B%E8%AF%95%E9%93%BE%E7%A0%81">五、测试链码</h1> 
  <h2 id="1.%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81">1.安装链码</h2> 
  <p>设置相应环境变量（根据相应环境修改配置）：</p> 
  <p>如果在四.6步骤中已经修改过配置文件（/etc/profile），则此处不需要重复操作。</p> 
  <p>&nbsp;</p> 
  <p>打包链码，由于这次的例子是基于 go 语言开发的智能合约，会依赖 go 的开发环境进行安装，如果使用 peer chaincode install 命令指定链码路径安装，可能会造成其他虚拟上安装的同样的链码无法同步实例化（go 开发环境不一致引起的问题），所以这里使用 go chaincode package 打包链码，然后通过安装打包链码文件进行链码的安装。</p> 
  <blockquote> 
   <p><em><span style="color:#4472c4;">注意：如果是自定义的源码，最好在打包前在源码目录执行一次</span><span style="color:#ff0000;">go build</span><span style="color:#4472c4;">以检查代码是否有错误。</span></em></p> 
  </blockquote> 
  <blockquote> 
   <p><em>注意：这里进行测试的链码是</em><em> fabric </em><em>源码中的样例</em><em>-p </em><em>指定的路径在命令执行的时候会自动根据</em><em> GOPATH </em><em>环境变量自动补全前缀，所以路径一个在</em><em> $GOPATH/src/</em><em>目录下：</em></p> 
  </blockquote> 
  <pre class="has">
<code>peer chaincode package -n test -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 -v 1.0 test.pak</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007171956284?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>使用 scp 命令分发 test.pak 文件至其他5台 peer 节点虚拟机的 fabric 网络执行环境变量路径下。例如：</p> 
  <pre class="has">
<code>scp -r test.pak root@172.17.0.208:/etc/hyperledger/fabric/</code></pre> 
  <p>安装链码</p> 
  <pre class="has">
<code>peer chaincode install test.pak</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007172048318?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>安装链码的 peer 节点服务器可以通过终端命令查看已安装的链码信息，如图：</p> 
  <pre class="has">
<code>peer chaincode -C testchannel list --installed</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013174729105?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <h2 id="2.%E5%88%9D%E5%A7%8B%E5%8C%96%E9%93%BE%E7%A0%81">2.初始化链码</h2> 
  <p>初始化链码，只需要在一台 peer 节点的服务器上执行实例化后自动创建链码容器，其他 peer 节点服务器会同步该实例化的链码信息，并创建链码容器（需要启动docker容器：<span style="color:#f33b45;">service docker start</span>）</p> 
  <pre class="has">
<code>peer chaincode instantiate -o orderer0.example.com:7050 -C testchannel -n test -v 1.0 -c'{"Args":["init","a","1000","b","2000"]}' -P "OR ('Org1MSP.member','Org2MSP.member','Org3MSP.member')" --tls true --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</code></pre> 
  <p>命令执行后对交易用户 a赋值100，交易用户 b 赋值200代币。</p> 
  <p>&nbsp;</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013174921635?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <blockquote> 
   <p style="margin-left:0cm;">-P指定的参数OR ('Org1MSP.member','Org2MSP.member','Org3MSP.member')是CLI endorsement policy语法，其作用是设置背书策略，表示需要请求三个组织的任何一个签名即可，类似的，如果设置AND ('Org1MSP.member','Org2MSP.member','Org3MSP.member')则表示需要三个组织签名，如果设置OR ('Org1MSP.member',AND('Org2MSP.member','Org3MSP.member'))则表示需要组织一或者组织二和三的签名。</p> 
  </blockquote> 
  <p>使用命令查看链码容器信息：docker ps。如图：</p> 
  <p style="text-align:center;"><img alt="" class="has" height="50" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175008397?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p>使用命令：</p> 
  <pre class="has">
<code>peer chaincode query -n test -C testchannel -c'{"Args":["query","a"]}'</code></pre> 
  <p>查看用户a（b）初始值：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018101317505084?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <h2 id="3.%E6%B5%8B%E8%AF%95%E4%BA%A4%E6%98%93">3.测试交易</h2> 
  <p>执行命令发送一笔交易，命令 b 向 a 转账 40个代币：</p> 
  <pre class="has">
<code>peer chaincode invoke -o orderer0.example.com:7050 -C testchannel -n test -c'{"Args":["invoke","b","a","40"]}' --tls ture --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175145661?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>再次查询a、b余额命令与五.2查询命令相同：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175202533?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>查询转账命令可以在任意peer节点执行，上面查询在.3.207节点（日志级别debug），其他节点类似。</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h1>六、<strong>区块基本信息查询</strong></h1> 
  <p>在peer节点执行，以下以207为例。</p> 
  <p>需要使用configtxlator工具，参考《<span style="color:#0563c1;"><u><a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-add-an-organization-to-your-hyperledger-fabric-blockchain/index.html" rel="nofollow">使用一个简单工具向现有的 Hyperledger Fabric 区块链网络添加一个组织</a></u></span>》，简介如下：</p> 
  <p style="text-indent:50px;">configtxlator 工具提供了一个与 SDK 独立的真正无状态的 REST API，以简化 Hyperledger Fabric 区块链网络中的配置任务。该工具能够在不同的等效数据表示/格式之间轻松转换。例如，在工具操作的一种模式中，该工具在二进制 protobuf 格式与人类可读的 JSON 文本格式间来回转换。此外，该工具可以基于两组不同的配置交易之间的区别来计算配置更新。</p> 
  <p>&nbsp;</p> 
  <h2>1.设置环境</h2> 
  <p style="margin-left:0cm;">确保您至少安装了 Hyperledger Fabric 的 1.1.0 预览版，命令行输入如下命令：</p> 
  <pre class="has">
<code>peer --version</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" height="211" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018101317540869?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="465"></p> 
  <p style="text-indent:50px;">本文使用开源的 jq 工具来通过脚本处理与 configtxlator 返回的 JSON 的交互。这些 JSON 操作也可以手动或通过其他 JSON 工具执行。centos使用如下命令安装jq工具：</p> 
  <p>安装源：</p> 
  <pre class="has">
<code>yum install epel-release</code></pre> 
  <p style="margin-left:0cm;">查看jq列表：</p> 
  <pre class="has">
<code>yum list jq</code></pre> 
  <p style="margin-left:0cm;">执行安装：</p> 
  <pre class="has">
<code>yun install jq</code></pre> 
  <p style="margin-left:0cm;">验证：</p> 
  <p style="text-align:center;"><img alt="" class="has" height="301" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175521717?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p style="margin-left:0cm;">后台启动 configtxlator工具：</p> 
  <p style="margin-left:0cm;">要启动configtxlator首先要编译configtxlator可执行程序，编译方法类似第三部分：</p> 
  <p style="margin-left:0cm;">首先进入$GOPATH/src/github.com/hyperledger/fabric目录：</p> 
  <pre class="has">
<code>cd $GOPATH/src/github.com/hyperledger/fabric</code></pre> 
  <p style="margin-left:0cm;">然后执行编译命令：</p> 
  <pre class="has">
<code>make configtxlator</code></pre> 
  <p>如下：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175646156?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>使用如下命令在后台启动configtxlator：</p> 
  <pre class="has">
<code>configtxlator start &amp;</code></pre> 
  <p style="margin-left:0cm;">验证（查看）configtxlator是否启动：</p> 
  <pre class="has">
<code>netstat -lnp | grep 7059</code></pre> 
  <p><img alt="" class="has" height="32" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175717551?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="554"></p> 
  <p>&nbsp;</p> 
  <h2>2.检索区块</h2> 
  <p style="margin-left:0cm;">切换目录到/etc/hyperledger/fabric</p> 
  <pre class="has">
<code>cd /etc/hyperledger/fabric</code></pre> 
  <p style="margin-left:0cm;">执行以下命令检索应用通道testchannel上最新的区块，因为订购者端点受 TLS 保护，所以以参数形式提供证书颁发机构身份。</p> 
  <pre class="has">
<code>peer channel fetch newest newest_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pen</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175830394?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">可以看到目前最新的区块高度为229。</p> 
  <p style="margin-left:0cm;">也可以指定区块高度，只需要修改命令中fetch后的参数即可，以区块高度228为例如下：</p> 
  <pre class="has">
<code>peer channel fetch 228 228_block.pb -c testchannel -o orderer0.example.com:7050 --tls --cafile /etc/hyperledger/fabric/crypto-config/ordererOrganizations/example.com/orderers/orderer0.example.com/msp/tlscacerts/tlsca.example.com-cert.pem</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013175919230?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">命令执行完成后可以在当前文件夹看到newest_block.pb（228_block.pb）文件。</p> 
  <p style="margin-left:0cm;">&nbsp;</p> 
  <h2 style="margin-left:0cm;">3.使用configtxlator解码pb文件</h2> 
  <p style="margin-left:0cm;">以newest_block.pb为例：</p> 
  <pre class="has">
<code>curl -X POST --data-binary @newest_block.pb http://127.0.0.1:7059/protolator/decode/common.Block &gt; newest_block.json</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181013180024695?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>完成后会在当前目录看到生成的newest_block.json文件，即可使用其他编辑软件打开查看。</p> 
  <p>&nbsp;</p> 
  <h1 id="%E5%85%AD%E3%80%81%E5%85%B6%E4%BB%96">七、其他</h1> 
  <h2 id="1.git%E6%9F%A5%E7%9C%8B%E8%BF%9C%E7%A8%8B%E7%9A%84%E6%89%80%E6%9C%89%E5%88%86%E6%94%AF%E5%88%97%E8%A1%A8">1.git查看远程的所有分支列表</h2> 
  <pre class="has">
<code>git branch -a</code></pre> 
  <p>*表示当前使用分支</p> 
  <p><img alt="" class="has" height="179" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007172653723?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="322"></p> 
  <p>如果上面命令不加参数（git branch），则为查看本地的git分支</p> 
  <p><img alt="" class="has" height="37" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181007172707493?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTkxNzU2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" width="265"></p> 
  <hr>
  <p>END&nbsp;</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq_38591756/article/details/83040322,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq_38591756/article/details/83040322,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
