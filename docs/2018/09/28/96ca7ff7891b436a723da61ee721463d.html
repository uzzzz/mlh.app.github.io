<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>0920mysql课堂笔记及作业 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="0920mysql课堂笔记及作业" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="0920MYSQL 选取数据 select item,value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in (&#39;totalassets&#39;,&#39;totalLiab&#39;) 转置 select item case when item=&#39;totalAssets&#39; then vlaue else 0 end, value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in (&#39;totalassets&#39;,&#39;totalLiab&#39;) select item, case when item=&#39;totalAssets&#39; then value else 0 end, case when item = &#39;totalLiab&#39; then value else 0 end, value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in(&#39;totalassets&#39;,&#39;totalLiab&#39;) select sum(case when item=&#39;totalAssets&#39; then value else 0 end), sum(case when item = &#39;totalLiab&#39; then value else 0 end) from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in(&#39;totalassets&#39;,&#39;totalLiab&#39;) 按照公司分组显示 select corp, sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) from tfinance_yahoo where period = &#39;201806&#39; AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;) group by corp 按照资产负债率排序 select corp, sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) from tfinance_yahoo where period = &#39;201806&#39; AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;) group by corp order by sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) 反向排序 desc select 选取数据条目 from 数据集 where 索引条目 group by 分组 order by 排序，降序 desc 升序 筛选 group by corp having sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end)&gt;0.5 SQL + python与交易系统 wdi数据库调用 select * from wdi_data where country_code = &#39;CHN&#39; 技术分析 select code,sum(close),count(*),sum(close)/count(*) from stock_data group by code 作业 一、阿特曼Z-SCOREs模型SQL实现 #Z = 1.2X1 + 1.4X2 + 3.3X3 + 0.6X4 + 0.99X5 #X1=营运资本／资产总额 #X2=留存收益／资产总额 #X3=息税前利润／资产总额 #X4=股东权益的市场价值总额／负债总额 #X5=销售收入／资产总额 (1) 暂时用所有者权益代替股东权益的市场价值总额 select a.corp,a.x1,a.x2,a.x3,a.x4,a.x5, 1.2*a.x1 + 1.4*a.x2 + 3.3*a.x3 +0.6*a.x4+0.99*a.x5 as z from(select corp, ((sum(case when item = &#39;totalCurrentAssets&#39; then value else 0 end)-sum(case when item = &#39;totalCurrentLiabilities&#39; then value else 0 end))/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x1, (sum(case when item = &#39;retainedearnings&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x2, (sum(case when item = &#39;ebit&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x3, (sum(case when item = &#39;totalstockholderequity&#39; then value else 0 end)/sum(case when item = &#39;totalLiab&#39; then value else 0 end)) as x4, (sum(case when item = &#39;totalRevenue&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x5 from tfinance_yahoo where period = &#39;201806&#39;AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;,&#39;totalRevenue&#39;,&#39;ebit&#39; ,&#39;totalCurrentAssets&#39;,&#39;totalCurrentLiabilities&#39;,&#39;retainedearnings&#39;,&#39;totalstockholderequity&#39;) group by corp )a group by a.corp (2) 尝试引入数据库中最新的股票收盘价来计算股东权益的市场价值总额 select a.corp,a.x1,a.x2,a.x3,b.close*a.commonstocks/a.totalLiab as x4,a.x5, 1.2*a.x1 + 1.4*a.x2 + 3.3*a.x3 +0.6*b.close*a.commonstocks/a.totalLiab+0.99*a.x5 as z from(select corp, ((sum(case when item = &#39;totalCurrentAssets&#39; then value else 0 end)-sum(case when item = &#39;totalCurrentLiabilities&#39; then value else 0 end))/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x1, (sum(case when item = &#39;retainedearnings&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x2, (sum(case when item = &#39;ebit&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x3, (sum(case when item = &#39;totalRevenue&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x5, sum(case when item = &#39;commonstock&#39; then value else 0 end) as commonstocks, sum(case when item = &#39;totalLiab&#39; then value else 0 end) as totalLiab from tfinance_yahoo where period = &#39;201806&#39;AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;,&#39;totalRevenue&#39;,&#39;ebit&#39; ,&#39;totalCurrentAssets&#39;,&#39;totalCurrentLiabilities&#39;,&#39;retainedearnings&#39;,&#39;commonstock&#39;) group by corp )a, (select b_1.close as close from ( select close from stock_data where code = &#39;AAPL&#39; order by time desc )b_1 limit 1 )b 二、海龟交易法则python实现 原理 市场： 海龟们都是期货交易者，海龟们只选择有一定交易量流动性高的市场。这里我选择日指数数据CSI300.INDX，一方面是为了更好与基准比较，另一方面也是因为该标的可以不用担心流动性的问题。 头寸规模： 头寸规模是海龟交易系统最重要的部分之一。 海龟交易法则根据一个市场的绝对波动幅度来调整头寸规模，也就是将头寸的绝对波动幅度进行了标准化。比如，投资标的的价值波动性较强时，可以减少持有量，相反，当它的价值波动性较弱时候，可以增加持有量。总而言之，市场的波动性与头寸规模可以相互抵消。 海龟用一个被称为N的概念来表示某个市场根本的波动性，它表示单个交易日某个特定市场所造成的价格波动的平均范围，它同时也涵盖了开盘价的缺口。其实这个所谓的N，就是我们平常所熟悉的ATR，关于ATR的介绍，可以戳AVERAGE TRUE RANGE. 以下为计算公式： TR=Max(H-L,H-PDC,PDC-L) 其中： TR=真实波幅 H=当日最高价 L=当日最低价 PDC=前一日收盘价 N(即ATR)的计算公式如下(其实就是前面计算所得TR的20日移动平均)： N=(19*PDN+TR)/20 其中： PDN=前一日N值 TR=当日的真实波动幅度 有了N之后，下一步可以计算绝对波动幅度，也就是用根本的市场价格波动性（用N值定义）表示的价值量波动性。 绝对波动幅度=N*合约每一点所代表的价值 最后，海龟按照我们所称的单位（Units）建立头寸。使1N代表帐户净值的1%。 波幅调整后的头寸单位为： 头寸规模单位=账户的1%/市场的绝对波动幅度 可以看出，使用N作为市场波动标准化的度量并以此作为开仓量及持仓量的依据，其背后的资金管理含义是，即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 入市： 海龟的入市规则有两个系统，我们可以根据自己的意愿决定将净值配置在何种系统上。 系统一————以20日突破为基础的偏短线系统 突破定义为超过前20日的最高价或者最低价 海龟总是在日间突破发生时进行交易，而不会等到收盘或次日开盘。 系统二————以55日突破为基础的较简单的长线系统 只要有一个信号显示价格超过了前55日的最高价和最低价就建立头寸。 追踪： 海龟交易系统不是一有突破信号就全仓介入，而是根据最新市场价格变化进行逐步建仓。 海龟在价格突破时只建立一个单位的头寸，在建立头寸后根据前面指令的实际成交价为基础以每突破0.5N的间隔进行加仓。 例如： 黄金：N=2.5 55日突破=310 增加的第一个单位310.00 第二个单位310.00+1/2个2.5即311.25 第三个单位311.25+1/2个2.5即312.50 第四个单位312.50+1/2个2.5即313.75 海龟被告知在接受入市信号时要非常连续，因为一年中的大部分利润可能仅仅来自两三次大赢利。 止损： 对大多数人来说，始终抱着亏损的交易终究会反转的愿望比干脆退出亏损头寸并承认交易失败要容易得多。长期看，不会止损的交易是不会成功的。在你建立头寸之前，你需要预先确定退出的点位。如果市场波动触及你的价位，你就必须每一次毫无例外的退出。在这一立场上摇摆不定最终会导致灾难。(画外音：前段时间大家应该体会比较深刻吧。) 止损标准 海龟以头寸风险为基础设置止损，任何一笔交易不能出现2%以上的风险，因为价格波动1N表示1%的账户净值，容许风险为2%的最大止损就是价格波动2N，为了保证全部头寸的风险最小，如果另外增加了单位，前面单位的止损需提高0.5N。 例如： 原油：N=1.255 日突破=28.30 第一单位 28.30 25.90 离市： 艰难的离市 对于大多数交易员，海龟离市规则是系统法则中唯一最难的部分。等待10或20新低出现通常意味着眼睁睁瞅着20%，40%甚至100%的利润化为泡影。 海龟交易法则对于系统一系统二有着不同的离市标准： 系统一 离市对于多头头寸为10日最低价，对于空头头寸为10日最高价。如果价格波动于头寸背离至10日突破头寸中所有单位都会退出 系统二 离市对于多头头寸为20日最低价，对于空头头寸为20日最高价，如果价格波动与头寸背离至20日突破头寸中所有单位都会退出 海龟入市时一般不会设置离市止损价，但会在日间盯着价格，一旦价格穿过离市突破价，就开始打电话下离市指令。 PYTHON代码 import pandas as pd import pymysql from datetime import datetime from datetime import timedelta #变量数据 cash0 = 10000#资金量 date_1 = &#39;2017-11-01&#39;#初始日期 p_1 = datetime.strptime(date_1,&quot;%Y-%m-%d&quot;) p_2 = p_1 - timedelta(days = 55) p_3 = p_1 - timedelta(days = 20) date_2 = p_2.strftime(&#39;%Y-%m-%d&#39;) date_3 = p_3.strftime(&#39;%Y-%m-%d&#39;) #链接数据库 con = pymysql.connect(host = &#39;47.97.205.89&#39;,port = 3306,user = &#39;#&#39;, passwd = &#39;#&#39;,db = &#39;quantity&#39;,use_unicode = True, charset = &quot;utf8&quot;) cursor = con.cursor() ############################# ########海龟交易法则######### ############################# #回测标的股/股票池 code = &#39;AAPL&#39; #提取前55日均价&amp;提取前20日最低价 df = pd.read_sql(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39;and TradingDay&gt;=&#39;&quot;+date_2+&quot;&#39;and TradingDay&lt;&#39;&quot;+date_1+&quot;&#39;&quot;,con) max_ = df[&#39;close&#39;].max() df = pd.read_sql(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39;and TradingDay&gt;=&#39;&quot;+date_3+&quot;&#39;and TradingDay&lt;&#39;&quot;+date_1+&quot;&#39;&quot;,con) min_ = df[&#39;close&#39;].min() cash = cash0#开仓前资金 stocknum = 0#持股量 buynum = 0 sellnum = 0 remain = 0 cursor.execute(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39; and TradingDay&gt;=&#39;&quot;+date_1+&quot;&#39; order by Time&quot;) for row in cursor.fetchall(): price = row[0] #获取此分钟的收盘价格 #开仓（超过前55日买入）,每次全仓操作 if (price &gt; max_ and stocknum==0) : stocknum = int(cash/price) cash = cash - stocknum*price buynum = buynum + 1 remain = price #离市*低于前20日最低价卖出 elif price &lt; min_ and stocknum!=0: cash = cash + stocknum*price stocknum = 0 sellnum = sellnum + 1 #动态调整最低最高价 if price&gt;max_:max_ = price if price&lt;min_:min_ = price print (&#39;现金：&#39;+str(cash)+&#39;,股票：&#39;+str(stocknum)+&#39;,股价：&#39;+str(remain)+&#39;,收益：&#39;+str(100*((cash+stocknum*remain)-cash0)/cash0)+&#39;%&#39;) print (&#39; 买入次数：&#39;+str(buynum)+&#39; 卖出次数：&#39;+str(sellnum)) print(max_) print(min_) cursor.close() con.close() 现金：9146.239929182,股票：0,股价：169.75,收益：-8.537600708179998% 买入次数：1 卖出次数：1 180.080001831 150.610397339 作业讲解 #强调数据仓库的作用 #DW数据仓库 #DM数据集市 #创建另外一张表，将结果放进去 #tabe为实体，需要及时更新，速度较快，只有管理员可以创建 #create table vifinance_yahoo as #view为虚拟，自动更新，速度较慢 create view vifinance_yahoo as select corp,sum(case when item= &#39;totalliab&#39; then value else 0 end)/sum(case when item= &#39;totalassets&#39; then value else 0 end) as aaa from tfinance_yahoo group by corp #市值调取 select tfinance_yahoo.value,stock_list from tfinance_yahoo left jon stock_list on tfinance_yahoo.corp=jon stock_list.code 阅读更多" />
<meta property="og:description" content="0920MYSQL 选取数据 select item,value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in (&#39;totalassets&#39;,&#39;totalLiab&#39;) 转置 select item case when item=&#39;totalAssets&#39; then vlaue else 0 end, value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in (&#39;totalassets&#39;,&#39;totalLiab&#39;) select item, case when item=&#39;totalAssets&#39; then value else 0 end, case when item = &#39;totalLiab&#39; then value else 0 end, value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in(&#39;totalassets&#39;,&#39;totalLiab&#39;) select sum(case when item=&#39;totalAssets&#39; then value else 0 end), sum(case when item = &#39;totalLiab&#39; then value else 0 end) from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in(&#39;totalassets&#39;,&#39;totalLiab&#39;) 按照公司分组显示 select corp, sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) from tfinance_yahoo where period = &#39;201806&#39; AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;) group by corp 按照资产负债率排序 select corp, sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) from tfinance_yahoo where period = &#39;201806&#39; AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;) group by corp order by sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) 反向排序 desc select 选取数据条目 from 数据集 where 索引条目 group by 分组 order by 排序，降序 desc 升序 筛选 group by corp having sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end)&gt;0.5 SQL + python与交易系统 wdi数据库调用 select * from wdi_data where country_code = &#39;CHN&#39; 技术分析 select code,sum(close),count(*),sum(close)/count(*) from stock_data group by code 作业 一、阿特曼Z-SCOREs模型SQL实现 #Z = 1.2X1 + 1.4X2 + 3.3X3 + 0.6X4 + 0.99X5 #X1=营运资本／资产总额 #X2=留存收益／资产总额 #X3=息税前利润／资产总额 #X4=股东权益的市场价值总额／负债总额 #X5=销售收入／资产总额 (1) 暂时用所有者权益代替股东权益的市场价值总额 select a.corp,a.x1,a.x2,a.x3,a.x4,a.x5, 1.2*a.x1 + 1.4*a.x2 + 3.3*a.x3 +0.6*a.x4+0.99*a.x5 as z from(select corp, ((sum(case when item = &#39;totalCurrentAssets&#39; then value else 0 end)-sum(case when item = &#39;totalCurrentLiabilities&#39; then value else 0 end))/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x1, (sum(case when item = &#39;retainedearnings&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x2, (sum(case when item = &#39;ebit&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x3, (sum(case when item = &#39;totalstockholderequity&#39; then value else 0 end)/sum(case when item = &#39;totalLiab&#39; then value else 0 end)) as x4, (sum(case when item = &#39;totalRevenue&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x5 from tfinance_yahoo where period = &#39;201806&#39;AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;,&#39;totalRevenue&#39;,&#39;ebit&#39; ,&#39;totalCurrentAssets&#39;,&#39;totalCurrentLiabilities&#39;,&#39;retainedearnings&#39;,&#39;totalstockholderequity&#39;) group by corp )a group by a.corp (2) 尝试引入数据库中最新的股票收盘价来计算股东权益的市场价值总额 select a.corp,a.x1,a.x2,a.x3,b.close*a.commonstocks/a.totalLiab as x4,a.x5, 1.2*a.x1 + 1.4*a.x2 + 3.3*a.x3 +0.6*b.close*a.commonstocks/a.totalLiab+0.99*a.x5 as z from(select corp, ((sum(case when item = &#39;totalCurrentAssets&#39; then value else 0 end)-sum(case when item = &#39;totalCurrentLiabilities&#39; then value else 0 end))/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x1, (sum(case when item = &#39;retainedearnings&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x2, (sum(case when item = &#39;ebit&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x3, (sum(case when item = &#39;totalRevenue&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x5, sum(case when item = &#39;commonstock&#39; then value else 0 end) as commonstocks, sum(case when item = &#39;totalLiab&#39; then value else 0 end) as totalLiab from tfinance_yahoo where period = &#39;201806&#39;AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;,&#39;totalRevenue&#39;,&#39;ebit&#39; ,&#39;totalCurrentAssets&#39;,&#39;totalCurrentLiabilities&#39;,&#39;retainedearnings&#39;,&#39;commonstock&#39;) group by corp )a, (select b_1.close as close from ( select close from stock_data where code = &#39;AAPL&#39; order by time desc )b_1 limit 1 )b 二、海龟交易法则python实现 原理 市场： 海龟们都是期货交易者，海龟们只选择有一定交易量流动性高的市场。这里我选择日指数数据CSI300.INDX，一方面是为了更好与基准比较，另一方面也是因为该标的可以不用担心流动性的问题。 头寸规模： 头寸规模是海龟交易系统最重要的部分之一。 海龟交易法则根据一个市场的绝对波动幅度来调整头寸规模，也就是将头寸的绝对波动幅度进行了标准化。比如，投资标的的价值波动性较强时，可以减少持有量，相反，当它的价值波动性较弱时候，可以增加持有量。总而言之，市场的波动性与头寸规模可以相互抵消。 海龟用一个被称为N的概念来表示某个市场根本的波动性，它表示单个交易日某个特定市场所造成的价格波动的平均范围，它同时也涵盖了开盘价的缺口。其实这个所谓的N，就是我们平常所熟悉的ATR，关于ATR的介绍，可以戳AVERAGE TRUE RANGE. 以下为计算公式： TR=Max(H-L,H-PDC,PDC-L) 其中： TR=真实波幅 H=当日最高价 L=当日最低价 PDC=前一日收盘价 N(即ATR)的计算公式如下(其实就是前面计算所得TR的20日移动平均)： N=(19*PDN+TR)/20 其中： PDN=前一日N值 TR=当日的真实波动幅度 有了N之后，下一步可以计算绝对波动幅度，也就是用根本的市场价格波动性（用N值定义）表示的价值量波动性。 绝对波动幅度=N*合约每一点所代表的价值 最后，海龟按照我们所称的单位（Units）建立头寸。使1N代表帐户净值的1%。 波幅调整后的头寸单位为： 头寸规模单位=账户的1%/市场的绝对波动幅度 可以看出，使用N作为市场波动标准化的度量并以此作为开仓量及持仓量的依据，其背后的资金管理含义是，即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 入市： 海龟的入市规则有两个系统，我们可以根据自己的意愿决定将净值配置在何种系统上。 系统一————以20日突破为基础的偏短线系统 突破定义为超过前20日的最高价或者最低价 海龟总是在日间突破发生时进行交易，而不会等到收盘或次日开盘。 系统二————以55日突破为基础的较简单的长线系统 只要有一个信号显示价格超过了前55日的最高价和最低价就建立头寸。 追踪： 海龟交易系统不是一有突破信号就全仓介入，而是根据最新市场价格变化进行逐步建仓。 海龟在价格突破时只建立一个单位的头寸，在建立头寸后根据前面指令的实际成交价为基础以每突破0.5N的间隔进行加仓。 例如： 黄金：N=2.5 55日突破=310 增加的第一个单位310.00 第二个单位310.00+1/2个2.5即311.25 第三个单位311.25+1/2个2.5即312.50 第四个单位312.50+1/2个2.5即313.75 海龟被告知在接受入市信号时要非常连续，因为一年中的大部分利润可能仅仅来自两三次大赢利。 止损： 对大多数人来说，始终抱着亏损的交易终究会反转的愿望比干脆退出亏损头寸并承认交易失败要容易得多。长期看，不会止损的交易是不会成功的。在你建立头寸之前，你需要预先确定退出的点位。如果市场波动触及你的价位，你就必须每一次毫无例外的退出。在这一立场上摇摆不定最终会导致灾难。(画外音：前段时间大家应该体会比较深刻吧。) 止损标准 海龟以头寸风险为基础设置止损，任何一笔交易不能出现2%以上的风险，因为价格波动1N表示1%的账户净值，容许风险为2%的最大止损就是价格波动2N，为了保证全部头寸的风险最小，如果另外增加了单位，前面单位的止损需提高0.5N。 例如： 原油：N=1.255 日突破=28.30 第一单位 28.30 25.90 离市： 艰难的离市 对于大多数交易员，海龟离市规则是系统法则中唯一最难的部分。等待10或20新低出现通常意味着眼睁睁瞅着20%，40%甚至100%的利润化为泡影。 海龟交易法则对于系统一系统二有着不同的离市标准： 系统一 离市对于多头头寸为10日最低价，对于空头头寸为10日最高价。如果价格波动于头寸背离至10日突破头寸中所有单位都会退出 系统二 离市对于多头头寸为20日最低价，对于空头头寸为20日最高价，如果价格波动与头寸背离至20日突破头寸中所有单位都会退出 海龟入市时一般不会设置离市止损价，但会在日间盯着价格，一旦价格穿过离市突破价，就开始打电话下离市指令。 PYTHON代码 import pandas as pd import pymysql from datetime import datetime from datetime import timedelta #变量数据 cash0 = 10000#资金量 date_1 = &#39;2017-11-01&#39;#初始日期 p_1 = datetime.strptime(date_1,&quot;%Y-%m-%d&quot;) p_2 = p_1 - timedelta(days = 55) p_3 = p_1 - timedelta(days = 20) date_2 = p_2.strftime(&#39;%Y-%m-%d&#39;) date_3 = p_3.strftime(&#39;%Y-%m-%d&#39;) #链接数据库 con = pymysql.connect(host = &#39;47.97.205.89&#39;,port = 3306,user = &#39;#&#39;, passwd = &#39;#&#39;,db = &#39;quantity&#39;,use_unicode = True, charset = &quot;utf8&quot;) cursor = con.cursor() ############################# ########海龟交易法则######### ############################# #回测标的股/股票池 code = &#39;AAPL&#39; #提取前55日均价&amp;提取前20日最低价 df = pd.read_sql(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39;and TradingDay&gt;=&#39;&quot;+date_2+&quot;&#39;and TradingDay&lt;&#39;&quot;+date_1+&quot;&#39;&quot;,con) max_ = df[&#39;close&#39;].max() df = pd.read_sql(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39;and TradingDay&gt;=&#39;&quot;+date_3+&quot;&#39;and TradingDay&lt;&#39;&quot;+date_1+&quot;&#39;&quot;,con) min_ = df[&#39;close&#39;].min() cash = cash0#开仓前资金 stocknum = 0#持股量 buynum = 0 sellnum = 0 remain = 0 cursor.execute(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39; and TradingDay&gt;=&#39;&quot;+date_1+&quot;&#39; order by Time&quot;) for row in cursor.fetchall(): price = row[0] #获取此分钟的收盘价格 #开仓（超过前55日买入）,每次全仓操作 if (price &gt; max_ and stocknum==0) : stocknum = int(cash/price) cash = cash - stocknum*price buynum = buynum + 1 remain = price #离市*低于前20日最低价卖出 elif price &lt; min_ and stocknum!=0: cash = cash + stocknum*price stocknum = 0 sellnum = sellnum + 1 #动态调整最低最高价 if price&gt;max_:max_ = price if price&lt;min_:min_ = price print (&#39;现金：&#39;+str(cash)+&#39;,股票：&#39;+str(stocknum)+&#39;,股价：&#39;+str(remain)+&#39;,收益：&#39;+str(100*((cash+stocknum*remain)-cash0)/cash0)+&#39;%&#39;) print (&#39; 买入次数：&#39;+str(buynum)+&#39; 卖出次数：&#39;+str(sellnum)) print(max_) print(min_) cursor.close() con.close() 现金：9146.239929182,股票：0,股价：169.75,收益：-8.537600708179998% 买入次数：1 卖出次数：1 180.080001831 150.610397339 作业讲解 #强调数据仓库的作用 #DW数据仓库 #DM数据集市 #创建另外一张表，将结果放进去 #tabe为实体，需要及时更新，速度较快，只有管理员可以创建 #create table vifinance_yahoo as #view为虚拟，自动更新，速度较慢 create view vifinance_yahoo as select corp,sum(case when item= &#39;totalliab&#39; then value else 0 end)/sum(case when item= &#39;totalassets&#39; then value else 0 end) as aaa from tfinance_yahoo group by corp #市值调取 select tfinance_yahoo.value,stock_list from tfinance_yahoo left jon stock_list on tfinance_yahoo.corp=jon stock_list.code 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/09/28/96ca7ff7891b436a723da61ee721463d.html" />
<meta property="og:url" content="https://mlh.app/2018/09/28/96ca7ff7891b436a723da61ee721463d.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-28T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"0920MYSQL 选取数据 select item,value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in (&#39;totalassets&#39;,&#39;totalLiab&#39;) 转置 select item case when item=&#39;totalAssets&#39; then vlaue else 0 end, value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in (&#39;totalassets&#39;,&#39;totalLiab&#39;) select item, case when item=&#39;totalAssets&#39; then value else 0 end, case when item = &#39;totalLiab&#39; then value else 0 end, value from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in(&#39;totalassets&#39;,&#39;totalLiab&#39;) select sum(case when item=&#39;totalAssets&#39; then value else 0 end), sum(case when item = &#39;totalLiab&#39; then value else 0 end) from tfinance_yahoo where corp = &#39;AAPL&#39; AND period = &#39;201806&#39; AND item in(&#39;totalassets&#39;,&#39;totalLiab&#39;) 按照公司分组显示 select corp, sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) from tfinance_yahoo where period = &#39;201806&#39; AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;) group by corp 按照资产负债率排序 select corp, sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) from tfinance_yahoo where period = &#39;201806&#39; AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;) group by corp order by sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end) 反向排序 desc select 选取数据条目 from 数据集 where 索引条目 group by 分组 order by 排序，降序 desc 升序 筛选 group by corp having sum(case when item = &#39;totalliab&#39; then value else 0 end)/sum(case when item=&#39;totalassets&#39; then value else 0 end)&gt;0.5 SQL + python与交易系统 wdi数据库调用 select * from wdi_data where country_code = &#39;CHN&#39; 技术分析 select code,sum(close),count(*),sum(close)/count(*) from stock_data group by code 作业 一、阿特曼Z-SCOREs模型SQL实现 #Z = 1.2X1 + 1.4X2 + 3.3X3 + 0.6X4 + 0.99X5 #X1=营运资本／资产总额 #X2=留存收益／资产总额 #X3=息税前利润／资产总额 #X4=股东权益的市场价值总额／负债总额 #X5=销售收入／资产总额 (1) 暂时用所有者权益代替股东权益的市场价值总额 select a.corp,a.x1,a.x2,a.x3,a.x4,a.x5, 1.2*a.x1 + 1.4*a.x2 + 3.3*a.x3 +0.6*a.x4+0.99*a.x5 as z from(select corp, ((sum(case when item = &#39;totalCurrentAssets&#39; then value else 0 end)-sum(case when item = &#39;totalCurrentLiabilities&#39; then value else 0 end))/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x1, (sum(case when item = &#39;retainedearnings&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x2, (sum(case when item = &#39;ebit&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x3, (sum(case when item = &#39;totalstockholderequity&#39; then value else 0 end)/sum(case when item = &#39;totalLiab&#39; then value else 0 end)) as x4, (sum(case when item = &#39;totalRevenue&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x5 from tfinance_yahoo where period = &#39;201806&#39;AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;,&#39;totalRevenue&#39;,&#39;ebit&#39; ,&#39;totalCurrentAssets&#39;,&#39;totalCurrentLiabilities&#39;,&#39;retainedearnings&#39;,&#39;totalstockholderequity&#39;) group by corp )a group by a.corp (2) 尝试引入数据库中最新的股票收盘价来计算股东权益的市场价值总额 select a.corp,a.x1,a.x2,a.x3,b.close*a.commonstocks/a.totalLiab as x4,a.x5, 1.2*a.x1 + 1.4*a.x2 + 3.3*a.x3 +0.6*b.close*a.commonstocks/a.totalLiab+0.99*a.x5 as z from(select corp, ((sum(case when item = &#39;totalCurrentAssets&#39; then value else 0 end)-sum(case when item = &#39;totalCurrentLiabilities&#39; then value else 0 end))/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x1, (sum(case when item = &#39;retainedearnings&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x2, (sum(case when item = &#39;ebit&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x3, (sum(case when item = &#39;totalRevenue&#39; then value else 0 end)/sum(case when item = &#39;totalassets&#39; then value else 0 end)) as x5, sum(case when item = &#39;commonstock&#39; then value else 0 end) as commonstocks, sum(case when item = &#39;totalLiab&#39; then value else 0 end) as totalLiab from tfinance_yahoo where period = &#39;201806&#39;AND item in(&#39;totalAssets&#39;,&#39;totalLiab&#39;,&#39;totalRevenue&#39;,&#39;ebit&#39; ,&#39;totalCurrentAssets&#39;,&#39;totalCurrentLiabilities&#39;,&#39;retainedearnings&#39;,&#39;commonstock&#39;) group by corp )a, (select b_1.close as close from ( select close from stock_data where code = &#39;AAPL&#39; order by time desc )b_1 limit 1 )b 二、海龟交易法则python实现 原理 市场： 海龟们都是期货交易者，海龟们只选择有一定交易量流动性高的市场。这里我选择日指数数据CSI300.INDX，一方面是为了更好与基准比较，另一方面也是因为该标的可以不用担心流动性的问题。 头寸规模： 头寸规模是海龟交易系统最重要的部分之一。 海龟交易法则根据一个市场的绝对波动幅度来调整头寸规模，也就是将头寸的绝对波动幅度进行了标准化。比如，投资标的的价值波动性较强时，可以减少持有量，相反，当它的价值波动性较弱时候，可以增加持有量。总而言之，市场的波动性与头寸规模可以相互抵消。 海龟用一个被称为N的概念来表示某个市场根本的波动性，它表示单个交易日某个特定市场所造成的价格波动的平均范围，它同时也涵盖了开盘价的缺口。其实这个所谓的N，就是我们平常所熟悉的ATR，关于ATR的介绍，可以戳AVERAGE TRUE RANGE. 以下为计算公式： TR=Max(H-L,H-PDC,PDC-L) 其中： TR=真实波幅 H=当日最高价 L=当日最低价 PDC=前一日收盘价 N(即ATR)的计算公式如下(其实就是前面计算所得TR的20日移动平均)： N=(19*PDN+TR)/20 其中： PDN=前一日N值 TR=当日的真实波动幅度 有了N之后，下一步可以计算绝对波动幅度，也就是用根本的市场价格波动性（用N值定义）表示的价值量波动性。 绝对波动幅度=N*合约每一点所代表的价值 最后，海龟按照我们所称的单位（Units）建立头寸。使1N代表帐户净值的1%。 波幅调整后的头寸单位为： 头寸规模单位=账户的1%/市场的绝对波动幅度 可以看出，使用N作为市场波动标准化的度量并以此作为开仓量及持仓量的依据，其背后的资金管理含义是，即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 入市： 海龟的入市规则有两个系统，我们可以根据自己的意愿决定将净值配置在何种系统上。 系统一————以20日突破为基础的偏短线系统 突破定义为超过前20日的最高价或者最低价 海龟总是在日间突破发生时进行交易，而不会等到收盘或次日开盘。 系统二————以55日突破为基础的较简单的长线系统 只要有一个信号显示价格超过了前55日的最高价和最低价就建立头寸。 追踪： 海龟交易系统不是一有突破信号就全仓介入，而是根据最新市场价格变化进行逐步建仓。 海龟在价格突破时只建立一个单位的头寸，在建立头寸后根据前面指令的实际成交价为基础以每突破0.5N的间隔进行加仓。 例如： 黄金：N=2.5 55日突破=310 增加的第一个单位310.00 第二个单位310.00+1/2个2.5即311.25 第三个单位311.25+1/2个2.5即312.50 第四个单位312.50+1/2个2.5即313.75 海龟被告知在接受入市信号时要非常连续，因为一年中的大部分利润可能仅仅来自两三次大赢利。 止损： 对大多数人来说，始终抱着亏损的交易终究会反转的愿望比干脆退出亏损头寸并承认交易失败要容易得多。长期看，不会止损的交易是不会成功的。在你建立头寸之前，你需要预先确定退出的点位。如果市场波动触及你的价位，你就必须每一次毫无例外的退出。在这一立场上摇摆不定最终会导致灾难。(画外音：前段时间大家应该体会比较深刻吧。) 止损标准 海龟以头寸风险为基础设置止损，任何一笔交易不能出现2%以上的风险，因为价格波动1N表示1%的账户净值，容许风险为2%的最大止损就是价格波动2N，为了保证全部头寸的风险最小，如果另外增加了单位，前面单位的止损需提高0.5N。 例如： 原油：N=1.255 日突破=28.30 第一单位 28.30 25.90 离市： 艰难的离市 对于大多数交易员，海龟离市规则是系统法则中唯一最难的部分。等待10或20新低出现通常意味着眼睁睁瞅着20%，40%甚至100%的利润化为泡影。 海龟交易法则对于系统一系统二有着不同的离市标准： 系统一 离市对于多头头寸为10日最低价，对于空头头寸为10日最高价。如果价格波动于头寸背离至10日突破头寸中所有单位都会退出 系统二 离市对于多头头寸为20日最低价，对于空头头寸为20日最高价，如果价格波动与头寸背离至20日突破头寸中所有单位都会退出 海龟入市时一般不会设置离市止损价，但会在日间盯着价格，一旦价格穿过离市突破价，就开始打电话下离市指令。 PYTHON代码 import pandas as pd import pymysql from datetime import datetime from datetime import timedelta #变量数据 cash0 = 10000#资金量 date_1 = &#39;2017-11-01&#39;#初始日期 p_1 = datetime.strptime(date_1,&quot;%Y-%m-%d&quot;) p_2 = p_1 - timedelta(days = 55) p_3 = p_1 - timedelta(days = 20) date_2 = p_2.strftime(&#39;%Y-%m-%d&#39;) date_3 = p_3.strftime(&#39;%Y-%m-%d&#39;) #链接数据库 con = pymysql.connect(host = &#39;47.97.205.89&#39;,port = 3306,user = &#39;#&#39;, passwd = &#39;#&#39;,db = &#39;quantity&#39;,use_unicode = True, charset = &quot;utf8&quot;) cursor = con.cursor() ############################# ########海龟交易法则######### ############################# #回测标的股/股票池 code = &#39;AAPL&#39; #提取前55日均价&amp;提取前20日最低价 df = pd.read_sql(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39;and TradingDay&gt;=&#39;&quot;+date_2+&quot;&#39;and TradingDay&lt;&#39;&quot;+date_1+&quot;&#39;&quot;,con) max_ = df[&#39;close&#39;].max() df = pd.read_sql(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39;and TradingDay&gt;=&#39;&quot;+date_3+&quot;&#39;and TradingDay&lt;&#39;&quot;+date_1+&quot;&#39;&quot;,con) min_ = df[&#39;close&#39;].min() cash = cash0#开仓前资金 stocknum = 0#持股量 buynum = 0 sellnum = 0 remain = 0 cursor.execute(&quot;select close from stock_data where code=&#39;&quot;+code+&quot;&#39; and TradingDay&gt;=&#39;&quot;+date_1+&quot;&#39; order by Time&quot;) for row in cursor.fetchall(): price = row[0] #获取此分钟的收盘价格 #开仓（超过前55日买入）,每次全仓操作 if (price &gt; max_ and stocknum==0) : stocknum = int(cash/price) cash = cash - stocknum*price buynum = buynum + 1 remain = price #离市*低于前20日最低价卖出 elif price &lt; min_ and stocknum!=0: cash = cash + stocknum*price stocknum = 0 sellnum = sellnum + 1 #动态调整最低最高价 if price&gt;max_:max_ = price if price&lt;min_:min_ = price print (&#39;现金：&#39;+str(cash)+&#39;,股票：&#39;+str(stocknum)+&#39;,股价：&#39;+str(remain)+&#39;,收益：&#39;+str(100*((cash+stocknum*remain)-cash0)/cash0)+&#39;%&#39;) print (&#39; 买入次数：&#39;+str(buynum)+&#39; 卖出次数：&#39;+str(sellnum)) print(max_) print(min_) cursor.close() con.close() 现金：9146.239929182,股票：0,股价：169.75,收益：-8.537600708179998% 买入次数：1 卖出次数：1 180.080001831 150.610397339 作业讲解 #强调数据仓库的作用 #DW数据仓库 #DM数据集市 #创建另外一张表，将结果放进去 #tabe为实体，需要及时更新，速度较快，只有管理员可以创建 #create table vifinance_yahoo as #view为虚拟，自动更新，速度较慢 create view vifinance_yahoo as select corp,sum(case when item= &#39;totalliab&#39; then value else 0 end)/sum(case when item= &#39;totalassets&#39; then value else 0 end) as aaa from tfinance_yahoo group by corp #市值调取 select tfinance_yahoo.value,stock_list from tfinance_yahoo left jon stock_list on tfinance_yahoo.corp=jon stock_list.code 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/09/28/96ca7ff7891b436a723da61ee721463d.html","headline":"0920mysql课堂笔记及作业","dateModified":"2018-09-28T00:00:00+08:00","datePublished":"2018-09-28T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/09/28/96ca7ff7891b436a723da61ee721463d.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>0920mysql课堂笔记及作业</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <h1><a id="0920MYSQL_0"></a>0920MYSQL</h1> 
  <h3><a id="_2"></a>选取数据</h3> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> item<span class="token punctuation">,</span><span class="token keyword">value</span>
	<span class="token keyword">from</span> tfinance_yahoo
		<span class="token keyword">where</span> corp <span class="token operator">=</span> <span class="token string">'AAPL'</span> <span class="token operator">AND</span> period <span class="token operator">=</span> <span class="token string">'201806'</span> <span class="token operator">AND</span> item <span class="token operator">in</span>  <span class="token punctuation">(</span><span class="token string">'totalassets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">)</span>
</code></pre> 
  <h3><a id="_9"></a>转置</h3> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> item
 	<span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalAssets'</span> <span class="token keyword">then</span> vlaue <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">,</span>
 	<span class="token keyword">value</span>
	<span class="token keyword">from</span> tfinance_yahoo
		<span class="token keyword">where</span> corp <span class="token operator">=</span> <span class="token string">'AAPL'</span> <span class="token operator">AND</span> period <span class="token operator">=</span> <span class="token string">'201806'</span> <span class="token operator">AND</span> item <span class="token operator">in</span>  <span class="token punctuation">(</span><span class="token string">'totalassets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">)</span>

</code></pre> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> item<span class="token punctuation">,</span>
   <span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalAssets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">,</span>
  <span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalLiab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">,</span>
   <span class="token keyword">value</span>
  <span class="token keyword">from</span> tfinance_yahoo
    <span class="token keyword">where</span> corp <span class="token operator">=</span> <span class="token string">'AAPL'</span> <span class="token operator">AND</span> period <span class="token operator">=</span> <span class="token string">'201806'</span> <span class="token operator">AND</span> item <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'totalassets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">)</span>
</code></pre> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span>
  <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalAssets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalLiab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
  <span class="token keyword">from</span> tfinance_yahoo
    <span class="token keyword">where</span> corp <span class="token operator">=</span> <span class="token string">'AAPL'</span> <span class="token operator">AND</span> period <span class="token operator">=</span> <span class="token string">'201806'</span> <span class="token operator">AND</span> item <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'totalassets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">)</span>
</code></pre> 
  <h3><a id="_34"></a>按照公司分组显示</h3> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> corp<span class="token punctuation">,</span>
   <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalliab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
  <span class="token keyword">from</span> tfinance_yahoo
    <span class="token keyword">where</span> period <span class="token operator">=</span> <span class="token string">'201806'</span> <span class="token operator">AND</span> item <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'totalAssets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">)</span>
  <span class="token keyword">group</span> <span class="token keyword">by</span> corp
</code></pre> 
  <h3><a id="_42"></a>按照资产负债率排序</h3> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> corp<span class="token punctuation">,</span>
   <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalliab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
  <span class="token keyword">from</span> tfinance_yahoo
    <span class="token keyword">where</span> period <span class="token operator">=</span> <span class="token string">'201806'</span> <span class="token operator">AND</span> item <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'totalAssets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">)</span>
  <span class="token keyword">group</span> <span class="token keyword">by</span> corp
    <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalliab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span>
</code></pre> 
  <h3><a id="_51"></a>反向排序</h3> 
  <pre><code class="prism language-sql">	<span class="token keyword">desc</span>
</code></pre> 
  <p>select 选取数据条目<br> from 数据集<br> where 索引条目<br> group by 分组<br> order by 排序，降序<br> desc 升序</p> 
  <h3><a id="_63"></a>筛选</h3> 
  <pre><code class="prism language-sql"><span class="token keyword">group</span> <span class="token keyword">by</span> corp
  
  <span class="token keyword">having</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalliab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span><span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0.5</span>
</code></pre> 
  <p>SQL + python与交易系统</p> 
  <h2><a id="wdi_71"></a>wdi数据库调用</h2> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> wdi_data <span class="token keyword">where</span> country_code <span class="token operator">=</span> <span class="token string">'CHN'</span>
</code></pre> 
  <h2><a id="_76"></a>技术分析</h2> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> code<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">close</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">close</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
  <span class="token keyword">from</span> stock_data
  <span class="token keyword">group</span> <span class="token keyword">by</span> code
</code></pre> 
  <h1><a id="_84"></a>作业</h1> 
  <h2><a id="ZSCOREsSQL_85"></a>一、阿特曼Z-SCOREs模型SQL实现</h2> 
  <pre><code class="prism language-sql"><span class="token comment">#Z = 1.2X1 + 1.4X2 + 3.3X3 + 0.6X4 + 0.99X5</span>
<span class="token comment">#X1=营运资本／资产总额</span>
<span class="token comment">#X2=留存收益／资产总额</span>
<span class="token comment">#X3=息税前利润／资产总额</span>
<span class="token comment">#X4=股东权益的市场价值总额／负债总额</span>
<span class="token comment">#X5=销售收入／资产总额</span>
</code></pre> 
  <h5><a id="1__94"></a>(1) 暂时用所有者权益代替股东权益的市场价值总额</h5> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>corp<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x1<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x2<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x3<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x4<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x5<span class="token punctuation">,</span>
<span class="token number">1.2</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x1 <span class="token operator">+</span> <span class="token number">1.4</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x2 <span class="token operator">+</span> <span class="token number">3.3</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x3 <span class="token operator">+</span><span class="token number">0.6</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x4<span class="token operator">+</span><span class="token number">0.99</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x5 <span class="token keyword">as</span> z 
<span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> corp<span class="token punctuation">,</span>
   <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalCurrentAssets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalCurrentLiabilities'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x1<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'retainedearnings'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x2<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'ebit'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x3<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalstockholderequity'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalLiab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x4<span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalRevenue'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x5
<span class="token keyword">from</span> tfinance_yahoo
<span class="token keyword">where</span> period <span class="token operator">=</span> <span class="token string">'201806'</span><span class="token operator">AND</span> item <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'totalAssets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">,</span><span class="token string">'totalRevenue'</span><span class="token punctuation">,</span><span class="token string">'ebit'</span> <span class="token punctuation">,</span><span class="token string">'totalCurrentAssets'</span><span class="token punctuation">,</span><span class="token string">'totalCurrentLiabilities'</span><span class="token punctuation">,</span><span class="token string">'retainedearnings'</span><span class="token punctuation">,</span><span class="token string">'totalstockholderequity'</span><span class="token punctuation">)</span> 
<span class="token keyword">group</span> <span class="token keyword">by</span> corp
<span class="token punctuation">)</span>a
<span class="token keyword">group</span> <span class="token keyword">by</span> a<span class="token punctuation">.</span>corp 
</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018092510132442?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RmaGJ5MA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="在这里插入图片描述"></p> 
  <h5><a id="2__111"></a>(2) 尝试引入数据库中最新的股票收盘价来计算股东权益的市场价值总额</h5> 
  <pre><code class="prism language-sql"><span class="token keyword">select</span> a<span class="token punctuation">.</span>corp<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x1<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x2<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x3<span class="token punctuation">,</span>b<span class="token punctuation">.</span><span class="token keyword">close</span><span class="token operator">*</span>a<span class="token punctuation">.</span>commonstocks<span class="token operator">/</span>a<span class="token punctuation">.</span>totalLiab <span class="token keyword">as</span> x4<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x5<span class="token punctuation">,</span>
  <span class="token number">1.2</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x1 <span class="token operator">+</span> <span class="token number">1.4</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x2 <span class="token operator">+</span> <span class="token number">3.3</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x3 <span class="token operator">+</span><span class="token number">0.6</span><span class="token operator">*</span>b<span class="token punctuation">.</span><span class="token keyword">close</span><span class="token operator">*</span>a<span class="token punctuation">.</span>commonstocks<span class="token operator">/</span>a<span class="token punctuation">.</span>totalLiab<span class="token operator">+</span><span class="token number">0.99</span><span class="token operator">*</span>a<span class="token punctuation">.</span>x5 <span class="token keyword">as</span> z 
  <span class="token keyword">from</span><span class="token punctuation">(</span><span class="token keyword">select</span> corp<span class="token punctuation">,</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalCurrentAssets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalCurrentLiabilities'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x1<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'retainedearnings'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x2<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'ebit'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x3<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalRevenue'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> x5<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'commonstock'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> commonstocks<span class="token punctuation">,</span>
    <span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item <span class="token operator">=</span> <span class="token string">'totalLiab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> totalLiab
  <span class="token keyword">from</span> tfinance_yahoo
  <span class="token keyword">where</span> period <span class="token operator">=</span> <span class="token string">'201806'</span><span class="token operator">AND</span> item <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'totalAssets'</span><span class="token punctuation">,</span><span class="token string">'totalLiab'</span><span class="token punctuation">,</span><span class="token string">'totalRevenue'</span><span class="token punctuation">,</span><span class="token string">'ebit'</span> <span class="token punctuation">,</span><span class="token string">'totalCurrentAssets'</span><span class="token punctuation">,</span><span class="token string">'totalCurrentLiabilities'</span><span class="token punctuation">,</span><span class="token string">'retainedearnings'</span><span class="token punctuation">,</span><span class="token string">'commonstock'</span><span class="token punctuation">)</span> 
  <span class="token keyword">group</span> <span class="token keyword">by</span> corp
  <span class="token punctuation">)</span>a<span class="token punctuation">,</span>

  <span class="token punctuation">(</span><span class="token keyword">select</span> b_1<span class="token punctuation">.</span><span class="token keyword">close</span> <span class="token keyword">as</span> <span class="token keyword">close</span>
  <span class="token keyword">from</span>
  <span class="token punctuation">(</span>
    <span class="token keyword">select</span> <span class="token keyword">close</span>  
    <span class="token keyword">from</span> stock_data
    <span class="token keyword">where</span> code <span class="token operator">=</span> <span class="token string">'AAPL'</span> 
    <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">time</span>
    <span class="token keyword">desc</span>
  <span class="token punctuation">)</span>b_1 
  <span class="token keyword">limit</span> <span class="token number">1</span>
  <span class="token punctuation">)</span>b
</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180925101247513?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RmaGJ5MA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="在这里插入图片描述"></p> 
  <h2><a id="python_143"></a>二、海龟交易法则python实现</h2> 
  <h3><a id="_144"></a>原理</h3> 
  <h4><a id="_145"></a><strong>市场</strong>：</h4> 
  <p>海龟们都是期货交易者，海龟们只选择有一定交易量流动性高的市场。这里我选择日指数数据CSI300.INDX，一方面是为了更好与基准比较，另一方面也是因为该标的可以不用担心流动性的问题。</p> 
  <h4><a id="_148"></a><strong>头寸规模</strong>：</h4> 
  <p>头寸规模是海龟交易系统最重要的部分之一。</p> 
  <p>海龟交易法则根据一个市场的绝对波动幅度来调整头寸规模，也就是将头寸的绝对波动幅度进行了标准化。比如，投资标的的价值波动性较强时，可以减少持有量，相反，当它的价值波动性较弱时候，可以增加持有量。总而言之，市场的波动性与头寸规模可以相互抵消。</p> 
  <p>海龟用一个被称为N的概念来表示某个市场根本的波动性，它表示单个交易日某个特定市场所造成的价格波动的平均范围，它同时也涵盖了开盘价的缺口。其实这个所谓的N，就是我们平常所熟悉的ATR，关于ATR的介绍，可以戳AVERAGE TRUE RANGE.</p> 
  <p><em>以下为计算公式：</em></p> 
  <blockquote> 
   <p>TR=Max(H-L,H-PDC,PDC-L)<br> 其中：<br> TR=真实波幅<br> H=当日最高价<br> L=当日最低价<br> PDC=前一日收盘价</p> 
  </blockquote> 
  <p><em>N(即ATR)的计算公式如下(其实就是前面计算所得TR的20日移动平均)：</em></p> 
  <blockquote> 
   <p>N=(19*PDN+TR)/20<br> 其中：<br> PDN=前一日N值<br> TR=当日的真实波动幅度</p> 
  </blockquote> 
  <p>有了N之后，下一步可以计算绝对波动幅度，也就是用根本的市场价格波动性（用N值定义）表示的价值量波动性。</p> 
  <p><strong>绝对波动幅度=N*合约每一点所代表的价值</strong></p> 
  <p>最后，海龟按照我们所称的单位（Units）建立头寸。使1N代表帐户净值的1%。 波幅调整后的头寸单位为：</p> 
  <p><strong>头寸规模单位=账户的1%/市场的绝对波动幅度</strong></p> 
  <p>可以看出，使用N作为市场波动标准化的度量并以此作为开仓量及持仓量的依据，其背后的资金管理含义是，即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。 即便当日投资标的跌幅达到N(ATR)的水平，当日的损失都能控制在1%的总资产水平内。</p> 
  <h5><a id="_180"></a>入市：</h5> 
  <p>海龟的入市规则有两个系统，我们可以根据自己的意愿决定将净值配置在何种系统上。</p> 
  <p><em><strong>系统一</strong></em>————以20日突破为基础的偏短线系统</p> 
  <blockquote> 
   <p>突破定义为超过前20日的最高价或者最低价 海龟总是在日间突破发生时进行交易，而不会等到收盘或次日开盘。</p> 
  </blockquote> 
  <p><em><strong>系统二</strong></em>————以55日突破为基础的较简单的长线系统</p> 
  <blockquote> 
   <p>只要有一个信号显示价格超过了前55日的最高价和最低价就建立头寸。</p> 
  </blockquote> 
  <h4><a id="_192"></a>追踪：</h4> 
  <p>海龟交易系统不是一有突破信号就全仓介入，而是根据最新市场价格变化进行逐步建仓。</p> 
  <p>海龟在价格突破时只建立一个单位的头寸，在建立头寸后根据前面指令的实际成交价为基础以每突破0.5N的间隔进行加仓。</p> 
  <p>例如：</p> 
  <p>黄金：N=2.5<br> 55日突破=310<br> 增加的第一个单位310.00<br> 第二个单位310.00+1/2个2.5即311.25<br> 第三个单位311.25+1/2个2.5即312.50<br> 第四个单位312.50+1/2个2.5即313.75</p> 
  <p>海龟被告知在接受入市信号时要非常连续，因为一年中的大部分利润可能仅仅来自两三次大赢利。</p> 
  <h4><a id="_208"></a>止损：</h4> 
  <p>对大多数人来说，始终抱着亏损的交易终究会反转的愿望比干脆退出亏损头寸并承认交易失败要容易得多。长期看，不会止损的交易是不会成功的。在你建立头寸之前，你需要预先确定退出的点位。如果市场波动触及你的价位，你就必须每一次毫无例外的退出。在这一立场上摇摆不定最终会导致灾难。(画外音：前段时间大家应该体会比较深刻吧。)</p> 
  <p><em><strong>止损标准</strong></em></p> 
  <blockquote> 
   <p>海龟以头寸风险为基础设置止损，任何一笔交易不能出现2%以上的风险，因为价格波动1N表示1%的账户净值，容许风险为2%的最大止损就是价格波动2N，为了保证全部头寸的风险最小，如果另外增加了单位，前面单位的止损需提高0.5N。</p> 
  </blockquote> 
  <p>例如：</p> 
  <p>原油：N=1.255 日突破=28.30<br> 第一单位 28.30 25.90</p> 
  <h4><a id="_220"></a>离市：</h4> 
  <p>艰难的离市</p> 
  <p>对于大多数交易员，海龟离市规则是系统法则中唯一最难的部分。等待10或20新低出现通常意味着眼睁睁瞅着20%，40%甚至100%的利润化为泡影。</p> 
  <p>海龟交易法则对于系统一系统二有着不同的离市标准：</p> 
  <p><em><strong>系统一</strong></em></p> 
  <blockquote> 
   <p>离市对于多头头寸为10日最低价，对于空头头寸为10日最高价。如果价格波动于头寸背离至10日突破头寸中所有单位都会退出</p> 
  </blockquote> 
  <p><em><strong>系统二</strong></em></p> 
  <blockquote> 
   <p>离市对于多头头寸为20日最低价，对于空头头寸为20日最高价，如果价格波动与头寸背离至20日突破头寸中所有单位都会退出</p> 
  </blockquote> 
  <p>海龟入市时一般不会设置离市止损价，但会在日间盯着价格，一旦价格穿过离市突破价，就开始打电话下离市指令。</p> 
  <p>PYTHON代码</p> 
  <pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> pymysql

<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> timedelta

<span class="token comment">#变量数据</span>
cash0 <span class="token operator">=</span> <span class="token number">10000</span><span class="token comment">#资金量</span>


date_1 <span class="token operator">=</span> <span class="token string">'2017-11-01'</span><span class="token comment">#初始日期</span>
p_1 <span class="token operator">=</span> datetime<span class="token punctuation">.</span>strptime<span class="token punctuation">(</span>date_1<span class="token punctuation">,</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>
p_2 <span class="token operator">=</span> p_1 <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days <span class="token operator">=</span> <span class="token number">55</span><span class="token punctuation">)</span>
p_3 <span class="token operator">=</span> p_1 <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">)</span>
date_2 <span class="token operator">=</span> p_2<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span>
date_3 <span class="token operator">=</span> p_3<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d'</span><span class="token punctuation">)</span>  

<span class="token comment">#链接数据库</span>
con <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host <span class="token operator">=</span> <span class="token string">'47.97.205.89'</span><span class="token punctuation">,</span>port <span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">,</span>user <span class="token operator">=</span> <span class="token string">'#'</span><span class="token punctuation">,</span> passwd <span class="token operator">=</span> <span class="token string">'#'</span><span class="token punctuation">,</span>db <span class="token operator">=</span> <span class="token string">'quantity'</span><span class="token punctuation">,</span>use_unicode <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> charset <span class="token operator">=</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span>
cursor <span class="token operator">=</span> con<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#############################</span>
<span class="token comment">########海龟交易法则#########</span>
<span class="token comment">#############################</span>


<span class="token comment">#回测标的股/股票池</span>
code <span class="token operator">=</span> <span class="token string">'AAPL'</span>

<span class="token comment">#提取前55日均价&amp;提取前20日最低价</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span><span class="token string">"select close from stock_data where code='"</span><span class="token operator">+</span>code<span class="token operator">+</span><span class="token string">"'and TradingDay&gt;='"</span><span class="token operator">+</span>date_2<span class="token operator">+</span><span class="token string">"'and TradingDay&lt;'"</span><span class="token operator">+</span>date_1<span class="token operator">+</span><span class="token string">"'"</span><span class="token punctuation">,</span>con<span class="token punctuation">)</span>
max_ <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span><span class="token string">"select close from stock_data where code='"</span><span class="token operator">+</span>code<span class="token operator">+</span><span class="token string">"'and TradingDay&gt;='"</span><span class="token operator">+</span>date_3<span class="token operator">+</span><span class="token string">"'and TradingDay&lt;'"</span><span class="token operator">+</span>date_1<span class="token operator">+</span><span class="token string">"'"</span><span class="token punctuation">,</span>con<span class="token punctuation">)</span>
min_ <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


cash <span class="token operator">=</span> cash0<span class="token comment">#开仓前资金</span>
stocknum <span class="token operator">=</span> <span class="token number">0</span><span class="token comment">#持股量</span>
buynum <span class="token operator">=</span> <span class="token number">0</span>
sellnum <span class="token operator">=</span> <span class="token number">0</span>
remain <span class="token operator">=</span> <span class="token number">0</span>

cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"select close from stock_data where code='"</span><span class="token operator">+</span>code<span class="token operator">+</span><span class="token string">"' and TradingDay&gt;='"</span><span class="token operator">+</span>date_1<span class="token operator">+</span><span class="token string">"' order by Time"</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> row <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        price <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">#获取此分钟的收盘价格</span>
        
        <span class="token comment">#开仓（超过前55日买入）,每次全仓操作</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>price <span class="token operator">&gt;</span> max_ <span class="token operator">and</span> stocknum<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
            stocknum <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cash<span class="token operator">/</span>price<span class="token punctuation">)</span>
            cash <span class="token operator">=</span> cash <span class="token operator">-</span> stocknum<span class="token operator">*</span>price
            buynum <span class="token operator">=</span> buynum <span class="token operator">+</span> <span class="token number">1</span>
            remain <span class="token operator">=</span> price

        
        <span class="token comment">#离市*低于前20日最低价卖出</span>
        <span class="token keyword">elif</span> price <span class="token operator">&lt;</span> min_ <span class="token operator">and</span> stocknum<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
            cash <span class="token operator">=</span> cash <span class="token operator">+</span> stocknum<span class="token operator">*</span>price
            stocknum <span class="token operator">=</span> <span class="token number">0</span>
            sellnum <span class="token operator">=</span> sellnum <span class="token operator">+</span> <span class="token number">1</span>
            
        <span class="token comment">#动态调整最低最高价 </span>
        <span class="token keyword">if</span> price<span class="token operator">&gt;</span>max_<span class="token punctuation">:</span>max_ <span class="token operator">=</span> price 
        <span class="token keyword">if</span> price<span class="token operator">&lt;</span>min_<span class="token punctuation">:</span>min_ <span class="token operator">=</span> price
            
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'现金：'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>cash<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">',股票：'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>stocknum<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">',股价：'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>remain<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">',收益：'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cash<span class="token operator">+</span>stocknum<span class="token operator">*</span>remain<span class="token punctuation">)</span><span class="token operator">-</span>cash0<span class="token punctuation">)</span><span class="token operator">/</span>cash0<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'%'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">' 买入次数：'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>buynum<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">' 卖出次数：'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>sellnum<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>max_<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>min_<span class="token punctuation">)</span>
cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
con<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>   
</code></pre> 
  <pre><code>现金：9146.239929182,股票：0,股价：169.75,收益：-8.537600708179998%
 买入次数：1 卖出次数：1
180.080001831
150.610397339
</code></pre> 
  <h3><a id="_318"></a>作业讲解</h3> 
  <pre><code class="prism language-sql"><span class="token comment">#强调数据仓库的作用</span>
<span class="token comment">#DW数据仓库</span>
<span class="token comment">#DM数据集市</span>

<span class="token comment">#创建另外一张表，将结果放进去</span>
<span class="token comment">#tabe为实体，需要及时更新，速度较快，只有管理员可以创建</span>
<span class="token comment">#create table vifinance_yahoo as</span>
<span class="token comment">#view为虚拟，自动更新，速度较慢</span>
<span class="token keyword">create</span> <span class="token keyword">view</span> vifinance_yahoo <span class="token keyword">as</span>
<span class="token keyword">select</span> corp<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span> <span class="token string">'totalliab'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token keyword">case</span> <span class="token keyword">when</span> item<span class="token operator">=</span> <span class="token string">'totalassets'</span> <span class="token keyword">then</span> <span class="token keyword">value</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> aaa 
  <span class="token keyword">from</span> tfinance_yahoo
  <span class="token keyword">group</span> <span class="token keyword">by</span> corp

<span class="token comment">#市值调取</span>
<span class="token keyword">select</span> tfinance_yahoo<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">,</span>stock_list <span class="token keyword">from</span> tfinance_yahoo <span class="token keyword">left</span> jon stock_list <span class="token keyword">on</span> 
tfinance_yahoo<span class="token punctuation">.</span>corp<span class="token operator">=</span>jon stock_list<span class="token punctuation">.</span>code
</code></pre> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-778f64ae39.css" rel="stylesheet"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/dfhby0/article/details/82786101,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/dfhby0/article/details/82786101,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
