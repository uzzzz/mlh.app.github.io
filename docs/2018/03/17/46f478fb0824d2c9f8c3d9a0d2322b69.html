<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>粗略分析hyperledger-fabric之e2e_cli是如何开启网络 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="粗略分析hyperledger-fabric之e2e_cli是如何开启网络" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="一、sudo ./network_setup.sh up 这条命令是如何为我们开启网络？通过几天的查看，我大致理清了他的顺序。在这里分享出来，如有不对，还望指出。 我们还是先看看这个shell文本里的内容： #!/bin/bash # # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # UP_DOWN=&quot;$1&quot; CH_NAME=&quot;$2&quot; CLI_TIMEOUT=&quot;$3&quot; IF_COUCHDB=&quot;$4&quot; : ${CLI_TIMEOUT:=&quot;10000&quot;} COMPOSE_FILE=docker-compose-cli.yaml COMPOSE_FILE_COUCH=docker-compose-couch.yaml #COMPOSE_FILE=docker-compose-e2e.yaml function printHelp () { echo &quot;Usage: ./network_setup &lt;up|down&gt; &lt;\$channel-name&gt; &lt;\$cli_timeout&gt; &lt;couchdb&gt;.\nThe arguments must be in order.&quot; } function validateArgs () { if [ -z &quot;${UP_DOWN}&quot; ]; then echo &quot;Option up / down / restart not mentioned&quot; printHelp exit 1 fi if [ -z &quot;${CH_NAME}&quot; ]; then echo &quot;setting to default channel &#39;mychannel&#39;&quot; CH_NAME=mychannel fi } function clearContainers () { CONTAINER_IDS=$(docker ps -aq) if [ -z &quot;$CONTAINER_IDS&quot; -o &quot;$CONTAINER_IDS&quot; = &quot; &quot; ]; then echo &quot;---- No containers available for deletion ----&quot; else docker rm -f $CONTAINER_IDS fi } function removeUnwantedImages() { DOCKER_IMAGE_IDS=$(docker images | grep &quot;dev\|none\|test-vp\|peer[0-9]-&quot; | awk &#39;{print $3}&#39;) if [ -z &quot;$DOCKER_IMAGE_IDS&quot; -o &quot;$DOCKER_IMAGE_IDS&quot; = &quot; &quot; ]; then echo &quot;---- No images available for deletion ----&quot; else docker rmi -f $DOCKER_IMAGE_IDS fi } function networkUp () { if [ -f &quot;./crypto-config&quot; ]; then echo &quot;crypto-config directory already exists.&quot; else #Generate all the artifacts that includes org certs, orderer genesis block, # channel configuration transaction source generateArtifacts.sh $CH_NAME fi if [ &quot;${IF_COUCHDB}&quot; == &quot;couchdb&quot; ]; then CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE -f $COMPOSE_FILE_COUCH up -d 2&gt;&amp;1 else CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE up -d 2&gt;&amp;1 fi if [ $? -ne 0 ]; then echo &quot;ERROR !!!! Unable to pull the images &quot; exit 1 fi docker logs -f cli } function networkDown () { docker-compose -f $COMPOSE_FILE down #Cleanup the chaincode containers clearContainers #Cleanup images removeUnwantedImages # remove orderer block and other channel configuration transactions and certs rm -rf channel-artifacts/*.block channel-artifacts/*.tx crypto-config } validateArgs #Create the network using docker compose if [ &quot;${UP_DOWN}&quot; == &quot;up&quot; ]; then networkUp elif [ &quot;${UP_DOWN}&quot; == &quot;down&quot; ]; then ## Clear the network networkDown elif [ &quot;${UP_DOWN}&quot; == &quot;restart&quot; ]; then ## Restart the network networkDown networkUp else printHelp exit 1 fi 阅读这个shell需要一些基础，我也是刚看完shell的一些基本语法才勉强理解，下面我用一张图表示他的启动顺序。 那么这里面最关键的地方有那些呢？首先这条语句： source generateArtifacts.sh $CH_NAME 无形之间将我们带到了另一个shell文本，那就是同目录下的generateArtifacts.sh，下面我们接着往下看。 #!/bin/bash +x # # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # #set -e CHANNEL_NAME=$1 : ${CHANNEL_NAME:=&quot;mychannel&quot;} echo $CHANNEL_NAME export FABRIC_ROOT=$PWD/../.. export FABRIC_CFG_PATH=$PWD echo OS_ARCH=$(echo &quot;$(uname -s|tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;|sed &#39;s/mingw64_nt.*/windows/&#39;)-$(uname -m | sed &#39;s/x86_64/amd64/g&#39;)&quot; | awk &#39;{print tolower($0)}&#39;) ## Using docker-compose template replace private key file names with constants function replacePrivateKey () { ARCH=`uname -s | grep Darwin` if [ &quot;$ARCH&quot; == &quot;Darwin&quot; ]; then OPTS=&quot;-it&quot; else OPTS=&quot;-i&quot; fi cp docker-compose-e2e-template.yaml docker-compose-e2e.yaml CURRENT_DIR=$PWD cd crypto-config/peerOrganizations/org1.example.com/ca/ PRIV_KEY=$(ls *_sk) cd $CURRENT_DIR sed $OPTS &quot;s/CA1_PRIVATE_KEY/${PRIV_KEY}/g&quot; docker-compose-e2e.yaml cd crypto-config/peerOrganizations/org2.example.com/ca/ PRIV_KEY=$(ls *_sk) cd $CURRENT_DIR sed $OPTS &quot;s/CA2_PRIVATE_KEY/${PRIV_KEY}/g&quot; docker-compose-e2e.yaml } ## Generates Org certs using cryptogen tool function generateCerts (){ CRYPTOGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/cryptogen if [ -f &quot;$CRYPTOGEN&quot; ]; then echo &quot;Using cryptogen -&gt; $CRYPTOGEN&quot; else echo &quot;Building cryptogen&quot; make -C $FABRIC_ROOT release fi echo echo &quot;##########################################################&quot; echo &quot;##### Generate certificates using cryptogen tool #########&quot; echo &quot;##########################################################&quot; $CRYPTOGEN generate --config=./crypto-config.yaml echo } ## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions function generateChannelArtifacts() { CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen if [ -f &quot;$CONFIGTXGEN&quot; ]; then echo &quot;Using configtxgen -&gt; $CONFIGTXGEN&quot; else echo &quot;Building configtxgen&quot; make -C $FABRIC_ROOT release fi echo &quot;##########################################################&quot; echo &quot;######### Generating Orderer Genesis block ##############&quot; echo &quot;##########################################################&quot; # Note: For some unknown reason (at least for now) the block file can&#39;t be # named orderer.genesis.block or the orderer will fail to launch! $CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block echo echo &quot;#################################################################&quot; echo &quot;### Generating channel configuration transaction &#39;channel.tx&#39; ###&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org1MSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org1MSP echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org2MSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org2MSP echo } generateCerts replacePrivateKey generateChannelArtifacts 此文件主要是用来生成主要的配置文件如私钥和证书，有通道证书之类的。下面这张图是它执行的顺序。 其次语句： CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE up -d 2&gt;&amp;1 其实就是：docker-compose -f docker-compose-cli.yaml up是不是感觉很熟悉呢？接下来我们接着看docker-compose-cli.yaml文件。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: orderer.example.com: extends: file: base/docker-compose-base.yaml service: orderer.example.com container_name: orderer.example.com peer0.org1.example.com: container_name: peer0.org1.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org1.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org1.example.com peer1.org1.example.com: container_name: peer1.org1.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org1.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org1.example.com peer0.org2.example.com: container_name: peer0.org2.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org2.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org2.example.com peer1.org2.example.com: container_name: peer1.org2.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org2.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org2.example.com cli: container_name: cli image: hyperledger/fabric-tools tty: true environment: - GOPATH=/opt/gopath - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_ID=cli - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP - CORE_PEER_TLS_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39; volumes: - /var/run/:/host/var/run/ - ../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts depends_on: - orderer.example.com - peer0.org1.example.com - peer1.org1.example.com - peer0.org2.example.com - peer1.org2.example.com 这个文件的作用就是启动一系列的容器，当你看到下面内容的时候，就是此配置文件的作用： Creating peer1.org2.example.com ... done Creating cli ... done Creating orderer.example.com ... Creating peer0.org2.example.com ... Creating peer1.org1.example.com ... Creating peer0.org1.example.com ... Creating cli ... 这个配置文件中还有一个地方需要我们关注，那就是：base/docker-compose-base.yaml，我们接着看看当前目录下的base文件夹里的docker-compose-base.yaml文件。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: orderer.example.com: container_name: orderer.example.com image: hyperledger/fabric-orderer environment: - ORDERER_GENERAL_LOGLEVEL=debug - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp # enabled TLS - ORDERER_GENERAL_TLS_ENABLED=true - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt] working_dir: /opt/gopath/src/github.com/hyperledger/fabric command: orderer volumes: - ../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls ports: - 7050:7050 peer0.org1.example.com: container_name: peer0.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org1.example.com - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer0.org1.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 7051:7051 - 7052:7052 - 7053:7053 peer1.org1.example.com: container_name: peer1.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer1.org1.example.com - CORE_PEER_ADDRESS=peer1.org1.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org1.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051 - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 8051:7051 - 8052:7052 - 8053:7053 peer0.org2.example.com: container_name: peer0.org2.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org2.example.com - CORE_PEER_ADDRESS=peer0.org2.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer0.org2.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org2.example.com:7051 - CORE_PEER_LOCALMSPID=Org2MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls:/etc/hyperledger/fabric/tls ports: - 9051:7051 - 9052:7052 - 9053:7053 peer1.org2.example.com: container_name: peer1.org2.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer1.org2.example.com - CORE_PEER_ADDRESS=peer1.org2.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org2.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org2.example.com:7051 - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org2.example.com:7051 - CORE_PEER_LOCALMSPID=Org2MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls:/etc/hyperledger/fabric/tls ports: - 10051:7051 - 10052:7052 - 10053:7053 这个配置文件就比较明显了，Orderer和peer的配置文件，细心的你肯定也发现了file: peer-base.yaml，那就看看同目录下的peer-base.yaml文件吧。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: peer-base: image: hyperledger/fabric-peer environment: - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock # the following setting starts chaincode containers on the same # bridge network as the peers # https://docs.docker.com/compose/networking/ - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli_default #- CORE_LOGGING_LEVEL=ERROR - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_TLS_ENABLED=true - CORE_PEER_GOSSIP_USELEADERELECTION=true - CORE_PEER_GOSSIP_ORGLEADER=false - CORE_PEER_PROFILE_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: peer node start 这我就不多解释了。 最后还有一个文件，在刚才的docker-compose-cli.yaml文件中有一句`command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39;什么意思呢？就是./scripts/script.sh这个shell脚本生效，一起去看看吧。 #!/bin/bash # Copyright London Stock Exchange Group All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # echo echo &quot; ____ _____ _ ____ _____ _____ ____ _____ &quot; echo &quot;/ ___| |_ _| / \ | _ \ |_ _| | ____| |___ \ | ____|&quot; echo &quot;\___ \ | | / _ \ | |_) | | | _____ | _| __) | | _| &quot; echo &quot; ___) | | | / ___ \ | _ &lt; | | |_____| | |___ / __/ | |___ &quot; echo &quot;|____/ |_| /_/ \_\ |_| \_\ |_| |_____| |_____| |_____|&quot; echo CHANNEL_NAME=&quot;$1&quot; : ${CHANNEL_NAME:=&quot;mychannel&quot;} : ${TIMEOUT:=&quot;60&quot;} COUNTER=1 MAX_RETRY=5 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem echo &quot;Channel name : &quot;$CHANNEL_NAME verifyResult () { if [ $1 -ne 0 ] ; then echo &quot;!!!!!!!!!!!!!!! &quot;$2&quot; !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } setGlobals () { if [ $1 -eq 0 -o $1 -eq 1 ] ; then CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp if [ $1 -eq 0 ]; then CORE_PEER_ADDRESS=peer0.org1.example.com:7051 else CORE_PEER_ADDRESS=peer1.org1.example.com:7051 fi else CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp if [ $1 -eq 2 ]; then CORE_PEER_ADDRESS=peer0.org2.example.com:7051 else CORE_PEER_ADDRESS=peer1.org2.example.com:7051 fi fi env |grep CORE } createChannel() { setGlobals 0 if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt else peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Channel creation failed&quot; echo &quot;===================== Channel \&quot;$CHANNEL_NAME\&quot; is created successfully ===================== &quot; echo } updateAnchorPeers() { PEER=$1 setGlobals $PEER if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt else peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Anchor peer update failed&quot; echo &quot;===================== Anchor peers for org \&quot;$CORE_PEER_LOCALMSPID\&quot; on \&quot;$CHANNEL_NAME\&quot; is updated successfully ===================== &quot; sleep 5 echo } ## Sometimes Join takes time hence RETRY atleast for 5 times joinWithRetry () { peer channel join -b $CHANNEL_NAME.block &gt;&amp;log.txt res=$? cat log.txt if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then COUNTER=` expr $COUNTER + 1` echo &quot;PEER$1 failed to join the channel, Retry after 2 seconds&quot; sleep 2 joinWithRetry $1 else COUNTER=1 fi verifyResult $res &quot;After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel&quot; } joinChannel () { for ch in 0 1 2 3; do setGlobals $ch joinWithRetry $ch echo &quot;===================== PEER$ch joined on the channel \&quot;$CHANNEL_NAME\&quot; ===================== &quot; sleep 2 echo done } installChaincode () { PEER=$1 setGlobals $PEER peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt res=$? cat log.txt verifyResult $res &quot;Chaincode installation on remote peer PEER$PEER has Failed&quot; echo &quot;===================== Chaincode is installed on remote peer PEER$PEER ===================== &quot; echo } instantiateChaincode () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &gt;&amp;log.txt else peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Chaincode instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; failed&quot; echo &quot;===================== Chaincode Instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } chaincodeQuery () { PEER=$1 echo &quot;===================== Querying on PEER$PEER on channel &#39;$CHANNEL_NAME&#39;... ===================== &quot; setGlobals $PEER local rc=1 local starttime=$(date +%s) # continue to poll # we either get a successful response, or reach TIMEOUT while test &quot;$(($(date +%s)-starttime))&quot; -lt &quot;$TIMEOUT&quot; -a $rc -ne 0 do sleep 3 echo &quot;Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs&quot; peer chaincode query -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &gt;&amp;log.txt test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk &#39;/Query Result/ {print $NF}&#39;) test &quot;$VALUE&quot; = &quot;$2&quot; &amp;&amp; let rc=0 done echo cat log.txt if test $rc -eq 0 ; then echo &quot;===================== Query on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; else echo &quot;!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } chaincodeInvoke () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode invoke -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt else peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Invoke execution on PEER$PEER failed &quot; echo &quot;===================== Invoke transaction on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } ## Create channel echo &quot;Creating channel...&quot; createChannel ## Join all the peers to the channel echo &quot;Having all peers join the channel...&quot; joinChannel ## Set the anchor peers for each org in the channel echo &quot;Updating anchor peers for org1...&quot; updateAnchorPeers 0 echo &quot;Updating anchor peers for org2...&quot; updateAnchorPeers 2 ## Install chaincode on Peer0/Org1 and Peer2/Org2 echo &quot;Installing chaincode on org1/peer0...&quot; installChaincode 0 echo &quot;Install chaincode on org2/peer2...&quot; installChaincode 2 #Instantiate chaincode on Peer2/Org2 echo &quot;Instantiating chaincode on org2/peer2...&quot; instantiateChaincode 2 #Query on chaincode on Peer0/Org1 echo &quot;Querying chaincode on org1/peer0...&quot; chaincodeQuery 0 100 #Invoke on chaincode on Peer0/Org1 echo &quot;Sending invoke transaction on org1/peer0...&quot; chaincodeInvoke 0 ## Install chaincode on Peer3/Org2 echo &quot;Installing chaincode on org2/peer3...&quot; installChaincode 3 #Query on chaincode on Peer3/Org2, check if the result is 90 echo &quot;Querying chaincode on org2/peer3...&quot; chaincodeQuery 3 90 echo echo &quot;===================== All GOOD, End-2-End execution completed ===================== &quot; echo echo echo &quot; _____ _ _ ____ _____ ____ _____ &quot; echo &quot;| ____| | \ | | | _ \ | ____| |___ \ | ____|&quot; echo &quot;| _| | \| | | | | | _____ | _| __) | | _| &quot; echo &quot;| |___ | |\ | | |_| | |_____| | |___ / __/ | |___ &quot; echo &quot;|_____| |_| \_| |____/ |_____| |_____| |_____|&quot; echo exit 0 我觉得终于到了你最希望看得的地方了，对于初学者而言的我们，看到good的时候就会心情很好，对吧？前面都为我们准备好了各节点，创世块，证书等内容！在这里这个文件为我们创建通道并且让各peer节点加入通道，安装、初始化、query准备好的chaincode！下图就是大致过程。 文件夹下还有许多的其他配置文件，其中如图。 下面用一张图总结一下： 大致过程基本如上，但感觉还差了一点什么！批评指正，批评指正！ 阅读更多" />
<meta property="og:description" content="一、sudo ./network_setup.sh up 这条命令是如何为我们开启网络？通过几天的查看，我大致理清了他的顺序。在这里分享出来，如有不对，还望指出。 我们还是先看看这个shell文本里的内容： #!/bin/bash # # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # UP_DOWN=&quot;$1&quot; CH_NAME=&quot;$2&quot; CLI_TIMEOUT=&quot;$3&quot; IF_COUCHDB=&quot;$4&quot; : ${CLI_TIMEOUT:=&quot;10000&quot;} COMPOSE_FILE=docker-compose-cli.yaml COMPOSE_FILE_COUCH=docker-compose-couch.yaml #COMPOSE_FILE=docker-compose-e2e.yaml function printHelp () { echo &quot;Usage: ./network_setup &lt;up|down&gt; &lt;\$channel-name&gt; &lt;\$cli_timeout&gt; &lt;couchdb&gt;.\nThe arguments must be in order.&quot; } function validateArgs () { if [ -z &quot;${UP_DOWN}&quot; ]; then echo &quot;Option up / down / restart not mentioned&quot; printHelp exit 1 fi if [ -z &quot;${CH_NAME}&quot; ]; then echo &quot;setting to default channel &#39;mychannel&#39;&quot; CH_NAME=mychannel fi } function clearContainers () { CONTAINER_IDS=$(docker ps -aq) if [ -z &quot;$CONTAINER_IDS&quot; -o &quot;$CONTAINER_IDS&quot; = &quot; &quot; ]; then echo &quot;---- No containers available for deletion ----&quot; else docker rm -f $CONTAINER_IDS fi } function removeUnwantedImages() { DOCKER_IMAGE_IDS=$(docker images | grep &quot;dev\|none\|test-vp\|peer[0-9]-&quot; | awk &#39;{print $3}&#39;) if [ -z &quot;$DOCKER_IMAGE_IDS&quot; -o &quot;$DOCKER_IMAGE_IDS&quot; = &quot; &quot; ]; then echo &quot;---- No images available for deletion ----&quot; else docker rmi -f $DOCKER_IMAGE_IDS fi } function networkUp () { if [ -f &quot;./crypto-config&quot; ]; then echo &quot;crypto-config directory already exists.&quot; else #Generate all the artifacts that includes org certs, orderer genesis block, # channel configuration transaction source generateArtifacts.sh $CH_NAME fi if [ &quot;${IF_COUCHDB}&quot; == &quot;couchdb&quot; ]; then CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE -f $COMPOSE_FILE_COUCH up -d 2&gt;&amp;1 else CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE up -d 2&gt;&amp;1 fi if [ $? -ne 0 ]; then echo &quot;ERROR !!!! Unable to pull the images &quot; exit 1 fi docker logs -f cli } function networkDown () { docker-compose -f $COMPOSE_FILE down #Cleanup the chaincode containers clearContainers #Cleanup images removeUnwantedImages # remove orderer block and other channel configuration transactions and certs rm -rf channel-artifacts/*.block channel-artifacts/*.tx crypto-config } validateArgs #Create the network using docker compose if [ &quot;${UP_DOWN}&quot; == &quot;up&quot; ]; then networkUp elif [ &quot;${UP_DOWN}&quot; == &quot;down&quot; ]; then ## Clear the network networkDown elif [ &quot;${UP_DOWN}&quot; == &quot;restart&quot; ]; then ## Restart the network networkDown networkUp else printHelp exit 1 fi 阅读这个shell需要一些基础，我也是刚看完shell的一些基本语法才勉强理解，下面我用一张图表示他的启动顺序。 那么这里面最关键的地方有那些呢？首先这条语句： source generateArtifacts.sh $CH_NAME 无形之间将我们带到了另一个shell文本，那就是同目录下的generateArtifacts.sh，下面我们接着往下看。 #!/bin/bash +x # # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # #set -e CHANNEL_NAME=$1 : ${CHANNEL_NAME:=&quot;mychannel&quot;} echo $CHANNEL_NAME export FABRIC_ROOT=$PWD/../.. export FABRIC_CFG_PATH=$PWD echo OS_ARCH=$(echo &quot;$(uname -s|tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;|sed &#39;s/mingw64_nt.*/windows/&#39;)-$(uname -m | sed &#39;s/x86_64/amd64/g&#39;)&quot; | awk &#39;{print tolower($0)}&#39;) ## Using docker-compose template replace private key file names with constants function replacePrivateKey () { ARCH=`uname -s | grep Darwin` if [ &quot;$ARCH&quot; == &quot;Darwin&quot; ]; then OPTS=&quot;-it&quot; else OPTS=&quot;-i&quot; fi cp docker-compose-e2e-template.yaml docker-compose-e2e.yaml CURRENT_DIR=$PWD cd crypto-config/peerOrganizations/org1.example.com/ca/ PRIV_KEY=$(ls *_sk) cd $CURRENT_DIR sed $OPTS &quot;s/CA1_PRIVATE_KEY/${PRIV_KEY}/g&quot; docker-compose-e2e.yaml cd crypto-config/peerOrganizations/org2.example.com/ca/ PRIV_KEY=$(ls *_sk) cd $CURRENT_DIR sed $OPTS &quot;s/CA2_PRIVATE_KEY/${PRIV_KEY}/g&quot; docker-compose-e2e.yaml } ## Generates Org certs using cryptogen tool function generateCerts (){ CRYPTOGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/cryptogen if [ -f &quot;$CRYPTOGEN&quot; ]; then echo &quot;Using cryptogen -&gt; $CRYPTOGEN&quot; else echo &quot;Building cryptogen&quot; make -C $FABRIC_ROOT release fi echo echo &quot;##########################################################&quot; echo &quot;##### Generate certificates using cryptogen tool #########&quot; echo &quot;##########################################################&quot; $CRYPTOGEN generate --config=./crypto-config.yaml echo } ## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions function generateChannelArtifacts() { CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen if [ -f &quot;$CONFIGTXGEN&quot; ]; then echo &quot;Using configtxgen -&gt; $CONFIGTXGEN&quot; else echo &quot;Building configtxgen&quot; make -C $FABRIC_ROOT release fi echo &quot;##########################################################&quot; echo &quot;######### Generating Orderer Genesis block ##############&quot; echo &quot;##########################################################&quot; # Note: For some unknown reason (at least for now) the block file can&#39;t be # named orderer.genesis.block or the orderer will fail to launch! $CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block echo echo &quot;#################################################################&quot; echo &quot;### Generating channel configuration transaction &#39;channel.tx&#39; ###&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org1MSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org1MSP echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org2MSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org2MSP echo } generateCerts replacePrivateKey generateChannelArtifacts 此文件主要是用来生成主要的配置文件如私钥和证书，有通道证书之类的。下面这张图是它执行的顺序。 其次语句： CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE up -d 2&gt;&amp;1 其实就是：docker-compose -f docker-compose-cli.yaml up是不是感觉很熟悉呢？接下来我们接着看docker-compose-cli.yaml文件。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: orderer.example.com: extends: file: base/docker-compose-base.yaml service: orderer.example.com container_name: orderer.example.com peer0.org1.example.com: container_name: peer0.org1.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org1.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org1.example.com peer1.org1.example.com: container_name: peer1.org1.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org1.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org1.example.com peer0.org2.example.com: container_name: peer0.org2.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org2.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org2.example.com peer1.org2.example.com: container_name: peer1.org2.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org2.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org2.example.com cli: container_name: cli image: hyperledger/fabric-tools tty: true environment: - GOPATH=/opt/gopath - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_ID=cli - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP - CORE_PEER_TLS_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39; volumes: - /var/run/:/host/var/run/ - ../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts depends_on: - orderer.example.com - peer0.org1.example.com - peer1.org1.example.com - peer0.org2.example.com - peer1.org2.example.com 这个文件的作用就是启动一系列的容器，当你看到下面内容的时候，就是此配置文件的作用： Creating peer1.org2.example.com ... done Creating cli ... done Creating orderer.example.com ... Creating peer0.org2.example.com ... Creating peer1.org1.example.com ... Creating peer0.org1.example.com ... Creating cli ... 这个配置文件中还有一个地方需要我们关注，那就是：base/docker-compose-base.yaml，我们接着看看当前目录下的base文件夹里的docker-compose-base.yaml文件。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: orderer.example.com: container_name: orderer.example.com image: hyperledger/fabric-orderer environment: - ORDERER_GENERAL_LOGLEVEL=debug - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp # enabled TLS - ORDERER_GENERAL_TLS_ENABLED=true - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt] working_dir: /opt/gopath/src/github.com/hyperledger/fabric command: orderer volumes: - ../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls ports: - 7050:7050 peer0.org1.example.com: container_name: peer0.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org1.example.com - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer0.org1.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 7051:7051 - 7052:7052 - 7053:7053 peer1.org1.example.com: container_name: peer1.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer1.org1.example.com - CORE_PEER_ADDRESS=peer1.org1.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org1.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051 - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 8051:7051 - 8052:7052 - 8053:7053 peer0.org2.example.com: container_name: peer0.org2.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org2.example.com - CORE_PEER_ADDRESS=peer0.org2.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer0.org2.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org2.example.com:7051 - CORE_PEER_LOCALMSPID=Org2MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls:/etc/hyperledger/fabric/tls ports: - 9051:7051 - 9052:7052 - 9053:7053 peer1.org2.example.com: container_name: peer1.org2.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer1.org2.example.com - CORE_PEER_ADDRESS=peer1.org2.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org2.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org2.example.com:7051 - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org2.example.com:7051 - CORE_PEER_LOCALMSPID=Org2MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls:/etc/hyperledger/fabric/tls ports: - 10051:7051 - 10052:7052 - 10053:7053 这个配置文件就比较明显了，Orderer和peer的配置文件，细心的你肯定也发现了file: peer-base.yaml，那就看看同目录下的peer-base.yaml文件吧。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: peer-base: image: hyperledger/fabric-peer environment: - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock # the following setting starts chaincode containers on the same # bridge network as the peers # https://docs.docker.com/compose/networking/ - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli_default #- CORE_LOGGING_LEVEL=ERROR - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_TLS_ENABLED=true - CORE_PEER_GOSSIP_USELEADERELECTION=true - CORE_PEER_GOSSIP_ORGLEADER=false - CORE_PEER_PROFILE_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: peer node start 这我就不多解释了。 最后还有一个文件，在刚才的docker-compose-cli.yaml文件中有一句`command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39;什么意思呢？就是./scripts/script.sh这个shell脚本生效，一起去看看吧。 #!/bin/bash # Copyright London Stock Exchange Group All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # echo echo &quot; ____ _____ _ ____ _____ _____ ____ _____ &quot; echo &quot;/ ___| |_ _| / \ | _ \ |_ _| | ____| |___ \ | ____|&quot; echo &quot;\___ \ | | / _ \ | |_) | | | _____ | _| __) | | _| &quot; echo &quot; ___) | | | / ___ \ | _ &lt; | | |_____| | |___ / __/ | |___ &quot; echo &quot;|____/ |_| /_/ \_\ |_| \_\ |_| |_____| |_____| |_____|&quot; echo CHANNEL_NAME=&quot;$1&quot; : ${CHANNEL_NAME:=&quot;mychannel&quot;} : ${TIMEOUT:=&quot;60&quot;} COUNTER=1 MAX_RETRY=5 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem echo &quot;Channel name : &quot;$CHANNEL_NAME verifyResult () { if [ $1 -ne 0 ] ; then echo &quot;!!!!!!!!!!!!!!! &quot;$2&quot; !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } setGlobals () { if [ $1 -eq 0 -o $1 -eq 1 ] ; then CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp if [ $1 -eq 0 ]; then CORE_PEER_ADDRESS=peer0.org1.example.com:7051 else CORE_PEER_ADDRESS=peer1.org1.example.com:7051 fi else CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp if [ $1 -eq 2 ]; then CORE_PEER_ADDRESS=peer0.org2.example.com:7051 else CORE_PEER_ADDRESS=peer1.org2.example.com:7051 fi fi env |grep CORE } createChannel() { setGlobals 0 if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt else peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Channel creation failed&quot; echo &quot;===================== Channel \&quot;$CHANNEL_NAME\&quot; is created successfully ===================== &quot; echo } updateAnchorPeers() { PEER=$1 setGlobals $PEER if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt else peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Anchor peer update failed&quot; echo &quot;===================== Anchor peers for org \&quot;$CORE_PEER_LOCALMSPID\&quot; on \&quot;$CHANNEL_NAME\&quot; is updated successfully ===================== &quot; sleep 5 echo } ## Sometimes Join takes time hence RETRY atleast for 5 times joinWithRetry () { peer channel join -b $CHANNEL_NAME.block &gt;&amp;log.txt res=$? cat log.txt if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then COUNTER=` expr $COUNTER + 1` echo &quot;PEER$1 failed to join the channel, Retry after 2 seconds&quot; sleep 2 joinWithRetry $1 else COUNTER=1 fi verifyResult $res &quot;After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel&quot; } joinChannel () { for ch in 0 1 2 3; do setGlobals $ch joinWithRetry $ch echo &quot;===================== PEER$ch joined on the channel \&quot;$CHANNEL_NAME\&quot; ===================== &quot; sleep 2 echo done } installChaincode () { PEER=$1 setGlobals $PEER peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt res=$? cat log.txt verifyResult $res &quot;Chaincode installation on remote peer PEER$PEER has Failed&quot; echo &quot;===================== Chaincode is installed on remote peer PEER$PEER ===================== &quot; echo } instantiateChaincode () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &gt;&amp;log.txt else peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Chaincode instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; failed&quot; echo &quot;===================== Chaincode Instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } chaincodeQuery () { PEER=$1 echo &quot;===================== Querying on PEER$PEER on channel &#39;$CHANNEL_NAME&#39;... ===================== &quot; setGlobals $PEER local rc=1 local starttime=$(date +%s) # continue to poll # we either get a successful response, or reach TIMEOUT while test &quot;$(($(date +%s)-starttime))&quot; -lt &quot;$TIMEOUT&quot; -a $rc -ne 0 do sleep 3 echo &quot;Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs&quot; peer chaincode query -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &gt;&amp;log.txt test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk &#39;/Query Result/ {print $NF}&#39;) test &quot;$VALUE&quot; = &quot;$2&quot; &amp;&amp; let rc=0 done echo cat log.txt if test $rc -eq 0 ; then echo &quot;===================== Query on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; else echo &quot;!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } chaincodeInvoke () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode invoke -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt else peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Invoke execution on PEER$PEER failed &quot; echo &quot;===================== Invoke transaction on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } ## Create channel echo &quot;Creating channel...&quot; createChannel ## Join all the peers to the channel echo &quot;Having all peers join the channel...&quot; joinChannel ## Set the anchor peers for each org in the channel echo &quot;Updating anchor peers for org1...&quot; updateAnchorPeers 0 echo &quot;Updating anchor peers for org2...&quot; updateAnchorPeers 2 ## Install chaincode on Peer0/Org1 and Peer2/Org2 echo &quot;Installing chaincode on org1/peer0...&quot; installChaincode 0 echo &quot;Install chaincode on org2/peer2...&quot; installChaincode 2 #Instantiate chaincode on Peer2/Org2 echo &quot;Instantiating chaincode on org2/peer2...&quot; instantiateChaincode 2 #Query on chaincode on Peer0/Org1 echo &quot;Querying chaincode on org1/peer0...&quot; chaincodeQuery 0 100 #Invoke on chaincode on Peer0/Org1 echo &quot;Sending invoke transaction on org1/peer0...&quot; chaincodeInvoke 0 ## Install chaincode on Peer3/Org2 echo &quot;Installing chaincode on org2/peer3...&quot; installChaincode 3 #Query on chaincode on Peer3/Org2, check if the result is 90 echo &quot;Querying chaincode on org2/peer3...&quot; chaincodeQuery 3 90 echo echo &quot;===================== All GOOD, End-2-End execution completed ===================== &quot; echo echo echo &quot; _____ _ _ ____ _____ ____ _____ &quot; echo &quot;| ____| | \ | | | _ \ | ____| |___ \ | ____|&quot; echo &quot;| _| | \| | | | | | _____ | _| __) | | _| &quot; echo &quot;| |___ | |\ | | |_| | |_____| | |___ / __/ | |___ &quot; echo &quot;|_____| |_| \_| |____/ |_____| |_____| |_____|&quot; echo exit 0 我觉得终于到了你最希望看得的地方了，对于初学者而言的我们，看到good的时候就会心情很好，对吧？前面都为我们准备好了各节点，创世块，证书等内容！在这里这个文件为我们创建通道并且让各peer节点加入通道，安装、初始化、query准备好的chaincode！下图就是大致过程。 文件夹下还有许多的其他配置文件，其中如图。 下面用一张图总结一下： 大致过程基本如上，但感觉还差了一点什么！批评指正，批评指正！ 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-03-17T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"一、sudo ./network_setup.sh up 这条命令是如何为我们开启网络？通过几天的查看，我大致理清了他的顺序。在这里分享出来，如有不对，还望指出。 我们还是先看看这个shell文本里的内容： #!/bin/bash # # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # UP_DOWN=&quot;$1&quot; CH_NAME=&quot;$2&quot; CLI_TIMEOUT=&quot;$3&quot; IF_COUCHDB=&quot;$4&quot; : ${CLI_TIMEOUT:=&quot;10000&quot;} COMPOSE_FILE=docker-compose-cli.yaml COMPOSE_FILE_COUCH=docker-compose-couch.yaml #COMPOSE_FILE=docker-compose-e2e.yaml function printHelp () { echo &quot;Usage: ./network_setup &lt;up|down&gt; &lt;\\$channel-name&gt; &lt;\\$cli_timeout&gt; &lt;couchdb&gt;.\\nThe arguments must be in order.&quot; } function validateArgs () { if [ -z &quot;${UP_DOWN}&quot; ]; then echo &quot;Option up / down / restart not mentioned&quot; printHelp exit 1 fi if [ -z &quot;${CH_NAME}&quot; ]; then echo &quot;setting to default channel &#39;mychannel&#39;&quot; CH_NAME=mychannel fi } function clearContainers () { CONTAINER_IDS=$(docker ps -aq) if [ -z &quot;$CONTAINER_IDS&quot; -o &quot;$CONTAINER_IDS&quot; = &quot; &quot; ]; then echo &quot;---- No containers available for deletion ----&quot; else docker rm -f $CONTAINER_IDS fi } function removeUnwantedImages() { DOCKER_IMAGE_IDS=$(docker images | grep &quot;dev\\|none\\|test-vp\\|peer[0-9]-&quot; | awk &#39;{print $3}&#39;) if [ -z &quot;$DOCKER_IMAGE_IDS&quot; -o &quot;$DOCKER_IMAGE_IDS&quot; = &quot; &quot; ]; then echo &quot;---- No images available for deletion ----&quot; else docker rmi -f $DOCKER_IMAGE_IDS fi } function networkUp () { if [ -f &quot;./crypto-config&quot; ]; then echo &quot;crypto-config directory already exists.&quot; else #Generate all the artifacts that includes org certs, orderer genesis block, # channel configuration transaction source generateArtifacts.sh $CH_NAME fi if [ &quot;${IF_COUCHDB}&quot; == &quot;couchdb&quot; ]; then CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE -f $COMPOSE_FILE_COUCH up -d 2&gt;&amp;1 else CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE up -d 2&gt;&amp;1 fi if [ $? -ne 0 ]; then echo &quot;ERROR !!!! Unable to pull the images &quot; exit 1 fi docker logs -f cli } function networkDown () { docker-compose -f $COMPOSE_FILE down #Cleanup the chaincode containers clearContainers #Cleanup images removeUnwantedImages # remove orderer block and other channel configuration transactions and certs rm -rf channel-artifacts/*.block channel-artifacts/*.tx crypto-config } validateArgs #Create the network using docker compose if [ &quot;${UP_DOWN}&quot; == &quot;up&quot; ]; then networkUp elif [ &quot;${UP_DOWN}&quot; == &quot;down&quot; ]; then ## Clear the network networkDown elif [ &quot;${UP_DOWN}&quot; == &quot;restart&quot; ]; then ## Restart the network networkDown networkUp else printHelp exit 1 fi 阅读这个shell需要一些基础，我也是刚看完shell的一些基本语法才勉强理解，下面我用一张图表示他的启动顺序。 那么这里面最关键的地方有那些呢？首先这条语句： source generateArtifacts.sh $CH_NAME 无形之间将我们带到了另一个shell文本，那就是同目录下的generateArtifacts.sh，下面我们接着往下看。 #!/bin/bash +x # # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # #set -e CHANNEL_NAME=$1 : ${CHANNEL_NAME:=&quot;mychannel&quot;} echo $CHANNEL_NAME export FABRIC_ROOT=$PWD/../.. export FABRIC_CFG_PATH=$PWD echo OS_ARCH=$(echo &quot;$(uname -s|tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;|sed &#39;s/mingw64_nt.*/windows/&#39;)-$(uname -m | sed &#39;s/x86_64/amd64/g&#39;)&quot; | awk &#39;{print tolower($0)}&#39;) ## Using docker-compose template replace private key file names with constants function replacePrivateKey () { ARCH=`uname -s | grep Darwin` if [ &quot;$ARCH&quot; == &quot;Darwin&quot; ]; then OPTS=&quot;-it&quot; else OPTS=&quot;-i&quot; fi cp docker-compose-e2e-template.yaml docker-compose-e2e.yaml CURRENT_DIR=$PWD cd crypto-config/peerOrganizations/org1.example.com/ca/ PRIV_KEY=$(ls *_sk) cd $CURRENT_DIR sed $OPTS &quot;s/CA1_PRIVATE_KEY/${PRIV_KEY}/g&quot; docker-compose-e2e.yaml cd crypto-config/peerOrganizations/org2.example.com/ca/ PRIV_KEY=$(ls *_sk) cd $CURRENT_DIR sed $OPTS &quot;s/CA2_PRIVATE_KEY/${PRIV_KEY}/g&quot; docker-compose-e2e.yaml } ## Generates Org certs using cryptogen tool function generateCerts (){ CRYPTOGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/cryptogen if [ -f &quot;$CRYPTOGEN&quot; ]; then echo &quot;Using cryptogen -&gt; $CRYPTOGEN&quot; else echo &quot;Building cryptogen&quot; make -C $FABRIC_ROOT release fi echo echo &quot;##########################################################&quot; echo &quot;##### Generate certificates using cryptogen tool #########&quot; echo &quot;##########################################################&quot; $CRYPTOGEN generate --config=./crypto-config.yaml echo } ## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions function generateChannelArtifacts() { CONFIGTXGEN=$FABRIC_ROOT/release/$OS_ARCH/bin/configtxgen if [ -f &quot;$CONFIGTXGEN&quot; ]; then echo &quot;Using configtxgen -&gt; $CONFIGTXGEN&quot; else echo &quot;Building configtxgen&quot; make -C $FABRIC_ROOT release fi echo &quot;##########################################################&quot; echo &quot;######### Generating Orderer Genesis block ##############&quot; echo &quot;##########################################################&quot; # Note: For some unknown reason (at least for now) the block file can&#39;t be # named orderer.genesis.block or the orderer will fail to launch! $CONFIGTXGEN -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block echo echo &quot;#################################################################&quot; echo &quot;### Generating channel configuration transaction &#39;channel.tx&#39; ###&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID $CHANNEL_NAME echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org1MSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org1MSP echo echo &quot;#################################################################&quot; echo &quot;####### Generating anchor peer update for Org2MSP ##########&quot; echo &quot;#################################################################&quot; $CONFIGTXGEN -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID $CHANNEL_NAME -asOrg Org2MSP echo } generateCerts replacePrivateKey generateChannelArtifacts 此文件主要是用来生成主要的配置文件如私钥和证书，有通道证书之类的。下面这张图是它执行的顺序。 其次语句： CHANNEL_NAME=$CH_NAME TIMEOUT=$CLI_TIMEOUT docker-compose -f $COMPOSE_FILE up -d 2&gt;&amp;1 其实就是：docker-compose -f docker-compose-cli.yaml up是不是感觉很熟悉呢？接下来我们接着看docker-compose-cli.yaml文件。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: orderer.example.com: extends: file: base/docker-compose-base.yaml service: orderer.example.com container_name: orderer.example.com peer0.org1.example.com: container_name: peer0.org1.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org1.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org1.example.com peer1.org1.example.com: container_name: peer1.org1.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org1.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org1.example.com peer0.org2.example.com: container_name: peer0.org2.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org2.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org2.example.com peer1.org2.example.com: container_name: peer1.org2.example.com #environment: #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org2.example.com:5984 #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org2.example.com cli: container_name: cli image: hyperledger/fabric-tools tty: true environment: - GOPATH=/opt/gopath - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_ID=cli - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP - CORE_PEER_TLS_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39; volumes: - /var/run/:/host/var/run/ - ../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts depends_on: - orderer.example.com - peer0.org1.example.com - peer1.org1.example.com - peer0.org2.example.com - peer1.org2.example.com 这个文件的作用就是启动一系列的容器，当你看到下面内容的时候，就是此配置文件的作用： Creating peer1.org2.example.com ... done Creating cli ... done Creating orderer.example.com ... Creating peer0.org2.example.com ... Creating peer1.org1.example.com ... Creating peer0.org1.example.com ... Creating cli ... 这个配置文件中还有一个地方需要我们关注，那就是：base/docker-compose-base.yaml，我们接着看看当前目录下的base文件夹里的docker-compose-base.yaml文件。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: orderer.example.com: container_name: orderer.example.com image: hyperledger/fabric-orderer environment: - ORDERER_GENERAL_LOGLEVEL=debug - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp # enabled TLS - ORDERER_GENERAL_TLS_ENABLED=true - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt] working_dir: /opt/gopath/src/github.com/hyperledger/fabric command: orderer volumes: - ../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls ports: - 7050:7050 peer0.org1.example.com: container_name: peer0.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org1.example.com - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer0.org1.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 7051:7051 - 7052:7052 - 7053:7053 peer1.org1.example.com: container_name: peer1.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer1.org1.example.com - CORE_PEER_ADDRESS=peer1.org1.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org1.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051 - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 8051:7051 - 8052:7052 - 8053:7053 peer0.org2.example.com: container_name: peer0.org2.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org2.example.com - CORE_PEER_ADDRESS=peer0.org2.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer0.org2.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org2.example.com:7051 - CORE_PEER_LOCALMSPID=Org2MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls:/etc/hyperledger/fabric/tls ports: - 9051:7051 - 9052:7052 - 9053:7053 peer1.org2.example.com: container_name: peer1.org2.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer1.org2.example.com - CORE_PEER_ADDRESS=peer1.org2.example.com:7051 - CORE_PEER_CHAINCODELISTENADDRESS=peer1.org2.example.com:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org2.example.com:7051 - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org2.example.com:7051 - CORE_PEER_LOCALMSPID=Org2MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls:/etc/hyperledger/fabric/tls ports: - 10051:7051 - 10052:7052 - 10053:7053 这个配置文件就比较明显了，Orderer和peer的配置文件，细心的你肯定也发现了file: peer-base.yaml，那就看看同目录下的peer-base.yaml文件吧。 # Copyright IBM Corp. All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # version: &#39;2&#39; services: peer-base: image: hyperledger/fabric-peer environment: - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock # the following setting starts chaincode containers on the same # bridge network as the peers # https://docs.docker.com/compose/networking/ - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli_default #- CORE_LOGGING_LEVEL=ERROR - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_TLS_ENABLED=true - CORE_PEER_GOSSIP_USELEADERELECTION=true - CORE_PEER_GOSSIP_ORGLEADER=false - CORE_PEER_PROFILE_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: peer node start 这我就不多解释了。 最后还有一个文件，在刚才的docker-compose-cli.yaml文件中有一句`command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39;什么意思呢？就是./scripts/script.sh这个shell脚本生效，一起去看看吧。 #!/bin/bash # Copyright London Stock Exchange Group All Rights Reserved. # # SPDX-License-Identifier: Apache-2.0 # echo echo &quot; ____ _____ _ ____ _____ _____ ____ _____ &quot; echo &quot;/ ___| |_ _| / \\ | _ \\ |_ _| | ____| |___ \\ | ____|&quot; echo &quot;\\___ \\ | | / _ \\ | |_) | | | _____ | _| __) | | _| &quot; echo &quot; ___) | | | / ___ \\ | _ &lt; | | |_____| | |___ / __/ | |___ &quot; echo &quot;|____/ |_| /_/ \\_\\ |_| \\_\\ |_| |_____| |_____| |_____|&quot; echo CHANNEL_NAME=&quot;$1&quot; : ${CHANNEL_NAME:=&quot;mychannel&quot;} : ${TIMEOUT:=&quot;60&quot;} COUNTER=1 MAX_RETRY=5 ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem echo &quot;Channel name : &quot;$CHANNEL_NAME verifyResult () { if [ $1 -ne 0 ] ; then echo &quot;!!!!!!!!!!!!!!! &quot;$2&quot; !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } setGlobals () { if [ $1 -eq 0 -o $1 -eq 1 ] ; then CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp if [ $1 -eq 0 ]; then CORE_PEER_ADDRESS=peer0.org1.example.com:7051 else CORE_PEER_ADDRESS=peer1.org1.example.com:7051 fi else CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp if [ $1 -eq 2 ]; then CORE_PEER_ADDRESS=peer0.org2.example.com:7051 else CORE_PEER_ADDRESS=peer1.org2.example.com:7051 fi fi env |grep CORE } createChannel() { setGlobals 0 if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx &gt;&amp;log.txt else peer channel create -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/channel.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Channel creation failed&quot; echo &quot;===================== Channel \\&quot;$CHANNEL_NAME\\&quot; is created successfully ===================== &quot; echo } updateAnchorPeers() { PEER=$1 setGlobals $PEER if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx &gt;&amp;log.txt else peer channel update -o orderer.example.com:7050 -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Anchor peer update failed&quot; echo &quot;===================== Anchor peers for org \\&quot;$CORE_PEER_LOCALMSPID\\&quot; on \\&quot;$CHANNEL_NAME\\&quot; is updated successfully ===================== &quot; sleep 5 echo } ## Sometimes Join takes time hence RETRY atleast for 5 times joinWithRetry () { peer channel join -b $CHANNEL_NAME.block &gt;&amp;log.txt res=$? cat log.txt if [ $res -ne 0 -a $COUNTER -lt $MAX_RETRY ]; then COUNTER=` expr $COUNTER + 1` echo &quot;PEER$1 failed to join the channel, Retry after 2 seconds&quot; sleep 2 joinWithRetry $1 else COUNTER=1 fi verifyResult $res &quot;After $MAX_RETRY attempts, PEER$ch has failed to Join the Channel&quot; } joinChannel () { for ch in 0 1 2 3; do setGlobals $ch joinWithRetry $ch echo &quot;===================== PEER$ch joined on the channel \\&quot;$CHANNEL_NAME\\&quot; ===================== &quot; sleep 2 echo done } installChaincode () { PEER=$1 setGlobals $PEER peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt res=$? cat log.txt verifyResult $res &quot;Chaincode installation on remote peer PEER$PEER has Failed&quot; echo &quot;===================== Chaincode is installed on remote peer PEER$PEER ===================== &quot; echo } instantiateChaincode () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode instantiate -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &gt;&amp;log.txt else peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Chaincode instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; failed&quot; echo &quot;===================== Chaincode Instantiation on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } chaincodeQuery () { PEER=$1 echo &quot;===================== Querying on PEER$PEER on channel &#39;$CHANNEL_NAME&#39;... ===================== &quot; setGlobals $PEER local rc=1 local starttime=$(date +%s) # continue to poll # we either get a successful response, or reach TIMEOUT while test &quot;$(($(date +%s)-starttime))&quot; -lt &quot;$TIMEOUT&quot; -a $rc -ne 0 do sleep 3 echo &quot;Attempting to Query PEER$PEER ...$(($(date +%s)-starttime)) secs&quot; peer chaincode query -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; &gt;&amp;log.txt test $? -eq 0 &amp;&amp; VALUE=$(cat log.txt | awk &#39;/Query Result/ {print $NF}&#39;) test &quot;$VALUE&quot; = &quot;$2&quot; &amp;&amp; let rc=0 done echo cat log.txt if test $rc -eq 0 ; then echo &quot;===================== Query on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; else echo &quot;!!!!!!!!!!!!!!! Query result on PEER$PEER is INVALID !!!!!!!!!!!!!!!!&quot; echo &quot;================== ERROR !!! FAILED to execute End-2-End Scenario ==================&quot; echo exit 1 fi } chaincodeInvoke () { PEER=$1 setGlobals $PEER # while &#39;peer chaincode&#39; command can get the orderer endpoint from the peer (if join was successful), # lets supply it directly as we know it using the &quot;-o&quot; option if [ -z &quot;$CORE_PEER_TLS_ENABLED&quot; -o &quot;$CORE_PEER_TLS_ENABLED&quot; = &quot;false&quot; ]; then peer chaincode invoke -o orderer.example.com:7050 -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt else peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile $ORDERER_CA -C $CHANNEL_NAME -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; &gt;&amp;log.txt fi res=$? cat log.txt verifyResult $res &quot;Invoke execution on PEER$PEER failed &quot; echo &quot;===================== Invoke transaction on PEER$PEER on channel &#39;$CHANNEL_NAME&#39; is successful ===================== &quot; echo } ## Create channel echo &quot;Creating channel...&quot; createChannel ## Join all the peers to the channel echo &quot;Having all peers join the channel...&quot; joinChannel ## Set the anchor peers for each org in the channel echo &quot;Updating anchor peers for org1...&quot; updateAnchorPeers 0 echo &quot;Updating anchor peers for org2...&quot; updateAnchorPeers 2 ## Install chaincode on Peer0/Org1 and Peer2/Org2 echo &quot;Installing chaincode on org1/peer0...&quot; installChaincode 0 echo &quot;Install chaincode on org2/peer2...&quot; installChaincode 2 #Instantiate chaincode on Peer2/Org2 echo &quot;Instantiating chaincode on org2/peer2...&quot; instantiateChaincode 2 #Query on chaincode on Peer0/Org1 echo &quot;Querying chaincode on org1/peer0...&quot; chaincodeQuery 0 100 #Invoke on chaincode on Peer0/Org1 echo &quot;Sending invoke transaction on org1/peer0...&quot; chaincodeInvoke 0 ## Install chaincode on Peer3/Org2 echo &quot;Installing chaincode on org2/peer3...&quot; installChaincode 3 #Query on chaincode on Peer3/Org2, check if the result is 90 echo &quot;Querying chaincode on org2/peer3...&quot; chaincodeQuery 3 90 echo echo &quot;===================== All GOOD, End-2-End execution completed ===================== &quot; echo echo echo &quot; _____ _ _ ____ _____ ____ _____ &quot; echo &quot;| ____| | \\ | | | _ \\ | ____| |___ \\ | ____|&quot; echo &quot;| _| | \\| | | | | | _____ | _| __) | | _| &quot; echo &quot;| |___ | |\\ | | |_| | |_____| | |___ / __/ | |___ &quot; echo &quot;|_____| |_| \\_| |____/ |_____| |_____| |_____|&quot; echo exit 0 我觉得终于到了你最希望看得的地方了，对于初学者而言的我们，看到good的时候就会心情很好，对吧？前面都为我们准备好了各节点，创世块，证书等内容！在这里这个文件为我们创建通道并且让各peer节点加入通道，安装、初始化、query准备好的chaincode！下图就是大致过程。 文件夹下还有许多的其他配置文件，其中如图。 下面用一张图总结一下： 大致过程基本如上，但感觉还差了一点什么！批评指正，批评指正！ 阅读更多","@type":"BlogPosting","url":"/2018/03/17/46f478fb0824d2c9f8c3d9a0d2322b69.html","headline":"粗略分析hyperledger-fabric之e2e_cli是如何开启网络","dateModified":"2018-03-17T00:00:00+08:00","datePublished":"2018-03-17T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/03/17/46f478fb0824d2c9f8c3d9a0d2322b69.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>粗略分析hyperledger-fabric之e2e_cli是如何开启网络</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h1 id="一sudo-networksetupsh-up">一、sudo ./network_setup.sh up</h1> 
  <p>这条命令是如何为我们开启网络？通过几天的查看，我大致理清了他的顺序。在这里分享出来，如有不对，还望指出。 <br> 我们还是先看看这个shell文本里的内容：</p> 
  <pre class="prettyprint"><code class="language-shell hljs bash"><span class="hljs-shebang">#!/bin/bash</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Copyright IBM Corp. All Rights Reserved.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span>
<span class="hljs-comment">#</span>


UP_DOWN=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
CH_NAME=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
CLI_TIMEOUT=<span class="hljs-string">"<span class="hljs-variable">$3</span>"</span>
IF_COUCHDB=<span class="hljs-string">"<span class="hljs-variable">$4</span>"</span>

: <span class="hljs-variable">${CLI_TIMEOUT:="10000"}</span>

COMPOSE_FILE=docker-compose-cli.yaml
COMPOSE_FILE_COUCH=docker-compose-couch.yaml
<span class="hljs-comment">#COMPOSE_FILE=docker-compose-e2e.yaml</span>

function <span class="hljs-function"><span class="hljs-title">printHelp</span></span> () {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: ./network_setup &lt;up|down&gt; &lt;\$channel-name&gt; &lt;\$cli_timeout&gt; &lt;couchdb&gt;.\nThe arguments must be in order."</span>
}

function <span class="hljs-function"><span class="hljs-title">validateArgs</span></span> () {
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">${UP_DOWN}</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Option up / down / restart not mentioned"</span>
        printHelp
        <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">${CH_NAME}</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"setting to default channel 'mychannel'"</span>
        CH_NAME=mychannel
    <span class="hljs-keyword">fi</span>
}

function <span class="hljs-function"><span class="hljs-title">clearContainers</span></span> () {
        CONTAINER_IDS=$(docker ps -aq)
        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$CONTAINER_IDS</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$CONTAINER_IDS</span>"</span> = <span class="hljs-string">" "</span> ]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"---- No containers available for deletion ----"</span>
        <span class="hljs-keyword">else</span>
                docker rm <span class="hljs-operator">-f</span> <span class="hljs-variable">$CONTAINER_IDS</span>
        <span class="hljs-keyword">fi</span>
}

function <span class="hljs-function"><span class="hljs-title">removeUnwantedImages</span></span>() {
        DOCKER_IMAGE_IDS=$(docker images | grep <span class="hljs-string">"dev\|none\|test-vp\|peer[0-9]-"</span> | awk <span class="hljs-string">'{print $3}'</span>)
        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$DOCKER_IMAGE_IDS</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$DOCKER_IMAGE_IDS</span>"</span> = <span class="hljs-string">" "</span> ]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"---- No images available for deletion ----"</span>
        <span class="hljs-keyword">else</span>
                docker rmi <span class="hljs-operator">-f</span> <span class="hljs-variable">$DOCKER_IMAGE_IDS</span>
        <span class="hljs-keyword">fi</span>
}

function <span class="hljs-function"><span class="hljs-title">networkUp</span></span> () {
    <span class="hljs-keyword">if</span> [ <span class="hljs-operator">-f</span> <span class="hljs-string">"./crypto-config"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">echo</span> <span class="hljs-string">"crypto-config directory already exists."</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-comment">#Generate all the artifacts that includes org certs, orderer genesis block,</span>
      <span class="hljs-comment"># channel configuration transaction</span>
      <span class="hljs-built_in">source</span> generateArtifacts.sh <span class="hljs-variable">$CH_NAME</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">${IF_COUCHDB}</span>"</span> == <span class="hljs-string">"couchdb"</span> ]; <span class="hljs-keyword">then</span>
      CHANNEL_NAME=<span class="hljs-variable">$CH_NAME</span> TIMEOUT=<span class="hljs-variable">$CLI_TIMEOUT</span> docker-compose <span class="hljs-operator">-f</span> <span class="hljs-variable">$COMPOSE_FILE</span> <span class="hljs-operator">-f</span> <span class="hljs-variable">$COMPOSE_FILE_COUCH</span> up <span class="hljs-operator">-d</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>
    <span class="hljs-keyword">else</span>
      CHANNEL_NAME=<span class="hljs-variable">$CH_NAME</span> TIMEOUT=<span class="hljs-variable">$CLI_TIMEOUT</span> docker-compose <span class="hljs-operator">-f</span> <span class="hljs-variable">$COMPOSE_FILE</span> up <span class="hljs-operator">-d</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">if</span> [ $? <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"ERROR !!!! Unable to pull the images "</span>
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">fi</span>
    docker logs <span class="hljs-operator">-f</span> cli
}

function <span class="hljs-function"><span class="hljs-title">networkDown</span></span> () {
    docker-compose <span class="hljs-operator">-f</span> <span class="hljs-variable">$COMPOSE_FILE</span> down

    <span class="hljs-comment">#Cleanup the chaincode containers</span>
    clearContainers

    <span class="hljs-comment">#Cleanup images</span>
    removeUnwantedImages

    <span class="hljs-comment"># remove orderer block and other channel configuration transactions and certs</span>
    rm -rf channel-artifacts/*.block channel-artifacts/*.tx crypto-config
}

validateArgs

<span class="hljs-comment">#Create the network using docker compose</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">${UP_DOWN}</span>"</span> == <span class="hljs-string">"up"</span> ]; <span class="hljs-keyword">then</span>
    networkUp
<span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">${UP_DOWN}</span>"</span> == <span class="hljs-string">"down"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">## Clear the network</span>
    networkDown 
<span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">${UP_DOWN}</span>"</span> == <span class="hljs-string">"restart"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-comment">## Restart the network</span>
    networkDown
    networkUp
<span class="hljs-keyword">else</span>
    printHelp
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">fi</span></code></pre> 
  <p>阅读这个shell需要一些基础，我也是刚看完shell的一些基本语法才勉强理解，下面我用一张图表示他的启动顺序。 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180317091037947?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2NzQyMTg2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 那么这里面最关键的地方有那些呢？首先这条语句：</p> 
  <pre class="prettyprint"><code class=" hljs bash"><span class="hljs-built_in">source</span> generateArtifacts.sh <span class="hljs-variable">$CH_NAME</span></code></pre> 
  <p>无形之间将我们带到了另一个shell文本，那就是同目录下的generateArtifacts.sh，下面我们接着往下看。</p> 
  <pre class="prettyprint"><code class=" hljs bash"><span class="hljs-comment">#!/bin/bash +x</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># Copyright IBM Corp. All Rights Reserved.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span>
<span class="hljs-comment">#</span>


<span class="hljs-comment">#set -e</span>

CHANNEL_NAME=<span class="hljs-variable">$1</span>
: <span class="hljs-variable">${CHANNEL_NAME:="mychannel"}</span>
<span class="hljs-built_in">echo</span> <span class="hljs-variable">$CHANNEL_NAME</span>

<span class="hljs-keyword">export</span> FABRIC_ROOT=<span class="hljs-variable">$PWD</span>/../..
<span class="hljs-keyword">export</span> FABRIC_CFG_PATH=<span class="hljs-variable">$PWD</span>
<span class="hljs-built_in">echo</span>

OS_ARCH=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$(uname -s|tr '[:upper:]' '[:lower:]'|sed 's/mingw64_nt.*/windows/')</span>-<span class="hljs-variable">$(uname -m | sed 's/x86_64/amd64/g')</span>"</span> | awk <span class="hljs-string">'{print tolower($0)}'</span>)

<span class="hljs-comment">## Using docker-compose template replace private key file names with constants</span>
function <span class="hljs-function"><span class="hljs-title">replacePrivateKey</span></span> () {
    ARCH=`uname <span class="hljs-operator">-s</span> | grep Darwin`
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$ARCH</span>"</span> == <span class="hljs-string">"Darwin"</span> ]; <span class="hljs-keyword">then</span>
        OPTS=<span class="hljs-string">"-it"</span>
    <span class="hljs-keyword">else</span>
        OPTS=<span class="hljs-string">"-i"</span>
    <span class="hljs-keyword">fi</span>

    cp docker-compose<span class="hljs-operator">-e</span>2e-template.yaml docker-compose<span class="hljs-operator">-e</span>2e.yaml

        CURRENT_DIR=<span class="hljs-variable">$PWD</span>
        <span class="hljs-built_in">cd</span> crypto-config/peerOrganizations/org1.example.com/ca/
        PRIV_KEY=$(ls *_sk)
        <span class="hljs-built_in">cd</span> <span class="hljs-variable">$CURRENT_DIR</span>
        sed <span class="hljs-variable">$OPTS</span> <span class="hljs-string">"s/CA1_PRIVATE_KEY/<span class="hljs-variable">${PRIV_KEY}</span>/g"</span> docker-compose<span class="hljs-operator">-e</span>2e.yaml
        <span class="hljs-built_in">cd</span> crypto-config/peerOrganizations/org2.example.com/ca/
        PRIV_KEY=$(ls *_sk)
        <span class="hljs-built_in">cd</span> <span class="hljs-variable">$CURRENT_DIR</span>
        sed <span class="hljs-variable">$OPTS</span> <span class="hljs-string">"s/CA2_PRIVATE_KEY/<span class="hljs-variable">${PRIV_KEY}</span>/g"</span> docker-compose<span class="hljs-operator">-e</span>2e.yaml
}

<span class="hljs-comment">## Generates Org certs using cryptogen tool</span>
function <span class="hljs-function"><span class="hljs-title">generateCerts</span></span> (){
    CRYPTOGEN=<span class="hljs-variable">$FABRIC_ROOT</span>/release/<span class="hljs-variable">$OS_ARCH</span>/bin/cryptogen

    <span class="hljs-keyword">if</span> [ <span class="hljs-operator">-f</span> <span class="hljs-string">"<span class="hljs-variable">$CRYPTOGEN</span>"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"Using cryptogen -&gt; <span class="hljs-variable">$CRYPTOGEN</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Building cryptogen"</span>
        make -C <span class="hljs-variable">$FABRIC_ROOT</span> release
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"##########################################################"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"##### Generate certificates using cryptogen tool #########"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"##########################################################"</span>
    <span class="hljs-variable">$CRYPTOGEN</span> generate --config=./crypto-config.yaml
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment">## Generate orderer genesis block , channel configuration transaction and anchor peer update transactions</span>
function <span class="hljs-function"><span class="hljs-title">generateChannelArtifacts</span></span>() {

    CONFIGTXGEN=<span class="hljs-variable">$FABRIC_ROOT</span>/release/<span class="hljs-variable">$OS_ARCH</span>/bin/configtxgen
    <span class="hljs-keyword">if</span> [ <span class="hljs-operator">-f</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIGTXGEN</span>"</span> ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"Using configtxgen -&gt; <span class="hljs-variable">$CONFIGTXGEN</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Building configtxgen"</span>
        make -C <span class="hljs-variable">$FABRIC_ROOT</span> release
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"##########################################################"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"######### Generating Orderer Genesis block ##############"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"##########################################################"</span>
    <span class="hljs-comment"># Note: For some unknown reason (at least for now) the block file can't be</span>
    <span class="hljs-comment"># named orderer.genesis.block or the orderer will fail to launch!</span>
    <span class="hljs-variable">$CONFIGTXGEN</span> -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block

    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"#################################################################"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"### Generating channel configuration transaction 'channel.tx' ###"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"#################################################################"</span>
    <span class="hljs-variable">$CONFIGTXGEN</span> -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID <span class="hljs-variable">$CHANNEL_NAME</span>

    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"#################################################################"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"####### Generating anchor peer update for Org1MSP ##########"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"#################################################################"</span>
    <span class="hljs-variable">$CONFIGTXGEN</span> -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID <span class="hljs-variable">$CHANNEL_NAME</span> -asOrg Org1MSP

    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"#################################################################"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"####### Generating anchor peer update for Org2MSP ##########"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"#################################################################"</span>
    <span class="hljs-variable">$CONFIGTXGEN</span> -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID <span class="hljs-variable">$CHANNEL_NAME</span> -asOrg Org2MSP
    <span class="hljs-built_in">echo</span>
}

generateCerts
replacePrivateKey
generateChannelArtifacts
</code></pre> 
  <p>此文件主要是用来生成主要的配置文件如私钥和证书，有通道证书之类的。下面这张图是它执行的顺序。 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180317144449999?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2NzQyMTg2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 其次语句：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">CHANNEL_NAME<span class="hljs-subst">=</span><span class="hljs-variable">$CH_NAME</span> TIMEOUT<span class="hljs-subst">=</span><span class="hljs-variable">$CLI_TIMEOUT</span> docker<span class="hljs-attribute">-compose</span> <span class="hljs-attribute">-f</span> <span class="hljs-variable">$COMPOSE_FILE</span> up <span class="hljs-attribute">-d</span> <span class="hljs-number">2</span><span class="hljs-subst">&gt;&amp;</span><span class="hljs-number">1</span></code></pre> 
  <p>其实就是：<code>docker-compose -f docker-compose-cli.yaml up</code>是不是感觉很熟悉呢？接下来我们接着看docker-compose-cli.yaml文件。</p> 
  <pre class="prettyprint"><code class="language-yaml hljs haml"># Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

version: '2'

services:

  orderer.example.com:
    extends:
      file:   base/docker-compose-base.yaml
      service: orderer.example.com
    container_name: orderer.example.com

  peer0.org1.example.com:
    container_name: peer0.org1.example.com
    #environment:
      #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org1.example.com:5984
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password
    extends:
      file:  base/docker-compose-base.yaml
      service: peer0.org1.example.com

  peer1.org1.example.com:
    container_name: peer1.org1.example.com
    #environment:
      #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org1.example.com:5984
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password
    extends:
      file:  base/docker-compose-base.yaml
      service: peer1.org1.example.com

  peer0.org2.example.com:
    container_name: peer0.org2.example.com
    #environment:
      #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer0.org2.example.com:5984
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password
    extends:
      file:  base/docker-compose-base.yaml
      service: peer0.org2.example.com

  peer1.org2.example.com:
    container_name: peer1.org2.example.com
    #environment:
      #- CORE_LEDGER_STATE_STATEDATABASE=CouchDB
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=peer1.org2.example.com:5984
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin
      #- CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password
    extends:
      file:  base/docker-compose-base.yaml
      service: peer1.org2.example.com

  cli:
    container_name: cli
    image: hyperledger/fabric-tools
    tty: true
    environment:
      -<span class="ruby"> <span class="hljs-constant">GOPATH</span>=<span class="hljs-regexp">/opt/gopath</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_VM_ENDPOINT</span>=<span class="hljs-symbol">unix:</span>/<span class="hljs-regexp">//host</span><span class="hljs-regexp">/var/run</span><span class="hljs-regexp">/docker.sock </span></span>      -<span class="ruby"> <span class="hljs-constant">CORE_LOGGING_LEVEL</span>=<span class="hljs-constant">DEBUG</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=cli </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org1MSP</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_CERT_FILE</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/tls/server.crt </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_KEY_FILE</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/tls/server.key </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ROOTCERT_FILE</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/tls/ca.crt </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_MSPCONFIGPATH</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/<span class="hljs-constant">Admin</span><span class="hljs-variable">@org1</span>.example.com/msp </span>    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash -c './scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT'
    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../chaincode/go/<span class="hljs-symbol">:/opt/gopath/src/github</span>.com/hyperledger/fabric/examples/chaincode/go </span>        -<span class="ruby"> ./crypto-<span class="hljs-symbol">config:</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ </span>        -<span class="ruby"> ./<span class="hljs-symbol">scripts:</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ </span>        -<span class="ruby"> ./channel-<span class="hljs-symbol">artifacts:</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts </span>    depends_on:
      -<span class="ruby"> orderer.example.com </span>      -<span class="ruby"> peer<span class="hljs-number">0</span>.org1.example.com </span>      -<span class="ruby"> peer1.org1.example.com </span>      -<span class="ruby"> peer<span class="hljs-number">0</span>.org2.example.com </span>      -<span class="ruby"> peer1.org2.example.com</span></code></pre> 
  <p>这个文件的作用就是启动一系列的容器，当你看到下面内容的时候，就是此配置文件的作用： <br> <code> <br> Creating peer1.org2.example.com ... done <br> Creating cli ... done <br> Creating orderer.example.com ... <br> Creating peer0.org2.example.com ... <br> Creating peer1.org1.example.com ... <br> Creating peer0.org1.example.com ... <br> Creating cli ... <br> </code> <br> 这个配置文件中还有一个地方需要我们关注，那就是：<code>base/docker-compose-base.yaml</code>，我们接着看看当前目录下的base文件夹里的<code>docker-compose-base.yaml</code>文件。</p> 
  <pre class="prettyprint"><code class=" hljs haml"># Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

version: '2'

services:

  orderer.example.com:
    container_name: orderer.example.com
    image: hyperledger/fabric-orderer
    environment:
      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LOGLEVEL</span>=debug </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LISTENADDRESS</span>=<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_GENESISMETHOD</span>=file </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_GENESISFILE</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/orderer</span>.genesis.block </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LOCALMSPID</span>=<span class="hljs-constant">OrdererMSP</span> </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LOCALMSPDIR</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/msp</span> </span>      # enabled TLS
      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_PRIVATEKEY</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/tls</span><span class="hljs-regexp">/server.key </span></span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_CERTIFICATE</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/tls</span><span class="hljs-regexp">/server.crt </span></span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_ROOTCAS</span>=[<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/tls</span><span class="hljs-regexp">/ca.crt] </span></span>    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: orderer
    volumes:
    -<span class="ruby"> ../channel-artifacts/genesis.<span class="hljs-symbol">block:</span>/var/hyperledger/orderer/orderer.genesis.block </span>    -<span class="ruby"> ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/<span class="hljs-symbol">msp:</span>/var/hyperledger/orderer/msp </span>    -<span class="ruby"> ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/<span class="hljs-symbol">:/var/hyperledger/orderer/tls</span> </span>    ports:
      -<span class="ruby"> <span class="hljs-number">7050</span><span class="hljs-symbol">:</span><span class="hljs-number">7050</span> </span>
  peer0.org1.example.com:
    container_name: peer0.org1.example.com
    extends:
      file: peer-base.yaml
      service: peer-base
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=peer<span class="hljs-number">0</span>.org1.example.com </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_CHAINCODELISTENADDRESS</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org1MSP</span> </span>    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/<span class="hljs-symbol">msp:</span>/etc/hyperledger/fabric/msp </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/<span class="hljs-symbol">tls:</span>/etc/hyperledger/fabric/tls </span>    ports:
      -<span class="ruby"> <span class="hljs-number">7051</span><span class="hljs-symbol">:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-number">7052</span><span class="hljs-symbol">:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-number">7053</span><span class="hljs-symbol">:</span><span class="hljs-number">7053</span> </span>
  peer1.org1.example.com:
    container_name: peer1.org1.example.com
    extends:
      file: peer-base.yaml
      service: peer-base
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=peer1.org1.example.com </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer1.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_CHAINCODELISTENADDRESS</span>=peer1.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span>=peer1.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_BOOTSTRAP</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org1MSP</span> </span>    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/<span class="hljs-symbol">msp:</span>/etc/hyperledger/fabric/msp </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/<span class="hljs-symbol">tls:</span>/etc/hyperledger/fabric/tls </span>
    ports:
      -<span class="ruby"> <span class="hljs-number">8051</span><span class="hljs-symbol">:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-number">8052</span><span class="hljs-symbol">:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-number">8053</span><span class="hljs-symbol">:</span><span class="hljs-number">7053</span> </span>
  peer0.org2.example.com:
    container_name: peer0.org2.example.com
    extends:
      file: peer-base.yaml
      service: peer-base
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=peer<span class="hljs-number">0</span>.org2.example.com </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer<span class="hljs-number">0</span>.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_CHAINCODELISTENADDRESS</span>=peer<span class="hljs-number">0</span>.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span>=peer<span class="hljs-number">0</span>.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org2MSP</span> </span>    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org2.example.com/peers/peer<span class="hljs-number">0</span>.org2.example.com/<span class="hljs-symbol">msp:</span>/etc/hyperledger/fabric/msp </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org2.example.com/peers/peer<span class="hljs-number">0</span>.org2.example.com/<span class="hljs-symbol">tls:</span>/etc/hyperledger/fabric/tls </span>    ports:
      -<span class="ruby"> <span class="hljs-number">9051</span><span class="hljs-symbol">:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-number">9052</span><span class="hljs-symbol">:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-number">9053</span><span class="hljs-symbol">:</span><span class="hljs-number">7053</span> </span>
  peer1.org2.example.com:
    container_name: peer1.org2.example.com
    extends:
      file: peer-base.yaml
      service: peer-base
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=peer1.org2.example.com </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer1.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_CHAINCODELISTENADDRESS</span>=peer1.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span>=peer1.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_BOOTSTRAP</span>=peer<span class="hljs-number">0</span>.org2.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org2MSP</span> </span>    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/<span class="hljs-symbol">msp:</span>/etc/hyperledger/fabric/msp </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/<span class="hljs-symbol">tls:</span>/etc/hyperledger/fabric/tls </span>    ports:
      -<span class="ruby"> <span class="hljs-number">10051</span><span class="hljs-symbol">:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-number">10052</span><span class="hljs-symbol">:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-number">10053</span><span class="hljs-symbol">:</span><span class="hljs-number">7053</span></span></code></pre> 
  <p>这个配置文件就比较明显了，<code>Orderer</code>和<code>peer</code>的配置文件，细心的你肯定也发现了<code>file: peer-base.yaml</code>，那就看看同目录下的<code>peer-base.yaml</code>文件吧。</p> 
  <pre class="prettyprint"><code class=" hljs haml"># Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#

version: '2'
services:
  peer-base:
    image: hyperledger/fabric-peer
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_VM_ENDPOINT</span>=<span class="hljs-symbol">unix:</span>/<span class="hljs-regexp">//host</span><span class="hljs-regexp">/var/run</span><span class="hljs-regexp">/docker.sock </span></span>      # the following setting starts chaincode containers on the same
      # bridge network as the peers
      # https://docs.docker.com/compose/networking/
      -<span class="ruby"> <span class="hljs-constant">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE</span>=e2ecli_default </span>      #- CORE_LOGGING_LEVEL=ERROR
      -<span class="ruby"> <span class="hljs-constant">CORE_LOGGING_LEVEL</span>=<span class="hljs-constant">DEBUG</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_USELEADERELECTION</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_ORGLEADER</span>=<span class="hljs-keyword">false</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_PROFILE_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_CERT_FILE</span>=<span class="hljs-regexp">/etc/hyperledger</span><span class="hljs-regexp">/fabric/tls</span><span class="hljs-regexp">/server.crt </span></span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_KEY_FILE</span>=<span class="hljs-regexp">/etc/hyperledger</span><span class="hljs-regexp">/fabric/tls</span><span class="hljs-regexp">/server.key </span></span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ROOTCERT_FILE</span>=<span class="hljs-regexp">/etc/hyperledger</span><span class="hljs-regexp">/fabric/tls</span><span class="hljs-regexp">/ca.crt </span></span>    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start</code></pre> 
  <p>这我就不多解释了。 <br> 最后还有一个文件，在刚才的<code>docker-compose-cli.yaml</code>文件中有一句<code>`command: /bin/bash -c './scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT'</code>什么意思呢？就是<code>./scripts/script.sh</code>这个shell脚本生效，一起去看看吧。</p> 
  <pre class="prettyprint"><code class=" hljs bash"><span class="hljs-shebang">#!/bin/bash</span>
<span class="hljs-comment"># Copyright London Stock Exchange Group All Rights Reserved.</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># SPDX-License-Identifier: Apache-2.0</span>
<span class="hljs-comment">#</span>
<span class="hljs-built_in">echo</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">" ____ _____ _ ____ _____ _____ ____ _____ "</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"/ ___| |_ _| / \ | _ \ |_ _| | ____| |___ \ | ____|"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"\___ \ | | / _ \ | |_) | | | _____ | _| __) | | _| "</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">" ___) | | | / ___ \ | _ &lt; | | |_____| | |___ / __/ | |___ "</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"|____/ |_| /_/ \_\ |_| \_\ |_| |_____| |_____| |_____|"</span>
<span class="hljs-built_in">echo</span>

CHANNEL_NAME=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
: <span class="hljs-variable">${CHANNEL_NAME:="mychannel"}</span>
: <span class="hljs-variable">${TIMEOUT:="60"}</span>
COUNTER=<span class="hljs-number">1</span>
MAX_RETRY=<span class="hljs-number">5</span>
ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Channel name : "</span><span class="hljs-variable">$CHANNEL_NAME</span>

<span class="hljs-function"><span class="hljs-title">verifyResult</span></span> () {
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span> ] ; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"!!!!!!!!!!!!!!! "</span><span class="hljs-variable">$2</span><span class="hljs-string">" !!!!!!!!!!!!!!!!"</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"================== ERROR !!! FAILED to execute End-2-End Scenario =================="</span>
        <span class="hljs-built_in">echo</span>
        <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">setGlobals</span></span> () {

    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> -o <span class="hljs-variable">$1</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">1</span> ] ; <span class="hljs-keyword">then</span>
        CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span>
        CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
        CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp
        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> ]; <span class="hljs-keyword">then</span>
            CORE_PEER_ADDRESS=peer0.org1.example.com:<span class="hljs-number">7051</span>
        <span class="hljs-keyword">else</span>
            CORE_PEER_ADDRESS=peer1.org1.example.com:<span class="hljs-number">7051</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span>
        CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
        CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$1</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">2</span> ]; <span class="hljs-keyword">then</span>
            CORE_PEER_ADDRESS=peer0.org2.example.com:<span class="hljs-number">7051</span>
        <span class="hljs-keyword">else</span>
            CORE_PEER_ADDRESS=peer1.org2.example.com:<span class="hljs-number">7051</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>

    env |grep CORE
}

<span class="hljs-function"><span class="hljs-title">createChannel</span></span>() {
    <span class="hljs-keyword">set</span>Globals <span class="hljs-number">0</span>

        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> = <span class="hljs-string">"false"</span> ]; <span class="hljs-keyword">then</span>
        peer channel create -o orderer.example.com:<span class="hljs-number">7050</span> -c <span class="hljs-variable">$CHANNEL_NAME</span> <span class="hljs-operator">-f</span> ./channel-artifacts/channel.tx &gt;&amp;log.txt
    <span class="hljs-keyword">else</span>
        peer channel create -o orderer.example.com:<span class="hljs-number">7050</span> -c <span class="hljs-variable">$CHANNEL_NAME</span> <span class="hljs-operator">-f</span> ./channel-artifacts/channel.tx --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> &gt;&amp;log.txt
    <span class="hljs-keyword">fi</span>
    res=$?
    cat log.txt
    verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">"Channel creation failed"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Channel \"<span class="hljs-variable">$CHANNEL_NAME</span>\" is created successfully ===================== "</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-function"><span class="hljs-title">updateAnchorPeers</span></span>() {
        PEER=<span class="hljs-variable">$1</span>
        <span class="hljs-keyword">set</span>Globals <span class="hljs-variable">$PEER</span>

        <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> = <span class="hljs-string">"false"</span> ]; <span class="hljs-keyword">then</span>
        peer channel update -o orderer.example.com:<span class="hljs-number">7050</span> -c <span class="hljs-variable">$CHANNEL_NAME</span> <span class="hljs-operator">-f</span> ./channel-artifacts/<span class="hljs-variable">${CORE_PEER_LOCALMSPID}</span>anchors.tx &gt;&amp;log.txt
    <span class="hljs-keyword">else</span>
        peer channel update -o orderer.example.com:<span class="hljs-number">7050</span> -c <span class="hljs-variable">$CHANNEL_NAME</span> <span class="hljs-operator">-f</span> ./channel-artifacts/<span class="hljs-variable">${CORE_PEER_LOCALMSPID}</span>anchors.tx --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> &gt;&amp;log.txt
    <span class="hljs-keyword">fi</span>
    res=$?
    cat log.txt
    verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">"Anchor peer update failed"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Anchor peers for org \"<span class="hljs-variable">$CORE_PEER_LOCALMSPID</span>\" on \"<span class="hljs-variable">$CHANNEL_NAME</span>\" is updated successfully ===================== "</span>
    sleep <span class="hljs-number">5</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment">## Sometimes Join takes time hence RETRY atleast for 5 times</span>
<span class="hljs-function"><span class="hljs-title">joinWithRetry</span></span> () {
    peer channel join -b <span class="hljs-variable">$CHANNEL_NAME</span>.block  &gt;&amp;log.txt
    res=$?
    cat log.txt
    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$res</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span> <span class="hljs-operator">-a</span> <span class="hljs-variable">$COUNTER</span> <span class="hljs-operator">-lt</span> <span class="hljs-variable">$MAX_RETRY</span> ]; <span class="hljs-keyword">then</span>
        COUNTER=` expr <span class="hljs-variable">$COUNTER</span> + <span class="hljs-number">1</span>`
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"PEER<span class="hljs-variable">$1</span> failed to join the channel, Retry after 2 seconds"</span>
        sleep <span class="hljs-number">2</span>
        joinWithRetry <span class="hljs-variable">$1</span>
    <span class="hljs-keyword">else</span>
        COUNTER=<span class="hljs-number">1</span>
    <span class="hljs-keyword">fi</span>
        verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">"After <span class="hljs-variable">$MAX_RETRY</span> attempts, PEER<span class="hljs-variable">$ch</span> has failed to Join the Channel"</span>
}

<span class="hljs-function"><span class="hljs-title">joinChannel</span></span> () {
    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">set</span>Globals <span class="hljs-variable">$ch</span>
        joinWithRetry <span class="hljs-variable">$ch</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== PEER<span class="hljs-variable">$ch</span> joined on the channel \"<span class="hljs-variable">$CHANNEL_NAME</span>\" ===================== "</span>
        sleep <span class="hljs-number">2</span>
        <span class="hljs-built_in">echo</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">installChaincode</span></span> () {
    PEER=<span class="hljs-variable">$1</span>
    <span class="hljs-keyword">set</span>Globals <span class="hljs-variable">$PEER</span>
    peer chaincode install -n mycc -v <span class="hljs-number">1.0</span> -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 &gt;&amp;log.txt
    res=$?
    cat log.txt
        verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">"Chaincode installation on remote peer PEER<span class="hljs-variable">$PEER</span> has Failed"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Chaincode is installed on remote peer PEER<span class="hljs-variable">$PEER</span> ===================== "</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-function"><span class="hljs-title">instantiateChaincode</span></span> () {
    PEER=<span class="hljs-variable">$1</span>
    <span class="hljs-keyword">set</span>Globals <span class="hljs-variable">$PEER</span>
    <span class="hljs-comment"># while 'peer chaincode' command can get the orderer endpoint from the peer (if join was successful),</span>
    <span class="hljs-comment"># lets supply it directly as we know it using the "-o" option</span>
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> = <span class="hljs-string">"false"</span> ]; <span class="hljs-keyword">then</span>
        peer chaincode instantiate -o orderer.example.com:<span class="hljs-number">7050</span> -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -v <span class="hljs-number">1.0</span> -c <span class="hljs-string">'{"Args":["init","a","100","b","200"]}'</span> -P <span class="hljs-string">"OR ('Org1MSP.member','Org2MSP.member')"</span> &gt;&amp;log.txt
    <span class="hljs-keyword">else</span>
        peer chaincode instantiate -o orderer.example.com:<span class="hljs-number">7050</span> --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -v <span class="hljs-number">1.0</span> -c <span class="hljs-string">'{"Args":["init","a","100","b","200"]}'</span> -P <span class="hljs-string">"OR ('Org1MSP.member','Org2MSP.member')"</span> &gt;&amp;log.txt
    <span class="hljs-keyword">fi</span>
    res=$?
    cat log.txt
    verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">"Chaincode instantiation on PEER<span class="hljs-variable">$PEER</span> on channel '<span class="hljs-variable">$CHANNEL_NAME</span>' failed"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Chaincode Instantiation on PEER<span class="hljs-variable">$PEER</span> on channel '<span class="hljs-variable">$CHANNEL_NAME</span>' is successful ===================== "</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-function"><span class="hljs-title">chaincodeQuery</span></span> () {
  PEER=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Querying on PEER<span class="hljs-variable">$PEER</span> on channel '<span class="hljs-variable">$CHANNEL_NAME</span>'... ===================== "</span>
  <span class="hljs-keyword">set</span>Globals <span class="hljs-variable">$PEER</span>
  local rc=<span class="hljs-number">1</span>
  local starttime=$(date +%s)

  <span class="hljs-comment"># continue to poll</span>
  <span class="hljs-comment"># we either get a successful response, or reach TIMEOUT</span>
  <span class="hljs-keyword">while</span> test <span class="hljs-string">"<span class="hljs-variable">$(($(date +%s)</span>-starttime))"</span> <span class="hljs-operator">-lt</span> <span class="hljs-string">"<span class="hljs-variable">$TIMEOUT</span>"</span> <span class="hljs-operator">-a</span> <span class="hljs-variable">$rc</span> <span class="hljs-operator">-ne</span> <span class="hljs-number">0</span>
  <span class="hljs-keyword">do</span>
     sleep <span class="hljs-number">3</span>
     <span class="hljs-built_in">echo</span> <span class="hljs-string">"Attempting to Query PEER<span class="hljs-variable">$PEER</span> ...<span class="hljs-variable">$(($(date +%s)</span>-starttime)) secs"</span>
     peer chaincode query -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -c <span class="hljs-string">'{"Args":["query","a"]}'</span> &gt;&amp;log.txt
     test $? <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> &amp;&amp; VALUE=$(cat log.txt | awk <span class="hljs-string">'/Query Result/ {print $NF}'</span>)
     test <span class="hljs-string">"<span class="hljs-variable">$VALUE</span>"</span> = <span class="hljs-string">"<span class="hljs-variable">$2</span>"</span> &amp;&amp; <span class="hljs-built_in">let</span> rc=<span class="hljs-number">0</span>
  <span class="hljs-keyword">done</span>
  <span class="hljs-built_in">echo</span>
  cat log.txt
  <span class="hljs-keyword">if</span> test <span class="hljs-variable">$rc</span> <span class="hljs-operator">-eq</span> <span class="hljs-number">0</span> ; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Query on PEER<span class="hljs-variable">$PEER</span> on channel '<span class="hljs-variable">$CHANNEL_NAME</span>' is successful ===================== "</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"!!!!!!!!!!!!!!! Query result on PEER<span class="hljs-variable">$PEER</span> is INVALID !!!!!!!!!!!!!!!!"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"================== ERROR !!! FAILED to execute End-2-End Scenario =================="</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">chaincodeInvoke</span></span> () {
    PEER=<span class="hljs-variable">$1</span>
    <span class="hljs-keyword">set</span>Globals <span class="hljs-variable">$PEER</span>
    <span class="hljs-comment"># while 'peer chaincode' command can get the orderer endpoint from the peer (if join was successful),</span>
    <span class="hljs-comment"># lets supply it directly as we know it using the "-o" option</span>
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> -o <span class="hljs-string">"<span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span>"</span> = <span class="hljs-string">"false"</span> ]; <span class="hljs-keyword">then</span>
        peer chaincode invoke -o orderer.example.com:<span class="hljs-number">7050</span> -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -c <span class="hljs-string">'{"Args":["invoke","a","b","10"]}'</span> &gt;&amp;log.txt
    <span class="hljs-keyword">else</span>
        peer chaincode invoke -o orderer.example.com:<span class="hljs-number">7050</span>  --tls <span class="hljs-variable">$CORE_PEER_TLS_ENABLED</span> --cafile <span class="hljs-variable">$ORDERER_CA</span> -C <span class="hljs-variable">$CHANNEL_NAME</span> -n mycc -c <span class="hljs-string">'{"Args":["invoke","a","b","10"]}'</span> &gt;&amp;log.txt
    <span class="hljs-keyword">fi</span>
    res=$?
    cat log.txt
    verifyResult <span class="hljs-variable">$res</span> <span class="hljs-string">"Invoke execution on PEER<span class="hljs-variable">$PEER</span> failed "</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== Invoke transaction on PEER<span class="hljs-variable">$PEER</span> on channel '<span class="hljs-variable">$CHANNEL_NAME</span>' is successful ===================== "</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment">## Create channel</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Creating channel..."</span>
createChannel

<span class="hljs-comment">## Join all the peers to the channel</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Having all peers join the channel..."</span>
joinChannel

<span class="hljs-comment">## Set the anchor peers for each org in the channel</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Updating anchor peers for org1..."</span>
updateAnchorPeers <span class="hljs-number">0</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Updating anchor peers for org2..."</span>
updateAnchorPeers <span class="hljs-number">2</span>

<span class="hljs-comment">## Install chaincode on Peer0/Org1 and Peer2/Org2</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Installing chaincode on org1/peer0..."</span>
installChaincode <span class="hljs-number">0</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Install chaincode on org2/peer2..."</span>
installChaincode <span class="hljs-number">2</span>

<span class="hljs-comment">#Instantiate chaincode on Peer2/Org2</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Instantiating chaincode on org2/peer2..."</span>
instantiateChaincode <span class="hljs-number">2</span>

<span class="hljs-comment">#Query on chaincode on Peer0/Org1</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Querying chaincode on org1/peer0..."</span>
chaincodeQuery <span class="hljs-number">0</span> <span class="hljs-number">100</span>

<span class="hljs-comment">#Invoke on chaincode on Peer0/Org1</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Sending invoke transaction on org1/peer0..."</span>
chaincodeInvoke <span class="hljs-number">0</span>

<span class="hljs-comment">## Install chaincode on Peer3/Org2</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Installing chaincode on org2/peer3..."</span>
installChaincode <span class="hljs-number">3</span>

<span class="hljs-comment">#Query on chaincode on Peer3/Org2, check if the result is 90</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Querying chaincode on org2/peer3..."</span>
chaincodeQuery <span class="hljs-number">3</span> <span class="hljs-number">90</span>

<span class="hljs-built_in">echo</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"===================== All GOOD, End-2-End execution completed ===================== "</span>
<span class="hljs-built_in">echo</span>

<span class="hljs-built_in">echo</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">" _____ _ _ ____ _____ ____ _____ "</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"| ____| | \ | | | _ \ | ____| |___ \ | ____|"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"| _| | \| | | | | | _____ | _| __) | | _| "</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"| |___ | |\ | | |_| | |_____| | |___ / __/ | |___ "</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"|_____| |_| \_| |____/ |_____| |_____| |_____|"</span>
<span class="hljs-built_in">echo</span>

<span class="hljs-keyword">exit</span> <span class="hljs-number">0</span></code></pre> 
  <p>我觉得终于到了你最希望看得的地方了，对于初学者而言的我们，看到<code>good</code>的时候就会心情很好，对吧？前面都为我们准备好了各节点，创世块，证书等内容！在这里这个文件为我们创建通道并且让各<code>peer</code>节点加入通道，安装、初始化、query准备好的<code>chaincode</code>！下图就是大致过程。 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180317152157770?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2NzQyMTg2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 文件夹下还有许多的其他配置文件，其中如图。 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180317152609657?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2NzQyMTg2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 下面用一张图总结一下： <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180317155346814?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3NpbmF0XzM2NzQyMTg2/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 大致过程基本如上，但感觉还差了一点什么！批评指正，批评指正！</p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sinat_36742186/article/details/79588804,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sinat_36742186/article/details/79588804,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
