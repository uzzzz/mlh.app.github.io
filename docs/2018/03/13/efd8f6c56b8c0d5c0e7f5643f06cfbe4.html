<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>以太坊智能合约DAPP区块链开发 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="以太坊智能合约DAPP区块链开发" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="作者也是刚入坑的小白，查看了网上很多示例也踩了很多坑，现将自己实际部署的情况总结如下，亲测有效： 机器环境为： &nbsp;&nbsp;&nbsp;&nbsp;Ubuntu 14.04.5 &nbsp; &nbsp; Node (v9.0.0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; Truffle&nbsp; &nbsp; &nbsp; Ganache &nbsp; &nbsp; npm (5.3.0) 在搭建智能合约之前需要提前安装好Node、Truffle 、Ganache、npm等需要的软件。 展示效果 部署好之后就可以领养狗狗，效果图如下： 项目背景 &nbsp;&nbsp;&nbsp;&nbsp;Pete有一个宠物店，他想开发一个去中心化应用，让大家来领养宠物。在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。有关truffle box可在github上可以找到相应的相应的源代码信息https://github.com/truffle-box/pet-shop-box 环境搭建 安装Node 安装 Truffle ：npm install -g truffle 安装Ganache Ganache（或Ganache CLI）已经取代了 testrpc。 创建项目 建立项目目录并进入 12 &gt; mkdir pet-shop-tutorial&gt; cd pet-shop-tutorial 使用truffle unbox 创建项目 123456789101112 &gt; truffle unbox pet-shop Downloading... Unpacking... Setting up... Unbox successful. Sweet!Commands: &nbsp;Compile: &nbsp; &nbsp; &nbsp; &nbsp;truffle compile &nbsp;Migrate: &nbsp; &nbsp; &nbsp; &nbsp;truffle migrate &nbsp;Test contracts: truffle test &nbsp;Run dev server: npm run dev 这一步需要等待一会 也可以使用truffle init 来创建一个全新的项目。 项目目录结构 contracts/&nbsp;智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲）migrations/&nbsp;用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。test/&nbsp;智能合约测试用例文件夹truffle.js/&nbsp;配置文件 其他代码可以暂时不用管 编写智能合约 智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读[solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/） 在contracts目录下，添加合约文件Adoption.sol 1234567891011121314151617181920 pragma solidity ^0.4.17;contract Adoption { &nbsp;address[16] public adopters; &nbsp;// 保存领养者的地址 &nbsp; &nbsp;// 领养宠物 &nbsp;function adopt(uint petId) public returns (uint) { &nbsp; &nbsp;require(petId &gt;= 0 &amp;&amp; petId &lt;= 15); &nbsp;// 确保id在数组长度内 &nbsp; &nbsp;adopters[petId] = msg.sender; &nbsp; &nbsp; &nbsp; &nbsp;// 保存调用这地址 &nbsp; &nbsp;return petId; &nbsp;} &nbsp;// 返回领养者 &nbsp;function getAdopters() public view returns (address[16]) { &nbsp; &nbsp;return adopters; &nbsp;}} 编译部署智能合约 Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。 编译 Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。dapp的根目录pet-shop-tutorial下， 1 &gt; truffle compile 输出 12 Compiling ./contracts/Adoption.sol...Writing artifacts to ./build/contracts 部署 编译之后，就可以部署到区块链上。在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。Migrations.sol 用来确保不会部署相同的合约。 现在我们来创建一个自己的部署脚本2_deploy_contracts.js 12345 var Adoption = artifacts.require(&quot;Adoption&quot;);module.exports = function(deployer) { &nbsp;deployer.deploy(Adoption);}; 在执行部署之前，需要确保有一个区块链运行, 可以使用 Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 Ganache 启动之后是这样： 接下来执行部署命令: 1 &gt; truffle &nbsp;migrate 执行后，有一下类似的输出， 12345678910111213141516 Using network &#39;develop&#39;.Running migration: 1_initial_migration.js &nbsp;Deploying Migrations... &nbsp;... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f &nbsp;Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0Saving successful migration to network... &nbsp;... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956Saving artifacts...Running migration: 2_deploy_contracts.js &nbsp;Deploying Adoption... &nbsp;... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4 &nbsp;Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10Saving successful migration to network... &nbsp;... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0Saving artifacts... 在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 这时说明已经智能合约已经部署好了。 也可以直接下载liunx版本的ganache-cli ，直接启动ganache-cli，会生成10个账户，为私有链，账户中有100ETH的余额。执行界面如下： 接下来执行部署命令: 1 &gt; truffle &nbsp;migrate 执行结果和上面相同，生成4个区块。 测试 现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。 在test目录下新建一个TestAdoption.sol，编写测试合约 12345678910111213141516171819202122232425262728293031323334 pragma solidity ^0.4.17;import &quot;truffle/Assert.sol&quot;; &nbsp; // 引入的断言import &quot;truffle/DeployedAddresses.sol&quot;; &nbsp;// 用来获取被测试合约的地址import &quot;../contracts/Adoption.sol&quot;; &nbsp; &nbsp; &nbsp;// 被测试合约contract TestAdoption { &nbsp;Adoption adoption = Adoption(DeployedAddresses.Adoption()); &nbsp;// 领养测试用例 &nbsp;function testUserCanAdoptPet() public { &nbsp; &nbsp;uint returnedId = adoption.adopt(8); &nbsp; &nbsp;uint expected = 8; &nbsp; &nbsp;Assert.equal(returnedId, expected, &quot;Adoption of pet ID 8 should be recorded.&quot;); &nbsp;} &nbsp;// 宠物所有者测试用例 &nbsp;function testGetAdopterAddressByPetId() public { &nbsp; &nbsp;// 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易， &nbsp; &nbsp;address expected = this; &nbsp; &nbsp;address adopter = adoption.adopters(8); &nbsp; &nbsp;Assert.equal(adopter, expected, &quot;Owner of pet ID 8 should be recorded.&quot;); &nbsp;} &nbsp; &nbsp;// 测试所有领养者 &nbsp;function testGetAdopterAddressByPetIdInArray() public { &nbsp;// 领养者的地址就是本合约地址 &nbsp; &nbsp;address expected = this; &nbsp; &nbsp;address[16] memory adopters = adoption.getAdopters(); &nbsp; &nbsp;Assert.equal(adopters[8], expected, &quot;Owner of pet ID 8 should be recorded.&quot;); &nbsp;}} Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。 TestAdoption合约中添加adopt的测试用例 运行测试用例 在终端中，执行 1 truffle test 如果测试通过，则终端输出： 123456789101112131415 Using network &#39;develop&#39;.Compiling ./contracts/Adoption.sol...Compiling ./test/TestAdoption.sol...Compiling truffle/Assert.sol...Compiling truffle/DeployedAddresses.sol... &nbsp;TestAdoption &nbsp; &nbsp;✓ testUserCanAdoptPet (62ms) &nbsp; &nbsp;✓ testGetAdopterAddressByPetId (53ms) &nbsp; &nbsp;✓ testGetAdopterAddressByPetIdInArray (73ms) &nbsp;3 passing (554ms) 创建用户接口和智能合约交互 我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。 在Truffle Box&nbsp;pet-shop里，已经包含了应用的前端代码，代码在src/文件夹下。 在编辑器中打开src/js/app.js可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3.web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。 初始化web3 接下来，我们来编辑app.js修改initWeb3():删除注释，修改为： 123456789101112 initWeb3: function() { &nbsp;// Is there an injected web3 instance? &nbsp;if (typeof web3 !== &#39;undefined&#39;) { &nbsp; &nbsp;App.web3Provider = web3.currentProvider; &nbsp;} else { &nbsp; &nbsp;// If no injected web3 instance is detected, fall back to Ganache &nbsp; &nbsp;App.web3Provider = new Web3.providers.HttpProvider(&#39;http://localhost:7545&#39;); &nbsp;} &nbsp;web3 = new Web3(App.web3Provider); &nbsp;return App.initContract();} 代码中优先使用Mist&nbsp;或&nbsp;MetaMask提供的web3实例，如果没有则从本地环境创建一个。 实例化合约 使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下： 123456789101112131415 initContract: function() { &nbsp;// 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息 &nbsp;$.getJSON(&#39;Adoption.json&#39;, function(data) { &nbsp; &nbsp;// 用Adoption.json数据创建一个可交互的TruffleContract合约实例。 &nbsp; &nbsp;var AdoptionArtifact = data; &nbsp; &nbsp;App.contracts.Adoption = TruffleContract(AdoptionArtifact); &nbsp; &nbsp;// Set the provider for our contract &nbsp; &nbsp;App.contracts.Adoption.setProvider(App.web3Provider); &nbsp; &nbsp;// Use our contract to retrieve and mark the adopted pets &nbsp; &nbsp;return App.markAdopted(); &nbsp;}); &nbsp;return App.bindEvents();} 处理领养 修改markAdopted()代码： 123456789101112131415161718 markAdopted: function(adopters, account) { &nbsp;var adoptionInstance; &nbsp;App.contracts.Adoption.deployed().then(function(instance) { &nbsp; &nbsp;adoptionInstance = instance; &nbsp; &nbsp;// 调用合约的getAdopters(), 用call读取信息不用消耗gas &nbsp; &nbsp;return adoptionInstance.getAdopters.call(); &nbsp;}).then(function(adopters) { &nbsp; &nbsp;for (i = 0; i &lt; adopters.length; i++) { &nbsp; &nbsp; &nbsp;if (adopters[i] !== &#39;0x0000000000000000000000000000000000000000&#39;) { &nbsp; &nbsp; &nbsp; &nbsp;$(&#39;.panel-pet&#39;).eq(i).find(&#39;button&#39;).text(&#39;Success&#39;).attr(&#39;disabled&#39;, true); &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp;}).catch(function(err) { &nbsp; &nbsp;console.log(err.message); &nbsp;});} 修改handleAdopt()代码： 123456789101112131415161718192021222324252627 handleAdopt: function(event) { &nbsp;event.preventDefault(); &nbsp;var petId = parseInt($(event.target).data(&#39;id&#39;)); &nbsp;var adoptionInstance; &nbsp;// 获取用户账号 &nbsp;web3.eth.getAccounts(function(error, accounts) { &nbsp; &nbsp;if (error) { &nbsp; &nbsp; &nbsp;console.log(error); &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp;var account = accounts[0]; &nbsp; &nbsp; &nbsp;App.contracts.Adoption.deployed().then(function(instance) { &nbsp; &nbsp; &nbsp;adoptionInstance = instance; &nbsp; &nbsp; &nbsp; &nbsp;// 发送交易领养宠物 &nbsp; &nbsp; &nbsp;return adoptionInstance.adopt(petId, {from: account}); &nbsp; &nbsp;}).then(function(result) { &nbsp; &nbsp; &nbsp;return App.markAdopted(); &nbsp; &nbsp;}).catch(function(err) { &nbsp; &nbsp; &nbsp;console.log(err.message); &nbsp; &nbsp;}); &nbsp;});} 在浏览器中运行 安装 MetaMask MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。 配置钱包 在接受隐私说明后，会出现页面如下：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的Import Existing DEN，输入Ganache显示的助记词。 1 candy maple cake sugar pudding cream honey rich smooth crumble sweet treat 然后自己想要的密码，点击OK。如图：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 连接开发区块链网络 默认连接的是以太坊主网（左上角显示），选择Custom RPC，添加一个网络：http://127.0.0.1:7545 （这里替换成自己的IP的端口）点返回后，显示如下：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这是左上角显示为Private Network，账号是Ganache中默认的第一个账号。 如要替换账号点击右上角的圆圈，然后点击Import Account ，将Ganache生成的私钥(Private Keys)填写即可。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 至此MetaMask的安装，配置已经完成。 安装和配置lite-server 接下来需要本地的web 服务器提供服务的访问， Truffle Box&nbsp;pet-shop里提供了一个lite-server可以直接使用，我们看看它是如何工作的。bs-config.json指示了lite-server的工作目录。 12345 { &nbsp;&quot;server&quot;: { &nbsp; &nbsp;&quot;baseDir&quot;: [&quot;./src&quot;, &quot;./build/contracts&quot;] &nbsp;}} ./src 是网站文件目录./build/contracts 是合约输出目录 以此同时，在package.json文件的scripts中添加了dev命令： 1234 &quot;scripts&quot;: { &nbsp;&quot;dev&quot;: &quot;lite-server&quot;, &nbsp;&quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;}, 当运行npm run dev的时候，就会启动lite-server 启动服务 1 &gt; npm run dev 会自动打开浏览器显示我们的dapp，如本文的第一张图。 现在领养一直宠物看看，当我们点击Adopt时，MetaMask会提示我们交易的确认，如图： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 点击Submit确认后，就可以看到成功领养了这次宠物。 在MetaMask中，也可以看到交易的清单：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 到这一步，智能合约已经部署完成。 阅读更多" />
<meta property="og:description" content="作者也是刚入坑的小白，查看了网上很多示例也踩了很多坑，现将自己实际部署的情况总结如下，亲测有效： 机器环境为： &nbsp;&nbsp;&nbsp;&nbsp;Ubuntu 14.04.5 &nbsp; &nbsp; Node (v9.0.0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; Truffle&nbsp; &nbsp; &nbsp; Ganache &nbsp; &nbsp; npm (5.3.0) 在搭建智能合约之前需要提前安装好Node、Truffle 、Ganache、npm等需要的软件。 展示效果 部署好之后就可以领养狗狗，效果图如下： 项目背景 &nbsp;&nbsp;&nbsp;&nbsp;Pete有一个宠物店，他想开发一个去中心化应用，让大家来领养宠物。在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。有关truffle box可在github上可以找到相应的相应的源代码信息https://github.com/truffle-box/pet-shop-box 环境搭建 安装Node 安装 Truffle ：npm install -g truffle 安装Ganache Ganache（或Ganache CLI）已经取代了 testrpc。 创建项目 建立项目目录并进入 12 &gt; mkdir pet-shop-tutorial&gt; cd pet-shop-tutorial 使用truffle unbox 创建项目 123456789101112 &gt; truffle unbox pet-shop Downloading... Unpacking... Setting up... Unbox successful. Sweet!Commands: &nbsp;Compile: &nbsp; &nbsp; &nbsp; &nbsp;truffle compile &nbsp;Migrate: &nbsp; &nbsp; &nbsp; &nbsp;truffle migrate &nbsp;Test contracts: truffle test &nbsp;Run dev server: npm run dev 这一步需要等待一会 也可以使用truffle init 来创建一个全新的项目。 项目目录结构 contracts/&nbsp;智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲）migrations/&nbsp;用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。test/&nbsp;智能合约测试用例文件夹truffle.js/&nbsp;配置文件 其他代码可以暂时不用管 编写智能合约 智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读[solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/） 在contracts目录下，添加合约文件Adoption.sol 1234567891011121314151617181920 pragma solidity ^0.4.17;contract Adoption { &nbsp;address[16] public adopters; &nbsp;// 保存领养者的地址 &nbsp; &nbsp;// 领养宠物 &nbsp;function adopt(uint petId) public returns (uint) { &nbsp; &nbsp;require(petId &gt;= 0 &amp;&amp; petId &lt;= 15); &nbsp;// 确保id在数组长度内 &nbsp; &nbsp;adopters[petId] = msg.sender; &nbsp; &nbsp; &nbsp; &nbsp;// 保存调用这地址 &nbsp; &nbsp;return petId; &nbsp;} &nbsp;// 返回领养者 &nbsp;function getAdopters() public view returns (address[16]) { &nbsp; &nbsp;return adopters; &nbsp;}} 编译部署智能合约 Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。 编译 Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。dapp的根目录pet-shop-tutorial下， 1 &gt; truffle compile 输出 12 Compiling ./contracts/Adoption.sol...Writing artifacts to ./build/contracts 部署 编译之后，就可以部署到区块链上。在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。Migrations.sol 用来确保不会部署相同的合约。 现在我们来创建一个自己的部署脚本2_deploy_contracts.js 12345 var Adoption = artifacts.require(&quot;Adoption&quot;);module.exports = function(deployer) { &nbsp;deployer.deploy(Adoption);}; 在执行部署之前，需要确保有一个区块链运行, 可以使用 Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 Ganache 启动之后是这样： 接下来执行部署命令: 1 &gt; truffle &nbsp;migrate 执行后，有一下类似的输出， 12345678910111213141516 Using network &#39;develop&#39;.Running migration: 1_initial_migration.js &nbsp;Deploying Migrations... &nbsp;... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f &nbsp;Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0Saving successful migration to network... &nbsp;... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956Saving artifacts...Running migration: 2_deploy_contracts.js &nbsp;Deploying Adoption... &nbsp;... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4 &nbsp;Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10Saving successful migration to network... &nbsp;... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0Saving artifacts... 在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 这时说明已经智能合约已经部署好了。 也可以直接下载liunx版本的ganache-cli ，直接启动ganache-cli，会生成10个账户，为私有链，账户中有100ETH的余额。执行界面如下： 接下来执行部署命令: 1 &gt; truffle &nbsp;migrate 执行结果和上面相同，生成4个区块。 测试 现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。 在test目录下新建一个TestAdoption.sol，编写测试合约 12345678910111213141516171819202122232425262728293031323334 pragma solidity ^0.4.17;import &quot;truffle/Assert.sol&quot;; &nbsp; // 引入的断言import &quot;truffle/DeployedAddresses.sol&quot;; &nbsp;// 用来获取被测试合约的地址import &quot;../contracts/Adoption.sol&quot;; &nbsp; &nbsp; &nbsp;// 被测试合约contract TestAdoption { &nbsp;Adoption adoption = Adoption(DeployedAddresses.Adoption()); &nbsp;// 领养测试用例 &nbsp;function testUserCanAdoptPet() public { &nbsp; &nbsp;uint returnedId = adoption.adopt(8); &nbsp; &nbsp;uint expected = 8; &nbsp; &nbsp;Assert.equal(returnedId, expected, &quot;Adoption of pet ID 8 should be recorded.&quot;); &nbsp;} &nbsp;// 宠物所有者测试用例 &nbsp;function testGetAdopterAddressByPetId() public { &nbsp; &nbsp;// 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易， &nbsp; &nbsp;address expected = this; &nbsp; &nbsp;address adopter = adoption.adopters(8); &nbsp; &nbsp;Assert.equal(adopter, expected, &quot;Owner of pet ID 8 should be recorded.&quot;); &nbsp;} &nbsp; &nbsp;// 测试所有领养者 &nbsp;function testGetAdopterAddressByPetIdInArray() public { &nbsp;// 领养者的地址就是本合约地址 &nbsp; &nbsp;address expected = this; &nbsp; &nbsp;address[16] memory adopters = adoption.getAdopters(); &nbsp; &nbsp;Assert.equal(adopters[8], expected, &quot;Owner of pet ID 8 should be recorded.&quot;); &nbsp;}} Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。 TestAdoption合约中添加adopt的测试用例 运行测试用例 在终端中，执行 1 truffle test 如果测试通过，则终端输出： 123456789101112131415 Using network &#39;develop&#39;.Compiling ./contracts/Adoption.sol...Compiling ./test/TestAdoption.sol...Compiling truffle/Assert.sol...Compiling truffle/DeployedAddresses.sol... &nbsp;TestAdoption &nbsp; &nbsp;✓ testUserCanAdoptPet (62ms) &nbsp; &nbsp;✓ testGetAdopterAddressByPetId (53ms) &nbsp; &nbsp;✓ testGetAdopterAddressByPetIdInArray (73ms) &nbsp;3 passing (554ms) 创建用户接口和智能合约交互 我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。 在Truffle Box&nbsp;pet-shop里，已经包含了应用的前端代码，代码在src/文件夹下。 在编辑器中打开src/js/app.js可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3.web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。 初始化web3 接下来，我们来编辑app.js修改initWeb3():删除注释，修改为： 123456789101112 initWeb3: function() { &nbsp;// Is there an injected web3 instance? &nbsp;if (typeof web3 !== &#39;undefined&#39;) { &nbsp; &nbsp;App.web3Provider = web3.currentProvider; &nbsp;} else { &nbsp; &nbsp;// If no injected web3 instance is detected, fall back to Ganache &nbsp; &nbsp;App.web3Provider = new Web3.providers.HttpProvider(&#39;http://localhost:7545&#39;); &nbsp;} &nbsp;web3 = new Web3(App.web3Provider); &nbsp;return App.initContract();} 代码中优先使用Mist&nbsp;或&nbsp;MetaMask提供的web3实例，如果没有则从本地环境创建一个。 实例化合约 使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下： 123456789101112131415 initContract: function() { &nbsp;// 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息 &nbsp;$.getJSON(&#39;Adoption.json&#39;, function(data) { &nbsp; &nbsp;// 用Adoption.json数据创建一个可交互的TruffleContract合约实例。 &nbsp; &nbsp;var AdoptionArtifact = data; &nbsp; &nbsp;App.contracts.Adoption = TruffleContract(AdoptionArtifact); &nbsp; &nbsp;// Set the provider for our contract &nbsp; &nbsp;App.contracts.Adoption.setProvider(App.web3Provider); &nbsp; &nbsp;// Use our contract to retrieve and mark the adopted pets &nbsp; &nbsp;return App.markAdopted(); &nbsp;}); &nbsp;return App.bindEvents();} 处理领养 修改markAdopted()代码： 123456789101112131415161718 markAdopted: function(adopters, account) { &nbsp;var adoptionInstance; &nbsp;App.contracts.Adoption.deployed().then(function(instance) { &nbsp; &nbsp;adoptionInstance = instance; &nbsp; &nbsp;// 调用合约的getAdopters(), 用call读取信息不用消耗gas &nbsp; &nbsp;return adoptionInstance.getAdopters.call(); &nbsp;}).then(function(adopters) { &nbsp; &nbsp;for (i = 0; i &lt; adopters.length; i++) { &nbsp; &nbsp; &nbsp;if (adopters[i] !== &#39;0x0000000000000000000000000000000000000000&#39;) { &nbsp; &nbsp; &nbsp; &nbsp;$(&#39;.panel-pet&#39;).eq(i).find(&#39;button&#39;).text(&#39;Success&#39;).attr(&#39;disabled&#39;, true); &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp;}).catch(function(err) { &nbsp; &nbsp;console.log(err.message); &nbsp;});} 修改handleAdopt()代码： 123456789101112131415161718192021222324252627 handleAdopt: function(event) { &nbsp;event.preventDefault(); &nbsp;var petId = parseInt($(event.target).data(&#39;id&#39;)); &nbsp;var adoptionInstance; &nbsp;// 获取用户账号 &nbsp;web3.eth.getAccounts(function(error, accounts) { &nbsp; &nbsp;if (error) { &nbsp; &nbsp; &nbsp;console.log(error); &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp;var account = accounts[0]; &nbsp; &nbsp; &nbsp;App.contracts.Adoption.deployed().then(function(instance) { &nbsp; &nbsp; &nbsp;adoptionInstance = instance; &nbsp; &nbsp; &nbsp; &nbsp;// 发送交易领养宠物 &nbsp; &nbsp; &nbsp;return adoptionInstance.adopt(petId, {from: account}); &nbsp; &nbsp;}).then(function(result) { &nbsp; &nbsp; &nbsp;return App.markAdopted(); &nbsp; &nbsp;}).catch(function(err) { &nbsp; &nbsp; &nbsp;console.log(err.message); &nbsp; &nbsp;}); &nbsp;});} 在浏览器中运行 安装 MetaMask MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。 配置钱包 在接受隐私说明后，会出现页面如下：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的Import Existing DEN，输入Ganache显示的助记词。 1 candy maple cake sugar pudding cream honey rich smooth crumble sweet treat 然后自己想要的密码，点击OK。如图：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 连接开发区块链网络 默认连接的是以太坊主网（左上角显示），选择Custom RPC，添加一个网络：http://127.0.0.1:7545 （这里替换成自己的IP的端口）点返回后，显示如下：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这是左上角显示为Private Network，账号是Ganache中默认的第一个账号。 如要替换账号点击右上角的圆圈，然后点击Import Account ，将Ganache生成的私钥(Private Keys)填写即可。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 至此MetaMask的安装，配置已经完成。 安装和配置lite-server 接下来需要本地的web 服务器提供服务的访问， Truffle Box&nbsp;pet-shop里提供了一个lite-server可以直接使用，我们看看它是如何工作的。bs-config.json指示了lite-server的工作目录。 12345 { &nbsp;&quot;server&quot;: { &nbsp; &nbsp;&quot;baseDir&quot;: [&quot;./src&quot;, &quot;./build/contracts&quot;] &nbsp;}} ./src 是网站文件目录./build/contracts 是合约输出目录 以此同时，在package.json文件的scripts中添加了dev命令： 1234 &quot;scripts&quot;: { &nbsp;&quot;dev&quot;: &quot;lite-server&quot;, &nbsp;&quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;}, 当运行npm run dev的时候，就会启动lite-server 启动服务 1 &gt; npm run dev 会自动打开浏览器显示我们的dapp，如本文的第一张图。 现在领养一直宠物看看，当我们点击Adopt时，MetaMask会提示我们交易的确认，如图： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 点击Submit确认后，就可以看到成功领养了这次宠物。 在MetaMask中，也可以看到交易的清单：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 到这一步，智能合约已经部署完成。 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/03/13/efd8f6c56b8c0d5c0e7f5643f06cfbe4.html" />
<meta property="og:url" content="https://mlh.app/2018/03/13/efd8f6c56b8c0d5c0e7f5643f06cfbe4.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-03-13T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"作者也是刚入坑的小白，查看了网上很多示例也踩了很多坑，现将自己实际部署的情况总结如下，亲测有效： 机器环境为： &nbsp;&nbsp;&nbsp;&nbsp;Ubuntu 14.04.5 &nbsp; &nbsp; Node (v9.0.0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; Truffle&nbsp; &nbsp; &nbsp; Ganache &nbsp; &nbsp; npm (5.3.0) 在搭建智能合约之前需要提前安装好Node、Truffle 、Ganache、npm等需要的软件。 展示效果 部署好之后就可以领养狗狗，效果图如下： 项目背景 &nbsp;&nbsp;&nbsp;&nbsp;Pete有一个宠物店，他想开发一个去中心化应用，让大家来领养宠物。在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。有关truffle box可在github上可以找到相应的相应的源代码信息https://github.com/truffle-box/pet-shop-box 环境搭建 安装Node 安装 Truffle ：npm install -g truffle 安装Ganache Ganache（或Ganache CLI）已经取代了 testrpc。 创建项目 建立项目目录并进入 12 &gt; mkdir pet-shop-tutorial&gt; cd pet-shop-tutorial 使用truffle unbox 创建项目 123456789101112 &gt; truffle unbox pet-shop Downloading... Unpacking... Setting up... Unbox successful. Sweet!Commands: &nbsp;Compile: &nbsp; &nbsp; &nbsp; &nbsp;truffle compile &nbsp;Migrate: &nbsp; &nbsp; &nbsp; &nbsp;truffle migrate &nbsp;Test contracts: truffle test &nbsp;Run dev server: npm run dev 这一步需要等待一会 也可以使用truffle init 来创建一个全新的项目。 项目目录结构 contracts/&nbsp;智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲）migrations/&nbsp;用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。test/&nbsp;智能合约测试用例文件夹truffle.js/&nbsp;配置文件 其他代码可以暂时不用管 编写智能合约 智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读[solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/） 在contracts目录下，添加合约文件Adoption.sol 1234567891011121314151617181920 pragma solidity ^0.4.17;contract Adoption { &nbsp;address[16] public adopters; &nbsp;// 保存领养者的地址 &nbsp; &nbsp;// 领养宠物 &nbsp;function adopt(uint petId) public returns (uint) { &nbsp; &nbsp;require(petId &gt;= 0 &amp;&amp; petId &lt;= 15); &nbsp;// 确保id在数组长度内 &nbsp; &nbsp;adopters[petId] = msg.sender; &nbsp; &nbsp; &nbsp; &nbsp;// 保存调用这地址 &nbsp; &nbsp;return petId; &nbsp;} &nbsp;// 返回领养者 &nbsp;function getAdopters() public view returns (address[16]) { &nbsp; &nbsp;return adopters; &nbsp;}} 编译部署智能合约 Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。 编译 Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。dapp的根目录pet-shop-tutorial下， 1 &gt; truffle compile 输出 12 Compiling ./contracts/Adoption.sol...Writing artifacts to ./build/contracts 部署 编译之后，就可以部署到区块链上。在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。Migrations.sol 用来确保不会部署相同的合约。 现在我们来创建一个自己的部署脚本2_deploy_contracts.js 12345 var Adoption = artifacts.require(&quot;Adoption&quot;);module.exports = function(deployer) { &nbsp;deployer.deploy(Adoption);}; 在执行部署之前，需要确保有一个区块链运行, 可以使用 Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 Ganache 启动之后是这样： 接下来执行部署命令: 1 &gt; truffle &nbsp;migrate 执行后，有一下类似的输出， 12345678910111213141516 Using network &#39;develop&#39;.Running migration: 1_initial_migration.js &nbsp;Deploying Migrations... &nbsp;... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f &nbsp;Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0Saving successful migration to network... &nbsp;... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956Saving artifacts...Running migration: 2_deploy_contracts.js &nbsp;Deploying Adoption... &nbsp;... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4 &nbsp;Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10Saving successful migration to network... &nbsp;... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0Saving artifacts... 在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 这时说明已经智能合约已经部署好了。 也可以直接下载liunx版本的ganache-cli ，直接启动ganache-cli，会生成10个账户，为私有链，账户中有100ETH的余额。执行界面如下： 接下来执行部署命令: 1 &gt; truffle &nbsp;migrate 执行结果和上面相同，生成4个区块。 测试 现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。 在test目录下新建一个TestAdoption.sol，编写测试合约 12345678910111213141516171819202122232425262728293031323334 pragma solidity ^0.4.17;import &quot;truffle/Assert.sol&quot;; &nbsp; // 引入的断言import &quot;truffle/DeployedAddresses.sol&quot;; &nbsp;// 用来获取被测试合约的地址import &quot;../contracts/Adoption.sol&quot;; &nbsp; &nbsp; &nbsp;// 被测试合约contract TestAdoption { &nbsp;Adoption adoption = Adoption(DeployedAddresses.Adoption()); &nbsp;// 领养测试用例 &nbsp;function testUserCanAdoptPet() public { &nbsp; &nbsp;uint returnedId = adoption.adopt(8); &nbsp; &nbsp;uint expected = 8; &nbsp; &nbsp;Assert.equal(returnedId, expected, &quot;Adoption of pet ID 8 should be recorded.&quot;); &nbsp;} &nbsp;// 宠物所有者测试用例 &nbsp;function testGetAdopterAddressByPetId() public { &nbsp; &nbsp;// 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易， &nbsp; &nbsp;address expected = this; &nbsp; &nbsp;address adopter = adoption.adopters(8); &nbsp; &nbsp;Assert.equal(adopter, expected, &quot;Owner of pet ID 8 should be recorded.&quot;); &nbsp;} &nbsp; &nbsp;// 测试所有领养者 &nbsp;function testGetAdopterAddressByPetIdInArray() public { &nbsp;// 领养者的地址就是本合约地址 &nbsp; &nbsp;address expected = this; &nbsp; &nbsp;address[16] memory adopters = adoption.getAdopters(); &nbsp; &nbsp;Assert.equal(adopters[8], expected, &quot;Owner of pet ID 8 should be recorded.&quot;); &nbsp;}} Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。 TestAdoption合约中添加adopt的测试用例 运行测试用例 在终端中，执行 1 truffle test 如果测试通过，则终端输出： 123456789101112131415 Using network &#39;develop&#39;.Compiling ./contracts/Adoption.sol...Compiling ./test/TestAdoption.sol...Compiling truffle/Assert.sol...Compiling truffle/DeployedAddresses.sol... &nbsp;TestAdoption &nbsp; &nbsp;✓ testUserCanAdoptPet (62ms) &nbsp; &nbsp;✓ testGetAdopterAddressByPetId (53ms) &nbsp; &nbsp;✓ testGetAdopterAddressByPetIdInArray (73ms) &nbsp;3 passing (554ms) 创建用户接口和智能合约交互 我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。 在Truffle Box&nbsp;pet-shop里，已经包含了应用的前端代码，代码在src/文件夹下。 在编辑器中打开src/js/app.js可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3.web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。 初始化web3 接下来，我们来编辑app.js修改initWeb3():删除注释，修改为： 123456789101112 initWeb3: function() { &nbsp;// Is there an injected web3 instance? &nbsp;if (typeof web3 !== &#39;undefined&#39;) { &nbsp; &nbsp;App.web3Provider = web3.currentProvider; &nbsp;} else { &nbsp; &nbsp;// If no injected web3 instance is detected, fall back to Ganache &nbsp; &nbsp;App.web3Provider = new Web3.providers.HttpProvider(&#39;http://localhost:7545&#39;); &nbsp;} &nbsp;web3 = new Web3(App.web3Provider); &nbsp;return App.initContract();} 代码中优先使用Mist&nbsp;或&nbsp;MetaMask提供的web3实例，如果没有则从本地环境创建一个。 实例化合约 使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下： 123456789101112131415 initContract: function() { &nbsp;// 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息 &nbsp;$.getJSON(&#39;Adoption.json&#39;, function(data) { &nbsp; &nbsp;// 用Adoption.json数据创建一个可交互的TruffleContract合约实例。 &nbsp; &nbsp;var AdoptionArtifact = data; &nbsp; &nbsp;App.contracts.Adoption = TruffleContract(AdoptionArtifact); &nbsp; &nbsp;// Set the provider for our contract &nbsp; &nbsp;App.contracts.Adoption.setProvider(App.web3Provider); &nbsp; &nbsp;// Use our contract to retrieve and mark the adopted pets &nbsp; &nbsp;return App.markAdopted(); &nbsp;}); &nbsp;return App.bindEvents();} 处理领养 修改markAdopted()代码： 123456789101112131415161718 markAdopted: function(adopters, account) { &nbsp;var adoptionInstance; &nbsp;App.contracts.Adoption.deployed().then(function(instance) { &nbsp; &nbsp;adoptionInstance = instance; &nbsp; &nbsp;// 调用合约的getAdopters(), 用call读取信息不用消耗gas &nbsp; &nbsp;return adoptionInstance.getAdopters.call(); &nbsp;}).then(function(adopters) { &nbsp; &nbsp;for (i = 0; i &lt; adopters.length; i++) { &nbsp; &nbsp; &nbsp;if (adopters[i] !== &#39;0x0000000000000000000000000000000000000000&#39;) { &nbsp; &nbsp; &nbsp; &nbsp;$(&#39;.panel-pet&#39;).eq(i).find(&#39;button&#39;).text(&#39;Success&#39;).attr(&#39;disabled&#39;, true); &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp;}).catch(function(err) { &nbsp; &nbsp;console.log(err.message); &nbsp;});} 修改handleAdopt()代码： 123456789101112131415161718192021222324252627 handleAdopt: function(event) { &nbsp;event.preventDefault(); &nbsp;var petId = parseInt($(event.target).data(&#39;id&#39;)); &nbsp;var adoptionInstance; &nbsp;// 获取用户账号 &nbsp;web3.eth.getAccounts(function(error, accounts) { &nbsp; &nbsp;if (error) { &nbsp; &nbsp; &nbsp;console.log(error); &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp;var account = accounts[0]; &nbsp; &nbsp; &nbsp;App.contracts.Adoption.deployed().then(function(instance) { &nbsp; &nbsp; &nbsp;adoptionInstance = instance; &nbsp; &nbsp; &nbsp; &nbsp;// 发送交易领养宠物 &nbsp; &nbsp; &nbsp;return adoptionInstance.adopt(petId, {from: account}); &nbsp; &nbsp;}).then(function(result) { &nbsp; &nbsp; &nbsp;return App.markAdopted(); &nbsp; &nbsp;}).catch(function(err) { &nbsp; &nbsp; &nbsp;console.log(err.message); &nbsp; &nbsp;}); &nbsp;});} 在浏览器中运行 安装 MetaMask MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。 配置钱包 在接受隐私说明后，会出现页面如下：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的Import Existing DEN，输入Ganache显示的助记词。 1 candy maple cake sugar pudding cream honey rich smooth crumble sweet treat 然后自己想要的密码，点击OK。如图：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 连接开发区块链网络 默认连接的是以太坊主网（左上角显示），选择Custom RPC，添加一个网络：http://127.0.0.1:7545 （这里替换成自己的IP的端口）点返回后，显示如下：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这是左上角显示为Private Network，账号是Ganache中默认的第一个账号。 如要替换账号点击右上角的圆圈，然后点击Import Account ，将Ganache生成的私钥(Private Keys)填写即可。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 至此MetaMask的安装，配置已经完成。 安装和配置lite-server 接下来需要本地的web 服务器提供服务的访问， Truffle Box&nbsp;pet-shop里提供了一个lite-server可以直接使用，我们看看它是如何工作的。bs-config.json指示了lite-server的工作目录。 12345 { &nbsp;&quot;server&quot;: { &nbsp; &nbsp;&quot;baseDir&quot;: [&quot;./src&quot;, &quot;./build/contracts&quot;] &nbsp;}} ./src 是网站文件目录./build/contracts 是合约输出目录 以此同时，在package.json文件的scripts中添加了dev命令： 1234 &quot;scripts&quot;: { &nbsp;&quot;dev&quot;: &quot;lite-server&quot;, &nbsp;&quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;}, 当运行npm run dev的时候，就会启动lite-server 启动服务 1 &gt; npm run dev 会自动打开浏览器显示我们的dapp，如本文的第一张图。 现在领养一直宠物看看，当我们点击Adopt时，MetaMask会提示我们交易的确认，如图： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 点击Submit确认后，就可以看到成功领养了这次宠物。 在MetaMask中，也可以看到交易的清单：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 到这一步，智能合约已经部署完成。 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/03/13/efd8f6c56b8c0d5c0e7f5643f06cfbe4.html","headline":"以太坊智能合约DAPP区块链开发","dateModified":"2018-03-13T00:00:00+08:00","datePublished":"2018-03-13T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/03/13/efd8f6c56b8c0d5c0e7f5643f06cfbe4.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>以太坊智能合约DAPP区块链开发</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p><strong>作者也是刚入坑的小白，查看了网上很多示例也踩了很多坑，现将自己实际部署的情况总结如下，亲测有效：</strong></p>
  <p><strong>机器环境为：</strong></p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;Ubuntu 14.04.5</p>
  <p>&nbsp; &nbsp; Node (v9.0.0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
  <p>&nbsp; &nbsp; Truffle&nbsp;</p>
  <p>&nbsp; &nbsp; Ganache</p>
  <p>&nbsp; &nbsp; npm (5.3.0)<br></p>
  <p>在搭建智能合约之前需要提前安装好Node、Truffle 、Ganache、npm等需要的软件。</p>
  <p><strong>展示效果</strong></p>
  <p>部署好之后就可以领养狗狗，效果图如下：</p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313154049472?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p></p>
  <p><span style="font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;color:#555555;background-color:rgb(255,255,255);"><strong>项目背景</strong></span></p>
  <p><span style="font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;color:#555555;background-color:rgb(255,255,255);">&nbsp;&nbsp;&nbsp;&nbsp;Pete有一个宠物店，他想开发一个去中心化应用，让大家来领养宠物。</span><span style="font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;color:#555555;background-color:rgb(255,255,255);">在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。有关</span><span style="font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;color:#555555;background-color:rgb(255,255,255);">truffle box可</span><span style="font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;color:#555555;background-color:rgb(255,255,255);">在github上可以找到相应的相应的源代码信息</span><span style="font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;color:#555555;background-color:rgb(255,255,255);">https://github.com/truffle-box/pet-shop-box</span></p>
  <p></p>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">环境搭建</h2>
  <ol class="list-paddingleft-2" style="color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);">
   <li><p style="clear:both;min-height:1em;">安装Node</p></li>
   <li><p style="clear:both;min-height:1em;">安装 Truffle ：<code>npm install -g truffle</code></p></li>
   <li><p style="clear:both;min-height:1em;">安装Ganache</p></li>
  </ol>
  <blockquote style="border-left:4px solid rgb(221,221,221);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(102,102,102);">
   <p style="clear:both;min-height:1em;">Ganache（或Ganache CLI）已经取代了 testrpc。</p>
  </blockquote>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">创建项目</h2>
  <ol class="list-paddingleft-2" style="color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);">
   <li><p style="clear:both;min-height:1em;">建立项目目录并进入</p>
    <table style="width:634.4px;">
     <tbody>
      <tr style="background-color:rgb(249,249,249);">
       <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br></pre></td>
       <td style="border-style:none;vertical-align:middle;"><pre><span><span style="color:#8959a8;">&gt;</span><span> mkdir pet-shop-tutorial</span></span><br><span><span style="color:#8959a8;">&gt;</span><span> <span style="color:#f5871f;">cd</span> pet-shop-tutorial</span></span><br></pre></td>
      </tr>
     </tbody>
    </table></li>
   <li><p style="clear:both;min-height:1em;">使用truffle unbox 创建项目</p>
    <table style="width:634.4px;">
     <tbody>
      <tr style="background-color:rgb(249,249,249);">
       <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></pre></td>
       <td style="border-style:none;vertical-align:middle;"><pre><span><span style="color:#8959a8;"> &gt;</span><span> truffle unbox pet-shop</span></span><br><span> Downloading...</span><br><span> Unpacking...</span><br><span> Setting up...</span><br><span> Unbox successful. Sweet!</span><br><span></span><br><span>Commands:</span><br><span></span><br><span> &nbsp;Compile: &nbsp; &nbsp; &nbsp; &nbsp;truffle compile</span><br><span> &nbsp;Migrate: &nbsp; &nbsp; &nbsp; &nbsp;truffle migrate</span><br><span> &nbsp;Test contracts: truffle test</span><br><span> &nbsp;Run dev server: npm run dev</span><br></pre></td>
      </tr>
     </tbody>
    </table></li>
  </ol>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">这一步需要等待一会</p>
  <blockquote style="border-left:4px solid rgb(221,221,221);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(102,102,102);">
   <p style="clear:both;min-height:1em;">也可以使用truffle init 来创建一个全新的项目。</p>
  </blockquote>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">项目目录结构</h2>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><code>contracts/</code>&nbsp;智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲）<br><code>migrations/</code>&nbsp;用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。<br><code>test/</code>&nbsp;智能合约测试用例文件夹<br><code>truffle.js/</code>&nbsp;配置文件</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">其他代码可以暂时不用管</p>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">编写智能合约</h2>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读<br>[solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/）</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在contracts目录下，添加合约文件Adoption.sol<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>pragma solidity ^<span>0.4</span><span>.17</span>;</span><br><span></span><br><span>contract Adoption {</span><br><span></span><br><span> &nbsp;address[<span>16</span>] public adopters; &nbsp;<span style="color:#8e908c;">// 保存领养者的地址</span></span><br><span></span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// 领养宠物</span></span><br><span> &nbsp;<span style="color:#4271ae;"><span style="color:#8959a8;">function</span> <span style="color:#3e999f;">adopt</span>(<span style="color:#f5871f;">uint petId</span>) <span style="color:#3e999f;">public</span> <span style="color:#3e999f;">returns</span> (<span style="color:#f5871f;">uint</span>) </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#f5871f;">require</span>(petId &gt;= <span>0</span> &amp;&amp; petId &lt;= <span>15</span>); &nbsp;<span style="color:#8e908c;">// 确保id在数组长度内</span></span><br><span></span><br><span> &nbsp; &nbsp;adopters[petId] = msg.sender; &nbsp; &nbsp; &nbsp; &nbsp;<span style="color:#8e908c;">// 保存调用这地址 </span></span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">return</span> petId;</span><br><span> &nbsp;}</span><br><span></span><br><span> &nbsp;<span style="color:#8e908c;">// 返回领养者</span></span><br><span> &nbsp;<span style="color:#4271ae;"><span style="color:#8959a8;">function</span> <span style="color:#3e999f;">getAdopters</span>(<span style="color:#f5871f;"></span>) <span style="color:#3e999f;">public</span> <span style="color:#3e999f;">view</span> <span style="color:#3e999f;">returns</span> (<span style="color:#f5871f;">address[<span>16</span>]</span>) </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">return</span> adopters;</span><br><span> &nbsp;}</span><br><span></span><br><span>}</span></pre></td>
    </tr>
   </tbody>
  </table>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">编译部署智能合约</h2>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">编译</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。<br>dapp的根目录pet-shop-tutorial下，<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span><span style="color:#8959a8;">&gt;</span><span> truffle compile</span></span></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">输出<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>Compiling ./contracts/Adoption.sol...</span><br><span>Writing artifacts to ./build/contracts</span></pre></td>
    </tr>
   </tbody>
  </table>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">部署</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">编译之后，就可以部署到区块链上。<br>在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。<br>Migrations.sol 用来确保不会部署相同的合约。</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">现在我们来创建一个自己的部署脚本<code>2_deploy_contracts.js</code></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>var Adoption = artifacts.require("Adoption");</span><br><span></span><br><span>module.exports = function(deployer) {</span><br><span> &nbsp;deployer.deploy(Adoption);</span><br><span>};</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在执行部署之前，需要确保有一个区块链运行, 可以使用<br></p>
  <p>Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。</p>
  <p>Ganache 启动之后是这样：</p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202200674?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">接下来执行部署命令:<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>&gt; truffle &nbsp;migrate</span></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">执行后，有一下类似的输出，<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>Using network 'develop'.</span><br><span></span><br><span>Running migration: 1_initial_migration.js</span><br><span> &nbsp;Deploying Migrations...</span><br><span> &nbsp;... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f</span><br><span> &nbsp;Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0</span><br><span>Saving successful migration to network...</span><br><span> &nbsp;... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956</span><br><span>Saving artifacts...</span><br><span>Running migration: 2_deploy_contracts.js</span><br><span> &nbsp;Deploying Adoption...</span><br><span> &nbsp;... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4</span><br><span> &nbsp;Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10</span><br><span>Saving successful migration to network...</span><br><span> &nbsp;... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0</span><br><span>Saving artifacts...</span></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。<br><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202231749?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p>这时说明已经智能合约已经部署好了。</p>
  <p>也可以直接下载liunx版本的ganache-cli ，直接启动ganache-cli，会生成10个账户，为私有链，账户中有100ETH的余额。执行界面如下：</p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313155314126?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p></p>
  <p style="color:rgb(85,85,85);min-height:1em;clear:both;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);">接下来执行部署命令:<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>&gt; truffle &nbsp;migrate</span></pre></td>
    </tr>
   </tbody>
  </table>
  <p>执行结果和上面相同，生成4个区块。</p>
  <p></p>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">测试</h2>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在<code>test</code>目录下新建一个<code>TestAdoption.sol</code>，编写测试合约<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span></span><br><span>pragma solidity ^<span>0.4</span><span>.17</span>;</span><br><span></span><br><span><span style="color:#8959a8;">import</span> <span>"truffle/Assert.sol"</span>; &nbsp; <span style="color:#8e908c;">// 引入的断言</span></span><br><span><span style="color:#8959a8;">import</span> <span>"truffle/DeployedAddresses.sol"</span>; &nbsp;<span style="color:#8e908c;">// 用来获取被测试合约的地址</span></span><br><span><span style="color:#8959a8;">import</span> <span>"../contracts/Adoption.sol"</span>; &nbsp; &nbsp; &nbsp;<span style="color:#8e908c;">// 被测试合约</span></span><br><span></span><br><span>contract TestAdoption {</span><br><span> &nbsp;Adoption adoption = Adoption(DeployedAddresses.Adoption());</span><br><span></span><br><span> &nbsp;<span style="color:#8e908c;">// 领养测试用例</span></span><br><span> &nbsp;<span style="color:#4271ae;"><span style="color:#8959a8;">function</span> <span style="color:#3e999f;">testUserCanAdoptPet</span>(<span style="color:#f5871f;"></span>) <span style="color:#3e999f;">public</span> </span>{</span><br><span> &nbsp; &nbsp;uint returnedId = adoption.adopt(<span>8</span>);</span><br><span></span><br><span> &nbsp; &nbsp;uint expected = <span>8</span>;</span><br><span> &nbsp; &nbsp;Assert.equal(returnedId, expected, <span>"Adoption of pet ID 8 should be recorded."</span>);</span><br><span> &nbsp;}</span><br><span></span><br><span> &nbsp;<span style="color:#8e908c;">// 宠物所有者测试用例</span></span><br><span> &nbsp;<span style="color:#4271ae;"><span style="color:#8959a8;">function</span> <span style="color:#3e999f;">testGetAdopterAddressByPetId</span>(<span style="color:#f5871f;"></span>) <span style="color:#3e999f;">public</span> </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易，</span></span><br><span> &nbsp; &nbsp;address expected = <span style="color:#8959a8;">this</span>;</span><br><span> &nbsp; &nbsp;address adopter = adoption.adopters(<span>8</span>);</span><br><span> &nbsp; &nbsp;Assert.equal(adopter, expected, <span>"Owner of pet ID 8 should be recorded."</span>);</span><br><span> &nbsp;}</span><br><span></span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// 测试所有领养者</span></span><br><span> &nbsp;<span style="color:#4271ae;"><span style="color:#8959a8;">function</span> <span style="color:#3e999f;">testGetAdopterAddressByPetIdInArray</span>(<span style="color:#f5871f;"></span>) <span style="color:#3e999f;">public</span> </span>{</span><br><span> &nbsp;<span style="color:#8e908c;">// 领养者的地址就是本合约地址</span></span><br><span> &nbsp; &nbsp;address expected = <span style="color:#8959a8;">this</span>;</span><br><span> &nbsp; &nbsp;address[<span>16</span>] memory adopters = adoption.getAdopters();</span><br><span> &nbsp; &nbsp;Assert.equal(adopters[<span>8</span>], expected, <span>"Owner of pet ID 8 should be recorded."</span>);</span><br><span> &nbsp;}</span><br><span>}</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">TestAdoption合约中添加adopt的测试用例</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">运行测试用例</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在终端中，执行<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>truffle <span style="color:#f5871f;">test</span></span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">如果测试通过，则终端输出：<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>Using network 'develop'.</span><br><span></span><br><span>Compiling ./contracts/Adoption.sol...</span><br><span>Compiling ./test/TestAdoption.sol...</span><br><span>Compiling truffle/Assert.sol...</span><br><span>Compiling truffle/DeployedAddresses.sol...</span><br><span></span><br><span></span><br><span> &nbsp;TestAdoption</span><br><span> &nbsp; &nbsp;✓ testUserCanAdoptPet (62ms)</span><br><span> &nbsp; &nbsp;✓ testGetAdopterAddressByPetId (53ms)</span><br><span> &nbsp; &nbsp;✓ testGetAdopterAddressByPetIdInArray (73ms)</span><br><span></span><br><span></span><br><span> &nbsp;3 passing (554ms)</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">创建用户接口和智能合约交互</h2>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在Truffle Box&nbsp;<code>pet-shop</code>里，已经包含了应用的前端代码，代码在<code>src/</code>文件夹下。</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在编辑器中打开<code>src/js/app.js</code><br>可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3.<br>web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">初始化web3</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">接下来，我们来编辑app.js修改initWeb3():<br>删除注释，修改为：<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>initWeb3: <span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;"></span>) </span>{</span><br><span> &nbsp;<span style="color:#8e908c;">// Is there an injected web3 instance?</span></span><br><span> &nbsp;<span style="color:#8959a8;">if</span> (<span style="color:#8959a8;">typeof</span> web3 !== <span>'undefined'</span>) {</span><br><span> &nbsp; &nbsp;App.web3Provider = web3.currentProvider;</span><br><span> &nbsp;} <span style="color:#8959a8;">else</span> {</span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// If no injected web3 instance is detected, fall back to Ganache</span></span><br><span> &nbsp; &nbsp;App.web3Provider = <span style="color:#8959a8;">new</span> Web3.providers.HttpProvider(<span>'http://localhost:7545'</span>);</span><br><span> &nbsp;}</span><br><span> &nbsp;web3 = <span style="color:#8959a8;">new</span> Web3(App.web3Provider);</span><br><span></span><br><span> &nbsp;<span style="color:#8959a8;">return</span> App.initContract();</span><br><span>}</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">代码中优先使用Mist&nbsp;或&nbsp;MetaMask提供的web3实例，如果没有则从本地环境创建一个。</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">实例化合约</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下：<br></p>
  <table>
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>initContract: <span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;"></span>) </span>{</span><br><span> &nbsp;<span style="color:#8e908c;">// 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息</span></span><br><span> &nbsp;$.getJSON(<span>'Adoption.json'</span>, <span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">data</span>) </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// 用Adoption.json数据创建一个可交互的TruffleContract合约实例。</span></span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">var</span> AdoptionArtifact = data;</span><br><span> &nbsp; &nbsp;App.contracts.Adoption = TruffleContract(AdoptionArtifact);</span><br><span></span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// Set the provider for our contract</span></span><br><span> &nbsp; &nbsp;App.contracts.Adoption.setProvider(App.web3Provider);</span><br><span></span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// Use our contract to retrieve and mark the adopted pets</span></span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">return</span> App.markAdopted();</span><br><span> &nbsp;});</span><br><span> &nbsp;<span style="color:#8959a8;">return</span> App.bindEvents();</span><br><span>}</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">处理领养</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">修改markAdopted()代码：<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>markAdopted: <span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">adopters, account</span>) </span>{</span><br><span> &nbsp;<span style="color:#8959a8;">var</span> adoptionInstance;</span><br><span></span><br><span> &nbsp;App.contracts.Adoption.deployed().then(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">instance</span>) </span>{</span><br><span> &nbsp; &nbsp;adoptionInstance = instance;</span><br><span></span><br><span> &nbsp; &nbsp;<span style="color:#8e908c;">// 调用合约的getAdopters(), 用call读取信息不用消耗gas</span></span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">return</span> adoptionInstance.getAdopters.call();</span><br><span> &nbsp;}).then(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">adopters</span>) </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">for</span> (i = <span>0</span>; i &lt; adopters.length; i++) {</span><br><span> &nbsp; &nbsp; &nbsp;<span style="color:#8959a8;">if</span> (adopters[i] !== <span>'0x0000000000000000000000000000000000000000'</span>) {</span><br><span> &nbsp; &nbsp; &nbsp; &nbsp;$(<span>'.panel-pet'</span>).eq(i).find(<span>'button'</span>).text(<span>'Success'</span>).attr(<span>'disabled'</span>, <span style="color:#f5871f;">true</span>);</span><br><span> &nbsp; &nbsp; &nbsp;}</span><br><span> &nbsp; &nbsp;}</span><br><span> &nbsp;}).catch(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">err</span>) </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#f5871f;">console</span>.log(err.message);</span><br><span> &nbsp;});</span><br><span>}</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">修改handleAdopt()代码：<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>handleAdopt: <span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">event</span>) </span>{</span><br><span> &nbsp;event.preventDefault();</span><br><span></span><br><span> &nbsp;<span style="color:#8959a8;">var</span> petId = <span style="color:#f5871f;">parseInt</span>($(event.target).data(<span>'id'</span>));</span><br><span></span><br><span> &nbsp;<span style="color:#8959a8;">var</span> adoptionInstance;</span><br><span></span><br><span> &nbsp;<span style="color:#8e908c;">// 获取用户账号</span></span><br><span> &nbsp;web3.eth.getAccounts(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">error, accounts</span>) </span>{</span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">if</span> (error) {</span><br><span> &nbsp; &nbsp; &nbsp;<span style="color:#f5871f;">console</span>.log(error);</span><br><span> &nbsp; &nbsp;}</span><br><span> &nbsp;</span><br><span> &nbsp; &nbsp;<span style="color:#8959a8;">var</span> account = accounts[<span>0</span>];</span><br><span> &nbsp;</span><br><span> &nbsp; &nbsp;App.contracts.Adoption.deployed().then(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">instance</span>) </span>{</span><br><span> &nbsp; &nbsp; &nbsp;adoptionInstance = instance;</span><br><span> &nbsp;</span><br><span> &nbsp; &nbsp; &nbsp;<span style="color:#8e908c;">// 发送交易领养宠物</span></span><br><span> &nbsp; &nbsp; &nbsp;<span style="color:#8959a8;">return</span> adoptionInstance.adopt(petId, {<span>from</span>: account});</span><br><span> &nbsp; &nbsp;}).then(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">result</span>) </span>{</span><br><span> &nbsp; &nbsp; &nbsp;<span style="color:#8959a8;">return</span> App.markAdopted();</span><br><span> &nbsp; &nbsp;}).catch(<span style="color:#4271ae;"><span style="color:#8959a8;">function</span>(<span style="color:#f5871f;">err</span>) </span>{</span><br><span> &nbsp; &nbsp; &nbsp;<span style="color:#f5871f;">console</span>.log(err.message);</span><br><span> &nbsp; &nbsp;});</span><br><span> &nbsp;});</span><br><span>}</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"><br></p>
  <h2 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">在浏览器中运行</h2>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">安装 MetaMask</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">配置钱包</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);"></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在接受隐私说明后，会出现页面如下：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202319227?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的<span>Import Existing DEN</span>，输入Ganache显示的助记词。<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>candy maple cake sugar pudding cream honey rich smooth crumble sweet treat</span></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">然后自己想要的密码，点击OK。<br>如图：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202345140?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">连接开发区块链网络</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">默认连接的是以太坊主网（左上角显示），选择<span>Custom RPC</span>，添加一个网络：<span>http://127.0.0.1:7545 （这里替换成自己的IP的端口）</span>点返回后，显示如下：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202410943?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p>这是左上角显示为<span>Private Network</span>，账号是Ganache中默认的第一个账号。</p>
  <p>如要替换账号点击右上角的圆圈，然后点击Import Account ，将Ganache生成的私钥(Private Keys)填写即可。</p>
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313155709598?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">至此MetaMask的安装，配置已经完成。</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">安装和配置lite-server</h3>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">接下来需要本地的web 服务器提供服务的访问， Truffle Box&nbsp;<span>pet-shop</span>里提供了一个<span>lite-server</span>可以直接使用，我们看看它是如何工作的。<br><span>bs-config.json</span>指示了lite-server的工作目录。<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>{</span><br><span> &nbsp;<span>"server"</span>: {</span><br><span> &nbsp; &nbsp;<span>"baseDir"</span>: [<span>"./src"</span>, <span>"./build/contracts"</span>]</span><br><span> &nbsp;}</span><br><span>}</span></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">./src 是网站文件目录<br>./build/contracts 是合约输出目录</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">以此同时，在package.json文件的scripts中添加了dev命令：<br></p>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>"scripts": {</span><br><span> &nbsp;"dev": "lite-server",</span><br><span> &nbsp;"test": "echo \"Error: no test specified\" &amp;&amp; exit 1"</span><br><span>},</span></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">当运行npm run dev的时候，就会启动lite-server</p>
  <h3 style="font-size:16px;color:rgb(62,62,62);font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);line-height:1.5;">启动服务</h3>
  <table style="width:669.6px;">
   <tbody>
    <tr style="background-color:rgb(249,249,249);">
     <td style="border-style:none;vertical-align:middle;"><pre><span>1</span><br></pre></td>
     <td style="border-style:none;vertical-align:middle;"><pre><span>&gt; npm run dev</span><br></pre></td>
    </tr>
   </tbody>
  </table>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">会自动打开浏览器显示我们的dapp，如本文的第一张图。<br></p>
  <p>现在领养一直宠物看看，当我们点击<span>Adopt</span>时，MetaMask会提示我们交易的确认，如图：</p>
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202534755?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">点击Submit确认后，就可以看到成功领养了这次宠物。</p>
  <p style="clear:both;min-height:1em;font-family:'Helvetica Neue', Helvetica, 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;background-color:rgb(255,255,255);color:rgb(85,85,85);">在MetaMask中，也可以看到交易的清单：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180313202608869?watermark/2/text/Ly9ibG9nLmNzZG4ubmV0L3UwMTQ0MzkyMzk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>到这一步，智能合约已经部署完成。 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/u014439239/article/details/79541119,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/u014439239/article/details/79541119,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
