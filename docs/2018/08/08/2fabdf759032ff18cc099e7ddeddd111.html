<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>006 以太坊钱包开发-发放token、token转账 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="006 以太坊钱包开发-发放token、token转账" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="私链发放token 编写代币合约代码 打开官方网站：https://www.ethereum.org/token#minimum-viable-token ，拷贝官方标准合约代码。 pragma solidity ^0.4.16; interface tokenRecipient { function receiveApproval(address _from, uint256 _value, address _token, bytes _extraData) external; } contract TokenERC20 { // Public variables of the token string public name; string public symbol; uint8 public decimals = 18; // 18 decimals is the strongly suggested default, avoid changing it uint256 public totalSupply; // This creates an array with all balances mapping (address =&gt; uint256) public balanceOf; mapping (address =&gt; mapping (address =&gt; uint256)) public allowance; // This generates a public event on the blockchain that will notify clients event Transfer(address indexed from, address indexed to, uint256 value); // This generates a public event on the blockchain that will notify clients event Approval(address indexed _owner, address indexed _spender, uint256 _value); // This notifies clients about the amount burnt event Burn(address indexed from, uint256 value); /** * Constructor function * * Initializes contract with initial supply tokens to the creator of the contract */ constructor( uint256 initialSupply, string tokenName, string tokenSymbol ) public { totalSupply = initialSupply * 10 ** uint256(decimals); // Update total supply with the decimal amount balanceOf[msg.sender] = totalSupply; // Give the creator all initial tokens name = tokenName; // Set the name for display purposes symbol = tokenSymbol; // Set the symbol for display purposes } /** * Internal transfer, only can be called by this contract */ function _transfer(address _from, address _to, uint _value) internal { // Prevent transfer to 0x0 address. Use burn() instead require(_to != 0x0); // Check if the sender has enough require(balanceOf[_from] &gt;= _value); // Check for overflows require(balanceOf[_to] + _value &gt;= balanceOf[_to]); // Save this for an assertion in the future uint previousBalances = balanceOf[_from] + balanceOf[_to]; // Subtract from the sender balanceOf[_from] -= _value; // Add the same to the recipient balanceOf[_to] += _value; emit Transfer(_from, _to, _value); // Asserts are used to use static analysis to find bugs in your code. They should never fail assert(balanceOf[_from] + balanceOf[_to] == previousBalances); } /** * Transfer tokens * * Send `_value` tokens to `_to` from your account * * @param _to The address of the recipient * @param _value the amount to send */ function transfer(address _to, uint256 _value) public returns (bool success) { _transfer(msg.sender, _to, _value); return true; } /** * Transfer tokens from other address * * Send `_value` tokens to `_to` on behalf of `_from` * * @param _from The address of the sender * @param _to The address of the recipient * @param _value the amount to send */ function transferFrom(address _from, address _to, uint256 _value) public returns (bool success) { require(_value &lt;= allowance[_from][msg.sender]); // Check allowance allowance[_from][msg.sender] -= _value; _transfer(_from, _to, _value); return true; } /** * Set allowance for other address * * Allows `_spender` to spend no more than `_value` tokens on your behalf * * @param _spender The address authorized to spend * @param _value the max amount they can spend */ function approve(address _spender, uint256 _value) public returns (bool success) { allowance[msg.sender][_spender] = _value; emit Approval(msg.sender, _spender, _value); return true; } /** * Set allowance for other address and notify * * Allows `_spender` to spend no more than `_value` tokens on your behalf, and then ping the contract about it * * @param _spender The address authorized to spend * @param _value the max amount they can spend * @param _extraData some extra information to send to the approved contract */ function approveAndCall(address _spender, uint256 _value, bytes _extraData) public returns (bool success) { tokenRecipient spender = tokenRecipient(_spender); if (approve(_spender, _value)) { spender.receiveApproval(msg.sender, _value, this, _extraData); return true; } } /** * Destroy tokens * * Remove `_value` tokens from the system irreversibly * * @param _value the amount of money to burn */ function burn(uint256 _value) public returns (bool success) { require(balanceOf[msg.sender] &gt;= _value); // Check if the sender has enough balanceOf[msg.sender] -= _value; // Subtract from the sender totalSupply -= _value; // Updates totalSupply emit Burn(msg.sender, _value); return true; } /** * Destroy tokens from other account * * Remove `_value` tokens from the system irreversibly on behalf of `_from`. * * @param _from the address of the sender * @param _value the amount of money to burn */ function burnFrom(address _from, uint256 _value) public returns (bool success) { require(balanceOf[_from] &gt;= _value); // Check if the targeted balance is enough require(_value &lt;= allowance[_from][msg.sender]); // Check allowance balanceOf[_from] -= _value; // Subtract from the targeted balance allowance[_from][msg.sender] -= _value; // Subtract from the sender&#39;s allowance totalSupply -= _value; // Update totalSupply emit Burn(_from, _value); return true; } } name ： 代币名称 symbol： 代币符号 decimals： 代币小数点位数，代币的最小单位， 18表示我们可以拥有 .0000000000000000001单位个代币。 totalSupply() : 发行代币总量。 balanceOf(): 查看对应账号的代币余额。 transfer(): 实现代币交易，用于给用户发送代币（从我们的账户里）。 transferFrom(): 实现代币用户之间的交易。 allowance(): 控制代币的交易，如可交易账号及资产。 approve(): 允许用户可花费的代币数。 下载 Ethereum Wallet 下载Ethereum Wallet ： https://github.com/ethereum/mist/releases 安装完成后，通过命令启动 Ethereum Wallet 客户端。 首先使用 geth 启动私有网络 $ geth --datadir ~/privatechain/data0 --networkid 110 --rpc console 然后通过命令启动 Ethereum Wallet open -a /Applications/Ethereum\ Wallet.app/ --args --rpc /Users/fujinliang/privatechain/data0/geth.ipc –rpc 的值如何获取？ 可以通过启动私链的控制台，查看ipc文件的路径，如下图所示： 部署代币合约 部署代币合约，设置代币发行数量、名字 点击 DEPLOY 部署合约 需要在geth 目录下启动挖矿。 miner.start(); 查看合约地址和合约Abi web3 调用代币转账 调用合约实现代币转账 修改 utils/web3helper 创建合约。 getContract() { const web3 = module.exports.getWeb3() // 定义合约abi const contractAbi = [ { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;name&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;string&quot;, &quot;value&quot;: &quot;kongyixueyuan&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x06fdde03&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;approve&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x095ea7b3&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;totalSupply&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot;, &quot;value&quot;: &quot;10000000000000000000000000&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x18160ddd&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;transferFrom&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x23b872dd&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;decimals&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot;, &quot;value&quot;: &quot;18&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x313ce567&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;burn&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x42966c68&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;balanceOf&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x70a08231&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;burnFrom&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x79cc6790&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;symbol&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;string&quot;, &quot;value&quot;: &quot;kyb&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x95d89b41&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;transfer&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xa9059cbb&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;name&quot;: &quot;_extraData&quot;, &quot;type&quot;: &quot;bytes&quot; } ], &quot;name&quot;: &quot;approveAndCall&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xcae9ca51&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;allowance&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xdd62ed3e&quot; }, { &quot;inputs&quot;: [ { &quot;name&quot;: &quot;initialSupply&quot;, &quot;type&quot;: &quot;uint256&quot;, &quot;index&quot;: 0, &quot;typeShort&quot;: &quot;uint&quot;, &quot;bits&quot;: &quot;256&quot;, &quot;displayName&quot;: &quot;initial Supply&quot;, &quot;template&quot;: &quot;elements_input_uint&quot;, &quot;value&quot;: &quot;10000000&quot; }, { &quot;name&quot;: &quot;tokenName&quot;, &quot;type&quot;: &quot;string&quot;, &quot;index&quot;: 1, &quot;typeShort&quot;: &quot;string&quot;, &quot;bits&quot;: &quot;&quot;, &quot;displayName&quot;: &quot;token Name&quot;, &quot;template&quot;: &quot;elements_input_string&quot;, &quot;value&quot;: &quot;kongyixueyuan&quot; }, { &quot;name&quot;: &quot;tokenSymbol&quot;, &quot;type&quot;: &quot;string&quot;, &quot;index&quot;: 2, &quot;typeShort&quot;: &quot;string&quot;, &quot;bits&quot;: &quot;&quot;, &quot;displayName&quot;: &quot;token Symbol&quot;, &quot;template&quot;: &quot;elements_input_string&quot;, &quot;value&quot;: &quot;kyb&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;constructor&quot;, &quot;signature&quot;: &quot;constructor&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: true, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Transfer&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;_owner&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: true, &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Approval&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Burn&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0xcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5&quot; } ] // 合约地址 const contractAddress = &quot;0xF2B6b76f1d0Ea4dC8ca543765640224819af3aA2&quot; const myContract = new web3.eth.Contract(contractAbi,contractAddress) return myContract } 在 controllers 中 新建 token.js 文件，通过调用合约实现代币转账 ，代码如下： const web3 = require(&quot;../utils/web3helper&quot;).getWeb3() const BigNumber = require(&#39;bignumber.js&#39;); const myContract = require(&quot;../utils/web3helper&quot;).getContract() module.exports = { async sendTokenTransaction (ctx) { let returnResult = { code: 0, msg: &#39;成功！&#39;, data: {} } const data = ctx.request.body const currentAccount = data.currAccount const privateKey = data.privateKey const reciptAccount = data.reciptAccount const txValue = data.txValue // 获取指定账户地址的交易数 let nonce = await web3.eth.getTransactionCount(currentAccount); // 获取设置的位数 const decimals = await myContract.methods.decimals().call() // 将输入的值 转为 最小单位的值 const value = BigNumber(txValue * Math.pow(10,decimals)); const txData = myContract.methods.transfer(reciptAccount, value).encodeABI(); // 获取当前gasprice let gasPrice = await web3.eth.getGasPrice(); // 以太币转账参数 let txParms = { from: currentAccount, // 合约地址 to: myContract.options.address, nonce: nonce, gasPrice: gasPrice, data: txData // 当使用代币转账或者合约调用时 } // 获取一下预估gas let gas = await web3.eth.estimateGas(txParms); txParms.gas = gas; // 用密钥对账单进行签名 let signTx = await web3.eth.accounts.signTransaction(txParms,privateKey) // 将签过名的账单进行发送 try { await web3.eth.sendSignedTransaction(signTx.rawTransaction, function(error, hash){ if (!error) { returnResult.data.hash = hash } else { returnResult.code = &quot;101&quot; returnResult.msg = &quot;失败！&quot; returnResult.data.error = error.message } }) } catch (error) { console.log(error) } ctx.body = returnResult } } 代币转账和以太币转账方法类似，只有两点不同： 转账参数 txParms 中 to 为合约的地址 转账参数 txParms 中 需要设置 data 的值 修改路由配置 代币转账添加路由配置，修改 routers/index.js，添加如下代码： const tokenController = require(&quot;../controllers/token&quot;) router.post(&#39;/token/send&#39;, tokenController.sendTokenTransaction) 修改转账页面 修改 view/transaction.html 中的代码。 转账币种选择加入 kyb的选项。 &lt;div class=&quot;form-group&quot;&gt; &lt;label for=&quot;txValue&quot;&gt;转账金额&lt;/label&gt; &lt;div class=&quot;input-group mb-3&quot;&gt; &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;txValue&quot; placeholder=&quot;&quot;&gt; &lt;div class=&quot;input-group-append&quot;&gt; &lt;select id=&quot;tokenType&quot;&gt; &lt;option value=&quot;eth&quot;&gt;ETH&lt;/option&gt; &lt;option value=&quot;kyb&quot;&gt;KYB&lt;/option&gt; &lt;/select&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; 修改转账 sendTransaction 方法 if (tokenType == &quot;kyb&quot;){ $.post(&quot;/token/send&quot;,params,function(res){ if (res.code == 0) { alert(&quot;交易成功！&quot;) $(&quot;#txHashDiv&quot;).show() $(&quot;#txHash&quot;).html(res.data.hash) } else { alert(&quot;交易失败！&quot;+res.data.error) } }) } 获取账户中的代币金额 修改 controllers/account.js 添加 getTokenBalance 获取代币的信息。 async getTokenBalance(account){ let returnResult = { balance: 0, symbol: &#39;kongyixueyuan&#39; } // 代币小数点位数 const decimals = await myContract.methods.decimals().call() // 代币符号 const symbol = await myContract.methods.symbol().call() const tokenBalance = await myContract.methods.balanceOf(account.address).call() const tokenBalanceNum = tokenBalance / Math.pow(10,decimals) returnResult.balance = tokenBalanceNum returnResult.symbol = symbol return returnResult } 修改 getAccountByKeystore 和 getAccountByPrivatekey 方法，添加获取代币的代码： const tokenResult = await module.exports.getTokenBalance(account) returnResult.data.tokenBalance = tokenResult.balance returnResult.data.tokenSymbol = tokenResult.symbol 项目运行 启动私链网络 使用 geth 启动私有网络 $ geth --datadir ~/privatechain/data0 --networkid 110 --rpc console 开启本地挖矿 miner.start() 启动项目 $ cd myWallet $ node index.js 访问 http://localhost:3000/transaction 查看项目： 源码下载 https://github.com/didianV5/web3EthWallet/tree/master/006_myWallet 关注我 阅读更多" />
<meta property="og:description" content="私链发放token 编写代币合约代码 打开官方网站：https://www.ethereum.org/token#minimum-viable-token ，拷贝官方标准合约代码。 pragma solidity ^0.4.16; interface tokenRecipient { function receiveApproval(address _from, uint256 _value, address _token, bytes _extraData) external; } contract TokenERC20 { // Public variables of the token string public name; string public symbol; uint8 public decimals = 18; // 18 decimals is the strongly suggested default, avoid changing it uint256 public totalSupply; // This creates an array with all balances mapping (address =&gt; uint256) public balanceOf; mapping (address =&gt; mapping (address =&gt; uint256)) public allowance; // This generates a public event on the blockchain that will notify clients event Transfer(address indexed from, address indexed to, uint256 value); // This generates a public event on the blockchain that will notify clients event Approval(address indexed _owner, address indexed _spender, uint256 _value); // This notifies clients about the amount burnt event Burn(address indexed from, uint256 value); /** * Constructor function * * Initializes contract with initial supply tokens to the creator of the contract */ constructor( uint256 initialSupply, string tokenName, string tokenSymbol ) public { totalSupply = initialSupply * 10 ** uint256(decimals); // Update total supply with the decimal amount balanceOf[msg.sender] = totalSupply; // Give the creator all initial tokens name = tokenName; // Set the name for display purposes symbol = tokenSymbol; // Set the symbol for display purposes } /** * Internal transfer, only can be called by this contract */ function _transfer(address _from, address _to, uint _value) internal { // Prevent transfer to 0x0 address. Use burn() instead require(_to != 0x0); // Check if the sender has enough require(balanceOf[_from] &gt;= _value); // Check for overflows require(balanceOf[_to] + _value &gt;= balanceOf[_to]); // Save this for an assertion in the future uint previousBalances = balanceOf[_from] + balanceOf[_to]; // Subtract from the sender balanceOf[_from] -= _value; // Add the same to the recipient balanceOf[_to] += _value; emit Transfer(_from, _to, _value); // Asserts are used to use static analysis to find bugs in your code. They should never fail assert(balanceOf[_from] + balanceOf[_to] == previousBalances); } /** * Transfer tokens * * Send `_value` tokens to `_to` from your account * * @param _to The address of the recipient * @param _value the amount to send */ function transfer(address _to, uint256 _value) public returns (bool success) { _transfer(msg.sender, _to, _value); return true; } /** * Transfer tokens from other address * * Send `_value` tokens to `_to` on behalf of `_from` * * @param _from The address of the sender * @param _to The address of the recipient * @param _value the amount to send */ function transferFrom(address _from, address _to, uint256 _value) public returns (bool success) { require(_value &lt;= allowance[_from][msg.sender]); // Check allowance allowance[_from][msg.sender] -= _value; _transfer(_from, _to, _value); return true; } /** * Set allowance for other address * * Allows `_spender` to spend no more than `_value` tokens on your behalf * * @param _spender The address authorized to spend * @param _value the max amount they can spend */ function approve(address _spender, uint256 _value) public returns (bool success) { allowance[msg.sender][_spender] = _value; emit Approval(msg.sender, _spender, _value); return true; } /** * Set allowance for other address and notify * * Allows `_spender` to spend no more than `_value` tokens on your behalf, and then ping the contract about it * * @param _spender The address authorized to spend * @param _value the max amount they can spend * @param _extraData some extra information to send to the approved contract */ function approveAndCall(address _spender, uint256 _value, bytes _extraData) public returns (bool success) { tokenRecipient spender = tokenRecipient(_spender); if (approve(_spender, _value)) { spender.receiveApproval(msg.sender, _value, this, _extraData); return true; } } /** * Destroy tokens * * Remove `_value` tokens from the system irreversibly * * @param _value the amount of money to burn */ function burn(uint256 _value) public returns (bool success) { require(balanceOf[msg.sender] &gt;= _value); // Check if the sender has enough balanceOf[msg.sender] -= _value; // Subtract from the sender totalSupply -= _value; // Updates totalSupply emit Burn(msg.sender, _value); return true; } /** * Destroy tokens from other account * * Remove `_value` tokens from the system irreversibly on behalf of `_from`. * * @param _from the address of the sender * @param _value the amount of money to burn */ function burnFrom(address _from, uint256 _value) public returns (bool success) { require(balanceOf[_from] &gt;= _value); // Check if the targeted balance is enough require(_value &lt;= allowance[_from][msg.sender]); // Check allowance balanceOf[_from] -= _value; // Subtract from the targeted balance allowance[_from][msg.sender] -= _value; // Subtract from the sender&#39;s allowance totalSupply -= _value; // Update totalSupply emit Burn(_from, _value); return true; } } name ： 代币名称 symbol： 代币符号 decimals： 代币小数点位数，代币的最小单位， 18表示我们可以拥有 .0000000000000000001单位个代币。 totalSupply() : 发行代币总量。 balanceOf(): 查看对应账号的代币余额。 transfer(): 实现代币交易，用于给用户发送代币（从我们的账户里）。 transferFrom(): 实现代币用户之间的交易。 allowance(): 控制代币的交易，如可交易账号及资产。 approve(): 允许用户可花费的代币数。 下载 Ethereum Wallet 下载Ethereum Wallet ： https://github.com/ethereum/mist/releases 安装完成后，通过命令启动 Ethereum Wallet 客户端。 首先使用 geth 启动私有网络 $ geth --datadir ~/privatechain/data0 --networkid 110 --rpc console 然后通过命令启动 Ethereum Wallet open -a /Applications/Ethereum\ Wallet.app/ --args --rpc /Users/fujinliang/privatechain/data0/geth.ipc –rpc 的值如何获取？ 可以通过启动私链的控制台，查看ipc文件的路径，如下图所示： 部署代币合约 部署代币合约，设置代币发行数量、名字 点击 DEPLOY 部署合约 需要在geth 目录下启动挖矿。 miner.start(); 查看合约地址和合约Abi web3 调用代币转账 调用合约实现代币转账 修改 utils/web3helper 创建合约。 getContract() { const web3 = module.exports.getWeb3() // 定义合约abi const contractAbi = [ { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;name&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;string&quot;, &quot;value&quot;: &quot;kongyixueyuan&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x06fdde03&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;approve&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x095ea7b3&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;totalSupply&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot;, &quot;value&quot;: &quot;10000000000000000000000000&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x18160ddd&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;transferFrom&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x23b872dd&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;decimals&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot;, &quot;value&quot;: &quot;18&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x313ce567&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;burn&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x42966c68&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;balanceOf&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x70a08231&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;burnFrom&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x79cc6790&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;symbol&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;string&quot;, &quot;value&quot;: &quot;kyb&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x95d89b41&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;transfer&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xa9059cbb&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;name&quot;: &quot;_extraData&quot;, &quot;type&quot;: &quot;bytes&quot; } ], &quot;name&quot;: &quot;approveAndCall&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xcae9ca51&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;allowance&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xdd62ed3e&quot; }, { &quot;inputs&quot;: [ { &quot;name&quot;: &quot;initialSupply&quot;, &quot;type&quot;: &quot;uint256&quot;, &quot;index&quot;: 0, &quot;typeShort&quot;: &quot;uint&quot;, &quot;bits&quot;: &quot;256&quot;, &quot;displayName&quot;: &quot;initial Supply&quot;, &quot;template&quot;: &quot;elements_input_uint&quot;, &quot;value&quot;: &quot;10000000&quot; }, { &quot;name&quot;: &quot;tokenName&quot;, &quot;type&quot;: &quot;string&quot;, &quot;index&quot;: 1, &quot;typeShort&quot;: &quot;string&quot;, &quot;bits&quot;: &quot;&quot;, &quot;displayName&quot;: &quot;token Name&quot;, &quot;template&quot;: &quot;elements_input_string&quot;, &quot;value&quot;: &quot;kongyixueyuan&quot; }, { &quot;name&quot;: &quot;tokenSymbol&quot;, &quot;type&quot;: &quot;string&quot;, &quot;index&quot;: 2, &quot;typeShort&quot;: &quot;string&quot;, &quot;bits&quot;: &quot;&quot;, &quot;displayName&quot;: &quot;token Symbol&quot;, &quot;template&quot;: &quot;elements_input_string&quot;, &quot;value&quot;: &quot;kyb&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;constructor&quot;, &quot;signature&quot;: &quot;constructor&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: true, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Transfer&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;_owner&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: true, &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Approval&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Burn&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0xcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5&quot; } ] // 合约地址 const contractAddress = &quot;0xF2B6b76f1d0Ea4dC8ca543765640224819af3aA2&quot; const myContract = new web3.eth.Contract(contractAbi,contractAddress) return myContract } 在 controllers 中 新建 token.js 文件，通过调用合约实现代币转账 ，代码如下： const web3 = require(&quot;../utils/web3helper&quot;).getWeb3() const BigNumber = require(&#39;bignumber.js&#39;); const myContract = require(&quot;../utils/web3helper&quot;).getContract() module.exports = { async sendTokenTransaction (ctx) { let returnResult = { code: 0, msg: &#39;成功！&#39;, data: {} } const data = ctx.request.body const currentAccount = data.currAccount const privateKey = data.privateKey const reciptAccount = data.reciptAccount const txValue = data.txValue // 获取指定账户地址的交易数 let nonce = await web3.eth.getTransactionCount(currentAccount); // 获取设置的位数 const decimals = await myContract.methods.decimals().call() // 将输入的值 转为 最小单位的值 const value = BigNumber(txValue * Math.pow(10,decimals)); const txData = myContract.methods.transfer(reciptAccount, value).encodeABI(); // 获取当前gasprice let gasPrice = await web3.eth.getGasPrice(); // 以太币转账参数 let txParms = { from: currentAccount, // 合约地址 to: myContract.options.address, nonce: nonce, gasPrice: gasPrice, data: txData // 当使用代币转账或者合约调用时 } // 获取一下预估gas let gas = await web3.eth.estimateGas(txParms); txParms.gas = gas; // 用密钥对账单进行签名 let signTx = await web3.eth.accounts.signTransaction(txParms,privateKey) // 将签过名的账单进行发送 try { await web3.eth.sendSignedTransaction(signTx.rawTransaction, function(error, hash){ if (!error) { returnResult.data.hash = hash } else { returnResult.code = &quot;101&quot; returnResult.msg = &quot;失败！&quot; returnResult.data.error = error.message } }) } catch (error) { console.log(error) } ctx.body = returnResult } } 代币转账和以太币转账方法类似，只有两点不同： 转账参数 txParms 中 to 为合约的地址 转账参数 txParms 中 需要设置 data 的值 修改路由配置 代币转账添加路由配置，修改 routers/index.js，添加如下代码： const tokenController = require(&quot;../controllers/token&quot;) router.post(&#39;/token/send&#39;, tokenController.sendTokenTransaction) 修改转账页面 修改 view/transaction.html 中的代码。 转账币种选择加入 kyb的选项。 &lt;div class=&quot;form-group&quot;&gt; &lt;label for=&quot;txValue&quot;&gt;转账金额&lt;/label&gt; &lt;div class=&quot;input-group mb-3&quot;&gt; &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;txValue&quot; placeholder=&quot;&quot;&gt; &lt;div class=&quot;input-group-append&quot;&gt; &lt;select id=&quot;tokenType&quot;&gt; &lt;option value=&quot;eth&quot;&gt;ETH&lt;/option&gt; &lt;option value=&quot;kyb&quot;&gt;KYB&lt;/option&gt; &lt;/select&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; 修改转账 sendTransaction 方法 if (tokenType == &quot;kyb&quot;){ $.post(&quot;/token/send&quot;,params,function(res){ if (res.code == 0) { alert(&quot;交易成功！&quot;) $(&quot;#txHashDiv&quot;).show() $(&quot;#txHash&quot;).html(res.data.hash) } else { alert(&quot;交易失败！&quot;+res.data.error) } }) } 获取账户中的代币金额 修改 controllers/account.js 添加 getTokenBalance 获取代币的信息。 async getTokenBalance(account){ let returnResult = { balance: 0, symbol: &#39;kongyixueyuan&#39; } // 代币小数点位数 const decimals = await myContract.methods.decimals().call() // 代币符号 const symbol = await myContract.methods.symbol().call() const tokenBalance = await myContract.methods.balanceOf(account.address).call() const tokenBalanceNum = tokenBalance / Math.pow(10,decimals) returnResult.balance = tokenBalanceNum returnResult.symbol = symbol return returnResult } 修改 getAccountByKeystore 和 getAccountByPrivatekey 方法，添加获取代币的代码： const tokenResult = await module.exports.getTokenBalance(account) returnResult.data.tokenBalance = tokenResult.balance returnResult.data.tokenSymbol = tokenResult.symbol 项目运行 启动私链网络 使用 geth 启动私有网络 $ geth --datadir ~/privatechain/data0 --networkid 110 --rpc console 开启本地挖矿 miner.start() 启动项目 $ cd myWallet $ node index.js 访问 http://localhost:3000/transaction 查看项目： 源码下载 https://github.com/didianV5/web3EthWallet/tree/master/006_myWallet 关注我 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/08/08/2fabdf759032ff18cc099e7ddeddd111.html" />
<meta property="og:url" content="https://mlh.app/2018/08/08/2fabdf759032ff18cc099e7ddeddd111.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-08T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"私链发放token 编写代币合约代码 打开官方网站：https://www.ethereum.org/token#minimum-viable-token ，拷贝官方标准合约代码。 pragma solidity ^0.4.16; interface tokenRecipient { function receiveApproval(address _from, uint256 _value, address _token, bytes _extraData) external; } contract TokenERC20 { // Public variables of the token string public name; string public symbol; uint8 public decimals = 18; // 18 decimals is the strongly suggested default, avoid changing it uint256 public totalSupply; // This creates an array with all balances mapping (address =&gt; uint256) public balanceOf; mapping (address =&gt; mapping (address =&gt; uint256)) public allowance; // This generates a public event on the blockchain that will notify clients event Transfer(address indexed from, address indexed to, uint256 value); // This generates a public event on the blockchain that will notify clients event Approval(address indexed _owner, address indexed _spender, uint256 _value); // This notifies clients about the amount burnt event Burn(address indexed from, uint256 value); /** * Constructor function * * Initializes contract with initial supply tokens to the creator of the contract */ constructor( uint256 initialSupply, string tokenName, string tokenSymbol ) public { totalSupply = initialSupply * 10 ** uint256(decimals); // Update total supply with the decimal amount balanceOf[msg.sender] = totalSupply; // Give the creator all initial tokens name = tokenName; // Set the name for display purposes symbol = tokenSymbol; // Set the symbol for display purposes } /** * Internal transfer, only can be called by this contract */ function _transfer(address _from, address _to, uint _value) internal { // Prevent transfer to 0x0 address. Use burn() instead require(_to != 0x0); // Check if the sender has enough require(balanceOf[_from] &gt;= _value); // Check for overflows require(balanceOf[_to] + _value &gt;= balanceOf[_to]); // Save this for an assertion in the future uint previousBalances = balanceOf[_from] + balanceOf[_to]; // Subtract from the sender balanceOf[_from] -= _value; // Add the same to the recipient balanceOf[_to] += _value; emit Transfer(_from, _to, _value); // Asserts are used to use static analysis to find bugs in your code. They should never fail assert(balanceOf[_from] + balanceOf[_to] == previousBalances); } /** * Transfer tokens * * Send `_value` tokens to `_to` from your account * * @param _to The address of the recipient * @param _value the amount to send */ function transfer(address _to, uint256 _value) public returns (bool success) { _transfer(msg.sender, _to, _value); return true; } /** * Transfer tokens from other address * * Send `_value` tokens to `_to` on behalf of `_from` * * @param _from The address of the sender * @param _to The address of the recipient * @param _value the amount to send */ function transferFrom(address _from, address _to, uint256 _value) public returns (bool success) { require(_value &lt;= allowance[_from][msg.sender]); // Check allowance allowance[_from][msg.sender] -= _value; _transfer(_from, _to, _value); return true; } /** * Set allowance for other address * * Allows `_spender` to spend no more than `_value` tokens on your behalf * * @param _spender The address authorized to spend * @param _value the max amount they can spend */ function approve(address _spender, uint256 _value) public returns (bool success) { allowance[msg.sender][_spender] = _value; emit Approval(msg.sender, _spender, _value); return true; } /** * Set allowance for other address and notify * * Allows `_spender` to spend no more than `_value` tokens on your behalf, and then ping the contract about it * * @param _spender The address authorized to spend * @param _value the max amount they can spend * @param _extraData some extra information to send to the approved contract */ function approveAndCall(address _spender, uint256 _value, bytes _extraData) public returns (bool success) { tokenRecipient spender = tokenRecipient(_spender); if (approve(_spender, _value)) { spender.receiveApproval(msg.sender, _value, this, _extraData); return true; } } /** * Destroy tokens * * Remove `_value` tokens from the system irreversibly * * @param _value the amount of money to burn */ function burn(uint256 _value) public returns (bool success) { require(balanceOf[msg.sender] &gt;= _value); // Check if the sender has enough balanceOf[msg.sender] -= _value; // Subtract from the sender totalSupply -= _value; // Updates totalSupply emit Burn(msg.sender, _value); return true; } /** * Destroy tokens from other account * * Remove `_value` tokens from the system irreversibly on behalf of `_from`. * * @param _from the address of the sender * @param _value the amount of money to burn */ function burnFrom(address _from, uint256 _value) public returns (bool success) { require(balanceOf[_from] &gt;= _value); // Check if the targeted balance is enough require(_value &lt;= allowance[_from][msg.sender]); // Check allowance balanceOf[_from] -= _value; // Subtract from the targeted balance allowance[_from][msg.sender] -= _value; // Subtract from the sender&#39;s allowance totalSupply -= _value; // Update totalSupply emit Burn(_from, _value); return true; } } name ： 代币名称 symbol： 代币符号 decimals： 代币小数点位数，代币的最小单位， 18表示我们可以拥有 .0000000000000000001单位个代币。 totalSupply() : 发行代币总量。 balanceOf(): 查看对应账号的代币余额。 transfer(): 实现代币交易，用于给用户发送代币（从我们的账户里）。 transferFrom(): 实现代币用户之间的交易。 allowance(): 控制代币的交易，如可交易账号及资产。 approve(): 允许用户可花费的代币数。 下载 Ethereum Wallet 下载Ethereum Wallet ： https://github.com/ethereum/mist/releases 安装完成后，通过命令启动 Ethereum Wallet 客户端。 首先使用 geth 启动私有网络 $ geth --datadir ~/privatechain/data0 --networkid 110 --rpc console 然后通过命令启动 Ethereum Wallet open -a /Applications/Ethereum\\ Wallet.app/ --args --rpc /Users/fujinliang/privatechain/data0/geth.ipc –rpc 的值如何获取？ 可以通过启动私链的控制台，查看ipc文件的路径，如下图所示： 部署代币合约 部署代币合约，设置代币发行数量、名字 点击 DEPLOY 部署合约 需要在geth 目录下启动挖矿。 miner.start(); 查看合约地址和合约Abi web3 调用代币转账 调用合约实现代币转账 修改 utils/web3helper 创建合约。 getContract() { const web3 = module.exports.getWeb3() // 定义合约abi const contractAbi = [ { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;name&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;string&quot;, &quot;value&quot;: &quot;kongyixueyuan&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x06fdde03&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;approve&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x095ea7b3&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;totalSupply&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot;, &quot;value&quot;: &quot;10000000000000000000000000&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x18160ddd&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;transferFrom&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x23b872dd&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;decimals&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot;, &quot;value&quot;: &quot;18&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x313ce567&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;burn&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x42966c68&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;balanceOf&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x70a08231&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;burnFrom&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x79cc6790&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [], &quot;name&quot;: &quot;symbol&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;string&quot;, &quot;value&quot;: &quot;kyb&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0x95d89b41&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;transfer&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xa9059cbb&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;name&quot;: &quot;_extraData&quot;, &quot;type&quot;: &quot;bytes&quot; } ], &quot;name&quot;: &quot;approveAndCall&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;success&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xcae9ca51&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;address&quot; } ], &quot;name&quot;: &quot;allowance&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;view&quot;, &quot;type&quot;: &quot;function&quot;, &quot;signature&quot;: &quot;0xdd62ed3e&quot; }, { &quot;inputs&quot;: [ { &quot;name&quot;: &quot;initialSupply&quot;, &quot;type&quot;: &quot;uint256&quot;, &quot;index&quot;: 0, &quot;typeShort&quot;: &quot;uint&quot;, &quot;bits&quot;: &quot;256&quot;, &quot;displayName&quot;: &quot;initial Supply&quot;, &quot;template&quot;: &quot;elements_input_uint&quot;, &quot;value&quot;: &quot;10000000&quot; }, { &quot;name&quot;: &quot;tokenName&quot;, &quot;type&quot;: &quot;string&quot;, &quot;index&quot;: 1, &quot;typeShort&quot;: &quot;string&quot;, &quot;bits&quot;: &quot;&quot;, &quot;displayName&quot;: &quot;token Name&quot;, &quot;template&quot;: &quot;elements_input_string&quot;, &quot;value&quot;: &quot;kongyixueyuan&quot; }, { &quot;name&quot;: &quot;tokenSymbol&quot;, &quot;type&quot;: &quot;string&quot;, &quot;index&quot;: 2, &quot;typeShort&quot;: &quot;string&quot;, &quot;bits&quot;: &quot;&quot;, &quot;displayName&quot;: &quot;token Symbol&quot;, &quot;template&quot;: &quot;elements_input_string&quot;, &quot;value&quot;: &quot;kyb&quot; } ], &quot;payable&quot;: false, &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;constructor&quot;, &quot;signature&quot;: &quot;constructor&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: true, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Transfer&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;_owner&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: true, &quot;name&quot;: &quot;_spender&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;_value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Approval&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925&quot; }, { &quot;anonymous&quot;: false, &quot;inputs&quot;: [ { &quot;indexed&quot;: true, &quot;name&quot;: &quot;from&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;indexed&quot;: false, &quot;name&quot;: &quot;value&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;Burn&quot;, &quot;type&quot;: &quot;event&quot;, &quot;signature&quot;: &quot;0xcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5&quot; } ] // 合约地址 const contractAddress = &quot;0xF2B6b76f1d0Ea4dC8ca543765640224819af3aA2&quot; const myContract = new web3.eth.Contract(contractAbi,contractAddress) return myContract } 在 controllers 中 新建 token.js 文件，通过调用合约实现代币转账 ，代码如下： const web3 = require(&quot;../utils/web3helper&quot;).getWeb3() const BigNumber = require(&#39;bignumber.js&#39;); const myContract = require(&quot;../utils/web3helper&quot;).getContract() module.exports = { async sendTokenTransaction (ctx) { let returnResult = { code: 0, msg: &#39;成功！&#39;, data: {} } const data = ctx.request.body const currentAccount = data.currAccount const privateKey = data.privateKey const reciptAccount = data.reciptAccount const txValue = data.txValue // 获取指定账户地址的交易数 let nonce = await web3.eth.getTransactionCount(currentAccount); // 获取设置的位数 const decimals = await myContract.methods.decimals().call() // 将输入的值 转为 最小单位的值 const value = BigNumber(txValue * Math.pow(10,decimals)); const txData = myContract.methods.transfer(reciptAccount, value).encodeABI(); // 获取当前gasprice let gasPrice = await web3.eth.getGasPrice(); // 以太币转账参数 let txParms = { from: currentAccount, // 合约地址 to: myContract.options.address, nonce: nonce, gasPrice: gasPrice, data: txData // 当使用代币转账或者合约调用时 } // 获取一下预估gas let gas = await web3.eth.estimateGas(txParms); txParms.gas = gas; // 用密钥对账单进行签名 let signTx = await web3.eth.accounts.signTransaction(txParms,privateKey) // 将签过名的账单进行发送 try { await web3.eth.sendSignedTransaction(signTx.rawTransaction, function(error, hash){ if (!error) { returnResult.data.hash = hash } else { returnResult.code = &quot;101&quot; returnResult.msg = &quot;失败！&quot; returnResult.data.error = error.message } }) } catch (error) { console.log(error) } ctx.body = returnResult } } 代币转账和以太币转账方法类似，只有两点不同： 转账参数 txParms 中 to 为合约的地址 转账参数 txParms 中 需要设置 data 的值 修改路由配置 代币转账添加路由配置，修改 routers/index.js，添加如下代码： const tokenController = require(&quot;../controllers/token&quot;) router.post(&#39;/token/send&#39;, tokenController.sendTokenTransaction) 修改转账页面 修改 view/transaction.html 中的代码。 转账币种选择加入 kyb的选项。 &lt;div class=&quot;form-group&quot;&gt; &lt;label for=&quot;txValue&quot;&gt;转账金额&lt;/label&gt; &lt;div class=&quot;input-group mb-3&quot;&gt; &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;txValue&quot; placeholder=&quot;&quot;&gt; &lt;div class=&quot;input-group-append&quot;&gt; &lt;select id=&quot;tokenType&quot;&gt; &lt;option value=&quot;eth&quot;&gt;ETH&lt;/option&gt; &lt;option value=&quot;kyb&quot;&gt;KYB&lt;/option&gt; &lt;/select&gt; &lt;/div&gt; &lt;/div&gt; &lt;/div&gt; 修改转账 sendTransaction 方法 if (tokenType == &quot;kyb&quot;){ $.post(&quot;/token/send&quot;,params,function(res){ if (res.code == 0) { alert(&quot;交易成功！&quot;) $(&quot;#txHashDiv&quot;).show() $(&quot;#txHash&quot;).html(res.data.hash) } else { alert(&quot;交易失败！&quot;+res.data.error) } }) } 获取账户中的代币金额 修改 controllers/account.js 添加 getTokenBalance 获取代币的信息。 async getTokenBalance(account){ let returnResult = { balance: 0, symbol: &#39;kongyixueyuan&#39; } // 代币小数点位数 const decimals = await myContract.methods.decimals().call() // 代币符号 const symbol = await myContract.methods.symbol().call() const tokenBalance = await myContract.methods.balanceOf(account.address).call() const tokenBalanceNum = tokenBalance / Math.pow(10,decimals) returnResult.balance = tokenBalanceNum returnResult.symbol = symbol return returnResult } 修改 getAccountByKeystore 和 getAccountByPrivatekey 方法，添加获取代币的代码： const tokenResult = await module.exports.getTokenBalance(account) returnResult.data.tokenBalance = tokenResult.balance returnResult.data.tokenSymbol = tokenResult.symbol 项目运行 启动私链网络 使用 geth 启动私有网络 $ geth --datadir ~/privatechain/data0 --networkid 110 --rpc console 开启本地挖矿 miner.start() 启动项目 $ cd myWallet $ node index.js 访问 http://localhost:3000/transaction 查看项目： 源码下载 https://github.com/didianV5/web3EthWallet/tree/master/006_myWallet 关注我 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/08/08/2fabdf759032ff18cc099e7ddeddd111.html","headline":"006 以太坊钱包开发-发放token、token转账","dateModified":"2018-08-08T00:00:00+08:00","datePublished":"2018-08-08T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/08/08/2fabdf759032ff18cc099e7ddeddd111.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>006 以太坊钱包开发-发放token、token转账</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h2 id="私链发放token">私链发放token</h2> 
  <h3 id="编写代币合约代码">编写代币合约代码</h3> 
  <p>打开官方网站：<a href="https://www.ethereum.org/token#minimum-viable-token" rel="nofollow">https://www.ethereum.org/token#minimum-viable-token</a> ，拷贝官方标准合约代码。</p> 
  <pre class="prettyprint"><code class=" hljs java">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.16</span>;

interface tokenRecipient { function receiveApproval(address _from, uint256 _value, address _token, bytes _extraData) external; }

contract TokenERC20 {
    <span class="hljs-comment">// Public variables of the token</span>
    string <span class="hljs-keyword">public</span> name;
    string <span class="hljs-keyword">public</span> symbol;
    uint8 <span class="hljs-keyword">public</span> decimals = <span class="hljs-number">18</span>;
    <span class="hljs-comment">// 18 decimals is the strongly suggested default, avoid changing it</span>
    uint256 <span class="hljs-keyword">public</span> totalSupply;

    <span class="hljs-comment">// This creates an array with all balances</span>
    mapping (address =&gt; uint256) <span class="hljs-keyword">public</span> balanceOf;
    mapping (address =&gt; mapping (address =&gt; uint256)) <span class="hljs-keyword">public</span> allowance;

    <span class="hljs-comment">// This generates a public event on the blockchain that will notify clients</span>
    event Transfer(address indexed from, address indexed to, uint256 value);

    <span class="hljs-comment">// This generates a public event on the blockchain that will notify clients</span>
    event Approval(address indexed _owner, address indexed _spender, uint256 _value);

    <span class="hljs-comment">// This notifies clients about the amount burnt</span>
    event Burn(address indexed from, uint256 value);

    <span class="hljs-javadoc">/** * Constructor function * * Initializes contract with initial supply tokens to the creator of the contract */</span>
    constructor(
        uint256 initialSupply,
        string tokenName,
        string tokenSymbol
    ) <span class="hljs-keyword">public</span> {
        totalSupply = initialSupply * <span class="hljs-number">10</span> ** uint256(decimals);  <span class="hljs-comment">// Update total supply with the decimal amount</span>
        balanceOf[msg.sender] = totalSupply;                <span class="hljs-comment">// Give the creator all initial tokens</span>
        name = tokenName;                                   <span class="hljs-comment">// Set the name for display purposes</span>
        symbol = tokenSymbol;                               <span class="hljs-comment">// Set the symbol for display purposes</span>
    }

    <span class="hljs-javadoc">/** * Internal transfer, only can be called by this contract */</span>
    function _transfer(address _from, address _to, uint _value) internal {
        <span class="hljs-comment">// Prevent transfer to 0x0 address. Use burn() instead</span>
        require(_to != <span class="hljs-number">0x0</span>);
        <span class="hljs-comment">// Check if the sender has enough</span>
        require(balanceOf[_from] &gt;= _value);
        <span class="hljs-comment">// Check for overflows</span>
        require(balanceOf[_to] + _value &gt;= balanceOf[_to]);
        <span class="hljs-comment">// Save this for an assertion in the future</span>
        uint previousBalances = balanceOf[_from] + balanceOf[_to];
        <span class="hljs-comment">// Subtract from the sender</span>
        balanceOf[_from] -= _value;
        <span class="hljs-comment">// Add the same to the recipient</span>
        balanceOf[_to] += _value;
        emit Transfer(_from, _to, _value);
        <span class="hljs-comment">// Asserts are used to use static analysis to find bugs in your code. They should never fail</span>
        <span class="hljs-keyword">assert</span>(balanceOf[_from] + balanceOf[_to] == previousBalances);
    }

    <span class="hljs-javadoc">/** * Transfer tokens * * Send `_value` tokens to `_to` from your account * *<span class="hljs-javadoctag"> @param</span> _to The address of the recipient *<span class="hljs-javadoctag"> @param</span> _value the amount to send */</span>
    function transfer(address _to, uint256 _value) <span class="hljs-keyword">public</span> <span class="hljs-title">returns</span> (bool success) {
        _transfer(msg.sender, _to, _value);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-javadoc">/** * Transfer tokens from other address * * Send `_value` tokens to `_to` on behalf of `_from` * *<span class="hljs-javadoctag"> @param</span> _from The address of the sender *<span class="hljs-javadoctag"> @param</span> _to The address of the recipient *<span class="hljs-javadoctag"> @param</span> _value the amount to send */</span>
    function transferFrom(address _from, address _to, uint256 _value) <span class="hljs-keyword">public</span> <span class="hljs-title">returns</span> (bool success) {
        require(_value &lt;= allowance[_from][msg.sender]);     <span class="hljs-comment">// Check allowance</span>
        allowance[_from][msg.sender] -= _value;
        _transfer(_from, _to, _value);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-javadoc">/** * Set allowance for other address * * Allows `_spender` to spend no more than `_value` tokens on your behalf * *<span class="hljs-javadoctag"> @param</span> _spender The address authorized to spend *<span class="hljs-javadoctag"> @param</span> _value the max amount they can spend */</span>
    function approve(address _spender, uint256 _value) <span class="hljs-keyword">public</span>
        <span class="hljs-title">returns</span> (bool success) {
        allowance[msg.sender][_spender] = _value;
        emit Approval(msg.sender, _spender, _value);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-javadoc">/** * Set allowance for other address and notify * * Allows `_spender` to spend no more than `_value` tokens on your behalf, and then ping the contract about it * *<span class="hljs-javadoctag"> @param</span> _spender The address authorized to spend *<span class="hljs-javadoctag"> @param</span> _value the max amount they can spend *<span class="hljs-javadoctag"> @param</span> _extraData some extra information to send to the approved contract */</span>
    function approveAndCall(address _spender, uint256 _value, bytes _extraData)
        <span class="hljs-keyword">public</span>
        <span class="hljs-title">returns</span> (bool success) {
        tokenRecipient spender = tokenRecipient(_spender);
        <span class="hljs-keyword">if</span> (approve(_spender, _value)) {
            spender.receiveApproval(msg.sender, _value, <span class="hljs-keyword">this</span>, _extraData);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }
    }

    <span class="hljs-javadoc">/** * Destroy tokens * * Remove `_value` tokens from the system irreversibly * *<span class="hljs-javadoctag"> @param</span> _value the amount of money to burn */</span>
    function burn(uint256 _value) <span class="hljs-keyword">public</span> <span class="hljs-title">returns</span> (bool success) {
        require(balanceOf[msg.sender] &gt;= _value);   <span class="hljs-comment">// Check if the sender has enough</span>
        balanceOf[msg.sender] -= _value;            <span class="hljs-comment">// Subtract from the sender</span>
        totalSupply -= _value;                      <span class="hljs-comment">// Updates totalSupply</span>
        emit Burn(msg.sender, _value);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-javadoc">/** * Destroy tokens from other account * * Remove `_value` tokens from the system irreversibly on behalf of `_from`. * *<span class="hljs-javadoctag"> @param</span> _from the address of the sender *<span class="hljs-javadoctag"> @param</span> _value the amount of money to burn */</span>
    function burnFrom(address _from, uint256 _value) <span class="hljs-keyword">public</span> <span class="hljs-title">returns</span> (bool success) {
        require(balanceOf[_from] &gt;= _value);                <span class="hljs-comment">// Check if the targeted balance is enough</span>
        require(_value &lt;= allowance[_from][msg.sender]);    <span class="hljs-comment">// Check allowance</span>
        balanceOf[_from] -= _value;                         <span class="hljs-comment">// Subtract from the targeted balance</span>
        allowance[_from][msg.sender] -= _value;             <span class="hljs-comment">// Subtract from the sender's allowance</span>
        totalSupply -= _value;                              <span class="hljs-comment">// Update totalSupply</span>
        emit Burn(_from, _value);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
}</code></pre> 
  <p>name ： 代币名称 <br> symbol： 代币符号 <br> decimals： 代币小数点位数，代币的最小单位， 18表示我们可以拥有 .0000000000000000001单位个代币。 <br> totalSupply() : 发行代币总量。 <br> balanceOf(): 查看对应账号的代币余额。 <br> transfer(): 实现代币交易，用于给用户发送代币（从我们的账户里）。 <br> transferFrom(): 实现代币用户之间的交易。 <br> allowance(): 控制代币的交易，如可交易账号及资产。 <br> approve(): 允许用户可花费的代币数。</p> 
  <h3 id="下载-ethereum-wallet">下载 Ethereum Wallet</h3> 
  <p>下载Ethereum Wallet ： <a href="https://github.com/ethereum/mist/releases" rel="nofollow">https://github.com/ethereum/mist/releases</a></p> 
  <p><img src="http://pck6uk7jx.bkt.clouddn.com/15334627501367.jpg" alt="-w991" title=""></p> 
  <p>安装完成后，通过命令启动 Ethereum Wallet 客户端。</p> 
  <p>首先使用 <code>geth</code> 启动私有网络</p> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">$</span> <span class="hljs-comment">geth</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">datadir</span> <span class="hljs-comment">~/privatechain/data0</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">networkid</span> <span class="hljs-comment">110</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">rpc</span> <span class="hljs-comment">console</span></code></pre> 
  <p>然后通过命令启动 Ethereum Wallet</p> 
  <pre class="prettyprint"><code class=" hljs livecodeserver"><span class="hljs-built_in">open</span> -<span class="hljs-operator">a</span> /Applications/Ethereum\ Wallet.app/ <span class="hljs-comment">--args --rpc /Users/fujinliang/privatechain/data0/geth.ipc</span></code></pre> 
  <p><strong>–rpc</strong> 的值如何获取？</p> 
  <p>可以通过启动私链的控制台，查看ipc文件的路径，如下图所示：</p> 
  <p><img src="http://pck6uk7jx.bkt.clouddn.com/15334653251343.jpg" alt="-w570" title=""></p> 
  <h3 id="部署代币合约">部署代币合约</h3> 
  <p><img src="http://oscd4dgpc.bkt.clouddn.com/20180718-205016.png" alt="" title=""></p> 
  <p><strong>部署代币合约，设置代币发行数量、名字</strong></p> 
  <p><img src="http://oscd4dgpc.bkt.clouddn.com/20180718-205150.png" alt="" title=""></p> 
  <p><strong>点击 DEPLOY 部署合约</strong> <br> <img src="http://oscd4dgpc.bkt.clouddn.com/20180718-205217.png" alt="" title=""></p> 
  <p>需要在<code>geth</code> 目录下启动挖矿。</p> 
  <pre class="prettyprint"><code class=" hljs sql">miner.<span class="hljs-operator"><span class="hljs-keyword">start</span>();</span></code></pre> 
  <p><strong>查看合约地址和合约Abi</strong></p> 
  <p><img src="http://oscd4dgpc.bkt.clouddn.com/20180718-205400.png" alt="" title=""></p> 
  <h2 id="web3-调用代币转账">web3 调用代币转账</h2> 
  <h3 id="调用合约实现代币转账">调用合约实现代币转账</h3> 
  <p>修改 <code>utils/web3helper</code> 创建合约。</p> 
  <pre class="prettyprint"><code class=" hljs d">getContract() {

        <span class="hljs-keyword">const</span> web3 = <span class="hljs-keyword">module</span>.exports.getWeb3()
        <span class="hljs-comment">// 定义合约abi</span>
        <span class="hljs-keyword">const</span> contractAbi = [ { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"inputs"</span>: [], <span class="hljs-string">"name"</span>: <span class="hljs-string">"name"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"kongyixueyuan"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"view"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x06fdde03"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_spender"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"approve"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bool"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x095ea7b3"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"inputs"</span>: [], <span class="hljs-string">"name"</span>: <span class="hljs-string">"totalSupply"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"10000000000000000000000000"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"view"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x18160ddd"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_from"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_to"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"transferFrom"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bool"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x23b872dd"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"inputs"</span>: [], <span class="hljs-string">"name"</span>: <span class="hljs-string">"decimals"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint8"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"18"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"view"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x313ce567"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"burn"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bool"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x42966c68"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"balanceOf"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"view"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x70a08231"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_from"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"burnFrom"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bool"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x79cc6790"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"inputs"</span>: [], <span class="hljs-string">"name"</span>: <span class="hljs-string">"symbol"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"kyb"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"view"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x95d89b41"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_to"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"transfer"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bool"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0xa9059cbb"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_spender"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"_extraData"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bytes"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"approveAndCall"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"success"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"bool"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0xcae9ca51"</span> }, { <span class="hljs-string">"constant"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"allowance"</span>, <span class="hljs-string">"outputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"view"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0xdd62ed3e"</span> }, { <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"name"</span>: <span class="hljs-string">"initialSupply"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span>, <span class="hljs-string">"index"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"typeShort"</span>: <span class="hljs-string">"uint"</span>, <span class="hljs-string">"bits"</span>: <span class="hljs-string">"256"</span>, <span class="hljs-string">"displayName"</span>: <span class="hljs-string">"initial Supply"</span>, <span class="hljs-string">"template"</span>: <span class="hljs-string">"elements_input_uint"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"10000000"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"tokenName"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"index"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"typeShort"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"bits"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"displayName"</span>: <span class="hljs-string">"token Name"</span>, <span class="hljs-string">"template"</span>: <span class="hljs-string">"elements_input_string"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"kongyixueyuan"</span> }, { <span class="hljs-string">"name"</span>: <span class="hljs-string">"tokenSymbol"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"index"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"typeShort"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"bits"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"displayName"</span>: <span class="hljs-string">"token Symbol"</span>, <span class="hljs-string">"template"</span>: <span class="hljs-string">"elements_input_string"</span>, <span class="hljs-string">"value"</span>: <span class="hljs-string">"kyb"</span> } ], <span class="hljs-string">"payable"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"stateMutability"</span>: <span class="hljs-string">"nonpayable"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"constructor"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"constructor"</span> }, { <span class="hljs-string">"anonymous"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"from"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"to"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"Transfer"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"event"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"</span> }, { <span class="hljs-string">"anonymous"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"_owner"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"_spender"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"_value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"Approval"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"event"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925"</span> }, { <span class="hljs-string">"anonymous"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"inputs"</span>: [ { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">true</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"from"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"address"</span> }, { <span class="hljs-string">"indexed"</span>: <span class="hljs-literal">false</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"value"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"uint256"</span> } ], <span class="hljs-string">"name"</span>: <span class="hljs-string">"Burn"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"event"</span>, <span class="hljs-string">"signature"</span>: <span class="hljs-string">"0xcc16f5dbb4873280815c1ee09dbd06736cffcc184412cf7a71a0fdb75d397ca5"</span> } ]
        <span class="hljs-comment">// 合约地址</span>
        <span class="hljs-keyword">const</span> contractAddress = <span class="hljs-string">"0xF2B6b76f1d0Ea4dC8ca543765640224819af3aA2"</span>

        <span class="hljs-keyword">const</span> myContract = <span class="hljs-keyword">new</span> web3.eth.Contract(contractAbi,contractAddress)

        <span class="hljs-keyword">return</span> myContract
    }
</code></pre> 
  <p>在 controllers 中 新建 <code>token.js</code> 文件，通过调用合约实现代币转账 ，代码如下：</p> 
  <pre class="prettyprint"><code class=" hljs cs"><span class="hljs-keyword">const</span> web3 = require(<span class="hljs-string">"../utils/web3helper"</span>).getWeb3()
<span class="hljs-keyword">const</span> BigNumber = require(<span class="hljs-string">'bignumber.js'</span>);
<span class="hljs-keyword">const</span> myContract = require(<span class="hljs-string">"../utils/web3helper"</span>).getContract()

module.exports = {

    <span class="hljs-keyword">async</span> sendTokenTransaction (ctx) {
        <span class="hljs-keyword">let</span> returnResult = {
            code: <span class="hljs-number">0</span>,
            msg: <span class="hljs-string">'成功！'</span>,
            data: {}
        }

        <span class="hljs-keyword">const</span> data = ctx.request.body

        <span class="hljs-keyword">const</span> currentAccount = data.currAccount
        <span class="hljs-keyword">const</span> privateKey = data.privateKey
        <span class="hljs-keyword">const</span> reciptAccount = data.reciptAccount
        <span class="hljs-keyword">const</span> txValue = data.txValue
        <span class="hljs-comment">// 获取指定账户地址的交易数</span>
        <span class="hljs-keyword">let</span> nonce = <span class="hljs-keyword">await</span> web3.eth.getTransactionCount(currentAccount);

        <span class="hljs-comment">// 获取设置的位数</span>
        <span class="hljs-keyword">const</span> decimals = <span class="hljs-keyword">await</span> myContract.methods.decimals().call()
        <span class="hljs-comment">// 将输入的值 转为 最小单位的值</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">value</span> = BigNumber(txValue * Math.pow(<span class="hljs-number">10</span>,decimals));
        <span class="hljs-keyword">const</span> txData = myContract.methods.transfer(reciptAccount, <span class="hljs-keyword">value</span>).encodeABI();

        <span class="hljs-comment">// 获取当前gasprice</span>
        <span class="hljs-keyword">let</span> gasPrice = <span class="hljs-keyword">await</span> web3.eth.getGasPrice();

        <span class="hljs-comment">// 以太币转账参数 </span>
        <span class="hljs-keyword">let</span> txParms = {
            <span class="hljs-keyword">from</span>: currentAccount,
            <span class="hljs-comment">// 合约地址</span>
            to: myContract.options.address,
            nonce: nonce,
            gasPrice: gasPrice,
            data: txData <span class="hljs-comment">// 当使用代币转账或者合约调用时</span>
        }

        <span class="hljs-comment">// 获取一下预估gas</span>
        <span class="hljs-keyword">let</span> gas = <span class="hljs-keyword">await</span> web3.eth.estimateGas(txParms);
        txParms.gas = gas;
        <span class="hljs-comment">// 用密钥对账单进行签名</span>
        <span class="hljs-keyword">let</span> signTx = <span class="hljs-keyword">await</span> web3.eth.accounts.signTransaction(txParms,privateKey)

        <span class="hljs-comment">// 将签过名的账单进行发送</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> web3.eth.sendSignedTransaction(signTx.rawTransaction, function(error, hash){
                <span class="hljs-keyword">if</span> (!error) {
                    returnResult.data.hash = hash
                } <span class="hljs-keyword">else</span> {
                    returnResult.code = <span class="hljs-string">"101"</span>
                    returnResult.msg = <span class="hljs-string">"失败！"</span>
                    returnResult.data.error = error.message

                }
            })
        } <span class="hljs-keyword">catch</span> (error) {
            console.log(error)
        }

        ctx.body = returnResult
    }
}</code></pre> 
  <p>代币转账和以太币转账方法类似，只有两点不同：</p> 
  <ul> 
   <li>转账参数 <code>txParms</code> 中 <code>to</code> 为合约的地址</li> 
   <li>转账参数 <code>txParms</code> 中 需要设置 <code>data</code> 的值</li> 
  </ul> 
  <h3 id="修改路由配置">修改路由配置</h3> 
  <p>代币转账添加路由配置，修改 <code>routers/index.js</code>，添加如下代码：</p> 
  <pre class="prettyprint"><code class=" hljs javascript"><span class="hljs-keyword">const</span> tokenController = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../controllers/token"</span>)

router.post(<span class="hljs-string">'/token/send'</span>, tokenController.sendTokenTransaction)</code></pre> 
  <h3 id="修改转账页面">修改转账页面</h3> 
  <p>修改 <code>view/transaction.html</code> 中的代码。</p> 
  <p><strong>转账币种选择加入 <code>kyb</code>的选项。</strong></p> 
  <pre class="prettyprint"><code class=" hljs xml">    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-group"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"txValue"</span>&gt;</span>转账金额<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"input-group mb-3"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"form-control"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"txValue"</span> <span class="hljs-attribute">placeholder</span>=<span class="hljs-value">""</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"input-group-append"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">select</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"tokenType"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">option</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"eth"</span>&gt;</span>ETH<span class="hljs-tag">&lt;/<span class="hljs-title">option</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">option</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"kyb"</span>&gt;</span>KYB<span class="hljs-tag">&lt;/<span class="hljs-title">option</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">select</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span></code></pre> 
  <p><strong>修改转账 <code>sendTransaction</code> 方法</strong></p> 
  <pre class="prettyprint"><code class=" hljs javascript">    <span class="hljs-keyword">if</span> (tokenType == <span class="hljs-string">"kyb"</span>){
            $.post(<span class="hljs-string">"/token/send"</span>,params,<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span>{</span>
                <span class="hljs-keyword">if</span> (res.code == <span class="hljs-number">0</span>) {
                    alert(<span class="hljs-string">"交易成功！"</span>)
                    $(<span class="hljs-string">"#txHashDiv"</span>).show()
                    $(<span class="hljs-string">"#txHash"</span>).html(res.data.hash)
                } <span class="hljs-keyword">else</span> {
                    alert(<span class="hljs-string">"交易失败！"</span>+res.data.error)
                }
            })
        }  </code></pre> 
  <h3 id="获取账户中的代币金额">获取账户中的代币金额</h3> 
  <p>修改 <code>controllers/account.js</code> 添加 <code>getTokenBalance</code> 获取代币的信息。</p> 
  <pre class="prettyprint"><code class=" hljs cs">    <span class="hljs-keyword">async</span> getTokenBalance(account){

        <span class="hljs-keyword">let</span> returnResult = {
            balance: <span class="hljs-number">0</span>,
            symbol: <span class="hljs-string">'kongyixueyuan'</span>
        }

        <span class="hljs-comment">// 代币小数点位数</span>
        <span class="hljs-keyword">const</span> decimals = <span class="hljs-keyword">await</span> myContract.methods.decimals().call()
        <span class="hljs-comment">// 代币符号</span>
        <span class="hljs-keyword">const</span> symbol = <span class="hljs-keyword">await</span> myContract.methods.symbol().call()
        <span class="hljs-keyword">const</span> tokenBalance = <span class="hljs-keyword">await</span> myContract.methods.balanceOf(account.address).call()
        <span class="hljs-keyword">const</span> tokenBalanceNum = tokenBalance / Math.pow(<span class="hljs-number">10</span>,decimals)

        returnResult.balance = tokenBalanceNum
        returnResult.symbol = symbol

       <span class="hljs-keyword">return</span> returnResult
    }</code></pre> 
  <p>修改 <strong>getAccountByKeystore</strong> 和 <strong>getAccountByPrivatekey</strong> 方法，添加获取代币的代码：</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">const tokenResult = await module<span class="hljs-preprocessor">.exports</span><span class="hljs-preprocessor">.getTokenBalance</span>(account)
returnResult<span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.tokenBalance</span> = tokenResult<span class="hljs-preprocessor">.balance</span>
returnResult<span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.tokenSymbol</span> = tokenResult<span class="hljs-preprocessor">.symbol</span></code></pre> 
  <h2 id="项目运行">项目运行</h2> 
  <h3 id="启动私链网络">启动私链网络</h3> 
  <p>使用 <code>geth</code> 启动私有网络</p> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">$</span> <span class="hljs-comment">geth</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">datadir</span> <span class="hljs-comment">~/privatechain/data0</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">networkid</span> <span class="hljs-comment">110</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">rpc</span> <span class="hljs-comment">console</span></code></pre> 
  <p>开启本地挖矿</p> 
  <pre class="prettyprint"><code class=" hljs sql">miner.<span class="hljs-operator"><span class="hljs-keyword">start</span>()</span></code></pre> 
  <h3 id="启动项目">启动项目</h3> 
  <pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-variable">$ </span>cd myWallet
<span class="hljs-variable">$ </span>node index.js</code></pre> 
  <p>访问 <a href="http://localhost:3000/transaction" rel="nofollow">http://localhost:3000/transaction</a> 查看项目：</p> 
  <p><img src="http://oscd4dgpc.bkt.clouddn.com/2018-07-18204319.gif" alt="" title=""></p> 
  <h2 id="源码下载">源码下载</h2> 
  <p><a href="https://github.com/didianV5/web3EthWallet/tree/master/006_myWallet" rel="nofollow">https://github.com/didianV5/web3EthWallet/tree/master/006_myWallet</a></p> 
  <h2 id="关注我">关注我</h2> 
  <p><img src="http://pck6uk7jx.bkt.clouddn.com/wechat001.png" alt="公众号" title=""></p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lengxue789/article/details/81507110,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lengxue789/article/details/81507110,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
