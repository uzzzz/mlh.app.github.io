<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>eos源码赏析（十二）：EOS之从“狼人游戏”看智能合约调用及权限分配（下） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="eos源码赏析（十二）：EOS之从“狼人游戏”看智能合约调用及权限分配（下）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="接上篇，本篇从智能合约内部权限使用出发，结合“狼人游戏”源码，谈谈eosio中权限的分配及使用，本文主要分为以下三部分： 狼人团队的声明探析 多签名账户 权限eosio.code的相关说明 狼人团队的声明 eos3d合约地址 https://github.com/yanxi-me/eos3d-contract 在“狼人游戏”源码底部，其团队已声明： 将owner&nbsp;权限已经移交给了eosio.prods，即所有的出块节点（BP)，active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币。开发团队已经对合约没有任何控制权限。但其做过的恶会永远记录在这条链上，从笔者角度出发，不建议参与这种资金盘游戏，哪怕源码已公开，你对源码已经了如指掌，但奈何eos中合约可更新机制，我们还是无法确保合约开发者永远不作恶。 由于源码已作出更新，我们就从最新的代码开始看。狼人游戏需要我们拿一定量的eos代币以某一比例去兑换相应的狼人系统的货币，这个过程其实可以看做为抵押，将自己的eos代币抵押至狼人团队的账户。而后有分红以及最后的获奖，均为从狼人团队账户转账至分红者及最后的获奖者。在狼人团队最新的声明中指出：active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币，那么我们来看看是如何进行提币的（也可参考exchange合约中的内容或者dice小游戏中的内容），代码如下：&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图1 eos3d::withdraw的实现 从上图中可以看出，_this_contract（即本合约，或称狼人游戏）的active权限是保留着的，但一个合约的部署或者更新使用active权限即可。我们从上篇文章中（eos源码赏析（十一）：EOS之从“狼人游戏”看智能合约调用及权限分配（上））也可以得知：内联通信采用调用其他action的形式，这些action需要作为调用操作的一部分来执行。在确保当前action可以执行的情况下，内联操作使用和当前action相同的域和权限进行操作。而在withdraw中使用action send的形式调用eosio.token给分红者或最后中奖者转出一定量的eos代币，此处使用了该合约账户的active权限。 作为eos的开发者我们都应知道，eos的智能合约是可以更新的，前期狼人游戏获取用户权限甚至更新用户权限，本文不谈溢出问题，从权限的角度出发这些潜在危险就令人惊惧。具体权限的解释说明及测试，可参考以下文章币乎大佬荆凯的文章： https://bihu.com/article/1074544 关于owner和active的权限在官方文档及众多博文内容中已经有过许多介绍，不管是开发者还是eos的持有者都应当有相当高的警惕在保存好自己私钥的同时，不擅自授权自己账户的active权限给一个不可信智能合约，因为你永远无法保证一个合约开发者不去作恶。 在介绍完狼人团队给出的active权限的相关解释之后，其团队还提到：将owner&nbsp;权限已经移交给了&nbsp;eosio.prods中的eosio.prods又是什么呢。我们通过获取账户信息可以看到： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图2 eosio.prods 在上图中我们可以看出这个账户是拥有了21个超级节点中的任意15节点的账户的active权限的，也就是说只有这15个节点的账户一致通过某一协定才能使用该active权限。这就涉及到了我们将要谈到的多签名账户。 多签名账户 我们在搭建自己的单机节点使用eosio注册新的账户或者在主网找别人注册账户的时候，均使用了单个账户的active权限。那么这个多签名账户是如何实现的呢？我们以明教为例，为了限制明教教主张无忌的一些作为，将教主的owner权限和active权限分别赋予光明左使杨逍和光明右使范遥的许可。我们先创建三人的账户，然后分别将杨逍和范遥的公钥通过set account permission的形式赋予张无忌这个账户的owner权限， 命令行如下: cleos set account permission zhangwuji owner&#39;{&quot;threshold&quot;: 2, &quot;keys&quot;:[{&quot;key&quot;:&quot;EOS4yMJpETmGkfdzppQJaJ4cbyqrskAVEmt4vbRHd7kVJ8JVdRkm7&quot;,&quot;weight&quot;:1},{&quot;key&quot;:&quot;EOS874qo6PMTt2eTao5S6SC2AxJqPH9DE6f9tS7nsHRbzG1NkrorL&quot;,&quot;weight&quot;:1}], &quot;accounts&quot;:[{&quot;permission&quot;:{&quot;actor&quot;:&quot;fanyao&quot;,&quot;permission&quot;:&quot;owner&quot;},&quot;weight&quot;:1},{&quot;permission&quot;:{&quot;actor&quot;:&quot;yangxiao&quot;,&quot;permission&quot;:&quot;owner&quot;}, &quot;weight&quot;:1}],&quot;waits&quot;: []}}&#39; -p zhangwuji@owner active权限的设定也是类似 如下图： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图3 权限设定&nbsp; &nbsp; &nbsp; &nbsp;通过cleos&nbsp; get&nbsp; account zhangwuji&nbsp;我们可以看到，张无忌这个账户的owner包含有两个公钥，也是我们刚才注册杨逍和范遥两个账户的公钥,同时其owner权限转交给了yangxiao@owner和fanyao@owner。通过查看账户张无忌中的内容可以看到，其owner为2，也就是我们刚才在设置权限的时候threshold设置为2，此处2表示张无忌这个账户的owner权限操作需要经过杨逍和范遥两人的owner权限才可执行。而如果threshold设置为1的话，则杨逍或者范遥任意一人的aowner权限即可令张无忌的owner权限执行。此时明教也不是张无忌一人说了算了。 &nbsp; &nbsp;在狼人团队转交的owner权限给15个超级节点的active，也就意味着只有超级节点中任意15个超级节点的active权限全部同意，狼人团队的智能合约owner权限才可执行，这样源码中没有获取用户权限或更新用户权限的操作，而其owner权限又掌握在eosio.prods手里，大大降低了其主动作恶的风险。但依然，狼人游戏智能合约的active权限还依旧保留着，我们依然要谨慎的参与此类游戏，因合约的部署和更新使用active权限即可，笔者再次建议不授权自己的权限给任何不可信任合约。关于多重签名的使用，集中在系统四大合约之一的eosio.msig智能合约中，我们有时间再进行讨论。 eosio.code的相关说明 &nbsp; &nbsp; &nbsp; &nbsp;我们在查看狼人团队的账户时发现，其账户的active权限有@eosio.code，最近两天群里讨论较多的也是权限相关的内容，我在上一篇内容中也对某个账户使用了eosio.code权限的设置。我们来思考一个问题,假设狼人团队获取了账户user的active权限,他们是否可以通过更新智能合约的形式偷偷的调用eosio.token的transfer函数转走user的eos代币呢?答案也是否定的。这还需要涉及到eosio.code权限的使用，用户user必须授权其active权限中加入狼人团队eosio.code权限，这样针对eosio.token这个合约，狼人团队才可使用user的active权限来操作eosio.token中的相关action。 &nbsp; &nbsp; &nbsp; &nbsp;关于eosio.code权限的issue，大家可以参考下： &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;https://github.com/EOSIO/eos/issues/4348 &nbsp; &nbsp; &nbsp; &nbsp; 对于一个相对去中心的系统来说，权限扮演的角色十分重要，那么这个eosio.code又是什么呢？今天中午在群里关于eosio.code的讨论如下，暂时得出结论如下：不擅自将自己的active权限授权给不可信智能合约的eosio.code特殊权限。 &nbsp; &nbsp; &nbsp; &nbsp;那么eosio.code这个权限又是什么呢？我们从源码中可以看到，eosio.code是个虚拟存在的但不得不使用的特殊权限。那么我个eosio.code的权限校验都使用在哪些地方呢？我们继续来看。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图4 eosio.code &nbsp; &nbsp; &nbsp; 读者中的大部分应该都在帮别人注册主网账户或者自己搭建测试节点的时候使用过newaccount指令，但newaccount指令后面进行了哪些操作，我们可能并未知悉，在图5中便是newaccount的具体信息,在进行对待注册账户的各种校验之后，调用validate_authority_precondition即权限校验的先决条件需要满足注册时赋予了eosio.code权限。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图5&nbsp;validate_authority_precondition 笔者在翻看代码更新记录时，eosio团队在历史修改中关于validate_authority_precondition函数的解释如下： A contract no longer satisfies all permissions of its account by default. If a contract needs to be able send an inline action or deferred transaction and requires adding some specific permission to the authorizations of the action, then the authority of that permission must be set up in such a way that it can be satisfied by just the &quot;eosio.code&quot; permission. 也就印证了我们上面所说的action的发起人必须授权其active权限中加入智能合约账户的eosio.code权限，这样针对eosio.token这个合约，智能合约才能用action发起人的active权限来操作eosio.token中的相关action，如issue，如transfer。 而在另一个issue中，有人提出的相关质疑，BM也做了回复，如下： https://github.com/EOSIO/eos/issues/3002 1、Why does dice contract ask for user‘s active key? the user can not trust so many DApp before to use them in product. And to enable DApp to transfer any cash in any amount from user&#39;s account is too dangerous and not acceptable in practice. 2、even dice app version 1.0.0 is secure enough, how to ensure version 1.0.1/1.1.0/1.2.0 .... is enough too? think about this case : a user authorize dice app at version 1.0.0, then a bad guy change dice app and update it maliciously. a). how to let user just auth exactly current version&#39;s DApp and do not auth to the future version? b). how to disable contract be updated by other account? it seems anybody can update a DApp in private net. BM的回答，也就是我们现在在用的版本，加入了eosio.code的虚拟权限 The dice app should be modified so as not to require permission from user to transfer funds. Future feature would be to allow delegation of &quot;contract@eosio.code&quot; to refer to a particular code revision rather than &quot;any code revision&quot;. &nbsp; 我们现在来回顾下本篇内容所要表述的事情： 狼人游戏团队智能合约权限的声明 以明教张无忌为例演示多重签名的实现 以群内eosio.code权限的讨论为契机,对eosio.code的使用做分享 通过以上分析我们可以得出以下结论 不管是合约开发者还是代币持有者,都要时刻对权限的授权增加警惕 为了整个生态持续良好的发展,智能合约开发者在无法公开源码的情况下,上交出智能合约账户的部分权限或许是一种很好的方式 多重签名是区块链行业发展的重要组成部分 用户的active权限不授权不可信和智能合约eosio.code权限 &nbsp; 最后笔者再哔哔几句,eos或者说区块链的生态还处于初期,很多内容或场景并未完善,作为开发者请爱惜自己的羽毛,毕竟没有羽毛的托付,再厉害的鸟面对蔚然蓝天时也无法起飞. &nbsp; 如果你觉得我的文章对你有一定的帮助，请点击文章末尾的喜欢该作者。 如果你对eos开发感兴趣,欢迎关注本公众号,一起学习eos开发。&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 微信公众号 &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有任何疑问或者指教请添加本人个人微信,当然有对eos开发感兴趣或者金庸粉的也可以添加一起交流,备注eos开发或金庸。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;个人微信号 阅读更多" />
<meta property="og:description" content="接上篇，本篇从智能合约内部权限使用出发，结合“狼人游戏”源码，谈谈eosio中权限的分配及使用，本文主要分为以下三部分： 狼人团队的声明探析 多签名账户 权限eosio.code的相关说明 狼人团队的声明 eos3d合约地址 https://github.com/yanxi-me/eos3d-contract 在“狼人游戏”源码底部，其团队已声明： 将owner&nbsp;权限已经移交给了eosio.prods，即所有的出块节点（BP)，active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币。开发团队已经对合约没有任何控制权限。但其做过的恶会永远记录在这条链上，从笔者角度出发，不建议参与这种资金盘游戏，哪怕源码已公开，你对源码已经了如指掌，但奈何eos中合约可更新机制，我们还是无法确保合约开发者永远不作恶。 由于源码已作出更新，我们就从最新的代码开始看。狼人游戏需要我们拿一定量的eos代币以某一比例去兑换相应的狼人系统的货币，这个过程其实可以看做为抵押，将自己的eos代币抵押至狼人团队的账户。而后有分红以及最后的获奖，均为从狼人团队账户转账至分红者及最后的获奖者。在狼人团队最新的声明中指出：active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币，那么我们来看看是如何进行提币的（也可参考exchange合约中的内容或者dice小游戏中的内容），代码如下：&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图1 eos3d::withdraw的实现 从上图中可以看出，_this_contract（即本合约，或称狼人游戏）的active权限是保留着的，但一个合约的部署或者更新使用active权限即可。我们从上篇文章中（eos源码赏析（十一）：EOS之从“狼人游戏”看智能合约调用及权限分配（上））也可以得知：内联通信采用调用其他action的形式，这些action需要作为调用操作的一部分来执行。在确保当前action可以执行的情况下，内联操作使用和当前action相同的域和权限进行操作。而在withdraw中使用action send的形式调用eosio.token给分红者或最后中奖者转出一定量的eos代币，此处使用了该合约账户的active权限。 作为eos的开发者我们都应知道，eos的智能合约是可以更新的，前期狼人游戏获取用户权限甚至更新用户权限，本文不谈溢出问题，从权限的角度出发这些潜在危险就令人惊惧。具体权限的解释说明及测试，可参考以下文章币乎大佬荆凯的文章： https://bihu.com/article/1074544 关于owner和active的权限在官方文档及众多博文内容中已经有过许多介绍，不管是开发者还是eos的持有者都应当有相当高的警惕在保存好自己私钥的同时，不擅自授权自己账户的active权限给一个不可信智能合约，因为你永远无法保证一个合约开发者不去作恶。 在介绍完狼人团队给出的active权限的相关解释之后，其团队还提到：将owner&nbsp;权限已经移交给了&nbsp;eosio.prods中的eosio.prods又是什么呢。我们通过获取账户信息可以看到： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图2 eosio.prods 在上图中我们可以看出这个账户是拥有了21个超级节点中的任意15节点的账户的active权限的，也就是说只有这15个节点的账户一致通过某一协定才能使用该active权限。这就涉及到了我们将要谈到的多签名账户。 多签名账户 我们在搭建自己的单机节点使用eosio注册新的账户或者在主网找别人注册账户的时候，均使用了单个账户的active权限。那么这个多签名账户是如何实现的呢？我们以明教为例，为了限制明教教主张无忌的一些作为，将教主的owner权限和active权限分别赋予光明左使杨逍和光明右使范遥的许可。我们先创建三人的账户，然后分别将杨逍和范遥的公钥通过set account permission的形式赋予张无忌这个账户的owner权限， 命令行如下: cleos set account permission zhangwuji owner&#39;{&quot;threshold&quot;: 2, &quot;keys&quot;:[{&quot;key&quot;:&quot;EOS4yMJpETmGkfdzppQJaJ4cbyqrskAVEmt4vbRHd7kVJ8JVdRkm7&quot;,&quot;weight&quot;:1},{&quot;key&quot;:&quot;EOS874qo6PMTt2eTao5S6SC2AxJqPH9DE6f9tS7nsHRbzG1NkrorL&quot;,&quot;weight&quot;:1}], &quot;accounts&quot;:[{&quot;permission&quot;:{&quot;actor&quot;:&quot;fanyao&quot;,&quot;permission&quot;:&quot;owner&quot;},&quot;weight&quot;:1},{&quot;permission&quot;:{&quot;actor&quot;:&quot;yangxiao&quot;,&quot;permission&quot;:&quot;owner&quot;}, &quot;weight&quot;:1}],&quot;waits&quot;: []}}&#39; -p zhangwuji@owner active权限的设定也是类似 如下图： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图3 权限设定&nbsp; &nbsp; &nbsp; &nbsp;通过cleos&nbsp; get&nbsp; account zhangwuji&nbsp;我们可以看到，张无忌这个账户的owner包含有两个公钥，也是我们刚才注册杨逍和范遥两个账户的公钥,同时其owner权限转交给了yangxiao@owner和fanyao@owner。通过查看账户张无忌中的内容可以看到，其owner为2，也就是我们刚才在设置权限的时候threshold设置为2，此处2表示张无忌这个账户的owner权限操作需要经过杨逍和范遥两人的owner权限才可执行。而如果threshold设置为1的话，则杨逍或者范遥任意一人的aowner权限即可令张无忌的owner权限执行。此时明教也不是张无忌一人说了算了。 &nbsp; &nbsp;在狼人团队转交的owner权限给15个超级节点的active，也就意味着只有超级节点中任意15个超级节点的active权限全部同意，狼人团队的智能合约owner权限才可执行，这样源码中没有获取用户权限或更新用户权限的操作，而其owner权限又掌握在eosio.prods手里，大大降低了其主动作恶的风险。但依然，狼人游戏智能合约的active权限还依旧保留着，我们依然要谨慎的参与此类游戏，因合约的部署和更新使用active权限即可，笔者再次建议不授权自己的权限给任何不可信任合约。关于多重签名的使用，集中在系统四大合约之一的eosio.msig智能合约中，我们有时间再进行讨论。 eosio.code的相关说明 &nbsp; &nbsp; &nbsp; &nbsp;我们在查看狼人团队的账户时发现，其账户的active权限有@eosio.code，最近两天群里讨论较多的也是权限相关的内容，我在上一篇内容中也对某个账户使用了eosio.code权限的设置。我们来思考一个问题,假设狼人团队获取了账户user的active权限,他们是否可以通过更新智能合约的形式偷偷的调用eosio.token的transfer函数转走user的eos代币呢?答案也是否定的。这还需要涉及到eosio.code权限的使用，用户user必须授权其active权限中加入狼人团队eosio.code权限，这样针对eosio.token这个合约，狼人团队才可使用user的active权限来操作eosio.token中的相关action。 &nbsp; &nbsp; &nbsp; &nbsp;关于eosio.code权限的issue，大家可以参考下： &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;https://github.com/EOSIO/eos/issues/4348 &nbsp; &nbsp; &nbsp; &nbsp; 对于一个相对去中心的系统来说，权限扮演的角色十分重要，那么这个eosio.code又是什么呢？今天中午在群里关于eosio.code的讨论如下，暂时得出结论如下：不擅自将自己的active权限授权给不可信智能合约的eosio.code特殊权限。 &nbsp; &nbsp; &nbsp; &nbsp;那么eosio.code这个权限又是什么呢？我们从源码中可以看到，eosio.code是个虚拟存在的但不得不使用的特殊权限。那么我个eosio.code的权限校验都使用在哪些地方呢？我们继续来看。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图4 eosio.code &nbsp; &nbsp; &nbsp; 读者中的大部分应该都在帮别人注册主网账户或者自己搭建测试节点的时候使用过newaccount指令，但newaccount指令后面进行了哪些操作，我们可能并未知悉，在图5中便是newaccount的具体信息,在进行对待注册账户的各种校验之后，调用validate_authority_precondition即权限校验的先决条件需要满足注册时赋予了eosio.code权限。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图5&nbsp;validate_authority_precondition 笔者在翻看代码更新记录时，eosio团队在历史修改中关于validate_authority_precondition函数的解释如下： A contract no longer satisfies all permissions of its account by default. If a contract needs to be able send an inline action or deferred transaction and requires adding some specific permission to the authorizations of the action, then the authority of that permission must be set up in such a way that it can be satisfied by just the &quot;eosio.code&quot; permission. 也就印证了我们上面所说的action的发起人必须授权其active权限中加入智能合约账户的eosio.code权限，这样针对eosio.token这个合约，智能合约才能用action发起人的active权限来操作eosio.token中的相关action，如issue，如transfer。 而在另一个issue中，有人提出的相关质疑，BM也做了回复，如下： https://github.com/EOSIO/eos/issues/3002 1、Why does dice contract ask for user‘s active key? the user can not trust so many DApp before to use them in product. And to enable DApp to transfer any cash in any amount from user&#39;s account is too dangerous and not acceptable in practice. 2、even dice app version 1.0.0 is secure enough, how to ensure version 1.0.1/1.1.0/1.2.0 .... is enough too? think about this case : a user authorize dice app at version 1.0.0, then a bad guy change dice app and update it maliciously. a). how to let user just auth exactly current version&#39;s DApp and do not auth to the future version? b). how to disable contract be updated by other account? it seems anybody can update a DApp in private net. BM的回答，也就是我们现在在用的版本，加入了eosio.code的虚拟权限 The dice app should be modified so as not to require permission from user to transfer funds. Future feature would be to allow delegation of &quot;contract@eosio.code&quot; to refer to a particular code revision rather than &quot;any code revision&quot;. &nbsp; 我们现在来回顾下本篇内容所要表述的事情： 狼人游戏团队智能合约权限的声明 以明教张无忌为例演示多重签名的实现 以群内eosio.code权限的讨论为契机,对eosio.code的使用做分享 通过以上分析我们可以得出以下结论 不管是合约开发者还是代币持有者,都要时刻对权限的授权增加警惕 为了整个生态持续良好的发展,智能合约开发者在无法公开源码的情况下,上交出智能合约账户的部分权限或许是一种很好的方式 多重签名是区块链行业发展的重要组成部分 用户的active权限不授权不可信和智能合约eosio.code权限 &nbsp; 最后笔者再哔哔几句,eos或者说区块链的生态还处于初期,很多内容或场景并未完善,作为开发者请爱惜自己的羽毛,毕竟没有羽毛的托付,再厉害的鸟面对蔚然蓝天时也无法起飞. &nbsp; 如果你觉得我的文章对你有一定的帮助，请点击文章末尾的喜欢该作者。 如果你对eos开发感兴趣,欢迎关注本公众号,一起学习eos开发。&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 微信公众号 &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有任何疑问或者指教请添加本人个人微信,当然有对eos开发感兴趣或者金庸粉的也可以添加一起交流,备注eos开发或金庸。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;个人微信号 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-13T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"接上篇，本篇从智能合约内部权限使用出发，结合“狼人游戏”源码，谈谈eosio中权限的分配及使用，本文主要分为以下三部分： 狼人团队的声明探析 多签名账户 权限eosio.code的相关说明 狼人团队的声明 eos3d合约地址 https://github.com/yanxi-me/eos3d-contract 在“狼人游戏”源码底部，其团队已声明： 将owner&nbsp;权限已经移交给了eosio.prods，即所有的出块节点（BP)，active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币。开发团队已经对合约没有任何控制权限。但其做过的恶会永远记录在这条链上，从笔者角度出发，不建议参与这种资金盘游戏，哪怕源码已公开，你对源码已经了如指掌，但奈何eos中合约可更新机制，我们还是无法确保合约开发者永远不作恶。 由于源码已作出更新，我们就从最新的代码开始看。狼人游戏需要我们拿一定量的eos代币以某一比例去兑换相应的狼人系统的货币，这个过程其实可以看做为抵押，将自己的eos代币抵押至狼人团队的账户。而后有分红以及最后的获奖，均为从狼人团队账户转账至分红者及最后的获奖者。在狼人团队最新的声明中指出：active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币，那么我们来看看是如何进行提币的（也可参考exchange合约中的内容或者dice小游戏中的内容），代码如下：&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图1 eos3d::withdraw的实现 从上图中可以看出，_this_contract（即本合约，或称狼人游戏）的active权限是保留着的，但一个合约的部署或者更新使用active权限即可。我们从上篇文章中（eos源码赏析（十一）：EOS之从“狼人游戏”看智能合约调用及权限分配（上））也可以得知：内联通信采用调用其他action的形式，这些action需要作为调用操作的一部分来执行。在确保当前action可以执行的情况下，内联操作使用和当前action相同的域和权限进行操作。而在withdraw中使用action send的形式调用eosio.token给分红者或最后中奖者转出一定量的eos代币，此处使用了该合约账户的active权限。 作为eos的开发者我们都应知道，eos的智能合约是可以更新的，前期狼人游戏获取用户权限甚至更新用户权限，本文不谈溢出问题，从权限的角度出发这些潜在危险就令人惊惧。具体权限的解释说明及测试，可参考以下文章币乎大佬荆凯的文章： https://bihu.com/article/1074544 关于owner和active的权限在官方文档及众多博文内容中已经有过许多介绍，不管是开发者还是eos的持有者都应当有相当高的警惕在保存好自己私钥的同时，不擅自授权自己账户的active权限给一个不可信智能合约，因为你永远无法保证一个合约开发者不去作恶。 在介绍完狼人团队给出的active权限的相关解释之后，其团队还提到：将owner&nbsp;权限已经移交给了&nbsp;eosio.prods中的eosio.prods又是什么呢。我们通过获取账户信息可以看到： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图2 eosio.prods 在上图中我们可以看出这个账户是拥有了21个超级节点中的任意15节点的账户的active权限的，也就是说只有这15个节点的账户一致通过某一协定才能使用该active权限。这就涉及到了我们将要谈到的多签名账户。 多签名账户 我们在搭建自己的单机节点使用eosio注册新的账户或者在主网找别人注册账户的时候，均使用了单个账户的active权限。那么这个多签名账户是如何实现的呢？我们以明教为例，为了限制明教教主张无忌的一些作为，将教主的owner权限和active权限分别赋予光明左使杨逍和光明右使范遥的许可。我们先创建三人的账户，然后分别将杨逍和范遥的公钥通过set account permission的形式赋予张无忌这个账户的owner权限， 命令行如下: cleos set account permission zhangwuji owner&#39;{&quot;threshold&quot;: 2, &quot;keys&quot;:[{&quot;key&quot;:&quot;EOS4yMJpETmGkfdzppQJaJ4cbyqrskAVEmt4vbRHd7kVJ8JVdRkm7&quot;,&quot;weight&quot;:1},{&quot;key&quot;:&quot;EOS874qo6PMTt2eTao5S6SC2AxJqPH9DE6f9tS7nsHRbzG1NkrorL&quot;,&quot;weight&quot;:1}], &quot;accounts&quot;:[{&quot;permission&quot;:{&quot;actor&quot;:&quot;fanyao&quot;,&quot;permission&quot;:&quot;owner&quot;},&quot;weight&quot;:1},{&quot;permission&quot;:{&quot;actor&quot;:&quot;yangxiao&quot;,&quot;permission&quot;:&quot;owner&quot;}, &quot;weight&quot;:1}],&quot;waits&quot;: []}}&#39; -p zhangwuji@owner active权限的设定也是类似 如下图： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图3 权限设定&nbsp; &nbsp; &nbsp; &nbsp;通过cleos&nbsp; get&nbsp; account zhangwuji&nbsp;我们可以看到，张无忌这个账户的owner包含有两个公钥，也是我们刚才注册杨逍和范遥两个账户的公钥,同时其owner权限转交给了yangxiao@owner和fanyao@owner。通过查看账户张无忌中的内容可以看到，其owner为2，也就是我们刚才在设置权限的时候threshold设置为2，此处2表示张无忌这个账户的owner权限操作需要经过杨逍和范遥两人的owner权限才可执行。而如果threshold设置为1的话，则杨逍或者范遥任意一人的aowner权限即可令张无忌的owner权限执行。此时明教也不是张无忌一人说了算了。 &nbsp; &nbsp;在狼人团队转交的owner权限给15个超级节点的active，也就意味着只有超级节点中任意15个超级节点的active权限全部同意，狼人团队的智能合约owner权限才可执行，这样源码中没有获取用户权限或更新用户权限的操作，而其owner权限又掌握在eosio.prods手里，大大降低了其主动作恶的风险。但依然，狼人游戏智能合约的active权限还依旧保留着，我们依然要谨慎的参与此类游戏，因合约的部署和更新使用active权限即可，笔者再次建议不授权自己的权限给任何不可信任合约。关于多重签名的使用，集中在系统四大合约之一的eosio.msig智能合约中，我们有时间再进行讨论。 eosio.code的相关说明 &nbsp; &nbsp; &nbsp; &nbsp;我们在查看狼人团队的账户时发现，其账户的active权限有@eosio.code，最近两天群里讨论较多的也是权限相关的内容，我在上一篇内容中也对某个账户使用了eosio.code权限的设置。我们来思考一个问题,假设狼人团队获取了账户user的active权限,他们是否可以通过更新智能合约的形式偷偷的调用eosio.token的transfer函数转走user的eos代币呢?答案也是否定的。这还需要涉及到eosio.code权限的使用，用户user必须授权其active权限中加入狼人团队eosio.code权限，这样针对eosio.token这个合约，狼人团队才可使用user的active权限来操作eosio.token中的相关action。 &nbsp; &nbsp; &nbsp; &nbsp;关于eosio.code权限的issue，大家可以参考下： &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;https://github.com/EOSIO/eos/issues/4348 &nbsp; &nbsp; &nbsp; &nbsp; 对于一个相对去中心的系统来说，权限扮演的角色十分重要，那么这个eosio.code又是什么呢？今天中午在群里关于eosio.code的讨论如下，暂时得出结论如下：不擅自将自己的active权限授权给不可信智能合约的eosio.code特殊权限。 &nbsp; &nbsp; &nbsp; &nbsp;那么eosio.code这个权限又是什么呢？我们从源码中可以看到，eosio.code是个虚拟存在的但不得不使用的特殊权限。那么我个eosio.code的权限校验都使用在哪些地方呢？我们继续来看。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图4 eosio.code &nbsp; &nbsp; &nbsp; 读者中的大部分应该都在帮别人注册主网账户或者自己搭建测试节点的时候使用过newaccount指令，但newaccount指令后面进行了哪些操作，我们可能并未知悉，在图5中便是newaccount的具体信息,在进行对待注册账户的各种校验之后，调用validate_authority_precondition即权限校验的先决条件需要满足注册时赋予了eosio.code权限。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图5&nbsp;validate_authority_precondition 笔者在翻看代码更新记录时，eosio团队在历史修改中关于validate_authority_precondition函数的解释如下： A contract no longer satisfies all permissions of its account by default. If a contract needs to be able send an inline action or deferred transaction and requires adding some specific permission to the authorizations of the action, then the authority of that permission must be set up in such a way that it can be satisfied by just the &quot;eosio.code&quot; permission. 也就印证了我们上面所说的action的发起人必须授权其active权限中加入智能合约账户的eosio.code权限，这样针对eosio.token这个合约，智能合约才能用action发起人的active权限来操作eosio.token中的相关action，如issue，如transfer。 而在另一个issue中，有人提出的相关质疑，BM也做了回复，如下： https://github.com/EOSIO/eos/issues/3002 1、Why does dice contract ask for user‘s active key? the user can not trust so many DApp before to use them in product. And to enable DApp to transfer any cash in any amount from user&#39;s account is too dangerous and not acceptable in practice. 2、even dice app version 1.0.0 is secure enough, how to ensure version 1.0.1/1.1.0/1.2.0 .... is enough too? think about this case : a user authorize dice app at version 1.0.0, then a bad guy change dice app and update it maliciously. a). how to let user just auth exactly current version&#39;s DApp and do not auth to the future version? b). how to disable contract be updated by other account? it seems anybody can update a DApp in private net. BM的回答，也就是我们现在在用的版本，加入了eosio.code的虚拟权限 The dice app should be modified so as not to require permission from user to transfer funds. Future feature would be to allow delegation of &quot;contract@eosio.code&quot; to refer to a particular code revision rather than &quot;any code revision&quot;. &nbsp; 我们现在来回顾下本篇内容所要表述的事情： 狼人游戏团队智能合约权限的声明 以明教张无忌为例演示多重签名的实现 以群内eosio.code权限的讨论为契机,对eosio.code的使用做分享 通过以上分析我们可以得出以下结论 不管是合约开发者还是代币持有者,都要时刻对权限的授权增加警惕 为了整个生态持续良好的发展,智能合约开发者在无法公开源码的情况下,上交出智能合约账户的部分权限或许是一种很好的方式 多重签名是区块链行业发展的重要组成部分 用户的active权限不授权不可信和智能合约eosio.code权限 &nbsp; 最后笔者再哔哔几句,eos或者说区块链的生态还处于初期,很多内容或场景并未完善,作为开发者请爱惜自己的羽毛,毕竟没有羽毛的托付,再厉害的鸟面对蔚然蓝天时也无法起飞. &nbsp; 如果你觉得我的文章对你有一定的帮助，请点击文章末尾的喜欢该作者。 如果你对eos开发感兴趣,欢迎关注本公众号,一起学习eos开发。&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 微信公众号 &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有任何疑问或者指教请添加本人个人微信,当然有对eos开发感兴趣或者金庸粉的也可以添加一起交流,备注eos开发或金庸。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;个人微信号 阅读更多","@type":"BlogPosting","url":"/2018/08/13/a32631a3407b81a94a46eae05fb3ad10.html","headline":"eos源码赏析（十二）：EOS之从“狼人游戏”看智能合约调用及权限分配（下）","dateModified":"2018-08-13T00:00:00+08:00","datePublished":"2018-08-13T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/08/13/a32631a3407b81a94a46eae05fb3ad10.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>eos源码赏析（十二）：EOS之从“狼人游戏”看智能合约调用及权限分配（下）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e4c7a3727d.css"> 
 <div class="htmledit_views"> 
  <p>接上篇，本篇从智能合约内部权限使用出发，结合“狼人游戏”源码，谈谈eosio中权限的分配及使用，本文主要分为以下三部分：</p> 
  <ul>
   <li> <p>狼人团队的声明探析</p> </li> 
   <li> <p>多签名账户</p> </li> 
   <li> <p>权限eosio.code的相关说明</p> </li> 
  </ul>
  <p><strong>狼人团队的声明</strong></p> 
  <p>eos3d合约地址</p> 
  <p>https://github.com/yanxi-me/eos3d-contract</p> 
  <p>在“狼人游戏”源码底部，其团队已声明：</p> 
  <p>将owner&nbsp;权限已经移交给了eosio.prods，即所有的出块节点（BP)，active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币。开发团队已经对合约没有任何控制权限。但其做过的恶会永远记录在这条链上，从笔者角度出发，不建议参与这种资金盘游戏，哪怕源码已公开，你对源码已经了如指掌，但奈何eos中合约可更新机制，我们还是无法确保合约开发者永远不作恶。</p> 
  <p>由于源码已作出更新，我们就从最新的代码开始看。狼人游戏需要我们拿一定量的eos代币以某一比例去兑换相应的狼人系统的货币，这个过程其实可以看做为抵押，将自己的eos代币抵押至狼人团队的账户。而后有分红以及最后的获奖，均为从狼人团队账户转账至分红者及最后的获奖者。在狼人团队最新的声明中指出：active&nbsp;权限为合约代码本身，这是为了可以利用合约实现自动提币，那么我们来看看是如何进行提币的（也可参考exchange合约中的内容或者dice小游戏中的内容），代码如下：&nbsp;</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194414363?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图1 eos3d::withdraw的实现</p> 
  <p>从上图中可以看出，_this_contract（即本合约，或称狼人游戏）的active权限是保留着的，但一个合约的部署或者更新使用active权限即可。我们从上篇文章中（<a href="http://mp.weixin.qq.com/s?__biz=MzAxOTcwNzQ2Mg==&amp;mid=2461720934&amp;idx=1&amp;sn=fdbc3705ec40c0a7f7f9789d24bb67c9&amp;chksm=8c8ca24fbbfb2b592340581ca039d125e4b145a893c6d6d3d56cd04d8746031aaefe9aef9711&amp;scene=21#wechat_redirect" rel="nofollow">eos源码赏析（十一）：EOS之从“狼人游戏”看智能合约调用及权限分配（上）</a>）也可以得知：内联通信采用调用其他action的形式，这些action需要作为调用操作的一部分来执行。在确保当前action可以执行的情况下，内联操作使用和当前action相同的域和权限进行操作。而在withdraw中使用action send的形式调用eosio.token给分红者或最后中奖者转出一定量的eos代币，此处使用了该合约账户的active权限。</p> 
  <p>作为eos的开发者我们都应知道，eos的智能合约是可以更新的，前期狼人游戏获取用户权限甚至更新用户权限，本文不谈溢出问题，从权限的角度出发这些潜在危险就令人惊惧。具体权限的解释说明及测试，可参考以下文章币乎大佬荆凯的文章：</p> 
  <p><a href="https://bihu.com/article/1074544" rel="nofollow">https://bihu.com/article/1074544</a></p> 
  <p>关于owner和active的权限在官方文档及众多博文内容中已经有过许多介绍，不管是开发者还是eos的持有者都应当有相当高的警惕在保存好自己私钥的同时，不擅自授权自己账户的active权限给一个不可信智能合约，因为你永远无法保证一个合约开发者不去作恶。</p> 
  <p>在介绍完狼人团队给出的active权限的相关解释之后，其团队还提到：将owner&nbsp;权限已经移交给了&nbsp;eosio.prods中的eosio.prods又是什么呢。我们通过获取账户信息可以看到：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194453587?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194506405?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图2 eosio.prods</p> 
  <p>在上图中我们可以看出这个账户是拥有了21个超级节点中的任意15节点的账户的active权限的，也就是说只有这15个节点的账户一致通过某一协定才能使用该active权限。这就涉及到了我们将要谈到的多签名账户。</p> 
  <p><strong>多签名账户</strong></p> 
  <p>我们在搭建自己的单机节点使用eosio注册新的账户或者在主网找别人注册账户的时候，均使用了单个账户的active权限。那么这个多签名账户是如何实现的呢？我们以明教为例，为了限制明教教主张无忌的一些作为，将教主的owner权限和active权限分别赋予光明左使杨逍和光明右使范遥的许可。我们先创建三人的账户，然后分别将杨逍和范遥的公钥通过set account permission的形式赋予张无忌这个账户的owner权限，</p> 
  <p>命令行如下:</p> 
  <blockquote> 
   <p>cleos set account permission zhangwuji owner'{"threshold": 2, "keys":[{"key":"EOS4yMJpETmGkfdzppQJaJ4cbyqrskAVEmt4vbRHd7kVJ8JVdRkm7","weight":1},{"key":"EOS874qo6PMTt2eTao5S6SC2AxJqPH9DE6f9tS7nsHRbzG1NkrorL","weight":1}], "accounts":[{"permission":{"actor":"fanyao","permission":"owner"},"weight":1},{"permission":{"actor":"yangxiao","permission":"owner"}, "weight":1}],"waits": []}}' -p zhangwuji@owner</p> 
  </blockquote> 
  <p>active权限的设定也是类似</p> 
  <p>如下图：</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194640466?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图3 权限设定&nbsp; &nbsp;</p> 
  <p>&nbsp; &nbsp;通过cleos&nbsp; get&nbsp; account zhangwuji&nbsp;我们可以看到，张无忌这个账户的owner包含有两个公钥，也是我们刚才注册杨逍和范遥两个账户的公钥,同时其owner权限转交给了yangxiao@owner和fanyao@owner。通过查看账户张无忌中的内容可以看到，其owner为2，也就是我们刚才在设置权限的时候threshold设置为2，此处2表示张无忌这个账户的owner权限操作需要经过杨逍和范遥两人的owner权限才可执行。而如果threshold设置为1的话，则杨逍或者范遥任意一人的aowner权限即可令张无忌的owner权限执行。此时明教也不是张无忌一人说了算了。</p> 
  <p>&nbsp; &nbsp;在狼人团队转交的owner权限给15个超级节点的active，也就意味着只有超级节点中任意15个超级节点的active权限全部同意，狼人团队的智能合约owner权限才可执行，这样源码中没有获取用户权限或更新用户权限的操作，而其owner权限又掌握在eosio.prods手里，大大降低了其主动作恶的风险。但依然，狼人游戏智能合约的active权限还依旧保留着，我们依然要谨慎的参与此类游戏，因合约的部署和更新使用active权限即可，笔者再次建议不授权自己的权限给任何不可信任合约。关于多重签名的使用，集中在系统四大合约之一的eosio.msig智能合约中，我们有时间再进行讨论。</p> 
  <p><strong>eosio.code的相关说明</strong></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;我们在查看狼人团队的账户时发现，其账户的active权限有@eosio.code，最近两天群里讨论较多的也是权限相关的内容，我在上一篇内容中也对某个账户使用了eosio.code权限的设置。我们来思考一个问题,假设狼人团队获取了账户user的active权限,他们是否可以通过更新智能合约的形式偷偷的调用eosio.token的transfer函数转走user的eos代币呢?答案也是否定的。这还需要涉及到eosio.code权限的使用，用户user必须授权其active权限中加入狼人团队eosio.code权限，这样针对eosio.token这个合约，狼人团队才可使用user的active权限来操作eosio.token中的相关action。</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;关于eosio.code权限的issue，大家可以参考下：</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<a href="https://github.com/EOSIO/eos/issues/4348" rel="nofollow">https://github.com/EOSIO/eos/issues/4348</a></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; 对于一个相对去中心的系统来说，权限扮演的角色十分重要，那么这个eosio.code又是什么呢？今天中午在群里关于eosio.code的讨论如下，暂时得出结论如下：不擅自将自己的active权限授权给不可信智能合约的eosio.code特殊权限。</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194748340?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;那么eosio.code这个权限又是什么呢？我们从源码中可以看到，eosio.code是个虚拟存在的但不得不使用的特殊权限。那么我个eosio.code的权限校验都使用在哪些地方呢？我们继续来看。</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194831818?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 图4 eosio.code</p> 
  <p>&nbsp; &nbsp; &nbsp; 读者中的大部分应该都在帮别人注册主网账户或者自己搭建测试节点的时候使用过newaccount指令，但newaccount指令后面进行了哪些操作，我们可能并未知悉，在图5中便是newaccount的具体信息,在进行对待注册账户的各种校验之后，调用validate_authority_precondition即权限校验的先决条件需要满足注册时赋予了eosio.code权限。</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194854566?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;图5&nbsp;validate_authority_precondition</p> 
  <p>笔者在翻看代码更新记录时，eosio团队在历史修改中关于validate_authority_precondition函数的解释如下：</p> 
  <blockquote> 
   <p>A contract no longer satisfies all permissions of its account by default.</p> 
   <p>If a contract needs to be able send an inline action or deferred transaction and requires adding some specific permission to the authorizations of the action, then the authority of that permission must be set up in such a way that it can be satisfied by just the "eosio.code" permission.</p> 
  </blockquote> 
  <p>也就印证了我们上面所说的action的发起人必须授权其active权限中加入智能合约账户的eosio.code权限，这样针对eosio.token这个合约，智能合约才能用action发起人的active权限来操作eosio.token中的相关action，如issue，如transfer。</p> 
  <p>而在另一个issue中，有人提出的相关质疑，BM也做了回复，如下：</p> 
  <p><a href="https://github.com/EOSIO/eos/issues/3002" rel="nofollow">https://github.com/EOSIO/eos/issues/3002</a></p> 
  <blockquote> 
   <p>1、Why does dice contract ask for user‘s active key?</p> 
   <p>the user can not trust so many DApp before to use them in product. And to enable DApp to transfer any cash in any amount from user's account is too dangerous and not acceptable in practice.</p> 
   <p>2、even dice app version 1.0.0 is secure enough, how to ensure version 1.0.1/1.1.0/1.2.0 .... is enough too?</p> 
   <p>think about this case : a user authorize dice app at version 1.0.0, then a bad guy change dice app and update it maliciously.</p> 
   <p>a). how to let user just auth exactly current version's DApp and do not auth to the future version?</p> 
   <p>b). how to disable contract be updated by other account? it seems anybody can update a DApp in private net.</p> 
  </blockquote> 
  <p>BM的回答，也就是我们现在在用的版本，加入了eosio.code的虚拟权限</p> 
  <blockquote> 
   <p>The dice app should be modified so as not to require permission from user to transfer funds.</p> 
   <p>Future feature would be to allow delegation of "contract@eosio.code" to refer to a particular code revision rather than "any code revision".</p> 
  </blockquote> 
  <p>&nbsp;</p> 
  <p>我们现在来回顾下本篇内容所要表述的事情：</p> 
  <ul>
   <li> <p>狼人游戏团队智能合约权限的声明</p> </li> 
   <li> <p>以明教张无忌为例演示多重签名的实现</p> </li> 
   <li> <p>以群内eosio.code权限的讨论为契机,对eosio.code的使用做分享</p> </li> 
  </ul>
  <p>通过以上分析我们可以得出以下结论</p> 
  <ul>
   <li> <p>不管是合约开发者还是代币持有者,都要时刻对权限的授权增加警惕</p> </li> 
   <li> <p>为了整个生态持续良好的发展,智能合约开发者在无法公开源码的情况下,上交出智能合约账户的部分权限或许是一种很好的方式</p> </li> 
   <li> <p>多重签名是区块链行业发展的重要组成部分</p> </li> 
   <li> <p>用户的active权限不授权不可信和智能合约eosio.code权限</p> </li> 
  </ul>
  <p>&nbsp;</p> 
  <p>最后笔者再哔哔几句,eos或者说区块链的生态还处于初期,很多内容或场景并未完善,作为开发者请爱惜自己的羽毛,毕竟没有羽毛的托付,再厉害的鸟面对蔚然蓝天时也无法起飞.</p> 
  <p>&nbsp;</p> 
  <p><strong>如果你觉得我的文章对你有一定的帮助，请点击文章末尾的喜欢该作者。</strong></p> 
  <p><strong>如果你对eos开发感兴趣,欢迎关注本公众号,一起学习eos开发。</strong>&nbsp;</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194934451?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 微信公众号</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有任何疑问或者指教请添加本人个人微信,当然有对eos开发感兴趣或者金庸粉的也可以添加一起交流,备注eos开发或金庸。</p> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813194954887?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3podXhpYW5nemhpZGk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;个人微信号</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/zhuxiangzhidi/article/details/81635688,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/zhuxiangzhidi/article/details/81635688,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
