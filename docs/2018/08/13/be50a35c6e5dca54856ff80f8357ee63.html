<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>账务实时交易系统设计思考-【第三节】-功能设计 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="账务实时交易系统设计思考-【第三节】-功能设计" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="【思考点滴】 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。同时进行了章节拆分。 &nbsp; 全量版 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;https://blog.csdn.net/yk200808/article/details/80755459 第一节:业务简介 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624677 第二节:业务分析 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624779 第三节:功能设计 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624826 第四节:热点问题 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624861 第五节:准确性 &nbsp; &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624899 第六节:使用建议 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624917 第七节:思考总结 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624934 &nbsp; 3. 功能设计 设计的几个原则， 1) 功能、准确、实时是基础， 2) 性能、效率是关键， 3) 健壮和可扩展是平台化所需。 &nbsp; &nbsp; 3.1 接口数据设计 3.2 资金操作 资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。 3.3 数据记录 对内使用：生成交易明细、提供交易记录实时查询 对外输出：为对账、查账、打款等提供数据支持 &nbsp; 3.4 算法选择 3.4.1数据唯一性(四元组) &nbsp; 数据唯一性是数据准确性的保证 数据唯一性是数据关系、数据关联的前提 &nbsp; 账户操作的唯一性实现，如下四元组详述 1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，订单不一定局限在百度外卖，可以是任何平台的订单【如下示例的 order_id】 2）业务描述 &nbsp; &nbsp; &nbsp; 如&quot;百度外卖用户订单&quot;，&quot;百度外卖商户订单&quot;，&quot;百度糯米&quot;, ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】 3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】 4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如&quot;点击消费扣费&quot;，&quot;转账入账&quot;，&quot;转账出账&quot;,&quot;充值入账&quot; 等 【如下示例的 trade_desc】 &nbsp; 订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性 账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分） 保证了资金操作的最小可查询粒度和资金监控的最小粒度 &nbsp; order_no&nbsp; : 业务订单号 &nbsp; order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据 account_id : 账户ID op_code : 操作码，去重；该订单该账户的唯一标识；可配置；可控； 如下图示，就是典型的，同账户通过op_code去重的方式。 &nbsp; 3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存) &nbsp; 绝对父子关系和相对父子关系并存 1) 提升操作效率(有效树在一棵绝对树上) 2) 提供按业务分段存储(查询子树即可) 3) 维护一棵整树(资金流完整统一，资金关系简单化) 4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。 3.4.3 数据唯一性支撑了图到树的转换 资金流是有向图，需要完成图到树的转换处理 &nbsp; &nbsp; 3.4.4 分账模型表述 &nbsp; 3.4.4.1 分账模型 &nbsp; 3.4.4.2 分账配置命令格式（分账模型表述） $postData = array(&nbsp; &nbsp; &#39;trade_commands&#39; =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;第一组分账操作命令 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;商户接单&#39;, // 备注信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;split_formula&#39; =&gt; array(//&nbsp;入账账户信息配置 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;55555666666666&#39; =&gt; array( // 入账账户1的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shopOrder_jljljljlljl&#39;, // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 55555666666666, //入账账户1的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户营业输入&#39;, //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;222222233333333&#39; =&gt; array( //&nbsp;入账账户2的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;logistics_5245787854745&#39;, // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖物流冻结账户&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 222222233333333, //入账账户2的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt;&nbsp;&#39;物流接单&#39;, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1000, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;新用户补贴出账&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -1500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;优质用户嘉奖&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -800, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// .... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp;), ); &nbsp; &nbsp; &nbsp; &nbsp; 3.4.5 资金关系存储算法选择： 3.4.5.1 资金关系存储模型 3.4.5.2 资金关系存储示例: array( &nbsp; &nbsp; // 资金交易上游账户唯一信息 &nbsp; &nbsp;&nbsp;&#39;absolute_parent&#39; =&gt; array( &nbsp;&nbsp;// 绝对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; ), &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作 &nbsp; &nbsp;&nbsp;&#39;relative_parent&#39; =&gt; array(), &nbsp; &nbsp;// 相对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;2500 = 2300+200 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;is_split&#39; =&gt; 1, // 0:可以分账 1:已分账 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;child_details&#39; =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;8888888888881111&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;8888888888883333&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; ) ); 基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。 1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一 2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一 优化点：建立绝对上下游关系和相对上游关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点 &nbsp; 3.4.5.3 账单格式 array( // 账单1 &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, // 余额出账账户的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, // 金额操作描述 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;out&#39;, // 资金出账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易出账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单2 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单3 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); &nbsp; &nbsp; &nbsp; 3.4.7 资金流按业务分区块 &nbsp; 1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金 2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向 &nbsp; 3.4.8&nbsp;资金操作接口API 3.4.8.1 完善的API接口 入账、出账、分账、调账和撤销等，实现资金操作接口统一化， &nbsp; 3.4.8.2 规范、丰富的交易类型 交易类型场景化和统一化 交易类型可定制 丰富交易类型，实现按类型归纳、追踪、查询和统计等 &nbsp; 3.4.8.3 资金分配状态机 资金操作API的背后，是规范化了的资金分配关系数据 资金分配关系数据，可以确保资金的准确分配 记录资金分配的完整过程 资金分配状态机的载体 同时通过资金分配关系，可以复盘、回放资金交易的完整过程 &nbsp; 3.4.8.4 资金撤回 1、支持取消任意账户分账（单节点取消分账） 2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账） 3、支持递归取消整个资金流的分账（取消整棵资金分配过程） &nbsp; &nbsp; &nbsp; 3.5 资源管理 支持批量请求:支持单个请求处理，也支持批量请求处理， 统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚 统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。 统一异常处理:错误抛异常，异常格式统一化... &nbsp; &nbsp; &nbsp; 3.6 设计回顾总结 赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。 账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。 上面说了一大堆，如下图示简单总结，小清新一下。 &nbsp; 阅读更多" />
<meta property="og:description" content="【思考点滴】 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。同时进行了章节拆分。 &nbsp; 全量版 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;https://blog.csdn.net/yk200808/article/details/80755459 第一节:业务简介 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624677 第二节:业务分析 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624779 第三节:功能设计 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624826 第四节:热点问题 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624861 第五节:准确性 &nbsp; &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624899 第六节:使用建议 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624917 第七节:思考总结 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624934 &nbsp; 3. 功能设计 设计的几个原则， 1) 功能、准确、实时是基础， 2) 性能、效率是关键， 3) 健壮和可扩展是平台化所需。 &nbsp; &nbsp; 3.1 接口数据设计 3.2 资金操作 资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。 3.3 数据记录 对内使用：生成交易明细、提供交易记录实时查询 对外输出：为对账、查账、打款等提供数据支持 &nbsp; 3.4 算法选择 3.4.1数据唯一性(四元组) &nbsp; 数据唯一性是数据准确性的保证 数据唯一性是数据关系、数据关联的前提 &nbsp; 账户操作的唯一性实现，如下四元组详述 1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，订单不一定局限在百度外卖，可以是任何平台的订单【如下示例的 order_id】 2）业务描述 &nbsp; &nbsp; &nbsp; 如&quot;百度外卖用户订单&quot;，&quot;百度外卖商户订单&quot;，&quot;百度糯米&quot;, ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】 3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】 4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如&quot;点击消费扣费&quot;，&quot;转账入账&quot;，&quot;转账出账&quot;,&quot;充值入账&quot; 等 【如下示例的 trade_desc】 &nbsp; 订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性 账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分） 保证了资金操作的最小可查询粒度和资金监控的最小粒度 &nbsp; order_no&nbsp; : 业务订单号 &nbsp; order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据 account_id : 账户ID op_code : 操作码，去重；该订单该账户的唯一标识；可配置；可控； 如下图示，就是典型的，同账户通过op_code去重的方式。 &nbsp; 3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存) &nbsp; 绝对父子关系和相对父子关系并存 1) 提升操作效率(有效树在一棵绝对树上) 2) 提供按业务分段存储(查询子树即可) 3) 维护一棵整树(资金流完整统一，资金关系简单化) 4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。 3.4.3 数据唯一性支撑了图到树的转换 资金流是有向图，需要完成图到树的转换处理 &nbsp; &nbsp; 3.4.4 分账模型表述 &nbsp; 3.4.4.1 分账模型 &nbsp; 3.4.4.2 分账配置命令格式（分账模型表述） $postData = array(&nbsp; &nbsp; &#39;trade_commands&#39; =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;第一组分账操作命令 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;商户接单&#39;, // 备注信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;split_formula&#39; =&gt; array(//&nbsp;入账账户信息配置 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;55555666666666&#39; =&gt; array( // 入账账户1的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shopOrder_jljljljlljl&#39;, // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 55555666666666, //入账账户1的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户营业输入&#39;, //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;222222233333333&#39; =&gt; array( //&nbsp;入账账户2的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;logistics_5245787854745&#39;, // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖物流冻结账户&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 222222233333333, //入账账户2的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt;&nbsp;&#39;物流接单&#39;, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1000, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;新用户补贴出账&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -1500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;优质用户嘉奖&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -800, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// .... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp;), ); &nbsp; &nbsp; &nbsp; &nbsp; 3.4.5 资金关系存储算法选择： 3.4.5.1 资金关系存储模型 3.4.5.2 资金关系存储示例: array( &nbsp; &nbsp; // 资金交易上游账户唯一信息 &nbsp; &nbsp;&nbsp;&#39;absolute_parent&#39; =&gt; array( &nbsp;&nbsp;// 绝对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; ), &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作 &nbsp; &nbsp;&nbsp;&#39;relative_parent&#39; =&gt; array(), &nbsp; &nbsp;// 相对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;2500 = 2300+200 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;is_split&#39; =&gt; 1, // 0:可以分账 1:已分账 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;child_details&#39; =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;8888888888881111&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;8888888888883333&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; ) ); 基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。 1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一 2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一 优化点：建立绝对上下游关系和相对上游关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点 &nbsp; 3.4.5.3 账单格式 array( // 账单1 &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, // 余额出账账户的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, // 金额操作描述 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;out&#39;, // 资金出账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易出账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单2 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单3 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); &nbsp; &nbsp; &nbsp; 3.4.7 资金流按业务分区块 &nbsp; 1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金 2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向 &nbsp; 3.4.8&nbsp;资金操作接口API 3.4.8.1 完善的API接口 入账、出账、分账、调账和撤销等，实现资金操作接口统一化， &nbsp; 3.4.8.2 规范、丰富的交易类型 交易类型场景化和统一化 交易类型可定制 丰富交易类型，实现按类型归纳、追踪、查询和统计等 &nbsp; 3.4.8.3 资金分配状态机 资金操作API的背后，是规范化了的资金分配关系数据 资金分配关系数据，可以确保资金的准确分配 记录资金分配的完整过程 资金分配状态机的载体 同时通过资金分配关系，可以复盘、回放资金交易的完整过程 &nbsp; 3.4.8.4 资金撤回 1、支持取消任意账户分账（单节点取消分账） 2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账） 3、支持递归取消整个资金流的分账（取消整棵资金分配过程） &nbsp; &nbsp; &nbsp; 3.5 资源管理 支持批量请求:支持单个请求处理，也支持批量请求处理， 统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚 统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。 统一异常处理:错误抛异常，异常格式统一化... &nbsp; &nbsp; &nbsp; 3.6 设计回顾总结 赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。 账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。 上面说了一大堆，如下图示简单总结，小清新一下。 &nbsp; 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-13T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"【思考点滴】 作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16 本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。同时进行了章节拆分。 &nbsp; 全量版 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;https://blog.csdn.net/yk200808/article/details/80755459 第一节:业务简介 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624677 第二节:业务分析 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624779 第三节:功能设计 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624826 第四节:热点问题 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624861 第五节:准确性 &nbsp; &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624899 第六节:使用建议 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624917 第七节:思考总结 &nbsp; &nbsp;https://blog.csdn.net/yk200808/article/details/81624934 &nbsp; 3. 功能设计 设计的几个原则， 1) 功能、准确、实时是基础， 2) 性能、效率是关键， 3) 健壮和可扩展是平台化所需。 &nbsp; &nbsp; 3.1 接口数据设计 3.2 资金操作 资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。 3.3 数据记录 对内使用：生成交易明细、提供交易记录实时查询 对外输出：为对账、查账、打款等提供数据支持 &nbsp; 3.4 算法选择 3.4.1数据唯一性(四元组) &nbsp; 数据唯一性是数据准确性的保证 数据唯一性是数据关系、数据关联的前提 &nbsp; 账户操作的唯一性实现，如下四元组详述 1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，订单不一定局限在百度外卖，可以是任何平台的订单【如下示例的 order_id】 2）业务描述 &nbsp; &nbsp; &nbsp; 如&quot;百度外卖用户订单&quot;，&quot;百度外卖商户订单&quot;，&quot;百度糯米&quot;, ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】 3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】 4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如&quot;点击消费扣费&quot;，&quot;转账入账&quot;，&quot;转账出账&quot;,&quot;充值入账&quot; 等 【如下示例的 trade_desc】 &nbsp; 订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性 账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分） 保证了资金操作的最小可查询粒度和资金监控的最小粒度 &nbsp; order_no&nbsp; : 业务订单号 &nbsp; order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据 account_id : 账户ID op_code : 操作码，去重；该订单该账户的唯一标识；可配置；可控； 如下图示，就是典型的，同账户通过op_code去重的方式。 &nbsp; 3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存) &nbsp; 绝对父子关系和相对父子关系并存 1) 提升操作效率(有效树在一棵绝对树上) 2) 提供按业务分段存储(查询子树即可) 3) 维护一棵整树(资金流完整统一，资金关系简单化) 4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。 3.4.3 数据唯一性支撑了图到树的转换 资金流是有向图，需要完成图到树的转换处理 &nbsp; &nbsp; 3.4.4 分账模型表述 &nbsp; 3.4.4.1 分账模型 &nbsp; 3.4.4.2 分账配置命令格式（分账模型表述） $postData = array(&nbsp; &nbsp; &#39;trade_commands&#39; =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;第一组分账操作命令 &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;商户接单&#39;, // 备注信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;split_formula&#39; =&gt; array(//&nbsp;入账账户信息配置 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;55555666666666&#39; =&gt; array( // 入账账户1的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shopOrder_jljljljlljl&#39;, // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 55555666666666, //入账账户1的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户营业输入&#39;, //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;222222233333333&#39; =&gt; array( //&nbsp;入账账户2的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;logistics_5245787854745&#39;, // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖物流冻结账户&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 222222233333333, //入账账户2的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt;&nbsp;&#39;物流接单&#39;, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 1000, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;新用户补贴出账&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -1500, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;1111111111777777&#39; =&gt; array( //&nbsp;入账账户3的账户ID，以及配置信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖新用户补贴&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt;&nbsp;1111111111777777, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;优质用户嘉奖&#39;, //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; -800, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_method&#39; =&gt; &#39;splitAccount&#39;, // 金额操作方法-分账 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// .... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ), &nbsp; &nbsp; &nbsp; &nbsp;), ); &nbsp; &nbsp; &nbsp; &nbsp; 3.4.5 资金关系存储算法选择： 3.4.5.1 资金关系存储模型 3.4.5.2 资金关系存储示例: array( &nbsp; &nbsp; // 资金交易上游账户唯一信息 &nbsp; &nbsp;&nbsp;&#39;absolute_parent&#39; =&gt; array( &nbsp;&nbsp;// 绝对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, //余额出账账户的账户ID &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, //金额操作描述 &nbsp; &nbsp; ), &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作 &nbsp; &nbsp;&nbsp;&#39;relative_parent&#39; =&gt; array(), &nbsp; &nbsp;// 相对上游信息 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;2500 = 2300+200 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;is_split&#39; =&gt; 1, // 0:可以分账 1:已分账 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;child_details&#39; =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;8888888888881111&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// order_id, business_desc, account_id, trade_desc 四元组的唯一性 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&#39;8888888888883333&#39; =&gt; array( // 入账账户 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;), &nbsp; &nbsp; &nbsp; &nbsp; ) ); 基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。 1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一 2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一 优化点：建立绝对上下游关系和相对上游关系 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点 &nbsp; 3.4.5.3 账单格式 array( // 账单1 &nbsp; &nbsp; &#39;order_id&#39; =&gt; &#39;userOrder_150121548745&#39;, // 业务订单ID，用户订单 &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖用户外卖订单&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 98989777783780001, // 余额出账账户的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;用户下单&#39;, // 金额操作描述 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;out&#39;, // 资金出账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易出账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2500, &nbsp; &nbsp; &#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单2 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;shop_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户净收&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888881111, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;商户净收入&#39;, //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 2300, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); array( // 账单3 &nbsp; &nbsp;&nbsp;&#39;order_id&#39; =&gt; &#39;platform_xxxxxxxx&#39;, // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID &nbsp; &nbsp;&nbsp;&#39;business_desc&#39; =&gt; &#39;百度外卖商户抽佣&#39;, // 业务描述 &nbsp; &nbsp;&nbsp;&#39;account_id&#39; =&gt; 8888888888883333, //入账账户3的账户ID &nbsp; &nbsp;&nbsp;&#39;trade_desc&#39; =&gt; &#39;平台抽佣金额&#39;, //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同 &nbsp; &nbsp;&nbsp;&#39;flow_type&#39; =&gt; &#39;in&#39;, // 资金入账 &nbsp; &nbsp;&nbsp;&#39;trade_type&#39; =&gt; &#39;交易入账&#39;, // 交易类型 &nbsp; &nbsp;&nbsp;&#39;amount&#39; =&gt; 200, &nbsp; &nbsp;&nbsp;&#39;remark&#39; =&gt; &#39;&#39;, ); &nbsp; &nbsp; &nbsp; 3.4.7 资金流按业务分区块 &nbsp; 1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金 2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向 &nbsp; 3.4.8&nbsp;资金操作接口API 3.4.8.1 完善的API接口 入账、出账、分账、调账和撤销等，实现资金操作接口统一化， &nbsp; 3.4.8.2 规范、丰富的交易类型 交易类型场景化和统一化 交易类型可定制 丰富交易类型，实现按类型归纳、追踪、查询和统计等 &nbsp; 3.4.8.3 资金分配状态机 资金操作API的背后，是规范化了的资金分配关系数据 资金分配关系数据，可以确保资金的准确分配 记录资金分配的完整过程 资金分配状态机的载体 同时通过资金分配关系，可以复盘、回放资金交易的完整过程 &nbsp; 3.4.8.4 资金撤回 1、支持取消任意账户分账（单节点取消分账） 2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账） 3、支持递归取消整个资金流的分账（取消整棵资金分配过程） &nbsp; &nbsp; &nbsp; 3.5 资源管理 支持批量请求:支持单个请求处理，也支持批量请求处理， 统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚 统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。 统一异常处理:错误抛异常，异常格式统一化... &nbsp; &nbsp; &nbsp; 3.6 设计回顾总结 赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。 账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。 上面说了一大堆，如下图示简单总结，小清新一下。 &nbsp; 阅读更多","@type":"BlogPosting","url":"/2018/08/13/be50a35c6e5dca54856ff80f8357ee63.html","headline":"账务实时交易系统设计思考-【第三节】-功能设计","dateModified":"2018-08-13T00:00:00+08:00","datePublished":"2018-08-13T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/08/13/be50a35c6e5dca54856ff80f8357ee63.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>账务实时交易系统设计思考-【第三节】-功能设计</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <h1>【思考点滴】</h1> 
  <p><strong>作者 : 杨考&nbsp; 微信号 :&nbsp;devin_cn_hd_09_16</strong></p> 
  <p><strong>本文是【讲解篇】和【技术分享篇】结合起来，由于CSDN文章图片丢失，又补了一次图片。同时进行了章节拆分。</strong></p> 
  <p>&nbsp;</p> 
  <p><strong>全量版 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<a href="https://blog.csdn.net/yk200808/article/details/80755459" rel="nofollow">https://blog.csdn.net/yk200808/article/details/80755459</a><br> 第一节:业务简介 &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624677" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624677</a><br> 第二节:业务分析 &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624779" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624779</a><br> 第三节:功能设计 &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624826" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624826</a><br> 第四节:热点问题 &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624861" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624861</a><br> 第五节:准确性 &nbsp; &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624899" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624899</a><br> 第六节:使用建议 &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624917" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624917</a><br> 第七节:思考总结 &nbsp; &nbsp;<a href="https://blog.csdn.net/yk200808/article/details/81624934" rel="nofollow">https://blog.csdn.net/yk200808/article/details/81624934</a></strong></p> 
  <h1>&nbsp;</h1> 
  <h1>3. 功能设计</h1> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184151325?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A46%3A6.png?version=1&amp;modificationDate=1495194393000&amp;api=v2"></p> 
  <p>设计的几个原则，</p> 
  <p>1) 功能、准确、实时是基础，</p> 
  <p>2) 性能、效率是关键，</p> 
  <p>3) 健壮和可扩展是平台化所需。</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2><a name="t21"></a>3.1 接口数据设计</h2> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A46%3A30.png?version=1&amp;modificationDate=1495194417000&amp;api=v2"></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184216854?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <h2><a name="t22"></a>3.2 资金操作</h2> 
  <p>资金操作，用来承接业务的配置，生成资金流转状态的记录，保证资金准确分配。</p> 
  <h2><a name="t23"></a>3.3 数据记录</h2> 
  <p>对内使用：生成交易明细、提供交易记录实时查询</p> 
  <p>对外输出：为对账、查账、打款等提供数据支持</p> 
  <p>&nbsp;</p> 
  <h2><a name="t24"></a>3.4 算法选择</h2> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A46%3A50.png?version=1&amp;modificationDate=1495194438000&amp;api=v2"></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184237566?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <h3><a name="t25"></a>3.4.1数据唯一性(四元组)</h3> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018425540?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <p>数据唯一性是数据<strong>准确性</strong>的保证</p> 
  <p>数据唯一性是数据关系、<strong>数据关联</strong>的前提</p> 
  <p>&nbsp;</p> 
  <p>账户操作的唯一性实现，如下四元组详述</p> 
  <p>1）订单ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 如用户订单ID，商户订单ID，物流订单ID，各业务选择自己的订单ID，<strong>订单不一定局限在百度外卖</strong>，可以是任何平台的订单【如下示例的 order_id】</p> 
  <p>2）业务描述 &nbsp; &nbsp; &nbsp; 如"百度外卖<strong>用户订单</strong>"，"百度外卖<strong>商户订单</strong>"，"<strong>百度糯米</strong>", ... 通过业务准确描述，可以完成不同公司不同业务的订单描述和区别 【如下示例的business_desc】</p> 
  <p>3）账户ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 平台为主体创建的账户 【如下示例的 account_id】</p> 
  <p>4）账务资金操作描述 &nbsp; &nbsp;结合业务场景和财务需求进行规定，如"点击消费扣费"，"转账入账"，"转账出账","充值入账" 等 【如下示例的 trade_desc】</p> 
  <p>&nbsp;</p> 
  <p>订单ID+业务描述，保证整体账务系统中，业务订单ID的唯一性</p> 
  <p>账户ID+账务资金操作描述，保证同一账户ID在订单中多次出现时的资金操作唯一，（如上 3.3.1 中列举的账户 1111111111777777，同一个资金流中，存在多笔不同的入账、出账操作，需要通过账务资金操作描述进行唯一性区分）</p> 
  <p>保证了资金操作的最小可查询粒度和资金监控的最小粒度</p> 
  <p>&nbsp;</p> 
  <p>order_no&nbsp; : 业务订单号</p> 
  <p>&nbsp;</p> 
  <p>order_type : 业务类型，区分业务类型，防止不同业务order_no重复，且方便按业务维度查数据</p> 
  <p>account_id : 账户ID</p> 
  <p>op_code : 操作码，去重；该订单该账户的<strong><em>唯一标识</em></strong>；可配置；可控；</p> 
  <p>如下图示，就是典型的，同账户通过op_code去重的方式。</p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-22%2011%3A12%3A13.png?version=1&amp;modificationDate=1495422768000&amp;api=v2"></p> 
  <p>&nbsp;</p> 
  <h3><a name="t26"></a>3.4.2 一棵整树和多可相对子树(绝对父子关系和相对父子关系并存)</h3> 
  <p>&nbsp;</p> 
  <p>绝对父子关系和相对父子关系并存</p> 
  <p>1) 提升操作效率(有效树在一棵绝对树上)</p> 
  <p>2) 提供按业务分段存储(查询子树即可)</p> 
  <p>3) 维护一棵整树(资金流完整统一，资金关系简单化)</p> 
  <p>4) 子树用来承接不同的业务，即资金流是一棵整树，不同的业务在资金流这棵整树上的一个子树。</p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-22%2011%3A12%3A22.png?version=1&amp;modificationDate=1495422777000&amp;api=v2"></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184318372?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <h3><a name="t27"></a>3.4.3 数据唯一性支撑了图到树的转换</h3> 
  <p>资金流是有向图，需要完成图到树的转换处理</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h3><a name="t28"></a>3.4.4 分账模型表述</h3> 
  <p>&nbsp;</p> 
  <p>3.4.4.1 分账模型</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094327946?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-14%2021%3A23%3A59.png?version=1&amp;modificationDate=1502717045000&amp;api=v2"></p> 
  <p>&nbsp;</p> 
  <p>3.4.4.2 分账配置命令格式（分账模型表述）</p> 
  <p>$postData = array(<br><strong>&nbsp; &nbsp; 'trade_commands' =&gt; array( &nbsp;&nbsp;//&nbsp;trade_commands 批量操作方法配置</strong><br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;array( //&nbsp;<strong>第一组分账操作命令</strong><br> &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'trade_method' =&gt; 'splitAccount', // 金额操作方法-分账<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<strong><em>// order_id, business_desc, account_id, trade_desc 四元组，本次操作出账的唯一标识，在整个数据表的唯一标识</em></strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'userOrder_150121548745', // 业务订单ID，用户订单<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖用户外卖订单', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 98989777783780001, //余额<strong>出账</strong>账户的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '用户下单', //金额操作描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 1200, // 出账金额，单位(分) &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;<strong>1200=2500+1000-1500-800 &nbsp; 会校验资金平衡关系</strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '商户接单', // 备注信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'split_formula' =&gt; array(//&nbsp;<strong>入账账户信息配置</strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识</strong></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'55555666666666' =&gt; array( // 入账账户1的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'order_id' =&gt; 'shopOrder_jljljljlljl', // 商户订单ID，没有生成商户订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户外卖订单', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 55555666666666, //<strong>入账</strong>账户1的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '<strong>商户营业输入</strong>', //金额操作描述, 如果账户 55555666666666 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 2500,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识</strong></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'222222233333333' =&gt; array( //&nbsp;<strong>入账</strong>账户2的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'logistics_5245787854745', // 物流订单ID，没有生成物流订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖物流冻结账户', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 222222233333333, //<strong>入账</strong>账户2的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt;&nbsp;<strong>'物流接单'</strong>, //金额操作描述, 如果账户 222222233333333 在分账流中只有一次流入，则这里trade_desc可以不设置，如果有多次，则trade_desc不能重复<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 1000,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识(本资金流中，1111111111777777两次操作的trade_desc不同)</strong></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '1111111111777777' =&gt; array( //&nbsp;<strong>入账</strong>账户3的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖新用户补贴', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt;&nbsp;<strong>1111111111777777</strong>, //<strong>入账</strong>账户3的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '<strong>新用户补贴出账</strong>', //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; -1500,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组，本次操作入账的唯一标识，在整个数据表的唯一标识<em><strong>(本资金流中，1111111111777777两次操作的trade_desc不同)</strong></em></strong></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '1111111111777777' =&gt; array( //&nbsp;<strong>入账</strong>账户3的账户ID，以及配置信息<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖新用户补贴', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt;&nbsp;<strong>1111111111777777</strong>, //<strong>入账</strong>账户3的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '<strong>优质用户嘉奖</strong>', //金额操作描述, 如果账户 1111111111777777 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; -800,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array( //&nbsp;第二组分账操作命令<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_method' =&gt; 'splitAccount', // 金额操作方法-分账<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;// ....<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;),<br> );</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p><br> &nbsp;</p> 
  <p>&nbsp;</p> 
  <h3><a name="t29"></a>3.4.5 资金关系存储算法选择：</h3> 
  <p>3.4.5.1 资金关系存储模型</p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-10%2016%3A38%3A4.png?version=1&amp;modificationDate=1502354339000&amp;api=v2"></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094354760?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>3.4.5.2 资金关系存储示例:</p> 
  <p>array(<br> &nbsp; &nbsp; // 资金交易上游账户唯一信息<br> &nbsp; &nbsp;&nbsp;<strong>'absolute_parent' =&gt; array( &nbsp;&nbsp;// 绝对上游信息</strong><br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组的唯一性</strong></em></p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; 'order_id' =&gt; 'userOrder_150121548745', // 业务订单ID，用户订单</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖用户外卖订单', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'account_id' =&gt; 98989777783780001, //余额出账账户的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '用户下单', //金额操作描述<br> &nbsp; &nbsp; ),<br> &nbsp; &nbsp; // 本业务资金的入口，在本业务属于分账根节点，相对上游为0,方便业务块操作<br> &nbsp; &nbsp;&nbsp;<strong>'relative_parent' =&gt; array(), &nbsp; &nbsp;// 相对上游信息</strong><br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'amount' =&gt; 2500, &nbsp; &nbsp;// 分账金额 &nbsp;<strong>2500 = 2300+200</strong><br> &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'is_split' =&gt; 1, // 0:可以分账 1:已分账<br> &nbsp; &nbsp; &nbsp; &nbsp;<strong>&nbsp;'child_details' =&gt; array( &nbsp; &nbsp;&nbsp;// 绝对下游信息</strong><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组的唯一性</strong></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '8888888888881111' =&gt; array( // 入账账户<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'order_id' =&gt; 'shop_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户净收', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888881111, //入账账户3的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '商户净收入', //金额操作描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'amount' =&gt; 2300,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;),<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<em><strong>// order_id, business_desc, account_id, trade_desc 四元组的唯一性</strong></em><br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;'8888888888883333' =&gt; array( // 入账账户<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户抽佣', // 业务描述<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888883333, //入账账户3的账户ID<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '平台抽佣金额', //金额操作描述,&nbsp;<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'amount' =&gt; 200,<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;),<br> &nbsp; &nbsp; &nbsp; &nbsp; )<br> );</p> 
  <p>基于四元组唯一性的定义，每笔账户操作在整表中都是唯一的，因此可以破解交易资金流向的网状关系(有向图)，实现树状结构关系存储。</p> 
  <p>1、根据四元组唯一性，入账账户可以快速查到上游出账账户，且双向关系唯一</p> 
  <p>2、根据四元组唯一性，出账账户可以快速查到资金流入的所有账户，且出账账户和每个入账账户之间的关系唯一</p> 
  <p>优化点：建立<strong>绝对上下游关系</strong>和<strong>相对上游</strong>关系</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 绝对上游：跨业务账务的上游账务节点是一个真实的唯一节点</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 相对上游：每个业务入口账务节点的上游账务节点是0，即该节点是本业务的入口节点</p> 
  <p>&nbsp;</p> 
  <p>3.4.5.3 账单格式</p> 
  <p>array( // 账单1<br> &nbsp; &nbsp; 'order_id' =&gt; 'userOrder_150121548745', // 业务订单ID，用户订单<br> &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖用户外卖订单', // 业务描述<br> &nbsp; &nbsp;&nbsp;'account_id' =&gt; 98989777783780001, // 余额出账账户的账户ID<br> &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '用户下单', // 金额操作描述<br> &nbsp; &nbsp;&nbsp;'flow_type' =&gt; 'out', // 资金出账<br> &nbsp; &nbsp;&nbsp;'trade_type' =&gt; '交易出账', // 交易类型<br> &nbsp; &nbsp;&nbsp;'amount' =&gt; 2500,</p> 
  <p>&nbsp; &nbsp; 'remark' =&gt; '',<br> );</p> 
  <p>array( // 账单2<br> &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'shop_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户净收', // 业务描述<br> &nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888881111, //入账账户3的账户ID<br> &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '商户净收入', //金额操作描述, 如果账户 8888888888881111 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同<br> &nbsp; &nbsp;&nbsp;'flow_type' =&gt; 'in', // 资金入账<br> &nbsp; &nbsp;&nbsp;'trade_type' =&gt; '交易入账', // 交易类型<br> &nbsp; &nbsp;&nbsp;'amount' =&gt; 2300,<br> &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> );</p> 
  <p>array( // 账单3<br> &nbsp; &nbsp;&nbsp;'order_id' =&gt; 'platform_xxxxxxxx', // 业务订单ID，没有生成平台补贴订单前，可考虑使用资金出方向(用户订单ID)，后者创建一个公共的该资金流的私有ID<br> &nbsp; &nbsp;&nbsp;'business_desc' =&gt; '百度外卖商户抽佣', // 业务描述<br> &nbsp; &nbsp;&nbsp;'account_id' =&gt; 8888888888883333, //入账账户3的账户ID<br> &nbsp; &nbsp;&nbsp;'trade_desc' =&gt; '平台抽佣金额', //金额操作描述, 如果账户 8888888888883333 在分账流中出现了两次，因此该账户在本次交易流中的四元素必须不同<br> &nbsp; &nbsp;&nbsp;'flow_type' =&gt; 'in', // 资金入账<br> &nbsp; &nbsp;&nbsp;'trade_type' =&gt; '交易入账', // 交易类型<br> &nbsp; &nbsp;&nbsp;'amount' =&gt; 200,<br> &nbsp; &nbsp;&nbsp;'remark' =&gt; '',<br> );</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h3><a name="t30"></a>3.4.7 资金流按业务分区块</h3> 
  <p>&nbsp;</p> 
  <p>1、方便按业务块：每个业务作为一棵子树，存在于整体资金流中，方便资金按业务区块的简易、高效管理</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 业务需求：方便每个业务管理本业务的资金</p> 
  <p>2、方便完整资金流查询：所有业务共用一棵资金流树，整体资金流可以方便查询，且资金关系完整易维护。</p> 
  <p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 财务需求：一棵完整的资金流树，方便财务跟踪整体资金流向</p> 
  <p>&nbsp;</p> 
  <h3><a name="t31"></a>3.4.8&nbsp;资金操作接口API</h3> 
  <p>3.4.8.1 完善的API接口</p> 
  <p>入账、出账、分账、调账和撤销等，实现资金操作接口统一化，</p> 
  <p>&nbsp;</p> 
  <p>3.4.8.2 规范、丰富的交易类型</p> 
  <p>交易类型场景化和统一化</p> 
  <p>交易类型可定制</p> 
  <p>丰富交易类型，实现按类型归纳、追踪、查询和统计等</p> 
  <p>&nbsp;</p> 
  <p>3.4.8.3 资金分配状态机</p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/9537682/image2017-8-10%2016%3A50%3A11.png?version=1&amp;modificationDate=1502355066000&amp;api=v2"></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180813094423806?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>资金操作API的背后，是规范化了的资金分配关系数据</p> 
  <p>资金分配关系数据，可以确保资金的准确分配</p> 
  <p>记录资金分配的完整过程</p> 
  <p>资金分配<strong>状态机</strong>的载体</p> 
  <p>同时通过资金分配关系，可以复盘、<strong>回放资金交易</strong>的完整过程</p> 
  <p>&nbsp;</p> 
  <p>3.4.8.4 资金撤回</p> 
  <p>1、支持取消任意账户分账（单节点取消分账）</p> 
  <p>2、支持递归取消任意账户下的分账（按业务区块递归取消多节点分账）</p> 
  <p>3、支持递归取消整个资金流的分账（取消整棵资金分配过程）</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2><a name="t32"></a>3.5 资源管理</h2> 
  <p>支持批量请求:支持单个请求处理，也支持批量请求处理，</p> 
  <p>统一事务管理:同一个请求中，无论是包含单个请求，还是多个请求，有一个请求失败，整个操作都需要回滚</p> 
  <p>统一资源管理:其中包括数据库连接、账户锁等资源，操作串行化，数据锁互斥。</p> 
  <p>统一异常处理:错误抛异常，异常格式统一化...</p> 
  <p>&nbsp;</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180810184352492?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A49%3A48.png?version=1&amp;modificationDate=1495194616000&amp;api=v2"></p> 
  <p>&nbsp;</p> 
  <p>&nbsp;</p> 
  <h2><a name="t33"></a>3.6 设计回顾总结</h2> 
  <p>赘述一下交易回放的实现 : 所有的分账，都有唯一的操作记录，分账数据不复用不重用，这是交易记录可回放的前提，同时也是业务正确性的支撑(需要清除无效的历史数据)。</p> 
  <p>账户是一个概念，账户可以承载补偿、积分、优惠券等特殊的资金。</p> 
  <p>上面说了一大堆，如下图示简单总结，小清新一下。</p> 
  <p><img alt="" class="has" src="http://wiki.inwaimai.baidu.com/download/attachments/7993775/image2017-5-19%2019%3A48%3A53.png?version=1&amp;modificationDate=1495194561000&amp;api=v2"></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018081018442527?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lrMjAwODA4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/yk200808/article/details/81624826,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/yk200808/article/details/81624826,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
