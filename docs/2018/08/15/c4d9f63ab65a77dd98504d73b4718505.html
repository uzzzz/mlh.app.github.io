<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>第十五篇 墨客区块链(MOAC BlockChain) 搭建自己的第一个DAPP | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="第十五篇 墨客区块链(MOAC BlockChain) 搭建自己的第一个DAPP" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81698014 本文平台：MOAC Nuwa v1.0.2 操作系统：64位 Windows 10 中文版 开发环境：node.js v8.11.1&nbsp; +&nbsp; npm v5.6.0&nbsp; +&nbsp; express v4.16.0&nbsp; +&nbsp; chain3 &nbsp; 1.开发环境 1.1 安装moac节点 &nbsp; &nbsp; &nbsp; 请参考文档《第三篇 墨客区块链(MOAC BlockChain) 节点安装教程》。 &nbsp; &nbsp; &nbsp; 启动节点使用命令： D:\nuwa1.0.2.win&gt;moac --rpc 1.2 安装开发环境 &nbsp; &nbsp; &nbsp; 请参考文档《第七篇 墨客区块链(MOAC BlockChain) 开发环境搭建》。 下载并安装git；本文中，安装成功后，仅需配置到环境变量即可； 下载并安装node.js，该步骤会自动安装npm； 安装express；该命令中“express”和“-genetator”之间没有空格； C:\&gt;npm install -g express C:\&gt;npm install -g express-generator@4 安装chain3； C:\&gt;npm install -g chain3 //Node.js &nbsp; 2.创建项目 2.1 创建express项目 D:\&gt;cd D:\nodeJS_Project D:\nodeJS_Project&gt;express -e firstApp 2.2 按提示做三步 第1步.进入目录（change directory） D:\nodeJS_Project&gt;cd firstApp 第2步.安装依赖（install dependencies） D:\nodeJS_Project\firstApp&gt;npm install 第3步.运行app（run the app） D:\nodeJS_Project\firstApp&gt;SET DEBUG=nodeProject1:* &amp; npm start 2.3 到浏览器查看 表示项目创建成功。 2.4 项目简单解析 经过以上步骤，目录显示为： bin\www：启动项，在package.json中定义的“start”； 主要是侦听，扮演“Event listener for HTTP server”角色； 一般不用修改，如果需要可以修改端口（默认3000）； node_modules：项目依赖的模块，通过npm install命令加载； public：公共文件的存放位置，默认把公共文件比如images、javascript、stylesheets等放在该文件夹下面； routes：express路由； 路由是由一个 URI（或者叫路径）和一个特定的 HTTP 方法（GET、POST 等）组成的，涉及到应用如何响应客户端对某个网站节点的访问； 每一个路由都可以有一个或者多个处理器函数，当匹配到路由时，这个/些函数将被执行； 可以通过next来控制路由是否向下进行，如果不调用next，则不会向下继续，而调用next则会触发下一个路由； views：前端页面都放在该文件夹下面；视图的模板引擎是ejs； app.js：项目入口；使用app.use()来配置中间件，中间件的效果和路由基本一致； package.json：项目的相关信息，比如项目名称、版本、依赖项等； package-lock.js：这是一个包锁，匹配package.json； 描述依赖关系树的单一表示，以确保队友，部署和持续集成确保安装完全相同的依赖关系； 为用户提供一个设施，使其能够“前往”以前的node_modules状态而不必提交目录本身； 允许npm跳过先前安装的软件包的重复元数据来优化安装过程。 2.5 流程简单解析 每次重新启动项目，使用命令： D:\nodeJS_Project\firstApp&gt;npm start 在浏览器输入localhost:3000发送一个get请求,node服务监听到来自3000端口的请求时就会对这个请求进行处理； 它会对地址栏的地址和路由规则进行匹配，如果匹配成功它就会返回请求的处理，对相应的页面进行渲染； 本实例中，启动的是bin\www，后台响应的是routes\index.js，实际显示的是views\index.ejs； 发送get请求、函数回调和内容显示主要在routes\index.js和views\index.ejs之间进行。 注意：1、本文即依据这些简单的express框架知识，实现第一个DAPP的构建； &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、本文的DAPP实现将自定义数据写入墨客区块链，并能依据返回的hash值读出已经写入区块链中的内容。有关此处的内容及代码主要参考《第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中》。 &nbsp; 3.将自定义数据写入区块链 3.1 下载 jquery.min.js 本实例中会用到jquery.min.js，下载该文件放到目录：D:\nodeJS_Project\firstApp\public\javascripts。 3.2 将数据写入区块链的js文件 将sendDataToBlockchain.js文件放到目录：D:\nodeJS_Project\firstApp\routes。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); var address = &quot;0x745c57ca5318093115d61bbca368XXXXXXXXXXXX&quot;; var account = {address:&quot;0x745c57ca5318093115d61bbca368XXXXXXXXXXXX&quot;,secret:&quot;bb673026deda3c3cd0c63f6ccddfb02a7ae320078aa8XXXXXXXXXXXXXXXXXXXX&quot;}; //该函数用于回调，取得前端要发送上链的数据message，并返回hash exports.sendMessage = function(message) { return send(message, chain3, account.address, account.secret, txCount = -1); } function send(message, chain3, fromAddress, fromSecret, txCount = -1){ var mc = chain3.mc; var txcount = txCount &gt;= 0 ? txCount : chain3.mc.getTransactionCount(fromAddress); console.log(&quot;Get tx account&quot;, chain3.mc.getTransactionCount(fromAddress)); console.log(&quot;Get tx account&quot;, txcount); var gasPrice = 25000000000; var gasLimit = 100000; var gasTotal = gasPrice * gasLimit; //console.log(gasPrice, gasLimit, chain3.fromSha(gasTotal, &#39;sha&#39;)); //以下定义写入数据log let log = { time:(new Date).getTime(), type:&quot;info&quot;, msg:message }; //转换log数据格式 let str = JSON.stringify(log); console.log(str); let data = Buffer.from(str).toString(&#39;hex&#39;); data = &#39;0x&#39;+data; console.log(data); var rawTx = { from: fromAddress, //to: toAddress, nonce: chain3.intToHex(txcount), gasPrice: chain3.intToHex(gasPrice), gasLimit: chain3.intToHex(gasLimit), //value: chain3.intToHex(value), data: data , shardingFlag: 0, //default is global contract chainId: chain3.version.network }; var signedTx = chain3.signTransaction(rawTx, fromSecret); return new Promise (function(resolve, reject){ //用于异步函数回调 mc.sendRawTransaction(signedTx, function(err, hash) { if (!err){ console.log(&quot;succeed: &quot;, hash); resolve(hash); }else{ console.log(&quot;error:&quot;, err); console.log(&#39;raw tx:&#39;, rawTx); reject(err); } }); }) } 3.3 修改后端代码 将D:\nodeJS_Project\firstApp\routes目录下的index.js文件增加交互功能。 var express = require(&#39;express&#39;); var router = express.Router(); //引入发送数据方法，就是3.2步骤中的sendDataToBlockchain.js var sendData = require(&#39;./sendDataToBlockchain.js&#39;); /* GET home page. */ router.get(&#39;/&#39;, function(req, res, next) { res.render(&#39;index&#39;, { title: &#39;Express&#39; }); }); /* POST message ,return hash. */ //接口&#39;/api/sendData&#39;与前端views\index.ejs交互 //调用sendMessage，发送req.body.text，并返回hash router.post(&#39;/api/sendData&#39;, function(req, res, next) { //发送完成后,异步回调 sendData.sendMessage(req.body.text).then(function(hash){ res.send({hash: hash}); }) }); module.exports = router; 3.4 修改前端代码 将D:\nodeJS_Project\firstApp\views目录下的index.ejs文件增加交互功能。 该代码中引入3.1节的jquery.min.js。 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div style=&quot;margin-bottom:10px;&quot;&gt;上链内容:&lt;/div&gt; &lt;input id=&quot;text&quot; style=&quot;width:500px;height:20px;&quot;&gt;&lt;/input&gt; &lt;button onclick=&quot;onSend()&quot;&gt;发送&lt;/button&gt; &lt;br/&gt; &lt;div id=&quot;result&quot;&gt;&lt;/div&gt; &lt;/body&gt; &lt;script src=&quot;/javascripts/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; function onSend() { $.ajax({ type: &#39;POST&#39;, url: &#39;/api/sendData&#39;, //与后端routes\index.js交互接口 data: { text: $(&#39;#text&#39;).val() }, success: function (result) { //成功回调方法 $(&#39;#result&#39;).html(&quot;hash:&quot;+result.hash); }, error: function () { //失败回调方法 } }); } &lt;/script&gt; &lt;/html&gt; 3.5 实测发送数据 启动本地节点： D:\nuwa1.0.2.win&gt;moac --rpc 启动本地项目： D:\nodeJS_Project\firstApp&gt;npm start 登录浏览器： 输入上链内容，比如“hello，world！”，点击按钮发送： 返回hash值，到浏览器查询该hash： 显示已经正确写到区块链上，使用《第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中》的代码读出并解析内容，结果如下： &nbsp; 4.读取区块链上的数据 注意：此处数据特指本文第三节写入到区块链交易的data字段中的数据。 4.1 增加功能配置 在app.js里增加定义该功能的模块。 var getDataRouter = require(&#39;./routes/getData&#39;); app.use(&#39;/getData&#39;, getDataRouter); 4.2 读取区块链数据的js文件 将getDataFromBlockchain.js文件放到目录：D:\nodeJS_Project\firstApp\routes。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); exports.getMessage = function(hash) { var receipt = chain3.mc.getTransaction(hash); res_str = Buffer.from(receipt.input.replace(&#39;0x&#39;,&#39;&#39;),&#39;hex&#39;).toString(); res_json = JSON.parse(res_str); console.log(&#39;get transaction from hash :&#39;+ JSON.stringify(receipt)); return res_json.msg; } 4.3 后端代码 在D:\nodeJS_Project\firstApp\routes目录下新建getData.js文件。 var express = require(&#39;express&#39;); var router = express.Router(); //引入解析数据方法,就是4.1步骤中的getDataFromBlockchain.js var callData = require(&#39;./getDataFromBlockchain.js&#39;); /* GET home page. */ router.get(&#39;/&#39;, function(req, res, next) { res.render(&#39;getData&#39;, { title: &#39;Express&#39;, moac:&#39;hello moac&#39;}); }); /* POST hash ,return message. */ //接口&#39;/api/getData&#39;与前端views\getData.ejs交互 //调用getMessage，发送req.body.text，并返回message router.post(&#39;/api/getData&#39;, function(req, res, next) { res.send({message:callData.getMessage(req.body.text)}); }); module.exports = router; 4.4 前端代码 在D:\nodeJS_Project\firstApp\views目录下新建getData.ejs文件。 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div style=&quot;margin-bottom:10px;&quot;&gt;查询哈希:&lt;/div&gt; &lt;input id=&quot;text&quot; style=&quot;width:500px;height:20px;&quot;&gt;&lt;/input&gt; &lt;button onclick=&quot;onSend()&quot;&gt;发送&lt;/button&gt; &lt;br/&gt; &lt;div id=&quot;result&quot;&gt;&lt;/div&gt; &lt;/body&gt; &lt;script src=&quot;/javascripts/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; function onSend() { $.ajax({ type: &#39;POST&#39;, url: &#39;/getData/api/getData&#39;, //与后端routes\getData.js交互接口 data: { text: $(&#39;#text&#39;).val() }, success: function (result) { //成功回调方法 $(&#39;#result&#39;).html(&quot;message:&quot;+result.message); }, error: function () { //失败回调方法 } }); } &lt;/script&gt; &lt;/html&gt; 4.5 实测读取数据 注意：后端修改后需要重新启动项目。 D:\nodeJS_Project\firstApp&gt;npm start 登录浏览器： 输入hash值，比如“0x57e0a3aa859402499a211113bda757466b15aee18cd9613228406eee7fc16ce7”，点击按钮发送： 立即得到结果，与第3节的上链数据吻合。 墨客(MOAC)作为开放、对DAPP友好的底层区块链平台，欢迎大家来开发自己的DAPP。实现共建、共享、共赢！ 阅读更多" />
<meta property="og:description" content="版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81698014 本文平台：MOAC Nuwa v1.0.2 操作系统：64位 Windows 10 中文版 开发环境：node.js v8.11.1&nbsp; +&nbsp; npm v5.6.0&nbsp; +&nbsp; express v4.16.0&nbsp; +&nbsp; chain3 &nbsp; 1.开发环境 1.1 安装moac节点 &nbsp; &nbsp; &nbsp; 请参考文档《第三篇 墨客区块链(MOAC BlockChain) 节点安装教程》。 &nbsp; &nbsp; &nbsp; 启动节点使用命令： D:\nuwa1.0.2.win&gt;moac --rpc 1.2 安装开发环境 &nbsp; &nbsp; &nbsp; 请参考文档《第七篇 墨客区块链(MOAC BlockChain) 开发环境搭建》。 下载并安装git；本文中，安装成功后，仅需配置到环境变量即可； 下载并安装node.js，该步骤会自动安装npm； 安装express；该命令中“express”和“-genetator”之间没有空格； C:\&gt;npm install -g express C:\&gt;npm install -g express-generator@4 安装chain3； C:\&gt;npm install -g chain3 //Node.js &nbsp; 2.创建项目 2.1 创建express项目 D:\&gt;cd D:\nodeJS_Project D:\nodeJS_Project&gt;express -e firstApp 2.2 按提示做三步 第1步.进入目录（change directory） D:\nodeJS_Project&gt;cd firstApp 第2步.安装依赖（install dependencies） D:\nodeJS_Project\firstApp&gt;npm install 第3步.运行app（run the app） D:\nodeJS_Project\firstApp&gt;SET DEBUG=nodeProject1:* &amp; npm start 2.3 到浏览器查看 表示项目创建成功。 2.4 项目简单解析 经过以上步骤，目录显示为： bin\www：启动项，在package.json中定义的“start”； 主要是侦听，扮演“Event listener for HTTP server”角色； 一般不用修改，如果需要可以修改端口（默认3000）； node_modules：项目依赖的模块，通过npm install命令加载； public：公共文件的存放位置，默认把公共文件比如images、javascript、stylesheets等放在该文件夹下面； routes：express路由； 路由是由一个 URI（或者叫路径）和一个特定的 HTTP 方法（GET、POST 等）组成的，涉及到应用如何响应客户端对某个网站节点的访问； 每一个路由都可以有一个或者多个处理器函数，当匹配到路由时，这个/些函数将被执行； 可以通过next来控制路由是否向下进行，如果不调用next，则不会向下继续，而调用next则会触发下一个路由； views：前端页面都放在该文件夹下面；视图的模板引擎是ejs； app.js：项目入口；使用app.use()来配置中间件，中间件的效果和路由基本一致； package.json：项目的相关信息，比如项目名称、版本、依赖项等； package-lock.js：这是一个包锁，匹配package.json； 描述依赖关系树的单一表示，以确保队友，部署和持续集成确保安装完全相同的依赖关系； 为用户提供一个设施，使其能够“前往”以前的node_modules状态而不必提交目录本身； 允许npm跳过先前安装的软件包的重复元数据来优化安装过程。 2.5 流程简单解析 每次重新启动项目，使用命令： D:\nodeJS_Project\firstApp&gt;npm start 在浏览器输入localhost:3000发送一个get请求,node服务监听到来自3000端口的请求时就会对这个请求进行处理； 它会对地址栏的地址和路由规则进行匹配，如果匹配成功它就会返回请求的处理，对相应的页面进行渲染； 本实例中，启动的是bin\www，后台响应的是routes\index.js，实际显示的是views\index.ejs； 发送get请求、函数回调和内容显示主要在routes\index.js和views\index.ejs之间进行。 注意：1、本文即依据这些简单的express框架知识，实现第一个DAPP的构建； &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、本文的DAPP实现将自定义数据写入墨客区块链，并能依据返回的hash值读出已经写入区块链中的内容。有关此处的内容及代码主要参考《第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中》。 &nbsp; 3.将自定义数据写入区块链 3.1 下载 jquery.min.js 本实例中会用到jquery.min.js，下载该文件放到目录：D:\nodeJS_Project\firstApp\public\javascripts。 3.2 将数据写入区块链的js文件 将sendDataToBlockchain.js文件放到目录：D:\nodeJS_Project\firstApp\routes。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); var address = &quot;0x745c57ca5318093115d61bbca368XXXXXXXXXXXX&quot;; var account = {address:&quot;0x745c57ca5318093115d61bbca368XXXXXXXXXXXX&quot;,secret:&quot;bb673026deda3c3cd0c63f6ccddfb02a7ae320078aa8XXXXXXXXXXXXXXXXXXXX&quot;}; //该函数用于回调，取得前端要发送上链的数据message，并返回hash exports.sendMessage = function(message) { return send(message, chain3, account.address, account.secret, txCount = -1); } function send(message, chain3, fromAddress, fromSecret, txCount = -1){ var mc = chain3.mc; var txcount = txCount &gt;= 0 ? txCount : chain3.mc.getTransactionCount(fromAddress); console.log(&quot;Get tx account&quot;, chain3.mc.getTransactionCount(fromAddress)); console.log(&quot;Get tx account&quot;, txcount); var gasPrice = 25000000000; var gasLimit = 100000; var gasTotal = gasPrice * gasLimit; //console.log(gasPrice, gasLimit, chain3.fromSha(gasTotal, &#39;sha&#39;)); //以下定义写入数据log let log = { time:(new Date).getTime(), type:&quot;info&quot;, msg:message }; //转换log数据格式 let str = JSON.stringify(log); console.log(str); let data = Buffer.from(str).toString(&#39;hex&#39;); data = &#39;0x&#39;+data; console.log(data); var rawTx = { from: fromAddress, //to: toAddress, nonce: chain3.intToHex(txcount), gasPrice: chain3.intToHex(gasPrice), gasLimit: chain3.intToHex(gasLimit), //value: chain3.intToHex(value), data: data , shardingFlag: 0, //default is global contract chainId: chain3.version.network }; var signedTx = chain3.signTransaction(rawTx, fromSecret); return new Promise (function(resolve, reject){ //用于异步函数回调 mc.sendRawTransaction(signedTx, function(err, hash) { if (!err){ console.log(&quot;succeed: &quot;, hash); resolve(hash); }else{ console.log(&quot;error:&quot;, err); console.log(&#39;raw tx:&#39;, rawTx); reject(err); } }); }) } 3.3 修改后端代码 将D:\nodeJS_Project\firstApp\routes目录下的index.js文件增加交互功能。 var express = require(&#39;express&#39;); var router = express.Router(); //引入发送数据方法，就是3.2步骤中的sendDataToBlockchain.js var sendData = require(&#39;./sendDataToBlockchain.js&#39;); /* GET home page. */ router.get(&#39;/&#39;, function(req, res, next) { res.render(&#39;index&#39;, { title: &#39;Express&#39; }); }); /* POST message ,return hash. */ //接口&#39;/api/sendData&#39;与前端views\index.ejs交互 //调用sendMessage，发送req.body.text，并返回hash router.post(&#39;/api/sendData&#39;, function(req, res, next) { //发送完成后,异步回调 sendData.sendMessage(req.body.text).then(function(hash){ res.send({hash: hash}); }) }); module.exports = router; 3.4 修改前端代码 将D:\nodeJS_Project\firstApp\views目录下的index.ejs文件增加交互功能。 该代码中引入3.1节的jquery.min.js。 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div style=&quot;margin-bottom:10px;&quot;&gt;上链内容:&lt;/div&gt; &lt;input id=&quot;text&quot; style=&quot;width:500px;height:20px;&quot;&gt;&lt;/input&gt; &lt;button onclick=&quot;onSend()&quot;&gt;发送&lt;/button&gt; &lt;br/&gt; &lt;div id=&quot;result&quot;&gt;&lt;/div&gt; &lt;/body&gt; &lt;script src=&quot;/javascripts/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; function onSend() { $.ajax({ type: &#39;POST&#39;, url: &#39;/api/sendData&#39;, //与后端routes\index.js交互接口 data: { text: $(&#39;#text&#39;).val() }, success: function (result) { //成功回调方法 $(&#39;#result&#39;).html(&quot;hash:&quot;+result.hash); }, error: function () { //失败回调方法 } }); } &lt;/script&gt; &lt;/html&gt; 3.5 实测发送数据 启动本地节点： D:\nuwa1.0.2.win&gt;moac --rpc 启动本地项目： D:\nodeJS_Project\firstApp&gt;npm start 登录浏览器： 输入上链内容，比如“hello，world！”，点击按钮发送： 返回hash值，到浏览器查询该hash： 显示已经正确写到区块链上，使用《第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中》的代码读出并解析内容，结果如下： &nbsp; 4.读取区块链上的数据 注意：此处数据特指本文第三节写入到区块链交易的data字段中的数据。 4.1 增加功能配置 在app.js里增加定义该功能的模块。 var getDataRouter = require(&#39;./routes/getData&#39;); app.use(&#39;/getData&#39;, getDataRouter); 4.2 读取区块链数据的js文件 将getDataFromBlockchain.js文件放到目录：D:\nodeJS_Project\firstApp\routes。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); exports.getMessage = function(hash) { var receipt = chain3.mc.getTransaction(hash); res_str = Buffer.from(receipt.input.replace(&#39;0x&#39;,&#39;&#39;),&#39;hex&#39;).toString(); res_json = JSON.parse(res_str); console.log(&#39;get transaction from hash :&#39;+ JSON.stringify(receipt)); return res_json.msg; } 4.3 后端代码 在D:\nodeJS_Project\firstApp\routes目录下新建getData.js文件。 var express = require(&#39;express&#39;); var router = express.Router(); //引入解析数据方法,就是4.1步骤中的getDataFromBlockchain.js var callData = require(&#39;./getDataFromBlockchain.js&#39;); /* GET home page. */ router.get(&#39;/&#39;, function(req, res, next) { res.render(&#39;getData&#39;, { title: &#39;Express&#39;, moac:&#39;hello moac&#39;}); }); /* POST hash ,return message. */ //接口&#39;/api/getData&#39;与前端views\getData.ejs交互 //调用getMessage，发送req.body.text，并返回message router.post(&#39;/api/getData&#39;, function(req, res, next) { res.send({message:callData.getMessage(req.body.text)}); }); module.exports = router; 4.4 前端代码 在D:\nodeJS_Project\firstApp\views目录下新建getData.ejs文件。 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div style=&quot;margin-bottom:10px;&quot;&gt;查询哈希:&lt;/div&gt; &lt;input id=&quot;text&quot; style=&quot;width:500px;height:20px;&quot;&gt;&lt;/input&gt; &lt;button onclick=&quot;onSend()&quot;&gt;发送&lt;/button&gt; &lt;br/&gt; &lt;div id=&quot;result&quot;&gt;&lt;/div&gt; &lt;/body&gt; &lt;script src=&quot;/javascripts/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; function onSend() { $.ajax({ type: &#39;POST&#39;, url: &#39;/getData/api/getData&#39;, //与后端routes\getData.js交互接口 data: { text: $(&#39;#text&#39;).val() }, success: function (result) { //成功回调方法 $(&#39;#result&#39;).html(&quot;message:&quot;+result.message); }, error: function () { //失败回调方法 } }); } &lt;/script&gt; &lt;/html&gt; 4.5 实测读取数据 注意：后端修改后需要重新启动项目。 D:\nodeJS_Project\firstApp&gt;npm start 登录浏览器： 输入hash值，比如“0x57e0a3aa859402499a211113bda757466b15aee18cd9613228406eee7fc16ce7”，点击按钮发送： 立即得到结果，与第3节的上链数据吻合。 墨客(MOAC)作为开放、对DAPP友好的底层区块链平台，欢迎大家来开发自己的DAPP。实现共建、共享、共赢！ 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-15T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81698014 本文平台：MOAC Nuwa v1.0.2 操作系统：64位 Windows 10 中文版 开发环境：node.js v8.11.1&nbsp; +&nbsp; npm v5.6.0&nbsp; +&nbsp; express v4.16.0&nbsp; +&nbsp; chain3 &nbsp; 1.开发环境 1.1 安装moac节点 &nbsp; &nbsp; &nbsp; 请参考文档《第三篇 墨客区块链(MOAC BlockChain) 节点安装教程》。 &nbsp; &nbsp; &nbsp; 启动节点使用命令： D:\\nuwa1.0.2.win&gt;moac --rpc 1.2 安装开发环境 &nbsp; &nbsp; &nbsp; 请参考文档《第七篇 墨客区块链(MOAC BlockChain) 开发环境搭建》。 下载并安装git；本文中，安装成功后，仅需配置到环境变量即可； 下载并安装node.js，该步骤会自动安装npm； 安装express；该命令中“express”和“-genetator”之间没有空格； C:\\&gt;npm install -g express C:\\&gt;npm install -g express-generator@4 安装chain3； C:\\&gt;npm install -g chain3 //Node.js &nbsp; 2.创建项目 2.1 创建express项目 D:\\&gt;cd D:\\nodeJS_Project D:\\nodeJS_Project&gt;express -e firstApp 2.2 按提示做三步 第1步.进入目录（change directory） D:\\nodeJS_Project&gt;cd firstApp 第2步.安装依赖（install dependencies） D:\\nodeJS_Project\\firstApp&gt;npm install 第3步.运行app（run the app） D:\\nodeJS_Project\\firstApp&gt;SET DEBUG=nodeProject1:* &amp; npm start 2.3 到浏览器查看 表示项目创建成功。 2.4 项目简单解析 经过以上步骤，目录显示为： bin\\www：启动项，在package.json中定义的“start”； 主要是侦听，扮演“Event listener for HTTP server”角色； 一般不用修改，如果需要可以修改端口（默认3000）； node_modules：项目依赖的模块，通过npm install命令加载； public：公共文件的存放位置，默认把公共文件比如images、javascript、stylesheets等放在该文件夹下面； routes：express路由； 路由是由一个 URI（或者叫路径）和一个特定的 HTTP 方法（GET、POST 等）组成的，涉及到应用如何响应客户端对某个网站节点的访问； 每一个路由都可以有一个或者多个处理器函数，当匹配到路由时，这个/些函数将被执行； 可以通过next来控制路由是否向下进行，如果不调用next，则不会向下继续，而调用next则会触发下一个路由； views：前端页面都放在该文件夹下面；视图的模板引擎是ejs； app.js：项目入口；使用app.use()来配置中间件，中间件的效果和路由基本一致； package.json：项目的相关信息，比如项目名称、版本、依赖项等； package-lock.js：这是一个包锁，匹配package.json； 描述依赖关系树的单一表示，以确保队友，部署和持续集成确保安装完全相同的依赖关系； 为用户提供一个设施，使其能够“前往”以前的node_modules状态而不必提交目录本身； 允许npm跳过先前安装的软件包的重复元数据来优化安装过程。 2.5 流程简单解析 每次重新启动项目，使用命令： D:\\nodeJS_Project\\firstApp&gt;npm start 在浏览器输入localhost:3000发送一个get请求,node服务监听到来自3000端口的请求时就会对这个请求进行处理； 它会对地址栏的地址和路由规则进行匹配，如果匹配成功它就会返回请求的处理，对相应的页面进行渲染； 本实例中，启动的是bin\\www，后台响应的是routes\\index.js，实际显示的是views\\index.ejs； 发送get请求、函数回调和内容显示主要在routes\\index.js和views\\index.ejs之间进行。 注意：1、本文即依据这些简单的express框架知识，实现第一个DAPP的构建； &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、本文的DAPP实现将自定义数据写入墨客区块链，并能依据返回的hash值读出已经写入区块链中的内容。有关此处的内容及代码主要参考《第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中》。 &nbsp; 3.将自定义数据写入区块链 3.1 下载 jquery.min.js 本实例中会用到jquery.min.js，下载该文件放到目录：D:\\nodeJS_Project\\firstApp\\public\\javascripts。 3.2 将数据写入区块链的js文件 将sendDataToBlockchain.js文件放到目录：D:\\nodeJS_Project\\firstApp\\routes。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); var address = &quot;0x745c57ca5318093115d61bbca368XXXXXXXXXXXX&quot;; var account = {address:&quot;0x745c57ca5318093115d61bbca368XXXXXXXXXXXX&quot;,secret:&quot;bb673026deda3c3cd0c63f6ccddfb02a7ae320078aa8XXXXXXXXXXXXXXXXXXXX&quot;}; //该函数用于回调，取得前端要发送上链的数据message，并返回hash exports.sendMessage = function(message) { return send(message, chain3, account.address, account.secret, txCount = -1); } function send(message, chain3, fromAddress, fromSecret, txCount = -1){ var mc = chain3.mc; var txcount = txCount &gt;= 0 ? txCount : chain3.mc.getTransactionCount(fromAddress); console.log(&quot;Get tx account&quot;, chain3.mc.getTransactionCount(fromAddress)); console.log(&quot;Get tx account&quot;, txcount); var gasPrice = 25000000000; var gasLimit = 100000; var gasTotal = gasPrice * gasLimit; //console.log(gasPrice, gasLimit, chain3.fromSha(gasTotal, &#39;sha&#39;)); //以下定义写入数据log let log = { time:(new Date).getTime(), type:&quot;info&quot;, msg:message }; //转换log数据格式 let str = JSON.stringify(log); console.log(str); let data = Buffer.from(str).toString(&#39;hex&#39;); data = &#39;0x&#39;+data; console.log(data); var rawTx = { from: fromAddress, //to: toAddress, nonce: chain3.intToHex(txcount), gasPrice: chain3.intToHex(gasPrice), gasLimit: chain3.intToHex(gasLimit), //value: chain3.intToHex(value), data: data , shardingFlag: 0, //default is global contract chainId: chain3.version.network }; var signedTx = chain3.signTransaction(rawTx, fromSecret); return new Promise (function(resolve, reject){ //用于异步函数回调 mc.sendRawTransaction(signedTx, function(err, hash) { if (!err){ console.log(&quot;succeed: &quot;, hash); resolve(hash); }else{ console.log(&quot;error:&quot;, err); console.log(&#39;raw tx:&#39;, rawTx); reject(err); } }); }) } 3.3 修改后端代码 将D:\\nodeJS_Project\\firstApp\\routes目录下的index.js文件增加交互功能。 var express = require(&#39;express&#39;); var router = express.Router(); //引入发送数据方法，就是3.2步骤中的sendDataToBlockchain.js var sendData = require(&#39;./sendDataToBlockchain.js&#39;); /* GET home page. */ router.get(&#39;/&#39;, function(req, res, next) { res.render(&#39;index&#39;, { title: &#39;Express&#39; }); }); /* POST message ,return hash. */ //接口&#39;/api/sendData&#39;与前端views\\index.ejs交互 //调用sendMessage，发送req.body.text，并返回hash router.post(&#39;/api/sendData&#39;, function(req, res, next) { //发送完成后,异步回调 sendData.sendMessage(req.body.text).then(function(hash){ res.send({hash: hash}); }) }); module.exports = router; 3.4 修改前端代码 将D:\\nodeJS_Project\\firstApp\\views目录下的index.ejs文件增加交互功能。 该代码中引入3.1节的jquery.min.js。 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div style=&quot;margin-bottom:10px;&quot;&gt;上链内容:&lt;/div&gt; &lt;input id=&quot;text&quot; style=&quot;width:500px;height:20px;&quot;&gt;&lt;/input&gt; &lt;button onclick=&quot;onSend()&quot;&gt;发送&lt;/button&gt; &lt;br/&gt; &lt;div id=&quot;result&quot;&gt;&lt;/div&gt; &lt;/body&gt; &lt;script src=&quot;/javascripts/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; function onSend() { $.ajax({ type: &#39;POST&#39;, url: &#39;/api/sendData&#39;, //与后端routes\\index.js交互接口 data: { text: $(&#39;#text&#39;).val() }, success: function (result) { //成功回调方法 $(&#39;#result&#39;).html(&quot;hash:&quot;+result.hash); }, error: function () { //失败回调方法 } }); } &lt;/script&gt; &lt;/html&gt; 3.5 实测发送数据 启动本地节点： D:\\nuwa1.0.2.win&gt;moac --rpc 启动本地项目： D:\\nodeJS_Project\\firstApp&gt;npm start 登录浏览器： 输入上链内容，比如“hello，world！”，点击按钮发送： 返回hash值，到浏览器查询该hash： 显示已经正确写到区块链上，使用《第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中》的代码读出并解析内容，结果如下： &nbsp; 4.读取区块链上的数据 注意：此处数据特指本文第三节写入到区块链交易的data字段中的数据。 4.1 增加功能配置 在app.js里增加定义该功能的模块。 var getDataRouter = require(&#39;./routes/getData&#39;); app.use(&#39;/getData&#39;, getDataRouter); 4.2 读取区块链数据的js文件 将getDataFromBlockchain.js文件放到目录：D:\\nodeJS_Project\\firstApp\\routes。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); exports.getMessage = function(hash) { var receipt = chain3.mc.getTransaction(hash); res_str = Buffer.from(receipt.input.replace(&#39;0x&#39;,&#39;&#39;),&#39;hex&#39;).toString(); res_json = JSON.parse(res_str); console.log(&#39;get transaction from hash :&#39;+ JSON.stringify(receipt)); return res_json.msg; } 4.3 后端代码 在D:\\nodeJS_Project\\firstApp\\routes目录下新建getData.js文件。 var express = require(&#39;express&#39;); var router = express.Router(); //引入解析数据方法,就是4.1步骤中的getDataFromBlockchain.js var callData = require(&#39;./getDataFromBlockchain.js&#39;); /* GET home page. */ router.get(&#39;/&#39;, function(req, res, next) { res.render(&#39;getData&#39;, { title: &#39;Express&#39;, moac:&#39;hello moac&#39;}); }); /* POST hash ,return message. */ //接口&#39;/api/getData&#39;与前端views\\getData.ejs交互 //调用getMessage，发送req.body.text，并返回message router.post(&#39;/api/getData&#39;, function(req, res, next) { res.send({message:callData.getMessage(req.body.text)}); }); module.exports = router; 4.4 前端代码 在D:\\nodeJS_Project\\firstApp\\views目录下新建getData.ejs文件。 &lt;!DOCTYPE html&gt; &lt;html lang=&quot;en&quot;&gt; &lt;head&gt; &lt;meta charset=&quot;UTF-8&quot;&gt; &lt;title&gt;Title&lt;/title&gt; &lt;/head&gt; &lt;body&gt; &lt;div style=&quot;margin-bottom:10px;&quot;&gt;查询哈希:&lt;/div&gt; &lt;input id=&quot;text&quot; style=&quot;width:500px;height:20px;&quot;&gt;&lt;/input&gt; &lt;button onclick=&quot;onSend()&quot;&gt;发送&lt;/button&gt; &lt;br/&gt; &lt;div id=&quot;result&quot;&gt;&lt;/div&gt; &lt;/body&gt; &lt;script src=&quot;/javascripts/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt; &lt;script type=&quot;text/javascript&quot;&gt; function onSend() { $.ajax({ type: &#39;POST&#39;, url: &#39;/getData/api/getData&#39;, //与后端routes\\getData.js交互接口 data: { text: $(&#39;#text&#39;).val() }, success: function (result) { //成功回调方法 $(&#39;#result&#39;).html(&quot;message:&quot;+result.message); }, error: function () { //失败回调方法 } }); } &lt;/script&gt; &lt;/html&gt; 4.5 实测读取数据 注意：后端修改后需要重新启动项目。 D:\\nodeJS_Project\\firstApp&gt;npm start 登录浏览器： 输入hash值，比如“0x57e0a3aa859402499a211113bda757466b15aee18cd9613228406eee7fc16ce7”，点击按钮发送： 立即得到结果，与第3节的上链数据吻合。 墨客(MOAC)作为开放、对DAPP友好的底层区块链平台，欢迎大家来开发自己的DAPP。实现共建、共享、共赢！ 阅读更多","@type":"BlogPosting","url":"/2018/08/15/c4d9f63ab65a77dd98504d73b4718505.html","headline":"第十五篇 墨客区块链(MOAC BlockChain) 搭建自己的第一个DAPP","dateModified":"2018-08-15T00:00:00+08:00","datePublished":"2018-08-15T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/08/15/c4d9f63ab65a77dd98504d73b4718505.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>第十五篇 墨客区块链(MOAC BlockChain) 搭建自己的第一个DAPP</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="article-copyright">
   版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81698014 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>本文平台：MOAC Nuwa v1.0.2</p> 
  <p>操作系统：64位 Windows 10 中文版</p> 
  <p>开发环境：node.js v8.11.1&nbsp; +&nbsp; npm v5.6.0&nbsp; +&nbsp; express v4.16.0&nbsp; +&nbsp; chain3</p> 
  <p>&nbsp;</p> 
  <p><strong>1.开发环境</strong></p> 
  <p><strong>1.1 安装moac节点</strong></p> 
  <p>&nbsp; &nbsp; &nbsp; 请参考文档《<a href="https://blog.csdn.net/lyq13573221675/article/details/81078424" rel="nofollow">第三篇 墨客区块链(MOAC BlockChain) 节点安装教程</a>》。</p> 
  <p>&nbsp; &nbsp; &nbsp; 启动节点使用命令：</p> 
  <pre class="has">
<code>D:\nuwa1.0.2.win&gt;moac --rpc</code></pre> 
  <p><strong>1.2 安装开发环境</strong></p> 
  <p>&nbsp; &nbsp; &nbsp; 请参考文档《<a href="https://blog.csdn.net/lyq13573221675/article/details/81214015" rel="nofollow">第七篇 墨客区块链(MOAC BlockChain) 开发环境搭建</a>》。</p> 
  <ul>
   <li>下载并安装git；本文中，安装成功后，仅需配置到环境变量即可；</li> 
   <li>下载并安装node.js，该步骤会自动安装npm；</li> 
   <li>安装express；该命令中“express”和“-genetator”之间没有空格；</li> 
  </ul>
  <pre class="has">
<code>C:\&gt;npm install -g express
C:\&gt;npm install -g express-generator@4</code></pre> 
  <ul>
   <li>安装chain3；</li> 
  </ul>
  <pre class="has">
<code>C:\&gt;npm install -g chain3               //Node.js</code></pre> 
  <p>&nbsp;</p> 
  <p><strong>2.创建项目</strong></p> 
  <p><strong>2.1 创建express项目</strong></p> 
  <pre class="has">
<code>D:\&gt;cd D:\nodeJS_Project
D:\nodeJS_Project&gt;express -e firstApp</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180815165904585?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>2.2 按提示做三步</strong></p> 
  <p>第1步.进入目录（change directory）</p> 
  <pre class="has">
<code>D:\nodeJS_Project&gt;cd firstApp</code></pre> 
  <p>第2步.安装依赖（install dependencies）</p> 
  <pre class="has">
<code>D:\nodeJS_Project\firstApp&gt;npm install</code></pre> 
  <p>第3步.运行app（run the app）</p> 
  <pre class="has">
<code>D:\nodeJS_Project\firstApp&gt;SET DEBUG=nodeProject1:* &amp; npm start</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180815171136291?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>2.3 到浏览器查看</strong></p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180815171655539?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>表示项目创建成功。</p> 
  <p><strong>2.4 项目简单解析</strong></p> 
  <p>经过以上步骤，目录显示为：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816092839305?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>bin\www：</strong>启动项，在package.json中定义的“start”；</p> 
  <ul>
   <li>主要是侦听，扮演“Event listener for HTTP server”角色；</li> 
   <li>一般不用修改，如果需要可以修改端口（默认3000）；</li> 
  </ul>
  <p><strong>node_modules：</strong>项目依赖的模块，通过npm install命令加载；</p> 
  <p><strong>public：</strong>公共文件的存放位置，默认把公共文件比如images、javascript、stylesheets等放在该文件夹下面；</p> 
  <p><strong>routes：</strong>express路由；</p> 
  <ul>
   <li>路由是由一个 URI（或者叫路径）和一个特定的 HTTP 方法（GET、POST 等）组成的，涉及到应用如何响应客户端对某个网站节点的访问；</li> 
   <li>每一个路由都可以有一个或者多个处理器函数，当匹配到路由时，这个/些函数将被执行；</li> 
   <li>可以通过next来控制路由是否向下进行，如果不调用next，则不会向下继续，而调用next则会触发下一个路由；</li> 
  </ul>
  <p><strong>views：</strong>前端页面都放在该文件夹下面；视图的模板引擎是ejs；</p> 
  <p><strong>app.js：</strong>项目入口；使用app.use()来配置中间件，中间件的效果和路由基本一致；</p> 
  <p><strong>package.json：</strong>项目的相关信息，比如项目名称、版本、依赖项等；</p> 
  <p><strong>package-lock.js：</strong>这是一个包锁，匹配package.json；</p> 
  <ul>
   <li>描述依赖关系树的单一表示，以确保队友，部署和持续集成确保安装完全相同的依赖关系；</li> 
   <li>为用户提供一个设施，使其能够“前往”以前的<code>node_modules</code>状态而不必提交目录本身；</li> 
   <li>允许npm跳过先前安装的软件包的重复元数据来优化安装过程。</li> 
  </ul>
  <p><strong>2.5 流程简单解析</strong></p> 
  <p>每次重新启动项目，使用命令：</p> 
  <pre class="has">
<code>D:\nodeJS_Project\firstApp&gt;npm start</code></pre> 
  <ol>
   <li>在浏览器输入localhost:3000发送一个get请求,node服务监听到来自3000端口的请求时就会对这个请求进行处理；</li> 
   <li>它会对地址栏的地址和路由规则进行匹配，如果匹配成功它就会返回请求的处理，对相应的页面进行渲染；</li> 
   <li>本实例中，启动的是bin\www，后台响应的是routes\index.js，实际显示的是views\index.ejs；</li> 
   <li>发送get请求、函数回调和内容显示主要在routes\index.js和views\index.ejs之间进行。</li> 
  </ol>
  <p><strong><span style="color:#ff0000;">注意：1、</span></strong><span style="color:#000000;">本文</span>即依据这些简单的express框架知识，实现第一个DAPP的构建；</p> 
  <p><strong><span style="color:#ff0000;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、</span></strong><span style="color:#000000;">本文的DAPP实现将自定义数据写入墨客区块链，并能依据返回的hash值读出已经写入区块链中的内容。有关此处的内容及代码主要参考《</span><a href="https://blog.csdn.net/lyq13573221675/article/details/81354458" rel="nofollow">第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中</a><span style="color:#000000;">》。</span></p> 
  <p>&nbsp;</p> 
  <p><strong>3.将自定义数据写入区块链</strong></p> 
  <p><strong>3.1 下载 jquery.min.js</strong></p> 
  <p>本实例中会用到jquery.min.js，下载该文件放到目录：D:\nodeJS_Project\firstApp\public\javascripts。</p> 
  <p><strong>3.2 将数据写入区块链的js文件</strong></p> 
  <p>将sendDataToBlockchain.js文件放到目录：D:\nodeJS_Project\firstApp\routes。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));

var address = "0x745c57ca5318093115d61bbca368XXXXXXXXXXXX";
var account = {address:"0x745c57ca5318093115d61bbca368XXXXXXXXXXXX",secret:"bb673026deda3c3cd0c63f6ccddfb02a7ae320078aa8XXXXXXXXXXXXXXXXXXXX"};

//该函数用于回调，取得前端要发送上链的数据message，并返回hash
exports.sendMessage = function(message) {
    return send(message, chain3, account.address, account.secret, txCount = -1);
}

function send(message, chain3, fromAddress, fromSecret, txCount = -1){
  var mc = chain3.mc;

  var txcount = txCount &gt;= 0 ? txCount : chain3.mc.getTransactionCount(fromAddress);
  console.log("Get tx account", chain3.mc.getTransactionCount(fromAddress));
  console.log("Get tx account", txcount);

  var gasPrice = 25000000000;
  var gasLimit = 100000;
  var gasTotal = gasPrice * gasLimit;
  //console.log(gasPrice, gasLimit, chain3.fromSha(gasTotal, 'sha'));
  
  //以下定义写入数据log
  let log = {
    time:(new Date).getTime(),
    type:"info",
    msg:message
  };
  //转换log数据格式
  let str = JSON.stringify(log);
  console.log(str);
  let data = Buffer.from(str).toString('hex');
  data = '0x'+data;
  console.log(data);  

  var rawTx = {
    from: fromAddress,
    //to: toAddress,
    nonce: chain3.intToHex(txcount),
    gasPrice: chain3.intToHex(gasPrice),
    gasLimit: chain3.intToHex(gasLimit),
    //value: chain3.intToHex(value),
    data: data ,
    shardingFlag: 0, //default is global contract
    chainId: chain3.version.network
  };

  var signedTx = chain3.signTransaction(rawTx, fromSecret);
  return new Promise (function(resolve, reject){             //用于异步函数回调
      mc.sendRawTransaction(signedTx, function(err, hash) {
          if (!err){
              console.log("succeed: ", hash);
              resolve(hash);
          }else{
              console.log("error:", err);
              console.log('raw tx:', rawTx);
              reject(err);
          }
      });	  
  })
}</code></pre> 
  <p><strong>3.3 修改后端代码</strong></p> 
  <p>将D:\nodeJS_Project\firstApp\routes目录下的index.js文件增加交互功能。</p> 
  <pre class="has">
<code>var express = require('express');
var router = express.Router();

//引入发送数据方法，就是3.2步骤中的sendDataToBlockchain.js
var sendData = require('./sendDataToBlockchain.js');

/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});

/* POST message ,return hash. */
//接口'/api/sendData'与前端views\index.ejs交互
//调用sendMessage，发送req.body.text，并返回hash
router.post('/api/sendData', function(req, res, next) {
    //发送完成后,异步回调
    sendData.sendMessage(req.body.text).then(function(hash){
        res.send({hash: hash});
    })  
});

module.exports = router;</code></pre> 
  <p><strong>3.4 修改前端代码</strong></p> 
  <p>将D:\nodeJS_Project\firstApp\views目录下的index.ejs文件增加交互功能。</p> 
  <p>该代码中引入3.1节的jquery.min.js。</p> 
  <pre class="has">
<code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div style="margin-bottom:10px;"&gt;上链内容:&lt;/div&gt;
    &lt;input id="text" style="width:500px;height:20px;"&gt;&lt;/input&gt;
    &lt;button onclick="onSend()"&gt;发送&lt;/button&gt;
    &lt;br/&gt;
    &lt;div id="result"&gt;&lt;/div&gt;
&lt;/body&gt;

&lt;script src="/javascripts/jquery.min.js" type="text/javascript"&gt;&lt;/script&gt;  
&lt;script type="text/javascript"&gt;
    function onSend() {
        $.ajax({
            type: 'POST',
            url: '/api/sendData',          //与后端routes\index.js交互接口
            data: {
                text: $('#text').val()
            },
            success: function (result) {   //成功回调方法
                $('#result').html("hash:"+result.hash);
            },
            error: function () {           //失败回调方法
            }
        });
    }
&lt;/script&gt;
&lt;/html&gt;
</code></pre> 
  <p><strong>3.5 实测发送数据</strong></p> 
  <p>启动本地节点：</p> 
  <pre class="has">
<code>D:\nuwa1.0.2.win&gt;moac --rpc</code></pre> 
  <p>启动本地项目：</p> 
  <pre class="has">
<code>D:\nodeJS_Project\firstApp&gt;npm start</code></pre> 
  <p>登录浏览器：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816164325775?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>输入上链内容，比如“hello，world！”，点击按钮发送：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816164511361?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>返回hash值，到浏览器查询该hash：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816164816554?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>显示已经正确写到区块链上，使用《<a href="https://blog.csdn.net/lyq13573221675/article/details/81354458" rel="nofollow">第十篇 墨客区块链(MOAC BlockChain) 如何将自定义数据写到区块链中</a>》的代码读出并解析内容，结果如下：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816165250457?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <p><strong>4.读取区块链上的数据</strong></p> 
  <p><strong><span style="color:#ff0000;">注意：</span></strong>此处数据特指本文第三节写入到区块链交易的data字段中的数据。</p> 
  <p><strong>4.1 增加功能配置</strong></p> 
  <p>在app.js里增加定义该功能的模块。</p> 
  <pre class="has">
<code>var getDataRouter = require('./routes/getData');
app.use('/getData', getDataRouter);</code></pre> 
  <p><strong>4.2 读取区块链数据的js文件</strong></p> 
  <p>将getDataFromBlockchain.js文件放到目录：D:\nodeJS_Project\firstApp\routes。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));

exports.getMessage = function(hash) {
    var receipt = chain3.mc.getTransaction(hash);
    res_str = Buffer.from(receipt.input.replace('0x',''),'hex').toString();
    res_json = JSON.parse(res_str);	
    console.log('get transaction from hash  :'+ JSON.stringify(receipt));
    return res_json.msg;
}</code></pre> 
  <p><strong>4.3 后端代码</strong></p> 
  <p>在D:\nodeJS_Project\firstApp\routes目录下新建getData.js文件。</p> 
  <pre class="has">
<code>var express = require('express');
var router = express.Router();

//引入解析数据方法,就是4.1步骤中的getDataFromBlockchain.js
var callData = require('./getDataFromBlockchain.js');

/* GET home page. */
router.get('/', function(req, res, next) {
  res.render('getData', { title: 'Express', moac:'hello moac'});
});

/* POST hash ,return message. */
//接口'/api/getData'与前端views\getData.ejs交互
//调用getMessage，发送req.body.text，并返回message
router.post('/api/getData', function(req, res, next) {
  res.send({message:callData.getMessage(req.body.text)});
});

module.exports = router;</code></pre> 
  <p><strong>4.4 前端代码</strong></p> 
  <p>在D:\nodeJS_Project\firstApp\views目录下新建getData.ejs文件。</p> 
  <pre class="has">
<code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;title&gt;Title&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div style="margin-bottom:10px;"&gt;查询哈希:&lt;/div&gt;
    &lt;input id="text" style="width:500px;height:20px;"&gt;&lt;/input&gt;
    &lt;button onclick="onSend()"&gt;发送&lt;/button&gt;
    &lt;br/&gt;
    &lt;div id="result"&gt;&lt;/div&gt;
&lt;/body&gt;

&lt;script src="/javascripts/jquery.min.js" type="text/javascript"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
    function onSend() {
        $.ajax({
            type: 'POST',
            url: '/getData/api/getData',        //与后端routes\getData.js交互接口
            data: {
                text: $('#text').val()
            },
            success: function (result) {        //成功回调方法
                $('#result').html("message:"+result.message);
            },
            error: function () {                //失败回调方法
            }
        });
    }
&lt;/script&gt;
&lt;/html&gt;
</code></pre> 
  <p><strong>4.5 实测读取数据</strong></p> 
  <p><strong><span style="color:#ff0000;">注意：</span></strong>后端修改后需要重新启动项目。</p> 
  <pre class="has">
<code>D:\nodeJS_Project\firstApp&gt;npm start</code></pre> 
  <p>登录浏览器：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816174154437?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>输入hash值，比如“0x57e0a3aa859402499a211113bda757466b15aee18cd9613228406eee7fc16ce7”，点击按钮发送：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816174239209?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>立即得到结果，与第3节的上链数据吻合。</p> 
  <p>墨客(MOAC)作为开放、对DAPP友好的底层区块链平台，欢迎大家来开发自己的DAPP。实现共建、共享、共赢！</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lyq13573221675/article/details/81698014,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lyq13573221675/article/details/81698014,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
