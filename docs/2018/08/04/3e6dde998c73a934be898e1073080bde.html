<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>TC 输入方向的弱网模拟 ( 一 ) | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="TC 输入方向的弱网模拟 ( 一 )" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="参考文档 https://wiki.linuxfoundation.org/networking/netem How can I use netem on incoming traffic? You need to use the Intermediate Functional Block pseudo-device IFB . This network device allows attaching queuing discplines to incoming packets. &nbsp;&nbsp;&nbsp;&nbsp;# modprobe ifb &nbsp;&nbsp;&nbsp;&nbsp;# ip link set dev ifb0 up &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev eth0 ingress &nbsp;&nbsp;&nbsp;&nbsp;# tc filter add dev eth0 parent ffff: \ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev ifb0 root netem delay 750ms Another way is to use another machine as an Ethernet bridge , and apply netem to both Ethernet devices. 文中简单提到了，2种方法： 使用 ifb 使用 2 台机器 … 操作实践下 按照上文中的提示，依次敲命令，体验下： modprobe ifb 执行命令： modprobe ifb 验证，执行命令： ip link list 显示内容： 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000 link/ether 00:16:3e:00:29:30 brd ff:ff:ff:ff:ff:ff 3: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b1:cd:f3:26 brd ff:ff:ff:ff:ff:ff 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b5:6d:27:f0 brd ff:ff:ff:ff:ff:ff 6: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether 7e:f2:81:b2:06:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0 12: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP mode DEFAULT group default link/ether 5a:60:84:59:3e:90 brd ff:ff:ff:ff:ff:ff link-netnsid 2 13: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default link/ether be:69:e0:c3:61:e6 brd ff:ff:ff:ff:ff:ff 14: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000 link/ether 0a:58:0a:f4:00:01 brd ff:ff:ff:ff:ff:ff 405: ifb0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether 2e:21:ac:75:30:3f brd ff:ff:ff:ff:ff:ff 406: ifb1: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether a6:a9:f7:cd:58:06 brd ff:ff:ff:ff:ff:ff 可以看到新增2块网卡： ifb0、ifb1 它们的状态为：state DOWN ip link set dev ifb0 up 执行命令： ip link set dev ifb0 up 验证，执行命令： ip link list 显示内容： 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000 link/ether 00:16:3e:00:29:30 brd ff:ff:ff:ff:ff:ff 3: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b1:cd:f3:26 brd ff:ff:ff:ff:ff:ff 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b5:6d:27:f0 brd ff:ff:ff:ff:ff:ff 6: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether 7e:f2:81:b2:06:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0 12: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP mode DEFAULT group default link/ether 5a:60:84:59:3e:90 brd ff:ff:ff:ff:ff:ff link-netnsid 2 13: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default link/ether be:69:e0:c3:61:e6 brd ff:ff:ff:ff:ff:ff 14: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000 link/ether 0a:58:0a:f4:00:01 brd ff:ff:ff:ff:ff:ff 405: ifb0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 32 link/ether 2e:21:ac:75:30:3f brd ff:ff:ff:ff:ff:ff 406: ifb1: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether a6:a9:f7:cd:58:06 brd ff:ff:ff:ff:ff:ff 可以看到 ifb0 网卡的状态为：state UNKNOWN tc qdisc add dev eth0 ingress 执行命令： tc qdisc add dev eth0 ingress 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 qdisc ingress ffff: parent ffff:fff1 ---------------- 可以看到 多了：qdisc ingress ffff: parent ffff:fff1 —————- tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 执行命令： tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 验证，执行命令： tc filter list dev eth0 parent ffff:fff1 显示内容： filter parent ffff: protocol ip pref 49152 u32 filter parent ffff: protocol ip pref 49152 u32 fh 800: ht divisor 1 filter parent ffff: protocol ip pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:1 match 00000000/00000000 at 0 action order 1: mirred (Egress Redirect to device ifb0) stolen index 4 ref 1 bind 1 可以看到 Egress Redirect to device ifb0 ，通过 eth0 的过滤器规则 parent ffff:fff1，把数据重定向到 device ifb0 tc qdisc add dev ifb0 root netem delay 750ms 执行命令： tc qdisc add dev ifb0 root netem delay 750ms 验证，执行命令： tc qdisc show dev ifb0 显示内容： qdisc netem 800d: root refcnt 2 limit 1000 delay 750.0ms 再在本地 ping 下测试 Linux 机看看： 可以看出，命令生效啦！ 试下输出方向是否正常 执行命令： tc qdisc add dev eth0 root netem delay 750ms 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc netem 800e: root refcnt 2 limit 1000 delay 750.0ms qdisc ingress ffff: parent ffff:fff1 ---------------- 再在本地 ping 下测试 Linux 机看看： 可以看到 输入方向、输出方向都生效了。 恢复正常 tc qdisc del dev ifb0 root netem 执行命令： tc qdisc del dev ifb0 root netem 验证，执行命令： tc qdisc show dev ifb0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 tc qdisc del dev eth0 root netem 执行命令： tc qdisc del dev eth0 root netem 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 qdisc ingress ffff: parent ffff:fff1 ---------------- tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32 若不知道过滤器名称： tc filter list dev eth0 parent ffff:fff1 显示内容： filter parent ffff: protocol ip pref 49152 u32 filter parent ffff: protocol ip pref 49152 u32 fh 800: ht divisor 1 filter parent ffff: protocol ip pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:1 match 00000000/00000000 at 0 action order 1: mirred (Egress Redirect to device ifb0) stolen index 4 ref 1 bind 1 然后执行： tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32 就可以删掉过滤器啦。 tc qdisc del dev eth0 ingress 最后执行： tc qdisc del dev eth0 ingress 以上 结束语 本章主要根据 https://wiki.linuxfoundation.org/networking/netem 中，关于输入方向的例子介绍。 实际操作练习了一遍。 下一章，继续根据 https://wiki.linuxfoundation.org/networking/netem 中的介绍，练习体验下，netem 的模拟网络的 6 个方面： Delay distribution （延迟分发） Packet loss （丢包） Packet duplication （数据包重复） Packet corruption （数据包损坏） Packet re-ordering （数据包乱序） Rate control （速率控制，或称之为带宽） 并在最后给出一些弱网模拟的5个方面的值设置。Rate control 可以不考虑！ 阅读更多" />
<meta property="og:description" content="参考文档 https://wiki.linuxfoundation.org/networking/netem How can I use netem on incoming traffic? You need to use the Intermediate Functional Block pseudo-device IFB . This network device allows attaching queuing discplines to incoming packets. &nbsp;&nbsp;&nbsp;&nbsp;# modprobe ifb &nbsp;&nbsp;&nbsp;&nbsp;# ip link set dev ifb0 up &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev eth0 ingress &nbsp;&nbsp;&nbsp;&nbsp;# tc filter add dev eth0 parent ffff: \ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev ifb0 root netem delay 750ms Another way is to use another machine as an Ethernet bridge , and apply netem to both Ethernet devices. 文中简单提到了，2种方法： 使用 ifb 使用 2 台机器 … 操作实践下 按照上文中的提示，依次敲命令，体验下： modprobe ifb 执行命令： modprobe ifb 验证，执行命令： ip link list 显示内容： 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000 link/ether 00:16:3e:00:29:30 brd ff:ff:ff:ff:ff:ff 3: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b1:cd:f3:26 brd ff:ff:ff:ff:ff:ff 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b5:6d:27:f0 brd ff:ff:ff:ff:ff:ff 6: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether 7e:f2:81:b2:06:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0 12: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP mode DEFAULT group default link/ether 5a:60:84:59:3e:90 brd ff:ff:ff:ff:ff:ff link-netnsid 2 13: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default link/ether be:69:e0:c3:61:e6 brd ff:ff:ff:ff:ff:ff 14: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000 link/ether 0a:58:0a:f4:00:01 brd ff:ff:ff:ff:ff:ff 405: ifb0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether 2e:21:ac:75:30:3f brd ff:ff:ff:ff:ff:ff 406: ifb1: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether a6:a9:f7:cd:58:06 brd ff:ff:ff:ff:ff:ff 可以看到新增2块网卡： ifb0、ifb1 它们的状态为：state DOWN ip link set dev ifb0 up 执行命令： ip link set dev ifb0 up 验证，执行命令： ip link list 显示内容： 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000 link/ether 00:16:3e:00:29:30 brd ff:ff:ff:ff:ff:ff 3: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b1:cd:f3:26 brd ff:ff:ff:ff:ff:ff 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b5:6d:27:f0 brd ff:ff:ff:ff:ff:ff 6: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether 7e:f2:81:b2:06:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0 12: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP mode DEFAULT group default link/ether 5a:60:84:59:3e:90 brd ff:ff:ff:ff:ff:ff link-netnsid 2 13: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default link/ether be:69:e0:c3:61:e6 brd ff:ff:ff:ff:ff:ff 14: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000 link/ether 0a:58:0a:f4:00:01 brd ff:ff:ff:ff:ff:ff 405: ifb0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 32 link/ether 2e:21:ac:75:30:3f brd ff:ff:ff:ff:ff:ff 406: ifb1: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether a6:a9:f7:cd:58:06 brd ff:ff:ff:ff:ff:ff 可以看到 ifb0 网卡的状态为：state UNKNOWN tc qdisc add dev eth0 ingress 执行命令： tc qdisc add dev eth0 ingress 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 qdisc ingress ffff: parent ffff:fff1 ---------------- 可以看到 多了：qdisc ingress ffff: parent ffff:fff1 —————- tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 执行命令： tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 验证，执行命令： tc filter list dev eth0 parent ffff:fff1 显示内容： filter parent ffff: protocol ip pref 49152 u32 filter parent ffff: protocol ip pref 49152 u32 fh 800: ht divisor 1 filter parent ffff: protocol ip pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:1 match 00000000/00000000 at 0 action order 1: mirred (Egress Redirect to device ifb0) stolen index 4 ref 1 bind 1 可以看到 Egress Redirect to device ifb0 ，通过 eth0 的过滤器规则 parent ffff:fff1，把数据重定向到 device ifb0 tc qdisc add dev ifb0 root netem delay 750ms 执行命令： tc qdisc add dev ifb0 root netem delay 750ms 验证，执行命令： tc qdisc show dev ifb0 显示内容： qdisc netem 800d: root refcnt 2 limit 1000 delay 750.0ms 再在本地 ping 下测试 Linux 机看看： 可以看出，命令生效啦！ 试下输出方向是否正常 执行命令： tc qdisc add dev eth0 root netem delay 750ms 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc netem 800e: root refcnt 2 limit 1000 delay 750.0ms qdisc ingress ffff: parent ffff:fff1 ---------------- 再在本地 ping 下测试 Linux 机看看： 可以看到 输入方向、输出方向都生效了。 恢复正常 tc qdisc del dev ifb0 root netem 执行命令： tc qdisc del dev ifb0 root netem 验证，执行命令： tc qdisc show dev ifb0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 tc qdisc del dev eth0 root netem 执行命令： tc qdisc del dev eth0 root netem 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 qdisc ingress ffff: parent ffff:fff1 ---------------- tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32 若不知道过滤器名称： tc filter list dev eth0 parent ffff:fff1 显示内容： filter parent ffff: protocol ip pref 49152 u32 filter parent ffff: protocol ip pref 49152 u32 fh 800: ht divisor 1 filter parent ffff: protocol ip pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:1 match 00000000/00000000 at 0 action order 1: mirred (Egress Redirect to device ifb0) stolen index 4 ref 1 bind 1 然后执行： tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32 就可以删掉过滤器啦。 tc qdisc del dev eth0 ingress 最后执行： tc qdisc del dev eth0 ingress 以上 结束语 本章主要根据 https://wiki.linuxfoundation.org/networking/netem 中，关于输入方向的例子介绍。 实际操作练习了一遍。 下一章，继续根据 https://wiki.linuxfoundation.org/networking/netem 中的介绍，练习体验下，netem 的模拟网络的 6 个方面： Delay distribution （延迟分发） Packet loss （丢包） Packet duplication （数据包重复） Packet corruption （数据包损坏） Packet re-ordering （数据包乱序） Rate control （速率控制，或称之为带宽） 并在最后给出一些弱网模拟的5个方面的值设置。Rate control 可以不考虑！ 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/08/04/3e6dde998c73a934be898e1073080bde.html" />
<meta property="og:url" content="https://mlh.app/2018/08/04/3e6dde998c73a934be898e1073080bde.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-04T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"参考文档 https://wiki.linuxfoundation.org/networking/netem How can I use netem on incoming traffic? You need to use the Intermediate Functional Block pseudo-device IFB . This network device allows attaching queuing discplines to incoming packets. &nbsp;&nbsp;&nbsp;&nbsp;# modprobe ifb &nbsp;&nbsp;&nbsp;&nbsp;# ip link set dev ifb0 up &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev eth0 ingress &nbsp;&nbsp;&nbsp;&nbsp;# tc filter add dev eth0 parent ffff: \\ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev ifb0 root netem delay 750ms Another way is to use another machine as an Ethernet bridge , and apply netem to both Ethernet devices. 文中简单提到了，2种方法： 使用 ifb 使用 2 台机器 … 操作实践下 按照上文中的提示，依次敲命令，体验下： modprobe ifb 执行命令： modprobe ifb 验证，执行命令： ip link list 显示内容： 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000 link/ether 00:16:3e:00:29:30 brd ff:ff:ff:ff:ff:ff 3: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b1:cd:f3:26 brd ff:ff:ff:ff:ff:ff 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b5:6d:27:f0 brd ff:ff:ff:ff:ff:ff 6: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether 7e:f2:81:b2:06:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0 12: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP mode DEFAULT group default link/ether 5a:60:84:59:3e:90 brd ff:ff:ff:ff:ff:ff link-netnsid 2 13: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default link/ether be:69:e0:c3:61:e6 brd ff:ff:ff:ff:ff:ff 14: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000 link/ether 0a:58:0a:f4:00:01 brd ff:ff:ff:ff:ff:ff 405: ifb0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether 2e:21:ac:75:30:3f brd ff:ff:ff:ff:ff:ff 406: ifb1: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether a6:a9:f7:cd:58:06 brd ff:ff:ff:ff:ff:ff 可以看到新增2块网卡： ifb0、ifb1 它们的状态为：state DOWN ip link set dev ifb0 up 执行命令： ip link set dev ifb0 up 验证，执行命令： ip link list 显示内容： 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000 link/ether 00:16:3e:00:29:30 brd ff:ff:ff:ff:ff:ff 3: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b1:cd:f3:26 brd ff:ff:ff:ff:ff:ff 4: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:b5:6d:27:f0 brd ff:ff:ff:ff:ff:ff 6: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether 7e:f2:81:b2:06:58 brd ff:ff:ff:ff:ff:ff link-netnsid 0 12: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker_gwbridge state UP mode DEFAULT group default link/ether 5a:60:84:59:3e:90 brd ff:ff:ff:ff:ff:ff link-netnsid 2 13: flannel.1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UNKNOWN mode DEFAULT group default link/ether be:69:e0:c3:61:e6 brd ff:ff:ff:ff:ff:ff 14: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000 link/ether 0a:58:0a:f4:00:01 brd ff:ff:ff:ff:ff:ff 405: ifb0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN mode DEFAULT group default qlen 32 link/ether 2e:21:ac:75:30:3f brd ff:ff:ff:ff:ff:ff 406: ifb1: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 32 link/ether a6:a9:f7:cd:58:06 brd ff:ff:ff:ff:ff:ff 可以看到 ifb0 网卡的状态为：state UNKNOWN tc qdisc add dev eth0 ingress 执行命令： tc qdisc add dev eth0 ingress 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 qdisc ingress ffff: parent ffff:fff1 ---------------- 可以看到 多了：qdisc ingress ffff: parent ffff:fff1 —————- tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 执行命令： tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 验证，执行命令： tc filter list dev eth0 parent ffff:fff1 显示内容： filter parent ffff: protocol ip pref 49152 u32 filter parent ffff: protocol ip pref 49152 u32 fh 800: ht divisor 1 filter parent ffff: protocol ip pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:1 match 00000000/00000000 at 0 action order 1: mirred (Egress Redirect to device ifb0) stolen index 4 ref 1 bind 1 可以看到 Egress Redirect to device ifb0 ，通过 eth0 的过滤器规则 parent ffff:fff1，把数据重定向到 device ifb0 tc qdisc add dev ifb0 root netem delay 750ms 执行命令： tc qdisc add dev ifb0 root netem delay 750ms 验证，执行命令： tc qdisc show dev ifb0 显示内容： qdisc netem 800d: root refcnt 2 limit 1000 delay 750.0ms 再在本地 ping 下测试 Linux 机看看： 可以看出，命令生效啦！ 试下输出方向是否正常 执行命令： tc qdisc add dev eth0 root netem delay 750ms 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc netem 800e: root refcnt 2 limit 1000 delay 750.0ms qdisc ingress ffff: parent ffff:fff1 ---------------- 再在本地 ping 下测试 Linux 机看看： 可以看到 输入方向、输出方向都生效了。 恢复正常 tc qdisc del dev ifb0 root netem 执行命令： tc qdisc del dev ifb0 root netem 验证，执行命令： tc qdisc show dev ifb0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 tc qdisc del dev eth0 root netem 执行命令： tc qdisc del dev eth0 root netem 验证，执行命令： tc qdisc show dev eth0 显示内容： qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap 1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1 qdisc ingress ffff: parent ffff:fff1 ---------------- tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32 若不知道过滤器名称： tc filter list dev eth0 parent ffff:fff1 显示内容： filter parent ffff: protocol ip pref 49152 u32 filter parent ffff: protocol ip pref 49152 u32 fh 800: ht divisor 1 filter parent ffff: protocol ip pref 49152 u32 fh 800::800 order 2048 key ht 800 bkt 0 flowid 1:1 match 00000000/00000000 at 0 action order 1: mirred (Egress Redirect to device ifb0) stolen index 4 ref 1 bind 1 然后执行： tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32 就可以删掉过滤器啦。 tc qdisc del dev eth0 ingress 最后执行： tc qdisc del dev eth0 ingress 以上 结束语 本章主要根据 https://wiki.linuxfoundation.org/networking/netem 中，关于输入方向的例子介绍。 实际操作练习了一遍。 下一章，继续根据 https://wiki.linuxfoundation.org/networking/netem 中的介绍，练习体验下，netem 的模拟网络的 6 个方面： Delay distribution （延迟分发） Packet loss （丢包） Packet duplication （数据包重复） Packet corruption （数据包损坏） Packet re-ordering （数据包乱序） Rate control （速率控制，或称之为带宽） 并在最后给出一些弱网模拟的5个方面的值设置。Rate control 可以不考虑！ 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/08/04/3e6dde998c73a934be898e1073080bde.html","headline":"TC 输入方向的弱网模拟 ( 一 )","dateModified":"2018-08-04T00:00:00+08:00","datePublished":"2018-08-04T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/08/04/3e6dde998c73a934be898e1073080bde.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>TC 输入方向的弱网模拟 ( 一 )</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h2 id="参考文档">参考文档</h2> 
  <ol> 
   <li><p><a href="https://wiki.linuxfoundation.org/networking/netem" rel="nofollow">https://wiki.linuxfoundation.org/networking/netem</a></p> 
    <blockquote> 
     <p>How can I use netem on incoming traffic? <br> You need to use the Intermediate Functional Block pseudo-device IFB . This network device allows attaching queuing discplines to incoming packets.</p> 
     <p>&nbsp;&nbsp;&nbsp;&nbsp;# modprobe ifb <br> &nbsp;&nbsp;&nbsp;&nbsp;# ip link set dev ifb0 up <br> &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev eth0 ingress <br> &nbsp;&nbsp;&nbsp;&nbsp;# tc filter add dev eth0 parent ffff: \ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0 <br> &nbsp;&nbsp;&nbsp;&nbsp;# tc qdisc add dev ifb0 root netem delay 750ms <br> Another way is to use another machine as an Ethernet bridge , and apply netem to both Ethernet devices.</p> 
    </blockquote> <p>文中简单提到了，2种方法：</p> 
    <ol>
     <li>使用 ifb</li> 
     <li>使用 2 台机器 …</li>
    </ol></li> 
  </ol> 
  <h2 id="操作实践下">操作实践下</h2> 
  <p>按照上文中的提示，依次敲命令，体验下：</p> 
  <ol> 
   <li><p>modprobe ifb</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs ">modprobe ifb</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs lasso">ip <span class="hljs-keyword">link</span> <span class="hljs-built_in">list</span></code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class=" hljs vbnet"><span class="hljs-number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="hljs-number">65536</span> qdisc noqueue state UNKNOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1</span>
    link/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span>
    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">16</span>:<span class="hljs-number">3</span>e:<span class="hljs-number">00</span>:<span class="hljs-number">29</span>:<span class="hljs-number">30</span> brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">3</span>: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:b1:cd:f3:<span class="hljs-number">26</span> brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">4</span>: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:b5:<span class="hljs-number">6</span>d:<span class="hljs-number">27</span>:f0 brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">6</span>: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue master docker0 state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">7</span>e:f2:<span class="hljs-number">81</span>:b2:<span class="hljs-number">06</span>:<span class="hljs-number">58</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="hljs-number">0</span>
<span class="hljs-number">12</span>: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue master docker_gwbridge state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">5</span>a:<span class="hljs-number">60</span>:<span class="hljs-number">84</span>:<span class="hljs-number">59</span>:<span class="hljs-number">3</span>e:<span class="hljs-number">90</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="hljs-number">2</span>
<span class="hljs-number">13</span>: flannel<span class="hljs-number">.1</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1450</span> qdisc noqueue state UNKNOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether be:<span class="hljs-number">69</span>:e0:c3:<span class="hljs-number">61</span>:e6 brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">14</span>: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state DOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span>
    link/ether <span class="hljs-number">0</span>a:<span class="hljs-number">58</span>:<span class="hljs-number">0</span>a:f4:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">405</span>: ifb0: &lt;BROADCAST,NOARP&gt; mtu <span class="hljs-number">1500</span> qdisc noop state DOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">32</span>
    link/ether <span class="hljs-number">2</span>e:<span class="hljs-number">21</span>:ac:<span class="hljs-number">75</span>:<span class="hljs-number">30</span>:<span class="hljs-number">3</span>f brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">406</span>: ifb1: &lt;BROADCAST,NOARP&gt; mtu <span class="hljs-number">1500</span> qdisc noop state DOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">32</span>
    link/ether a6:a9:f7:cd:<span class="hljs-number">58</span>:<span class="hljs-number">06</span> brd ff:ff:ff:ff:ff:ff</code></pre> <p>可以看到新增2块网卡： ifb0、ifb1</p> <p>它们的状态为：state DOWN</p></li> 
   <li><p>ip link set dev ifb0 up</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs lasso">ip <span class="hljs-keyword">link</span> <span class="hljs-built_in">set</span> dev ifb0 up</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs lasso">ip <span class="hljs-keyword">link</span> <span class="hljs-built_in">list</span></code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs vbnet"><span class="hljs-number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="hljs-number">65536</span> qdisc noqueue state UNKNOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1</span>
    link/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>
<span class="hljs-number">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span>
    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">16</span>:<span class="hljs-number">3</span>e:<span class="hljs-number">00</span>:<span class="hljs-number">29</span>:<span class="hljs-number">30</span> brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">3</span>: docker_gwbridge: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:b1:cd:f3:<span class="hljs-number">26</span> brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">4</span>: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:b5:<span class="hljs-number">6</span>d:<span class="hljs-number">27</span>:f0 brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">6</span>: veth250924d@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue master docker0 state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">7</span>e:f2:<span class="hljs-number">81</span>:b2:<span class="hljs-number">06</span>:<span class="hljs-number">58</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="hljs-number">0</span>
<span class="hljs-number">12</span>: vethd86893f@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue master docker_gwbridge state UP mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether <span class="hljs-number">5</span>a:<span class="hljs-number">60</span>:<span class="hljs-number">84</span>:<span class="hljs-number">59</span>:<span class="hljs-number">3</span>e:<span class="hljs-number">90</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="hljs-number">2</span>
<span class="hljs-number">13</span>: flannel<span class="hljs-number">.1</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1450</span> qdisc noqueue state UNKNOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span>
    link/ether be:<span class="hljs-number">69</span>:e0:c3:<span class="hljs-number">61</span>:e6 brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">14</span>: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state DOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span>
    link/ether <span class="hljs-number">0</span>a:<span class="hljs-number">58</span>:<span class="hljs-number">0</span>a:f4:<span class="hljs-number">00</span>:<span class="hljs-number">01</span> brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">405</span>: ifb0: &lt;BROADCAST,NOARP,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UNKNOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">32</span>
    link/ether <span class="hljs-number">2</span>e:<span class="hljs-number">21</span>:ac:<span class="hljs-number">75</span>:<span class="hljs-number">30</span>:<span class="hljs-number">3</span>f brd ff:ff:ff:ff:ff:ff
<span class="hljs-number">406</span>: ifb1: &lt;BROADCAST,NOARP&gt; mtu <span class="hljs-number">1500</span> qdisc noop state DOWN mode <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">32</span>
    link/ether a6:a9:f7:cd:<span class="hljs-number">58</span>:<span class="hljs-number">06</span> brd ff:ff:ff:ff:ff:ff</code></pre> <p>可以看到 ifb0 网卡的状态为：state UNKNOWN</p></li> 
   <li><p>tc qdisc add dev eth0 ingress</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs livecodeserver">tc qdisc <span class="hljs-built_in">add</span> dev eth0 ingress</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs sql">tc qdisc <span class="hljs-operator"><span class="hljs-keyword">show</span> dev eth0</span></code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs brainfuck"><span class="hljs-comment">qdisc</span> <span class="hljs-comment">pfifo_fast</span> <span class="hljs-comment">0:</span> <span class="hljs-comment">root</span> <span class="hljs-comment">refcnt</span> <span class="hljs-comment">2</span> <span class="hljs-comment">bands</span> <span class="hljs-comment">3</span> <span class="hljs-comment">priomap</span>  <span class="hljs-comment">1</span> <span class="hljs-comment">2</span> <span class="hljs-comment">2</span> <span class="hljs-comment">2</span> <span class="hljs-comment">1</span> <span class="hljs-comment">2</span> <span class="hljs-comment">0</span> <span class="hljs-comment">0</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span>
<span class="hljs-comment">qdisc</span> <span class="hljs-comment">ingress</span> <span class="hljs-comment">ffff:</span> <span class="hljs-comment">parent</span> <span class="hljs-comment">ffff:fff1</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span></code></pre> <p>可以看到 多了：qdisc ingress ffff: parent ffff:fff1 —————-</p></li> 
   <li><p>tc filter add dev eth0 parent ffff: protocol ip u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs rust">tc filter add dev eth0 parent ffff: protocol ip <span class="hljs-keyword">u32</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">u32</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> flowid <span class="hljs-number">1</span>:<span class="hljs-number">1</span> action mirred egress redirect dev ifb0</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs php">tc filter <span class="hljs-keyword">list</span> dev eth0 <span class="hljs-keyword">parent</span> ffff:fff1</code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs mel"><span class="hljs-keyword">filter</span> <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32
<span class="hljs-keyword">filter</span> <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32 fh <span class="hljs-number">800</span>: ht divisor <span class="hljs-number">1</span>
<span class="hljs-keyword">filter</span> <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32 fh <span class="hljs-number">800</span>::<span class="hljs-number">800</span> order <span class="hljs-number">2048</span> key ht <span class="hljs-number">800</span> bkt <span class="hljs-number">0</span> flowid <span class="hljs-number">1</span>:<span class="hljs-number">1</span>
<span class="hljs-keyword">match</span> <span class="hljs-number">00000000</span>/<span class="hljs-number">00000000</span> at <span class="hljs-number">0</span>
    action order <span class="hljs-number">1</span>: mirred (Egress Redirect to device ifb0) stolen
    index <span class="hljs-number">4</span> ref <span class="hljs-number">1</span> bind <span class="hljs-number">1</span></code></pre> <p>可以看到 Egress Redirect to device ifb0 ，通过 eth0 的过滤器规则 parent ffff:fff1，把数据重定向到 device ifb0</p></li> 
   <li><p>tc qdisc add dev ifb0 root netem delay 750ms</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs livecodeserver">tc qdisc <span class="hljs-built_in">add</span> dev ifb0 root netem delay <span class="hljs-number">750</span>ms</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs sql">tc qdisc <span class="hljs-operator"><span class="hljs-keyword">show</span> dev ifb0</span></code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs applescript">qdisc netem <span class="hljs-number">800</span>d: root refcnt <span class="hljs-number">2</span> limit <span class="hljs-number">1000</span> <span class="hljs-command">delay</span> <span class="hljs-number">750.0</span>ms</code></pre> <p>再在本地 ping 下测试 Linux 机看看：</p> <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180804161237404?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMyNzIwMDk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> <p>可以看出，命令生效啦！</p></li> 
  </ol> 
  <h2 id="试下输出方向是否正常">试下输出方向是否正常</h2> 
  <p>执行命令：</p> 
  <pre class="prettyprint"><code class="language-shell hljs livecodeserver">tc qdisc <span class="hljs-built_in">add</span> dev eth0 root netem delay <span class="hljs-number">750</span>ms</code></pre> 
  <p>验证，执行命令：</p> 
  <pre class="prettyprint"><code class="language-shell hljs sql">tc qdisc <span class="hljs-operator"><span class="hljs-keyword">show</span> dev eth0</span></code></pre> 
  <p>显示内容：</p> 
  <pre class="prettyprint"><code class="language-shell hljs applescript">qdisc netem <span class="hljs-number">800</span>e: root refcnt <span class="hljs-number">2</span> limit <span class="hljs-number">1000</span> <span class="hljs-command">delay</span> <span class="hljs-number">750.0</span>ms
qdisc ingress ffff: parent ffff:fff1 <span class="hljs-comment">----------------</span></code></pre> 
  <p>再在本地 ping 下测试 Linux 机看看：</p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180804161747838?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMyNzIwMDk=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <p>可以看到 输入方向、输出方向都生效了。</p> 
  <h2 id="恢复正常">恢复正常</h2> 
  <ol> 
   <li><p>tc qdisc del dev ifb0 root netem</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs python">tc qdisc <span class="hljs-keyword">del</span> dev ifb0 root netem</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs sql">tc qdisc <span class="hljs-operator"><span class="hljs-keyword">show</span> dev ifb0</span></code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs ">qdisc pfifo_fast 0: root refcnt 2 bands 3 priomap  1 2 2 2 1 2 0 0 1 1 1 1 1 1 1 1</code></pre></li> 
   <li><p>tc qdisc del dev eth0 root netem</p> <p>执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs python">tc qdisc <span class="hljs-keyword">del</span> dev eth0 root netem</code></pre> <p>验证，执行命令：</p> <pre class="prettyprint"><code class="language-shell hljs sql">tc qdisc <span class="hljs-operator"><span class="hljs-keyword">show</span> dev eth0 </span></code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs brainfuck"><span class="hljs-comment">qdisc</span> <span class="hljs-comment">pfifo_fast</span> <span class="hljs-comment">0:</span> <span class="hljs-comment">root</span> <span class="hljs-comment">refcnt</span> <span class="hljs-comment">2</span> <span class="hljs-comment">bands</span> <span class="hljs-comment">3</span> <span class="hljs-comment">priomap</span>  <span class="hljs-comment">1</span> <span class="hljs-comment">2</span> <span class="hljs-comment">2</span> <span class="hljs-comment">2</span> <span class="hljs-comment">1</span> <span class="hljs-comment">2</span> <span class="hljs-comment">0</span> <span class="hljs-comment">0</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span> <span class="hljs-comment">1</span>
<span class="hljs-comment">qdisc</span> <span class="hljs-comment">ingress</span> <span class="hljs-comment">ffff:</span> <span class="hljs-comment">parent</span> <span class="hljs-comment">ffff:fff1</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span></code></pre></li> 
   <li><p>tc filter del dev eth0 parent ffff: protocol ip pref 49152 u32</p> <p>若不知道过滤器名称：</p> <pre class="prettyprint"><code class="language-shell hljs php">tc filter <span class="hljs-keyword">list</span> dev eth0 <span class="hljs-keyword">parent</span> ffff:fff1</code></pre> <p>显示内容：</p> <pre class="prettyprint"><code class="language-shell hljs mel"><span class="hljs-keyword">filter</span> <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32
<span class="hljs-keyword">filter</span> <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32 fh <span class="hljs-number">800</span>: ht divisor <span class="hljs-number">1</span>
<span class="hljs-keyword">filter</span> <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32 fh <span class="hljs-number">800</span>::<span class="hljs-number">800</span> order <span class="hljs-number">2048</span> key ht <span class="hljs-number">800</span> bkt <span class="hljs-number">0</span> flowid <span class="hljs-number">1</span>:<span class="hljs-number">1</span>
<span class="hljs-keyword">match</span> <span class="hljs-number">00000000</span>/<span class="hljs-number">00000000</span> at <span class="hljs-number">0</span>
    action order <span class="hljs-number">1</span>: mirred (Egress Redirect to device ifb0) stolen
    index <span class="hljs-number">4</span> ref <span class="hljs-number">1</span> bind <span class="hljs-number">1</span></code></pre> <p>然后执行：</p> <pre class="prettyprint"><code class="language-shell hljs mel">tc <span class="hljs-keyword">filter</span> del dev eth0 <span class="hljs-keyword">parent</span> ffff: protocol ip pref <span class="hljs-number">49152</span> u32</code></pre> <p>就可以删掉过滤器啦。</p></li> 
   <li><p>tc qdisc del dev eth0 ingress</p> <p>最后执行：</p> <pre class="prettyprint"><code class="language-shell hljs python">tc qdisc <span class="hljs-keyword">del</span> dev eth0 ingress</code></pre></li> 
  </ol> 
  <p>以上</p> 
  <h2 id="结束语">结束语</h2> 
  <p>本章主要根据 <a href="https://wiki.linuxfoundation.org/networking/netem" rel="nofollow">https://wiki.linuxfoundation.org/networking/netem</a> 中，关于输入方向的例子介绍。</p> 
  <p>实际操作练习了一遍。</p> 
  <p>下一章，继续根据 <a href="https://wiki.linuxfoundation.org/networking/netem" rel="nofollow">https://wiki.linuxfoundation.org/networking/netem</a> 中的介绍，练习体验下，netem 的模拟网络的 6 个方面：</p> 
  <ul> 
   <li>Delay distribution （延迟分发）</li> 
   <li>Packet loss （丢包）</li> 
   <li>Packet duplication （数据包重复）</li> 
   <li>Packet corruption （数据包损坏）</li> 
   <li>Packet re-ordering （数据包乱序）</li> 
   <li>Rate control （速率控制，或称之为带宽）</li> 
  </ul> 
  <p>并在最后给出一些弱网模拟的5个方面的值设置。Rate control 可以不考虑！</p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/u013272009/article/details/81412517,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/u013272009/article/details/81412517,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
