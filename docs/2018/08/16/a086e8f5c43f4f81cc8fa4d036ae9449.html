<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Hyperledger Fabric 替换合买大厅搭建开发couchDB | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Hyperledger Fabric 替换合买大厅搭建开发couchDB" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="fabric合买大厅搭建开发 dsluntan.com Q:3393756370 VX:17061863513中默认数据存储的方式是levelDB，一个key/value存储的单机数据库。除此之外还提供了另外一种存储方式：couchDB。同样也是一个K/V 数据库，对fabric而言，相比于前者，后者提供更加丰富的查询功能。 而默认的levelDB切换到couchDb也很简单。即所谓的快速拔插。 区块链是文件系统，这个目前不支持更改，历史数据和区块链的索引是LevelDB，这个也不能更改。而对于State Database，由于和业务相关，所以提供了替换数据库，目前支持默认的LevelDB和用户可选择的CouchDB。这里要说到2点，一个是在0.6的时候其实用的RockDB，但是由于License的考虑，所以在1.0改成了LevelDB。另外就是CouchDB也不一定是最优的，很多人还考虑到MongoDB或者MySQL等，但是由于现在Fabric那边开发资源有限，所以在1.0还不会做，以后可能会实现。 1.安装couchDB 正常来讲，我们会为每一个peer节点提供一个couchDB作为数据存储。 执行： docker pull klaemo/couchdb 下载镜像创建完成后 创建一个文件夹： mkdir couchDb 这个文件夹是用来存储数据的，因为couchDB每次启动时候都需要指定数据存储位置。 实例化一个couchDB实例： docker run -p 5984:5984 -d –name my-couchdb -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb:/opt/couchdb/data klaemo/couchdb这是启动一个名字为 my-couchdb，账号为admin，密码为 password的 couchDb实例 本地的5984端口映射到容器的5984端口。接下来访问界面化操作页面： http://IP:5984/_utils显示如下界面： 先不用管里面的数据，因为我这个是后面操作的数据。正常到这一步应该是没有数据。 因为我们正常的fabric网络是默认启动4个peer节点，所以需要启动四个couchDb实例。 创建用来对应剩下的三个peer节点的数据库存储文件夹。 mkdir couchdb2 mkdir couchdb3 mkdir couchdb4 docker run -p 6984:5984 -d –name my-couchdb2 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb1:/opt/couchdb/data klaemo/couchdb docker run -p 7984:5984 -d –name my-couchdb3 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb2:/opt/couchdb/data klaemo/couchdb docker run -p 8984:5984 -d –name my-couchdb4 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb3:/opt/couchdb/data klaemo/couchdb 2.关联 peer节点和couchDb 到这一步fabric的网络是还没有启动的，上一篇文章启动的e2e-cli的网络。peer节点的相关配置在/root/go/src/github.com/hyperledger/fabric/examples/e2e_cli/下的docker-compose-cli.yaml vi docker-compose-cli.yaml 编辑四个节点，红色部分为新增： peer0.org1.example.com: container_name: peer0.org1.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:5984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org1.example.com peer1.org1.example.com: container_name: peer1.org1.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:6984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org1.example.com peer0.org2.example.com: container_name: peer0.org2.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:7984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org2.example.com peer1.org2.example.com:合买大厅搭建开发 dsluntan.com Q:3393756370 VX:17061863513 container_name: peer1.org2.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:8984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org2.example.com 保存以后启动fabric网络 ./network_setup.sh up 这个时候再查看就会发现多出来的数据。 http://IP:5984/_utils可以看到以Channel名字创建的Database，另外还有几个是系统数据库。点进去可以查看存储在当前节点的区块数据。——————-以下内容转自深蓝大神的博文—————————–https://www.cnblogs.com/studyzy/p/7101136.html CouchDB的直接查询 接下来我们使用Linux的curl来查询CouchDB数据库。 比如我们要看看mychannel数据库下有哪些数据： curl http://192.168.100.129:5984/mychannel/_all_docs 可以看到我运行了一些ChainCode后的State DATABASE结果： {“total_rows”:7,”offset”:0,”rows”:[ {“id”:”devincc\u0000a”,”key”:”devincc\u0000a”,”value”:{“rev”:”2-a979bf6c2716ecae6d106999f833a59c”}}, {“id”:”devincc\u0000b”,”key”:”devincc\u0000b”,”value”:{“rev”:”2-ad1c549305fd277097180405f96bdcd8”}}, {“id”:”lscc\u0000devincc”,”key”:”lscc\u0000devincc”,”value”:{“rev”:”1-05d2cd0b344c4dd8a8d1a3ffd7332544”}}, {“id”:”lscc\u0000mycc”,”key”:”lscc\u0000mycc”,”value”:{“rev”:”1-2cba0344b1610b9d9254bbafbda5e9b1”}}, {“id”:”mycc\u0000a”,”key”:”mycc\u0000a”,”value”:{“rev”:”2-588a45b289359afa9dc6e5e7866eaf97”}}, {“id”:”mycc\u0000b”,”key”:”mycc\u0000b”,”value”:{“rev”:”2-54e6639a858b0f91298c9a354484513a”}}, {“id”:”statedb_savepoint”,”key”:”statedb_savepoint”,”value”:{“rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”}} ]} 如果我们要查询其中的一条数据，只需要用/ChannelId/id来查询，比如查询：statedb_savepoint curl http://192.168.100.129:5984/mychannel/statedb_savepoint 返回的结果： {“_id”:”statedb_savepoint”,”_rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”,”BlockNum”:4,”TxNum”:0,”UpdateSeq”:”19-g1AAAAEzeJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuRAYeCJAUgmWQPVsOCS40DSE08WA0jLjUJIDX1eO3KYwGSDA1ACqhsPiF1CyDq9mclsuJVdwCi7j4h8x5A1AHdx5kFAI6sYwk”} 麻烦的是业务数据是“ChainCodeName\u0000数据”这样的格式的ID，而如果我们要通过这个ID查询，那么就根本找不到啊！ curl http://192.168.100.129:5984/mychannel/mycc\u0000a {“error”:”not_found”,”reason”:”missing”} 正确的做法是把\u0000替换为%00，也就是说我们的查询应该是： curl http://192.168.100.129:5984/mychannel/mycc%00a 正确返回结果： {“_id”:”mycc\u0000a”,”_rev”:”2-588a45b289359afa9dc6e5e7866eaf97”,”chaincodeid”:”mycc”,”version”:”4:0”,”_attachments”:{“valueBytes”:{“content_type”:”application/octet-stream”,”revpos”:2,”digest”:”md5-hhOYXsSeuPdXrmQ56Hm7Kg==”,”length”:2,”stub”:true}}} Fabric可能会遇到的问题 虽然区块链是一个只能插入和查询的数据库，但是我们的业务数据是存放在State Database中的，如果我们直接修改了CouchDB的数据，那么接下来的查询和事务是直接基于修改后的CouchDB的，并不会去检查区块链中的记录，所以理论上是可以通过直接改CouchDB来实现业务数据的修改。 我们以官方的Marble为例，看看修改CouchDB会怎么样？ 具体操作步骤如下： 1.Install，instantiate和初始化数据： peer chaincode install -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 peer chaincode instantiate -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 -c ‘{“Args”:[“init”]}’ -P “OR (‘Org1MSP.member’,’Org2MSP.member’)” peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“initMarble”,”marble2”,”red”,”50”,”tom”]}’ peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 我们可以看到通过curl直接查询CouchDB中的数据： curl http://192.168.100.129:5984/mychannel/marbles02%00marble2 {“_id”:”marbles02\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”red”,”size”:50,”owner”:”tom”},”version”:”6:0”} 如果我们要修改其中的数据，把颜色改成green，大小改成10，那么我们可以运行： curl -X PUT http://192.168.100.129:5984/mychannel/marbles02%00marble2 -d ‘{“_id”:”marbles02\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”green”,”size”:10,”owner”:”tom”},”version”:”6:0”}’ 系统返回结果： {“ok”:true,”id”:”marbles02\u0000marble2”,”rev”:”2-6ffc6652cfc707f8352a5f06c3ce1ce6”} 我们在4个CouchDB中都运行这个命令，把4个数据库的数据都改了。 接下来我们通过ChainCode来查询，看看会怎么样。 peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 返回结果： Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”tom”,”size”:10} 可以看到数据已经变成新的值，那么接下来运行其他的Transaction会怎么样？我们试一试转账操作： peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“transferMarble”,”marble2”,”jerry”]}’ 系统返回成功，我们再查一下呢 peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”jerry”,”size”:10} 所以我们对CouchDB数据库的更改都是有效的，在Fabric看来似乎并不知道我们改了CouchDB的内容。 阅读更多" />
<meta property="og:description" content="fabric合买大厅搭建开发 dsluntan.com Q:3393756370 VX:17061863513中默认数据存储的方式是levelDB，一个key/value存储的单机数据库。除此之外还提供了另外一种存储方式：couchDB。同样也是一个K/V 数据库，对fabric而言，相比于前者，后者提供更加丰富的查询功能。 而默认的levelDB切换到couchDb也很简单。即所谓的快速拔插。 区块链是文件系统，这个目前不支持更改，历史数据和区块链的索引是LevelDB，这个也不能更改。而对于State Database，由于和业务相关，所以提供了替换数据库，目前支持默认的LevelDB和用户可选择的CouchDB。这里要说到2点，一个是在0.6的时候其实用的RockDB，但是由于License的考虑，所以在1.0改成了LevelDB。另外就是CouchDB也不一定是最优的，很多人还考虑到MongoDB或者MySQL等，但是由于现在Fabric那边开发资源有限，所以在1.0还不会做，以后可能会实现。 1.安装couchDB 正常来讲，我们会为每一个peer节点提供一个couchDB作为数据存储。 执行： docker pull klaemo/couchdb 下载镜像创建完成后 创建一个文件夹： mkdir couchDb 这个文件夹是用来存储数据的，因为couchDB每次启动时候都需要指定数据存储位置。 实例化一个couchDB实例： docker run -p 5984:5984 -d –name my-couchdb -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb:/opt/couchdb/data klaemo/couchdb这是启动一个名字为 my-couchdb，账号为admin，密码为 password的 couchDb实例 本地的5984端口映射到容器的5984端口。接下来访问界面化操作页面： http://IP:5984/_utils显示如下界面： 先不用管里面的数据，因为我这个是后面操作的数据。正常到这一步应该是没有数据。 因为我们正常的fabric网络是默认启动4个peer节点，所以需要启动四个couchDb实例。 创建用来对应剩下的三个peer节点的数据库存储文件夹。 mkdir couchdb2 mkdir couchdb3 mkdir couchdb4 docker run -p 6984:5984 -d –name my-couchdb2 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb1:/opt/couchdb/data klaemo/couchdb docker run -p 7984:5984 -d –name my-couchdb3 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb2:/opt/couchdb/data klaemo/couchdb docker run -p 8984:5984 -d –name my-couchdb4 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb3:/opt/couchdb/data klaemo/couchdb 2.关联 peer节点和couchDb 到这一步fabric的网络是还没有启动的，上一篇文章启动的e2e-cli的网络。peer节点的相关配置在/root/go/src/github.com/hyperledger/fabric/examples/e2e_cli/下的docker-compose-cli.yaml vi docker-compose-cli.yaml 编辑四个节点，红色部分为新增： peer0.org1.example.com: container_name: peer0.org1.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:5984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org1.example.com peer1.org1.example.com: container_name: peer1.org1.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:6984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org1.example.com peer0.org2.example.com: container_name: peer0.org2.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:7984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org2.example.com peer1.org2.example.com:合买大厅搭建开发 dsluntan.com Q:3393756370 VX:17061863513 container_name: peer1.org2.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:8984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org2.example.com 保存以后启动fabric网络 ./network_setup.sh up 这个时候再查看就会发现多出来的数据。 http://IP:5984/_utils可以看到以Channel名字创建的Database，另外还有几个是系统数据库。点进去可以查看存储在当前节点的区块数据。——————-以下内容转自深蓝大神的博文—————————–https://www.cnblogs.com/studyzy/p/7101136.html CouchDB的直接查询 接下来我们使用Linux的curl来查询CouchDB数据库。 比如我们要看看mychannel数据库下有哪些数据： curl http://192.168.100.129:5984/mychannel/_all_docs 可以看到我运行了一些ChainCode后的State DATABASE结果： {“total_rows”:7,”offset”:0,”rows”:[ {“id”:”devincc\u0000a”,”key”:”devincc\u0000a”,”value”:{“rev”:”2-a979bf6c2716ecae6d106999f833a59c”}}, {“id”:”devincc\u0000b”,”key”:”devincc\u0000b”,”value”:{“rev”:”2-ad1c549305fd277097180405f96bdcd8”}}, {“id”:”lscc\u0000devincc”,”key”:”lscc\u0000devincc”,”value”:{“rev”:”1-05d2cd0b344c4dd8a8d1a3ffd7332544”}}, {“id”:”lscc\u0000mycc”,”key”:”lscc\u0000mycc”,”value”:{“rev”:”1-2cba0344b1610b9d9254bbafbda5e9b1”}}, {“id”:”mycc\u0000a”,”key”:”mycc\u0000a”,”value”:{“rev”:”2-588a45b289359afa9dc6e5e7866eaf97”}}, {“id”:”mycc\u0000b”,”key”:”mycc\u0000b”,”value”:{“rev”:”2-54e6639a858b0f91298c9a354484513a”}}, {“id”:”statedb_savepoint”,”key”:”statedb_savepoint”,”value”:{“rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”}} ]} 如果我们要查询其中的一条数据，只需要用/ChannelId/id来查询，比如查询：statedb_savepoint curl http://192.168.100.129:5984/mychannel/statedb_savepoint 返回的结果： {“_id”:”statedb_savepoint”,”_rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”,”BlockNum”:4,”TxNum”:0,”UpdateSeq”:”19-g1AAAAEzeJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuRAYeCJAUgmWQPVsOCS40DSE08WA0jLjUJIDX1eO3KYwGSDA1ACqhsPiF1CyDq9mclsuJVdwCi7j4h8x5A1AHdx5kFAI6sYwk”} 麻烦的是业务数据是“ChainCodeName\u0000数据”这样的格式的ID，而如果我们要通过这个ID查询，那么就根本找不到啊！ curl http://192.168.100.129:5984/mychannel/mycc\u0000a {“error”:”not_found”,”reason”:”missing”} 正确的做法是把\u0000替换为%00，也就是说我们的查询应该是： curl http://192.168.100.129:5984/mychannel/mycc%00a 正确返回结果： {“_id”:”mycc\u0000a”,”_rev”:”2-588a45b289359afa9dc6e5e7866eaf97”,”chaincodeid”:”mycc”,”version”:”4:0”,”_attachments”:{“valueBytes”:{“content_type”:”application/octet-stream”,”revpos”:2,”digest”:”md5-hhOYXsSeuPdXrmQ56Hm7Kg==”,”length”:2,”stub”:true}}} Fabric可能会遇到的问题 虽然区块链是一个只能插入和查询的数据库，但是我们的业务数据是存放在State Database中的，如果我们直接修改了CouchDB的数据，那么接下来的查询和事务是直接基于修改后的CouchDB的，并不会去检查区块链中的记录，所以理论上是可以通过直接改CouchDB来实现业务数据的修改。 我们以官方的Marble为例，看看修改CouchDB会怎么样？ 具体操作步骤如下： 1.Install，instantiate和初始化数据： peer chaincode install -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 peer chaincode instantiate -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 -c ‘{“Args”:[“init”]}’ -P “OR (‘Org1MSP.member’,’Org2MSP.member’)” peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“initMarble”,”marble2”,”red”,”50”,”tom”]}’ peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 我们可以看到通过curl直接查询CouchDB中的数据： curl http://192.168.100.129:5984/mychannel/marbles02%00marble2 {“_id”:”marbles02\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”red”,”size”:50,”owner”:”tom”},”version”:”6:0”} 如果我们要修改其中的数据，把颜色改成green，大小改成10，那么我们可以运行： curl -X PUT http://192.168.100.129:5984/mychannel/marbles02%00marble2 -d ‘{“_id”:”marbles02\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”green”,”size”:10,”owner”:”tom”},”version”:”6:0”}’ 系统返回结果： {“ok”:true,”id”:”marbles02\u0000marble2”,”rev”:”2-6ffc6652cfc707f8352a5f06c3ce1ce6”} 我们在4个CouchDB中都运行这个命令，把4个数据库的数据都改了。 接下来我们通过ChainCode来查询，看看会怎么样。 peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 返回结果： Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”tom”,”size”:10} 可以看到数据已经变成新的值，那么接下来运行其他的Transaction会怎么样？我们试一试转账操作： peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“transferMarble”,”marble2”,”jerry”]}’ 系统返回成功，我们再查一下呢 peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”jerry”,”size”:10} 所以我们对CouchDB数据库的更改都是有效的，在Fabric看来似乎并不知道我们改了CouchDB的内容。 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/08/16/a086e8f5c43f4f81cc8fa4d036ae9449.html" />
<meta property="og:url" content="https://mlh.app/2018/08/16/a086e8f5c43f4f81cc8fa4d036ae9449.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-16T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"fabric合买大厅搭建开发 dsluntan.com Q:3393756370 VX:17061863513中默认数据存储的方式是levelDB，一个key/value存储的单机数据库。除此之外还提供了另外一种存储方式：couchDB。同样也是一个K/V 数据库，对fabric而言，相比于前者，后者提供更加丰富的查询功能。 而默认的levelDB切换到couchDb也很简单。即所谓的快速拔插。 区块链是文件系统，这个目前不支持更改，历史数据和区块链的索引是LevelDB，这个也不能更改。而对于State Database，由于和业务相关，所以提供了替换数据库，目前支持默认的LevelDB和用户可选择的CouchDB。这里要说到2点，一个是在0.6的时候其实用的RockDB，但是由于License的考虑，所以在1.0改成了LevelDB。另外就是CouchDB也不一定是最优的，很多人还考虑到MongoDB或者MySQL等，但是由于现在Fabric那边开发资源有限，所以在1.0还不会做，以后可能会实现。 1.安装couchDB 正常来讲，我们会为每一个peer节点提供一个couchDB作为数据存储。 执行： docker pull klaemo/couchdb 下载镜像创建完成后 创建一个文件夹： mkdir couchDb 这个文件夹是用来存储数据的，因为couchDB每次启动时候都需要指定数据存储位置。 实例化一个couchDB实例： docker run -p 5984:5984 -d –name my-couchdb -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb:/opt/couchdb/data klaemo/couchdb这是启动一个名字为 my-couchdb，账号为admin，密码为 password的 couchDb实例 本地的5984端口映射到容器的5984端口。接下来访问界面化操作页面： http://IP:5984/_utils显示如下界面： 先不用管里面的数据，因为我这个是后面操作的数据。正常到这一步应该是没有数据。 因为我们正常的fabric网络是默认启动4个peer节点，所以需要启动四个couchDb实例。 创建用来对应剩下的三个peer节点的数据库存储文件夹。 mkdir couchdb2 mkdir couchdb3 mkdir couchdb4 docker run -p 6984:5984 -d –name my-couchdb2 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb1:/opt/couchdb/data klaemo/couchdb docker run -p 7984:5984 -d –name my-couchdb3 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb2:/opt/couchdb/data klaemo/couchdb docker run -p 8984:5984 -d –name my-couchdb4 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb3:/opt/couchdb/data klaemo/couchdb 2.关联 peer节点和couchDb 到这一步fabric的网络是还没有启动的，上一篇文章启动的e2e-cli的网络。peer节点的相关配置在/root/go/src/github.com/hyperledger/fabric/examples/e2e_cli/下的docker-compose-cli.yaml vi docker-compose-cli.yaml 编辑四个节点，红色部分为新增： peer0.org1.example.com: container_name: peer0.org1.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:5984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org1.example.com peer1.org1.example.com: container_name: peer1.org1.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:6984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org1.example.com peer0.org2.example.com: container_name: peer0.org2.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:7984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer0.org2.example.com peer1.org2.example.com:合买大厅搭建开发 dsluntan.com Q:3393756370 VX:17061863513 container_name: peer1.org2.example.com environment: - CORE_LEDGER_STATE_STATEDATABASE=CouchDB - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:8984 - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password extends: file: base/docker-compose-base.yaml service: peer1.org2.example.com 保存以后启动fabric网络 ./network_setup.sh up 这个时候再查看就会发现多出来的数据。 http://IP:5984/_utils可以看到以Channel名字创建的Database，另外还有几个是系统数据库。点进去可以查看存储在当前节点的区块数据。——————-以下内容转自深蓝大神的博文—————————–https://www.cnblogs.com/studyzy/p/7101136.html CouchDB的直接查询 接下来我们使用Linux的curl来查询CouchDB数据库。 比如我们要看看mychannel数据库下有哪些数据： curl http://192.168.100.129:5984/mychannel/_all_docs 可以看到我运行了一些ChainCode后的State DATABASE结果： {“total_rows”:7,”offset”:0,”rows”:[ {“id”:”devincc\\u0000a”,”key”:”devincc\\u0000a”,”value”:{“rev”:”2-a979bf6c2716ecae6d106999f833a59c”}}, {“id”:”devincc\\u0000b”,”key”:”devincc\\u0000b”,”value”:{“rev”:”2-ad1c549305fd277097180405f96bdcd8”}}, {“id”:”lscc\\u0000devincc”,”key”:”lscc\\u0000devincc”,”value”:{“rev”:”1-05d2cd0b344c4dd8a8d1a3ffd7332544”}}, {“id”:”lscc\\u0000mycc”,”key”:”lscc\\u0000mycc”,”value”:{“rev”:”1-2cba0344b1610b9d9254bbafbda5e9b1”}}, {“id”:”mycc\\u0000a”,”key”:”mycc\\u0000a”,”value”:{“rev”:”2-588a45b289359afa9dc6e5e7866eaf97”}}, {“id”:”mycc\\u0000b”,”key”:”mycc\\u0000b”,”value”:{“rev”:”2-54e6639a858b0f91298c9a354484513a”}}, {“id”:”statedb_savepoint”,”key”:”statedb_savepoint”,”value”:{“rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”}} ]} 如果我们要查询其中的一条数据，只需要用/ChannelId/id来查询，比如查询：statedb_savepoint curl http://192.168.100.129:5984/mychannel/statedb_savepoint 返回的结果： {“_id”:”statedb_savepoint”,”_rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”,”BlockNum”:4,”TxNum”:0,”UpdateSeq”:”19-g1AAAAEzeJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuRAYeCJAUgmWQPVsOCS40DSE08WA0jLjUJIDX1eO3KYwGSDA1ACqhsPiF1CyDq9mclsuJVdwCi7j4h8x5A1AHdx5kFAI6sYwk”} 麻烦的是业务数据是“ChainCodeName\\u0000数据”这样的格式的ID，而如果我们要通过这个ID查询，那么就根本找不到啊！ curl http://192.168.100.129:5984/mychannel/mycc\\u0000a {“error”:”not_found”,”reason”:”missing”} 正确的做法是把\\u0000替换为%00，也就是说我们的查询应该是： curl http://192.168.100.129:5984/mychannel/mycc%00a 正确返回结果： {“_id”:”mycc\\u0000a”,”_rev”:”2-588a45b289359afa9dc6e5e7866eaf97”,”chaincodeid”:”mycc”,”version”:”4:0”,”_attachments”:{“valueBytes”:{“content_type”:”application/octet-stream”,”revpos”:2,”digest”:”md5-hhOYXsSeuPdXrmQ56Hm7Kg==”,”length”:2,”stub”:true}}} Fabric可能会遇到的问题 虽然区块链是一个只能插入和查询的数据库，但是我们的业务数据是存放在State Database中的，如果我们直接修改了CouchDB的数据，那么接下来的查询和事务是直接基于修改后的CouchDB的，并不会去检查区块链中的记录，所以理论上是可以通过直接改CouchDB来实现业务数据的修改。 我们以官方的Marble为例，看看修改CouchDB会怎么样？ 具体操作步骤如下： 1.Install，instantiate和初始化数据： peer chaincode install -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 peer chaincode instantiate -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 -c ‘{“Args”:[“init”]}’ -P “OR (‘Org1MSP.member’,’Org2MSP.member’)” peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“initMarble”,”marble2”,”red”,”50”,”tom”]}’ peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 我们可以看到通过curl直接查询CouchDB中的数据： curl http://192.168.100.129:5984/mychannel/marbles02%00marble2 {“_id”:”marbles02\\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”red”,”size”:50,”owner”:”tom”},”version”:”6:0”} 如果我们要修改其中的数据，把颜色改成green，大小改成10，那么我们可以运行： curl -X PUT http://192.168.100.129:5984/mychannel/marbles02%00marble2 -d ‘{“_id”:”marbles02\\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”green”,”size”:10,”owner”:”tom”},”version”:”6:0”}’ 系统返回结果： {“ok”:true,”id”:”marbles02\\u0000marble2”,”rev”:”2-6ffc6652cfc707f8352a5f06c3ce1ce6”} 我们在4个CouchDB中都运行这个命令，把4个数据库的数据都改了。 接下来我们通过ChainCode来查询，看看会怎么样。 peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 返回结果： Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”tom”,”size”:10} 可以看到数据已经变成新的值，那么接下来运行其他的Transaction会怎么样？我们试一试转账操作： peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“transferMarble”,”marble2”,”jerry”]}’ 系统返回成功，我们再查一下呢 peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”jerry”,”size”:10} 所以我们对CouchDB数据库的更改都是有效的，在Fabric看来似乎并不知道我们改了CouchDB的内容。 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/08/16/a086e8f5c43f4f81cc8fa4d036ae9449.html","headline":"Hyperledger Fabric 替换合买大厅搭建开发couchDB","dateModified":"2018-08-16T00:00:00+08:00","datePublished":"2018-08-16T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/08/16/a086e8f5c43f4f81cc8fa4d036ae9449.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>Hyperledger Fabric 替换合买大厅搭建开发couchDB</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <p>fabric<a href="http://dsluntan.com/forum.php" rel="nofollow">合买大厅搭建开发</a> dsluntan.com Q:3393756370 VX:17061863513中默认数据存储的方式是levelDB，一个key/value存储的单机数据库。除此之外还提供了另外一种存储方式：couchDB。同样也是一个K/V 数据库，对fabric而言，相比于前者，后者提供更加丰富的查询功能。</p> 
  <p>而默认的levelDB切换到couchDb也很简单。即所谓的快速拔插。</p> 
  <p>区块链是文件系统，这个目前不支持更改，历史数据和区块链的索引是LevelDB，这个也不能更改。而对于State Database，由于和业务相关，所以提供了替换数据库，目前支持默认的LevelDB和用户可选择的CouchDB。这里要说到2点，一个是在0.6的时候其实用的RockDB，但是由于License的考虑，所以在1.0改成了LevelDB。另外就是CouchDB也不一定是最优的，很多人还考虑到MongoDB或者MySQL等，但是由于现在Fabric那边开发资源有限，所以在1.0还不会做，以后可能会实现。</p> 
  <p>1.安装couchDB</p> 
  <p>正常来讲，我们会为每一个peer节点提供一个couchDB作为数据存储。 <br> 执行： docker pull klaemo/couchdb 下载镜像创建完成后 创建一个文件夹： mkdir couchDb 这个文件夹是用来存储数据的，因为couchDB每次启动时候都需要指定数据存储位置。 实例化一个couchDB实例： docker run -p 5984:5984 -d –name my-couchdb -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb:/opt/couchdb/data klaemo/couchdb这是启动一个名字为 my-couchdb，账号为admin，密码为 password的 couchDb实例 本地的5984端口映射到容器的5984端口。接下来访问界面化操作页面： <a href="http://IP:5984/_utils" rel="nofollow">http://IP:5984/_utils</a>显示如下界面： </p> 
  <p>先不用管里面的数据，因为我这个是后面操作的数据。正常到这一步应该是没有数据。</p> 
  <p>因为我们正常的fabric网络是默认启动4个peer节点，所以需要启动四个couchDb实例。</p> 
  <p>创建用来对应剩下的三个peer节点的数据库存储文件夹。 <br> mkdir couchdb2 <br> mkdir couchdb3 <br> mkdir couchdb4 docker run -p 6984:5984 -d –name my-couchdb2 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb1:/opt/couchdb/data klaemo/couchdb docker run -p 7984:5984 -d –name my-couchdb3 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb2:/opt/couchdb/data klaemo/couchdb docker run -p 8984:5984 -d –name my-couchdb4 -e COUCHDB_USER=admin -e COUCHDB_PASSWORD=password -v ~/couchdb3:/opt/couchdb/data klaemo/couchdb <br> 2.关联 peer节点和couchDb</p> 
  <p>到这一步fabric的网络是还没有启动的，上一篇文章启动的e2e-cli的网络。peer节点的相关配置在/root/go/src/github.com/hyperledger/fabric/examples/e2e_cli/下的docker-compose-cli.yaml</p> 
  <p>vi docker-compose-cli.yaml</p> 
  <p>编辑四个节点，红色部分为新增：</p> 
  <p>peer0.org1.example.com: <br> container_name: peer0.org1.example.com <br> environment: <br> - CORE_LEDGER_STATE_STATEDATABASE=CouchDB <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:5984 <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password <br> extends: <br> file: base/docker-compose-base.yaml <br> service: peer0.org1.example.com</p> 
  <p>peer1.org1.example.com: <br> container_name: peer1.org1.example.com <br> environment: <br> - CORE_LEDGER_STATE_STATEDATABASE=CouchDB <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:6984 <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password <br> extends: <br> file: base/docker-compose-base.yaml <br> service: peer1.org1.example.com</p> 
  <p>peer0.org2.example.com: <br> container_name: peer0.org2.example.com <br> environment: <br> - CORE_LEDGER_STATE_STATEDATABASE=CouchDB <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:7984 <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password <br> extends: <br> file: base/docker-compose-base.yaml <br> service: peer0.org2.example.com</p> 
  <p>peer1.org2.example.com:<a href="http://dsluntan.com/forum.php" rel="nofollow">合买大厅搭建开发</a> dsluntan.com Q:3393756370 VX:17061863513 <br> container_name: peer1.org2.example.com <br> environment: <br> - CORE_LEDGER_STATE_STATEDATABASE=CouchDB <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=121.199.63.157:8984 <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME=admin <br> - CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD=password <br> extends: <br> file: base/docker-compose-base.yaml <br> service: peer1.org2.example.com</p> 
  <p>保存以后启动fabric网络 ./network_setup.sh up</p> 
  <p>这个时候再查看就会发现多出来的数据。 <br> <a href="http://IP:5984/_utils" rel="nofollow">http://IP:5984/_utils</a>可以看到以Channel名字创建的Database，另外还有几个是系统数据库。点进去可以查看存储在当前节点的区块数据。——————-以下内容转自深蓝大神的博文—————————–<a href="https://www.cnblogs.com/studyzy/p/7101136.html" rel="nofollow">https://www.cnblogs.com/studyzy/p/7101136.html</a> <br> CouchDB的直接查询 <br> 接下来我们使用Linux的curl来查询CouchDB数据库。 比如我们要看看mychannel数据库下有哪些数据： curl <a href="http://192.168.100.129:5984/mychannel/_all_docs" rel="nofollow">http://192.168.100.129:5984/mychannel/_all_docs</a> 可以看到我运行了一些ChainCode后的State DATABASE结果： <br> {“total_rows”:7,”offset”:0,”rows”:[ <br> {“id”:”devincc\u0000a”,”key”:”devincc\u0000a”,”value”:{“rev”:”2-a979bf6c2716ecae6d106999f833a59c”}}, <br> {“id”:”devincc\u0000b”,”key”:”devincc\u0000b”,”value”:{“rev”:”2-ad1c549305fd277097180405f96bdcd8”}}, <br> {“id”:”lscc\u0000devincc”,”key”:”lscc\u0000devincc”,”value”:{“rev”:”1-05d2cd0b344c4dd8a8d1a3ffd7332544”}}, <br> {“id”:”lscc\u0000mycc”,”key”:”lscc\u0000mycc”,”value”:{“rev”:”1-2cba0344b1610b9d9254bbafbda5e9b1”}}, <br> {“id”:”mycc\u0000a”,”key”:”mycc\u0000a”,”value”:{“rev”:”2-588a45b289359afa9dc6e5e7866eaf97”}}, <br> {“id”:”mycc\u0000b”,”key”:”mycc\u0000b”,”value”:{“rev”:”2-54e6639a858b0f91298c9a354484513a”}}, <br> {“id”:”statedb_savepoint”,”key”:”statedb_savepoint”,”value”:{“rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”}} <br> ]}</p> 
  <p>如果我们要查询其中的一条数据，只需要用/ChannelId/id来查询，比如查询：statedb_savepoint</p> 
  <p>curl <a href="http://192.168.100.129:5984/mychannel/statedb_savepoint" rel="nofollow">http://192.168.100.129:5984/mychannel/statedb_savepoint</a> <br> 返回的结果： <br> {“_id”:”statedb_savepoint”,”_rev”:”10-6ccde2a55c71d7d6a70d9333d119fc8e”,”BlockNum”:4,”TxNum”:0,”UpdateSeq”:”19-g1AAAAEzeJzLYWBg4MhgTmHgzcvPy09JdcjLz8gvLskBCjMlMiTJ____PyuRAYeCJAUgmWQPVsOCS40DSE08WA0jLjUJIDX1eO3KYwGSDA1ACqhsPiF1CyDq9mclsuJVdwCi7j4h8x5A1AHdx5kFAI6sYwk”} <br> 麻烦的是业务数据是“ChainCodeName\u0000数据”这样的格式的ID，而如果我们要通过这个ID查询，那么就根本找不到啊！ <br> curl <a href="http://192.168.100.129:5984/mychannel/mycc" rel="nofollow">http://192.168.100.129:5984/mychannel/mycc</a>\u0000a <br> {“error”:”not_found”,”reason”:”missing”}</p> 
  <p>正确的做法是把\u0000替换为%00，也就是说我们的查询应该是：</p> 
  <p>curl <a href="http://192.168.100.129:5984/mychannel/mycc%00a" rel="nofollow">http://192.168.100.129:5984/mychannel/mycc%00a</a> <br> 正确返回结果： <br> {“_id”:”mycc\u0000a”,”_rev”:”2-588a45b289359afa9dc6e5e7866eaf97”,”chaincodeid”:”mycc”,”version”:”4:0”,”_attachments”:{“valueBytes”:{“content_type”:”application/octet-stream”,”revpos”:2,”digest”:”md5-hhOYXsSeuPdXrmQ56Hm7Kg==”,”length”:2,”stub”:true}}}</p> 
  <p>Fabric可能会遇到的问题 <br> 虽然区块链是一个只能插入和查询的数据库，但是我们的业务数据是存放在State Database中的，如果我们直接修改了CouchDB的数据，那么接下来的查询和事务是直接基于修改后的CouchDB的，并不会去检查区块链中的记录，所以理论上是可以通过直接改CouchDB来实现业务数据的修改。 我们以官方的Marble为例，看看修改CouchDB会怎么样？ 具体操作步骤如下： 1.Install，instantiate和初始化数据： </p> 
  <p>peer chaincode install -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02</p> 
  <p>peer chaincode instantiate -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/marbles02 -c ‘{“Args”:[“init”]}’ -P “OR (‘Org1MSP.member’,’Org2MSP.member’)”</p> 
  <p>peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“initMarble”,”marble2”,”red”,”50”,”tom”]}’</p> 
  <p>peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ </p> 
  <p>我们可以看到通过curl直接查询CouchDB中的数据：</p> 
  <p>curl <a href="http://192.168.100.129:5984/mychannel/marbles02%00marble2" rel="nofollow">http://192.168.100.129:5984/mychannel/marbles02%00marble2</a></p> 
  <p>{“_id”:”marbles02\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”red”,”size”:50,”owner”:”tom”},”version”:”6:0”}</p> 
  <p>如果我们要修改其中的数据，把颜色改成green，大小改成10，那么我们可以运行：</p> 
  <p>curl -X PUT <a href="http://192.168.100.129:5984/mychannel/marbles02%00marble2" rel="nofollow">http://192.168.100.129:5984/mychannel/marbles02%00marble2</a> -d ‘{“_id”:”marbles02\u0000marble2”,”_rev”:”1-a1844f47b9ed94294b430c9a9a6f543b”,”chaincodeid”:”marbles02”,”data”:{“docType”:”marble”,”name”:”marble2”,”color”:”green”,”size”:10,”owner”:”tom”},”version”:”6:0”}’ <br> 系统返回结果： <br> {“ok”:true,”id”:”marbles02\u0000marble2”,”rev”:”2-6ffc6652cfc707f8352a5f06c3ce1ce6”} <br> 我们在4个CouchDB中都运行这个命令，把4个数据库的数据都改了。 接下来我们通过ChainCode来查询，看看会怎么样。 <br> peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ 返回结果： Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”tom”,”size”:10} 可以看到数据已经变成新的值，那么接下来运行其他的Transaction会怎么样？我们试一试转账操作： <br> peer chaincode invoke -o orderer.example.com:7050 –tls $CORE_PEER_TLS_ENABLED –cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n marbles02 -c ‘{“Args”:[“transferMarble”,”marble2”,”jerry”]}’ 系统返回成功，我们再查一下呢 <br> peer chaincode query -C mychannel -n marbles02 -c ‘{“Args”:[“readMarble”,”marble2”]}’ Query Result: {“color”:”green”,”docType”:”marble”,”name”:”marble2”,”owner”:”jerry”,”size”:10} 所以我们对CouchDB数据库的更改都是有效的，在Fabric看来似乎并不知道我们改了CouchDB的内容。</p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq_42984500/article/details/81737956,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq_42984500/article/details/81737956,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
