<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>【6】以太坊Miner模块源码分析 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="【6】以太坊Miner模块源码分析" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Miner模块： 类结构如下： 主要结构体 Miner、Worker、Work、CpuAgent、Result、unconfiredBlocks Miner为挖矿的核心对象（矿工），核心成员包括注册处理事件（mux）、工人（worker）、coinbase（默认账户地址hash）、后台处理对象（eth）、共识处理引擎（engine）、判定能否挖矿的对象（canstart）、判定是否同步挖矿（shouldstart） 方法： 方法名 参数 主要描述 update 空 防止DOS攻击 Start coinbase 关闭同步，启动挖矿 Stop 空 停止挖矿 Register 空 注册代理 Unregister 空 解除代理 Mining 空 是否挖矿 HashRate 空 返回Pow当前挖矿的哈希率 SetExtra 空 设置worker的extra值（byte数组） Pending 空 挂起返回当前挂起的块和关联的状态。 PendingBlock 空 挂起返回当前挂起的块 SetEtherbase 空 设置coinbase &nbsp; Worker为挖矿管理的核心对象，主要的属性包括区块配置项（BlockConfig）、共识引擎（consensus.Engine）、交易事件处理通道或生产订阅处理（txsch、chainHead、chainSide&nbsp;Ch&nbsp;or&nbsp;Sub）、代理对象集、 属性： 属性名 类型 主要描述 config *params.ChainConfig 区块链config配置 engine consensus.Engine 共识引擎 mu sync.Mutex 互斥锁 mux &nbsp;&nbsp;&nbsp;*event.TypeMux Type MeXUX将事件发送到已注册的接收方。接收机可以注册处理某些类型的事件。任何操作MUX停止后调用将返回ErrMxxOutlook零值已经准备好使用了。弃用：使用饲料 txsCh &nbsp; chan core.NewTxsEvent &nbsp; txsSub event.Subscription &nbsp; chainHeadCh chan core.ChainHeadEvent &nbsp; chainHeadSub event.Subscription &nbsp; …… …… …… agents agents map[Agent]struct{} 挖矿代理通道 recv chan *Result 结果通道 eth Backend 后台处理对象（账号管理、链、交易池以及链存储管理） chain *core.BlockChain 链对象 proc core.Validator 区块核查对象，核查区块儿内容 chainDb ethdb.Database 数据库封装所有数据库操作。所有的方法都是安全的并发使用。 coinbase common.Address Coinbase extra []byte 区块的extraData currentMu sync.Mutex 当前互斥锁 current *Work 当前执行的工作work snapshotMu sync.RWMutex 读写锁快照 snapshotBlock *types.Block 区块快照 snapshotState *state.StateDB 状态快照 uncleMu sync.Mutex 数块互斥锁 possibleUncles map[common.Hash]*types.Block 数块哈希映射 unconfirmed *unconfirmedBlocks 未确认区块 atWork int32 运行中的引擎数量 running int32 状态判定字段 &nbsp; 方法： 方法名 参数 描述 newWorker Config，engine，eth，mux返回*worker 初始化Worker函数 setEtherbase addr （common.Address） 设置coinbase setExtra extra （[]byte） 设置extra pending 返回(*types.Block, *state.StateDB) 返回快照防止房钱互斥锁征用 pendingBlock 返回 *types.Block 返回区块快照 start 空 启动所有agent挖矿工作 stop 空 停止所有agent挖矿工作 isRunning 空 返回是否运行bool值 register agent 注册新代理，若worker运行则启动代理挖矿 unregister Agent 解除已存在的agent，并停止挖矿 update 空 处理交易、区块头等事件，更新区块、叔块和交易信息 wait 空 更新所有日志中的块散列，从它现在可用时，而不是在创建单个事务的收据/日志时，广播pending的区块等待确认 push Work 创建一个新的work 任务给当前活动的矿工代理 makeCurrent parent *types.Block, header *types.Header 为当前循环，创建一个新的环境 commitNewWork 空 提交新的work commitUncle Work，uncle&nbsp;&nbsp; 在新的work中添加叔块hash updateSnapshot 空 更新快照 commitTransactions Mux、 txs、bc、coinbase 提交交易 commitTransaction Tx，bc、coinbase、gp &nbsp; &nbsp; Work是矿工的执行环境，掌握所有当前状态信息 属性： 属性名 类型 主要描述 config *params.ChainConfig 区块链config配置 signer types.Signer 签名器封装事务签名处理 state *state.StateDB 网络状态存储 ancestors mapset.Set 祖先 用于检查叔块父块是否合法 family mapset.Set 用于检查叔块合法 uncles mapset.Set 叔块集合 gasPool *core.GasPool Gas池 用于打包交易的可用gas值 Block *types.Block 新块儿 header *types.Header …… txs []*types.Transaction …… receipts []*types.Receipt …… createdAt time.Time …… &nbsp; Agent：挖矿代理 属性： 属性名 类型 主要描述 mu sync.Mutex 互斥锁 workCh chan *Work Work 通道 quitCurrentOp chan struct{} 取消当前操作 returnCh chan&lt;- *Result 返回执行结果（work 和区块） chain consensus.ChainReader Uncle核查时提供查询区块链的对象 Engine consensus.Engine 共识处理引擎 Started Int32 指定agent当前是否启动 方法： 方法名 参数 描述 Work 无 返回chan&lt;-*Work 返回工作通道 SetReturnCh ch 设置Work 通道 Start 空 调用update，启动挖矿 Stop 空 清空work Update consensus.ChainReader Uncle核查时提供查询区块链的对象 Mine work.&nbsp;stop 调用engine.Seal封装交易，打包新块儿 &nbsp; &nbsp; Miner&nbsp;中Gas及gasPrice相关重点分析：( blockheader 的gaslimit来源commitNewWork) 1）从miner、worker、work、agent的相关接口可知并无直接修改或者接受gas、gasprice、gaslimit的直接设定和修改，miner对gas、gasPrice不具有大的自主性修改权限和接收权限 2）挖矿打包的过程由eth.backend.go实现，其中对象Ethereum处理交易池、区块链存储、共识引擎、矿工、RPC服务等关键操作，值得注意的是ethereum对象包含gasprice对象，但该值初始化配置源于config的默认设置为big.NewInt(18 * params.Shannon),见eth.config.go文件中的DefaultConfig； 3）从commitTransactions函数分析，若新的work 的可用gas值gasPool为nil则默认将work正在处理的区块儿的区块头中的Gaslimit作为该work的gaspool，作为当前工作的可用gas。而当前work.header.Gaslimit来源于work.&nbsp;commitNewWork()中core.CalcGasLimit(parent),计算机制如下： // contrib = (parentGasUsed * 3 / 2) / 1024，当父区块Gas使用量&gt;2/3的时候，会较上次加大gaslimit，反之减小； 计算新区块gaslimit的贡献度值contrib := (parent.GasUsed() + parent.GasUsed()/2) / params.GasLimitBoundDivisor（1024） 计算衰减量：decay = parentGasLimit / 1024 -1 最后计算得到limit&nbsp;:= parent.GasLimit() - decay + contrib gaslimit &nbsp;不可小于5000&nbsp;不大于创世块儿的gaslimit限制（4712388） &nbsp; 此处work在打包时要进行gas判断：env.gasPool.Gas() &lt; params.TxGas（21000），每个work的gas值（也就是说交易发送者提供的每笔交易gas）不能低于21000； commitTransaction调用了core.ApplyTransaction函数，该函数的具体实现Gas的消耗和奖励机制，过程如下图： ApplyTransaction()&nbsp;首先根据输入参数分别封装出一个Message对象和一个EVM对象； 然后加上一个传入的GasPool类型变量，由TransitionDb()函数完成tx的执行，待TransitionDb()返回之后，创建一个收据Receipt对象，最后返回该Recetip对象，以及整个tx执行过程所消耗Gas数量。 GasPool对象是在一个Block执行开始时创建，并在该Block内所有tx的执行过程中共享，对于一个tx的执行可视为“全局”存储对象； Message由此次待执行的tx对象转化而来，并携带了解析出的tx的(转帐)转出方地址，属于待处理的数据对象； EVM 作为Ethereum世界里的虚拟机(Virtual Machine)，作为此次tx的实际执行者，完成转帐和合约(Contract)的相关操作。 &nbsp; TransitioinDb()的执行过程(/core/state_transition.go)。假设有StateTransition对象st,&nbsp; 其成员变量initialGas表示初始可用Gas数量，gas表示即时可用Gas数量，初始值均为0，于是st.TransitionDb() 可由以下步骤展开： 购买Gas。首先从交易的(转帐)转出方账户扣除一笔Ether，费用等于tx.data.GasLimit * tx.data.Price；同时&nbsp;st.initialGas = st.gas = tx.data.GasLimit；然后(GasPool) gp -= st.gas。 计算tx的固有Gas消耗&nbsp;- intrinsicGas。它分为两个部分，每一个tx预设的消耗量，这个消耗量还因tx是否含有(转帐)转入方地址而略有不同；以及针对tx.data.Payload的Gas消耗，Payload类型是[]byte，关于它的固有消耗依赖于[]byte中非0字节和0字节的长度。最终，st.gas -= intrinsicGas EVM执行。如果交易的(转帐)转入方地址(tx.data.Recipient)为空，调用EVM的Create()函数；否则，调用Call()函数。无论哪个函数返回后，更新st.gas。 计算本次执行交易的实际Gas消耗：&nbsp;requiredGas = st.initialGas - st.gas 偿退Gas。它包括两个部分：首先将剩余st.gas 折算成Ether，归还给交易的(转帐)转出方账户；然后，基于实际消耗量requiredGas，系统提供一定的补偿，数量为refundGas。refundGas 所折算的Ether会被立即加在(转帐)转出方账户上，同时st.gas += refundGas，gp += st.gas，即剩余的Gas加上系统补偿的Gas，被一起归并进GasPool，供之后的交易执行使用。 奖励所属区块的挖掘者：系统给所属区块的作者，亦即挖掘者账户，增加一笔金额，数额等于&nbsp;st.data,Price * (st.initialGas - st.gas)。注意，这里的st.gas在步骤5中被加上了refundGas, 所以这笔奖励金所对应的Gas，其数量小于该交易实际消耗量requiredGas。 阅读更多" />
<meta property="og:description" content="Miner模块： 类结构如下： 主要结构体 Miner、Worker、Work、CpuAgent、Result、unconfiredBlocks Miner为挖矿的核心对象（矿工），核心成员包括注册处理事件（mux）、工人（worker）、coinbase（默认账户地址hash）、后台处理对象（eth）、共识处理引擎（engine）、判定能否挖矿的对象（canstart）、判定是否同步挖矿（shouldstart） 方法： 方法名 参数 主要描述 update 空 防止DOS攻击 Start coinbase 关闭同步，启动挖矿 Stop 空 停止挖矿 Register 空 注册代理 Unregister 空 解除代理 Mining 空 是否挖矿 HashRate 空 返回Pow当前挖矿的哈希率 SetExtra 空 设置worker的extra值（byte数组） Pending 空 挂起返回当前挂起的块和关联的状态。 PendingBlock 空 挂起返回当前挂起的块 SetEtherbase 空 设置coinbase &nbsp; Worker为挖矿管理的核心对象，主要的属性包括区块配置项（BlockConfig）、共识引擎（consensus.Engine）、交易事件处理通道或生产订阅处理（txsch、chainHead、chainSide&nbsp;Ch&nbsp;or&nbsp;Sub）、代理对象集、 属性： 属性名 类型 主要描述 config *params.ChainConfig 区块链config配置 engine consensus.Engine 共识引擎 mu sync.Mutex 互斥锁 mux &nbsp;&nbsp;&nbsp;*event.TypeMux Type MeXUX将事件发送到已注册的接收方。接收机可以注册处理某些类型的事件。任何操作MUX停止后调用将返回ErrMxxOutlook零值已经准备好使用了。弃用：使用饲料 txsCh &nbsp; chan core.NewTxsEvent &nbsp; txsSub event.Subscription &nbsp; chainHeadCh chan core.ChainHeadEvent &nbsp; chainHeadSub event.Subscription &nbsp; …… …… …… agents agents map[Agent]struct{} 挖矿代理通道 recv chan *Result 结果通道 eth Backend 后台处理对象（账号管理、链、交易池以及链存储管理） chain *core.BlockChain 链对象 proc core.Validator 区块核查对象，核查区块儿内容 chainDb ethdb.Database 数据库封装所有数据库操作。所有的方法都是安全的并发使用。 coinbase common.Address Coinbase extra []byte 区块的extraData currentMu sync.Mutex 当前互斥锁 current *Work 当前执行的工作work snapshotMu sync.RWMutex 读写锁快照 snapshotBlock *types.Block 区块快照 snapshotState *state.StateDB 状态快照 uncleMu sync.Mutex 数块互斥锁 possibleUncles map[common.Hash]*types.Block 数块哈希映射 unconfirmed *unconfirmedBlocks 未确认区块 atWork int32 运行中的引擎数量 running int32 状态判定字段 &nbsp; 方法： 方法名 参数 描述 newWorker Config，engine，eth，mux返回*worker 初始化Worker函数 setEtherbase addr （common.Address） 设置coinbase setExtra extra （[]byte） 设置extra pending 返回(*types.Block, *state.StateDB) 返回快照防止房钱互斥锁征用 pendingBlock 返回 *types.Block 返回区块快照 start 空 启动所有agent挖矿工作 stop 空 停止所有agent挖矿工作 isRunning 空 返回是否运行bool值 register agent 注册新代理，若worker运行则启动代理挖矿 unregister Agent 解除已存在的agent，并停止挖矿 update 空 处理交易、区块头等事件，更新区块、叔块和交易信息 wait 空 更新所有日志中的块散列，从它现在可用时，而不是在创建单个事务的收据/日志时，广播pending的区块等待确认 push Work 创建一个新的work 任务给当前活动的矿工代理 makeCurrent parent *types.Block, header *types.Header 为当前循环，创建一个新的环境 commitNewWork 空 提交新的work commitUncle Work，uncle&nbsp;&nbsp; 在新的work中添加叔块hash updateSnapshot 空 更新快照 commitTransactions Mux、 txs、bc、coinbase 提交交易 commitTransaction Tx，bc、coinbase、gp &nbsp; &nbsp; Work是矿工的执行环境，掌握所有当前状态信息 属性： 属性名 类型 主要描述 config *params.ChainConfig 区块链config配置 signer types.Signer 签名器封装事务签名处理 state *state.StateDB 网络状态存储 ancestors mapset.Set 祖先 用于检查叔块父块是否合法 family mapset.Set 用于检查叔块合法 uncles mapset.Set 叔块集合 gasPool *core.GasPool Gas池 用于打包交易的可用gas值 Block *types.Block 新块儿 header *types.Header …… txs []*types.Transaction …… receipts []*types.Receipt …… createdAt time.Time …… &nbsp; Agent：挖矿代理 属性： 属性名 类型 主要描述 mu sync.Mutex 互斥锁 workCh chan *Work Work 通道 quitCurrentOp chan struct{} 取消当前操作 returnCh chan&lt;- *Result 返回执行结果（work 和区块） chain consensus.ChainReader Uncle核查时提供查询区块链的对象 Engine consensus.Engine 共识处理引擎 Started Int32 指定agent当前是否启动 方法： 方法名 参数 描述 Work 无 返回chan&lt;-*Work 返回工作通道 SetReturnCh ch 设置Work 通道 Start 空 调用update，启动挖矿 Stop 空 清空work Update consensus.ChainReader Uncle核查时提供查询区块链的对象 Mine work.&nbsp;stop 调用engine.Seal封装交易，打包新块儿 &nbsp; &nbsp; Miner&nbsp;中Gas及gasPrice相关重点分析：( blockheader 的gaslimit来源commitNewWork) 1）从miner、worker、work、agent的相关接口可知并无直接修改或者接受gas、gasprice、gaslimit的直接设定和修改，miner对gas、gasPrice不具有大的自主性修改权限和接收权限 2）挖矿打包的过程由eth.backend.go实现，其中对象Ethereum处理交易池、区块链存储、共识引擎、矿工、RPC服务等关键操作，值得注意的是ethereum对象包含gasprice对象，但该值初始化配置源于config的默认设置为big.NewInt(18 * params.Shannon),见eth.config.go文件中的DefaultConfig； 3）从commitTransactions函数分析，若新的work 的可用gas值gasPool为nil则默认将work正在处理的区块儿的区块头中的Gaslimit作为该work的gaspool，作为当前工作的可用gas。而当前work.header.Gaslimit来源于work.&nbsp;commitNewWork()中core.CalcGasLimit(parent),计算机制如下： // contrib = (parentGasUsed * 3 / 2) / 1024，当父区块Gas使用量&gt;2/3的时候，会较上次加大gaslimit，反之减小； 计算新区块gaslimit的贡献度值contrib := (parent.GasUsed() + parent.GasUsed()/2) / params.GasLimitBoundDivisor（1024） 计算衰减量：decay = parentGasLimit / 1024 -1 最后计算得到limit&nbsp;:= parent.GasLimit() - decay + contrib gaslimit &nbsp;不可小于5000&nbsp;不大于创世块儿的gaslimit限制（4712388） &nbsp; 此处work在打包时要进行gas判断：env.gasPool.Gas() &lt; params.TxGas（21000），每个work的gas值（也就是说交易发送者提供的每笔交易gas）不能低于21000； commitTransaction调用了core.ApplyTransaction函数，该函数的具体实现Gas的消耗和奖励机制，过程如下图： ApplyTransaction()&nbsp;首先根据输入参数分别封装出一个Message对象和一个EVM对象； 然后加上一个传入的GasPool类型变量，由TransitionDb()函数完成tx的执行，待TransitionDb()返回之后，创建一个收据Receipt对象，最后返回该Recetip对象，以及整个tx执行过程所消耗Gas数量。 GasPool对象是在一个Block执行开始时创建，并在该Block内所有tx的执行过程中共享，对于一个tx的执行可视为“全局”存储对象； Message由此次待执行的tx对象转化而来，并携带了解析出的tx的(转帐)转出方地址，属于待处理的数据对象； EVM 作为Ethereum世界里的虚拟机(Virtual Machine)，作为此次tx的实际执行者，完成转帐和合约(Contract)的相关操作。 &nbsp; TransitioinDb()的执行过程(/core/state_transition.go)。假设有StateTransition对象st,&nbsp; 其成员变量initialGas表示初始可用Gas数量，gas表示即时可用Gas数量，初始值均为0，于是st.TransitionDb() 可由以下步骤展开： 购买Gas。首先从交易的(转帐)转出方账户扣除一笔Ether，费用等于tx.data.GasLimit * tx.data.Price；同时&nbsp;st.initialGas = st.gas = tx.data.GasLimit；然后(GasPool) gp -= st.gas。 计算tx的固有Gas消耗&nbsp;- intrinsicGas。它分为两个部分，每一个tx预设的消耗量，这个消耗量还因tx是否含有(转帐)转入方地址而略有不同；以及针对tx.data.Payload的Gas消耗，Payload类型是[]byte，关于它的固有消耗依赖于[]byte中非0字节和0字节的长度。最终，st.gas -= intrinsicGas EVM执行。如果交易的(转帐)转入方地址(tx.data.Recipient)为空，调用EVM的Create()函数；否则，调用Call()函数。无论哪个函数返回后，更新st.gas。 计算本次执行交易的实际Gas消耗：&nbsp;requiredGas = st.initialGas - st.gas 偿退Gas。它包括两个部分：首先将剩余st.gas 折算成Ether，归还给交易的(转帐)转出方账户；然后，基于实际消耗量requiredGas，系统提供一定的补偿，数量为refundGas。refundGas 所折算的Ether会被立即加在(转帐)转出方账户上，同时st.gas += refundGas，gp += st.gas，即剩余的Gas加上系统补偿的Gas，被一起归并进GasPool，供之后的交易执行使用。 奖励所属区块的挖掘者：系统给所属区块的作者，亦即挖掘者账户，增加一笔金额，数额等于&nbsp;st.data,Price * (st.initialGas - st.gas)。注意，这里的st.gas在步骤5中被加上了refundGas, 所以这笔奖励金所对应的Gas，其数量小于该交易实际消耗量requiredGas。 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-08-16T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"Miner模块： 类结构如下： 主要结构体 Miner、Worker、Work、CpuAgent、Result、unconfiredBlocks Miner为挖矿的核心对象（矿工），核心成员包括注册处理事件（mux）、工人（worker）、coinbase（默认账户地址hash）、后台处理对象（eth）、共识处理引擎（engine）、判定能否挖矿的对象（canstart）、判定是否同步挖矿（shouldstart） 方法： 方法名 参数 主要描述 update 空 防止DOS攻击 Start coinbase 关闭同步，启动挖矿 Stop 空 停止挖矿 Register 空 注册代理 Unregister 空 解除代理 Mining 空 是否挖矿 HashRate 空 返回Pow当前挖矿的哈希率 SetExtra 空 设置worker的extra值（byte数组） Pending 空 挂起返回当前挂起的块和关联的状态。 PendingBlock 空 挂起返回当前挂起的块 SetEtherbase 空 设置coinbase &nbsp; Worker为挖矿管理的核心对象，主要的属性包括区块配置项（BlockConfig）、共识引擎（consensus.Engine）、交易事件处理通道或生产订阅处理（txsch、chainHead、chainSide&nbsp;Ch&nbsp;or&nbsp;Sub）、代理对象集、 属性： 属性名 类型 主要描述 config *params.ChainConfig 区块链config配置 engine consensus.Engine 共识引擎 mu sync.Mutex 互斥锁 mux &nbsp;&nbsp;&nbsp;*event.TypeMux Type MeXUX将事件发送到已注册的接收方。接收机可以注册处理某些类型的事件。任何操作MUX停止后调用将返回ErrMxxOutlook零值已经准备好使用了。弃用：使用饲料 txsCh &nbsp; chan core.NewTxsEvent &nbsp; txsSub event.Subscription &nbsp; chainHeadCh chan core.ChainHeadEvent &nbsp; chainHeadSub event.Subscription &nbsp; …… …… …… agents agents map[Agent]struct{} 挖矿代理通道 recv chan *Result 结果通道 eth Backend 后台处理对象（账号管理、链、交易池以及链存储管理） chain *core.BlockChain 链对象 proc core.Validator 区块核查对象，核查区块儿内容 chainDb ethdb.Database 数据库封装所有数据库操作。所有的方法都是安全的并发使用。 coinbase common.Address Coinbase extra []byte 区块的extraData currentMu sync.Mutex 当前互斥锁 current *Work 当前执行的工作work snapshotMu sync.RWMutex 读写锁快照 snapshotBlock *types.Block 区块快照 snapshotState *state.StateDB 状态快照 uncleMu sync.Mutex 数块互斥锁 possibleUncles map[common.Hash]*types.Block 数块哈希映射 unconfirmed *unconfirmedBlocks 未确认区块 atWork int32 运行中的引擎数量 running int32 状态判定字段 &nbsp; 方法： 方法名 参数 描述 newWorker Config，engine，eth，mux返回*worker 初始化Worker函数 setEtherbase addr （common.Address） 设置coinbase setExtra extra （[]byte） 设置extra pending 返回(*types.Block, *state.StateDB) 返回快照防止房钱互斥锁征用 pendingBlock 返回 *types.Block 返回区块快照 start 空 启动所有agent挖矿工作 stop 空 停止所有agent挖矿工作 isRunning 空 返回是否运行bool值 register agent 注册新代理，若worker运行则启动代理挖矿 unregister Agent 解除已存在的agent，并停止挖矿 update 空 处理交易、区块头等事件，更新区块、叔块和交易信息 wait 空 更新所有日志中的块散列，从它现在可用时，而不是在创建单个事务的收据/日志时，广播pending的区块等待确认 push Work 创建一个新的work 任务给当前活动的矿工代理 makeCurrent parent *types.Block, header *types.Header 为当前循环，创建一个新的环境 commitNewWork 空 提交新的work commitUncle Work，uncle&nbsp;&nbsp; 在新的work中添加叔块hash updateSnapshot 空 更新快照 commitTransactions Mux、 txs、bc、coinbase 提交交易 commitTransaction Tx，bc、coinbase、gp &nbsp; &nbsp; Work是矿工的执行环境，掌握所有当前状态信息 属性： 属性名 类型 主要描述 config *params.ChainConfig 区块链config配置 signer types.Signer 签名器封装事务签名处理 state *state.StateDB 网络状态存储 ancestors mapset.Set 祖先 用于检查叔块父块是否合法 family mapset.Set 用于检查叔块合法 uncles mapset.Set 叔块集合 gasPool *core.GasPool Gas池 用于打包交易的可用gas值 Block *types.Block 新块儿 header *types.Header …… txs []*types.Transaction …… receipts []*types.Receipt …… createdAt time.Time …… &nbsp; Agent：挖矿代理 属性： 属性名 类型 主要描述 mu sync.Mutex 互斥锁 workCh chan *Work Work 通道 quitCurrentOp chan struct{} 取消当前操作 returnCh chan&lt;- *Result 返回执行结果（work 和区块） chain consensus.ChainReader Uncle核查时提供查询区块链的对象 Engine consensus.Engine 共识处理引擎 Started Int32 指定agent当前是否启动 方法： 方法名 参数 描述 Work 无 返回chan&lt;-*Work 返回工作通道 SetReturnCh ch 设置Work 通道 Start 空 调用update，启动挖矿 Stop 空 清空work Update consensus.ChainReader Uncle核查时提供查询区块链的对象 Mine work.&nbsp;stop 调用engine.Seal封装交易，打包新块儿 &nbsp; &nbsp; Miner&nbsp;中Gas及gasPrice相关重点分析：( blockheader 的gaslimit来源commitNewWork) 1）从miner、worker、work、agent的相关接口可知并无直接修改或者接受gas、gasprice、gaslimit的直接设定和修改，miner对gas、gasPrice不具有大的自主性修改权限和接收权限 2）挖矿打包的过程由eth.backend.go实现，其中对象Ethereum处理交易池、区块链存储、共识引擎、矿工、RPC服务等关键操作，值得注意的是ethereum对象包含gasprice对象，但该值初始化配置源于config的默认设置为big.NewInt(18 * params.Shannon),见eth.config.go文件中的DefaultConfig； 3）从commitTransactions函数分析，若新的work 的可用gas值gasPool为nil则默认将work正在处理的区块儿的区块头中的Gaslimit作为该work的gaspool，作为当前工作的可用gas。而当前work.header.Gaslimit来源于work.&nbsp;commitNewWork()中core.CalcGasLimit(parent),计算机制如下： // contrib = (parentGasUsed * 3 / 2) / 1024，当父区块Gas使用量&gt;2/3的时候，会较上次加大gaslimit，反之减小； 计算新区块gaslimit的贡献度值contrib := (parent.GasUsed() + parent.GasUsed()/2) / params.GasLimitBoundDivisor（1024） 计算衰减量：decay = parentGasLimit / 1024 -1 最后计算得到limit&nbsp;:= parent.GasLimit() - decay + contrib gaslimit &nbsp;不可小于5000&nbsp;不大于创世块儿的gaslimit限制（4712388） &nbsp; 此处work在打包时要进行gas判断：env.gasPool.Gas() &lt; params.TxGas（21000），每个work的gas值（也就是说交易发送者提供的每笔交易gas）不能低于21000； commitTransaction调用了core.ApplyTransaction函数，该函数的具体实现Gas的消耗和奖励机制，过程如下图： ApplyTransaction()&nbsp;首先根据输入参数分别封装出一个Message对象和一个EVM对象； 然后加上一个传入的GasPool类型变量，由TransitionDb()函数完成tx的执行，待TransitionDb()返回之后，创建一个收据Receipt对象，最后返回该Recetip对象，以及整个tx执行过程所消耗Gas数量。 GasPool对象是在一个Block执行开始时创建，并在该Block内所有tx的执行过程中共享，对于一个tx的执行可视为“全局”存储对象； Message由此次待执行的tx对象转化而来，并携带了解析出的tx的(转帐)转出方地址，属于待处理的数据对象； EVM 作为Ethereum世界里的虚拟机(Virtual Machine)，作为此次tx的实际执行者，完成转帐和合约(Contract)的相关操作。 &nbsp; TransitioinDb()的执行过程(/core/state_transition.go)。假设有StateTransition对象st,&nbsp; 其成员变量initialGas表示初始可用Gas数量，gas表示即时可用Gas数量，初始值均为0，于是st.TransitionDb() 可由以下步骤展开： 购买Gas。首先从交易的(转帐)转出方账户扣除一笔Ether，费用等于tx.data.GasLimit * tx.data.Price；同时&nbsp;st.initialGas = st.gas = tx.data.GasLimit；然后(GasPool) gp -= st.gas。 计算tx的固有Gas消耗&nbsp;- intrinsicGas。它分为两个部分，每一个tx预设的消耗量，这个消耗量还因tx是否含有(转帐)转入方地址而略有不同；以及针对tx.data.Payload的Gas消耗，Payload类型是[]byte，关于它的固有消耗依赖于[]byte中非0字节和0字节的长度。最终，st.gas -= intrinsicGas EVM执行。如果交易的(转帐)转入方地址(tx.data.Recipient)为空，调用EVM的Create()函数；否则，调用Call()函数。无论哪个函数返回后，更新st.gas。 计算本次执行交易的实际Gas消耗：&nbsp;requiredGas = st.initialGas - st.gas 偿退Gas。它包括两个部分：首先将剩余st.gas 折算成Ether，归还给交易的(转帐)转出方账户；然后，基于实际消耗量requiredGas，系统提供一定的补偿，数量为refundGas。refundGas 所折算的Ether会被立即加在(转帐)转出方账户上，同时st.gas += refundGas，gp += st.gas，即剩余的Gas加上系统补偿的Gas，被一起归并进GasPool，供之后的交易执行使用。 奖励所属区块的挖掘者：系统给所属区块的作者，亦即挖掘者账户，增加一笔金额，数额等于&nbsp;st.data,Price * (st.initialGas - st.gas)。注意，这里的st.gas在步骤5中被加上了refundGas, 所以这笔奖励金所对应的Gas，其数量小于该交易实际消耗量requiredGas。 阅读更多","@type":"BlogPosting","url":"/2018/08/16/969e38a73527fac6cc542ac0906bd46d.html","headline":"【6】以太坊Miner模块源码分析","dateModified":"2018-08-16T00:00:00+08:00","datePublished":"2018-08-16T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/08/16/969e38a73527fac6cc542ac0906bd46d.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>【6】以太坊Miner模块源码分析</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p style="margin-left:0pt;"><strong><strong>Miner模块</strong></strong>：</p> 
  <p style="margin-left:0pt;">类结构如下：</p> 
  <p style="margin-left:0pt;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816000925975?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R3anBlbmcy/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0pt;">主要结构体</p> 
  <p style="margin-left:0pt;">Miner、Worker、Work、CpuAgent、Result、unconfiredBlocks</p> 
  <p style="margin-left:0pt;"><strong><strong>Mine</strong></strong><strong><strong>r</strong></strong>为挖矿的核心对象（矿工），核心成员包括注册处理事件（mux）、工人（worker）、coinbase（默认账户地址hash）、后台处理对象（eth）、共识处理引擎（engine）、判定能否挖矿的对象（canstart）、判定是否同步挖矿（shouldstart）</p> 
  <p style="margin-left:0pt;">方法：</p> 
  <table border="1" cellspacing="0" style="width:412.55pt;">
   <tbody>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">方法名</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">参数</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">主要描述</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">update</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">防止DOS攻击</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Start</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">coinbase</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">关闭同步，启动挖矿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Stop</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">停止挖矿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Register</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">注册代理</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Unregister</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">解除代理</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Mining</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">是否挖矿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">HashRate</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">返回Pow当前挖矿的哈希率</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">SetExtra</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">设置worker的extra值（byte数组）</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Pending</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">挂起返回当前挂起的块和关联的状态。</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">PendingBlock</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">挂起返回当前挂起的块</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">SetEtherbase</p> </td> 
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:246.75pt;"> <p style="margin-left:0pt;">设置coinbase</p> </td> 
    </tr>
   </tbody>
  </table>
  <p style="margin-left:0pt;">&nbsp;</p> 
  <p style="margin-left:0pt;"><strong><strong>Worker</strong></strong>为挖矿管理的核心对象，主要的属性包括区块配置项（BlockConfig）、共识引擎（consensus.Engine）、交易事件处理通道或生产订阅处理（txsch、chainHead、chainSide&nbsp;Ch&nbsp;or&nbsp;Sub）、代理对象集、</p> 
  <p style="margin-left:0pt;"><strong><strong>属性</strong></strong>：</p> 
  <table border="1" cellspacing="0" style="width:412.55pt;">
   <tbody>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">属性名</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">类型</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">主要描述</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">config</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">*params.ChainConfig</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">区块链config配置</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">engine</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">consensus.Engine</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">共识引擎</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">mu</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">sync.Mutex</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">互斥锁</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">mux</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">&nbsp;&nbsp;&nbsp;*event.TypeMux</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">Type MeXUX将事件发送到已注册的接收方。接收机可以注册处理某些类型的事件。任何操作MUX停止后调用将返回ErrMxxOutlook零值已经准备好使用了。弃用：使用饲料</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">txsCh</p> <p style="margin-left:0pt;">&nbsp;</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">chan core.NewTxsEvent</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">&nbsp;</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">txsSub</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">event.Subscription</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">&nbsp;</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">chainHeadCh</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">chan core.ChainHeadEvent</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">&nbsp;</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">chainHeadSub</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">event.Subscription</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">&nbsp;</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">……</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">……</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">……</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">agents</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">agents map[Agent]struct{}</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">挖矿代理通道</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">recv</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">chan *Result</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">结果通道</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">eth</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">Backend</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">后台处理对象（账号管理、链、交易池以及链存储管理）</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">chain</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">*core.BlockChain</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">链对象</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">proc</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">core.Validator</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">区块核查对象，核查区块儿内容</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">chainDb</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">ethdb.Database</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">数据库封装所有数据库操作。所有的方法都是安全的并发使用。</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">coinbase</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">common.Address</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">Coinbase</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">extra</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">[]byte</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">区块的extraData</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">currentMu</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">sync.Mutex</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">当前互斥锁</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">current</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">*Work</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">当前执行的工作work</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">snapshotMu</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">sync.RWMutex</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">读写锁快照</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">snapshotBlock</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">*types.Block</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">区块快照</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">snapshotState</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">*state.StateDB</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">状态快照</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">uncleMu</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">sync.Mutex</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">数块互斥锁</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">possibleUncles</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">map[common.Hash]*types.Block</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">数块哈希映射</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">unconfirmed</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">*unconfirmedBlocks</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">未确认区块</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">atWork</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">int32</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">运行中的引擎数量</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:83.5pt;"> <p style="margin-left:0pt;">running</p> </td> 
     <td style="vertical-align:top;width:172.15pt;"> <p style="margin-left:0pt;">int32</p> </td> 
     <td style="vertical-align:top;width:156.9pt;"> <p style="margin-left:0pt;">状态判定字段</p> </td> 
    </tr>
   </tbody>
  </table>
  <p style="margin-left:0pt;">&nbsp;</p> 
  <p style="margin-left:0pt;"><strong><strong>方法：</strong></strong></p> 
  <table border="1" cellspacing="0" style="width:414.5pt;">
   <tbody>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">方法名</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">参数</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">描述</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">newWorker</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">Config，engine，eth，mux返回*worker</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">初始化Worker函数</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">setEtherbase</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">addr （common.Address）</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">设置coinbase</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">setExtra</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">extra （[]byte）</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">设置extra</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">pending</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">返回(*types.Block, *state.StateDB)</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">返回快照防止房钱互斥锁征用</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">pendingBlock</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">返回 *types.Block</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">返回区块快照</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">start</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">启动所有agent挖矿工作</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">stop</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">停止所有agent挖矿工作</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">isRunning</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">返回是否运行bool值</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">register</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">agent</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">注册新代理，若worker运行则启动代理挖矿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">unregister</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">Agent</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">解除已存在的agent，并停止挖矿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">update</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">处理交易、区块头等事件，更新区块、叔块和交易信息</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">wait</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">更新所有日志中的块散列，从它现在可用时，而不是在创建单个事务的收据/日志时，广播pending的区块等待确认</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">push</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">Work</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">创建一个新的work 任务给当前活动的矿工代理</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">makeCurrent</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">parent *types.Block, header *types.Header</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">为当前循环，创建一个新的环境</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;"><strong><strong>commitNewWork</strong></strong></p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">提交新的work</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">commitUncle</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">Work，uncle&nbsp;&nbsp;</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">在新的work中添加叔块hash</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;">updateSnapshot</p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">更新快照</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;"><strong><strong>commitTransactions</strong></strong></p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">Mux、 txs、bc、coinbase</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">提交交易</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:106.55pt;"> <p style="margin-left:0pt;"><strong><strong>commitTransaction</strong></strong></p> </td> 
     <td style="vertical-align:top;width:155.35pt;"> <p style="margin-left:0pt;">Tx，bc、coinbase、gp</p> </td> 
     <td style="vertical-align:top;width:152.6pt;"> <p style="margin-left:0pt;">&nbsp;</p> </td> 
    </tr>
   </tbody>
  </table>
  <p style="margin-left:0pt;">&nbsp;</p> 
  <p style="margin-left:0pt;">Work是矿工的执行环境，掌握所有当前状态信息</p> 
  <p style="margin-left:0pt;"><strong><strong>属性</strong></strong>：</p> 
  <table border="1" cellspacing="0" style="width:412.55pt;">
   <tbody>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">属性名</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">类型</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">主要描述</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">config</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">*params.ChainConfig</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">区块链config配置</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">signer</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">types.Signer</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">签名器封装事务签名处理</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">state</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">*state.StateDB</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">网络状态存储</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">ancestors</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">mapset.Set</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">祖先 用于检查叔块父块是否合法</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">family</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">mapset.Set</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">用于检查叔块合法</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">uncles</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">mapset.Set</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">叔块集合</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">gasPool</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">*core.GasPool</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">Gas池 用于打包交易的可用gas值</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Block</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">*types.Block</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">新块儿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">header</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">*types.Header</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">……</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">txs</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">[]*types.Transaction</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">……</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">receipts</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">[]*types.Receipt</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">……</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">createdAt</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">time.Time</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">……</p> </td> 
    </tr>
   </tbody>
  </table>
  <p style="margin-left:0pt;">&nbsp;</p> 
  <p style="margin-left:0pt;">Agent：挖矿代理</p> 
  <p style="margin-left:0pt;"><strong><strong>属性</strong></strong>：</p> 
  <table border="1" cellspacing="0" style="width:412.55pt;">
   <tbody>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">属性名</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">类型</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">主要描述</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">mu</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">sync.Mutex</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">互斥锁</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">workCh</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">chan *Work</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">Work 通道</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">quitCurrentOp</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">chan struct{}</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">取消当前操作</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">returnCh</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">chan&lt;- *Result</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">返回执行结果（work 和区块）</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">chain</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">consensus.ChainReader</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">Uncle核查时提供查询区块链的对象</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Engine</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">consensus.Engine</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">共识处理引擎</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Started</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">Int32</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">指定agent当前是否启动</p> </td> 
    </tr>
   </tbody>
  </table>
  <p style="margin-left:0pt;"><strong><strong>方法：</strong></strong></p> 
  <table border="1" cellspacing="0" style="width:412.55pt;">
   <tbody>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">方法名</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">参数</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">描述</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Work</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">无 返回chan&lt;-*Work</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">返回工作通道</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">SetReturnCh</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">ch</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">设置Work 通道</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Start</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">调用update，启动挖矿</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Stop</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">空</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">清空work</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;">Update</p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">consensus.ChainReader</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">Uncle核查时提供查询区块链的对象</p> </td> 
    </tr>
    <tr>
     <td style="vertical-align:top;width:82.9pt;"> <p style="margin-left:0pt;"><strong><strong>Mine</strong></strong></p> </td> 
     <td style="vertical-align:top;width:129.5pt;"> <p style="margin-left:0pt;">work.&nbsp;stop</p> </td> 
     <td style="vertical-align:top;width:200.15pt;"> <p style="margin-left:0pt;">调用engine.Seal封装交易，打包新块儿</p> </td> 
    </tr>
   </tbody>
  </table>
  <p style="margin-left:0pt;">&nbsp;</p> 
  <p style="margin-left:0pt;">&nbsp;</p> 
  <p style="margin-left:0pt;"><strong><strong>Miner</strong></strong><strong><strong>&nbsp;中</strong></strong><strong><strong>G</strong></strong><strong><strong>as</strong></strong><strong><strong>及gasPrice</strong></strong><strong><strong>相关</strong></strong><strong><strong>重点分析：( bloc</strong></strong><strong><strong>k</strong></strong><strong><strong>header </strong></strong><strong><strong>的</strong></strong><strong><strong>gaslimit来源</strong></strong><strong><strong>commitNewWork</strong></strong><strong><strong>)</strong></strong></p> 
  <p style="margin-left:0pt;">1）从miner、worker、work、agent的相关接口可知并无直接修改或者接受gas、gasprice、gaslimit的直接设定和修改，miner对gas、gasPrice不具有大的自主性修改权限和接收权限</p> 
  <p style="margin-left:0pt;">2）挖矿打包的过程由eth.backend.go实现，其中对象Ethereum处理交易池、区块链存储、共识引擎、矿工、RPC服务等关键操作，值得注意的是ethereum对象包含gasprice对象，但该值初始化配置源于config的默认设置为<span style="color:#ff0000;">big.NewInt(18 * params.Shannon)</span><span style="color:#4c4c4c;">,</span><span style="color:#4c4c4c;">见</span><span style="color:#4c4c4c;">eth.config.go</span><span style="color:#4c4c4c;">文件</span><span style="color:#4c4c4c;">中的DefaultConfig；</span></p> 
  <p style="margin-left:0pt;"><span style="color:#4c4c4c;">3）从commitTransactions函数分析，若新的work </span><span style="color:#4c4c4c;">的</span><span style="color:#4c4c4c;">可用gas值gasPool为nil</span><span style="color:#4c4c4c;">则</span><span style="color:#4c4c4c;">默认将</span><span style="color:#4c4c4c;">work</span><span style="color:#4c4c4c;">正在处理的区块</span><span style="color:#4c4c4c;">儿</span><span style="color:#4c4c4c;">的区块头中的Gaslimit作为该work的gaspool，作为当前</span><span style="color:#4c4c4c;">工作</span><span style="color:#4c4c4c;">的可用gas。</span><span style="color:#4c4c4c;">而</span><span style="color:#4c4c4c;">当前work.</span><span style="color:#4c4c4c;">header</span><span style="color:#4c4c4c;">.Gaslimit</span><span style="color:#4c4c4c;">来源于</span><span style="color:#4c4c4c;">work.</span>&nbsp;<span style="color:#4c4c4c;">commitNewWork()</span><span style="color:#4c4c4c;">中</span><span style="color:#4c4c4c;">core.CalcGasLimit(parent),计算</span><span style="color:#4c4c4c;">机制</span><span style="color:#4c4c4c;">如下：</span></p> 
  <p style="margin-left:0pt;"><span style="color:#4c4c4c;">// contrib = (parentGasUsed * 3 / 2) / 1024，</span><span style="color:#4c4c4c;">当父区块Gas使用量&gt;2/3的时候，会较上次加大gaslimit，反之减小</span><span style="color:#4c4c4c;">；</span></p> 
  <p style="margin-left:0pt;"><span style="color:#4c4c4c;">计算新区块gaslimit的贡献度值contrib := (parent.GasUsed() + parent.GasUsed()/2) / params.GasLimitBoundDivisor（1024）</span></p> 
  <p style="margin-left:0pt;"><span style="color:#4c4c4c;">计算</span><span style="color:#4c4c4c;">衰减</span><span style="color:#4c4c4c;">量：decay = parentGasLimit / 1024 -1</span></p> 
  <ol>
   <li><strong><span style="color:#4c4c4c;"><strong>最后计算得到limit</strong></span></strong><span style="color:#4c4c4c;">&nbsp;:= parent.GasLimit() - decay + contrib</span></li> 
   <li><span style="color:#4c4c4c;">gaslimit &nbsp;</span><span style="color:#4c4c4c;">不可</span><span style="color:#4c4c4c;">小于</span><strong><span style="color:#4c4c4c;"><strong>5000</strong></span></strong><strong>&nbsp;</strong><span style="color:#4c4c4c;">不大于</span><span style="color:#4c4c4c;">创世块儿的gaslimit</span><span style="color:#4c4c4c;">限制</span><span style="color:#4c4c4c;">（</span><strong><span style="color:#4c4c4c;"><strong>4712388</strong></span></strong><span style="color:#4c4c4c;">）</span></li> 
  </ol>
  <p style="margin-left:24pt;">&nbsp;</p> 
  <p style="margin-left:0pt;"><span style="color:#4c4c4c;">此处</span><span style="color:#4c4c4c;">work</span><span style="color:#4c4c4c;">在</span><span style="color:#4c4c4c;">打包时要进行gas判断：env.gasPool.Gas() &lt; params.TxGas（21000），</span><span style="color:#4c4c4c;">每个</span><span style="color:#4c4c4c;">work的gas值（也就是说交易发送者</span><span style="color:#4c4c4c;">提供</span><span style="color:#4c4c4c;">的每笔交易gas）不能低于21000；</span></p> 
  <p style="margin-left:0pt;"><span style="color:#4c4c4c;">commitTransaction</span><span style="color:#4c4c4c;">调用了core.ApplyTransaction</span><span style="color:#4c4c4c;">函数</span><span style="color:#4c4c4c;">，该函数的</span><span style="color:#4c4c4c;">具体</span><span style="color:#4c4c4c;">实现Gas的消耗和奖励机制，</span><span style="color:#4c4c4c;">过程</span><span style="color:#4c4c4c;">如下图：</span></p> 
  <p style="margin-left:0pt;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180816000948377?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2R3anBlbmcy/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <ul>
   <li>ApplyTransaction()&nbsp;首先根据输入参数分别封装出一个Message对象和一个EVM对象；</li> 
   <li>然后加上一个传入的GasPool类型变量，由TransitionDb()函数完成tx的执行，待TransitionDb()返回之后，创建一个收据Receipt对象，最后返回该Recetip对象，以及整个tx执行过程所消耗Gas数量。</li> 
   <li>GasPool对象是在一个Block执行开始时创建，并在该Block内所有tx的执行过程中共享，对于一个tx的执行可视为“全局”存储对象； Message由此次待执行的tx对象转化而来，并携带了解析出的tx的(转帐)转出方地址，属于待处理的数据对象；</li> 
   <li>EVM 作为Ethereum世界里的虚拟机(Virtual Machine)，作为此次tx的实际执行者，完成转帐和合约(Contract)的相关操作。</li> 
  </ul>
  <p style="margin-left:24pt;">&nbsp;</p> 
  <p style="margin-left:0pt;"><span style="color:#4f4f4f;">TransitioinDb()的执行过程(/core/state_transition.go)。假设有StateTransition对象st,&nbsp; 其成员变量initialGas表示初始可用Gas数量，gas表示即时可用Gas数量，初始值均为0，于是st.TransitionDb() 可由以下步骤展开：</span></p> 
  <ol>
   <li><span style="color:#333333;">购买</span><span style="color:#333333;">Gas</span><span style="color:#333333;">。首先从交易的</span><span style="color:#333333;">(</span><span style="color:#333333;">转帐</span><span style="color:#333333;">)</span><span style="color:#333333;">转出方账户扣除一笔</span><span style="color:#333333;">Ether</span><span style="color:#333333;">，</span><span style="color:#333333;">费</span><span style="color:#333333;">用等于</span><span style="color:#333333;">tx.data.GasLimit * tx.data.Price</span><span style="color:#333333;">；同</span><span style="color:#333333;">时</span><span style="color:#333333;">&nbsp;st.initialGas = st.gas = tx.data.GasLimit</span><span style="color:#333333;">；然后</span><span style="color:#333333;">(GasPool) gp -= st.gas</span><span style="color:#333333;">。</span></li> 
   <li><span style="color:#333333;">计算</span><span style="color:#333333;">tx</span><span style="color:#333333;">的固有</span><span style="color:#333333;">Gas</span><span style="color:#333333;">消耗</span><span style="color:#333333;">&nbsp;- intrinsicGas</span><span style="color:#333333;">。它分</span><span style="color:#333333;">为</span><span style="color:#333333;">两个部分，每一个</span><span style="color:#333333;">tx</span><span style="color:#333333;">预设的消耗量，这</span><span style="color:#333333;">个消耗量</span><span style="color:#333333;">还</span><span style="color:#333333;">因</span><span style="color:#333333;">tx</span><span style="color:#333333;">是否含有</span><span style="color:#333333;">(</span><span style="color:#333333;">转帐</span><span style="color:#333333;">)</span><span style="color:#333333;">转入方地址而略有不同；以及针对</span><span style="color:#333333;">tx.data.Payload</span><span style="color:#333333;">的</span><span style="color:#333333;">Gas</span><span style="color:#333333;">消耗，</span><span style="color:#333333;">Payload</span><span style="color:#333333;">类型是</span><span style="color:#333333;">[]byte</span><span style="color:#333333;">，关于它的固有消耗依</span><span style="color:#333333;">赖</span><span style="color:#333333;">于</span><span style="color:#333333;">[]byte</span><span style="color:#333333;">中非</span><span style="color:#333333;">0</span><span style="color:#333333;">字</span><span style="color:#333333;">节</span><span style="color:#333333;">和</span><span style="color:#333333;">0</span><span style="color:#333333;">字</span><span style="color:#333333;">节</span><span style="color:#333333;">的</span><span style="color:#333333;">长</span><span style="color:#333333;">度。最</span><span style="color:#333333;">终</span><span style="color:#333333;">，</span><span style="color:#333333;">st.gas -= intrinsicGas</span></li> 
   <li><span style="color:#333333;">EVM</span><span style="color:#333333;">执行。如果交易的</span><span style="color:#333333;">(</span><span style="color:#333333;">转帐</span><span style="color:#333333;">)</span><span style="color:#333333;">转入方地址</span><span style="color:#333333;">(tx.data.Recipient)</span><span style="color:#333333;">为空，调用</span><span style="color:#333333;">EVM</span><span style="color:#333333;">的</span><span style="color:#333333;">Create()</span><span style="color:#333333;">函数；否</span><span style="color:#333333;">则</span><span style="color:#333333;">，</span><span style="color:#333333;">调</span><span style="color:#333333;">用</span><span style="color:#333333;">Call()</span><span style="color:#333333;">函数。无</span><span style="color:#333333;">论</span><span style="color:#333333;">哪个函数返回后，更新</span><span style="color:#333333;">st.gas</span><span style="color:#333333;">。</span></li> 
   <li><span style="color:#333333;">计算本次执行交易的实际</span><span style="color:#333333;">Gas</span><span style="color:#333333;">消耗：</span><span style="color:#333333;">&nbsp;requiredGas = st.initialGas - st.gas</span></li> 
   <li><strong><span style="color:#333333;"><strong>偿退</strong></span></strong><strong><span style="color:#333333;"><strong>Gas</strong></span></strong><span style="color:#333333;">。它包括两个部分：首先将剩余</span><span style="color:#333333;">st.gas </span><span style="color:#333333;">折算成</span><span style="color:#333333;">Ether</span><span style="color:#333333;">，</span><span style="color:#333333;">归还给</span><span style="color:#333333;">交易的</span><span style="color:#333333;">(</span><span style="color:#333333;">转帐</span><span style="color:#333333;">)</span><span style="color:#333333;">转出方账户；然后，基于实际消耗量</span><span style="color:#333333;">requiredGas</span><span style="color:#333333;">，系</span><span style="color:#333333;">统</span><span style="color:#333333;">提供一定的</span><strong><span style="color:#333333;"><strong>补偿</strong></span></strong><span style="color:#333333;">，数量</span><span style="color:#333333;">为</span><span style="color:#333333;">refundGas</span><span style="color:#333333;">。</span><span style="color:#333333;">refundGas </span><span style="color:#333333;">所折算的</span><span style="color:#333333;">Ether</span><span style="color:#333333;">会被立即加在</span><span style="color:#333333;">(</span><span style="color:#333333;">转帐</span><span style="color:#333333;">)</span><span style="color:#333333;">转出方账户上，同时</span><span style="color:#333333;">st.gas += refundGas</span><span style="color:#333333;">，</span><span style="color:#333333;">gp += st.gas</span><span style="color:#333333;">，即剩余的</span><span style="color:#333333;">Gas</span><span style="color:#333333;">加上系</span><span style="color:#333333;">统补偿</span><span style="color:#333333;">的</span><span style="color:#333333;">Gas</span><span style="color:#333333;">，被一起</span><span style="color:#333333;">归</span><span style="color:#333333;">并</span><span style="color:#333333;">进</span><span style="color:#333333;">GasPool</span><span style="color:#333333;">，供之后的交易</span><span style="color:#333333;">执</span><span style="color:#333333;">行使用。</span></li> 
   <li><strong><span style="color:#333333;"><strong>奖励所属区块的挖掘者</strong></span></strong><span style="color:#333333;">：系</span><span style="color:#333333;">统给</span><span style="color:#333333;">所属区</span><span style="color:#333333;">块</span><span style="color:#333333;">的作者，亦即挖掘者</span><span style="color:#333333;">账户</span><span style="color:#333333;">，增加一笔金</span><span style="color:#333333;">额</span><span style="color:#333333;">，数</span><span style="color:#333333;">额</span><span style="color:#333333;">等于</span><span style="color:#333333;">&nbsp;st.data,Price * (st.initialGas - st.gas)</span><span style="color:#333333;">。注意，</span><span style="color:#333333;">这</span><span style="color:#333333;">里的</span><span style="color:#333333;">st.gas</span><span style="color:#333333;">在步</span><span style="color:#333333;">骤</span><span style="color:#333333;">5</span><span style="color:#333333;">中被加上了</span><span style="color:#333333;">refundGas, </span><span style="color:#333333;">所以</span><span style="color:#333333;">这</span><span style="color:#333333;">笔</span><span style="color:#333333;">奖</span><span style="color:#333333;">励金所</span><span style="color:#333333;">对应</span><span style="color:#333333;">的</span><span style="color:#333333;">Gas</span><span style="color:#333333;">，其数量小于</span><span style="color:#333333;">该</span><span style="color:#333333;">交易</span><span style="color:#333333;">实际</span><span style="color:#333333;">消耗量</span><span style="color:#333333;">requiredGas</span><span style="color:#333333;">。</span></li> 
  </ol> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/dwjpeng2/article/details/81713521,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/dwjpeng2/article/details/81713521,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
