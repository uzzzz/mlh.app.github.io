<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>项目名称：银行ATM存取款机系统设计与实现 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="项目名称：银行ATM存取款机系统设计与实现" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="&nbsp;项目名称：银行ATM存取款机系统设计与实现&nbsp;&nbsp; 一、创建数据库............................................................................................................. 3 1.1创建数据库....................................................................................................... 3 1.2创建各个数据表及相关的约束....................................................................... 3 1.3添加外键约束和生成数据库关系图............................................................... 6 二、创建触发器和插入测试数据................................................................................. 6 2.1创建级联触发器.............................................................................................. 6 2.2插入数据表的测试数据.................................................................................. 9 三、模拟常规业务....................................................................................................... 12 3.1修改客户密码................................................................................................. 12 3.2办理银行卡挂失............................................................................................ 12 3.3统计银行资金流通余额和盈利结算............................................................ 13 3.4查询本周开户信息........................................................................................ 14 3.5查询本月单次交易金额最高的卡号和总交易金额最高的卡号................ 14 3.6查询挂失客户................................................................................................ 15 3.7催款提醒业务................................................................................................ 15 四、创建、使用视图................................................................................................... 16 4.1输出银行客户记录视图VW_userInfo......................................................... 16 4.2输出银行卡记录视图VW_CardInfo............................................................. 16 4.3输出银行卡交易记录视图VW_TransInfo................................................... 17 4.4根据客户登录名查询该客户账户信息VW_OneUserInfo........................... 18 五、存储过程实现业务处理....................................................................................... 18 5.1完成存款或取款业务.................................................................................... 18 5.2产生随机卡号................................................................................................ 21 5.3完成开户业务................................................................................................ 22 5.4分页显示查询交易数据................................................................................ 24 5.5打印客户对账单............................................................................................ 25 5.6统计未发生交易的账户................................................................................ 27 5.7统计银行卡交易量和交易额........................................................................ 30 六、利用事务实现转账............................................................................................... 34 心得体会：................................................................................................................... 39 源代码：....................................................................................................................... 40 创建数据库 -- 创建数据库BankDB -- 数据库文件和日志均保存在 D:\20160107SQL项目练习\银行ATM机器系统\ -- 文件大小为5MB增长15% 日志大小为3MB增长5MB use master if exists(select * from sysdatabases where name=&#39;BankDB&#39;) &nbsp;&nbsp;&nbsp; drop database BankDB go create database BankDB on ( &nbsp;&nbsp;&nbsp; name=&#39;BankDB_Data&#39;, &nbsp;&nbsp;&nbsp; filename=&#39;D:\20160107SQL\项目练习\银行ATM机器系统\BankDB01_Data.mdf&#39;, &nbsp;&nbsp;&nbsp; size=5mb, &nbsp;&nbsp;&nbsp; filegrowth=15% ) log on ( &nbsp;&nbsp;&nbsp; name=&#39;BankDB_Log&#39;, &nbsp;&nbsp;&nbsp; filename=&#39;D:\20160107SQL\项目练习\银行ATM机器系统\BankDB01_Log.ldf&#39;, &nbsp;&nbsp;&nbsp; size=3mb, &nbsp;&nbsp;&nbsp; filegrowth=5mb ) go 创建各个数据表及相关的约束 --创建银行业务类型表BankBusinessType --判断银行业务类型表是否存在,若存在则删除 --创建银行业务类型表，包含银行业务类型编号BBTId主键 自动标识符，银行业务类型名称BBTName char(20) not null，银行业务描述BBTComment varchar(100) use BankDB if exists(select * from sysobjects where name=&#39;BankBusinessType&#39;) &nbsp;&nbsp;&nbsp; drop table BankBusinessType go create table BankBusinessType ( &nbsp;&nbsp;&nbsp; BBTId int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; BBTName char(20) not null, &nbsp;&nbsp;&nbsp; BBTComment varchar(100) ) go --创建银行客户信息表BankCustomer --判断银行卡客户是否存在,若存在则删除 --创建银行客户信息表，包含客户编号BCID 主键 自动标识符，客户姓名BCName char(20) not null，客户身份证BCICNo，客户联系电话BCTel、 客户居住地址BCAddr varchar(100) &nbsp;&nbsp;&nbsp; --定义身份证号前位必须是数字，后位可以是数字或者X。 &nbsp;&nbsp; --定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号，手机号码前面第一位必须是1,第二位必须是[3,5,8,9] if exists(select * from sysobjects where name=&#39;BankCustomer&#39;) &nbsp;&nbsp;&nbsp; drop table BankCustomer go create table BankCustomer ( &nbsp;&nbsp;&nbsp; --客户编号BCID 主键 自动标识符， &nbsp;&nbsp;&nbsp; BCID int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; --客户姓名BCName char(20) not null， &nbsp;&nbsp;&nbsp; BCName char(20) not null, &nbsp;&nbsp;&nbsp; --客户身份证BCICNo， &nbsp;&nbsp;&nbsp; BCICNo char(18) not null, &nbsp;&nbsp;&nbsp; --客户联系电话BCTel &nbsp;&nbsp;&nbsp; BCTel char(12) not null, &nbsp;&nbsp;&nbsp; --客户居住地址BCAddr varchar(100) &nbsp;&nbsp;&nbsp; BCAddr varchar(100) ) go --定义身份证号前位必须是数字，后位可以是数字或者X。 alter table BankCustomer add constraint CK_BCICNo check(BCICNo like replicate(&#39;[0-9]&#39;,17)+replicate(&#39;[0-9xX]&#39;,1)) --定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号， --手机号码前面第一位必须是1,第二位必须是[3,5,8,9] alter table BankCustomer add constraint CK_BCTel check(BCTel like &#39;1&#39;+replicate(&#39;[3589]&#39;,1)+replicate(&#39;[0-9]&#39;,9) or BCTel like replicate(&#39;[0-9]&#39;,3)+&#39;-&#39;+replicate(&#39;[0-9]&#39;,8) or BCTel like replicate(&#39;[0-9]&#39;,4)+&#39;-&#39;+replicate(&#39;[0-9]&#39;,7)) go --建立银行卡信息 BankCard --判断银行卡是否存在，若存在，则删除银行卡BankCard -- 卡号 BCNo char(19) 主键 必须符合16位数字构成,前8位为1010 3576,后位是随机产生且唯一,每4位必须有一个空格 -- 密码&nbsp; BCPwd char(6) not null ,开户默认为&#39;888888&#39; -- 币种&nbsp; BCCurrency char(5) not null, 默认为RMB类型 -- 存款类型 BCBBTId int not null -- 开户日期 BCOpenDate datetime not null,默认当日 -- 开户金额 BCOpenAmount money&nbsp; not null ,不得小于1元 -- 是否挂失 BCRegLoss char(2),默认为否 -- 客户编号 BCBCId intnot null, -- 当前余额 BCExistBalance money not null if exists(select * from sysobjects where name=&#39;BankCard&#39;) &nbsp;&nbsp;&nbsp; drop table BankCard go create table BankCard ( &nbsp;&nbsp;&nbsp; -- 卡号 BCNo char(19) 主键 &nbsp;&nbsp;&nbsp; BCNo char(19) primary key, &nbsp;&nbsp;&nbsp; -- 密码&nbsp; BCPwd char(6) not null ,开户默认为&#39;888888&#39; &nbsp;&nbsp;&nbsp; BCPwd char(6) not null default(&#39;888888&#39;), &nbsp;&nbsp;&nbsp; -- 币种&nbsp; BCCurrency char(5) not null, 默认为RMB类型 &nbsp;&nbsp;&nbsp; BCCurrency char(5) not null&nbsp; default(&#39;RMB&#39;), &nbsp;&nbsp;&nbsp; -- 存款类型 BCBBTId int not null &nbsp;&nbsp;&nbsp; BCBBTId int not null, &nbsp;&nbsp;&nbsp; -- 开户日期 BCOpenDate datetime notnull,默认当日 &nbsp;&nbsp;&nbsp; BCOpenDate date not null default(convert(varchar(10),getdate(),120)), &nbsp;&nbsp;&nbsp; -- 开户金额 BCOpenAmount money&nbsp; not null ,不得小于1元 &nbsp;&nbsp;&nbsp; BCOpenAmountmoney not null check(BCOpenAmount&gt;=1), &nbsp;&nbsp;&nbsp; -- 是否挂失 BCRegLoss char(2),默认为否 &nbsp;&nbsp;&nbsp; BCRegLoss char(2) default(&#39;否&#39;) check(BCRegLoss=&#39;是&#39; or BCRegLoss=&#39;否&#39;), &nbsp;&nbsp;&nbsp; -- 客户编号 BCBCId int not null, &nbsp;&nbsp;&nbsp; BCBCId int not null, &nbsp;&nbsp;&nbsp; -- 当前余额 BCExistBalance moneynot null &nbsp;&nbsp;&nbsp; BCExistBalancemoney not null ) go --卡号必须符合16位数字构成,前8位为1010 3576, --后位是随机产生且唯一,每4位必须有一个空格 alter table BankCard add constraint CK_BCNo check(BCNo like&#39;1010 3576 &#39;+ replicate(&#39;[0-9]&#39;,4)+&#39; &#39;+replicate(&#39;[0-9]&#39;,4)) go --创建交易信息表BankDealInfo &nbsp;--判断交易信息BankDealInfo是否存在,若存在则删除 &nbsp;&nbsp;&nbsp; --交易编号BDNo&nbsp; 为自动增长列 主键 &nbsp;&nbsp;&nbsp; --卡号 BDBCNo char(19) not null &nbsp;&nbsp;&nbsp; --交易日期 BDDealDate Datenot null 默认为当前日期 &nbsp;&nbsp;&nbsp; --交易金额 BDDealAcount money not null &nbsp;&nbsp;&nbsp; --交易类型，有种存入和支取 BDDealType Char(10) not null &nbsp;&nbsp;&nbsp; --交易备注 BDDealComment varchar(100) if exists(select * from sysobjects where name=&#39;BankDealInfo&#39;) &nbsp;&nbsp;&nbsp; drop table BankDealInfo go create table BankDealInfo ( &nbsp;&nbsp;&nbsp; --交易编号BDNo&nbsp; 为自动增长列 主键 &nbsp;&nbsp;&nbsp; BDNo int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; --卡号 BDBCNo char(19) not null &nbsp;&nbsp;&nbsp; BDBCNo char(19) not null, &nbsp;&nbsp;&nbsp; --交易日期 BDDealDate Date notnull 默认为当前日期 &nbsp;&nbsp;&nbsp; BDDealDate Date not null default(convert(varchar(10),getdate(),120)), &nbsp;&nbsp;&nbsp; --交易金额 BDDealAcount money notnull &nbsp;&nbsp;&nbsp; BDDealAcountmoney not null, &nbsp;&nbsp;&nbsp; --交易类型，有种存入和支取 BDDealTypeChar(10) not null &nbsp;&nbsp;&nbsp; BDDealType Char(10) not null check(BDDealType like&#39;存入&#39; &nbsp;&nbsp;&nbsp; or BDDealType like&#39;支取&#39;), &nbsp;&nbsp;&nbsp; --交易备注 BDDealCommentvarchar(100) &nbsp;&nbsp;&nbsp; BDDealCommentvarchar(100) ) Go &nbsp;添加外键约束和生成数据库关系图 --建立表之间的外键约束关系 alter table BankCard add constraint FK_BCBBTIdforeign key(BCBBTId) references BankBusinessType(BBTId) alter table BankCard add constraint FK_BCBCId foreign key(BCBCId) references BankCustomer(BCID) alter table BankDealInfo add constraint FK_BDBCNo foreign key(BDBCNo) references BankCard(BCNo) go &nbsp;创建级联触发器 &nbsp;&nbsp;&nbsp;2.1.1创建Insert触发器 --在交易信息表中插入一个触发器tr_InsertdealInfo，修改银行卡的存款余额 --判断交易记录里是存入还是支取，及时更新银行卡表的存款余额 if exists(select * from sysobjects where name=&#39;tr_InsertdealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_InsertdealInfo&nbsp; go create trigger tr_InsertdealInfo on BankDealInfo for insert as &nbsp;&nbsp;&nbsp; declare @BDDealType Char(10),@BDDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount,@BDBCNo &nbsp;&nbsp;&nbsp; =BDBCNo from inserted &nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@BDDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; end go &nbsp;2.1.2创建Delete触发器 --在交易信息表中插入一个触发器tr_DeldealInfo，当删除一个交易信息，修改银行卡的存款余额 if exists(select * from sysobjects where name=&#39;tr_DeldealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_DeldealInfo go create trigger tr_DeldealInfo on BankDealInfo instead of delete as &nbsp;&nbsp;&nbsp; declare @BDDealType Char(10),@BDDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount,@BDBCNo &nbsp;&nbsp;&nbsp; =BDBCNo from deleted &nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@BDDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@BDDealAcount where BCNo=@BDBCNo go &nbsp;2.1.3创建Update触发器 --在交易信息表中插入一个触发器，修改银行卡的存款余额 --判断交易记录里是存入还是支取，及时更新银行卡表的存款余额 if exists(select * from sysobjects where name=&#39;tr_updatedealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_updatedealInfo&nbsp; go create trigger tr_updatedealInfo on BankDealInfo for update as &nbsp;&nbsp;&nbsp; declare @oldDealType Char(10),@newDealType Char(10),@oldDealAcount &nbsp;&nbsp;&nbsp; money,@newDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDBCNo=BDBCNo,@oldDealType=BDDealType,@oldDealAcount= &nbsp;&nbsp;&nbsp; BDDealAcountfrom deleted &nbsp;&nbsp;&nbsp; select @newDealType=BDDealType,@newDealAcount=BDDealAcount from inserted &nbsp;&nbsp;&nbsp; if(@oldDealType=@newDealAcount) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@oldDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@newDealAcount-@oldDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@oldDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@newDealAcount+@oldDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@newDealAcount+@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; end go 插入数据表的测试数据 --插入表的测试数据 insert into BankBusinessType values(&#39;活期&#39;,&#39;无固定存储期,可随时存款,存款金额不限的一种比较灵活的存款&#39;), (&#39;定活俩便&#39;,&#39;事先不约定存期,一次性存入,一次性取出的存款&#39;), (&#39;通知&#39;,&#39;不约定存期,支取时需要提前通知银行,约定支取时间和金额方能支取的存款&#39;), (&#39;整存整取1年&#39;,&#39;整笔存入,到期提取本息&#39;),(&#39;整存整取2年&#39;,&#39;整笔存入,到期提取本息&#39;), (&#39;整存整取3年&#39;,&#39;整笔存入,到期提取本息&#39;),(&#39;零存整取1年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;零存整取2年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;零存整取3年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;自助转账&#39;, &#39;银行ATM存取款机上办理银行卡之间的相互转账&#39;) select * from BankBusinessType go &nbsp; insert into BankCustomer values(&#39;张飞&#39;,&#39;150203197611154224&#39;,&#39;13088447030&#39;, &#39;包头市昆区宝钢五中&#39;),(&#39;关羽&#39;,&#39;15020319761005123X&#39;,&#39;0472-2315490&#39;, &#39;包头昆区阿尔丁大街&#39;) select * from BankCustomer go &nbsp; insert into BankCard values(&#39;1010 3576 1234 5678&#39;,&#39;197611&#39;,default,1, &#39;2018-05-28&#39;,1000,default,1,1000),(&#39;1010 3576 1234 5688&#39;,&#39;197711&#39;, default,2,&#39;2018-05-28&#39;,1500,default,2,1500) select * from BankCard go &nbsp; insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,500, &#39;存入&#39;,&#39;单位1月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,1500,&#39;存入&#39;, &#39;单位2月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,600,&#39;支取&#39;, &#39;支付宝付款&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,700,&#39;支取&#39;, &#39;刷卡消费&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,3000,&#39;存入&#39;, &#39;单位1月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,2800,&#39;存入&#39;, &#39;单位2月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,1600,&#39;支取&#39;, &#39;支付宝付款&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,900,&#39;支取&#39;, &#39;刷卡消费&#39;) select * from BankDealInfo select * from BankCard go &nbsp;修改客户密码 --修改客户密码 --根据卡号修改指定2个客户的银行密码，其中第一个客户1010 3576 1234 5678密码修改为123456，第二个客户1010 3576 1234 5688修改为123123. update BankCardset BCPwd=&#39;123456&#39; where BCNo=&#39;1010 3576 1234 5678&#39; update BankCardset BCPwd=&#39;123123&#39; where BCNo=&#39;1010 3576 1234 5688&#39; go &nbsp; -- 按照以下字段进行显示 &#39;卡号&#39;, &#39;密码&#39;, &#39;货币类型&#39;, &#39;存储类型&#39;,&#39;开户日期&#39;, &#39;开户金额&#39;,&#39;是否挂失&#39;, &#39;客户编号&#39;,&#39;存款金额&#39; select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BCBBTId as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCRegLoss as 是否挂失,BCBCId as 客户编号,BCExistBalance as 存款金额 from BankCard go 办理银行卡挂失 --办理银行卡挂失 --卡号为1010 3576 1234 5678的银行卡丢失，申请挂失，要求使用innerjoin语句显示如下图运行结果： update BankCardset BCRegLoss=&#39;是&#39; where BCNo=&#39;1010 3576 1234 5688&#39; select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BBTName as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCRegLoss as 是否挂失,BCBCId as 客户编号,BCExistBalance as 存款金额 from BankCard inner join BankBusinessType on BCBBTId=BBTId go 统计银行资金流通余额和盈利结算 -- 使用存储过程 proc_BanlanceAndProfit, -- 统计银行资金流通余额和盈利结算 &nbsp;-- 1.获取总存入金额和总支取金额 盈利余额=总存入金额*0.008-总支取金额*0.003 if exists(select * from sysobjects where name=&#39;proc_BanlanceAndProfit&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_BanlanceAndProfit go create procedure proc_BanlanceAndProfit as &nbsp;&nbsp;&nbsp; declare @inMoney money=0,@outMoney money=0,@i int=1,@BDDealType Char(10), &nbsp;&nbsp;&nbsp; @BDDealAcountmoney &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankDealInfowhere BDNo=@i &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @inMoney+=@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if(@BDDealType=&#39;支取&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @outMoney+=@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; print &#39;存入总金额：&#39;+ltrim(str(@inMoney))+&#39;RMB,支取总金额：&#39;+ &nbsp;&nbsp;&nbsp; ltrim(str(@outMoney))+&#39;RMB&#39; &nbsp;&nbsp;&nbsp; print &#39;盈利余额为：&#39;+ltrim(str(@inMoney*0.008-@outMoney*0.003)) go exec proc_BanlanceAndProfit go 查询本周开户信息 --查询本周开户信息 select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BBTName as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCName as 客户姓名,BCExistBalance as 存款金额,BCRegLoss as 是否挂失,(case when BCRegLoss=&#39;否&#39; then &#39;正常账户&#39; else &#39;挂失账户&#39; end) as 账户状态 from BankCard,BankCustomer,BankBusinessType where BCBBTId=BBTId and BCID=BCBCId and datediff(ww,BCOpenDate,getdate())=0 go 查询本月单次交易金额最高的卡号和总交易金额最高的卡号 代码实现： --查询 --1.本月单次交易金额最高的卡号 select top 1 BDBCNo as 卡号,BCOpenDate as 开户日期,BCOpenAmount as 开户金额 from BankCard,BankDealInfo,BankCustomer where BDBCNo=BCNo and BCID=BCBCId and datediff(mm,BCOpenDate,getdate())=0 order by BDDealAcount desc go &nbsp; --2. 总交易金额最高的卡号 select top 1 BDBCNo as 卡号,BCOpenDate as 开户日期,BCOpenAmount as 开户金额 from BankCard,BankDealInfo,BankCustomer where BDBCNo=BCNo and BCID=BCBCId group by BDBCNo,BCOpenDate,BCOpenAmount order by sum(BDDealAcount) desc go &nbsp;查询挂失客户 --查询挂失客户 --查询挂失账号的客户信息，分别利用子查询in的方式或者内部连接inner join，查询结果如下图所示： select BCName as 客户姓名,BCTel as 客户电话 from BankCustomer where BCID in(select BCBCId from BankCard where BCRegLoss=&#39;是&#39;) go &nbsp;催款提醒业务 --催款提醒业务 --根据某种业务（如代缴电话费、代缴手机费或房贷等）的需要，每个月末，查询出客户账户上余额少于2000元，由银行统一致电催款。 select BCName as 客户姓名,BCTel as 客户电话,BCExistBalance as 客户余额 from BankCustomer inner join BankCard on BCID=BCBCId where BCExistBalance&lt;2000 go 输出银行客户记录视图VW_userInfo 为向客户提供友好的用户界面，使用T-SQL语句创建下面几个视图，并使用这些视图输出各表信息。 &nbsp;--输出银行客户记录视图VW_userInfo &nbsp;--显示的列名全为中文，要求先判断该视图是否存在，若存在，则先删除。结果如下图所示： if exists(select * from sysobjects where name=&#39;VW_userInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_userInfo go create view VW_userInfo as &nbsp;&nbsp;&nbsp; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel &nbsp;&nbsp;&nbsp; as 电话号码,BCAddr as 居住地址 from BankCustomer go select * from VW_userInfo go 输出银行卡记录视图VW_CardInfo --(2)输出银行卡记录视图VW_CardInfo if exists(select * from sysobjects where name=&#39;VW_CardInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_CardInfo go create view VW_CardInfo as &nbsp;&nbsp;&nbsp; select BCNo as 卡号,BCName as 开户名,BCCurrency as 货币类型,BBTName as &nbsp;&nbsp;&nbsp; 存储类型,BCOpenDate as 开户日期,BCExistBalance as 存款金额,BCPwd as 密码 &nbsp;&nbsp;&nbsp; ,BCRegLoss as 是否挂失 from BankCard,BankBusinessType,BankCustomer &nbsp;&nbsp;&nbsp; where BBTId=BCBBTId and BCID=BCBCId go select * from VW_CardInfo go 输出银行卡交易记录视图VW_TransInfo --输出银行卡交易记录视图VW_TransInfo --查询该视图，结果如下图所示： if exists(select * from sysobjects where name=&#39;VW_TransInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_TransInfo go create view VW_TransInfo as &nbsp;&nbsp;&nbsp; select BDDealDate as 交易日期,BDDealType as 交易类型,BDBCNo as 交易卡号, &nbsp;&nbsp;&nbsp; BDDealAcountas 交易金额,BDDealComment as 备注 from BankDealInfo go select * from VW_TransInfo go 根据客户登录名查询该客户账户信息VW_OneUserInfo --根据客户登录名查询该客户账户信息VW_OneUserInfo if exists(select * from sysobjects where name=&#39;VW_OneUserInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_OneUserInfo go create view VW_OneUserInfo as &nbsp;&nbsp;&nbsp; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel &nbsp;&nbsp;&nbsp; as 电话号码,BCAddr as 居住地址 from BankCustomer where BCName=system_user go select * from VW_OneUserInfo go 完成存款或取款业务 描述： Ø&nbsp; 根据银行卡号和交易金额实现银行卡的存款和取款业务。 Ø&nbsp; 每一笔存款，取款业务都要计入银行交易账户，并同时更新客户的存款余额。 Ø&nbsp; 如果是取款业务，在记账之前，要完成下面两项数据的检查验证工作，如果检查不合格，那么中断取款业务，给出提示信息后退出。 ²&nbsp; 检查客户输入的密码是否正确。 ²&nbsp; 账户取款金额是否大于当前存款额加1。 要求： Ø&nbsp; 取款或存款存储过程名为usp_takeMoney。 Ø&nbsp; 编写一个存储过程完成存款和取款业务，并调用存储过程取钱或者存钱进行测试，测试数据是张飞的卡号支取100元（密码123456），关羽的卡号存入2100元。 Ø&nbsp; &nbsp; --创建存取款业务的存储过程proc_TakeMoney --完成存款或取款业务 if exists(select * from sysobjects where name=&#39;proc_TakeMoney&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_TakeMoney go create procedure proc_TakeMoney @bcno char(19),@saleMoney money,@pwd char(6)=null as &nbsp;&nbsp;&nbsp; declare @existBanlance money,@errorCount int =0 &nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp; select @existBanlance=BCExistBalance from BankCard where BCNo=@bcno &nbsp;&nbsp;&nbsp; --不返回受影响的行数 &nbsp;&nbsp;&nbsp; set nocount on &nbsp;&nbsp;&nbsp; print &#39;交易前，卡号&#39;+@bcno+&#39;，余额为：&#39;+ltrim(str(@existBanlance)) &nbsp;&nbsp;&nbsp; print &#39;交易正进行，请稍后...&#39; &nbsp;&nbsp;&nbsp; --如果输入参数@pwd为空，则为存款业务，否则为取款业务 &nbsp;&nbsp;&nbsp; if (@pwd is not null) &nbsp;&nbsp;&nbsp; begin&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --1. 办理取款业务 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断指定卡号和密码是否存在，若存在，则可以取款，否则不能办理取款业务 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断取款金额是否小于等于存款余额-1，若条件成立，则可以取款，否则不能取款 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if exists(select * from BankCard where BCNo=@bcno and BCPwd=@pwd) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(money,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@bcno and BCPwd=@pwd))-1&lt;=@saleMoney) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;存款余额不足，不能办理取款业务！！&#39;,15,1) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set@existBanlance-=@saleMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insertinto BankDealInfovalues(@bcno,default,@saleMoney,&#39;支取&#39;,&#39;取款&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set@errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;不能办理取款业务！！&#39;,15,1) &nbsp;&nbsp;&nbsp; end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --2. 办理存款业务 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --判断事务处理里是否有异常，若没有异常，则提交，若有异常，则回滚 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断该交易为何种类型业务，若是存款，则现有余额等于原有余额加上存款金额 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @existBanlance+=@saleMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@bcno,default,@saleMoney,&#39;存入&#39;,&#39;存款&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollback tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;支取失败！！&#39;,18,2) &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit tran &nbsp;&nbsp;&nbsp; print &#39;交易成功，交易金额为：&#39;+ltrim(str(@saleMoney)) &nbsp;&nbsp;&nbsp; print &#39;卡号&#39;+@bcno+&#39;，余额为：&#39;+ltrim(str(@existBanlance)) go --执行存款存储过程 exec proc_TakeMoney&#39;1010 3576 1234 5678&#39;,2100 --执行取款存储过程 exec proc_TakeMoney&#39;1010 3576 1234 5678&#39;,100,&#39;123456&#39; select * from BankCard select * from BankDealInfo go 产生随机卡号 --使用存储过程 Proc_randCardID&nbsp;&nbsp; 产生随机卡号 --随机生成后8位卡号 &nbsp;[rand() 随机数 ] -- 再把前面的8位补上 &#39;1010 3576&#39; -- 最后判断卡号是否存在,如果存在则重新生成卡号的过程 if exists(select * from sysobjects where name=&#39;proc_randCardId&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_randCardId go create procedure proc_randCardId @myCardId1varchar(19) output as &nbsp;&nbsp;&nbsp; while(1=1) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @num1 char(4),@num2 char(4) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num1=convert(int,rand()*10000) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num2=convert(int,rand()*10000) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num1=replicate(0,4-len(@num1))+@num1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num2=replicate(0,4-len(@num2))+@num2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @myCardId1=&#39;1010 3576 &#39;+@num1+&#39; &#39;+@num2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@myCardId1 not in(select BCNo from BankCard)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break &nbsp;&nbsp;&nbsp; end go declare @myCardId1 varchar(19) exec proc_randCardId@myCardId1 output print &#39;产生随机卡号为:&#39;+@myCardId1 go 完成开户业务 描述： Ø&nbsp; 利用存储过程为客户开设2个银行卡账户，开户时需要提供客户的信息有：开户名、身份证号、电话号码、开户金额、存款类型和地址。客户的信息见表所示： Ø&nbsp; 为成功开户的客户提供银行卡，且银行卡号唯一。 要求： Ø&nbsp; 开户的存储过程名为usp_openAccount。 Ø&nbsp; 使用下面的数据执行该存储过程，进行测试：调用此存储过程开户。 --完成开户业务 --创建开户存储过程usp_openAccount，输入参数分别是开户名、身份证号、 --电话号码、开户金额、存款类型和地址 if exists(select * from sysobjects where name=&#39;usp_openAccount&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_openAccount go create procedure usp_openAccount @BCNamechar(20),@BCICNo char(18), @BCTel char(12),@BCOpenAmount money,@BBTName char(20),@BCAddr varchar(100) as &nbsp;&nbsp;&nbsp; --先判断存款类型是否正确 &nbsp;&nbsp;&nbsp; if exists(select BBTName from BankBusinessType whereBBTName=@BBTName) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @errorCount int =0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --插入一条客户信息记录&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankCustomer values(@BCName,@BCICNo,@BCTel,@BCAddr) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --得到刚插入的客户信息的编号 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BCID int,@BCNo char(19) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BCID=max(BCID) from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --插入一条新开银行卡记录 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exec proc_randCardId@BCNo output&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankCard values(@BCNo,default,default,(select BBTId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankBusinessTypewhere BBTName=@BBTName),default,@BCOpenAmount,default, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BCID,@BCOpenAmount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断上述事务操作是否有异常 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --1.如果错误 &#39;尊敬的客户，开户不成功，所有操作均撤销&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;尊敬的客户，开户不成功，所有操作均撤销！！&#39;,18,2) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- 2. 如果成功 &#39;尊敬的客户，开户成功，系统为你产生的 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --随机卡号是&#39;+@BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print&#39;尊敬的客户，开户成功，系统为你产生的&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print&#39;随机卡号是&#39;+@BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; committran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --错误显示 &#39;尊敬的客户，未能成功开户，存款类型不正确，请重新输入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;尊敬的客户，未能成功开户，存款类型不正确，请重新输入&#39;,15,1) go --执行开户过程 exec dbo.usp_openAccount&#39;周公旦&#39;,&#39;150203197510074339&#39;,&#39;0472-2457890&#39;,&#39;1200.00&#39;, &#39;定活俩便&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;姬昌&#39;,&#39;150203197610174339&#39;,&#39;0472-2457890&#39;,&#39;1300.00&#39;, &#39;活期&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;白天磊&#39;,&#39;150207199301252316&#39;,&#39;18347261609&#39;,&#39;10000000&#39;, &#39;通知&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;白天帅&#39;,&#39;150203197510074339&#39;,&#39;15102274286&#39;,&#39;1200.00&#39;, &#39;定活俩便&#39;,&#39;天津&#39; go &nbsp; --显示开户的客户信息和银行卡信息 --&#39;客户编号&#39;, &#39;开户名&#39;, &#39;身份证号&#39;, &#39;电话号码&#39;, &#39;居住地址&#39;, --&#39;卡号&#39;, &#39;客户&#39;, &#39;货币种类&#39;, &#39;存款类型&#39;, &#39;余额&#39;, &#39;密码&#39;, &#39;是否挂失&#39; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel as 电话号码,BCAddr as 居住地址 from BankCustomer go &nbsp; select BCNo as 卡号,BCName as 客户,BCCurrency as 货币类型,BBTName as 存款类型,BCExistBalance as 余额,BCPwd as 密码,BCRegLoss as 是否挂失 from BankCard,BankBusinessType,BankCustomer where BBTId=BCBBTId and BCID=BCBCId go 分页显示查询交易数据 --分页显示查询交易数据 --根据指定的页数和每页的记录数分页显示交易数据。要求： -- 显示第2页 的5条信息 if exists(select * from sysobjects where name=&#39;usp_PagingDisplay&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_PagingDisplay go create procedure usp_PagingDisplay @pageint,@info int as &nbsp;&nbsp;&nbsp; select top(@page*@info) * from BankDealInfo where BDNo not in(select &nbsp;&nbsp;&nbsp; top((@page-1)*@info) BDNo from BankDealInfo) go exec usp_PagingDisplay2,5 go 打印客户对账单 为某个特定的银行卡号打印指定时间内发生交易的对账单。要求如下： Ø&nbsp; 存储过程名称是usp_CheckSheet。 Ø&nbsp; 分别采用以下两种方式执行存储过程，结果如下图所示。 ²&nbsp; 如果不指定交易时间段，那么打印指定卡号的所有交易记录，如测试命令：exec&nbsp; usp_CheckSheet &#39;1010 3576 1234 5688&#39; &nbsp; ²&nbsp; 如果指定交易时间段，那么打印指定卡号在指定时间内发生的所有交易记录，如测试命令： --（5）打印客户对账单 --创建客户对账单的存储过程usp_CheckSheet --判断客户对账单存储过程是否存在，若是存在，则删除 if exists(select * from sysobjects where name=&#39;usp_CheckSheet&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_CheckSheet go create procedure usp_CheckSheet @BCNo char(19),@startTime date=null, @endTime date=null as &nbsp;&nbsp;&nbsp; declare @BCName char(20),@BCCurrency char(5),@BBTName char(20), &nbsp;&nbsp;&nbsp; @BCOpenDate date,@i int=0 &nbsp;&nbsp;&nbsp; select @BCName=BCName,@BCCurrency=BCCurrency,@BBTName=BBTName, &nbsp;&nbsp;&nbsp; @BCOpenDate=BCOpenDate from BankCustomer,BankBusinessType,BankCard &nbsp;&nbsp;&nbsp; where BCID=BCBCId and BBTId=BCBBTId and BCNo=@BCNo &nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@BCNo &nbsp;&nbsp;&nbsp; print &#39;姓名：&#39;+@BCName &nbsp;&nbsp;&nbsp; print &#39;货币：&#39;+@BCCurrency &nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@BBTName &nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@BCOpenDate) &nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+&#39;类型&nbsp;&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp; --打印客户对账单 &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BDDealDate date,@BDDealType char(10),@BDDealAcount money, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BDDealCommentvarchar(100) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@startTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(dd,-convert(int,datename(dd,getdate()))+1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getdate()) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BDDealDate=BDDealDate,@BDDealType=BDDealType,@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =BDDealAcount,@BDDealComment=BDDealComment from BankDealInfo where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDBCNo=@BCNo and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (dd,@endTime,BDDealDate)&lt;=0 and BDNo=@i &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@BDDealDate is not null and @BDDealType is not null and @BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is not null and @BDDealComment is not null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printrtrim(convert(char,@BDDealDate))+&#39;&nbsp;&nbsp;&nbsp; &#39;+rtrim(ltrim(@BDDealType)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +&#39;&nbsp;&nbsp;&nbsp; &#39;+ltrim(convert(char,@BDDealAcount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+@BDDealComment &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealDate=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealType=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealAcount=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealComment=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end go --执行打印客户对账单 exec usp_CheckSheet&#39;1010 3576 1234 5688&#39;,&#39;2018-05-15&#39;,&#39;2018-06-15&#39; exec usp_CheckSheet&#39;1010 3576 1234 5678&#39; go 统计未发生交易的账户 查询统计指定时间段内没有发生交易的账户信息。 要求： 存储过程名称是usp_getWithoutTrade。 指定时间段 如果没有指定起始日期，那么自本月1日开始进行统计，如果没有指定终止日期，那么截止到当日为止。 要求采用游标技术打印未发生交易的客户信息，参考客户对账单的代码。 该存储过程的执行结果如下图所示 --统计未发生交易的账户 if exists(select * from sysobjects where name=&#39;usp_getWithoutTrade&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_getWithoutTrade go create procedure usp_getWithoutTrade @startTimedate=null,@endTime date=null as begin &nbsp;&nbsp;&nbsp; if(@startTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(dd,-convert(int,datename(dd,getdate()))+1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getdate()) &nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp; declare cur_BankCustomer cursorforward_only forselect distinct &nbsp;&nbsp;&nbsp; BCID,BCName,BCICNo,BCTel,BCAddr from BankCustomer inner join &nbsp;&nbsp;&nbsp; BankCard on BCID=BCBCId where BCNo not in(select BDBCNo &nbsp;&nbsp;&nbsp; from BankDealInfo where datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0) &nbsp;&nbsp;&nbsp; open cur_BankCustomer &nbsp;&nbsp;&nbsp; declare @i int=0,@BCExistBalance money,@sumMoney money=0 &nbsp;&nbsp;&nbsp; print &#39;客户编号&nbsp;&nbsp; &#39;+&#39;客户姓名&nbsp;&nbsp; &#39;+&#39;身份证号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp;&nbsp; 电话号码&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp;&nbsp; 地址&#39; &nbsp;&nbsp;&nbsp; while(1=1) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BCID int,@BCName char(20),@BCICNo char(18),@BCTel char(12), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BCAddr varchar(20) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fetch next from cur_BankCustomer into@BCID,@BCName,@BCICNo,@BCTel,@BCAddr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @@fetch_status&lt;&gt;0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(11),@BCID)+rtrim(@BCName)+&#39;&nbsp;&nbsp;&nbsp; &#39;+@BCICNo+&#39;&nbsp;&nbsp;&nbsp; &#39;+@BCTel+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp; &#39;+@BCAddr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BCExistBalance=BCExistBalance from BankCard where BCBCId=@BCID &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumMoney+=@BCExistBalance &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; close cur_BankCustomer &nbsp;&nbsp;&nbsp; deallocate cur_BankCustomer &nbsp;&nbsp;&nbsp; print &#39;统计为发生交易的人数：&#39;+ltrim(str(@i))+&#39;人,客户总余额为：&#39;+ &nbsp;&nbsp;&nbsp; ltrim(str(@sumMoney))+&#39;元&#39; end go&nbsp; exec usp_getWithoutTrade&#39;2018-05-28&#39;,&#39;2018-05-28&#39; go 统计银行卡交易量和交易额 统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。 要求： Ø&nbsp; 存储过程名称是usp_getTradeInfo。 Ø&nbsp; 指定时间段和客户所在区域 如果没有指定起始日期，那么自当年1月1日开始统计，如果没有指定终止日期，那么以当日作为截止日。 如果没有指定地点（根据客户所在地址查询），如北京，那么统计全部客户的交易量和交易额。 --(7)统计银行卡交易量和交易额 --统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。 if exists(select * from sysobjects where name=&#39;usp_getTradeInfo&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_getTradeInfo go create procedure usp_getTradeInfo @startTimedate=null,@endTime date=null, @addr varchar(100)=null as &nbsp;&nbsp;&nbsp; declare @inCount int=0,@outCount int=0,@inMoney money=0,@outMoney money=0, &nbsp;&nbsp;&nbsp; @sumInMoney money=0,@sumOutMoney money=0,@i int=1 &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@startTime is null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(mm,-convert(int,datename(mm,getdate())) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +1,dateadd(dd,-convert(int,datename(dd,getdate()))+1,getdate())) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@addr is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inCount=count(*) from BankDealInfo where BDDealType=&#39;存入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;存入&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumInMoney+=@inMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outCount=count(*) from BankDealInfo where BDDealType=&#39;支取&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;支取&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumOutMoney+=@outMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inCount=count(*) from BankDealInfo where BDDealType=&#39;存入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 and BDBCNo in(select BCNo from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBCIdin(select BCID from BankCustomer where BCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;存入&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 and BDBCNo in(select BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from BankCard where BCBCId in(select BCID from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumInMoney+=@inMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outCount=count(*) from BankDealInfo where BDDealType=&#39;支取&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 and BDBCNo in(select BCNo from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBCIdin(select BCID from BankCustomer where BCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;支取&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 and BDBCNo in(select BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from BankCard where BCBCId in(select BCID from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumOutMoney+=@outMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;统计银行卡交易量和交易额&#39; &nbsp;&nbsp;&nbsp; print &#39;起始日期：&#39;+convert(char(21),@startTime)+&#39;截止日期：&#39;+convert(char,@endTime) &nbsp;&nbsp;&nbsp; print &#39;存入笔数：&#39;+ltrim(str(@inCount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 存入金额：&#39; &nbsp;&nbsp;&nbsp; +ltrim(str(@sumInMoney)) &nbsp;&nbsp;&nbsp; print &#39;支出笔数：&#39;+ltrim(str(@outCount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 支出金额：&#39; &nbsp;&nbsp;&nbsp; +ltrim(str(@sumOutMoney)) &nbsp;&nbsp;&nbsp; print &#39;交易总笔数：&#39;+ltrim(str(@inCount+@outCount)) &nbsp;&nbsp;&nbsp; print &#39;结余金额：&#39;+ltrim(str(@sumInMoney-@sumOutMoney)) &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; go exec usp_getTradeInfo exec usp_getTradeInfo@addr=&#39;包头市昆区宝钢五中&#39; exec usp_getTradeInfo&#39;2018-05-1&#39;,&#39;2018-05-28&#39; exec usp_getTradeInfo&#39;2018-05-1&#39;,&#39;2018-12-30&#39;,&#39;包头市昆区宝钢五中&#39; exec usp_getTradeInfo@addr=&#39;内蒙古包头&#39; go 利用事务实现转账 使用存储过程和事务实现转账业务，操作步骤如下所示： (1) 从某一个账户支取一定金额的存款。 (2) 将支取金额存入到另一个指定的账户中。 (3) 分别打印此笔业务的转出账单和转入账单。 &nbsp;&nbsp; 要求： (1) &nbsp;存储过程名称是usp_transfer。 (2) 要求使用事务机制实现转账业务。 if exists(select * from sysobjects where name=&#39;usp_transfer&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_transfer go create procedure usp_transfer @outBCNochar(19),@inBCNo char(19),@saleMoney money as &nbsp;&nbsp;&nbsp; declare @errorCount int =0,@outBCExistBalance money,@inBCExistBalance money &nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp; --不返回受影响的行数 &nbsp;&nbsp;&nbsp; set nocount on &nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@outBCNo,default,@saleMoney,&#39;支取&#39;,&#39;通过存储&#39;) &nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@inBCNo,default,@saleMoney,&#39;存入&#39;,&#39;通过存储&#39;) &nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollback tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;转账失败！！&#39;,18,2) &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开始转账，请稍后...&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易正进行，请稍后...&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易成功，交易金额：&#39;+ltrim(str(@saleMoney)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCExistBalance=BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@outBCNo+&#39;&nbsp;&nbsp;&nbsp; 余额：&#39;+ltrim(str(@outBCExistBalance)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCExistBalance=BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@inBCNo+&#39;&nbsp;&nbsp;&nbsp; 余额：&#39;+ltrim(str(@inBCExistBalance)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @outBCName char(20),@outBCCurrency char(5),@outBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char(20),@outBCOpenDate date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCName=BCName from BankCustomer where BCID=(select BCBCId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@outBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCCurrency=BCCurrency,@outBCOpenDate=BCOpenDate from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBBTName=BBTName from BankBusinessType whereBBTId=(select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBBTId from BankCard where BCNo=@outBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;打印出转出对账单&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;货币类型：&#39;+@outBCCurrency &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@outBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@outBCOpenDate) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp; 类型&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(10),getdate(),120)+&#39;&nbsp; 支取&nbsp;&nbsp; &#39;+ltrim(str(@saleMoney))+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过存储&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @inBCName char(20),@inBCCurrency char(5),@inBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char(20),@inBCOpenDate date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCName=BCName from BankCustomer where BCID=(select BCBCId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@inBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCCurrency=BCCurrency,@inBCOpenDate=BCOpenDate from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBBTName=BBTName from BankBusinessType whereBBTId=(select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBBTId from BankCard where BCNo=@inBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;打印出转入对账单&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;货币类型：&#39;+@inBCCurrency &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@inBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@inBCOpenDate) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp; 类型&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(10),getdate(),120)+&#39;&nbsp; 存入&nbsp;&nbsp; &#39;+ltrim(str(@saleMoney))+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过存储&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end go exec usp_transfer&#39;1010 3576 1234 5678&#39;,&#39;1010 3576 1234 5688&#39;,100 go 阅读更多" />
<meta property="og:description" content="&nbsp;项目名称：银行ATM存取款机系统设计与实现&nbsp;&nbsp; 一、创建数据库............................................................................................................. 3 1.1创建数据库....................................................................................................... 3 1.2创建各个数据表及相关的约束....................................................................... 3 1.3添加外键约束和生成数据库关系图............................................................... 6 二、创建触发器和插入测试数据................................................................................. 6 2.1创建级联触发器.............................................................................................. 6 2.2插入数据表的测试数据.................................................................................. 9 三、模拟常规业务....................................................................................................... 12 3.1修改客户密码................................................................................................. 12 3.2办理银行卡挂失............................................................................................ 12 3.3统计银行资金流通余额和盈利结算............................................................ 13 3.4查询本周开户信息........................................................................................ 14 3.5查询本月单次交易金额最高的卡号和总交易金额最高的卡号................ 14 3.6查询挂失客户................................................................................................ 15 3.7催款提醒业务................................................................................................ 15 四、创建、使用视图................................................................................................... 16 4.1输出银行客户记录视图VW_userInfo......................................................... 16 4.2输出银行卡记录视图VW_CardInfo............................................................. 16 4.3输出银行卡交易记录视图VW_TransInfo................................................... 17 4.4根据客户登录名查询该客户账户信息VW_OneUserInfo........................... 18 五、存储过程实现业务处理....................................................................................... 18 5.1完成存款或取款业务.................................................................................... 18 5.2产生随机卡号................................................................................................ 21 5.3完成开户业务................................................................................................ 22 5.4分页显示查询交易数据................................................................................ 24 5.5打印客户对账单............................................................................................ 25 5.6统计未发生交易的账户................................................................................ 27 5.7统计银行卡交易量和交易额........................................................................ 30 六、利用事务实现转账............................................................................................... 34 心得体会：................................................................................................................... 39 源代码：....................................................................................................................... 40 创建数据库 -- 创建数据库BankDB -- 数据库文件和日志均保存在 D:\20160107SQL项目练习\银行ATM机器系统\ -- 文件大小为5MB增长15% 日志大小为3MB增长5MB use master if exists(select * from sysdatabases where name=&#39;BankDB&#39;) &nbsp;&nbsp;&nbsp; drop database BankDB go create database BankDB on ( &nbsp;&nbsp;&nbsp; name=&#39;BankDB_Data&#39;, &nbsp;&nbsp;&nbsp; filename=&#39;D:\20160107SQL\项目练习\银行ATM机器系统\BankDB01_Data.mdf&#39;, &nbsp;&nbsp;&nbsp; size=5mb, &nbsp;&nbsp;&nbsp; filegrowth=15% ) log on ( &nbsp;&nbsp;&nbsp; name=&#39;BankDB_Log&#39;, &nbsp;&nbsp;&nbsp; filename=&#39;D:\20160107SQL\项目练习\银行ATM机器系统\BankDB01_Log.ldf&#39;, &nbsp;&nbsp;&nbsp; size=3mb, &nbsp;&nbsp;&nbsp; filegrowth=5mb ) go 创建各个数据表及相关的约束 --创建银行业务类型表BankBusinessType --判断银行业务类型表是否存在,若存在则删除 --创建银行业务类型表，包含银行业务类型编号BBTId主键 自动标识符，银行业务类型名称BBTName char(20) not null，银行业务描述BBTComment varchar(100) use BankDB if exists(select * from sysobjects where name=&#39;BankBusinessType&#39;) &nbsp;&nbsp;&nbsp; drop table BankBusinessType go create table BankBusinessType ( &nbsp;&nbsp;&nbsp; BBTId int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; BBTName char(20) not null, &nbsp;&nbsp;&nbsp; BBTComment varchar(100) ) go --创建银行客户信息表BankCustomer --判断银行卡客户是否存在,若存在则删除 --创建银行客户信息表，包含客户编号BCID 主键 自动标识符，客户姓名BCName char(20) not null，客户身份证BCICNo，客户联系电话BCTel、 客户居住地址BCAddr varchar(100) &nbsp;&nbsp;&nbsp; --定义身份证号前位必须是数字，后位可以是数字或者X。 &nbsp;&nbsp; --定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号，手机号码前面第一位必须是1,第二位必须是[3,5,8,9] if exists(select * from sysobjects where name=&#39;BankCustomer&#39;) &nbsp;&nbsp;&nbsp; drop table BankCustomer go create table BankCustomer ( &nbsp;&nbsp;&nbsp; --客户编号BCID 主键 自动标识符， &nbsp;&nbsp;&nbsp; BCID int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; --客户姓名BCName char(20) not null， &nbsp;&nbsp;&nbsp; BCName char(20) not null, &nbsp;&nbsp;&nbsp; --客户身份证BCICNo， &nbsp;&nbsp;&nbsp; BCICNo char(18) not null, &nbsp;&nbsp;&nbsp; --客户联系电话BCTel &nbsp;&nbsp;&nbsp; BCTel char(12) not null, &nbsp;&nbsp;&nbsp; --客户居住地址BCAddr varchar(100) &nbsp;&nbsp;&nbsp; BCAddr varchar(100) ) go --定义身份证号前位必须是数字，后位可以是数字或者X。 alter table BankCustomer add constraint CK_BCICNo check(BCICNo like replicate(&#39;[0-9]&#39;,17)+replicate(&#39;[0-9xX]&#39;,1)) --定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号， --手机号码前面第一位必须是1,第二位必须是[3,5,8,9] alter table BankCustomer add constraint CK_BCTel check(BCTel like &#39;1&#39;+replicate(&#39;[3589]&#39;,1)+replicate(&#39;[0-9]&#39;,9) or BCTel like replicate(&#39;[0-9]&#39;,3)+&#39;-&#39;+replicate(&#39;[0-9]&#39;,8) or BCTel like replicate(&#39;[0-9]&#39;,4)+&#39;-&#39;+replicate(&#39;[0-9]&#39;,7)) go --建立银行卡信息 BankCard --判断银行卡是否存在，若存在，则删除银行卡BankCard -- 卡号 BCNo char(19) 主键 必须符合16位数字构成,前8位为1010 3576,后位是随机产生且唯一,每4位必须有一个空格 -- 密码&nbsp; BCPwd char(6) not null ,开户默认为&#39;888888&#39; -- 币种&nbsp; BCCurrency char(5) not null, 默认为RMB类型 -- 存款类型 BCBBTId int not null -- 开户日期 BCOpenDate datetime not null,默认当日 -- 开户金额 BCOpenAmount money&nbsp; not null ,不得小于1元 -- 是否挂失 BCRegLoss char(2),默认为否 -- 客户编号 BCBCId intnot null, -- 当前余额 BCExistBalance money not null if exists(select * from sysobjects where name=&#39;BankCard&#39;) &nbsp;&nbsp;&nbsp; drop table BankCard go create table BankCard ( &nbsp;&nbsp;&nbsp; -- 卡号 BCNo char(19) 主键 &nbsp;&nbsp;&nbsp; BCNo char(19) primary key, &nbsp;&nbsp;&nbsp; -- 密码&nbsp; BCPwd char(6) not null ,开户默认为&#39;888888&#39; &nbsp;&nbsp;&nbsp; BCPwd char(6) not null default(&#39;888888&#39;), &nbsp;&nbsp;&nbsp; -- 币种&nbsp; BCCurrency char(5) not null, 默认为RMB类型 &nbsp;&nbsp;&nbsp; BCCurrency char(5) not null&nbsp; default(&#39;RMB&#39;), &nbsp;&nbsp;&nbsp; -- 存款类型 BCBBTId int not null &nbsp;&nbsp;&nbsp; BCBBTId int not null, &nbsp;&nbsp;&nbsp; -- 开户日期 BCOpenDate datetime notnull,默认当日 &nbsp;&nbsp;&nbsp; BCOpenDate date not null default(convert(varchar(10),getdate(),120)), &nbsp;&nbsp;&nbsp; -- 开户金额 BCOpenAmount money&nbsp; not null ,不得小于1元 &nbsp;&nbsp;&nbsp; BCOpenAmountmoney not null check(BCOpenAmount&gt;=1), &nbsp;&nbsp;&nbsp; -- 是否挂失 BCRegLoss char(2),默认为否 &nbsp;&nbsp;&nbsp; BCRegLoss char(2) default(&#39;否&#39;) check(BCRegLoss=&#39;是&#39; or BCRegLoss=&#39;否&#39;), &nbsp;&nbsp;&nbsp; -- 客户编号 BCBCId int not null, &nbsp;&nbsp;&nbsp; BCBCId int not null, &nbsp;&nbsp;&nbsp; -- 当前余额 BCExistBalance moneynot null &nbsp;&nbsp;&nbsp; BCExistBalancemoney not null ) go --卡号必须符合16位数字构成,前8位为1010 3576, --后位是随机产生且唯一,每4位必须有一个空格 alter table BankCard add constraint CK_BCNo check(BCNo like&#39;1010 3576 &#39;+ replicate(&#39;[0-9]&#39;,4)+&#39; &#39;+replicate(&#39;[0-9]&#39;,4)) go --创建交易信息表BankDealInfo &nbsp;--判断交易信息BankDealInfo是否存在,若存在则删除 &nbsp;&nbsp;&nbsp; --交易编号BDNo&nbsp; 为自动增长列 主键 &nbsp;&nbsp;&nbsp; --卡号 BDBCNo char(19) not null &nbsp;&nbsp;&nbsp; --交易日期 BDDealDate Datenot null 默认为当前日期 &nbsp;&nbsp;&nbsp; --交易金额 BDDealAcount money not null &nbsp;&nbsp;&nbsp; --交易类型，有种存入和支取 BDDealType Char(10) not null &nbsp;&nbsp;&nbsp; --交易备注 BDDealComment varchar(100) if exists(select * from sysobjects where name=&#39;BankDealInfo&#39;) &nbsp;&nbsp;&nbsp; drop table BankDealInfo go create table BankDealInfo ( &nbsp;&nbsp;&nbsp; --交易编号BDNo&nbsp; 为自动增长列 主键 &nbsp;&nbsp;&nbsp; BDNo int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; --卡号 BDBCNo char(19) not null &nbsp;&nbsp;&nbsp; BDBCNo char(19) not null, &nbsp;&nbsp;&nbsp; --交易日期 BDDealDate Date notnull 默认为当前日期 &nbsp;&nbsp;&nbsp; BDDealDate Date not null default(convert(varchar(10),getdate(),120)), &nbsp;&nbsp;&nbsp; --交易金额 BDDealAcount money notnull &nbsp;&nbsp;&nbsp; BDDealAcountmoney not null, &nbsp;&nbsp;&nbsp; --交易类型，有种存入和支取 BDDealTypeChar(10) not null &nbsp;&nbsp;&nbsp; BDDealType Char(10) not null check(BDDealType like&#39;存入&#39; &nbsp;&nbsp;&nbsp; or BDDealType like&#39;支取&#39;), &nbsp;&nbsp;&nbsp; --交易备注 BDDealCommentvarchar(100) &nbsp;&nbsp;&nbsp; BDDealCommentvarchar(100) ) Go &nbsp;添加外键约束和生成数据库关系图 --建立表之间的外键约束关系 alter table BankCard add constraint FK_BCBBTIdforeign key(BCBBTId) references BankBusinessType(BBTId) alter table BankCard add constraint FK_BCBCId foreign key(BCBCId) references BankCustomer(BCID) alter table BankDealInfo add constraint FK_BDBCNo foreign key(BDBCNo) references BankCard(BCNo) go &nbsp;创建级联触发器 &nbsp;&nbsp;&nbsp;2.1.1创建Insert触发器 --在交易信息表中插入一个触发器tr_InsertdealInfo，修改银行卡的存款余额 --判断交易记录里是存入还是支取，及时更新银行卡表的存款余额 if exists(select * from sysobjects where name=&#39;tr_InsertdealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_InsertdealInfo&nbsp; go create trigger tr_InsertdealInfo on BankDealInfo for insert as &nbsp;&nbsp;&nbsp; declare @BDDealType Char(10),@BDDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount,@BDBCNo &nbsp;&nbsp;&nbsp; =BDBCNo from inserted &nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@BDDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; end go &nbsp;2.1.2创建Delete触发器 --在交易信息表中插入一个触发器tr_DeldealInfo，当删除一个交易信息，修改银行卡的存款余额 if exists(select * from sysobjects where name=&#39;tr_DeldealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_DeldealInfo go create trigger tr_DeldealInfo on BankDealInfo instead of delete as &nbsp;&nbsp;&nbsp; declare @BDDealType Char(10),@BDDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount,@BDBCNo &nbsp;&nbsp;&nbsp; =BDBCNo from deleted &nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@BDDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@BDDealAcount where BCNo=@BDBCNo go &nbsp;2.1.3创建Update触发器 --在交易信息表中插入一个触发器，修改银行卡的存款余额 --判断交易记录里是存入还是支取，及时更新银行卡表的存款余额 if exists(select * from sysobjects where name=&#39;tr_updatedealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_updatedealInfo&nbsp; go create trigger tr_updatedealInfo on BankDealInfo for update as &nbsp;&nbsp;&nbsp; declare @oldDealType Char(10),@newDealType Char(10),@oldDealAcount &nbsp;&nbsp;&nbsp; money,@newDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDBCNo=BDBCNo,@oldDealType=BDDealType,@oldDealAcount= &nbsp;&nbsp;&nbsp; BDDealAcountfrom deleted &nbsp;&nbsp;&nbsp; select @newDealType=BDDealType,@newDealAcount=BDDealAcount from inserted &nbsp;&nbsp;&nbsp; if(@oldDealType=@newDealAcount) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@oldDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@newDealAcount-@oldDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@oldDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@newDealAcount+@oldDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@newDealAcount+@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; end go 插入数据表的测试数据 --插入表的测试数据 insert into BankBusinessType values(&#39;活期&#39;,&#39;无固定存储期,可随时存款,存款金额不限的一种比较灵活的存款&#39;), (&#39;定活俩便&#39;,&#39;事先不约定存期,一次性存入,一次性取出的存款&#39;), (&#39;通知&#39;,&#39;不约定存期,支取时需要提前通知银行,约定支取时间和金额方能支取的存款&#39;), (&#39;整存整取1年&#39;,&#39;整笔存入,到期提取本息&#39;),(&#39;整存整取2年&#39;,&#39;整笔存入,到期提取本息&#39;), (&#39;整存整取3年&#39;,&#39;整笔存入,到期提取本息&#39;),(&#39;零存整取1年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;零存整取2年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;零存整取3年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;自助转账&#39;, &#39;银行ATM存取款机上办理银行卡之间的相互转账&#39;) select * from BankBusinessType go &nbsp; insert into BankCustomer values(&#39;张飞&#39;,&#39;150203197611154224&#39;,&#39;13088447030&#39;, &#39;包头市昆区宝钢五中&#39;),(&#39;关羽&#39;,&#39;15020319761005123X&#39;,&#39;0472-2315490&#39;, &#39;包头昆区阿尔丁大街&#39;) select * from BankCustomer go &nbsp; insert into BankCard values(&#39;1010 3576 1234 5678&#39;,&#39;197611&#39;,default,1, &#39;2018-05-28&#39;,1000,default,1,1000),(&#39;1010 3576 1234 5688&#39;,&#39;197711&#39;, default,2,&#39;2018-05-28&#39;,1500,default,2,1500) select * from BankCard go &nbsp; insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,500, &#39;存入&#39;,&#39;单位1月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,1500,&#39;存入&#39;, &#39;单位2月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,600,&#39;支取&#39;, &#39;支付宝付款&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,700,&#39;支取&#39;, &#39;刷卡消费&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,3000,&#39;存入&#39;, &#39;单位1月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,2800,&#39;存入&#39;, &#39;单位2月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,1600,&#39;支取&#39;, &#39;支付宝付款&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,900,&#39;支取&#39;, &#39;刷卡消费&#39;) select * from BankDealInfo select * from BankCard go &nbsp;修改客户密码 --修改客户密码 --根据卡号修改指定2个客户的银行密码，其中第一个客户1010 3576 1234 5678密码修改为123456，第二个客户1010 3576 1234 5688修改为123123. update BankCardset BCPwd=&#39;123456&#39; where BCNo=&#39;1010 3576 1234 5678&#39; update BankCardset BCPwd=&#39;123123&#39; where BCNo=&#39;1010 3576 1234 5688&#39; go &nbsp; -- 按照以下字段进行显示 &#39;卡号&#39;, &#39;密码&#39;, &#39;货币类型&#39;, &#39;存储类型&#39;,&#39;开户日期&#39;, &#39;开户金额&#39;,&#39;是否挂失&#39;, &#39;客户编号&#39;,&#39;存款金额&#39; select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BCBBTId as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCRegLoss as 是否挂失,BCBCId as 客户编号,BCExistBalance as 存款金额 from BankCard go 办理银行卡挂失 --办理银行卡挂失 --卡号为1010 3576 1234 5678的银行卡丢失，申请挂失，要求使用innerjoin语句显示如下图运行结果： update BankCardset BCRegLoss=&#39;是&#39; where BCNo=&#39;1010 3576 1234 5688&#39; select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BBTName as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCRegLoss as 是否挂失,BCBCId as 客户编号,BCExistBalance as 存款金额 from BankCard inner join BankBusinessType on BCBBTId=BBTId go 统计银行资金流通余额和盈利结算 -- 使用存储过程 proc_BanlanceAndProfit, -- 统计银行资金流通余额和盈利结算 &nbsp;-- 1.获取总存入金额和总支取金额 盈利余额=总存入金额*0.008-总支取金额*0.003 if exists(select * from sysobjects where name=&#39;proc_BanlanceAndProfit&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_BanlanceAndProfit go create procedure proc_BanlanceAndProfit as &nbsp;&nbsp;&nbsp; declare @inMoney money=0,@outMoney money=0,@i int=1,@BDDealType Char(10), &nbsp;&nbsp;&nbsp; @BDDealAcountmoney &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankDealInfowhere BDNo=@i &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @inMoney+=@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if(@BDDealType=&#39;支取&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @outMoney+=@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; print &#39;存入总金额：&#39;+ltrim(str(@inMoney))+&#39;RMB,支取总金额：&#39;+ &nbsp;&nbsp;&nbsp; ltrim(str(@outMoney))+&#39;RMB&#39; &nbsp;&nbsp;&nbsp; print &#39;盈利余额为：&#39;+ltrim(str(@inMoney*0.008-@outMoney*0.003)) go exec proc_BanlanceAndProfit go 查询本周开户信息 --查询本周开户信息 select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BBTName as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCName as 客户姓名,BCExistBalance as 存款金额,BCRegLoss as 是否挂失,(case when BCRegLoss=&#39;否&#39; then &#39;正常账户&#39; else &#39;挂失账户&#39; end) as 账户状态 from BankCard,BankCustomer,BankBusinessType where BCBBTId=BBTId and BCID=BCBCId and datediff(ww,BCOpenDate,getdate())=0 go 查询本月单次交易金额最高的卡号和总交易金额最高的卡号 代码实现： --查询 --1.本月单次交易金额最高的卡号 select top 1 BDBCNo as 卡号,BCOpenDate as 开户日期,BCOpenAmount as 开户金额 from BankCard,BankDealInfo,BankCustomer where BDBCNo=BCNo and BCID=BCBCId and datediff(mm,BCOpenDate,getdate())=0 order by BDDealAcount desc go &nbsp; --2. 总交易金额最高的卡号 select top 1 BDBCNo as 卡号,BCOpenDate as 开户日期,BCOpenAmount as 开户金额 from BankCard,BankDealInfo,BankCustomer where BDBCNo=BCNo and BCID=BCBCId group by BDBCNo,BCOpenDate,BCOpenAmount order by sum(BDDealAcount) desc go &nbsp;查询挂失客户 --查询挂失客户 --查询挂失账号的客户信息，分别利用子查询in的方式或者内部连接inner join，查询结果如下图所示： select BCName as 客户姓名,BCTel as 客户电话 from BankCustomer where BCID in(select BCBCId from BankCard where BCRegLoss=&#39;是&#39;) go &nbsp;催款提醒业务 --催款提醒业务 --根据某种业务（如代缴电话费、代缴手机费或房贷等）的需要，每个月末，查询出客户账户上余额少于2000元，由银行统一致电催款。 select BCName as 客户姓名,BCTel as 客户电话,BCExistBalance as 客户余额 from BankCustomer inner join BankCard on BCID=BCBCId where BCExistBalance&lt;2000 go 输出银行客户记录视图VW_userInfo 为向客户提供友好的用户界面，使用T-SQL语句创建下面几个视图，并使用这些视图输出各表信息。 &nbsp;--输出银行客户记录视图VW_userInfo &nbsp;--显示的列名全为中文，要求先判断该视图是否存在，若存在，则先删除。结果如下图所示： if exists(select * from sysobjects where name=&#39;VW_userInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_userInfo go create view VW_userInfo as &nbsp;&nbsp;&nbsp; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel &nbsp;&nbsp;&nbsp; as 电话号码,BCAddr as 居住地址 from BankCustomer go select * from VW_userInfo go 输出银行卡记录视图VW_CardInfo --(2)输出银行卡记录视图VW_CardInfo if exists(select * from sysobjects where name=&#39;VW_CardInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_CardInfo go create view VW_CardInfo as &nbsp;&nbsp;&nbsp; select BCNo as 卡号,BCName as 开户名,BCCurrency as 货币类型,BBTName as &nbsp;&nbsp;&nbsp; 存储类型,BCOpenDate as 开户日期,BCExistBalance as 存款金额,BCPwd as 密码 &nbsp;&nbsp;&nbsp; ,BCRegLoss as 是否挂失 from BankCard,BankBusinessType,BankCustomer &nbsp;&nbsp;&nbsp; where BBTId=BCBBTId and BCID=BCBCId go select * from VW_CardInfo go 输出银行卡交易记录视图VW_TransInfo --输出银行卡交易记录视图VW_TransInfo --查询该视图，结果如下图所示： if exists(select * from sysobjects where name=&#39;VW_TransInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_TransInfo go create view VW_TransInfo as &nbsp;&nbsp;&nbsp; select BDDealDate as 交易日期,BDDealType as 交易类型,BDBCNo as 交易卡号, &nbsp;&nbsp;&nbsp; BDDealAcountas 交易金额,BDDealComment as 备注 from BankDealInfo go select * from VW_TransInfo go 根据客户登录名查询该客户账户信息VW_OneUserInfo --根据客户登录名查询该客户账户信息VW_OneUserInfo if exists(select * from sysobjects where name=&#39;VW_OneUserInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_OneUserInfo go create view VW_OneUserInfo as &nbsp;&nbsp;&nbsp; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel &nbsp;&nbsp;&nbsp; as 电话号码,BCAddr as 居住地址 from BankCustomer where BCName=system_user go select * from VW_OneUserInfo go 完成存款或取款业务 描述： Ø&nbsp; 根据银行卡号和交易金额实现银行卡的存款和取款业务。 Ø&nbsp; 每一笔存款，取款业务都要计入银行交易账户，并同时更新客户的存款余额。 Ø&nbsp; 如果是取款业务，在记账之前，要完成下面两项数据的检查验证工作，如果检查不合格，那么中断取款业务，给出提示信息后退出。 ²&nbsp; 检查客户输入的密码是否正确。 ²&nbsp; 账户取款金额是否大于当前存款额加1。 要求： Ø&nbsp; 取款或存款存储过程名为usp_takeMoney。 Ø&nbsp; 编写一个存储过程完成存款和取款业务，并调用存储过程取钱或者存钱进行测试，测试数据是张飞的卡号支取100元（密码123456），关羽的卡号存入2100元。 Ø&nbsp; &nbsp; --创建存取款业务的存储过程proc_TakeMoney --完成存款或取款业务 if exists(select * from sysobjects where name=&#39;proc_TakeMoney&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_TakeMoney go create procedure proc_TakeMoney @bcno char(19),@saleMoney money,@pwd char(6)=null as &nbsp;&nbsp;&nbsp; declare @existBanlance money,@errorCount int =0 &nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp; select @existBanlance=BCExistBalance from BankCard where BCNo=@bcno &nbsp;&nbsp;&nbsp; --不返回受影响的行数 &nbsp;&nbsp;&nbsp; set nocount on &nbsp;&nbsp;&nbsp; print &#39;交易前，卡号&#39;+@bcno+&#39;，余额为：&#39;+ltrim(str(@existBanlance)) &nbsp;&nbsp;&nbsp; print &#39;交易正进行，请稍后...&#39; &nbsp;&nbsp;&nbsp; --如果输入参数@pwd为空，则为存款业务，否则为取款业务 &nbsp;&nbsp;&nbsp; if (@pwd is not null) &nbsp;&nbsp;&nbsp; begin&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --1. 办理取款业务 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断指定卡号和密码是否存在，若存在，则可以取款，否则不能办理取款业务 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断取款金额是否小于等于存款余额-1，若条件成立，则可以取款，否则不能取款 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if exists(select * from BankCard where BCNo=@bcno and BCPwd=@pwd) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(money,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@bcno and BCPwd=@pwd))-1&lt;=@saleMoney) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;存款余额不足，不能办理取款业务！！&#39;,15,1) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set@existBanlance-=@saleMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insertinto BankDealInfovalues(@bcno,default,@saleMoney,&#39;支取&#39;,&#39;取款&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set@errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;不能办理取款业务！！&#39;,15,1) &nbsp;&nbsp;&nbsp; end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --2. 办理存款业务 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --判断事务处理里是否有异常，若没有异常，则提交，若有异常，则回滚 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断该交易为何种类型业务，若是存款，则现有余额等于原有余额加上存款金额 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @existBanlance+=@saleMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@bcno,default,@saleMoney,&#39;存入&#39;,&#39;存款&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollback tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;支取失败！！&#39;,18,2) &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit tran &nbsp;&nbsp;&nbsp; print &#39;交易成功，交易金额为：&#39;+ltrim(str(@saleMoney)) &nbsp;&nbsp;&nbsp; print &#39;卡号&#39;+@bcno+&#39;，余额为：&#39;+ltrim(str(@existBanlance)) go --执行存款存储过程 exec proc_TakeMoney&#39;1010 3576 1234 5678&#39;,2100 --执行取款存储过程 exec proc_TakeMoney&#39;1010 3576 1234 5678&#39;,100,&#39;123456&#39; select * from BankCard select * from BankDealInfo go 产生随机卡号 --使用存储过程 Proc_randCardID&nbsp;&nbsp; 产生随机卡号 --随机生成后8位卡号 &nbsp;[rand() 随机数 ] -- 再把前面的8位补上 &#39;1010 3576&#39; -- 最后判断卡号是否存在,如果存在则重新生成卡号的过程 if exists(select * from sysobjects where name=&#39;proc_randCardId&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_randCardId go create procedure proc_randCardId @myCardId1varchar(19) output as &nbsp;&nbsp;&nbsp; while(1=1) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @num1 char(4),@num2 char(4) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num1=convert(int,rand()*10000) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num2=convert(int,rand()*10000) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num1=replicate(0,4-len(@num1))+@num1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num2=replicate(0,4-len(@num2))+@num2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @myCardId1=&#39;1010 3576 &#39;+@num1+&#39; &#39;+@num2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@myCardId1 not in(select BCNo from BankCard)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break &nbsp;&nbsp;&nbsp; end go declare @myCardId1 varchar(19) exec proc_randCardId@myCardId1 output print &#39;产生随机卡号为:&#39;+@myCardId1 go 完成开户业务 描述： Ø&nbsp; 利用存储过程为客户开设2个银行卡账户，开户时需要提供客户的信息有：开户名、身份证号、电话号码、开户金额、存款类型和地址。客户的信息见表所示： Ø&nbsp; 为成功开户的客户提供银行卡，且银行卡号唯一。 要求： Ø&nbsp; 开户的存储过程名为usp_openAccount。 Ø&nbsp; 使用下面的数据执行该存储过程，进行测试：调用此存储过程开户。 --完成开户业务 --创建开户存储过程usp_openAccount，输入参数分别是开户名、身份证号、 --电话号码、开户金额、存款类型和地址 if exists(select * from sysobjects where name=&#39;usp_openAccount&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_openAccount go create procedure usp_openAccount @BCNamechar(20),@BCICNo char(18), @BCTel char(12),@BCOpenAmount money,@BBTName char(20),@BCAddr varchar(100) as &nbsp;&nbsp;&nbsp; --先判断存款类型是否正确 &nbsp;&nbsp;&nbsp; if exists(select BBTName from BankBusinessType whereBBTName=@BBTName) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @errorCount int =0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --插入一条客户信息记录&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankCustomer values(@BCName,@BCICNo,@BCTel,@BCAddr) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --得到刚插入的客户信息的编号 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BCID int,@BCNo char(19) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BCID=max(BCID) from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --插入一条新开银行卡记录 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exec proc_randCardId@BCNo output&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankCard values(@BCNo,default,default,(select BBTId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankBusinessTypewhere BBTName=@BBTName),default,@BCOpenAmount,default, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BCID,@BCOpenAmount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断上述事务操作是否有异常 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --1.如果错误 &#39;尊敬的客户，开户不成功，所有操作均撤销&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;尊敬的客户，开户不成功，所有操作均撤销！！&#39;,18,2) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- 2. 如果成功 &#39;尊敬的客户，开户成功，系统为你产生的 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --随机卡号是&#39;+@BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print&#39;尊敬的客户，开户成功，系统为你产生的&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print&#39;随机卡号是&#39;+@BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; committran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --错误显示 &#39;尊敬的客户，未能成功开户，存款类型不正确，请重新输入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;尊敬的客户，未能成功开户，存款类型不正确，请重新输入&#39;,15,1) go --执行开户过程 exec dbo.usp_openAccount&#39;周公旦&#39;,&#39;150203197510074339&#39;,&#39;0472-2457890&#39;,&#39;1200.00&#39;, &#39;定活俩便&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;姬昌&#39;,&#39;150203197610174339&#39;,&#39;0472-2457890&#39;,&#39;1300.00&#39;, &#39;活期&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;白天磊&#39;,&#39;150207199301252316&#39;,&#39;18347261609&#39;,&#39;10000000&#39;, &#39;通知&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;白天帅&#39;,&#39;150203197510074339&#39;,&#39;15102274286&#39;,&#39;1200.00&#39;, &#39;定活俩便&#39;,&#39;天津&#39; go &nbsp; --显示开户的客户信息和银行卡信息 --&#39;客户编号&#39;, &#39;开户名&#39;, &#39;身份证号&#39;, &#39;电话号码&#39;, &#39;居住地址&#39;, --&#39;卡号&#39;, &#39;客户&#39;, &#39;货币种类&#39;, &#39;存款类型&#39;, &#39;余额&#39;, &#39;密码&#39;, &#39;是否挂失&#39; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel as 电话号码,BCAddr as 居住地址 from BankCustomer go &nbsp; select BCNo as 卡号,BCName as 客户,BCCurrency as 货币类型,BBTName as 存款类型,BCExistBalance as 余额,BCPwd as 密码,BCRegLoss as 是否挂失 from BankCard,BankBusinessType,BankCustomer where BBTId=BCBBTId and BCID=BCBCId go 分页显示查询交易数据 --分页显示查询交易数据 --根据指定的页数和每页的记录数分页显示交易数据。要求： -- 显示第2页 的5条信息 if exists(select * from sysobjects where name=&#39;usp_PagingDisplay&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_PagingDisplay go create procedure usp_PagingDisplay @pageint,@info int as &nbsp;&nbsp;&nbsp; select top(@page*@info) * from BankDealInfo where BDNo not in(select &nbsp;&nbsp;&nbsp; top((@page-1)*@info) BDNo from BankDealInfo) go exec usp_PagingDisplay2,5 go 打印客户对账单 为某个特定的银行卡号打印指定时间内发生交易的对账单。要求如下： Ø&nbsp; 存储过程名称是usp_CheckSheet。 Ø&nbsp; 分别采用以下两种方式执行存储过程，结果如下图所示。 ²&nbsp; 如果不指定交易时间段，那么打印指定卡号的所有交易记录，如测试命令：exec&nbsp; usp_CheckSheet &#39;1010 3576 1234 5688&#39; &nbsp; ²&nbsp; 如果指定交易时间段，那么打印指定卡号在指定时间内发生的所有交易记录，如测试命令： --（5）打印客户对账单 --创建客户对账单的存储过程usp_CheckSheet --判断客户对账单存储过程是否存在，若是存在，则删除 if exists(select * from sysobjects where name=&#39;usp_CheckSheet&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_CheckSheet go create procedure usp_CheckSheet @BCNo char(19),@startTime date=null, @endTime date=null as &nbsp;&nbsp;&nbsp; declare @BCName char(20),@BCCurrency char(5),@BBTName char(20), &nbsp;&nbsp;&nbsp; @BCOpenDate date,@i int=0 &nbsp;&nbsp;&nbsp; select @BCName=BCName,@BCCurrency=BCCurrency,@BBTName=BBTName, &nbsp;&nbsp;&nbsp; @BCOpenDate=BCOpenDate from BankCustomer,BankBusinessType,BankCard &nbsp;&nbsp;&nbsp; where BCID=BCBCId and BBTId=BCBBTId and BCNo=@BCNo &nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@BCNo &nbsp;&nbsp;&nbsp; print &#39;姓名：&#39;+@BCName &nbsp;&nbsp;&nbsp; print &#39;货币：&#39;+@BCCurrency &nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@BBTName &nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@BCOpenDate) &nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+&#39;类型&nbsp;&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp; --打印客户对账单 &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BDDealDate date,@BDDealType char(10),@BDDealAcount money, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BDDealCommentvarchar(100) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@startTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(dd,-convert(int,datename(dd,getdate()))+1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getdate()) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BDDealDate=BDDealDate,@BDDealType=BDDealType,@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =BDDealAcount,@BDDealComment=BDDealComment from BankDealInfo where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDBCNo=@BCNo and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (dd,@endTime,BDDealDate)&lt;=0 and BDNo=@i &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@BDDealDate is not null and @BDDealType is not null and @BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is not null and @BDDealComment is not null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printrtrim(convert(char,@BDDealDate))+&#39;&nbsp;&nbsp;&nbsp; &#39;+rtrim(ltrim(@BDDealType)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +&#39;&nbsp;&nbsp;&nbsp; &#39;+ltrim(convert(char,@BDDealAcount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+@BDDealComment &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealDate=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealType=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealAcount=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealComment=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end go --执行打印客户对账单 exec usp_CheckSheet&#39;1010 3576 1234 5688&#39;,&#39;2018-05-15&#39;,&#39;2018-06-15&#39; exec usp_CheckSheet&#39;1010 3576 1234 5678&#39; go 统计未发生交易的账户 查询统计指定时间段内没有发生交易的账户信息。 要求： 存储过程名称是usp_getWithoutTrade。 指定时间段 如果没有指定起始日期，那么自本月1日开始进行统计，如果没有指定终止日期，那么截止到当日为止。 要求采用游标技术打印未发生交易的客户信息，参考客户对账单的代码。 该存储过程的执行结果如下图所示 --统计未发生交易的账户 if exists(select * from sysobjects where name=&#39;usp_getWithoutTrade&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_getWithoutTrade go create procedure usp_getWithoutTrade @startTimedate=null,@endTime date=null as begin &nbsp;&nbsp;&nbsp; if(@startTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(dd,-convert(int,datename(dd,getdate()))+1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getdate()) &nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp; declare cur_BankCustomer cursorforward_only forselect distinct &nbsp;&nbsp;&nbsp; BCID,BCName,BCICNo,BCTel,BCAddr from BankCustomer inner join &nbsp;&nbsp;&nbsp; BankCard on BCID=BCBCId where BCNo not in(select BDBCNo &nbsp;&nbsp;&nbsp; from BankDealInfo where datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0) &nbsp;&nbsp;&nbsp; open cur_BankCustomer &nbsp;&nbsp;&nbsp; declare @i int=0,@BCExistBalance money,@sumMoney money=0 &nbsp;&nbsp;&nbsp; print &#39;客户编号&nbsp;&nbsp; &#39;+&#39;客户姓名&nbsp;&nbsp; &#39;+&#39;身份证号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp;&nbsp; 电话号码&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp;&nbsp; 地址&#39; &nbsp;&nbsp;&nbsp; while(1=1) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BCID int,@BCName char(20),@BCICNo char(18),@BCTel char(12), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BCAddr varchar(20) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fetch next from cur_BankCustomer into@BCID,@BCName,@BCICNo,@BCTel,@BCAddr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @@fetch_status&lt;&gt;0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(11),@BCID)+rtrim(@BCName)+&#39;&nbsp;&nbsp;&nbsp; &#39;+@BCICNo+&#39;&nbsp;&nbsp;&nbsp; &#39;+@BCTel+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp; &#39;+@BCAddr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BCExistBalance=BCExistBalance from BankCard where BCBCId=@BCID &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumMoney+=@BCExistBalance &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; close cur_BankCustomer &nbsp;&nbsp;&nbsp; deallocate cur_BankCustomer &nbsp;&nbsp;&nbsp; print &#39;统计为发生交易的人数：&#39;+ltrim(str(@i))+&#39;人,客户总余额为：&#39;+ &nbsp;&nbsp;&nbsp; ltrim(str(@sumMoney))+&#39;元&#39; end go&nbsp; exec usp_getWithoutTrade&#39;2018-05-28&#39;,&#39;2018-05-28&#39; go 统计银行卡交易量和交易额 统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。 要求： Ø&nbsp; 存储过程名称是usp_getTradeInfo。 Ø&nbsp; 指定时间段和客户所在区域 如果没有指定起始日期，那么自当年1月1日开始统计，如果没有指定终止日期，那么以当日作为截止日。 如果没有指定地点（根据客户所在地址查询），如北京，那么统计全部客户的交易量和交易额。 --(7)统计银行卡交易量和交易额 --统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。 if exists(select * from sysobjects where name=&#39;usp_getTradeInfo&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_getTradeInfo go create procedure usp_getTradeInfo @startTimedate=null,@endTime date=null, @addr varchar(100)=null as &nbsp;&nbsp;&nbsp; declare @inCount int=0,@outCount int=0,@inMoney money=0,@outMoney money=0, &nbsp;&nbsp;&nbsp; @sumInMoney money=0,@sumOutMoney money=0,@i int=1 &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@startTime is null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(mm,-convert(int,datename(mm,getdate())) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +1,dateadd(dd,-convert(int,datename(dd,getdate()))+1,getdate())) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@addr is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inCount=count(*) from BankDealInfo where BDDealType=&#39;存入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;存入&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumInMoney+=@inMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outCount=count(*) from BankDealInfo where BDDealType=&#39;支取&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;支取&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumOutMoney+=@outMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inCount=count(*) from BankDealInfo where BDDealType=&#39;存入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 and BDBCNo in(select BCNo from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBCIdin(select BCID from BankCustomer where BCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;存入&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 and BDBCNo in(select BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from BankCard where BCBCId in(select BCID from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumInMoney+=@inMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outCount=count(*) from BankDealInfo where BDDealType=&#39;支取&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 and BDBCNo in(select BCNo from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBCIdin(select BCID from BankCustomer where BCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;支取&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 and BDBCNo in(select BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from BankCard where BCBCId in(select BCID from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumOutMoney+=@outMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;统计银行卡交易量和交易额&#39; &nbsp;&nbsp;&nbsp; print &#39;起始日期：&#39;+convert(char(21),@startTime)+&#39;截止日期：&#39;+convert(char,@endTime) &nbsp;&nbsp;&nbsp; print &#39;存入笔数：&#39;+ltrim(str(@inCount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 存入金额：&#39; &nbsp;&nbsp;&nbsp; +ltrim(str(@sumInMoney)) &nbsp;&nbsp;&nbsp; print &#39;支出笔数：&#39;+ltrim(str(@outCount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 支出金额：&#39; &nbsp;&nbsp;&nbsp; +ltrim(str(@sumOutMoney)) &nbsp;&nbsp;&nbsp; print &#39;交易总笔数：&#39;+ltrim(str(@inCount+@outCount)) &nbsp;&nbsp;&nbsp; print &#39;结余金额：&#39;+ltrim(str(@sumInMoney-@sumOutMoney)) &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; go exec usp_getTradeInfo exec usp_getTradeInfo@addr=&#39;包头市昆区宝钢五中&#39; exec usp_getTradeInfo&#39;2018-05-1&#39;,&#39;2018-05-28&#39; exec usp_getTradeInfo&#39;2018-05-1&#39;,&#39;2018-12-30&#39;,&#39;包头市昆区宝钢五中&#39; exec usp_getTradeInfo@addr=&#39;内蒙古包头&#39; go 利用事务实现转账 使用存储过程和事务实现转账业务，操作步骤如下所示： (1) 从某一个账户支取一定金额的存款。 (2) 将支取金额存入到另一个指定的账户中。 (3) 分别打印此笔业务的转出账单和转入账单。 &nbsp;&nbsp; 要求： (1) &nbsp;存储过程名称是usp_transfer。 (2) 要求使用事务机制实现转账业务。 if exists(select * from sysobjects where name=&#39;usp_transfer&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_transfer go create procedure usp_transfer @outBCNochar(19),@inBCNo char(19),@saleMoney money as &nbsp;&nbsp;&nbsp; declare @errorCount int =0,@outBCExistBalance money,@inBCExistBalance money &nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp; --不返回受影响的行数 &nbsp;&nbsp;&nbsp; set nocount on &nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@outBCNo,default,@saleMoney,&#39;支取&#39;,&#39;通过存储&#39;) &nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@inBCNo,default,@saleMoney,&#39;存入&#39;,&#39;通过存储&#39;) &nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollback tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;转账失败！！&#39;,18,2) &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开始转账，请稍后...&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易正进行，请稍后...&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易成功，交易金额：&#39;+ltrim(str(@saleMoney)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCExistBalance=BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@outBCNo+&#39;&nbsp;&nbsp;&nbsp; 余额：&#39;+ltrim(str(@outBCExistBalance)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCExistBalance=BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@inBCNo+&#39;&nbsp;&nbsp;&nbsp; 余额：&#39;+ltrim(str(@inBCExistBalance)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @outBCName char(20),@outBCCurrency char(5),@outBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char(20),@outBCOpenDate date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCName=BCName from BankCustomer where BCID=(select BCBCId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@outBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCCurrency=BCCurrency,@outBCOpenDate=BCOpenDate from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBBTName=BBTName from BankBusinessType whereBBTId=(select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBBTId from BankCard where BCNo=@outBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;打印出转出对账单&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;货币类型：&#39;+@outBCCurrency &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@outBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@outBCOpenDate) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp; 类型&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(10),getdate(),120)+&#39;&nbsp; 支取&nbsp;&nbsp; &#39;+ltrim(str(@saleMoney))+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过存储&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @inBCName char(20),@inBCCurrency char(5),@inBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char(20),@inBCOpenDate date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCName=BCName from BankCustomer where BCID=(select BCBCId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@inBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCCurrency=BCCurrency,@inBCOpenDate=BCOpenDate from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBBTName=BBTName from BankBusinessType whereBBTId=(select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBBTId from BankCard where BCNo=@inBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;打印出转入对账单&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;货币类型：&#39;+@inBCCurrency &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@inBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@inBCOpenDate) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp; 类型&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(10),getdate(),120)+&#39;&nbsp; 存入&nbsp;&nbsp; &#39;+ltrim(str(@saleMoney))+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过存储&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end go exec usp_transfer&#39;1010 3576 1234 5678&#39;,&#39;1010 3576 1234 5688&#39;,100 go 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/05/31/c6bc4ab80ecec1df780429637ace5ed3.html" />
<meta property="og:url" content="https://mlh.app/2018/05/31/c6bc4ab80ecec1df780429637ace5ed3.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-31T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"&nbsp;项目名称：银行ATM存取款机系统设计与实现&nbsp;&nbsp; 一、创建数据库............................................................................................................. 3 1.1创建数据库....................................................................................................... 3 1.2创建各个数据表及相关的约束....................................................................... 3 1.3添加外键约束和生成数据库关系图............................................................... 6 二、创建触发器和插入测试数据................................................................................. 6 2.1创建级联触发器.............................................................................................. 6 2.2插入数据表的测试数据.................................................................................. 9 三、模拟常规业务....................................................................................................... 12 3.1修改客户密码................................................................................................. 12 3.2办理银行卡挂失............................................................................................ 12 3.3统计银行资金流通余额和盈利结算............................................................ 13 3.4查询本周开户信息........................................................................................ 14 3.5查询本月单次交易金额最高的卡号和总交易金额最高的卡号................ 14 3.6查询挂失客户................................................................................................ 15 3.7催款提醒业务................................................................................................ 15 四、创建、使用视图................................................................................................... 16 4.1输出银行客户记录视图VW_userInfo......................................................... 16 4.2输出银行卡记录视图VW_CardInfo............................................................. 16 4.3输出银行卡交易记录视图VW_TransInfo................................................... 17 4.4根据客户登录名查询该客户账户信息VW_OneUserInfo........................... 18 五、存储过程实现业务处理....................................................................................... 18 5.1完成存款或取款业务.................................................................................... 18 5.2产生随机卡号................................................................................................ 21 5.3完成开户业务................................................................................................ 22 5.4分页显示查询交易数据................................................................................ 24 5.5打印客户对账单............................................................................................ 25 5.6统计未发生交易的账户................................................................................ 27 5.7统计银行卡交易量和交易额........................................................................ 30 六、利用事务实现转账............................................................................................... 34 心得体会：................................................................................................................... 39 源代码：....................................................................................................................... 40 创建数据库 -- 创建数据库BankDB -- 数据库文件和日志均保存在 D:\\20160107SQL项目练习\\银行ATM机器系统\\ -- 文件大小为5MB增长15% 日志大小为3MB增长5MB use master if exists(select * from sysdatabases where name=&#39;BankDB&#39;) &nbsp;&nbsp;&nbsp; drop database BankDB go create database BankDB on ( &nbsp;&nbsp;&nbsp; name=&#39;BankDB_Data&#39;, &nbsp;&nbsp;&nbsp; filename=&#39;D:\\20160107SQL\\项目练习\\银行ATM机器系统\\BankDB01_Data.mdf&#39;, &nbsp;&nbsp;&nbsp; size=5mb, &nbsp;&nbsp;&nbsp; filegrowth=15% ) log on ( &nbsp;&nbsp;&nbsp; name=&#39;BankDB_Log&#39;, &nbsp;&nbsp;&nbsp; filename=&#39;D:\\20160107SQL\\项目练习\\银行ATM机器系统\\BankDB01_Log.ldf&#39;, &nbsp;&nbsp;&nbsp; size=3mb, &nbsp;&nbsp;&nbsp; filegrowth=5mb ) go 创建各个数据表及相关的约束 --创建银行业务类型表BankBusinessType --判断银行业务类型表是否存在,若存在则删除 --创建银行业务类型表，包含银行业务类型编号BBTId主键 自动标识符，银行业务类型名称BBTName char(20) not null，银行业务描述BBTComment varchar(100) use BankDB if exists(select * from sysobjects where name=&#39;BankBusinessType&#39;) &nbsp;&nbsp;&nbsp; drop table BankBusinessType go create table BankBusinessType ( &nbsp;&nbsp;&nbsp; BBTId int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; BBTName char(20) not null, &nbsp;&nbsp;&nbsp; BBTComment varchar(100) ) go --创建银行客户信息表BankCustomer --判断银行卡客户是否存在,若存在则删除 --创建银行客户信息表，包含客户编号BCID 主键 自动标识符，客户姓名BCName char(20) not null，客户身份证BCICNo，客户联系电话BCTel、 客户居住地址BCAddr varchar(100) &nbsp;&nbsp;&nbsp; --定义身份证号前位必须是数字，后位可以是数字或者X。 &nbsp;&nbsp; --定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号，手机号码前面第一位必须是1,第二位必须是[3,5,8,9] if exists(select * from sysobjects where name=&#39;BankCustomer&#39;) &nbsp;&nbsp;&nbsp; drop table BankCustomer go create table BankCustomer ( &nbsp;&nbsp;&nbsp; --客户编号BCID 主键 自动标识符， &nbsp;&nbsp;&nbsp; BCID int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; --客户姓名BCName char(20) not null， &nbsp;&nbsp;&nbsp; BCName char(20) not null, &nbsp;&nbsp;&nbsp; --客户身份证BCICNo， &nbsp;&nbsp;&nbsp; BCICNo char(18) not null, &nbsp;&nbsp;&nbsp; --客户联系电话BCTel &nbsp;&nbsp;&nbsp; BCTel char(12) not null, &nbsp;&nbsp;&nbsp; --客户居住地址BCAddr varchar(100) &nbsp;&nbsp;&nbsp; BCAddr varchar(100) ) go --定义身份证号前位必须是数字，后位可以是数字或者X。 alter table BankCustomer add constraint CK_BCICNo check(BCICNo like replicate(&#39;[0-9]&#39;,17)+replicate(&#39;[0-9xX]&#39;,1)) --定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号， --手机号码前面第一位必须是1,第二位必须是[3,5,8,9] alter table BankCustomer add constraint CK_BCTel check(BCTel like &#39;1&#39;+replicate(&#39;[3589]&#39;,1)+replicate(&#39;[0-9]&#39;,9) or BCTel like replicate(&#39;[0-9]&#39;,3)+&#39;-&#39;+replicate(&#39;[0-9]&#39;,8) or BCTel like replicate(&#39;[0-9]&#39;,4)+&#39;-&#39;+replicate(&#39;[0-9]&#39;,7)) go --建立银行卡信息 BankCard --判断银行卡是否存在，若存在，则删除银行卡BankCard -- 卡号 BCNo char(19) 主键 必须符合16位数字构成,前8位为1010 3576,后位是随机产生且唯一,每4位必须有一个空格 -- 密码&nbsp; BCPwd char(6) not null ,开户默认为&#39;888888&#39; -- 币种&nbsp; BCCurrency char(5) not null, 默认为RMB类型 -- 存款类型 BCBBTId int not null -- 开户日期 BCOpenDate datetime not null,默认当日 -- 开户金额 BCOpenAmount money&nbsp; not null ,不得小于1元 -- 是否挂失 BCRegLoss char(2),默认为否 -- 客户编号 BCBCId intnot null, -- 当前余额 BCExistBalance money not null if exists(select * from sysobjects where name=&#39;BankCard&#39;) &nbsp;&nbsp;&nbsp; drop table BankCard go create table BankCard ( &nbsp;&nbsp;&nbsp; -- 卡号 BCNo char(19) 主键 &nbsp;&nbsp;&nbsp; BCNo char(19) primary key, &nbsp;&nbsp;&nbsp; -- 密码&nbsp; BCPwd char(6) not null ,开户默认为&#39;888888&#39; &nbsp;&nbsp;&nbsp; BCPwd char(6) not null default(&#39;888888&#39;), &nbsp;&nbsp;&nbsp; -- 币种&nbsp; BCCurrency char(5) not null, 默认为RMB类型 &nbsp;&nbsp;&nbsp; BCCurrency char(5) not null&nbsp; default(&#39;RMB&#39;), &nbsp;&nbsp;&nbsp; -- 存款类型 BCBBTId int not null &nbsp;&nbsp;&nbsp; BCBBTId int not null, &nbsp;&nbsp;&nbsp; -- 开户日期 BCOpenDate datetime notnull,默认当日 &nbsp;&nbsp;&nbsp; BCOpenDate date not null default(convert(varchar(10),getdate(),120)), &nbsp;&nbsp;&nbsp; -- 开户金额 BCOpenAmount money&nbsp; not null ,不得小于1元 &nbsp;&nbsp;&nbsp; BCOpenAmountmoney not null check(BCOpenAmount&gt;=1), &nbsp;&nbsp;&nbsp; -- 是否挂失 BCRegLoss char(2),默认为否 &nbsp;&nbsp;&nbsp; BCRegLoss char(2) default(&#39;否&#39;) check(BCRegLoss=&#39;是&#39; or BCRegLoss=&#39;否&#39;), &nbsp;&nbsp;&nbsp; -- 客户编号 BCBCId int not null, &nbsp;&nbsp;&nbsp; BCBCId int not null, &nbsp;&nbsp;&nbsp; -- 当前余额 BCExistBalance moneynot null &nbsp;&nbsp;&nbsp; BCExistBalancemoney not null ) go --卡号必须符合16位数字构成,前8位为1010 3576, --后位是随机产生且唯一,每4位必须有一个空格 alter table BankCard add constraint CK_BCNo check(BCNo like&#39;1010 3576 &#39;+ replicate(&#39;[0-9]&#39;,4)+&#39; &#39;+replicate(&#39;[0-9]&#39;,4)) go --创建交易信息表BankDealInfo &nbsp;--判断交易信息BankDealInfo是否存在,若存在则删除 &nbsp;&nbsp;&nbsp; --交易编号BDNo&nbsp; 为自动增长列 主键 &nbsp;&nbsp;&nbsp; --卡号 BDBCNo char(19) not null &nbsp;&nbsp;&nbsp; --交易日期 BDDealDate Datenot null 默认为当前日期 &nbsp;&nbsp;&nbsp; --交易金额 BDDealAcount money not null &nbsp;&nbsp;&nbsp; --交易类型，有种存入和支取 BDDealType Char(10) not null &nbsp;&nbsp;&nbsp; --交易备注 BDDealComment varchar(100) if exists(select * from sysobjects where name=&#39;BankDealInfo&#39;) &nbsp;&nbsp;&nbsp; drop table BankDealInfo go create table BankDealInfo ( &nbsp;&nbsp;&nbsp; --交易编号BDNo&nbsp; 为自动增长列 主键 &nbsp;&nbsp;&nbsp; BDNo int identity(1,1) primary key, &nbsp;&nbsp;&nbsp; --卡号 BDBCNo char(19) not null &nbsp;&nbsp;&nbsp; BDBCNo char(19) not null, &nbsp;&nbsp;&nbsp; --交易日期 BDDealDate Date notnull 默认为当前日期 &nbsp;&nbsp;&nbsp; BDDealDate Date not null default(convert(varchar(10),getdate(),120)), &nbsp;&nbsp;&nbsp; --交易金额 BDDealAcount money notnull &nbsp;&nbsp;&nbsp; BDDealAcountmoney not null, &nbsp;&nbsp;&nbsp; --交易类型，有种存入和支取 BDDealTypeChar(10) not null &nbsp;&nbsp;&nbsp; BDDealType Char(10) not null check(BDDealType like&#39;存入&#39; &nbsp;&nbsp;&nbsp; or BDDealType like&#39;支取&#39;), &nbsp;&nbsp;&nbsp; --交易备注 BDDealCommentvarchar(100) &nbsp;&nbsp;&nbsp; BDDealCommentvarchar(100) ) Go &nbsp;添加外键约束和生成数据库关系图 --建立表之间的外键约束关系 alter table BankCard add constraint FK_BCBBTIdforeign key(BCBBTId) references BankBusinessType(BBTId) alter table BankCard add constraint FK_BCBCId foreign key(BCBCId) references BankCustomer(BCID) alter table BankDealInfo add constraint FK_BDBCNo foreign key(BDBCNo) references BankCard(BCNo) go &nbsp;创建级联触发器 &nbsp;&nbsp;&nbsp;2.1.1创建Insert触发器 --在交易信息表中插入一个触发器tr_InsertdealInfo，修改银行卡的存款余额 --判断交易记录里是存入还是支取，及时更新银行卡表的存款余额 if exists(select * from sysobjects where name=&#39;tr_InsertdealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_InsertdealInfo&nbsp; go create trigger tr_InsertdealInfo on BankDealInfo for insert as &nbsp;&nbsp;&nbsp; declare @BDDealType Char(10),@BDDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount,@BDBCNo &nbsp;&nbsp;&nbsp; =BDBCNo from inserted &nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@BDDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; end go &nbsp;2.1.2创建Delete触发器 --在交易信息表中插入一个触发器tr_DeldealInfo，当删除一个交易信息，修改银行卡的存款余额 if exists(select * from sysobjects where name=&#39;tr_DeldealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_DeldealInfo go create trigger tr_DeldealInfo on BankDealInfo instead of delete as &nbsp;&nbsp;&nbsp; declare @BDDealType Char(10),@BDDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount,@BDBCNo &nbsp;&nbsp;&nbsp; =BDBCNo from deleted &nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@BDDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@BDDealAcount where BCNo=@BDBCNo &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@BDDealAcount where BCNo=@BDBCNo go &nbsp;2.1.3创建Update触发器 --在交易信息表中插入一个触发器，修改银行卡的存款余额 --判断交易记录里是存入还是支取，及时更新银行卡表的存款余额 if exists(select * from sysobjects where name=&#39;tr_updatedealInfo&#39;) &nbsp;&nbsp;&nbsp; drop trigger tr_updatedealInfo&nbsp; go create trigger tr_updatedealInfo on BankDealInfo for update as &nbsp;&nbsp;&nbsp; declare @oldDealType Char(10),@newDealType Char(10),@oldDealAcount &nbsp;&nbsp;&nbsp; money,@newDealAcount money,@BDBCNo char(19) &nbsp;&nbsp;&nbsp; select @BDBCNo=BDBCNo,@oldDealType=BDDealType,@oldDealAcount= &nbsp;&nbsp;&nbsp; BDDealAcountfrom deleted &nbsp;&nbsp;&nbsp; select @newDealType=BDDealType,@newDealAcount=BDDealAcount from inserted &nbsp;&nbsp;&nbsp; if(@oldDealType=@newDealAcount) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@oldDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@newDealAcount-@oldDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@oldDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(float,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@BDBCNo))&lt;@newDealAcount+@oldDealAcount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;本卡的当前余额不足&#39;,18,100)&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance-=@newDealAcount+@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; updateBankCard set BCExistBalance+=@newDealAcount-@oldDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCNo=@BDBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; end go 插入数据表的测试数据 --插入表的测试数据 insert into BankBusinessType values(&#39;活期&#39;,&#39;无固定存储期,可随时存款,存款金额不限的一种比较灵活的存款&#39;), (&#39;定活俩便&#39;,&#39;事先不约定存期,一次性存入,一次性取出的存款&#39;), (&#39;通知&#39;,&#39;不约定存期,支取时需要提前通知银行,约定支取时间和金额方能支取的存款&#39;), (&#39;整存整取1年&#39;,&#39;整笔存入,到期提取本息&#39;),(&#39;整存整取2年&#39;,&#39;整笔存入,到期提取本息&#39;), (&#39;整存整取3年&#39;,&#39;整笔存入,到期提取本息&#39;),(&#39;零存整取1年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;零存整取2年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;零存整取3年&#39;, &#39;事先约定金额,逐月按约定金额存入,到期支付本息&#39;),(&#39;自助转账&#39;, &#39;银行ATM存取款机上办理银行卡之间的相互转账&#39;) select * from BankBusinessType go &nbsp; insert into BankCustomer values(&#39;张飞&#39;,&#39;150203197611154224&#39;,&#39;13088447030&#39;, &#39;包头市昆区宝钢五中&#39;),(&#39;关羽&#39;,&#39;15020319761005123X&#39;,&#39;0472-2315490&#39;, &#39;包头昆区阿尔丁大街&#39;) select * from BankCustomer go &nbsp; insert into BankCard values(&#39;1010 3576 1234 5678&#39;,&#39;197611&#39;,default,1, &#39;2018-05-28&#39;,1000,default,1,1000),(&#39;1010 3576 1234 5688&#39;,&#39;197711&#39;, default,2,&#39;2018-05-28&#39;,1500,default,2,1500) select * from BankCard go &nbsp; insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,500, &#39;存入&#39;,&#39;单位1月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,1500,&#39;存入&#39;, &#39;单位2月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,600,&#39;支取&#39;, &#39;支付宝付款&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5678&#39;,&#39;2018-05-29&#39;,700,&#39;支取&#39;, &#39;刷卡消费&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,3000,&#39;存入&#39;, &#39;单位1月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,2800,&#39;存入&#39;, &#39;单位2月工资&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,1600,&#39;支取&#39;, &#39;支付宝付款&#39;) insert into BankDealInfo values(&#39;1010 3576 1234 5688&#39;,&#39;2018-05-29&#39;,900,&#39;支取&#39;, &#39;刷卡消费&#39;) select * from BankDealInfo select * from BankCard go &nbsp;修改客户密码 --修改客户密码 --根据卡号修改指定2个客户的银行密码，其中第一个客户1010 3576 1234 5678密码修改为123456，第二个客户1010 3576 1234 5688修改为123123. update BankCardset BCPwd=&#39;123456&#39; where BCNo=&#39;1010 3576 1234 5678&#39; update BankCardset BCPwd=&#39;123123&#39; where BCNo=&#39;1010 3576 1234 5688&#39; go &nbsp; -- 按照以下字段进行显示 &#39;卡号&#39;, &#39;密码&#39;, &#39;货币类型&#39;, &#39;存储类型&#39;,&#39;开户日期&#39;, &#39;开户金额&#39;,&#39;是否挂失&#39;, &#39;客户编号&#39;,&#39;存款金额&#39; select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BCBBTId as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCRegLoss as 是否挂失,BCBCId as 客户编号,BCExistBalance as 存款金额 from BankCard go 办理银行卡挂失 --办理银行卡挂失 --卡号为1010 3576 1234 5678的银行卡丢失，申请挂失，要求使用innerjoin语句显示如下图运行结果： update BankCardset BCRegLoss=&#39;是&#39; where BCNo=&#39;1010 3576 1234 5688&#39; select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BBTName as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCRegLoss as 是否挂失,BCBCId as 客户编号,BCExistBalance as 存款金额 from BankCard inner join BankBusinessType on BCBBTId=BBTId go 统计银行资金流通余额和盈利结算 -- 使用存储过程 proc_BanlanceAndProfit, -- 统计银行资金流通余额和盈利结算 &nbsp;-- 1.获取总存入金额和总支取金额 盈利余额=总存入金额*0.008-总支取金额*0.003 if exists(select * from sysobjects where name=&#39;proc_BanlanceAndProfit&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_BanlanceAndProfit go create procedure proc_BanlanceAndProfit as &nbsp;&nbsp;&nbsp; declare @inMoney money=0,@outMoney money=0,@i int=1,@BDDealType Char(10), &nbsp;&nbsp;&nbsp; @BDDealAcountmoney &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BDDealType=BDDealType,@BDDealAcount=BDDealAcount from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankDealInfowhere BDNo=@i &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@BDDealType=&#39;存入&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @inMoney+=@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if(@BDDealType=&#39;支取&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @outMoney+=@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; print &#39;存入总金额：&#39;+ltrim(str(@inMoney))+&#39;RMB,支取总金额：&#39;+ &nbsp;&nbsp;&nbsp; ltrim(str(@outMoney))+&#39;RMB&#39; &nbsp;&nbsp;&nbsp; print &#39;盈利余额为：&#39;+ltrim(str(@inMoney*0.008-@outMoney*0.003)) go exec proc_BanlanceAndProfit go 查询本周开户信息 --查询本周开户信息 select BCNo as 卡号,BCPwd as 密码,BCCurrency as 货币类型,BBTName as 存储类型,BCOpenDate as 开户日期,BCOpenAmount as 开户金额,BCName as 客户姓名,BCExistBalance as 存款金额,BCRegLoss as 是否挂失,(case when BCRegLoss=&#39;否&#39; then &#39;正常账户&#39; else &#39;挂失账户&#39; end) as 账户状态 from BankCard,BankCustomer,BankBusinessType where BCBBTId=BBTId and BCID=BCBCId and datediff(ww,BCOpenDate,getdate())=0 go 查询本月单次交易金额最高的卡号和总交易金额最高的卡号 代码实现： --查询 --1.本月单次交易金额最高的卡号 select top 1 BDBCNo as 卡号,BCOpenDate as 开户日期,BCOpenAmount as 开户金额 from BankCard,BankDealInfo,BankCustomer where BDBCNo=BCNo and BCID=BCBCId and datediff(mm,BCOpenDate,getdate())=0 order by BDDealAcount desc go &nbsp; --2. 总交易金额最高的卡号 select top 1 BDBCNo as 卡号,BCOpenDate as 开户日期,BCOpenAmount as 开户金额 from BankCard,BankDealInfo,BankCustomer where BDBCNo=BCNo and BCID=BCBCId group by BDBCNo,BCOpenDate,BCOpenAmount order by sum(BDDealAcount) desc go &nbsp;查询挂失客户 --查询挂失客户 --查询挂失账号的客户信息，分别利用子查询in的方式或者内部连接inner join，查询结果如下图所示： select BCName as 客户姓名,BCTel as 客户电话 from BankCustomer where BCID in(select BCBCId from BankCard where BCRegLoss=&#39;是&#39;) go &nbsp;催款提醒业务 --催款提醒业务 --根据某种业务（如代缴电话费、代缴手机费或房贷等）的需要，每个月末，查询出客户账户上余额少于2000元，由银行统一致电催款。 select BCName as 客户姓名,BCTel as 客户电话,BCExistBalance as 客户余额 from BankCustomer inner join BankCard on BCID=BCBCId where BCExistBalance&lt;2000 go 输出银行客户记录视图VW_userInfo 为向客户提供友好的用户界面，使用T-SQL语句创建下面几个视图，并使用这些视图输出各表信息。 &nbsp;--输出银行客户记录视图VW_userInfo &nbsp;--显示的列名全为中文，要求先判断该视图是否存在，若存在，则先删除。结果如下图所示： if exists(select * from sysobjects where name=&#39;VW_userInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_userInfo go create view VW_userInfo as &nbsp;&nbsp;&nbsp; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel &nbsp;&nbsp;&nbsp; as 电话号码,BCAddr as 居住地址 from BankCustomer go select * from VW_userInfo go 输出银行卡记录视图VW_CardInfo --(2)输出银行卡记录视图VW_CardInfo if exists(select * from sysobjects where name=&#39;VW_CardInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_CardInfo go create view VW_CardInfo as &nbsp;&nbsp;&nbsp; select BCNo as 卡号,BCName as 开户名,BCCurrency as 货币类型,BBTName as &nbsp;&nbsp;&nbsp; 存储类型,BCOpenDate as 开户日期,BCExistBalance as 存款金额,BCPwd as 密码 &nbsp;&nbsp;&nbsp; ,BCRegLoss as 是否挂失 from BankCard,BankBusinessType,BankCustomer &nbsp;&nbsp;&nbsp; where BBTId=BCBBTId and BCID=BCBCId go select * from VW_CardInfo go 输出银行卡交易记录视图VW_TransInfo --输出银行卡交易记录视图VW_TransInfo --查询该视图，结果如下图所示： if exists(select * from sysobjects where name=&#39;VW_TransInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_TransInfo go create view VW_TransInfo as &nbsp;&nbsp;&nbsp; select BDDealDate as 交易日期,BDDealType as 交易类型,BDBCNo as 交易卡号, &nbsp;&nbsp;&nbsp; BDDealAcountas 交易金额,BDDealComment as 备注 from BankDealInfo go select * from VW_TransInfo go 根据客户登录名查询该客户账户信息VW_OneUserInfo --根据客户登录名查询该客户账户信息VW_OneUserInfo if exists(select * from sysobjects where name=&#39;VW_OneUserInfo&#39;) &nbsp;&nbsp;&nbsp; drop view VW_OneUserInfo go create view VW_OneUserInfo as &nbsp;&nbsp;&nbsp; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel &nbsp;&nbsp;&nbsp; as 电话号码,BCAddr as 居住地址 from BankCustomer where BCName=system_user go select * from VW_OneUserInfo go 完成存款或取款业务 描述： Ø&nbsp; 根据银行卡号和交易金额实现银行卡的存款和取款业务。 Ø&nbsp; 每一笔存款，取款业务都要计入银行交易账户，并同时更新客户的存款余额。 Ø&nbsp; 如果是取款业务，在记账之前，要完成下面两项数据的检查验证工作，如果检查不合格，那么中断取款业务，给出提示信息后退出。 ²&nbsp; 检查客户输入的密码是否正确。 ²&nbsp; 账户取款金额是否大于当前存款额加1。 要求： Ø&nbsp; 取款或存款存储过程名为usp_takeMoney。 Ø&nbsp; 编写一个存储过程完成存款和取款业务，并调用存储过程取钱或者存钱进行测试，测试数据是张飞的卡号支取100元（密码123456），关羽的卡号存入2100元。 Ø&nbsp; &nbsp; --创建存取款业务的存储过程proc_TakeMoney --完成存款或取款业务 if exists(select * from sysobjects where name=&#39;proc_TakeMoney&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_TakeMoney go create procedure proc_TakeMoney @bcno char(19),@saleMoney money,@pwd char(6)=null as &nbsp;&nbsp;&nbsp; declare @existBanlance money,@errorCount int =0 &nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp; select @existBanlance=BCExistBalance from BankCard where BCNo=@bcno &nbsp;&nbsp;&nbsp; --不返回受影响的行数 &nbsp;&nbsp;&nbsp; set nocount on &nbsp;&nbsp;&nbsp; print &#39;交易前，卡号&#39;+@bcno+&#39;，余额为：&#39;+ltrim(str(@existBanlance)) &nbsp;&nbsp;&nbsp; print &#39;交易正进行，请稍后...&#39; &nbsp;&nbsp;&nbsp; --如果输入参数@pwd为空，则为存款业务，否则为取款业务 &nbsp;&nbsp;&nbsp; if (@pwd is not null) &nbsp;&nbsp;&nbsp; begin&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --1. 办理取款业务 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断指定卡号和密码是否存在，若存在，则可以取款，否则不能办理取款业务 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断取款金额是否小于等于存款余额-1，若条件成立，则可以取款，否则不能取款 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if exists(select * from BankCard where BCNo=@bcno and BCPwd=@pwd) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(convert(money,(select BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@bcno and BCPwd=@pwd))-1&lt;=@saleMoney) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;存款余额不足，不能办理取款业务！！&#39;,15,1) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set@existBanlance-=@saleMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insertinto BankDealInfovalues(@bcno,default,@saleMoney,&#39;支取&#39;,&#39;取款&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set@errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;不能办理取款业务！！&#39;,15,1) &nbsp;&nbsp;&nbsp; end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --2. 办理存款业务 &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --判断事务处理里是否有异常，若没有异常，则提交，若有异常，则回滚 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断该交易为何种类型业务，若是存款，则现有余额等于原有余额加上存款金额 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @existBanlance+=@saleMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@bcno,default,@saleMoney,&#39;存入&#39;,&#39;存款&#39;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollback tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;支取失败！！&#39;,18,2) &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit tran &nbsp;&nbsp;&nbsp; print &#39;交易成功，交易金额为：&#39;+ltrim(str(@saleMoney)) &nbsp;&nbsp;&nbsp; print &#39;卡号&#39;+@bcno+&#39;，余额为：&#39;+ltrim(str(@existBanlance)) go --执行存款存储过程 exec proc_TakeMoney&#39;1010 3576 1234 5678&#39;,2100 --执行取款存储过程 exec proc_TakeMoney&#39;1010 3576 1234 5678&#39;,100,&#39;123456&#39; select * from BankCard select * from BankDealInfo go 产生随机卡号 --使用存储过程 Proc_randCardID&nbsp;&nbsp; 产生随机卡号 --随机生成后8位卡号 &nbsp;[rand() 随机数 ] -- 再把前面的8位补上 &#39;1010 3576&#39; -- 最后判断卡号是否存在,如果存在则重新生成卡号的过程 if exists(select * from sysobjects where name=&#39;proc_randCardId&#39;) &nbsp;&nbsp;&nbsp; drop procedure proc_randCardId go create procedure proc_randCardId @myCardId1varchar(19) output as &nbsp;&nbsp;&nbsp; while(1=1) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @num1 char(4),@num2 char(4) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num1=convert(int,rand()*10000) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num2=convert(int,rand()*10000) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num1=replicate(0,4-len(@num1))+@num1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @num2=replicate(0,4-len(@num2))+@num2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @myCardId1=&#39;1010 3576 &#39;+@num1+&#39; &#39;+@num2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@myCardId1 not in(select BCNo from BankCard)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break &nbsp;&nbsp;&nbsp; end go declare @myCardId1 varchar(19) exec proc_randCardId@myCardId1 output print &#39;产生随机卡号为:&#39;+@myCardId1 go 完成开户业务 描述： Ø&nbsp; 利用存储过程为客户开设2个银行卡账户，开户时需要提供客户的信息有：开户名、身份证号、电话号码、开户金额、存款类型和地址。客户的信息见表所示： Ø&nbsp; 为成功开户的客户提供银行卡，且银行卡号唯一。 要求： Ø&nbsp; 开户的存储过程名为usp_openAccount。 Ø&nbsp; 使用下面的数据执行该存储过程，进行测试：调用此存储过程开户。 --完成开户业务 --创建开户存储过程usp_openAccount，输入参数分别是开户名、身份证号、 --电话号码、开户金额、存款类型和地址 if exists(select * from sysobjects where name=&#39;usp_openAccount&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_openAccount go create procedure usp_openAccount @BCNamechar(20),@BCICNo char(18), @BCTel char(12),@BCOpenAmount money,@BBTName char(20),@BCAddr varchar(100) as &nbsp;&nbsp;&nbsp; --先判断存款类型是否正确 &nbsp;&nbsp;&nbsp; if exists(select BBTName from BankBusinessType whereBBTName=@BBTName) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @errorCount int =0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --插入一条客户信息记录&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankCustomer values(@BCName,@BCICNo,@BCTel,@BCAddr) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --得到刚插入的客户信息的编号 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BCID int,@BCNo char(19) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BCID=max(BCID) from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --插入一条新开银行卡记录 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exec proc_randCardId@BCNo output&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; insert into BankCard values(@BCNo,default,default,(select BBTId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankBusinessTypewhere BBTName=@BBTName),default,@BCOpenAmount,default, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BCID,@BCOpenAmount) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --判断上述事务操作是否有异常 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --1.如果错误 &#39;尊敬的客户，开户不成功，所有操作均撤销&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollbacktran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;尊敬的客户，开户不成功，所有操作均撤销！！&#39;,18,2) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -- 2. 如果成功 &#39;尊敬的客户，开户成功，系统为你产生的 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --随机卡号是&#39;+@BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print&#39;尊敬的客户，开户成功，系统为你产生的&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print&#39;随机卡号是&#39;+@BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; committran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --错误显示 &#39;尊敬的客户，未能成功开户，存款类型不正确，请重新输入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;尊敬的客户，未能成功开户，存款类型不正确，请重新输入&#39;,15,1) go --执行开户过程 exec dbo.usp_openAccount&#39;周公旦&#39;,&#39;150203197510074339&#39;,&#39;0472-2457890&#39;,&#39;1200.00&#39;, &#39;定活俩便&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;姬昌&#39;,&#39;150203197610174339&#39;,&#39;0472-2457890&#39;,&#39;1300.00&#39;, &#39;活期&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;白天磊&#39;,&#39;150207199301252316&#39;,&#39;18347261609&#39;,&#39;10000000&#39;, &#39;通知&#39;,&#39;内蒙古包头&#39; exec dbo.usp_openAccount&#39;白天帅&#39;,&#39;150203197510074339&#39;,&#39;15102274286&#39;,&#39;1200.00&#39;, &#39;定活俩便&#39;,&#39;天津&#39; go &nbsp; --显示开户的客户信息和银行卡信息 --&#39;客户编号&#39;, &#39;开户名&#39;, &#39;身份证号&#39;, &#39;电话号码&#39;, &#39;居住地址&#39;, --&#39;卡号&#39;, &#39;客户&#39;, &#39;货币种类&#39;, &#39;存款类型&#39;, &#39;余额&#39;, &#39;密码&#39;, &#39;是否挂失&#39; select BCID as 客户编号,BCName as 开户名,BCICNo as 身份证号,BCTel as 电话号码,BCAddr as 居住地址 from BankCustomer go &nbsp; select BCNo as 卡号,BCName as 客户,BCCurrency as 货币类型,BBTName as 存款类型,BCExistBalance as 余额,BCPwd as 密码,BCRegLoss as 是否挂失 from BankCard,BankBusinessType,BankCustomer where BBTId=BCBBTId and BCID=BCBCId go 分页显示查询交易数据 --分页显示查询交易数据 --根据指定的页数和每页的记录数分页显示交易数据。要求： -- 显示第2页 的5条信息 if exists(select * from sysobjects where name=&#39;usp_PagingDisplay&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_PagingDisplay go create procedure usp_PagingDisplay @pageint,@info int as &nbsp;&nbsp;&nbsp; select top(@page*@info) * from BankDealInfo where BDNo not in(select &nbsp;&nbsp;&nbsp; top((@page-1)*@info) BDNo from BankDealInfo) go exec usp_PagingDisplay2,5 go 打印客户对账单 为某个特定的银行卡号打印指定时间内发生交易的对账单。要求如下： Ø&nbsp; 存储过程名称是usp_CheckSheet。 Ø&nbsp; 分别采用以下两种方式执行存储过程，结果如下图所示。 ²&nbsp; 如果不指定交易时间段，那么打印指定卡号的所有交易记录，如测试命令：exec&nbsp; usp_CheckSheet &#39;1010 3576 1234 5688&#39; &nbsp; ²&nbsp; 如果指定交易时间段，那么打印指定卡号在指定时间内发生的所有交易记录，如测试命令： --（5）打印客户对账单 --创建客户对账单的存储过程usp_CheckSheet --判断客户对账单存储过程是否存在，若是存在，则删除 if exists(select * from sysobjects where name=&#39;usp_CheckSheet&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_CheckSheet go create procedure usp_CheckSheet @BCNo char(19),@startTime date=null, @endTime date=null as &nbsp;&nbsp;&nbsp; declare @BCName char(20),@BCCurrency char(5),@BBTName char(20), &nbsp;&nbsp;&nbsp; @BCOpenDate date,@i int=0 &nbsp;&nbsp;&nbsp; select @BCName=BCName,@BCCurrency=BCCurrency,@BBTName=BBTName, &nbsp;&nbsp;&nbsp; @BCOpenDate=BCOpenDate from BankCustomer,BankBusinessType,BankCard &nbsp;&nbsp;&nbsp; where BCID=BCBCId and BBTId=BCBBTId and BCNo=@BCNo &nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@BCNo &nbsp;&nbsp;&nbsp; print &#39;姓名：&#39;+@BCName &nbsp;&nbsp;&nbsp; print &#39;货币：&#39;+@BCCurrency &nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@BBTName &nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@BCOpenDate) &nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+&#39;类型&nbsp;&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp; --打印客户对账单 &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BDDealDate date,@BDDealType char(10),@BDDealAcount money, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BDDealCommentvarchar(100) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@startTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(dd,-convert(int,datename(dd,getdate()))+1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getdate()) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BDDealDate=BDDealDate,@BDDealType=BDDealType,@BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =BDDealAcount,@BDDealComment=BDDealComment from BankDealInfo where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDBCNo=@BCNo and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (dd,@endTime,BDDealDate)&lt;=0 and BDNo=@i &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@BDDealDate is not null and @BDDealType is not null and @BDDealAcount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is not null and @BDDealComment is not null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printrtrim(convert(char,@BDDealDate))+&#39;&nbsp;&nbsp;&nbsp; &#39;+rtrim(ltrim(@BDDealType)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +&#39;&nbsp;&nbsp;&nbsp; &#39;+ltrim(convert(char,@BDDealAcount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+@BDDealComment &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealDate=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealType=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealAcount=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @BDDealComment=null &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end go --执行打印客户对账单 exec usp_CheckSheet&#39;1010 3576 1234 5688&#39;,&#39;2018-05-15&#39;,&#39;2018-06-15&#39; exec usp_CheckSheet&#39;1010 3576 1234 5678&#39; go 统计未发生交易的账户 查询统计指定时间段内没有发生交易的账户信息。 要求： 存储过程名称是usp_getWithoutTrade。 指定时间段 如果没有指定起始日期，那么自本月1日开始进行统计，如果没有指定终止日期，那么截止到当日为止。 要求采用游标技术打印未发生交易的客户信息，参考客户对账单的代码。 该存储过程的执行结果如下图所示 --统计未发生交易的账户 if exists(select * from sysobjects where name=&#39;usp_getWithoutTrade&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_getWithoutTrade go create procedure usp_getWithoutTrade @startTimedate=null,@endTime date=null as begin &nbsp;&nbsp;&nbsp; if(@startTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(dd,-convert(int,datename(dd,getdate()))+1, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getdate()) &nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp; declare cur_BankCustomer cursorforward_only forselect distinct &nbsp;&nbsp;&nbsp; BCID,BCName,BCICNo,BCTel,BCAddr from BankCustomer inner join &nbsp;&nbsp;&nbsp; BankCard on BCID=BCBCId where BCNo not in(select BDBCNo &nbsp;&nbsp;&nbsp; from BankDealInfo where datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0) &nbsp;&nbsp;&nbsp; open cur_BankCustomer &nbsp;&nbsp;&nbsp; declare @i int=0,@BCExistBalance money,@sumMoney money=0 &nbsp;&nbsp;&nbsp; print &#39;客户编号&nbsp;&nbsp; &#39;+&#39;客户姓名&nbsp;&nbsp; &#39;+&#39;身份证号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp;&nbsp; 电话号码&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp;&nbsp; 地址&#39; &nbsp;&nbsp;&nbsp; while(1=1) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @BCID int,@BCName char(20),@BCICNo char(18),@BCTel char(12), &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @BCAddr varchar(20) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fetch next from cur_BankCustomer into@BCID,@BCName,@BCICNo,@BCTel,@BCAddr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if @@fetch_status&lt;&gt;0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(11),@BCID)+rtrim(@BCName)+&#39;&nbsp;&nbsp;&nbsp; &#39;+@BCICNo+&#39;&nbsp;&nbsp;&nbsp; &#39;+@BCTel+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp; &#39;+@BCAddr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @BCExistBalance=BCExistBalance from BankCard where BCBCId=@BCID &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumMoney+=@BCExistBalance &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; close cur_BankCustomer &nbsp;&nbsp;&nbsp; deallocate cur_BankCustomer &nbsp;&nbsp;&nbsp; print &#39;统计为发生交易的人数：&#39;+ltrim(str(@i))+&#39;人,客户总余额为：&#39;+ &nbsp;&nbsp;&nbsp; ltrim(str(@sumMoney))+&#39;元&#39; end go&nbsp; exec usp_getWithoutTrade&#39;2018-05-28&#39;,&#39;2018-05-28&#39; go 统计银行卡交易量和交易额 统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。 要求： Ø&nbsp; 存储过程名称是usp_getTradeInfo。 Ø&nbsp; 指定时间段和客户所在区域 如果没有指定起始日期，那么自当年1月1日开始统计，如果没有指定终止日期，那么以当日作为截止日。 如果没有指定地点（根据客户所在地址查询），如北京，那么统计全部客户的交易量和交易额。 --(7)统计银行卡交易量和交易额 --统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。 if exists(select * from sysobjects where name=&#39;usp_getTradeInfo&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_getTradeInfo go create procedure usp_getTradeInfo @startTimedate=null,@endTime date=null, @addr varchar(100)=null as &nbsp;&nbsp;&nbsp; declare @inCount int=0,@outCount int=0,@inMoney money=0,@outMoney money=0, &nbsp;&nbsp;&nbsp; @sumInMoney money=0,@sumOutMoney money=0,@i int=1 &nbsp;&nbsp;&nbsp; while(@i&lt;=convert(int,(select max(BDNo) from BankDealInfo))) &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@startTime is null)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @startTime=dateadd(mm,-convert(int,datename(mm,getdate())) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +1,dateadd(dd,-convert(int,datename(dd,getdate()))+1,getdate())) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@endTime is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @endTime=getdate() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(@addr is null) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inCount=count(*) from BankDealInfo where BDDealType=&#39;存入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;存入&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumInMoney+=@inMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outCount=count(*) from BankDealInfo where BDDealType=&#39;支取&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;支取&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumOutMoney+=@outMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inCount=count(*) from BankDealInfo where BDDealType=&#39;存入&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 and BDBCNo in(select BCNo from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBCIdin(select BCID from BankCustomer where BCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@inMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;存入&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 and BDBCNo in(select BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from BankCard where BCBCId in(select BCID from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumInMoney+=@inMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outCount=count(*) from BankDealInfo where BDDealType=&#39;支取&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@startTime,BDDealDate)&gt;=0 and datediff(dd,@endTime, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BDDealDate)&lt;=0 and BDBCNo in(select BCNo from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBCIdin(select BCID from BankCustomer where BCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select@outMoney=BDDealAcount from BankDealInfo where BDDealType &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; =&#39;支取&#39; and BDNo=@i and datediff(dd,@startTime,BDDealDate)&gt;=0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; and datediff(dd,@endTime,BDDealDate)&lt;=0 and BDBCNo in(select BCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; from BankCard where BCBCId in(select BCID from BankCustomer &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; whereBCAddr=@addr)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @sumOutMoney+=@outMoney &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set @i+=1 &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;统计银行卡交易量和交易额&#39; &nbsp;&nbsp;&nbsp; print &#39;起始日期：&#39;+convert(char(21),@startTime)+&#39;截止日期：&#39;+convert(char,@endTime) &nbsp;&nbsp;&nbsp; print &#39;存入笔数：&#39;+ltrim(str(@inCount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 存入金额：&#39; &nbsp;&nbsp;&nbsp; +ltrim(str(@sumInMoney)) &nbsp;&nbsp;&nbsp; print &#39;支出笔数：&#39;+ltrim(str(@outCount))+&#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 支出金额：&#39; &nbsp;&nbsp;&nbsp; +ltrim(str(@sumOutMoney)) &nbsp;&nbsp;&nbsp; print &#39;交易总笔数：&#39;+ltrim(str(@inCount+@outCount)) &nbsp;&nbsp;&nbsp; print &#39;结余金额：&#39;+ltrim(str(@sumInMoney-@sumOutMoney)) &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39; &nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; go exec usp_getTradeInfo exec usp_getTradeInfo@addr=&#39;包头市昆区宝钢五中&#39; exec usp_getTradeInfo&#39;2018-05-1&#39;,&#39;2018-05-28&#39; exec usp_getTradeInfo&#39;2018-05-1&#39;,&#39;2018-12-30&#39;,&#39;包头市昆区宝钢五中&#39; exec usp_getTradeInfo@addr=&#39;内蒙古包头&#39; go 利用事务实现转账 使用存储过程和事务实现转账业务，操作步骤如下所示： (1) 从某一个账户支取一定金额的存款。 (2) 将支取金额存入到另一个指定的账户中。 (3) 分别打印此笔业务的转出账单和转入账单。 &nbsp;&nbsp; 要求： (1) &nbsp;存储过程名称是usp_transfer。 (2) 要求使用事务机制实现转账业务。 if exists(select * from sysobjects where name=&#39;usp_transfer&#39;) &nbsp;&nbsp;&nbsp; drop procedure usp_transfer go create procedure usp_transfer @outBCNochar(19),@inBCNo char(19),@saleMoney money as &nbsp;&nbsp;&nbsp; declare @errorCount int =0,@outBCExistBalance money,@inBCExistBalance money &nbsp;&nbsp;&nbsp; begin tran &nbsp;&nbsp;&nbsp; --不返回受影响的行数 &nbsp;&nbsp;&nbsp; set nocount on &nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@outBCNo,default,@saleMoney,&#39;支取&#39;,&#39;通过存储&#39;) &nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; insert into BankDealInfo values(@inBCNo,default,@saleMoney,&#39;存入&#39;,&#39;通过存储&#39;) &nbsp;&nbsp;&nbsp; set @errorCount+=@@error &nbsp;&nbsp;&nbsp; if @errorCount&lt;&gt;0 &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rollback tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; raiserror(&#39;转账失败！！&#39;,18,2) &nbsp;&nbsp;&nbsp; end &nbsp;&nbsp;&nbsp; else &nbsp;&nbsp;&nbsp; begin &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; commit tran &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开始转账，请稍后...&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易正进行，请稍后...&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易成功，交易金额：&#39;+ltrim(str(@saleMoney)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCExistBalance=BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@outBCNo+&#39;&nbsp;&nbsp;&nbsp; 余额：&#39;+ltrim(str(@outBCExistBalance)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCExistBalance=BCExistBalance from BankCard where &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCNo=@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@inBCNo+&#39;&nbsp;&nbsp;&nbsp; 余额：&#39;+ltrim(str(@inBCExistBalance)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @outBCName char(20),@outBCCurrency char(5),@outBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char(20),@outBCOpenDate date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCName=BCName from BankCustomer where BCID=(select BCBCId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@outBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBCCurrency=BCCurrency,@outBCOpenDate=BCOpenDate from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @outBBTName=BBTName from BankBusinessType whereBBTId=(select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBBTId from BankCard where BCNo=@outBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;打印出转出对账单&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@outBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;货币类型：&#39;+@outBCCurrency &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@outBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@outBCOpenDate) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp; 类型&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(10),getdate(),120)+&#39;&nbsp; 支取&nbsp;&nbsp; &#39;+ltrim(str(@saleMoney))+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过存储&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; declare @inBCName char(20),@inBCCurrency char(5),@inBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char(20),@inBCOpenDate date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCName=BCName from BankCustomer where BCID=(select BCBCId from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@inBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBCCurrency=BCCurrency,@inBCOpenDate=BCOpenDate from &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BankCard where BCNo=@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; select @inBBTName=BBTName from BankBusinessType whereBBTId=(select &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BCBBTId from BankCard where BCNo=@inBCNo) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;打印出转入对账单&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;卡号：&#39;+@inBCNo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;货币类型：&#39;+@inBCCurrency &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;存款类型：&#39;+@inBBTName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;开户日期：&#39;+convert(char,@inBCOpenDate) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;交易日&nbsp;&nbsp; &#39;+&#39;&nbsp;&nbsp; 类型&nbsp;&nbsp; &#39;+&#39;交易金额&nbsp;&nbsp; &#39;+&#39;备注&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print convert(char(10),getdate(),120)+&#39;&nbsp; 存入&nbsp;&nbsp; &#39;+ltrim(str(@saleMoney))+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#39;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 通过存储&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; print &#39;---------------------------------------------------------------&#39;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; end go exec usp_transfer&#39;1010 3576 1234 5678&#39;,&#39;1010 3576 1234 5688&#39;,100 go 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/05/31/c6bc4ab80ecec1df780429637ace5ed3.html","headline":"项目名称：银行ATM存取款机系统设计与实现","dateModified":"2018-05-31T00:00:00+08:00","datePublished":"2018-05-31T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/05/31/c6bc4ab80ecec1df780429637ace5ed3.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>项目名称：银行ATM存取款机系统设计与实现</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p align="center">&nbsp;<span style="text-align:justify;">项目名称：银行ATM存取款机系统设计与实现</span><span style="text-align:justify;">&nbsp;</span><span style="text-align:justify;">&nbsp;</span></p>
  <p><a><span>一、创建数据库</span><span>............................................................................................................. </span><span>3</span></a></p>
  <p><a><span>1.1</span><span>创建数据库</span><span>....................................................................................................... </span><span>3</span></a></p>
  <p><a><span>1.2</span><span>创建各个数据表及相关的约束</span><span>....................................................................... </span><span>3</span></a></p>
  <p><a><span>1.3</span><span>添加外键约束和生成数据库关系图</span><span>............................................................... </span><span>6</span></a></p>
  <p><a><span>二、创建触发器和插入测试数据</span><span>................................................................................. </span><span>6</span></a></p>
  <p><a><span>2.1</span><span>创建级联触发器</span><span>.............................................................................................. </span><span>6</span></a></p>
  <p><a><span>2.2</span><span>插入数据表的测试数据</span><span>.................................................................................. </span><span>9</span></a></p>
  <p><a><span>三、模拟常规业务</span><span>....................................................................................................... </span><span>12</span></a></p>
  <p><a><span>3.1</span><span>修改客户密码</span><span>................................................................................................. </span><span>12</span></a></p>
  <p><a><span>3.2</span><span>办理银行卡挂失</span><span>............................................................................................ </span><span>12</span></a></p>
  <p><a><span>3.3</span><span>统计银行资金流通余额和盈利结算</span><span>............................................................ </span><span>13</span></a></p>
  <p><a><span>3.4</span><span>查询本周开户信息</span><span>........................................................................................ </span><span>14</span></a></p>
  <p><a><span>3.5</span><span>查询本月单次交易金额最高的卡号和总交易金额最高的卡号</span><span>................ </span><span>14</span></a></p>
  <p><a><span>3.6</span><span>查询挂失客户</span><span>................................................................................................ </span><span>15</span></a></p>
  <p><a><span>3.7</span><span>催款提醒业务</span><span>................................................................................................ </span><span>15</span></a></p>
  <p><a><span>四、创建、使用视图</span><span>................................................................................................... </span><span>16</span></a></p>
  <p><a><span>4.1</span><span>输出银行客户记录视图VW_userInfo</span><span>......................................................... </span><span>16</span></a></p>
  <p><a><span>4.2</span><span>输出银行卡记录视图VW_CardInfo</span><span>............................................................. </span><span>16</span></a></p>
  <p><a><span>4.3</span><span>输出银行卡交易记录视图VW_TransInfo</span><span>................................................... </span><span>17</span></a></p>
  <p><a><span>4.4</span><span>根据客户登录名查询该客户账户信息VW_OneUserInfo</span><span>........................... </span><span>18</span></a></p>
  <p><a><span>五、存储过程实现业务处理</span><span>....................................................................................... </span><span>18</span></a></p>
  <p><a><span>5.1</span><span>完成存款或取款业务</span><span>.................................................................................... </span><span>18</span></a></p>
  <p><a><span>5.2</span><span>产生随机卡号</span><span>................................................................................................ </span><span>21</span></a></p>
  <p><a><span>5.3</span><span>完成开户业务</span><span>................................................................................................ </span><span>22</span></a></p>
  <p><a><span>5.4</span><span>分页显示查询交易数据</span><span>................................................................................ </span><span>24</span></a></p>
  <p><a><span>5.5</span><span>打印客户对账单</span><span>............................................................................................ </span><span>25</span></a></p>
  <p><a><span>5.6</span><span>统计未发生交易的账户</span><span>................................................................................ </span><span>27</span></a></p>
  <p><a><span>5.7</span><span>统计银行卡交易量和交易额</span><span>........................................................................ </span><span>30</span></a></p>
  <p><a><span>六、利用事务实现转账</span><span>............................................................................................... </span><span>34</span></a></p>
  <p><a><span>心得体会：</span><span>................................................................................................................... </span><span>39</span></a></p>
  <p><a><span>源代码：</span><span>....................................................................................................................... </span><span>40</span></a></p>
  <p><strong>创建数据库</strong></p>
  <p><strong>-- 创建数据库BankDB </strong></p>
  <p><strong>-- 数据库文件和日志均保存在 D:\20160107SQL项目练习\银行ATM机器系统\</strong></p>
  <p><strong>-- 文件大小为5MB增长15% 日志大小为3MB增长5MB</strong></p>
  <p align="left"><span style="color:#0000FF;">use</span> <span style="color:#0000FF;">master</span></p>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysdatabases</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankDB'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">database</span> <span style="color:#008080;">BankDB</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">database</span> <span style="color:#008080;">BankDB</span></p>
  <p align="left"><span style="color:#0000FF;">on</span></p>
  <p align="left"><span style="color:#808080;">(</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankDB_Data'</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">filename</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'D:\20160107SQL\</span><span style="color:#FF0000;">项目练习\</span>银行ATM机器系统\BankDB01_Data.mdf'<span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">size</span><span style="color:#808080;">=</span>5<span style="color:#008080;">mb</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">filegrowth</span><span style="color:#808080;">=</span>15<span style="color:#808080;">%</span></p>
  <p align="left"><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#FF00FF;">log</span> <span style="color:#0000FF;">on</span></p>
  <p align="left"><span style="color:#808080;">(</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankDB_Log'</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">filename</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'D:\20160107SQL\</span><span style="color:#FF0000;">项目练习\</span>银行ATM机器系统\BankDB01_Log.ldf'<span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">size</span><span style="color:#808080;">=</span>3<span style="color:#008080;">mb</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">filegrowth</span><span style="color:#808080;">=</span>5<span style="color:#008080;">mb</span></p>
  <p align="left"><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p><strong>创建各个数据表及相关的约束</strong></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建银行业务类型表</span><span style="color:#008080;">BankBusinessType</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">判断银行业务类型表是否存在,</span>若存在则删除</p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建银行业务类型表，包含银行业务类型编号BBTId</span>主键 自动标识符，银行业务类型名称BBTName<span style="color:#0000FF;"> char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">) not</span> <span style="color:#808080;">null</span><span style="color:#008000;">，银行业务描述BBTComment</span><span style="color:#0000FF;"> varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">use</span> <span style="color:#008080;">BankDB</span></p>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankBusinessType'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankBusinessType</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankBusinessType</span></p>
  <p align="left"><span style="color:#808080;">(</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BBTId</span> <span style="color:#0000FF;">int</span> <span style="color:#0000FF;">identity</span><span style="color:#808080;">(</span>1<span style="color:#808080;">,</span>1<span style="color:#808080;">)</span> <span style="color:#0000FF;">primary</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BBTComment</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建银行客户信息表</span><span style="color:#008080;">BankCustomer</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">判断银行卡客户是否存在,</span>若存在则删除</p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建银行客户信息表，包含客户编号BCID </span>主键 自动标识符，客户姓名BCName<span style="color:#0000FF;"> char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span><span style="color:#008000;">，客户身份证BCICNo</span>，客户联系电话BCTel、</p>
   <p align="left"><span style="color:#008000;">客户居住地址BCAddr</span><span style="color:#0000FF;"> varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  </div>
  <div style="background:#CCCCCC;">
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">定义身份证号前位必须是数字，后位可以是数字或者X</span>。</p>
   <p align="left"><span style="color:#008000;">&nbsp;&nbsp; --</span><span style="color:#008000;">定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号，手机号码前面第一位必须是1,</span>第二位必须是[3,5,8,9]</p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankCustomer'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left"><span style="color:#808080;">(</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">客户编号BCID </span>主键 自动标识符，</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">int</span> <span style="color:#0000FF;">identity</span><span style="color:#808080;">(</span>1<span style="color:#808080;">,</span>1<span style="color:#808080;">)</span> <span style="color:#0000FF;">primary</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">客户姓名BCName char(20) not null</span>，</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">客户身份证BCICNo</span>，</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCICNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>18<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">客户联系电话BCTel</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCTel</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>12<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">客户居住地址BCAddr varchar(100)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCAddr</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">定义身份证号前位必须是数字，后位可以是数字或者X</span>。</p>
  <p align="left"><span style="color:#0000FF;">alter</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">add</span> <span style="color:#0000FF;">constraint</span> <span style="color:#008080;">CK_BCICNo</span> <span style="color:#0000FF;">check</span><span style="color:#808080;">(</span><span style="color:#008080;">BCICNo</span> <span style="color:#808080;">like</span> </p>
  <p align="left"><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>17<span style="color:#808080;">)+</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9xX]'</span><span style="color:#808080;">,</span>1<span style="color:#808080;">))</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">定义联系方式，必须是固定电话号码或者手机号，固定电话号码前位必须是区号，</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">手机号码前面第一位必须是1,</span>第二位必须是[3,5,8,9]</p>
  <p align="left"><span style="color:#0000FF;">alter</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">add</span> <span style="color:#0000FF;">constraint</span> <span style="color:#008080;">CK_BCTel</span> <span style="color:#0000FF;">check</span><span style="color:#808080;">(</span><span style="color:#008080;">BCTel</span> <span style="color:#808080;">like</span> </p>
  <p align="left"><span style="color:#FF0000;">'1'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[3589]'</span><span style="color:#808080;">,</span>1<span style="color:#808080;">)+</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>9<span style="color:#808080;">)</span> <span style="color:#808080;">or</span> <span style="color:#008080;">BCTel</span> </p>
  <p align="left"><span style="color:#808080;">like</span> <span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>3<span style="color:#808080;">)+</span><span style="color:#FF0000;">'-'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>8<span style="color:#808080;">)</span> <span style="color:#808080;">or</span></p>
  <p align="left"><span style="color:#008080;">BCTel</span> <span style="color:#808080;">like</span> <span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>4<span style="color:#808080;">)+</span><span style="color:#FF0000;">'-'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>7<span style="color:#808080;">))</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">建立银行卡信息 </span><span style="color:#008080;">BankCard</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">判断银行卡是否存在，若存在，则删除银行卡BankCard</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">卡号 </span><span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">) </span><span style="color:#808080;">主键 </span><span style="color:#008000;">必须符合16</span>位数字构成,前8位为1010 3576,后位是随机产生且唯一,每4位必须有一个空格</p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">密码&nbsp; </span><span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>6<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null </span><span style="color:#008000;">,</span><span style="color:#008000;">开户默认为</span><span style="color:#FF0000;">'888888'</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">币种&nbsp; </span><span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>5<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span><span style="color:#008000;">, </span><span style="color:#008000;">默认为RMB</span>类型</p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">存款类型 </span><span style="color:#008080;">BCBBTId</span> <span style="color:#0000FF;">int</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">开户日期 </span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">datetime</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span><span style="color:#008000;">,</span><span style="color:#008000;">默认当日</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">开户金额 </span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">money</span>&nbsp; <span style="color:#808080;">not</span> <span style="color:#808080;">null</span><span style="color:#008000;"> ,</span><span style="color:#008000;">不得小于1</span>元</p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">是否挂失 </span><span style="color:#008080;">BCRegLoss</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>2<span style="color:#808080;">)</span><span style="color:#008000;">,</span><span style="color:#008000;">默认为否</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">客户编号</span> <span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">当前余额 </span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">money</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankCard'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCard</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCard</span></p>
  <p align="left"><span style="color:#808080;">(</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">卡号 BCNo char(19) </span>主键 </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span> <span style="color:#0000FF;">primary</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">密码&nbsp; BCPwd char(6) not null ,</span>开户默认为'888888'</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>6<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#0000FF;">default</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'888888'</span><span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">币种&nbsp; BCCurrency char(5) not null, </span>默认为RMB类型</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>5<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span>&nbsp; <span style="color:#0000FF;">default</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'RMB'</span><span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">存款类型 BCBBTId int not null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCBBTId</span> <span style="color:#0000FF;">int</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">开户日期 BCOpenDate datetime notnull,</span>默认当日</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">date</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#0000FF;">default</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">(),</span>120<span style="color:#808080;">)),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">开户金额 BCOpenAmount money&nbsp; not null ,</span>不得小于1元</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCOpenAmount</span><span style="color:#0000FF;">money</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#0000FF;">check</span><span style="color:#808080;">(</span><span style="color:#008080;">BCOpenAmount</span><span style="color:#808080;">&gt;=</span>1<span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">是否挂失 BCRegLoss char(2),</span>默认为否</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCRegLoss</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>2<span style="color:#808080;">)</span> <span style="color:#0000FF;">default</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">否'</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">check</span><span style="color:#808080;">(</span><span style="color:#008080;">BCRegLoss</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">是'</span> <span style="color:#808080;">or</span> <span style="color:#008080;">BCRegLoss</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">否'</span><span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">客户编号 BCBCId int not null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">int</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- </span><span style="color:#008000;">当前余额 BCExistBalance moneynot null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCExistBalance</span><span style="color:#0000FF;">money</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span></p>
  <p align="left"><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">卡号必须符合16</span>位数字构成,前8位为1010 3576,</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">后位是随机产生且唯一,</span>每4位必须有一个空格</p>
  <p align="left"><span style="color:#0000FF;">alter</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">add</span> <span style="color:#0000FF;">constraint</span> <span style="color:#008080;">CK_BCNo</span> <span style="color:#0000FF;">check</span><span style="color:#808080;">(</span><span style="color:#008080;">BCNo</span> <span style="color:#808080;">like</span><span style="color:#FF0000;">'1010 3576 '</span><span style="color:#808080;">+</span></p>
  <p align="left"><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>4<span style="color:#808080;">)+</span><span style="color:#FF0000;">' '</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'[0-9]'</span><span style="color:#808080;">,</span>4<span style="color:#808080;">))</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建交易信息表</span><span style="color:#008080;">BankDealInfo</span></p>
   <p align="left"><span style="color:#008000;">&nbsp;--</span><span style="color:#008000;">判断交易信息BankDealInfo</span>是否存在,若存在则删除</p>
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易编号</span><span style="color:#008080;">BDNo</span><span style="color:#008000;">&nbsp; </span><span style="color:#008000;">为自动增长列 主键</span></p>
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">卡号</span> <span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span></p>
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易日期</span> <span style="color:#008080;">BDDealDate</span> <span style="color:#0000FF;">Date</span><span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#008000;">默认为当前日期</span></p>
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易金额</span> <span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">money</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span></p>
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易类型，有种存入和支取</span> <span style="color:#008080;">BDDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> </p>
   <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易备注</span> <span style="color:#008080;">BDDealComment</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'BankDealInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#808080;">(</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易编号BDNo&nbsp; </span>为自动增长列 主键</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDNo</span> <span style="color:#0000FF;">int</span> <span style="color:#0000FF;">identity</span><span style="color:#808080;">(</span>1<span style="color:#808080;">,</span>1<span style="color:#808080;">)</span> <span style="color:#0000FF;">primary</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">卡号 BDBCNo char(19) not null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易日期 BDDealDate Date notnull </span>默认为当前日期</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealDate</span> <span style="color:#0000FF;">Date</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#0000FF;">default</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">(),</span>120<span style="color:#808080;">)),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易金额 BDDealAcount money notnull</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealAcount</span><span style="color:#0000FF;">money</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易类型，有种存入和支取 BDDealTypeChar(10) not null </span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">)</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#0000FF;">check</span><span style="color:#808080;">(</span><span style="color:#008080;">BDDealType</span> <span style="color:#808080;">like</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">or</span> <span style="color:#008080;">BDDealType</span> <span style="color:#808080;">like</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">),</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">交易备注 BDDealCommentvarchar(100)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealComment</span><span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">Go</span></p>
  <p align="left"><span style="color:#0000FF;">&nbsp;</span><span style="font-weight:bold;">添加外键约束和生成数据库关系图</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">建立表之间的外键约束关系</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">alter</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">add</span> <span style="color:#0000FF;">constraint</span> <span style="color:#008080;">FK_BCBBTId</span><span style="color:#0000FF;">foreign</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">(</span><span style="color:#008080;">BCBBTId</span><span style="color:#808080;">)</span> </p>
  <p align="left"><span style="color:#0000FF;">references</span> <span style="color:#008080;">BankBusinessType</span><span style="color:#808080;">(</span><span style="color:#008080;">BBTId</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">alter</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">add</span> <span style="color:#0000FF;">constraint</span> <span style="color:#008080;">FK_BCBCId</span> <span style="color:#0000FF;">foreign</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">(</span><span style="color:#008080;">BCBCId</span><span style="color:#808080;">)</span> </p>
  <p align="left"><span style="color:#0000FF;">references</span> <span style="color:#008080;">BankCustomer</span><span style="color:#808080;">(</span><span style="color:#008080;">BCID</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">alter</span> <span style="color:#0000FF;">table</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">add</span> <span style="color:#0000FF;">constraint</span> <span style="color:#008080;">FK_BDBCNo</span> <span style="color:#0000FF;">foreign</span> <span style="color:#0000FF;">key</span><span style="color:#808080;">(</span><span style="color:#008080;">BDBCNo</span><span style="color:#808080;">)</span> </p>
  <p align="left"><span style="color:#0000FF;">references</span> <span style="color:#008080;">BankCard</span><span style="color:#808080;">(</span><span style="color:#008080;">BCNo</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">&nbsp;</span><span style="font-weight:bold;">创建级联触发器</span></p>
  <p>&nbsp;&nbsp;&nbsp;2.1.1创建Insert触发器</p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">在交易信息表中插入一个触发器</span><span style="color:#008080;">tr_InsertdealInfo</span><span style="color:#008000;">，修改银行卡的存款余额</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">判断交易记录里是存入还是支取，及时更新银行卡表的存款余额</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'tr_InsertdealInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">trigger</span> <span style="color:#008080;">tr_InsertdealInfo</span>&nbsp; </p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">trigger</span> <span style="color:#008080;">tr_InsertdealInfo</span> <span style="color:#0000FF;">on</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#0000FF;">for</span> <span style="color:#0000FF;">insert</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@BDDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDBCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealType</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">inserted</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">+=</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">float</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span><span style="color:#808080;">))&lt;</span><span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">本卡的当前余额不足'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>100<span style="color:#808080;">)</span>&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span><span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">-=</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p>&nbsp;2.1.2创建Delete触发器</p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">在交易信息表中插入一个触发器</span><span style="color:#008080;">tr_DeldealInfo</span><span style="color:#008000;">，当删除一个交易信息，修改银行卡的存款余额</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'tr_DeldealInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">trigger</span> <span style="color:#008080;">tr_DeldealInfo</span> </p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">trigger</span> <span style="color:#008080;">tr_DeldealInfo</span> <span style="color:#0000FF;">on</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#0000FF;">instead</span> <span style="color:#0000FF;">of</span> <span style="color:#0000FF;">delete</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@BDDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDBCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealType</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">deleted</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">float</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span><span style="color:#808080;">))&lt;</span><span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">本卡的当前余额不足'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>100<span style="color:#808080;">)</span>&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span><span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">-=</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">+=</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <h4>&nbsp;2.1.3创建Update触发器</h4>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">在交易信息表中插入一个触发器，修改银行卡的存款余额</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">判断交易记录里是存入还是支取，及时更新银行卡表的存款余额</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'tr_updatedealInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">trigger</span> <span style="color:#008080;">tr_updatedealInfo</span>&nbsp; </p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">trigger</span> <span style="color:#008080;">tr_updatedealInfo</span> <span style="color:#0000FF;">on</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#0000FF;">for</span> <span style="color:#FF00FF;">update</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@oldDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#008080;">@newDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#008080;">@oldDealAcount</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@newDealAcount</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDBCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BDBCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">BDBCNo</span><span style="color:#808080;">,</span><span style="color:#008080;">@oldDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealType</span><span style="color:#808080;">,</span><span style="color:#008080;">@oldDealAcount</span><span style="color:#808080;">=</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealAcount</span><span style="color:#0000FF;">from</span> <span style="color:#008080;">deleted</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@newDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealType</span><span style="color:#808080;">,</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">inserted</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@oldDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@oldDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">+=</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">-</span><span style="color:#008080;">@oldDealAcount</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span><span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">float</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span><span style="color:#808080;">))&lt;</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">-</span><span style="color:#008080;">@oldDealAcount</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">本卡的当前余额不足'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>100<span style="color:#808080;">)</span>&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span><span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">-=</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">-</span><span style="color:#008080;">@oldDealAcount</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span><span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@oldDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">float</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span><span style="color:#808080;">))&lt;</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">+</span><span style="color:#008080;">@oldDealAcount</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">本卡的当前余额不足'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>100<span style="color:#808080;">)</span>&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span><span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">-=</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">+</span><span style="color:#008080;">@oldDealAcount</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span><span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">update</span><span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">set</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">+=</span><span style="color:#008080;">@newDealAcount</span><span style="color:#808080;">-</span><span style="color:#008080;">@oldDealAcount</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span><span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BDBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-weight:bold;">插入数据表的测试数据</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">插入表的测试数据</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankBusinessType</span> </p>
  <p align="left"><span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">活期'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">无固定存储期,</span>可随时存款,存款金额不限的一种比较灵活的存款'<span style="color:#808080;">),</span></p>
  <p align="left"><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">定活俩便'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">事先不约定存期,</span>一次性存入,一次性取出的存款'<span style="color:#808080;">),</span></p>
  <p align="left"><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">通知'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">不约定存期,</span>支取时需要提前通知银行,约定支取时间和金额方能支取的存款'<span style="color:#808080;">),</span></p>
  <p align="left"><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">整存整取1</span>年'<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">整笔存入,</span>到期提取本息'<span style="color:#808080;">),(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">整存整取2</span>年'<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">整笔存入,</span>到期提取本息'<span style="color:#808080;">),</span></p>
  <p align="left"><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">整存整取3</span>年'<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">整笔存入,</span>到期提取本息'<span style="color:#808080;">),(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">零存整取1</span>年'<span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">事先约定金额,</span>逐月按约定金额存入,到期支付本息'<span style="color:#808080;">),(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">零存整取2</span>年'<span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">事先约定金额,</span>逐月按约定金额存入,到期支付本息'<span style="color:#808080;">),(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">零存整取3</span>年'<span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">事先约定金额,</span>逐月按约定金额存入,到期支付本息'<span style="color:#808080;">),(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">自助转账'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">银行ATM</span>存取款机上办理银行卡之间的相互转账'<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankBusinessType</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left">&nbsp;</p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">张飞'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'150203197611154224'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'13088447030'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">包头市昆区宝钢五中'</span><span style="color:#808080;">),(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">关羽'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'15020319761005123X'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'0472-2315490'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">包头昆区阿尔丁大街'</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left">&nbsp;</p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'197611'</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span>1<span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'2018-05-28'</span><span style="color:#808080;">,</span>1000<span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span>1<span style="color:#808080;">,</span>1000<span style="color:#808080;">),(</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'197711'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span>2<span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-28'</span><span style="color:#808080;">,</span>1500<span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span>2<span style="color:#808080;">,</span>1500<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left">&nbsp;</p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>500<span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">单位1</span>月工资'<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>1500<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">单位2</span>月工资'<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>600<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支付宝付款'</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>700<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">刷卡消费'</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>3000<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">单位1</span>月工资'<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>2800<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">单位2</span>月工资'<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>1600<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支付宝付款'</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-29'</span><span style="color:#808080;">,</span>900<span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">刷卡消费'</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left">&nbsp;<span style="font-weight:bold;">修改客户密码</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">修改客户密码</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">根据卡号修改指定2</span>个客户的银行密码，其中第一个客户1010 3576 1234 5678密码修改为123456，第二个客户1010 3576 1234 5688修改为123123.</p>
  </div>
  <p align="left"><span style="color:#FF00FF;">update</span> <span style="color:#008080;">BankCard</span><span style="color:#0000FF;">set</span> <span style="color:#008080;">BCPwd</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'123456'</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span></p>
  <p align="left"><span style="color:#FF00FF;">update</span> <span style="color:#008080;">BankCard</span><span style="color:#0000FF;">set</span> <span style="color:#008080;">BCPwd</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'123123'</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#FF0000;">&nbsp;</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">按照以下字段进行显示 '</span>卡号', '密码', '货币类型', '存储类型','开户日期', '开户金额','是否挂失', '客户编号','存款金额'</p>
  </div>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">密码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">货币类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BCBBTId</span> <span style="color:#0000FF;">as</span> </p>
  <p align="left"><span style="color:#008080;">存储类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户金额</span><span style="color:#808080;">,</span><span style="color:#008080;">BCRegLoss</span> </p>
  <p align="left"><span style="color:#0000FF;">as</span> <span style="color:#008080;">是否挂失</span><span style="color:#808080;">,</span><span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户编号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">存款金额</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-weight:bold;">办理银行卡挂失</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">办理银行卡挂失</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">卡号为1010 3576 1234 5678</span>的银行卡丢失，申请挂失，要求使用innerjoin语句显示如下图运行结果：</p>
  </div>
  <p align="left"><span style="color:#FF00FF;">update</span> <span style="color:#008080;">BankCard</span><span style="color:#0000FF;">set</span> <span style="color:#008080;">BCRegLoss</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">是'</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">密码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">货币类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">as</span> </p>
  <p align="left"><span style="color:#008080;">存储类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户金额</span><span style="color:#808080;">,</span><span style="color:#008080;">BCRegLoss</span> </p>
  <p align="left"><span style="color:#0000FF;">as</span> <span style="color:#008080;">是否挂失</span><span style="color:#808080;">,</span><span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户编号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">存款金额</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> </p>
  <p align="left"><span style="color:#808080;">inner</span> <span style="color:#808080;">join</span> <span style="color:#008080;">BankBusinessType</span> <span style="color:#0000FF;">on</span> <span style="color:#008080;">BCBBTId</span><span style="color:#808080;">=</span><span style="color:#008080;">BBTId</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p><strong>统计银行资金流通余额和盈利结算</strong></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">使用存储过程 </span><span style="color:#FF0000;">proc_BanlanceAndProfit,</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">统计银行资金流通余额和盈利结算</span></p>
   <p align="left"><span style="color:#008000;">&nbsp;-- 1.</span><span style="color:#008000;">获取总存入金额和总支取金额</span></p>
   <p align="left"><span style="color:#008000;">盈利余额=</span>总存入金额*0.008-总支取金额*0.003</p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'proc_BanlanceAndProfit'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">proc_BanlanceAndProfit</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">proc_BanlanceAndProfit</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@inMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@outMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@i</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">=</span>1<span style="color:#808080;">,</span><span style="color:#008080;">@BDDealType</span> <span style="color:#0000FF;">Char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@BDDealAcount</span><span style="color:#0000FF;">money</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">while</span><span style="color:#808080;">(</span><span style="color:#008080;">@i</span><span style="color:#808080;">&lt;=</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#FF00FF;">max</span><span style="color:#808080;">(</span><span style="color:#008080;">BDNo</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span><span style="color:#808080;">)))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealType</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">from</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankDealInfo</span><span style="color:#0000FF;">where</span> <span style="color:#008080;">BDNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@i</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@inMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@BDDealAcount</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span> <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@outMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@BDDealAcount</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@i</span><span style="color:#808080;">+=</span>1</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入总金额：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@inMoney</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'RMB,</span><span style="color:#FF0000;">支取总金额：'</span><span style="color:#808080;">+</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@outMoney</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'RMB'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">盈利余额为：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@inMoney</span><span style="color:#808080;">*</span>0.008<span style="color:#808080;">-</span><span style="color:#008080;">@outMoney</span><span style="color:#808080;">*</span>0.003<span style="color:#808080;">))</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">proc_BanlanceAndProfit</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-weight:bold;">查询本周开户信息</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">查询本周开户信息</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">密码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">货币类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">as</span> </p>
  <p align="left"><span style="color:#008080;">存储类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户金额</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> </p>
  <p align="left"><span style="color:#008080;">客户姓名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">存款金额</span><span style="color:#808080;">,</span><span style="color:#008080;">BCRegLoss</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">是否挂失</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">case</span> <span style="color:#0000FF;">when</span></p>
  <p align="left"><span style="color:#008080;">BCRegLoss</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">否'</span> <span style="color:#0000FF;">then</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">正常账户'</span> <span style="color:#0000FF;">else</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">挂失账户'</span> <span style="color:#0000FF;">end</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">账户状态</span> <span style="color:#0000FF;">from</span> </p>
  <p align="left"><span style="color:#008080;">BankCard</span><span style="color:#808080;">,</span><span style="color:#008080;">BankCustomer</span><span style="color:#808080;">,</span><span style="color:#008080;">BankBusinessType</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCBBTId</span><span style="color:#808080;">=</span><span style="color:#008080;">BBTId</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span></p>
  <p align="left"><span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">ww</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">())=</span>0</p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-weight:bold;">查询本月单次交易金额最高的卡号和总交易金额最高的卡号</span></p>
  <div style="background:#CCCCCC;">
   <p align="left">代码实现：</p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">查询</span></p>
   <p align="left"><span style="color:#008000;">--1.</span><span style="color:#008000;">本月单次交易金额最高的卡号</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#0000FF;">top</span> 1 <span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户金额</span></p>
  <p align="left"><span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span><span style="color:#808080;">,</span><span style="color:#008080;">BankDealInfo</span><span style="color:#808080;">,</span><span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDBCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">BCNo</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span></p>
  <p align="left"><span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">mm</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">())=</span>0 <span style="color:#0000FF;">order</span> <span style="color:#0000FF;">by</span> <span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">desc</span> </p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">&nbsp;</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--2. </span><span style="color:#008000;">总交易金额最高的卡号</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#0000FF;">top</span> 1 <span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户金额</span></p>
  <p align="left"><span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span><span style="color:#808080;">,</span><span style="color:#008080;">BankDealInfo</span><span style="color:#808080;">,</span><span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDBCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">BCNo</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span></p>
  <p align="left"><span style="color:#0000FF;">group</span> <span style="color:#0000FF;">by</span> <span style="color:#008080;">BDBCNo</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenAmount</span> <span style="color:#0000FF;">order</span> <span style="color:#0000FF;">by</span> <span style="color:#FF00FF;">sum</span><span style="color:#808080;">(</span><span style="color:#008080;">BDDealAcount</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">desc</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p>&nbsp;<span style="font-weight:bold;">查询挂失客户</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">查询挂失客户</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">查询挂失账号的客户信息，分别利用子查询in</span>的方式或者内部连接inner join，查询结果如下图所示：</p>
  </div>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户姓名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCTel</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户电话</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span></p>
  <p align="left"><span style="color:#008080;">BCID</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCRegLoss</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">是'</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">&nbsp;</span><span style="font-weight:bold;">催款提醒业务</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">催款提醒业务</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">根据某种业务（如代缴电话费、代缴手机费或房贷等）的需要，每个月末，查询出客户账户上余额少于2000</span>元，由银行统一致电催款。</p>
  </div>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户姓名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCTel</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户电话</span><span style="color:#808080;">,</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户余额</span></p>
  <p align="left"><span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#808080;">inner</span> <span style="color:#808080;">join</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">on</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCExistBalance</span><span style="color:#808080;">&lt;</span>2000</p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-weight:bold;">输出银行客户记录视图VW_userInfo</span></p>
  <p>为向客户提供友好的用户界面，使用T-SQL语句创建下面几个视图，并使用这些视图输出各表信息。</p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">&nbsp;--</span><span style="color:#008000;">输出银行客户记录视图VW_userInfo</span></p>
   <p align="left">&nbsp;<span style="color:#008000;">--</span><span style="color:#008000;">显示的列名全为中文，要求先判断该视图是否存在，若存在，则先删除。结果如下图所示：</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'VW_userInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_userInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_userInfo</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户编号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCICNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">身份证号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCTel</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">as</span> <span style="color:#008080;">电话号码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCAddr</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">居住地址</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">VW_userInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-weight:bold;">输出银行卡记录视图VW_CardInfo</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--(2)</span><span style="color:#008000;">输出银行卡记录视图VW_CardInfo</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'VW_CardInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_CardInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_CardInfo</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">货币类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">as</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">存储类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">存款金额</span><span style="color:#808080;">,</span><span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">密码</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">,</span><span style="color:#008080;">BCRegLoss</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">是否挂失</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span><span style="color:#808080;">,</span><span style="color:#008080;">BankBusinessType</span><span style="color:#808080;">,</span><span style="color:#008080;">BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span> <span style="color:#008080;">BBTId</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBBTId</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">VW_CardInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p><span style="font-size:22px;font-weight:bold;line-height:30px;">输出银行卡交易记录视图VW_TransInfo</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">输出银行卡交易记录视图VW_TransInfo</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">查询该视图，结果如下图所示：</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'VW_TransInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_TransInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_TransInfo</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">BDDealDate</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">交易日期</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealType</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">交易类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BDBCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">交易卡号</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealAcount</span><span style="color:#0000FF;">as</span> <span style="color:#008080;">交易金额</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealComment</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">备注</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> </p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">VW_TransInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">根据客户登录名查询该客户账户信息VW_OneUserInfo</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">根据客户登录名查询该客户账户信息VW_OneUserInfo</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'VW_OneUserInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_OneUserInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">view</span> <span style="color:#008080;">VW_OneUserInfo</span> </p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户编号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCICNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">身份证号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCTel</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">as</span> <span style="color:#008080;">电话号码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCAddr</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">居住地址</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCName</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">system_user</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">VW_OneUserInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">完成存款或取款业务</span></p>
  <p>描述：</p>
  <p>Ø&nbsp; 根据银行卡号和交易金额实现银行卡的存款和取款业务。</p>
  <p>Ø&nbsp; 每一笔存款，取款业务都要计入银行交易账户，并同时更新客户的存款余额。</p>
  <p>Ø&nbsp; 如果是取款业务，在记账之前，要完成下面两项数据的检查验证工作，如果检查不合格，那么中断取款业务，给出提示信息后退出。</p>
  <p>²&nbsp; 检查客户输入的密码是否正确。</p>
  <p>²&nbsp; 账户取款金额是否大于当前存款额加1。</p>
  <p>要求：</p>
  <p>Ø&nbsp; 取款或存款存储过程名为usp_takeMoney。</p>
  <p>Ø&nbsp; 编写一个存储过程完成存款和取款业务，并调用存储过程取钱或者存钱进行测试，测试数据是张飞的卡号支取100元（密码123456），关羽的卡号存入2100元。</p>
  <p>Ø&nbsp; &nbsp;</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建存取款业务的存储过程proc_TakeMoney</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">完成存款或取款业务</span></p>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'proc_TakeMoney'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">proc_TakeMoney</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">proc_TakeMoney</span> <span style="color:#008080;">@bcno</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">),</span><span style="color:#008080;">@saleMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@pwd</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>6<span style="color:#808080;">)=null</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@existBanlance</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@errorCount</span> <span style="color:#0000FF;">int</span> <span style="color:#808080;">=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@existBanlance</span><span style="color:#808080;">=</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@bcno</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">不返回受影响的行数</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#0000FF;">nocount</span> <span style="color:#0000FF;">on</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易前，卡号'</span><span style="color:#808080;">+</span><span style="color:#008080;">@bcno</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">，余额为：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@existBanlance</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易正进行，请稍后...'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">如果输入参数@pwd</span>为空，则为存款业务，否则为取款业务</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if </span><span style="color:#808080;">(</span><span style="color:#008080;">@pwd</span> <span style="color:#808080;">is</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span>&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--1. </span><span style="color:#008000;">办理取款业务</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">判断指定卡号和密码是否存在，若存在，则可以取款，否则不能办理取款业务</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">判断取款金额是否小于等于存款余额-1</span>，若条件成立，则可以取款，否则不能取款</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@bcno</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCPwd</span><span style="color:#808080;">=</span><span style="color:#008080;">@pwd</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">money</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@bcno</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCPwd</span><span style="color:#808080;">=</span><span style="color:#008080;">@pwd</span><span style="color:#808080;">))-</span>1<span style="color:#808080;">&lt;=</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存款余额不足，不能办理取款业务！！'</span><span style="color:#808080;">,</span>15<span style="color:#808080;">,</span>1<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span><span style="color:#008080;">@existBanlance</span><span style="color:#808080;">-=</span><span style="color:#008080;">@saleMoney</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">insert</span><span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span><span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#008080;">@bcno</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">取款'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span><span style="color:#008080;">@errorCount</span><span style="color:#808080;">+=</span><span style="color:#FF00FF;">@@error</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">不能办理取款业务！！'</span><span style="color:#808080;">,</span>15<span style="color:#808080;">,</span>1<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--2. </span><span style="color:#008000;">办理存款业务 </span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">判断事务处理里是否有异常，若没有异常，则提交，若有异常，则回滚</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">判断该交易为何种类型业务，若是存款，则现有余额等于原有余额加上存款金额</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@existBanlance</span><span style="color:#808080;">+=</span><span style="color:#008080;">@saleMoney</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#008080;">@bcno</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存款'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">+=</span><span style="color:#FF00FF;">@@error</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">&lt;&gt;</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取失败！！'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>2<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">commit</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易成功，交易金额为：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">卡号'</span><span style="color:#808080;">+</span><span style="color:#008080;">@bcno</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">，余额为：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@existBanlance</span><span style="color:#808080;">))</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">执行存款存储过程</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">proc_TakeMoney</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span>2100</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">执行取款存储过程</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">proc_TakeMoney</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span>100<span style="color:#808080;">,</span><span style="color:#FF0000;">'123456'</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span></p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p><span style="font-size:22px;font-weight:bold;line-height:30px;">产生随机卡号</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">使用存储过程 </span><span style="color:#008080;">Proc_randCardID</span><span style="color:#008000;">&nbsp;&nbsp; </span><span style="color:#008000;">产生随机卡号</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">随机生成后8</span>位卡号 &nbsp;[rand() 随机数 ]</p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">再把前面的8</span>位补上 '1010 3576'</p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">最后判断卡号是否存在,</span>如果存在则重新生成卡号的过程</p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'proc_randCardId'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">proc_randCardId</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">proc_randCardId</span> <span style="color:#008080;">@myCardId1</span><span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span> <span style="color:#0000FF;">output</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">while</span><span style="color:#808080;">(</span>1<span style="color:#808080;">=</span>1<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@num1</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>4<span style="color:#808080;">),</span><span style="color:#008080;">@num2</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>4<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@num1</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">rand</span><span style="color:#808080;">()*</span>10000<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@num2</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">rand</span><span style="color:#808080;">()*</span>10000<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@num1</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span>0<span style="color:#808080;">,</span>4<span style="color:#808080;">-</span><span style="color:#FF00FF;">len</span><span style="color:#808080;">(</span><span style="color:#008080;">@num1</span><span style="color:#808080;">))+</span><span style="color:#008080;">@num1</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@num2</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">replicate</span><span style="color:#808080;">(</span>0<span style="color:#808080;">,</span>4<span style="color:#808080;">-</span><span style="color:#FF00FF;">len</span><span style="color:#808080;">(</span><span style="color:#008080;">@num2</span><span style="color:#808080;">))+</span><span style="color:#008080;">@num2</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@myCardId1</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'1010 3576 '</span><span style="color:#808080;">+</span><span style="color:#008080;">@num1</span><span style="color:#808080;">+</span><span style="color:#FF0000;">' '</span><span style="color:#808080;">+</span><span style="color:#008080;">@num2</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@myCardId1</span> <span style="color:#808080;">not</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">break</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">declare</span> <span style="color:#008080;">@myCardId1</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">proc_randCardId</span><span style="color:#008080;">@myCardId1</span> <span style="color:#0000FF;">output</span></p>
  <p align="left"><span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">产生随机卡号为:'</span><span style="color:#808080;">+</span><span style="color:#008080;">@myCardId1</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">完成开户业务</span></p>
  <p>描述：</p>
  <p>Ø&nbsp; 利用存储过程为客户开设2个银行卡账户，开户时需要提供客户的信息有：开户名、身份证号、电话号码、开户金额、存款类型和地址。客户的信息见表所示：</p>
  <p>Ø&nbsp; 为成功开户的客户提供银行卡，且银行卡号唯一。</p>
  <p>要求：</p>
  <p>Ø&nbsp; 开户的存储过程名为usp_openAccount。</p>
  <p>Ø&nbsp; 使用下面的数据执行该存储过程，进行测试：调用此存储过程开户。</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">完成开户业务</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建开户存储过程usp_openAccount</span>，输入参数分别是开户名、身份证号、</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">电话号码、开户金额、存款类型和地址</span></p>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'usp_openAccount'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_openAccount</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_openAccount</span> <span style="color:#008080;">@BCName</span><span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@BCICNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>18<span style="color:#808080;">),</span></p>
  <p align="left"><span style="color:#008080;">@BCTel</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>12<span style="color:#808080;">),</span><span style="color:#008080;">@BCOpenAmount</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@BBTName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@BCAddr</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">先判断存款类型是否正确 </span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankBusinessType</span> <span style="color:#0000FF;">where</span><span style="color:#008080;">BBTName</span><span style="color:#808080;">=</span><span style="color:#008080;">@BBTName</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@errorCount</span> <span style="color:#0000FF;">int</span> <span style="color:#808080;">=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">插入一条客户信息记录&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#008080;">@BCName</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCICNo</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCTel</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCAddr</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">+=</span><span style="color:#FF00FF;">@@error</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">得到刚插入的客户信息的编号</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@BCID</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BCID</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">max</span><span style="color:#808080;">(</span><span style="color:#008080;">BCID</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">插入一条新开银行卡记录</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">exec</span> <span style="color:#008080;">proc_randCardId</span><span style="color:#008080;">@BCNo</span> <span style="color:#0000FF;">output</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#008080;">@BCNo</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BBTId</span> <span style="color:#0000FF;">from</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankBusinessType</span><span style="color:#0000FF;">where</span> <span style="color:#008080;">BBTName</span><span style="color:#808080;">=</span><span style="color:#008080;">@BBTName</span><span style="color:#808080;">),</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCOpenAmount</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@BCID</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCOpenAmount</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">+=</span><span style="color:#FF00FF;">@@error</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">判断上述事务操作是否有异常</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--1.</span><span style="color:#008000;">如果错误 '</span>尊敬的客户，开户不成功，所有操作均撤销'</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">&lt;&gt;</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span><span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">尊敬的客户，开户不成功，所有操作均撤销！！'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>2<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">-- 2. </span><span style="color:#008000;">如果成功 '</span>尊敬的客户，开户成功，系统为你产生的</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">随机卡号是'+@BCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">尊敬的客户，开户成功，系统为你产生的'</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">随机卡号是'</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">commit</span><span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">错误显示 '</span>尊敬的客户，未能成功开户，存款类型不正确，请重新输入'</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">尊敬的客户，未能成功开户，存款类型不正确，请重新输入'</span><span style="color:#808080;">,</span>15<span style="color:#808080;">,</span>1<span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">执行开户过程</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">dbo</span><span style="color:#808080;">.</span><span style="color:#008080;">usp_openAccount</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">周公旦'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'150203197510074339'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'0472-2457890'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'1200.00'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">定活俩便'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">内蒙古包头'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">dbo</span><span style="color:#808080;">.</span><span style="color:#008080;">usp_openAccount</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">姬昌'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'150203197610174339'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'0472-2457890'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'1300.00'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">活期'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">内蒙古包头'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">dbo</span><span style="color:#808080;">.</span><span style="color:#008080;">usp_openAccount</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">白天磊'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'150207199301252316'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'18347261609'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'10000000'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">通知'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">内蒙古包头'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">dbo</span><span style="color:#808080;">.</span><span style="color:#008080;">usp_openAccount</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">白天帅'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'150203197510074339'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'15102274286'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'1200.00'</span><span style="color:#808080;">,</span></p>
  <p align="left"><span style="color:#FF0000;">'</span><span style="color:#FF0000;">定活俩便'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">天津'</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><strong><span style="color:#008000;">&nbsp;</span></strong></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">显示开户的客户信息和银行卡信息</span></p>
  <p align="left"><span style="color:#008000;">--'</span><span style="color:#008000;">客户编号', '</span>开户名', '身份证号', '电话号码', '居住地址',</p>
  <p align="left"><span style="color:#008000;">--'</span><span style="color:#008000;">卡号', '</span>客户', '货币种类', '存款类型', '余额', '密码', '是否挂失' </p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户编号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">开户名</span><span style="color:#808080;">,</span><span style="color:#008080;">BCICNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">身份证号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCTel</span></p>
  <p align="left"><span style="color:#0000FF;">as</span> <span style="color:#008080;">电话号码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCAddr</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">居住地址</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left">&nbsp;</p>
  <p align="left"><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">卡号</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">客户</span><span style="color:#808080;">,</span><span style="color:#008080;">BCCurrency</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">货币类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">as</span> </p>
  <p align="left"><span style="color:#008080;">存款类型</span><span style="color:#808080;">,</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">余额</span><span style="color:#808080;">,</span><span style="color:#008080;">BCPwd</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">密码</span><span style="color:#808080;">,</span><span style="color:#008080;">BCRegLoss</span> <span style="color:#0000FF;">as</span> <span style="color:#008080;">是否挂失</span> </p>
  <p align="left"><span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span><span style="color:#808080;">,</span><span style="color:#008080;">BankBusinessType</span><span style="color:#808080;">,</span><span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BBTId</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBBTId</span> </p>
  <p align="left"><span style="color:#808080;">and</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">分页显示查询交易数据</span></p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">分页显示查询交易数据</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">根据指定的页数和每页的记录数分页显示交易数据。要求：</span></p>
   <p align="left"><span style="color:#008000;">-- </span><span style="color:#008000;">显示第2</span>页 的5条信息</p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'usp_PagingDisplay'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_PagingDisplay</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_PagingDisplay</span> <span style="color:#008080;">@page</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#008080;">@info</span> <span style="color:#0000FF;">int</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#0000FF;">top</span><span style="color:#808080;">(</span><span style="color:#008080;">@page</span><span style="color:#808080;">*</span><span style="color:#008080;">@info</span><span style="color:#808080;">)</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDNo</span> <span style="color:#808080;">not</span> <span style="color:#808080;">in(</span><span style="color:#0000FF;">select</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">top</span><span style="color:#808080;">((</span><span style="color:#008080;">@page</span><span style="color:#808080;">-</span>1<span style="color:#808080;">)*</span><span style="color:#008080;">@info</span><span style="color:#808080;">)</span> <span style="color:#008080;">BDNo</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span><span style="color:#808080;">)</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_PagingDisplay</span>2<span style="color:#808080;">,</span>5</p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">打印客户对账单</span></p>
  <p>为某个特定的银行卡号打印指定时间内发生交易的对账单。要求如下：</p>
  <p>Ø&nbsp; 存储过程名称是usp_CheckSheet。</p>
  <p>Ø&nbsp; 分别采用以下两种方式执行存储过程，结果如下图所示。</p>
  <p>²&nbsp; 如果不指定交易时间段，那么打印指定卡号的所有交易记录，如测试命令：exec&nbsp; usp_CheckSheet '1010 3576 1234 5688'</p>
  <p>&nbsp;</p>
  <p>²&nbsp; 如果指定交易时间段，那么打印指定卡号在指定时间内发生的所有交易记录，如测试命令：</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">（5</span>）打印客户对账单</p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">创建客户对账单的存储过程usp_CheckSheet</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">判断客户对账单存储过程是否存在，若是存在，则删除</span></p>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'usp_CheckSheet'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_CheckSheet</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_CheckSheet</span> <span style="color:#008080;">@BCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">),</span><span style="color:#008080;">@startTime</span> <span style="color:#0000FF;">date</span><span style="color:#808080;">=null,</span></p>
  <p align="left"><span style="color:#008080;">@endTime</span> <span style="color:#0000FF;">date</span><span style="color:#808080;">=null</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@BCName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@BCCurrency</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>5<span style="color:#808080;">),</span><span style="color:#008080;">@BBTName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@BCOpenDate</span> <span style="color:#0000FF;">date</span><span style="color:#808080;">,</span><span style="color:#008080;">@i</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BCName</span><span style="color:#808080;">=</span><span style="color:#008080;">BCName</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCCurrency</span><span style="color:#808080;">=</span><span style="color:#008080;">BCCurrency</span><span style="color:#808080;">,</span><span style="color:#008080;">@BBTName</span><span style="color:#808080;">=</span><span style="color:#008080;">BBTName</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@BCOpenDate</span><span style="color:#808080;">=</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span><span style="color:#808080;">,</span><span style="color:#008080;">BankBusinessType</span><span style="color:#808080;">,</span><span style="color:#008080;">BankCard</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BBTId</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBBTId</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">卡号：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">姓名：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCName</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">货币：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCCurrency</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">存款类型：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@BBTName</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">开户日期：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCOpenDate</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易日&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">类型&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易金额&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">备注'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">打印客户对账单</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">while</span><span style="color:#808080;">(</span><span style="color:#008080;">@i</span><span style="color:#808080;">&lt;=</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#FF00FF;">max</span><span style="color:#808080;">(</span><span style="color:#008080;">BDNo</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span><span style="color:#808080;">)))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@BDDealDate</span> <span style="color:#0000FF;">date</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealType</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#008080;">@BDDealAcount</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@BDDealComment</span><span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@startTime</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@startTime</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">dateadd</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,-</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">datename</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()))+</span>1<span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">getdate</span><span style="color:#808080;">())</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@endTime</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@endTime</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BDDealDate</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealType</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealAcount</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealComment</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealComment</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDBCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@BCNo</span> <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span></p>
  <p align="left"><span style="color:#0000FF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#008080;">BDNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@i</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@BDDealDate</span> <span style="color:#808080;">is</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#808080;">and</span> <span style="color:#008080;">@BDDealType</span> <span style="color:#808080;">is</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#808080;">and</span> <span style="color:#008080;">@BDDealAcount</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">is</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null</span> <span style="color:#808080;">and</span> <span style="color:#008080;">@BDDealComment</span> <span style="color:#808080;">is</span> <span style="color:#808080;">not</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span><span style="color:#FF00FF;">rtrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealDate</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">rtrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#008080;">@BDDealType</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">,</span><span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#008080;">@BDDealComment</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@BDDealDate</span><span style="color:#808080;">=null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@BDDealType</span><span style="color:#808080;">=null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@BDDealAcount</span><span style="color:#808080;">=null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@BDDealComment</span><span style="color:#808080;">=null</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@i</span><span style="color:#808080;">+=</span>1</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">执行打印客户对账单</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_CheckSheet</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-15'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-06-15'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_CheckSheet</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">统计未发生交易的账户</span></p>
  <p>查询统计指定时间段内没有发生交易的账户信息。</p>
  <p>要求：</p>
  <p>存储过程名称是usp_getWithoutTrade。</p>
  <p>指定时间段</p>
  <p>如果没有指定起始日期，那么自本月1日开始进行统计，如果没有指定终止日期，那么截止到当日为止。</p>
  <p>要求采用游标技术打印未发生交易的客户信息，参考客户对账单的代码。</p>
  <p>该存储过程的执行结果如下图所示</p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">统计未发生交易的账户</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'usp_getWithoutTrade'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_getWithoutTrade</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_getWithoutTrade</span> <span style="color:#008080;">@startTime</span><span style="color:#0000FF;">date</span><span style="color:#808080;">=null,</span><span style="color:#008080;">@endTime</span> <span style="color:#0000FF;">date</span><span style="color:#808080;">=null</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left"><span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@startTime</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@startTime</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">dateadd</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,-</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">datename</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()))+</span>1<span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">getdate</span><span style="color:#808080;">())</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@endTime</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@endTime</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">cur_BankCustomer</span> <span style="color:#0000FF;">cursor</span><span style="color:#0000FF;">forward_only</span> <span style="color:#0000FF;">for</span><span style="color:#0000FF;">select</span> <span style="color:#0000FF;">distinct</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCID</span><span style="color:#808080;">,</span><span style="color:#008080;">BCName</span><span style="color:#808080;">,</span><span style="color:#008080;">BCICNo</span><span style="color:#808080;">,</span><span style="color:#008080;">BCTel</span><span style="color:#808080;">,</span><span style="color:#008080;">BCAddr</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#808080;">inner</span> <span style="color:#808080;">join</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">on</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=</span><span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span> <span style="color:#808080;">not</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BDBCNo</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0 </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0<span style="color:#808080;">)</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">open</span> <span style="color:#008080;">cur_BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@i</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@BCExistBalance</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@sumMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">客户编号&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">客户姓名&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">身份证号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">电话号码&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">地址'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">while</span><span style="color:#808080;">(</span>1<span style="color:#808080;">=</span>1<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@BCID</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@BCICNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>18<span style="color:#808080;">),</span><span style="color:#008080;">@BCTel</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>12<span style="color:#808080;">),</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@BCAddr</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>20<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">fetch</span> <span style="color:#0000FF;">next</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">cur_BankCustomer</span> <span style="color:#0000FF;">into</span><span style="color:#008080;">@BCID</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCName</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCICNo</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCTel</span><span style="color:#808080;">,</span><span style="color:#008080;">@BCAddr</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span> <span style="color:#FF00FF;">@@fetch_status</span><span style="color:#808080;">&lt;&gt;</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">break</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>11<span style="color:#808080;">),</span><span style="color:#008080;">@BCID</span><span style="color:#808080;">)+</span><span style="color:#FF00FF;">rtrim</span><span style="color:#808080;">(</span><span style="color:#008080;">@BCName</span><span style="color:#808080;">)+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCICNo</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCTel</span><span style="color:#808080;">+</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#008080;">@BCAddr</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@i</span><span style="color:#808080;">+=</span>1</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@BCExistBalance</span><span style="color:#808080;">=</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCBCId</span><span style="color:#808080;">=</span><span style="color:#008080;">@BCID</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@sumMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@BCExistBalance</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">close</span> <span style="color:#008080;">cur_BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">deallocate</span> <span style="color:#008080;">cur_BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">统计为发生交易的人数：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@i</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">人,</span>客户总余额为：'<span style="color:#808080;">+</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@sumMoney</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">元'</span></p>
  <p align="left"><span style="color:#0000FF;">end</span></p>
  <p align="left"><span style="color:#0000FF;">go</span>&nbsp; </p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_getWithoutTrade</span><span style="color:#FF0000;">'2018-05-28'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-28'</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:22px;font-weight:bold;line-height:30px;">统计银行卡交易量和交易额</span></p>
  <p>统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。</p>
  <p>要求：</p>
  <p>Ø&nbsp; 存储过程名称是usp_getTradeInfo。</p>
  <p>Ø&nbsp; 指定时间段和客户所在区域</p>
  <p>如果没有指定起始日期，那么自当年1月1日开始统计，如果没有指定终止日期，那么以当日作为截止日。</p>
  <p align="left">如果没有指定地点（根据客户所在地址查询），如北京，那么统计全部客户的交易量和交易额。</p>
  <div style="background:#CCCCCC;">
   <p align="left"><span style="color:#008000;">--(7)</span><span style="color:#008000;">统计银行卡交易量和交易额</span></p>
   <p align="left"><span style="color:#008000;">--</span><span style="color:#008000;">统计指定时间段内某地区客户在银行卡交易量和交易额，如果不指定地区，则查询所有客户的交易量和交易额。</span></p>
  </div>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'usp_getTradeInfo'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_getTradeInfo</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_getTradeInfo</span> <span style="color:#008080;">@startTime</span><span style="color:#0000FF;">date</span><span style="color:#808080;">=null,</span><span style="color:#008080;">@endTime</span> <span style="color:#0000FF;">date</span><span style="color:#808080;">=null,</span></p>
  <p align="left"><span style="color:#008080;">@addr</span> <span style="color:#0000FF;">varchar</span><span style="color:#808080;">(</span>100<span style="color:#808080;">)=null</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@inCount</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@outCount</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@inMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@outMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008080;">@sumInMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@sumOutMoney</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@i</span> <span style="color:#0000FF;">int</span><span style="color:#808080;">=</span>1</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">while</span><span style="color:#808080;">(</span><span style="color:#008080;">@i</span><span style="color:#808080;">&lt;=</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,(</span><span style="color:#0000FF;">select</span> <span style="color:#FF00FF;">max</span><span style="color:#808080;">(</span><span style="color:#008080;">BDNo</span><span style="color:#808080;">)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span><span style="color:#808080;">)))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@startTime</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@startTime</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">dateadd</span><span style="color:#808080;">(</span><span style="color:#008080;">mm</span><span style="color:#808080;">,-</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">datename</span><span style="color:#808080;">(</span><span style="color:#008080;">mm</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">+</span>1<span style="color:#808080;">,</span><span style="color:#FF00FF;">dateadd</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,-</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">int</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">datename</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()))+</span>1<span style="color:#808080;">,</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@endTime</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@endTime</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">()</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span><span style="color:#808080;">(</span><span style="color:#008080;">@addr</span> <span style="color:#808080;">is</span> <span style="color:#808080;">null)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@inCount</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">count</span><span style="color:#808080;">(*)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@inMoney</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BDNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@i</span> <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@sumInMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@inMoney</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@outCount</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">count</span><span style="color:#808080;">(*)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@outMoney</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BDNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@i</span> <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@sumOutMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@outMoney</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@inCount</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">count</span><span style="color:#808080;">(*)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#008080;">BDBCNo</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCBCId</span><span style="color:#808080;">in(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCAddr</span><span style="color:#808080;">=</span><span style="color:#008080;">@addr</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@inMoney</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BDNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@i</span> <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#008080;">BDBCNo</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCBCId</span> <span style="color:#808080;">in(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span><span style="color:#008080;">BCAddr</span><span style="color:#808080;">=</span><span style="color:#008080;">@addr</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@sumInMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@inMoney</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@outCount</span><span style="color:#808080;">=</span><span style="color:#FF00FF;">count</span><span style="color:#808080;">(*)</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#008080;">BDBCNo</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCBCId</span><span style="color:#808080;">in(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCAddr</span><span style="color:#808080;">=</span><span style="color:#008080;">@addr</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span><span style="color:#008080;">@outMoney</span><span style="color:#808080;">=</span><span style="color:#008080;">BDDealAcount</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BDDealType</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span> <span style="color:#808080;">and</span> <span style="color:#008080;">BDNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@i</span> <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&gt;=</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#808080;">and</span> <span style="color:#FF00FF;">datediff</span><span style="color:#808080;">(</span><span style="color:#008080;">dd</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">,</span><span style="color:#008080;">BDDealDate</span><span style="color:#808080;">)&lt;=</span>0 <span style="color:#808080;">and</span> <span style="color:#008080;">BDBCNo</span> <span style="color:#808080;">in</span><span style="color:#808080;">(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCNo</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCBCId</span> <span style="color:#808080;">in(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCID</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">where</span><span style="color:#008080;">BCAddr</span><span style="color:#808080;">=</span><span style="color:#008080;">@addr</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@sumOutMoney</span><span style="color:#808080;">+=</span><span style="color:#008080;">@outMoney</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@i</span><span style="color:#808080;">+=</span>1</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">统计银行卡交易量和交易额'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">起始日期：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>21<span style="color:#808080;">),</span><span style="color:#008080;">@startTime</span><span style="color:#808080;">)+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">截止日期：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">,</span><span style="color:#008080;">@endTime</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入笔数：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@inCount</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">存入金额：'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@sumInMoney</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">支出笔数：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@outCount</span><span style="color:#808080;">))+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">支出金额：'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@sumOutMoney</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易总笔数：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@inCount</span><span style="color:#808080;">+</span><span style="color:#008080;">@outCount</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">结余金额：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@sumInMoney</span><span style="color:#808080;">-</span><span style="color:#008080;">@sumOutMoney</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span>&nbsp;&nbsp; </p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_getTradeInfo</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_getTradeInfo</span><span style="color:#008080;">@addr</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">包头市昆区宝钢五中'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_getTradeInfo</span><span style="color:#FF0000;">'2018-05-1'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-05-28'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_getTradeInfo</span><span style="color:#FF0000;">'2018-05-1'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'2018-12-30'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">包头市昆区宝钢五中'</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_getTradeInfo</span><span style="color:#008080;">@addr</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">内蒙古包头'</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="font-size:24px;font-weight:bold;line-height:32px;">利用事务实现转账</span></p>
  <p>使用存储过程和事务实现转账业务，操作步骤如下所示：</p>
  <p>(1) 从某一个账户支取一定金额的存款。</p>
  <p>(2) 将支取金额存入到另一个指定的账户中。</p>
  <p>(3) 分别打印此笔业务的转出账单和转入账单。</p>
  <p>&nbsp;&nbsp; 要求：</p>
  <p>(1) &nbsp;存储过程名称是usp_transfer。</p>
  <p>(2) 要求使用事务机制实现转账业务。</p>
  <p align="left"><span style="color:#0000FF;">if</span> <span style="color:#808080;">exists(</span><span style="color:#0000FF;">select</span> <span style="color:#808080;">*</span> <span style="color:#0000FF;">from</span> <span style="color:#00FF00;">sysobjects</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">name</span><span style="color:#808080;">=</span><span style="color:#FF0000;">'usp_transfer'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">drop</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_transfer</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">create</span> <span style="color:#0000FF;">procedure</span> <span style="color:#008080;">usp_transfer</span> <span style="color:#008080;">@outBCNo</span><span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">),</span><span style="color:#008080;">@inBCNo</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>19<span style="color:#808080;">),</span><span style="color:#008080;">@saleMoney</span> <span style="color:#0000FF;">money</span></p>
  <p align="left"><span style="color:#0000FF;">as</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@errorCount</span> <span style="color:#0000FF;">int</span> <span style="color:#808080;">=</span>0<span style="color:#808080;">,</span><span style="color:#008080;">@outBCExistBalance</span> <span style="color:#0000FF;">money</span><span style="color:#808080;">,</span><span style="color:#008080;">@inBCExistBalance</span> <span style="color:#0000FF;">money</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#008000;">--</span><span style="color:#008000;">不返回受影响的行数</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#0000FF;">nocount</span> <span style="color:#0000FF;">on</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#008080;">@outBCNo</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">支取'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">通过存储'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">+=</span><span style="color:#FF00FF;">@@error</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">insert</span> <span style="color:#0000FF;">into</span> <span style="color:#008080;">BankDealInfo</span> <span style="color:#0000FF;">values</span><span style="color:#808080;">(</span><span style="color:#008080;">@inBCNo</span><span style="color:#808080;">,</span><span style="color:#0000FF;">default</span><span style="color:#808080;">,</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">存入'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">通过存储'</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">set</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">+=</span><span style="color:#FF00FF;">@@error</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">if</span> <span style="color:#008080;">@errorCount</span><span style="color:#808080;">&lt;&gt;</span>0</p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">rollback</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">raiserror</span><span style="color:#808080;">(</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">转账失败！！'</span><span style="color:#808080;">,</span>18<span style="color:#808080;">,</span>2<span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">else</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">begin</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">commit</span> <span style="color:#0000FF;">tran</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">开始转账，请稍后...'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易正进行，请稍后...'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易成功，交易金额：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@outBCExistBalance</span><span style="color:#808080;">=</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@outBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">卡号：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@outBCNo</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">余额：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@outBCExistBalance</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@inBCExistBalance</span><span style="color:#808080;">=</span><span style="color:#008080;">BCExistBalance</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@inBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">卡号：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@inBCNo</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">余额：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@inBCExistBalance</span><span style="color:#808080;">))</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@outBCName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@outBCCurrency</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>5<span style="color:#808080;">),</span><span style="color:#008080;">@outBBTName</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@outBCOpenDate</span> <span style="color:#0000FF;">date</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@outBCName</span><span style="color:#808080;">=</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">from</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@outBCNo</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@outBCCurrency</span><span style="color:#808080;">=</span><span style="color:#008080;">BCCurrency</span><span style="color:#808080;">,</span><span style="color:#008080;">@outBCOpenDate</span><span style="color:#808080;">=</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">from</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@outBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@outBBTName</span><span style="color:#808080;">=</span><span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankBusinessType</span> <span style="color:#0000FF;">where</span><span style="color:#008080;">BBTId</span><span style="color:#808080;">=(</span><span style="color:#0000FF;">select</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCBBTId</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@outBCNo</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">打印出转出对账单'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span>&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">卡号：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@outBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">货币类型：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@outBCCurrency</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">存款类型：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@outBBTName</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">开户日期：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">,</span><span style="color:#008080;">@outBCOpenDate</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易日&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp; </span><span style="color:#FF0000;">类型&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易金额&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">备注'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">(),</span>120<span style="color:#808080;">)+</span><span style="color:#FF0000;">'&nbsp; </span><span style="color:#FF0000;">支取&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">))+</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">通过存储'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">declare</span> <span style="color:#008080;">@inBCName</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@inBCCurrency</span> <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>5<span style="color:#808080;">),</span><span style="color:#008080;">@inBBTName</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>20<span style="color:#808080;">),</span><span style="color:#008080;">@inBCOpenDate</span> <span style="color:#0000FF;">date</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@inBCName</span><span style="color:#808080;">=</span><span style="color:#008080;">BCName</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCustomer</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCID</span><span style="color:#808080;">=(</span><span style="color:#0000FF;">select</span> <span style="color:#008080;">BCBCId</span> <span style="color:#0000FF;">from</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@inBCNo</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@inBCCurrency</span><span style="color:#808080;">=</span><span style="color:#008080;">BCCurrency</span><span style="color:#808080;">,</span><span style="color:#008080;">@inBCOpenDate</span><span style="color:#808080;">=</span><span style="color:#008080;">BCOpenDate</span> <span style="color:#0000FF;">from</span> </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@inBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">select</span> <span style="color:#008080;">@inBBTName</span><span style="color:#808080;">=</span><span style="color:#008080;">BBTName</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankBusinessType</span> <span style="color:#0000FF;">where</span><span style="color:#008080;">BBTId</span><span style="color:#808080;">=(</span><span style="color:#0000FF;">select</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#008080;">BCBBTId</span> <span style="color:#0000FF;">from</span> <span style="color:#008080;">BankCard</span> <span style="color:#0000FF;">where</span> <span style="color:#008080;">BCNo</span><span style="color:#808080;">=</span><span style="color:#008080;">@inBCNo</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">打印出转入对账单'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span>&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">卡号：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@inBCNo</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">货币类型：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@inBCCurrency</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">存款类型：'</span><span style="color:#808080;">+</span><span style="color:#008080;">@inBBTName</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">开户日期：'</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">,</span><span style="color:#008080;">@inBCOpenDate</span><span style="color:#808080;">)</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易日&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'&nbsp;&nbsp; </span><span style="color:#FF0000;">类型&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">交易金额&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF0000;">'</span><span style="color:#FF0000;">备注'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF00FF;">convert</span><span style="color:#808080;">(</span><span style="color:#0000FF;">char</span><span style="color:#808080;">(</span>10<span style="color:#808080;">),</span><span style="color:#FF00FF;">getdate</span><span style="color:#808080;">(),</span>120<span style="color:#808080;">)+</span><span style="color:#FF0000;">'&nbsp; </span><span style="color:#FF0000;">存入&nbsp;&nbsp; '</span><span style="color:#808080;">+</span><span style="color:#FF00FF;">ltrim</span><span style="color:#808080;">(</span><span style="color:#FF00FF;">str</span><span style="color:#808080;">(</span><span style="color:#008080;">@saleMoney</span><span style="color:#808080;">))+</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#FF0000;">'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#FF0000;">通过存储'</span></p>
  <p align="left">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">print</span> <span style="color:#FF0000;">'---------------------------------------------------------------'</span>&nbsp;&nbsp; </p>
  <p align="left">&nbsp;&nbsp;&nbsp; <span style="color:#0000FF;">end</span></p>
  <p align="left"><span style="color:#0000FF;">go</span></p>
  <p align="left"><span style="color:#0000FF;">exec</span> <span style="color:#008080;">usp_transfer</span><span style="color:#FF0000;">'1010 3576 1234 5678'</span><span style="color:#808080;">,</span><span style="color:#FF0000;">'1010 3576 1234 5688'</span><span style="color:#808080;">,</span>100</p>
  <p align="left"><span style="color:#0000FF;">go</span></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/fffssso/article/details/80528840,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/fffssso/article/details/80528840,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
