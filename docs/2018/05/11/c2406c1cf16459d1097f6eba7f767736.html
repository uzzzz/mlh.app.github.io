<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>第四章：经典量化策略集锦（第六篇：交易系统终结者—海龟交易法则） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="第四章：经典量化策略集锦（第六篇：交易系统终结者—海龟交易法则）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="导语：作为策略锦集第六篇，再向大家介绍非常著名的交易系统—海龟交易法则。&nbsp; 一、策略阐述&nbsp; 1.海龟交易法则的由来&nbsp; &nbsp; &nbsp; Riachard Dennis 是七八十年代著名的期货投机商，是一位具有传奇色彩的人物，在多年&nbsp; 的投机生涯中，Dennis 出尽风头，给人的感觉是常常可以在最低点买进，然后在最高峰反手&nbsp; 卖空。&nbsp; &nbsp; &nbsp; 他相信优秀的交易员是后天培养而非天生的。在1983 年12 月，他招聘了23 名新人，昵&nbsp; 称为海龟，并对这些交易员进行了一个趋势跟踪交易策略培训。随后给予每个新人 100 万美&nbsp; 元的初始资金。经5 年的运作，大部分“海龟”的业绩非常惊人，其中最好的业绩达到1.72&nbsp; 亿美元。多年后，海龟交易法则公布于世，我们才有幸看到曾名噪一时的完整的海龟交易法&nbsp; 则。&nbsp; 2.海龟交易法则介绍&nbsp; A.市场与标的&nbsp; &nbsp; &nbsp; 海龟交易法则应用于流动性高的市场中，选择交易量较大的标的进行交易。本文以沪深&nbsp; 300 指数 ETF 为标的，构建海龟交易法则。&nbsp; B 、仓位：仓位是海龟交易系统最核心的部分，通过ATR 真实波幅指标来管理仓位。&nbsp; 第一步：计算True Range ，简称TR 。&nbsp; &nbsp; &nbsp; TR = Max ( H−L , H−P , P−L ) &nbsp;，其中H 为当日日内最高价，L 为当日日内最低价，P 为&nbsp; 前一日收盘价。&nbsp; 第二步：计算ATR&nbsp; &nbsp; &nbsp; ATR = mean ( TR , 20 ) , &nbsp;即计算过去 20 天的TR 的平均值，ATR 是 TR 的移动平均值&nbsp; 第三步：计算unit &nbsp;（法则的交易单位）&nbsp; &nbsp; &nbsp; Unit = (value * 1% ) / ATR &nbsp;，其中value*1% 即为总资产的 1%，考虑到国内最小变化量是&nbsp; 0.01 元，1 手是 100 股，所以1ATR 即为持1 股股票的资产最大变动，那么买入 1Unit 单位的&nbsp; 股票，使得总资产当天震幅不超过 1% &nbsp;。&nbsp; ----------------------- Page 95----------------------- C.开仓入市&nbsp; &nbsp; &nbsp; 海龟交易法则分两个交易系统，两者都为分钟回测，即盘中交易：&nbsp; 系统一：&nbsp; I 、若当前价格高于过去 20 &nbsp;日的最高价，则买入一个Unit&nbsp; II 、加仓：若股价在上一次买入的基础上上涨了0.5ATR，则加仓一个 Unit 。&nbsp; 系统二：&nbsp; I 、若当前价格高于过去 55 日的最高价，则买入一个Unit&nbsp; II 、加仓：若股价在上一次买入的基础上上涨了0.5N ，则加仓一个 Unit 。&nbsp; 举例：若某只股票 A 的ATR 为 1，20 &nbsp;日最高价为40 。&nbsp; 则当股价突破40 时买入一个Unit ，当股价突破40+0.5×1=40.5 时加仓一个 Unit 。&nbsp; 当股价突破40.5+0.5×1=41 时加仓一个 Unit 。&nbsp; D.止损：海龟交易法则规定，当价格比最后一次买入价格下跌2ATR 时，则卖出全部头寸止&nbsp; 损。&nbsp; E.止盈：两个系统分别采用不同参数来止盈。&nbsp; 系统一：当股价跌破10 日内最低价格时，清仓结束交易&nbsp; 系统二、当股价跌破20 &nbsp;日内最低价格时，清仓结束交易&nbsp; &nbsp; &nbsp; 考虑到系统一与系统二的差异性集中在参数上，本篇内容实现系统二，来向大家展示海&nbsp; 龟交易法则。&nbsp; &nbsp; &nbsp; 以下为策略实现的基本信息：&nbsp; &nbsp; &nbsp; 策略实现难度：2&nbsp; &nbsp; &nbsp; 实现过程中所需要用到的API 函数，ps:通过 MindGo 量化交易平台 API 文档快速掌握：&nbsp; 需要用到的API 函数 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;功能&nbsp; account.portfolio_value 获取账户总资产&nbsp; set_benchmark() &nbsp; &nbsp; &nbsp; &nbsp;设置基准指数&nbsp; ----------------------- Page 96----------------------- 二、代码示意图&nbsp; ----------------------- Page 97----------------------- 三、编写释义&nbsp; &nbsp; &nbsp; 本策略的编写难点在于理解海龟交易法则的运行逻辑，以下是海龟法则运行逻辑的梳理：&nbsp; &nbsp; &nbsp; 编写海龟交易法则的时候，建议采用主干+枝干的思路。&nbsp; ----------------------- Page 98----------------------- 四、最终结果&nbsp; 策略回测区间：2014.01.01-2018.01.29&nbsp; 回测资金：1000000&nbsp; 回测频率：分钟&nbsp; 回测结果：红色曲线为策略收益率曲线，蓝色曲线为对应的基准指数收益率曲线&nbsp; ----------------------- Page 99----------------------- 策略源代码：&nbsp; import pandas as pd &nbsp; import numpy as np &nbsp; #===========================初始化账户==================================&nbsp; == &nbsp; def initialize(account):&nbsp; &nbsp; &nbsp; account.security = &#39;159919.OF&#39;#确定交易标的&nbsp; &nbsp; &nbsp; set_benchmark(account.security)&nbsp; &nbsp; &nbsp; account.ART = 0#储存ATR 的值，每个交易 日更新一次&nbsp; &nbsp; &nbsp; account.unit = 0# 买卖单位的储存变量&nbsp; &nbsp; &nbsp; account.steam = False#交易系统&nbsp; &nbsp; &nbsp; account.price = 0 #记录系统的买入价，以便加仓和离市&nbsp; #======================盘前运行============================&nbsp; def before_trading_start(account,data): &nbsp;&nbsp; &nbsp; &nbsp; #更新n 值&nbsp; &nbsp; &nbsp; ATR=get_ATR(account,data)&nbsp; &nbsp; &nbsp; #获取账户总资产&nbsp; &nbsp; &nbsp; value=account.portfolio_value&nbsp; &nbsp; &nbsp; # 依本策略，计算一个单位的unit 为多少股, 以便后续下单交易,注意一共两个系统，因此&nbsp; 需要除以2&nbsp; &nbsp; &nbsp; account.unit = (value*0.01)/account.ATR&nbsp; &nbsp; &nbsp; if account.unit&lt;100:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;一个unit 单位的股数不满1 手，无法下单！&#39;)&nbsp; &nbsp; &nbsp; &nbsp; #======================设置买卖条件，分钟回测============================&nbsp; def handle_data(account,data):&nbsp; &nbsp; &nbsp; &nbsp; #====================系统 1================================&nbsp; &nbsp; &nbsp; #系统是否需要开启运作&nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取开启系统的结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = steam(account,data,55)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统开启&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = nowclose[0]&nbsp; &nbsp; &nbsp; #系统已经开启运作&nbsp; &nbsp; &nbsp; if account.steam == True:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取进行加仓结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=addtrade(account,data)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行结果加仓&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;buy&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统加仓&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp; ----------------------- Page 100----------------------- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price1 = nowclose[0]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取止盈结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=down(account,data)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行止盈，关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;sell&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统 1 止盈&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #止盈后情况价位记录&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = False&nbsp; &nbsp; &nbsp; #离场结果判断&nbsp; &nbsp; &nbsp; if account.steam==True:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取离场结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=giveuptrade(account,data,20)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行离场，关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;sell&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统 1 离场&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #离场后情况价位记录&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price=0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam=False&nbsp; #=================判断是否离场函数============================&nbsp; def giveuptrade(account,data,n):&nbsp; &nbsp; &nbsp; #根据系统来获取相应数据长度&nbsp; &nbsp; &nbsp; close = history(account.security, [&#39;low&#39;], n, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;low&#39;]&nbsp; &nbsp; &nbsp; close_min=min(close)&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp; &nbsp; &nbsp; if nowclose[0]&lt;close_min:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;sell&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; #==================判断是否止盈函数=================================&nbsp; def down(account,data):&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; n=account.ATR&nbsp; &nbsp; &nbsp; TP=account.price-2*n&nbsp; &nbsp; &nbsp; if nowclose[0]&lt;TP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;sell&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; #==================判断是否加仓函数=================================&nbsp; def addtrade(account,data):&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; ----------------------- Page 101----------------------- &nbsp; &nbsp; n=account.ATR&nbsp; &nbsp; &nbsp; TP=account.price+n/2&nbsp; &nbsp; &nbsp; if nowclose[0]&gt;TP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;buy&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; &nbsp; &nbsp; &nbsp; #==================判断系统开启函数=================================&nbsp; def steam(account,data,n):&nbsp; &nbsp; &nbsp; close = history(account.security, [&#39;close&#39;], n, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; close_max=max(close)&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp; &nbsp; &nbsp; if nowclose[0]&gt;close_max:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return False&nbsp; #==================计算 n 值的函数=================================&nbsp; def get_ATR(account,data):&nbsp; &nbsp; &nbsp; # 由于用到前20 个交易 日的n 值，ATR 计为过去 20 &nbsp;日的TR 均值&nbsp; &nbsp; &nbsp; price = history(account.security, [&#39;close&#39;,&#39;high&#39;,&#39;low&#39;], 21, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)&nbsp; &nbsp; &nbsp; h = price[&#39;high&#39;].iloc[1:] #最高价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; l= price[&#39;low&#39;].iloc[1:]#最低价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; rc = price[&#39;close&#39;].shift().iloc[1:]# 昨日收盘价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; #shift()操作专门是用于获取前收盘价数据的&nbsp; &nbsp; &nbsp; tr_list = []&nbsp; &nbsp; &nbsp; for i in range(0,20,1):&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = price[&#39;high&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l = price[&#39;low&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = price[&#39;close&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TR = max(h-l, h-rc, rc-l)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tr_list.append(TR)&nbsp; &nbsp; &nbsp; ATR=np.mean(tr_list)&nbsp; &nbsp; &nbsp; account.ATR=ATR&nbsp; &nbsp; &nbsp; return account.ATR&nbsp; ----------------------- Page 102----------------------- 阅读更多" />
<meta property="og:description" content="导语：作为策略锦集第六篇，再向大家介绍非常著名的交易系统—海龟交易法则。&nbsp; 一、策略阐述&nbsp; 1.海龟交易法则的由来&nbsp; &nbsp; &nbsp; Riachard Dennis 是七八十年代著名的期货投机商，是一位具有传奇色彩的人物，在多年&nbsp; 的投机生涯中，Dennis 出尽风头，给人的感觉是常常可以在最低点买进，然后在最高峰反手&nbsp; 卖空。&nbsp; &nbsp; &nbsp; 他相信优秀的交易员是后天培养而非天生的。在1983 年12 月，他招聘了23 名新人，昵&nbsp; 称为海龟，并对这些交易员进行了一个趋势跟踪交易策略培训。随后给予每个新人 100 万美&nbsp; 元的初始资金。经5 年的运作，大部分“海龟”的业绩非常惊人，其中最好的业绩达到1.72&nbsp; 亿美元。多年后，海龟交易法则公布于世，我们才有幸看到曾名噪一时的完整的海龟交易法&nbsp; 则。&nbsp; 2.海龟交易法则介绍&nbsp; A.市场与标的&nbsp; &nbsp; &nbsp; 海龟交易法则应用于流动性高的市场中，选择交易量较大的标的进行交易。本文以沪深&nbsp; 300 指数 ETF 为标的，构建海龟交易法则。&nbsp; B 、仓位：仓位是海龟交易系统最核心的部分，通过ATR 真实波幅指标来管理仓位。&nbsp; 第一步：计算True Range ，简称TR 。&nbsp; &nbsp; &nbsp; TR = Max ( H−L , H−P , P−L ) &nbsp;，其中H 为当日日内最高价，L 为当日日内最低价，P 为&nbsp; 前一日收盘价。&nbsp; 第二步：计算ATR&nbsp; &nbsp; &nbsp; ATR = mean ( TR , 20 ) , &nbsp;即计算过去 20 天的TR 的平均值，ATR 是 TR 的移动平均值&nbsp; 第三步：计算unit &nbsp;（法则的交易单位）&nbsp; &nbsp; &nbsp; Unit = (value * 1% ) / ATR &nbsp;，其中value*1% 即为总资产的 1%，考虑到国内最小变化量是&nbsp; 0.01 元，1 手是 100 股，所以1ATR 即为持1 股股票的资产最大变动，那么买入 1Unit 单位的&nbsp; 股票，使得总资产当天震幅不超过 1% &nbsp;。&nbsp; ----------------------- Page 95----------------------- C.开仓入市&nbsp; &nbsp; &nbsp; 海龟交易法则分两个交易系统，两者都为分钟回测，即盘中交易：&nbsp; 系统一：&nbsp; I 、若当前价格高于过去 20 &nbsp;日的最高价，则买入一个Unit&nbsp; II 、加仓：若股价在上一次买入的基础上上涨了0.5ATR，则加仓一个 Unit 。&nbsp; 系统二：&nbsp; I 、若当前价格高于过去 55 日的最高价，则买入一个Unit&nbsp; II 、加仓：若股价在上一次买入的基础上上涨了0.5N ，则加仓一个 Unit 。&nbsp; 举例：若某只股票 A 的ATR 为 1，20 &nbsp;日最高价为40 。&nbsp; 则当股价突破40 时买入一个Unit ，当股价突破40+0.5×1=40.5 时加仓一个 Unit 。&nbsp; 当股价突破40.5+0.5×1=41 时加仓一个 Unit 。&nbsp; D.止损：海龟交易法则规定，当价格比最后一次买入价格下跌2ATR 时，则卖出全部头寸止&nbsp; 损。&nbsp; E.止盈：两个系统分别采用不同参数来止盈。&nbsp; 系统一：当股价跌破10 日内最低价格时，清仓结束交易&nbsp; 系统二、当股价跌破20 &nbsp;日内最低价格时，清仓结束交易&nbsp; &nbsp; &nbsp; 考虑到系统一与系统二的差异性集中在参数上，本篇内容实现系统二，来向大家展示海&nbsp; 龟交易法则。&nbsp; &nbsp; &nbsp; 以下为策略实现的基本信息：&nbsp; &nbsp; &nbsp; 策略实现难度：2&nbsp; &nbsp; &nbsp; 实现过程中所需要用到的API 函数，ps:通过 MindGo 量化交易平台 API 文档快速掌握：&nbsp; 需要用到的API 函数 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;功能&nbsp; account.portfolio_value 获取账户总资产&nbsp; set_benchmark() &nbsp; &nbsp; &nbsp; &nbsp;设置基准指数&nbsp; ----------------------- Page 96----------------------- 二、代码示意图&nbsp; ----------------------- Page 97----------------------- 三、编写释义&nbsp; &nbsp; &nbsp; 本策略的编写难点在于理解海龟交易法则的运行逻辑，以下是海龟法则运行逻辑的梳理：&nbsp; &nbsp; &nbsp; 编写海龟交易法则的时候，建议采用主干+枝干的思路。&nbsp; ----------------------- Page 98----------------------- 四、最终结果&nbsp; 策略回测区间：2014.01.01-2018.01.29&nbsp; 回测资金：1000000&nbsp; 回测频率：分钟&nbsp; 回测结果：红色曲线为策略收益率曲线，蓝色曲线为对应的基准指数收益率曲线&nbsp; ----------------------- Page 99----------------------- 策略源代码：&nbsp; import pandas as pd &nbsp; import numpy as np &nbsp; #===========================初始化账户==================================&nbsp; == &nbsp; def initialize(account):&nbsp; &nbsp; &nbsp; account.security = &#39;159919.OF&#39;#确定交易标的&nbsp; &nbsp; &nbsp; set_benchmark(account.security)&nbsp; &nbsp; &nbsp; account.ART = 0#储存ATR 的值，每个交易 日更新一次&nbsp; &nbsp; &nbsp; account.unit = 0# 买卖单位的储存变量&nbsp; &nbsp; &nbsp; account.steam = False#交易系统&nbsp; &nbsp; &nbsp; account.price = 0 #记录系统的买入价，以便加仓和离市&nbsp; #======================盘前运行============================&nbsp; def before_trading_start(account,data): &nbsp;&nbsp; &nbsp; &nbsp; #更新n 值&nbsp; &nbsp; &nbsp; ATR=get_ATR(account,data)&nbsp; &nbsp; &nbsp; #获取账户总资产&nbsp; &nbsp; &nbsp; value=account.portfolio_value&nbsp; &nbsp; &nbsp; # 依本策略，计算一个单位的unit 为多少股, 以便后续下单交易,注意一共两个系统，因此&nbsp; 需要除以2&nbsp; &nbsp; &nbsp; account.unit = (value*0.01)/account.ATR&nbsp; &nbsp; &nbsp; if account.unit&lt;100:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;一个unit 单位的股数不满1 手，无法下单！&#39;)&nbsp; &nbsp; &nbsp; &nbsp; #======================设置买卖条件，分钟回测============================&nbsp; def handle_data(account,data):&nbsp; &nbsp; &nbsp; &nbsp; #====================系统 1================================&nbsp; &nbsp; &nbsp; #系统是否需要开启运作&nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取开启系统的结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = steam(account,data,55)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统开启&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = nowclose[0]&nbsp; &nbsp; &nbsp; #系统已经开启运作&nbsp; &nbsp; &nbsp; if account.steam == True:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取进行加仓结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=addtrade(account,data)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行结果加仓&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;buy&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统加仓&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp; ----------------------- Page 100----------------------- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price1 = nowclose[0]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取止盈结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=down(account,data)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行止盈，关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;sell&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统 1 止盈&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #止盈后情况价位记录&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = False&nbsp; &nbsp; &nbsp; #离场结果判断&nbsp; &nbsp; &nbsp; if account.steam==True:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取离场结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=giveuptrade(account,data,20)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行离场，关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;sell&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统 1 离场&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #离场后情况价位记录&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price=0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam=False&nbsp; #=================判断是否离场函数============================&nbsp; def giveuptrade(account,data,n):&nbsp; &nbsp; &nbsp; #根据系统来获取相应数据长度&nbsp; &nbsp; &nbsp; close = history(account.security, [&#39;low&#39;], n, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;low&#39;]&nbsp; &nbsp; &nbsp; close_min=min(close)&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp; &nbsp; &nbsp; if nowclose[0]&lt;close_min:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;sell&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; #==================判断是否止盈函数=================================&nbsp; def down(account,data):&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; n=account.ATR&nbsp; &nbsp; &nbsp; TP=account.price-2*n&nbsp; &nbsp; &nbsp; if nowclose[0]&lt;TP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;sell&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; #==================判断是否加仓函数=================================&nbsp; def addtrade(account,data):&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; ----------------------- Page 101----------------------- &nbsp; &nbsp; n=account.ATR&nbsp; &nbsp; &nbsp; TP=account.price+n/2&nbsp; &nbsp; &nbsp; if nowclose[0]&gt;TP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;buy&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; &nbsp; &nbsp; &nbsp; #==================判断系统开启函数=================================&nbsp; def steam(account,data,n):&nbsp; &nbsp; &nbsp; close = history(account.security, [&#39;close&#39;], n, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; close_max=max(close)&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp; &nbsp; &nbsp; if nowclose[0]&gt;close_max:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return False&nbsp; #==================计算 n 值的函数=================================&nbsp; def get_ATR(account,data):&nbsp; &nbsp; &nbsp; # 由于用到前20 个交易 日的n 值，ATR 计为过去 20 &nbsp;日的TR 均值&nbsp; &nbsp; &nbsp; price = history(account.security, [&#39;close&#39;,&#39;high&#39;,&#39;low&#39;], 21, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)&nbsp; &nbsp; &nbsp; h = price[&#39;high&#39;].iloc[1:] #最高价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; l= price[&#39;low&#39;].iloc[1:]#最低价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; rc = price[&#39;close&#39;].shift().iloc[1:]# 昨日收盘价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; #shift()操作专门是用于获取前收盘价数据的&nbsp; &nbsp; &nbsp; tr_list = []&nbsp; &nbsp; &nbsp; for i in range(0,20,1):&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = price[&#39;high&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l = price[&#39;low&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = price[&#39;close&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TR = max(h-l, h-rc, rc-l)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tr_list.append(TR)&nbsp; &nbsp; &nbsp; ATR=np.mean(tr_list)&nbsp; &nbsp; &nbsp; account.ATR=ATR&nbsp; &nbsp; &nbsp; return account.ATR&nbsp; ----------------------- Page 102----------------------- 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-11T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"导语：作为策略锦集第六篇，再向大家介绍非常著名的交易系统—海龟交易法则。&nbsp; 一、策略阐述&nbsp; 1.海龟交易法则的由来&nbsp; &nbsp; &nbsp; Riachard Dennis 是七八十年代著名的期货投机商，是一位具有传奇色彩的人物，在多年&nbsp; 的投机生涯中，Dennis 出尽风头，给人的感觉是常常可以在最低点买进，然后在最高峰反手&nbsp; 卖空。&nbsp; &nbsp; &nbsp; 他相信优秀的交易员是后天培养而非天生的。在1983 年12 月，他招聘了23 名新人，昵&nbsp; 称为海龟，并对这些交易员进行了一个趋势跟踪交易策略培训。随后给予每个新人 100 万美&nbsp; 元的初始资金。经5 年的运作，大部分“海龟”的业绩非常惊人，其中最好的业绩达到1.72&nbsp; 亿美元。多年后，海龟交易法则公布于世，我们才有幸看到曾名噪一时的完整的海龟交易法&nbsp; 则。&nbsp; 2.海龟交易法则介绍&nbsp; A.市场与标的&nbsp; &nbsp; &nbsp; 海龟交易法则应用于流动性高的市场中，选择交易量较大的标的进行交易。本文以沪深&nbsp; 300 指数 ETF 为标的，构建海龟交易法则。&nbsp; B 、仓位：仓位是海龟交易系统最核心的部分，通过ATR 真实波幅指标来管理仓位。&nbsp; 第一步：计算True Range ，简称TR 。&nbsp; &nbsp; &nbsp; TR = Max ( H−L , H−P , P−L ) &nbsp;，其中H 为当日日内最高价，L 为当日日内最低价，P 为&nbsp; 前一日收盘价。&nbsp; 第二步：计算ATR&nbsp; &nbsp; &nbsp; ATR = mean ( TR , 20 ) , &nbsp;即计算过去 20 天的TR 的平均值，ATR 是 TR 的移动平均值&nbsp; 第三步：计算unit &nbsp;（法则的交易单位）&nbsp; &nbsp; &nbsp; Unit = (value * 1% ) / ATR &nbsp;，其中value*1% 即为总资产的 1%，考虑到国内最小变化量是&nbsp; 0.01 元，1 手是 100 股，所以1ATR 即为持1 股股票的资产最大变动，那么买入 1Unit 单位的&nbsp; 股票，使得总资产当天震幅不超过 1% &nbsp;。&nbsp; ----------------------- Page 95----------------------- C.开仓入市&nbsp; &nbsp; &nbsp; 海龟交易法则分两个交易系统，两者都为分钟回测，即盘中交易：&nbsp; 系统一：&nbsp; I 、若当前价格高于过去 20 &nbsp;日的最高价，则买入一个Unit&nbsp; II 、加仓：若股价在上一次买入的基础上上涨了0.5ATR，则加仓一个 Unit 。&nbsp; 系统二：&nbsp; I 、若当前价格高于过去 55 日的最高价，则买入一个Unit&nbsp; II 、加仓：若股价在上一次买入的基础上上涨了0.5N ，则加仓一个 Unit 。&nbsp; 举例：若某只股票 A 的ATR 为 1，20 &nbsp;日最高价为40 。&nbsp; 则当股价突破40 时买入一个Unit ，当股价突破40+0.5×1=40.5 时加仓一个 Unit 。&nbsp; 当股价突破40.5+0.5×1=41 时加仓一个 Unit 。&nbsp; D.止损：海龟交易法则规定，当价格比最后一次买入价格下跌2ATR 时，则卖出全部头寸止&nbsp; 损。&nbsp; E.止盈：两个系统分别采用不同参数来止盈。&nbsp; 系统一：当股价跌破10 日内最低价格时，清仓结束交易&nbsp; 系统二、当股价跌破20 &nbsp;日内最低价格时，清仓结束交易&nbsp; &nbsp; &nbsp; 考虑到系统一与系统二的差异性集中在参数上，本篇内容实现系统二，来向大家展示海&nbsp; 龟交易法则。&nbsp; &nbsp; &nbsp; 以下为策略实现的基本信息：&nbsp; &nbsp; &nbsp; 策略实现难度：2&nbsp; &nbsp; &nbsp; 实现过程中所需要用到的API 函数，ps:通过 MindGo 量化交易平台 API 文档快速掌握：&nbsp; 需要用到的API 函数 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;功能&nbsp; account.portfolio_value 获取账户总资产&nbsp; set_benchmark() &nbsp; &nbsp; &nbsp; &nbsp;设置基准指数&nbsp; ----------------------- Page 96----------------------- 二、代码示意图&nbsp; ----------------------- Page 97----------------------- 三、编写释义&nbsp; &nbsp; &nbsp; 本策略的编写难点在于理解海龟交易法则的运行逻辑，以下是海龟法则运行逻辑的梳理：&nbsp; &nbsp; &nbsp; 编写海龟交易法则的时候，建议采用主干+枝干的思路。&nbsp; ----------------------- Page 98----------------------- 四、最终结果&nbsp; 策略回测区间：2014.01.01-2018.01.29&nbsp; 回测资金：1000000&nbsp; 回测频率：分钟&nbsp; 回测结果：红色曲线为策略收益率曲线，蓝色曲线为对应的基准指数收益率曲线&nbsp; ----------------------- Page 99----------------------- 策略源代码：&nbsp; import pandas as pd &nbsp; import numpy as np &nbsp; #===========================初始化账户==================================&nbsp; == &nbsp; def initialize(account):&nbsp; &nbsp; &nbsp; account.security = &#39;159919.OF&#39;#确定交易标的&nbsp; &nbsp; &nbsp; set_benchmark(account.security)&nbsp; &nbsp; &nbsp; account.ART = 0#储存ATR 的值，每个交易 日更新一次&nbsp; &nbsp; &nbsp; account.unit = 0# 买卖单位的储存变量&nbsp; &nbsp; &nbsp; account.steam = False#交易系统&nbsp; &nbsp; &nbsp; account.price = 0 #记录系统的买入价，以便加仓和离市&nbsp; #======================盘前运行============================&nbsp; def before_trading_start(account,data): &nbsp;&nbsp; &nbsp; &nbsp; #更新n 值&nbsp; &nbsp; &nbsp; ATR=get_ATR(account,data)&nbsp; &nbsp; &nbsp; #获取账户总资产&nbsp; &nbsp; &nbsp; value=account.portfolio_value&nbsp; &nbsp; &nbsp; # 依本策略，计算一个单位的unit 为多少股, 以便后续下单交易,注意一共两个系统，因此&nbsp; 需要除以2&nbsp; &nbsp; &nbsp; account.unit = (value*0.01)/account.ATR&nbsp; &nbsp; &nbsp; if account.unit&lt;100:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;一个unit 单位的股数不满1 手，无法下单！&#39;)&nbsp; &nbsp; &nbsp; &nbsp; #======================设置买卖条件，分钟回测============================&nbsp; def handle_data(account,data):&nbsp; &nbsp; &nbsp; &nbsp; #====================系统 1================================&nbsp; &nbsp; &nbsp; #系统是否需要开启运作&nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取开启系统的结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = steam(account,data,55)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统开启&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = nowclose[0]&nbsp; &nbsp; &nbsp; #系统已经开启运作&nbsp; &nbsp; &nbsp; if account.steam == True:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取进行加仓结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=addtrade(account,data)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行结果加仓&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;buy&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统加仓&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp; ----------------------- Page 100----------------------- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price1 = nowclose[0]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取止盈结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=down(account,data)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行止盈，关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;sell&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统 1 止盈&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #止盈后情况价位记录&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = 0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = False&nbsp; &nbsp; &nbsp; #离场结果判断&nbsp; &nbsp; &nbsp; if account.steam==True:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #获取离场结果&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal=giveuptrade(account,data,20)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #执行离场，关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if signal==&#39;sell&#39;:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info(&#39;系统 1 离场&#39;)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #离场后情况价位记录&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price=0&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam=False&nbsp; #=================判断是否离场函数============================&nbsp; def giveuptrade(account,data,n):&nbsp; &nbsp; &nbsp; #根据系统来获取相应数据长度&nbsp; &nbsp; &nbsp; close = history(account.security, [&#39;low&#39;], n, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;low&#39;]&nbsp; &nbsp; &nbsp; close_min=min(close)&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp; &nbsp; &nbsp; if nowclose[0]&lt;close_min:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;sell&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; #==================判断是否止盈函数=================================&nbsp; def down(account,data):&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; n=account.ATR&nbsp; &nbsp; &nbsp; TP=account.price-2*n&nbsp; &nbsp; &nbsp; if nowclose[0]&lt;TP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;sell&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; #==================判断是否加仓函数=================================&nbsp; def addtrade(account,data):&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; ----------------------- Page 101----------------------- &nbsp; &nbsp; n=account.ATR&nbsp; &nbsp; &nbsp; TP=account.price+n/2&nbsp; &nbsp; &nbsp; if nowclose[0]&gt;TP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return &#39;buy&#39;&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp; &nbsp; &nbsp; &nbsp; #==================判断系统开启函数=================================&nbsp; def steam(account,data,n):&nbsp; &nbsp; &nbsp; close = history(account.security, [&#39;close&#39;], n, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; close_max=max(close)&nbsp; &nbsp; &nbsp; nowclose = history(account.security, [&#39;close&#39;], 1, &#39;1m&#39;, False, &#39;pre&#39;, is_panel=1)[&#39;close&#39;]&nbsp; &nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp; &nbsp; &nbsp; if nowclose[0]&gt;close_max:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return True&nbsp; &nbsp; &nbsp; else:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return False&nbsp; #==================计算 n 值的函数=================================&nbsp; def get_ATR(account,data):&nbsp; &nbsp; &nbsp; # 由于用到前20 个交易 日的n 值，ATR 计为过去 20 &nbsp;日的TR 均值&nbsp; &nbsp; &nbsp; price = history(account.security, [&#39;close&#39;,&#39;high&#39;,&#39;low&#39;], 21, &#39;1d&#39;, False, &#39;pre&#39;, is_panel=1)&nbsp; &nbsp; &nbsp; h = price[&#39;high&#39;].iloc[1:] #最高价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; l= price[&#39;low&#39;].iloc[1:]#最低价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; rc = price[&#39;close&#39;].shift().iloc[1:]# 昨日收盘价，获取21 个需弃掉第一个&nbsp; &nbsp; &nbsp; #shift()操作专门是用于获取前收盘价数据的&nbsp; &nbsp; &nbsp; tr_list = []&nbsp; &nbsp; &nbsp; for i in range(0,20,1):&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; h = price[&#39;high&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; l = price[&#39;low&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = price[&#39;close&#39;].iloc[i]&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TR = max(h-l, h-rc, rc-l)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tr_list.append(TR)&nbsp; &nbsp; &nbsp; ATR=np.mean(tr_list)&nbsp; &nbsp; &nbsp; account.ATR=ATR&nbsp; &nbsp; &nbsp; return account.ATR&nbsp; ----------------------- Page 102----------------------- 阅读更多","@type":"BlogPosting","url":"/2018/05/11/c2406c1cf16459d1097f6eba7f767736.html","headline":"第四章：经典量化策略集锦（第六篇：交易系统终结者—海龟交易法则）","dateModified":"2018-05-11T00:00:00+08:00","datePublished":"2018-05-11T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/05/11/c2406c1cf16459d1097f6eba7f767736.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>第四章：经典量化策略集锦（第六篇：交易系统终结者—海龟交易法则）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views">
   导语：作为策略锦集第六篇，再向大家介绍非常著名的交易系统—海龟交易法则。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>一、策略阐述&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>1.海龟交易法则的由来&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; Riachard Dennis 是七八十年代著名的期货投机商，是一位具有传奇色彩的人物，在多年&nbsp;
  <br>
  <br>
  <br>的投机生涯中，Dennis 出尽风头，给人的感觉是常常可以在最低点买进，然后在最高峰反手&nbsp;
  <br>
  <br>
  <br>卖空。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 他相信优秀的交易员是后天培养而非天生的。在1983 年12 月，他招聘了23 名新人，昵&nbsp;
  <br>
  <br>
  <br>称为海龟，并对这些交易员进行了一个趋势跟踪交易策略培训。随后给予每个新人 100 万美&nbsp;
  <br>
  <br>
  <br>元的初始资金。经5 年的运作，大部分“海龟”的业绩非常惊人，其中最好的业绩达到1.72&nbsp;
  <br>
  <br>
  <br>亿美元。多年后，海龟交易法则公布于世，我们才有幸看到曾名噪一时的完整的海龟交易法&nbsp;
  <br>
  <br>
  <br>则。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>2.海龟交易法则介绍&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>A.市场与标的&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 海龟交易法则应用于流动性高的市场中，选择交易量较大的标的进行交易。本文以沪深&nbsp;
  <br>
  <br>
  <br>300 指数 ETF 为标的，构建海龟交易法则。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>B 、仓位：仓位是海龟交易系统最核心的部分，通过ATR 真实波幅指标来管理仓位。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>第一步：计算True Range ，简称TR 。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; TR = Max ( H−L , H−P , P−L ) &nbsp;，其中H 为当日日内最高价，L 为当日日内最低价，P 为&nbsp;
  <br>
  <br>
  <br>前一日收盘价。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>第二步：计算ATR&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; ATR = mean ( TR , 20 ) , &nbsp;即计算过去 20 天的TR 的平均值，ATR 是 TR 的移动平均值&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>第三步：计算unit &nbsp;（法则的交易单位）&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; Unit = (value * 1% ) / ATR &nbsp;，其中value*1% 即为总资产的 1%，考虑到国内最小变化量是&nbsp;
  <br>
  <br>
  <br>0.01 元，1 手是 100 股，所以1ATR 即为持1 股股票的资产最大变动，那么买入 1Unit 单位的&nbsp;
  <br>
  <br>
  <br>股票，使得总资产当天震幅不超过 1% &nbsp;。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 95-----------------------
  <br>
  <br>
  <br>C.开仓入市&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 海龟交易法则分两个交易系统，两者都为分钟回测，即盘中交易：&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>系统一：&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>I 、若当前价格高于过去 20 &nbsp;日的最高价，则买入一个Unit&nbsp;
  <br>
  <br>
  <br>II 、加仓：若股价在上一次买入的基础上上涨了0.5ATR，则加仓一个 Unit 。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>系统二：&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>I 、若当前价格高于过去 55 日的最高价，则买入一个Unit&nbsp;
  <br>
  <br>
  <br>II 、加仓：若股价在上一次买入的基础上上涨了0.5N ，则加仓一个 Unit 。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>举例：若某只股票 A 的ATR 为 1，20 &nbsp;日最高价为40 。&nbsp;
  <br>
  <br>
  <br>则当股价突破40 时买入一个Unit ，当股价突破40+0.5×1=40.5 时加仓一个 Unit 。&nbsp;
  <br>
  <br>
  <br>当股价突破40.5+0.5×1=41 时加仓一个 Unit 。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>D.止损：海龟交易法则规定，当价格比最后一次买入价格下跌2ATR 时，则卖出全部头寸止&nbsp;
  <br>
  <br>
  <br>损。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>E.止盈：两个系统分别采用不同参数来止盈。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>系统一：当股价跌破10 日内最低价格时，清仓结束交易&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>系统二、当股价跌破20 &nbsp;日内最低价格时，清仓结束交易&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 考虑到系统一与系统二的差异性集中在参数上，本篇内容实现系统二，来向大家展示海&nbsp;
  <br>
  <br>
  <br>龟交易法则。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 以下为策略实现的基本信息：&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 策略实现难度：2&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; 实现过程中所需要用到的API 函数，ps:通过 MindGo 量化交易平台 API 文档快速掌握：&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>需要用到的API 函数 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;功能&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>account.portfolio_value 获取账户总资产&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>set_benchmark() &nbsp; &nbsp; &nbsp; &nbsp;设置基准指数&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 96-----------------------
  <br>
  <br>
  <br>二、代码示意图&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 97-----------------------
  <br>
  <br>
  <br>三、编写释义&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>&nbsp; &nbsp; 本策略的编写难点在于理解海龟交易法则的运行逻辑，以下是海龟法则运行逻辑的梳理：&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; 编写海龟交易法则的时候，建议采用主干+枝干的思路。&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 98-----------------------
  <br>
  <br>
  <br>四、最终结果&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>策略回测区间：2014.01.01-2018.01.29&nbsp;
  <br>
  <br>
  <br>回测资金：1000000&nbsp;
  <br>
  <br>
  <br>回测频率：分钟&nbsp;
  <br>
  <br>
  <br>回测结果：红色曲线为策略收益率曲线，蓝色曲线为对应的基准指数收益率曲线&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 99-----------------------
  <br>
  <br>
  <br>策略源代码：&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>import pandas as pd &nbsp;
  <br>
  <br>
  <br>import numpy as np &nbsp;
  <br>
  <br>
  <br>#===========================初始化账户==================================&nbsp;
  <br>
  <br>
  <br>== &nbsp;
  <br>
  <br>
  <br>def initialize(account):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.security = '159919.OF'#确定交易标的&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; set_benchmark(account.security)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.ART = 0#储存ATR 的值，每个交易 日更新一次&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.unit = 0# 买卖单位的储存变量&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.steam = False#交易系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.price = 0 #记录系统的买入价，以便加仓和离市&nbsp;
  <br>
  <br>
  <br>#======================盘前运行============================&nbsp;
  <br>
  <br>
  <br>def before_trading_start(account,data): &nbsp;&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #更新n 值&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; ATR=get_ATR(account,data)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #获取账户总资产&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; value=account.portfolio_value&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; # 依本策略，计算一个单位的unit 为多少股, 以便后续下单交易,注意一共两个系统，因此&nbsp;
  <br>
  <br>
  <br>需要除以2&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.unit = (value*0.01)/account.ATR&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if account.unit&lt;100:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; log.info('一个unit 单位的股数不满1 手，无法下单！')&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp;
  <br>
  <br>
  <br>#======================设置买卖条件，分钟回测============================&nbsp;
  <br>
  <br>
  <br>def handle_data(account,data):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; #====================系统 1================================&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #系统是否需要开启运作&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if account.steam == False:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #获取开启系统的结果&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; account.steam = steam(account,data,55)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; if account.steam == False:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info('系统开启')&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, ['close'], 1, '1m', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = nowclose[0]&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #系统已经开启运作&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if account.steam == True:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #获取进行加仓结果&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; signal=addtrade(account,data)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #执行结果加仓&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; if signal=='buy':&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info('系统加仓')&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nowclose = history(account.security, ['close'], 1, '1m', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order(account.security,account.unit)&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 100-----------------------
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #买入后记录当前价位，以便加仓和离市&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price1 = nowclose[0]&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; else:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pass&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #获取止盈结果&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; signal=down(account,data)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #执行止盈，关闭系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; if signal=='sell':&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info('系统 1 止盈')&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #止盈后情况价位记录&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price = 0&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam = False&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #离场结果判断&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if account.steam==True:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #获取离场结果&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; signal=giveuptrade(account,data,20)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; #执行离场，关闭系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; if signal=='sell':&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log.info('系统 1 离场')&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; order_target(account.security,0)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #离场后情况价位记录&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.price=0&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #关闭系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; account.steam=False&nbsp;
  <br>
  <br>
  <br>#=================判断是否离场函数============================&nbsp;
  <br>
  <br>
  <br>def giveuptrade(account,data,n):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #根据系统来获取相应数据长度&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; close = history(account.security, ['low'], n, '1d', False, 'pre', is_panel=1)['low']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; close_min=min(close)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; nowclose = history(account.security, ['close'], 1, '1m', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if nowclose[0]&lt;close_min:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return 'sell'&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; else:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp;
  <br>
  <br>
  <br>#==================判断是否止盈函数=================================&nbsp;
  <br>
  <br>
  <br>def down(account,data):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; nowclose = history(account.security, ['close'], 1, '1m', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; n=account.ATR&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; TP=account.price-2*n&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if nowclose[0]&lt;TP:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return 'sell'&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; else:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>
  <br>#==================判断是否加仓函数=================================&nbsp;
  <br>
  <br>
  <br>def addtrade(account,data):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; nowclose = history(account.security, ['close'], 1, '1m', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 101-----------------------
  <br>
  <br>
  <br>&nbsp; &nbsp; n=account.ATR&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; TP=account.price+n/2&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if nowclose[0]&gt;TP:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return 'buy'&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; else:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return None&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp;
  <br>
  <br>
  <br>#==================判断系统开启函数=================================&nbsp;
  <br>
  <br>
  <br>def steam(account,data,n):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; close = history(account.security, ['close'], n, '1d', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; close_max=max(close)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; nowclose = history(account.security, ['close'], 1, '1m', False, 'pre', is_panel=1)['close']&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #最新价格突破过去N &nbsp;日最大收盘价，即为突破，开启系统&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; if nowclose[0]&gt;close_max:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return True&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; else:&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; return False&nbsp;
  <br>
  <br>
  <br>#==================计算 n 值的函数=================================&nbsp;
  <br>
  <br>
  <br>def get_ATR(account,data):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; # 由于用到前20 个交易 日的n 值，ATR 计为过去 20 &nbsp;日的TR 均值&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; price = history(account.security, ['close','high','low'], 21, '1d', False, 'pre', is_panel=1)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; h = price['high'].iloc[1:] #最高价，获取21 个需弃掉第一个&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; l= price['low'].iloc[1:]#最低价，获取21 个需弃掉第一个&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; rc = price['close'].shift().iloc[1:]# 昨日收盘价，获取21 个需弃掉第一个&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; #shift()操作专门是用于获取前收盘价数据的&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; tr_list = []&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; for i in range(0,20,1):&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; h = price['high'].iloc[i]&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; l = price['low'].iloc[i]&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; rc = price['close'].iloc[i]&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; TR = max(h-l, h-rc, rc-l)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; &nbsp; &nbsp; tr_list.append(TR)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; ATR=np.mean(tr_list)&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; account.ATR=ATR&nbsp;
  <br>
  <br>
  <br>&nbsp; &nbsp; return account.ATR&nbsp;
  <br>
  <br>
  <br>
  <br>
  <br>----------------------- Page 102----------------------- 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wuyusheng314/article/details/80279415,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wuyusheng314/article/details/80279415,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
