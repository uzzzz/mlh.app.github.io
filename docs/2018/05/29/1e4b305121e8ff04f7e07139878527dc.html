<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>区块链实战系列：众筹空间（NodeJs版本） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="区块链实战系列：众筹空间（NodeJs版本）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1 基础环境准备 1.1环境预览 1.2基础工程 Npm install -g truffle Npm install -g EthereumJS TestRPC Npm install -g supervisor Truffle init Npm init 1.3疑难解答 Web3依赖c++build tools python（only for python2.7），npm install web3会报？ Recommend：npm install –global –production windows-build-tools View more detail：https://github.com/nodejs/node-gyp#installation能合约开发 2 智能合约开发 2.1 基础表结构 pragma solidity ^0.4.21; /** * 官方文档众筹实现 * https://solidity.readthedocs.io/en/develop/types.html#structs * 1 存储方式：memory、storage，状态变量默认是storage而local变量默认是memory * 2 mapping类似java中字典key=&gt;value，但是没有数组常用操作：push * 3 require类似junit中断言 * 4 函数体操作状态变量必须有修饰符，view：对状态变量读操作，payable：支付操作 * 5 msg全局变量是配合web3使用 **/ contract CrowdFunding { // 表结构：众筹项目 struct Fund { // 众筹地址 address owner; // 众筹描述 string desc; // 众筹目标 uint goal; // 已筹金币 uint coins; // 是否结束 bool finished; // 捐赠人数 uint recordCounts; // 捐赠记录 mapping(uint =&gt; Record) records; // 原本使用 Record[] records 数组定义 // 但是貌似目前版本尚不支持 // 于是将 数组 拆分成 长度 + 映射 // https://solidity.readthedocs.io/en/develop/types.html#mappings } // 表结构：捐赠记录 struct Record { // 捐赠成员 address member; // 捐赠金币 uint coin; // 捐赠时间 uint time; } 2.2 查询操作 // 众筹地址列表 Fund[] funds; function CrowdFunding() public payable { } // 获取众筹项目数量 function getFundCount() public view returns (uint) { return funds.length; } // 获取众筹项目信息 // 参数：项目编号 // 返回：众筹地址 众筹描述 众筹目标 已筹金币 是否结束 function getFundInfo(uint fundIndex) public view returns (address, string, uint, uint, bool) { Fund storage fund = funds[fundIndex]; return (fund.owner, fund.desc, fund.goal, fund.coins, fund.finished); } // 获取众筹捐赠人数 function getRecordCount(uint fundIndex) public view returns (uint) { return funds[fundIndex].recordCounts; } // 获取众筹捐赠记录 // 参数：项目编号 记录编号 // 返回：捐赠成员 捐赠金币 捐赠时间 function getRecordInfo(uint fundIndex, uint recordIndex) public view returns (address, uint, uint) { Record storage record = funds[fundIndex].records[recordIndex]; return (record.member, record.coin, record.time); } 2.3 发起众筹 // 发起众筹： function raiseFund(address raiser, string info, uint goal) public { //funds.push(Fund(msg.sender, info, goal, 0, false, 0)); funds.push(Fund(raiser, info, goal, 0, false, 0)); } 2.4 账户支付操作 // 捐赠众筹： // https://solidity.readthedocs.io/en/latest/miscellaneous.html#modifiers // payable for functions: Allows them to receive Ether together with a call. function sendCoin(uint fundIndex) public payable { // 默认属性 // msg.sender 转账账户 // msg.value 转账数目 // 智能合约默认单位 wei // 1 ether = 10^18 wei // 引用拷贝 Fund storage fund = funds[fundIndex]; require(!fund.finished); // 转账 失败自动退出 fund.owner.transfer(msg.value); // 更新众筹信息 fund.coins += msg.value; fund.records[fund.recordCounts++] = Record(msg.sender, msg.value, now); fund.finished = fund.coins &gt;= fund.goal * 1 ether? true : false; } // fallback function：回退函数 防止抛出异常 // https://solidity.readthedocs.io/en/latest/contracts.html#fallback-function // if you want your contract to receive Ether, you have to implement a fallback function. function() public payable { } 3 NodeJs export众筹模型 3.1 合约编译 Truffle compile --reset 注意--reset是版本发生变化才生效，编译生成的合约\build\contracts\CrowdFunding.json 3.2 NodeJs引入abi协议、web3、truffle-contract /** * 众筹业务控model * @author wolf * @time 2018-05-01 */ var Web3 = require(&#39;web3&#39;); var contract = require(&quot;truffle-contract&quot;); var provider = new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;); //使用truffle-contract包的contract()方法 var CrowdFunding = contract( copy编译后文件：/build/contracts/CrowdFunding.json ); //UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address //没有默认地址，会报错:务必设置为自己的钱包地址，如果不知道，查看自己的客户端启动时，观察打印到控制台的地址 CrowdFunding.setProvider(provider); CrowdFunding.defaults({ from : &quot;0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf&quot; }); module.exports = function () { this.web3 = new Web3(provider); this.model = CrowdFunding; } 3.3 合约部署 Truffle migrate --reset 3.4 疑难解答 UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address **Option 1：** CrowdFunding.defaults({ from : &quot;0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf&quot; }); **Option2：** CrowdService.web3.eth.defaultAccount=account; 4 NodeJs众筹业务交互 4.1 web3交互基础信息 /** * 账户列表 * @param req * @param res */ get_accountsList:function (req, res) { res.send(CrowdService.web3.eth.accounts) }, /** * 查看区块数 * @param req * @param res */ get_blocksList : function (req, res) { res.send(CrowdService.web3.eth.blockNumber); }, /** * 查看默认账户/调用合约的账户 * @param req * @param res */ post_defaultAccount: function (req, res) { var account = req.body.account; var retMsg = new Message(); if (Checks.isNull(account)) { console.log(&quot;Current default: &quot; + CrowdService.web3.eth.defaultAccount); res.send(retMsg.success(&#39;合约调用默认账户：&#39;+ CrowdService.web3.eth.defaultAccount)); } else { CrowdService.web3.eth.defaultAccount=account; res.send(retMsg.success(&#39;更新合约调用默认账户：&#39;+ CrowdService.web3.eth.defaultAccount)) } }, /** * 查看账户余额 * @param req * @param res */ post_accountBalance : function (req, res) { var account = req.body.account; retMsg = new Message(); if (Checks.isNull(account)) { res.send(retMsg.fail(&#39;账户地址不能为空！&#39;)) } var balance = CrowdService.web3.eth.getBalance(account); res.send(balance) }, 4.2 众筹业务交互 /** * 发起众筹 * @param req * @param res */ post_raiseFund: function (req, res) { var raiser = req.body.raiser; var info = req.body.info; var goal = req.body.goal; if (Checks.isNull(raiser)) { raiser = CrowdService.web3.eth.accounts[0]; } CrowdService.model.deployed().then(function (instance) { return instance.raiseFund(raiser, info, goal, { gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); res.send(JSON.stringify({&quot;info&quot; : info, &quot;goal&quot;: goal, &quot;code&quot;: &quot;募集成功！&quot;})); }, /** * 捐赠众筹 * @param req * @param res */ post_donate: function (req, res) { var retMsg = new Message(); // sendCoin(uint fundIndex, address donater, uint coin) var fundIndex = req.body.fundIndex; var donater = req.body.donater; var coin = req.body.coin; /*if (Checks.isNull(fundIndex) || Checks.isNull(donater) || Checks.isNull(coin)) { res.send(JSON.stringify(retMsg.fail(&#39;众筹项目、捐赠账户、捐赠数量不能为空！！！&#39;))); }*/ CrowdService.web3.eth.defaultAccount = donater; CrowdService.model.deployed().then(function (instance) { return instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, &#39;ether&#39;), from: donater, gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); res.send(JSON.stringify(retMsg.success(&#39;捐赠成功！！！&#39;))); }, /** * 众筹列表 * @param req * @param res */ post_fundsList: function (req, res) { var total; var list = new Array(); var g; CrowdService.model.deployed().then(function (instance) { g=instance; return g.getFundCount(); }).then(function (total) { //promise循环 var promoseArray=[]; for (index=0; index &lt; total; index++) { promoseArray.push(g.getFundInfo(index)); } Promise.all(promoseArray).then(function (data) { res.send(JSON.stringify(data)); }) }); }, /** * 众筹详情 * @param req * @param res */ post_fundInfo: function (req, res) { var index = req.body.index; CrowdService.model.deployed().then(function (instance) { return instance.getFundInfo(index); }).then(function (result) { res.send(result); }); }, /** * 获取捐赠记录列表 * @param req * @param res */ post_recordsList: function (req, res) { var fundIndex = req.body.fundIndex; var g; CrowdService.model.deployed().then(function (instance) { g = instance; return g.getRecordCount(fundIndex); }).then(function (count) { console.log(count); if (count &lt;= 0) { res.send(&quot;没有捐赠记录&quot;); return; } var promiseArray=[]; for(x=0; x&lt;count; x++){ promiseArray.push(g.getRecordInfo(fundIndex, x)); } Promise.all(promiseArray).then(function (data) { res.send(JSON.stringify(data)); }) }); }, 4.3 基础工具 /** * 输出格式类 * @type {{code: number, msg: string, data: {total: number, pageNo: number, pageSize: number, object: {}, array: Array}}} * @author wolf * @time 2018/5/1 */ function Message () { this.result = { &quot;code&quot;: 0, &quot;msg&quot;: &quot;操作成功&quot;, &quot;data&quot;: {&quot;total&quot;: 0, &quot;pageNo&quot;: 1, &quot;pageSize&quot;: 10, &quot;object&quot;: {}, &quot;array&quot;: []} }; } Message.prototype.success = function (msg) { this.result.msg = msg; return this.result; } Message.prototype.fail = function (msg) { this.result.code = -1; this.result.msg = msg; return this.result; } Message.prototype.listPage = function (total, pageNo, list) { this.result.data.total = total; this.result.data.pageNo = pageNo; this.result.data.array = list; return this.result; } Message.prototype.setData = function (object) { this.result.data.object = object; return this.result; } module.exports = Message; 4.4 部署配置 var Migrations = artifacts.require(&quot;./Migrations.sol&quot;); var Test = artifacts.require(&quot;./Test.sol&quot;); var CrowdFunding = artifacts.require(&quot;./CrowdFunding.sol&quot;); module.exports = function (deployer) { deployer.deploy(Migrations); deployer.deploy(Test); deployer.deploy(CrowdFunding); }; 4.5 疑难解答 Promise循环 var promiseArray=[]; for(x=0; x&lt;count; x++){ promiseArray.push(g.getRecordInfo(fundIndex, x)); } Promise.all(promiseArray).then(function (data) { res.send(JSON.stringify(data)); }) Javascript prototype实现面向对象继承 Message.prototype.success = function (msg) { this.result.msg = msg; return this.result; } NodeJs静态导入 /** * 检查工具类 * @author wolf * @time 2018/5/1 */ function Checks() {} /** * 判断是否为空 * @param val * @returns */ Checks.isNull = function(val) { if (val == undefined || val == null || val == &quot;&quot; || val == &#39;&#39; || val == &quot;undefined&quot; || val == &quot;null&quot; || val == &quot;NULL&quot;) { return true; } return false; } module.exports = Checks; Msg全局变量使用（msg.sender、msg.value） for crowdfunding.sol : // 转账 失败自动退出 fund.owner.transfer(msg.value); // 更新众筹信息 fund.coins += msg.value; fund.records[fund.recordCounts++] = Record(msg.sender, msg.value, now); for crowdfunding.js: CrowdService.model.deployed().then(function (instance) { return instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, &#39;ether&#39;), from: donater, gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); 交易中total used gas = usedgas * gasPrice，而每次交易都需要预设gas（预估使用gas上限），使用完total used gas &gt; gas：out of gas error，相反多余的gas会在交易完退换账户 转账账户余额 = 默认账户总额 - msg.value - total used gas msg.sender定义为调用合约账户，合约也能隐形转换为合同账户 阅读更多" />
<meta property="og:description" content="1 基础环境准备 1.1环境预览 1.2基础工程 Npm install -g truffle Npm install -g EthereumJS TestRPC Npm install -g supervisor Truffle init Npm init 1.3疑难解答 Web3依赖c++build tools python（only for python2.7），npm install web3会报？ Recommend：npm install –global –production windows-build-tools View more detail：https://github.com/nodejs/node-gyp#installation能合约开发 2 智能合约开发 2.1 基础表结构 pragma solidity ^0.4.21; /** * 官方文档众筹实现 * https://solidity.readthedocs.io/en/develop/types.html#structs * 1 存储方式：memory、storage，状态变量默认是storage而local变量默认是memory * 2 mapping类似java中字典key=&gt;value，但是没有数组常用操作：push * 3 require类似junit中断言 * 4 函数体操作状态变量必须有修饰符，view：对状态变量读操作，payable：支付操作 * 5 msg全局变量是配合web3使用 **/ contract CrowdFunding { // 表结构：众筹项目 struct Fund { // 众筹地址 address owner; // 众筹描述 string desc; // 众筹目标 uint goal; // 已筹金币 uint coins; // 是否结束 bool finished; // 捐赠人数 uint recordCounts; // 捐赠记录 mapping(uint =&gt; Record) records; // 原本使用 Record[] records 数组定义 // 但是貌似目前版本尚不支持 // 于是将 数组 拆分成 长度 + 映射 // https://solidity.readthedocs.io/en/develop/types.html#mappings } // 表结构：捐赠记录 struct Record { // 捐赠成员 address member; // 捐赠金币 uint coin; // 捐赠时间 uint time; } 2.2 查询操作 // 众筹地址列表 Fund[] funds; function CrowdFunding() public payable { } // 获取众筹项目数量 function getFundCount() public view returns (uint) { return funds.length; } // 获取众筹项目信息 // 参数：项目编号 // 返回：众筹地址 众筹描述 众筹目标 已筹金币 是否结束 function getFundInfo(uint fundIndex) public view returns (address, string, uint, uint, bool) { Fund storage fund = funds[fundIndex]; return (fund.owner, fund.desc, fund.goal, fund.coins, fund.finished); } // 获取众筹捐赠人数 function getRecordCount(uint fundIndex) public view returns (uint) { return funds[fundIndex].recordCounts; } // 获取众筹捐赠记录 // 参数：项目编号 记录编号 // 返回：捐赠成员 捐赠金币 捐赠时间 function getRecordInfo(uint fundIndex, uint recordIndex) public view returns (address, uint, uint) { Record storage record = funds[fundIndex].records[recordIndex]; return (record.member, record.coin, record.time); } 2.3 发起众筹 // 发起众筹： function raiseFund(address raiser, string info, uint goal) public { //funds.push(Fund(msg.sender, info, goal, 0, false, 0)); funds.push(Fund(raiser, info, goal, 0, false, 0)); } 2.4 账户支付操作 // 捐赠众筹： // https://solidity.readthedocs.io/en/latest/miscellaneous.html#modifiers // payable for functions: Allows them to receive Ether together with a call. function sendCoin(uint fundIndex) public payable { // 默认属性 // msg.sender 转账账户 // msg.value 转账数目 // 智能合约默认单位 wei // 1 ether = 10^18 wei // 引用拷贝 Fund storage fund = funds[fundIndex]; require(!fund.finished); // 转账 失败自动退出 fund.owner.transfer(msg.value); // 更新众筹信息 fund.coins += msg.value; fund.records[fund.recordCounts++] = Record(msg.sender, msg.value, now); fund.finished = fund.coins &gt;= fund.goal * 1 ether? true : false; } // fallback function：回退函数 防止抛出异常 // https://solidity.readthedocs.io/en/latest/contracts.html#fallback-function // if you want your contract to receive Ether, you have to implement a fallback function. function() public payable { } 3 NodeJs export众筹模型 3.1 合约编译 Truffle compile --reset 注意--reset是版本发生变化才生效，编译生成的合约\build\contracts\CrowdFunding.json 3.2 NodeJs引入abi协议、web3、truffle-contract /** * 众筹业务控model * @author wolf * @time 2018-05-01 */ var Web3 = require(&#39;web3&#39;); var contract = require(&quot;truffle-contract&quot;); var provider = new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;); //使用truffle-contract包的contract()方法 var CrowdFunding = contract( copy编译后文件：/build/contracts/CrowdFunding.json ); //UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address //没有默认地址，会报错:务必设置为自己的钱包地址，如果不知道，查看自己的客户端启动时，观察打印到控制台的地址 CrowdFunding.setProvider(provider); CrowdFunding.defaults({ from : &quot;0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf&quot; }); module.exports = function () { this.web3 = new Web3(provider); this.model = CrowdFunding; } 3.3 合约部署 Truffle migrate --reset 3.4 疑难解答 UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address **Option 1：** CrowdFunding.defaults({ from : &quot;0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf&quot; }); **Option2：** CrowdService.web3.eth.defaultAccount=account; 4 NodeJs众筹业务交互 4.1 web3交互基础信息 /** * 账户列表 * @param req * @param res */ get_accountsList:function (req, res) { res.send(CrowdService.web3.eth.accounts) }, /** * 查看区块数 * @param req * @param res */ get_blocksList : function (req, res) { res.send(CrowdService.web3.eth.blockNumber); }, /** * 查看默认账户/调用合约的账户 * @param req * @param res */ post_defaultAccount: function (req, res) { var account = req.body.account; var retMsg = new Message(); if (Checks.isNull(account)) { console.log(&quot;Current default: &quot; + CrowdService.web3.eth.defaultAccount); res.send(retMsg.success(&#39;合约调用默认账户：&#39;+ CrowdService.web3.eth.defaultAccount)); } else { CrowdService.web3.eth.defaultAccount=account; res.send(retMsg.success(&#39;更新合约调用默认账户：&#39;+ CrowdService.web3.eth.defaultAccount)) } }, /** * 查看账户余额 * @param req * @param res */ post_accountBalance : function (req, res) { var account = req.body.account; retMsg = new Message(); if (Checks.isNull(account)) { res.send(retMsg.fail(&#39;账户地址不能为空！&#39;)) } var balance = CrowdService.web3.eth.getBalance(account); res.send(balance) }, 4.2 众筹业务交互 /** * 发起众筹 * @param req * @param res */ post_raiseFund: function (req, res) { var raiser = req.body.raiser; var info = req.body.info; var goal = req.body.goal; if (Checks.isNull(raiser)) { raiser = CrowdService.web3.eth.accounts[0]; } CrowdService.model.deployed().then(function (instance) { return instance.raiseFund(raiser, info, goal, { gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); res.send(JSON.stringify({&quot;info&quot; : info, &quot;goal&quot;: goal, &quot;code&quot;: &quot;募集成功！&quot;})); }, /** * 捐赠众筹 * @param req * @param res */ post_donate: function (req, res) { var retMsg = new Message(); // sendCoin(uint fundIndex, address donater, uint coin) var fundIndex = req.body.fundIndex; var donater = req.body.donater; var coin = req.body.coin; /*if (Checks.isNull(fundIndex) || Checks.isNull(donater) || Checks.isNull(coin)) { res.send(JSON.stringify(retMsg.fail(&#39;众筹项目、捐赠账户、捐赠数量不能为空！！！&#39;))); }*/ CrowdService.web3.eth.defaultAccount = donater; CrowdService.model.deployed().then(function (instance) { return instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, &#39;ether&#39;), from: donater, gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); res.send(JSON.stringify(retMsg.success(&#39;捐赠成功！！！&#39;))); }, /** * 众筹列表 * @param req * @param res */ post_fundsList: function (req, res) { var total; var list = new Array(); var g; CrowdService.model.deployed().then(function (instance) { g=instance; return g.getFundCount(); }).then(function (total) { //promise循环 var promoseArray=[]; for (index=0; index &lt; total; index++) { promoseArray.push(g.getFundInfo(index)); } Promise.all(promoseArray).then(function (data) { res.send(JSON.stringify(data)); }) }); }, /** * 众筹详情 * @param req * @param res */ post_fundInfo: function (req, res) { var index = req.body.index; CrowdService.model.deployed().then(function (instance) { return instance.getFundInfo(index); }).then(function (result) { res.send(result); }); }, /** * 获取捐赠记录列表 * @param req * @param res */ post_recordsList: function (req, res) { var fundIndex = req.body.fundIndex; var g; CrowdService.model.deployed().then(function (instance) { g = instance; return g.getRecordCount(fundIndex); }).then(function (count) { console.log(count); if (count &lt;= 0) { res.send(&quot;没有捐赠记录&quot;); return; } var promiseArray=[]; for(x=0; x&lt;count; x++){ promiseArray.push(g.getRecordInfo(fundIndex, x)); } Promise.all(promiseArray).then(function (data) { res.send(JSON.stringify(data)); }) }); }, 4.3 基础工具 /** * 输出格式类 * @type {{code: number, msg: string, data: {total: number, pageNo: number, pageSize: number, object: {}, array: Array}}} * @author wolf * @time 2018/5/1 */ function Message () { this.result = { &quot;code&quot;: 0, &quot;msg&quot;: &quot;操作成功&quot;, &quot;data&quot;: {&quot;total&quot;: 0, &quot;pageNo&quot;: 1, &quot;pageSize&quot;: 10, &quot;object&quot;: {}, &quot;array&quot;: []} }; } Message.prototype.success = function (msg) { this.result.msg = msg; return this.result; } Message.prototype.fail = function (msg) { this.result.code = -1; this.result.msg = msg; return this.result; } Message.prototype.listPage = function (total, pageNo, list) { this.result.data.total = total; this.result.data.pageNo = pageNo; this.result.data.array = list; return this.result; } Message.prototype.setData = function (object) { this.result.data.object = object; return this.result; } module.exports = Message; 4.4 部署配置 var Migrations = artifacts.require(&quot;./Migrations.sol&quot;); var Test = artifacts.require(&quot;./Test.sol&quot;); var CrowdFunding = artifacts.require(&quot;./CrowdFunding.sol&quot;); module.exports = function (deployer) { deployer.deploy(Migrations); deployer.deploy(Test); deployer.deploy(CrowdFunding); }; 4.5 疑难解答 Promise循环 var promiseArray=[]; for(x=0; x&lt;count; x++){ promiseArray.push(g.getRecordInfo(fundIndex, x)); } Promise.all(promiseArray).then(function (data) { res.send(JSON.stringify(data)); }) Javascript prototype实现面向对象继承 Message.prototype.success = function (msg) { this.result.msg = msg; return this.result; } NodeJs静态导入 /** * 检查工具类 * @author wolf * @time 2018/5/1 */ function Checks() {} /** * 判断是否为空 * @param val * @returns */ Checks.isNull = function(val) { if (val == undefined || val == null || val == &quot;&quot; || val == &#39;&#39; || val == &quot;undefined&quot; || val == &quot;null&quot; || val == &quot;NULL&quot;) { return true; } return false; } module.exports = Checks; Msg全局变量使用（msg.sender、msg.value） for crowdfunding.sol : // 转账 失败自动退出 fund.owner.transfer(msg.value); // 更新众筹信息 fund.coins += msg.value; fund.records[fund.recordCounts++] = Record(msg.sender, msg.value, now); for crowdfunding.js: CrowdService.model.deployed().then(function (instance) { return instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, &#39;ether&#39;), from: donater, gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); 交易中total used gas = usedgas * gasPrice，而每次交易都需要预设gas（预估使用gas上限），使用完total used gas &gt; gas：out of gas error，相反多余的gas会在交易完退换账户 转账账户余额 = 默认账户总额 - msg.value - total used gas msg.sender定义为调用合约账户，合约也能隐形转换为合同账户 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/05/29/1e4b305121e8ff04f7e07139878527dc.html" />
<meta property="og:url" content="https://mlh.app/2018/05/29/1e4b305121e8ff04f7e07139878527dc.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-29T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"1 基础环境准备 1.1环境预览 1.2基础工程 Npm install -g truffle Npm install -g EthereumJS TestRPC Npm install -g supervisor Truffle init Npm init 1.3疑难解答 Web3依赖c++build tools python（only for python2.7），npm install web3会报？ Recommend：npm install –global –production windows-build-tools View more detail：https://github.com/nodejs/node-gyp#installation能合约开发 2 智能合约开发 2.1 基础表结构 pragma solidity ^0.4.21; /** * 官方文档众筹实现 * https://solidity.readthedocs.io/en/develop/types.html#structs * 1 存储方式：memory、storage，状态变量默认是storage而local变量默认是memory * 2 mapping类似java中字典key=&gt;value，但是没有数组常用操作：push * 3 require类似junit中断言 * 4 函数体操作状态变量必须有修饰符，view：对状态变量读操作，payable：支付操作 * 5 msg全局变量是配合web3使用 **/ contract CrowdFunding { // 表结构：众筹项目 struct Fund { // 众筹地址 address owner; // 众筹描述 string desc; // 众筹目标 uint goal; // 已筹金币 uint coins; // 是否结束 bool finished; // 捐赠人数 uint recordCounts; // 捐赠记录 mapping(uint =&gt; Record) records; // 原本使用 Record[] records 数组定义 // 但是貌似目前版本尚不支持 // 于是将 数组 拆分成 长度 + 映射 // https://solidity.readthedocs.io/en/develop/types.html#mappings } // 表结构：捐赠记录 struct Record { // 捐赠成员 address member; // 捐赠金币 uint coin; // 捐赠时间 uint time; } 2.2 查询操作 // 众筹地址列表 Fund[] funds; function CrowdFunding() public payable { } // 获取众筹项目数量 function getFundCount() public view returns (uint) { return funds.length; } // 获取众筹项目信息 // 参数：项目编号 // 返回：众筹地址 众筹描述 众筹目标 已筹金币 是否结束 function getFundInfo(uint fundIndex) public view returns (address, string, uint, uint, bool) { Fund storage fund = funds[fundIndex]; return (fund.owner, fund.desc, fund.goal, fund.coins, fund.finished); } // 获取众筹捐赠人数 function getRecordCount(uint fundIndex) public view returns (uint) { return funds[fundIndex].recordCounts; } // 获取众筹捐赠记录 // 参数：项目编号 记录编号 // 返回：捐赠成员 捐赠金币 捐赠时间 function getRecordInfo(uint fundIndex, uint recordIndex) public view returns (address, uint, uint) { Record storage record = funds[fundIndex].records[recordIndex]; return (record.member, record.coin, record.time); } 2.3 发起众筹 // 发起众筹： function raiseFund(address raiser, string info, uint goal) public { //funds.push(Fund(msg.sender, info, goal, 0, false, 0)); funds.push(Fund(raiser, info, goal, 0, false, 0)); } 2.4 账户支付操作 // 捐赠众筹： // https://solidity.readthedocs.io/en/latest/miscellaneous.html#modifiers // payable for functions: Allows them to receive Ether together with a call. function sendCoin(uint fundIndex) public payable { // 默认属性 // msg.sender 转账账户 // msg.value 转账数目 // 智能合约默认单位 wei // 1 ether = 10^18 wei // 引用拷贝 Fund storage fund = funds[fundIndex]; require(!fund.finished); // 转账 失败自动退出 fund.owner.transfer(msg.value); // 更新众筹信息 fund.coins += msg.value; fund.records[fund.recordCounts++] = Record(msg.sender, msg.value, now); fund.finished = fund.coins &gt;= fund.goal * 1 ether? true : false; } // fallback function：回退函数 防止抛出异常 // https://solidity.readthedocs.io/en/latest/contracts.html#fallback-function // if you want your contract to receive Ether, you have to implement a fallback function. function() public payable { } 3 NodeJs export众筹模型 3.1 合约编译 Truffle compile --reset 注意--reset是版本发生变化才生效，编译生成的合约\\build\\contracts\\CrowdFunding.json 3.2 NodeJs引入abi协议、web3、truffle-contract /** * 众筹业务控model * @author wolf * @time 2018-05-01 */ var Web3 = require(&#39;web3&#39;); var contract = require(&quot;truffle-contract&quot;); var provider = new Web3.providers.HttpProvider(&quot;http://localhost:8545&quot;); //使用truffle-contract包的contract()方法 var CrowdFunding = contract( copy编译后文件：/build/contracts/CrowdFunding.json ); //UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address //没有默认地址，会报错:务必设置为自己的钱包地址，如果不知道，查看自己的客户端启动时，观察打印到控制台的地址 CrowdFunding.setProvider(provider); CrowdFunding.defaults({ from : &quot;0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf&quot; }); module.exports = function () { this.web3 = new Web3(provider); this.model = CrowdFunding; } 3.3 合约部署 Truffle migrate --reset 3.4 疑难解答 UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address **Option 1：** CrowdFunding.defaults({ from : &quot;0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf&quot; }); **Option2：** CrowdService.web3.eth.defaultAccount=account; 4 NodeJs众筹业务交互 4.1 web3交互基础信息 /** * 账户列表 * @param req * @param res */ get_accountsList:function (req, res) { res.send(CrowdService.web3.eth.accounts) }, /** * 查看区块数 * @param req * @param res */ get_blocksList : function (req, res) { res.send(CrowdService.web3.eth.blockNumber); }, /** * 查看默认账户/调用合约的账户 * @param req * @param res */ post_defaultAccount: function (req, res) { var account = req.body.account; var retMsg = new Message(); if (Checks.isNull(account)) { console.log(&quot;Current default: &quot; + CrowdService.web3.eth.defaultAccount); res.send(retMsg.success(&#39;合约调用默认账户：&#39;+ CrowdService.web3.eth.defaultAccount)); } else { CrowdService.web3.eth.defaultAccount=account; res.send(retMsg.success(&#39;更新合约调用默认账户：&#39;+ CrowdService.web3.eth.defaultAccount)) } }, /** * 查看账户余额 * @param req * @param res */ post_accountBalance : function (req, res) { var account = req.body.account; retMsg = new Message(); if (Checks.isNull(account)) { res.send(retMsg.fail(&#39;账户地址不能为空！&#39;)) } var balance = CrowdService.web3.eth.getBalance(account); res.send(balance) }, 4.2 众筹业务交互 /** * 发起众筹 * @param req * @param res */ post_raiseFund: function (req, res) { var raiser = req.body.raiser; var info = req.body.info; var goal = req.body.goal; if (Checks.isNull(raiser)) { raiser = CrowdService.web3.eth.accounts[0]; } CrowdService.model.deployed().then(function (instance) { return instance.raiseFund(raiser, info, goal, { gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); res.send(JSON.stringify({&quot;info&quot; : info, &quot;goal&quot;: goal, &quot;code&quot;: &quot;募集成功！&quot;})); }, /** * 捐赠众筹 * @param req * @param res */ post_donate: function (req, res) { var retMsg = new Message(); // sendCoin(uint fundIndex, address donater, uint coin) var fundIndex = req.body.fundIndex; var donater = req.body.donater; var coin = req.body.coin; /*if (Checks.isNull(fundIndex) || Checks.isNull(donater) || Checks.isNull(coin)) { res.send(JSON.stringify(retMsg.fail(&#39;众筹项目、捐赠账户、捐赠数量不能为空！！！&#39;))); }*/ CrowdService.web3.eth.defaultAccount = donater; CrowdService.model.deployed().then(function (instance) { return instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, &#39;ether&#39;), from: donater, gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); res.send(JSON.stringify(retMsg.success(&#39;捐赠成功！！！&#39;))); }, /** * 众筹列表 * @param req * @param res */ post_fundsList: function (req, res) { var total; var list = new Array(); var g; CrowdService.model.deployed().then(function (instance) { g=instance; return g.getFundCount(); }).then(function (total) { //promise循环 var promoseArray=[]; for (index=0; index &lt; total; index++) { promoseArray.push(g.getFundInfo(index)); } Promise.all(promoseArray).then(function (data) { res.send(JSON.stringify(data)); }) }); }, /** * 众筹详情 * @param req * @param res */ post_fundInfo: function (req, res) { var index = req.body.index; CrowdService.model.deployed().then(function (instance) { return instance.getFundInfo(index); }).then(function (result) { res.send(result); }); }, /** * 获取捐赠记录列表 * @param req * @param res */ post_recordsList: function (req, res) { var fundIndex = req.body.fundIndex; var g; CrowdService.model.deployed().then(function (instance) { g = instance; return g.getRecordCount(fundIndex); }).then(function (count) { console.log(count); if (count &lt;= 0) { res.send(&quot;没有捐赠记录&quot;); return; } var promiseArray=[]; for(x=0; x&lt;count; x++){ promiseArray.push(g.getRecordInfo(fundIndex, x)); } Promise.all(promiseArray).then(function (data) { res.send(JSON.stringify(data)); }) }); }, 4.3 基础工具 /** * 输出格式类 * @type {{code: number, msg: string, data: {total: number, pageNo: number, pageSize: number, object: {}, array: Array}}} * @author wolf * @time 2018/5/1 */ function Message () { this.result = { &quot;code&quot;: 0, &quot;msg&quot;: &quot;操作成功&quot;, &quot;data&quot;: {&quot;total&quot;: 0, &quot;pageNo&quot;: 1, &quot;pageSize&quot;: 10, &quot;object&quot;: {}, &quot;array&quot;: []} }; } Message.prototype.success = function (msg) { this.result.msg = msg; return this.result; } Message.prototype.fail = function (msg) { this.result.code = -1; this.result.msg = msg; return this.result; } Message.prototype.listPage = function (total, pageNo, list) { this.result.data.total = total; this.result.data.pageNo = pageNo; this.result.data.array = list; return this.result; } Message.prototype.setData = function (object) { this.result.data.object = object; return this.result; } module.exports = Message; 4.4 部署配置 var Migrations = artifacts.require(&quot;./Migrations.sol&quot;); var Test = artifacts.require(&quot;./Test.sol&quot;); var CrowdFunding = artifacts.require(&quot;./CrowdFunding.sol&quot;); module.exports = function (deployer) { deployer.deploy(Migrations); deployer.deploy(Test); deployer.deploy(CrowdFunding); }; 4.5 疑难解答 Promise循环 var promiseArray=[]; for(x=0; x&lt;count; x++){ promiseArray.push(g.getRecordInfo(fundIndex, x)); } Promise.all(promiseArray).then(function (data) { res.send(JSON.stringify(data)); }) Javascript prototype实现面向对象继承 Message.prototype.success = function (msg) { this.result.msg = msg; return this.result; } NodeJs静态导入 /** * 检查工具类 * @author wolf * @time 2018/5/1 */ function Checks() {} /** * 判断是否为空 * @param val * @returns */ Checks.isNull = function(val) { if (val == undefined || val == null || val == &quot;&quot; || val == &#39;&#39; || val == &quot;undefined&quot; || val == &quot;null&quot; || val == &quot;NULL&quot;) { return true; } return false; } module.exports = Checks; Msg全局变量使用（msg.sender、msg.value） for crowdfunding.sol : // 转账 失败自动退出 fund.owner.transfer(msg.value); // 更新众筹信息 fund.coins += msg.value; fund.records[fund.recordCounts++] = Record(msg.sender, msg.value, now); for crowdfunding.js: CrowdService.model.deployed().then(function (instance) { return instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, &#39;ether&#39;), from: donater, gas: 1000000 }); }).then(function (result) { console.log(result); //打印交易收据 }); 交易中total used gas = usedgas * gasPrice，而每次交易都需要预设gas（预估使用gas上限），使用完total used gas &gt; gas：out of gas error，相反多余的gas会在交易完退换账户 转账账户余额 = 默认账户总额 - msg.value - total used gas msg.sender定义为调用合约账户，合约也能隐形转换为合同账户 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/05/29/1e4b305121e8ff04f7e07139878527dc.html","headline":"区块链实战系列：众筹空间（NodeJs版本）","dateModified":"2018-05-29T00:00:00+08:00","datePublished":"2018-05-29T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/05/29/1e4b305121e8ff04f7e07139878527dc.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>区块链实战系列：众筹空间（NodeJs版本）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h2 id="1-基础环境准备">1 基础环境准备</h2> 
  <h2 id="11环境预览">1.1环境预览</h2> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180529122158710?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvbGZqc29u/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <h2 id="12基础工程">1.2基础工程</h2> 
  <pre class="prettyprint"><code class=" hljs cmake">Npm <span class="hljs-keyword">install</span> -g truffle
Npm <span class="hljs-keyword">install</span> -g EthereumJS TestRPC
Npm <span class="hljs-keyword">install</span> -g supervisor
Truffle init
Npm init</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180529122251355?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dvbGZqc29u/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <h2 id="13疑难解答">1.3疑难解答</h2> 
  <ul> 
   <li><strong>Web3依赖c++build tools python（only for python2.7），npm install web3会报？</strong></li> 
  </ul> 
  <blockquote> 
   <p>Recommend：npm install –global –production windows-build-tools View <br> more detail：<a href="https://github.com/nodejs/node-gyp#installation" rel="nofollow">https://github.com/nodejs/node-gyp#installation</a>能合约开发</p> 
  </blockquote> 
  <h2 id="2-智能合约开发">2 智能合约开发</h2> 
  <h2 id="21-基础表结构">2.1 基础表结构</h2> 
  <pre class="prettyprint"><code class=" hljs d"><span class="hljs-keyword">pragma</span> solidity ^<span class="hljs-number">0.4</span>.21;

<span class="hljs-comment">/** * 官方文档众筹实现 * https://solidity.readthedocs.io/en/develop/types.html#structs * 1 存储方式：memory、storage，状态变量默认是storage而local变量默认是memory * 2 mapping类似java中字典key=&gt;value，但是没有数组常用操作：push * 3 require类似junit中断言 * 4 函数体操作状态变量必须有修饰符，view：对状态变量读操作，payable：支付操作 * 5 msg全局变量是配合web3使用 **/</span>
contract CrowdFunding {

    <span class="hljs-comment">// 表结构：众筹项目</span>
    <span class="hljs-keyword">struct</span> Fund {
        <span class="hljs-comment">// 众筹地址</span>
        address owner;
        <span class="hljs-comment">// 众筹描述</span>
        <span class="hljs-built_in">string</span> desc;
        <span class="hljs-comment">// 众筹目标</span>
        <span class="hljs-built_in">uint</span> goal;

        <span class="hljs-comment">// 已筹金币</span>
        <span class="hljs-built_in">uint</span> coins;
        <span class="hljs-comment">// 是否结束</span>
        <span class="hljs-built_in">bool</span> finished;

        <span class="hljs-comment">// 捐赠人数</span>
        <span class="hljs-built_in">uint</span> recordCounts;
        <span class="hljs-comment">// 捐赠记录</span>
        mapping(<span class="hljs-built_in">uint</span> =&gt; Record) records;
        <span class="hljs-comment">// 原本使用 Record[] records 数组定义</span>
        <span class="hljs-comment">// 但是貌似目前版本尚不支持</span>
        <span class="hljs-comment">// 于是将 数组 拆分成 长度 + 映射</span>
        <span class="hljs-comment">// https://solidity.readthedocs.io/en/develop/types.html#mappings</span>
    }

    <span class="hljs-comment">// 表结构：捐赠记录</span>
    <span class="hljs-keyword">struct</span> Record {
        <span class="hljs-comment">// 捐赠成员</span>
        address member;
        <span class="hljs-comment">// 捐赠金币</span>
        <span class="hljs-built_in">uint</span> coin;
        <span class="hljs-comment">// 捐赠时间</span>
        <span class="hljs-built_in">uint</span> time;
    }</code></pre> 
  <h2 id="22-查询操作">2.2 查询操作</h2> 
  <pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">// 众筹地址列表</span>
Fund[] funds;

function CrowdFunding() <span class="hljs-keyword">public</span> payable {
}

<span class="hljs-comment">// 获取众筹项目数量</span>
function getFundCount() <span class="hljs-keyword">public</span> view <span class="hljs-title">returns</span> (<span class="hljs-keyword">uint</span>) {
    <span class="hljs-keyword">return</span> funds.length;
}

<span class="hljs-comment">// 获取众筹项目信息</span>
<span class="hljs-comment">// 参数：项目编号</span>
<span class="hljs-comment">// 返回：众筹地址 众筹描述 众筹目标 已筹金币 是否结束</span>
function getFundInfo(<span class="hljs-keyword">uint</span> fundIndex) <span class="hljs-keyword">public</span> view <span class="hljs-title">returns</span> (address, <span class="hljs-keyword">string</span>, <span class="hljs-keyword">uint</span>, <span class="hljs-keyword">uint</span>, <span class="hljs-keyword">bool</span>) {
    Fund storage fund = funds[fundIndex];
    <span class="hljs-keyword">return</span> (fund.owner, fund.desc, fund.goal, fund.coins, fund.finished);
}

<span class="hljs-comment">// 获取众筹捐赠人数</span>
function getRecordCount(<span class="hljs-keyword">uint</span> fundIndex) <span class="hljs-keyword">public</span> view <span class="hljs-title">returns</span> (<span class="hljs-keyword">uint</span>) {
    <span class="hljs-keyword">return</span> funds[fundIndex].recordCounts;
}


<span class="hljs-comment">// 获取众筹捐赠记录</span>
<span class="hljs-comment">// 参数：项目编号 记录编号</span>
<span class="hljs-comment">// 返回：捐赠成员 捐赠金币 捐赠时间</span>
function getRecordInfo(<span class="hljs-keyword">uint</span> fundIndex, <span class="hljs-keyword">uint</span> recordIndex) <span class="hljs-keyword">public</span> view <span class="hljs-title">returns</span> (address, <span class="hljs-keyword">uint</span>, <span class="hljs-keyword">uint</span>) {
    Record storage record = funds[fundIndex].records[recordIndex];
    <span class="hljs-keyword">return</span> (record.member, record.coin, record.time);
}</code></pre> 
  <h2 id="23-发起众筹">2.3 发起众筹</h2> 
  <pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">// 发起众筹：</span>
function raiseFund(address raiser, <span class="hljs-keyword">string</span> info, <span class="hljs-keyword">uint</span> goal) <span class="hljs-keyword">public</span> {
    <span class="hljs-comment">//funds.push(Fund(msg.sender, info, goal, 0, false, 0));</span>
    funds.push(Fund(raiser, info, goal, <span class="hljs-number">0</span>, <span class="hljs-keyword">false</span>, <span class="hljs-number">0</span>));
}</code></pre> 
  <h2 id="24-账户支付操作">2.4 账户支付操作</h2> 
  <pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">// 捐赠众筹：</span>
<span class="hljs-comment">// https://solidity.readthedocs.io/en/latest/miscellaneous.html#modifiers</span>
<span class="hljs-comment">// payable for functions: Allows them to receive Ether together with a call.</span>
function sendCoin(<span class="hljs-keyword">uint</span> fundIndex) <span class="hljs-keyword">public</span> payable {
    <span class="hljs-comment">// 默认属性</span>
    <span class="hljs-comment">// msg.sender 转账账户</span>
    <span class="hljs-comment">// msg.value 转账数目</span>
    <span class="hljs-comment">// 智能合约默认单位 wei</span>
    <span class="hljs-comment">// 1 ether = 10^18 wei</span>

    <span class="hljs-comment">// 引用拷贝</span>
    Fund storage fund = funds[fundIndex];
    require(!fund.finished);

    <span class="hljs-comment">// 转账 失败自动退出</span>
    fund.owner.transfer(msg.<span class="hljs-keyword">value</span>);

    <span class="hljs-comment">// 更新众筹信息</span>
    fund.coins += msg.<span class="hljs-keyword">value</span>;
    fund.records[fund.recordCounts++] = Record(msg.sender, msg.<span class="hljs-keyword">value</span>, now);
    fund.finished = fund.coins &gt;= fund.goal * <span class="hljs-number">1</span> ether? <span class="hljs-keyword">true</span> : <span class="hljs-keyword">false</span>;
}


<span class="hljs-comment">// fallback function：回退函数 防止抛出异常</span>
<span class="hljs-comment">// https://solidity.readthedocs.io/en/latest/contracts.html#fallback-function</span>
<span class="hljs-comment">// if you want your contract to receive Ether, you have to implement a fallback function.</span>
function() <span class="hljs-keyword">public</span> payable { }</code></pre> 
  <h2 id="3-nodejs-export众筹模型">3 NodeJs export众筹模型</h2> 
  <h2 id="31-合约编译">3.1 合约编译</h2> 
  <pre class="prettyprint"><code class=" hljs tex">Truffle compile --reset
注意--reset是版本发生变化才生效，编译生成的合约<span class="hljs-command">\build</span><span class="hljs-command">\contracts</span><span class="hljs-command">\CrowdFunding</span>.json</code></pre> 
  <h2 id="32-nodejs引入abi协议web3truffle-contract">3.2 NodeJs引入abi协议、web3、truffle-contract</h2> 
  <pre class="prettyprint"><code class=" hljs scala"><span class="hljs-javadoc">/** * 众筹业务控model * <span class="hljs-javadoctag">@author</span> wolf * <span class="hljs-javadoctag">@time</span> 2018-05-01 */</span>
<span class="hljs-keyword">var</span> Web3 = require(<span class="hljs-string">'web3'</span>);
<span class="hljs-keyword">var</span> contract = require(<span class="hljs-string">"truffle-contract"</span>);

<span class="hljs-keyword">var</span> provider = <span class="hljs-keyword">new</span> Web3.providers.HttpProvider(<span class="hljs-string">"http://localhost:8545"</span>);

<span class="hljs-comment">//使用truffle-contract包的contract()方法</span>
<span class="hljs-keyword">var</span> CrowdFunding = contract(
   copy编译后文件：/build/contracts/CrowdFunding.json
);

<span class="hljs-comment">//UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 3): Error: invalid address</span>
<span class="hljs-comment">//没有默认地址，会报错:务必设置为自己的钱包地址，如果不知道，查看自己的客户端启动时，观察打印到控制台的地址</span>
CrowdFunding.setProvider(provider);
CrowdFunding.defaults({
    from : <span class="hljs-string">"0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf"</span>
});


module.exports = function () {
    <span class="hljs-keyword">this</span>.web3 = <span class="hljs-keyword">new</span> Web3(provider);
    <span class="hljs-keyword">this</span>.model = CrowdFunding;
}</code></pre> 
  <h2 id="33-合约部署">3.3 合约部署</h2> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">Truffle</span> <span class="hljs-comment">migrate</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">reset</span></code></pre> 
  <h2 id="34-疑难解答">3.4 疑难解答</h2> 
  <ul> 
   <li>UnhandledPromiseRejectionWarning: Unhandled promise rejection <br> (rejection id: 3): Error: invalid address</li> 
  </ul> 
  <pre class="prettyprint"><code class=" hljs avrasm">**Option <span class="hljs-number">1</span>：**
CrowdFunding<span class="hljs-preprocessor">.defaults</span>({
    from : <span class="hljs-string">"0xeeacbf78bb5eeba49acdc67c0fbd5dd46e67facf"</span>
})<span class="hljs-comment">;</span>

**Option2：**
CrowdService<span class="hljs-preprocessor">.web</span>3<span class="hljs-preprocessor">.eth</span><span class="hljs-preprocessor">.defaultAccount</span>=account<span class="hljs-comment">;</span></code></pre> 
  <h2 id="4-nodejs众筹业务交互">4 NodeJs众筹业务交互</h2> 
  <h2 id="41-web3交互基础信息">4.1 web3交互基础信息</h2> 
  <pre class="prettyprint"><code class=" hljs scala"><span class="hljs-javadoc">/** * 账户列表 * <span class="hljs-javadoctag">@param</span> req * <span class="hljs-javadoctag">@param</span> res */</span>
get_accountsList:function (req, res) {
    res.send(CrowdService.web3.eth.accounts)
},

<span class="hljs-javadoc">/** * 查看区块数 * <span class="hljs-javadoctag">@param</span> req * <span class="hljs-javadoctag">@param</span> res */</span>
get_blocksList : function (req, res) {
    res.send(CrowdService.web3.eth.blockNumber);
},

<span class="hljs-javadoc">/** * 查看默认账户/调用合约的账户 * <span class="hljs-javadoctag">@param</span> req * <span class="hljs-javadoctag">@param</span> res */</span>
post_defaultAccount: function (req, res) {

    <span class="hljs-keyword">var</span> account = req.body.account;
    <span class="hljs-keyword">var</span> retMsg = <span class="hljs-keyword">new</span> Message();

    <span class="hljs-keyword">if</span> (Checks.isNull(account)) {
        console.log(<span class="hljs-string">"Current default: "</span> + CrowdService.web3.eth.defaultAccount);
        res.send(retMsg.success(<span class="hljs-string">'合约调用默认账户：'</span>+ CrowdService.web3.eth.defaultAccount));
    } <span class="hljs-keyword">else</span> {
        CrowdService.web3.eth.defaultAccount=account;
        res.send(retMsg.success(<span class="hljs-string">'更新合约调用默认账户：'</span>+ CrowdService.web3.eth.defaultAccount))
    }
},


<span class="hljs-javadoc">/** * 查看账户余额 * <span class="hljs-javadoctag">@param</span> req * <span class="hljs-javadoctag">@param</span> res */</span>
post_accountBalance : function (req, res) {
    <span class="hljs-keyword">var</span> account = req.body.account;
    retMsg = <span class="hljs-keyword">new</span> Message();
    <span class="hljs-keyword">if</span> (Checks.isNull(account)) {
        res.send(retMsg.fail(<span class="hljs-string">'账户地址不能为空！'</span>))
    }
    <span class="hljs-keyword">var</span> balance = CrowdService.web3.eth.getBalance(account);
    res.send(balance)
},</code></pre> 
  <h2 id="42-众筹业务交互">4.2 众筹业务交互</h2> 
  <pre class="prettyprint"><code class=" hljs php"><span class="hljs-comment">/** * 发起众筹 *<span class="hljs-phpdoc"> @param</span> req *<span class="hljs-phpdoc"> @param</span> res */</span>
post_raiseFund: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> raiser = req.body.raiser;
    <span class="hljs-keyword">var</span> info = req.body.info;
    <span class="hljs-keyword">var</span> goal = req.body.goal;
    <span class="hljs-keyword">if</span> (Checks.isNull(raiser)) {
        raiser = CrowdService.web3.eth.accounts[<span class="hljs-number">0</span>];
    }

    CrowdService.model.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> {</span>
        <span class="hljs-keyword">return</span> instance.raiseFund(raiser, info, goal, { gas: <span class="hljs-number">1000000</span> });
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
        console.log(result); <span class="hljs-comment">//打印交易收据</span>
    });

    res.send(JSON.stringify({<span class="hljs-string">"info"</span> : info, <span class="hljs-string">"goal"</span>: goal, <span class="hljs-string">"code"</span>: <span class="hljs-string">"募集成功！"</span>}));
},

<span class="hljs-comment">/** * 捐赠众筹 *<span class="hljs-phpdoc"> @param</span> req *<span class="hljs-phpdoc"> @param</span> res */</span>
post_donate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> retMsg = <span class="hljs-keyword">new</span> Message();
    <span class="hljs-comment">// sendCoin(uint fundIndex, address donater, uint coin)</span>
    <span class="hljs-keyword">var</span> fundIndex = req.body.fundIndex;
    <span class="hljs-keyword">var</span> donater = req.body.donater;
    <span class="hljs-keyword">var</span> coin = req.body.coin;


    <span class="hljs-comment">/*if (Checks.isNull(fundIndex) || Checks.isNull(donater) || Checks.isNull(coin)) { res.send(JSON.stringify(retMsg.fail('众筹项目、捐赠账户、捐赠数量不能为空！！！'))); }*/</span>

    CrowdService.web3.eth.defaultAccount = donater;

    CrowdService.model.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> {</span>
        <span class="hljs-keyword">return</span> instance.sendCoin(fundIndex,{value: CrowdService.web3.toWei(coin, <span class="hljs-string">'ether'</span>), from: donater, gas: <span class="hljs-number">1000000</span> });
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
        console.log(result); <span class="hljs-comment">//打印交易收据</span>
    });

    res.send(JSON.stringify(retMsg.success(<span class="hljs-string">'捐赠成功！！！'</span>)));
},

<span class="hljs-comment">/** * 众筹列表 *<span class="hljs-phpdoc"> @param</span> req *<span class="hljs-phpdoc"> @param</span> res */</span>
post_fundsList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> total;
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">list</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">Array</span>();
    <span class="hljs-keyword">var</span> g;

    CrowdService.model.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> {</span>
        g=instance;
        <span class="hljs-keyword">return</span> g.getFundCount();
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(total)</span> {</span>
        <span class="hljs-comment">//promise循环</span>
        <span class="hljs-keyword">var</span> promoseArray=[];
        <span class="hljs-keyword">for</span> (index=<span class="hljs-number">0</span>; index &lt; total; index++) {
            promoseArray.push(g.getFundInfo(index));
        }

        Promise.all(promoseArray).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
            res.send(JSON.stringify(data));
        })
    });
},

<span class="hljs-comment">/** * 众筹详情 *<span class="hljs-phpdoc"> @param</span> req *<span class="hljs-phpdoc"> @param</span> res */</span>
post_fundInfo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> index = req.body.index;
    CrowdService.model.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> {</span>
        <span class="hljs-keyword">return</span> instance.getFundInfo(index);
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
        res.send(result);
    });
},


<span class="hljs-comment">/** * 获取捐赠记录列表 *<span class="hljs-phpdoc"> @param</span> req *<span class="hljs-phpdoc"> @param</span> res */</span>
post_recordsList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(req, res)</span> {</span>
    <span class="hljs-keyword">var</span> fundIndex = req.body.fundIndex;
    <span class="hljs-keyword">var</span> g;

    CrowdService.model.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> {</span>
        g = instance;
        <span class="hljs-keyword">return</span> g.getRecordCount(fundIndex);
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(count)</span> {</span>
        console.log(count);
        <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>) {
            res.send(<span class="hljs-string">"没有捐赠记录"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">var</span> promiseArray=[];
        <span class="hljs-keyword">for</span>(x=<span class="hljs-number">0</span>; x&lt;count; x++){
            promiseArray.push(g.getRecordInfo(fundIndex, x));
        }

        Promise.all(promiseArray).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
            res.send(JSON.stringify(data));
        })
    });
},</code></pre> 
  <h2 id="43-基础工具">4.3 基础工具</h2> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-comment">/** * 输出格式类 * @type {{code: number, msg: string, data: {total: number, pageNo: number, pageSize: number, object: {}, array: Array}}} * @author wolf * @time 2018/5/1 */</span>

function Message () {
    this<span class="hljs-preprocessor">.result</span> = {
        <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">"msg"</span>: <span class="hljs-string">"操作成功"</span>,
        <span class="hljs-string">"data"</span>: {<span class="hljs-string">"total"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"pageNo"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"pageSize"</span>: <span class="hljs-number">10</span>, <span class="hljs-string">"object"</span>: {}, <span class="hljs-string">"array"</span>: []}
    }<span class="hljs-comment">;</span>
}

Message<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.success</span> = function (msg) {
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.msg</span> = msg<span class="hljs-comment">;</span>
    return this<span class="hljs-preprocessor">.result</span><span class="hljs-comment">;</span>
}

Message<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.fail</span> = function (msg) {
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.code</span> = -<span class="hljs-number">1</span><span class="hljs-comment">;</span>
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.msg</span> = msg<span class="hljs-comment">;</span>
    return this<span class="hljs-preprocessor">.result</span><span class="hljs-comment">;</span>
}

Message<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.listPage</span> = function (total, pageNo, list) {
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.total</span> = total<span class="hljs-comment">;</span>
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.pageNo</span> = pageNo<span class="hljs-comment">;</span>
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.array</span> = list<span class="hljs-comment">;</span>
    return this<span class="hljs-preprocessor">.result</span><span class="hljs-comment">;</span>
}

Message<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.setData</span> = function (object) {
    this<span class="hljs-preprocessor">.result</span><span class="hljs-preprocessor">.data</span><span class="hljs-preprocessor">.object</span> = object<span class="hljs-comment">;</span>
    return this<span class="hljs-preprocessor">.result</span><span class="hljs-comment">;</span>
}

module<span class="hljs-preprocessor">.exports</span> = Message<span class="hljs-comment">;</span></code></pre> 
  <h2 id="44-部署配置">4.4 部署配置</h2> 
  <pre class="prettyprint"><code class=" hljs php"><span class="hljs-keyword">var</span> Migrations = artifacts.<span class="hljs-keyword">require</span>(<span class="hljs-string">"./Migrations.sol"</span>);
<span class="hljs-keyword">var</span> Test = artifacts.<span class="hljs-keyword">require</span>(<span class="hljs-string">"./Test.sol"</span>);
<span class="hljs-keyword">var</span> CrowdFunding = artifacts.<span class="hljs-keyword">require</span>(<span class="hljs-string">"./CrowdFunding.sol"</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(deployer)</span> {</span>
    deployer.deploy(Migrations);
    deployer.deploy(Test);
    deployer.deploy(CrowdFunding);
};</code></pre> 
  <h2 id="45-疑难解答">4.5 疑难解答</h2> 
  <ul> 
   <li><strong>Promise循环</strong></li> 
  </ul> 
  <pre class="prettyprint"><code class=" hljs javascript"><span class="hljs-keyword">var</span> promiseArray=[];
<span class="hljs-keyword">for</span>(x=<span class="hljs-number">0</span>; x&lt;count; x++){
    promiseArray.push(g.getRecordInfo(fundIndex, x));
}

Promise.all(promiseArray).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
    res.send(<span class="hljs-built_in">JSON</span>.stringify(data));
})</code></pre> 
  <ul> 
   <li><strong>Javascript prototype实现面向对象继承</strong></li> 
  </ul> 
  <pre class="prettyprint"><code class=" hljs javascript">Message.prototype.success = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
    <span class="hljs-keyword">this</span>.result.msg = msg;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.result;
}</code></pre> 
  <ul> 
   <li><strong>NodeJs静态导入</strong></li> 
  </ul> 
  <pre class="prettyprint"><code class=" hljs scala"><span class="hljs-javadoc">/** * 检查工具类 * <span class="hljs-javadoctag">@author</span> wolf * <span class="hljs-javadoctag">@time</span> 2018/5/1 */</span>
function Checks() {}

    <span class="hljs-javadoc">/** * 判断是否为空 * <span class="hljs-javadoctag">@param</span> val * <span class="hljs-javadoctag">@returns</span> */</span>
    Checks.isNull = function(<span class="hljs-keyword">val</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">val</span> == undefined || <span class="hljs-keyword">val</span> == <span class="hljs-keyword">null</span> || <span class="hljs-keyword">val</span> == <span class="hljs-string">""</span> || <span class="hljs-keyword">val</span> == <span class="hljs-string">''</span>
            || <span class="hljs-keyword">val</span> == <span class="hljs-string">"undefined"</span> || <span class="hljs-keyword">val</span> == <span class="hljs-string">"null"</span> || <span class="hljs-keyword">val</span> == <span class="hljs-string">"NULL"</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

module.exports = Checks;</code></pre> 
  <ul> 
   <li><strong>Msg全局变量使用（msg.sender、msg.value）</strong> <br> <strong>for crowdfunding.sol :</strong></li> 
  </ul> 
  <pre class="prettyprint"><code class=" hljs avrasm">// 转账 失败自动退出
fund<span class="hljs-preprocessor">.owner</span><span class="hljs-preprocessor">.transfer</span>(msg<span class="hljs-preprocessor">.value</span>)<span class="hljs-comment">;</span>

// 更新众筹信息
fund<span class="hljs-preprocessor">.coins</span> += msg<span class="hljs-preprocessor">.value</span><span class="hljs-comment">;</span>
fund<span class="hljs-preprocessor">.records</span>[fund<span class="hljs-preprocessor">.recordCounts</span>++] = Record(msg<span class="hljs-preprocessor">.sender</span>, msg<span class="hljs-preprocessor">.value</span>, now)<span class="hljs-comment">;</span></code></pre> 
  <p><strong>for crowdfunding.js:</strong></p> 
  <pre class="prettyprint"><code class=" hljs scilab"><span class="hljs-transposed_variable">CrowdService.</span><span class="hljs-transposed_variable">model.</span>deployed().<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(instance)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-transposed_variable">instance.</span>sendCoin(fundIndex,{value: <span class="hljs-transposed_variable">CrowdService.</span><span class="hljs-transposed_variable">web3.</span>toWei(coin, <span class="hljs-string">'ether'</span>), from: donater, gas: <span class="hljs-number">1000000</span> });
}).<span class="hljs-keyword">then</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> {</span>
    <span class="hljs-transposed_variable">console.</span>log(result); <span class="hljs-comment">//打印交易收据</span>
});</code></pre> 
  <ul> 
   <li>交易中total used gas = usedgas * <br> gasPrice，而每次交易都需要预设gas（预估使用gas上限），使用完total used gas &gt; gas：out of gas <br> error，相反多余的gas会在交易完退换账户</li> 
   <li><strong>转账账户余额 = 默认账户总额 - msg.value - total used gas</strong></li> 
   <li><strong>msg.sender定义为调用合约账户，合约也能隐形转换为合同账户</strong></li> 
  </ul> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wolfjson/article/details/80494720,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wolfjson/article/details/80494720,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
