<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>paypal消息通知IPN | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="paypal消息通知IPN" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="paypal支付成功时会实时的把支付交易信息返回给我们，java会返回一个payment对象，里面有交易的信息包含付款人，订单费用，订单的收货地址，收款人，交易号等信息。我们拿到了这个payment就表示支付成功了，接下来就可以处理我们的逻辑了，比如修改订单状态，记录交易记录等操作了。 IPN其实就是paypal的交易状态的一种推送机制，是由paypal主动推送，只要我们配置好地址就可以了。 官方paypal对IPN的解释：IPN消息通知 消息地址设置 使用卖家账号登录paypal，然后找到用户信息-用户信息与设置，点进去 在点击销售工具，在里面找到即时付款通知项，点击更新 启用这个付款通知，并把自己的接口url填进去。 注意事项： 其实这个地址url可以是个restful的接口。 接口地址是https开头的，也就是要求使用SSL进行连接，其实Paypal Sandbox可以使用http，但是最后实际的Paypal接口，不支持http协议，paypal会校验是否是https地址。 在支付表单中，可以自己设置notify_url字段，来指定此次交易的信息应该发送到哪个地方，这样就可以覆盖在Profile中我们的设置，另外，这个字段要进行urlencode 我们得到的IPN信息中，status对应的便是交易状态，如Complete表示完成，首字母大写，而验证结果则是VERIFIEY或者INVALID，全部大写，具体的内容，可以查看Paypal官方的文档订单管理整合指南。 处理逻辑： IPN的原理很简单，就是当产生了一个交易之后，交易状态发生变化时，如用户已经付款、或者退款、撤销时，Paypal利用常用的HTTP POST方式，将交易的一些变量提交给网站的某个页面（称之为IPN Handler），当这个页面接受到请求时候，将这些数据原封不动加上一个指示验证的cmd=_notify-validate，POST回Paypal的接口地址，如果数据正确，那么Paypal返回字符串VERIFIED，否则为INVALID，如果结果为VERIFIED，那么你的程序就可以使用这些数据进行操作。 通知传输的数据： array ( &#39;act&#39; =&gt; &#39;ipn&#39;, &#39;mc_gross&#39; =&gt; &#39;20.00&#39;, &#39;invoice&#39; =&gt; &#39;548531d624f59&#39;, &#39;protection_eligibility&#39; =&gt; &#39;Eligible&#39;, &#39;address_status&#39; =&gt; &#39;unconfirmed&#39;, &#39;item_number1&#39; =&gt; &#39;&#39;, &#39;tax&#39; =&gt; &#39;1.30&#39;, &#39;item_number2&#39; =&gt; &#39;&#39;, &#39;payer_id&#39; =&gt; &#39;JARYJK2TES6C6&#39;, &#39;address_street&#39; =&gt; &#39;NO 1 Nan Jin Road&#39;, &#39;payment_date&#39; =&gt; &#39;21:04:35 Dec 07, 2014 PST&#39;, &#39;payment_status&#39; =&gt; &#39;Completed&#39;, &#39;charset&#39; =&gt; &#39;gb2312&#39;, &#39;address_zip&#39; =&gt; &#39;200000&#39;, &#39;mc_shipping&#39; =&gt; &#39;1.20&#39;, &#39;mc_handling&#39; =&gt; &#39;0.00&#39;, &#39;first_name&#39; =&gt; &#39;Test&#39;, &#39;mc_fee&#39; =&gt; &#39;0.98&#39;, &#39;address_country_code&#39; =&gt; &#39;CN&#39;, &#39;address_name&#39; =&gt; &#39;Buyer Test&#39;, &#39;notify_version&#39; =&gt; &#39;3.8&#39;, &#39;custom&#39; =&gt; &#39;&#39;, &#39;payer_status&#39; =&gt; &#39;unverified&#39;, &#39;address_country&#39; =&gt; &#39;China&#39;, &#39;num_cart_items&#39; =&gt; &#39;2&#39;, &#39;mc_handling1&#39; =&gt; &#39;0.00&#39;, &#39;mc_handling2&#39; =&gt; &#39;0.00&#39;, &#39;address_city&#39; =&gt; &#39;Shanghai&#39;, &#39;verify_sign&#39; =&gt; &#39;AomRS5l2W2xlt2An.GaSrAzpCl-NACIvh3Pz0HtrSBZzfcIeqDPGrXSk&#39;, &#39;payer_email&#39; =&gt; &#39;yxw.2013.03-buyer@gmail.com&#39;, &#39;mc_shipping1&#39; =&gt; &#39;0.00&#39;, &#39;mc_shipping2&#39; =&gt; &#39;0.00&#39;, &#39;tax1&#39; =&gt; &#39;0.00&#39;, &#39;tax2&#39; =&gt; &#39;0.00&#39;, &#39;txn_id&#39; =&gt; &#39;5CS19517SJ894934R&#39;, &#39;payment_type&#39; =&gt; &#39;instant&#39;, &#39;last_name&#39; =&gt; &#39;Buyer&#39;, &#39;address_state&#39; =&gt; &#39;Shanghai&#39;, &#39;item_name1&#39; =&gt; &#39;Ground Coffee 40 oz&#39;, &#39;receiver_email&#39; =&gt; &#39;yxw.2013.03@gmail.com&#39;, &#39;item_name2&#39; =&gt; &#39;Granola bars&#39;, &#39;payment_fee&#39; =&gt; &#39;0.98&#39;, &#39;quantity1&#39; =&gt; &#39;1&#39;, &#39;quantity2&#39; =&gt; &#39;5&#39;, &#39;receiver_id&#39; =&gt; &#39;937CP9PSMDS2A&#39;, &#39;txn_type&#39; =&gt; &#39;cart&#39;, &#39;mc_gross_1&#39; =&gt; &#39;7.50&#39;, &#39;mc_currency&#39; =&gt; &#39;USD&#39;, &#39;mc_gross_2&#39; =&gt; &#39;10.00&#39;, &#39;residence_country&#39; =&gt; &#39;CN&#39;, &#39;test_ipn&#39; =&gt; &#39;1&#39;, &#39;transaction_subject&#39; =&gt; &#39;&#39;, &#39;payment_gross&#39; =&gt; &#39;20.00&#39;, &#39;ipn_track_id&#39; =&gt; &#39;a9059421a1dd7&#39;, ) 我们接收这些数据使用 cmd=_notify-validate 拼接并返回给paypal告诉paypal我们接收到了。后面我在做的过程中发现通知的数据有时候有parent_txn_id有时候又没有，后面去查文档才发现原来paypal第一次通知的时候没有parent_txn_id，后面交易状态改变后就会有这个parent_txn_id。其实这个parent_txn_id就是原始的交易号，第二次通知回调的时候parent_txn_id是原来的交易号，然后同时又会生成一个新的txn_id推送过来。 所以我这边做的逻辑判断是：如果parent_txn_id为空时则表示是paypal的第一次通知，这个时候我就去检查这个交易号之前实时支付成功的时候有没有存到，如果有则不管，没有则存起来。 parent_txn_id不为空的时候表示这是我们第二次或者多次接受到paypal通知了，这个时候我就去更新支付状态，订单状态。 &nbsp;&nbsp;&nbsp;&nbsp;/** * 获取paypal的通知消息 * @param request * @param response * @throws Exception */ @ApiIgnore @RequestMapping(method = RequestMethod.POST, value = &quot;/receivePaypalStatus&quot;) public void receivePaypalStatus(HttpServletRequest request, HttpServletResponse response) throws Exception { log.info(&quot;receivePaypalStatus &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 进入paypal后台支付通知&quot;); PrintWriter out = response.getWriter(); try { /** * 获取paypal请求参数,并拼接验证参数 */ Enumeration&lt;String&gt; en = request.getParameterNames(); String str = &quot;cmd=_notify-validate&quot;; while (en.hasMoreElements()) { String paramName = en.nextElement(); String paramValue = request.getParameter(paramName); //此处的编码一定要和自己的网站编码一致，不然会出现乱码，paypal回复的通知为‘INVALID’ str = str + &quot;&amp;&quot; + paramName + &quot;=&quot; + URLEncoder.encode(paramValue, &quot;utf-8&quot;); } //建议在此将接受到的信息 str 记录到日志文件中以确认是否收到 IPN 信息 log.info(&quot;=========================================================================================&quot;); log.info(&quot;paypal传递过来的交易信息:&quot;+str); /** * 将信息 POST 回给 PayPal 进行验证 */ //验证地址测试环境和正式环境不一样配置在yml中 URL u = new URL(paypalConfig.getWebscr()); HttpURLConnection uc = (HttpURLConnection) u.openConnection(); uc.setRequestMethod(&quot;POST&quot;); uc.setDoOutput(true); uc.setDoInput(true); uc.setUseCaches(false); //设置 HTTP 的头信息 uc.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;); PrintWriter pw = new PrintWriter(uc.getOutputStream()); pw.println(str); pw.close(); /** * 接受 PayPal 对 IPN 回发的回复信息 */ BufferedReader in = new BufferedReader(new InputStreamReader(uc.getInputStream())); String res = in.readLine(); in.close(); /** * 将 POST 信息分配给本地变量，可以根据您的需要添加 */ // 交易状态 Completed 代表交易成功 String paymentStatus = request.getParameter(&quot;payment_status&quot;); // 交易时间 String paymentDate = request.getParameter(&quot;payment_date&quot;); // 交易id String txnId = request.getParameter(&quot;txn_id&quot;); // 父交易id String parentTxnId = request.getParameter(&quot;parent_txn_id&quot;); // 收款人email String receiverEmail = request.getParameter(&quot;receiver_email&quot;); // 收款人id String receiverId = request.getParameter(&quot;receiver_id&quot;); // 付款人email String payerEmail = request.getParameter(&quot;payer_email&quot;); // 付款人id String payerId = request.getParameter(&quot;payer_id&quot;); // 交易金额 String mcGross = request.getParameter(&quot;mc_gross&quot;); // 自定义字段，我们存放的订单ID String custom = request.getParameter(&quot;custom&quot;); if (res == null || res == &quot;&quot;) { res = &quot;0&quot;; } log.info(&quot;res = &quot; + res); log.info(&quot;paymentStatus = &quot; + paymentStatus); log.info(&quot;txnI = &quot; + txnId); log.info(&quot;parentTxnId = &quot; + parentTxnId); log.info(&quot;custom = &quot; + custom); /** * 获取 PayPal 对回发信息的回复信息，判断刚才的通知是否为 PayPal 发出的 */ if (VERIFIED.equalsIgnoreCase(res)) { /** * 如果 parentTxnId 不为空我们就认为是通知就不是第一次通知 */ if (StringUtil.isNotEmpty(parentTxnId)) { // 根据父支付交易号查询付款表数据 List&lt;ShopOrderPayment&gt; list = shopOrderPaymentService.getOrderPaymentByParentTxnId(parentTxnId); if (null != list &amp;&amp; list.size() &gt; 0) { ShopOrderPayment shopOrderPayment = list.get(0); /** * 更新支付状态 */ ShopOrderPayment updateOrderPayment = new ShopOrderPayment(); updateOrderPayment.setId(shopOrderPayment.getId()); updateOrderPayment.setPaymentStatus(paymentStatus); updateOrderPayment.setTransactionId(txnId); shopOrderPaymentService.updateOrderPaymentById(shopOrderPayment); /** * 保存支付历史记录数据 */ ShopOrderPaymentHistory paymentHistory = new ShopOrderPaymentHistory(); BeanUtils.copyProperties(shopOrderPayment, paymentHistory); paymentHistory.setPaymentStatus(paymentStatus); paymentHistory.setTransactionId(txnId); shopOrderPaymentHistoryService.savePaymentHistory(paymentHistory); /** * 判断状态是complete则更新订单状态为待确认收货 * 如果是refunded则更新订单状态为已完成 */ if (COMPLETED_STATUS.equalsIgnoreCase(paymentStatus)) { paypalService.updateOrderStatus(shopOrderPayment.getOrderId(), com.sunvalley.shop.order.constants.Constants.OrderStatus.STATUS_PRE_REC); } else if (REFUNDED_STATUS.equalsIgnoreCase(paymentStatus)) { paypalService.updateOrderStatus(shopOrderPayment.getOrderId(), com.sunvalley.shop.order.constants.Constants.OrderStatus.STATUS_COMPLETE); } } else { log.error(&quot;父支付交易号：&quot; + parentTxnId + &quot; 在支付表中不存在&quot;); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); } } else { /** * 第一次回调通知,根据 txnId 查询。如果存在则表示支付实时返回结果已经记录了，不存在则表示实时返回结果没有记录到 */ List&lt;ShopOrderPayment&gt; paymentList = shopOrderPaymentService.getOrderPaymentByTxnId(txnId); if (null != paymentList &amp;&amp; paymentList.size() &gt; 0) { ShopOrderPayment orderPaymentTmp = paymentList.get(0); if (COMPLETED_STATUS.equalsIgnoreCase(orderPaymentTmp.getPaymentStatus())) { log.info(&quot;================ 支付表数据已经是complete了，不需要更新 ================&quot;); } else { // 如果回传的状态不是complete则更新我们的支付数据 /** * 更新支付状态 */ ShopOrderPayment updateOrderPayment = new ShopOrderPayment(); updateOrderPayment.setId(orderPaymentTmp.getId()); updateOrderPayment.setPaymentStatus(paymentStatus); shopOrderPaymentService.updateOrderPaymentById(orderPaymentTmp); /** * 保存支付历史记录数据 */ ShopOrderPaymentHistory paymentHistory = new ShopOrderPaymentHistory(); BeanUtils.copyProperties(orderPaymentTmp, paymentHistory); paymentHistory.setPaymentStatus(paymentStatus); paymentHistory.setTransactionId(txnId); shopOrderPaymentHistoryService.savePaymentHistory(paymentHistory); } } else { /** * 保存支付信息 */ ShopOrderPayment orderPayment = new ShopOrderPayment(); // 从redis中获取订单ID if (StringUtil.isNotEmpty(custom)) { orderPayment.setOrderId(Integer.valueOf(custom)); } else { log.info(&quot;***************** paypal回传的订单ID为空 **************&quot;); } // 订单总价 orderPayment.setAmountPaid(new BigDecimal(mcGross)); // 交易号 orderPayment.setTransactionId(txnId); // 支付成功时把交易号同时写进父交易号中 orderPayment.setParentTransationId(txnId); // 收款方ID orderPayment.setReceiveId(receiverId); // 收款方邮箱 orderPayment.setReceiveEmial(receiverEmail); // 收款方状态 orderPayment.setPaymentStatus(paymentStatus.toLowerCase()); // 付款方ID orderPayment.setPayerId(payerId); // 付款方邮箱 orderPayment.setPayerEmail(payerEmail); // 保存支付数据 ShopOrderPayment orderPay = paypalService.savePayment(orderPayment); log.info(&quot;================= 支付信息保存成功，订单状态更新成待发货成功 ====================&quot;); } } } else if (INVALID.equalsIgnoreCase(res)) { //非法信息，可以将此记录到您的日志文件中以备调查 log.error(&quot;paypal完成支付发送IPN通知返回状态非法，请联系管理员，请求参数：&quot; + str); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } else { //处理其他错误 log.error(&quot;paypal完成支付发送IPN通知发生其他异常，请联系管理员，请求参数：&quot; + str); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } } catch (Exception e) { log.error(&quot;确认付款信息发生IO异常&quot; + e.getMessage()); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } out.flush(); out.close(); }以上是我个人的代码，可以收到paypal的消息通知，仅供参考，转载需注明，谢谢~ 阅读更多" />
<meta property="og:description" content="paypal支付成功时会实时的把支付交易信息返回给我们，java会返回一个payment对象，里面有交易的信息包含付款人，订单费用，订单的收货地址，收款人，交易号等信息。我们拿到了这个payment就表示支付成功了，接下来就可以处理我们的逻辑了，比如修改订单状态，记录交易记录等操作了。 IPN其实就是paypal的交易状态的一种推送机制，是由paypal主动推送，只要我们配置好地址就可以了。 官方paypal对IPN的解释：IPN消息通知 消息地址设置 使用卖家账号登录paypal，然后找到用户信息-用户信息与设置，点进去 在点击销售工具，在里面找到即时付款通知项，点击更新 启用这个付款通知，并把自己的接口url填进去。 注意事项： 其实这个地址url可以是个restful的接口。 接口地址是https开头的，也就是要求使用SSL进行连接，其实Paypal Sandbox可以使用http，但是最后实际的Paypal接口，不支持http协议，paypal会校验是否是https地址。 在支付表单中，可以自己设置notify_url字段，来指定此次交易的信息应该发送到哪个地方，这样就可以覆盖在Profile中我们的设置，另外，这个字段要进行urlencode 我们得到的IPN信息中，status对应的便是交易状态，如Complete表示完成，首字母大写，而验证结果则是VERIFIEY或者INVALID，全部大写，具体的内容，可以查看Paypal官方的文档订单管理整合指南。 处理逻辑： IPN的原理很简单，就是当产生了一个交易之后，交易状态发生变化时，如用户已经付款、或者退款、撤销时，Paypal利用常用的HTTP POST方式，将交易的一些变量提交给网站的某个页面（称之为IPN Handler），当这个页面接受到请求时候，将这些数据原封不动加上一个指示验证的cmd=_notify-validate，POST回Paypal的接口地址，如果数据正确，那么Paypal返回字符串VERIFIED，否则为INVALID，如果结果为VERIFIED，那么你的程序就可以使用这些数据进行操作。 通知传输的数据： array ( &#39;act&#39; =&gt; &#39;ipn&#39;, &#39;mc_gross&#39; =&gt; &#39;20.00&#39;, &#39;invoice&#39; =&gt; &#39;548531d624f59&#39;, &#39;protection_eligibility&#39; =&gt; &#39;Eligible&#39;, &#39;address_status&#39; =&gt; &#39;unconfirmed&#39;, &#39;item_number1&#39; =&gt; &#39;&#39;, &#39;tax&#39; =&gt; &#39;1.30&#39;, &#39;item_number2&#39; =&gt; &#39;&#39;, &#39;payer_id&#39; =&gt; &#39;JARYJK2TES6C6&#39;, &#39;address_street&#39; =&gt; &#39;NO 1 Nan Jin Road&#39;, &#39;payment_date&#39; =&gt; &#39;21:04:35 Dec 07, 2014 PST&#39;, &#39;payment_status&#39; =&gt; &#39;Completed&#39;, &#39;charset&#39; =&gt; &#39;gb2312&#39;, &#39;address_zip&#39; =&gt; &#39;200000&#39;, &#39;mc_shipping&#39; =&gt; &#39;1.20&#39;, &#39;mc_handling&#39; =&gt; &#39;0.00&#39;, &#39;first_name&#39; =&gt; &#39;Test&#39;, &#39;mc_fee&#39; =&gt; &#39;0.98&#39;, &#39;address_country_code&#39; =&gt; &#39;CN&#39;, &#39;address_name&#39; =&gt; &#39;Buyer Test&#39;, &#39;notify_version&#39; =&gt; &#39;3.8&#39;, &#39;custom&#39; =&gt; &#39;&#39;, &#39;payer_status&#39; =&gt; &#39;unverified&#39;, &#39;address_country&#39; =&gt; &#39;China&#39;, &#39;num_cart_items&#39; =&gt; &#39;2&#39;, &#39;mc_handling1&#39; =&gt; &#39;0.00&#39;, &#39;mc_handling2&#39; =&gt; &#39;0.00&#39;, &#39;address_city&#39; =&gt; &#39;Shanghai&#39;, &#39;verify_sign&#39; =&gt; &#39;AomRS5l2W2xlt2An.GaSrAzpCl-NACIvh3Pz0HtrSBZzfcIeqDPGrXSk&#39;, &#39;payer_email&#39; =&gt; &#39;yxw.2013.03-buyer@gmail.com&#39;, &#39;mc_shipping1&#39; =&gt; &#39;0.00&#39;, &#39;mc_shipping2&#39; =&gt; &#39;0.00&#39;, &#39;tax1&#39; =&gt; &#39;0.00&#39;, &#39;tax2&#39; =&gt; &#39;0.00&#39;, &#39;txn_id&#39; =&gt; &#39;5CS19517SJ894934R&#39;, &#39;payment_type&#39; =&gt; &#39;instant&#39;, &#39;last_name&#39; =&gt; &#39;Buyer&#39;, &#39;address_state&#39; =&gt; &#39;Shanghai&#39;, &#39;item_name1&#39; =&gt; &#39;Ground Coffee 40 oz&#39;, &#39;receiver_email&#39; =&gt; &#39;yxw.2013.03@gmail.com&#39;, &#39;item_name2&#39; =&gt; &#39;Granola bars&#39;, &#39;payment_fee&#39; =&gt; &#39;0.98&#39;, &#39;quantity1&#39; =&gt; &#39;1&#39;, &#39;quantity2&#39; =&gt; &#39;5&#39;, &#39;receiver_id&#39; =&gt; &#39;937CP9PSMDS2A&#39;, &#39;txn_type&#39; =&gt; &#39;cart&#39;, &#39;mc_gross_1&#39; =&gt; &#39;7.50&#39;, &#39;mc_currency&#39; =&gt; &#39;USD&#39;, &#39;mc_gross_2&#39; =&gt; &#39;10.00&#39;, &#39;residence_country&#39; =&gt; &#39;CN&#39;, &#39;test_ipn&#39; =&gt; &#39;1&#39;, &#39;transaction_subject&#39; =&gt; &#39;&#39;, &#39;payment_gross&#39; =&gt; &#39;20.00&#39;, &#39;ipn_track_id&#39; =&gt; &#39;a9059421a1dd7&#39;, ) 我们接收这些数据使用 cmd=_notify-validate 拼接并返回给paypal告诉paypal我们接收到了。后面我在做的过程中发现通知的数据有时候有parent_txn_id有时候又没有，后面去查文档才发现原来paypal第一次通知的时候没有parent_txn_id，后面交易状态改变后就会有这个parent_txn_id。其实这个parent_txn_id就是原始的交易号，第二次通知回调的时候parent_txn_id是原来的交易号，然后同时又会生成一个新的txn_id推送过来。 所以我这边做的逻辑判断是：如果parent_txn_id为空时则表示是paypal的第一次通知，这个时候我就去检查这个交易号之前实时支付成功的时候有没有存到，如果有则不管，没有则存起来。 parent_txn_id不为空的时候表示这是我们第二次或者多次接受到paypal通知了，这个时候我就去更新支付状态，订单状态。 &nbsp;&nbsp;&nbsp;&nbsp;/** * 获取paypal的通知消息 * @param request * @param response * @throws Exception */ @ApiIgnore @RequestMapping(method = RequestMethod.POST, value = &quot;/receivePaypalStatus&quot;) public void receivePaypalStatus(HttpServletRequest request, HttpServletResponse response) throws Exception { log.info(&quot;receivePaypalStatus &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 进入paypal后台支付通知&quot;); PrintWriter out = response.getWriter(); try { /** * 获取paypal请求参数,并拼接验证参数 */ Enumeration&lt;String&gt; en = request.getParameterNames(); String str = &quot;cmd=_notify-validate&quot;; while (en.hasMoreElements()) { String paramName = en.nextElement(); String paramValue = request.getParameter(paramName); //此处的编码一定要和自己的网站编码一致，不然会出现乱码，paypal回复的通知为‘INVALID’ str = str + &quot;&amp;&quot; + paramName + &quot;=&quot; + URLEncoder.encode(paramValue, &quot;utf-8&quot;); } //建议在此将接受到的信息 str 记录到日志文件中以确认是否收到 IPN 信息 log.info(&quot;=========================================================================================&quot;); log.info(&quot;paypal传递过来的交易信息:&quot;+str); /** * 将信息 POST 回给 PayPal 进行验证 */ //验证地址测试环境和正式环境不一样配置在yml中 URL u = new URL(paypalConfig.getWebscr()); HttpURLConnection uc = (HttpURLConnection) u.openConnection(); uc.setRequestMethod(&quot;POST&quot;); uc.setDoOutput(true); uc.setDoInput(true); uc.setUseCaches(false); //设置 HTTP 的头信息 uc.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;); PrintWriter pw = new PrintWriter(uc.getOutputStream()); pw.println(str); pw.close(); /** * 接受 PayPal 对 IPN 回发的回复信息 */ BufferedReader in = new BufferedReader(new InputStreamReader(uc.getInputStream())); String res = in.readLine(); in.close(); /** * 将 POST 信息分配给本地变量，可以根据您的需要添加 */ // 交易状态 Completed 代表交易成功 String paymentStatus = request.getParameter(&quot;payment_status&quot;); // 交易时间 String paymentDate = request.getParameter(&quot;payment_date&quot;); // 交易id String txnId = request.getParameter(&quot;txn_id&quot;); // 父交易id String parentTxnId = request.getParameter(&quot;parent_txn_id&quot;); // 收款人email String receiverEmail = request.getParameter(&quot;receiver_email&quot;); // 收款人id String receiverId = request.getParameter(&quot;receiver_id&quot;); // 付款人email String payerEmail = request.getParameter(&quot;payer_email&quot;); // 付款人id String payerId = request.getParameter(&quot;payer_id&quot;); // 交易金额 String mcGross = request.getParameter(&quot;mc_gross&quot;); // 自定义字段，我们存放的订单ID String custom = request.getParameter(&quot;custom&quot;); if (res == null || res == &quot;&quot;) { res = &quot;0&quot;; } log.info(&quot;res = &quot; + res); log.info(&quot;paymentStatus = &quot; + paymentStatus); log.info(&quot;txnI = &quot; + txnId); log.info(&quot;parentTxnId = &quot; + parentTxnId); log.info(&quot;custom = &quot; + custom); /** * 获取 PayPal 对回发信息的回复信息，判断刚才的通知是否为 PayPal 发出的 */ if (VERIFIED.equalsIgnoreCase(res)) { /** * 如果 parentTxnId 不为空我们就认为是通知就不是第一次通知 */ if (StringUtil.isNotEmpty(parentTxnId)) { // 根据父支付交易号查询付款表数据 List&lt;ShopOrderPayment&gt; list = shopOrderPaymentService.getOrderPaymentByParentTxnId(parentTxnId); if (null != list &amp;&amp; list.size() &gt; 0) { ShopOrderPayment shopOrderPayment = list.get(0); /** * 更新支付状态 */ ShopOrderPayment updateOrderPayment = new ShopOrderPayment(); updateOrderPayment.setId(shopOrderPayment.getId()); updateOrderPayment.setPaymentStatus(paymentStatus); updateOrderPayment.setTransactionId(txnId); shopOrderPaymentService.updateOrderPaymentById(shopOrderPayment); /** * 保存支付历史记录数据 */ ShopOrderPaymentHistory paymentHistory = new ShopOrderPaymentHistory(); BeanUtils.copyProperties(shopOrderPayment, paymentHistory); paymentHistory.setPaymentStatus(paymentStatus); paymentHistory.setTransactionId(txnId); shopOrderPaymentHistoryService.savePaymentHistory(paymentHistory); /** * 判断状态是complete则更新订单状态为待确认收货 * 如果是refunded则更新订单状态为已完成 */ if (COMPLETED_STATUS.equalsIgnoreCase(paymentStatus)) { paypalService.updateOrderStatus(shopOrderPayment.getOrderId(), com.sunvalley.shop.order.constants.Constants.OrderStatus.STATUS_PRE_REC); } else if (REFUNDED_STATUS.equalsIgnoreCase(paymentStatus)) { paypalService.updateOrderStatus(shopOrderPayment.getOrderId(), com.sunvalley.shop.order.constants.Constants.OrderStatus.STATUS_COMPLETE); } } else { log.error(&quot;父支付交易号：&quot; + parentTxnId + &quot; 在支付表中不存在&quot;); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); } } else { /** * 第一次回调通知,根据 txnId 查询。如果存在则表示支付实时返回结果已经记录了，不存在则表示实时返回结果没有记录到 */ List&lt;ShopOrderPayment&gt; paymentList = shopOrderPaymentService.getOrderPaymentByTxnId(txnId); if (null != paymentList &amp;&amp; paymentList.size() &gt; 0) { ShopOrderPayment orderPaymentTmp = paymentList.get(0); if (COMPLETED_STATUS.equalsIgnoreCase(orderPaymentTmp.getPaymentStatus())) { log.info(&quot;================ 支付表数据已经是complete了，不需要更新 ================&quot;); } else { // 如果回传的状态不是complete则更新我们的支付数据 /** * 更新支付状态 */ ShopOrderPayment updateOrderPayment = new ShopOrderPayment(); updateOrderPayment.setId(orderPaymentTmp.getId()); updateOrderPayment.setPaymentStatus(paymentStatus); shopOrderPaymentService.updateOrderPaymentById(orderPaymentTmp); /** * 保存支付历史记录数据 */ ShopOrderPaymentHistory paymentHistory = new ShopOrderPaymentHistory(); BeanUtils.copyProperties(orderPaymentTmp, paymentHistory); paymentHistory.setPaymentStatus(paymentStatus); paymentHistory.setTransactionId(txnId); shopOrderPaymentHistoryService.savePaymentHistory(paymentHistory); } } else { /** * 保存支付信息 */ ShopOrderPayment orderPayment = new ShopOrderPayment(); // 从redis中获取订单ID if (StringUtil.isNotEmpty(custom)) { orderPayment.setOrderId(Integer.valueOf(custom)); } else { log.info(&quot;***************** paypal回传的订单ID为空 **************&quot;); } // 订单总价 orderPayment.setAmountPaid(new BigDecimal(mcGross)); // 交易号 orderPayment.setTransactionId(txnId); // 支付成功时把交易号同时写进父交易号中 orderPayment.setParentTransationId(txnId); // 收款方ID orderPayment.setReceiveId(receiverId); // 收款方邮箱 orderPayment.setReceiveEmial(receiverEmail); // 收款方状态 orderPayment.setPaymentStatus(paymentStatus.toLowerCase()); // 付款方ID orderPayment.setPayerId(payerId); // 付款方邮箱 orderPayment.setPayerEmail(payerEmail); // 保存支付数据 ShopOrderPayment orderPay = paypalService.savePayment(orderPayment); log.info(&quot;================= 支付信息保存成功，订单状态更新成待发货成功 ====================&quot;); } } } else if (INVALID.equalsIgnoreCase(res)) { //非法信息，可以将此记录到您的日志文件中以备调查 log.error(&quot;paypal完成支付发送IPN通知返回状态非法，请联系管理员，请求参数：&quot; + str); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } else { //处理其他错误 log.error(&quot;paypal完成支付发送IPN通知发生其他异常，请联系管理员，请求参数：&quot; + str); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } } catch (Exception e) { log.error(&quot;确认付款信息发生IO异常&quot; + e.getMessage()); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } out.flush(); out.close(); }以上是我个人的代码，可以收到paypal的消息通知，仅供参考，转载需注明，谢谢~ 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-29T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"paypal支付成功时会实时的把支付交易信息返回给我们，java会返回一个payment对象，里面有交易的信息包含付款人，订单费用，订单的收货地址，收款人，交易号等信息。我们拿到了这个payment就表示支付成功了，接下来就可以处理我们的逻辑了，比如修改订单状态，记录交易记录等操作了。 IPN其实就是paypal的交易状态的一种推送机制，是由paypal主动推送，只要我们配置好地址就可以了。 官方paypal对IPN的解释：IPN消息通知 消息地址设置 使用卖家账号登录paypal，然后找到用户信息-用户信息与设置，点进去 在点击销售工具，在里面找到即时付款通知项，点击更新 启用这个付款通知，并把自己的接口url填进去。 注意事项： 其实这个地址url可以是个restful的接口。 接口地址是https开头的，也就是要求使用SSL进行连接，其实Paypal Sandbox可以使用http，但是最后实际的Paypal接口，不支持http协议，paypal会校验是否是https地址。 在支付表单中，可以自己设置notify_url字段，来指定此次交易的信息应该发送到哪个地方，这样就可以覆盖在Profile中我们的设置，另外，这个字段要进行urlencode 我们得到的IPN信息中，status对应的便是交易状态，如Complete表示完成，首字母大写，而验证结果则是VERIFIEY或者INVALID，全部大写，具体的内容，可以查看Paypal官方的文档订单管理整合指南。 处理逻辑： IPN的原理很简单，就是当产生了一个交易之后，交易状态发生变化时，如用户已经付款、或者退款、撤销时，Paypal利用常用的HTTP POST方式，将交易的一些变量提交给网站的某个页面（称之为IPN Handler），当这个页面接受到请求时候，将这些数据原封不动加上一个指示验证的cmd=_notify-validate，POST回Paypal的接口地址，如果数据正确，那么Paypal返回字符串VERIFIED，否则为INVALID，如果结果为VERIFIED，那么你的程序就可以使用这些数据进行操作。 通知传输的数据： array ( &#39;act&#39; =&gt; &#39;ipn&#39;, &#39;mc_gross&#39; =&gt; &#39;20.00&#39;, &#39;invoice&#39; =&gt; &#39;548531d624f59&#39;, &#39;protection_eligibility&#39; =&gt; &#39;Eligible&#39;, &#39;address_status&#39; =&gt; &#39;unconfirmed&#39;, &#39;item_number1&#39; =&gt; &#39;&#39;, &#39;tax&#39; =&gt; &#39;1.30&#39;, &#39;item_number2&#39; =&gt; &#39;&#39;, &#39;payer_id&#39; =&gt; &#39;JARYJK2TES6C6&#39;, &#39;address_street&#39; =&gt; &#39;NO 1 Nan Jin Road&#39;, &#39;payment_date&#39; =&gt; &#39;21:04:35 Dec 07, 2014 PST&#39;, &#39;payment_status&#39; =&gt; &#39;Completed&#39;, &#39;charset&#39; =&gt; &#39;gb2312&#39;, &#39;address_zip&#39; =&gt; &#39;200000&#39;, &#39;mc_shipping&#39; =&gt; &#39;1.20&#39;, &#39;mc_handling&#39; =&gt; &#39;0.00&#39;, &#39;first_name&#39; =&gt; &#39;Test&#39;, &#39;mc_fee&#39; =&gt; &#39;0.98&#39;, &#39;address_country_code&#39; =&gt; &#39;CN&#39;, &#39;address_name&#39; =&gt; &#39;Buyer Test&#39;, &#39;notify_version&#39; =&gt; &#39;3.8&#39;, &#39;custom&#39; =&gt; &#39;&#39;, &#39;payer_status&#39; =&gt; &#39;unverified&#39;, &#39;address_country&#39; =&gt; &#39;China&#39;, &#39;num_cart_items&#39; =&gt; &#39;2&#39;, &#39;mc_handling1&#39; =&gt; &#39;0.00&#39;, &#39;mc_handling2&#39; =&gt; &#39;0.00&#39;, &#39;address_city&#39; =&gt; &#39;Shanghai&#39;, &#39;verify_sign&#39; =&gt; &#39;AomRS5l2W2xlt2An.GaSrAzpCl-NACIvh3Pz0HtrSBZzfcIeqDPGrXSk&#39;, &#39;payer_email&#39; =&gt; &#39;yxw.2013.03-buyer@gmail.com&#39;, &#39;mc_shipping1&#39; =&gt; &#39;0.00&#39;, &#39;mc_shipping2&#39; =&gt; &#39;0.00&#39;, &#39;tax1&#39; =&gt; &#39;0.00&#39;, &#39;tax2&#39; =&gt; &#39;0.00&#39;, &#39;txn_id&#39; =&gt; &#39;5CS19517SJ894934R&#39;, &#39;payment_type&#39; =&gt; &#39;instant&#39;, &#39;last_name&#39; =&gt; &#39;Buyer&#39;, &#39;address_state&#39; =&gt; &#39;Shanghai&#39;, &#39;item_name1&#39; =&gt; &#39;Ground Coffee 40 oz&#39;, &#39;receiver_email&#39; =&gt; &#39;yxw.2013.03@gmail.com&#39;, &#39;item_name2&#39; =&gt; &#39;Granola bars&#39;, &#39;payment_fee&#39; =&gt; &#39;0.98&#39;, &#39;quantity1&#39; =&gt; &#39;1&#39;, &#39;quantity2&#39; =&gt; &#39;5&#39;, &#39;receiver_id&#39; =&gt; &#39;937CP9PSMDS2A&#39;, &#39;txn_type&#39; =&gt; &#39;cart&#39;, &#39;mc_gross_1&#39; =&gt; &#39;7.50&#39;, &#39;mc_currency&#39; =&gt; &#39;USD&#39;, &#39;mc_gross_2&#39; =&gt; &#39;10.00&#39;, &#39;residence_country&#39; =&gt; &#39;CN&#39;, &#39;test_ipn&#39; =&gt; &#39;1&#39;, &#39;transaction_subject&#39; =&gt; &#39;&#39;, &#39;payment_gross&#39; =&gt; &#39;20.00&#39;, &#39;ipn_track_id&#39; =&gt; &#39;a9059421a1dd7&#39;, ) 我们接收这些数据使用 cmd=_notify-validate 拼接并返回给paypal告诉paypal我们接收到了。后面我在做的过程中发现通知的数据有时候有parent_txn_id有时候又没有，后面去查文档才发现原来paypal第一次通知的时候没有parent_txn_id，后面交易状态改变后就会有这个parent_txn_id。其实这个parent_txn_id就是原始的交易号，第二次通知回调的时候parent_txn_id是原来的交易号，然后同时又会生成一个新的txn_id推送过来。 所以我这边做的逻辑判断是：如果parent_txn_id为空时则表示是paypal的第一次通知，这个时候我就去检查这个交易号之前实时支付成功的时候有没有存到，如果有则不管，没有则存起来。 parent_txn_id不为空的时候表示这是我们第二次或者多次接受到paypal通知了，这个时候我就去更新支付状态，订单状态。 &nbsp;&nbsp;&nbsp;&nbsp;/** * 获取paypal的通知消息 * @param request * @param response * @throws Exception */ @ApiIgnore @RequestMapping(method = RequestMethod.POST, value = &quot;/receivePaypalStatus&quot;) public void receivePaypalStatus(HttpServletRequest request, HttpServletResponse response) throws Exception { log.info(&quot;receivePaypalStatus &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 进入paypal后台支付通知&quot;); PrintWriter out = response.getWriter(); try { /** * 获取paypal请求参数,并拼接验证参数 */ Enumeration&lt;String&gt; en = request.getParameterNames(); String str = &quot;cmd=_notify-validate&quot;; while (en.hasMoreElements()) { String paramName = en.nextElement(); String paramValue = request.getParameter(paramName); //此处的编码一定要和自己的网站编码一致，不然会出现乱码，paypal回复的通知为‘INVALID’ str = str + &quot;&amp;&quot; + paramName + &quot;=&quot; + URLEncoder.encode(paramValue, &quot;utf-8&quot;); } //建议在此将接受到的信息 str 记录到日志文件中以确认是否收到 IPN 信息 log.info(&quot;=========================================================================================&quot;); log.info(&quot;paypal传递过来的交易信息:&quot;+str); /** * 将信息 POST 回给 PayPal 进行验证 */ //验证地址测试环境和正式环境不一样配置在yml中 URL u = new URL(paypalConfig.getWebscr()); HttpURLConnection uc = (HttpURLConnection) u.openConnection(); uc.setRequestMethod(&quot;POST&quot;); uc.setDoOutput(true); uc.setDoInput(true); uc.setUseCaches(false); //设置 HTTP 的头信息 uc.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;); PrintWriter pw = new PrintWriter(uc.getOutputStream()); pw.println(str); pw.close(); /** * 接受 PayPal 对 IPN 回发的回复信息 */ BufferedReader in = new BufferedReader(new InputStreamReader(uc.getInputStream())); String res = in.readLine(); in.close(); /** * 将 POST 信息分配给本地变量，可以根据您的需要添加 */ // 交易状态 Completed 代表交易成功 String paymentStatus = request.getParameter(&quot;payment_status&quot;); // 交易时间 String paymentDate = request.getParameter(&quot;payment_date&quot;); // 交易id String txnId = request.getParameter(&quot;txn_id&quot;); // 父交易id String parentTxnId = request.getParameter(&quot;parent_txn_id&quot;); // 收款人email String receiverEmail = request.getParameter(&quot;receiver_email&quot;); // 收款人id String receiverId = request.getParameter(&quot;receiver_id&quot;); // 付款人email String payerEmail = request.getParameter(&quot;payer_email&quot;); // 付款人id String payerId = request.getParameter(&quot;payer_id&quot;); // 交易金额 String mcGross = request.getParameter(&quot;mc_gross&quot;); // 自定义字段，我们存放的订单ID String custom = request.getParameter(&quot;custom&quot;); if (res == null || res == &quot;&quot;) { res = &quot;0&quot;; } log.info(&quot;res = &quot; + res); log.info(&quot;paymentStatus = &quot; + paymentStatus); log.info(&quot;txnI = &quot; + txnId); log.info(&quot;parentTxnId = &quot; + parentTxnId); log.info(&quot;custom = &quot; + custom); /** * 获取 PayPal 对回发信息的回复信息，判断刚才的通知是否为 PayPal 发出的 */ if (VERIFIED.equalsIgnoreCase(res)) { /** * 如果 parentTxnId 不为空我们就认为是通知就不是第一次通知 */ if (StringUtil.isNotEmpty(parentTxnId)) { // 根据父支付交易号查询付款表数据 List&lt;ShopOrderPayment&gt; list = shopOrderPaymentService.getOrderPaymentByParentTxnId(parentTxnId); if (null != list &amp;&amp; list.size() &gt; 0) { ShopOrderPayment shopOrderPayment = list.get(0); /** * 更新支付状态 */ ShopOrderPayment updateOrderPayment = new ShopOrderPayment(); updateOrderPayment.setId(shopOrderPayment.getId()); updateOrderPayment.setPaymentStatus(paymentStatus); updateOrderPayment.setTransactionId(txnId); shopOrderPaymentService.updateOrderPaymentById(shopOrderPayment); /** * 保存支付历史记录数据 */ ShopOrderPaymentHistory paymentHistory = new ShopOrderPaymentHistory(); BeanUtils.copyProperties(shopOrderPayment, paymentHistory); paymentHistory.setPaymentStatus(paymentStatus); paymentHistory.setTransactionId(txnId); shopOrderPaymentHistoryService.savePaymentHistory(paymentHistory); /** * 判断状态是complete则更新订单状态为待确认收货 * 如果是refunded则更新订单状态为已完成 */ if (COMPLETED_STATUS.equalsIgnoreCase(paymentStatus)) { paypalService.updateOrderStatus(shopOrderPayment.getOrderId(), com.sunvalley.shop.order.constants.Constants.OrderStatus.STATUS_PRE_REC); } else if (REFUNDED_STATUS.equalsIgnoreCase(paymentStatus)) { paypalService.updateOrderStatus(shopOrderPayment.getOrderId(), com.sunvalley.shop.order.constants.Constants.OrderStatus.STATUS_COMPLETE); } } else { log.error(&quot;父支付交易号：&quot; + parentTxnId + &quot; 在支付表中不存在&quot;); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); } } else { /** * 第一次回调通知,根据 txnId 查询。如果存在则表示支付实时返回结果已经记录了，不存在则表示实时返回结果没有记录到 */ List&lt;ShopOrderPayment&gt; paymentList = shopOrderPaymentService.getOrderPaymentByTxnId(txnId); if (null != paymentList &amp;&amp; paymentList.size() &gt; 0) { ShopOrderPayment orderPaymentTmp = paymentList.get(0); if (COMPLETED_STATUS.equalsIgnoreCase(orderPaymentTmp.getPaymentStatus())) { log.info(&quot;================ 支付表数据已经是complete了，不需要更新 ================&quot;); } else { // 如果回传的状态不是complete则更新我们的支付数据 /** * 更新支付状态 */ ShopOrderPayment updateOrderPayment = new ShopOrderPayment(); updateOrderPayment.setId(orderPaymentTmp.getId()); updateOrderPayment.setPaymentStatus(paymentStatus); shopOrderPaymentService.updateOrderPaymentById(orderPaymentTmp); /** * 保存支付历史记录数据 */ ShopOrderPaymentHistory paymentHistory = new ShopOrderPaymentHistory(); BeanUtils.copyProperties(orderPaymentTmp, paymentHistory); paymentHistory.setPaymentStatus(paymentStatus); paymentHistory.setTransactionId(txnId); shopOrderPaymentHistoryService.savePaymentHistory(paymentHistory); } } else { /** * 保存支付信息 */ ShopOrderPayment orderPayment = new ShopOrderPayment(); // 从redis中获取订单ID if (StringUtil.isNotEmpty(custom)) { orderPayment.setOrderId(Integer.valueOf(custom)); } else { log.info(&quot;***************** paypal回传的订单ID为空 **************&quot;); } // 订单总价 orderPayment.setAmountPaid(new BigDecimal(mcGross)); // 交易号 orderPayment.setTransactionId(txnId); // 支付成功时把交易号同时写进父交易号中 orderPayment.setParentTransationId(txnId); // 收款方ID orderPayment.setReceiveId(receiverId); // 收款方邮箱 orderPayment.setReceiveEmial(receiverEmail); // 收款方状态 orderPayment.setPaymentStatus(paymentStatus.toLowerCase()); // 付款方ID orderPayment.setPayerId(payerId); // 付款方邮箱 orderPayment.setPayerEmail(payerEmail); // 保存支付数据 ShopOrderPayment orderPay = paypalService.savePayment(orderPayment); log.info(&quot;================= 支付信息保存成功，订单状态更新成待发货成功 ====================&quot;); } } } else if (INVALID.equalsIgnoreCase(res)) { //非法信息，可以将此记录到您的日志文件中以备调查 log.error(&quot;paypal完成支付发送IPN通知返回状态非法，请联系管理员，请求参数：&quot; + str); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } else { //处理其他错误 log.error(&quot;paypal完成支付发送IPN通知发生其他异常，请联系管理员，请求参数：&quot; + str); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } } catch (Exception e) { log.error(&quot;确认付款信息发生IO异常&quot; + e.getMessage()); log.error(&quot;Class: &quot;+this.getClass().getName()+&quot; method: &quot;+ Thread.currentThread().getStackTrace()[1].getMethodName()); out.println(&quot;confirmError&quot;); } out.flush(); out.close(); }以上是我个人的代码，可以收到paypal的消息通知，仅供参考，转载需注明，谢谢~ 阅读更多","@type":"BlogPosting","url":"/2018/05/29/2a0e29d826566ea79e78538444c661db.html","headline":"paypal消息通知IPN","dateModified":"2018-05-29T00:00:00+08:00","datePublished":"2018-05-29T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/05/29/2a0e29d826566ea79e78538444c661db.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>paypal消息通知IPN</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>paypal支付成功时会实时的把支付交易信息返回给我们，java会返回一个payment对象，里面有交易的信息包含付款人，订单费用，订单的收货地址，收款人，交易号等信息。我们拿到了这个payment就表示支付成功了，接下来就可以处理我们的逻辑了，比如修改订单状态，记录交易记录等操作了。</p>
  <p>IPN其实就是paypal的交易状态的一种推送机制，是由paypal主动推送，只要我们配置好地址就可以了。</p>
  <p>官方paypal对IPN的解释：<a href="https://www.paypal.com/c2/cgi-bin/webscr?cmd=p/acc/ipn-info-outside" rel="nofollow">IPN消息通知</a><br></p>
  <p><strong><span style="font-size:18px;">消息地址设置</span></strong><br></p>
  <p>使用卖家账号登录paypal，然后找到用户信息-用户信息与设置，点进去</p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180529143813267?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4bDY0NjgwMTkyNA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p>在点击销售工具，在里面找到即时付款通知项，点击更新<br></p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180529143927189?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4bDY0NjgwMTkyNA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p><br></p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180606145444371?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p4bDY0NjgwMTkyNA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p>启用这个付款通知，并把自己的接口url填进去。<br></p>
  <p><strong><span style="font-size:18px;">注意事项：</span></strong></p>
  <ol>
   <li>其实这个地址url可以是个restful的接口。</li>
   <li>接口地址是<strong>https</strong>开头的，也就是要求使用<strong>SSL进行连接</strong>，其实Paypal Sandbox可以使用http，但是最后实际的Paypal接口，不支持http协议，paypal会校验是否是https地址。</li>
   <li>在支付表单中，可以自己设置<code>notify_url</code>字段，来指定此次交易的信息应该发送到哪个地方，这样就可以覆盖在Profile中我们的设置，另外，这个字段要进行<code>urlencode</code></li>
   <li>我们得到的IPN信息中，<code>status</code>对应的便是交易状态，如<code>Complete</code>表示完成，首字母大写，而验证结果则是<code>VERIFIEY</code>或者<code>INVALID</code>，全部大写，具体的内容，可以查看Paypal官方的文档<a href="https://www.paypal.com/en_US/pdf/PP_OrderManagement_IntegrationGuide.pdf" rel="nofollow">订单管理整合指南</a>。</li>
  </ol>
  <p><strong><span style="font-size:18px;">处理逻辑：</span></strong></p>
  <p>IPN的原理很简单，就是当产生了一个交易之后，交易状态发生变化时，如用户已经付款、或者退款、撤销时，Paypal利用常用的HTTP POST方式，将交易的一些变量提交给网站的某个页面（称之为IPN Handler），当这个页面接受到请求时候，将这些数据原封不动加上一个指示验证的<code>cmd=_notify-validate</code>，POST回Paypal的接口地址，如果数据正确，那么Paypal返回字符串VERIFIED，否则为INVALID，如果结果为VERIFIED，那么你的程序就可以使用这些数据进行操作。<br></p>
  <p>通知传输的数据：</p>
  <pre><code class="language-plain">array (
  'act' =&gt; 'ipn',
  'mc_gross' =&gt; '20.00',
  'invoice' =&gt; '548531d624f59',
  'protection_eligibility' =&gt; 'Eligible',
  'address_status' =&gt; 'unconfirmed',
  'item_number1' =&gt; '',
  'tax' =&gt; '1.30',
  'item_number2' =&gt; '',
  'payer_id' =&gt; 'JARYJK2TES6C6',
  'address_street' =&gt; 'NO 1 Nan Jin Road',
  'payment_date' =&gt; '21:04:35 Dec 07, 2014 PST',
  'payment_status' =&gt; 'Completed',
  'charset' =&gt; 'gb2312',
  'address_zip' =&gt; '200000',
  'mc_shipping' =&gt; '1.20',
  'mc_handling' =&gt; '0.00',
  'first_name' =&gt; 'Test',
  'mc_fee' =&gt; '0.98',
  'address_country_code' =&gt; 'CN',
  'address_name' =&gt; 'Buyer Test',
  'notify_version' =&gt; '3.8',
  'custom' =&gt; '',
  'payer_status' =&gt; 'unverified',
  'address_country' =&gt; 'China',
  'num_cart_items' =&gt; '2',
  'mc_handling1' =&gt; '0.00',
  'mc_handling2' =&gt; '0.00',
  'address_city' =&gt; 'Shanghai',
  'verify_sign' =&gt; 'AomRS5l2W2xlt2An.GaSrAzpCl-NACIvh3Pz0HtrSBZzfcIeqDPGrXSk',
  'payer_email' =&gt; 'yxw.2013.03-buyer@gmail.com',
  'mc_shipping1' =&gt; '0.00',
  'mc_shipping2' =&gt; '0.00',
  'tax1' =&gt; '0.00',
  'tax2' =&gt; '0.00',
  'txn_id' =&gt; '5CS19517SJ894934R',
  'payment_type' =&gt; 'instant',
  'last_name' =&gt; 'Buyer',
  'address_state' =&gt; 'Shanghai',
  'item_name1' =&gt; 'Ground Coffee 40 oz',
  'receiver_email' =&gt; 'yxw.2013.03@gmail.com',
  'item_name2' =&gt; 'Granola bars',
  'payment_fee' =&gt; '0.98',
  'quantity1' =&gt; '1',
  'quantity2' =&gt; '5',
  'receiver_id' =&gt; '937CP9PSMDS2A',
  'txn_type' =&gt; 'cart',
  'mc_gross_1' =&gt; '7.50',
  'mc_currency' =&gt; 'USD',
  'mc_gross_2' =&gt; '10.00',
  'residence_country' =&gt; 'CN',
  'test_ipn' =&gt; '1',
  'transaction_subject' =&gt; '',
  'payment_gross' =&gt; '20.00',
  'ipn_track_id' =&gt; 'a9059421a1dd7',
)</code></pre>
  <p>我们接收这些数据使用 cmd=_notify-validate 拼接并返回给paypal告诉paypal我们接收到了。后面我在做的过程中发现通知的数据有时候有parent_txn_id有时候又没有，后面去查文档才发现原来paypal第一次通知的时候没有parent_txn_id，后面交易状态改变后就会有这个parent_txn_id。其实这个parent_txn_id就是原始的交易号，第二次通知回调的时候parent_txn_id是原来的交易号，然后同时又会生成一个新的txn_id推送过来。</p>
  <p>所以我这边做的逻辑判断是：如果parent_txn_id为空时则表示是paypal的第一次通知，这个时候我就去检查这个交易号之前实时支付成功的时候有没有存到，如果有则不管，没有则存起来。</p>
  <p>parent_txn_id不为空的时候表示这是我们第二次或者多次接受到paypal通知了，这个时候我就去更新支付状态，订单状态。<br></p>
  <p><br></p>
  <p></p>
  <pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:Consolas;font-size:12pt;"><span style="color:#629755;font-style:italic;">&nbsp;&nbsp;&nbsp;&nbsp;/**
</span><span style="color:#629755;font-style:italic;">     * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">获取</span><span style="color:#629755;font-style:italic;">paypal</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">的通知消息
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">     </span><span style="color:#629755;font-style:italic;">* </span><span style="color:#629755;font-weight:bold;font-style:italic;">@param </span><span style="color:#8a653b;font-style:italic;">request
</span><span style="color:#8a653b;font-style:italic;">     </span><span style="color:#629755;font-style:italic;">* </span><span style="color:#629755;font-weight:bold;font-style:italic;">@param </span><span style="color:#8a653b;font-style:italic;">response
</span><span style="color:#8a653b;font-style:italic;">     </span><span style="color:#629755;font-style:italic;">* </span><span style="color:#629755;font-weight:bold;font-style:italic;">@throws </span><span style="color:#629755;font-style:italic;">Exception
</span><span style="color:#629755;font-style:italic;">     */
</span><span style="color:#629755;font-style:italic;">    </span><span style="color:#bbb529;">@ApiIgnore
</span><span style="color:#bbb529;">    @RequestMapping</span>(<span style="color:#d0d0ff;">method </span>= RequestMethod.<span style="color:#9876aa;font-style:italic;">POST</span><span style="color:#cc7832;">, </span><span style="color:#d0d0ff;">value </span>= <span style="color:#6a8759;">"/receivePaypalStatus"</span>)
    <span style="color:#cc7832;">public void </span><span style="color:#ffc66d;">receivePaypalStatus</span>(HttpServletRequest request<span style="color:#cc7832;">, </span>HttpServletResponse response) <span style="color:#cc7832;">throws </span>Exception {
        <span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"receivePaypalStatus &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; </span><span style="font-family:'Courier New';color:#6a8759;">进入</span><span style="color:#6a8759;">paypal</span><span style="font-family:'Courier New';color:#6a8759;">后台支付通知</span><span style="color:#6a8759;">"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">        </span>PrintWriter out = response.getWriter()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">        try </span>{
            <span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">获取</span><span style="color:#629755;font-style:italic;">paypal</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">请求参数</span><span style="color:#629755;font-style:italic;">,</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">并拼接验证参数
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">            </span>Enumeration&lt;String&gt; en = request.getParameterNames()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>String str = <span style="color:#6a8759;">"cmd=_notify-validate"</span><span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            while </span>(en.hasMoreElements()) {
                String paramName = en.nextElement()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                </span>String paramValue = request.getParameter(paramName)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                </span><span style="color:#808080;">//</span><span style="font-family:'Courier New';color:#808080;">此处的编码一定要和自己的网站编码一致，不然会出现乱码，</span><span style="color:#808080;">paypal</span><span style="font-family:'Courier New';color:#808080;">回复的通知为</span><span style="color:#808080;">‘INVALID’
</span><span style="color:#808080;">                </span>str = str + <span style="color:#6a8759;">"&amp;" </span>+ paramName + <span style="color:#6a8759;">"=" </span>+ URLEncoder.<span style="font-style:italic;">encode</span>(paramValue<span style="color:#cc7832;">, </span><span style="color:#6a8759;">"utf-8"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>}
            <span style="color:#808080;">//</span><span style="font-family:'Courier New';color:#808080;">建议在此将接受到的信息</span><span style="color:#808080;"> str </span><span style="font-family:'Courier New';color:#808080;">记录到日志文件中以确认是否收到</span><span style="color:#808080;"> IPN </span><span style="font-family:'Courier New';color:#808080;">信息
</span><span style="font-family:'Courier New';color:#808080;">            </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"========================================================================================="</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"paypal</span><span style="font-family:'Courier New';color:#6a8759;">传递过来的交易信息</span><span style="color:#6a8759;">:"</span>+str)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">            </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">将信息 </span><span style="color:#629755;font-style:italic;">POST </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">回给 </span><span style="color:#629755;font-style:italic;">PayPal </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">进行验证
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">            </span><span style="color:#808080;">//</span><span style="font-family:'Courier New';color:#808080;">验证地址测试环境和正式环境不一样配置在</span><span style="color:#808080;">yml</span><span style="font-family:'Courier New';color:#808080;">中
</span><span style="font-family:'Courier New';color:#808080;">            </span>URL u = <span style="color:#cc7832;">new </span>URL(<span style="color:#9876aa;">paypalConfig</span>.getWebscr())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>HttpURLConnection uc = (HttpURLConnection) u.openConnection()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>uc.setRequestMethod(<span style="color:#6a8759;">"POST"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>uc.setDoOutput(<span style="color:#cc7832;">true</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>uc.setDoInput(<span style="color:#cc7832;">true</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>uc.setUseCaches(<span style="color:#cc7832;">false</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">//</span><span style="font-family:'Courier New';color:#808080;">设置</span><span style="color:#808080;"> HTTP </span><span style="font-family:'Courier New';color:#808080;">的头信息
</span><span style="font-family:'Courier New';color:#808080;">            </span>uc.setRequestProperty(<span style="color:#6a8759;">"Content-Type"</span><span style="color:#cc7832;">, </span><span style="color:#6a8759;">"application/x-www-form-urlencoded"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>PrintWriter pw = <span style="color:#cc7832;">new </span>PrintWriter(uc.getOutputStream())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>pw.println(str)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>pw.close()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">            </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">接受 </span><span style="color:#629755;font-style:italic;">PayPal </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">对 </span><span style="color:#629755;font-style:italic;">IPN </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">回发的回复信息
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">            </span>BufferedReader in = <span style="color:#cc7832;">new </span>BufferedReader(<span style="color:#cc7832;">new </span>InputStreamReader(uc.getInputStream()))<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>String res = in.readLine()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>in.close()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">            </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">将 </span><span style="color:#629755;font-style:italic;">POST </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">信息分配给本地变量，可以根据您的需要添加
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">交易状态</span><span style="color:#808080;"> Completed </span><span style="font-family:'Courier New';color:#808080;">代表交易成功
</span><span style="font-family:'Courier New';color:#808080;">            </span>String paymentStatus = request.getParameter(<span style="color:#6a8759;">"payment_status"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">交易时间
</span><span style="font-family:'Courier New';color:#808080;">            </span>String paymentDate = request.getParameter(<span style="color:#6a8759;">"payment_date"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">交易</span><span style="color:#808080;">id
</span><span style="color:#808080;">            </span>String txnId = request.getParameter(<span style="color:#6a8759;">"txn_id"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">父交易</span><span style="color:#808080;">id
</span><span style="color:#808080;">            </span>String parentTxnId = request.getParameter(<span style="color:#6a8759;">"parent_txn_id"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">收款人</span><span style="color:#808080;">email
</span><span style="color:#808080;">            </span>String receiverEmail = request.getParameter(<span style="color:#6a8759;">"receiver_email"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">收款人</span><span style="color:#808080;">id
</span><span style="color:#808080;">            </span>String receiverId = request.getParameter(<span style="color:#6a8759;">"receiver_id"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">付款人</span><span style="color:#808080;">email
</span><span style="color:#808080;">            </span>String payerEmail = request.getParameter(<span style="color:#6a8759;">"payer_email"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">付款人</span><span style="color:#808080;">id
</span><span style="color:#808080;">            </span>String payerId = request.getParameter(<span style="color:#6a8759;">"payer_id"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">交易金额
</span><span style="font-family:'Courier New';color:#808080;">            </span>String mcGross = request.getParameter(<span style="color:#6a8759;">"mc_gross"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">自定义字段，我们存放的订单</span><span style="color:#808080;">ID
</span><span style="color:#808080;">            </span>String custom = request.getParameter(<span style="color:#6a8759;">"custom"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">            if </span>(res == <span style="color:#cc7832;">null </span>|| res == <span style="color:#6a8759;">""</span>) {
                res = <span style="color:#6a8759;">"0"</span><span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>}
            <span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"res = " </span>+ res)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"paymentStatus = " </span>+ paymentStatus)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"txnI = " </span>+ txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"parentTxnId = " </span>+ parentTxnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"custom = " </span>+ custom)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">            </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">获取 </span><span style="color:#629755;font-style:italic;">PayPal </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">对回发信息的回复信息，判断刚才的通知是否为 </span><span style="color:#629755;font-style:italic;">PayPal </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">发出的
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">            </span><span style="color:#cc7832;">if </span>(<span style="color:#9876aa;font-style:italic;">VERIFIED</span>.equalsIgnoreCase(res)) {<span style="color:#808080;">
</span><span style="color:#808080;">                </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                 * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">如果 </span><span style="color:#629755;font-style:italic;">parentTxnId </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">不为空我们就认为是通知就不是第一次通知
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                 </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                </span><span style="color:#cc7832;">if </span>(StringUtil.<span style="font-style:italic;">isNotEmpty</span>(parentTxnId)) {
                    <span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">根据父支付交易号查询付款表数据
</span><span style="font-family:'Courier New';color:#808080;">                    </span>List&lt;ShopOrderPayment&gt; list = <span style="color:#9876aa;">shopOrderPaymentService</span>.getOrderPaymentByParentTxnId(parentTxnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                    if </span>(<span style="color:#cc7832;">null </span>!= list &amp;&amp; list.size() &gt; <span style="color:#6897bb;">0</span>) {
                        ShopOrderPayment shopOrderPayment = list.get(<span style="color:#6897bb;">0</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">                        </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                         * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">更新支付状态
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                         </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                        </span>ShopOrderPayment updateOrderPayment = <span style="color:#cc7832;">new </span>ShopOrderPayment()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>updateOrderPayment.setId(shopOrderPayment.getId())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>updateOrderPayment.setPaymentStatus(paymentStatus)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>updateOrderPayment.setTransactionId(txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#9876aa;">shopOrderPaymentService</span>.updateOrderPaymentById(shopOrderPayment)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">                        </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                         * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">保存支付历史记录数据
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                         </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                        </span>ShopOrderPaymentHistory paymentHistory = <span style="color:#cc7832;">new </span>ShopOrderPaymentHistory()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>BeanUtils.<span style="font-style:italic;">copyProperties</span>(shopOrderPayment<span style="color:#cc7832;">, </span>paymentHistory)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>paymentHistory.setPaymentStatus(paymentStatus)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>paymentHistory.setTransactionId(txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#9876aa;">shopOrderPaymentHistoryService</span>.savePaymentHistory(paymentHistory)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">                        </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                         * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">判断状态是</span><span style="color:#629755;font-style:italic;">complete</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">则更新订单状态为待确认收货
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                         </span><span style="color:#629755;font-style:italic;">* </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">如果是</span><span style="color:#629755;font-style:italic;">refunded</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">则更新订单状态为已完成
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                         </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                        </span><span style="color:#cc7832;">if </span>(<span style="color:#9876aa;font-style:italic;">COMPLETED_STATUS</span>.equalsIgnoreCase(paymentStatus)) {
                            <span style="color:#9876aa;">paypalService</span>.updateOrderStatus(shopOrderPayment.getOrderId()<span style="color:#cc7832;">, </span>com.sunvalley.shop.order.constants.Constants.OrderStatus.<span style="color:#9876aa;font-style:italic;">STATUS_PRE_REC</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>} <span style="color:#cc7832;">else if </span>(<span style="color:#9876aa;font-style:italic;">REFUNDED_STATUS</span>.equalsIgnoreCase(paymentStatus)) {
                            <span style="color:#9876aa;">paypalService</span>.updateOrderStatus(shopOrderPayment.getOrderId()<span style="color:#cc7832;">, </span>com.sunvalley.shop.order.constants.Constants.OrderStatus.<span style="color:#9876aa;font-style:italic;">STATUS_COMPLETE</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>}
                    } <span style="color:#cc7832;">else </span>{
                        <span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"</span><span style="font-family:'Courier New';color:#6a8759;">父支付交易号：</span><span style="color:#6a8759;">" </span>+ parentTxnId + <span style="color:#6a8759;">" </span><span style="font-family:'Courier New';color:#6a8759;">在支付表中不存在</span><span style="color:#6a8759;">"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"Class: "</span>+<span style="color:#cc7832;">this</span>.getClass().getName()+<span style="color:#6a8759;">" method: "</span>+
                                Thread.<span style="font-style:italic;">currentThread</span>().getStackTrace()[<span style="color:#6897bb;">1</span>].getMethodName())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                    </span>}
                } <span style="color:#cc7832;">else </span>{
                    <span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                     * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">第一次回调通知</span><span style="color:#629755;font-style:italic;">,</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">根据 </span><span style="color:#629755;font-style:italic;">txnId </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">查询。如果存在则表示支付实时返回结果已经记录了，不存在则表示实时返回结果没有记录到
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                     </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                    </span>List&lt;ShopOrderPayment&gt; paymentList = <span style="color:#9876aa;">shopOrderPaymentService</span>.getOrderPaymentByTxnId(txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                    if </span>(<span style="color:#cc7832;">null </span>!= paymentList &amp;&amp; paymentList.size() &gt; <span style="color:#6897bb;">0</span>) {
                        ShopOrderPayment orderPaymentTmp = paymentList.get(<span style="color:#6897bb;">0</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        if </span>(<span style="color:#9876aa;font-style:italic;">COMPLETED_STATUS</span>.equalsIgnoreCase(orderPaymentTmp.getPaymentStatus())) {
                            <span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"================ </span><span style="font-family:'Courier New';color:#6a8759;">支付表数据已经是</span><span style="color:#6a8759;">complete</span><span style="font-family:'Courier New';color:#6a8759;">了，不需要更新</span><span style="color:#6a8759;"> ================"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>} <span style="color:#cc7832;">else </span>{
                            <span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">如果回传的状态不是</span><span style="color:#808080;">complete</span><span style="font-family:'Courier New';color:#808080;">则更新我们的支付数据
</span><span style="font-family:'Courier New';color:#808080;">                            </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">更新支付状态
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                            </span>ShopOrderPayment updateOrderPayment = <span style="color:#cc7832;">new </span>ShopOrderPayment()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span>updateOrderPayment.setId(orderPaymentTmp.getId())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span>updateOrderPayment.setPaymentStatus(paymentStatus)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span><span style="color:#9876aa;">shopOrderPaymentService</span>.updateOrderPaymentById(orderPaymentTmp)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">                            </span><span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                             * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">保存支付历史记录数据
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                             </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                            </span>ShopOrderPaymentHistory paymentHistory = <span style="color:#cc7832;">new </span>ShopOrderPaymentHistory()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span>BeanUtils.<span style="font-style:italic;">copyProperties</span>(orderPaymentTmp<span style="color:#cc7832;">, </span>paymentHistory)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span>paymentHistory.setPaymentStatus(paymentStatus)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span>paymentHistory.setTransactionId(txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                            </span><span style="color:#9876aa;">shopOrderPaymentHistoryService</span>.savePaymentHistory(paymentHistory)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>}
                    } <span style="color:#cc7832;">else </span>{
                        <span style="color:#629755;font-style:italic;">/**
</span><span style="color:#629755;font-style:italic;">                         * </span><span style="font-family:'Courier New';color:#629755;font-style:italic;">保存支付信息
</span><span style="font-family:'Courier New';color:#629755;font-style:italic;">                         </span><span style="color:#629755;font-style:italic;">*/
</span><span style="color:#629755;font-style:italic;">                        </span>ShopOrderPayment orderPayment = <span style="color:#cc7832;">new </span>ShopOrderPayment()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">从</span><span style="color:#808080;">redis</span><span style="font-family:'Courier New';color:#808080;">中获取订单</span><span style="color:#808080;">ID
</span><span style="color:#808080;">                        </span><span style="color:#cc7832;">if </span>(StringUtil.<span style="font-style:italic;">isNotEmpty</span>(custom)) {
                            orderPayment.setOrderId(Integer.<span style="font-style:italic;">valueOf</span>(custom))<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>} <span style="color:#cc7832;">else </span>{
                            <span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"***************** paypal</span><span style="font-family:'Courier New';color:#6a8759;">回传的订单</span><span style="color:#6a8759;">ID</span><span style="font-family:'Courier New';color:#6a8759;">为空</span><span style="color:#6a8759;"> **************"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span>}
                        <span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">订单总价
</span><span style="font-family:'Courier New';color:#808080;">                        </span>orderPayment.setAmountPaid(<span style="color:#cc7832;">new </span>BigDecimal(mcGross))<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">交易号
</span><span style="font-family:'Courier New';color:#808080;">                        </span>orderPayment.setTransactionId(txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">支付成功时把交易号同时写进父交易号中
</span><span style="font-family:'Courier New';color:#808080;">                        </span>orderPayment.setParentTransationId(txnId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">收款方</span><span style="color:#808080;">ID
</span><span style="color:#808080;">                        </span>orderPayment.setReceiveId(receiverId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">收款方邮箱
</span><span style="font-family:'Courier New';color:#808080;">                        </span>orderPayment.setReceiveEmial(receiverEmail)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">收款方状态
</span><span style="font-family:'Courier New';color:#808080;">                        </span>orderPayment.setPaymentStatus(paymentStatus.toLowerCase())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">付款方</span><span style="color:#808080;">ID
</span><span style="color:#808080;">                        </span>orderPayment.setPayerId(payerId)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">付款方邮箱
</span><span style="font-family:'Courier New';color:#808080;">                        </span>orderPayment.setPayerEmail(payerEmail)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">                        </span><span style="color:#808080;">// </span><span style="font-family:'Courier New';color:#808080;">保存支付数据
</span><span style="font-family:'Courier New';color:#808080;">                        </span>ShopOrderPayment orderPay = <span style="color:#9876aa;">paypalService</span>.savePayment(orderPayment)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">
</span><span style="color:#cc7832;">                        </span><span style="color:#9876aa;">log</span>.info(<span style="color:#6a8759;">"================= </span><span style="font-family:'Courier New';color:#6a8759;">支付信息保存成功，订单状态更新成待发货成功</span><span style="color:#6a8759;"> ===================="</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                    </span>}
                }

            } <span style="color:#cc7832;">else if </span>(<span style="color:#9876aa;font-style:italic;">INVALID</span>.equalsIgnoreCase(res)) {
                <span style="color:#808080;">//</span><span style="font-family:'Courier New';color:#808080;">非法信息，可以将此记录到您的日志文件中以备调查
</span><span style="font-family:'Courier New';color:#808080;">                </span><span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"paypal</span><span style="font-family:'Courier New';color:#6a8759;">完成支付发送</span><span style="color:#6a8759;">IPN</span><span style="font-family:'Courier New';color:#6a8759;">通知返回状态非法，请联系管理员，请求参数：</span><span style="color:#6a8759;">" </span>+ str)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                </span><span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"Class: "</span>+<span style="color:#cc7832;">this</span>.getClass().getName()+<span style="color:#6a8759;">" method: "</span>+
                        Thread.<span style="font-style:italic;">currentThread</span>().getStackTrace()[<span style="color:#6897bb;">1</span>].getMethodName())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                </span>out.println(<span style="color:#6a8759;">"confirmError"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>} <span style="color:#cc7832;">else </span>{
                <span style="color:#808080;">//</span><span style="font-family:'Courier New';color:#808080;">处理其他错误
</span><span style="font-family:'Courier New';color:#808080;">                </span><span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"paypal</span><span style="font-family:'Courier New';color:#6a8759;">完成支付发送</span><span style="color:#6a8759;">IPN</span><span style="font-family:'Courier New';color:#6a8759;">通知发生其他异常，请联系管理员，请求参数：</span><span style="color:#6a8759;">" </span>+ str)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                </span><span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"Class: "</span>+<span style="color:#cc7832;">this</span>.getClass().getName()+<span style="color:#6a8759;">" method: "</span>+
                        Thread.<span style="font-style:italic;">currentThread</span>().getStackTrace()[<span style="color:#6897bb;">1</span>].getMethodName())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">                </span>out.println(<span style="color:#6a8759;">"confirmError"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>}
        } <span style="color:#cc7832;">catch </span>(Exception e) {
            <span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"</span><span style="font-family:'Courier New';color:#6a8759;">确认付款信息发生</span><span style="color:#6a8759;">IO</span><span style="font-family:'Courier New';color:#6a8759;">异常</span><span style="color:#6a8759;">" </span>+ e.getMessage())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span><span style="color:#9876aa;">log</span>.error(<span style="color:#6a8759;">"Class: "</span>+<span style="color:#cc7832;">this</span>.getClass().getName()+<span style="color:#6a8759;">" method: "</span>+
                    Thread.<span style="font-style:italic;">currentThread</span>().getStackTrace()[<span style="color:#6897bb;">1</span>].getMethodName())<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">            </span>out.println(<span style="color:#6a8759;">"confirmError"</span>)<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">        </span>}
        out.flush()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">        </span>out.close()<span style="color:#cc7832;">;
</span><span style="color:#cc7832;">    </span>}</pre>以上是我个人的代码，可以收到paypal的消息通知，仅供参考，转载需注明，谢谢~
  <br>
  <p><br></p>
  <p><br></p>
  <p><br></p>
  <p><br></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/zxl646801924/article/details/80483333,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/zxl646801924/article/details/80483333,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
