<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>超级账本HyperLedger的Fabric-CA的使用（两个组织一个Orderer三个Peer)，带视频演示 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="超级账本HyperLedger的Fabric-CA的使用（两个组织一个Orderer三个Peer)，带视频演示" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="原文地址：&nbsp;超级账本HyperLedger的Fabric-CA的使用演示(两个组织一个Orderer三个Peer) 说明 启动fabric-ca 生成fabric-ca admin的凭证 创建联盟 为每个组织准备msp 注册example.com的管理员Admin@example.com 注册org1.example.com的管理员Admin@org1.example.com 注册org2.example.com的管理员Admin@org2.example.com 各个组织分别使用自己的Admin账户创建其它账号 orderer.example.com peer0.org1.example.com peer1.org1.example.com peer0.org2.example.com 重新部署 更新用户的证书以及后续操作 参考 说明 本文是对hyperledger的fabric项目的全手动部署的补充，这里将演示如何使用fabric-ca为每个组件和用户生成证书。 如果对下面的操作有不清楚的地方，可以参阅超级账本HyperLedger的fabricCA的用法讲解。演示视频已经制作完成： IT技术快速入门学院：HyperLedger FabricCA使用演示的视频教程 可以使用下面的部署方式： 这里做了简化，只部署了一个Fabric-CA作为rootCA。 将创建一个由两个组织org1.example.com和org2.example.com组成的的联盟。 另外还有一个组织example.com用来部署orderer。 example.com部署了一个solo模式的orderer。（多个orderer的部署方式，以后探讨） orderer.example.com org1.example.com部署了两个peer: peer0.org1.example.com peer1.org1.example.com org2.example.com部署了一个peer: peer0.org2.example.com 每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建7个用户： example.com: Admin@example.com orderer.example.com org1.example.com: Admin@org1.example.com peer0.org1.example.com peer1.org1.example.com org2.example.com: Admin@org2.example.com peer0.org2.example.com 这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。 启动fabric-ca fabirc-ca的编译： $ go get -u github.com/hyperledger/fabric-ca $ cd $GOPATH/src/github.com/hyperledger/fabric-ca $ make fabric-ca-server $ make fabric-ca-client $ ls bin/ fabric-ca-client fabric-ca-server 这里将fabric-ca部署在/opt/app/fabric-ca/server目录中： mkdir -p /opt/app/fabric-ca/server cp -rf $GOPATH/src/github.com/hyperledger/fabric-ca/bin/* /opt/app/fabric-ca/server ln -s /opt/app/fabric-ca/server/fabric-ca-client /usr/bin/fabric-ca-client 直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置) cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass &amp; 如果有删除联盟和删除用户的需求，需要用下面的方式启动： cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove --cfg.identities.allowremove &amp; 注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：HyperLedger FabricCA Config Database and LDAP。 生成fabric-ca admin的凭证 下面的操作在《hyperledger的fabric项目的全手动部署》中创建的fabric-deploy目录中进行后续操作。 cd ~/fabric-deploy mkdir fabric-ca-files 生成fabric-ca admin的凭证，用-H参数指定client目录： mkdir -p `pwd`/fabric-ca-files/admin fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin 也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。 export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin mkdir -p $FABRIC_CA_CLIENT_HOME fabric-ca-client enroll -u http://admin:pass@localhost:7054 为了防止混乱，后面的演示操作中，都直接用-H指定目录。 创建联盟 上面的启动方式默认会创建两个组织： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot; affiliation: . affiliation: org2 affiliation: org2.department1 affiliation: org1 affiliation: org1.department1 affiliation: org1.department2 为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org2 执行下面命令创建联盟： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org2 创建联盟如下： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 为每个组织准备msp 为example.com准备msp，将ca证书等存放example.com组织的目录中: mkdir -p ./fabric-ca-files/example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp //-M需要指定绝对路径 命令执行结束后，会在fabric-ca-files/example.com/msp得到文件： $ tree fabric-ca-files/example.com/msp/ example.com/msp/ |-- cacerts | `-- localhost-7054.pem |-- intermediatecerts | `-- localhost-7054.pem |-- keystore `-- signcerts 注意通过getcacert得到msp目录中只有CA证书。 同样的方式为org1.example.com获取msp: mkdir -p fabric-ca-files/org1.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp 为org2.example.com准备msp: mkdir -p ./fabric-ca-files/org2.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp 这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。 在1.1.0版本的fabric-ca中，只会组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书。 这里继续沿用之前的fabric-deploy中的tls证书，在最后的重新部署操作，只会替换msp目录。 但是需要将验证tls证书的ca添加到msp目录中，如下： cp -rf certs/ordererOrganizations/example.com/msp/tlscacerts fabric-ca-files/example.com/msp/ cp -rf certs/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/ cp -rf certs/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/ 如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。 注册example.com的管理员Admin@example.com 可以直接用命令行（命令比较长，这里用\\截断了）： fabric-ca-client register --id.name Admin@example.com --id.type client --id.affiliation &quot;com.example.org1&quot; \ --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,\ hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; 也可以将命令行参数写在fabric-ca admin的配置文件fabric-ca-files/admin/fabric-ca-client-config.yaml中。 $ ls fabric-ca-files/admin/admin/ fabric-ca-client-config.yaml msp 为了演示清楚，这里使用修改配置文件的方式，将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@example.com type: client affiliation: com.example maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀:ecert表示true，例如: fabric-ca-client register --id.affiliation &quot;com.example.org1&quot; --id.attrs &quot;role=admin:ecert&quot; 直接执行下面的命令，即可完成用户Admin@example.com注册，注意这时候的注册使用fabricCA的admin账号完成的： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 如果不用--id.secret指定密码，会自动生成密码。 其它配置的含义是用户名为Admin@example.com，类型是client，它能够管理com.example.*下的用户，如下: --id.name Admin@example.com //用户名 --id.type client //类型为client --id.affiliation &quot;com.example&quot; //权利访问 hf.Registrar.Roles=client,orderer,peer,user //能够管理的用户类型 hf.Registrar.DelegateRoles=client,orderer,peer,user //可以授权给子用户管理的用户类型 hf.Registrar.Attributes=* //可以为子用户设置所有属性 hf.GenCRL=true //可以生成撤销证书列表 hf.Revoker=true //可以撤销用户 hf.AffiliationMgr=true //能够管理联盟 hf.IntermediateCA=true //可以作为中间CA role=admin:ecert //自定义属性 生成Admin@example.com凭证： $ mkdir -p ./fabric-ca-files/example.com/admin $ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ 这时候可以用Admin@example.com的身份查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin 2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ mkdir fabric-ca-files/example.com/msp/admincerts/ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/msp/admincerts/ 只有这样，才能具备管理员权限。 注册org1.example.com的管理员Admin@org1.example.com 为org1.example.com的管理员Admin@org1.example.com准备一个目录: cd ~/fabric-deploy mkdir -p ./fabric-ca-files/org1.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org1.example.com type: client affiliation: com.example.org1 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/admin $ ls ./fabric-ca-files/org1.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin 2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 注意与Admin@example.com的区别，这里只能看到组织com.example.org1 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： mkdir fabric-ca-files/org1.example.com/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/msp/admincerts/ 在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* 注册org2.example.com的管理员Admin@org2.example.com 为org2.example.com的管理员Admin@org2.example.com准备一个目录: cd ~/fabric-deploy mkdir -p ./fabric-ca-files/org2.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org2.example.com type: client affiliation: com.example.org2 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/admin $ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin 2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org2 Admin@org2.example.com只能看到组织com.example.org2。 将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： mkdir fabric-ca-files/org2.example.com/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/msp/admincerts/ 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* 各个组织分别使用自己的Admin账户创建其它账号 example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 orderer.example.com 使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml: id: name: orderer.example.com type: orderer affiliation: com.example maxenrollments: 0 attributes: - name: role value: orderer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password mkdir ./fabric-ca-files/example.com/orderer fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer 将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： mkdir fabric-ca-files/example.com/orderer/msp/admincerts cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/ peer0.org1.example.com 使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer0 fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/ peer1.org1.example.com 使用Admin@org1.example.com注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer1 fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/ peer0.org2.example.com 使用Admin@org2.example.com注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer0 fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/ 重新部署 然后在hyperledger的fabric项目的全手动部署执行结束后得到的fabric-deploy目录基础上，进行下面的操作。 修改configtx.yaml，将其中的msp路径修改为通过fabric-ca创建的msp目录: Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: ./fabric-ca-files/example.com/msp - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: ./fabric-ca-files/org1.example.com/msp AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: ./fabric-ca-files/org2.example.com/msp AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations: 注意configtx.yaml中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。 更新orderer.example.com/中的msp： rm -rf orderer.example.com/msp/ cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/ 更新peer0.org1.example.com的msp: rm -rf peer0.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer0/msp peer0.org1.example.com/ 更新peer1.org1.example.com的msp: rm -rf peer1.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer1/msp peer1.org1.example.com/ 更新peer0.org2.example.com的msp: rm -rf peer0.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer0.org2.example.com/ 然后重新部署下面的组件，参考hyperledger的fabric项目的全手动部署: 开始部署。 scp -r orderer.example.com/* root@192.168.88.10:/opt/app/fabric/orderer/ scp -r peer0.org1.example.com/* root@192.168.88.10:/opt/app/fabric/peer/ scp -r peer1.org1.example.com/* root@192.168.88.11:/opt/app/fabric/peer/ scp -r peer0.org2.example.com/* root@192.168.88.12:/opt/app/fabric/peer/ 重新部署的时候，注意将之前已经启动的服务停止，并删除安装文件。 重新部署完成后，重新生成./genesisblock文件，并上传到orderer.example.com的安装路径中: ./bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./genesisblock 这里没有使用中间CA，生成genesisblock的时候，会提示: 2018-05-04 16:37:17.788 CST [msp] getPemMaterialFromDir -&gt; WARN 002 Failed reading file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem: no pem content for file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem 将intermediatecerts中的文件删除即可， rm fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem rm fabric-ca-files/org1.example.com/msp/intermediatecerts/localhost-7054.pem rm fabric-ca-files/org2.example.com/msp/intermediatecerts/localhost-7054.pem 如果是通过intermediateCA生成的证书，intermediatecerts中包含中间CA的证书。这里只部署了一个fabric-ca作为rootCA，因此intermediatecerts中是一个空文件。 将生成的genesisblock上传到orderer.example.com： scp genesisblock root@192.168.88.10:/opt/app/fabric/orderer/ 可以用下面的命令查看创始块的内容: ./bin/configtxgen -inspectBlock genesisblock 然后重新启动fabric的所有组件。 更新用户的证书以及后续操作 因为我们是在hyperledger的fabric项目的全手动部署执行结束后得到的fabric-deploy目录基础上，进行操作的。 所有还要更新一下该目录下用户目录中的msp： $ rm -rf Admin\@org1.example.com/msp $ cp -rf fabric-ca-files/org1.example.com/admin/msp Admin\@org1.example.com/ $ cd Admin\@org1.example.com $ ./peer.sh node status status:STARTED 2018-05-04 17:03:06.202 CST [main] main -&gt; INFO 001 Exiting..... $ cd ../ $ rm -rf Admin\@org2.example.com/msp $ cp -rf fabric-ca-files/org2.example.com/admin/msp Admin\@org2.example.com/ $ cd Admin\@org2.example.com $ ./peer.sh node status status:STARTED 2018-05-04 17:08:27.959 CST [main] main -&gt; INFO 001 Exiting..... 重新创建channel，设置anchor peer： ./bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx mychannel.tx -channelID mychannel ./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP ./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP cd Admin\@org1.example.com/ ./peer.sh channel create -o orderer.example.com:7050 -c mychannel -f ../mychannel.tx --tls true --cafile tlsca.example.com-cert.pem cp mychannel.block ../Admin\@org2.example.com/ ./peer.sh channel join -b mychannel.block ./peer.sh channel join -b mychannel.block //将peer.sh中的peer0修改为peer1后在执行一次 ./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org1MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem cd ../Admin\@org2.example.com/ ./peer.sh channel join -b mychannel.block ./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org2MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem 这些操作的含义见：&nbsp;hyperledger的fabric项目的全手动部署-创建channel与peer的设置 后续的合约创建、更新、调用等操作这里就不演示了，请直接查看:&nbsp;hyperledger的fabric项目的全手动部署：安装合约: go get github.com/lijiaocn/fabric-chaincode-example/demo ./peer.sh chaincode package demo-pack.out -n demo -v 0.0.1 -s -S -p github.com/lijiaocn/fabric-chaincode-example/demo ./peer.sh chaincode signpackage demo-pack.out signed-demo-pack.out ./peer.sh chaincode install ./signed-demo-pack.out ./peer.sh chaincode instantiate -o orderer.example.com:7050 --tls true --cafile ./tlsca.example.com-cert.pem -C mychannel -n demo -v 0.0.1 -c &#39;{&quot;Args&quot;:[&quot;init&quot;]}&#39; -P &quot;OR(&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; ./peer.sh chaincode query -C mychannel -n demox -c &#39;{&quot;Args&quot;:[&quot;attr&quot;,&quot;role&quot;]}&#39; ./peer.sh chaincode query -C mychannel -n demox -c &#39;{&quot;Args&quot;:[&quot;attr&quot;,&quot;hf.Type&quot;]}&#39; 有问题的话，可以到下面的知识星球中交流，我会在里面分享一些资料： 参考 Welcome to Hyperledger Fabric CA fabric-ca codes HyperLedger的fabric项目的全手动部署 HyperLedger的fabric项目的全手动部署: 开始部署 HyperLedger的fabric项目的全手动部署-创建channel与peer的设置 超级账本HyperLedger的fabricCA的用法讲解 HyperLedger FabricCA Config Database and LDAP HyperLedger的fabric项目的全手动部署: 安装合约 超级账本HyperLedger的fabricCA的用法讲解 &nbsp; 阅读更多" />
<meta property="og:description" content="原文地址：&nbsp;超级账本HyperLedger的Fabric-CA的使用演示(两个组织一个Orderer三个Peer) 说明 启动fabric-ca 生成fabric-ca admin的凭证 创建联盟 为每个组织准备msp 注册example.com的管理员Admin@example.com 注册org1.example.com的管理员Admin@org1.example.com 注册org2.example.com的管理员Admin@org2.example.com 各个组织分别使用自己的Admin账户创建其它账号 orderer.example.com peer0.org1.example.com peer1.org1.example.com peer0.org2.example.com 重新部署 更新用户的证书以及后续操作 参考 说明 本文是对hyperledger的fabric项目的全手动部署的补充，这里将演示如何使用fabric-ca为每个组件和用户生成证书。 如果对下面的操作有不清楚的地方，可以参阅超级账本HyperLedger的fabricCA的用法讲解。演示视频已经制作完成： IT技术快速入门学院：HyperLedger FabricCA使用演示的视频教程 可以使用下面的部署方式： 这里做了简化，只部署了一个Fabric-CA作为rootCA。 将创建一个由两个组织org1.example.com和org2.example.com组成的的联盟。 另外还有一个组织example.com用来部署orderer。 example.com部署了一个solo模式的orderer。（多个orderer的部署方式，以后探讨） orderer.example.com org1.example.com部署了两个peer: peer0.org1.example.com peer1.org1.example.com org2.example.com部署了一个peer: peer0.org2.example.com 每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建7个用户： example.com: Admin@example.com orderer.example.com org1.example.com: Admin@org1.example.com peer0.org1.example.com peer1.org1.example.com org2.example.com: Admin@org2.example.com peer0.org2.example.com 这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。 启动fabric-ca fabirc-ca的编译： $ go get -u github.com/hyperledger/fabric-ca $ cd $GOPATH/src/github.com/hyperledger/fabric-ca $ make fabric-ca-server $ make fabric-ca-client $ ls bin/ fabric-ca-client fabric-ca-server 这里将fabric-ca部署在/opt/app/fabric-ca/server目录中： mkdir -p /opt/app/fabric-ca/server cp -rf $GOPATH/src/github.com/hyperledger/fabric-ca/bin/* /opt/app/fabric-ca/server ln -s /opt/app/fabric-ca/server/fabric-ca-client /usr/bin/fabric-ca-client 直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置) cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass &amp; 如果有删除联盟和删除用户的需求，需要用下面的方式启动： cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove --cfg.identities.allowremove &amp; 注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：HyperLedger FabricCA Config Database and LDAP。 生成fabric-ca admin的凭证 下面的操作在《hyperledger的fabric项目的全手动部署》中创建的fabric-deploy目录中进行后续操作。 cd ~/fabric-deploy mkdir fabric-ca-files 生成fabric-ca admin的凭证，用-H参数指定client目录： mkdir -p `pwd`/fabric-ca-files/admin fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin 也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。 export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin mkdir -p $FABRIC_CA_CLIENT_HOME fabric-ca-client enroll -u http://admin:pass@localhost:7054 为了防止混乱，后面的演示操作中，都直接用-H指定目录。 创建联盟 上面的启动方式默认会创建两个组织： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot; affiliation: . affiliation: org2 affiliation: org2.department1 affiliation: org1 affiliation: org1.department1 affiliation: org1.department2 为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org2 执行下面命令创建联盟： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org2 创建联盟如下： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 为每个组织准备msp 为example.com准备msp，将ca证书等存放example.com组织的目录中: mkdir -p ./fabric-ca-files/example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp //-M需要指定绝对路径 命令执行结束后，会在fabric-ca-files/example.com/msp得到文件： $ tree fabric-ca-files/example.com/msp/ example.com/msp/ |-- cacerts | `-- localhost-7054.pem |-- intermediatecerts | `-- localhost-7054.pem |-- keystore `-- signcerts 注意通过getcacert得到msp目录中只有CA证书。 同样的方式为org1.example.com获取msp: mkdir -p fabric-ca-files/org1.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp 为org2.example.com准备msp: mkdir -p ./fabric-ca-files/org2.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp 这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。 在1.1.0版本的fabric-ca中，只会组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书。 这里继续沿用之前的fabric-deploy中的tls证书，在最后的重新部署操作，只会替换msp目录。 但是需要将验证tls证书的ca添加到msp目录中，如下： cp -rf certs/ordererOrganizations/example.com/msp/tlscacerts fabric-ca-files/example.com/msp/ cp -rf certs/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/ cp -rf certs/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/ 如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。 注册example.com的管理员Admin@example.com 可以直接用命令行（命令比较长，这里用\\截断了）： fabric-ca-client register --id.name Admin@example.com --id.type client --id.affiliation &quot;com.example.org1&quot; \ --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,\ hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; 也可以将命令行参数写在fabric-ca admin的配置文件fabric-ca-files/admin/fabric-ca-client-config.yaml中。 $ ls fabric-ca-files/admin/admin/ fabric-ca-client-config.yaml msp 为了演示清楚，这里使用修改配置文件的方式，将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@example.com type: client affiliation: com.example maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀:ecert表示true，例如: fabric-ca-client register --id.affiliation &quot;com.example.org1&quot; --id.attrs &quot;role=admin:ecert&quot; 直接执行下面的命令，即可完成用户Admin@example.com注册，注意这时候的注册使用fabricCA的admin账号完成的： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 如果不用--id.secret指定密码，会自动生成密码。 其它配置的含义是用户名为Admin@example.com，类型是client，它能够管理com.example.*下的用户，如下: --id.name Admin@example.com //用户名 --id.type client //类型为client --id.affiliation &quot;com.example&quot; //权利访问 hf.Registrar.Roles=client,orderer,peer,user //能够管理的用户类型 hf.Registrar.DelegateRoles=client,orderer,peer,user //可以授权给子用户管理的用户类型 hf.Registrar.Attributes=* //可以为子用户设置所有属性 hf.GenCRL=true //可以生成撤销证书列表 hf.Revoker=true //可以撤销用户 hf.AffiliationMgr=true //能够管理联盟 hf.IntermediateCA=true //可以作为中间CA role=admin:ecert //自定义属性 生成Admin@example.com凭证： $ mkdir -p ./fabric-ca-files/example.com/admin $ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ 这时候可以用Admin@example.com的身份查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin 2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ mkdir fabric-ca-files/example.com/msp/admincerts/ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/msp/admincerts/ 只有这样，才能具备管理员权限。 注册org1.example.com的管理员Admin@org1.example.com 为org1.example.com的管理员Admin@org1.example.com准备一个目录: cd ~/fabric-deploy mkdir -p ./fabric-ca-files/org1.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org1.example.com type: client affiliation: com.example.org1 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/admin $ ls ./fabric-ca-files/org1.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin 2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 注意与Admin@example.com的区别，这里只能看到组织com.example.org1 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： mkdir fabric-ca-files/org1.example.com/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/msp/admincerts/ 在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* 注册org2.example.com的管理员Admin@org2.example.com 为org2.example.com的管理员Admin@org2.example.com准备一个目录: cd ~/fabric-deploy mkdir -p ./fabric-ca-files/org2.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org2.example.com type: client affiliation: com.example.org2 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/admin $ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin 2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org2 Admin@org2.example.com只能看到组织com.example.org2。 将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： mkdir fabric-ca-files/org2.example.com/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/msp/admincerts/ 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* 各个组织分别使用自己的Admin账户创建其它账号 example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 orderer.example.com 使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml: id: name: orderer.example.com type: orderer affiliation: com.example maxenrollments: 0 attributes: - name: role value: orderer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password mkdir ./fabric-ca-files/example.com/orderer fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer 将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： mkdir fabric-ca-files/example.com/orderer/msp/admincerts cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/ peer0.org1.example.com 使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer0 fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/ peer1.org1.example.com 使用Admin@org1.example.com注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer1 fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/ peer0.org2.example.com 使用Admin@org2.example.com注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer0 fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/ 重新部署 然后在hyperledger的fabric项目的全手动部署执行结束后得到的fabric-deploy目录基础上，进行下面的操作。 修改configtx.yaml，将其中的msp路径修改为通过fabric-ca创建的msp目录: Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: ./fabric-ca-files/example.com/msp - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: ./fabric-ca-files/org1.example.com/msp AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: ./fabric-ca-files/org2.example.com/msp AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations: 注意configtx.yaml中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。 更新orderer.example.com/中的msp： rm -rf orderer.example.com/msp/ cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/ 更新peer0.org1.example.com的msp: rm -rf peer0.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer0/msp peer0.org1.example.com/ 更新peer1.org1.example.com的msp: rm -rf peer1.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer1/msp peer1.org1.example.com/ 更新peer0.org2.example.com的msp: rm -rf peer0.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer0.org2.example.com/ 然后重新部署下面的组件，参考hyperledger的fabric项目的全手动部署: 开始部署。 scp -r orderer.example.com/* root@192.168.88.10:/opt/app/fabric/orderer/ scp -r peer0.org1.example.com/* root@192.168.88.10:/opt/app/fabric/peer/ scp -r peer1.org1.example.com/* root@192.168.88.11:/opt/app/fabric/peer/ scp -r peer0.org2.example.com/* root@192.168.88.12:/opt/app/fabric/peer/ 重新部署的时候，注意将之前已经启动的服务停止，并删除安装文件。 重新部署完成后，重新生成./genesisblock文件，并上传到orderer.example.com的安装路径中: ./bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./genesisblock 这里没有使用中间CA，生成genesisblock的时候，会提示: 2018-05-04 16:37:17.788 CST [msp] getPemMaterialFromDir -&gt; WARN 002 Failed reading file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem: no pem content for file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem 将intermediatecerts中的文件删除即可， rm fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem rm fabric-ca-files/org1.example.com/msp/intermediatecerts/localhost-7054.pem rm fabric-ca-files/org2.example.com/msp/intermediatecerts/localhost-7054.pem 如果是通过intermediateCA生成的证书，intermediatecerts中包含中间CA的证书。这里只部署了一个fabric-ca作为rootCA，因此intermediatecerts中是一个空文件。 将生成的genesisblock上传到orderer.example.com： scp genesisblock root@192.168.88.10:/opt/app/fabric/orderer/ 可以用下面的命令查看创始块的内容: ./bin/configtxgen -inspectBlock genesisblock 然后重新启动fabric的所有组件。 更新用户的证书以及后续操作 因为我们是在hyperledger的fabric项目的全手动部署执行结束后得到的fabric-deploy目录基础上，进行操作的。 所有还要更新一下该目录下用户目录中的msp： $ rm -rf Admin\@org1.example.com/msp $ cp -rf fabric-ca-files/org1.example.com/admin/msp Admin\@org1.example.com/ $ cd Admin\@org1.example.com $ ./peer.sh node status status:STARTED 2018-05-04 17:03:06.202 CST [main] main -&gt; INFO 001 Exiting..... $ cd ../ $ rm -rf Admin\@org2.example.com/msp $ cp -rf fabric-ca-files/org2.example.com/admin/msp Admin\@org2.example.com/ $ cd Admin\@org2.example.com $ ./peer.sh node status status:STARTED 2018-05-04 17:08:27.959 CST [main] main -&gt; INFO 001 Exiting..... 重新创建channel，设置anchor peer： ./bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx mychannel.tx -channelID mychannel ./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP ./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP cd Admin\@org1.example.com/ ./peer.sh channel create -o orderer.example.com:7050 -c mychannel -f ../mychannel.tx --tls true --cafile tlsca.example.com-cert.pem cp mychannel.block ../Admin\@org2.example.com/ ./peer.sh channel join -b mychannel.block ./peer.sh channel join -b mychannel.block //将peer.sh中的peer0修改为peer1后在执行一次 ./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org1MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem cd ../Admin\@org2.example.com/ ./peer.sh channel join -b mychannel.block ./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org2MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem 这些操作的含义见：&nbsp;hyperledger的fabric项目的全手动部署-创建channel与peer的设置 后续的合约创建、更新、调用等操作这里就不演示了，请直接查看:&nbsp;hyperledger的fabric项目的全手动部署：安装合约: go get github.com/lijiaocn/fabric-chaincode-example/demo ./peer.sh chaincode package demo-pack.out -n demo -v 0.0.1 -s -S -p github.com/lijiaocn/fabric-chaincode-example/demo ./peer.sh chaincode signpackage demo-pack.out signed-demo-pack.out ./peer.sh chaincode install ./signed-demo-pack.out ./peer.sh chaincode instantiate -o orderer.example.com:7050 --tls true --cafile ./tlsca.example.com-cert.pem -C mychannel -n demo -v 0.0.1 -c &#39;{&quot;Args&quot;:[&quot;init&quot;]}&#39; -P &quot;OR(&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; ./peer.sh chaincode query -C mychannel -n demox -c &#39;{&quot;Args&quot;:[&quot;attr&quot;,&quot;role&quot;]}&#39; ./peer.sh chaincode query -C mychannel -n demox -c &#39;{&quot;Args&quot;:[&quot;attr&quot;,&quot;hf.Type&quot;]}&#39; 有问题的话，可以到下面的知识星球中交流，我会在里面分享一些资料： 参考 Welcome to Hyperledger Fabric CA fabric-ca codes HyperLedger的fabric项目的全手动部署 HyperLedger的fabric项目的全手动部署: 开始部署 HyperLedger的fabric项目的全手动部署-创建channel与peer的设置 超级账本HyperLedger的fabricCA的用法讲解 HyperLedger FabricCA Config Database and LDAP HyperLedger的fabric项目的全手动部署: 安装合约 超级账本HyperLedger的fabricCA的用法讲解 &nbsp; 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/05/09/69075eb90b3aa295a42842a46ca56cef.html" />
<meta property="og:url" content="https://mlh.app/2018/05/09/69075eb90b3aa295a42842a46ca56cef.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-09T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"原文地址：&nbsp;超级账本HyperLedger的Fabric-CA的使用演示(两个组织一个Orderer三个Peer) 说明 启动fabric-ca 生成fabric-ca admin的凭证 创建联盟 为每个组织准备msp 注册example.com的管理员Admin@example.com 注册org1.example.com的管理员Admin@org1.example.com 注册org2.example.com的管理员Admin@org2.example.com 各个组织分别使用自己的Admin账户创建其它账号 orderer.example.com peer0.org1.example.com peer1.org1.example.com peer0.org2.example.com 重新部署 更新用户的证书以及后续操作 参考 说明 本文是对hyperledger的fabric项目的全手动部署的补充，这里将演示如何使用fabric-ca为每个组件和用户生成证书。 如果对下面的操作有不清楚的地方，可以参阅超级账本HyperLedger的fabricCA的用法讲解。演示视频已经制作完成： IT技术快速入门学院：HyperLedger FabricCA使用演示的视频教程 可以使用下面的部署方式： 这里做了简化，只部署了一个Fabric-CA作为rootCA。 将创建一个由两个组织org1.example.com和org2.example.com组成的的联盟。 另外还有一个组织example.com用来部署orderer。 example.com部署了一个solo模式的orderer。（多个orderer的部署方式，以后探讨） orderer.example.com org1.example.com部署了两个peer: peer0.org1.example.com peer1.org1.example.com org2.example.com部署了一个peer: peer0.org2.example.com 每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建7个用户： example.com: Admin@example.com orderer.example.com org1.example.com: Admin@org1.example.com peer0.org1.example.com peer1.org1.example.com org2.example.com: Admin@org2.example.com peer0.org2.example.com 这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。 启动fabric-ca fabirc-ca的编译： $ go get -u github.com/hyperledger/fabric-ca $ cd $GOPATH/src/github.com/hyperledger/fabric-ca $ make fabric-ca-server $ make fabric-ca-client $ ls bin/ fabric-ca-client fabric-ca-server 这里将fabric-ca部署在/opt/app/fabric-ca/server目录中： mkdir -p /opt/app/fabric-ca/server cp -rf $GOPATH/src/github.com/hyperledger/fabric-ca/bin/* /opt/app/fabric-ca/server ln -s /opt/app/fabric-ca/server/fabric-ca-client /usr/bin/fabric-ca-client 直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置) cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass &amp; 如果有删除联盟和删除用户的需求，需要用下面的方式启动： cd /opt/app/fabric-ca/server ./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove --cfg.identities.allowremove &amp; 注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：HyperLedger FabricCA Config Database and LDAP。 生成fabric-ca admin的凭证 下面的操作在《hyperledger的fabric项目的全手动部署》中创建的fabric-deploy目录中进行后续操作。 cd ~/fabric-deploy mkdir fabric-ca-files 生成fabric-ca admin的凭证，用-H参数指定client目录： mkdir -p `pwd`/fabric-ca-files/admin fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin 也可以用环境变量FABRIC_CA_CLIENT_HOME指定了client的工作目录，生成的用户凭证将存放在这个目录中。 export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin mkdir -p $FABRIC_CA_CLIENT_HOME fabric-ca-client enroll -u http://admin:pass@localhost:7054 为了防止混乱，后面的演示操作中，都直接用-H指定目录。 创建联盟 上面的启动方式默认会创建两个组织： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 &quot;OK&quot; affiliation: . affiliation: org2 affiliation: org2.department1 affiliation: org1 affiliation: org1.department1 affiliation: org1.department2 为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation remove --force org2 执行下面命令创建联盟： fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org1 fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation add com.example.org2 创建联盟如下： $ fabric-ca-client -H `pwd`/fabric-ca-files/admin affiliation list 2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 为每个组织准备msp 为example.com准备msp，将ca证书等存放example.com组织的目录中: mkdir -p ./fabric-ca-files/example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp //-M需要指定绝对路径 命令执行结束后，会在fabric-ca-files/example.com/msp得到文件： $ tree fabric-ca-files/example.com/msp/ example.com/msp/ |-- cacerts | `-- localhost-7054.pem |-- intermediatecerts | `-- localhost-7054.pem |-- keystore `-- signcerts 注意通过getcacert得到msp目录中只有CA证书。 同样的方式为org1.example.com获取msp: mkdir -p fabric-ca-files/org1.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp 为org2.example.com准备msp: mkdir -p ./fabric-ca-files/org2.example.com/msp fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp 这里是用getcacert为每个组织准备需要的ca文件，在生成创始块的时候会用到。 在1.1.0版本的fabric-ca中，只会组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书。 这里继续沿用之前的fabric-deploy中的tls证书，在最后的重新部署操作，只会替换msp目录。 但是需要将验证tls证书的ca添加到msp目录中，如下： cp -rf certs/ordererOrganizations/example.com/msp/tlscacerts fabric-ca-files/example.com/msp/ cp -rf certs/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/ cp -rf certs/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/ 如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。 注册example.com的管理员Admin@example.com 可以直接用命令行（命令比较长，这里用\\\\截断了）： fabric-ca-client register --id.name Admin@example.com --id.type client --id.affiliation &quot;com.example.org1&quot; \\ --id.attrs &#39;&quot;hf.Registrar.Roles=client,orderer,peer,user&quot;,&quot;hf.Registrar.DelegateRoles=client,orderer,peer,user&quot;,\\ hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert&#39; 也可以将命令行参数写在fabric-ca admin的配置文件fabric-ca-files/admin/fabric-ca-client-config.yaml中。 $ ls fabric-ca-files/admin/admin/ fabric-ca-client-config.yaml msp 为了演示清楚，这里使用修改配置文件的方式，将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@example.com type: client affiliation: com.example maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀:ecert表示true，例如: fabric-ca-client register --id.affiliation &quot;com.example.org1&quot; --id.attrs &quot;role=admin:ecert&quot; 直接执行下面的命令，即可完成用户Admin@example.com注册，注意这时候的注册使用fabricCA的admin账号完成的： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 如果不用--id.secret指定密码，会自动生成密码。 其它配置的含义是用户名为Admin@example.com，类型是client，它能够管理com.example.*下的用户，如下: --id.name Admin@example.com //用户名 --id.type client //类型为client --id.affiliation &quot;com.example&quot; //权利访问 hf.Registrar.Roles=client,orderer,peer,user //能够管理的用户类型 hf.Registrar.DelegateRoles=client,orderer,peer,user //可以授权给子用户管理的用户类型 hf.Registrar.Attributes=* //可以为子用户设置所有属性 hf.GenCRL=true //可以生成撤销证书列表 hf.Revoker=true //可以撤销用户 hf.AffiliationMgr=true //能够管理联盟 hf.IntermediateCA=true //可以作为中间CA role=admin:ecert //自定义属性 生成Admin@example.com凭证： $ mkdir -p ./fabric-ca-files/example.com/admin $ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/admin $ ls ./fabric-ca-files/example.com/admin fabric-ca-client-config.yaml msp/ 这时候可以用Admin@example.com的身份查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin 2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 affiliation: com.example.org2 最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/ mkdir fabric-ca-files/example.com/msp/admincerts/ cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/msp/admincerts/ 只有这样，才能具备管理员权限。 注册org1.example.com的管理员Admin@org1.example.com 为org1.example.com的管理员Admin@org1.example.com准备一个目录: cd ~/fabric-deploy mkdir -p ./fabric-ca-files/org1.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org1.example.com type: client affiliation: com.example.org1 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/admin $ ls ./fabric-ca-files/org1.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin 2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org1 注意与Admin@example.com的区别，这里只能看到组织com.example.org1 将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中： mkdir fabric-ca-files/org1.example.com/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/msp/admincerts/ 在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/ cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/* 注册org2.example.com的管理员Admin@org2.example.com 为org2.example.com的管理员Admin@org2.example.com准备一个目录: cd ~/fabric-deploy mkdir -p ./fabric-ca-files/org2.example.com/admin 将fabric-ca-files/admin/fabric-ca-client-config.yaml其中的id部分修改为： id: name: Admin@org2.example.com type: client affiliation: com.example.org2 maxenrollments: 0 attributes: - name: hf.Registrar.Roles value: client,orderer,peer,user - name: hf.Registrar.DelegateRoles value: client,orderer,peer,user - name: hf.Registrar.Attributes value: &quot;*&quot; - name: hf.GenCRL value: true - name: hf.Revoker value: true - name: hf.AffiliationMgr value: true - name: hf.IntermediateCA value: true - name: role value: admin ecert: true 注册： fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password 生成凭证： $ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/admin $ ls ./fabric-ca-files/org2.example.com/admin fabric-ca-client-config.yaml msp/ 查看联盟： $ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin 2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 &quot;OK&quot; affiliation: com affiliation: com.example affiliation: com.example.org2 Admin@org2.example.com只能看到组织com.example.org2。 将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中： mkdir fabric-ca-files/org2.example.com/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/msp/admincerts/ 在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在： mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/ cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/admin/msp/admincerts/ 另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning： rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/* 各个组织分别使用自己的Admin账户创建其它账号 example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。 orderer.example.com 使用Admin@example.com注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/example.com/admin/。 修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml: id: name: orderer.example.com type: orderer affiliation: com.example maxenrollments: 0 attributes: - name: role value: orderer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password mkdir ./fabric-ca-files/example.com/orderer fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer 将Admin@example.com的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts： mkdir fabric-ca-files/example.com/orderer/msp/admincerts cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/ peer0.org1.example.com 使用Admin@org1.example.com注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer0 fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/ peer1.org1.example.com 使用Admin@org1.example.com注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/org1.example.com/admin/。 修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml: id: name: peer1.org1.example.com type: peer affiliation: com.example.org1 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org1.example.com/peer1 fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1 将Admin@org1.example.com的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts： mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/ peer0.org2.example.com 使用Admin@org2.example.com注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/org2.example.com/admin/。 修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml: id: name: peer0.org2.example.com type: peer affiliation: com.example.org2 maxenrollments: 0 attributes: - name: role value: peer ecert: true 注册以及生成凭证： fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password mkdir ./fabric-ca-files/org2.example.com/peer0 fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0 将Admin@org2.example.com的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts： mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/ 重新部署 然后在hyperledger的fabric项目的全手动部署执行结束后得到的fabric-deploy目录基础上，进行下面的操作。 修改configtx.yaml，将其中的msp路径修改为通过fabric-ca创建的msp目录: Profiles: TwoOrgsOrdererGenesis: Orderer: &lt;&lt;: *OrdererDefaults Organizations: - *OrdererOrg Consortiums: SampleConsortium: Organizations: - *Org1 - *Org2 TwoOrgsChannel: Consortium: SampleConsortium Application: &lt;&lt;: *ApplicationDefaults Organizations: - *Org1 - *Org2 Organizations: - &amp;OrdererOrg Name: OrdererOrg ID: OrdererMSP MSPDir: ./fabric-ca-files/example.com/msp - &amp;Org1 Name: Org1MSP ID: Org1MSP MSPDir: ./fabric-ca-files/org1.example.com/msp AnchorPeers: - Host: peer0.org1.example.com Port: 7051 - &amp;Org2 Name: Org2MSP ID: Org2MSP MSPDir: ./fabric-ca-files/org2.example.com/msp AnchorPeers: - Host: peer0.org2.example.com Port: 7051 Orderer: &amp;OrdererDefaults OrdererType: solo Addresses: - orderer.example.com:7050 BatchTimeout: 2s BatchSize: MaxMessageCount: 10 AbsoluteMaxBytes: 99 MB PreferredMaxBytes: 512 KB Kafka: Brokers: - 127.0.0.1:9092 Organizations: Application: &amp;ApplicationDefaults Organizations: 注意configtx.yaml中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。 更新orderer.example.com/中的msp： rm -rf orderer.example.com/msp/ cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/ 更新peer0.org1.example.com的msp: rm -rf peer0.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer0/msp peer0.org1.example.com/ 更新peer1.org1.example.com的msp: rm -rf peer1.org1.example.com/msp/ cp -rf fabric-ca-files/org1.example.com/peer1/msp peer1.org1.example.com/ 更新peer0.org2.example.com的msp: rm -rf peer0.org2.example.com/msp/ cp -rf fabric-ca-files/org2.example.com/peer0/msp peer0.org2.example.com/ 然后重新部署下面的组件，参考hyperledger的fabric项目的全手动部署: 开始部署。 scp -r orderer.example.com/* root@192.168.88.10:/opt/app/fabric/orderer/ scp -r peer0.org1.example.com/* root@192.168.88.10:/opt/app/fabric/peer/ scp -r peer1.org1.example.com/* root@192.168.88.11:/opt/app/fabric/peer/ scp -r peer0.org2.example.com/* root@192.168.88.12:/opt/app/fabric/peer/ 重新部署的时候，注意将之前已经启动的服务停止，并删除安装文件。 重新部署完成后，重新生成./genesisblock文件，并上传到orderer.example.com的安装路径中: ./bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./genesisblock 这里没有使用中间CA，生成genesisblock的时候，会提示: 2018-05-04 16:37:17.788 CST [msp] getPemMaterialFromDir -&gt; WARN 002 Failed reading file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem: no pem content for file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem 将intermediatecerts中的文件删除即可， rm fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem rm fabric-ca-files/org1.example.com/msp/intermediatecerts/localhost-7054.pem rm fabric-ca-files/org2.example.com/msp/intermediatecerts/localhost-7054.pem 如果是通过intermediateCA生成的证书，intermediatecerts中包含中间CA的证书。这里只部署了一个fabric-ca作为rootCA，因此intermediatecerts中是一个空文件。 将生成的genesisblock上传到orderer.example.com： scp genesisblock root@192.168.88.10:/opt/app/fabric/orderer/ 可以用下面的命令查看创始块的内容: ./bin/configtxgen -inspectBlock genesisblock 然后重新启动fabric的所有组件。 更新用户的证书以及后续操作 因为我们是在hyperledger的fabric项目的全手动部署执行结束后得到的fabric-deploy目录基础上，进行操作的。 所有还要更新一下该目录下用户目录中的msp： $ rm -rf Admin\\@org1.example.com/msp $ cp -rf fabric-ca-files/org1.example.com/admin/msp Admin\\@org1.example.com/ $ cd Admin\\@org1.example.com $ ./peer.sh node status status:STARTED 2018-05-04 17:03:06.202 CST [main] main -&gt; INFO 001 Exiting..... $ cd ../ $ rm -rf Admin\\@org2.example.com/msp $ cp -rf fabric-ca-files/org2.example.com/admin/msp Admin\\@org2.example.com/ $ cd Admin\\@org2.example.com $ ./peer.sh node status status:STARTED 2018-05-04 17:08:27.959 CST [main] main -&gt; INFO 001 Exiting..... 重新创建channel，设置anchor peer： ./bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx mychannel.tx -channelID mychannel ./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP ./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP cd Admin\\@org1.example.com/ ./peer.sh channel create -o orderer.example.com:7050 -c mychannel -f ../mychannel.tx --tls true --cafile tlsca.example.com-cert.pem cp mychannel.block ../Admin\\@org2.example.com/ ./peer.sh channel join -b mychannel.block ./peer.sh channel join -b mychannel.block //将peer.sh中的peer0修改为peer1后在执行一次 ./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org1MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem cd ../Admin\\@org2.example.com/ ./peer.sh channel join -b mychannel.block ./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org2MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem 这些操作的含义见：&nbsp;hyperledger的fabric项目的全手动部署-创建channel与peer的设置 后续的合约创建、更新、调用等操作这里就不演示了，请直接查看:&nbsp;hyperledger的fabric项目的全手动部署：安装合约: go get github.com/lijiaocn/fabric-chaincode-example/demo ./peer.sh chaincode package demo-pack.out -n demo -v 0.0.1 -s -S -p github.com/lijiaocn/fabric-chaincode-example/demo ./peer.sh chaincode signpackage demo-pack.out signed-demo-pack.out ./peer.sh chaincode install ./signed-demo-pack.out ./peer.sh chaincode instantiate -o orderer.example.com:7050 --tls true --cafile ./tlsca.example.com-cert.pem -C mychannel -n demo -v 0.0.1 -c &#39;{&quot;Args&quot;:[&quot;init&quot;]}&#39; -P &quot;OR(&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; ./peer.sh chaincode query -C mychannel -n demox -c &#39;{&quot;Args&quot;:[&quot;attr&quot;,&quot;role&quot;]}&#39; ./peer.sh chaincode query -C mychannel -n demox -c &#39;{&quot;Args&quot;:[&quot;attr&quot;,&quot;hf.Type&quot;]}&#39; 有问题的话，可以到下面的知识星球中交流，我会在里面分享一些资料： 参考 Welcome to Hyperledger Fabric CA fabric-ca codes HyperLedger的fabric项目的全手动部署 HyperLedger的fabric项目的全手动部署: 开始部署 HyperLedger的fabric项目的全手动部署-创建channel与peer的设置 超级账本HyperLedger的fabricCA的用法讲解 HyperLedger FabricCA Config Database and LDAP HyperLedger的fabric项目的全手动部署: 安装合约 超级账本HyperLedger的fabricCA的用法讲解 &nbsp; 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/05/09/69075eb90b3aa295a42842a46ca56cef.html","headline":"超级账本HyperLedger的Fabric-CA的使用（两个组织一个Orderer三个Peer)，带视频演示","dateModified":"2018-05-09T00:00:00+08:00","datePublished":"2018-05-09T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/05/09/69075eb90b3aa295a42842a46ca56cef.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>超级账本HyperLedger的Fabric-CA的使用（两个组织一个Orderer三个Peer)，带视频演示</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>原文地址：&nbsp;<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html" rel="nofollow">超级账本HyperLedger的Fabric-CA的使用演示(两个组织一个Orderer三个Peer)</a></p> 
  <ul>
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E8%AF%B4%E6%98%8E" rel="nofollow">说明</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E5%90%AF%E5%8A%A8fabric-ca" rel="nofollow">启动fabric-ca</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E7%94%9F%E6%88%90fabric-ca-admin%E7%9A%84%E5%87%AD%E8%AF%81" rel="nofollow">生成fabric-ca admin的凭证</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E5%88%9B%E5%BB%BA%E8%81%94%E7%9B%9F" rel="nofollow">创建联盟</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E4%B8%BA%E6%AF%8F%E4%B8%AA%E7%BB%84%E7%BB%87%E5%87%86%E5%A4%87msp" rel="nofollow">为每个组织准备msp</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E6%B3%A8%E5%86%8Cexamplecom%E7%9A%84%E7%AE%A1%E7%90%86%E5%91%98adminexamplecom" rel="nofollow">注册example.com的管理员Admin@example.com</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E6%B3%A8%E5%86%8Corg1examplecom%E7%9A%84%E7%AE%A1%E7%90%86%E5%91%98adminorg1examplecom" rel="nofollow">注册org1.example.com的管理员Admin@org1.example.com</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E6%B3%A8%E5%86%8Corg2examplecom%E7%9A%84%E7%AE%A1%E7%90%86%E5%91%98adminorg2examplecom" rel="nofollow">注册org2.example.com的管理员Admin@org2.example.com</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E5%90%84%E4%B8%AA%E7%BB%84%E7%BB%87%E5%88%86%E5%88%AB%E4%BD%BF%E7%94%A8%E8%87%AA%E5%B7%B1%E7%9A%84admin%E8%B4%A6%E6%88%B7%E5%88%9B%E5%BB%BA%E5%85%B6%E5%AE%83%E8%B4%A6%E5%8F%B7" rel="nofollow">各个组织分别使用自己的Admin账户创建其它账号</a> 
    <ul>
     <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#ordererexamplecom" rel="nofollow">orderer.example.com</a></li> 
     <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#peer0org1examplecom" rel="nofollow">peer0.org1.example.com</a></li> 
     <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#peer1org1examplecom" rel="nofollow">peer1.org1.example.com</a></li> 
     <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#peer0org2examplecom" rel="nofollow">peer0.org2.example.com</a></li> 
    </ul></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E9%87%8D%E6%96%B0%E9%83%A8%E7%BD%B2" rel="nofollow">重新部署</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7%E7%9A%84%E8%AF%81%E4%B9%A6%E4%BB%A5%E5%8F%8A%E5%90%8E%E7%BB%AD%E6%93%8D%E4%BD%9C" rel="nofollow">更新用户的证书以及后续操作</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/05/04/fabric-ca-example.html#%E5%8F%82%E8%80%83" rel="nofollow">参考</a></li> 
  </ul>
  <h2>说明</h2> 
  <p style="text-indent:0px;">本文是对<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html" rel="nofollow">hyperledger的fabric项目的全手动部署</a>的补充，这里将演示如何使用fabric-ca为每个组件和用户生成证书。</p> 
  <p style="text-indent:0px;">如果对下面的操作有不清楚的地方，可以参阅<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html" rel="nofollow">超级账本HyperLedger的fabricCA的用法讲解</a>。演示视频已经制作完成：</p> 
  <p style="text-indent:0px;"><a href="https://study.163.com/provider/400000000376006/index.htm" rel="nofollow">IT技术快速入门学院：HyperLedger FabricCA使用演示的视频教程</a></p> 
  <p style="text-indent:0px;">可以使用下面的部署方式：</p> 
  <p style="text-indent:0px;"><img alt="fabric-deploy-example" class="has" src="http://www.lijiaocn.com/img/hyperledger-class/fabric-ca-deploy-example-1.png"></p> 
  <p style="text-indent:0px;">这里做了简化，只部署了一个Fabric-CA作为rootCA。</p> 
  <p style="text-indent:0px;"><img alt="fabric-deploy-example" class="has" src="http://www.lijiaocn.com/img/hyperledger-class/fabric-ca-deploy-example-2.png"></p> 
  <p style="text-indent:0px;">将创建一个由两个组织<code>org1.example.com</code>和<code>org2.example.com</code>组成的的联盟。</p> 
  <p style="text-indent:0px;">另外还有一个组织<code>example.com</code>用来部署orderer。</p> 
  <p style="text-indent:0px;">example.com部署了一个<code>solo</code>模式的orderer。（多个orderer的部署方式，以后探讨）</p> 
  <pre class="highlight">
<code>orderer.example.com
</code></pre> 
  <p style="text-indent:0px;">org1.example.com部署了两个peer:</p> 
  <pre class="highlight">
<code>peer0.org1.example.com
peer1.org1.example.com
</code></pre> 
  <p style="text-indent:0px;">org2.example.com部署了一个peer:</p> 
  <pre class="highlight">
<code>peer0.org2.example.com
</code></pre> 
  <p style="text-indent:0px;">每个组织都要有一个Admin用户，每个组件(peer/orderer)也需要一个账号，因此需要通过fabric-ca创建7个用户：</p> 
  <pre class="highlight">
<code>example.com:       Admin@example.com       orderer.example.com
org1.example.com:  Admin@org1.example.com  peer0.org1.example.com  peer1.org1.example.com  
org2.example.com:  Admin@org2.example.com  peer0.org2.example.com
</code></pre> 
  <p style="text-indent:0px;">这里只创建了Admin用户，普通用户的创建方式相同，只是普通用户的证书不需要添加到目标组件的admincerts目录中。</p> 
  <h2>启动fabric-ca</h2> 
  <p style="text-indent:0px;">fabirc-ca的编译：</p> 
  <pre class="highlight">
<code>$ go get -u github.com/hyperledger/fabric-ca
$ cd $GOPATH/src/github.com/hyperledger/fabric-ca
$ make fabric-ca-server
$ make fabric-ca-client
$ ls bin/
fabric-ca-client  fabric-ca-server
</code></pre> 
  <p style="text-indent:0px;">这里将fabric-ca部署在<code>/opt/app/fabric-ca/server</code>目录中：</p> 
  <pre class="highlight">
<code>mkdir -p /opt/app/fabric-ca/server
cp -rf $GOPATH/src/github.com/hyperledger/fabric-ca/bin/*  /opt/app/fabric-ca/server
ln -s /opt/app/fabric-ca/server/fabric-ca-client  /usr/bin/fabric-ca-client
</code></pre> 
  <p style="text-indent:0px;">直接启动ca，fabric-ca admin的名称为admin，密码为pass。(这里只是演示，生产中使用，你需要根据实际的情况配置)</p> 
  <pre class="highlight">
<code>cd /opt/app/fabric-ca/server
./fabric-ca-server start -b  admin:pass &amp;
</code></pre> 
  <p style="text-indent:0px;">如果有<code>删除联盟</code>和<code>删除用户</code>的需求，需要用下面的方式启动：</p> 
  <pre class="highlight">
<code>cd /opt/app/fabric-ca/server
./fabric-ca-server start -b admin:pass --cfg.affiliations.allowremove  --cfg.identities.allowremove &amp;
</code></pre> 
  <p style="text-indent:0px;">注意：这里只是演示用法，直接用sqlite存储用户信息，生产中，请根据情况配置ldap或者mysql等数据库：<a href="https://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html#configuring-the-database" rel="nofollow">HyperLedger FabricCA Config Database and LDAP</a>。</p> 
  <h2>生成fabric-ca admin的凭证</h2> 
  <p style="text-indent:0px;">下面的操作在《<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html" rel="nofollow">hyperledger的fabric项目的全手动部署</a>》中创建的<code>fabric-deploy</code>目录中进行后续操作。</p> 
  <pre class="highlight">
<code>cd ~/fabric-deploy
mkdir fabric-ca-files 
</code></pre> 
  <p style="text-indent:0px;">生成fabric-ca admin的凭证，用<code>-H</code>参数指定client目录：</p> 
  <pre class="highlight">
<code>mkdir -p `pwd`/fabric-ca-files/admin
fabric-ca-client enroll -u http://admin:pass@localhost:7054 -H `pwd`/fabric-ca-files/admin
</code></pre> 
  <p style="text-indent:0px;">也可以用环境变量<code>FABRIC_CA_CLIENT_HOME</code>指定了client的工作目录，生成的用户凭证将存放在这个目录中。</p> 
  <pre class="highlight">
<code>export FABRIC_CA_CLIENT_HOME=`pwd`/fabric-ca-files/admin
mkdir -p $FABRIC_CA_CLIENT_HOME
fabric-ca-client enroll -u http://admin:pass@localhost:7054
</code></pre> 
  <p style="text-indent:0px;">为了防止混乱，后面的演示操作中，都直接用<code>-H</code>指定目录。</p> 
  <h2>创建联盟</h2> 
  <p style="text-indent:0px;">上面的启动方式默认会创建两个组织：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation list
2018/05/07 02:36:46 [INFO] [::1]:56148 GET /affiliations 200 0 "OK"
affiliation: .
   affiliation: org2
      affiliation: org2.department1
   affiliation: org1
      affiliation: org1.department1
      affiliation: org1.department2
</code></pre> 
  <p style="text-indent:0px;">为了查看信息的时候，看到的输出比较简洁，用下面的命令将其删除：</p> 
  <pre class="highlight">
<code>fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation remove --force  org1
fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation remove --force  org2
</code></pre> 
  <p style="text-indent:0px;">执行下面命令创建联盟：</p> 
  <pre class="highlight">
<code>fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com 
fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example
fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example.org1
fabric-ca-client  -H `pwd`/fabric-ca-files/admin  affiliation add com.example.org2
</code></pre> 
  <p style="text-indent:0px;">创建联盟如下：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client -H `pwd`/fabric-ca-files/admin  affiliation list
2018/04/28 15:19:34 [INFO] 127.0.0.1:38160 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org1
      affiliation: com.example.org2
</code></pre> 
  <h2>为每个组织准备msp</h2> 
  <p style="text-indent:0px;">为example.com准备msp，将ca证书等存放example.com组织的目录中:</p> 
  <pre class="highlight">
<code>mkdir -p ./fabric-ca-files/example.com/msp
fabric-ca-client getcacert -M `pwd`/fabric-ca-files/example.com/msp    //-M需要指定绝对路径
</code></pre> 
  <p style="text-indent:0px;">命令执行结束后，会在<code>fabric-ca-files/example.com/msp</code>得到文件：</p> 
  <pre class="highlight">
<code>$ tree fabric-ca-files/example.com/msp/
example.com/msp/
|-- cacerts
|   `-- localhost-7054.pem
|-- intermediatecerts
|   `-- localhost-7054.pem
|-- keystore
`-- signcerts
</code></pre> 
  <p style="text-indent:0px;">注意通过getcacert得到msp目录中只有CA证书。</p> 
  <p style="text-indent:0px;">同样的方式为org1.example.com获取msp:</p> 
  <pre class="highlight">
<code>mkdir -p fabric-ca-files/org1.example.com/msp
fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org1.example.com/msp
</code></pre> 
  <p style="text-indent:0px;">为org2.example.com准备msp:</p> 
  <pre class="highlight">
<code>mkdir -p ./fabric-ca-files/org2.example.com/msp
fabric-ca-client getcacert -M `pwd`/fabric-ca-files/org2.example.com/msp
</code></pre> 
  <p style="text-indent:0px;">这里是用<code>getcacert</code>为每个组织准备需要的ca文件，在生成创始块的时候会用到。</p> 
  <p style="text-indent:0px;">在1.1.0版本的fabric-ca中，只会组件或用户在操作区块链的时候用到的证书和密钥，不会生成用来加密grpc通信的证书。</p> 
  <p style="text-indent:0px;">这里继续沿用之前的fabric-deploy中的tls证书，在最后的重新部署操作，只会替换msp目录。</p> 
  <p style="text-indent:0px;">但是需要将验证tls证书的ca添加到msp目录中，如下：</p> 
  <pre class="highlight">
<code>cp -rf certs/ordererOrganizations/example.com/msp/tlscacerts  fabric-ca-files/example.com/msp/
cp -rf certs/peerOrganizations/org1.example.com/msp/tlscacerts/ fabric-ca-files/org1.example.com/msp/
cp -rf certs/peerOrganizations/org2.example.com/msp/tlscacerts/ fabric-ca-files/org2.example.com/msp/
</code></pre> 
  <p style="text-indent:0px;">如果在你的环境中，各个组件域名的证书，是由第三方CA签署的，就将第三方CA的根证书添加到tlscacerts目录中。</p> 
  <h2>注册example.com的管理员Admin@example.com</h2> 
  <p style="text-indent:0px;">可以直接用命令行（命令比较长，这里用<code>\\</code>截断了）：</p> 
  <pre class="highlight">
<code>fabric-ca-client register --id.name Admin@example.com --id.type client --id.affiliation "com.example.org1"  \
    --id.attrs '"hf.Registrar.Roles=client,orderer,peer,user","hf.Registrar.DelegateRoles=client,orderer,peer,user",\
                 hf.Registrar.Attributes=*,hf.GenCRL=true,hf.Revoker=true,hf.AffiliationMgr=true,hf.IntermediateCA=true,role=admin:ecert'
</code></pre> 
  <p style="text-indent:0px;">也可以将命令行参数写在fabric-ca admin的配置文件<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>中。</p> 
  <pre class="highlight">
<code>$ ls fabric-ca-files/admin/admin/
fabric-ca-client-config.yaml  msp
</code></pre> 
  <p style="text-indent:0px;">为了演示清楚，这里使用修改配置文件的方式，将<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code>id</code>部分修改为：</p> 
  <pre class="highlight">
<code>id:
  name: Admin@example.com
  type: client
  affiliation: com.example
  maxenrollments: 0
  attributes:
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    - name: role
      value: admin
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注意最后一行role属性，是我们自定义的属性，在配置文件中是单独设置ecert属性为true或者false，如果在命令行中，添加后缀<code>:ecert</code>表示true，例如:</p> 
  <pre class="highlight">
<code>fabric-ca-client register --id.affiliation "com.example.org1" --id.attrs "role=admin:ecert"
</code></pre> 
  <p style="text-indent:0px;">直接执行下面的命令，即可完成用户<code>Admin@example.com</code>注册，注意这时候的注册使用fabricCA的admin账号完成的：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password
</code></pre> 
  <p style="text-indent:0px;">如果不用<code>--id.secret</code>指定密码，会自动生成密码。</p> 
  <p style="text-indent:0px;">其它配置的含义是用户名为<code>Admin@example.com</code>，类型是<code>client</code>，它能够管理<code>com.example.*</code>下的用户，如下:</p> 
  <pre class="highlight">
<code>--id.name  Admin@example.com                           //用户名
--id.type client                                       //类型为client
--id.affiliation "com.example"                         //权利访问
hf.Registrar.Roles=client,orderer,peer,user            //能够管理的用户类型
hf.Registrar.DelegateRoles=client,orderer,peer,user    //可以授权给子用户管理的用户类型
hf.Registrar.Attributes=*                              //可以为子用户设置所有属性
hf.GenCRL=true                                         //可以生成撤销证书列表
hf.Revoker=true                                        //可以撤销用户
hf.AffiliationMgr=true                                 //能够管理联盟
hf.IntermediateCA=true                                 //可以作为中间CA
role=admin:ecert                                       //自定义属性
</code></pre> 
  <p style="text-indent:0px;">生成Admin@example.com凭证：</p> 
  <pre class="highlight">
<code>$ mkdir -p ./fabric-ca-files/example.com/admin
$ fabric-ca-client enroll -u http://Admin@example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/example.com/admin
$ ls ./fabric-ca-files/example.com/admin
fabric-ca-client-config.yaml  msp/
</code></pre> 
  <p style="text-indent:0px;">这时候可以用Admin@example.com的身份查看联盟：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/example.com/admin
2018/04/28 15:35:10 [INFO] 127.0.0.1:38172 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org1
      affiliation: com.example.org2
</code></pre> 
  <p style="text-indent:0px;">最后需要将Admin@example.com的证书复制到example.com/msp/admincerts/</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/example.com/msp/admincerts/
cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/example.com/msp/admincerts/
</code></pre> 
  <p style="text-indent:0px;"><strong>只有这样，才能具备管理员权限</strong>。</p> 
  <h2>注册org1.example.com的管理员Admin@org1.example.com</h2> 
  <p style="text-indent:0px;">为org1.example.com的管理员Admin@org1.example.com准备一个目录:</p> 
  <pre class="highlight">
<code>cd ~/fabric-deploy
mkdir -p ./fabric-ca-files/org1.example.com/admin
</code></pre> 
  <p style="text-indent:0px;">将<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code>id</code>部分修改为：</p> 
  <pre class="highlight">
<code>id:
  name: Admin@org1.example.com
  type: client
  affiliation: com.example.org1
  maxenrollments: 0
  attributes:
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    - name: role
      value: admin
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注册：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password
</code></pre> 
  <p style="text-indent:0px;">生成凭证：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client enroll -u http://Admin@org1.example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/org1.example.com/admin
$ ls ./fabric-ca-files/org1.example.com/admin
fabric-ca-client-config.yaml  msp/
</code></pre> 
  <p style="text-indent:0px;">查看联盟：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org1.example.com/admin
2018/05/04 15:42:53 [INFO] 127.0.0.1:51298 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org1
</code></pre> 
  <p style="text-indent:0px;">注意与<code>Admin@example.com</code>的区别，这里只能看到组织com.example.org1</p> 
  <p style="text-indent:0px;">将Admin@org1.example.com的证书复制到org1.example.com的msp/admincerts中：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org1.example.com/msp/admincerts/
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org1.example.com/msp/admincerts/
</code></pre> 
  <p style="text-indent:0px;">在Admin@org1.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org1.example.com/admin/msp/admincerts/
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org1.example.com/admin/msp/admincerts/
</code></pre> 
  <p style="text-indent:0px;">另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</p> 
  <pre class="highlight">
<code>rm fabric-ca-files/org1.example.com/admin/msp/intermediatecerts/*
</code></pre> 
  <h2>注册org2.example.com的管理员Admin@org2.example.com</h2> 
  <p style="text-indent:0px;">为org2.example.com的管理员Admin@org2.example.com准备一个目录:</p> 
  <pre class="highlight">
<code>cd ~/fabric-deploy
mkdir -p ./fabric-ca-files/org2.example.com/admin
</code></pre> 
  <p style="text-indent:0px;">将<code>fabric-ca-files/admin/fabric-ca-client-config.yaml</code>其中的<code>id</code>部分修改为：</p> 
  <pre class="highlight">
<code>id:
  name: Admin@org2.example.com
  type: client
  affiliation: com.example.org2
  maxenrollments: 0
  attributes:
    - name: hf.Registrar.Roles
      value: client,orderer,peer,user
    - name: hf.Registrar.DelegateRoles
      value: client,orderer,peer,user
    - name: hf.Registrar.Attributes
      value: "*"
    - name: hf.GenCRL
      value: true
    - name: hf.Revoker
      value: true
    - name: hf.AffiliationMgr
      value: true
    - name: hf.IntermediateCA
      value: true
    - name: role
      value: admin
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注册：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/admin --id.secret=password
</code></pre> 
  <p style="text-indent:0px;">生成凭证：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client enroll -u http://Admin@org2.example.com:password@localhost:7054  -H `pwd`/fabric-ca-files/org2.example.com/admin
$ ls ./fabric-ca-files/org2.example.com/admin
fabric-ca-client-config.yaml  msp/
</code></pre> 
  <p style="text-indent:0px;">查看联盟：</p> 
  <pre class="highlight">
<code>$ fabric-ca-client affiliation list -H `pwd`/fabric-ca-files/org2.example.com/admin
2018/05/02 16:49:00 [INFO] 127.0.0.1:50828 GET /affiliations 201 0 "OK"
affiliation: com
   affiliation: com.example
      affiliation: com.example.org2
</code></pre> 
  <p style="text-indent:0px;">Admin@org2.example.com只能看到组织<code>com.example.org2</code>。</p> 
  <p style="text-indent:0px;">将Admin@org2.example.com的证书复制到org2.example.com的msp/admincerts中：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org2.example.com/msp/admincerts/
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org2.example.com/msp/admincerts/
</code></pre> 
  <p style="text-indent:0px;">在Admin@org2.example.com中也需要创建msp/admincerts目录，通过peer命令操作fabric的时候会要求admincerts存在：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org2.example.com/admin/msp/admincerts/
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem  fabric-ca-files/org2.example.com/admin/msp/admincerts/
</code></pre> 
  <p style="text-indent:0px;">另外，这里没有使用中间CA，将intermediatecerts中的空文件删除，否则peer会提示Warning：</p> 
  <pre class="highlight">
<code>rm fabric-ca-files/org2.example.com/admin/msp/intermediatecerts/*
</code></pre> 
  <h2>各个组织分别使用自己的Admin账户创建其它账号</h2> 
  <p style="text-indent:0px;">example.com、org1.example.com、org2.example.com三个组织这时候可以分别使用自己的Admin账号创建子账号。</p> 
  <h3>orderer.example.com</h3> 
  <p style="text-indent:0px;">使用<code>Admin@example.com</code>注册账号orderer.example.com。注意这时候指定的目录是fabric-ca-files/<code>example.com</code>/admin/。</p> 
  <p style="text-indent:0px;">修改fabric-ca-files/example.com/admin/fabric-ca-client-config.yaml:</p> 
  <pre class="highlight">
<code>id:
  name: orderer.example.com
  type: orderer
  affiliation: com.example
  maxenrollments: 0
  attributes:
    - name: role
      value: orderer
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注册以及生成凭证：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/example.com/admin --id.secret=password
mkdir ./fabric-ca-files/example.com/orderer
fabric-ca-client enroll -u http://orderer.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/example.com/orderer
</code></pre> 
  <p style="text-indent:0px;">将<code>Admin@example.com</code>的证书复制到fabric-ca-files/example.com/orderer/msp/admincerts：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/example.com/orderer/msp/admincerts
cp fabric-ca-files/example.com/admin/msp/signcerts/cert.pem fabric-ca-files/example.com/orderer/msp/admincerts/
</code></pre> 
  <h3>peer0.org1.example.com</h3> 
  <p style="text-indent:0px;">使用<code>Admin@org1.example.com</code>注册账号peer0.org1.example.com。这时候指定的目录是fabric-ca-files/<code>org1.example.com</code>/admin/。</p> 
  <p style="text-indent:0px;">修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml:</p> 
  <pre class="highlight">
<code>id:
  name: peer0.org1.example.com
  type: peer
  affiliation: com.example.org1
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注册以及生成凭证：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org1.example.com/peer0
fabric-ca-client enroll -u http://peer0.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer0
</code></pre> 
  <p style="text-indent:0px;">将<code>Admin@org1.example.com</code>的证书复制到fabric-ca-files/org1.example.com/peer0/msp/admincerts：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org1.example.com/peer0/msp/admincerts
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer0/msp/admincerts/
</code></pre> 
  <h3>peer1.org1.example.com</h3> 
  <p style="text-indent:0px;">使用<code>Admin@org1.example.com</code>注册账号peer1.org1.example.com。这时候指定的目录是fabric-ca-files/<code>org1.example.com</code>/admin/。</p> 
  <p style="text-indent:0px;">修改fabric-ca-files/org1.example.com/admin/fabric-ca-client-config.yaml:</p> 
  <pre class="highlight">
<code>id:
  name: peer1.org1.example.com
  type: peer
  affiliation: com.example.org1
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注册以及生成凭证：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/org1.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org1.example.com/peer1
fabric-ca-client enroll -u http://peer1.org1.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org1.example.com/peer1
</code></pre> 
  <p style="text-indent:0px;">将<code>Admin@org1.example.com</code>的证书复制到fabric-ca-files/org1.example.com/peer1/msp/admincerts：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org1.example.com/peer1/msp/admincerts
cp fabric-ca-files/org1.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org1.example.com/peer1/msp/admincerts/
</code></pre> 
  <h3>peer0.org2.example.com</h3> 
  <p style="text-indent:0px;">使用<code>Admin@org2.example.com</code>注册账号peer0.org2.example.com。这时候指定的目录是fabric-ca-files/<code>org2.example.com</code>/admin/。</p> 
  <p style="text-indent:0px;">修改fabric-ca-files/org2.example.com/admin/fabric-ca-client-config.yaml:</p> 
  <pre class="highlight">
<code>id:
  name: peer0.org2.example.com
  type: peer
  affiliation: com.example.org2
  maxenrollments: 0
  attributes:
    - name: role
      value: peer
      ecert: true
</code></pre> 
  <p style="text-indent:0px;">注册以及生成凭证：</p> 
  <pre class="highlight">
<code>fabric-ca-client register -H `pwd`/fabric-ca-files/org2.example.com/admin --id.secret=password
mkdir ./fabric-ca-files/org2.example.com/peer0
fabric-ca-client enroll -u http://peer0.org2.example.com:password@localhost:7054 -H `pwd`/fabric-ca-files/org2.example.com/peer0
</code></pre> 
  <p style="text-indent:0px;">将<code>Admin@org2.example.com</code>的证书复制到fabric-ca-files/org2.example.com/peer0/msp/admincerts：</p> 
  <pre class="highlight">
<code>mkdir fabric-ca-files/org2.example.com/peer0/msp/admincerts
cp fabric-ca-files/org2.example.com/admin/msp/signcerts/cert.pem fabric-ca-files/org2.example.com/peer0/msp/admincerts/
</code></pre> 
  <h2>重新部署</h2> 
  <p style="text-indent:0px;">然后在<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html" rel="nofollow">hyperledger的fabric项目的全手动部署</a>执行结束后得到的<code>fabric-deploy</code>目录基础上，进行下面的操作。</p> 
  <p style="text-indent:0px;">修改<code>configtx.yaml</code>，将其中的msp路径修改为通过fabric-ca创建的msp目录:</p> 
  <pre class="highlight">
<code>Profiles:
    TwoOrgsOrdererGenesis:
        Orderer:
            &lt;&lt;: *OrdererDefaults
            Organizations:
                - *OrdererOrg
        Consortiums:
            SampleConsortium:
                Organizations:
                    - *Org1
                    - *Org2
    TwoOrgsChannel:
        Consortium: SampleConsortium
        Application:
            &lt;&lt;: *ApplicationDefaults
            Organizations:
                - *Org1
                - *Org2
Organizations:
    - &amp;OrdererOrg
        Name: OrdererOrg
        ID: OrdererMSP
        MSPDir: ./fabric-ca-files/example.com/msp
    - &amp;Org1
        Name: Org1MSP
        ID: Org1MSP
        MSPDir: ./fabric-ca-files/org1.example.com/msp
        AnchorPeers:
            - Host: peer0.org1.example.com
              Port: 7051
    - &amp;Org2
        Name: Org2MSP
        ID: Org2MSP
        MSPDir: ./fabric-ca-files/org2.example.com/msp
        AnchorPeers:
            - Host: peer0.org2.example.com
              Port: 7051
Orderer: &amp;OrdererDefaults
    OrdererType: solo
    Addresses:
        - orderer.example.com:7050
    BatchTimeout: 2s
    BatchSize:
        MaxMessageCount: 10
        AbsoluteMaxBytes: 99 MB
        PreferredMaxBytes: 512 KB
    Kafka:
        Brokers:
            - 127.0.0.1:9092
    Organizations:
Application: &amp;ApplicationDefaults
    Organizations:
</code></pre> 
  <p style="text-indent:0px;">注意<code>configtx.yaml</code>中使用的每个组织的msp，不是组件的或者用户的。这个文件备用。</p> 
  <p style="text-indent:0px;">更新orderer.example.com/中的msp：</p> 
  <pre class="highlight">
<code>rm -rf orderer.example.com/msp/ 
cp -rf fabric-ca-files/example.com/orderer/msp orderer.example.com/
</code></pre> 
  <p style="text-indent:0px;">更新peer0.org1.example.com的msp:</p> 
  <pre class="highlight">
<code>rm -rf peer0.org1.example.com/msp/
cp -rf fabric-ca-files/org1.example.com/peer0/msp  peer0.org1.example.com/
</code></pre> 
  <p style="text-indent:0px;">更新peer1.org1.example.com的msp:</p> 
  <pre class="highlight">
<code>rm -rf peer1.org1.example.com/msp/
cp -rf fabric-ca-files/org1.example.com/peer1/msp  peer1.org1.example.com/
</code></pre> 
  <p style="text-indent:0px;">更新peer0.org2.example.com的msp:</p> 
  <pre class="highlight">
<code>rm -rf peer0.org2.example.com/msp/
cp -rf fabric-ca-files/org2.example.com/peer0/msp   peer0.org2.example.com/
</code></pre> 
  <p style="text-indent:0px;">然后重新部署下面的组件，参考<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html#%E5%BC%80%E5%A7%8B%E9%83%A8%E7%BD%B2" rel="nofollow">hyperledger的fabric项目的全手动部署: 开始部署</a>。</p> 
  <pre class="highlight">
<code>scp -r orderer.example.com/*     root@192.168.88.10:/opt/app/fabric/orderer/
scp -r peer0.org1.example.com/*  root@192.168.88.10:/opt/app/fabric/peer/
scp -r peer1.org1.example.com/*  root@192.168.88.11:/opt/app/fabric/peer/
scp -r peer0.org2.example.com/*  root@192.168.88.12:/opt/app/fabric/peer/
</code></pre> 
  <p style="text-indent:0px;">重新部署的时候，注意将之前已经启动的服务停止，并删除安装文件。</p> 
  <p style="text-indent:0px;">重新部署完成后，重新生成./genesisblock文件，并上传到orderer.example.com的安装路径中:</p> 
  <pre class="highlight">
<code>./bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./genesisblock
</code></pre> 
  <p style="text-indent:0px;">这里没有使用中间CA，生成genesisblock的时候，会提示:</p> 
  <pre class="highlight">
<code>2018-05-04 16:37:17.788 CST [msp] getPemMaterialFromDir -&gt; WARN 002 Failed reading file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem: no pem content for file /root/fabric-deploy/fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem
</code></pre> 
  <p style="text-indent:0px;">将intermediatecerts中的文件删除即可，</p> 
  <pre class="highlight">
<code>rm fabric-ca-files/example.com/msp/intermediatecerts/localhost-7054.pem
rm fabric-ca-files/org1.example.com/msp/intermediatecerts/localhost-7054.pem
rm fabric-ca-files/org2.example.com/msp/intermediatecerts/localhost-7054.pem
</code></pre> 
  <p style="text-indent:0px;">如果是通过intermediateCA生成的证书，intermediatecerts中包含中间CA的证书。这里只部署了一个fabric-ca作为rootCA，因此intermediatecerts中是一个空文件。</p> 
  <p style="text-indent:0px;">将生成的genesisblock上传到orderer.example.com：</p> 
  <pre class="highlight">
<code>scp genesisblock root@192.168.88.10:/opt/app/fabric/orderer/
</code></pre> 
  <p style="text-indent:0px;">可以用下面的命令查看创始块的内容:</p> 
  <pre class="highlight">
<code>./bin/configtxgen  -inspectBlock genesisblock
</code></pre> 
  <p style="text-indent:0px;">然后重新启动fabric的所有组件。</p> 
  <h2>更新用户的证书以及后续操作</h2> 
  <p style="text-indent:0px;">因为我们是在<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html" rel="nofollow">hyperledger的fabric项目的全手动部署</a><code>执行结束后得到的fabric-deploy目录</code>基础上，进行操作的。</p> 
  <p style="text-indent:0px;">所有还要更新一下该目录下用户目录中的msp：</p> 
  <pre class="highlight">
<code>$ rm -rf Admin\@org1.example.com/msp
$ cp -rf fabric-ca-files/org1.example.com/admin/msp Admin\@org1.example.com/
$ cd Admin\@org1.example.com
$ ./peer.sh node status
status:STARTED
2018-05-04 17:03:06.202 CST [main] main -&gt; INFO 001 Exiting.....

$ cd ../
$ rm -rf Admin\@org2.example.com/msp
$ cp -rf fabric-ca-files/org2.example.com/admin/msp Admin\@org2.example.com/
$ cd Admin\@org2.example.com
$ ./peer.sh node status
status:STARTED
2018-05-04 17:08:27.959 CST [main] main -&gt; INFO 001 Exiting.....
</code></pre> 
  <p style="text-indent:0px;">重新创建channel，设置anchor peer：</p> 
  <pre class="highlight">
<code>./bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx mychannel.tx -channelID mychannel
./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP
./bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP

cd Admin\@org1.example.com/
./peer.sh channel create -o orderer.example.com:7050 -c mychannel -f ../mychannel.tx --tls true --cafile tlsca.example.com-cert.pem
cp mychannel.block ../Admin\@org2.example.com/
./peer.sh channel join -b mychannel.block
./peer.sh channel join -b mychannel.block   //将peer.sh中的peer0修改为peer1后在执行一次
./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org1MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem

cd ../Admin\@org2.example.com/
./peer.sh channel join -b mychannel.block
./peer.sh channel update -o orderer.example.com:7050 -c mychannel -f ../Org2MSPanchors.tx --tls true --cafile ./tlsca.example.com-cert.pem
</code></pre> 
  <p style="text-indent:0px;">这些操作的含义见：&nbsp;<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html#%E5%88%9B%E5%BB%BAchannel%E4%B8%8Epeer%E7%9A%84%E8%AE%BE%E7%BD%AE" rel="nofollow">hyperledger的fabric项目的全手动部署-创建channel与peer的设置</a></p> 
  <p style="text-indent:0px;">后续的合约创建、更新、调用等操作这里就不演示了，请直接查看:&nbsp;<a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html#%E5%AE%89%E8%A3%85%E5%90%88%E7%BA%A6chaincode" rel="nofollow">hyperledger的fabric项目的全手动部署：安装合约</a>:</p> 
  <pre class="highlight">
<code>go get github.com/lijiaocn/fabric-chaincode-example/demo
./peer.sh chaincode package demo-pack.out -n demo -v 0.0.1 -s -S -p github.com/lijiaocn/fabric-chaincode-example/demo
./peer.sh chaincode signpackage demo-pack.out signed-demo-pack.out
./peer.sh chaincode install ./signed-demo-pack.out
./peer.sh chaincode instantiate -o orderer.example.com:7050 --tls true --cafile ./tlsca.example.com-cert.pem -C mychannel -n demo -v 0.0.1 -c '{"Args":["init"]}' -P "OR('Org1MSP.member','Org2MSP.member')"
./peer.sh chaincode query -C mychannel -n demox -c '{"Args":["attr","role"]}'
./peer.sh chaincode query -C mychannel -n demox -c '{"Args":["attr","hf.Type"]}'
</code></pre> 
  <p style="text-indent:0px;">有问题的话，可以到下面的知识星球中交流，我会在里面分享一些资料：</p> 
  <p style="text-indent:0px;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180716093813964?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xpamlhb2Nu/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="text-indent:0px;"><img alt="区块链实践分享" class="has" src="http://www.lijiaocn.com/img/xiaomiquan-blockchain.jpg"></p> 
  <h2>参考</h2> 
  <ol>
   <li><a href="https://hyperledger-fabric-ca.readthedocs.io/en/latest/" rel="nofollow">Welcome to Hyperledger Fabric CA</a></li> 
   <li><a href="https://github.com/hyperledger/fabric-ca" rel="nofollow">fabric-ca codes</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html" rel="nofollow">HyperLedger的fabric项目的全手动部署</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html#%E5%BC%80%E5%A7%8B%E9%83%A8%E7%BD%B2" rel="nofollow">HyperLedger的fabric项目的全手动部署: 开始部署</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html#%E5%88%9B%E5%BB%BAchannel%E4%B8%8Epeer%E7%9A%84%E8%AE%BE%E7%BD%AE" rel="nofollow">HyperLedger的fabric项目的全手动部署-创建channel与peer的设置</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html" rel="nofollow">超级账本HyperLedger的fabricCA的用法讲解</a></li> 
   <li><a href="https://hyperledger-fabric-ca.readthedocs.io/en/latest/users-guide.html#configuring-the-database" rel="nofollow">HyperLedger FabricCA Config Database and LDAP</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/26/hyperledger-fabric-deploy.html#%E5%AE%89%E8%A3%85%E5%90%88%E7%BA%A6chaincode" rel="nofollow">HyperLedger的fabric项目的全手动部署: 安装合约</a></li> 
   <li><a href="http://www.lijiaocn.com/%E9%A1%B9%E7%9B%AE/2018/04/27/hyperledger-fabric-ca-usage.html" rel="nofollow">超级账本HyperLedger的fabricCA的用法讲解</a></li> 
  </ol>
  <p>&nbsp;</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lijiaocn/article/details/80261529,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lijiaocn/article/details/80261529,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
