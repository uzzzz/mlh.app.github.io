<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>以太坊分析之 智能合约和DAPP | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="以太坊分析之 智能合约和DAPP" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="以太坊介绍 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊（Ethereum）是一个建立在区块链技术之上，去中心化应用平台。它允许任何人在平台中建立和使用通过区块链技术运行的去中心化应用。 &nbsp; 智能合约 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊是一个运行着智能合约的分布式平台，智能合约本质就是脚本，这些脚本可以处理各种业务逻辑来利用以太坊区块链的能力，比如彩票、拍卖、物流跟踪等等。这也正是以太坊区别于比特币的最重要的属性，定位来说以太坊旨在成为一个平台，而比特币则是一个货币体系。智能合约赋能给以太坊无限想象力和更强大的生命力。 &nbsp; 一个简单的例子，就是A转账给B，在比特币和以太坊中大概都怎么实现的： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊智能合约实现的方式貌似能看懂，比较易读。事实也是这样的，智能合约使得区块链的扩展性更强，且实现上更简洁，从而让以太坊发展成为目前最大的一个区块链开发平台。 随着智能合约的发展，智能合约构建的组织如同现实商业社会一样的运行，这样形成的去中心化组织网络会变得极其复杂和自治，会出现各种形态：DAPP（去中心化应用）DAO（去中心化自治组织）DAC（去中心化自治公司）DAS（去中心化自治社会）. &nbsp; DAPP &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DAPP是去中心化的APP，DAPP和普通的App原理一样，除了他们是完全去中心化的，在以太坊网络本身自己的节点来运作的DAPP，不依赖于任何中心化的服务器，DAPP是去中心化的，可以完全自动地运行。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊中一般会认为智能合约就是DAPP，当然更准确的可以认为智能合约相当于服务器后台，另外要实现用户体验，还需要UI交互界面，通过RPC与后台对接，那么DAPP就是包含完整的智能合约+用户UI交互界面。 &nbsp; 智能合约开发 搭建开发环境 智能合约的开发环境需要： ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Truffle：是以太坊的开发环境、测试框架和资产通道。换句话说，它可以帮助你开发、发布和测试智能合约等等。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ganache：以前叫作 TestRPC，如果你读过几个月前的教程的话，有可能他们在使用TestRPC 的情境下配合使用了 Truffle，它在 TestRPC 和Truffle 的集成后被重新命名为 Ganache。Ganache 的工作很简单：创建一个虚拟的以太坊区块链，并生成一些我们将在开发过程中用到的虚拟账号。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mist：Mist 是一个分布式网络 apps 的浏览器，相当于是只针对 Dapps 的 Chrome 或Firefox。目前来说，它仍然是不安全的，所以你还不能在不受信任的 Dapp 中使用它。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以太坊钱包：它是 Mist 的一个版本，但只启动一个 Dapp ——以太坊钱包。Mist 和以太坊钱包只是 UI（用户界面）前端，我们还需要一个将我们连接到以太坊区块链的核心程序（它可以是一个真正的以太坊区块链，也可以是一个测试版的）。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Geth：Geth 是把你连接到区块链的核心应用程序，它也可以启动一个新的区块链（在我们这个示例中，我们将创建一个本地测试网区块链），创建合约，挖掘以太币等。 &nbsp; Truffle和Ganache都是基于NodeJS，所以首先得安装Node和NPM。本文是CentOS7环境， Node版本如下： $ node -v v7.0.0 $ npm -v 3.10.8 &nbsp; 安装Truffle： $ npm&nbsp;install&nbsp;-g&nbsp;truffle &nbsp; 安装成功查询： $ truffle version Truffle v4.1.11 (core: 4.1.11) Solidity v0.4.24 (solc-js) &nbsp; 安装Ganache命令行工具： $ npm&nbsp;install&nbsp;-g&nbsp;ganache-cli 创建Truffle工程 使用Truffle来创建一个工程： $ mkdir my-dapp $ cd my-dapp/ $ truffle init Downloading... Unpacking... Setting up... Unbox successful. Sweet! &nbsp; Commands: &nbsp; &nbsp; Compile:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle compile &nbsp; Migrate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle migrate &nbsp; Test contracts: truffle test &nbsp; Truffle会初始化一个项目，项目的文件结构如下： . ├── contracts │&nbsp;&nbsp; └── Migrations.sol ├── migrations │&nbsp;&nbsp; └── 1_initial_migration.js ├── test ├── truffle-config.js └── truffle.js &nbsp; &nbsp; 第一步在工程contracts&nbsp;目录下创建一个Solidity&nbsp;脚本： Wrestling.sol pragma solidity ^0.4.18;&nbsp;/*** Example script for the Ethereum development walkthrough*/contract Wrestling {&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * Our wrestlers&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; address public wrestler1;&nbsp;&nbsp;&nbsp; address public wrestler2;&nbsp;&nbsp;&nbsp;&nbsp; bool public wrestler1Played;&nbsp;&nbsp;&nbsp; bool public wrestler2Played;&nbsp;&nbsp;&nbsp;&nbsp; uint private wrestler1Deposit;&nbsp;&nbsp;&nbsp; uint private wrestler2Deposit;&nbsp;&nbsp;&nbsp;&nbsp; bool public gameFinished;&nbsp;&nbsp;&nbsp; address public theWinner;&nbsp;&nbsp;&nbsp; uint gains;&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The logs that will be emitted in every step of the contract&#39;s life cycle&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; event WrestlingStartsEvent(address wrestler1, address wrestler2);&nbsp;&nbsp;&nbsp; event EndOfRoundEvent(uint wrestler1Deposit, uint wrestler2Deposit);&nbsp;&nbsp;&nbsp; event EndOfWrestlingEvent(address winner, uint gains);&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The contract constructor&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; constructor() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1 = msg.sender;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * A second wrestler can register as an opponent&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function registerAsAnOpponent() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2 == address(0));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2 = msg.sender;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit WrestlingStartsEvent(wrestler1, wrestler2);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * Every round a player can put a sum of ether, if one of the player put in twice or&nbsp;&nbsp;&nbsp; * more the money (in total) than the other did, the first wins&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function wrestle() public payable {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(!gameFinished &amp;&amp; (msg.sender == wrestler1 || msg.sender == wrestler2));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(msg.sender == wrestler1) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler1Played == false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrestler1Deposit = wrestler1Deposit + msg.value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2Played == false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Deposit = wrestler2Deposit + msg.value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Played &amp;&amp; wrestler2Played) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Deposit &gt;= wrestler2Deposit * 2) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (wrestler2Deposit &gt;= wrestler1Deposit * 2) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler2);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;endOfRound();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; function endOfRound() internal {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfRoundEvent(wrestler1Deposit, wrestler2Deposit);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; function endOfGame(address winner) internal {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gameFinished = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; theWinner = winner;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = wrestler1Deposit + wrestler2Deposit;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfWrestlingEvent(winner, gains);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The withdraw function, following the withdraw pattern shown and explained here:&nbsp;&nbsp;&nbsp; * http://solidity.readthedocs.io/en/develop/common-patterns.html#withdrawal-from-contracts&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function withdraw() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(gameFinished &amp;&amp; theWinner == msg.sender);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;uint amount = gains;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg.sender.transfer(amount);&nbsp;&nbsp;&nbsp; }} Wrestling实现的是一个角力的游戏，在这个游戏中，每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍(总计)，那他就赢了。 关于代码的解读参考http://www.cocoachina.com/blockchain/20180312/22550.html &nbsp; &nbsp; 第二步在工程目录migrations创建一个部署脚本： 2_deploy_contracts.js const&nbsp;Wrestling&nbsp;=&nbsp;artifacts.require(&quot;./Wrestling.sol&quot;) &nbsp; module.exports&nbsp;=&nbsp;function(deployer)&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;deployer.deploy(Wrestling); }; 这个部署脚本的作用是导入Wrestling.sol然后部署到区块链中。 &nbsp; 启动Ganache Truffle工程创建完成后，现在通过Ganache创建一个虚拟的以太坊区块链。 新开一个窗口执行: $ ganache-cli&nbsp;-p&nbsp;7545 Ganache CLI v6.1.0 (ganache-core: 2.1.0) &nbsp; Available Accounts ================== (0) 0x67f0c56f2ed6b635e7a4d4285615ae01b4b6d834 (1) 0xdde20e330d5747253aa2041532b486fb425951a8 (2) 0xecc3a4c50bce3014d11a3840d0d1dd3011cf65e8 (3) 0x3db9dcb607a15b744affb1453ce1d36121f56a9a (4) 0x0f1c36775edba34f9239f6fbe3e1d071a35a80bf (5) 0x14156195c281babf28200aec756ce16e8794e724 (6) 0xdb89069d044cb1f8246fad2a805b97102b05c6a5 (7) 0xa3dfb369603aa5788626371ab022e42f98001607 (8) 0x455bffe5cce17a3a71bfb1ef1fb74c3640f77b97 (9) 0x82512876028923943d5e937441710d6675d573b0 &nbsp; Private Keys ================== (0) 5d5d0d038bbd85c1ca25768a0da88b49805dd74bbffa628cd4b0968877eb84af (1) ba616ed800cf1e0306ec1eaea7416d52bab5ad0dd7216a997194784461da7efe (2) 0f80b88a4ad72850003a8aca809932e3e27f29e2a931d900ac0cb06fc22247bd (3) c0cb6aecff075d9527eebb69c5389f6cfaea2a3e7120a2fb6fb4122e299dfdad (4) 7ea0bd30edcbe05b89553a1c7e4eb52c4ebf87f1a664202ccad7eb26e589403c (5) 5ff14162882f900a4c2241042b1e51c866adeb089c28e6643787ef26b43293c8 (6) 24da6f19bfaa3de81ab1fd9b62636064282604e4fa26d6697eacfc3c9d3d9de8 (7) 944c9ede3956b7dc55b2ece7f9506358b1d7c5e5f7275c6b11dacd5e38414c0f (8) 43e8c352eaafd39e7116b43aed86006141daa18c1cf7c06806c6c19cbb7be29a (9) bf43907fd082a64b987c00ceb9b7ae45eee08fcf96ae07d6b0260d4ec370f736 &nbsp; HD Wallet ================== Mnemonic:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; video march rail weapon lunch holiday organ vague food strategy gown artist Base HD Path:&nbsp; m/44&#39;/60&#39;/0&#39;/0/{account_index} &nbsp; Listening on localhost:7545 &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ganache启动成功后，会生成10个测试账号，默认情况下，每个账户都有未锁定的100个以太币并，所以我们可以自由地从那里发送以太币。最后Ganache服务监听在localhost:7545。 &nbsp; 编译和部署 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ganache启动后，回到Truffle工程目录下修改配置文件truffle.js和truffle-config.js： module.exports&nbsp;=&nbsp;{ &nbsp;&nbsp;//&nbsp;See&nbsp;&nbsp;&nbsp;//&nbsp;for&nbsp;more&nbsp;about&nbsp;customizing&nbsp;your&nbsp;Truffle&nbsp;configuration! &nbsp;&nbsp;networks:&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;development:&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;&quot;127.0.0.1&quot;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port:&nbsp;7545, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;network_id:&nbsp;&quot;*&quot;&nbsp;//&nbsp;Match&nbsp;any&nbsp;network&nbsp;id &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;} }; 简单说就是配置Truffle工程的一个开发网络，地址是127.0.0.1:7545，也就是Ganache服务的地址。也就是说可以把工程部署到Ganache。 &nbsp; 然后开始编译Truffle工程： $ cd /path/to/my-dapp $ truffle compile Compiling ./contracts/Migrations.sol... Compiling ./contracts/Wrestling.sol... Writing artifacts to ./build/contracts &nbsp; 编程成功后部署到Ganache： $ truffle migrate --network development Using network &#39;development&#39;. &nbsp; Running migration: 1_initial_migration.js &nbsp; Deploying Migrations... &nbsp; ... 0xc278ec5575aa24a03c6c84e17c32d890ba6e748034e3d93a83c77f5082d856d7 &nbsp; Migrations: 0xd4ec84fa50eef802535fce494a187f17beb2a642 Saving successful migration to network... &nbsp; ... 0xa1ec2490cdb988259b7762bf483184f7226a4af3a57d11f660b5d1848ef9aeb0 Saving artifacts... Running migration: 2_initial_migration.js &nbsp; Deploying Wrestling... &nbsp; ... 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3 &nbsp; Wrestling: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a Saving successful migration to network... &nbsp; ... 0x57325073308f757f7788920795b7f3cff59c7483b71ff5319de251505b0d6b13 Saving artifacts... 可以看到Wrestling合约的地址是0xb386d031d04d3cb623d6f45872203a9cb99b3e4a &nbsp; 另外在Ganache的日志可以看到： &nbsp; &nbsp; Transaction: 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3 &nbsp; Contract created: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a &nbsp; Gas usage: 708985 &nbsp; Block Number: 3 &nbsp; Block Time: Fri May 25 2018 17:35:22 GMT+0800 (CST) 这里创建Wrestling合约花费了708985Gas &nbsp; 执行合约 启动 Truffle 控制台，这会帮助我们与ganache的区块链进行交互： $ truffle console --network development truffle(development)&gt; &nbsp; 然后在控制台中进行编码来实现合约的执行 &nbsp; 首先选择2个账户作为游戏的2个参与者 &gt; &nbsp;account0 = web3.eth.accounts[0] &#39;0xe2be5aa059b3891a519f7f1e04666d05e92b1365&#39; &gt;&nbsp; account1 = web3.eth.accounts[1] &#39;0x726f35aa2eabc41b6cb934fb5be7719263f4fe13&#39; &nbsp; &nbsp; 接着初始化一个Wrestling合约实例WrestlingInstance &gt;&nbsp; Wrestling.deployed().then(inst&nbsp;=&gt;&nbsp;{&nbsp;WrestlingInstance&nbsp;=&nbsp;inst&nbsp;}) &nbsp; 可以查看WrestlingInstance的变量wrestler1，也就是选手1的地址，因为我们没有指定，所以默认就是Ganache&nbsp;生成的第一个账户，也就是account0 &gt;&nbsp; WrestlingInstance.wrestler1.call() &#39;0xe2be5aa059b3891a519f7f1e04666d05e92b1365&#39; &nbsp; 然后我们把account1注册成Wrestling合约的第二个选手2 &gt;&nbsp; WrestlingInstance.registerAsAnOpponent({from: account1}) { tx: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp; receipt: &nbsp;&nbsp; { transactionHash: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp; blockHash: &#39;0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052&#39;, &nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5, &nbsp;&nbsp;&nbsp;&nbsp; gasUsed: 43900, &nbsp;&nbsp;&nbsp;&nbsp; cumulativeGasUsed: 43900, &nbsp;&nbsp;&nbsp;&nbsp; contractAddress: null, &nbsp;&nbsp;&nbsp;&nbsp; logs: [ [Object] ], &nbsp;&nbsp;&nbsp;&nbsp; status: &#39;0x01&#39;, &nbsp;&nbsp;&nbsp;&nbsp; logsBloom: &#39;0x00000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000&#39; }, &nbsp; logs: &nbsp;&nbsp; [ { logIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionHash: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockHash: &#39;0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; address: &#39;0xb386d031d04d3cb623d6f45872203a9cb99b3e4a&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: &#39;mined&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; event: &#39;WrestlingStartsEvent&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; args: [Object] } ] } 从返回的结果可以看出该项交易使用了Gas，并且触发了“WrestlingStartsEvent” 事件。 &nbsp; 现在2个选手准备就绪，就可以开始游戏: 每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍(总计)，那他就赢了。 &nbsp; 第一轮，选手1出价2 ether，选手2出价3 ether &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(2,&nbsp;&quot;ether&quot;)}) &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(3,&nbsp;&quot;ether&quot;)}) &nbsp; 第二轮，选手1出价5 ether，选手2出价20 ether &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(5,&nbsp;&quot;ether&quot;)}) &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(20,&nbsp;&quot;ether&quot;)}) &nbsp; 两轮下来，选手1出价7ether，选手2出价23ether，所以选手2获胜，这时候获胜者可以提现： &gt;&nbsp; WrestlingInstance.withdraw({from: account1}) &nbsp; 最后查询账户余额，因为在合约执行过程中要支付Gas，所以账户1的余额是小于107ether的。 &gt;&nbsp; web3.eth.getBalance(account1) { [String: &#39;106974788700000000000&#39;] s: 1, e: 20, c: [ 1069747, 88700000000000 ] 参考 https://blog.csdn.net/m0_37722557/article/details/79899847 http://xinwen.eastday.com/a/180314214918603.html?xx=1&amp;recommendtype=d http://www.cocoachina.com/blockchain/20180314/22592.html http://www.cocoachina.com/blockchain/20180312/22550.html 作者简介 吴龙辉，《Kubernetes实战》作者，活跃于技术开源社区，贡献代码和撰写技术文档。&nbsp; 邮箱： wlh6666@qq.com 阅读更多" />
<meta property="og:description" content="以太坊介绍 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊（Ethereum）是一个建立在区块链技术之上，去中心化应用平台。它允许任何人在平台中建立和使用通过区块链技术运行的去中心化应用。 &nbsp; 智能合约 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊是一个运行着智能合约的分布式平台，智能合约本质就是脚本，这些脚本可以处理各种业务逻辑来利用以太坊区块链的能力，比如彩票、拍卖、物流跟踪等等。这也正是以太坊区别于比特币的最重要的属性，定位来说以太坊旨在成为一个平台，而比特币则是一个货币体系。智能合约赋能给以太坊无限想象力和更强大的生命力。 &nbsp; 一个简单的例子，就是A转账给B，在比特币和以太坊中大概都怎么实现的： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊智能合约实现的方式貌似能看懂，比较易读。事实也是这样的，智能合约使得区块链的扩展性更强，且实现上更简洁，从而让以太坊发展成为目前最大的一个区块链开发平台。 随着智能合约的发展，智能合约构建的组织如同现实商业社会一样的运行，这样形成的去中心化组织网络会变得极其复杂和自治，会出现各种形态：DAPP（去中心化应用）DAO（去中心化自治组织）DAC（去中心化自治公司）DAS（去中心化自治社会）. &nbsp; DAPP &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DAPP是去中心化的APP，DAPP和普通的App原理一样，除了他们是完全去中心化的，在以太坊网络本身自己的节点来运作的DAPP，不依赖于任何中心化的服务器，DAPP是去中心化的，可以完全自动地运行。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊中一般会认为智能合约就是DAPP，当然更准确的可以认为智能合约相当于服务器后台，另外要实现用户体验，还需要UI交互界面，通过RPC与后台对接，那么DAPP就是包含完整的智能合约+用户UI交互界面。 &nbsp; 智能合约开发 搭建开发环境 智能合约的开发环境需要： ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Truffle：是以太坊的开发环境、测试框架和资产通道。换句话说，它可以帮助你开发、发布和测试智能合约等等。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ganache：以前叫作 TestRPC，如果你读过几个月前的教程的话，有可能他们在使用TestRPC 的情境下配合使用了 Truffle，它在 TestRPC 和Truffle 的集成后被重新命名为 Ganache。Ganache 的工作很简单：创建一个虚拟的以太坊区块链，并生成一些我们将在开发过程中用到的虚拟账号。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mist：Mist 是一个分布式网络 apps 的浏览器，相当于是只针对 Dapps 的 Chrome 或Firefox。目前来说，它仍然是不安全的，所以你还不能在不受信任的 Dapp 中使用它。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以太坊钱包：它是 Mist 的一个版本，但只启动一个 Dapp ——以太坊钱包。Mist 和以太坊钱包只是 UI（用户界面）前端，我们还需要一个将我们连接到以太坊区块链的核心程序（它可以是一个真正的以太坊区块链，也可以是一个测试版的）。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Geth：Geth 是把你连接到区块链的核心应用程序，它也可以启动一个新的区块链（在我们这个示例中，我们将创建一个本地测试网区块链），创建合约，挖掘以太币等。 &nbsp; Truffle和Ganache都是基于NodeJS，所以首先得安装Node和NPM。本文是CentOS7环境， Node版本如下： $ node -v v7.0.0 $ npm -v 3.10.8 &nbsp; 安装Truffle： $ npm&nbsp;install&nbsp;-g&nbsp;truffle &nbsp; 安装成功查询： $ truffle version Truffle v4.1.11 (core: 4.1.11) Solidity v0.4.24 (solc-js) &nbsp; 安装Ganache命令行工具： $ npm&nbsp;install&nbsp;-g&nbsp;ganache-cli 创建Truffle工程 使用Truffle来创建一个工程： $ mkdir my-dapp $ cd my-dapp/ $ truffle init Downloading... Unpacking... Setting up... Unbox successful. Sweet! &nbsp; Commands: &nbsp; &nbsp; Compile:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle compile &nbsp; Migrate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle migrate &nbsp; Test contracts: truffle test &nbsp; Truffle会初始化一个项目，项目的文件结构如下： . ├── contracts │&nbsp;&nbsp; └── Migrations.sol ├── migrations │&nbsp;&nbsp; └── 1_initial_migration.js ├── test ├── truffle-config.js └── truffle.js &nbsp; &nbsp; 第一步在工程contracts&nbsp;目录下创建一个Solidity&nbsp;脚本： Wrestling.sol pragma solidity ^0.4.18;&nbsp;/*** Example script for the Ethereum development walkthrough*/contract Wrestling {&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * Our wrestlers&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; address public wrestler1;&nbsp;&nbsp;&nbsp; address public wrestler2;&nbsp;&nbsp;&nbsp;&nbsp; bool public wrestler1Played;&nbsp;&nbsp;&nbsp; bool public wrestler2Played;&nbsp;&nbsp;&nbsp;&nbsp; uint private wrestler1Deposit;&nbsp;&nbsp;&nbsp; uint private wrestler2Deposit;&nbsp;&nbsp;&nbsp;&nbsp; bool public gameFinished;&nbsp;&nbsp;&nbsp; address public theWinner;&nbsp;&nbsp;&nbsp; uint gains;&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The logs that will be emitted in every step of the contract&#39;s life cycle&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; event WrestlingStartsEvent(address wrestler1, address wrestler2);&nbsp;&nbsp;&nbsp; event EndOfRoundEvent(uint wrestler1Deposit, uint wrestler2Deposit);&nbsp;&nbsp;&nbsp; event EndOfWrestlingEvent(address winner, uint gains);&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The contract constructor&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; constructor() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1 = msg.sender;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * A second wrestler can register as an opponent&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function registerAsAnOpponent() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2 == address(0));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2 = msg.sender;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit WrestlingStartsEvent(wrestler1, wrestler2);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * Every round a player can put a sum of ether, if one of the player put in twice or&nbsp;&nbsp;&nbsp; * more the money (in total) than the other did, the first wins&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function wrestle() public payable {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(!gameFinished &amp;&amp; (msg.sender == wrestler1 || msg.sender == wrestler2));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(msg.sender == wrestler1) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler1Played == false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrestler1Deposit = wrestler1Deposit + msg.value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2Played == false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Deposit = wrestler2Deposit + msg.value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Played &amp;&amp; wrestler2Played) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Deposit &gt;= wrestler2Deposit * 2) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (wrestler2Deposit &gt;= wrestler1Deposit * 2) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler2);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;endOfRound();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; function endOfRound() internal {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfRoundEvent(wrestler1Deposit, wrestler2Deposit);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; function endOfGame(address winner) internal {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gameFinished = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; theWinner = winner;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = wrestler1Deposit + wrestler2Deposit;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfWrestlingEvent(winner, gains);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The withdraw function, following the withdraw pattern shown and explained here:&nbsp;&nbsp;&nbsp; * http://solidity.readthedocs.io/en/develop/common-patterns.html#withdrawal-from-contracts&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function withdraw() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(gameFinished &amp;&amp; theWinner == msg.sender);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;uint amount = gains;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg.sender.transfer(amount);&nbsp;&nbsp;&nbsp; }} Wrestling实现的是一个角力的游戏，在这个游戏中，每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍(总计)，那他就赢了。 关于代码的解读参考http://www.cocoachina.com/blockchain/20180312/22550.html &nbsp; &nbsp; 第二步在工程目录migrations创建一个部署脚本： 2_deploy_contracts.js const&nbsp;Wrestling&nbsp;=&nbsp;artifacts.require(&quot;./Wrestling.sol&quot;) &nbsp; module.exports&nbsp;=&nbsp;function(deployer)&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;deployer.deploy(Wrestling); }; 这个部署脚本的作用是导入Wrestling.sol然后部署到区块链中。 &nbsp; 启动Ganache Truffle工程创建完成后，现在通过Ganache创建一个虚拟的以太坊区块链。 新开一个窗口执行: $ ganache-cli&nbsp;-p&nbsp;7545 Ganache CLI v6.1.0 (ganache-core: 2.1.0) &nbsp; Available Accounts ================== (0) 0x67f0c56f2ed6b635e7a4d4285615ae01b4b6d834 (1) 0xdde20e330d5747253aa2041532b486fb425951a8 (2) 0xecc3a4c50bce3014d11a3840d0d1dd3011cf65e8 (3) 0x3db9dcb607a15b744affb1453ce1d36121f56a9a (4) 0x0f1c36775edba34f9239f6fbe3e1d071a35a80bf (5) 0x14156195c281babf28200aec756ce16e8794e724 (6) 0xdb89069d044cb1f8246fad2a805b97102b05c6a5 (7) 0xa3dfb369603aa5788626371ab022e42f98001607 (8) 0x455bffe5cce17a3a71bfb1ef1fb74c3640f77b97 (9) 0x82512876028923943d5e937441710d6675d573b0 &nbsp; Private Keys ================== (0) 5d5d0d038bbd85c1ca25768a0da88b49805dd74bbffa628cd4b0968877eb84af (1) ba616ed800cf1e0306ec1eaea7416d52bab5ad0dd7216a997194784461da7efe (2) 0f80b88a4ad72850003a8aca809932e3e27f29e2a931d900ac0cb06fc22247bd (3) c0cb6aecff075d9527eebb69c5389f6cfaea2a3e7120a2fb6fb4122e299dfdad (4) 7ea0bd30edcbe05b89553a1c7e4eb52c4ebf87f1a664202ccad7eb26e589403c (5) 5ff14162882f900a4c2241042b1e51c866adeb089c28e6643787ef26b43293c8 (6) 24da6f19bfaa3de81ab1fd9b62636064282604e4fa26d6697eacfc3c9d3d9de8 (7) 944c9ede3956b7dc55b2ece7f9506358b1d7c5e5f7275c6b11dacd5e38414c0f (8) 43e8c352eaafd39e7116b43aed86006141daa18c1cf7c06806c6c19cbb7be29a (9) bf43907fd082a64b987c00ceb9b7ae45eee08fcf96ae07d6b0260d4ec370f736 &nbsp; HD Wallet ================== Mnemonic:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; video march rail weapon lunch holiday organ vague food strategy gown artist Base HD Path:&nbsp; m/44&#39;/60&#39;/0&#39;/0/{account_index} &nbsp; Listening on localhost:7545 &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ganache启动成功后，会生成10个测试账号，默认情况下，每个账户都有未锁定的100个以太币并，所以我们可以自由地从那里发送以太币。最后Ganache服务监听在localhost:7545。 &nbsp; 编译和部署 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ganache启动后，回到Truffle工程目录下修改配置文件truffle.js和truffle-config.js： module.exports&nbsp;=&nbsp;{ &nbsp;&nbsp;//&nbsp;See&nbsp;&nbsp;&nbsp;//&nbsp;for&nbsp;more&nbsp;about&nbsp;customizing&nbsp;your&nbsp;Truffle&nbsp;configuration! &nbsp;&nbsp;networks:&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;development:&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;&quot;127.0.0.1&quot;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port:&nbsp;7545, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;network_id:&nbsp;&quot;*&quot;&nbsp;//&nbsp;Match&nbsp;any&nbsp;network&nbsp;id &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;} }; 简单说就是配置Truffle工程的一个开发网络，地址是127.0.0.1:7545，也就是Ganache服务的地址。也就是说可以把工程部署到Ganache。 &nbsp; 然后开始编译Truffle工程： $ cd /path/to/my-dapp $ truffle compile Compiling ./contracts/Migrations.sol... Compiling ./contracts/Wrestling.sol... Writing artifacts to ./build/contracts &nbsp; 编程成功后部署到Ganache： $ truffle migrate --network development Using network &#39;development&#39;. &nbsp; Running migration: 1_initial_migration.js &nbsp; Deploying Migrations... &nbsp; ... 0xc278ec5575aa24a03c6c84e17c32d890ba6e748034e3d93a83c77f5082d856d7 &nbsp; Migrations: 0xd4ec84fa50eef802535fce494a187f17beb2a642 Saving successful migration to network... &nbsp; ... 0xa1ec2490cdb988259b7762bf483184f7226a4af3a57d11f660b5d1848ef9aeb0 Saving artifacts... Running migration: 2_initial_migration.js &nbsp; Deploying Wrestling... &nbsp; ... 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3 &nbsp; Wrestling: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a Saving successful migration to network... &nbsp; ... 0x57325073308f757f7788920795b7f3cff59c7483b71ff5319de251505b0d6b13 Saving artifacts... 可以看到Wrestling合约的地址是0xb386d031d04d3cb623d6f45872203a9cb99b3e4a &nbsp; 另外在Ganache的日志可以看到： &nbsp; &nbsp; Transaction: 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3 &nbsp; Contract created: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a &nbsp; Gas usage: 708985 &nbsp; Block Number: 3 &nbsp; Block Time: Fri May 25 2018 17:35:22 GMT+0800 (CST) 这里创建Wrestling合约花费了708985Gas &nbsp; 执行合约 启动 Truffle 控制台，这会帮助我们与ganache的区块链进行交互： $ truffle console --network development truffle(development)&gt; &nbsp; 然后在控制台中进行编码来实现合约的执行 &nbsp; 首先选择2个账户作为游戏的2个参与者 &gt; &nbsp;account0 = web3.eth.accounts[0] &#39;0xe2be5aa059b3891a519f7f1e04666d05e92b1365&#39; &gt;&nbsp; account1 = web3.eth.accounts[1] &#39;0x726f35aa2eabc41b6cb934fb5be7719263f4fe13&#39; &nbsp; &nbsp; 接着初始化一个Wrestling合约实例WrestlingInstance &gt;&nbsp; Wrestling.deployed().then(inst&nbsp;=&gt;&nbsp;{&nbsp;WrestlingInstance&nbsp;=&nbsp;inst&nbsp;}) &nbsp; 可以查看WrestlingInstance的变量wrestler1，也就是选手1的地址，因为我们没有指定，所以默认就是Ganache&nbsp;生成的第一个账户，也就是account0 &gt;&nbsp; WrestlingInstance.wrestler1.call() &#39;0xe2be5aa059b3891a519f7f1e04666d05e92b1365&#39; &nbsp; 然后我们把account1注册成Wrestling合约的第二个选手2 &gt;&nbsp; WrestlingInstance.registerAsAnOpponent({from: account1}) { tx: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp; receipt: &nbsp;&nbsp; { transactionHash: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp; blockHash: &#39;0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052&#39;, &nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5, &nbsp;&nbsp;&nbsp;&nbsp; gasUsed: 43900, &nbsp;&nbsp;&nbsp;&nbsp; cumulativeGasUsed: 43900, &nbsp;&nbsp;&nbsp;&nbsp; contractAddress: null, &nbsp;&nbsp;&nbsp;&nbsp; logs: [ [Object] ], &nbsp;&nbsp;&nbsp;&nbsp; status: &#39;0x01&#39;, &nbsp;&nbsp;&nbsp;&nbsp; logsBloom: &#39;0x00000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000&#39; }, &nbsp; logs: &nbsp;&nbsp; [ { logIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionHash: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockHash: &#39;0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; address: &#39;0xb386d031d04d3cb623d6f45872203a9cb99b3e4a&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: &#39;mined&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; event: &#39;WrestlingStartsEvent&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; args: [Object] } ] } 从返回的结果可以看出该项交易使用了Gas，并且触发了“WrestlingStartsEvent” 事件。 &nbsp; 现在2个选手准备就绪，就可以开始游戏: 每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍(总计)，那他就赢了。 &nbsp; 第一轮，选手1出价2 ether，选手2出价3 ether &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(2,&nbsp;&quot;ether&quot;)}) &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(3,&nbsp;&quot;ether&quot;)}) &nbsp; 第二轮，选手1出价5 ether，选手2出价20 ether &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(5,&nbsp;&quot;ether&quot;)}) &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(20,&nbsp;&quot;ether&quot;)}) &nbsp; 两轮下来，选手1出价7ether，选手2出价23ether，所以选手2获胜，这时候获胜者可以提现： &gt;&nbsp; WrestlingInstance.withdraw({from: account1}) &nbsp; 最后查询账户余额，因为在合约执行过程中要支付Gas，所以账户1的余额是小于107ether的。 &gt;&nbsp; web3.eth.getBalance(account1) { [String: &#39;106974788700000000000&#39;] s: 1, e: 20, c: [ 1069747, 88700000000000 ] 参考 https://blog.csdn.net/m0_37722557/article/details/79899847 http://xinwen.eastday.com/a/180314214918603.html?xx=1&amp;recommendtype=d http://www.cocoachina.com/blockchain/20180314/22592.html http://www.cocoachina.com/blockchain/20180312/22550.html 作者简介 吴龙辉，《Kubernetes实战》作者，活跃于技术开源社区，贡献代码和撰写技术文档。&nbsp; 邮箱： wlh6666@qq.com 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-05-28T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"以太坊介绍 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊（Ethereum）是一个建立在区块链技术之上，去中心化应用平台。它允许任何人在平台中建立和使用通过区块链技术运行的去中心化应用。 &nbsp; 智能合约 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊是一个运行着智能合约的分布式平台，智能合约本质就是脚本，这些脚本可以处理各种业务逻辑来利用以太坊区块链的能力，比如彩票、拍卖、物流跟踪等等。这也正是以太坊区别于比特币的最重要的属性，定位来说以太坊旨在成为一个平台，而比特币则是一个货币体系。智能合约赋能给以太坊无限想象力和更强大的生命力。 &nbsp; 一个简单的例子，就是A转账给B，在比特币和以太坊中大概都怎么实现的： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊智能合约实现的方式貌似能看懂，比较易读。事实也是这样的，智能合约使得区块链的扩展性更强，且实现上更简洁，从而让以太坊发展成为目前最大的一个区块链开发平台。 随着智能合约的发展，智能合约构建的组织如同现实商业社会一样的运行，这样形成的去中心化组织网络会变得极其复杂和自治，会出现各种形态：DAPP（去中心化应用）DAO（去中心化自治组织）DAC（去中心化自治公司）DAS（去中心化自治社会）. &nbsp; DAPP &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DAPP是去中心化的APP，DAPP和普通的App原理一样，除了他们是完全去中心化的，在以太坊网络本身自己的节点来运作的DAPP，不依赖于任何中心化的服务器，DAPP是去中心化的，可以完全自动地运行。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 以太坊中一般会认为智能合约就是DAPP，当然更准确的可以认为智能合约相当于服务器后台，另外要实现用户体验，还需要UI交互界面，通过RPC与后台对接，那么DAPP就是包含完整的智能合约+用户UI交互界面。 &nbsp; 智能合约开发 搭建开发环境 智能合约的开发环境需要： ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Truffle：是以太坊的开发环境、测试框架和资产通道。换句话说，它可以帮助你开发、发布和测试智能合约等等。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ganache：以前叫作 TestRPC，如果你读过几个月前的教程的话，有可能他们在使用TestRPC 的情境下配合使用了 Truffle，它在 TestRPC 和Truffle 的集成后被重新命名为 Ganache。Ganache 的工作很简单：创建一个虚拟的以太坊区块链，并生成一些我们将在开发过程中用到的虚拟账号。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mist：Mist 是一个分布式网络 apps 的浏览器，相当于是只针对 Dapps 的 Chrome 或Firefox。目前来说，它仍然是不安全的，所以你还不能在不受信任的 Dapp 中使用它。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以太坊钱包：它是 Mist 的一个版本，但只启动一个 Dapp ——以太坊钱包。Mist 和以太坊钱包只是 UI（用户界面）前端，我们还需要一个将我们连接到以太坊区块链的核心程序（它可以是一个真正的以太坊区块链，也可以是一个测试版的）。 ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Geth：Geth 是把你连接到区块链的核心应用程序，它也可以启动一个新的区块链（在我们这个示例中，我们将创建一个本地测试网区块链），创建合约，挖掘以太币等。 &nbsp; Truffle和Ganache都是基于NodeJS，所以首先得安装Node和NPM。本文是CentOS7环境， Node版本如下： $ node -v v7.0.0 $ npm -v 3.10.8 &nbsp; 安装Truffle： $ npm&nbsp;install&nbsp;-g&nbsp;truffle &nbsp; 安装成功查询： $ truffle version Truffle v4.1.11 (core: 4.1.11) Solidity v0.4.24 (solc-js) &nbsp; 安装Ganache命令行工具： $ npm&nbsp;install&nbsp;-g&nbsp;ganache-cli 创建Truffle工程 使用Truffle来创建一个工程： $ mkdir my-dapp $ cd my-dapp/ $ truffle init Downloading... Unpacking... Setting up... Unbox successful. Sweet! &nbsp; Commands: &nbsp; &nbsp; Compile:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle compile &nbsp; Migrate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle migrate &nbsp; Test contracts: truffle test &nbsp; Truffle会初始化一个项目，项目的文件结构如下： . ├── contracts │&nbsp;&nbsp; └── Migrations.sol ├── migrations │&nbsp;&nbsp; └── 1_initial_migration.js ├── test ├── truffle-config.js └── truffle.js &nbsp; &nbsp; 第一步在工程contracts&nbsp;目录下创建一个Solidity&nbsp;脚本： Wrestling.sol pragma solidity ^0.4.18;&nbsp;/*** Example script for the Ethereum development walkthrough*/contract Wrestling {&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * Our wrestlers&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; address public wrestler1;&nbsp;&nbsp;&nbsp; address public wrestler2;&nbsp;&nbsp;&nbsp;&nbsp; bool public wrestler1Played;&nbsp;&nbsp;&nbsp; bool public wrestler2Played;&nbsp;&nbsp;&nbsp;&nbsp; uint private wrestler1Deposit;&nbsp;&nbsp;&nbsp; uint private wrestler2Deposit;&nbsp;&nbsp;&nbsp;&nbsp; bool public gameFinished;&nbsp;&nbsp;&nbsp; address public theWinner;&nbsp;&nbsp;&nbsp; uint gains;&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The logs that will be emitted in every step of the contract&#39;s life cycle&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; event WrestlingStartsEvent(address wrestler1, address wrestler2);&nbsp;&nbsp;&nbsp; event EndOfRoundEvent(uint wrestler1Deposit, uint wrestler2Deposit);&nbsp;&nbsp;&nbsp; event EndOfWrestlingEvent(address winner, uint gains);&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The contract constructor&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; constructor() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1 = msg.sender;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * A second wrestler can register as an opponent&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function registerAsAnOpponent() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2 == address(0));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2 = msg.sender;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit WrestlingStartsEvent(wrestler1, wrestler2);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * Every round a player can put a sum of ether, if one of the player put in twice or&nbsp;&nbsp;&nbsp; * more the money (in total) than the other did, the first wins&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function wrestle() public payable {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(!gameFinished &amp;&amp; (msg.sender == wrestler1 || msg.sender == wrestler2));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(msg.sender == wrestler1) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler1Played == false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrestler1Deposit = wrestler1Deposit + msg.value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2Played == false);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Deposit = wrestler2Deposit + msg.value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Played &amp;&amp; wrestler2Played) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Deposit &gt;= wrestler2Deposit * 2) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler1);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (wrestler2Deposit &gt;= wrestler1Deposit * 2) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler2);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;endOfRound();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; function endOfRound() internal {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfRoundEvent(wrestler1Deposit, wrestler2Deposit);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; function endOfGame(address winner) internal {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gameFinished = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; theWinner = winner;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = wrestler1Deposit + wrestler2Deposit;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfWrestlingEvent(winner, gains);&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;&nbsp;&nbsp; /**&nbsp;&nbsp;&nbsp; * The withdraw function, following the withdraw pattern shown and explained here:&nbsp;&nbsp;&nbsp; * http://solidity.readthedocs.io/en/develop/common-patterns.html#withdrawal-from-contracts&nbsp;&nbsp;&nbsp; */&nbsp;&nbsp;&nbsp; function withdraw() public {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(gameFinished &amp;&amp; theWinner == msg.sender);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;uint amount = gains;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg.sender.transfer(amount);&nbsp;&nbsp;&nbsp; }} Wrestling实现的是一个角力的游戏，在这个游戏中，每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍(总计)，那他就赢了。 关于代码的解读参考http://www.cocoachina.com/blockchain/20180312/22550.html &nbsp; &nbsp; 第二步在工程目录migrations创建一个部署脚本： 2_deploy_contracts.js const&nbsp;Wrestling&nbsp;=&nbsp;artifacts.require(&quot;./Wrestling.sol&quot;) &nbsp; module.exports&nbsp;=&nbsp;function(deployer)&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;deployer.deploy(Wrestling); }; 这个部署脚本的作用是导入Wrestling.sol然后部署到区块链中。 &nbsp; 启动Ganache Truffle工程创建完成后，现在通过Ganache创建一个虚拟的以太坊区块链。 新开一个窗口执行: $ ganache-cli&nbsp;-p&nbsp;7545 Ganache CLI v6.1.0 (ganache-core: 2.1.0) &nbsp; Available Accounts ================== (0) 0x67f0c56f2ed6b635e7a4d4285615ae01b4b6d834 (1) 0xdde20e330d5747253aa2041532b486fb425951a8 (2) 0xecc3a4c50bce3014d11a3840d0d1dd3011cf65e8 (3) 0x3db9dcb607a15b744affb1453ce1d36121f56a9a (4) 0x0f1c36775edba34f9239f6fbe3e1d071a35a80bf (5) 0x14156195c281babf28200aec756ce16e8794e724 (6) 0xdb89069d044cb1f8246fad2a805b97102b05c6a5 (7) 0xa3dfb369603aa5788626371ab022e42f98001607 (8) 0x455bffe5cce17a3a71bfb1ef1fb74c3640f77b97 (9) 0x82512876028923943d5e937441710d6675d573b0 &nbsp; Private Keys ================== (0) 5d5d0d038bbd85c1ca25768a0da88b49805dd74bbffa628cd4b0968877eb84af (1) ba616ed800cf1e0306ec1eaea7416d52bab5ad0dd7216a997194784461da7efe (2) 0f80b88a4ad72850003a8aca809932e3e27f29e2a931d900ac0cb06fc22247bd (3) c0cb6aecff075d9527eebb69c5389f6cfaea2a3e7120a2fb6fb4122e299dfdad (4) 7ea0bd30edcbe05b89553a1c7e4eb52c4ebf87f1a664202ccad7eb26e589403c (5) 5ff14162882f900a4c2241042b1e51c866adeb089c28e6643787ef26b43293c8 (6) 24da6f19bfaa3de81ab1fd9b62636064282604e4fa26d6697eacfc3c9d3d9de8 (7) 944c9ede3956b7dc55b2ece7f9506358b1d7c5e5f7275c6b11dacd5e38414c0f (8) 43e8c352eaafd39e7116b43aed86006141daa18c1cf7c06806c6c19cbb7be29a (9) bf43907fd082a64b987c00ceb9b7ae45eee08fcf96ae07d6b0260d4ec370f736 &nbsp; HD Wallet ================== Mnemonic:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; video march rail weapon lunch holiday organ vague food strategy gown artist Base HD Path:&nbsp; m/44&#39;/60&#39;/0&#39;/0/{account_index} &nbsp; Listening on localhost:7545 &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ganache启动成功后，会生成10个测试账号，默认情况下，每个账户都有未锁定的100个以太币并，所以我们可以自由地从那里发送以太币。最后Ganache服务监听在localhost:7545。 &nbsp; 编译和部署 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ganache启动后，回到Truffle工程目录下修改配置文件truffle.js和truffle-config.js： module.exports&nbsp;=&nbsp;{ &nbsp;&nbsp;//&nbsp;See&nbsp;&nbsp;&nbsp;//&nbsp;for&nbsp;more&nbsp;about&nbsp;customizing&nbsp;your&nbsp;Truffle&nbsp;configuration! &nbsp;&nbsp;networks:&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;development:&nbsp;{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;&quot;127.0.0.1&quot;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port:&nbsp;7545, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;network_id:&nbsp;&quot;*&quot;&nbsp;//&nbsp;Match&nbsp;any&nbsp;network&nbsp;id &nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;} }; 简单说就是配置Truffle工程的一个开发网络，地址是127.0.0.1:7545，也就是Ganache服务的地址。也就是说可以把工程部署到Ganache。 &nbsp; 然后开始编译Truffle工程： $ cd /path/to/my-dapp $ truffle compile Compiling ./contracts/Migrations.sol... Compiling ./contracts/Wrestling.sol... Writing artifacts to ./build/contracts &nbsp; 编程成功后部署到Ganache： $ truffle migrate --network development Using network &#39;development&#39;. &nbsp; Running migration: 1_initial_migration.js &nbsp; Deploying Migrations... &nbsp; ... 0xc278ec5575aa24a03c6c84e17c32d890ba6e748034e3d93a83c77f5082d856d7 &nbsp; Migrations: 0xd4ec84fa50eef802535fce494a187f17beb2a642 Saving successful migration to network... &nbsp; ... 0xa1ec2490cdb988259b7762bf483184f7226a4af3a57d11f660b5d1848ef9aeb0 Saving artifacts... Running migration: 2_initial_migration.js &nbsp; Deploying Wrestling... &nbsp; ... 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3 &nbsp; Wrestling: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a Saving successful migration to network... &nbsp; ... 0x57325073308f757f7788920795b7f3cff59c7483b71ff5319de251505b0d6b13 Saving artifacts... 可以看到Wrestling合约的地址是0xb386d031d04d3cb623d6f45872203a9cb99b3e4a &nbsp; 另外在Ganache的日志可以看到： &nbsp; &nbsp; Transaction: 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3 &nbsp; Contract created: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a &nbsp; Gas usage: 708985 &nbsp; Block Number: 3 &nbsp; Block Time: Fri May 25 2018 17:35:22 GMT+0800 (CST) 这里创建Wrestling合约花费了708985Gas &nbsp; 执行合约 启动 Truffle 控制台，这会帮助我们与ganache的区块链进行交互： $ truffle console --network development truffle(development)&gt; &nbsp; 然后在控制台中进行编码来实现合约的执行 &nbsp; 首先选择2个账户作为游戏的2个参与者 &gt; &nbsp;account0 = web3.eth.accounts[0] &#39;0xe2be5aa059b3891a519f7f1e04666d05e92b1365&#39; &gt;&nbsp; account1 = web3.eth.accounts[1] &#39;0x726f35aa2eabc41b6cb934fb5be7719263f4fe13&#39; &nbsp; &nbsp; 接着初始化一个Wrestling合约实例WrestlingInstance &gt;&nbsp; Wrestling.deployed().then(inst&nbsp;=&gt;&nbsp;{&nbsp;WrestlingInstance&nbsp;=&nbsp;inst&nbsp;}) &nbsp; 可以查看WrestlingInstance的变量wrestler1，也就是选手1的地址，因为我们没有指定，所以默认就是Ganache&nbsp;生成的第一个账户，也就是account0 &gt;&nbsp; WrestlingInstance.wrestler1.call() &#39;0xe2be5aa059b3891a519f7f1e04666d05e92b1365&#39; &nbsp; 然后我们把account1注册成Wrestling合约的第二个选手2 &gt;&nbsp; WrestlingInstance.registerAsAnOpponent({from: account1}) { tx: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp; receipt: &nbsp;&nbsp; { transactionHash: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp; blockHash: &#39;0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052&#39;, &nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5, &nbsp;&nbsp;&nbsp;&nbsp; gasUsed: 43900, &nbsp;&nbsp;&nbsp;&nbsp; cumulativeGasUsed: 43900, &nbsp;&nbsp;&nbsp;&nbsp; contractAddress: null, &nbsp;&nbsp;&nbsp;&nbsp; logs: [ [Object] ], &nbsp;&nbsp;&nbsp;&nbsp; status: &#39;0x01&#39;, &nbsp;&nbsp;&nbsp;&nbsp; logsBloom: &#39;0x00000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000&#39; }, &nbsp; logs: &nbsp;&nbsp; [ { logIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionHash: &#39;0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockHash: &#39;0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; address: &#39;0xb386d031d04d3cb623d6f45872203a9cb99b3e4a&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: &#39;mined&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; event: &#39;WrestlingStartsEvent&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; args: [Object] } ] } 从返回的结果可以看出该项交易使用了Gas，并且触发了“WrestlingStartsEvent” 事件。 &nbsp; 现在2个选手准备就绪，就可以开始游戏: 每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍(总计)，那他就赢了。 &nbsp; 第一轮，选手1出价2 ether，选手2出价3 ether &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(2,&nbsp;&quot;ether&quot;)}) &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(3,&nbsp;&quot;ether&quot;)}) &nbsp; 第二轮，选手1出价5 ether，选手2出价20 ether &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(5,&nbsp;&quot;ether&quot;)}) &gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(20,&nbsp;&quot;ether&quot;)}) &nbsp; 两轮下来，选手1出价7ether，选手2出价23ether，所以选手2获胜，这时候获胜者可以提现： &gt;&nbsp; WrestlingInstance.withdraw({from: account1}) &nbsp; 最后查询账户余额，因为在合约执行过程中要支付Gas，所以账户1的余额是小于107ether的。 &gt;&nbsp; web3.eth.getBalance(account1) { [String: &#39;106974788700000000000&#39;] s: 1, e: 20, c: [ 1069747, 88700000000000 ] 参考 https://blog.csdn.net/m0_37722557/article/details/79899847 http://xinwen.eastday.com/a/180314214918603.html?xx=1&amp;recommendtype=d http://www.cocoachina.com/blockchain/20180314/22592.html http://www.cocoachina.com/blockchain/20180312/22550.html 作者简介 吴龙辉，《Kubernetes实战》作者，活跃于技术开源社区，贡献代码和撰写技术文档。&nbsp; 邮箱： wlh6666@qq.com 阅读更多","@type":"BlogPosting","url":"/2018/05/28/abb37bc9a8b34f734d600f2dc4f0fe1a.html","headline":"以太坊分析之 智能合约和DAPP","dateModified":"2018-05-28T00:00:00+08:00","datePublished":"2018-05-28T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/05/28/abb37bc9a8b34f734d600f2dc4f0fe1a.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>以太坊分析之 智能合约和DAPP</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <h1>以太坊介绍</h1>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#000000;background:#FFFFFF;">以太坊（</span><span style="color:#000000;background:#FFFFFF;">Ethereum</span><span style="color:#000000;background:#FFFFFF;">）是一个建立在区块链技术之上，</span><span style="color:#000000;background:#FFFFFF;">去中心化应用平台。它允许任何人在平台中建立和使用通过区块链技术运行的去中心化应用。</span></p>
  <p style="background:#FFFFFF;">&nbsp;</p>
  <h1>智能合约</h1>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#000000;background:#FFFFFF;">以太坊是一个运行着智能合约的分布式平台</span>，智能合约本质就是脚本，这些脚本可以处理各种业务逻辑来利用以太坊区块链的能力，比如彩票、拍卖、物流跟踪等等。这也正是以太坊区别于比特币的最重要的属性，定位来说以太坊旨在成为一个平台，而比特币则是一个货币体系。智能合约赋能给以太坊无限想象力和更强大的生命力。</p>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;<img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180528101717943?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsaGRvNzE5MjAxNDU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></span></p>
  <p><span style="background:#FFFFFF;">一个简单的例子，就是</span><span style="background:#FFFFFF;">A</span><span style="background:#FFFFFF;">转账给</span><span style="background:#FFFFFF;">B</span><span style="background:#FFFFFF;">，在比特币和以太坊中大概都怎么实现的：</span></p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180528101723483?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsaGRvNzE5MjAxNDU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""></p>
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018052810173080?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dsaGRvNzE5MjAxNDU=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt=""><br></p>
  <p> </p>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#000000;background:#FFFFFF;">以太坊智能合约实现的方式貌似能看懂，比较易读</span><strong><span style="color:#000000;">。</span></strong><span style="color:#000000;background:#FFFFFF;">事实也是这样的，智能合约使得区块链的</span>扩展性更强，且实现上更简洁，从而让以太坊发展成为目前最大的一个区块链开发平台。</p>
  <p><span style="color:#000000;background:#FFFFFF;">随着智能合约的发展，智能合约构建的组织如同现实商业社会一样的运行，这样形成的去中心化组织网络会变得极其复杂和自治，会出现各种形态：</span><span style="color:#000000;background:#FFFFFF;">DAPP</span><span style="color:#000000;background:#FFFFFF;">（去中心化应用）</span><span style="color:#000000;background:#FFFFFF;">DAO</span><span style="color:#000000;background:#FFFFFF;">（去中心化自治组织）</span><span style="color:#000000;background:#FFFFFF;">DAC</span><span style="color:#000000;background:#FFFFFF;">（去中心化自治公司）</span><span style="color:#000000;background:#FFFFFF;">DAS</span><span style="color:#000000;background:#FFFFFF;">（去中心化自治社会）</span><span style="color:#000000;background:#FFFFFF;">.</span></p>
  <p>&nbsp;</p>
  <h1>DAPP</h1>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DAPP</span><span style="color:#000000;background:#FFFFFF;">是去中心化的</span><span style="color:#000000;background:#FFFFFF;">APP</span><span style="color:#000000;background:#FFFFFF;">，</span><span style="color:#000000;background:#FFFFFF;">DAPP</span><span style="color:#000000;background:#FFFFFF;">和普通的</span><span style="color:#000000;background:#FFFFFF;">App</span><span style="color:#000000;background:#FFFFFF;">原理一样，除了他们是完全去中心化的，在以太坊网络本身自己的节点来运作的</span><span style="color:#000000;background:#FFFFFF;">DAPP</span><span style="color:#000000;background:#FFFFFF;">，不依赖于任何中心化的服务器，</span><span style="color:#000000;background:#FFFFFF;">DAPP</span><span style="color:#000000;background:#FFFFFF;">是去中心化的，可以完全自动地运行</span>。</p>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="color:#000000;background:#FFFFFF;">以太坊中一般会认为智能合约就是</span><span style="color:#000000;background:#FFFFFF;">DAPP</span><span style="color:#000000;background:#FFFFFF;">，当然更准确的可以认为智能合约相当于服务器后台，另外要实现用户体验，还需要</span><span style="color:#000000;background:#FFFFFF;">UI</span><span style="color:#000000;background:#FFFFFF;">交互界面，通过</span><span style="color:#000000;background:#FFFFFF;">RPC</span><span style="color:#000000;background:#FFFFFF;">与后台对接，那么</span><span style="color:#000000;background:#FFFFFF;">DAPP</span><span style="color:#000000;background:#FFFFFF;">就是包含完整的智能合约</span><span style="color:#000000;background:#FFFFFF;">+</span><span style="color:#000000;background:#FFFFFF;">用户</span><span style="color:#000000;background:#FFFFFF;">UI</span><span style="color:#000000;background:#FFFFFF;">交互界面。</span></p>
  <p><span style="color:#000000;background:#FFFFFF;">&nbsp;</span></p>
  <h1><span style="background:#FFFFFF;">智能合约开发</span></h1>
  <h2>搭建开发环境</h2>
  <p>智能合约的开发环境需要：</p>
  <p style="background:#FAFAFA;"><span style="color:#252525;">·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#252525;">Truffle</span><span style="color:#252525;">：是以太坊的开发环境、测试框架和资产通道。换句话说，它可以帮助你开发、发布和测试智能合约等等。</span></p>
  <p style="background:#FAFAFA;"><span style="color:#252525;">·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#252525;">Ganache</span><span style="color:#252525;">：以前叫作</span><span style="color:#252525;"> TestRPC</span><span style="color:#252525;">，如果你读过几个月前的教程的话，有可能他们在使用</span><span style="color:#252525;">TestRPC </span><span style="color:#252525;">的情境下配合使用了</span><span style="color:#252525;"> Truffle</span><span style="color:#252525;">，它在</span><span style="color:#252525;"> TestRPC </span><span style="color:#252525;">和</span><span style="color:#252525;">Truffle </span><span style="color:#252525;">的集成后被重新命名为</span><span style="color:#252525;"> Ganache</span><span style="color:#252525;">。</span><span style="color:#252525;">Ganache </span><span style="color:#252525;">的工作很简单：<a></a><a>创建一个虚拟的以太坊区块链</a>，并生成一些我们将在开发过程中用到的虚拟账号。</span></p>
  <p style="background:#FAFAFA;"><span style="color:#252525;">·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#252525;">Mist</span><span style="color:#252525;">：</span><span style="color:#252525;">Mist </span><span style="color:#252525;">是一个分布式网络</span><span style="color:#252525;"> apps </span><span style="color:#252525;">的浏览器，相当于是只针对</span><span style="color:#252525;"> Dapps </span><span style="color:#252525;">的</span><span style="color:#252525;"> Chrome </span><span style="color:#252525;">或</span><span style="color:#252525;">Firefox</span><span style="color:#252525;">。目前来说，它仍然是不安全的，所以你还不能在不受信任的</span><span style="color:#252525;"> Dapp </span><span style="color:#252525;">中使用它。</span></p>
  <p style="background:#FAFAFA;"><span style="color:#252525;">·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#252525;">以太坊钱包：它是</span><span style="color:#252525;"> Mist </span><span style="color:#252525;">的一个版本，但只启动一个</span><span style="color:#252525;"> Dapp ——</span><span style="color:#252525;">以太坊钱包。</span><span style="color:#252525;">Mist </span><span style="color:#252525;">和</span><span style="color:#252525;"><a href="https://wallet.ethereum.org/" rel="nofollow"><span style="color:#EB6100;">以太坊钱包</span></a></span><span style="color:#252525;">只是</span><span style="color:#252525;"> UI</span><span style="color:#252525;">（用户界面）前端，我们还需要一个将我们连接到以太坊区块链的核心程序（它可以是一个真正的以太坊区块链，也可以是一个测试版的）。</span></p>
  <p style="background:#FAFAFA;"><span style="color:#252525;">·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color:#252525;">Geth</span><span style="color:#252525;">：</span><span style="color:#252525;">Geth </span><span style="color:#252525;">是把你连接到区块链的核心应用程序，它也可以启动一个新的区块链（在我们这个示例中，我们将创建一个本地测试网区块链），创建合约，挖掘以太币等。</span></p>
  <p>&nbsp;</p>
  <p align="left"><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">和</span><span style="background:#FFFFFF;">Ganache</span><span style="background:#FFFFFF;">都是基于</span><span style="background:#FFFFFF;">NodeJS</span><span style="background:#FFFFFF;">，所以首先得安装</span><span style="background:#FFFFFF;">Node</span><span style="background:#FFFFFF;">和</span><span style="background:#FFFFFF;">NPM</span><span style="background:#FFFFFF;">。本文是</span><span style="background:#FFFFFF;">CentOS7</span><span style="background:#FFFFFF;">环境，</span></p>
  <p align="left"><span style="background:#FFFFFF;">Node</span><span style="background:#FFFFFF;">版本如下：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><strong><span style="color:#FF0000;">$ node -v</span></strong></p> <p align="left">v7.0.0</p> <p align="left"><strong><span style="color:#FF0000;">$ npm -v</span></strong></p> <p align="left">3.10.8</p></td> 
    </tr>
   </tbody>
  </table>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">安装</span><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><a></a><a><strong><span style="color:#FF0000;">$ npm&nbsp;install&nbsp;-g&nbsp;truffle</span></strong></a></p></td> 
    </tr>
   </tbody>
  </table>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">安装成功查询：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><strong><span style="color:#FF0000;">$ truffle version</span></strong></p> <p align="left">Truffle v4.1.11 (core: 4.1.11)</p> <p align="left">Solidity v0.4.24 (solc-js)</p></td> 
    </tr>
   </tbody>
  </table>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">安装</span><span style="color:#252525;background:#FAFAFA;">Ganache</span><span style="color:#252525;background:#FAFAFA;">命令行工具：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><strong><span style="color:#FF0000;">$ npm&nbsp;install&nbsp;-g&nbsp;ganache-cli</span></strong></p></td> 
    </tr>
   </tbody>
  </table>
  <h2><span style="background:#FFFFFF;">创建Truffle</span>工程</h2>
  <p><span style="background:#FFFFFF;">使用</span><a></a><a><span style="background:#FFFFFF;">Truffle</span></a><span style="background:#FFFFFF;">来创建一个工程：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">$ mkdir my-dapp</span></strong></p> <p><strong><span style="color:#FF0000;">$ cd my-dapp/</span></strong></p> <p><strong><span style="color:#FF0000;">$ truffle init</span></strong></p> <p>Downloading...</p> <p>Unpacking...</p> <p>Setting up...</p> <p>Unbox successful. Sweet!</p> <p>&nbsp;</p> <p>Commands:</p> <p>&nbsp;</p> <p>&nbsp; Compile:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle compile</p> <p>&nbsp; Migrate:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; truffle migrate</p> <p>&nbsp; Test contracts: truffle test</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">会初始化一个项目，项目的</span><span style="background:#FFFFFF;">文件结构如下：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p>.</p> <p>├── contracts</p> <p>│&nbsp;&nbsp; └── Migrations.sol</p> <p>├── migrations</p> <p>│&nbsp;&nbsp; └── 1_initial_migration.js</p> <p>├── test</p> <p>├── truffle-config.js</p> <p>└── truffle.js</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><a></a><a><span style="background:#FFFFFF;">第一步</span></a><span style="background:#FFFFFF;">在工程</span><span style="color:#252525;background:#FAFAFA;">contracts&nbsp;</span><span style="color:#252525;background:#FAFAFA;">目录下</span><span style="background:#FFFFFF;">创建一个</span><span style="color:#252525;background:#FAFAFA;">Solidity&nbsp;</span><span style="background:#FFFFFF;">脚本：</span></p>
  <p align="left"><a></a><a><span style="background:#FFFFFF;">Wrestling</span></a><span style="background:#FFFFFF;">.sol</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><pre>pragma solidity ^0.4.18;</pre><pre>&nbsp;</pre><pre>/**</pre><pre>* Example script for the Ethereum development walkthrough</pre><pre>*/</pre><pre>contract Wrestling {</pre><pre>&nbsp;&nbsp;&nbsp; /**</pre><pre>&nbsp;&nbsp;&nbsp; * Our wrestlers</pre><pre>&nbsp;&nbsp;&nbsp; */</pre><pre>&nbsp;&nbsp;&nbsp; address public <a></a><a>wrestler1</a>;</pre><pre>&nbsp;&nbsp;&nbsp; address public wrestler2;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; bool public wrestler1Played;</pre><pre>&nbsp;&nbsp;&nbsp; bool public wrestler2Played;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; uint private wrestler1Deposit;</pre><pre>&nbsp;&nbsp;&nbsp; uint private wrestler2Deposit;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; bool public gameFinished;</pre><pre>&nbsp;&nbsp;&nbsp; address public theWinner;</pre><pre>&nbsp;&nbsp;&nbsp; uint gains;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; /**</pre><pre>&nbsp;&nbsp;&nbsp; * The logs that will be emitted in every step of the contract's life cycle</pre><pre>&nbsp;&nbsp;&nbsp; */</pre><pre>&nbsp;&nbsp;&nbsp; event WrestlingStartsEvent(address wrestler1, address wrestler2);</pre><pre>&nbsp;&nbsp;&nbsp; event EndOfRoundEvent(uint wrestler1Deposit, uint wrestler2Deposit);</pre><pre>&nbsp;&nbsp;&nbsp; event EndOfWrestlingEvent(address winner, uint gains);</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; /**</pre><pre>&nbsp;&nbsp;&nbsp; * The contract constructor</pre><pre>&nbsp;&nbsp;&nbsp; */</pre><pre>&nbsp;&nbsp;&nbsp; constructor() public {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1 = msg.sender;</pre><pre>&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; /**</pre><pre>&nbsp;&nbsp;&nbsp; * A second wrestler can register as an opponent</pre><pre>&nbsp;&nbsp;&nbsp; */</pre><pre>&nbsp;&nbsp;&nbsp; function registerAsAnOpponent() public {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2 == address(0));</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2 = msg.sender;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit WrestlingStartsEvent(wrestler1, wrestler2);</pre><pre>&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; /**</pre><pre>&nbsp;&nbsp;&nbsp; * Every round a player can put a sum of ether, if one of the player put in twice or</pre><pre>&nbsp;&nbsp;&nbsp; * more the money (in total) than the other did, the first wins</pre><pre>&nbsp;&nbsp;&nbsp; */</pre><pre>&nbsp;&nbsp;&nbsp; function wrestle() public payable {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(!gameFinished &amp;&amp; (msg.sender == wrestler1 || msg.sender == wrestler2));</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(msg.sender == wrestler1) {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler1Played == false);</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = true;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrestler1Deposit = wrestler1Deposit + msg.value;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(wrestler2Played == false);</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = true;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Deposit = wrestler2Deposit + msg.value;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Played &amp;&amp; wrestler2Played) {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(wrestler1Deposit &gt;= wrestler2Deposit * 2) {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler1);</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (wrestler2Deposit &gt;= wrestler1Deposit * 2) {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; endOfGame(wrestler2);</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;endOfRound();</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; function endOfRound() internal {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler1Played = false;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wrestler2Played = false;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfRoundEvent(wrestler1Deposit, wrestler2Deposit);</pre><pre>&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; function endOfGame(address winner) internal {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gameFinished = true;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; theWinner = winner;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = wrestler1Deposit + wrestler2Deposit;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; emit EndOfWrestlingEvent(winner, gains);</pre><pre>&nbsp;&nbsp;&nbsp; }</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp; /**</pre><pre>&nbsp;&nbsp;&nbsp; * The withdraw function, following the withdraw pattern shown and explained here:</pre><pre>&nbsp;&nbsp;&nbsp; * http://solidity.readthedocs.io/en/develop/common-patterns.html#withdrawal-from-contracts</pre><pre>&nbsp;&nbsp;&nbsp; */</pre><pre>&nbsp;&nbsp;&nbsp; function withdraw() public {</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; require(gameFinished &amp;&amp; theWinner == msg.sender);</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;uint amount = gains;</pre><pre>&nbsp;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gains = 0;</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg.sender.transfer(amount);</pre><pre>&nbsp;&nbsp;&nbsp; }</pre><pre>}</pre></td> 
    </tr>
   </tbody>
  </table>
  <p align="left"><a></a><a><span style="background:#FFFFFF;">Wrestling</span></a><span style="background:#FFFFFF;">实现的是一个角力的游戏，在这个游戏中，<a></a><a>每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍</a></span><span style="background:#FFFFFF;">(</span><span style="background:#FFFFFF;">总计</span><span style="background:#FFFFFF;">)</span><span style="background:#FFFFFF;">，那他就赢了。</span></p>
  <p align="left"><span style="color:#252525;background:#FAFAFA;">关于代码的解读参考</span><span style="color:#252525;background:#FAFAFA;">http://www.cocoachina.com/blockchain/20180312/22550.html</span></p>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">第二步在工程目录</span><span style="color:#252525;background:#FAFAFA;">migrations</span><span style="color:#252525;background:#FAFAFA;">创建一个部署脚本：</span></p>
  <p align="left"><span style="color:#252525;background:#FAFAFA;">2_deploy_contracts.js</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><span style="color:#252525;">const</span><span style="color:#252525;">&nbsp;</span><span style="color:#252525;">Wrestling&nbsp;=&nbsp;artifacts.require("./Wrestling.sol")</span></p> <p align="left"><span style="color:#252525;">&nbsp;</span></p> <p align="left"><span style="color:#252525;">module.exports&nbsp;=&nbsp;function(deployer)&nbsp;{</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;&nbsp;&nbsp;deployer.deploy(Wrestling);</span></p> <p align="left"><span style="color:#252525;">};</span></p></td> 
    </tr>
   </tbody>
  </table>
  <p align="left"><span style="background:#FFFFFF;">这个部署脚本的作用是导入</span><span style="color:#252525;background:#FAFAFA;">Wrestling.sol</span><span style="color:#252525;background:#FAFAFA;">然后部署到区块链中。</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <h2><span style="background:#FFFFFF;">启动</span><span style="background:#FAFAFA;">Ganache</span></h2>
  <p><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">工程创建完成后，现在通过</span><span style="background:#FFFFFF;">Ganache</span><span style="color:#252525;">创建一个虚拟的以太坊区块链。</span></p>
  <p><span style="background:#FFFFFF;">新开一个窗口执行</span><span style="background:#FFFFFF;">:</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><code><strong><span style="color:#FF0000;">$ ganache-cli&nbsp;-p&nbsp;7545</span></strong></code></p> <p>Ganache CLI v6.1.0 (ganache-core: 2.1.0)</p> <p>&nbsp;</p> <p>Available Accounts</p> <p>==================</p> <p>(0) 0x67f0c56f2ed6b635e7a4d4285615ae01b4b6d834</p> <p>(1) 0xdde20e330d5747253aa2041532b486fb425951a8</p> <p>(2) 0xecc3a4c50bce3014d11a3840d0d1dd3011cf65e8</p> <p>(3) 0x3db9dcb607a15b744affb1453ce1d36121f56a9a</p> <p>(4) 0x0f1c36775edba34f9239f6fbe3e1d071a35a80bf</p> <p>(5) 0x14156195c281babf28200aec756ce16e8794e724</p> <p>(6) 0xdb89069d044cb1f8246fad2a805b97102b05c6a5</p> <p>(7) 0xa3dfb369603aa5788626371ab022e42f98001607</p> <p>(8) 0x455bffe5cce17a3a71bfb1ef1fb74c3640f77b97</p> <p>(9) 0x82512876028923943d5e937441710d6675d573b0</p> <p>&nbsp;</p> <p>Private Keys</p> <p>==================</p> <p>(0) 5d5d0d038bbd85c1ca25768a0da88b49805dd74bbffa628cd4b0968877eb84af</p> <p>(1) ba616ed800cf1e0306ec1eaea7416d52bab5ad0dd7216a997194784461da7efe</p> <p>(2) 0f80b88a4ad72850003a8aca809932e3e27f29e2a931d900ac0cb06fc22247bd</p> <p>(3) c0cb6aecff075d9527eebb69c5389f6cfaea2a3e7120a2fb6fb4122e299dfdad</p> <p>(4) 7ea0bd30edcbe05b89553a1c7e4eb52c4ebf87f1a664202ccad7eb26e589403c</p> <p>(5) 5ff14162882f900a4c2241042b1e51c866adeb089c28e6643787ef26b43293c8</p> <p>(6) 24da6f19bfaa3de81ab1fd9b62636064282604e4fa26d6697eacfc3c9d3d9de8</p> <p>(7) 944c9ede3956b7dc55b2ece7f9506358b1d7c5e5f7275c6b11dacd5e38414c0f</p> <p>(8) 43e8c352eaafd39e7116b43aed86006141daa18c1cf7c06806c6c19cbb7be29a</p> <p>(9) bf43907fd082a64b987c00ceb9b7ae45eee08fcf96ae07d6b0260d4ec370f736</p> <p>&nbsp;</p> <p>HD Wallet</p> <p>==================</p> <p>Mnemonic:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; video march rail weapon lunch holiday organ vague food strategy gown artist</p> <p>Base HD Path:&nbsp; m/44'/60'/0'/0/{account_index}</p> <p>&nbsp;</p> <p>Listening on localhost:7545</p></td> 
    </tr>
   </tbody>
  </table>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><a></a><a>Ganache</a><span style="background:#FFFFFF;">启动成功后，会生成</span><span style="background:#FFFFFF;">10</span><span style="background:#FFFFFF;">个</span>测试账号，默认情况下，每个账户都有未锁定的<span style="background:#FFFFFF;">100</span><span style="background:#FFFFFF;">个以太币并，所以我们可以自由地从那里发送以太币</span>。最后<span style="background:#FFFFFF;">Ganache</span><span style="background:#FFFFFF;">服务监听在</span><span style="background:#FFFFFF;">localhost:7545</span><span style="background:#FFFFFF;">。</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <h2><span style="background:#FFFFFF;">编译和部署</span></h2>
  <p><span style="background:#FFFFFF;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="background:#FFFFFF;">Ganache</span><span style="background:#FFFFFF;">启动后，回到</span><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">工程目录下修改配置文件</span><span style="color:#252525;background:#FAFAFA;">truffle.js</span><span style="color:#252525;background:#FAFAFA;">和</span><span style="color:#252525;background:#FAFAFA;">truffle-config.js</span><span style="color:#252525;background:#FAFAFA;">：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><span style="color:#252525;">module.exports&nbsp;=&nbsp;{</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;//&nbsp;See&nbsp;&nbsp;&nbsp;//&nbsp;for&nbsp;more&nbsp;about&nbsp;customizing&nbsp;your&nbsp;Truffle&nbsp;configuration!</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;networks:&nbsp;{</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;&nbsp;&nbsp;development:&nbsp;{</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;"127.0.0.1",</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port:&nbsp;7545,</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;network_id:&nbsp;"*"</span><span style="color:#252525;">&nbsp;</span><span style="color:#252525;">//&nbsp;Match&nbsp;any&nbsp;network&nbsp;id</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></p> <p align="left"><span style="color:#252525;">&nbsp;&nbsp;}</span></p> <p align="left"><span style="color:#252525;">};</span></p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">简单说就是配置</span><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">工程的一个开发网络，地址是</span><span style="background:#FFFFFF;">127.0.0.1:7545</span><span style="background:#FFFFFF;">，也就是</span><a></a><a><span style="background:#FFFFFF;">Ganache</span></a><span style="background:#FFFFFF;">服务的地址。也就是说可以把工程部署到</span><span style="background:#FFFFFF;">Ganache</span><span style="background:#FFFFFF;">。</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">然后开始编译</span><span style="background:#FFFFFF;">Truffle</span><span style="background:#FFFFFF;">工程：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><code><strong><span style="color:#FF0000;">$ cd /path/to/my-dapp</span></strong></code></p> <p><code><strong><span style="color:#FF0000;">$ truffle compile</span></strong></code></p> <p><span style="color:#000000;">Compiling ./contracts/Migrations.sol...</span></p> <p><span style="color:#000000;">Compiling ./contracts/Wrestling.sol...</span></p> <p><span style="color:#000000;">Writing artifacts to ./build/contracts</span></p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">编程成功后部署到</span><span style="background:#FFFFFF;">Ganache</span><span style="background:#FFFFFF;">：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><code><strong><span style="color:#FF0000;">$ </span></strong></code><code><strong><span style="color:#FF0000;">truffle migrate --network development</span></strong></code></p> <p>Using network 'development'.</p> <p>&nbsp;</p> <p>Running migration: 1_initial_migration.js</p> <p>&nbsp; Deploying Migrations...</p> <p>&nbsp; ... 0xc278ec5575aa24a03c6c84e17c32d890ba6e748034e3d93a83c77f5082d856d7</p> <p>&nbsp; Migrations: 0xd4ec84fa50eef802535fce494a187f17beb2a642</p> <p>Saving successful migration to network...</p> <p>&nbsp; ... 0xa1ec2490cdb988259b7762bf483184f7226a4af3a57d11f660b5d1848ef9aeb0</p> <p>Saving artifacts...</p> <p>Running migration: 2_initial_migration.js</p> <p>&nbsp; Deploying Wrestling...</p> <p>&nbsp; ... 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3</p> <p>&nbsp; Wrestling: <span style="color:#FF0000;">0xb386d031d04d3cb623d6f45872203a9cb99b3e4a</span></p> <p>Saving successful migration to network...</p> <p>&nbsp; ... 0x57325073308f757f7788920795b7f3cff59c7483b71ff5319de251505b0d6b13</p> <p>Saving artifacts...</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">可以看到</span><span style="background:#FFFFFF;">Wrestling</span><span style="background:#FFFFFF;">合约的地址</span>是<span style="color:#FF0000;background:#FFFFFF;">0xb386d031d04d3cb623d6f45872203a9cb99b3e4a</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">另外在</span><span style="background:#FFFFFF;">Ganache</span><span style="background:#FFFFFF;">的日志可以看到：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p>&nbsp;</p> <p>&nbsp; Transaction: 0x802eaf5257108cdf3615b9c75903826a6223cb7ec9201d23c75f36085439d4f3</p> <p><strong><span style="color:#FF0000;">&nbsp; Contract created: 0xb386d031d04d3cb623d6f45872203a9cb99b3e4a</span></strong></p> <p><span style="color:#FF0000;">&nbsp; Gas usage: <a></a><a>708985</a></span></p> <p>&nbsp; Block Number: 3</p> <p>&nbsp; Block Time: Fri May 25 2018 17:35:22 GMT+0800 (CST)</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">这里创建</span><span style="background:#FFFFFF;">Wrestling</span><span style="background:#FFFFFF;">合约花费了</span><span style="color:#FF0000;background:#FFFFFF;">708985Gas</span></p>
  <p><span style="color:#FF0000;background:#FFFFFF;">&nbsp;</span></p>
  <h2><span style="background:#FFFFFF;">执行合约</span></h2>
  <p><span style="background:#FFFFFF;">启动</span><span style="background:#FFFFFF;"> Truffle </span><span style="background:#FFFFFF;">控制台，这会帮助我们与</span><span style="background:#FFFFFF;">ganache</span><span style="background:#FFFFFF;">的区块链进行交互：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">$ truffle console --network development</span></strong></p> <p>truffle(development)&gt;</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">然后在控制台中进行编码来实现合约的执行</span></p>
  <p align="left"><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p align="left"><span style="background:#FFFFFF;">首先选择</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">个账户作为游戏的</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">个参与者</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">&gt; &nbsp;account0 = web3.eth.accounts[0]</span></strong></p> <p>'0xe2be5aa059b3891a519f7f1e04666d05e92b1365'</p> <p><strong><span style="color:#FF0000;">&gt;&nbsp; account1 = web3.eth.accounts[1]</span></strong></p> <p>'0x726f35aa2eabc41b6cb934fb5be7719263f4fe13'</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">接着初始化一个</span><a></a><a><span style="color:#252525;background:#FAFAFA;">Wrestling</span></a><span style="background:#FFFFFF;">合约</span><span style="background:#FFFFFF;">实例</span><a></a><a><span style="color:#252525;background:#FAFAFA;">WrestlingInstance</span></a></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">&gt;&nbsp; Wrestling.deployed().then(inst&nbsp;=&gt;&nbsp;{&nbsp;WrestlingInstance&nbsp;=&nbsp;inst&nbsp;})</span></strong></p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">可以查看</span><span style="background:#FFFFFF;">WrestlingInstance</span><span style="background:#FFFFFF;">的变量</span><span style="background:#FFFFFF;">wrestler1</span><span style="background:#FFFFFF;">，</span><span style="background:#FFFFFF;">也就是选手</span><span style="background:#FFFFFF;">1</span><span style="background:#FFFFFF;">的地址，因为我们没有指定，所以默认就是</span><span style="background:#FFFFFF;">Ganache&nbsp;</span><span style="background:#FFFFFF;">生成的第一个账户，也就是</span><strong><span style="color:#FF0000;background:#FFFFFF;">account0</span></strong></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">&gt;&nbsp; <a></a><a>WrestlingInstance.wrestler1.call()</a></span></strong></p> <p>'0xe2be5aa059b3891a519f7f1e04666d05e92b1365'</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">然后我们把</span><span style="background:#FFFFFF;">account1</span><span style="background:#FFFFFF;">注册成</span><span style="color:#252525;background:#FAFAFA;">Wrestling</span><span style="background:#FFFFFF;">合约的第二个选手</span><span style="background:#FFFFFF;">2</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">&gt;&nbsp; <a></a><a>WrestlingInstance.registerAsAnOpponent({from: account1})</a></span></strong></p> <p>{ tx: '0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea',</p> <p>&nbsp; receipt: </p> <p>&nbsp;&nbsp; { transactionHash: '0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea',</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0,</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; blockHash: '0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052',</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5,</p> <p><strong><span style="color:#FF0000;">&nbsp;&nbsp;&nbsp;&nbsp; gasUsed: 43900,</span></strong></p> <p>&nbsp;&nbsp;&nbsp;&nbsp; cumulativeGasUsed: 43900,</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; contractAddress: null,</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; logs: [ [Object] ],</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; status: '0x01',</p> <p>&nbsp;&nbsp;&nbsp;&nbsp; logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000' },</p> <p>&nbsp; logs: </p> <p>&nbsp;&nbsp; [ { logIndex: 0,</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionIndex: 0,</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; transactionHash: '0x1144b68e8d19c4288ef0d20a558fd178066ec1cd38cc6610a9e16150e013d3ea',</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockHash: '0x7b36144a86ff06c56fb702a376af0bbc300e077ee09451a154b7743fa2f6e052',</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; blockNumber: 5,</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; address: '0xb386d031d04d3cb623d6f45872203a9cb99b3e4a',</p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; type: 'mined',</p> <p><strong><span style="color:#FF0000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; event: 'WrestlingStartsEvent',</span></strong></p> <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; args: [Object] } ] }</p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">从返回的结果可以看出该项交易使用了</span><span style="background:#FFFFFF;">Gas</span><span style="background:#FFFFFF;">，并且触发了</span><span style="background:#FFFFFF;">“WrestlingStartsEvent” </span><span style="background:#FFFFFF;">事件。</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">现在</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">个选手准备就绪，就可以开始游戏</span><span style="background:#FFFFFF;">: </span><span style="background:#FFFFFF;">每一轮的比赛，参与者都可以投入一笔钱，如果一个人投入的钱大于等于另一个人的两倍</span><span style="background:#FFFFFF;">(</span><span style="background:#FFFFFF;">总计</span><span style="background:#FFFFFF;">)</span><span style="background:#FFFFFF;">，那他就赢了。</span></p>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">第一轮，选手</span><span style="background:#FFFFFF;">1</span><span style="background:#FFFFFF;">出价</span><span style="background:#FFFFFF;">2 ether</span><span style="background:#FFFFFF;">，选手</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">出价</span><span style="background:#FFFFFF;">3 ether</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p><strong><span style="color:#FF0000;">&gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(2,&nbsp;"ether")})</span></strong></p> <p><strong><span style="color:#FF0000;">&gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(3,&nbsp;"ether")})</span></strong></p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">第二轮，选手</span><span style="background:#FFFFFF;">1</span><span style="background:#FFFFFF;">出价</span><span style="background:#FFFFFF;">5 ether</span><span style="background:#FFFFFF;">，选手</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">出价</span><span style="background:#FFFFFF;">20 ether</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><strong><span style="color:#FF0000;">&gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account0,&nbsp;value:&nbsp;web3.toWei(5,&nbsp;"ether")})</span></strong></p> <p align="left"><strong><span style="color:#FF0000;">&gt;&nbsp; WrestlingInstance.wrestle({from:&nbsp;account1,&nbsp;value:&nbsp;web3.toWei(20,&nbsp;"ether")})</span></strong></p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">两轮下来，选手</span><span style="background:#FFFFFF;">1</span><span style="background:#FFFFFF;">出价</span><span style="background:#FFFFFF;">7ether</span><span style="background:#FFFFFF;">，选手</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">出价</span><span style="background:#FFFFFF;">23ether</span><span style="background:#FFFFFF;">，所以选手</span><span style="background:#FFFFFF;">2</span><span style="background:#FFFFFF;">获胜，这时候获胜者可以提现：</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><strong><span style="color:#FF0000;">&gt;&nbsp; WrestlingInstance.withdraw({from: account1})</span></strong></p></td> 
    </tr>
   </tbody>
  </table>
  <p><span style="background:#FFFFFF;">&nbsp;</span></p>
  <p><span style="background:#FFFFFF;">最后查询账户余额，因为在合约执行过程中要支付</span><span style="background:#FFFFFF;">Gas</span><span style="background:#FFFFFF;">，所以账户</span><span style="background:#FFFFFF;">1</span><span style="background:#FFFFFF;">的余额是小于</span><span style="background:#FFFFFF;">107ether</span><span style="background:#FFFFFF;">的。</span></p>
  <table border="1" cellspacing="0" cellpadding="0">
   <tbody>
    <tr>
     <td valign="top"><p align="left"><strong><span style="color:#FF0000;">&gt;&nbsp; web3.eth.getBalance(account1)</span></strong></p> <p>{ [String: '106974788700000000000'] s: 1, e: 20, c: [ 1069747, 88700000000000 ]</p></td>
    </tr>
   </tbody>
  </table>
  <h1><br></h1>
  <h1>参考</h1>
  <p></p>
  <ul>
   <li>https://blog.csdn.net/m0_37722557/article/details/79899847</li>
   <li>http://xinwen.eastday.com/a/180314214918603.html?xx=1&amp;recommendtype=d</li>
   <li>http://www.cocoachina.com/blockchain/20180314/22592.html<br></li>
   <li>http://www.cocoachina.com/blockchain/20180312/22550.html<br></li>
  </ul>
  <p><br></p>
  <p></p>
  <h2 style="font-size:1.75em;color:rgb(51,51,51);font-weight:500;line-height:30px;font-family:'Helvetica Neue', STHeiti, 'Microsoft YaHei', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">作者简介</h2>
  <span style="font-size:14px;color:rgb(102,102,102);font-family:'Helvetica Neue', STHeiti, 'Microsoft YaHei', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">吴龙辉，《Kubernetes实战》作者，活跃于技术开源社区，贡献代码和撰写技术文档。&nbsp;</span>
  <br style="font-size:14px;color:rgb(102,102,102);font-family:'Helvetica Neue', STHeiti, 'Microsoft YaHei', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">
  <span style="font-size:14px;color:rgb(102,102,102);font-family:'Helvetica Neue', STHeiti, 'Microsoft YaHei', Helvetica, Arial, sans-serif;background-color:rgb(255,255,255);">邮箱：</span>
  <a href="mailto:wlh6666@qq.com" rel="nofollow" style="color:rgb(21,95,170);font-size:14px;background:rgb(255,255,255) 0px 0px;font-family:'Helvetica Neue', STHeiti, 'Microsoft YaHei', Helvetica, Arial, sans-serif;">wlh6666@qq.com</a>
  <br> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wlhdo71920145/article/details/80476257,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wlhdo71920145/article/details/80476257,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
