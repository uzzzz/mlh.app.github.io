<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>基于Chromium工程的BitcoinCore移植 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="基于Chromium工程的BitcoinCore移植" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="移植目标 1、将BitcoinCore核心代码移植到Windows系统。 2、将BitcoinCore代码与Chromium浏览器工程融合，实现gyp编译。 3、浏览器启动后自动加载BitcoinCore服务。 BitcoinCore依赖关系简述 BitcoinCore工程依赖于： 1、leveldb——已存在于bitcoincore源码工程中。 2、secp256k1——已存在于bitcoincore源码工程中。 3、univalue——已存在于bitcoincore源码工程中。 4、libevent——从http://libevent.org/下载源码。 5、libboost——采用下载静态库方式，直接链接到工程。 从https://dl.bintray.com/boostorg/release/1.67.0/binaries/下载编译过的工程（头文件和静态库）。 6、openssl——由于openssl工程在Windows系统编译配置较麻烦，且Chromium工程预置了与其功能相近的boringssl（源码存在于Chromium工程的third_party/boringssl中）及crypto模块，故将BitcoinCore使用openssl的代码适配到crypto和boringssl模块。 源码工程准备 一、配置Chromium源码工程 配置方法不在本文描述范围，请参考《Windows系统下Chromium/content shell工程的编译》。 二、下载BitcoinCore源码 下载地址https://github.com/bitcoin/bitcoin，可使用git或直接下载源码包方式下载。代码目录为： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其中，有效源码在src子目录下（如下图）。移植时，也是将src目录的源码文件放置至Chromium工程中编译。 三、依赖工程的编译及整合 1、libboost 本文采用下载prebuilt库方式（如果Windows系统编译libboost库则推荐采用交叉编译），下载地址为https://dl.bintray.com/boostorg/release/1.67.0/binaries/。本文使用libboost1.67.0版本，解压后的目录结构如下图所示。 其中，boost目录为头文件路径，lib32-msvc-12.0为对应Windows系统的libboost库（静态库和动态库均有）。 本文编译bitcoincore时采用静态链接，因此使用其中的*.lib。 将此两个目录拷贝到bitcoincore源码工程下（在bitcoincore源码目录下新建boost目录存放此两个目录内容），且为命名便利，将lib32-msvc-12.0改为libs。 2、libevent 从http://libevent.org/下载源码，本文下载的是2.0.22稳定版。通过命令行启动 最终生成三个静态库文件，参见下图。 3、bitcoincore 1）在Chromium工程中创建bitcoin目录（假设创建于chromium/src/content/shell路径下）。 2）将bitcoincore源码中src下源码文件拷贝到新创建的bitcoin目录下。 3）在bitcoincore路径下创建boost目录。将libboost源码中的boost目录中内容（头文件），以及lib32-msvc-12.0目录中的静态库文件拷贝到bitcoin/boost目录中，参见下图所示。其中，libs中的文件即为lib32-msvc-12.0中内容。 4）在bitcoincore路径下创建libevent目录。将libevent工程中文件和生成的静态库文件拷贝到此路径下，参见下图所示。其中，lib目录存在的即为2步骤中生成的*.lib文件。 5）最终生成的bitcoin源码工程结构如下图所示，在原bitcoincore基础上多出了boost和libevent目录。 &nbsp; &nbsp; 本文未计划构建完整的bitcoincore（包括bitcoind、bitcoin-cli、bitcoin-tx、bitcoin-qt），只构建bitcoind服务，因此原bitcoincore源码中的wallet、qt、interface、bench、test、zmq子目录和bitcoin-tx、bitcoin-cli等文件不参与编译，未纳入到工程中。 编写编译脚本（gyp） 由于本文中的Chromium工程构建系统为gyp，因此需要针对参与编译的bitcoin工程编写相应的gyp文件，命名为bitcoin.gyp。共计由7部分组成： 1、target_name 工程生成目标名称，本文指定target_name参数为bitcoin_lib，即&#39;target_name&#39;: &#39;bitcoin_lib&#39;。名称可自主定义。 2、type &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 构建类型，指定静态库，即&#39;type&#39;: &#39;static_library&#39;。本文计划将bitcoind服务生成为静态库，并最终链接到可执行文件中（本文移植验证目标为content shell可执行程序）。 3、dependencies &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 工程依赖，本bitcoin工程为定制工程，会使用原Chromium工程的子项目，如加密库、ssl和log系统。因此依赖如下三个子项目。 4、include_dirs &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 头文件目录清单。根据对内、对外的头文件依赖情况，头文件目录清单如下。 5、sources &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 参与编译源码文件清单。包括： 1）compat目录文件 &#39;shell/bitcoin/compat/strnlen.cpp&#39; 2）crypto目录文件 3）secp256k1目录文件 &#39;shell/bitcoin/secp256k1/src/secp256k1.c&#39; 4）support目录文件 &nbsp; 5）primitives目录文件 &nbsp; 6）consensus目录文件 7）univalue目录文件 &nbsp; 8）policy目录文件 9）leveldb目录文件 10）script目录文件 11）rpc目录文件 12）bitcoin主目录下文件 除了bitcoin-clic.cpp、bitcoin-tx.cpp、span.h（vs对模板支持不完整，引入该文件会导致编译错误，后文会对调用Span模板代码进行改写）以外的其它cpp文件。 6、msvs_settings等 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译选项设置，需启动RTTI，否则会导致编译出错。并禁止一些warning，避免因warning的编译中断。 若编译过程中仍然报RTTI相关错误，可将chromium/src/build/common.gypi中的RuntimeTypeInfo置为true。 7、defines &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译过程中的宏定义。 加入Chromium编译系统 由于本文计划将bitcoin服务加入到content shell项目中，因此bitcoin.gyp放置在chromium/src/content/路径下。 一、bitcoind服务入口定制 由于原bitcoind本身是可执行文件，当嵌入到Chromium系统中，需要对bitcoind.cpp文件进行修改。将main修改为bitcoindStart。 并新建名为bitcoind.h文件，定义bitcoindStart()，以便content shell合适位置调用此函数时包含此头文件。 二、content shell编译配置文件定制 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将bitcoin子项目相关信息加入到content shell配置文件（chromium/src/content/content_shell.gypi）中，使得编译可生效。主要加入到如下单元中： 1、dependencies和include_dirs修改 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 增加对bitcoin项目目标和头文件路径依赖，如下图所示。 2、添加静态库依赖 主要增加bitcoin所依赖的boost、libevent静态库及路径，以保证链接时能正常通过。其中libboost和libevent路径加入到variables变量中。 Bitcoin代码定制 除上述的编译配置外，若要bitcoin通过VS2012或其它VS编译环境成功，还需要对代码进行定制。 一、constexpr编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS不支持此关键字，因此部分引用此关键字的代码会编译失败。遇到此情况，可在编译报错源码前部增加如下代码。 二、__func__和_Exit编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 该关键字在VS编译环境中无法识别，可用__FUNCTION__代替。 _Exit可替换为_exit。 三、ssize_t编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到提示ssize_t无法识别，则增加如下声明。 四、宽字符报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译如env_win.cc源码时可能提示宽字符报错，可采用Chromium工程中的字符串转换函数进行宽字符抓换。首先在编译报错的源码中增加#include &lt;base/strings/utf_string_conversions.h&gt;，而后修改报错代码，参考如下： 五、std::numeric_limits&lt;int64_t&gt;::max()编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到关于max或min报错，则修改成VS可支持宏，如下。 六、“带有类内初始值设定项的静态数据成员必须具有不可变的常量整型”编译报错 诸如fees.h定义了常量静态变量的初始化。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将.h中的初始化去掉，如下： 增加到相应的.cpp文件中统一初始化。 七、std::atomic_*类型编译报错 VS2012不支持std::atomic_bool或std::atomic_int类型，修改为std::atomic&lt;bool&gt;即可。 八、span.h相关编译报错 &nbsp;&nbsp;&nbsp;&nbsp; span.h中的模板定义VS2012无法支持，因此需要改写，主要影响serialize.h。建议参照github的bitcoin早期版本修改。 九、缺省构造函数编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; net.h中的CSerializedNetMsg(CSerializedNetMsg&amp;&amp;) = default;无法被VS2012识别，可修改如下： 十、[noreturn]编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS2012无法识别noreturn关键字，诸如[[noreturn]] static void RandFailure()形式可修改为static void RandFailure()，确保编译通过。 【编译过程中的代码报错不止上述几类，需要根据具体情况进行相应修改。】 Content shell启动bitcoind服务 编译配置和代码修改定制完成后即可保证bitcoind编译链接通过，但启动bitcoind需要调用加入Chromium编译系统章节中的bitcoinStart()接口。 参考代码如下，取content shell的命令行，并将其构成启动bitcoind的参数，传入bitcoindStart()启动bitcoind服务。 可在命令行下启动content_shell.exe时将bitcoind支持的参数代入，即可在运行content shell的同时启动bitcoind。运行打印如下： &nbsp; 阅读更多" />
<meta property="og:description" content="移植目标 1、将BitcoinCore核心代码移植到Windows系统。 2、将BitcoinCore代码与Chromium浏览器工程融合，实现gyp编译。 3、浏览器启动后自动加载BitcoinCore服务。 BitcoinCore依赖关系简述 BitcoinCore工程依赖于： 1、leveldb——已存在于bitcoincore源码工程中。 2、secp256k1——已存在于bitcoincore源码工程中。 3、univalue——已存在于bitcoincore源码工程中。 4、libevent——从http://libevent.org/下载源码。 5、libboost——采用下载静态库方式，直接链接到工程。 从https://dl.bintray.com/boostorg/release/1.67.0/binaries/下载编译过的工程（头文件和静态库）。 6、openssl——由于openssl工程在Windows系统编译配置较麻烦，且Chromium工程预置了与其功能相近的boringssl（源码存在于Chromium工程的third_party/boringssl中）及crypto模块，故将BitcoinCore使用openssl的代码适配到crypto和boringssl模块。 源码工程准备 一、配置Chromium源码工程 配置方法不在本文描述范围，请参考《Windows系统下Chromium/content shell工程的编译》。 二、下载BitcoinCore源码 下载地址https://github.com/bitcoin/bitcoin，可使用git或直接下载源码包方式下载。代码目录为： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其中，有效源码在src子目录下（如下图）。移植时，也是将src目录的源码文件放置至Chromium工程中编译。 三、依赖工程的编译及整合 1、libboost 本文采用下载prebuilt库方式（如果Windows系统编译libboost库则推荐采用交叉编译），下载地址为https://dl.bintray.com/boostorg/release/1.67.0/binaries/。本文使用libboost1.67.0版本，解压后的目录结构如下图所示。 其中，boost目录为头文件路径，lib32-msvc-12.0为对应Windows系统的libboost库（静态库和动态库均有）。 本文编译bitcoincore时采用静态链接，因此使用其中的*.lib。 将此两个目录拷贝到bitcoincore源码工程下（在bitcoincore源码目录下新建boost目录存放此两个目录内容），且为命名便利，将lib32-msvc-12.0改为libs。 2、libevent 从http://libevent.org/下载源码，本文下载的是2.0.22稳定版。通过命令行启动 最终生成三个静态库文件，参见下图。 3、bitcoincore 1）在Chromium工程中创建bitcoin目录（假设创建于chromium/src/content/shell路径下）。 2）将bitcoincore源码中src下源码文件拷贝到新创建的bitcoin目录下。 3）在bitcoincore路径下创建boost目录。将libboost源码中的boost目录中内容（头文件），以及lib32-msvc-12.0目录中的静态库文件拷贝到bitcoin/boost目录中，参见下图所示。其中，libs中的文件即为lib32-msvc-12.0中内容。 4）在bitcoincore路径下创建libevent目录。将libevent工程中文件和生成的静态库文件拷贝到此路径下，参见下图所示。其中，lib目录存在的即为2步骤中生成的*.lib文件。 5）最终生成的bitcoin源码工程结构如下图所示，在原bitcoincore基础上多出了boost和libevent目录。 &nbsp; &nbsp; 本文未计划构建完整的bitcoincore（包括bitcoind、bitcoin-cli、bitcoin-tx、bitcoin-qt），只构建bitcoind服务，因此原bitcoincore源码中的wallet、qt、interface、bench、test、zmq子目录和bitcoin-tx、bitcoin-cli等文件不参与编译，未纳入到工程中。 编写编译脚本（gyp） 由于本文中的Chromium工程构建系统为gyp，因此需要针对参与编译的bitcoin工程编写相应的gyp文件，命名为bitcoin.gyp。共计由7部分组成： 1、target_name 工程生成目标名称，本文指定target_name参数为bitcoin_lib，即&#39;target_name&#39;: &#39;bitcoin_lib&#39;。名称可自主定义。 2、type &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 构建类型，指定静态库，即&#39;type&#39;: &#39;static_library&#39;。本文计划将bitcoind服务生成为静态库，并最终链接到可执行文件中（本文移植验证目标为content shell可执行程序）。 3、dependencies &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 工程依赖，本bitcoin工程为定制工程，会使用原Chromium工程的子项目，如加密库、ssl和log系统。因此依赖如下三个子项目。 4、include_dirs &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 头文件目录清单。根据对内、对外的头文件依赖情况，头文件目录清单如下。 5、sources &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 参与编译源码文件清单。包括： 1）compat目录文件 &#39;shell/bitcoin/compat/strnlen.cpp&#39; 2）crypto目录文件 3）secp256k1目录文件 &#39;shell/bitcoin/secp256k1/src/secp256k1.c&#39; 4）support目录文件 &nbsp; 5）primitives目录文件 &nbsp; 6）consensus目录文件 7）univalue目录文件 &nbsp; 8）policy目录文件 9）leveldb目录文件 10）script目录文件 11）rpc目录文件 12）bitcoin主目录下文件 除了bitcoin-clic.cpp、bitcoin-tx.cpp、span.h（vs对模板支持不完整，引入该文件会导致编译错误，后文会对调用Span模板代码进行改写）以外的其它cpp文件。 6、msvs_settings等 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译选项设置，需启动RTTI，否则会导致编译出错。并禁止一些warning，避免因warning的编译中断。 若编译过程中仍然报RTTI相关错误，可将chromium/src/build/common.gypi中的RuntimeTypeInfo置为true。 7、defines &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译过程中的宏定义。 加入Chromium编译系统 由于本文计划将bitcoin服务加入到content shell项目中，因此bitcoin.gyp放置在chromium/src/content/路径下。 一、bitcoind服务入口定制 由于原bitcoind本身是可执行文件，当嵌入到Chromium系统中，需要对bitcoind.cpp文件进行修改。将main修改为bitcoindStart。 并新建名为bitcoind.h文件，定义bitcoindStart()，以便content shell合适位置调用此函数时包含此头文件。 二、content shell编译配置文件定制 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将bitcoin子项目相关信息加入到content shell配置文件（chromium/src/content/content_shell.gypi）中，使得编译可生效。主要加入到如下单元中： 1、dependencies和include_dirs修改 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 增加对bitcoin项目目标和头文件路径依赖，如下图所示。 2、添加静态库依赖 主要增加bitcoin所依赖的boost、libevent静态库及路径，以保证链接时能正常通过。其中libboost和libevent路径加入到variables变量中。 Bitcoin代码定制 除上述的编译配置外，若要bitcoin通过VS2012或其它VS编译环境成功，还需要对代码进行定制。 一、constexpr编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS不支持此关键字，因此部分引用此关键字的代码会编译失败。遇到此情况，可在编译报错源码前部增加如下代码。 二、__func__和_Exit编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 该关键字在VS编译环境中无法识别，可用__FUNCTION__代替。 _Exit可替换为_exit。 三、ssize_t编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到提示ssize_t无法识别，则增加如下声明。 四、宽字符报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译如env_win.cc源码时可能提示宽字符报错，可采用Chromium工程中的字符串转换函数进行宽字符抓换。首先在编译报错的源码中增加#include &lt;base/strings/utf_string_conversions.h&gt;，而后修改报错代码，参考如下： 五、std::numeric_limits&lt;int64_t&gt;::max()编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到关于max或min报错，则修改成VS可支持宏，如下。 六、“带有类内初始值设定项的静态数据成员必须具有不可变的常量整型”编译报错 诸如fees.h定义了常量静态变量的初始化。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将.h中的初始化去掉，如下： 增加到相应的.cpp文件中统一初始化。 七、std::atomic_*类型编译报错 VS2012不支持std::atomic_bool或std::atomic_int类型，修改为std::atomic&lt;bool&gt;即可。 八、span.h相关编译报错 &nbsp;&nbsp;&nbsp;&nbsp; span.h中的模板定义VS2012无法支持，因此需要改写，主要影响serialize.h。建议参照github的bitcoin早期版本修改。 九、缺省构造函数编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; net.h中的CSerializedNetMsg(CSerializedNetMsg&amp;&amp;) = default;无法被VS2012识别，可修改如下： 十、[noreturn]编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS2012无法识别noreturn关键字，诸如[[noreturn]] static void RandFailure()形式可修改为static void RandFailure()，确保编译通过。 【编译过程中的代码报错不止上述几类，需要根据具体情况进行相应修改。】 Content shell启动bitcoind服务 编译配置和代码修改定制完成后即可保证bitcoind编译链接通过，但启动bitcoind需要调用加入Chromium编译系统章节中的bitcoinStart()接口。 参考代码如下，取content shell的命令行，并将其构成启动bitcoind的参数，传入bitcoindStart()启动bitcoind服务。 可在命令行下启动content_shell.exe时将bitcoind支持的参数代入，即可在运行content shell的同时启动bitcoind。运行打印如下： &nbsp; 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/07/18/f2d1fb3f680517fea2882e0fbaddbfa6.html" />
<meta property="og:url" content="https://mlh.app/2018/07/18/f2d1fb3f680517fea2882e0fbaddbfa6.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-18T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"移植目标 1、将BitcoinCore核心代码移植到Windows系统。 2、将BitcoinCore代码与Chromium浏览器工程融合，实现gyp编译。 3、浏览器启动后自动加载BitcoinCore服务。 BitcoinCore依赖关系简述 BitcoinCore工程依赖于： 1、leveldb——已存在于bitcoincore源码工程中。 2、secp256k1——已存在于bitcoincore源码工程中。 3、univalue——已存在于bitcoincore源码工程中。 4、libevent——从http://libevent.org/下载源码。 5、libboost——采用下载静态库方式，直接链接到工程。 从https://dl.bintray.com/boostorg/release/1.67.0/binaries/下载编译过的工程（头文件和静态库）。 6、openssl——由于openssl工程在Windows系统编译配置较麻烦，且Chromium工程预置了与其功能相近的boringssl（源码存在于Chromium工程的third_party/boringssl中）及crypto模块，故将BitcoinCore使用openssl的代码适配到crypto和boringssl模块。 源码工程准备 一、配置Chromium源码工程 配置方法不在本文描述范围，请参考《Windows系统下Chromium/content shell工程的编译》。 二、下载BitcoinCore源码 下载地址https://github.com/bitcoin/bitcoin，可使用git或直接下载源码包方式下载。代码目录为： &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其中，有效源码在src子目录下（如下图）。移植时，也是将src目录的源码文件放置至Chromium工程中编译。 三、依赖工程的编译及整合 1、libboost 本文采用下载prebuilt库方式（如果Windows系统编译libboost库则推荐采用交叉编译），下载地址为https://dl.bintray.com/boostorg/release/1.67.0/binaries/。本文使用libboost1.67.0版本，解压后的目录结构如下图所示。 其中，boost目录为头文件路径，lib32-msvc-12.0为对应Windows系统的libboost库（静态库和动态库均有）。 本文编译bitcoincore时采用静态链接，因此使用其中的*.lib。 将此两个目录拷贝到bitcoincore源码工程下（在bitcoincore源码目录下新建boost目录存放此两个目录内容），且为命名便利，将lib32-msvc-12.0改为libs。 2、libevent 从http://libevent.org/下载源码，本文下载的是2.0.22稳定版。通过命令行启动 最终生成三个静态库文件，参见下图。 3、bitcoincore 1）在Chromium工程中创建bitcoin目录（假设创建于chromium/src/content/shell路径下）。 2）将bitcoincore源码中src下源码文件拷贝到新创建的bitcoin目录下。 3）在bitcoincore路径下创建boost目录。将libboost源码中的boost目录中内容（头文件），以及lib32-msvc-12.0目录中的静态库文件拷贝到bitcoin/boost目录中，参见下图所示。其中，libs中的文件即为lib32-msvc-12.0中内容。 4）在bitcoincore路径下创建libevent目录。将libevent工程中文件和生成的静态库文件拷贝到此路径下，参见下图所示。其中，lib目录存在的即为2步骤中生成的*.lib文件。 5）最终生成的bitcoin源码工程结构如下图所示，在原bitcoincore基础上多出了boost和libevent目录。 &nbsp; &nbsp; 本文未计划构建完整的bitcoincore（包括bitcoind、bitcoin-cli、bitcoin-tx、bitcoin-qt），只构建bitcoind服务，因此原bitcoincore源码中的wallet、qt、interface、bench、test、zmq子目录和bitcoin-tx、bitcoin-cli等文件不参与编译，未纳入到工程中。 编写编译脚本（gyp） 由于本文中的Chromium工程构建系统为gyp，因此需要针对参与编译的bitcoin工程编写相应的gyp文件，命名为bitcoin.gyp。共计由7部分组成： 1、target_name 工程生成目标名称，本文指定target_name参数为bitcoin_lib，即&#39;target_name&#39;: &#39;bitcoin_lib&#39;。名称可自主定义。 2、type &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 构建类型，指定静态库，即&#39;type&#39;: &#39;static_library&#39;。本文计划将bitcoind服务生成为静态库，并最终链接到可执行文件中（本文移植验证目标为content shell可执行程序）。 3、dependencies &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 工程依赖，本bitcoin工程为定制工程，会使用原Chromium工程的子项目，如加密库、ssl和log系统。因此依赖如下三个子项目。 4、include_dirs &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 头文件目录清单。根据对内、对外的头文件依赖情况，头文件目录清单如下。 5、sources &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 参与编译源码文件清单。包括： 1）compat目录文件 &#39;shell/bitcoin/compat/strnlen.cpp&#39; 2）crypto目录文件 3）secp256k1目录文件 &#39;shell/bitcoin/secp256k1/src/secp256k1.c&#39; 4）support目录文件 &nbsp; 5）primitives目录文件 &nbsp; 6）consensus目录文件 7）univalue目录文件 &nbsp; 8）policy目录文件 9）leveldb目录文件 10）script目录文件 11）rpc目录文件 12）bitcoin主目录下文件 除了bitcoin-clic.cpp、bitcoin-tx.cpp、span.h（vs对模板支持不完整，引入该文件会导致编译错误，后文会对调用Span模板代码进行改写）以外的其它cpp文件。 6、msvs_settings等 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译选项设置，需启动RTTI，否则会导致编译出错。并禁止一些warning，避免因warning的编译中断。 若编译过程中仍然报RTTI相关错误，可将chromium/src/build/common.gypi中的RuntimeTypeInfo置为true。 7、defines &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译过程中的宏定义。 加入Chromium编译系统 由于本文计划将bitcoin服务加入到content shell项目中，因此bitcoin.gyp放置在chromium/src/content/路径下。 一、bitcoind服务入口定制 由于原bitcoind本身是可执行文件，当嵌入到Chromium系统中，需要对bitcoind.cpp文件进行修改。将main修改为bitcoindStart。 并新建名为bitcoind.h文件，定义bitcoindStart()，以便content shell合适位置调用此函数时包含此头文件。 二、content shell编译配置文件定制 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将bitcoin子项目相关信息加入到content shell配置文件（chromium/src/content/content_shell.gypi）中，使得编译可生效。主要加入到如下单元中： 1、dependencies和include_dirs修改 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 增加对bitcoin项目目标和头文件路径依赖，如下图所示。 2、添加静态库依赖 主要增加bitcoin所依赖的boost、libevent静态库及路径，以保证链接时能正常通过。其中libboost和libevent路径加入到variables变量中。 Bitcoin代码定制 除上述的编译配置外，若要bitcoin通过VS2012或其它VS编译环境成功，还需要对代码进行定制。 一、constexpr编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS不支持此关键字，因此部分引用此关键字的代码会编译失败。遇到此情况，可在编译报错源码前部增加如下代码。 二、__func__和_Exit编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 该关键字在VS编译环境中无法识别，可用__FUNCTION__代替。 _Exit可替换为_exit。 三、ssize_t编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到提示ssize_t无法识别，则增加如下声明。 四、宽字符报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译如env_win.cc源码时可能提示宽字符报错，可采用Chromium工程中的字符串转换函数进行宽字符抓换。首先在编译报错的源码中增加#include &lt;base/strings/utf_string_conversions.h&gt;，而后修改报错代码，参考如下： 五、std::numeric_limits&lt;int64_t&gt;::max()编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到关于max或min报错，则修改成VS可支持宏，如下。 六、“带有类内初始值设定项的静态数据成员必须具有不可变的常量整型”编译报错 诸如fees.h定义了常量静态变量的初始化。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将.h中的初始化去掉，如下： 增加到相应的.cpp文件中统一初始化。 七、std::atomic_*类型编译报错 VS2012不支持std::atomic_bool或std::atomic_int类型，修改为std::atomic&lt;bool&gt;即可。 八、span.h相关编译报错 &nbsp;&nbsp;&nbsp;&nbsp; span.h中的模板定义VS2012无法支持，因此需要改写，主要影响serialize.h。建议参照github的bitcoin早期版本修改。 九、缺省构造函数编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; net.h中的CSerializedNetMsg(CSerializedNetMsg&amp;&amp;) = default;无法被VS2012识别，可修改如下： 十、[noreturn]编译报错 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS2012无法识别noreturn关键字，诸如[[noreturn]] static void RandFailure()形式可修改为static void RandFailure()，确保编译通过。 【编译过程中的代码报错不止上述几类，需要根据具体情况进行相应修改。】 Content shell启动bitcoind服务 编译配置和代码修改定制完成后即可保证bitcoind编译链接通过，但启动bitcoind需要调用加入Chromium编译系统章节中的bitcoinStart()接口。 参考代码如下，取content shell的命令行，并将其构成启动bitcoind的参数，传入bitcoindStart()启动bitcoind服务。 可在命令行下启动content_shell.exe时将bitcoind支持的参数代入，即可在运行content shell的同时启动bitcoind。运行打印如下： &nbsp; 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/07/18/f2d1fb3f680517fea2882e0fbaddbfa6.html","headline":"基于Chromium工程的BitcoinCore移植","dateModified":"2018-07-18T00:00:00+08:00","datePublished":"2018-07-18T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/07/18/f2d1fb3f680517fea2882e0fbaddbfa6.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>基于Chromium工程的BitcoinCore移植</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702224">移植目标</a></h1> 
  <p style="margin-left:0cm;">1、将BitcoinCore核心代码移植到Windows系统。</p> 
  <p style="margin-left:0cm;">2、将BitcoinCore代码与Chromium浏览器工程融合，实现gyp编译。</p> 
  <p style="margin-left:0cm;">3、浏览器启动后自动加载BitcoinCore服务。</p> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702225">BitcoinCore</a>依赖关系简述</h1> 
  <p style="margin-left:0cm;">BitcoinCore工程依赖于：</p> 
  <p style="margin-left:0cm;">1、leveldb——已存在于bitcoincore源码工程中。</p> 
  <p style="margin-left:0cm;">2、secp256k1——已存在于bitcoincore源码工程中。</p> 
  <p style="margin-left:0cm;">3、univalue——已存在于bitcoincore源码工程中。</p> 
  <p style="margin-left:0cm;">4、libevent——从<u><a href="http://libevent.org/" rel="nofollow">http://libevent.org/</a></u>下载源码。</p> 
  <p style="margin-left:0cm;">5、libboost——采用下载静态库方式，直接链接到工程。</p> 
  <p style="margin-left:0cm;">从<u><a href="https://dl.bintray.com/boostorg/release/1.67.0/binaries/" rel="nofollow">https://dl.bintray.com/boostorg/release/1.67.0/binaries/</a></u>下载编译过的工程（头文件和静态库）。</p> 
  <p style="margin-left:0cm;">6、openssl——由于openssl工程在Windows系统编译配置较麻烦，且Chromium工程预置了与其功能相近的boringssl（源码存在于Chromium工程的third_party/boringssl中）及crypto模块，故将BitcoinCore使用openssl的代码适配到crypto和boringssl模块。</p> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702226">源码工程准备</a></h1> 
  <p style="margin-left:0cm;"><strong>一、配置Chromium源码工程</strong></p> 
  <p style="margin-left:0cm;">配置方法不在本文描述范围，请参考《Windows系统下Chromium/content shell工程的编译》。</p> 
  <p style="margin-left:0cm;"><strong>二、下载BitcoinCore源码</strong></p> 
  <p style="margin-left:0cm;">下载地址<u><a href="https://github.com/bitcoin/bitcoin" rel="nofollow">https://github.com/bitcoin/bitcoin</a></u>，可使用git或直接下载源码包方式下载。代码目录为：</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718183716250?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 其中，有效源码在src子目录下（如下图）。移植时，也是将src目录的源码文件放置至Chromium工程中编译。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718183752731?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>三、依赖工程的编译及整合</strong></p> 
  <p style="margin-left:0cm;">1、libboost</p> 
  <p style="margin-left:0cm;">本文采用下载prebuilt库方式（如果Windows系统编译libboost库则推荐采用交叉编译），下载地址为<u><a href="https://dl.bintray.com/boostorg/release/1.67.0/binaries/%E3%80%82%E6%9C%AC%E6%96%87%E4%BD%BF%E7%94%A8libboost1.67.0" rel="nofollow">https://dl.bintray.com/boostorg/release/1.67.0/binaries/。本文使用libboost1.67.0</a></u>版本，解压后的目录结构如下图所示。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718183838755?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">其中，boost目录为头文件路径，lib32-msvc-12.0为对应Windows系统的libboost库（静态库和动态库均有）。</p> 
  <p style="margin-left:0cm;">本文编译bitcoincore时采用静态链接，因此使用其中的*.lib。</p> 
  <p style="margin-left:0cm;">将此两个目录拷贝到bitcoincore源码工程下（在bitcoincore源码目录下新建boost目录存放此两个目录内容），且为命名便利，将lib32-msvc-12.0改为libs。</p> 
  <p style="margin-left:0cm;">2、libevent</p> 
  <p style="margin-left:0cm;">从<u>http://libevent.org/</u>下载源码，本文下载的是2.0.22稳定版。通过命令行启动</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718183933751?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">最终生成三个静态库文件，参见下图。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718184005684?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">3、bitcoincore</p> 
  <p style="margin-left:0cm;">1）在Chromium工程中创建bitcoin目录（假设创建于chromium/src/content/shell路径下）。</p> 
  <p style="margin-left:0cm;">2）将bitcoincore源码中src下源码文件拷贝到新创建的bitcoin目录下。</p> 
  <p style="margin-left:0cm;">3）在bitcoincore路径下创建boost目录。将libboost源码中的boost目录中内容（头文件），以及lib32-msvc-12.0目录中的静态库文件拷贝到bitcoin/boost目录中，参见下图所示。其中，libs中的文件即为lib32-msvc-12.0中内容。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718184035619?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">4）在bitcoincore路径下创建libevent目录。将libevent工程中文件和生成的静态库文件拷贝到此路径下，参见下图所示。其中，lib目录存在的即为2步骤中生成的*.lib文件。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718184110440?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">5）最终生成的bitcoin源码工程结构如下图所示，在原bitcoincore基础上多出了boost和libevent目录。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018071818414879?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp; &nbsp; 本文未计划构建完整的bitcoincore（包括bitcoind、bitcoin-cli、bitcoin-tx、bitcoin-qt），只构建bitcoind服务，因此原bitcoincore源码中的wallet、qt、interface、bench、test、zmq子目录和bitcoin-tx、bitcoin-cli等文件不参与编译，未纳入到工程中。</p> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702227">编写编译脚本（gyp）</a></h1> 
  <p style="margin-left:0cm;">由于本文中的Chromium工程构建系统为gyp，因此需要针对参与编译的bitcoin工程编写相应的gyp文件，命名为bitcoin.gyp。共计由7部分组成：</p> 
  <p style="margin-left:0cm;">1、target_name</p> 
  <p style="margin-left:0cm;">工程生成目标名称，本文指定target_name参数为bitcoin_lib，即'target_name': 'bitcoin_lib'。名称可自主定义。</p> 
  <p style="margin-left:0cm;">2、type</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 构建类型，指定静态库，即'type': 'static_library'。本文计划将bitcoind服务生成为静态库，并最终链接到可执行文件中（本文移植验证目标为content shell可执行程序）。</p> 
  <p style="margin-left:0cm;">3、dependencies</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 工程依赖，本bitcoin工程为定制工程，会使用原Chromium工程的子项目，如加密库、ssl和log系统。因此依赖如下三个子项目。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193737196?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">4、include_dirs</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 头文件目录清单。根据对内、对外的头文件依赖情况，头文件目录清单如下。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193756751?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">5、sources</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 参与编译源码文件清单。包括：</p> 
  <p style="margin-left:0cm;">1）compat目录文件</p> 
  <p style="margin-left:0cm;">'shell/bitcoin/compat/strnlen.cpp'</p> 
  <p style="margin-left:0cm;">2）crypto目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825323?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">3）secp256k1目录文件</p> 
  <p style="margin-left:0cm;">'shell/bitcoin/secp256k1/src/secp256k1.c'</p> 
  <p style="margin-left:0cm;">4）support目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193904715?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp;</p> 
  <p style="margin-left:0cm;">5）primitives目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193916134?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp;</p> 
  <p style="margin-left:0cm;">6）consensus目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825399?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">7）univalue目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193942411?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp;</p> 
  <p style="margin-left:0cm;">8）policy目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825418?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">9）leveldb目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825672?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825697?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">10）script目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825656?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">11）rpc目录文件</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718193825730?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">12）bitcoin主目录下文件</p> 
  <p style="margin-left:0cm;">除了bitcoin-clic.cpp、bitcoin-tx.cpp、span.h（vs对模板支持不完整，引入该文件会导致编译错误，后文会对调用Span模板代码进行改写）以外的其它cpp文件。</p> 
  <p style="margin-left:0cm;">6、msvs_settings等</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译选项设置，需启动RTTI，否则会导致编译出错。并禁止一些warning，避免因warning的编译中断。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194050322?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">若编译过程中仍然报RTTI相关错误，可将chromium/src/build/common.gypi中的RuntimeTypeInfo置为true。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194106433?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">7、defines</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译过程中的宏定义。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194131344?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702228">加入Chromium编译系统</a></h1> 
  <p style="margin-left:0cm;">由于本文计划将bitcoin服务加入到content shell项目中，因此bitcoin.gyp放置在chromium/src/content/路径下。</p> 
  <p style="margin-left:0cm;"><strong>一、bitcoind服务入口定制</strong></p> 
  <p style="margin-left:0cm;">由于原bitcoind本身是可执行文件，当嵌入到Chromium系统中，需要对bitcoind.cpp文件进行修改。将main修改为bitcoindStart。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194148772?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">并新建名为bitcoind.h文件，定义bitcoindStart()，以便content shell合适位置调用此函数时包含此头文件。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194207616?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>二、content shell编译配置文件定制</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将bitcoin子项目相关信息加入到content shell配置文件（chromium/src/content/content_shell.gypi）中，使得编译可生效。主要加入到如下单元中：</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194221332?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">1、dependencies和include_dirs修改</p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 增加对bitcoin项目目标和头文件路径依赖，如下图所示。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194237519?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">2、添加静态库依赖</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194250711?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">主要增加bitcoin所依赖的boost、libevent静态库及路径，以保证链接时能正常通过。其中libboost和libevent路径加入到variables变量中。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194306319?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702229">Bitcoin</a>代码定制</h1> 
  <p style="margin-left:0cm;">除上述的编译配置外，若要bitcoin通过VS2012或其它VS编译环境成功，还需要对代码进行定制。</p> 
  <p style="margin-left:0cm;"><strong>一、constexpr编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS不支持此关键字，因此部分引用此关键字的代码会编译失败。遇到此情况，可在编译报错源码前部增加如下代码。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194317786?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>二、__func__和_Exit编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 该关键字在VS编译环境中无法识别，可用__FUNCTION__代替。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018071819433223?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">_Exit可替换为_exit。</p> 
  <p style="margin-left:0cm;"><strong>三、ssize_t编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到提示ssize_t无法识别，则增加如下声明。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194405664?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>四、宽字符报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 编译如env_win.cc源码时可能提示宽字符报错，可采用Chromium工程中的字符串转换函数进行宽字符抓换。首先在编译报错的源码中增加#include &lt;base/strings/utf_string_conversions.h&gt;，而后修改报错代码，参考如下：</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194420641?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>五、std::numeric_limits&lt;int64_t&gt;::max()编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 若遇到关于max或min报错，则修改成VS可支持宏，如下。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194443238?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>六、“带有类内初始值设定项的静态数据成员必须具有不可变的常量整型”编译报错</strong></p> 
  <p style="margin-left:0cm;">诸如fees.h定义了常量静态变量的初始化。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194457597?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 将.h中的初始化去掉，如下：</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194457711?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">增加到相应的.cpp文件中统一初始化。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194457752?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>七、std::atomic_*类型编译报错</strong></p> 
  <p style="margin-left:0cm;">VS2012不支持std::atomic_bool或std::atomic_int类型，修改为std::atomic&lt;bool&gt;即可。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018071819454354?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>八、span.h相关编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp; span.h中的模板定义VS2012无法支持，因此需要改写，主要影响serialize.h。建议参照github的bitcoin早期版本修改。</p> 
  <p style="margin-left:0cm;"><strong>九、缺省构造函数编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; net.h中的CSerializedNetMsg(CSerializedNetMsg&amp;&amp;) = default;无法被VS2012识别，可修改如下：</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194606310?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;"><strong>十、[noreturn]编译报错</strong></p> 
  <p style="margin-left:0cm;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VS2012无法识别noreturn关键字，诸如[[noreturn]] static void RandFailure()形式可修改为static void RandFailure()，确保编译通过。</p> 
  <p style="margin-left:0cm;">【编译过程中的代码报错不止上述几类，需要根据具体情况进行相应修改。】</p> 
  <h1 style="margin-left:0cm;"><a name="_Toc519702230">Content shell</a>启动bitcoind服务</h1> 
  <p style="margin-left:0cm;">编译配置和代码修改定制完成后即可保证bitcoind编译链接通过，但启动bitcoind需要调用加入Chromium编译系统章节中的bitcoinStart()接口。</p> 
  <p style="margin-left:0cm;">参考代码如下，取content shell的命令行，并将其构成启动bitcoind的参数，传入bitcoindStart()启动bitcoind服务。</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194625246?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">可在命令行下启动content_shell.exe时将bitcoind支持的参数代入，即可在运行content shell的同时启动bitcoind。运行打印如下：</p> 
  <p style="margin-left:0cm;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180718194640448?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjA4MDU2Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p style="margin-left:0cm;">&nbsp;</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/weixin_42080566/article/details/81103175,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/weixin_42080566/article/details/81103175,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
