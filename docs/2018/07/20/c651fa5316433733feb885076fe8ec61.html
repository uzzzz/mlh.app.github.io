<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>第六篇 在墨客区块链(MOAC BlockChain) 测试网搭建子链 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="第六篇 在墨客区块链(MOAC BlockChain) 测试网搭建子链" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81125954 北京时间2018年6月30日，MOAC子链正式上线公测。 北京时间2018年9月30日，MOAC发布Nuwa1.0.3，该版本目前仅用于moac testnet。 以下为MOAC&nbsp;子链公测版安装及应用教程。 &nbsp; 1.&nbsp;准备工作 从MOAC版本发布页：https://github.com/MOACChain/moac-core/releases 下载Windows版本的系统软件包nuwa1.0.3.win.zip。 该版本适用于64位Windows 7及以上系统。本文实际操作环境为：64位Windows 10&nbsp;中文版。 本文主要内容来自MOAC中文wiki。建议操作前浏览子链相关内容。网址： https://github.com/delida/MoacDocs/wiki &nbsp; 2.&nbsp;产生本地MOAC节点 解压系统软件包nuwa1.0.3.win.zip到本地硬盘。 安装节点到MOAC测试网。安装命令： D:\nuwa1.0.3\vnode&gt;moac --testnet 注意：在moac测试网，任何情形使用moac命令启动节点均需要加--testnet。 节点自动安装到目录：C:\Users\[user]\AppData\Roaming\MoacNode\testnet 墨客测试网区块高度可以通过墨客测试网区块浏览器查询。 浏览器网址：http://47.75.144.55:3000/home。 特别注意：为了完成本篇文档的所有操作，需要用以下方式启动节点： D:\nuwa1.0.3\vnode&gt;moac --testnet --rpc --rpcapi &quot;chain3,personal,mc,net,vnode&quot; --rpccorsdomain &quot;http://walletbeta.moac.io&quot; 使用该命令启动节点后，本编文档后面所用到的网页版钱包为：http://walletbeta.moac.io。 3.节点基本操作 此节内容参考文档《第三篇 墨客区块链（MOAC BlockChain）节点安装教程》。 3.1 进入console界面 系统关机或主动关闭运行中的节点后，如果需要重新启动节点，在命令行中执行： D:\nuwa1.0.3\vnode&gt;moac –testnet 命令执行后，界面一直滚屏以同步区块数据。 3.2 进入attach界面 打开另一个命令（cmd）终端，转到当前目录，在命令行中执行： D:\nuwa1.0.3\vnode&gt;moac attach 该命令依赖于节点已经启动，命令执行后不会主动滚屏，而是等待命令。 3.3 创建账号 进入MOAC console界面后，执行命令： &gt; personal.newAccount() 系统会在以下目录：C:\Users\[userName]\AppData\Roaming\MoacNode\testnet\keystore，记录一个账号文件。 请保存好该文件，并牢记密码。 3.4 挖矿 在测试网，可以尝试挖矿，用于之后操作的gas费，进入moac attach界面后： 开始挖矿，执行命令： &gt; miner.start() 停止挖矿，执行命令： &gt; miner.stop() 查看挖矿状态，执行命令： &gt;mc.mining 查看余额变动，执行命令： &gt;loadScript(&quot;mctest.js&quot;) &gt;checkBalance() &nbsp; 4.scs注册 此处内容参考中文wiki内容《SCS矿工参与方法》。 4.1 部署子链矿池 部署子链矿池智能合约，用于子链SCS节点矿工加入矿工池。 从MOAC版本发布页下载合约SubChainProtocolBase.sol。进行合约部署。 此处内容参考文档《第四篇 在墨客区块链（MOAC BlockChain）部署ERC-20合约》。 测试网部署合约使用的网页版钱包工具请登录：http://walletbeta.moac.io。 部署时选择“Sub&nbsp;Chain Protocol Base”，填入参数Protocol（POS）、Bmin(1)和protocol type（0表示pos，1表示ipfs），如图所示。 成功部署后 注意：该步骤非必须，可以直接加入测试网已经存在的矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署子链矿池。 该合约地址经测试工作正常，用户可以在后面的步骤将scs注册到moac测试网公开的合约地址。 0x55db2865e29e8a1adC54fABDA221609536DD8b90 4.2 启动SCS 在下载的节点文件中，有一个scs目录。目录下有一个配置文件userconfig.json。其中的Beneficiary为矿工收益账号。为了安全起见，建议采用与scsid不同的墨客底层账号用来获取子链的收益（scsid将会在后面讲到）。 进入目录scs\scsserver启动scs： D:\nuwa1.0.3\scs&gt;scsserver -p &quot;password&quot; 命令中：如果直接运行scsserver，则默认密码为 moacscsofflineaccountpwd，使用参数-p，则可以自己设定scs账号密码。 启动后，SCS将会在当前目录下生成一个keystore目录，并在目录中新建一个账号，这个账号就是scsid。如果想换一个scsid，则需要删除该目录中所有新内容，仅保留原来的2个文件，重新启动。 可以根据实际需要，按照以上步骤重新启动一个或多个scs。单台电脑建议启动不超过3个scs。 4.3 注册SCS 在启动scs并已经知道一个子链矿池合约地址的情况下（见4.1节），可以进行注册。 写一个scsRegister.js，代码如下。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //scs注册 console.log(&#39;SCS Register start!&#39;); var baseAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var basePasswd = &quot;password&quot;; var protocolAddr = &quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot;; var scsAddr = &quot;755a37ec5ba302cd0022af2b8e3ff97c1996601b&quot;; //不带0x开头 chain3.personal.unlockAccount(baseAddr, basePasswd,0); sendtx(baseAddr, protocolAddr, &#39;5&#39;,&#39;0x4420e486000000000000000000000000&#39; + scsAddr); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,’mc’), to: tgtaddr, gas: &quot;9000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 主要参数如下： baseAddr、basePasswd：主网的一个账户及其密码，付出本次交易的gas费及scs注册所需的押金（本例5mc）； protocolAddr：步骤4.1子链矿池合约subchainprotocolbase地址； scsAddr：步骤4.2的scsid地址，放在“…/scsserver/scskeystore”目录下； 注册mc数量，本例子中为5mc，此处必须大于矿池合约的设置值。scs提交押金越多，能参与的子链越多。 特别注意：scsAddr的地址不要加上“0x”。 在文件目录下执行该注册文件scsRegister.js： D:\nuwa1.0.3\scs&gt;node&nbsp;scsRegister.js 在等待一定时间之后（通常是母链50个block），就进入子链矿池，成为该子链的候选SCS节点。注册后，保证金会从baseAddr账号转到子链矿池合约账号。 注册时缴纳的保证金，将在SCS被选中服务子链的时候临时扣除。下图为注册两个SCS，各交2个mc保证金的情况。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 其中： Select function：选择合约功能Register； Scs-address：填入要注册的scsid； Execute from：使用有mc余额的账号，并且已经解锁，personal.unlockAccount； Send mc：提交押金，应该多于scs池子合约所要求的最少押金； 4.4 给SCS地址转账 scs在跟底层vnode通信或被调用时，tx是需要交易费的，因此需要在scsid存入1个mc作为gas费。 给scsid转账跟向普通账户转账一样。 4.5 查询SCS注册数量 如果是使用网页版钱包部署的子链矿池合约，可以直接在界面看到scs注册数量等信息。 或者，通过moac attach界面，使用合约地址查询注册scs数量 &gt; mc.getStorageAt(&quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot;,0x02) &nbsp; 5.部署Vnode矿池合约 此处内容参考中文wiki内容《代理vnode节点介绍》。 5.1 部署vnode矿池 从MOAC版本发布页下载合约VnodeProtocolBase.sol 部署时选择“Vnode&nbsp;Protocol Base”，填入参数Bmin(1)，即最少押金为1。如图所示。 成功后得到合约地址，用于后面vnode的注册。 注意：该步骤非必须，可以直接加入测试网已经存在的Vnode池子。 用户可以不必自己部署合约，在后面的步骤将Vnode节点注册到该合约地址；或者不注册vnode，直接使用该Vnode池子合约地址，里面已经注册的Vnode将会为你的子链提供服务。 0x5B43583F33214c790B8206D9B06685c49A1DB455 5.2 添加节点到vnode矿池 添加本节点到vnode矿池的代码如下vnodeRegister.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //vnode register var baseAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var basePasswd = &quot;password&quot;; var vnodeChain = &quot;0x0fB05e4a2b878855e27A7675135BecA0E257e896&quot;; var vnodeAddr = &quot;7610fd66c272332edd59a43460ad24eee1973bfe&quot;; chain3.personal.unlockAccount(baseAddr,basePasswd,0); //该步骤也可以在attach界面执行 sendtx(baseAddr, vnodeChain, &#39;2&#39;,&#39;0x32434a2e000000000000000000000000&#39; + vnodeAddr //数据1 +&#39;0000000000000000000000000000000000000000000000000000000000000040&#39;//数据2 +&#39;0000000000000000000000000000000000000000000000000000000000000013&#39;//数据3 //192.168.10.16:50062（填入本机实际IP地址值，并修改数据3和数据4） +&#39;3139322e3136382e31302e31363a353030363200000000000000000000000000&#39;);//数据4 function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;9000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 主要参数如下： baseAddr、basePasswd：Dapp用户用来发送交易前账户解锁； vnodeChain：部署VNODE-PROXY合约得到的合约地址； vnodeAddr：vnodeconfig.json的VnodeBeneficialAddress 数据1：&#39;0x32434a2e &#39;是VNODE-PROXY合约 中‘register(address vnode, string link)’通过hash算法Keccak256得到前4个字节，本例押金交2mc；本例带两个参数； 添加成功后，启动节点方式不变。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成，前提是你已经部署了自己的Vnode Proxy池子合约（也就是5.1节的步骤）。 其中： Select function：选择合约功能Register； Vnode-address：填入收益账号，一般是本地节点的挖矿账号； Link-String：本节点主机的IP地址； Send mc：提交押金，应该多于Vnode池子合约所要求的最少押金； 注意：该步骤非必须，也就是说并不是必须把本节点注册为proxy Vnode，可以直接加入测试网已经存在的Vnode矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署Vnode矿池并将本节点注册为Vnode proxy。 &nbsp; 6.部署子链合约 此处内容参考中文wiki内容《DAPP用户的参与方法》。 6.1 编译子链合约 合约可以通过多种方式编译，比如在线编译工具remix等，如果是本地命令行编译，需要安装solidity环境。 D:\scs&gt;&nbsp;solcjs --bin --abi -o bin SubChainBase.sol SubChainProtocolBase.sol SubChainBase.sol是子链合约，其中import &quot;./SubChainProtocolBase.sol&quot;; 因此要把SubChainProtocolBase.sol合约放在同一个目录下。 编译结果如果没有error，会在bin目录生成相应的*.bin和*.abi文件。 6.2 部署子链合约 部署子链合约的代码如下deploySubChain.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //deploy subChainBase chain3.personal.unlockAccount(chain3.mc.accounts[0], &#39;password&#39;,0); var proto = &quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot; ; var vnodeProtocolBaseAddr = &quot;0x0fB05e4a2b878855e27A7675135BecA0E257e896&quot; ; var min = 1 ; var max = 10 ; var thousandth = 1 ; var flushRound = 20 ; var subchainbaseContract = chain3.mc.contract([{&quot;constant&quot;:true,......,&quot;type&quot;:&quot;event&quot;}]); var subchainbase = subchainbaseContract.new( proto, vnodeProtocolBaseAddr, min, max, thousandth, flushRound, { from: chain3.mc.accounts[0], data: &#39;0x6060604052600c601555670d...708e8ee3c23da8b02d0278eb0029&#39;, gas: &#39;9000000&#39; }, function (e, contract){ console.log(e, contract); if (typeof contract.address !== &#39;undefined&#39;) { console.log(&#39;Contract mined! address: &#39; + contract.address + &#39; transactionHash: &#39; + contract.transactionHash); } }) 子链控制合约subchainbase是DAPP用户使用子链的基本合约，其提供子链运行前和运行中的一些必要接口。 通常来说，子链控制合约subchainbase需要修改相应的内容如下： 参数proto：通过官方渠道获取到，或者自己部署的子链矿池合约subchainprotocolbase的地址，复制粘贴到此变量； 参数vnodeProtocolBaseAddr：通过官方渠道获取到，或者自己部署的代理智能合约vnodeprotocolbase的地址，复制粘贴到此变量； 参数min：子链运行后需要的SCS的最小数量，建议数量为1； 参数max：子链运行后需要的SCS的最大数量，建议数量为100； 参数thousandth：千分之几，默认为1； 参数flushRound：子链刷新周期（以母链block生成数量为准），小于100的值，合约会自动置为100； 合约部署时的gas值必须为9000000； Chain3.mc.contract：其内容是6.1节编译结果的SubChainBase.abi； data：其内容是6.1节编译结果的SubChainBase.bin，前面要加”0x”。 6.3&nbsp;子链控制合约信息 部署成功后： 得到子链控制合约地址和本次交易hash。 该合约不是在网页版钱包部署的，因此不会在界面上显示，此时需要将该合约加到界面上。 点击“WATCH MOTHERCHAIN CONTRACT”按钮。 输入刚部署的合约的合约地址和JSON（就是合约的abiString），自己给合约取个名称，点击“好”，会在界面上增加该合约。之后对合约的操作跟使用网页版钱包部署成功的合约一致。 6.4 子链开放注册 通过开放子链注册，候选SCS内部完成注册，最终成为子链的一员，才有资格参与子链的相关业务。 需要注意的是：SCS参与子链注册是通过SCS地址（我们也称为scsid，放在“./scskeystore”目录下）发送交易到子链完成；因此需要给SCS地址储备一定量的moac，建议1个moac。同时子链合约需要最终提供gas费给scs，因此，也需要给子链控制合约发送一定量的moac。 请注意：给子链控制合约发送moac，不能直接send，需要用合约里的函数addFund（）。 部署子链开放注册的代码如下registerOpen.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register open var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x8a194e9567d7339b968dac61546a52f89a8c7a2f&quot;;//子链控制合约地址 chain3.personal.unlockAccount(dappAddr, dappPasswd,0); sendtx(dappAddr, subchainAddr, &#39;0&#39;,&#39;0x5defc56c&#39; ); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁； subchainAddr：部署子链控制合约subchainbase的地址； 数据：&#39;0x5defc56c&#39;是子链控制合约subchainbase中‘registerOpen()’通过hash算法Keccak256得到前4个字节，此处不用修改； 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 6.5 查看注册情况 通过registerOpen后，系统将自动选择符合条件的SCS节点并通知他们进行注册，DAPP用户需要通过如下方法查看已经注册完成的SCS节点数目（nodeCount）： &gt;mc.getStorageAt(subchainAddr,0x0e) 通过合约地址subchainAddr查询合约中第0x0e个public成员变量（即nodeCount）的值，请不要修改此值 当达到子链运行需要的SCS的数量区间后，即可进入RegisterClose步骤。 该步骤也可以在http://walletbeta.moac.io的合约功能处直接查看。还可以查询已经注册的scs的id。 6.6 子链关闭注册 首先介绍一下RegisterClose的主要工作： Dapp用户设置子链关闭注册； 已经注册SCS数目必须不小于子链要求的最小数目，否则子链注册无效； 主网广播通知所有的协议合约中候选SCS，包括已经注册的成功的SCS； SCS收到广播后，SCS自身完成初始化并开始子链运行。 关闭子链注册后，候选SCS不能再通过subchain RegisterOpen方式注册该子链，已经注册的SCS处于正常运行状态，参与子链的相关业务，如：处理交易、出块、刷新等。 部署子链关闭注册的代码如下registerClose.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register open var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x8a194e9567d7339b968dac61546a52f89a8c7a2f&quot;;//子链控制合约地址 chain3.personal.unlockAccount(dappAddr, dappPasswd,0); sendtx(dappAddr, subchainAddr, &#39;0&#39;,&#39;0x69f3576f&#39; ); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 其中， dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁； subchainAddr：部署子链合约得到的合约地址； 数据：&#39;0x69f3576f&#39;是子链控制合约subchainbase中‘registerClose()’通过hash算法Keccak256得到前4个字节； 执行完毕，如果一切正常，子链建成并开始出块。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 实测环境中3个scs轮流出块，显示如下。 图中显示本scs出块正常，当前为子链第15个区块，由本scs挖矿出块成功。 如果是同步其他scs出的子链区块，“SendBkToVnode”显示为“Insert”，也就是同步其他scs的区块。 至此，子链部署完成。 &nbsp; 7.SCS monitor Monitor是一个特殊的SCS节点，它是一种模式，DAPP用户可以通过这个节点来监控自己的子链运行状态和业务数据。 SCS Monitor不参与子链共识，因此只能查看，不能修改数据。即使子链已经运行，Monitor也能注册加入。 Monitor SCS启动方式为： D:\nuwa1.0.3\scs&gt;scsserver -p &quot;password&quot; --rpcaddr 0.0.0.0 --rpcport 2345 启动后，DAPP用户通过调用子链控制合约subchainbase中的registerAsMonitor方法使Monitor SCS接入子链同步数据。 部署子链开放注册的代码如下registerAsMonitor.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register as monitor var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x4132d3d98e5781507633dfd2248d810ab05d1431&quot;;//子链控制合约地址 var scsAddr = &quot;d35eb82143aa45857bb5324a3b5b493d4078e812&quot;; //monitor的scsid，不带0x开头 subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,&#39;1&#39;,scsAddr); function subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,amount,scsAddr) { chain3.mc.sendTransaction( { from: dappAddr, value:chain3.toSha(amount,&#39;mc&#39;), to: subchainAddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: &#39;0x4e592e2f000000000000000000000000&#39; + scsAddr }); console.log(&#39;sending from:&#39; + dappAddr + &#39; to:&#39; + subchainAddr + &#39; with data:&#39; + &#39;0x4e592e2f000000000000000000000000&#39; + scsAddr); } 部署成功后可以看到，SCS monitor开始同步子链区块。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 &nbsp; 8.在子链部署业务逻辑合约 8.1 使用钱包工具部署业务逻辑合约 登录http://walletbeta.moac.io，点击“部署新合约”。 本文档使用一个简单的合约，mySubContract.sol，代码如下： pragma solidity ^0.4.18; contract Calc{ uint public count; uint public equation; function add(uint a, uint b){ count++; equation = a + b; } function getCount() constant returns (uint){ return count; } function getEquation() constant returns (uint){ return equation; } } 部署子链业务逻辑合约时，勾选复选框“MicroChain Dapp”； MicroChain Base&nbsp;Address：在里面填上子链控制合约的地址； SCS Monitor Address：填写SCS Monitor的IP地址（本机可以用127.0.0.1）； SCS Monitor Port：SCS Monitor启动端口。 然后填写合约的内容，按步骤即可成功部署子链业务逻辑合约。同时在contract页面的MICROCHAIN CONTRACTS显示。 点击进去，会发现显示的合约地址仍然是子链控制合约地址，同时显示scs monitor的address和port； 右边的合约函数就是业务逻辑合约的函数。&nbsp; 请注意，此时Nonce值应该自动是1，才是正确状态，如果等待很久之后还是0或者-1，则表示没有部署成功。 部署不成功的原因很多，比如本地网路问题，或者scs出块时子链分叉等。 正常后，可以对子链业务逻辑合约进行操作，每次操作成功后，Nonce会自动增加1。 本例中，左边可以直接看到测试运算结果。 在对子链业务逻辑合约的操作中，可以在scs monitor界面看到交易的发送情况，基本格式如下： ====== Transactions: 1 ===== TX(f3eb6baf45ff003f766d88bf7dddd6894ec4bf72ebdae1a2931241674ad7f8d4) Contract: false From: 7610fd66c272332edd59a43460ad24eee1973bfe To: 6b4e01e1598fdabd7c926260ae614005bf1cc9a0 Nonce: 1 GasPrice: 0x4a817c800 GasLimit 0x0 Value: 0x0 Data: 0x771602f700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005 V: 0xee R: 0xf0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686 S: 0x6bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28 Hex: f8bf01808504a817c80080946b4e01e1598fdabd7c926260ae614005bf1cc9a080b844771602f70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000501947610fd66c272332edd59a43460ad24eee1973bfe81eea0f0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686a06bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28 SysCnt: 0 ShardingFlag: 1 Via: [118 16 253 102 194 114 51 46 221 89 164 52 96 173 36 238 225 151 59 254] ============================= &nbsp; 阅读更多" />
<meta property="og:description" content="版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81125954 北京时间2018年6月30日，MOAC子链正式上线公测。 北京时间2018年9月30日，MOAC发布Nuwa1.0.3，该版本目前仅用于moac testnet。 以下为MOAC&nbsp;子链公测版安装及应用教程。 &nbsp; 1.&nbsp;准备工作 从MOAC版本发布页：https://github.com/MOACChain/moac-core/releases 下载Windows版本的系统软件包nuwa1.0.3.win.zip。 该版本适用于64位Windows 7及以上系统。本文实际操作环境为：64位Windows 10&nbsp;中文版。 本文主要内容来自MOAC中文wiki。建议操作前浏览子链相关内容。网址： https://github.com/delida/MoacDocs/wiki &nbsp; 2.&nbsp;产生本地MOAC节点 解压系统软件包nuwa1.0.3.win.zip到本地硬盘。 安装节点到MOAC测试网。安装命令： D:\nuwa1.0.3\vnode&gt;moac --testnet 注意：在moac测试网，任何情形使用moac命令启动节点均需要加--testnet。 节点自动安装到目录：C:\Users\[user]\AppData\Roaming\MoacNode\testnet 墨客测试网区块高度可以通过墨客测试网区块浏览器查询。 浏览器网址：http://47.75.144.55:3000/home。 特别注意：为了完成本篇文档的所有操作，需要用以下方式启动节点： D:\nuwa1.0.3\vnode&gt;moac --testnet --rpc --rpcapi &quot;chain3,personal,mc,net,vnode&quot; --rpccorsdomain &quot;http://walletbeta.moac.io&quot; 使用该命令启动节点后，本编文档后面所用到的网页版钱包为：http://walletbeta.moac.io。 3.节点基本操作 此节内容参考文档《第三篇 墨客区块链（MOAC BlockChain）节点安装教程》。 3.1 进入console界面 系统关机或主动关闭运行中的节点后，如果需要重新启动节点，在命令行中执行： D:\nuwa1.0.3\vnode&gt;moac –testnet 命令执行后，界面一直滚屏以同步区块数据。 3.2 进入attach界面 打开另一个命令（cmd）终端，转到当前目录，在命令行中执行： D:\nuwa1.0.3\vnode&gt;moac attach 该命令依赖于节点已经启动，命令执行后不会主动滚屏，而是等待命令。 3.3 创建账号 进入MOAC console界面后，执行命令： &gt; personal.newAccount() 系统会在以下目录：C:\Users\[userName]\AppData\Roaming\MoacNode\testnet\keystore，记录一个账号文件。 请保存好该文件，并牢记密码。 3.4 挖矿 在测试网，可以尝试挖矿，用于之后操作的gas费，进入moac attach界面后： 开始挖矿，执行命令： &gt; miner.start() 停止挖矿，执行命令： &gt; miner.stop() 查看挖矿状态，执行命令： &gt;mc.mining 查看余额变动，执行命令： &gt;loadScript(&quot;mctest.js&quot;) &gt;checkBalance() &nbsp; 4.scs注册 此处内容参考中文wiki内容《SCS矿工参与方法》。 4.1 部署子链矿池 部署子链矿池智能合约，用于子链SCS节点矿工加入矿工池。 从MOAC版本发布页下载合约SubChainProtocolBase.sol。进行合约部署。 此处内容参考文档《第四篇 在墨客区块链（MOAC BlockChain）部署ERC-20合约》。 测试网部署合约使用的网页版钱包工具请登录：http://walletbeta.moac.io。 部署时选择“Sub&nbsp;Chain Protocol Base”，填入参数Protocol（POS）、Bmin(1)和protocol type（0表示pos，1表示ipfs），如图所示。 成功部署后 注意：该步骤非必须，可以直接加入测试网已经存在的矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署子链矿池。 该合约地址经测试工作正常，用户可以在后面的步骤将scs注册到moac测试网公开的合约地址。 0x55db2865e29e8a1adC54fABDA221609536DD8b90 4.2 启动SCS 在下载的节点文件中，有一个scs目录。目录下有一个配置文件userconfig.json。其中的Beneficiary为矿工收益账号。为了安全起见，建议采用与scsid不同的墨客底层账号用来获取子链的收益（scsid将会在后面讲到）。 进入目录scs\scsserver启动scs： D:\nuwa1.0.3\scs&gt;scsserver -p &quot;password&quot; 命令中：如果直接运行scsserver，则默认密码为 moacscsofflineaccountpwd，使用参数-p，则可以自己设定scs账号密码。 启动后，SCS将会在当前目录下生成一个keystore目录，并在目录中新建一个账号，这个账号就是scsid。如果想换一个scsid，则需要删除该目录中所有新内容，仅保留原来的2个文件，重新启动。 可以根据实际需要，按照以上步骤重新启动一个或多个scs。单台电脑建议启动不超过3个scs。 4.3 注册SCS 在启动scs并已经知道一个子链矿池合约地址的情况下（见4.1节），可以进行注册。 写一个scsRegister.js，代码如下。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //scs注册 console.log(&#39;SCS Register start!&#39;); var baseAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var basePasswd = &quot;password&quot;; var protocolAddr = &quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot;; var scsAddr = &quot;755a37ec5ba302cd0022af2b8e3ff97c1996601b&quot;; //不带0x开头 chain3.personal.unlockAccount(baseAddr, basePasswd,0); sendtx(baseAddr, protocolAddr, &#39;5&#39;,&#39;0x4420e486000000000000000000000000&#39; + scsAddr); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,’mc’), to: tgtaddr, gas: &quot;9000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 主要参数如下： baseAddr、basePasswd：主网的一个账户及其密码，付出本次交易的gas费及scs注册所需的押金（本例5mc）； protocolAddr：步骤4.1子链矿池合约subchainprotocolbase地址； scsAddr：步骤4.2的scsid地址，放在“…/scsserver/scskeystore”目录下； 注册mc数量，本例子中为5mc，此处必须大于矿池合约的设置值。scs提交押金越多，能参与的子链越多。 特别注意：scsAddr的地址不要加上“0x”。 在文件目录下执行该注册文件scsRegister.js： D:\nuwa1.0.3\scs&gt;node&nbsp;scsRegister.js 在等待一定时间之后（通常是母链50个block），就进入子链矿池，成为该子链的候选SCS节点。注册后，保证金会从baseAddr账号转到子链矿池合约账号。 注册时缴纳的保证金，将在SCS被选中服务子链的时候临时扣除。下图为注册两个SCS，各交2个mc保证金的情况。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 其中： Select function：选择合约功能Register； Scs-address：填入要注册的scsid； Execute from：使用有mc余额的账号，并且已经解锁，personal.unlockAccount； Send mc：提交押金，应该多于scs池子合约所要求的最少押金； 4.4 给SCS地址转账 scs在跟底层vnode通信或被调用时，tx是需要交易费的，因此需要在scsid存入1个mc作为gas费。 给scsid转账跟向普通账户转账一样。 4.5 查询SCS注册数量 如果是使用网页版钱包部署的子链矿池合约，可以直接在界面看到scs注册数量等信息。 或者，通过moac attach界面，使用合约地址查询注册scs数量 &gt; mc.getStorageAt(&quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot;,0x02) &nbsp; 5.部署Vnode矿池合约 此处内容参考中文wiki内容《代理vnode节点介绍》。 5.1 部署vnode矿池 从MOAC版本发布页下载合约VnodeProtocolBase.sol 部署时选择“Vnode&nbsp;Protocol Base”，填入参数Bmin(1)，即最少押金为1。如图所示。 成功后得到合约地址，用于后面vnode的注册。 注意：该步骤非必须，可以直接加入测试网已经存在的Vnode池子。 用户可以不必自己部署合约，在后面的步骤将Vnode节点注册到该合约地址；或者不注册vnode，直接使用该Vnode池子合约地址，里面已经注册的Vnode将会为你的子链提供服务。 0x5B43583F33214c790B8206D9B06685c49A1DB455 5.2 添加节点到vnode矿池 添加本节点到vnode矿池的代码如下vnodeRegister.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //vnode register var baseAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var basePasswd = &quot;password&quot;; var vnodeChain = &quot;0x0fB05e4a2b878855e27A7675135BecA0E257e896&quot;; var vnodeAddr = &quot;7610fd66c272332edd59a43460ad24eee1973bfe&quot;; chain3.personal.unlockAccount(baseAddr,basePasswd,0); //该步骤也可以在attach界面执行 sendtx(baseAddr, vnodeChain, &#39;2&#39;,&#39;0x32434a2e000000000000000000000000&#39; + vnodeAddr //数据1 +&#39;0000000000000000000000000000000000000000000000000000000000000040&#39;//数据2 +&#39;0000000000000000000000000000000000000000000000000000000000000013&#39;//数据3 //192.168.10.16:50062（填入本机实际IP地址值，并修改数据3和数据4） +&#39;3139322e3136382e31302e31363a353030363200000000000000000000000000&#39;);//数据4 function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;9000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 主要参数如下： baseAddr、basePasswd：Dapp用户用来发送交易前账户解锁； vnodeChain：部署VNODE-PROXY合约得到的合约地址； vnodeAddr：vnodeconfig.json的VnodeBeneficialAddress 数据1：&#39;0x32434a2e &#39;是VNODE-PROXY合约 中‘register(address vnode, string link)’通过hash算法Keccak256得到前4个字节，本例押金交2mc；本例带两个参数； 添加成功后，启动节点方式不变。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成，前提是你已经部署了自己的Vnode Proxy池子合约（也就是5.1节的步骤）。 其中： Select function：选择合约功能Register； Vnode-address：填入收益账号，一般是本地节点的挖矿账号； Link-String：本节点主机的IP地址； Send mc：提交押金，应该多于Vnode池子合约所要求的最少押金； 注意：该步骤非必须，也就是说并不是必须把本节点注册为proxy Vnode，可以直接加入测试网已经存在的Vnode矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署Vnode矿池并将本节点注册为Vnode proxy。 &nbsp; 6.部署子链合约 此处内容参考中文wiki内容《DAPP用户的参与方法》。 6.1 编译子链合约 合约可以通过多种方式编译，比如在线编译工具remix等，如果是本地命令行编译，需要安装solidity环境。 D:\scs&gt;&nbsp;solcjs --bin --abi -o bin SubChainBase.sol SubChainProtocolBase.sol SubChainBase.sol是子链合约，其中import &quot;./SubChainProtocolBase.sol&quot;; 因此要把SubChainProtocolBase.sol合约放在同一个目录下。 编译结果如果没有error，会在bin目录生成相应的*.bin和*.abi文件。 6.2 部署子链合约 部署子链合约的代码如下deploySubChain.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //deploy subChainBase chain3.personal.unlockAccount(chain3.mc.accounts[0], &#39;password&#39;,0); var proto = &quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot; ; var vnodeProtocolBaseAddr = &quot;0x0fB05e4a2b878855e27A7675135BecA0E257e896&quot; ; var min = 1 ; var max = 10 ; var thousandth = 1 ; var flushRound = 20 ; var subchainbaseContract = chain3.mc.contract([{&quot;constant&quot;:true,......,&quot;type&quot;:&quot;event&quot;}]); var subchainbase = subchainbaseContract.new( proto, vnodeProtocolBaseAddr, min, max, thousandth, flushRound, { from: chain3.mc.accounts[0], data: &#39;0x6060604052600c601555670d...708e8ee3c23da8b02d0278eb0029&#39;, gas: &#39;9000000&#39; }, function (e, contract){ console.log(e, contract); if (typeof contract.address !== &#39;undefined&#39;) { console.log(&#39;Contract mined! address: &#39; + contract.address + &#39; transactionHash: &#39; + contract.transactionHash); } }) 子链控制合约subchainbase是DAPP用户使用子链的基本合约，其提供子链运行前和运行中的一些必要接口。 通常来说，子链控制合约subchainbase需要修改相应的内容如下： 参数proto：通过官方渠道获取到，或者自己部署的子链矿池合约subchainprotocolbase的地址，复制粘贴到此变量； 参数vnodeProtocolBaseAddr：通过官方渠道获取到，或者自己部署的代理智能合约vnodeprotocolbase的地址，复制粘贴到此变量； 参数min：子链运行后需要的SCS的最小数量，建议数量为1； 参数max：子链运行后需要的SCS的最大数量，建议数量为100； 参数thousandth：千分之几，默认为1； 参数flushRound：子链刷新周期（以母链block生成数量为准），小于100的值，合约会自动置为100； 合约部署时的gas值必须为9000000； Chain3.mc.contract：其内容是6.1节编译结果的SubChainBase.abi； data：其内容是6.1节编译结果的SubChainBase.bin，前面要加”0x”。 6.3&nbsp;子链控制合约信息 部署成功后： 得到子链控制合约地址和本次交易hash。 该合约不是在网页版钱包部署的，因此不会在界面上显示，此时需要将该合约加到界面上。 点击“WATCH MOTHERCHAIN CONTRACT”按钮。 输入刚部署的合约的合约地址和JSON（就是合约的abiString），自己给合约取个名称，点击“好”，会在界面上增加该合约。之后对合约的操作跟使用网页版钱包部署成功的合约一致。 6.4 子链开放注册 通过开放子链注册，候选SCS内部完成注册，最终成为子链的一员，才有资格参与子链的相关业务。 需要注意的是：SCS参与子链注册是通过SCS地址（我们也称为scsid，放在“./scskeystore”目录下）发送交易到子链完成；因此需要给SCS地址储备一定量的moac，建议1个moac。同时子链合约需要最终提供gas费给scs，因此，也需要给子链控制合约发送一定量的moac。 请注意：给子链控制合约发送moac，不能直接send，需要用合约里的函数addFund（）。 部署子链开放注册的代码如下registerOpen.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register open var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x8a194e9567d7339b968dac61546a52f89a8c7a2f&quot;;//子链控制合约地址 chain3.personal.unlockAccount(dappAddr, dappPasswd,0); sendtx(dappAddr, subchainAddr, &#39;0&#39;,&#39;0x5defc56c&#39; ); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁； subchainAddr：部署子链控制合约subchainbase的地址； 数据：&#39;0x5defc56c&#39;是子链控制合约subchainbase中‘registerOpen()’通过hash算法Keccak256得到前4个字节，此处不用修改； 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 6.5 查看注册情况 通过registerOpen后，系统将自动选择符合条件的SCS节点并通知他们进行注册，DAPP用户需要通过如下方法查看已经注册完成的SCS节点数目（nodeCount）： &gt;mc.getStorageAt(subchainAddr,0x0e) 通过合约地址subchainAddr查询合约中第0x0e个public成员变量（即nodeCount）的值，请不要修改此值 当达到子链运行需要的SCS的数量区间后，即可进入RegisterClose步骤。 该步骤也可以在http://walletbeta.moac.io的合约功能处直接查看。还可以查询已经注册的scs的id。 6.6 子链关闭注册 首先介绍一下RegisterClose的主要工作： Dapp用户设置子链关闭注册； 已经注册SCS数目必须不小于子链要求的最小数目，否则子链注册无效； 主网广播通知所有的协议合约中候选SCS，包括已经注册的成功的SCS； SCS收到广播后，SCS自身完成初始化并开始子链运行。 关闭子链注册后，候选SCS不能再通过subchain RegisterOpen方式注册该子链，已经注册的SCS处于正常运行状态，参与子链的相关业务，如：处理交易、出块、刷新等。 部署子链关闭注册的代码如下registerClose.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register open var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x8a194e9567d7339b968dac61546a52f89a8c7a2f&quot;;//子链控制合约地址 chain3.personal.unlockAccount(dappAddr, dappPasswd,0); sendtx(dappAddr, subchainAddr, &#39;0&#39;,&#39;0x69f3576f&#39; ); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 其中， dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁； subchainAddr：部署子链合约得到的合约地址； 数据：&#39;0x69f3576f&#39;是子链控制合约subchainbase中‘registerClose()’通过hash算法Keccak256得到前4个字节； 执行完毕，如果一切正常，子链建成并开始出块。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 实测环境中3个scs轮流出块，显示如下。 图中显示本scs出块正常，当前为子链第15个区块，由本scs挖矿出块成功。 如果是同步其他scs出的子链区块，“SendBkToVnode”显示为“Insert”，也就是同步其他scs的区块。 至此，子链部署完成。 &nbsp; 7.SCS monitor Monitor是一个特殊的SCS节点，它是一种模式，DAPP用户可以通过这个节点来监控自己的子链运行状态和业务数据。 SCS Monitor不参与子链共识，因此只能查看，不能修改数据。即使子链已经运行，Monitor也能注册加入。 Monitor SCS启动方式为： D:\nuwa1.0.3\scs&gt;scsserver -p &quot;password&quot; --rpcaddr 0.0.0.0 --rpcport 2345 启动后，DAPP用户通过调用子链控制合约subchainbase中的registerAsMonitor方法使Monitor SCS接入子链同步数据。 部署子链开放注册的代码如下registerAsMonitor.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register as monitor var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x4132d3d98e5781507633dfd2248d810ab05d1431&quot;;//子链控制合约地址 var scsAddr = &quot;d35eb82143aa45857bb5324a3b5b493d4078e812&quot;; //monitor的scsid，不带0x开头 subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,&#39;1&#39;,scsAddr); function subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,amount,scsAddr) { chain3.mc.sendTransaction( { from: dappAddr, value:chain3.toSha(amount,&#39;mc&#39;), to: subchainAddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: &#39;0x4e592e2f000000000000000000000000&#39; + scsAddr }); console.log(&#39;sending from:&#39; + dappAddr + &#39; to:&#39; + subchainAddr + &#39; with data:&#39; + &#39;0x4e592e2f000000000000000000000000&#39; + scsAddr); } 部署成功后可以看到，SCS monitor开始同步子链区块。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 &nbsp; 8.在子链部署业务逻辑合约 8.1 使用钱包工具部署业务逻辑合约 登录http://walletbeta.moac.io，点击“部署新合约”。 本文档使用一个简单的合约，mySubContract.sol，代码如下： pragma solidity ^0.4.18; contract Calc{ uint public count; uint public equation; function add(uint a, uint b){ count++; equation = a + b; } function getCount() constant returns (uint){ return count; } function getEquation() constant returns (uint){ return equation; } } 部署子链业务逻辑合约时，勾选复选框“MicroChain Dapp”； MicroChain Base&nbsp;Address：在里面填上子链控制合约的地址； SCS Monitor Address：填写SCS Monitor的IP地址（本机可以用127.0.0.1）； SCS Monitor Port：SCS Monitor启动端口。 然后填写合约的内容，按步骤即可成功部署子链业务逻辑合约。同时在contract页面的MICROCHAIN CONTRACTS显示。 点击进去，会发现显示的合约地址仍然是子链控制合约地址，同时显示scs monitor的address和port； 右边的合约函数就是业务逻辑合约的函数。&nbsp; 请注意，此时Nonce值应该自动是1，才是正确状态，如果等待很久之后还是0或者-1，则表示没有部署成功。 部署不成功的原因很多，比如本地网路问题，或者scs出块时子链分叉等。 正常后，可以对子链业务逻辑合约进行操作，每次操作成功后，Nonce会自动增加1。 本例中，左边可以直接看到测试运算结果。 在对子链业务逻辑合约的操作中，可以在scs monitor界面看到交易的发送情况，基本格式如下： ====== Transactions: 1 ===== TX(f3eb6baf45ff003f766d88bf7dddd6894ec4bf72ebdae1a2931241674ad7f8d4) Contract: false From: 7610fd66c272332edd59a43460ad24eee1973bfe To: 6b4e01e1598fdabd7c926260ae614005bf1cc9a0 Nonce: 1 GasPrice: 0x4a817c800 GasLimit 0x0 Value: 0x0 Data: 0x771602f700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005 V: 0xee R: 0xf0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686 S: 0x6bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28 Hex: f8bf01808504a817c80080946b4e01e1598fdabd7c926260ae614005bf1cc9a080b844771602f70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000501947610fd66c272332edd59a43460ad24eee1973bfe81eea0f0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686a06bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28 SysCnt: 0 ShardingFlag: 1 Via: [118 16 253 102 194 114 51 46 221 89 164 52 96 173 36 238 225 151 59 254] ============================= &nbsp; 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-20T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81125954 北京时间2018年6月30日，MOAC子链正式上线公测。 北京时间2018年9月30日，MOAC发布Nuwa1.0.3，该版本目前仅用于moac testnet。 以下为MOAC&nbsp;子链公测版安装及应用教程。 &nbsp; 1.&nbsp;准备工作 从MOAC版本发布页：https://github.com/MOACChain/moac-core/releases 下载Windows版本的系统软件包nuwa1.0.3.win.zip。 该版本适用于64位Windows 7及以上系统。本文实际操作环境为：64位Windows 10&nbsp;中文版。 本文主要内容来自MOAC中文wiki。建议操作前浏览子链相关内容。网址： https://github.com/delida/MoacDocs/wiki &nbsp; 2.&nbsp;产生本地MOAC节点 解压系统软件包nuwa1.0.3.win.zip到本地硬盘。 安装节点到MOAC测试网。安装命令： D:\\nuwa1.0.3\\vnode&gt;moac --testnet 注意：在moac测试网，任何情形使用moac命令启动节点均需要加--testnet。 节点自动安装到目录：C:\\Users\\[user]\\AppData\\Roaming\\MoacNode\\testnet 墨客测试网区块高度可以通过墨客测试网区块浏览器查询。 浏览器网址：http://47.75.144.55:3000/home。 特别注意：为了完成本篇文档的所有操作，需要用以下方式启动节点： D:\\nuwa1.0.3\\vnode&gt;moac --testnet --rpc --rpcapi &quot;chain3,personal,mc,net,vnode&quot; --rpccorsdomain &quot;http://walletbeta.moac.io&quot; 使用该命令启动节点后，本编文档后面所用到的网页版钱包为：http://walletbeta.moac.io。 3.节点基本操作 此节内容参考文档《第三篇 墨客区块链（MOAC BlockChain）节点安装教程》。 3.1 进入console界面 系统关机或主动关闭运行中的节点后，如果需要重新启动节点，在命令行中执行： D:\\nuwa1.0.3\\vnode&gt;moac –testnet 命令执行后，界面一直滚屏以同步区块数据。 3.2 进入attach界面 打开另一个命令（cmd）终端，转到当前目录，在命令行中执行： D:\\nuwa1.0.3\\vnode&gt;moac attach 该命令依赖于节点已经启动，命令执行后不会主动滚屏，而是等待命令。 3.3 创建账号 进入MOAC console界面后，执行命令： &gt; personal.newAccount() 系统会在以下目录：C:\\Users\\[userName]\\AppData\\Roaming\\MoacNode\\testnet\\keystore，记录一个账号文件。 请保存好该文件，并牢记密码。 3.4 挖矿 在测试网，可以尝试挖矿，用于之后操作的gas费，进入moac attach界面后： 开始挖矿，执行命令： &gt; miner.start() 停止挖矿，执行命令： &gt; miner.stop() 查看挖矿状态，执行命令： &gt;mc.mining 查看余额变动，执行命令： &gt;loadScript(&quot;mctest.js&quot;) &gt;checkBalance() &nbsp; 4.scs注册 此处内容参考中文wiki内容《SCS矿工参与方法》。 4.1 部署子链矿池 部署子链矿池智能合约，用于子链SCS节点矿工加入矿工池。 从MOAC版本发布页下载合约SubChainProtocolBase.sol。进行合约部署。 此处内容参考文档《第四篇 在墨客区块链（MOAC BlockChain）部署ERC-20合约》。 测试网部署合约使用的网页版钱包工具请登录：http://walletbeta.moac.io。 部署时选择“Sub&nbsp;Chain Protocol Base”，填入参数Protocol（POS）、Bmin(1)和protocol type（0表示pos，1表示ipfs），如图所示。 成功部署后 注意：该步骤非必须，可以直接加入测试网已经存在的矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署子链矿池。 该合约地址经测试工作正常，用户可以在后面的步骤将scs注册到moac测试网公开的合约地址。 0x55db2865e29e8a1adC54fABDA221609536DD8b90 4.2 启动SCS 在下载的节点文件中，有一个scs目录。目录下有一个配置文件userconfig.json。其中的Beneficiary为矿工收益账号。为了安全起见，建议采用与scsid不同的墨客底层账号用来获取子链的收益（scsid将会在后面讲到）。 进入目录scs\\scsserver启动scs： D:\\nuwa1.0.3\\scs&gt;scsserver -p &quot;password&quot; 命令中：如果直接运行scsserver，则默认密码为 moacscsofflineaccountpwd，使用参数-p，则可以自己设定scs账号密码。 启动后，SCS将会在当前目录下生成一个keystore目录，并在目录中新建一个账号，这个账号就是scsid。如果想换一个scsid，则需要删除该目录中所有新内容，仅保留原来的2个文件，重新启动。 可以根据实际需要，按照以上步骤重新启动一个或多个scs。单台电脑建议启动不超过3个scs。 4.3 注册SCS 在启动scs并已经知道一个子链矿池合约地址的情况下（见4.1节），可以进行注册。 写一个scsRegister.js，代码如下。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //scs注册 console.log(&#39;SCS Register start!&#39;); var baseAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var basePasswd = &quot;password&quot;; var protocolAddr = &quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot;; var scsAddr = &quot;755a37ec5ba302cd0022af2b8e3ff97c1996601b&quot;; //不带0x开头 chain3.personal.unlockAccount(baseAddr, basePasswd,0); sendtx(baseAddr, protocolAddr, &#39;5&#39;,&#39;0x4420e486000000000000000000000000&#39; + scsAddr); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,’mc’), to: tgtaddr, gas: &quot;9000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 主要参数如下： baseAddr、basePasswd：主网的一个账户及其密码，付出本次交易的gas费及scs注册所需的押金（本例5mc）； protocolAddr：步骤4.1子链矿池合约subchainprotocolbase地址； scsAddr：步骤4.2的scsid地址，放在“…/scsserver/scskeystore”目录下； 注册mc数量，本例子中为5mc，此处必须大于矿池合约的设置值。scs提交押金越多，能参与的子链越多。 特别注意：scsAddr的地址不要加上“0x”。 在文件目录下执行该注册文件scsRegister.js： D:\\nuwa1.0.3\\scs&gt;node&nbsp;scsRegister.js 在等待一定时间之后（通常是母链50个block），就进入子链矿池，成为该子链的候选SCS节点。注册后，保证金会从baseAddr账号转到子链矿池合约账号。 注册时缴纳的保证金，将在SCS被选中服务子链的时候临时扣除。下图为注册两个SCS，各交2个mc保证金的情况。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 其中： Select function：选择合约功能Register； Scs-address：填入要注册的scsid； Execute from：使用有mc余额的账号，并且已经解锁，personal.unlockAccount； Send mc：提交押金，应该多于scs池子合约所要求的最少押金； 4.4 给SCS地址转账 scs在跟底层vnode通信或被调用时，tx是需要交易费的，因此需要在scsid存入1个mc作为gas费。 给scsid转账跟向普通账户转账一样。 4.5 查询SCS注册数量 如果是使用网页版钱包部署的子链矿池合约，可以直接在界面看到scs注册数量等信息。 或者，通过moac attach界面，使用合约地址查询注册scs数量 &gt; mc.getStorageAt(&quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot;,0x02) &nbsp; 5.部署Vnode矿池合约 此处内容参考中文wiki内容《代理vnode节点介绍》。 5.1 部署vnode矿池 从MOAC版本发布页下载合约VnodeProtocolBase.sol 部署时选择“Vnode&nbsp;Protocol Base”，填入参数Bmin(1)，即最少押金为1。如图所示。 成功后得到合约地址，用于后面vnode的注册。 注意：该步骤非必须，可以直接加入测试网已经存在的Vnode池子。 用户可以不必自己部署合约，在后面的步骤将Vnode节点注册到该合约地址；或者不注册vnode，直接使用该Vnode池子合约地址，里面已经注册的Vnode将会为你的子链提供服务。 0x5B43583F33214c790B8206D9B06685c49A1DB455 5.2 添加节点到vnode矿池 添加本节点到vnode矿池的代码如下vnodeRegister.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //vnode register var baseAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var basePasswd = &quot;password&quot;; var vnodeChain = &quot;0x0fB05e4a2b878855e27A7675135BecA0E257e896&quot;; var vnodeAddr = &quot;7610fd66c272332edd59a43460ad24eee1973bfe&quot;; chain3.personal.unlockAccount(baseAddr,basePasswd,0); //该步骤也可以在attach界面执行 sendtx(baseAddr, vnodeChain, &#39;2&#39;,&#39;0x32434a2e000000000000000000000000&#39; + vnodeAddr //数据1 +&#39;0000000000000000000000000000000000000000000000000000000000000040&#39;//数据2 +&#39;0000000000000000000000000000000000000000000000000000000000000013&#39;//数据3 //192.168.10.16:50062（填入本机实际IP地址值，并修改数据3和数据4） +&#39;3139322e3136382e31302e31363a353030363200000000000000000000000000&#39;);//数据4 function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;9000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 主要参数如下： baseAddr、basePasswd：Dapp用户用来发送交易前账户解锁； vnodeChain：部署VNODE-PROXY合约得到的合约地址； vnodeAddr：vnodeconfig.json的VnodeBeneficialAddress 数据1：&#39;0x32434a2e &#39;是VNODE-PROXY合约 中‘register(address vnode, string link)’通过hash算法Keccak256得到前4个字节，本例押金交2mc；本例带两个参数； 添加成功后，启动节点方式不变。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成，前提是你已经部署了自己的Vnode Proxy池子合约（也就是5.1节的步骤）。 其中： Select function：选择合约功能Register； Vnode-address：填入收益账号，一般是本地节点的挖矿账号； Link-String：本节点主机的IP地址； Send mc：提交押金，应该多于Vnode池子合约所要求的最少押金； 注意：该步骤非必须，也就是说并不是必须把本节点注册为proxy Vnode，可以直接加入测试网已经存在的Vnode矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署Vnode矿池并将本节点注册为Vnode proxy。 &nbsp; 6.部署子链合约 此处内容参考中文wiki内容《DAPP用户的参与方法》。 6.1 编译子链合约 合约可以通过多种方式编译，比如在线编译工具remix等，如果是本地命令行编译，需要安装solidity环境。 D:\\scs&gt;&nbsp;solcjs --bin --abi -o bin SubChainBase.sol SubChainProtocolBase.sol SubChainBase.sol是子链合约，其中import &quot;./SubChainProtocolBase.sol&quot;; 因此要把SubChainProtocolBase.sol合约放在同一个目录下。 编译结果如果没有error，会在bin目录生成相应的*.bin和*.abi文件。 6.2 部署子链合约 部署子链合约的代码如下deploySubChain.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //deploy subChainBase chain3.personal.unlockAccount(chain3.mc.accounts[0], &#39;password&#39;,0); var proto = &quot;0x225Ebb0b9DF76E3D48eA0614943340611f635EA0&quot; ; var vnodeProtocolBaseAddr = &quot;0x0fB05e4a2b878855e27A7675135BecA0E257e896&quot; ; var min = 1 ; var max = 10 ; var thousandth = 1 ; var flushRound = 20 ; var subchainbaseContract = chain3.mc.contract([{&quot;constant&quot;:true,......,&quot;type&quot;:&quot;event&quot;}]); var subchainbase = subchainbaseContract.new( proto, vnodeProtocolBaseAddr, min, max, thousandth, flushRound, { from: chain3.mc.accounts[0], data: &#39;0x6060604052600c601555670d...708e8ee3c23da8b02d0278eb0029&#39;, gas: &#39;9000000&#39; }, function (e, contract){ console.log(e, contract); if (typeof contract.address !== &#39;undefined&#39;) { console.log(&#39;Contract mined! address: &#39; + contract.address + &#39; transactionHash: &#39; + contract.transactionHash); } }) 子链控制合约subchainbase是DAPP用户使用子链的基本合约，其提供子链运行前和运行中的一些必要接口。 通常来说，子链控制合约subchainbase需要修改相应的内容如下： 参数proto：通过官方渠道获取到，或者自己部署的子链矿池合约subchainprotocolbase的地址，复制粘贴到此变量； 参数vnodeProtocolBaseAddr：通过官方渠道获取到，或者自己部署的代理智能合约vnodeprotocolbase的地址，复制粘贴到此变量； 参数min：子链运行后需要的SCS的最小数量，建议数量为1； 参数max：子链运行后需要的SCS的最大数量，建议数量为100； 参数thousandth：千分之几，默认为1； 参数flushRound：子链刷新周期（以母链block生成数量为准），小于100的值，合约会自动置为100； 合约部署时的gas值必须为9000000； Chain3.mc.contract：其内容是6.1节编译结果的SubChainBase.abi； data：其内容是6.1节编译结果的SubChainBase.bin，前面要加”0x”。 6.3&nbsp;子链控制合约信息 部署成功后： 得到子链控制合约地址和本次交易hash。 该合约不是在网页版钱包部署的，因此不会在界面上显示，此时需要将该合约加到界面上。 点击“WATCH MOTHERCHAIN CONTRACT”按钮。 输入刚部署的合约的合约地址和JSON（就是合约的abiString），自己给合约取个名称，点击“好”，会在界面上增加该合约。之后对合约的操作跟使用网页版钱包部署成功的合约一致。 6.4 子链开放注册 通过开放子链注册，候选SCS内部完成注册，最终成为子链的一员，才有资格参与子链的相关业务。 需要注意的是：SCS参与子链注册是通过SCS地址（我们也称为scsid，放在“./scskeystore”目录下）发送交易到子链完成；因此需要给SCS地址储备一定量的moac，建议1个moac。同时子链合约需要最终提供gas费给scs，因此，也需要给子链控制合约发送一定量的moac。 请注意：给子链控制合约发送moac，不能直接send，需要用合约里的函数addFund（）。 部署子链开放注册的代码如下registerOpen.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register open var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x8a194e9567d7339b968dac61546a52f89a8c7a2f&quot;;//子链控制合约地址 chain3.personal.unlockAccount(dappAddr, dappPasswd,0); sendtx(dappAddr, subchainAddr, &#39;0&#39;,&#39;0x5defc56c&#39; ); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁； subchainAddr：部署子链控制合约subchainbase的地址； 数据：&#39;0x5defc56c&#39;是子链控制合约subchainbase中‘registerOpen()’通过hash算法Keccak256得到前4个字节，此处不用修改； 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 6.5 查看注册情况 通过registerOpen后，系统将自动选择符合条件的SCS节点并通知他们进行注册，DAPP用户需要通过如下方法查看已经注册完成的SCS节点数目（nodeCount）： &gt;mc.getStorageAt(subchainAddr,0x0e) 通过合约地址subchainAddr查询合约中第0x0e个public成员变量（即nodeCount）的值，请不要修改此值 当达到子链运行需要的SCS的数量区间后，即可进入RegisterClose步骤。 该步骤也可以在http://walletbeta.moac.io的合约功能处直接查看。还可以查询已经注册的scs的id。 6.6 子链关闭注册 首先介绍一下RegisterClose的主要工作： Dapp用户设置子链关闭注册； 已经注册SCS数目必须不小于子链要求的最小数目，否则子链注册无效； 主网广播通知所有的协议合约中候选SCS，包括已经注册的成功的SCS； SCS收到广播后，SCS自身完成初始化并开始子链运行。 关闭子链注册后，候选SCS不能再通过subchain RegisterOpen方式注册该子链，已经注册的SCS处于正常运行状态，参与子链的相关业务，如：处理交易、出块、刷新等。 部署子链关闭注册的代码如下registerClose.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register open var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x8a194e9567d7339b968dac61546a52f89a8c7a2f&quot;;//子链控制合约地址 chain3.personal.unlockAccount(dappAddr, dappPasswd,0); sendtx(dappAddr, subchainAddr, &#39;0&#39;,&#39;0x69f3576f&#39; ); function sendtx(src, tgtaddr, amount, strData) { chain3.mc.sendTransaction( { from: src, value:chain3.toSha(amount,&#39;mc&#39;), to: tgtaddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: strData }); console.log(&#39;sending from:&#39; + src + &#39; to:&#39; + tgtaddr + &#39; with data:&#39; + strData); } 其中， dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁； subchainAddr：部署子链合约得到的合约地址； 数据：&#39;0x69f3576f&#39;是子链控制合约subchainbase中‘registerClose()’通过hash算法Keccak256得到前4个字节； 执行完毕，如果一切正常，子链建成并开始出块。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 实测环境中3个scs轮流出块，显示如下。 图中显示本scs出块正常，当前为子链第15个区块，由本scs挖矿出块成功。 如果是同步其他scs出的子链区块，“SendBkToVnode”显示为“Insert”，也就是同步其他scs的区块。 至此，子链部署完成。 &nbsp; 7.SCS monitor Monitor是一个特殊的SCS节点，它是一种模式，DAPP用户可以通过这个节点来监控自己的子链运行状态和业务数据。 SCS Monitor不参与子链共识，因此只能查看，不能修改数据。即使子链已经运行，Monitor也能注册加入。 Monitor SCS启动方式为： D:\\nuwa1.0.3\\scs&gt;scsserver -p &quot;password&quot; --rpcaddr 0.0.0.0 --rpcport 2345 启动后，DAPP用户通过调用子链控制合约subchainbase中的registerAsMonitor方法使Monitor SCS接入子链同步数据。 部署子链开放注册的代码如下registerAsMonitor.js，执行node即可。 var Chain3 = require(&#39;chain3&#39;); var chain3 = new Chain3(new Chain3.providers.HttpProvider(&#39;http://localhost:8545&#39;)); //register as monitor var dappAddr = &quot;0x7610fd66c272332edd59a43460ad24eee1973bfe&quot;; var dappPasswd = &quot;password&quot;; var subchainAddr = &quot;0x4132d3d98e5781507633dfd2248d810ab05d1431&quot;;//子链控制合约地址 var scsAddr = &quot;d35eb82143aa45857bb5324a3b5b493d4078e812&quot;; //monitor的scsid，不带0x开头 subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,&#39;1&#39;,scsAddr); function subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,amount,scsAddr) { chain3.mc.sendTransaction( { from: dappAddr, value:chain3.toSha(amount,&#39;mc&#39;), to: subchainAddr, gas: &quot;2000000&quot;, gasPrice: chain3.mc.gasPrice, data: &#39;0x4e592e2f000000000000000000000000&#39; + scsAddr }); console.log(&#39;sending from:&#39; + dappAddr + &#39; to:&#39; + subchainAddr + &#39; with data:&#39; + &#39;0x4e592e2f000000000000000000000000&#39; + scsAddr); } 部署成功后可以看到，SCS monitor开始同步子链区块。 该步骤也可以不使用代码，而是在http://walletbeta.moac.io的合约功能处完成。 &nbsp; 8.在子链部署业务逻辑合约 8.1 使用钱包工具部署业务逻辑合约 登录http://walletbeta.moac.io，点击“部署新合约”。 本文档使用一个简单的合约，mySubContract.sol，代码如下： pragma solidity ^0.4.18; contract Calc{ uint public count; uint public equation; function add(uint a, uint b){ count++; equation = a + b; } function getCount() constant returns (uint){ return count; } function getEquation() constant returns (uint){ return equation; } } 部署子链业务逻辑合约时，勾选复选框“MicroChain Dapp”； MicroChain Base&nbsp;Address：在里面填上子链控制合约的地址； SCS Monitor Address：填写SCS Monitor的IP地址（本机可以用127.0.0.1）； SCS Monitor Port：SCS Monitor启动端口。 然后填写合约的内容，按步骤即可成功部署子链业务逻辑合约。同时在contract页面的MICROCHAIN CONTRACTS显示。 点击进去，会发现显示的合约地址仍然是子链控制合约地址，同时显示scs monitor的address和port； 右边的合约函数就是业务逻辑合约的函数。&nbsp; 请注意，此时Nonce值应该自动是1，才是正确状态，如果等待很久之后还是0或者-1，则表示没有部署成功。 部署不成功的原因很多，比如本地网路问题，或者scs出块时子链分叉等。 正常后，可以对子链业务逻辑合约进行操作，每次操作成功后，Nonce会自动增加1。 本例中，左边可以直接看到测试运算结果。 在对子链业务逻辑合约的操作中，可以在scs monitor界面看到交易的发送情况，基本格式如下： ====== Transactions: 1 ===== TX(f3eb6baf45ff003f766d88bf7dddd6894ec4bf72ebdae1a2931241674ad7f8d4) Contract: false From: 7610fd66c272332edd59a43460ad24eee1973bfe To: 6b4e01e1598fdabd7c926260ae614005bf1cc9a0 Nonce: 1 GasPrice: 0x4a817c800 GasLimit 0x0 Value: 0x0 Data: 0x771602f700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005 V: 0xee R: 0xf0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686 S: 0x6bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28 Hex: f8bf01808504a817c80080946b4e01e1598fdabd7c926260ae614005bf1cc9a080b844771602f70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000501947610fd66c272332edd59a43460ad24eee1973bfe81eea0f0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686a06bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28 SysCnt: 0 ShardingFlag: 1 Via: [118 16 253 102 194 114 51 46 221 89 164 52 96 173 36 238 225 151 59 254] ============================= &nbsp; 阅读更多","@type":"BlogPosting","url":"/2018/07/20/c651fa5316433733feb885076fe8ec61.html","headline":"第六篇 在墨客区块链(MOAC BlockChain) 测试网搭建子链","dateModified":"2018-07-20T00:00:00+08:00","datePublished":"2018-07-20T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/07/20/c651fa5316433733feb885076fe8ec61.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>第六篇 在墨客区块链(MOAC BlockChain) 测试网搭建子链</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="article-copyright">
   版权声明：Copyright Reserved © 2018-2020 https://blog.csdn.net/lyq13573221675/article/details/81125954 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css"> 
 <div class="htmledit_views"> 
  <p>北京时间2018年6月30日，MOAC子链正式上线公测。</p> 
  <p>北京时间2018年9月30日，MOAC发布<a href="https://github.com/MOACChain/moac-core/releases/tag/v1.0.3" rel="nofollow">Nuwa1.0.3</a>，该版本目前仅用于moac testnet。</p> 
  <p>以下为MOAC&nbsp;子链公测版安装及应用教程。</p> 
  <p>&nbsp;</p> 
  <p><strong>1.&nbsp;准备工作</strong></p> 
  <p>从MOAC版本发布页：<a href="https://github.com/MOACChain/moac-core/releases" rel="nofollow">https://github.com/MOACChain/moac-core/releases</a></p> 
  <p>下载Windows版本的系统软件包nuwa1.0.3.win.zip。</p> 
  <p>该版本适用于64位Windows 7及以上系统。本文实际操作环境为：64位Windows 10&nbsp;中文版。</p> 
  <p>本文主要内容来自MOAC中文wiki。建议操作前浏览子链相关内容。网址：</p> 
  <p><a href="https://github.com/delida/MoacDocs/wiki" rel="nofollow">https://github.com/delida/MoacDocs/wiki</a></p> 
  <p>&nbsp;</p> 
  <p><strong>2.&nbsp;产生本地MOAC节点</strong></p> 
  <p>解压系统软件包nuwa<strong>1.0.3.win.zip</strong>到本地硬盘。</p> 
  <p>安装节点到MOAC测试网。安装命令：</p> 
  <pre class="has">
<code>D:\nuwa1.0.3\vnode&gt;moac --testnet</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/201810091222331?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>注意：</strong>在moac测试网，任何情形使用moac命令启动节点均需要加--testnet。</p> 
  <p>节点自动安装到目录：C:\Users\[user]\AppData\Roaming\MoacNode\testnet</p> 
  <p>墨客测试网区块高度可以通过墨客测试网区块浏览器查询。</p> 
  <p>浏览器网址：<a href="http://47.75.144.55:3000/home" rel="nofollow">http://47.75.144.55:3000/home</a>。</p> 
  <p><span style="color:#f33b45;"><strong>特别注意：为了完成本篇文档的所有操作，需要用以下方式启动节点：</strong></span></p> 
  <pre class="has">
<code>D:\nuwa1.0.3\vnode&gt;moac --testnet --rpc --rpcapi "chain3,personal,mc,net,vnode" --rpccorsdomain "http://walletbeta.moac.io"</code></pre> 
  <p>使用该命令启动节点后，本编文档后面所用到的网页版钱包为：<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>。</p> 
  <p><strong>3.节点</strong><strong>基本操作</strong></p> 
  <p>此节内容参考文档《<a href="https://blog.csdn.net/lyq13573221675/article/details/81078424" rel="nofollow">第三篇 墨客区块链（MOAC BlockChain）节点安装教程</a>》。</p> 
  <p><strong>3.1 进入console界面</strong></p> 
  <p>系统关机或主动关闭运行中的节点后，如果需要重新启动节点，在命令行中执行：</p> 
  <pre class="has">
<code>D:\nuwa1.0.3\vnode&gt;moac –testnet</code></pre> 
  <p>命令执行后，界面一直滚屏以同步区块数据。</p> 
  <p><strong>3.2 进入attach界面</strong></p> 
  <p>打开另一个命令（cmd）终端，转到当前目录，在命令行中执行：</p> 
  <pre class="has">
<code>D:\nuwa1.0.3\vnode&gt;moac attach</code></pre> 
  <p>该命令依赖于节点已经启动，命令执行后不会主动滚屏，而是等待命令。</p> 
  <p><strong>3.3 创建账号</strong></p> 
  <p>进入MOAC console界面后，执行命令：</p> 
  <pre class="has">
<code>&gt; personal.newAccount()</code></pre> 
  <p>系统会在以下目录：C:\Users\[userName]\AppData\Roaming\MoacNode\testnet\keystore，记录一个账号文件。</p> 
  <p>请保存好该文件，并牢记密码。</p> 
  <p><strong>3.4 挖矿</strong></p> 
  <p>在测试网，可以尝试挖矿，用于之后操作的gas费，进入moac attach界面后：</p> 
  <p>开始挖矿，执行命令：</p> 
  <pre class="has">
<code>&gt; miner.start()</code></pre> 
  <p>停止挖矿，执行命令：</p> 
  <pre class="has">
<code>&gt; miner.stop()</code></pre> 
  <p>查看挖矿状态，执行命令：</p> 
  <pre class="has">
<code>&gt;mc.mining</code></pre> 
  <p>查看余额变动，执行命令：</p> 
  <pre class="has">
<code>&gt;loadScript("mctest.js")
&gt;checkBalance()</code></pre> 
  <p>&nbsp;</p> 
  <p><strong>4</strong><strong>.</strong><strong>scs注册</strong></p> 
  <p>此处内容参考中文wiki内容《SCS矿工参与方法》。</p> 
  <p><strong>4.1 部署子链矿池</strong></p> 
  <p>部署子链矿池智能合约，用于子链SCS节点矿工加入矿工池。</p> 
  <p>从MOAC版本发布页下载合约<strong>SubChainProtocolBase.sol</strong>。进行合约部署。</p> 
  <p>此处内容参考文档《<a href="https://blog.csdn.net/lyq13573221675/article/details/81085339" rel="nofollow">第四篇 在墨客区块链（MOAC BlockChain）部署ERC-20合约</a>》。</p> 
  <p>测试网部署合约使用的网页版钱包工具请登录：<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>。</p> 
  <p>部署时选择“Sub&nbsp;Chain Protocol Base”，填入参数Protocol（POS）、Bmin(1)和protocol type（0表示pos，1表示ipfs），如图所示。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181009122934108?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>成功部署后</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720094732579?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>注意：</strong>该步骤非必须，可以直接加入测试网已经存在的矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署子链矿池。</p> 
  <p>该合约地址经测试工作正常，用户可以在后面的步骤将scs注册到moac测试网公开的合约地址。</p> 
  <p>0x55db2865e29e8a1adC54fABDA221609536DD8b90</p> 
  <p><strong>4.2 启动SCS</strong></p> 
  <p>在下载的节点文件中，有一个scs目录。目录下有一个配置文件userconfig.json。其中的Beneficiary为矿工收益账号。为了安全起见，建议采用与scsid不同的墨客底层账号用来获取子链的收益（scsid将会在后面讲到）。</p> 
  <p>进入目录scs\scsserver启动scs：</p> 
  <pre class="has">
<code>D:\nuwa1.0.3\scs&gt;scsserver -p "password"</code></pre> 
  <p>命令中：如果直接运行scsserver，则默认密码为 moacscsofflineaccountpwd，使用参数-p，则可以自己设定scs账号密码。</p> 
  <p>启动后，SCS将会在当前目录下生成一个keystore目录，并在目录中新建一个账号，这个账号就是scsid。如果想换一个scsid，则需要删除该目录中所有新内容，仅保留原来的2个文件，重新启动。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181009122719361?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>可以根据实际需要，按照以上步骤重新启动一个或多个scs。单台电脑建议启动不超过3个scs。</p> 
  <p><strong>4.3 注册SCS</strong></p> 
  <p>在启动scs并已经知道一个子链矿池合约地址的情况下（见4.1节），可以进行注册。</p> 
  <p>写一个scsRegister.js，代码如下。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));
//scs注册
console.log('SCS Register start!');
var baseAddr = "0x7610fd66c272332edd59a43460ad24eee1973bfe";
var basePasswd = "password";
var protocolAddr = "0x225Ebb0b9DF76E3D48eA0614943340611f635EA0";
var scsAddr = "755a37ec5ba302cd0022af2b8e3ff97c1996601b";    //不带0x开头
chain3.personal.unlockAccount(baseAddr, basePasswd,0);
sendtx(baseAddr, protocolAddr, '5','0x4420e486000000000000000000000000' + scsAddr);
function sendtx(src, tgtaddr, amount, strData) {
    chain3.mc.sendTransaction(
        {
            from: src,
            value:chain3.toSha(amount,’mc’),
            to: tgtaddr,
            gas: "9000000",
            gasPrice: chain3.mc.gasPrice,
            data: strData
        });
    console.log('sending from:' +   src + ' to:' + tgtaddr  + ' with data:' + strData);
}</code></pre> 
  <p>主要参数如下：</p> 
  <ol>
   <li>baseAddr、basePasswd：主网的一个账户及其密码，付出本次交易的gas费及scs注册所需的押金（本例5mc）；</li> 
   <li>protocolAddr：步骤4.1子链矿池合约subchainprotocolbase地址；</li> 
   <li>scsAddr：步骤4.2的scsid地址，放在“…/scsserver/scskeystore”目录下；</li> 
   <li>注册mc数量，本例子中为5mc，此处必须大于矿池合约的设置值。scs提交押金越多，能参与的子链越多。</li> 
  </ol>
  <p><strong>特别注意：</strong>scsAddr的地址不要加上“0x”。</p> 
  <p>在文件目录下执行该注册文件scsRegister.js：</p> 
  <pre class="has">
<code>D:\nuwa1.0.3\scs&gt;node&nbsp;scsRegister.js</code></pre> 
  <p>在等待一定时间之后（通常是母链50个block），就进入子链矿池，成为该子链的候选SCS节点。注册后，保证金会从baseAddr账号转到子链矿池合约账号。</p> 
  <p>注册时缴纳的保证金，将在SCS被选中服务子链的时候临时扣除。下图为注册两个SCS，各交2个mc保证金的情况。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720104224357?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>该步骤也可以不使用代码，而是在<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>的合约功能处完成。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011100023128?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>其中：</p> 
  <ol>
   <li>Select function：选择合约功能Register；</li> 
   <li>Scs-address：填入要注册的scsid；</li> 
   <li>Execute from：使用有mc余额的账号，并且已经解锁，personal.unlockAccount；</li> 
   <li>Send mc：提交押金，应该多于scs池子合约所要求的最少押金；</li> 
  </ol>
  <p><strong>4.4 给SCS地址转账</strong></p> 
  <p>scs在跟底层vnode通信或被调用时，tx是需要交易费的，因此需要在scsid存入1个mc作为gas费。</p> 
  <p>给scsid转账跟向普通账户转账一样。</p> 
  <p><strong>4.5 查询SCS注册数量</strong></p> 
  <p>如果是使用网页版钱包部署的子链矿池合约，可以直接在界面看到scs注册数量等信息。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720111700974?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>或者，通过moac attach界面，使用合约地址查询注册scs数量</p> 
  <pre class="has">
<code>&gt; mc.getStorageAt("0x225Ebb0b9DF76E3D48eA0614943340611f635EA0",0x02)</code></pre> 
  <p style="text-align:center;"><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720112005243?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <p><strong>5</strong><strong>.</strong><strong>部署</strong><strong>Vnode</strong><strong>矿池合约</strong></p> 
  <p>此处内容参考中文wiki内容《代理vnode节点介绍》。</p> 
  <p><strong>5.1 部署vnode矿池</strong></p> 
  <p>从MOAC版本发布页下载合约<strong>VnodeProtocolBase.sol</strong></p> 
  <p>部署时选择“Vnode&nbsp;Protocol Base”，填入参数Bmin(1)，即最少押金为1。如图所示。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011101144621?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>成功后得到合约地址，用于后面vnode的注册。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720130040663?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>注意：</strong>该步骤非必须，可以直接加入测试网已经存在的Vnode池子。</p> 
  <p>用户可以不必自己部署合约，在后面的步骤将Vnode节点注册到该合约地址；或者不注册vnode，直接使用该Vnode池子合约地址，里面已经注册的Vnode将会为你的子链提供服务。</p> 
  <p>0x5B43583F33214c790B8206D9B06685c49A1DB455</p> 
  <p><strong>5.2 添加节点到vnode矿池</strong></p> 
  <p>添加本节点到vnode矿池的代码如下vnodeRegister.js，执行node即可。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));
//vnode register
var baseAddr = "0x7610fd66c272332edd59a43460ad24eee1973bfe";
var basePasswd = "password";
var vnodeChain = "0x0fB05e4a2b878855e27A7675135BecA0E257e896";
var vnodeAddr = "7610fd66c272332edd59a43460ad24eee1973bfe"; 

chain3.personal.unlockAccount(baseAddr,basePasswd,0);  //该步骤也可以在attach界面执行
sendtx(baseAddr, vnodeChain, '2','0x32434a2e000000000000000000000000' + vnodeAddr //数据1
    +'0000000000000000000000000000000000000000000000000000000000000040'//数据2
    +'0000000000000000000000000000000000000000000000000000000000000013'//数据3
    //192.168.10.16:50062（填入本机实际IP地址值，并修改数据3和数据4）
    +'3139322e3136382e31302e31363a353030363200000000000000000000000000');//数据4

function sendtx(src, tgtaddr, amount, strData) {
    chain3.mc.sendTransaction(
        {
            from: src,
            value:chain3.toSha(amount,'mc'),
            to: tgtaddr,
            gas: "9000000",
            gasPrice: chain3.mc.gasPrice,
            data: strData
        });
    console.log('sending from:' +   src + ' to:' + tgtaddr  + ' with data:' + strData);
}</code></pre> 
  <p>主要参数如下：</p> 
  <ol>
   <li>baseAddr、basePasswd：Dapp用户用来发送交易前账户解锁；</li> 
   <li>vnodeChain：部署VNODE-PROXY合约得到的合约地址；</li> 
   <li>vnodeAddr：vnodeconfig.json的VnodeBeneficialAddress</li> 
   <li>数据1：'0x32434a2e '是VNODE-PROXY合约 中‘register(address vnode, string link)’通过hash算法Keccak256得到前4个字节，本例押金交2mc；本例带两个参数；</li> 
  </ol>
  <p>添加成功后，启动节点方式不变。</p> 
  <p>该步骤也可以不使用代码，而是在<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>的合约功能处完成，前提是你已经部署了自己的Vnode Proxy池子合约（也就是5.1节的步骤）。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011103145238?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>其中：</p> 
  <ol>
   <li>Select function：选择合约功能Register；</li> 
   <li>Vnode-address：填入收益账号，一般是本地节点的挖矿账号；</li> 
   <li>Link-String：本节点主机的IP地址；</li> 
   <li>Send mc：提交押金，应该多于Vnode池子合约所要求的最少押金；</li> 
  </ol>
  <p><strong>注意：</strong>该步骤非必须，也就是说并不是必须把本节点注册为proxy Vnode，可以直接加入测试网已经存在的Vnode矿工池。仅在受网络限制，本节点不能同步的情况下，才必须自己部署Vnode矿池并将本节点注册为Vnode proxy。</p> 
  <p>&nbsp;</p> 
  <p><strong>6</strong><strong>.</strong><strong>部署子链合约</strong></p> 
  <p>此处内容参考中文wiki内容《DAPP用户的参与方法》。</p> 
  <p><strong>6.1 编译子链合约</strong></p> 
  <p>合约可以通过多种方式编译，比如在线编译工具remix等，如果是本地命令行编译，需要安装solidity环境。</p> 
  <pre class="has">
<code>D:\scs&gt;&nbsp;solcjs --bin --abi -o bin SubChainBase.sol SubChainProtocolBase.sol</code></pre> 
  <p>SubChainBase.sol是子链合约，其中import "./SubChainProtocolBase.sol";</p> 
  <p>因此要把SubChainProtocolBase.sol合约放在同一个目录下。</p> 
  <p>编译结果如果没有error，会在bin目录生成相应的*.bin和*.abi文件。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181009124417853?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>6.2 部署子链合约</strong></p> 
  <p>部署子链合约的代码如下deploySubChain.js，执行node即可。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));
//deploy subChainBase
chain3.personal.unlockAccount(chain3.mc.accounts[0], 'password',0);
var proto = "0x225Ebb0b9DF76E3D48eA0614943340611f635EA0" ;
var vnodeProtocolBaseAddr = "0x0fB05e4a2b878855e27A7675135BecA0E257e896" ;
var min = 1 ;
var max = 10 ;
var thousandth = 1 ;
var flushRound = 20 ;
var subchainbaseContract = chain3.mc.contract([{"constant":true,......,"type":"event"}]);
var subchainbase = subchainbaseContract.new(
    proto,
    vnodeProtocolBaseAddr,
    min,
    max,
    thousandth,
    flushRound,
    {
        from: chain3.mc.accounts[0], 
        data: '0x6060604052600c601555670d...708e8ee3c23da8b02d0278eb0029', 
        gas: '9000000'
    }, function (e, contract){
        console.log(e, contract);
        if (typeof contract.address !== 'undefined') {
            console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
        }
   }) </code></pre> 
  <p>子链控制合约subchainbase是DAPP用户使用子链的基本合约，其提供子链运行前和运行中的一些必要接口。</p> 
  <p>通常来说，子链控制合约subchainbase需要修改相应的内容如下：</p> 
  <ol>
   <li>参数proto：通过官方渠道获取到，或者自己部署的子链矿池合约subchainprotocolbase的地址，复制粘贴到此变量；</li> 
   <li>参数vnodeProtocolBaseAddr：通过官方渠道获取到，或者自己部署的代理智能合约vnodeprotocolbase的地址，复制粘贴到此变量；</li> 
   <li>参数min：子链运行后需要的SCS的最小数量，建议数量为1；</li> 
   <li>参数max：子链运行后需要的SCS的最大数量，建议数量为100；</li> 
   <li>参数thousandth：千分之几，默认为1；</li> 
   <li>参数flushRound：子链刷新周期（以母链block生成数量为准），小于100的值，合约会自动置为100；</li> 
   <li>合约部署时的gas值必须为9000000；</li> 
   <li>Chain3.mc.contract：其内容是6.1节编译结果的SubChainBase.abi；</li> 
   <li>data：其内容是6.1节编译结果的SubChainBase.bin，<strong>前面要加</strong><strong>”0x”</strong>。</li> 
  </ol>
  <p><strong>6.</strong><strong>3&nbsp;</strong><strong>子链控制合约信息</strong></p> 
  <p>部署成功后：</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011111344146?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>得到子链控制合约地址和本次交易hash。</p> 
  <p>该合约不是在网页版钱包部署的，因此不会在界面上显示，此时需要将该合约加到界面上。</p> 
  <p><img alt="" class="has" src="https://img-blog.csdnimg.cn/20181101142144228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1,size_16,color_FFFFFF,t_70"></p> 
  <p>点击“WATCH MOTHERCHAIN CONTRACT”按钮。</p> 
  <p><img alt="" class="has" src="https://img-blog.csdnimg.cn/2018110114223265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1,size_16,color_FFFFFF,t_70"></p> 
  <p>输入刚部署的合约的合约地址和JSON（就是合约的abiString），自己给合约取个名称，点击“好”，会在界面上增加该合约。之后对合约的操作跟使用网页版钱包部署成功的合约一致。</p> 
  <p><strong>6.4 子链开放注册</strong></p> 
  <p>通过开放子链注册，候选SCS内部完成注册，最终成为子链的一员，才有资格参与子链的相关业务。 需要注意的是：SCS参与子链注册是通过SCS地址（我们也称为scsid，放在“./scskeystore”目录下）发送交易到子链完成；因此需要给SCS地址储备一定量的moac，建议1个moac。同时子链合约需要最终提供gas费给scs，因此，也需要给子链控制合约发送一定量的moac。</p> 
  <p><span style="color:#f33b45;"><strong>请注意：</strong></span>给子链控制合约发送moac，不能直接send，需要用合约里的函数addFund（）。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181024132858414?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>部署子链开放注册的代码如下registerOpen.js，执行node即可。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));
//register open
var dappAddr = "0x7610fd66c272332edd59a43460ad24eee1973bfe";
var dappPasswd = "password";
var subchainAddr = "0x8a194e9567d7339b968dac61546a52f89a8c7a2f";//子链控制合约地址

chain3.personal.unlockAccount(dappAddr, dappPasswd,0);
sendtx(dappAddr, subchainAddr, '0','0x5defc56c' );

function sendtx(src, tgtaddr, amount, strData) {
    chain3.mc.sendTransaction(
         {
            from: src,
            value:chain3.toSha(amount,'mc'),
            to: tgtaddr,
            gas: "2000000",
            gasPrice: chain3.mc.gasPrice,
            data: strData
         }); 
    console.log('sending from:' +   src + ' to:' + tgtaddr  + ' with data:' + strData);  
}    </code></pre> 
  <ol>
   <li>dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁；</li> 
   <li>subchainAddr：部署子链控制合约subchainbase的地址；</li> 
   <li>数据：'0x5defc56c'是子链控制合约subchainbase中‘registerOpen()’通过hash算法Keccak256得到前4个字节，此处不用修改；</li> 
  </ol>
  <p>该步骤也可以不使用代码，而是在<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>的合约功能处完成。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018101112075779?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>6.5 查看注册情况</strong></p> 
  <p>通过registerOpen后，系统将自动选择符合条件的SCS节点并通知他们进行注册，DAPP用户需要通过如下方法查看已经注册完成的SCS节点数目（nodeCount）：</p> 
  <pre class="has">
<code>&gt;mc.getStorageAt(subchainAddr,0x0e)</code></pre> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720153425734?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>通过合约地址subchainAddr查询合约中第0x0e个public成员变量（即nodeCount）的值，请不要修改此值 当达到子链运行需要的SCS的数量区间后，即可进入RegisterClose步骤。</p> 
  <p>该步骤也可以在<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>的合约功能处直接查看。还可以查询已经注册的scs的id。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011120935137?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p><strong>6.6 子链关闭注册</strong></p> 
  <p>首先介绍一下RegisterClose的主要工作：</p> 
  <ol>
   <li>Dapp用户设置子链关闭注册；</li> 
   <li>已经注册SCS数目必须不小于子链要求的最小数目，否则子链注册无效；</li> 
   <li>主网广播通知所有的协议合约中候选SCS，包括已经注册的成功的SCS；</li> 
   <li>SCS收到广播后，SCS自身完成初始化并开始子链运行。</li> 
  </ol>
  <p>关闭子链注册后，候选SCS不能再通过subchain RegisterOpen方式注册该子链，已经注册的SCS处于正常运行状态，参与子链的相关业务，如：处理交易、出块、刷新等。</p> 
  <p>部署子链关闭注册的代码如下registerClose.js，执行node即可。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));
//register open
var dappAddr = "0x7610fd66c272332edd59a43460ad24eee1973bfe";
var dappPasswd = "password";
var subchainAddr = "0x8a194e9567d7339b968dac61546a52f89a8c7a2f";//子链控制合约地址

chain3.personal.unlockAccount(dappAddr, dappPasswd,0);
sendtx(dappAddr, subchainAddr, '0','0x69f3576f' );

function sendtx(src, tgtaddr, amount, strData) {
    chain3.mc.sendTransaction(
         {
             from: src,
             value:chain3.toSha(amount,'mc'),
             to: tgtaddr,
             gas: "2000000",
             gasPrice: chain3.mc.gasPrice,
             data: strData
          }); 
    console.log('sending from:' +   src + ' to:' + tgtaddr  + ' with data:' + strData);
}   </code></pre> 
  <p>其中，</p> 
  <ol>
   <li>dappAddr、dappPasswd：Dapp用户用来发送交易前账户解锁；</li> 
   <li>subchainAddr：部署子链合约得到的合约地址；</li> 
   <li>数据：'0x69f3576f'是子链控制合约subchainbase中‘registerClose()’通过hash算法Keccak256得到前4个字节；</li> 
  </ol>
  <p>执行完毕，如果一切正常，子链建成并开始出块。</p> 
  <p>该步骤也可以不使用代码，而是在<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>的合约功能处完成。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011121045605?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>实测环境中3个scs轮流出块，显示如下。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720173719129?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>图中显示本scs出块正常，当前为子链第15个区块，由本scs挖矿出块成功。</p> 
  <p>如果是同步其他scs出的子链区块，“SendBkToVnode”显示为“Insert”，也就是同步其他scs的区块。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720173741676?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>至此，子链部署完成。</p> 
  <p>&nbsp;</p> 
  <p><strong>7.SCS monitor</strong></p> 
  <p>Monitor是一个特殊的SCS节点，它是一种模式，DAPP用户可以通过这个节点来监控自己的子链运行状态和业务数据。</p> 
  <p>SCS Monitor不参与子链共识，因此只能查看，不能修改数据。即使子链已经运行，Monitor也能注册加入。</p> 
  <p>Monitor SCS启动方式为：</p> 
  <pre class="has">
<code>D:\nuwa1.0.3\scs&gt;scsserver -p "password" --rpcaddr 0.0.0.0 --rpcport 2345</code></pre> 
  <p>启动后，DAPP用户通过调用子链控制合约subchainbase中的registerAsMonitor方法使Monitor SCS接入子链同步数据。</p> 
  <p>部署子链开放注册的代码如下registerAsMonitor.js，执行node即可。</p> 
  <pre class="has">
<code>var Chain3 = require('chain3');
var chain3 = new Chain3(new Chain3.providers.HttpProvider('http://localhost:8545'));
//register as monitor
var dappAddr = "0x7610fd66c272332edd59a43460ad24eee1973bfe";
var dappPasswd = "password";
var subchainAddr = "0x4132d3d98e5781507633dfd2248d810ab05d1431";//子链控制合约地址
var scsAddr =  "d35eb82143aa45857bb5324a3b5b493d4078e812";      //monitor的scsid，不带0x开头

subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,'1',scsAddr);

function subchainRegisterAsMonitor (dappAddr,dappPasswd,subchainAddr,amount,scsAddr)
{
	chain3.mc.sendTransaction(
         {
             from: dappAddr,
             value:chain3.toSha(amount,'mc'),
             to: subchainAddr,
             gas: "2000000",
             gasPrice: chain3.mc.gasPrice,
             data: '0x4e592e2f000000000000000000000000' + scsAddr
          }); 
    console.log('sending from:' +   dappAddr + ' to:' + subchainAddr  + ' with data:' + '0x4e592e2f000000000000000000000000' + scsAddr);

}</code></pre> 
  <p>部署成功后可以看到，SCS monitor开始同步子链区块。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181009160022992?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>该步骤也可以不使用代码，而是在<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>的合约功能处完成。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011121631830?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>&nbsp;</p> 
  <p><strong>8.在子链部署业务逻辑合约</strong></p> 
  <p><strong>8.1 使用钱包工具部署业务逻辑合约</strong></p> 
  <p>登录<a href="http://walletbeta.moac.io" rel="nofollow">http://walletbeta.moac.io</a>，点击“部署新合约”。</p> 
  <p>本文档使用一个简单的合约，mySubContract.sol，代码如下：</p> 
  <pre class="has">
<code>pragma solidity ^0.4.18;

contract Calc{
	uint public count;
	uint public equation;

	function add(uint a, uint b){
		count++;
		equation = a + b; 
	}

	function getCount() constant returns (uint){
		return count;
	}

	function getEquation() constant returns (uint){
		return equation;
	}
}</code></pre> 
  <p>部署子链业务逻辑合约时，勾选复选框“MicroChain Dapp”；</p> 
  <ol>
   <li>MicroChain Base&nbsp;Address：在里面填上子链控制合约的地址；</li> 
   <li>SCS Monitor Address：填写SCS Monitor的IP地址（本机可以用127.0.0.1）；</li> 
   <li>SCS Monitor Port：SCS Monitor启动端口。</li> 
  </ol>
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181014124212723?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>然后填写合约的内容，按步骤即可成功部署子链业务逻辑合约。同时在contract页面的MICROCHAIN CONTRACTS显示。</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181011163935812?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>点击进去，会发现显示的合约地址仍然是子链控制合约地址，同时显示scs monitor的address和port；</p> 
  <p>右边的合约函数就是业务逻辑合约的函数。&nbsp;</p> 
  <p><img alt="" class="has" src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20181014124715635?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2x5cTEzNTczMjIxNjc1/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70"></p> 
  <p>请注意，此时Nonce值应该自动是1，才是正确状态，如果等待很久之后还是0或者-1，则表示没有部署成功。</p> 
  <p>部署不成功的原因很多，比如本地网路问题，或者scs出块时子链分叉等。</p> 
  <p>正常后，可以对子链业务逻辑合约进行操作，每次操作成功后，Nonce会自动增加1。</p> 
  <p>本例中，左边可以直接看到测试运算结果。</p> 
  <p>在对子链业务逻辑合约的操作中，可以在scs monitor界面看到交易的发送情况，基本格式如下：</p> 
  <pre class="has">
<code>		====== Transactions: 1 =====
		
	TX(f3eb6baf45ff003f766d88bf7dddd6894ec4bf72ebdae1a2931241674ad7f8d4)
	Contract: false
	From:     7610fd66c272332edd59a43460ad24eee1973bfe
	To:       6b4e01e1598fdabd7c926260ae614005bf1cc9a0
	Nonce:    1
	GasPrice: 0x4a817c800
	GasLimit  0x0
	Value:    0x0
	Data:     0x771602f700000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000005
	V:        0xee
	R:        0xf0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686
	S:        0x6bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28
	Hex:      f8bf01808504a817c80080946b4e01e1598fdabd7c926260ae614005bf1cc9a080b844771602f70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000501947610fd66c272332edd59a43460ad24eee1973bfe81eea0f0023109bd51efc72702637bf4ef3c7ca11df228bf258d1b31ed593c2e9f9686a06bdd7642aa10d94e837ee9ae5c39ee25be395182355cab554a6ec4b67534fe28
	SysCnt:	  0
	ShardingFlag: 1
	Via:	  [118 16 253 102 194 114 51 46 221 89 164 52 96 173 36 238 225 151 59 254]

		=============================</code></pre> 
  <p>&nbsp;</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lyq13573221675/article/details/81125954,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lyq13573221675/article/details/81125954,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
