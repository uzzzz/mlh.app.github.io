<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>【fabric 2】v1.0环境搭建详细过程 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="【fabric 2】v1.0环境搭建详细过程" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="搭建fabric网络的详细步骤大都隐藏在官方的脚本中，本文详细了解下脚本的执行过程 1.生成各节点需要的公私钥证书 1.1编译生成cryptogen cd ~/github.com/hyperledger/fabric make cryptogen //编译生成cryptogen 正常编译通过后会如下图所示并且在build/bin/目录下可以看到cryptogen Tips： 我在执行这步操作的时候遇到了fatal error:ltdl.h:no such file or directory的错误。 安装libltdl-dev解决：sudo apt-get install libltdl-dev 1.2用cryptogen生成公私钥 cd examples/e2e_cli/ ../../build/bin/cryptogen generate --config=./crypto-config.yaml //根据crypto-confgi.yaml生成公私钥证书，生成的文件都存放在crypto-config文件夹中 tree crypto-config 2.生成创世区块和channel配置区块 2.1生成configtxgen cd ~/github.com/hyperledger/fabric make configtxgen //编译生成configtxgen 正常编译通过后会如下图所示并且在build/bin/目录下可以看到configtxgen 2.2生成创世区块 cd examples/e2e_cli/ ../../build/bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block 2.3生成channel区块 ../../build/bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel 2.4更新锚节点 ../../build/bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP ../../build/bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP 上述步骤执行完毕后在channel-artifacts目录下应该有4个文件 3.配置docker-compose orderer配置参考base/docker-compose-base.yaml orderer.example.com: container_name: orderer.example.com image: hyperledger/fabric-orderer environment: - ORDERER_GENERAL_LOGLEVEL=debug - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp # enabled TLS - ORDERER_GENERAL_TLS_ENABLED=true - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt] - ORDERER_KAFKA_RETRY_SHORTINTERVAL=1s - ORDERER_KAFKA_RETRY_SHORTTOTAL=30s - ORDERER_KAFKA_VERBOSE=true working_dir: /opt/gopath/src/github.com/hyperledger/fabric command: orderer volumes: - ../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls ports: - 7050:7050 peer的配置参考base/docker-compose-base.yaml和peer-base.yaml peer-base: image: hyperledger/fabric-peer environment: - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock # the following setting starts chaincode containers on the same # bridge network as the peers # https://docs.docker.com/compose/networking/ - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2e_default #- CORE_LOGGING_LEVEL=ERROR - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_TLS_ENABLED=true - CORE_PEER_GOSSIP_USELEADERELECTION=true - CORE_PEER_GOSSIP_ORGLEADER=false - CORE_PEER_PROFILE_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: peer node start peer0.org1.example.com: container_name: peer0.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org1.example.com - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_CHAINCODEADDRESS=peer0.org1.example.com:7052 - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 7051:7051 - 7052:7052 - 7053:7053 CLI的配置参考docker-compose-cli.yaml cli: container_name: cli image: hyperledger/fabric-tools tty: true environment: - GOPATH=/opt/gopath - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_ID=cli - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP - CORE_PEER_LOCALMSPTYPE=bccsp - CORE_PEER_TLS_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39; volumes: - /var/run/:/host/var/run/ - ../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts depends_on: - orderer.example.com - peer0.org1.example.com - peer1.org1.example.com - peer0.org2.example.com - peer1.org2.example.com 需要注意的一点是，我们需要注释掉cli配置脚本中的command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39;因为我们接下来会手动执行./scripts/script.sh中的内容。 4.初始化fabric网络环境 4.1启动docker容器 docker-compose -f docker-compose-cli.yaml up -d docker ps 可以看到cli + orderer + 4 peer已经启动 4.2创建channel channel本身是存在于orderer节点内部的 对于channel的理解，可以参考“我和你不在一个channel”~ 也就是说，两个结点要想发生交易，它们必须加入同一个channel。 另外，block账本和channel也是一对一的关系，即一个channel一个账本。 docker exec -it cli bash //创建channel需要先进入cli ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true --cafile $ORDERER_CA 执行成功会在cli内部生成一个mychannel.block文件，后续peer节点加入channel需要用到这个文件 4.3peer加入channel cli默认连接的是peer0.org1(docker-compose-cli.yaml中的默认配置)，所以如果将peero.org1加入channel就非常简单 peer channel join -b mychannel.block 其他几个peer要想加入channel就需要先修改cli的环境变量，然后再执行peer channel join //peer1.org1 join CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer1.org1.example.com:7051 peer channel join -b mychannel.block //peer0.org2 join CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel join -b mychannel.block //peer1.org2 join CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer1.org2.example.com:7051 peer channel join -b mychannel.block 4.4更新AnchorPeer节点 //更新Org1的anchor节点peer0.org1 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --tls true --cafile $ORDERER_CA //更新Org2的anchor节点peer0.org2 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --tls true --cafile $ORDERER_CA 5.安装并运行chaincode 以chaincode_example02为例，这个chaincode实现了a,b两个账户转账的功能 5.1 install chaincode 安装过程指的是对指定代码进行编译打包并发送到指定peer节点 //在peer0.org1上安装chaincode CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 5.2 instantiate chaincode 在peer所在的基础上对chaincode进行包装，生成对应channel的docker容器 peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; 执行docker ps可以看到多了一个dev-peer0.org1.example.com-mycc-1.0的image 5.3 invoke chaincode peer chaincode query -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; //查询账户a余额 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; //转账：a-&gt;b 10 5.4 在另一个节点查询交易 //在peer0.org2上安装chaincode CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 peer chaincode query -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; //查询a账户余额 初始化时a账户余额为100，刚在peer0.org1上执行了a向b转账10的操作，我们发现，在peer0.org2上执行的查询结果也是更新后的，为90. 并且此时若再执行docker ps我们会发现也为peer0.org2创建了一个docker镜像 阅读更多" />
<meta property="og:description" content="搭建fabric网络的详细步骤大都隐藏在官方的脚本中，本文详细了解下脚本的执行过程 1.生成各节点需要的公私钥证书 1.1编译生成cryptogen cd ~/github.com/hyperledger/fabric make cryptogen //编译生成cryptogen 正常编译通过后会如下图所示并且在build/bin/目录下可以看到cryptogen Tips： 我在执行这步操作的时候遇到了fatal error:ltdl.h:no such file or directory的错误。 安装libltdl-dev解决：sudo apt-get install libltdl-dev 1.2用cryptogen生成公私钥 cd examples/e2e_cli/ ../../build/bin/cryptogen generate --config=./crypto-config.yaml //根据crypto-confgi.yaml生成公私钥证书，生成的文件都存放在crypto-config文件夹中 tree crypto-config 2.生成创世区块和channel配置区块 2.1生成configtxgen cd ~/github.com/hyperledger/fabric make configtxgen //编译生成configtxgen 正常编译通过后会如下图所示并且在build/bin/目录下可以看到configtxgen 2.2生成创世区块 cd examples/e2e_cli/ ../../build/bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block 2.3生成channel区块 ../../build/bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel 2.4更新锚节点 ../../build/bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP ../../build/bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP 上述步骤执行完毕后在channel-artifacts目录下应该有4个文件 3.配置docker-compose orderer配置参考base/docker-compose-base.yaml orderer.example.com: container_name: orderer.example.com image: hyperledger/fabric-orderer environment: - ORDERER_GENERAL_LOGLEVEL=debug - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp # enabled TLS - ORDERER_GENERAL_TLS_ENABLED=true - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt] - ORDERER_KAFKA_RETRY_SHORTINTERVAL=1s - ORDERER_KAFKA_RETRY_SHORTTOTAL=30s - ORDERER_KAFKA_VERBOSE=true working_dir: /opt/gopath/src/github.com/hyperledger/fabric command: orderer volumes: - ../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls ports: - 7050:7050 peer的配置参考base/docker-compose-base.yaml和peer-base.yaml peer-base: image: hyperledger/fabric-peer environment: - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock # the following setting starts chaincode containers on the same # bridge network as the peers # https://docs.docker.com/compose/networking/ - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2e_default #- CORE_LOGGING_LEVEL=ERROR - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_TLS_ENABLED=true - CORE_PEER_GOSSIP_USELEADERELECTION=true - CORE_PEER_GOSSIP_ORGLEADER=false - CORE_PEER_PROFILE_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: peer node start peer0.org1.example.com: container_name: peer0.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org1.example.com - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_CHAINCODEADDRESS=peer0.org1.example.com:7052 - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 7051:7051 - 7052:7052 - 7053:7053 CLI的配置参考docker-compose-cli.yaml cli: container_name: cli image: hyperledger/fabric-tools tty: true environment: - GOPATH=/opt/gopath - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_ID=cli - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP - CORE_PEER_LOCALMSPTYPE=bccsp - CORE_PEER_TLS_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39; volumes: - /var/run/:/host/var/run/ - ../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts depends_on: - orderer.example.com - peer0.org1.example.com - peer1.org1.example.com - peer0.org2.example.com - peer1.org2.example.com 需要注意的一点是，我们需要注释掉cli配置脚本中的command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39;因为我们接下来会手动执行./scripts/script.sh中的内容。 4.初始化fabric网络环境 4.1启动docker容器 docker-compose -f docker-compose-cli.yaml up -d docker ps 可以看到cli + orderer + 4 peer已经启动 4.2创建channel channel本身是存在于orderer节点内部的 对于channel的理解，可以参考“我和你不在一个channel”~ 也就是说，两个结点要想发生交易，它们必须加入同一个channel。 另外，block账本和channel也是一对一的关系，即一个channel一个账本。 docker exec -it cli bash //创建channel需要先进入cli ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true --cafile $ORDERER_CA 执行成功会在cli内部生成一个mychannel.block文件，后续peer节点加入channel需要用到这个文件 4.3peer加入channel cli默认连接的是peer0.org1(docker-compose-cli.yaml中的默认配置)，所以如果将peero.org1加入channel就非常简单 peer channel join -b mychannel.block 其他几个peer要想加入channel就需要先修改cli的环境变量，然后再执行peer channel join //peer1.org1 join CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer1.org1.example.com:7051 peer channel join -b mychannel.block //peer0.org2 join CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel join -b mychannel.block //peer1.org2 join CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer1.org2.example.com:7051 peer channel join -b mychannel.block 4.4更新AnchorPeer节点 //更新Org1的anchor节点peer0.org1 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --tls true --cafile $ORDERER_CA //更新Org2的anchor节点peer0.org2 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --tls true --cafile $ORDERER_CA 5.安装并运行chaincode 以chaincode_example02为例，这个chaincode实现了a,b两个账户转账的功能 5.1 install chaincode 安装过程指的是对指定代码进行编译打包并发送到指定peer节点 //在peer0.org1上安装chaincode CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 5.2 instantiate chaincode 在peer所在的基础上对chaincode进行包装，生成对应channel的docker容器 peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; 执行docker ps可以看到多了一个dev-peer0.org1.example.com-mycc-1.0的image 5.3 invoke chaincode peer chaincode query -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; //查询账户a余额 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; //转账：a-&gt;b 10 5.4 在另一个节点查询交易 //在peer0.org2上安装chaincode CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 peer chaincode query -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; //查询a账户余额 初始化时a账户余额为100，刚在peer0.org1上执行了a向b转账10的操作，我们发现，在peer0.org2上执行的查询结果也是更新后的，为90. 并且此时若再执行docker ps我们会发现也为peer0.org2创建了一个docker镜像 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-19T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"搭建fabric网络的详细步骤大都隐藏在官方的脚本中，本文详细了解下脚本的执行过程 1.生成各节点需要的公私钥证书 1.1编译生成cryptogen cd ~/github.com/hyperledger/fabric make cryptogen //编译生成cryptogen 正常编译通过后会如下图所示并且在build/bin/目录下可以看到cryptogen Tips： 我在执行这步操作的时候遇到了fatal error:ltdl.h:no such file or directory的错误。 安装libltdl-dev解决：sudo apt-get install libltdl-dev 1.2用cryptogen生成公私钥 cd examples/e2e_cli/ ../../build/bin/cryptogen generate --config=./crypto-config.yaml //根据crypto-confgi.yaml生成公私钥证书，生成的文件都存放在crypto-config文件夹中 tree crypto-config 2.生成创世区块和channel配置区块 2.1生成configtxgen cd ~/github.com/hyperledger/fabric make configtxgen //编译生成configtxgen 正常编译通过后会如下图所示并且在build/bin/目录下可以看到configtxgen 2.2生成创世区块 cd examples/e2e_cli/ ../../build/bin/configtxgen -profile TwoOrgsOrdererGenesis -outputBlock ./channel-artifacts/genesis.block 2.3生成channel区块 ../../build/bin/configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel 2.4更新锚节点 ../../build/bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP ../../build/bin/configtxgen -profile TwoOrgsChannel -outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP 上述步骤执行完毕后在channel-artifacts目录下应该有4个文件 3.配置docker-compose orderer配置参考base/docker-compose-base.yaml orderer.example.com: container_name: orderer.example.com image: hyperledger/fabric-orderer environment: - ORDERER_GENERAL_LOGLEVEL=debug - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 - ORDERER_GENERAL_GENESISMETHOD=file - ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block - ORDERER_GENERAL_LOCALMSPID=OrdererMSP - ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp # enabled TLS - ORDERER_GENERAL_TLS_ENABLED=true - ORDERER_GENERAL_TLS_PRIVATEKEY=/var/hyperledger/orderer/tls/server.key - ORDERER_GENERAL_TLS_CERTIFICATE=/var/hyperledger/orderer/tls/server.crt - ORDERER_GENERAL_TLS_ROOTCAS=[/var/hyperledger/orderer/tls/ca.crt] - ORDERER_KAFKA_RETRY_SHORTINTERVAL=1s - ORDERER_KAFKA_RETRY_SHORTTOTAL=30s - ORDERER_KAFKA_VERBOSE=true working_dir: /opt/gopath/src/github.com/hyperledger/fabric command: orderer volumes: - ../channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:/var/hyperledger/orderer/msp - ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/:/var/hyperledger/orderer/tls ports: - 7050:7050 peer的配置参考base/docker-compose-base.yaml和peer-base.yaml peer-base: image: hyperledger/fabric-peer environment: - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock # the following setting starts chaincode containers on the same # bridge network as the peers # https://docs.docker.com/compose/networking/ - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2e_default #- CORE_LOGGING_LEVEL=ERROR - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_TLS_ENABLED=true - CORE_PEER_GOSSIP_USELEADERELECTION=true - CORE_PEER_GOSSIP_ORGLEADER=false - CORE_PEER_PROFILE_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/etc/hyperledger/fabric/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/etc/hyperledger/fabric/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/etc/hyperledger/fabric/tls/ca.crt working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: peer node start peer0.org1.example.com: container_name: peer0.org1.example.com extends: file: peer-base.yaml service: peer-base environment: - CORE_PEER_ID=peer0.org1.example.com - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_CHAINCODEADDRESS=peer0.org1.example.com:7052 - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052 - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP volumes: - /var/run/:/host/var/run/ - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp:/etc/hyperledger/fabric/msp - ../crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls:/etc/hyperledger/fabric/tls ports: - 7051:7051 - 7052:7052 - 7053:7053 CLI的配置参考docker-compose-cli.yaml cli: container_name: cli image: hyperledger/fabric-tools tty: true environment: - GOPATH=/opt/gopath - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_LOGGING_LEVEL=DEBUG - CORE_PEER_ID=cli - CORE_PEER_ADDRESS=peer0.org1.example.com:7051 - CORE_PEER_LOCALMSPID=Org1MSP - CORE_PEER_LOCALMSPTYPE=bccsp - CORE_PEER_TLS_ENABLED=true - CORE_PEER_TLS_CERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.crt - CORE_PEER_TLS_KEY_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/server.key - CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt - CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39; volumes: - /var/run/:/host/var/run/ - ../chaincode/go/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go - ./crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ - ./scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ - ./channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts depends_on: - orderer.example.com - peer0.org1.example.com - peer1.org1.example.com - peer0.org2.example.com - peer1.org2.example.com 需要注意的一点是，我们需要注释掉cli配置脚本中的command: /bin/bash -c &#39;./scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT&#39;因为我们接下来会手动执行./scripts/script.sh中的内容。 4.初始化fabric网络环境 4.1启动docker容器 docker-compose -f docker-compose-cli.yaml up -d docker ps 可以看到cli + orderer + 4 peer已经启动 4.2创建channel channel本身是存在于orderer节点内部的 对于channel的理解，可以参考“我和你不在一个channel”~ 也就是说，两个结点要想发生交易，它们必须加入同一个channel。 另外，block账本和channel也是一对一的关系，即一个channel一个账本。 docker exec -it cli bash //创建channel需要先进入cli ORDERER_CA=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem peer channel create -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/channel.tx --tls true --cafile $ORDERER_CA 执行成功会在cli内部生成一个mychannel.block文件，后续peer节点加入channel需要用到这个文件 4.3peer加入channel cli默认连接的是peer0.org1(docker-compose-cli.yaml中的默认配置)，所以如果将peero.org1加入channel就非常简单 peer channel join -b mychannel.block 其他几个peer要想加入channel就需要先修改cli的环境变量，然后再执行peer channel join //peer1.org1 join CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer1.org1.example.com:7051 peer channel join -b mychannel.block //peer0.org2 join CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel join -b mychannel.block //peer1.org2 join CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer1.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer1.org2.example.com:7051 peer channel join -b mychannel.block 4.4更新AnchorPeer节点 //更新Org1的anchor节点peer0.org1 CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx --tls true --cafile $ORDERER_CA //更新Org2的anchor节点peer0.org2 CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer channel update -o orderer.example.com:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx --tls true --cafile $ORDERER_CA 5.安装并运行chaincode 以chaincode_example02为例，这个chaincode实现了a,b两个账户转账的功能 5.1 install chaincode 安装过程指的是对指定代码进行编译打包并发送到指定peer节点 //在peer0.org1上安装chaincode CORE_PEER_LOCALMSPID=&quot;Org1MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp CORE_PEER_ADDRESS=peer0.org1.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 5.2 instantiate chaincode 在peer所在的基础上对chaincode进行包装，生成对应channel的docker容器 peer chaincode instantiate -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; 执行docker ps可以看到多了一个dev-peer0.org1.example.com-mycc-1.0的image 5.3 invoke chaincode peer chaincode query -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; //查询账户a余额 peer chaincode invoke -o orderer.example.com:7050 --tls true --cafile $ORDERER_CA -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; //转账：a-&gt;b 10 5.4 在另一个节点查询交易 //在peer0.org2上安装chaincode CORE_PEER_LOCALMSPID=&quot;Org2MSP&quot; CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp CORE_PEER_ADDRESS=peer0.org2.example.com:7051 peer chaincode install -n mycc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 peer chaincode query -C mychannel -n mycc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; //查询a账户余额 初始化时a账户余额为100，刚在peer0.org1上执行了a向b转账10的操作，我们发现，在peer0.org2上执行的查询结果也是更新后的，为90. 并且此时若再执行docker ps我们会发现也为peer0.org2创建了一个docker镜像 阅读更多","@type":"BlogPosting","url":"/2018/07/19/25ba0f597b883c30670d119aa4da649e.html","headline":"【fabric 2】v1.0环境搭建详细过程","dateModified":"2018-07-19T00:00:00+08:00","datePublished":"2018-07-19T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/07/19/25ba0f597b883c30670d119aa4da649e.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>【fabric 2】v1.0环境搭建详细过程</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <p>搭建fabric网络的详细步骤大都隐藏在官方的脚本中，本文详细了解下脚本的执行过程</p> 
  <h2 id="1生成各节点需要的公私钥证书">1.生成各节点需要的公私钥证书</h2> 
  <p><strong>1.1编译生成cryptogen</strong></p> 
  <pre class="prettyprint"><code class=" hljs javascript">cd ~<span class="hljs-regexp">/github.com/</span>hyperledger/fabric
make cryptogen  <span class="hljs-comment">//编译生成cryptogen</span></code></pre> 
  <p>正常编译通过后会如下图所示并且在build/bin/目录下可以看到cryptogen <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180719160750131?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> Tips： <br> 我在执行这步操作的时候遇到了<code>fatal error:ltdl.h:no such file or directory</code>的错误。 <br> 安装libltdl-dev解决：<code>sudo apt-get install libltdl-dev</code></p> 
  <p><strong>1.2用cryptogen生成公私钥</strong></p> 
  <pre class="prettyprint"><code class=" hljs lasso">cd examples/e2e_cli<span class="hljs-subst">/</span>
<span class="hljs-built_in">..</span><span class="hljs-subst">/</span><span class="hljs-built_in">..</span>/build/bin/cryptogen generate <span class="hljs-subst">--</span>config<span class="hljs-subst">=</span><span class="hljs-built_in">.</span>/crypto<span class="hljs-attribute">-config</span><span class="hljs-built_in">.</span>yaml    <span class="hljs-comment">//根据crypto-confgi.yaml生成公私钥证书，生成的文件都存放在crypto-config文件夹中</span>
tree crypto<span class="hljs-attribute">-config</span>  </code></pre> 
  <h2 id="2生成创世区块和channel配置区块">2.生成创世区块和channel配置区块</h2> 
  <p><strong>2.1生成configtxgen</strong></p> 
  <pre class="prettyprint"><code class=" hljs javascript">cd ~<span class="hljs-regexp">/github.com/</span>hyperledger/fabric
make configtxgen <span class="hljs-comment">//编译生成configtxgen</span></code></pre> 
  <p>正常编译通过后会如下图所示并且在build/bin/目录下可以看到configtxgen <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180719162510911?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> <strong>2.2生成创世区块</strong></p> 
  <pre class="prettyprint"><code class=" hljs lasso">cd examples/e2e_cli<span class="hljs-subst">/</span>
<span class="hljs-built_in">..</span><span class="hljs-subst">/</span><span class="hljs-built_in">..</span>/build/bin/configtxgen <span class="hljs-attribute">-profile</span> TwoOrgsOrdererGenesis <span class="hljs-attribute">-outputBlock</span> <span class="hljs-built_in">.</span>/channel<span class="hljs-attribute">-artifacts</span>/genesis<span class="hljs-built_in">.</span>block</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018071916283264?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> <strong>2.3生成channel区块</strong></p> 
  <pre class="prettyprint"><code class=" hljs lasso"><span class="hljs-built_in">..</span><span class="hljs-subst">/</span><span class="hljs-built_in">..</span>/build/bin/configtxgen <span class="hljs-attribute">-profile</span> TwoOrgsChannel <span class="hljs-attribute">-outputCreateChannelTx</span> <span class="hljs-built_in">.</span>/channel<span class="hljs-attribute">-artifacts</span>/channel<span class="hljs-built_in">.</span>tx <span class="hljs-attribute">-channelID</span> mychannel</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180719163108907?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> <strong>2.4更新锚节点</strong></p> 
  <pre class="prettyprint"><code class=" hljs lasso"><span class="hljs-built_in">..</span><span class="hljs-subst">/</span><span class="hljs-built_in">..</span>/build/bin/configtxgen <span class="hljs-attribute">-profile</span> TwoOrgsChannel <span class="hljs-attribute">-outputAnchorPeersUpdate</span> <span class="hljs-built_in">.</span>/channel<span class="hljs-attribute">-artifacts</span>/Org1MSPanchors<span class="hljs-built_in">.</span>tx <span class="hljs-attribute">-channelID</span> mychannel <span class="hljs-attribute">-asOrg</span> Org1MSP
<span class="hljs-built_in">..</span><span class="hljs-subst">/</span><span class="hljs-built_in">..</span>/build/bin/configtxgen <span class="hljs-attribute">-profile</span> TwoOrgsChannel <span class="hljs-attribute">-outputAnchorPeersUpdate</span> <span class="hljs-built_in">.</span>/channel<span class="hljs-attribute">-artifacts</span>/Org2MSPanchors<span class="hljs-built_in">.</span>tx <span class="hljs-attribute">-channelID</span> mychannel <span class="hljs-attribute">-asOrg</span> Org2MSP</code></pre> 
  <p>上述步骤执行完毕后在channel-artifacts目录下应该有4个文件 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180719163536925?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
  <h2 id="3配置docker-compose">3.配置docker-compose</h2> 
  <p>orderer配置参考base/docker-compose-base.yaml</p> 
  <pre class="prettyprint"><code class=" hljs haml">orderer.example.com:
    container_name: orderer.example.com
    image: hyperledger/fabric-orderer
    environment:
      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LOGLEVEL</span>=debug </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LISTENADDRESS</span>=<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span> </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_GENESISMETHOD</span>=file </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_GENESISFILE</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/orderer</span>.genesis.block </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LOCALMSPID</span>=<span class="hljs-constant">OrdererMSP</span> </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_LOCALMSPDIR</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/msp</span> </span>      # enabled TLS
      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_PRIVATEKEY</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/tls</span><span class="hljs-regexp">/server.key </span></span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_CERTIFICATE</span>=<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/tls</span><span class="hljs-regexp">/server.crt </span></span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_GENERAL_TLS_ROOTCAS</span>=[<span class="hljs-regexp">/var/hyperledger</span><span class="hljs-regexp">/orderer/tls</span><span class="hljs-regexp">/ca.crt] </span></span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_KAFKA_RETRY_SHORTINTERVAL</span>=<span class="hljs-number">1</span>s </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_KAFKA_RETRY_SHORTTOTAL</span>=<span class="hljs-number">30</span>s </span>      -<span class="ruby"> <span class="hljs-constant">ORDERER_KAFKA_VERBOSE</span>=<span class="hljs-keyword">true</span> </span>    working_dir: /opt/gopath/src/github.com/hyperledger/fabric
    command: orderer
    volumes:
    -<span class="ruby"> ../channel-artifacts/genesis.<span class="hljs-symbol">block:</span>/var/hyperledger/orderer/orderer.genesis.block </span>    -<span class="ruby"> ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/<span class="hljs-symbol">msp:</span>/var/hyperledger/orderer/msp </span>    -<span class="ruby"> ../crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/tls/<span class="hljs-symbol">:/var/hyperledger/orderer/tls</span> </span>    ports:
      -<span class="ruby"> <span class="hljs-number">7050</span><span class="hljs-symbol">:</span><span class="hljs-number">7050</span></span></code></pre> 
  <p>peer的配置参考base/docker-compose-base.yaml和peer-base.yaml</p> 
  <pre class="prettyprint"><code class=" hljs haml">peer-base:
    image: hyperledger/fabric-peer
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_VM_ENDPOINT</span>=<span class="hljs-symbol">unix:</span>/<span class="hljs-regexp">//host</span><span class="hljs-regexp">/var/run</span><span class="hljs-regexp">/docker.sock </span></span>      # the following setting starts chaincode containers on the same
      # bridge network as the peers
      # https://docs.docker.com/compose/networking/
      -<span class="ruby"> <span class="hljs-constant">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE</span>=e2e_default </span>      #- CORE_LOGGING_LEVEL=ERROR
      -<span class="ruby"> <span class="hljs-constant">CORE_LOGGING_LEVEL</span>=<span class="hljs-constant">DEBUG</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_USELEADERELECTION</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_ORGLEADER</span>=<span class="hljs-keyword">false</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_PROFILE_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_CERT_FILE</span>=<span class="hljs-regexp">/etc/hyperledger</span><span class="hljs-regexp">/fabric/tls</span><span class="hljs-regexp">/server.crt </span></span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_KEY_FILE</span>=<span class="hljs-regexp">/etc/hyperledger</span><span class="hljs-regexp">/fabric/tls</span><span class="hljs-regexp">/server.key </span></span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ROOTCERT_FILE</span>=<span class="hljs-regexp">/etc/hyperledger</span><span class="hljs-regexp">/fabric/tls</span><span class="hljs-regexp">/ca.crt </span></span>    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: peer node start

peer0.org1.example.com:
    container_name: peer0.org1.example.com
    extends:
      file: peer-base.yaml
      service: peer-base
    environment:
      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=peer<span class="hljs-number">0</span>.org1.example.com </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_CHAINCODEADDRESS</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_CHAINCODELISTENADDRESS</span>=<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span><span class="hljs-symbol">:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_GOSSIP_EXTERNALENDPOINT</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org1MSP</span> </span>    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/<span class="hljs-symbol">msp:</span>/etc/hyperledger/fabric/msp </span>        -<span class="ruby"> ../crypto-config/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/<span class="hljs-symbol">tls:</span>/etc/hyperledger/fabric/tls </span>    ports:
      -<span class="ruby"> <span class="hljs-number">7051</span><span class="hljs-symbol">:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-number">7052</span><span class="hljs-symbol">:</span><span class="hljs-number">7052</span> </span>      -<span class="ruby"> <span class="hljs-number">7053</span><span class="hljs-symbol">:</span><span class="hljs-number">7053</span></span></code></pre> 
  <p>CLI的配置参考docker-compose-cli.yaml</p> 
  <pre class="prettyprint"><code class=" hljs haml">cli:
    container_name: cli
    image: hyperledger/fabric-tools
    tty: true
    environment:
      -<span class="ruby"> <span class="hljs-constant">GOPATH</span>=<span class="hljs-regexp">/opt/gopath</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_VM_ENDPOINT</span>=<span class="hljs-symbol">unix:</span>/<span class="hljs-regexp">//host</span><span class="hljs-regexp">/var/run</span><span class="hljs-regexp">/docker.sock </span></span>      -<span class="ruby"> <span class="hljs-constant">CORE_LOGGING_LEVEL</span>=<span class="hljs-constant">DEBUG</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ID</span>=cli </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESS</span>=peer<span class="hljs-number">0</span>.org1.example.<span class="hljs-symbol">com:</span><span class="hljs-number">7051</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPID</span>=<span class="hljs-constant">Org1MSP</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_LOCALMSPTYPE</span>=bccsp </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ENABLED</span>=<span class="hljs-keyword">true</span> </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_CERT_FILE</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/tls/server.crt </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_KEY_FILE</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/tls/server.key </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_TLS_ROOTCERT_FILE</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/peers/peer<span class="hljs-number">0</span>.org1.example.com/tls/ca.crt </span>      -<span class="ruby"> <span class="hljs-constant">CORE_PEER_MSPCONFIGPATH</span>=<span class="hljs-regexp">/opt/gopath</span><span class="hljs-regexp">/src/github</span>.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/<span class="hljs-constant">Admin</span><span class="hljs-variable">@org1</span>.example.com/msp </span>    working_dir: /opt/gopath/src/github.com/hyperledger/fabric/peer
    command: /bin/bash -c './scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT'
    volumes:
        -<span class="ruby"> /var/run/<span class="hljs-symbol">:/host/var/run/</span> </span>        -<span class="ruby"> ../chaincode/go/<span class="hljs-symbol">:/opt/gopath/src/github</span>.com/hyperledger/fabric/examples/chaincode/go </span>        -<span class="ruby"> ./crypto-<span class="hljs-symbol">config:</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ </span>        -<span class="ruby"> ./<span class="hljs-symbol">scripts:</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ </span>        -<span class="ruby"> ./channel-<span class="hljs-symbol">artifacts:</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts </span>    depends_on:
      -<span class="ruby"> orderer.example.com </span>      -<span class="ruby"> peer<span class="hljs-number">0</span>.org1.example.com </span>      -<span class="ruby"> peer1.org1.example.com </span>      -<span class="ruby"> peer<span class="hljs-number">0</span>.org2.example.com </span>      -<span class="ruby"> peer1.org2.example.com</span></code></pre> 
  <p>需要<strong>注意</strong>的一点是，我们需要<strong>注释掉cli配置脚本</strong>中的<code>command: /bin/bash -c './scripts/script.sh ${CHANNEL_NAME}; sleep $TIMEOUT'</code>因为我们接下来会手动执行./scripts/script.sh中的内容。</p> 
  <h2 id="4初始化fabric网络环境">4.初始化fabric网络环境</h2> 
  <p><strong>4.1启动docker容器</strong></p> 
  <pre class="prettyprint"><code class=" hljs lasso">docker<span class="hljs-attribute">-compose</span> <span class="hljs-attribute">-f</span> docker<span class="hljs-attribute">-compose</span><span class="hljs-attribute">-cli</span><span class="hljs-built_in">.</span>yaml up <span class="hljs-attribute">-d</span>
docker ps</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720145404656?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 可以看到cli + orderer + 4 peer已经启动 <br> <strong>4.2创建channel</strong> <br> channel本身是存在于orderer节点内部的 <br> 对于channel的理解，可以参考“我和你不在一个channel”~ <br> 也就是说，两个结点要想发生交易，它们必须加入同一个channel。 <br> 另外，block账本和channel也是一对一的关系，即一个channel一个账本。</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">docker exec -it <span class="hljs-keyword">cli</span> bash    //创建channel需要先进入<span class="hljs-keyword">cli</span>

ORDERER_CA=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/ordererOrganizations/example<span class="hljs-preprocessor">.com</span>/orderers/orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/tlscacerts/tlsca<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-cert<span class="hljs-preprocessor">.pem</span>
peer channel create -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/channel<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA</code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720150413779?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 执行成功会在cli内部生成一个mychannel.block文件，后续peer节点加入channel需要用到这个文件 <br> <strong>4.3peer加入channel</strong> <br> cli默认连接的是peer0.org1(docker-compose-cli.yaml中的默认配置)，所以如果将peero.org1加入channel就非常简单</p> 
  <pre class="prettyprint"><code class=" hljs oxygene">peer channel <span class="hljs-keyword">join</span> -b mychannel.<span class="hljs-keyword">block</span></code></pre> 
  <p>其他几个peer要想加入channel就需要先修改cli的环境变量，然后再执行peer channel join</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">//peer1<span class="hljs-preprocessor">.org</span>1 join
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer1<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer channel join -b mychannel<span class="hljs-preprocessor">.block</span>

//peer0<span class="hljs-preprocessor">.org</span>2 join
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer channel join -b mychannel<span class="hljs-preprocessor">.block</span>

//peer1<span class="hljs-preprocessor">.org</span>2 join
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer1<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer1<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer channel join -b mychannel<span class="hljs-preprocessor">.block</span></code></pre> 
  <p><strong>4.4更新AnchorPeer节点</strong></p> 
  <pre class="prettyprint"><code class=" hljs avrasm">//更新Org1的anchor节点peer0<span class="hljs-preprocessor">.org</span>1
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer channel update -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/Org1MSPanchors<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA

//更新Org2的anchor节点peer0<span class="hljs-preprocessor">.org</span>2
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer channel update -o orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7050</span> -c mychannel -f ./channel-artifacts/Org2MSPanchors<span class="hljs-preprocessor">.tx</span> --tls true --cafile $ORDERER_CA</code></pre> 
  <h2 id="5安装并运行chaincode">5.安装并运行chaincode</h2> 
  <p>以chaincode_example02为例，这个chaincode实现了a,b两个账户转账的功能 <br> <strong>5.1 install chaincode</strong> <br> 安装过程指的是对指定代码进行编译打包并发送到指定peer节点</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">//在peer0<span class="hljs-preprocessor">.org</span>1上安装chaincode
CORE_PEER_LOCALMSPID=<span class="hljs-string">"Org1MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/peers/peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/tls/ca<span class="hljs-preprocessor">.crt</span> 
CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp 
CORE_PEER_ADDRESS=peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>:<span class="hljs-number">7051</span>
peer chaincode install -n mycc -v <span class="hljs-number">1.0</span> -p github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/examples/chaincode/go/chaincode_example02</code></pre> 
  <p><strong>5.2 instantiate chaincode</strong> <br> 在peer所在的基础上对chaincode进行包装，生成对应channel的docker容器</p> 
  <pre class="prettyprint"><code class=" hljs lasso">peer chaincode instantiate <span class="hljs-attribute">-o</span> orderer<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com:<span class="hljs-number">7050</span> <span class="hljs-subst">--</span>tls <span class="hljs-literal">true</span> <span class="hljs-subst">--</span>cafile <span class="hljs-variable">$ORDERER_CA</span> <span class="hljs-attribute">-C</span> mychannel <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-v</span> <span class="hljs-number">1.0</span> <span class="hljs-attribute">-c</span> <span class="hljs-string">'{"Args":["init","a","100","b","200"]}'</span> <span class="hljs-attribute">-P</span> <span class="hljs-string">"OR ('Org1MSP.member','Org2MSP.member')"</span></code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720165831567?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 执行<code>docker ps</code>可以看到多了一个dev-peer0.org1.example.com-mycc-1.0的image <br> <strong>5.3 invoke chaincode</strong></p> 
  <pre class="prettyprint"><code class=" hljs lasso">peer chaincode query <span class="hljs-attribute">-C</span> mychannel <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-c</span> <span class="hljs-string">'{"Args":["query","a"]}'</span>   <span class="hljs-comment">//查询账户a余额</span>
peer chaincode invoke <span class="hljs-attribute">-o</span> orderer<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com:<span class="hljs-number">7050</span>  <span class="hljs-subst">--</span>tls <span class="hljs-literal">true</span> <span class="hljs-subst">--</span>cafile <span class="hljs-variable">$ORDERER_CA</span> <span class="hljs-attribute">-C</span> mychannel <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-c</span> <span class="hljs-string">'{"Args":["invoke","a","b","10"]}'</span>      <span class="hljs-comment">//转账：a-&gt;b 10</span></code></pre> 
  <p>5.4 在另一个节点查询交易</p> 
  <pre class="prettyprint"><code class=" hljs lasso"><span class="hljs-comment">//在peer0.org2上安装chaincode</span>
CORE_PEER_LOCALMSPID<span class="hljs-subst">=</span><span class="hljs-string">"Org2MSP"</span> 
CORE_PEER_TLS_ROOTCERT_FILE<span class="hljs-subst">=</span>/opt/gopath/src/github<span class="hljs-built_in">.</span>com/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com/peers/peer0<span class="hljs-built_in">.</span>org2<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com/tls/ca<span class="hljs-built_in">.</span>crt 
CORE_PEER_MSPCONFIGPATH<span class="hljs-subst">=</span>/opt/gopath/src/github<span class="hljs-built_in">.</span>com/hyperledger/fabric/peer/crypto/peerOrganizations/org2<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com/users/Admin@org2<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com/msp 
CORE_PEER_ADDRESS<span class="hljs-subst">=</span>peer0<span class="hljs-built_in">.</span>org2<span class="hljs-built_in">.</span>example<span class="hljs-built_in">.</span>com:<span class="hljs-number">7051</span>
peer chaincode install <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-v</span> <span class="hljs-number">1.0</span> <span class="hljs-attribute">-p</span> github<span class="hljs-built_in">.</span>com/hyperledger/fabric/examples/chaincode/go/chaincode_example02

peer chaincode query <span class="hljs-attribute">-C</span> mychannel <span class="hljs-attribute">-n</span> mycc <span class="hljs-attribute">-c</span> <span class="hljs-string">'{"Args":["query","a"]}'</span>   <span class="hljs-comment">//查询a账户余额</span></code></pre> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720170651788?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""> <br> 初始化时a账户余额为100，刚在peer0.org1上执行了a向b转账10的操作，我们发现，在peer0.org2上执行的查询结果也是更新后的，为90. <br> 并且此时若再执行<code>docker ps</code>我们会发现也为peer0.org2创建了一个docker镜像 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180720171006996?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zOTM1NDY3Ng==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="这里写图片描述" title=""></p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/weixin_39354676/article/details/81118240,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/weixin_39354676/article/details/81118240,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
