<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>新一代区块链去中心化交易所和相关协议–路印协议介绍 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="新一代区块链去中心化交易所和相关协议–路印协议介绍" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Loopring介绍 查看行情 路印协议新一代区块链资产交易协议和交易所。它采用去中心化技术，提供零风险的代币交易所模式，并允许多家交易所通过竞争，对同样的订单进行链外撮合及链上清结算。 路印协议将彻底解决现有中心化交易所模式的一些固有风险。 主要特性有： 1,绝对安全 路印协议订单中的卖出代币不必充值到交易所做资金托管，在下单、撮合、清结算过程中一直保存在用户自己区块链的地址中。订单不锁定用户区块链上的代币，下单后用户依然可以任意使用自己的数字代币，余额不足时路印协议自动调整订单的数额且保持价格恒定。使用路印协议，交易所倒闭跑路都不会对用户有任何影响。 2,环路撮合 路印协议一次撮合可将十几个包含不同类型代币的订单做环路撮合。 3,去中心化 订单在区块链外生成，传播、撮合；链上清算转账。理论上100%安全，用户资金不会丢失或被盗。 4,订单共享 路印协议中一个订单可以被广播给多个交易所，被这些交易所并行撮合。一个订单可被一个交易所撮合成功一部分，被另一个交易所撮合成功另一部分。交易所之间存在竞争关系，因此订单会被更快、更好（价格最优）地撮合。使用路印协议下单，交易不会因交易所被DDOS攻击而无法得到及时撮合。 5,跨链协议 路印协议是个去中心化安全交易的协议层，可在多个智能合约公有链上实现，而不依赖于某个特定平台。我们会在以太坊上率先实现第一个版本，接下来会在EOS，ETC，量子链上部署协议，为这些平台提供代币流动性支持 1 背景区块链 [1][2] 作为比特币 [3] 的底层技术，本质上是去中心化无信任环境中的存在性共识机制 [4][5]。存在性可应用于各种不同的数据，如股权，版权，使用权等。尽管联盟链和企业私有链中共识数据的类别正在变得越来越多样化，但这些数据的价值却有着明确的边界限制 — 只限于联盟成员间和企业内部。我们认为区块链的价值网络属性目前只有在公有链中才能得到更好的体现。根据 coinmarketcap.com 的统计，截止本文成稿时间，区块链上代币总市值已经接近 790 亿美元，以太坊区块链[6]（ETH）上承载的代币市值也已超过 170 亿美元。区块链对各行业都可能有着深远的影响，尤其是金融领域。我们相信基于区块链的新金融会有一个明显趋势，即资产代币化（Tokenization）[7][5]：一方面链下资产的使用权，所有权，分红权等相关权益通过抵押，会以代币（Token）[2] 的形式发行到区块链上，另一方面区块链上资产也会进行跨链发行。资产代币化的目标之一就是低成本，全球化，全天候的高流动性。而流动性则主要通过交易所得以实现，因此一个更适合区块链上代币的交易标准对于区块链金融至关重要。现阶段交易所都采用类似的模式：交易所要求用户将法币或者代币充值到交易所的银行账户或区块链地址中，然后交易所在自己的私有虚拟账户系统中为用户进行 IOU记账。用户实际交易的是这些 IOU。为了将IOU 兑换成法币或区块链代币，用户需要向交易所提出提现申请，提现成功后，才算真正交易完成。在这个过程中，交易所替用户保管资产的能力是用户最大的风险；同时用户还需承担交易所运营者商业道德带来的其它风险，比如挪用资金造成资不抵债等。 2014 年2 月当时世界最大的比特币交易所 Mt.Gox 的 85 万个比特币被盗一空 [8]，公司向日本东京地方法院申请破产保护。该公司的用户至今仍在等待其返还尚未被盗的少量比特币。随着调查的不断进行 Mt.Gox被曝出所谓的比特币被盗其实是监守自盗。 85万个“被偷窃”的比特币中，实际上因外部盗窃失踪的仅为 7000 个。2016 年 8月最大的美元比特币交易平台香港的 Bitfnex由于网站出现安全漏洞，导致用户持有的比特币被盗，被盗的比特币共 119756枚，总价值约为 6500 万美元。随后该公司决定由所有用户共同分担损失以避免破产。这些发生过的事件一方面反映出区块链代币交易在各个国家监管政策的缺失，另一方面也证实了中心化交易所模式的固有风险。本文描述的基于区块链的去中心化交易机制就是为了彻底解决上述问题。去中心化交易的核心优势之一是避免任何资产被托管，因此资产就不存在被盗的可能，这会极大降低用户对交易所的信任成本。这种交易机制的另一个优势是没有地缘和时间限制，以及极高的透明性和可追溯性。这些特点会促使交易整体具有更大的流动性和更小的价差。2 相关工作开源社区已经有过一些基于区块链搭建去中心化交易所的尝试，如瑞波（Ripple）、比特股（BitShares）、 Openledger 等。Ripple [9] 是一个去中心化的银行系统间清算协议，是为了解决银行间清算的高费用和高延迟问题而设计，具有快速、方便、超低费用的优点。 Ripple 提出了一项In- 2 相关工作 4 terledger [10] 协议（ILP）实现跨账本的资产交易。ILP 本身并不是一个账本，相反，它 提供了一个顶层加密托管系统，在称之为“连接者”的中介机构的帮助下，可以让资金 在各账本之间进行流动。 Ripple交易依赖于网关间信任的建立，而网关提供代币发行功 能。 比特股（BitShares）[11][12] 是一个区块链开发平台，任何个人和机构都可以在此 平台上自由地进行转账、借贷、发行资产等，也可以基于这个平台快速搭建出去中心化 的金融服务平台等。 BitShares内置的去中心化交易所（DEX），让数字资产的交易撮合 和交割完全发生在链上，并通过内置智能合约锚定其他资产，如法币、比特币、黄金、 白银等。可惜 BitShares项目由于开发者自身的问题，已经慢慢被边缘化。 Openledger[13] 是一个新型去中心化交易平台。它允许用户将比特币兑换成法币锚 定的 SmartCoins，SmartCoins 可以直接通过paypal、瑞波网关兑换成现金。需要注意 的是， Openledger在很大程度上依赖于 BitShares 2.0平台以及 Graphene Toolkit。因 此， Openledger平台的性能取决于 Graphene Toolkit的性能和 BitShares 2.0平台的性 能。 比特币的闪电网络 [14]和以太坊上的雷霆网络 [15] 是两个去中心化的系统。它们 的卓越之处在于，无需信任对方以及第三方即可实现实时的、海量的交易网络。闪电网 络和雷霆网络提供了一个可扩展的微支付通道网络。交易双方若在区块链上预先设有支 付通道，就可以多次、高频、双向地通过轧差方式实现瞬间确认的微支付；双方若无直 接的点对点支付通道，只要找到网络中一条连通双方的、由多个支付通道构成的支付路 径即可。闪电网络和雷霆网络的突出贡献是将链上交易放到链外，只把最后一笔清算交 易提交到区块链上，从而变相为区块链扩容。 Bancor[16] 协议引入了一种基于数学模型的方案去试图解决经济学中的“双重需求 巧合”问题。其理念和预测市场中的 Logarithmic Market Scoring Rules（LSMR）[17] 类似。 Bancor协议基于以区块链为基础的智能合约和储备代币，允许任何人通过这个 协议创建代币，新的代币以预先设置的比率来持有一种或几种其它代币作为自己的储备 金。这些储备代币可以是法币、数字化资产或其它加密代币。通过使用这些储备金，不 论有没有交易，新创建的代币都可以获得价格，并随时可以兑换回其对应的储备代币。 0x [18] 是一个可以在以太坊区块链上进行ERC20[19] 代币对等交易的开放式协议。 该协议旨在成为通用开放标准，作为可与其他协议组合的基本模块，用以驱动越来越 复杂的区块链应用程序。由于它使用的是以太坊的智能合约系统，因此可以作为各种 dApps 的共享基础架构。而从长远来看，开放式技术标准相比封闭模式具有更大的优 势，随着每个月有更多的资产在区块链上被代币化，也有更多的 dApps需要使用这些 不同的代币，开放式标准也因此变得更加重要。此外，由 dApps耦合到其底层协议所 导致的智能合约冗余也是未来区块链协议开发的主要障碍，因此在标准化之余，我们 还需要一个合适的解耦方式。 0x协议试图将信息交换功能从应用层拉到协议层，推动 dApps 之间的互操作性。然而，0x 协议的局限包括： taker 必须在线匹配订单，这导致 撮合实时性差，难以优化成交价格； 0x协议采用的是简单的 OTC 方式，无法法实现复 杂订单的撮合；不同交易所之间没有明确的竞争激励机制；也没有考虑了矿工的利益。 上述努力由于种种限制，到目前为止依然没有能够撼动中心化交易所的地位。我们 主要受到支付通道和 0x协议的启发，提出一种更可行的链上交易撮合标准。 3 协议设计 5 3 协议设计 图 1: Loopring 协议：图中示例一个三边交易的撮合我们用上图中的三边交易，简要讲解下采用 Loopring 协议的撮合交易过程。该过程如下： 1. 用户甲、乙、丙分别对 Loopring 撮合智能合约（ Loopring Matching Contract ）授权，授权后该合约可对用户指定代币账号做不超过一定额度的转出操作 1 。在上面实例中，合约可最多从用户甲的账号转出 1000 个 A 代币，从用户乙账户转出 9 个 B 代币，从用户丙账户转出 100 个 C 代币； 2. 用户甲、乙、丙分别生成自己的订单，并用私钥对其进行数字签名。订单不再区分买单和卖单，所有订单都被视为 交换单 — 甲的订单声明：甲愿意卖出不多于 1000 个 A 代币，买到尽可能多但不少于 10 个 B 代币；如果是部分成交，那么 A 到 B 的 兑换率 不得低于 1000/10 = 100.0 （卖出代币数量除以买入代币数量）。订单中还可以包含其它参数，我们在章节 3.7 中会对订单参数进行说明； 3. 甲、乙、丙分别将自己的订单通过适当的方式发送到一个或多个交易所； 4. 交易所收到上述三个订单，将它们分别放到三个对应的订单表（ orderbook ）中，并实时通过区块链数据更新计算每个订单的状态，同时不断努力寻找能够撮合的一组订单 — 我们后续称之为 交易环路 或者 撮合环路 。一旦确定三个订单的当前状态可以撮合成功，且收益满足预期，即决定实施这个撮合； 5. 交易所对撮合交易签名后发送到 Loopring 撮合智能合约地址； 1 通过 ERC20 机制实现。 3 协议设计 6 6. 撮合智能合约验证四方签名，之后验证三个订单（的最新状态）是否可以真正成 交。若无法成交，合约终止（交易所依然要消耗一定的油费）；否则智能合约分别 计算出甲、乙、丙三方各自需要支出的金额，以及交易所该收取的费用，并且实 时将甲、乙、丙账号中的资产进行互转，并完成对交易所的费用支付 —如下图 所示。在交易过程中，撮合智能合约还会调用 Loopring注册智能合约（Loopring Registration Contract）来计算交易所应该给予该笔交易的费用折扣；在交易完成 前，还会调用 Loopring统计智能合约（Loopring Stats Contract）对交易所以及 代币相关的统计数据做更新。 图 2: Loopring 协议：交易环路结算 7. 交易所监听新的区块和链下新的交易数据，并根据这些数据更新订单表，然后不断进行新的撮合。接下来我们介绍可以撮合成交的交易环路相关的概念，包括 交易链 ，交易链的可归约性，成交价，成交量，和交易所收益模型。 3.1 符号定义 在正式介绍协议之前，我们要介绍一些符号的定义。 C i ：编号为 i 的代币币种。 O i ! j ：一个卖出代币为 C i ，买入代币为 C j 的订单。 s i ! j ：表示上述订单的当前卖出代币 C i 的数量。 b i ! j ：表示上述订单的当前买入代币 C j 的数量。 r i ! j ：为订单 O i ! j 的兑换率，即 s i ! j / b i ! j 。为了特指订单的原始状态，我们为符号加上水平线，代表其在原始订单中的值，比如 s i ! j 和 b i ! j 分别代表原始订单中的卖出和买入代币数量。 3.2 订单兑换率恒定 除非订单完全成交，即 s i ! j = 0 ，否则 Loopring 协议保证订单状态更新后： s i ! j / b i ! j = s i ! j / b i ! j ，即订单中隐含的兑换率不会因为部分成交而变化，亦即 r i ! j = r i ! j 。 3 协议设计 7 在实际实施中，兑换率恒定是通过先计算部分成交后卖出代币的剩余量，再使用原 始订单中隐含的兑换率来计算买入代币数量得以保证的。 3.3 可规约性 考虑两个订单 O i ! j 和 O j ! k , 我们可以通过中间代币 C j 的连接，将其规约一个卖出代币为 Ci ，买入代币为 C k 的订单。我们用 O i ! j ! k 来表示这样一个订单，它和订单 O i ! k 在撮合的各种属性上是等价的，且： s i ! j ! k = min ( b i ! j ; s j ! k ) · r i ! j (1) b i ! j ! k = min ( b i ! j ; s j ! k )/ r j ! k (2) r i ! j ! k = r i ! j · r j ! k (3) 在这里我们顺便引入 订单链 这个概念。一个订单链是两个或者两个以上订单，除了最后一个订单，每个订单的买入代币类型恰巧是后一个订单的卖出代币类型，但最后一个订单的买入代币类型不同于第一个订单的卖出代币类型（否则就成了一个环路）。我们可以将上述规约计算用于一个订单链。通过规约，一个包含 n - 1 个订单（ n 个不同的代币） , 即长度为 n - 1 的订单链可被视为一个单一订单 O 0 ! ::: ! n ，且有： s 0 ! ::: ! n = 8&lt;: s 0 ! 1 如 n = 1 min ( b 0 ! ::: ! n - 1 ; s n - 1 ! n ) · r 0 ! ::: ! n - 1 如 n &gt; 1 b 0 ! ::: ! n = 8&lt;: b 0 ! 1 如 n = 1 min ( b 0 ! ::: ! n - 1 ; s n - 1 ! n )/ r n - 1 ! n 如 n &gt; 1 r 0 ! ::: ! n = n - 1 ∏ i =0 r i ! i +1 订单链的可规约性可以帮助我们在分析订单路径时简化模型，在后文的讨论中，我们将符号 O i ! j 的含义扩展到即包含简单的卖出代币为 C i ，买入代币为 C j 的单一订单，也包含可规约成这样一个类型订单的订单链，如果为了强调是个订单链，我们会用 O i ! ::: ! j 或 O i !! j 表示。 3.4 环路撮合 传统撮合系统是在两个币种间，即一个交易对的买卖两个方向间完成撮合；而 Loopring 协议将撮合的概念扩展到多币种，通过 交易环路 来完成多个币种之间交易的撮合。下面介绍一下交易环路的概念。 定义 3.1 ( 交易环路 ) 如果有 n 个币种 C 0 、 C 1 、 · · · 、 C n - 1 ，和 n 个订单： O 0 ! 1 ， · · · ， O i ! i ⊕ 1 ， · · · ， O n - 1 ! 0 ，其中， i ⊕ 1 ≡ i + 1 mod n 。那么这些订单可以组成跨 n 个币种的交易环路： 3 协议设计 8 O 0 ! 1 ! · · · ! O i ! i ⊕ 1 ! · · · ! O n - 1 ! 0 ，其中 n 为环路的长度。 当这些订单的价格 满足一定条件时 ，我们可以对整个交易环路进行撮合，这种交易环路称为 可交易环路 。下面我们对交易环路中的成交价格和成交量进行讨论。 3.4.1 成交条件和价格 我们由一个长度为 3 的交易环路为例，介绍环路可成交的条件。假定环路中的三个币种为 C 0 、 C 1 和 C 2 ，三笔订单分别为： O 0 ! 1 、 O 1 ! 2 和 O 2 ! 0 。很容易证明，如果 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 = 1 时，三个订单都可以用其自身的兑换率成交。当 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 &gt; 1 时，三个订单都可以用比自身兑换率更低的兑换率成交。我们称第一种情况为 原价撮合 ，称第二种情况为 折价撮合 。 Loopring 协议要求交易环路的折价平均分享给环路中的每个订单。假设每笔订单兑换率折价比例为 γ ，那么最终完成撮合时，三笔订单的成交价分别为： r 0 ! 1 · (1 - γ ) ， r 1 ! 2 · (1 - γ ) ， r 2 ! 0 · (1 - γ ) ，并且满足： r 0 ! 1 · (1 - γ ) · r 1 ! 2 · (1 - γ ) · r 2 ! 0 · (1 - γ ) = 1 (4) 根据上式我们可以推导出： γ = 1 - 1 p 3 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 。在更一般的情形下，如果跨 n 个币种的环路中， 兑换率折扣 为： γ = 1 - 1 √ n ∏ ni =0 - 1 r i ，其中 r i 表示第 i 个订单的兑换率。显然，只有在兑换率折扣 γ ≥ 0 时，交易环路才可以真正成交；且第 i 个订单 O i 的实际兑换率 r ^ i = r i · (1 - γ ) ，且有 r ^ i ≤ r i 。 3.4.2 成交量 当一个交易环路撮合完成后，至少有一个订单是被完全成交的。这点很容易得到证明：我们可以先假设该结论不成立，即全部订单都没有完全成交。由于章节 3.2 中要求兑换率在订单新状态（尾单）中保持不变，意味着撮合后新的环路依然满足成交条件。这就意味着之前的撮合是没有进行完的。因此可以断言：一次完整的撮合应该会将至少一个订单完全吃掉。我们称这个（些）被完全吃掉的订单为交易环路的 最小订单 。找到任何一个最小订单，既可循环计算环路中所有订单的成交量。假设第 i 个订单是最小订单，那么每笔订单的卖出代币成交量 s ^ 和买入代币成交量 ^ b 可以以此如下计算得出： s ^ i = s i ， ^ b i = ^ s i /^ r i ，其中 s i 为订单的卖出代币余额 ; s ^ i ⊕ 1 = ^ b i ， ^ b i ⊕ 1 = ^ s i ⊕ 1 /^ r i ⊕ 1 ; s ^ i ⊕ 2 = ^ b i ⊕ 1 ， ^ b i ⊕ 2 = ^ s i ⊕ 2 /^ r i ⊕ 2 ; ::: 3 协议设计 9 实际实施过程中，可以先假定第一个订单为最小订单，往后循环计算成交量，直到 每个订单的成交量都不再变化为止。理论上最多循环两次即可计算出每单的实际成交 量。 3.4.3 撮合费用 交易所第一种收费形式是手续费。在订单中可以设置一个以 Loopring 的代币 LRC 为单位的费用 , m i ，代表完全成交情况下编号为 i 订单愿意支付给交易所的手续费总和。实际成交时候按订单卖出代币成交比例支付给交易所，即： f i = b i · m i / b i 为了鼓励交易所为用户找到兑换率折价比例最大的成交环路， Loopring 协议要求将兑换率折价带来的 成本节约 分润给交易所。对于一个订单 O i , 假设买入订单的成交额度为 b i （ b i ≤ b i ） , 我们定义成本节约为： ∆ i = b i · r i · γ Loopring 协议允许每个订单设定一个成本节约分享 分润比例 θ i ，并将交易环路上所有订单分润比例的最小值作为该环路的分润比例 Θ ，那么订单 O i 支付给交易所的费用为： f i = ∆ i · Θ = b i · r i · γ · Θ 因此交易所对于一个交易环路，通过成本节约分润获得的收入为： F = n - 1 ∑ i =0 b i · r i · γ · Θ 采用所有订单中最小的分润比例作为整个交易环路的分润比例，可以激励订单采用较大的分润比例。这样做会激励交易所对订单进行撮合，同时一旦订单成交，也不一定非要支付指定比例的分润。为了鼓励 Loopring 的代币 LRC 的使用，如果订单中没有指定代币费用 m i ，或 m i = 0 ，那么该笔订单的分润比例实际被认为是 100% ，而不管订单中相应参数的值是多少。如果一个交易环路中的所有订单都没有设置代币费用， Θ = 100 % ，环路中所有成本节约归交易所所有。在下一章节，我们会引入一个激励交易所竞争的代币抵押机制，智能合约根据每个交易所代币抵押数量的排名，为每个交易所计算一个 费用强制折扣 ， λ ，该折扣会进一步影响交易所的费用收取；同时，交易所也可以指定为某个交易环路做进一步的费用优惠折扣， η 。因此，交易所对于一个交易环路的整体费用为： F = (1 - λ ) · (1 - η ) · n - 1 ∑ i =0 ( b i · r i · γ · Θ + b i · m i / b i ) 两种不同的费用模型能够满足不同订单的诉求：对于没有 LRC 代币的账户，可以设置合适的分润比例；对于有 LRC 代币的账户，可以选择支付较多的代币费用，并将 3 协议设计 10 分润比例设为一个较小值。交易所有可能对每笔订单的代币费用值有个最小额度限制， Loopring 协议并不对此作出明确要求。交易所可以在自己网站上对相关标准做说明，并 引导用户设定合适的订单参数值。 3.4.4 交易所费用强制折扣 Loopring 协议要求交易所给交易费强制打一个折扣，折扣大小决定于交易所抵押 LRC 代币数量的排名，排名越靠后，折扣越高。假定排名为 n 的折扣为： λ n = 0 : 05 · ( ln ( n + e - 1) - 1) 。具体返利比例如下表所示： 抵押排名 n 费用强制折扣 λ 1 0% 2 1:57% 10 7:31% 20 10:39% 99 18:06% 100 18:11% 1000 29:55% 1001 30:00%∗ 表 1: 抵押 LRC 排名与费用强制折扣对于排名 1001 及以后的交易所，或未进行抵押的交易所，统一实施 30% 费用强制折扣。如下图所示，费用强制折扣的下降并非线性的，如 λ 2 - λ 1 ≫ λ 100 - λ 99 。 3 协议设计 11 图 3: LRC 代币抵押排名与费用强制折扣在实际部署时，折扣函数中的参数需要根据市场行情不断调整，比如交易量和实时性。当市场交易量过于旺盛时，会导致过多交易无法及时确认，这时需要降低整体折扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交易的撮合。 3.5 防作弊和防攻击 3.5.1 交易所无风险套利 Loopring 协议致力寻求在用户和交易所间利益的平衡点，打造公平健康的交易所生态。 Loopring 协议不反对交易所的套利行为，因为套利行为本质上也是在促成交易。但是我们禁止交易所利用自己在生态中角色的特殊性进行套利，具体来说，通过上传一种特殊的闭环无风险套取订单间的价差，本节我们将介绍如何防止交易所的这种行为。在介绍之前，我们首先来分析交易所如何做到无风险套利。假设有两个订单 O a ! b ， O b ! a ，形成一个交易环路，且 r a ! b · r b ! a &gt; 1 。交易所可以在这个环路上插入三个自己新生成的订单 O b ! c ， O c ! d ， O d ! b ，生成一个长度为 5 的新环路，并使 r a ! b · r b ! c · r c ! d · r d ! b · r b ! a = 1 。通过这种方式，交易所可以做到将所有可能的成本节约变成 0 ，一旦撮合被智能合约接受，即可实现无风险套利。这种套利的交易环路有个显著的特征：它们包含子环路。在上个例子中，两个子环路分别是： O a ! b ! O b ! a 和 O b ! c ! O c ! d ! O d ! b 。为了杜绝交易所的这种无风险套利， Loopring 协议要求： 合法的闭环必须保证其订单子集无法组成更小的可交易环路 。 3.5.2 交易所拒绝服务 Loopring 协议允许交易所选择性地为特定订单做撮合。交易所有权对订单的代币类型，订单数量，费用等做筛选，也有权对这些筛选条件做更改，且有权公开或隐藏这些筛选条件。交易发起者与交易所之间是相互选择的关系，彼此没有任何义务。 3.5.3 尘埃订单攻击 普通用户可以通过广播大量的尘埃订单（即数量非常小的订单）试图对交易所做攻击，不过由于撮合尘埃订单获利很低，所以这些订单一定会被交易所抛弃，进而对交易所和区块链没有任何影响。交易所也可能采用同样方式发起攻击，从而试图影响其它交易所对某些订单的撮合。不过这种努力也不会奏效，因为协议允许同一个订单在同一个块中参与到多个环路成交（这些环路可能是不同交易所提交到区块链上的），换句话说，订单并没有所谓的锁定状态。 3.5.4 余额不足订单攻击 交易发起者可能发起多笔订单，但订单卖出代币账户实际余额为零。这样的订单提交到交易所后，交易所很容易通过查询区块链地址的余额信息将该订单抛弃，不过这种 3 协议设计 12 攻击的确会浪费交易所的处理时间。好在交易所可以通过黑名单机制，迅速有效地将某 些地址屏蔽掉，拒绝再为这些地址提供撮合服务。 3.5.5 撮合窃取 一个懒惰交易所可以监听网络上未被确认的撮合交易，解析交易环路并生成一个带有自己签名的新撮合（环路相同，只有受益地址和数字签名不同），通过提供更高的交易费来窃取其它交易所的撮合结果。特别当窃取者是矿工时，这种作弊行为是比较难以预防的。为防止撮合窃取，我们规定交易所上传订单环路的过程分为两步： • 交易所在区块链上发一笔交易，上传订单环路的存证， • 存证信息被写入区块链后，交易所提交具体环路信息。这个存证通过哈希来实现，哈希值的生成方法为 h = H ( r; nonce ) ，其中， H () 为单向函数， r 为订单环路信息。哈希函数的输入包含了一个随机数 nonce ，用于防止对哈希值进行暴力破解。在提交具体环路信息时，随机数 nonce 需要一并提交。 3.6 市场深度 交易所并不一定需要提供市场深度数据。在整个生态中，可能会有单独的组织和机构汇集全网的未成交订单或者交易的尾单信息，汇总成独立的市场深度数据。市场深度数据可以根据章节 3.3 中的订单的规约方法，计算出任何两个 ERC20 代币之间的买单卖单数据。 3.7 数据格式 由于采用 OTC 模型，所有订单可以用同一个数据结构表示。该结构包含订单本身的各种参数数据和发起者的数字签名。在签名前，先将订单参数数据连接成一个字节数组，通过 Keccak SHA3 方法对这个字节数组做散列计算得到订单的哈希，之后用账户私钥对这个哈希进行 ECDSA 签名。 message Order {address protocol; // Loopring 协议入口智能合约地址 address owner; // 该订单发起者地址 address outToken; // 卖出 ERC20 代币智能合约地址 address inToken; // 买入 ERC20 代币智能合约地址 uint256 outAmount; // 卖出 ERC20 代币数量上限 uint256 inAmount; // 买入 ERC20 代币数量下限 unit256 expiration // 过期时间 unit256 fee; // 交易总费用（ LRC ），部分成交的费用按该次 3 协议设计 13 // 撮合实际卖出代币额与 outAmount 比例计算 uint8 marginSplit; // fee 不为 0 时支付给交易所的分润比例，否则视为 100%unit8 v;bytes32 r;bytes32 s;} 订单中虽然没有明确指定价格，但我们可以通过计算 outAmount / inAmount 来得到一个订单兑换率 r 。该兑换率隐含地要求所有实际撮合成交的兑换率不得大于 r 。一个好的交易所 UI 应该允许用户输入 outAmount ， inAmount ，和传统意义的买入价或卖出价这三个数据的任意两个来计算缺失的 outAmount 或 outAmount 值。订单实际上可以有两种不同的 完全成交 定义：一种定义是只有卖出代币达到了 outAmount 就算完全成交；另一种定义在之前的基础上允许买入代币累计金额达到 inAmount 也算完全成交。我们可以在订单中引入一个参数告诉交易所和撮合智能合约选择哪种完全成交定义。在第一版本的实现中，我们先支持第一种完全成交定义。交易所可以通过下面的数据结构构建一个交易环路： message MatchRing {Order[] orders; // 该次匹配的所有订单 address feeRecipient; // 费用收取地址 unit256 additionalDiscount; // 在费用基础上进行的再折扣价 - etaunit256 nonce; // 一个随机数 unit8 v;bytes32 r;bytes32 s;} 一个可交易环路上同一位置的订单只能有一个 — 理论上可以将这个限制去掉，不过这会让撮合智能合约更加复杂，我们可能在后续的版本中再给与支持。 3.8 订单状态 订单发起者对订单签字广播后无法对该订单进行修改。撮合智能合约一旦对某个订单进行撮合，就需要在区块链上对订单的状态更新记录。对部分或者完全成交的订单，会计算更新 inAmount 和 outAmount 两个值，并且保障订单新状态价格和原始订单的价格一致。如果 inAmount 或 outAmount 为 0 ，则表示该订单已经完全成交。如果用户取消订单，需要发起一个特殊的交易，将 inAmount 和 outAmount 更改为 0 即可。过期的订单不会触发区块链上的数据更新 — 可以根据最后一个块的时间戳来判断任何一个订单是否过期 — 因此我们期待多数的订单会因为过期或者完全成交而变成失效。交易所需要采用同样的甚至是更复杂的逻辑在区块链外追踪订单状态，尤其是当一家交易监听到到竞争对手在对同一个订单做不同的撮合的时候。一个可交易的订单还需要其账户中有足够多的卖出代币余额 balance ，虽然 balance 不要求达到订单中 outAmount 的数量。实际上交易所在对订单状态计算的时候，会取 4 LOOPRING 协议代币LRC 14 max(balance; outAmount)作为实际的可成交金额。这里可以看出，订单的卖出代币并 不需要锁定的过程。用户提交订单后依然可以任意支配卖出代币作为他用。交易所不仅 仅要监听订单被（其它交易所）撮合的结果，还需要监听订单账户的余额变动情况。看 起来这种对区块链数据的监听和对订单状态的更新有些复杂，但这些反而极大简化区块 链上合约的逻辑，这种思路和比特币闪电网络，以太坊的雷霆网络的思路是一致的。 3.9 智能合约 Loopring 协议协议可能包含多个智能合约，包括但不限于： • 撮合合约 负责计算并确认交易环路中每个订单的状态，计算成交金额和成交量，对交易进行清算转账。该合约还会与其它合约交互，是 Loopring 协议的入口合约； • 订单合约 负责更新订单状态以及对取消订单提供支持； • 交易所注册合约 负责维护和更新一系列支持 Loopring 协议的交易所，为交易所代币抵押和预设参数默认值提供支持； • 统计合约 计算任何两个币种之间的成交量，成交价，以及不同交易所的贡献度等指标，以及这些指标的某些滑动平均值。这些指标是订单发起者授权撮合的重要参考依据，同时也可以作为某些预测市场的输入，并且为以后可能的协议拓展（比如对条件单的支持）提供输入（ Oracle ）。这里，不排除将上述合约进一步拆解或合并的可能。同时值得指出： Loopring 协议中的智能合约是完全开放的，这意味着它们可以被任何的 dApp 直接或者间接调用。因此整个协议即使一个完善的整体，又是个开放的，单独可用的组件的集合。 4 Loopring 协议代币 LRC 我们将为 Loopring 协议发行符合 ERC20 规范的原生代币，其符号为 LRC （在本文中用斜体字母表示）。 4.1 代币的应用 LRC 在生态中发挥下列作用： • 作为撮合费用 — 订单中可以指定用 LRC 可作为支付给交易所的撮合费用。虽然协议支持通过卖出代币成本节约的分润作为支付手段，但对于交易所来说，将来需要支持的 ERC20 代币类型可能越来越多，如果每笔撮合交易都通过各订单中的卖出代币为单位支付手续费，那么对于一次撮合的收益计算将变得复杂；相反，如果通过 LRC 来衡量收益（或者用来计算成本），会简单得多。同样，对于订单发起者，可以通过公开信息获取某笔订单需要支付大约多少费用，如果用每个订单的卖出代币计算，那么下单过程中的费用计算也会比较分散。我们在之前章节 3.4.3 对费用模型做了详细的说明。 4 LOOPRING 协议代币LRC 15 • 作为交易所注册抵押—订单发起者希望自己的订单得到最好的撮合，这要求交易 所在各个方面都做到专业，特别是对全部订单的汇聚情况。由于去中心化交易没 有地域限制，一个好的交易所应该能比一个相对差的交易所看到更多的订单，也 应能在最短时间内找到最好的交易环路。为了鼓励实力强的交易所，淘汰实力差 的交易所，我们提供一种交易所注册抵押机制：交易所可以将一定数量的 LRC 代 币抵押给智能合约。交易所可以随时申请抵押代币的解冻，但申请提出后，一年 后才锁定的代币才可以转账出去。并不是所有交易所都必须进行注册抵押。交易 所代币抵押的另一个作用是防止交易所为了抛弃不利的历史统计数据而频繁变动 身份。 4.2 去中心化自治 随着交易所的不断升级，交易所中的规则需要不断升级升级，为此我们引入去中心化自治机制。任何持有 LRC 者都可以将代币抵押并获得自治系统的投票权益，投票权益 S 是一个关于抵押数量 N 和抵押时间 CoinAge 的函数， S = f ( N; CoinAge ) ，其中 CoinAge = H c - H s ，这里的 CoinAge 是当前区块高度 H c 减去开始抵押区块高度 H s 。加入 CoinAge 参数是为了防止有攻击者短时间内租借到大量代币并获得很高的权益，迫使某项并不为他人接受的提议得以通过。在去中心化自治系统中，任何决定都要在一个固定时间内完成投票，这个时间根据提议内容不同而发生改变。当且仅当收集到足够高权益的投票，提议才会执行，否则提议将会关闭。在去中心化自治系统中，并不是权益高者的一言堂，权益低者可以联合在一起制衡权益高者。去中心化自治内容包括但不限于交易所注册、币种注册、统计函数、抵押代币范围等，这些升级可以通过自治系统参与者共同投票参与决定。 • 币种注册 Loopring 协议会阶段性的调整支持的币种，有些数字货币会因为交易量过低而退出交易所，而另外会有一些新的数字货币诞生而加入交易所。这些币种需要记录在智能合约中，包括币种名称、代号及对应智能合约地址等信息。 • 交易所注册 交易所需要注册完成才能通过协议进行交易，当交易所达到一定数量后，新注册交易所需要经过自治系统投票才能通过。 • 统计函数 随着交易所上线运行时间越长，数据量得到一定积累，用于统计的指标和函数也会逐渐成熟。自治系统参与者可以决定新增或淘汰统计函数。 • 抵押代币范围 交易所可以抵押的代币数量需要限制在一定范围内。如果抵押数量太多，会导致代币流动性变差；如果抵押过少，则无法体现交易所间的差异性。 • 环路最大长度 理论上说，环路越长越有可能发现利差大的环路，然而过长的环路会降低环路撮合的成功率，并且在过长的环路会带来过高的计算成本。 4 LOOPRING 协议代币LRC 16 • 强制折扣函数强制折扣函数需要根据市场行情不断调整，比如交易量和实时性。当 市场交易量过于旺盛时，会导致交易过多而无法及时确认，这时需要降低整体折 扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交 易的撮合。如下图所示，其中蓝色为交易量正常时的折扣率，黄色为市场交易量 过高时的折扣率，红色为交易量过低时的折扣率。 图 4: 调整后的强制折扣率 • 子合约地址 如果基于公有链搭建 Loopring 交易所，智能合约本身是无法改动的。在这种情况下，如果升级 Loopring 协议的子合约，则需要重新部署智能合约，并修改子合约的地址。 4.3 代币的原生流动性 Loopring 协议代币本身遵循 ERC20 标准，并且在 Loopring 智能合约的基础上带有原生的流动性 — 这意味着你不必去传统的交易所购买和出售 LRC ，而是可以通过本文论述的方式，利用 Loopring 协议本身的去中心化撮合机制，使用任何 ERC20 代币购得 LRC （订单中的买入代币设定为 LRC ，并将 fee 设为 0 ）。这得益于协议灵活的收费模式。 5 交易所 17 5 交易所 采用 Loopring 开放协议后，交易所并不能保证每一个撮合都是盈利的。一方面可能是成本过高，因为交易所为了激励矿工优先打包自己的撮合交易到区块链，可能根据预期的收益调高手续费，而手续费代币和撮合中代币的相对价格有可能有超出预期的浮动，从而造成手续费实际成本更高。另一方面可能是因为收入没有达到预期，比如交易所把撮合广播到区块链后，该撮合的某个订单的卖出代币被部分或者全部转移到另一个地址，从而造成整个撮合交易未能被确认或实际成交量和手续费过低。类似这样的原因还有很多，因此交易所的每次撮合广播都是根据自己的经验和算法，最大化长期利益的概率游戏。不过也不用担心，实际上交易所和订单发起者是双向选择的关系：交易所只会选择有利可图的订单；而订单发起者只会选择费用最低的交易所 — 通过参考 Loopring 统计合约数据决策订单参数。交易所采用 Loopring 协议后，不需要再保存用户的 ERC20 代币资产。交易所的主要职能从负责 ERC20 的充值提现，内部虚拟账号管理，转移到更加纯粹的撮合服务。对于用户来讲， Loopring 协议不要求卖出或买入代币的充值，提现，锁定，因此根本没有资产丢失，被盗，或者资产流动性降低等的风险，同时一笔订单可以同时被多个交易所同时撮合。对于非 ERC20 资产，交易所可以提供代币发行服务（ Tokenization ），将资产通过抵押的方式，在区块链上发行相应的 ERC20 代币，并提供相应的充值、提现、和赎回功能。这种服务和传统交易所类似，但也省去了传统交易所研发和维护内部虚拟账号的必要。 5.1 传统与 Loopring 上交易所模式的对比 在传统交易所模型中，被撮合的两方中先下单的为 Maker ，后下单的为 Taker 。因为 Maker 创造流动性而 Taker 销毁流动性，所以在计算成交价时候会更偏向于 Maker 的价格，甚至直接采用 Maker 的价格作为成交价。与之相比， Loopring 采用的是 OverThe-Counter （ OTC ）模型。主要的原因是在去中心化环境中，很难严格界定哪个单是真正意义上较早的单。因此 Loopring 的撮合设计不考虑时间因素，只考虑兑换率（在本文中我们偶尔也用价格一词与兑换率交替使用）。传统交易所对投资者安全的保障只能依靠自身信用，如果出现兑付问题，跑路的成本非常低，因此需要通过监管保护投资者。然而在 Loopring 协议中，通过在区块链上开源智能合约可以实现交易的原子性，成交前卖出的代币和成交后买入的代币均存放在用户本人区块链地址中。整个交易过程过程用户无需向交易所转账，交易所不托管用户下单资金，资产丢失或者被盗风险为零，哪怕交易所倒闭，也不会对用户产生任何影响。传统交易所中，用户下单后用于交易的资金会被冻结，同一订单只能提交给一家交易所，各家交易只能看到部分交易信息。但在 Loopring 协议中，用户下单后依然可以动用账户资金，用户将资金部分或全部转移的行为等同于部分或全部撤单。订单可被广播给多家交易所，由不同交易所共同完成撮合，每家交易所可以看到全部订单，因此市场深度和订单表更全面，成交更快更有效。 Loopring 协议的另一个显著特点是消除了传统交易所中 交易对（ Trading Pair ） 6 总结 18 的概念。一个从 A到 B 的订单不一定要一个反向的从B 到 A订单才能撮合，只要有 一个交易环路被发现，就可以撮合。也可以说传统交易所的交易对是多边交易环路的一 个最简特例。为激励撮合价格最优的交易环路， Loopring协议的收费模式以成交的“成 本节约分润”为主，交易手续费为辅。 传统交易所 Loopring 交易所 托管下单资金 是 否1 下单资金冻结 是 否2 需充值提现 是 否3 有内部交易风险 是 否4 倒闭会造成用户损失 是 否5 收入主要来源为手续费 是 否6 支持法币 是 是7 同一个订单可以提交给多个交易所 否 是8 Maker 和 Taker 是否平等 否 是9 支持环路交易 否 是10 监管必要性 强 弱11 表 2: 两种模式交易所简要对比 6 总结 本文描述了一个开放的，支持智能合约和 ERC20 的代币间多边交易协议。该协议允许多个订单构成一个可交易环路进行撮合，并允许交易所只将撮合的最终结果作为交易提交到区块链上进行清算；本文描述了协议代币在撮合收费中起到的作用；以及 Loopring 协议相对于传统交易所模式为用户带来的好处。 1 Loopring 交易所无需托管下单资金 — 交易用代币存放到自己区块链地址中，成交前无需要转账。资产丢失或者被盗风险为零。 2 Loopring 交易所无需冻结下单资金 — 用户下单后依然可以任意动用账户任何资金，将资金部分或全部转移走等同于部分或全部撤单。 3 Loopring 订单实际是交易指令，交易过程中用户资产一直保存在用户自己的区块链地址中，无需充值提现过程。 4 Loopring 交易所撮合全部基于区块链智能合约，数据不可更改，完全开放透明。 5 Loopring 交易所如果不提供代币发行职责，交易所倒闭对用户没有任何影响 — 好比矿工倒闭对区块链账户也没有影响一样。交易所只负责撮合，清算转账通过智能合约完成。所有资产一直在区块链用户自己的账户里。 6 Loopring 交易所的交易手续费为辅助收入，主要收入为成交的“成本节约分润”，这样会激励撮合价格最优订单。 7 Loopring 交易所对法币的支持是通过资产代币化，需要将法币在区块链上做 ERC20 代币发行。 8 Loopring 允许用户的同一个订单被多家 Loopring 交易所同时撮合，并可以被多家交易所不同程度部分或全部成交。 9 Loopring 协议要求成交接近中间价，而不是过度倾向于 Maker 的价格。 10 Loopring 交易所支持环路发现，能最大程度找到最好的匹配订单。 11 Loopring 交易所不保存 阅读更多" />
<meta property="og:description" content="Loopring介绍 查看行情 路印协议新一代区块链资产交易协议和交易所。它采用去中心化技术，提供零风险的代币交易所模式，并允许多家交易所通过竞争，对同样的订单进行链外撮合及链上清结算。 路印协议将彻底解决现有中心化交易所模式的一些固有风险。 主要特性有： 1,绝对安全 路印协议订单中的卖出代币不必充值到交易所做资金托管，在下单、撮合、清结算过程中一直保存在用户自己区块链的地址中。订单不锁定用户区块链上的代币，下单后用户依然可以任意使用自己的数字代币，余额不足时路印协议自动调整订单的数额且保持价格恒定。使用路印协议，交易所倒闭跑路都不会对用户有任何影响。 2,环路撮合 路印协议一次撮合可将十几个包含不同类型代币的订单做环路撮合。 3,去中心化 订单在区块链外生成，传播、撮合；链上清算转账。理论上100%安全，用户资金不会丢失或被盗。 4,订单共享 路印协议中一个订单可以被广播给多个交易所，被这些交易所并行撮合。一个订单可被一个交易所撮合成功一部分，被另一个交易所撮合成功另一部分。交易所之间存在竞争关系，因此订单会被更快、更好（价格最优）地撮合。使用路印协议下单，交易不会因交易所被DDOS攻击而无法得到及时撮合。 5,跨链协议 路印协议是个去中心化安全交易的协议层，可在多个智能合约公有链上实现，而不依赖于某个特定平台。我们会在以太坊上率先实现第一个版本，接下来会在EOS，ETC，量子链上部署协议，为这些平台提供代币流动性支持 1 背景区块链 [1][2] 作为比特币 [3] 的底层技术，本质上是去中心化无信任环境中的存在性共识机制 [4][5]。存在性可应用于各种不同的数据，如股权，版权，使用权等。尽管联盟链和企业私有链中共识数据的类别正在变得越来越多样化，但这些数据的价值却有着明确的边界限制 — 只限于联盟成员间和企业内部。我们认为区块链的价值网络属性目前只有在公有链中才能得到更好的体现。根据 coinmarketcap.com 的统计，截止本文成稿时间，区块链上代币总市值已经接近 790 亿美元，以太坊区块链[6]（ETH）上承载的代币市值也已超过 170 亿美元。区块链对各行业都可能有着深远的影响，尤其是金融领域。我们相信基于区块链的新金融会有一个明显趋势，即资产代币化（Tokenization）[7][5]：一方面链下资产的使用权，所有权，分红权等相关权益通过抵押，会以代币（Token）[2] 的形式发行到区块链上，另一方面区块链上资产也会进行跨链发行。资产代币化的目标之一就是低成本，全球化，全天候的高流动性。而流动性则主要通过交易所得以实现，因此一个更适合区块链上代币的交易标准对于区块链金融至关重要。现阶段交易所都采用类似的模式：交易所要求用户将法币或者代币充值到交易所的银行账户或区块链地址中，然后交易所在自己的私有虚拟账户系统中为用户进行 IOU记账。用户实际交易的是这些 IOU。为了将IOU 兑换成法币或区块链代币，用户需要向交易所提出提现申请，提现成功后，才算真正交易完成。在这个过程中，交易所替用户保管资产的能力是用户最大的风险；同时用户还需承担交易所运营者商业道德带来的其它风险，比如挪用资金造成资不抵债等。 2014 年2 月当时世界最大的比特币交易所 Mt.Gox 的 85 万个比特币被盗一空 [8]，公司向日本东京地方法院申请破产保护。该公司的用户至今仍在等待其返还尚未被盗的少量比特币。随着调查的不断进行 Mt.Gox被曝出所谓的比特币被盗其实是监守自盗。 85万个“被偷窃”的比特币中，实际上因外部盗窃失踪的仅为 7000 个。2016 年 8月最大的美元比特币交易平台香港的 Bitfnex由于网站出现安全漏洞，导致用户持有的比特币被盗，被盗的比特币共 119756枚，总价值约为 6500 万美元。随后该公司决定由所有用户共同分担损失以避免破产。这些发生过的事件一方面反映出区块链代币交易在各个国家监管政策的缺失，另一方面也证实了中心化交易所模式的固有风险。本文描述的基于区块链的去中心化交易机制就是为了彻底解决上述问题。去中心化交易的核心优势之一是避免任何资产被托管，因此资产就不存在被盗的可能，这会极大降低用户对交易所的信任成本。这种交易机制的另一个优势是没有地缘和时间限制，以及极高的透明性和可追溯性。这些特点会促使交易整体具有更大的流动性和更小的价差。2 相关工作开源社区已经有过一些基于区块链搭建去中心化交易所的尝试，如瑞波（Ripple）、比特股（BitShares）、 Openledger 等。Ripple [9] 是一个去中心化的银行系统间清算协议，是为了解决银行间清算的高费用和高延迟问题而设计，具有快速、方便、超低费用的优点。 Ripple 提出了一项In- 2 相关工作 4 terledger [10] 协议（ILP）实现跨账本的资产交易。ILP 本身并不是一个账本，相反，它 提供了一个顶层加密托管系统，在称之为“连接者”的中介机构的帮助下，可以让资金 在各账本之间进行流动。 Ripple交易依赖于网关间信任的建立，而网关提供代币发行功 能。 比特股（BitShares）[11][12] 是一个区块链开发平台，任何个人和机构都可以在此 平台上自由地进行转账、借贷、发行资产等，也可以基于这个平台快速搭建出去中心化 的金融服务平台等。 BitShares内置的去中心化交易所（DEX），让数字资产的交易撮合 和交割完全发生在链上，并通过内置智能合约锚定其他资产，如法币、比特币、黄金、 白银等。可惜 BitShares项目由于开发者自身的问题，已经慢慢被边缘化。 Openledger[13] 是一个新型去中心化交易平台。它允许用户将比特币兑换成法币锚 定的 SmartCoins，SmartCoins 可以直接通过paypal、瑞波网关兑换成现金。需要注意 的是， Openledger在很大程度上依赖于 BitShares 2.0平台以及 Graphene Toolkit。因 此， Openledger平台的性能取决于 Graphene Toolkit的性能和 BitShares 2.0平台的性 能。 比特币的闪电网络 [14]和以太坊上的雷霆网络 [15] 是两个去中心化的系统。它们 的卓越之处在于，无需信任对方以及第三方即可实现实时的、海量的交易网络。闪电网 络和雷霆网络提供了一个可扩展的微支付通道网络。交易双方若在区块链上预先设有支 付通道，就可以多次、高频、双向地通过轧差方式实现瞬间确认的微支付；双方若无直 接的点对点支付通道，只要找到网络中一条连通双方的、由多个支付通道构成的支付路 径即可。闪电网络和雷霆网络的突出贡献是将链上交易放到链外，只把最后一笔清算交 易提交到区块链上，从而变相为区块链扩容。 Bancor[16] 协议引入了一种基于数学模型的方案去试图解决经济学中的“双重需求 巧合”问题。其理念和预测市场中的 Logarithmic Market Scoring Rules（LSMR）[17] 类似。 Bancor协议基于以区块链为基础的智能合约和储备代币，允许任何人通过这个 协议创建代币，新的代币以预先设置的比率来持有一种或几种其它代币作为自己的储备 金。这些储备代币可以是法币、数字化资产或其它加密代币。通过使用这些储备金，不 论有没有交易，新创建的代币都可以获得价格，并随时可以兑换回其对应的储备代币。 0x [18] 是一个可以在以太坊区块链上进行ERC20[19] 代币对等交易的开放式协议。 该协议旨在成为通用开放标准，作为可与其他协议组合的基本模块，用以驱动越来越 复杂的区块链应用程序。由于它使用的是以太坊的智能合约系统，因此可以作为各种 dApps 的共享基础架构。而从长远来看，开放式技术标准相比封闭模式具有更大的优 势，随着每个月有更多的资产在区块链上被代币化，也有更多的 dApps需要使用这些 不同的代币，开放式标准也因此变得更加重要。此外，由 dApps耦合到其底层协议所 导致的智能合约冗余也是未来区块链协议开发的主要障碍，因此在标准化之余，我们 还需要一个合适的解耦方式。 0x协议试图将信息交换功能从应用层拉到协议层，推动 dApps 之间的互操作性。然而，0x 协议的局限包括： taker 必须在线匹配订单，这导致 撮合实时性差，难以优化成交价格； 0x协议采用的是简单的 OTC 方式，无法法实现复 杂订单的撮合；不同交易所之间没有明确的竞争激励机制；也没有考虑了矿工的利益。 上述努力由于种种限制，到目前为止依然没有能够撼动中心化交易所的地位。我们 主要受到支付通道和 0x协议的启发，提出一种更可行的链上交易撮合标准。 3 协议设计 5 3 协议设计 图 1: Loopring 协议：图中示例一个三边交易的撮合我们用上图中的三边交易，简要讲解下采用 Loopring 协议的撮合交易过程。该过程如下： 1. 用户甲、乙、丙分别对 Loopring 撮合智能合约（ Loopring Matching Contract ）授权，授权后该合约可对用户指定代币账号做不超过一定额度的转出操作 1 。在上面实例中，合约可最多从用户甲的账号转出 1000 个 A 代币，从用户乙账户转出 9 个 B 代币，从用户丙账户转出 100 个 C 代币； 2. 用户甲、乙、丙分别生成自己的订单，并用私钥对其进行数字签名。订单不再区分买单和卖单，所有订单都被视为 交换单 — 甲的订单声明：甲愿意卖出不多于 1000 个 A 代币，买到尽可能多但不少于 10 个 B 代币；如果是部分成交，那么 A 到 B 的 兑换率 不得低于 1000/10 = 100.0 （卖出代币数量除以买入代币数量）。订单中还可以包含其它参数，我们在章节 3.7 中会对订单参数进行说明； 3. 甲、乙、丙分别将自己的订单通过适当的方式发送到一个或多个交易所； 4. 交易所收到上述三个订单，将它们分别放到三个对应的订单表（ orderbook ）中，并实时通过区块链数据更新计算每个订单的状态，同时不断努力寻找能够撮合的一组订单 — 我们后续称之为 交易环路 或者 撮合环路 。一旦确定三个订单的当前状态可以撮合成功，且收益满足预期，即决定实施这个撮合； 5. 交易所对撮合交易签名后发送到 Loopring 撮合智能合约地址； 1 通过 ERC20 机制实现。 3 协议设计 6 6. 撮合智能合约验证四方签名，之后验证三个订单（的最新状态）是否可以真正成 交。若无法成交，合约终止（交易所依然要消耗一定的油费）；否则智能合约分别 计算出甲、乙、丙三方各自需要支出的金额，以及交易所该收取的费用，并且实 时将甲、乙、丙账号中的资产进行互转，并完成对交易所的费用支付 —如下图 所示。在交易过程中，撮合智能合约还会调用 Loopring注册智能合约（Loopring Registration Contract）来计算交易所应该给予该笔交易的费用折扣；在交易完成 前，还会调用 Loopring统计智能合约（Loopring Stats Contract）对交易所以及 代币相关的统计数据做更新。 图 2: Loopring 协议：交易环路结算 7. 交易所监听新的区块和链下新的交易数据，并根据这些数据更新订单表，然后不断进行新的撮合。接下来我们介绍可以撮合成交的交易环路相关的概念，包括 交易链 ，交易链的可归约性，成交价，成交量，和交易所收益模型。 3.1 符号定义 在正式介绍协议之前，我们要介绍一些符号的定义。 C i ：编号为 i 的代币币种。 O i ! j ：一个卖出代币为 C i ，买入代币为 C j 的订单。 s i ! j ：表示上述订单的当前卖出代币 C i 的数量。 b i ! j ：表示上述订单的当前买入代币 C j 的数量。 r i ! j ：为订单 O i ! j 的兑换率，即 s i ! j / b i ! j 。为了特指订单的原始状态，我们为符号加上水平线，代表其在原始订单中的值，比如 s i ! j 和 b i ! j 分别代表原始订单中的卖出和买入代币数量。 3.2 订单兑换率恒定 除非订单完全成交，即 s i ! j = 0 ，否则 Loopring 协议保证订单状态更新后： s i ! j / b i ! j = s i ! j / b i ! j ，即订单中隐含的兑换率不会因为部分成交而变化，亦即 r i ! j = r i ! j 。 3 协议设计 7 在实际实施中，兑换率恒定是通过先计算部分成交后卖出代币的剩余量，再使用原 始订单中隐含的兑换率来计算买入代币数量得以保证的。 3.3 可规约性 考虑两个订单 O i ! j 和 O j ! k , 我们可以通过中间代币 C j 的连接，将其规约一个卖出代币为 Ci ，买入代币为 C k 的订单。我们用 O i ! j ! k 来表示这样一个订单，它和订单 O i ! k 在撮合的各种属性上是等价的，且： s i ! j ! k = min ( b i ! j ; s j ! k ) · r i ! j (1) b i ! j ! k = min ( b i ! j ; s j ! k )/ r j ! k (2) r i ! j ! k = r i ! j · r j ! k (3) 在这里我们顺便引入 订单链 这个概念。一个订单链是两个或者两个以上订单，除了最后一个订单，每个订单的买入代币类型恰巧是后一个订单的卖出代币类型，但最后一个订单的买入代币类型不同于第一个订单的卖出代币类型（否则就成了一个环路）。我们可以将上述规约计算用于一个订单链。通过规约，一个包含 n - 1 个订单（ n 个不同的代币） , 即长度为 n - 1 的订单链可被视为一个单一订单 O 0 ! ::: ! n ，且有： s 0 ! ::: ! n = 8&lt;: s 0 ! 1 如 n = 1 min ( b 0 ! ::: ! n - 1 ; s n - 1 ! n ) · r 0 ! ::: ! n - 1 如 n &gt; 1 b 0 ! ::: ! n = 8&lt;: b 0 ! 1 如 n = 1 min ( b 0 ! ::: ! n - 1 ; s n - 1 ! n )/ r n - 1 ! n 如 n &gt; 1 r 0 ! ::: ! n = n - 1 ∏ i =0 r i ! i +1 订单链的可规约性可以帮助我们在分析订单路径时简化模型，在后文的讨论中，我们将符号 O i ! j 的含义扩展到即包含简单的卖出代币为 C i ，买入代币为 C j 的单一订单，也包含可规约成这样一个类型订单的订单链，如果为了强调是个订单链，我们会用 O i ! ::: ! j 或 O i !! j 表示。 3.4 环路撮合 传统撮合系统是在两个币种间，即一个交易对的买卖两个方向间完成撮合；而 Loopring 协议将撮合的概念扩展到多币种，通过 交易环路 来完成多个币种之间交易的撮合。下面介绍一下交易环路的概念。 定义 3.1 ( 交易环路 ) 如果有 n 个币种 C 0 、 C 1 、 · · · 、 C n - 1 ，和 n 个订单： O 0 ! 1 ， · · · ， O i ! i ⊕ 1 ， · · · ， O n - 1 ! 0 ，其中， i ⊕ 1 ≡ i + 1 mod n 。那么这些订单可以组成跨 n 个币种的交易环路： 3 协议设计 8 O 0 ! 1 ! · · · ! O i ! i ⊕ 1 ! · · · ! O n - 1 ! 0 ，其中 n 为环路的长度。 当这些订单的价格 满足一定条件时 ，我们可以对整个交易环路进行撮合，这种交易环路称为 可交易环路 。下面我们对交易环路中的成交价格和成交量进行讨论。 3.4.1 成交条件和价格 我们由一个长度为 3 的交易环路为例，介绍环路可成交的条件。假定环路中的三个币种为 C 0 、 C 1 和 C 2 ，三笔订单分别为： O 0 ! 1 、 O 1 ! 2 和 O 2 ! 0 。很容易证明，如果 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 = 1 时，三个订单都可以用其自身的兑换率成交。当 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 &gt; 1 时，三个订单都可以用比自身兑换率更低的兑换率成交。我们称第一种情况为 原价撮合 ，称第二种情况为 折价撮合 。 Loopring 协议要求交易环路的折价平均分享给环路中的每个订单。假设每笔订单兑换率折价比例为 γ ，那么最终完成撮合时，三笔订单的成交价分别为： r 0 ! 1 · (1 - γ ) ， r 1 ! 2 · (1 - γ ) ， r 2 ! 0 · (1 - γ ) ，并且满足： r 0 ! 1 · (1 - γ ) · r 1 ! 2 · (1 - γ ) · r 2 ! 0 · (1 - γ ) = 1 (4) 根据上式我们可以推导出： γ = 1 - 1 p 3 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 。在更一般的情形下，如果跨 n 个币种的环路中， 兑换率折扣 为： γ = 1 - 1 √ n ∏ ni =0 - 1 r i ，其中 r i 表示第 i 个订单的兑换率。显然，只有在兑换率折扣 γ ≥ 0 时，交易环路才可以真正成交；且第 i 个订单 O i 的实际兑换率 r ^ i = r i · (1 - γ ) ，且有 r ^ i ≤ r i 。 3.4.2 成交量 当一个交易环路撮合完成后，至少有一个订单是被完全成交的。这点很容易得到证明：我们可以先假设该结论不成立，即全部订单都没有完全成交。由于章节 3.2 中要求兑换率在订单新状态（尾单）中保持不变，意味着撮合后新的环路依然满足成交条件。这就意味着之前的撮合是没有进行完的。因此可以断言：一次完整的撮合应该会将至少一个订单完全吃掉。我们称这个（些）被完全吃掉的订单为交易环路的 最小订单 。找到任何一个最小订单，既可循环计算环路中所有订单的成交量。假设第 i 个订单是最小订单，那么每笔订单的卖出代币成交量 s ^ 和买入代币成交量 ^ b 可以以此如下计算得出： s ^ i = s i ， ^ b i = ^ s i /^ r i ，其中 s i 为订单的卖出代币余额 ; s ^ i ⊕ 1 = ^ b i ， ^ b i ⊕ 1 = ^ s i ⊕ 1 /^ r i ⊕ 1 ; s ^ i ⊕ 2 = ^ b i ⊕ 1 ， ^ b i ⊕ 2 = ^ s i ⊕ 2 /^ r i ⊕ 2 ; ::: 3 协议设计 9 实际实施过程中，可以先假定第一个订单为最小订单，往后循环计算成交量，直到 每个订单的成交量都不再变化为止。理论上最多循环两次即可计算出每单的实际成交 量。 3.4.3 撮合费用 交易所第一种收费形式是手续费。在订单中可以设置一个以 Loopring 的代币 LRC 为单位的费用 , m i ，代表完全成交情况下编号为 i 订单愿意支付给交易所的手续费总和。实际成交时候按订单卖出代币成交比例支付给交易所，即： f i = b i · m i / b i 为了鼓励交易所为用户找到兑换率折价比例最大的成交环路， Loopring 协议要求将兑换率折价带来的 成本节约 分润给交易所。对于一个订单 O i , 假设买入订单的成交额度为 b i （ b i ≤ b i ） , 我们定义成本节约为： ∆ i = b i · r i · γ Loopring 协议允许每个订单设定一个成本节约分享 分润比例 θ i ，并将交易环路上所有订单分润比例的最小值作为该环路的分润比例 Θ ，那么订单 O i 支付给交易所的费用为： f i = ∆ i · Θ = b i · r i · γ · Θ 因此交易所对于一个交易环路，通过成本节约分润获得的收入为： F = n - 1 ∑ i =0 b i · r i · γ · Θ 采用所有订单中最小的分润比例作为整个交易环路的分润比例，可以激励订单采用较大的分润比例。这样做会激励交易所对订单进行撮合，同时一旦订单成交，也不一定非要支付指定比例的分润。为了鼓励 Loopring 的代币 LRC 的使用，如果订单中没有指定代币费用 m i ，或 m i = 0 ，那么该笔订单的分润比例实际被认为是 100% ，而不管订单中相应参数的值是多少。如果一个交易环路中的所有订单都没有设置代币费用， Θ = 100 % ，环路中所有成本节约归交易所所有。在下一章节，我们会引入一个激励交易所竞争的代币抵押机制，智能合约根据每个交易所代币抵押数量的排名，为每个交易所计算一个 费用强制折扣 ， λ ，该折扣会进一步影响交易所的费用收取；同时，交易所也可以指定为某个交易环路做进一步的费用优惠折扣， η 。因此，交易所对于一个交易环路的整体费用为： F = (1 - λ ) · (1 - η ) · n - 1 ∑ i =0 ( b i · r i · γ · Θ + b i · m i / b i ) 两种不同的费用模型能够满足不同订单的诉求：对于没有 LRC 代币的账户，可以设置合适的分润比例；对于有 LRC 代币的账户，可以选择支付较多的代币费用，并将 3 协议设计 10 分润比例设为一个较小值。交易所有可能对每笔订单的代币费用值有个最小额度限制， Loopring 协议并不对此作出明确要求。交易所可以在自己网站上对相关标准做说明，并 引导用户设定合适的订单参数值。 3.4.4 交易所费用强制折扣 Loopring 协议要求交易所给交易费强制打一个折扣，折扣大小决定于交易所抵押 LRC 代币数量的排名，排名越靠后，折扣越高。假定排名为 n 的折扣为： λ n = 0 : 05 · ( ln ( n + e - 1) - 1) 。具体返利比例如下表所示： 抵押排名 n 费用强制折扣 λ 1 0% 2 1:57% 10 7:31% 20 10:39% 99 18:06% 100 18:11% 1000 29:55% 1001 30:00%∗ 表 1: 抵押 LRC 排名与费用强制折扣对于排名 1001 及以后的交易所，或未进行抵押的交易所，统一实施 30% 费用强制折扣。如下图所示，费用强制折扣的下降并非线性的，如 λ 2 - λ 1 ≫ λ 100 - λ 99 。 3 协议设计 11 图 3: LRC 代币抵押排名与费用强制折扣在实际部署时，折扣函数中的参数需要根据市场行情不断调整，比如交易量和实时性。当市场交易量过于旺盛时，会导致过多交易无法及时确认，这时需要降低整体折扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交易的撮合。 3.5 防作弊和防攻击 3.5.1 交易所无风险套利 Loopring 协议致力寻求在用户和交易所间利益的平衡点，打造公平健康的交易所生态。 Loopring 协议不反对交易所的套利行为，因为套利行为本质上也是在促成交易。但是我们禁止交易所利用自己在生态中角色的特殊性进行套利，具体来说，通过上传一种特殊的闭环无风险套取订单间的价差，本节我们将介绍如何防止交易所的这种行为。在介绍之前，我们首先来分析交易所如何做到无风险套利。假设有两个订单 O a ! b ， O b ! a ，形成一个交易环路，且 r a ! b · r b ! a &gt; 1 。交易所可以在这个环路上插入三个自己新生成的订单 O b ! c ， O c ! d ， O d ! b ，生成一个长度为 5 的新环路，并使 r a ! b · r b ! c · r c ! d · r d ! b · r b ! a = 1 。通过这种方式，交易所可以做到将所有可能的成本节约变成 0 ，一旦撮合被智能合约接受，即可实现无风险套利。这种套利的交易环路有个显著的特征：它们包含子环路。在上个例子中，两个子环路分别是： O a ! b ! O b ! a 和 O b ! c ! O c ! d ! O d ! b 。为了杜绝交易所的这种无风险套利， Loopring 协议要求： 合法的闭环必须保证其订单子集无法组成更小的可交易环路 。 3.5.2 交易所拒绝服务 Loopring 协议允许交易所选择性地为特定订单做撮合。交易所有权对订单的代币类型，订单数量，费用等做筛选，也有权对这些筛选条件做更改，且有权公开或隐藏这些筛选条件。交易发起者与交易所之间是相互选择的关系，彼此没有任何义务。 3.5.3 尘埃订单攻击 普通用户可以通过广播大量的尘埃订单（即数量非常小的订单）试图对交易所做攻击，不过由于撮合尘埃订单获利很低，所以这些订单一定会被交易所抛弃，进而对交易所和区块链没有任何影响。交易所也可能采用同样方式发起攻击，从而试图影响其它交易所对某些订单的撮合。不过这种努力也不会奏效，因为协议允许同一个订单在同一个块中参与到多个环路成交（这些环路可能是不同交易所提交到区块链上的），换句话说，订单并没有所谓的锁定状态。 3.5.4 余额不足订单攻击 交易发起者可能发起多笔订单，但订单卖出代币账户实际余额为零。这样的订单提交到交易所后，交易所很容易通过查询区块链地址的余额信息将该订单抛弃，不过这种 3 协议设计 12 攻击的确会浪费交易所的处理时间。好在交易所可以通过黑名单机制，迅速有效地将某 些地址屏蔽掉，拒绝再为这些地址提供撮合服务。 3.5.5 撮合窃取 一个懒惰交易所可以监听网络上未被确认的撮合交易，解析交易环路并生成一个带有自己签名的新撮合（环路相同，只有受益地址和数字签名不同），通过提供更高的交易费来窃取其它交易所的撮合结果。特别当窃取者是矿工时，这种作弊行为是比较难以预防的。为防止撮合窃取，我们规定交易所上传订单环路的过程分为两步： • 交易所在区块链上发一笔交易，上传订单环路的存证， • 存证信息被写入区块链后，交易所提交具体环路信息。这个存证通过哈希来实现，哈希值的生成方法为 h = H ( r; nonce ) ，其中， H () 为单向函数， r 为订单环路信息。哈希函数的输入包含了一个随机数 nonce ，用于防止对哈希值进行暴力破解。在提交具体环路信息时，随机数 nonce 需要一并提交。 3.6 市场深度 交易所并不一定需要提供市场深度数据。在整个生态中，可能会有单独的组织和机构汇集全网的未成交订单或者交易的尾单信息，汇总成独立的市场深度数据。市场深度数据可以根据章节 3.3 中的订单的规约方法，计算出任何两个 ERC20 代币之间的买单卖单数据。 3.7 数据格式 由于采用 OTC 模型，所有订单可以用同一个数据结构表示。该结构包含订单本身的各种参数数据和发起者的数字签名。在签名前，先将订单参数数据连接成一个字节数组，通过 Keccak SHA3 方法对这个字节数组做散列计算得到订单的哈希，之后用账户私钥对这个哈希进行 ECDSA 签名。 message Order {address protocol; // Loopring 协议入口智能合约地址 address owner; // 该订单发起者地址 address outToken; // 卖出 ERC20 代币智能合约地址 address inToken; // 买入 ERC20 代币智能合约地址 uint256 outAmount; // 卖出 ERC20 代币数量上限 uint256 inAmount; // 买入 ERC20 代币数量下限 unit256 expiration // 过期时间 unit256 fee; // 交易总费用（ LRC ），部分成交的费用按该次 3 协议设计 13 // 撮合实际卖出代币额与 outAmount 比例计算 uint8 marginSplit; // fee 不为 0 时支付给交易所的分润比例，否则视为 100%unit8 v;bytes32 r;bytes32 s;} 订单中虽然没有明确指定价格，但我们可以通过计算 outAmount / inAmount 来得到一个订单兑换率 r 。该兑换率隐含地要求所有实际撮合成交的兑换率不得大于 r 。一个好的交易所 UI 应该允许用户输入 outAmount ， inAmount ，和传统意义的买入价或卖出价这三个数据的任意两个来计算缺失的 outAmount 或 outAmount 值。订单实际上可以有两种不同的 完全成交 定义：一种定义是只有卖出代币达到了 outAmount 就算完全成交；另一种定义在之前的基础上允许买入代币累计金额达到 inAmount 也算完全成交。我们可以在订单中引入一个参数告诉交易所和撮合智能合约选择哪种完全成交定义。在第一版本的实现中，我们先支持第一种完全成交定义。交易所可以通过下面的数据结构构建一个交易环路： message MatchRing {Order[] orders; // 该次匹配的所有订单 address feeRecipient; // 费用收取地址 unit256 additionalDiscount; // 在费用基础上进行的再折扣价 - etaunit256 nonce; // 一个随机数 unit8 v;bytes32 r;bytes32 s;} 一个可交易环路上同一位置的订单只能有一个 — 理论上可以将这个限制去掉，不过这会让撮合智能合约更加复杂，我们可能在后续的版本中再给与支持。 3.8 订单状态 订单发起者对订单签字广播后无法对该订单进行修改。撮合智能合约一旦对某个订单进行撮合，就需要在区块链上对订单的状态更新记录。对部分或者完全成交的订单，会计算更新 inAmount 和 outAmount 两个值，并且保障订单新状态价格和原始订单的价格一致。如果 inAmount 或 outAmount 为 0 ，则表示该订单已经完全成交。如果用户取消订单，需要发起一个特殊的交易，将 inAmount 和 outAmount 更改为 0 即可。过期的订单不会触发区块链上的数据更新 — 可以根据最后一个块的时间戳来判断任何一个订单是否过期 — 因此我们期待多数的订单会因为过期或者完全成交而变成失效。交易所需要采用同样的甚至是更复杂的逻辑在区块链外追踪订单状态，尤其是当一家交易监听到到竞争对手在对同一个订单做不同的撮合的时候。一个可交易的订单还需要其账户中有足够多的卖出代币余额 balance ，虽然 balance 不要求达到订单中 outAmount 的数量。实际上交易所在对订单状态计算的时候，会取 4 LOOPRING 协议代币LRC 14 max(balance; outAmount)作为实际的可成交金额。这里可以看出，订单的卖出代币并 不需要锁定的过程。用户提交订单后依然可以任意支配卖出代币作为他用。交易所不仅 仅要监听订单被（其它交易所）撮合的结果，还需要监听订单账户的余额变动情况。看 起来这种对区块链数据的监听和对订单状态的更新有些复杂，但这些反而极大简化区块 链上合约的逻辑，这种思路和比特币闪电网络，以太坊的雷霆网络的思路是一致的。 3.9 智能合约 Loopring 协议协议可能包含多个智能合约，包括但不限于： • 撮合合约 负责计算并确认交易环路中每个订单的状态，计算成交金额和成交量，对交易进行清算转账。该合约还会与其它合约交互，是 Loopring 协议的入口合约； • 订单合约 负责更新订单状态以及对取消订单提供支持； • 交易所注册合约 负责维护和更新一系列支持 Loopring 协议的交易所，为交易所代币抵押和预设参数默认值提供支持； • 统计合约 计算任何两个币种之间的成交量，成交价，以及不同交易所的贡献度等指标，以及这些指标的某些滑动平均值。这些指标是订单发起者授权撮合的重要参考依据，同时也可以作为某些预测市场的输入，并且为以后可能的协议拓展（比如对条件单的支持）提供输入（ Oracle ）。这里，不排除将上述合约进一步拆解或合并的可能。同时值得指出： Loopring 协议中的智能合约是完全开放的，这意味着它们可以被任何的 dApp 直接或者间接调用。因此整个协议即使一个完善的整体，又是个开放的，单独可用的组件的集合。 4 Loopring 协议代币 LRC 我们将为 Loopring 协议发行符合 ERC20 规范的原生代币，其符号为 LRC （在本文中用斜体字母表示）。 4.1 代币的应用 LRC 在生态中发挥下列作用： • 作为撮合费用 — 订单中可以指定用 LRC 可作为支付给交易所的撮合费用。虽然协议支持通过卖出代币成本节约的分润作为支付手段，但对于交易所来说，将来需要支持的 ERC20 代币类型可能越来越多，如果每笔撮合交易都通过各订单中的卖出代币为单位支付手续费，那么对于一次撮合的收益计算将变得复杂；相反，如果通过 LRC 来衡量收益（或者用来计算成本），会简单得多。同样，对于订单发起者，可以通过公开信息获取某笔订单需要支付大约多少费用，如果用每个订单的卖出代币计算，那么下单过程中的费用计算也会比较分散。我们在之前章节 3.4.3 对费用模型做了详细的说明。 4 LOOPRING 协议代币LRC 15 • 作为交易所注册抵押—订单发起者希望自己的订单得到最好的撮合，这要求交易 所在各个方面都做到专业，特别是对全部订单的汇聚情况。由于去中心化交易没 有地域限制，一个好的交易所应该能比一个相对差的交易所看到更多的订单，也 应能在最短时间内找到最好的交易环路。为了鼓励实力强的交易所，淘汰实力差 的交易所，我们提供一种交易所注册抵押机制：交易所可以将一定数量的 LRC 代 币抵押给智能合约。交易所可以随时申请抵押代币的解冻，但申请提出后，一年 后才锁定的代币才可以转账出去。并不是所有交易所都必须进行注册抵押。交易 所代币抵押的另一个作用是防止交易所为了抛弃不利的历史统计数据而频繁变动 身份。 4.2 去中心化自治 随着交易所的不断升级，交易所中的规则需要不断升级升级，为此我们引入去中心化自治机制。任何持有 LRC 者都可以将代币抵押并获得自治系统的投票权益，投票权益 S 是一个关于抵押数量 N 和抵押时间 CoinAge 的函数， S = f ( N; CoinAge ) ，其中 CoinAge = H c - H s ，这里的 CoinAge 是当前区块高度 H c 减去开始抵押区块高度 H s 。加入 CoinAge 参数是为了防止有攻击者短时间内租借到大量代币并获得很高的权益，迫使某项并不为他人接受的提议得以通过。在去中心化自治系统中，任何决定都要在一个固定时间内完成投票，这个时间根据提议内容不同而发生改变。当且仅当收集到足够高权益的投票，提议才会执行，否则提议将会关闭。在去中心化自治系统中，并不是权益高者的一言堂，权益低者可以联合在一起制衡权益高者。去中心化自治内容包括但不限于交易所注册、币种注册、统计函数、抵押代币范围等，这些升级可以通过自治系统参与者共同投票参与决定。 • 币种注册 Loopring 协议会阶段性的调整支持的币种，有些数字货币会因为交易量过低而退出交易所，而另外会有一些新的数字货币诞生而加入交易所。这些币种需要记录在智能合约中，包括币种名称、代号及对应智能合约地址等信息。 • 交易所注册 交易所需要注册完成才能通过协议进行交易，当交易所达到一定数量后，新注册交易所需要经过自治系统投票才能通过。 • 统计函数 随着交易所上线运行时间越长，数据量得到一定积累，用于统计的指标和函数也会逐渐成熟。自治系统参与者可以决定新增或淘汰统计函数。 • 抵押代币范围 交易所可以抵押的代币数量需要限制在一定范围内。如果抵押数量太多，会导致代币流动性变差；如果抵押过少，则无法体现交易所间的差异性。 • 环路最大长度 理论上说，环路越长越有可能发现利差大的环路，然而过长的环路会降低环路撮合的成功率，并且在过长的环路会带来过高的计算成本。 4 LOOPRING 协议代币LRC 16 • 强制折扣函数强制折扣函数需要根据市场行情不断调整，比如交易量和实时性。当 市场交易量过于旺盛时，会导致交易过多而无法及时确认，这时需要降低整体折 扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交 易的撮合。如下图所示，其中蓝色为交易量正常时的折扣率，黄色为市场交易量 过高时的折扣率，红色为交易量过低时的折扣率。 图 4: 调整后的强制折扣率 • 子合约地址 如果基于公有链搭建 Loopring 交易所，智能合约本身是无法改动的。在这种情况下，如果升级 Loopring 协议的子合约，则需要重新部署智能合约，并修改子合约的地址。 4.3 代币的原生流动性 Loopring 协议代币本身遵循 ERC20 标准，并且在 Loopring 智能合约的基础上带有原生的流动性 — 这意味着你不必去传统的交易所购买和出售 LRC ，而是可以通过本文论述的方式，利用 Loopring 协议本身的去中心化撮合机制，使用任何 ERC20 代币购得 LRC （订单中的买入代币设定为 LRC ，并将 fee 设为 0 ）。这得益于协议灵活的收费模式。 5 交易所 17 5 交易所 采用 Loopring 开放协议后，交易所并不能保证每一个撮合都是盈利的。一方面可能是成本过高，因为交易所为了激励矿工优先打包自己的撮合交易到区块链，可能根据预期的收益调高手续费，而手续费代币和撮合中代币的相对价格有可能有超出预期的浮动，从而造成手续费实际成本更高。另一方面可能是因为收入没有达到预期，比如交易所把撮合广播到区块链后，该撮合的某个订单的卖出代币被部分或者全部转移到另一个地址，从而造成整个撮合交易未能被确认或实际成交量和手续费过低。类似这样的原因还有很多，因此交易所的每次撮合广播都是根据自己的经验和算法，最大化长期利益的概率游戏。不过也不用担心，实际上交易所和订单发起者是双向选择的关系：交易所只会选择有利可图的订单；而订单发起者只会选择费用最低的交易所 — 通过参考 Loopring 统计合约数据决策订单参数。交易所采用 Loopring 协议后，不需要再保存用户的 ERC20 代币资产。交易所的主要职能从负责 ERC20 的充值提现，内部虚拟账号管理，转移到更加纯粹的撮合服务。对于用户来讲， Loopring 协议不要求卖出或买入代币的充值，提现，锁定，因此根本没有资产丢失，被盗，或者资产流动性降低等的风险，同时一笔订单可以同时被多个交易所同时撮合。对于非 ERC20 资产，交易所可以提供代币发行服务（ Tokenization ），将资产通过抵押的方式，在区块链上发行相应的 ERC20 代币，并提供相应的充值、提现、和赎回功能。这种服务和传统交易所类似，但也省去了传统交易所研发和维护内部虚拟账号的必要。 5.1 传统与 Loopring 上交易所模式的对比 在传统交易所模型中，被撮合的两方中先下单的为 Maker ，后下单的为 Taker 。因为 Maker 创造流动性而 Taker 销毁流动性，所以在计算成交价时候会更偏向于 Maker 的价格，甚至直接采用 Maker 的价格作为成交价。与之相比， Loopring 采用的是 OverThe-Counter （ OTC ）模型。主要的原因是在去中心化环境中，很难严格界定哪个单是真正意义上较早的单。因此 Loopring 的撮合设计不考虑时间因素，只考虑兑换率（在本文中我们偶尔也用价格一词与兑换率交替使用）。传统交易所对投资者安全的保障只能依靠自身信用，如果出现兑付问题，跑路的成本非常低，因此需要通过监管保护投资者。然而在 Loopring 协议中，通过在区块链上开源智能合约可以实现交易的原子性，成交前卖出的代币和成交后买入的代币均存放在用户本人区块链地址中。整个交易过程过程用户无需向交易所转账，交易所不托管用户下单资金，资产丢失或者被盗风险为零，哪怕交易所倒闭，也不会对用户产生任何影响。传统交易所中，用户下单后用于交易的资金会被冻结，同一订单只能提交给一家交易所，各家交易只能看到部分交易信息。但在 Loopring 协议中，用户下单后依然可以动用账户资金，用户将资金部分或全部转移的行为等同于部分或全部撤单。订单可被广播给多家交易所，由不同交易所共同完成撮合，每家交易所可以看到全部订单，因此市场深度和订单表更全面，成交更快更有效。 Loopring 协议的另一个显著特点是消除了传统交易所中 交易对（ Trading Pair ） 6 总结 18 的概念。一个从 A到 B 的订单不一定要一个反向的从B 到 A订单才能撮合，只要有 一个交易环路被发现，就可以撮合。也可以说传统交易所的交易对是多边交易环路的一 个最简特例。为激励撮合价格最优的交易环路， Loopring协议的收费模式以成交的“成 本节约分润”为主，交易手续费为辅。 传统交易所 Loopring 交易所 托管下单资金 是 否1 下单资金冻结 是 否2 需充值提现 是 否3 有内部交易风险 是 否4 倒闭会造成用户损失 是 否5 收入主要来源为手续费 是 否6 支持法币 是 是7 同一个订单可以提交给多个交易所 否 是8 Maker 和 Taker 是否平等 否 是9 支持环路交易 否 是10 监管必要性 强 弱11 表 2: 两种模式交易所简要对比 6 总结 本文描述了一个开放的，支持智能合约和 ERC20 的代币间多边交易协议。该协议允许多个订单构成一个可交易环路进行撮合，并允许交易所只将撮合的最终结果作为交易提交到区块链上进行清算；本文描述了协议代币在撮合收费中起到的作用；以及 Loopring 协议相对于传统交易所模式为用户带来的好处。 1 Loopring 交易所无需托管下单资金 — 交易用代币存放到自己区块链地址中，成交前无需要转账。资产丢失或者被盗风险为零。 2 Loopring 交易所无需冻结下单资金 — 用户下单后依然可以任意动用账户任何资金，将资金部分或全部转移走等同于部分或全部撤单。 3 Loopring 订单实际是交易指令，交易过程中用户资产一直保存在用户自己的区块链地址中，无需充值提现过程。 4 Loopring 交易所撮合全部基于区块链智能合约，数据不可更改，完全开放透明。 5 Loopring 交易所如果不提供代币发行职责，交易所倒闭对用户没有任何影响 — 好比矿工倒闭对区块链账户也没有影响一样。交易所只负责撮合，清算转账通过智能合约完成。所有资产一直在区块链用户自己的账户里。 6 Loopring 交易所的交易手续费为辅助收入，主要收入为成交的“成本节约分润”，这样会激励撮合价格最优订单。 7 Loopring 交易所对法币的支持是通过资产代币化，需要将法币在区块链上做 ERC20 代币发行。 8 Loopring 允许用户的同一个订单被多家 Loopring 交易所同时撮合，并可以被多家交易所不同程度部分或全部成交。 9 Loopring 协议要求成交接近中间价，而不是过度倾向于 Maker 的价格。 10 Loopring 交易所支持环路发现，能最大程度找到最好的匹配订单。 11 Loopring 交易所不保存 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-02-06T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"Loopring介绍 查看行情 路印协议新一代区块链资产交易协议和交易所。它采用去中心化技术，提供零风险的代币交易所模式，并允许多家交易所通过竞争，对同样的订单进行链外撮合及链上清结算。 路印协议将彻底解决现有中心化交易所模式的一些固有风险。 主要特性有： 1,绝对安全 路印协议订单中的卖出代币不必充值到交易所做资金托管，在下单、撮合、清结算过程中一直保存在用户自己区块链的地址中。订单不锁定用户区块链上的代币，下单后用户依然可以任意使用自己的数字代币，余额不足时路印协议自动调整订单的数额且保持价格恒定。使用路印协议，交易所倒闭跑路都不会对用户有任何影响。 2,环路撮合 路印协议一次撮合可将十几个包含不同类型代币的订单做环路撮合。 3,去中心化 订单在区块链外生成，传播、撮合；链上清算转账。理论上100%安全，用户资金不会丢失或被盗。 4,订单共享 路印协议中一个订单可以被广播给多个交易所，被这些交易所并行撮合。一个订单可被一个交易所撮合成功一部分，被另一个交易所撮合成功另一部分。交易所之间存在竞争关系，因此订单会被更快、更好（价格最优）地撮合。使用路印协议下单，交易不会因交易所被DDOS攻击而无法得到及时撮合。 5,跨链协议 路印协议是个去中心化安全交易的协议层，可在多个智能合约公有链上实现，而不依赖于某个特定平台。我们会在以太坊上率先实现第一个版本，接下来会在EOS，ETC，量子链上部署协议，为这些平台提供代币流动性支持 1 背景区块链 [1][2] 作为比特币 [3] 的底层技术，本质上是去中心化无信任环境中的存在性共识机制 [4][5]。存在性可应用于各种不同的数据，如股权，版权，使用权等。尽管联盟链和企业私有链中共识数据的类别正在变得越来越多样化，但这些数据的价值却有着明确的边界限制 — 只限于联盟成员间和企业内部。我们认为区块链的价值网络属性目前只有在公有链中才能得到更好的体现。根据 coinmarketcap.com 的统计，截止本文成稿时间，区块链上代币总市值已经接近 790 亿美元，以太坊区块链[6]（ETH）上承载的代币市值也已超过 170 亿美元。区块链对各行业都可能有着深远的影响，尤其是金融领域。我们相信基于区块链的新金融会有一个明显趋势，即资产代币化（Tokenization）[7][5]：一方面链下资产的使用权，所有权，分红权等相关权益通过抵押，会以代币（Token）[2] 的形式发行到区块链上，另一方面区块链上资产也会进行跨链发行。资产代币化的目标之一就是低成本，全球化，全天候的高流动性。而流动性则主要通过交易所得以实现，因此一个更适合区块链上代币的交易标准对于区块链金融至关重要。现阶段交易所都采用类似的模式：交易所要求用户将法币或者代币充值到交易所的银行账户或区块链地址中，然后交易所在自己的私有虚拟账户系统中为用户进行 IOU记账。用户实际交易的是这些 IOU。为了将IOU 兑换成法币或区块链代币，用户需要向交易所提出提现申请，提现成功后，才算真正交易完成。在这个过程中，交易所替用户保管资产的能力是用户最大的风险；同时用户还需承担交易所运营者商业道德带来的其它风险，比如挪用资金造成资不抵债等。 2014 年2 月当时世界最大的比特币交易所 Mt.Gox 的 85 万个比特币被盗一空 [8]，公司向日本东京地方法院申请破产保护。该公司的用户至今仍在等待其返还尚未被盗的少量比特币。随着调查的不断进行 Mt.Gox被曝出所谓的比特币被盗其实是监守自盗。 85万个“被偷窃”的比特币中，实际上因外部盗窃失踪的仅为 7000 个。2016 年 8月最大的美元比特币交易平台香港的 Bitfnex由于网站出现安全漏洞，导致用户持有的比特币被盗，被盗的比特币共 119756枚，总价值约为 6500 万美元。随后该公司决定由所有用户共同分担损失以避免破产。这些发生过的事件一方面反映出区块链代币交易在各个国家监管政策的缺失，另一方面也证实了中心化交易所模式的固有风险。本文描述的基于区块链的去中心化交易机制就是为了彻底解决上述问题。去中心化交易的核心优势之一是避免任何资产被托管，因此资产就不存在被盗的可能，这会极大降低用户对交易所的信任成本。这种交易机制的另一个优势是没有地缘和时间限制，以及极高的透明性和可追溯性。这些特点会促使交易整体具有更大的流动性和更小的价差。2 相关工作开源社区已经有过一些基于区块链搭建去中心化交易所的尝试，如瑞波（Ripple）、比特股（BitShares）、 Openledger 等。Ripple [9] 是一个去中心化的银行系统间清算协议，是为了解决银行间清算的高费用和高延迟问题而设计，具有快速、方便、超低费用的优点。 Ripple 提出了一项In- 2 相关工作 4 terledger [10] 协议（ILP）实现跨账本的资产交易。ILP 本身并不是一个账本，相反，它 提供了一个顶层加密托管系统，在称之为“连接者”的中介机构的帮助下，可以让资金 在各账本之间进行流动。 Ripple交易依赖于网关间信任的建立，而网关提供代币发行功 能。 比特股（BitShares）[11][12] 是一个区块链开发平台，任何个人和机构都可以在此 平台上自由地进行转账、借贷、发行资产等，也可以基于这个平台快速搭建出去中心化 的金融服务平台等。 BitShares内置的去中心化交易所（DEX），让数字资产的交易撮合 和交割完全发生在链上，并通过内置智能合约锚定其他资产，如法币、比特币、黄金、 白银等。可惜 BitShares项目由于开发者自身的问题，已经慢慢被边缘化。 Openledger[13] 是一个新型去中心化交易平台。它允许用户将比特币兑换成法币锚 定的 SmartCoins，SmartCoins 可以直接通过paypal、瑞波网关兑换成现金。需要注意 的是， Openledger在很大程度上依赖于 BitShares 2.0平台以及 Graphene Toolkit。因 此， Openledger平台的性能取决于 Graphene Toolkit的性能和 BitShares 2.0平台的性 能。 比特币的闪电网络 [14]和以太坊上的雷霆网络 [15] 是两个去中心化的系统。它们 的卓越之处在于，无需信任对方以及第三方即可实现实时的、海量的交易网络。闪电网 络和雷霆网络提供了一个可扩展的微支付通道网络。交易双方若在区块链上预先设有支 付通道，就可以多次、高频、双向地通过轧差方式实现瞬间确认的微支付；双方若无直 接的点对点支付通道，只要找到网络中一条连通双方的、由多个支付通道构成的支付路 径即可。闪电网络和雷霆网络的突出贡献是将链上交易放到链外，只把最后一笔清算交 易提交到区块链上，从而变相为区块链扩容。 Bancor[16] 协议引入了一种基于数学模型的方案去试图解决经济学中的“双重需求 巧合”问题。其理念和预测市场中的 Logarithmic Market Scoring Rules（LSMR）[17] 类似。 Bancor协议基于以区块链为基础的智能合约和储备代币，允许任何人通过这个 协议创建代币，新的代币以预先设置的比率来持有一种或几种其它代币作为自己的储备 金。这些储备代币可以是法币、数字化资产或其它加密代币。通过使用这些储备金，不 论有没有交易，新创建的代币都可以获得价格，并随时可以兑换回其对应的储备代币。 0x [18] 是一个可以在以太坊区块链上进行ERC20[19] 代币对等交易的开放式协议。 该协议旨在成为通用开放标准，作为可与其他协议组合的基本模块，用以驱动越来越 复杂的区块链应用程序。由于它使用的是以太坊的智能合约系统，因此可以作为各种 dApps 的共享基础架构。而从长远来看，开放式技术标准相比封闭模式具有更大的优 势，随着每个月有更多的资产在区块链上被代币化，也有更多的 dApps需要使用这些 不同的代币，开放式标准也因此变得更加重要。此外，由 dApps耦合到其底层协议所 导致的智能合约冗余也是未来区块链协议开发的主要障碍，因此在标准化之余，我们 还需要一个合适的解耦方式。 0x协议试图将信息交换功能从应用层拉到协议层，推动 dApps 之间的互操作性。然而，0x 协议的局限包括： taker 必须在线匹配订单，这导致 撮合实时性差，难以优化成交价格； 0x协议采用的是简单的 OTC 方式，无法法实现复 杂订单的撮合；不同交易所之间没有明确的竞争激励机制；也没有考虑了矿工的利益。 上述努力由于种种限制，到目前为止依然没有能够撼动中心化交易所的地位。我们 主要受到支付通道和 0x协议的启发，提出一种更可行的链上交易撮合标准。 3 协议设计 5 3 协议设计 图 1: Loopring 协议：图中示例一个三边交易的撮合我们用上图中的三边交易，简要讲解下采用 Loopring 协议的撮合交易过程。该过程如下： 1. 用户甲、乙、丙分别对 Loopring 撮合智能合约（ Loopring Matching Contract ）授权，授权后该合约可对用户指定代币账号做不超过一定额度的转出操作 1 。在上面实例中，合约可最多从用户甲的账号转出 1000 个 A 代币，从用户乙账户转出 9 个 B 代币，从用户丙账户转出 100 个 C 代币； 2. 用户甲、乙、丙分别生成自己的订单，并用私钥对其进行数字签名。订单不再区分买单和卖单，所有订单都被视为 交换单 — 甲的订单声明：甲愿意卖出不多于 1000 个 A 代币，买到尽可能多但不少于 10 个 B 代币；如果是部分成交，那么 A 到 B 的 兑换率 不得低于 1000/10 = 100.0 （卖出代币数量除以买入代币数量）。订单中还可以包含其它参数，我们在章节 3.7 中会对订单参数进行说明； 3. 甲、乙、丙分别将自己的订单通过适当的方式发送到一个或多个交易所； 4. 交易所收到上述三个订单，将它们分别放到三个对应的订单表（ orderbook ）中，并实时通过区块链数据更新计算每个订单的状态，同时不断努力寻找能够撮合的一组订单 — 我们后续称之为 交易环路 或者 撮合环路 。一旦确定三个订单的当前状态可以撮合成功，且收益满足预期，即决定实施这个撮合； 5. 交易所对撮合交易签名后发送到 Loopring 撮合智能合约地址； 1 通过 ERC20 机制实现。 3 协议设计 6 6. 撮合智能合约验证四方签名，之后验证三个订单（的最新状态）是否可以真正成 交。若无法成交，合约终止（交易所依然要消耗一定的油费）；否则智能合约分别 计算出甲、乙、丙三方各自需要支出的金额，以及交易所该收取的费用，并且实 时将甲、乙、丙账号中的资产进行互转，并完成对交易所的费用支付 —如下图 所示。在交易过程中，撮合智能合约还会调用 Loopring注册智能合约（Loopring Registration Contract）来计算交易所应该给予该笔交易的费用折扣；在交易完成 前，还会调用 Loopring统计智能合约（Loopring Stats Contract）对交易所以及 代币相关的统计数据做更新。 图 2: Loopring 协议：交易环路结算 7. 交易所监听新的区块和链下新的交易数据，并根据这些数据更新订单表，然后不断进行新的撮合。接下来我们介绍可以撮合成交的交易环路相关的概念，包括 交易链 ，交易链的可归约性，成交价，成交量，和交易所收益模型。 3.1 符号定义 在正式介绍协议之前，我们要介绍一些符号的定义。 C i ：编号为 i 的代币币种。 O i ! j ：一个卖出代币为 C i ，买入代币为 C j 的订单。 s i ! j ：表示上述订单的当前卖出代币 C i 的数量。 b i ! j ：表示上述订单的当前买入代币 C j 的数量。 r i ! j ：为订单 O i ! j 的兑换率，即 s i ! j / b i ! j 。为了特指订单的原始状态，我们为符号加上水平线，代表其在原始订单中的值，比如 s i ! j 和 b i ! j 分别代表原始订单中的卖出和买入代币数量。 3.2 订单兑换率恒定 除非订单完全成交，即 s i ! j = 0 ，否则 Loopring 协议保证订单状态更新后： s i ! j / b i ! j = s i ! j / b i ! j ，即订单中隐含的兑换率不会因为部分成交而变化，亦即 r i ! j = r i ! j 。 3 协议设计 7 在实际实施中，兑换率恒定是通过先计算部分成交后卖出代币的剩余量，再使用原 始订单中隐含的兑换率来计算买入代币数量得以保证的。 3.3 可规约性 考虑两个订单 O i ! j 和 O j ! k , 我们可以通过中间代币 C j 的连接，将其规约一个卖出代币为 Ci ，买入代币为 C k 的订单。我们用 O i ! j ! k 来表示这样一个订单，它和订单 O i ! k 在撮合的各种属性上是等价的，且： s i ! j ! k = min ( b i ! j ; s j ! k ) · r i ! j (1) b i ! j ! k = min ( b i ! j ; s j ! k )/ r j ! k (2) r i ! j ! k = r i ! j · r j ! k (3) 在这里我们顺便引入 订单链 这个概念。一个订单链是两个或者两个以上订单，除了最后一个订单，每个订单的买入代币类型恰巧是后一个订单的卖出代币类型，但最后一个订单的买入代币类型不同于第一个订单的卖出代币类型（否则就成了一个环路）。我们可以将上述规约计算用于一个订单链。通过规约，一个包含 n - 1 个订单（ n 个不同的代币） , 即长度为 n - 1 的订单链可被视为一个单一订单 O 0 ! ::: ! n ，且有： s 0 ! ::: ! n = 8&lt;: s 0 ! 1 如 n = 1 min ( b 0 ! ::: ! n - 1 ; s n - 1 ! n ) · r 0 ! ::: ! n - 1 如 n &gt; 1 b 0 ! ::: ! n = 8&lt;: b 0 ! 1 如 n = 1 min ( b 0 ! ::: ! n - 1 ; s n - 1 ! n )/ r n - 1 ! n 如 n &gt; 1 r 0 ! ::: ! n = n - 1 ∏ i =0 r i ! i +1 订单链的可规约性可以帮助我们在分析订单路径时简化模型，在后文的讨论中，我们将符号 O i ! j 的含义扩展到即包含简单的卖出代币为 C i ，买入代币为 C j 的单一订单，也包含可规约成这样一个类型订单的订单链，如果为了强调是个订单链，我们会用 O i ! ::: ! j 或 O i !! j 表示。 3.4 环路撮合 传统撮合系统是在两个币种间，即一个交易对的买卖两个方向间完成撮合；而 Loopring 协议将撮合的概念扩展到多币种，通过 交易环路 来完成多个币种之间交易的撮合。下面介绍一下交易环路的概念。 定义 3.1 ( 交易环路 ) 如果有 n 个币种 C 0 、 C 1 、 · · · 、 C n - 1 ，和 n 个订单： O 0 ! 1 ， · · · ， O i ! i ⊕ 1 ， · · · ， O n - 1 ! 0 ，其中， i ⊕ 1 ≡ i + 1 mod n 。那么这些订单可以组成跨 n 个币种的交易环路： 3 协议设计 8 O 0 ! 1 ! · · · ! O i ! i ⊕ 1 ! · · · ! O n - 1 ! 0 ，其中 n 为环路的长度。 当这些订单的价格 满足一定条件时 ，我们可以对整个交易环路进行撮合，这种交易环路称为 可交易环路 。下面我们对交易环路中的成交价格和成交量进行讨论。 3.4.1 成交条件和价格 我们由一个长度为 3 的交易环路为例，介绍环路可成交的条件。假定环路中的三个币种为 C 0 、 C 1 和 C 2 ，三笔订单分别为： O 0 ! 1 、 O 1 ! 2 和 O 2 ! 0 。很容易证明，如果 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 = 1 时，三个订单都可以用其自身的兑换率成交。当 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 &gt; 1 时，三个订单都可以用比自身兑换率更低的兑换率成交。我们称第一种情况为 原价撮合 ，称第二种情况为 折价撮合 。 Loopring 协议要求交易环路的折价平均分享给环路中的每个订单。假设每笔订单兑换率折价比例为 γ ，那么最终完成撮合时，三笔订单的成交价分别为： r 0 ! 1 · (1 - γ ) ， r 1 ! 2 · (1 - γ ) ， r 2 ! 0 · (1 - γ ) ，并且满足： r 0 ! 1 · (1 - γ ) · r 1 ! 2 · (1 - γ ) · r 2 ! 0 · (1 - γ ) = 1 (4) 根据上式我们可以推导出： γ = 1 - 1 p 3 r 0 ! 1 · r 1 ! 2 · r 2 ! 0 。在更一般的情形下，如果跨 n 个币种的环路中， 兑换率折扣 为： γ = 1 - 1 √ n ∏ ni =0 - 1 r i ，其中 r i 表示第 i 个订单的兑换率。显然，只有在兑换率折扣 γ ≥ 0 时，交易环路才可以真正成交；且第 i 个订单 O i 的实际兑换率 r ^ i = r i · (1 - γ ) ，且有 r ^ i ≤ r i 。 3.4.2 成交量 当一个交易环路撮合完成后，至少有一个订单是被完全成交的。这点很容易得到证明：我们可以先假设该结论不成立，即全部订单都没有完全成交。由于章节 3.2 中要求兑换率在订单新状态（尾单）中保持不变，意味着撮合后新的环路依然满足成交条件。这就意味着之前的撮合是没有进行完的。因此可以断言：一次完整的撮合应该会将至少一个订单完全吃掉。我们称这个（些）被完全吃掉的订单为交易环路的 最小订单 。找到任何一个最小订单，既可循环计算环路中所有订单的成交量。假设第 i 个订单是最小订单，那么每笔订单的卖出代币成交量 s ^ 和买入代币成交量 ^ b 可以以此如下计算得出： s ^ i = s i ， ^ b i = ^ s i /^ r i ，其中 s i 为订单的卖出代币余额 ; s ^ i ⊕ 1 = ^ b i ， ^ b i ⊕ 1 = ^ s i ⊕ 1 /^ r i ⊕ 1 ; s ^ i ⊕ 2 = ^ b i ⊕ 1 ， ^ b i ⊕ 2 = ^ s i ⊕ 2 /^ r i ⊕ 2 ; ::: 3 协议设计 9 实际实施过程中，可以先假定第一个订单为最小订单，往后循环计算成交量，直到 每个订单的成交量都不再变化为止。理论上最多循环两次即可计算出每单的实际成交 量。 3.4.3 撮合费用 交易所第一种收费形式是手续费。在订单中可以设置一个以 Loopring 的代币 LRC 为单位的费用 , m i ，代表完全成交情况下编号为 i 订单愿意支付给交易所的手续费总和。实际成交时候按订单卖出代币成交比例支付给交易所，即： f i = b i · m i / b i 为了鼓励交易所为用户找到兑换率折价比例最大的成交环路， Loopring 协议要求将兑换率折价带来的 成本节约 分润给交易所。对于一个订单 O i , 假设买入订单的成交额度为 b i （ b i ≤ b i ） , 我们定义成本节约为： ∆ i = b i · r i · γ Loopring 协议允许每个订单设定一个成本节约分享 分润比例 θ i ，并将交易环路上所有订单分润比例的最小值作为该环路的分润比例 Θ ，那么订单 O i 支付给交易所的费用为： f i = ∆ i · Θ = b i · r i · γ · Θ 因此交易所对于一个交易环路，通过成本节约分润获得的收入为： F = n - 1 ∑ i =0 b i · r i · γ · Θ 采用所有订单中最小的分润比例作为整个交易环路的分润比例，可以激励订单采用较大的分润比例。这样做会激励交易所对订单进行撮合，同时一旦订单成交，也不一定非要支付指定比例的分润。为了鼓励 Loopring 的代币 LRC 的使用，如果订单中没有指定代币费用 m i ，或 m i = 0 ，那么该笔订单的分润比例实际被认为是 100% ，而不管订单中相应参数的值是多少。如果一个交易环路中的所有订单都没有设置代币费用， Θ = 100 % ，环路中所有成本节约归交易所所有。在下一章节，我们会引入一个激励交易所竞争的代币抵押机制，智能合约根据每个交易所代币抵押数量的排名，为每个交易所计算一个 费用强制折扣 ， λ ，该折扣会进一步影响交易所的费用收取；同时，交易所也可以指定为某个交易环路做进一步的费用优惠折扣， η 。因此，交易所对于一个交易环路的整体费用为： F = (1 - λ ) · (1 - η ) · n - 1 ∑ i =0 ( b i · r i · γ · Θ + b i · m i / b i ) 两种不同的费用模型能够满足不同订单的诉求：对于没有 LRC 代币的账户，可以设置合适的分润比例；对于有 LRC 代币的账户，可以选择支付较多的代币费用，并将 3 协议设计 10 分润比例设为一个较小值。交易所有可能对每笔订单的代币费用值有个最小额度限制， Loopring 协议并不对此作出明确要求。交易所可以在自己网站上对相关标准做说明，并 引导用户设定合适的订单参数值。 3.4.4 交易所费用强制折扣 Loopring 协议要求交易所给交易费强制打一个折扣，折扣大小决定于交易所抵押 LRC 代币数量的排名，排名越靠后，折扣越高。假定排名为 n 的折扣为： λ n = 0 : 05 · ( ln ( n + e - 1) - 1) 。具体返利比例如下表所示： 抵押排名 n 费用强制折扣 λ 1 0% 2 1:57% 10 7:31% 20 10:39% 99 18:06% 100 18:11% 1000 29:55% 1001 30:00%∗ 表 1: 抵押 LRC 排名与费用强制折扣对于排名 1001 及以后的交易所，或未进行抵押的交易所，统一实施 30% 费用强制折扣。如下图所示，费用强制折扣的下降并非线性的，如 λ 2 - λ 1 ≫ λ 100 - λ 99 。 3 协议设计 11 图 3: LRC 代币抵押排名与费用强制折扣在实际部署时，折扣函数中的参数需要根据市场行情不断调整，比如交易量和实时性。当市场交易量过于旺盛时，会导致过多交易无法及时确认，这时需要降低整体折扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交易的撮合。 3.5 防作弊和防攻击 3.5.1 交易所无风险套利 Loopring 协议致力寻求在用户和交易所间利益的平衡点，打造公平健康的交易所生态。 Loopring 协议不反对交易所的套利行为，因为套利行为本质上也是在促成交易。但是我们禁止交易所利用自己在生态中角色的特殊性进行套利，具体来说，通过上传一种特殊的闭环无风险套取订单间的价差，本节我们将介绍如何防止交易所的这种行为。在介绍之前，我们首先来分析交易所如何做到无风险套利。假设有两个订单 O a ! b ， O b ! a ，形成一个交易环路，且 r a ! b · r b ! a &gt; 1 。交易所可以在这个环路上插入三个自己新生成的订单 O b ! c ， O c ! d ， O d ! b ，生成一个长度为 5 的新环路，并使 r a ! b · r b ! c · r c ! d · r d ! b · r b ! a = 1 。通过这种方式，交易所可以做到将所有可能的成本节约变成 0 ，一旦撮合被智能合约接受，即可实现无风险套利。这种套利的交易环路有个显著的特征：它们包含子环路。在上个例子中，两个子环路分别是： O a ! b ! O b ! a 和 O b ! c ! O c ! d ! O d ! b 。为了杜绝交易所的这种无风险套利， Loopring 协议要求： 合法的闭环必须保证其订单子集无法组成更小的可交易环路 。 3.5.2 交易所拒绝服务 Loopring 协议允许交易所选择性地为特定订单做撮合。交易所有权对订单的代币类型，订单数量，费用等做筛选，也有权对这些筛选条件做更改，且有权公开或隐藏这些筛选条件。交易发起者与交易所之间是相互选择的关系，彼此没有任何义务。 3.5.3 尘埃订单攻击 普通用户可以通过广播大量的尘埃订单（即数量非常小的订单）试图对交易所做攻击，不过由于撮合尘埃订单获利很低，所以这些订单一定会被交易所抛弃，进而对交易所和区块链没有任何影响。交易所也可能采用同样方式发起攻击，从而试图影响其它交易所对某些订单的撮合。不过这种努力也不会奏效，因为协议允许同一个订单在同一个块中参与到多个环路成交（这些环路可能是不同交易所提交到区块链上的），换句话说，订单并没有所谓的锁定状态。 3.5.4 余额不足订单攻击 交易发起者可能发起多笔订单，但订单卖出代币账户实际余额为零。这样的订单提交到交易所后，交易所很容易通过查询区块链地址的余额信息将该订单抛弃，不过这种 3 协议设计 12 攻击的确会浪费交易所的处理时间。好在交易所可以通过黑名单机制，迅速有效地将某 些地址屏蔽掉，拒绝再为这些地址提供撮合服务。 3.5.5 撮合窃取 一个懒惰交易所可以监听网络上未被确认的撮合交易，解析交易环路并生成一个带有自己签名的新撮合（环路相同，只有受益地址和数字签名不同），通过提供更高的交易费来窃取其它交易所的撮合结果。特别当窃取者是矿工时，这种作弊行为是比较难以预防的。为防止撮合窃取，我们规定交易所上传订单环路的过程分为两步： • 交易所在区块链上发一笔交易，上传订单环路的存证， • 存证信息被写入区块链后，交易所提交具体环路信息。这个存证通过哈希来实现，哈希值的生成方法为 h = H ( r; nonce ) ，其中， H () 为单向函数， r 为订单环路信息。哈希函数的输入包含了一个随机数 nonce ，用于防止对哈希值进行暴力破解。在提交具体环路信息时，随机数 nonce 需要一并提交。 3.6 市场深度 交易所并不一定需要提供市场深度数据。在整个生态中，可能会有单独的组织和机构汇集全网的未成交订单或者交易的尾单信息，汇总成独立的市场深度数据。市场深度数据可以根据章节 3.3 中的订单的规约方法，计算出任何两个 ERC20 代币之间的买单卖单数据。 3.7 数据格式 由于采用 OTC 模型，所有订单可以用同一个数据结构表示。该结构包含订单本身的各种参数数据和发起者的数字签名。在签名前，先将订单参数数据连接成一个字节数组，通过 Keccak SHA3 方法对这个字节数组做散列计算得到订单的哈希，之后用账户私钥对这个哈希进行 ECDSA 签名。 message Order {address protocol; // Loopring 协议入口智能合约地址 address owner; // 该订单发起者地址 address outToken; // 卖出 ERC20 代币智能合约地址 address inToken; // 买入 ERC20 代币智能合约地址 uint256 outAmount; // 卖出 ERC20 代币数量上限 uint256 inAmount; // 买入 ERC20 代币数量下限 unit256 expiration // 过期时间 unit256 fee; // 交易总费用（ LRC ），部分成交的费用按该次 3 协议设计 13 // 撮合实际卖出代币额与 outAmount 比例计算 uint8 marginSplit; // fee 不为 0 时支付给交易所的分润比例，否则视为 100%unit8 v;bytes32 r;bytes32 s;} 订单中虽然没有明确指定价格，但我们可以通过计算 outAmount / inAmount 来得到一个订单兑换率 r 。该兑换率隐含地要求所有实际撮合成交的兑换率不得大于 r 。一个好的交易所 UI 应该允许用户输入 outAmount ， inAmount ，和传统意义的买入价或卖出价这三个数据的任意两个来计算缺失的 outAmount 或 outAmount 值。订单实际上可以有两种不同的 完全成交 定义：一种定义是只有卖出代币达到了 outAmount 就算完全成交；另一种定义在之前的基础上允许买入代币累计金额达到 inAmount 也算完全成交。我们可以在订单中引入一个参数告诉交易所和撮合智能合约选择哪种完全成交定义。在第一版本的实现中，我们先支持第一种完全成交定义。交易所可以通过下面的数据结构构建一个交易环路： message MatchRing {Order[] orders; // 该次匹配的所有订单 address feeRecipient; // 费用收取地址 unit256 additionalDiscount; // 在费用基础上进行的再折扣价 - etaunit256 nonce; // 一个随机数 unit8 v;bytes32 r;bytes32 s;} 一个可交易环路上同一位置的订单只能有一个 — 理论上可以将这个限制去掉，不过这会让撮合智能合约更加复杂，我们可能在后续的版本中再给与支持。 3.8 订单状态 订单发起者对订单签字广播后无法对该订单进行修改。撮合智能合约一旦对某个订单进行撮合，就需要在区块链上对订单的状态更新记录。对部分或者完全成交的订单，会计算更新 inAmount 和 outAmount 两个值，并且保障订单新状态价格和原始订单的价格一致。如果 inAmount 或 outAmount 为 0 ，则表示该订单已经完全成交。如果用户取消订单，需要发起一个特殊的交易，将 inAmount 和 outAmount 更改为 0 即可。过期的订单不会触发区块链上的数据更新 — 可以根据最后一个块的时间戳来判断任何一个订单是否过期 — 因此我们期待多数的订单会因为过期或者完全成交而变成失效。交易所需要采用同样的甚至是更复杂的逻辑在区块链外追踪订单状态，尤其是当一家交易监听到到竞争对手在对同一个订单做不同的撮合的时候。一个可交易的订单还需要其账户中有足够多的卖出代币余额 balance ，虽然 balance 不要求达到订单中 outAmount 的数量。实际上交易所在对订单状态计算的时候，会取 4 LOOPRING 协议代币LRC 14 max(balance; outAmount)作为实际的可成交金额。这里可以看出，订单的卖出代币并 不需要锁定的过程。用户提交订单后依然可以任意支配卖出代币作为他用。交易所不仅 仅要监听订单被（其它交易所）撮合的结果，还需要监听订单账户的余额变动情况。看 起来这种对区块链数据的监听和对订单状态的更新有些复杂，但这些反而极大简化区块 链上合约的逻辑，这种思路和比特币闪电网络，以太坊的雷霆网络的思路是一致的。 3.9 智能合约 Loopring 协议协议可能包含多个智能合约，包括但不限于： • 撮合合约 负责计算并确认交易环路中每个订单的状态，计算成交金额和成交量，对交易进行清算转账。该合约还会与其它合约交互，是 Loopring 协议的入口合约； • 订单合约 负责更新订单状态以及对取消订单提供支持； • 交易所注册合约 负责维护和更新一系列支持 Loopring 协议的交易所，为交易所代币抵押和预设参数默认值提供支持； • 统计合约 计算任何两个币种之间的成交量，成交价，以及不同交易所的贡献度等指标，以及这些指标的某些滑动平均值。这些指标是订单发起者授权撮合的重要参考依据，同时也可以作为某些预测市场的输入，并且为以后可能的协议拓展（比如对条件单的支持）提供输入（ Oracle ）。这里，不排除将上述合约进一步拆解或合并的可能。同时值得指出： Loopring 协议中的智能合约是完全开放的，这意味着它们可以被任何的 dApp 直接或者间接调用。因此整个协议即使一个完善的整体，又是个开放的，单独可用的组件的集合。 4 Loopring 协议代币 LRC 我们将为 Loopring 协议发行符合 ERC20 规范的原生代币，其符号为 LRC （在本文中用斜体字母表示）。 4.1 代币的应用 LRC 在生态中发挥下列作用： • 作为撮合费用 — 订单中可以指定用 LRC 可作为支付给交易所的撮合费用。虽然协议支持通过卖出代币成本节约的分润作为支付手段，但对于交易所来说，将来需要支持的 ERC20 代币类型可能越来越多，如果每笔撮合交易都通过各订单中的卖出代币为单位支付手续费，那么对于一次撮合的收益计算将变得复杂；相反，如果通过 LRC 来衡量收益（或者用来计算成本），会简单得多。同样，对于订单发起者，可以通过公开信息获取某笔订单需要支付大约多少费用，如果用每个订单的卖出代币计算，那么下单过程中的费用计算也会比较分散。我们在之前章节 3.4.3 对费用模型做了详细的说明。 4 LOOPRING 协议代币LRC 15 • 作为交易所注册抵押—订单发起者希望自己的订单得到最好的撮合，这要求交易 所在各个方面都做到专业，特别是对全部订单的汇聚情况。由于去中心化交易没 有地域限制，一个好的交易所应该能比一个相对差的交易所看到更多的订单，也 应能在最短时间内找到最好的交易环路。为了鼓励实力强的交易所，淘汰实力差 的交易所，我们提供一种交易所注册抵押机制：交易所可以将一定数量的 LRC 代 币抵押给智能合约。交易所可以随时申请抵押代币的解冻，但申请提出后，一年 后才锁定的代币才可以转账出去。并不是所有交易所都必须进行注册抵押。交易 所代币抵押的另一个作用是防止交易所为了抛弃不利的历史统计数据而频繁变动 身份。 4.2 去中心化自治 随着交易所的不断升级，交易所中的规则需要不断升级升级，为此我们引入去中心化自治机制。任何持有 LRC 者都可以将代币抵押并获得自治系统的投票权益，投票权益 S 是一个关于抵押数量 N 和抵押时间 CoinAge 的函数， S = f ( N; CoinAge ) ，其中 CoinAge = H c - H s ，这里的 CoinAge 是当前区块高度 H c 减去开始抵押区块高度 H s 。加入 CoinAge 参数是为了防止有攻击者短时间内租借到大量代币并获得很高的权益，迫使某项并不为他人接受的提议得以通过。在去中心化自治系统中，任何决定都要在一个固定时间内完成投票，这个时间根据提议内容不同而发生改变。当且仅当收集到足够高权益的投票，提议才会执行，否则提议将会关闭。在去中心化自治系统中，并不是权益高者的一言堂，权益低者可以联合在一起制衡权益高者。去中心化自治内容包括但不限于交易所注册、币种注册、统计函数、抵押代币范围等，这些升级可以通过自治系统参与者共同投票参与决定。 • 币种注册 Loopring 协议会阶段性的调整支持的币种，有些数字货币会因为交易量过低而退出交易所，而另外会有一些新的数字货币诞生而加入交易所。这些币种需要记录在智能合约中，包括币种名称、代号及对应智能合约地址等信息。 • 交易所注册 交易所需要注册完成才能通过协议进行交易，当交易所达到一定数量后，新注册交易所需要经过自治系统投票才能通过。 • 统计函数 随着交易所上线运行时间越长，数据量得到一定积累，用于统计的指标和函数也会逐渐成熟。自治系统参与者可以决定新增或淘汰统计函数。 • 抵押代币范围 交易所可以抵押的代币数量需要限制在一定范围内。如果抵押数量太多，会导致代币流动性变差；如果抵押过少，则无法体现交易所间的差异性。 • 环路最大长度 理论上说，环路越长越有可能发现利差大的环路，然而过长的环路会降低环路撮合的成功率，并且在过长的环路会带来过高的计算成本。 4 LOOPRING 协议代币LRC 16 • 强制折扣函数强制折扣函数需要根据市场行情不断调整，比如交易量和实时性。当 市场交易量过于旺盛时，会导致交易过多而无法及时确认，这时需要降低整体折 扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交 易的撮合。如下图所示，其中蓝色为交易量正常时的折扣率，黄色为市场交易量 过高时的折扣率，红色为交易量过低时的折扣率。 图 4: 调整后的强制折扣率 • 子合约地址 如果基于公有链搭建 Loopring 交易所，智能合约本身是无法改动的。在这种情况下，如果升级 Loopring 协议的子合约，则需要重新部署智能合约，并修改子合约的地址。 4.3 代币的原生流动性 Loopring 协议代币本身遵循 ERC20 标准，并且在 Loopring 智能合约的基础上带有原生的流动性 — 这意味着你不必去传统的交易所购买和出售 LRC ，而是可以通过本文论述的方式，利用 Loopring 协议本身的去中心化撮合机制，使用任何 ERC20 代币购得 LRC （订单中的买入代币设定为 LRC ，并将 fee 设为 0 ）。这得益于协议灵活的收费模式。 5 交易所 17 5 交易所 采用 Loopring 开放协议后，交易所并不能保证每一个撮合都是盈利的。一方面可能是成本过高，因为交易所为了激励矿工优先打包自己的撮合交易到区块链，可能根据预期的收益调高手续费，而手续费代币和撮合中代币的相对价格有可能有超出预期的浮动，从而造成手续费实际成本更高。另一方面可能是因为收入没有达到预期，比如交易所把撮合广播到区块链后，该撮合的某个订单的卖出代币被部分或者全部转移到另一个地址，从而造成整个撮合交易未能被确认或实际成交量和手续费过低。类似这样的原因还有很多，因此交易所的每次撮合广播都是根据自己的经验和算法，最大化长期利益的概率游戏。不过也不用担心，实际上交易所和订单发起者是双向选择的关系：交易所只会选择有利可图的订单；而订单发起者只会选择费用最低的交易所 — 通过参考 Loopring 统计合约数据决策订单参数。交易所采用 Loopring 协议后，不需要再保存用户的 ERC20 代币资产。交易所的主要职能从负责 ERC20 的充值提现，内部虚拟账号管理，转移到更加纯粹的撮合服务。对于用户来讲， Loopring 协议不要求卖出或买入代币的充值，提现，锁定，因此根本没有资产丢失，被盗，或者资产流动性降低等的风险，同时一笔订单可以同时被多个交易所同时撮合。对于非 ERC20 资产，交易所可以提供代币发行服务（ Tokenization ），将资产通过抵押的方式，在区块链上发行相应的 ERC20 代币，并提供相应的充值、提现、和赎回功能。这种服务和传统交易所类似，但也省去了传统交易所研发和维护内部虚拟账号的必要。 5.1 传统与 Loopring 上交易所模式的对比 在传统交易所模型中，被撮合的两方中先下单的为 Maker ，后下单的为 Taker 。因为 Maker 创造流动性而 Taker 销毁流动性，所以在计算成交价时候会更偏向于 Maker 的价格，甚至直接采用 Maker 的价格作为成交价。与之相比， Loopring 采用的是 OverThe-Counter （ OTC ）模型。主要的原因是在去中心化环境中，很难严格界定哪个单是真正意义上较早的单。因此 Loopring 的撮合设计不考虑时间因素，只考虑兑换率（在本文中我们偶尔也用价格一词与兑换率交替使用）。传统交易所对投资者安全的保障只能依靠自身信用，如果出现兑付问题，跑路的成本非常低，因此需要通过监管保护投资者。然而在 Loopring 协议中，通过在区块链上开源智能合约可以实现交易的原子性，成交前卖出的代币和成交后买入的代币均存放在用户本人区块链地址中。整个交易过程过程用户无需向交易所转账，交易所不托管用户下单资金，资产丢失或者被盗风险为零，哪怕交易所倒闭，也不会对用户产生任何影响。传统交易所中，用户下单后用于交易的资金会被冻结，同一订单只能提交给一家交易所，各家交易只能看到部分交易信息。但在 Loopring 协议中，用户下单后依然可以动用账户资金，用户将资金部分或全部转移的行为等同于部分或全部撤单。订单可被广播给多家交易所，由不同交易所共同完成撮合，每家交易所可以看到全部订单，因此市场深度和订单表更全面，成交更快更有效。 Loopring 协议的另一个显著特点是消除了传统交易所中 交易对（ Trading Pair ） 6 总结 18 的概念。一个从 A到 B 的订单不一定要一个反向的从B 到 A订单才能撮合，只要有 一个交易环路被发现，就可以撮合。也可以说传统交易所的交易对是多边交易环路的一 个最简特例。为激励撮合价格最优的交易环路， Loopring协议的收费模式以成交的“成 本节约分润”为主，交易手续费为辅。 传统交易所 Loopring 交易所 托管下单资金 是 否1 下单资金冻结 是 否2 需充值提现 是 否3 有内部交易风险 是 否4 倒闭会造成用户损失 是 否5 收入主要来源为手续费 是 否6 支持法币 是 是7 同一个订单可以提交给多个交易所 否 是8 Maker 和 Taker 是否平等 否 是9 支持环路交易 否 是10 监管必要性 强 弱11 表 2: 两种模式交易所简要对比 6 总结 本文描述了一个开放的，支持智能合约和 ERC20 的代币间多边交易协议。该协议允许多个订单构成一个可交易环路进行撮合，并允许交易所只将撮合的最终结果作为交易提交到区块链上进行清算；本文描述了协议代币在撮合收费中起到的作用；以及 Loopring 协议相对于传统交易所模式为用户带来的好处。 1 Loopring 交易所无需托管下单资金 — 交易用代币存放到自己区块链地址中，成交前无需要转账。资产丢失或者被盗风险为零。 2 Loopring 交易所无需冻结下单资金 — 用户下单后依然可以任意动用账户任何资金，将资金部分或全部转移走等同于部分或全部撤单。 3 Loopring 订单实际是交易指令，交易过程中用户资产一直保存在用户自己的区块链地址中，无需充值提现过程。 4 Loopring 交易所撮合全部基于区块链智能合约，数据不可更改，完全开放透明。 5 Loopring 交易所如果不提供代币发行职责，交易所倒闭对用户没有任何影响 — 好比矿工倒闭对区块链账户也没有影响一样。交易所只负责撮合，清算转账通过智能合约完成。所有资产一直在区块链用户自己的账户里。 6 Loopring 交易所的交易手续费为辅助收入，主要收入为成交的“成本节约分润”，这样会激励撮合价格最优订单。 7 Loopring 交易所对法币的支持是通过资产代币化，需要将法币在区块链上做 ERC20 代币发行。 8 Loopring 允许用户的同一个订单被多家 Loopring 交易所同时撮合，并可以被多家交易所不同程度部分或全部成交。 9 Loopring 协议要求成交接近中间价，而不是过度倾向于 Maker 的价格。 10 Loopring 交易所支持环路发现，能最大程度找到最好的匹配订单。 11 Loopring 交易所不保存 阅读更多","@type":"BlogPosting","url":"/2018/02/06/e5ea4ecb7dbaa5e80ef07fef5b9ca123.html","headline":"新一代区块链去中心化交易所和相关协议–路印协议介绍","dateModified":"2018-02-06T00:00:00+08:00","datePublished":"2018-02-06T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/02/06/e5ea4ecb7dbaa5e80ef07fef5b9ca123.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>新一代区块链去中心化交易所和相关协议--路印协议介绍</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div class="boxTit" style="list-style:none;font-family:'Microsoft YaHei', sans-serif;border-bottom:1px solid rgb(234,236,239);color:rgb(51,51,51);font-size:14px;">
   <h2 style="list-style:none;font-size:17px;font-weight:500;color:rgb(0,0,0);">Loopring介绍</h2>
   <a href="https://www.feixiaohao.com/currencies/loopring/" rel="nofollow" class="more2" style="list-style:none;color:rgb(102,102,102);">查看行情</a>
  </div>
  <div class="boxContain" style="list-style:none;font-family:'Microsoft YaHei', sans-serif;color:rgb(51,51,51);font-size:14px;">
   <div class="artBox" style="list-style:none;min-height:610px;">
    <p style="list-style:none;line-height:25px;"></p>
    <p style="list-style:none;line-height:25px;">路印协议新一代区块链资产交易协议和交易所。它采用去中心化技术，提供零风险的代币交易所模式，并允许多家交易所通过竞争，对同样的订单进行链外撮合及链上清结算。</p>
    <p style="list-style:none;line-height:25px;">路印协议将彻底解决现有中心化交易所模式的一些固有风险。</p>
    <p style="list-style:none;line-height:25px;">主要特性有：</p>
    <h3 style="list-style:none;font-size:18px;"><span style="list-style:none;">1,绝对安全</span></h3>
    <p style="list-style:none;line-height:25px;">路印协议订单中的卖出代币不必充值到交易所做资金托管，在下单、撮合、清结算过程中一直保存在用户自己区块链的地址中。订单不锁定用户区块链上的代币，下单后用户依然可以任意使用自己的数字代币，余额不足时路印协议自动调整订单的数额且保持价格恒定。使用路印协议，交易所倒闭跑路都不会对用户有任何影响。</p>
    <h3 style="list-style:none;font-size:18px;"><span style="list-style:none;">2,环路撮合</span></h3>
    <p style="list-style:none;line-height:25px;">路印协议一次撮合可将十几个包含不同类型代币的订单做环路撮合。</p>
    <h3 style="list-style:none;font-size:18px;"><span style="list-style:none;">3,去中心化</span></h3>
    <p style="list-style:none;line-height:25px;">订单在区块链外生成，传播、撮合；链上清算转账。理论上100%安全，用户资金不会丢失或被盗。</p>
    <h3 style="list-style:none;font-size:18px;"><span style="list-style:none;">4,订单共享</span></h3>
    <p style="list-style:none;line-height:25px;">路印协议中一个订单可以被广播给多个交易所，被这些交易所并行撮合。一个订单可被一个交易所撮合成功一部分，被另一个交易所撮合成功另一部分。交易所之间存在竞争关系，因此订单会被更快、更好（价格最优）地撮合。使用路印协议下单，交易不会因交易所被DDOS攻击而无法得到及时撮合。</p>
    <h3 style="list-style:none;font-size:18px;"><span style="list-style:none;">5,跨链协议</span></h3>
    <p style="list-style:none;line-height:25px;">路印协议是个去中心化安全交易的协议层，可在多个智能合约公有链上实现，而不依赖于某个特定平台。我们会在以太坊上率先实现第一个版本，接下来会在EOS，ETC，量子链上部署协议，为这些平台提供代币流动性支持</p>
    <p style="list-style:none;line-height:25px;"><span class="fontstyle0">1 </span><span class="fontstyle2">背景<br></span><span class="fontstyle3">区块链 </span><span class="fontstyle4">[1][2] </span><span class="fontstyle3">作为比特币 </span><span class="fontstyle4">[3] </span><span class="fontstyle3">的底层技术，本质上是去中心化无信任环境中的存在<br>性共识机制 </span><span class="fontstyle4">[4][5]</span><span class="fontstyle3">。存在性可应用于各种不同的数据，如股权，版权，使用权等。尽管联<br>盟链和企业私有链中共识数据的类别正在变得越来越多样化，但这些数据的价值却有着<br>明确的边界限制 </span><span class="fontstyle4">— </span><span class="fontstyle3">只限于联盟成员间和企业内部。我们认为区块链的价值网络属性目<br>前只有在公有链中才能得到更好的体现。根据 </span><span class="fontstyle4">coinmarketcap.com </span><span class="fontstyle3">的统计，截止本文成<br>稿时间，区块链上代币总市值已经接近 </span><span class="fontstyle4">790 </span><span class="fontstyle3">亿美元，以太坊区块链</span><span class="fontstyle4">[6]</span><span class="fontstyle3">（</span><span class="fontstyle4">ETH</span><span class="fontstyle3">）上承载<br>的代币市值也已超过 </span><span class="fontstyle4">170 </span><span class="fontstyle3">亿美元。<br>区块链对各行业都可能有着深远的影响，尤其是金融领域。我们相信基于区块链的<br>新金融会有一个明显趋势，即资产代币化（</span><span class="fontstyle4">Tokenization</span><span class="fontstyle3">）</span><span class="fontstyle4">[7][5]</span><span class="fontstyle3">：一方面链下资产的使<br>用权，所有权，分红权等相关权益通过抵押，会以代币（</span><span class="fontstyle4">Token</span><span class="fontstyle3">）</span><span class="fontstyle4">[2] </span><span class="fontstyle3">的形式发行到区块<br>链上，另一方面区块链上资产也会进行跨链发行。资产代币化的目标之一就是低成本，<br>全球化，全天候的高流动性。而流动性则主要通过交易所得以实现，因此一个更适合区<br>块链上代币的交易标准对于区块链金融至关重要。<br>现阶段交易所都采用类似的模式：交易所要求用户将法币或者代币充值到交易所的<br>银行账户或区块链地址中，然后交易所在自己的私有虚拟账户系统中为用户进行 </span><span class="fontstyle4">IOU<br></span><span class="fontstyle3">记账。用户实际交易的是这些 </span><span class="fontstyle4">IOU</span><span class="fontstyle3">。为了将</span><span class="fontstyle4">IOU </span><span class="fontstyle3">兑换成法币或区块链代币，用户需要<br>向交易所提出提现申请，提现成功后，才算真正交易完成。在这个过程中，交易所替用<br>户保管资产的能力是用户最大的风险；同时用户还需承担交易所运营者商业道德带来<br>的其它风险，比如挪用资金造成资不抵债等。 </span><span class="fontstyle4">2014 </span><span class="fontstyle3">年</span><span class="fontstyle4">2 </span><span class="fontstyle3">月当时世界最大的比特币交易<br>所 </span><span class="fontstyle4">Mt.Gox </span><span class="fontstyle3">的 </span><span class="fontstyle4">85 </span><span class="fontstyle3">万个比特币被盗一空 </span><span class="fontstyle4">[8]</span><span class="fontstyle3">，公司向日本东京地方法院申请破产保护。该<br>公司的用户至今仍在等待其返还尚未被盗的少量比特币。随着调查的不断进行 </span><span class="fontstyle4">Mt.Gox<br></span><span class="fontstyle3">被曝出所谓的比特币被盗其实是监守自盗。 </span><span class="fontstyle4">85</span><span class="fontstyle3">万个“被偷窃”的比特币中，实际上因<br>外部盗窃失踪的仅为 </span><span class="fontstyle4">7000 </span><span class="fontstyle3">个。</span><span class="fontstyle4">2016 </span><span class="fontstyle3">年 </span><span class="fontstyle4">8</span><span class="fontstyle3">月最大的美元比特币交易平台香港的 </span><span class="fontstyle4">Bitfnex<br></span><span class="fontstyle3">由于网站出现安全漏洞，导致用户持有的比特币被盗，被盗的比特币共 </span><span class="fontstyle4">119756</span><span class="fontstyle3">枚，总<br>价值约为 </span><span class="fontstyle4">6500 </span><span class="fontstyle3">万美元。随后该公司决定由所有用户共同分担损失以避免破产。这些发<br>生过的事件一方面反映出区块链代币交易在各个国家监管政策的缺失，另一方面也证实<br>了中心化交易所模式的固有风险。<br>本文描述的基于区块链的去中心化交易机制就是为了彻底解决上述问题。去中心化<br>交易的核心优势之一是避免任何资产被托管，因此资产就不存在被盗的可能，这会极大<br>降低用户对交易所的信任成本。这种交易机制的另一个优势是没有地缘和时间限制，以<br>及极高的透明性和可追溯性。这些特点会促使交易整体具有更大的流动性和更小的价<br>差。<br></span><span class="fontstyle0">2 </span><span class="fontstyle2">相关工作<br></span><span class="fontstyle3">开源社区已经有过一些基于区块链搭建去中心化交易所的尝试，如瑞波（</span><span class="fontstyle4">Ripple</span><span class="fontstyle3">）、<br>比特股（</span><span class="fontstyle4">BitShares</span><span class="fontstyle3">）、 </span><span class="fontstyle4">Openledger </span><span class="fontstyle3">等。<br></span><span class="fontstyle4">Ripple [9] </span><span class="fontstyle3">是一个去中心化的银行系统间清算协议，是为了解决银行间清算的高费<br>用和高延迟问题而设计，具有快速、方便、超低费用的优点。 </span><span class="fontstyle4">Ripple </span><span class="fontstyle3">提出了一项</span><span class="fontstyle4">In-</span><br></p>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">2 </span><span class="fontstyle6">相关工作 </span></td>
       <td><span class="fontstyle4">4</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">terledger [10] </span><span class="fontstyle3">协议（</span><span class="fontstyle4">ILP</span><span class="fontstyle3">）实现跨账本的资产交易。</span><span class="fontstyle4">ILP </span><span class="fontstyle3">本身并不是一个账本，相反，它</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">提供了一个顶层加密托管系统，在称之为“连接者”的中介机构的帮助下，可以让资金</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">在各账本之间进行流动。 </span><span class="fontstyle4">Ripple</span><span class="fontstyle3">交易依赖于网关间信任的建立，而网关提供代币发行功</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">能。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">比特股（</span><span class="fontstyle4">BitShares</span><span class="fontstyle3">）</span><span class="fontstyle4">[11][12] </span><span class="fontstyle3">是一个区块链开发平台，任何个人和机构都可以在此</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">平台上自由地进行转账、借贷、发行资产等，也可以基于这个平台快速搭建出去中心化</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">的金融服务平台等。 </span><span class="fontstyle4">BitShares</span><span class="fontstyle3">内置的去中心化交易所（</span><span class="fontstyle4">DEX</span><span class="fontstyle3">），让数字资产的交易撮合</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">和交割完全发生在链上，并通过内置智能合约锚定其他资产，如法币、比特币、黄金、</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">白银等。可惜 </span><span class="fontstyle4">BitShares</span><span class="fontstyle3">项目由于开发者自身的问题，已经慢慢被边缘化。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">Openledger[13] </span><span class="fontstyle3">是一个新型去中心化交易平台。它允许用户将比特币兑换成法币锚</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">定的 </span><span class="fontstyle4">SmartCoins</span><span class="fontstyle3">，</span><span class="fontstyle4">SmartCoins </span><span class="fontstyle3">可以直接通过</span><span class="fontstyle4">paypal</span><span class="fontstyle3">、瑞波网关兑换成现金。需要注意</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">的是， </span><span class="fontstyle4">Openledger</span><span class="fontstyle3">在很大程度上依赖于 </span><span class="fontstyle4">BitShares 2.0</span><span class="fontstyle3">平台以及 </span><span class="fontstyle4">Graphene Toolkit</span><span class="fontstyle3">。因</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">此， </span><span class="fontstyle4">Openledger</span><span class="fontstyle3">平台的性能取决于 </span><span class="fontstyle4">Graphene Toolkit</span><span class="fontstyle3">的性能和 </span><span class="fontstyle4">BitShares 2.0</span><span class="fontstyle3">平台的性</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">能。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">比特币的闪电网络 </span><span class="fontstyle4">[14]</span><span class="fontstyle3">和以太坊上的雷霆网络 </span><span class="fontstyle4">[15] </span><span class="fontstyle3">是两个去中心化的系统。它们</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">的卓越之处在于，无需信任对方以及第三方即可实现实时的、海量的交易网络。闪电网</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">络和雷霆网络提供了一个可扩展的微支付通道网络。交易双方若在区块链上预先设有支</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">付通道，就可以多次、高频、双向地通过轧差方式实现瞬间确认的微支付；双方若无直</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">接的点对点支付通道，只要找到网络中一条连通双方的、由多个支付通道构成的支付路</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">径即可。闪电网络和雷霆网络的突出贡献是将链上交易放到链外，只把最后一笔清算交</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">易提交到区块链上，从而变相为区块链扩容。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">Bancor[16] </span><span class="fontstyle3">协议引入了一种基于数学模型的方案去试图解决经济学中的“双重需求</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">巧合”问题。其理念和预测市场中的 </span><span class="fontstyle4">Logarithmic Market Scoring Rules</span><span class="fontstyle3">（</span><span class="fontstyle4">LSMR</span><span class="fontstyle3">）</span><span class="fontstyle4">[17]</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">类似。 </span><span class="fontstyle4">Bancor</span><span class="fontstyle3">协议基于以区块链为基础的智能合约和储备代币，允许任何人通过这个</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">协议创建代币，新的代币以预先设置的比率来持有一种或几种其它代币作为自己的储备</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">金。这些储备代币可以是法币、数字化资产或其它加密代币。通过使用这些储备金，不</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">论有没有交易，新创建的代币都可以获得价格，并随时可以兑换回其对应的储备代币。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">0x [18] </span><span class="fontstyle3">是一个可以在以太坊区块链上进行</span><span class="fontstyle4">ERC20[19] </span><span class="fontstyle3">代币对等交易的开放式协议。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">该协议旨在成为通用开放标准，作为可与其他协议组合的基本模块，用以驱动越来越</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">复杂的区块链应用程序。由于它使用的是以太坊的智能合约系统，因此可以作为各种</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">dApps </span><span class="fontstyle3">的共享基础架构。而从长远来看，开放式技术标准相比封闭模式具有更大的优</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">势，随着每个月有更多的资产在区块链上被代币化，也有更多的 </span><span class="fontstyle4">dApps</span><span class="fontstyle3">需要使用这些</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">不同的代币，开放式标准也因此变得更加重要。此外，由 </span><span class="fontstyle4">dApps</span><span class="fontstyle3">耦合到其底层协议所</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">导致的智能合约冗余也是未来区块链协议开发的主要障碍，因此在标准化之余，我们</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">还需要一个合适的解耦方式。 </span><span class="fontstyle4">0x</span><span class="fontstyle3">协议试图将信息交换功能从应用层拉到协议层，推动</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">dApps </span><span class="fontstyle3">之间的互操作性。然而，</span><span class="fontstyle4">0x </span><span class="fontstyle3">协议的局限包括： </span><span class="fontstyle4">taker </span><span class="fontstyle3">必须在线匹配订单，这导致</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">撮合实时性差，难以优化成交价格； </span><span class="fontstyle4">0x</span><span class="fontstyle3">协议采用的是简单的 </span><span class="fontstyle4">OTC </span><span class="fontstyle3">方式，无法法实现复</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">杂订单的撮合；不同交易所之间没有明确的竞争激励机制；也没有考虑了矿工的利益。</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">上述努力由于种种限制，到目前为止依然没有能够撼动中心化交易所的地位。我们</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">主要受到支付通道和 </span><span class="fontstyle4">0x</span><span class="fontstyle3">协议的启发，提出一种更可行的链上交易撮合标准。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <br>
    <span class="fontstyle5">3 </span>
    <span class="fontstyle6">协议设计 </span>
    <span class="fontstyle4">5<br></span>
    <span class="fontstyle0">3 </span>
    <span class="fontstyle2">协议设计<br></span>
    <span class="fontstyle3">图 </span>
    <span class="fontstyle4">1: Loopring </span>
    <span class="fontstyle3">协议：图中示例一个三边交易的撮合<br>我们用上图中的三边交易，简要讲解下采用 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议的撮合交易过程。该过<br>程如下：<br></span>
    <span class="fontstyle4">1. </span>
    <span class="fontstyle3">用户甲、乙、丙分别对 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">撮合智能合约（</span>
    <span class="fontstyle4">Loopring Matching Contract</span>
    <span class="fontstyle3">）授<br>权，授权后该合约可对用户指定代币账号做不超过一定额度的转出操作</span>
    <span class="fontstyle7">1</span>
    <span class="fontstyle3">。在上面<br>实例中，合约可最多从用户甲的账号转出 </span>
    <span class="fontstyle4">1000 </span>
    <span class="fontstyle3">个</span>
    <span class="fontstyle8">A </span>
    <span class="fontstyle3">代币，从用户乙账户转出 </span>
    <span class="fontstyle4">9<br></span>
    <span class="fontstyle3">个 </span>
    <span class="fontstyle8">B </span>
    <span class="fontstyle3">代币，从用户丙账户转出</span>
    <span class="fontstyle4">100 </span>
    <span class="fontstyle3">个 </span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle3">代币；<br></span>
    <span class="fontstyle4">2. </span>
    <span class="fontstyle3">用户甲、乙、丙分别生成自己的订单，并用私钥对其进行数字签名。订单不再区<br>分买单和卖单，所有订单都被视为</span>
    <span class="fontstyle9">交换单 </span>
    <span class="fontstyle4">—</span>
    <span class="fontstyle3">甲的订单声明：甲愿意卖出不多于<br></span>
    <span class="fontstyle4">1000 </span>
    <span class="fontstyle3">个 </span>
    <span class="fontstyle8">A</span>
    <span class="fontstyle3">代币，买到尽可能多但不少于 </span>
    <span class="fontstyle4">10 </span>
    <span class="fontstyle3">个 </span>
    <span class="fontstyle8">B </span>
    <span class="fontstyle3">代币；如果是部分成交，那么</span>
    <span class="fontstyle8">A<br></span>
    <span class="fontstyle3">到 </span>
    <span class="fontstyle8">B </span>
    <span class="fontstyle3">的</span>
    <span class="fontstyle9">兑换率</span>
    <span class="fontstyle3">不得低于</span>
    <span class="fontstyle4">1000/10 = 100.0</span>
    <span class="fontstyle3">（卖出代币数量除以买入代币数量）。订<br>单中还可以包含其它参数，我们在章节 </span>
    <span class="fontstyle4">3.7</span>
    <span class="fontstyle3">中会对订单参数进行说明；<br></span>
    <span class="fontstyle4">3. </span>
    <span class="fontstyle3">甲、乙、丙分别将自己的订单通过适当的方式发送到一个或多个交易所；<br></span>
    <span class="fontstyle4">4. </span>
    <span class="fontstyle3">交易所收到上述三个订单，将它们分别放到三个对应的订单表（</span>
    <span class="fontstyle4">orderbook</span>
    <span class="fontstyle3">）中，并<br>实时通过区块链数据更新计算每个订单的状态，同时不断努力寻找能够撮合的一<br>组订单 </span>
    <span class="fontstyle4">— </span>
    <span class="fontstyle3">我们后续称之为</span>
    <span class="fontstyle9">交易环路</span>
    <span class="fontstyle3">或者</span>
    <span class="fontstyle9">撮合环路</span>
    <span class="fontstyle3">。一旦确定三个订单的当前状态<br>可以撮合成功，且收益满足预期，即决定实施这个撮合；<br></span>
    <span class="fontstyle4">5. </span>
    <span class="fontstyle3">交易所对撮合交易签名后发送到</span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">撮合智能合约地址；<br></span>
    <span class="fontstyle10">1</span>
    <span class="fontstyle3" style="font-size:8pt;">通过</span>
    <span class="fontstyle11">ERC20 </span>
    <span class="fontstyle3" style="font-size:8pt;">机制实现。</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">3 </span><span class="fontstyle6">协议设计 </span></td>
       <td><span class="fontstyle4">6</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">6. </span><span class="fontstyle3">撮合智能合约验证四方签名，之后验证三个订单（的最新状态）是否可以真正成</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">交。若无法成交，合约终止（交易所依然要消耗一定的油费）；否则智能合约分别</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">计算出甲、乙、丙三方各自需要支出的金额，以及交易所该收取的费用，并且实</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">时将甲、乙、丙账号中的资产进行互转，并完成对交易所的费用支付 </span><span class="fontstyle4">—</span><span class="fontstyle3">如下图</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">所示。在交易过程中，撮合智能合约还会调用 </span><span class="fontstyle4">Loopring</span><span class="fontstyle3">注册智能合约（</span><span class="fontstyle4">Loopring</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">Registration Contract</span><span class="fontstyle3">）来计算交易所应该给予该笔交易的费用折扣；在交易完成</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">前，还会调用 </span><span class="fontstyle4">Loopring</span><span class="fontstyle3">统计智能合约（</span><span class="fontstyle4">Loopring Stats Contract</span><span class="fontstyle3">）对交易所以及</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">代币相关的统计数据做更新。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle3">图 </span>
    <span class="fontstyle4">2: Loopring </span>
    <span class="fontstyle3">协议：交易环路结算<br></span>
    <span class="fontstyle4">7. </span>
    <span class="fontstyle3">交易所监听新的区块和链下新的交易数据，并根据这些数据更新订单表，然后不<br>断进行新的撮合。<br>接下来我们介绍可以撮合成交的交易环路相关的概念，包括</span>
    <span class="fontstyle9">交易链</span>
    <span class="fontstyle3">，交易链的可归<br>约性，成交价，成交量，和交易所收益模型。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.1 </span>
    <span class="fontstyle2" style="font-size:12pt;">符号定义<br></span>
    <span class="fontstyle3">在正式介绍协议之前，我们要介绍一些符号的定义。<br></span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle3">：编号为</span>
    <span class="fontstyle8">i </span>
    <span class="fontstyle3">的代币币种。<br></span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">：一个卖出代币为</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，买入代币为</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">j </span>
    <span class="fontstyle3">的订单。<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">：表示上述订单的当前卖出代币</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle3">的数量。<br></span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">：表示上述订单的当前买入代币</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">j </span>
    <span class="fontstyle3">的数量。<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">：为订单</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">的兑换率，即 </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle14">/</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">。<br>为了特指订单的原始状态，我们为符号加上水平线，代表其在原始订单中的值，比<br>如 </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">和 </span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">分别代表原始订单中的卖出和买入代币数量。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.2 </span>
    <span class="fontstyle2" style="font-size:12pt;">订单兑换率恒定<br></span>
    <span class="fontstyle3">除非订单完全成交，即 </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle14">= 0</span>
    <span class="fontstyle3">，否则 </span>
    <span class="fontstyle4">Loopring</span>
    <span class="fontstyle3">协议保证订单状态更新后：</span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle14">/</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j<br></span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle14">/</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">，即订单中隐含的兑换率不会因为部分成交而变化，亦即</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">。</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">3 </span><span class="fontstyle6">协议设计 </span></td>
       <td><span class="fontstyle4">7</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">在实际实施中，兑换率恒定是通过先计算部分成交后卖出代币的剩余量，再使用原</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">始订单中隐含的兑换率来计算买入代币数量得以保证的。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle0" style="font-size:12pt;">3.3 </span>
    <span class="fontstyle2" style="font-size:12pt;">可规约性<br></span>
    <span class="fontstyle3">考虑两个订单 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">和 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle4">,</span>
    <span class="fontstyle3">我们可以通过中间代币 </span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">的连接，将其规约一个卖<br>出代币为 </span>
    <span class="fontstyle8">Ci</span>
    <span class="fontstyle3">，买入代币为 </span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">k </span>
    <span class="fontstyle3">的订单。我们用</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle3">来表示这样一个订单，它和订<br>单 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle3">在撮合的各种属性上是等价的，且：<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">min</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle8">; s</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle4">(1)<br></span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">min</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle8">; s</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle14">)/</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle4">(2)<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">k</span>
    <span class="fontstyle4">(3)<br></span>
    <span class="fontstyle3">在这里我们顺便引入</span>
    <span class="fontstyle9">订单链</span>
    <span class="fontstyle3">这个概念。一个订单链是两个或者两个以上订单，除了<br>最后一个订单，每个订单的买入代币类型恰巧是后一个订单的卖出代币类型，但最后一<br>个订单的买入代币类型不同于第一个订单的卖出代币类型（否则就成了一个环路）。我<br>们可以将上述规约计算用于一个订单链。通过规约，一个包含 </span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle14">1 </span>
    <span class="fontstyle3">个订单（</span>
    <span class="fontstyle8">n</span>
    <span class="fontstyle3">个不同<br>的代币） </span>
    <span class="fontstyle4">, </span>
    <span class="fontstyle3">即长度为 </span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle15">- </span>
    <span class="fontstyle14">1</span>
    <span class="fontstyle3">的订单链可被视为一个单一订单 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle3">，且有：<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle14">=<br></span>
    <span class="fontstyle17">8&lt;:<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle3">如</span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle4">= 1<br></span>
    <span class="fontstyle8">min</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle8">; s</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle3">如</span>
    <span class="fontstyle8">n &gt; </span>
    <span class="fontstyle4">1<br></span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle14">=<br></span>
    <span class="fontstyle17">8&lt;:<br></span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle3">如</span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle4">= 1<br></span>
    <span class="fontstyle8">min</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle8">; s</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle14">)/</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle3">如</span>
    <span class="fontstyle8">n &gt; </span>
    <span class="fontstyle4">1<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle14">=<br></span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1<br></span>
    <span class="fontstyle17">∏ </span>
    <span class="fontstyle12">i<br></span>
    <span class="fontstyle16">=0<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle16">+1<br></span>
    <span class="fontstyle3">订单链的可规约性可以帮助我们在分析订单路径时简化模型，在后文的讨论中，我<br>们将符号 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">的含义扩展到即包含简单的卖出代币为 </span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，买入代币为</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">j </span>
    <span class="fontstyle3">的单一订<br>单，也包含可规约成这样一个类型订单的订单链，如果为了强调是个订单链，我们会用<br></span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">:::</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">或 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!!</span>
    <span class="fontstyle12">j</span>
    <span class="fontstyle3">表示。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.4 </span>
    <span class="fontstyle2" style="font-size:12pt;">环路撮合<br></span>
    <span class="fontstyle3">传统撮合系统是在两个币种间，即一个交易对的买卖两个方向间完成撮合；而<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议将撮合的概念扩展到多币种，通过</span>
    <span class="fontstyle9">交易环路</span>
    <span class="fontstyle3">来完成多个币种之间交易<br>的撮合。下面介绍一下交易环路的概念。<br></span>
    <span class="fontstyle2" style="font-size:11pt;">定义 </span>
    <span class="fontstyle18">3.1 (</span>
    <span class="fontstyle2" style="font-size:11pt;">交易环路</span>
    <span class="fontstyle18">)</span>
    <span class="fontstyle6">如果有 </span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle6">个币种</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle6">、</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle6">、</span>
    <span class="fontstyle15">· · · </span>
    <span class="fontstyle6">、 </span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle6">，和</span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle6">个订单： </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle6">，</span>
    <span class="fontstyle15">· · · </span>
    <span class="fontstyle6">，<br></span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle6">，</span>
    <span class="fontstyle15">· · · </span>
    <span class="fontstyle6">， </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle6">，其中，</span>
    <span class="fontstyle8">i </span>
    <span class="fontstyle15">⊕ </span>
    <span class="fontstyle14">1</span>
    <span class="fontstyle15">≡ </span>
    <span class="fontstyle8">i </span>
    <span class="fontstyle14">+ 1</span>
    <span class="fontstyle4">mod </span>
    <span class="fontstyle8">n</span>
    <span class="fontstyle6">。那么这些订单可以组成跨</span>
    <span class="fontstyle19">n </span>
    <span class="fontstyle6">个币<br>种的交易环路：</span>
    <br>
    <span class="fontstyle5">3 </span>
    <span class="fontstyle6">协议设计 </span>
    <span class="fontstyle4">8<br></span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">! · · · ! </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">! · · · ! </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle6">，其中 </span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle6">为环路的长度。<br></span>
    <span class="fontstyle3">当这些订单的价格</span>
    <span class="fontstyle2" style="font-size:11pt;">满足一定条件时</span>
    <span class="fontstyle3">，我们可以对整个交易环路进行撮合，这种交易<br>环路称为</span>
    <span class="fontstyle2" style="font-size:11pt;">可交易环路</span>
    <span class="fontstyle3">。下面我们对交易环路中的成交价格和成交量进行讨论。<br></span>
    <span class="fontstyle18">3.4.1 </span>
    <span class="fontstyle2" style="font-size:11pt;">成交条件和价格<br></span>
    <span class="fontstyle3">我们由一个长度为 </span>
    <span class="fontstyle4">3 </span>
    <span class="fontstyle3">的交易环路为例，介绍环路可成交的条件。假定环路中的三<br>个币种为 </span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle3">、</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle16">1 </span>
    <span class="fontstyle3">和</span>
    <span class="fontstyle8">C</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle3">，三笔订单分别为：</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle3">、</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle3">和 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle3">。很容易证明，如果<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle14">= 1 </span>
    <span class="fontstyle3">时，三个订单都可以用其自身的兑换率成交。当</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle8">&gt; </span>
    <span class="fontstyle14">1<br></span>
    <span class="fontstyle3">时，三个订单都可以用比自身兑换率更低的兑换率成交。我们称第一种情况为</span>
    <span class="fontstyle9">原价撮<br>合</span>
    <span class="fontstyle3">，称第二种情况为</span>
    <span class="fontstyle9">折价撮合</span>
    <span class="fontstyle3">。<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议要求交易环路的折价平均分享给环路中的每个订单。假设每笔订单<br>兑换率折价比例为 </span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle3">，那么最终完成撮合时，三笔订单的成交价分别为：</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle3">，<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle3">，并且满足：<br></span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">) </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">) </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">) = 1 </span>
    <span class="fontstyle4">(4)<br></span>
    <span class="fontstyle3">根据上式我们可以推导出：<br></span>
    <span class="fontstyle8">γ </span>
    <span class="fontstyle14">= 1 </span>
    <span class="fontstyle15">-<br></span>
    <span class="fontstyle14">1<br></span>
    <span class="fontstyle15">p</span>
    <span class="fontstyle20">3 </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle16">0</span>
    <span class="fontstyle3">。<br>在更一般的情形下，如果跨 </span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle3">个币种的环路中，</span>
    <span class="fontstyle9">兑换率折扣</span>
    <span class="fontstyle3">为：<br></span>
    <span class="fontstyle8">γ </span>
    <span class="fontstyle14">= 1 </span>
    <span class="fontstyle15">-<br></span>
    <span class="fontstyle14">1<br></span>
    <span class="fontstyle17">√</span>
    <span class="fontstyle21">n </span>
    <span class="fontstyle17">∏</span>
    <span class="fontstyle12">ni</span>
    <span class="fontstyle16">=0</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1 </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，其中</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">表示第</span>
    <span class="fontstyle8">i</span>
    <span class="fontstyle3">个订单的兑换率。<br>显然，只有在兑换率折扣 </span>
    <span class="fontstyle8">γ </span>
    <span class="fontstyle15">≥ </span>
    <span class="fontstyle14">0 </span>
    <span class="fontstyle3">时，交易环路才可以真正成交；且第 </span>
    <span class="fontstyle8">i </span>
    <span class="fontstyle3">个订单 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i<br></span>
    <span class="fontstyle3">的实际兑换率 </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">γ</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle3">，且有</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">≤ </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">。<br></span>
    <span class="fontstyle18">3.4.2 </span>
    <span class="fontstyle2" style="font-size:11pt;">成交量<br></span>
    <span class="fontstyle3">当一个交易环路撮合完成后，至少有一个订单是被完全成交的。这点很容易得到证<br>明：我们可以先假设该结论不成立，即全部订单都没有完全成交。由于章节 </span>
    <span class="fontstyle4">3.2</span>
    <span class="fontstyle3">中要求<br>兑换率在订单新状态（尾单）中保持不变，意味着撮合后新的环路依然满足成交条件。<br>这就意味着之前的撮合是没有进行完的。因此可以断言：一次完整的撮合应该会将至少<br>一个订单完全吃掉。我们称这个（些）被完全吃掉的订单为交易环路的</span>
    <span class="fontstyle9">最小订单</span>
    <span class="fontstyle3">。<br>找到任何一个最小订单，既可循环计算环路中所有订单的成交量。假设第 </span>
    <span class="fontstyle8">i </span>
    <span class="fontstyle3">个订单<br>是最小订单，那么每笔订单的卖出代币成交量 </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle3">和买入代币成交量 </span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle3">可以以此如下计<br>算得出：<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">= ^ </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">/^</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，其中</span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">为订单的卖出代币余额</span>
    <span class="fontstyle4">;<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle14">= ^</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle14">= ^ </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle14">/^</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle4">;<br></span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle14">= ^</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle14">^</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle14">= ^ </span>
    <span class="fontstyle8">s</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle14">/^</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle13">⊕</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle4">;<br></span>
    <span class="fontstyle8">:::</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">3 </span><span class="fontstyle6">协议设计 </span></td>
       <td><span class="fontstyle4">9</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">实际实施过程中，可以先假定第一个订单为最小订单，往后循环计算成交量，直到</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">每个订单的成交量都不再变化为止。理论上最多循环两次即可计算出每单的实际成交</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">量。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle18">3.4.3 </span>
    <span class="fontstyle2" style="font-size:11pt;">撮合费用<br></span>
    <span class="fontstyle3">交易所第一种收费形式是手续费。在订单中可以设置一个以 </span>
    <span class="fontstyle4">Loopring</span>
    <span class="fontstyle3">的代币 </span>
    <span class="fontstyle8">LRC<br></span>
    <span class="fontstyle3">为单位的费用</span>
    <span class="fontstyle4">, </span>
    <span class="fontstyle8">m</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，代表完全成交情况下编号为</span>
    <span class="fontstyle8">i </span>
    <span class="fontstyle3">订单愿意支付给交易所的手续费总和。<br>实际成交时候按订单卖出代币成交比例支付给交易所，即：<br></span>
    <span class="fontstyle8">f </span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle14">=</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">m</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">/</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i<br></span>
    <span class="fontstyle3">为了鼓励交易所为用户找到兑换率折价比例最大的成交环路， </span>
    <span class="fontstyle4">Loopring</span>
    <span class="fontstyle3">协议要求<br>将兑换率折价带来的</span>
    <span class="fontstyle9">成本节约</span>
    <span class="fontstyle3">分润给交易所。对于一个订单</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle4">,</span>
    <span class="fontstyle3">假设买入订单的成交额<br>度为 </span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">（</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">≤ </span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">）</span>
    <span class="fontstyle4">, </span>
    <span class="fontstyle3">我们定义成本节约为：<br></span>
    <span class="fontstyle14">∆</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle14">=</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">γ<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议允许每个订单设定一个成本节约分享</span>
    <span class="fontstyle9">分润比例</span>
    <span class="fontstyle8">θ</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，并将交易环路上<br>所有订单分润比例的最小值作为该环路的分润比例 </span>
    <span class="fontstyle14">Θ</span>
    <span class="fontstyle3">，那么订单</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle3">支付给交易所的费<br>用为：<br></span>
    <span class="fontstyle8">f </span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle14">= ∆</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">Θ = </span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">γ </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle14">Θ<br></span>
    <span class="fontstyle3">因此交易所对于一个交易环路，通过成本节约分润获得的收入为：<br></span>
    <span class="fontstyle8">F </span>
    <span class="fontstyle14">=<br></span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1<br></span>
    <span class="fontstyle17">∑ </span>
    <span class="fontstyle12">i<br></span>
    <span class="fontstyle16">=0<br></span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle8">γ </span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">Θ<br></span>
    <span class="fontstyle3">采用所有订单中最小的分润比例作为整个交易环路的分润比例，可以激励订单采用<br>较大的分润比例。这样做会激励交易所对订单进行撮合，同时一旦订单成交，也不一定<br>非要支付指定比例的分润。<br>为了鼓励 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">的代币</span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">的使用，如果订单中没有指定代币费用</span>
    <span class="fontstyle8">m</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle3">，或<br></span>
    <span class="fontstyle8">m</span>
    <span class="fontstyle12">i </span>
    <span class="fontstyle14">= 0</span>
    <span class="fontstyle3">，那么该笔订单的分润比例实际被认为是</span>
    <span class="fontstyle4">100%</span>
    <span class="fontstyle3">，而不管订单中相应参数的值是<br>多少。如果一个交易环路中的所有订单都没有设置代币费用， </span>
    <span class="fontstyle14">Θ = 100</span>
    <span class="fontstyle4">%</span>
    <span class="fontstyle3">，环路中所有<br>成本节约归交易所所有。<br>在下一章节，我们会引入一个激励交易所竞争的代币抵押机制，智能合约根据每个<br>交易所代币抵押数量的排名，为每个交易所计算一个</span>
    <span class="fontstyle9">费用强制折扣</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle3">，该折扣会进一<br>步影响交易所的费用收取；同时，交易所也可以指定为某个交易环路做进一步的费用优<br>惠折扣， </span>
    <span class="fontstyle8">η</span>
    <span class="fontstyle3">。因此，交易所对于一个交易环路的整体费用为：<br></span>
    <span class="fontstyle8">F </span>
    <span class="fontstyle14">= (1 </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle14">) </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle14">(1 </span>
    <span class="fontstyle15">- </span>
    <span class="fontstyle8">η</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle15">·<br></span>
    <span class="fontstyle12">n</span>
    <span class="fontstyle13">-</span>
    <span class="fontstyle16">1<br></span>
    <span class="fontstyle17">∑ </span>
    <span class="fontstyle12">i<br></span>
    <span class="fontstyle16">=0<br></span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">γ </span>
    <span class="fontstyle15">·</span>
    <span class="fontstyle14">Θ + </span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">m</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">/</span>
    <span class="fontstyle8">b</span>
    <span class="fontstyle12">i</span>
    <span class="fontstyle14">)<br></span>
    <span class="fontstyle3">两种不同的费用模型能够满足不同订单的诉求：对于没有 </span>
    <span class="fontstyle8">LRC</span>
    <span class="fontstyle3">代币的账户，可以<br>设置合适的分润比例；对于有 </span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">代币的账户，可以选择支付较多的代币费用，并将</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">3 </span><span class="fontstyle6">协议设计 </span></td>
       <td><span class="fontstyle4">10</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">分润比例设为一个较小值。交易所有可能对每笔订单的代币费用值有个最小额度限制，</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">Loopring </span><span class="fontstyle3">协议并不对此作出明确要求。交易所可以在自己网站上对相关标准做说明，并</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">引导用户设定合适的订单参数值。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle18">3.4.4 </span>
    <span class="fontstyle2" style="font-size:11pt;">交易所费用强制折扣<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议要求交易所给交易费强制打一个折扣，折扣大小决定于交易所抵押<br></span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">代币数量的排名，排名越靠后，折扣越高。假定排名为</span>
    <span class="fontstyle8">n </span>
    <span class="fontstyle3">的折扣为：<br></span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle12">n </span>
    <span class="fontstyle14">= 0</span>
    <span class="fontstyle8">:</span>
    <span class="fontstyle14">05</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle4">ln</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">n</span>
    <span class="fontstyle14">+ </span>
    <span class="fontstyle8">e </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle14">1) </span>
    <span class="fontstyle15">- </span>
    <span class="fontstyle14">1)</span>
    <span class="fontstyle3">。<br>具体返利比例如下表所示：<br></span>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle3">抵押排名 </span><span class="fontstyle8">n </span></td>
       <td><span class="fontstyle3">费用强制折扣 </span><span class="fontstyle8">λ</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">1 </span></td>
       <td><span class="fontstyle4">0%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">2 </span></td>
       <td><span class="fontstyle14">1</span><span class="fontstyle8">:</span><span class="fontstyle14">57</span><span class="fontstyle4">%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">10 </span></td>
       <td><span class="fontstyle14">7</span><span class="fontstyle8">:</span><span class="fontstyle14">31</span><span class="fontstyle4">%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">20 </span></td>
       <td><span class="fontstyle14">10</span><span class="fontstyle8">:</span><span class="fontstyle14">39</span><span class="fontstyle4">%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">99 </span></td>
       <td><span class="fontstyle14">18</span><span class="fontstyle8">:</span><span class="fontstyle14">06</span><span class="fontstyle4">%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">100 </span></td>
       <td><span class="fontstyle14">18</span><span class="fontstyle8">:</span><span class="fontstyle14">11</span><span class="fontstyle4">%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">1000 </span></td>
       <td><span class="fontstyle14">29</span><span class="fontstyle8">:</span><span class="fontstyle14">55</span><span class="fontstyle4">%</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">1001 </span></td>
       <td><span class="fontstyle14">30</span><span class="fontstyle8">:</span><span class="fontstyle14">00</span><span class="fontstyle4">%</span><span class="fontstyle13">∗</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle3">表 </span>
    <span class="fontstyle4">1: </span>
    <span class="fontstyle3">抵押</span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">排名与费用强制折扣<br>对于排名 </span>
    <span class="fontstyle4">1001 </span>
    <span class="fontstyle3">及以后的交易所，或未进行抵押的交易所，统一实施</span>
    <span class="fontstyle4">30% </span>
    <span class="fontstyle3">费用强制<br>折扣。<br>如下图所示，费用强制折扣的下降并非线性的，如 </span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle16">2</span>
    <span class="fontstyle15">- </span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle16">1</span>
    <span class="fontstyle15">≫ </span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle16">100</span>
    <span class="fontstyle15">- </span>
    <span class="fontstyle8">λ</span>
    <span class="fontstyle16">99</span>
    <span class="fontstyle3">。</span>
    <br>
    <span class="fontstyle5">3 </span>
    <span class="fontstyle6">协议设计 </span>
    <span class="fontstyle4">11<br></span>
    <span class="fontstyle3">图 </span>
    <span class="fontstyle4">3: </span>
    <span class="fontstyle8">LRC</span>
    <span class="fontstyle3">代币抵押排名与费用强制折扣<br>在实际部署时，折扣函数中的参数需要根据市场行情不断调整，比如交易量和实时<br>性。当市场交易量过于旺盛时，会导致过多交易无法及时确认，这时需要降低整体折扣<br>率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交易的撮<br>合。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.5 </span>
    <span class="fontstyle2" style="font-size:12pt;">防作弊和防攻击<br></span>
    <span class="fontstyle18">3.5.1 </span>
    <span class="fontstyle2" style="font-size:11pt;">交易所无风险套利<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议致力寻求在用户和交易所间利益的平衡点，打造公平健康的交易所<br>生态。 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议不反对交易所的套利行为，因为套利行为本质上也是在促成交易。<br>但是我们禁止交易所利用自己在生态中角色的特殊性进行套利，具体来说，通过上传一<br>种特殊的闭环无风险套取订单间的价差，本节我们将介绍如何防止交易所的这种行为。<br>在介绍之前，我们首先来分析交易所如何做到无风险套利。<br>假设有两个订单 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle3">，形成一个交易环路，且</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle8">&gt; </span>
    <span class="fontstyle14">1</span>
    <span class="fontstyle3">。交易所可<br>以在这个环路上插入三个自己新生成的订单 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">c</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">c</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">d</span>
    <span class="fontstyle3">，</span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">d</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle3">，生成一个长度为</span>
    <span class="fontstyle4">5 </span>
    <span class="fontstyle3">的<br>新环路，并使 </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">c</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">c</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">d</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">d</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle15">· </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle14">= 1</span>
    <span class="fontstyle3">。通过这种方式，交易所可以做到将所<br>有可能的成本节约变成 </span>
    <span class="fontstyle4">0</span>
    <span class="fontstyle3">，一旦撮合被智能合约接受，即可实现无风险套利。<br>这种套利的交易环路有个显著的特征：它们包含子环路。在上个例子中，两个子环<br>路分别是： </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle15">! </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">a</span>
    <span class="fontstyle3">和 </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">c</span>
    <span class="fontstyle15">! </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">c</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">d</span>
    <span class="fontstyle15">! </span>
    <span class="fontstyle8">O</span>
    <span class="fontstyle12">d</span>
    <span class="fontstyle13">!</span>
    <span class="fontstyle12">b</span>
    <span class="fontstyle3">。为了杜绝交易所的这种无风险套<br>利， </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议要求：</span>
    <span class="fontstyle2" style="font-size:11pt;">合法的闭环必须保证其订单子集无法组成更小的可交易环路</span>
    <span class="fontstyle3">。<br></span>
    <span class="fontstyle18">3.5.2 </span>
    <span class="fontstyle2" style="font-size:11pt;">交易所拒绝服务<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议允许交易所选择性地为特定订单做撮合。交易所有权对订单的代币<br>类型，订单数量，费用等做筛选，也有权对这些筛选条件做更改，且有权公开或隐藏这<br>些筛选条件。交易发起者与交易所之间是相互选择的关系，彼此没有任何义务。<br></span>
    <span class="fontstyle18">3.5.3 </span>
    <span class="fontstyle2" style="font-size:11pt;">尘埃订单攻击<br></span>
    <span class="fontstyle3">普通用户可以通过广播大量的尘埃订单（即数量非常小的订单）试图对交易所做攻<br>击，不过由于撮合尘埃订单获利很低，所以这些订单一定会被交易所抛弃，进而对交易<br>所和区块链没有任何影响。<br>交易所也可能采用同样方式发起攻击，从而试图影响其它交易所对某些订单的撮<br>合。不过这种努力也不会奏效，因为协议允许同一个订单在同一个块中参与到多个环路<br>成交（这些环路可能是不同交易所提交到区块链上的），换句话说，订单并没有所谓的<br>锁定状态。<br></span>
    <span class="fontstyle18">3.5.4 </span>
    <span class="fontstyle2" style="font-size:11pt;">余额不足订单攻击<br></span>
    <span class="fontstyle3">交易发起者可能发起多笔订单，但订单卖出代币账户实际余额为零。这样的订单提<br>交到交易所后，交易所很容易通过查询区块链地址的余额信息将该订单抛弃，不过这种</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">3 </span><span class="fontstyle6">协议设计 </span></td>
       <td><span class="fontstyle4">12</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">攻击的确会浪费交易所的处理时间。好在交易所可以通过黑名单机制，迅速有效地将某</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">些地址屏蔽掉，拒绝再为这些地址提供撮合服务。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle18">3.5.5 </span>
    <span class="fontstyle2" style="font-size:11pt;">撮合窃取<br></span>
    <span class="fontstyle3">一个懒惰交易所可以监听网络上未被确认的撮合交易，解析交易环路并生成一个带<br>有自己签名的新撮合（环路相同，只有受益地址和数字签名不同），通过提供更高的交<br>易费来窃取其它交易所的撮合结果。特别当窃取者是矿工时，这种作弊行为是比较难以<br>预防的。为防止撮合窃取，我们规定交易所上传订单环路的过程分为两步：<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle3">交易所在区块链上发一笔交易，上传订单环路的存证，<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle3">存证信息被写入区块链后，交易所提交具体环路信息。<br>这个存证通过哈希来实现，哈希值的生成方法为<br></span>
    <span class="fontstyle8">h </span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">H</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">r; nonce</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle3">，<br>其中， </span>
    <span class="fontstyle8">H</span>
    <span class="fontstyle14">() </span>
    <span class="fontstyle3">为单向函数，</span>
    <span class="fontstyle8">r </span>
    <span class="fontstyle3">为订单环路信息。哈希函数的输入包含了一个随机数</span>
    <span class="fontstyle8">nonce</span>
    <span class="fontstyle3">，<br>用于防止对哈希值进行暴力破解。在提交具体环路信息时，随机数 </span>
    <span class="fontstyle8">nonce </span>
    <span class="fontstyle3">需要一并提<br>交。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.6 </span>
    <span class="fontstyle2" style="font-size:12pt;">市场深度<br></span>
    <span class="fontstyle3">交易所并不一定需要提供市场深度数据。在整个生态中，可能会有单独的组织和机<br>构汇集全网的未成交订单或者交易的尾单信息，汇总成独立的市场深度数据。市场深度<br>数据可以根据章节 </span>
    <span class="fontstyle4">3.3</span>
    <span class="fontstyle3">中的订单的规约方法，计算出任何两个</span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">代币之间的买单<br>卖单数据。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.7 </span>
    <span class="fontstyle2" style="font-size:12pt;">数据格式<br></span>
    <span class="fontstyle3">由于采用 </span>
    <span class="fontstyle4">OTC </span>
    <span class="fontstyle3">模型，所有订单可以用同一个数据结构表示。该结构包含订单本身<br>的各种参数数据和发起者的数字签名。在签名前，先将订单参数数据连接成一个字节数<br>组，通过 </span>
    <span class="fontstyle4">Keccak SHA3 </span>
    <span class="fontstyle3">方法对这个字节数组做散列计算得到订单的哈希，之后用账户<br>私钥对这个哈希进行 </span>
    <span class="fontstyle4">ECDSA </span>
    <span class="fontstyle3">签名。<br></span>
    <span class="fontstyle22">message Order {<br>address protocol; // Loopring</span>
    <span class="fontstyle9">协议入口智能合约地址<br></span>
    <span class="fontstyle22">address owner; // </span>
    <span class="fontstyle9">该订单发起者地址<br></span>
    <span class="fontstyle22">address outToken; // </span>
    <span class="fontstyle9">卖出</span>
    <span class="fontstyle22">ERC20</span>
    <span class="fontstyle9">代币智能合约地址<br></span>
    <span class="fontstyle22">address inToken; // </span>
    <span class="fontstyle9">买入</span>
    <span class="fontstyle22">ERC20</span>
    <span class="fontstyle9">代币智能合约地址<br></span>
    <span class="fontstyle22">uint256 outAmount; // </span>
    <span class="fontstyle9">卖出</span>
    <span class="fontstyle22">ERC20</span>
    <span class="fontstyle9">代币数量上限<br></span>
    <span class="fontstyle22">uint256 inAmount; // </span>
    <span class="fontstyle9">买入</span>
    <span class="fontstyle22">ERC20</span>
    <span class="fontstyle9">代币数量下限<br></span>
    <span class="fontstyle22">unit256 expiration // </span>
    <span class="fontstyle9">过期时间<br></span>
    <span class="fontstyle22">unit256 fee; // </span>
    <span class="fontstyle9">交易总费用（</span>
    <span class="fontstyle22">LRC</span>
    <span class="fontstyle9">），部分成交的费用按该次</span>
    <br>
    <span class="fontstyle5">3 </span>
    <span class="fontstyle6">协议设计 </span>
    <span class="fontstyle4">13<br></span>
    <span class="fontstyle22">// </span>
    <span class="fontstyle9">撮合实际卖出代币额与</span>
    <span class="fontstyle22">outAmount</span>
    <span class="fontstyle9">比例计算<br></span>
    <span class="fontstyle22">uint8 marginSplit; // fee</span>
    <span class="fontstyle9">不为</span>
    <span class="fontstyle22">0</span>
    <span class="fontstyle9">时支付给交易所的分润比例，否则视为</span>
    <span class="fontstyle22">100%<br>unit8 v;<br>bytes32 r;<br>bytes32 s;<br>}<br></span>
    <span class="fontstyle3">订单中虽然没有明确指定价格，但我们可以通过计算 </span>
    <span class="fontstyle8">outAmount</span>
    <span class="fontstyle14">/</span>
    <span class="fontstyle8">inAmount</span>
    <span class="fontstyle3">来得<br>到一个订单兑换率 </span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle3">。该兑换率隐含地要求所有实际撮合成交的兑换率不得大于</span>
    <span class="fontstyle8">r</span>
    <span class="fontstyle3">。一<br>个好的交易所 </span>
    <span class="fontstyle4">UI </span>
    <span class="fontstyle3">应该允许用户输入</span>
    <span class="fontstyle8">outAmount</span>
    <span class="fontstyle3">， </span>
    <span class="fontstyle8">inAmount</span>
    <span class="fontstyle3">，和传统意义的买入价或<br>卖出价这三个数据的任意两个来计算缺失的 </span>
    <span class="fontstyle8">outAmount </span>
    <span class="fontstyle3">或</span>
    <span class="fontstyle8">outAmount </span>
    <span class="fontstyle3">值。<br>订单实际上可以有两种不同的</span>
    <span class="fontstyle9">完全成交</span>
    <span class="fontstyle3">定义：一种定义是只有卖出代币达到了<br></span>
    <span class="fontstyle8">outAmount </span>
    <span class="fontstyle3">就算完全成交；另一种定义在之前的基础上允许买入代币累计金额达到<br></span>
    <span class="fontstyle8">inAmount </span>
    <span class="fontstyle3">也算完全成交。我们可以在订单中引入一个参数告诉交易所和撮合智能合约<br>选择哪种完全成交定义。在第一版本的实现中，我们先支持第一种完全成交定义。<br>交易所可以通过下面的数据结构构建一个交易环路：<br></span>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle22">message MatchRing {<br>Order[] orders; </span></td>
       <td><span class="fontstyle22">// </span><span class="fontstyle9">该次匹配的所有订单</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle22">address feeRecipient; </span></td>
       <td><span class="fontstyle22">// </span><span class="fontstyle9">费用收取地址</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle22">unit256 additionalDiscount; // </span>
    <span class="fontstyle9">在费用基础上进行的再折扣价</span>
    <span class="fontstyle22">- eta<br>unit256 nonce; // </span>
    <span class="fontstyle9">一个随机数<br></span>
    <span class="fontstyle22">unit8 v;<br>bytes32 r;<br>bytes32 s;<br>}<br></span>
    <span class="fontstyle3">一个可交易环路上同一位置的订单只能有一个 </span>
    <span class="fontstyle4">—</span>
    <span class="fontstyle3">理论上可以将这个限制去掉，不<br>过这会让撮合智能合约更加复杂，我们可能在后续的版本中再给与支持。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">3.8 </span>
    <span class="fontstyle2" style="font-size:12pt;">订单状态<br></span>
    <span class="fontstyle3">订单发起者对订单签字广播后无法对该订单进行修改。撮合智能合约一旦对某个订<br>单进行撮合，就需要在区块链上对订单的状态更新记录。对部分或者完全成交的订单，<br>会计算更新 </span>
    <span class="fontstyle8">inAmount </span>
    <span class="fontstyle3">和 </span>
    <span class="fontstyle8">outAmount </span>
    <span class="fontstyle3">两个值，并且保障订单新状态价格和原始订单的<br>价格一致。如果 </span>
    <span class="fontstyle8">inAmount </span>
    <span class="fontstyle3">或</span>
    <span class="fontstyle8">outAmount </span>
    <span class="fontstyle3">为 </span>
    <span class="fontstyle4">0</span>
    <span class="fontstyle3">，则表示该订单已经完全成交。如果用<br>户取消订单，需要发起一个特殊的交易，将 </span>
    <span class="fontstyle8">inAmount </span>
    <span class="fontstyle3">和</span>
    <span class="fontstyle8">outAmount </span>
    <span class="fontstyle3">更改为 </span>
    <span class="fontstyle4">0 </span>
    <span class="fontstyle3">即可。<br>过期的订单不会触发区块链上的数据更新 </span>
    <span class="fontstyle4">— </span>
    <span class="fontstyle3">可以根据最后一个块的时间戳来判断任何<br>一个订单是否过期 </span>
    <span class="fontstyle4">— </span>
    <span class="fontstyle3">因此我们期待多数的订单会因为过期或者完全成交而变成失效。<br>交易所需要采用同样的甚至是更复杂的逻辑在区块链外追踪订单状态，尤其是当一<br>家交易监听到到竞争对手在对同一个订单做不同的撮合的时候。<br>一个可交易的订单还需要其账户中有足够多的卖出代币余额 </span>
    <span class="fontstyle8">balance</span>
    <span class="fontstyle3">，虽然</span>
    <span class="fontstyle8">balance<br></span>
    <span class="fontstyle3">不要求达到订单中 </span>
    <span class="fontstyle8">outAmount</span>
    <span class="fontstyle3">的数量。实际上交易所在对订单状态计算的时候，会取</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">4 LOOPRING </span><span class="fontstyle6">协议代币</span><span class="fontstyle8">LRC </span></td>
       <td><span class="fontstyle4">14</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle8">max</span><span class="fontstyle14">(</span><span class="fontstyle8">balance; outAmount</span><span class="fontstyle14">)</span><span class="fontstyle3">作为实际的可成交金额。这里可以看出，订单的卖出代币并</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">不需要锁定的过程。用户提交订单后依然可以任意支配卖出代币作为他用。交易所不仅</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">仅要监听订单被（其它交易所）撮合的结果，还需要监听订单账户的余额变动情况。看</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">起来这种对区块链数据的监听和对订单状态的更新有些复杂，但这些反而极大简化区块</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">链上合约的逻辑，这种思路和比特币闪电网络，以太坊的雷霆网络的思路是一致的。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle0" style="font-size:12pt;">3.9 </span>
    <span class="fontstyle2" style="font-size:12pt;">智能合约<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议协议可能包含多个智能合约，包括但不限于：<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">撮合合约</span>
    <span class="fontstyle3">负责计算并确认交易环路中每个订单的状态，计算成交金额和成交量，对<br>交易进行清算转账。该合约还会与其它合约交互，是 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议的入口合约；<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">订单合约</span>
    <span class="fontstyle3">负责更新订单状态以及对取消订单提供支持；<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">交易所注册合约</span>
    <span class="fontstyle3">负责维护和更新一系列支持</span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议的交易所，为交易所代<br>币抵押和预设参数默认值提供支持；<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">统计合约</span>
    <span class="fontstyle3">计算任何两个币种之间的成交量，成交价，以及不同交易所的贡献度等<br>指标，以及这些指标的某些滑动平均值。这些指标是订单发起者授权撮合的重要<br>参考依据，同时也可以作为某些预测市场的输入，并且为以后可能的协议拓展（比<br>如对条件单的支持）提供输入（</span>
    <span class="fontstyle4">Oracle</span>
    <span class="fontstyle3">）。<br>这里，不排除将上述合约进一步拆解或合并的可能。同时值得指出： </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议<br>中的智能合约是完全开放的，这意味着它们可以被任何的 </span>
    <span class="fontstyle4">dApp </span>
    <span class="fontstyle3">直接或者间接调用。因<br>此整个协议即使一个完善的整体，又是个开放的，单独可用的组件的集合。<br></span>
    <span class="fontstyle0">4 Loopring </span>
    <span class="fontstyle2">协议代币 </span>
    <span class="fontstyle23">LRC<br></span>
    <span class="fontstyle3">我们将为 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议发行符合 </span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">规范的原生代币，其符号为</span>
    <span class="fontstyle8">LRC</span>
    <span class="fontstyle3">（在本<br>文中用斜体字母表示）。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">4.1 </span>
    <span class="fontstyle2" style="font-size:12pt;">代币的应用<br></span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">在生态中发挥下列作用：<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">作为撮合费用</span>
    <span class="fontstyle4">— </span>
    <span class="fontstyle3">订单中可以指定用 </span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">可作为支付给交易所的撮合费用。虽然<br>协议支持通过卖出代币成本节约的分润作为支付手段，但对于交易所来说，将来<br>需要支持的 </span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">代币类型可能越来越多，如果每笔撮合交易都通过各订单中<br>的卖出代币为单位支付手续费，那么对于一次撮合的收益计算将变得复杂；相反，<br>如果通过 </span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">来衡量收益（或者用来计算成本），会简单得多。同样，对于订单<br>发起者，可以通过公开信息获取某笔订单需要支付大约多少费用，如果用每个订<br>单的卖出代币计算，那么下单过程中的费用计算也会比较分散。我们在之前章节<br></span>
    <span class="fontstyle4">3.4.3</span>
    <span class="fontstyle3">对费用模型做了详细的说明。</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">4 LOOPRING </span><span class="fontstyle6">协议代币</span><span class="fontstyle8">LRC </span></td>
       <td><span class="fontstyle4">15</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">• </span><span class="fontstyle2" style="font-size:11pt;">作为交易所注册抵押</span><span class="fontstyle4">—</span><span class="fontstyle3">订单发起者希望自己的订单得到最好的撮合，这要求交易</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">所在各个方面都做到专业，特别是对全部订单的汇聚情况。由于去中心化交易没</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">有地域限制，一个好的交易所应该能比一个相对差的交易所看到更多的订单，也</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">应能在最短时间内找到最好的交易环路。为了鼓励实力强的交易所，淘汰实力差</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">的交易所，我们提供一种交易所注册抵押机制：交易所可以将一定数量的 </span><span class="fontstyle8">LRC </span><span class="fontstyle3">代</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">币抵押给智能合约。交易所可以随时申请抵押代币的解冻，但申请提出后，一年</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">后才锁定的代币才可以转账出去。并不是所有交易所都必须进行注册抵押。交易</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">所代币抵押的另一个作用是防止交易所为了抛弃不利的历史统计数据而频繁变动</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">身份。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle0" style="font-size:12pt;">4.2 </span>
    <span class="fontstyle2" style="font-size:12pt;">去中心化自治<br></span>
    <span class="fontstyle3">随着交易所的不断升级，交易所中的规则需要不断升级升级，为此我们引入去中心<br>化自治机制。任何持有 </span>
    <span class="fontstyle8">LRC </span>
    <span class="fontstyle3">者都可以将代币抵押并获得自治系统的投票权益，投票权<br>益 </span>
    <span class="fontstyle4">S </span>
    <span class="fontstyle3">是一个关于抵押数量 </span>
    <span class="fontstyle4">N </span>
    <span class="fontstyle3">和抵押时间 </span>
    <span class="fontstyle4">CoinAge</span>
    <span class="fontstyle3">的函数，<br></span>
    <span class="fontstyle8">S </span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">f</span>
    <span class="fontstyle14">(</span>
    <span class="fontstyle8">N; CoinAge</span>
    <span class="fontstyle14">)</span>
    <span class="fontstyle3">，<br>其中 </span>
    <span class="fontstyle8">CoinAge </span>
    <span class="fontstyle14">= </span>
    <span class="fontstyle8">H</span>
    <span class="fontstyle12">c </span>
    <span class="fontstyle15">-</span>
    <span class="fontstyle8">H</span>
    <span class="fontstyle12">s</span>
    <span class="fontstyle3">，这里的</span>
    <span class="fontstyle4">CoinAge </span>
    <span class="fontstyle3">是当前区块高度 </span>
    <span class="fontstyle8">H</span>
    <span class="fontstyle12">c </span>
    <span class="fontstyle3">减去开始抵押区块高<br>度 </span>
    <span class="fontstyle8">H</span>
    <span class="fontstyle12">s</span>
    <span class="fontstyle3">。加入</span>
    <span class="fontstyle4">CoinAge </span>
    <span class="fontstyle3">参数是为了防止有攻击者短时间内租借到大量代币并获得很高的<br>权益，迫使某项并不为他人接受的提议得以通过。<br>在去中心化自治系统中，任何决定都要在一个固定时间内完成投票，这个时间根据<br>提议内容不同而发生改变。当且仅当收集到足够高权益的投票，提议才会执行，否则提<br>议将会关闭。在去中心化自治系统中，并不是权益高者的一言堂，权益低者可以联合在<br>一起制衡权益高者。<br>去中心化自治内容包括但不限于交易所注册、币种注册、统计函数、抵押代币范围<br>等，这些升级可以通过自治系统参与者共同投票参与决定。<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">币种注册</span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议会阶段性的调整支持的币种，有些数字货币会因为交易量<br>过低而退出交易所，而另外会有一些新的数字货币诞生而加入交易所。这些币种<br>需要记录在智能合约中，包括币种名称、代号及对应智能合约地址等信息。<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">交易所注册</span>
    <span class="fontstyle3">交易所需要注册完成才能通过协议进行交易，当交易所达到一定数量<br>后，新注册交易所需要经过自治系统投票才能通过。<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">统计函数</span>
    <span class="fontstyle3">随着交易所上线运行时间越长，数据量得到一定积累，用于统计的指标<br>和函数也会逐渐成熟。自治系统参与者可以决定新增或淘汰统计函数。<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">抵押代币范围</span>
    <span class="fontstyle3">交易所可以抵押的代币数量需要限制在一定范围内。如果抵押数量<br>太多，会导致代币流动性变差；如果抵押过少，则无法体现交易所间的差异性。<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">环路最大长度</span>
    <span class="fontstyle3">理论上说，环路越长越有可能发现利差大的环路，然而过长的环路<br>会降低环路撮合的成功率，并且在过长的环路会带来过高的计算成本。</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">4 LOOPRING </span><span class="fontstyle6">协议代币</span><span class="fontstyle8">LRC </span></td>
       <td><span class="fontstyle4">16</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">• </span><span class="fontstyle2" style="font-size:11pt;">强制折扣函数</span><span class="fontstyle3">强制折扣函数需要根据市场行情不断调整，比如交易量和实时性。当</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">市场交易量过于旺盛时，会导致交易过多而无法及时确认，这时需要降低整体折</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">扣率，尤其是原本折扣率高的那些交易所。当交易量低时，需降低折扣率，刺激交</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">易的撮合。如下图所示，其中蓝色为交易量正常时的折扣率，黄色为市场交易量</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">过高时的折扣率，红色为交易量过低时的折扣率。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle3">图 </span>
    <span class="fontstyle4">4: </span>
    <span class="fontstyle3">调整后的强制折扣率<br></span>
    <span class="fontstyle4">• </span>
    <span class="fontstyle2" style="font-size:11pt;">子合约地址</span>
    <span class="fontstyle3">如果基于公有链搭建</span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">交易所，智能合约本身是无法改动的。<br>在这种情况下，如果升级 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议的子合约，则需要重新部署智能合约，并<br>修改子合约的地址。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">4.3 </span>
    <span class="fontstyle2" style="font-size:12pt;">代币的原生流动性<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议代币本身遵循</span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">标准，并且在 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">智能合约的基础上带<br>有原生的流动性 </span>
    <span class="fontstyle4">— </span>
    <span class="fontstyle3">这意味着你不必去传统的交易所购买和出售</span>
    <span class="fontstyle8">LRC</span>
    <span class="fontstyle3">，而是可以通过<br>本文论述的方式，利用 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议本身的去中心化撮合机制，使用任何</span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">代<br>币购得 </span>
    <span class="fontstyle8">LRC</span>
    <span class="fontstyle3">（订单中的买入代币设定为</span>
    <span class="fontstyle8">LRC</span>
    <span class="fontstyle3">，并将 </span>
    <span class="fontstyle8">fee</span>
    <span class="fontstyle3">设为 </span>
    <span class="fontstyle4">0</span>
    <span class="fontstyle3">）。这得益于协议灵活<br>的收费模式。</span>
    <br>
    <span class="fontstyle5">5 </span>
    <span class="fontstyle6">交易所 </span>
    <span class="fontstyle4">17<br></span>
    <span class="fontstyle0">5 </span>
    <span class="fontstyle2">交易所<br></span>
    <span class="fontstyle3">采用 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">开放协议后，交易所并不能保证每一个撮合都是盈利的。一方面可<br>能是成本过高，因为交易所为了激励矿工优先打包自己的撮合交易到区块链，可能根据<br>预期的收益调高手续费，而手续费代币和撮合中代币的相对价格有可能有超出预期的<br>浮动，从而造成手续费实际成本更高。另一方面可能是因为收入没有达到预期，比如交<br>易所把撮合广播到区块链后，该撮合的某个订单的卖出代币被部分或者全部转移到另<br>一个地址，从而造成整个撮合交易未能被确认或实际成交量和手续费过低。类似这样的<br>原因还有很多，因此交易所的每次撮合广播都是根据自己的经验和算法，最大化长期<br>利益的概率游戏。不过也不用担心，实际上交易所和订单发起者是双向选择的关系：交<br>易所只会选择有利可图的订单；而订单发起者只会选择费用最低的交易所 </span>
    <span class="fontstyle4">— </span>
    <span class="fontstyle3">通过参考<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">统计合约数据决策订单参数。<br>交易所采用 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议后，不需要再保存用户的</span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">代币资产。交易所的<br>主要职能从负责 </span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">的充值提现，内部虚拟账号管理，转移到更加纯粹的撮合服务。<br>对于用户来讲， </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议不要求卖出或买入代币的充值，提现，锁定，因此根本没<br>有资产丢失，被盗，或者资产流动性降低等的风险，同时一笔订单可以同时被多个交易<br>所同时撮合。<br>对于非 </span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">资产，交易所可以提供代币发行服务（</span>
    <span class="fontstyle4">Tokenization</span>
    <span class="fontstyle3">），将资产通过<br>抵押的方式，在区块链上发行相应的 </span>
    <span class="fontstyle4">ERC20 </span>
    <span class="fontstyle3">代币，并提供相应的充值、提现、和赎回<br>功能。这种服务和传统交易所类似，但也省去了传统交易所研发和维护内部虚拟账号的<br>必要。<br></span>
    <span class="fontstyle0" style="font-size:12pt;">5.1 </span>
    <span class="fontstyle2" style="font-size:12pt;">传统与</span>
    <span class="fontstyle0" style="font-size:12pt;">Loopring </span>
    <span class="fontstyle2" style="font-size:12pt;">上交易所模式的对比<br></span>
    <span class="fontstyle3">在传统交易所模型中，被撮合的两方中先下单的为 </span>
    <span class="fontstyle4">Maker</span>
    <span class="fontstyle3">，后下单的为</span>
    <span class="fontstyle4">Taker</span>
    <span class="fontstyle3">。因<br>为 </span>
    <span class="fontstyle4">Maker </span>
    <span class="fontstyle3">创造流动性而 </span>
    <span class="fontstyle4">Taker </span>
    <span class="fontstyle3">销毁流动性，所以在计算成交价时候会更偏向于</span>
    <span class="fontstyle4">Maker<br></span>
    <span class="fontstyle3">的价格，甚至直接采用 </span>
    <span class="fontstyle4">Maker </span>
    <span class="fontstyle3">的价格作为成交价。与之相比， </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">采用的是 </span>
    <span class="fontstyle4">OverThe-Counter</span>
    <span class="fontstyle3">（</span>
    <span class="fontstyle4">OTC</span>
    <span class="fontstyle3">）模型。主要的原因是在去中心化环境中，很难严格界定哪个单是<br>真正意义上较早的单。因此 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">的撮合设计不考虑时间因素，只考虑兑换率（在<br>本文中我们偶尔也用价格一词与兑换率交替使用）。<br>传统交易所对投资者安全的保障只能依靠自身信用，如果出现兑付问题，跑路的成<br>本非常低，因此需要通过监管保护投资者。然而在 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议中，通过在区块链上<br>开源智能合约可以实现交易的原子性，成交前卖出的代币和成交后买入的代币均存放在<br>用户本人区块链地址中。整个交易过程过程用户无需向交易所转账，交易所不托管用户<br>下单资金，资产丢失或者被盗风险为零，哪怕交易所倒闭，也不会对用户产生任何影响。<br>传统交易所中，用户下单后用于交易的资金会被冻结，同一订单只能提交给一家交<br>易所，各家交易只能看到部分交易信息。但在 </span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议中，用户下单后依然可以<br>动用账户资金，用户将资金部分或全部转移的行为等同于部分或全部撤单。订单可被广<br>播给多家交易所，由不同交易所共同完成撮合，每家交易所可以看到全部订单，因此市<br>场深度和订单表更全面，成交更快更有效。<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议的另一个显著特点是消除了传统交易所中</span>
    <span class="fontstyle9">交易对（</span>
    <span class="fontstyle22">Trading Pair</span>
    <span class="fontstyle9">）</span>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle5">6 </span><span class="fontstyle6">总结 </span></td>
       <td><span class="fontstyle4">18</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">的概念。一个从 </span><span class="fontstyle8">A</span><span class="fontstyle3">到 </span><span class="fontstyle8">B </span><span class="fontstyle3">的订单不一定要一个反向的从</span><span class="fontstyle8">B </span><span class="fontstyle3">到 </span><span class="fontstyle8">A</span><span class="fontstyle3">订单才能撮合，只要有</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">一个交易环路被发现，就可以撮合。也可以说传统交易所的交易对是多边交易环路的一</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">个最简特例。为激励撮合价格最优的交易环路， </span><span class="fontstyle4">Loopring</span><span class="fontstyle3">协议的收费模式以成交的“成</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">本节约分润”为主，交易手续费为辅。</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <table class="NormalTable">
     <tbody>
      <tr>
       <td><span class="fontstyle3">传统交易所 </span></td>
       <td><span class="fontstyle4">Loopring </span><span class="fontstyle3">交易<br>所</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">托管下单资金 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">否</span><span class="fontstyle7">1</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">下单资金冻结 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">否</span><span class="fontstyle7">2</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">需充值提现 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">否</span><span class="fontstyle7">3</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">有内部交易风险 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">否</span><span class="fontstyle7">4</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">倒闭会造成用户损失 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">否</span><span class="fontstyle7">5</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">收入主要来源为手续费 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">否</span><span class="fontstyle7">6</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">支持法币 </span></td>
       <td><span class="fontstyle3">是 </span></td>
       <td><span class="fontstyle3">是</span><span class="fontstyle7">7</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">同一个订单可以提交给多个交<br>易所</span></td>
       <td><span class="fontstyle3">否 </span></td>
       <td><span class="fontstyle3">是</span><span class="fontstyle7">8</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle4">Maker </span><span class="fontstyle3">和 </span><span class="fontstyle4">Taker </span><span class="fontstyle3">是否平等 </span></td>
       <td><span class="fontstyle3">否 </span></td>
       <td><span class="fontstyle3">是</span><span class="fontstyle7">9</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">支持环路交易 </span></td>
       <td><span class="fontstyle3">否 </span></td>
       <td><span class="fontstyle3">是</span><span class="fontstyle7">10</span></td>
      </tr>
      <tr>
       <td><span class="fontstyle3">监管必要性 </span></td>
       <td><span class="fontstyle3">强 </span></td>
       <td><span class="fontstyle3">弱</span><span class="fontstyle7">11</span></td>
      </tr>
     </tbody>
    </table>
    <br>
    <span class="fontstyle3">表 </span>
    <span class="fontstyle4">2: </span>
    <span class="fontstyle3">两种模式交易所简要对比<br></span>
    <span class="fontstyle0">6 </span>
    <span class="fontstyle2">总结<br></span>
    <span class="fontstyle3">本文描述了一个开放的，支持智能合约和 </span>
    <span class="fontstyle4">ERC20</span>
    <span class="fontstyle3">的代币间多边交易协议。该协议<br>允许多个订单构成一个可交易环路进行撮合，并允许交易所只将撮合的最终结果作为<br>交易提交到区块链上进行清算；本文描述了协议代币在撮合收费中起到的作用；以及<br></span>
    <span class="fontstyle4">Loopring </span>
    <span class="fontstyle3">协议相对于传统交易所模式为用户带来的好处。<br></span>
    <span class="fontstyle10">1</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所无需托管下单资金 </span>
    <span class="fontstyle11">—</span>
    <span class="fontstyle3" style="font-size:8pt;">交易用代币存放到自己区块链地址中，成交前无需要转账。资产丢失或者被盗<br>风险为零。<br></span>
    <span class="fontstyle10">2</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所无需冻结下单资金 </span>
    <span class="fontstyle11">—</span>
    <span class="fontstyle3" style="font-size:8pt;">用户下单后依然可以任意动用账户任何资金，将资金部分或全部转移走等同于<br>部分或全部撤单。<br></span>
    <span class="fontstyle10">3</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">订单实际是交易指令，交易过程中用户资产一直保存在用户自己的区块链地址中，无需充值提现过程。<br></span>
    <span class="fontstyle10">4</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所撮合全部基于区块链智能合约，数据不可更改，完全开放透明。<br></span>
    <span class="fontstyle10">5</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所如果不提供代币发行职责，交易所倒闭对用户没有任何影响 </span>
    <span class="fontstyle11">— </span>
    <span class="fontstyle3" style="font-size:8pt;">好比矿工倒闭对区块链账户也没有影<br>响一样。交易所只负责撮合，清算转账通过智能合约完成。所有资产一直在区块链用户自己的账户里。<br></span>
    <span class="fontstyle10">6</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所的交易手续费为辅助收入，主要收入为成交的“成本节约分润”，这样会激励撮合价格最优订单。<br></span>
    <span class="fontstyle10">7</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所对法币的支持是通过资产代币化，需要将法币在区块链上做 </span>
    <span class="fontstyle11">ERC20 </span>
    <span class="fontstyle3" style="font-size:8pt;">代币发行。<br></span>
    <span class="fontstyle10">8</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">允许用户的同一个订单被多家 </span>
    <span class="fontstyle11">Loopring</span>
    <span class="fontstyle3" style="font-size:8pt;">交易所同时撮合，并可以被多家交易所不同程度部分或全部成交。<br></span>
    <span class="fontstyle10">9</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">协议要求成交接近中间价，而不是过度倾向于 </span>
    <span class="fontstyle11">Maker</span>
    <span class="fontstyle3" style="font-size:8pt;">的价格。<br></span>
    <span class="fontstyle10">10</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所支持环路发现，能最大程度找到最好的匹配订单。<br></span>
    <span class="fontstyle10">11</span>
    <span class="fontstyle11">Loopring </span>
    <span class="fontstyle3" style="font-size:8pt;">交易所不保存</span> 
    <br style="line-height:normal;">
    <br>
   </div>
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sinat_34070003/article/details/79269411,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sinat_34070003/article/details/79269411,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
