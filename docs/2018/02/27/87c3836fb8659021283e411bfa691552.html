<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>电商平台搭建–支付模块开发 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="电商平台搭建–支付模块开发" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="一、支付模块开发-概述 &nbsp; &nbsp; 本项目使用的支付方式是支付宝支付，在后期会集成微信支付。为了方便大家集成支付宝，我把几篇必要的文章放到了一起。 沙箱登录：https://openhome.alipay.com/platform/appDaily.htm&nbsp; 沙箱环境使用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105311&amp;docType=1&nbsp; 如何使用沙箱环境：https://support.open.alipay.com/support/hotProblemDetail.htm?spm=a219a.7386793.0.0.uS5uZ6&amp;id=251932&amp;tagId=100248&nbsp; 当面付产品介绍：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105072&amp;docType=1&nbsp; 扫码支付接入指引：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.Ia6Wqy&amp;treeId=193&amp;articleId=106078&amp;docType=1&nbsp; 当面付快速接入：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.bROnXf&amp;treeId=193&amp;articleId=105170&amp;docType=1&nbsp; 当面付接入必读：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105322&amp;docType=1&nbsp; 当面付进阶功能：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.YFmkxI&amp;treeId=193&amp;articleId=105190&amp;docType=1&nbsp; 当面付异步通知-仅用于扫码支付：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.BykVSR&amp;treeId=193&amp;articleId=103296&amp;docType=1&nbsp; 当面付SDK&amp;DEMO：https://support.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.k0rwWc&amp;treeId=193&amp;articleId=105201&amp;docType=1&nbsp; 服务端SDK：https://doc.open.alipay.com/doc2/detail?treeId=54&amp;articleId=103419&amp;docType=1&nbsp; 生成RSA密钥：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1&nbsp; 线上创建应用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105310&amp;docType=1#s0 &nbsp; &nbsp; 集成支付宝支付需要用到沙箱环境，上面有沙箱的地址，点击进去登录即可，如果没有账号需要申请注册一个才能使用支付宝的沙箱环境。 登录进去以后首先会看到“必看部分”，APPID是自动生成的，支付宝网关都是一样的，这个是让我们把我们项目中的支付宝请求请求到该接口上，这样就会接到支付宝的回调。RSA2密钥是下载支付宝密钥生成器生成的。接下来是选看部分 商户UID也是自动生成的，授权回调地址就是支付宝的回调请求接口，这个是自己设置的。RSA密钥因为加密过于简单在实际的项目开发中已经不再使用了。如果需要手机支付宝进行调试，请下载手机支付宝沙箱版，支付宝官方会在沙箱账号中随机生成对应的卖家和买家账号信息 这里的所有信息都是自动生成的，在手机支付宝沙箱环境中请使用这里的账号进行登录。账户余额是随便设置的最高99999，不会有真实的交易产生。 以上就是集成支付宝的一些基本操作。 二、支付模块开发-集成支付宝的进一步设置 &nbsp; &nbsp;除了上述基本操作意外，为了方便，还需要把支付宝官网的Demo在自己的项目中调试通，这样可以直接在项目中调用调试好的Api，不用重新再进行配置 （1）alipay.demo.trade-&gt;DemoHbRunner /** * Created by liuyangkly on 15/10/23. 执行调度，主要任务由两个线程完成，交易线程（调用当面付2.0接口）和交易保障线程（轮询），具体需要做的事情 1.当面付程序每执行完一笔交易后将交易结果保存在临时队列 2.轮询线程读取临时队列，获取基础采集信息和最多30条trade_info信息，调用支付宝monitor.heartbeat.syn接口 示例代码仅封装了如何调用该接口api，采集数据，比如采集网络信息、交易耗时、异常信息等，需要系统商开发者自行完成。 */ public class DemoHbRunner extends AbsHbRunner { public DemoHbRunner(AlipayMonitorService monitorService) { super(monitorService); } @Override public String getAppAuthToken() { // 对于系统商，如果是为了商户开发监控保障接口，则需要传此值，否则如果为系统商自己做交易保障接口开发，则可不传。 return null; } @Override public AlipayHeartbeatSynRequestBuilder getBuilder() { // 系统商使用的交易信息格式，json字符串类型，从交易队列中获取 List&lt;SysTradeInfo&gt; sysTradeInfoList = HbQueue.poll(); // 异常信息的采集，系统商自行完成 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); // exceptionInfoList.add(ExceptionInfo.HE_SCANER); // exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // exceptionInfoList.add(ExceptionInfo.HE_OTHER); AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setProduct(Product.FP).setType(Type.CR).setEquipmentId(&quot;cr1000001&quot;) .setEquipmentStatus(EquipStatus.NORMAL).setTime(Utils.toDate(new Date())) .setStoreId(&quot;store10001&quot;).setMac(&quot;0a:00:27:00:00:00&quot;).setNetworkType(&quot;LAN&quot;) .setProviderId(&quot;你的pid&quot;) // 设置系统商pid .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息 .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 ; return builder; } } （2）&nbsp;alipay.demo.trade-&gt;main /** * 简单main函数，用于测试当面付api * sdk和demo的意见和问题反馈请联系：liuyang.kly@alipay.com */ public class Main { private static Log log = LogFactory.getLog(Main.class); // 支付宝当面付2.0服务 private static AlipayTradeService tradeService; // 支付宝当面付2.0服务（集成了交易保障接口逻辑） private static AlipayTradeService tradeWithHBService; // 支付宝交易保障接口服务，供测试接口api使用，请先阅读readme.txt private static AlipayMonitorService monitorService; static { /** 一定要在创建AlipayTradeService之前调用Configs.init()设置默认参数 * Configs会读取classpath下的zfbinfo.properties文件配置信息，如果找不到该文件则确认该文件是否在classpath目录 */ Configs.init(&quot;zfbinfo.properties&quot;); /** 使用Configs提供的默认参数 * AlipayTradeService可以使用单例或者为静态成员对象，不需要反复new */ tradeService = new AlipayTradeServiceImpl.ClientBuilder().build(); // 支付宝当面付2.0服务（集成了交易保障接口逻辑） tradeWithHBService = new AlipayTradeWithHBServiceImpl.ClientBuilder().build(); /** 如果需要在程序中覆盖Configs提供的默认参数, 可以使用ClientBuilder类的setXXX方法修改默认参数 否则使用代码中的默认设置 */ monitorService = new AlipayMonitorServiceImpl.ClientBuilder() .setGatewayUrl(&quot;http://mcloudmonitor.com/gateway.do&quot;).setCharset(&quot;GBK&quot;) .setFormat(&quot;json&quot;).build(); } // 简单打印应答 private void dumpResponse(AlipayResponse response) { if (response != null) { log.info(String.format(&quot;code:%s, msg:%s&quot;, response.getCode(), response.getMsg())); if (StringUtils.isNotEmpty(response.getSubCode())) { log.info(String.format(&quot;subCode:%s, subMsg:%s&quot;, response.getSubCode(), response.getSubMsg())); } log.info(&quot;body:&quot; + response.getBody()); } } public static void main(String[] args) { Main main = new Main(); // 系统商商测试交易保障接口api // main.test_monitor_sys(); // POS厂商测试交易保障接口api // main.test_monitor_pos(); // 测试交易保障接口调度 // main.test_monitor_schedule_logic(); // 测试当面付2.0支付（使用未集成交易保障接口的当面付2.0服务） // main.test_trade_pay(tradeService); // 测试查询当面付2.0交易 // main.test_trade_query(); // 测试当面付2.0退货 // main.test_trade_refund(); // 测试当面付2.0生成支付二维码 main.test_trade_precreate(); } // 测试系统商交易保障调度 public void test_monitor_schedule_logic() { // 启动交易保障线程 DemoHbRunner demoRunner = new DemoHbRunner(monitorService); demoRunner.setDelay(5); // 设置启动后延迟5秒开始调度，不设置则默认3秒 demoRunner.setDuration(10); // 设置间隔10秒进行调度，不设置则默认15 * 60秒 demoRunner.schedule(); // 启动当面付，此处每隔5秒调用一次支付接口，并且当随机数为0时交易保障线程退出 while (Math.random() != 0) { test_trade_pay(tradeWithHBService); Utils.sleep(5 * 1000); } // 满足退出条件后可以调用shutdown优雅安全退出 demoRunner.shutdown(); } // 系统商的调用样例，填写了所有系统商商需要填写的字段 public void test_monitor_sys() { // 系统商使用的交易信息格式，json字符串类型 List&lt;SysTradeInfo&gt; sysTradeInfoList = new ArrayList&lt;SysTradeInfo&gt;(); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000001&quot;, 5.2, HbStatus.S)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000002&quot;, 4.4, HbStatus.F)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000003&quot;, 11.3, HbStatus.P)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000004&quot;, 3.2, HbStatus.X)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000005&quot;, 4.1, HbStatus.X)); // 填写异常信息，如果有的话 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); exceptionInfoList.add(ExceptionInfo.HE_SCANER); // exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // exceptionInfoList.add(ExceptionInfo.HE_OTHER); // 填写扩展参数，如果有的话 Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;(); // extendInfo.put(&quot;SHOP_ID&quot;, &quot;BJ_ZZ_001&quot;); // extendInfo.put(&quot;TERMINAL_ID&quot;, &quot;1234&quot;); String appAuthToken = &quot;应用授权令牌&quot;;//根据真实值填写 AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setAppAuthToken(appAuthToken).setProduct(Product.FP).setType(Type.CR) .setEquipmentId(&quot;cr1000001&quot;).setEquipmentStatus(EquipStatus.NORMAL) .setTime(Utils.toDate(new Date())).setStoreId(&quot;store10001&quot;).setMac(&quot;0a:00:27:00:00:00&quot;) .setNetworkType(&quot;LAN&quot;).setProviderId(&quot;你的pid&quot;) // 设置系统商pid .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息 // .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话 ; MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder); dumpResponse(response); } // POS厂商的调用样例，填写了所有pos厂商需要填写的字段 public void test_monitor_pos() { // POS厂商使用的交易信息格式，字符串类型 List&lt;PosTradeInfo&gt; posTradeInfoList = new ArrayList&lt;PosTradeInfo&gt;(); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, &quot;1324&quot;, 7)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.X, &quot;1326&quot;, 15)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, &quot;1401&quot;, 8)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.F, &quot;1405&quot;, 3)); // 填写异常信息，如果有的话 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // 填写扩展参数，如果有的话 Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;(); // extendInfo.put(&quot;SHOP_ID&quot;, &quot;BJ_ZZ_001&quot;); // extendInfo.put(&quot;TERMINAL_ID&quot;, &quot;1234&quot;); AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setProduct(Product.FP) .setType(Type.SOFT_POS) .setEquipmentId(&quot;soft100001&quot;) .setEquipmentStatus(EquipStatus.NORMAL) .setTime(&quot;2015-09-28 11:14:49&quot;) .setManufacturerPid(&quot;2088000000000009&quot;) // 填写机具商的支付宝pid .setStoreId(&quot;store200001&quot;).setEquipmentPosition(&quot;31.2433190000,121.5090750000&quot;) .setBbsPosition(&quot;2869719733-065|2896507033-091&quot;).setNetworkStatus(&quot;gggbbbgggnnn&quot;) .setNetworkType(&quot;3G&quot;).setBattery(&quot;98&quot;).setWifiMac(&quot;0a:00:27:00:00:00&quot;) .setWifiName(&quot;test_wifi_name&quot;).setIp(&quot;192.168.1.188&quot;) .setPosTradeInfoList(posTradeInfoList) // POS厂商同步trade_info信息 // .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话 ; MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder); dumpResponse(response); } // 测试当面付2.0支付 public void test_trade_pay(AlipayTradeService service) { // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线， // 需保证商户系统端不能重复，建议通过数据库sequence生成， String outTradeNo = &quot;tradepay&quot; + System.currentTimeMillis() + (long) (Math.random() * 10000000L); // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店消费” String subject = &quot;xxx品牌xxx门店当面付消费&quot;; // (必填) 订单总金额，单位为元，不能超过1亿元 // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】 String totalAmount = &quot;0.01&quot;; // (必填) 付款条码，用户支付宝钱包手机app点击“付款”产生的付款条码 String authCode = &quot;用户自己的支付宝付款码&quot;; // 条码示例，286648048691290423 // (可选，根据需要决定是否使用) 订单可打折金额，可以配合商家平台配置折扣活动，如果订单部分商品参与打折，可以将部分商品总价填写至此字段，默认全部商品可打折 // 如果该值未传入,但传入了【订单总金额】,【不可打折金额】 则该值默认为【订单总金额】- 【不可打折金额】 // String discountableAmount = &quot;1.00&quot;; // // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段 // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】 String undiscountableAmount = &quot;0.0&quot;; // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = &quot;&quot;; // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品3件共20.00元&quot; String body = &quot;购买商品3件共20.00元&quot;; // 商户操作员编号，添加此参数可以为商户操作员做销售统计 String operatorId = &quot;test_operator_id&quot;; // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持 String providerId = &quot;你的系统商编号&quot;; ExtendParams extendParams = new ExtendParams(); extendParams.setSysServiceProviderId(providerId); // 支付超时，线下扫码交易定义为5分钟 String timeoutExpress = &quot;5m&quot;; // 商品明细列表，需填写购买商品详细信息， List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;(); // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail GoodsDetail goods1 = GoodsDetail.newInstance(&quot;goods_id001&quot;, &quot;xxx面包&quot;, 1000, 1); // 创建好一个商品后添加至商品明细列表 goodsDetailList.add(goods1); // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件 GoodsDetail goods2 = GoodsDetail.newInstance(&quot;goods_id002&quot;, &quot;xxx牙刷&quot;, 500, 2); goodsDetailList.add(goods2); String appAuthToken = &quot;应用授权令牌&quot;;//根据真实值填写 // 创建条码支付请求builder，设置请求参数 AlipayTradePayRequestBuilder builder = new AlipayTradePayRequestBuilder() // .setAppAuthToken(appAuthToken) .setOutTradeNo(outTradeNo).setSubject(subject).setAuthCode(authCode) .setTotalAmount(totalAmount).setStoreId(storeId) .setUndiscountableAmount(undiscountableAmount).setBody(body).setOperatorId(operatorId) .setExtendParams(extendParams).setSellerId(sellerId) .setGoodsDetailList(goodsDetailList).setTimeoutExpress(timeoutExpress); // 调用tradePay方法获取当面付应答 AlipayF2FPayResult result = service.tradePay(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝支付成功: )&quot;); break; case FAILED: log.error(&quot;支付宝支付失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0查询订单 public void test_trade_query() { // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // 创建查询请求builder，设置请求参数 AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder() .setOutTradeNo(outTradeNo); AlipayF2FQueryResult result = tradeService.queryTradeResult(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;查询返回该订单支付成功: )&quot;); AlipayTradeQueryResponse response = result.getResponse(); dumpResponse(response); log.info(response.getTradeStatus()); if (Utils.isListNotEmpty(response.getFundBillList())) { for (TradeFundBill bill : response.getFundBillList()) { log.info(bill.getFundChannel() + &quot;:&quot; + bill.getAmount()); } } break; case FAILED: log.error(&quot;查询返回该订单支付失败或被关闭!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单支付状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0退款 public void test_trade_refund() { // (必填) 外部订单号，需要退款交易的商户外部订单号 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // (必填) 退款金额，该金额必须小于等于订单的支付金额，单位为元 String refundAmount = &quot;0.01&quot;; // (可选，需要支持重复退货时必填) 商户退款请求号，相同支付宝交易号下的不同退款请求号对应同一笔交易的不同退款申请， // 对于相同支付宝交易号下多笔相同商户退款请求号的退款交易，支付宝只会进行一次退款 String outRequestNo = &quot;&quot;; // (必填) 退款原因，可以说明用户退款原因，方便为商家后台提供统计 String refundReason = &quot;正常退款，用户买多了&quot;; // (必填) 商户门店编号，退款情况下可以为商家后台提供退款权限判定和统计等作用，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 创建退款请求builder，设置请求参数 AlipayTradeRefundRequestBuilder builder = new AlipayTradeRefundRequestBuilder() .setOutTradeNo(outTradeNo).setRefundAmount(refundAmount).setRefundReason(refundReason) .setOutRequestNo(outRequestNo).setStoreId(storeId); AlipayF2FRefundResult result = tradeService.tradeRefund(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝退款成功: )&quot;); break; case FAILED: log.error(&quot;支付宝退款失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单退款状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0生成支付二维码 public void test_trade_precreate() { // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线， // 需保证商户系统端不能重复，建议通过数据库sequence生成， String outTradeNo = &quot;tradeprecreate&quot; + System.currentTimeMillis() + (long) (Math.random() * 10000000L); // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店当面付扫码消费” String subject = &quot;xxx品牌xxx门店当面付扫码消费&quot;; // (必填) 订单总金额，单位为元，不能超过1亿元 // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】 String totalAmount = &quot;0.01&quot;; // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段 // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】 String undiscountableAmount = &quot;0&quot;; // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = &quot;&quot;; // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品2件共15.00元&quot; String body = &quot;购买商品3件共20.00元&quot;; // 商户操作员编号，添加此参数可以为商户操作员做销售统计 String operatorId = &quot;test_operator_id&quot;; // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持 ExtendParams extendParams = new ExtendParams(); extendParams.setSysServiceProviderId(&quot;你的系统商编号&quot;); // 支付超时，定义为120分钟 String timeoutExpress = &quot;120m&quot;; // 商品明细列表，需填写购买商品详细信息， List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;(); // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail GoodsDetail goods1 = GoodsDetail.newInstance(&quot;goods_id001&quot;, &quot;xxx小面包&quot;, 1000, 1); // 创建好一个商品后添加至商品明细列表 goodsDetailList.add(goods1); // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件 GoodsDetail goods2 = GoodsDetail.newInstance(&quot;goods_id002&quot;, &quot;xxx牙刷&quot;, 500, 2); goodsDetailList.add(goods2); // 创建扫码支付请求builder，设置请求参数 AlipayTradePrecreateRequestBuilder builder = new AlipayTradePrecreateRequestBuilder() .setSubject(subject).setTotalAmount(totalAmount).setOutTradeNo(outTradeNo) .setUndiscountableAmount(undiscountableAmount).setSellerId(sellerId).setBody(body) .setOperatorId(operatorId).setStoreId(storeId).setExtendParams(extendParams) .setTimeoutExpress(timeoutExpress) // .setNotifyUrl(&quot;http://www.test-notify-url.com&quot;)//支付宝服务器主动通知商户服务器里指定的页面http路径,根据需要设置 .setGoodsDetailList(goodsDetailList); AlipayF2FPrecreateResult result = tradeService.tradePrecreate(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝预下单成功: )&quot;); AlipayTradePrecreateResponse response = result.getResponse(); dumpResponse(response); // 需要修改为运行机器上的路径 String filePath = String.format(&quot;/Users/sudo/Desktop/qr-%s.png&quot;, response.getOutTradeNo()); log.info(&quot;filePath:&quot; + filePath); // ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath); break; case FAILED: log.error(&quot;支付宝预下单失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，预下单状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } } &nbsp; &nbsp; 重要部分我都做了标红，自己看就能理解。 &nbsp; &nbsp;如果大家把Main调通了就说明支付宝已经成功集成到项目中。 三、支付模块-一些其他注意事项 &nbsp; &nbsp; 如果需要在本地接收到支付宝的回调结果，需要用到natapp外网穿透，这个免费的通道已经不能用了，可以用付费的5元一个月，也不是很贵（付费的相当安全）。 &nbsp; &nbsp; 如果用了付费的，直接把里面的那个url改成自己的调试URL即可，这样支付宝就会走外网穿透将回调结果映射到这个url上，前端直接从这个url中拿到回调信息，如果不做外网穿透，前端就拿不到支付宝回调，这点大家注意一下。 写到这里，支付模块就介绍完了。我们会在订单模块中使用我们自己集成的支付宝服务来完成最后的功能开发。有不懂的欢迎留言，下期再见！！ 阅读更多" />
<meta property="og:description" content="一、支付模块开发-概述 &nbsp; &nbsp; 本项目使用的支付方式是支付宝支付，在后期会集成微信支付。为了方便大家集成支付宝，我把几篇必要的文章放到了一起。 沙箱登录：https://openhome.alipay.com/platform/appDaily.htm&nbsp; 沙箱环境使用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105311&amp;docType=1&nbsp; 如何使用沙箱环境：https://support.open.alipay.com/support/hotProblemDetail.htm?spm=a219a.7386793.0.0.uS5uZ6&amp;id=251932&amp;tagId=100248&nbsp; 当面付产品介绍：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105072&amp;docType=1&nbsp; 扫码支付接入指引：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.Ia6Wqy&amp;treeId=193&amp;articleId=106078&amp;docType=1&nbsp; 当面付快速接入：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.bROnXf&amp;treeId=193&amp;articleId=105170&amp;docType=1&nbsp; 当面付接入必读：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105322&amp;docType=1&nbsp; 当面付进阶功能：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.YFmkxI&amp;treeId=193&amp;articleId=105190&amp;docType=1&nbsp; 当面付异步通知-仅用于扫码支付：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.BykVSR&amp;treeId=193&amp;articleId=103296&amp;docType=1&nbsp; 当面付SDK&amp;DEMO：https://support.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.k0rwWc&amp;treeId=193&amp;articleId=105201&amp;docType=1&nbsp; 服务端SDK：https://doc.open.alipay.com/doc2/detail?treeId=54&amp;articleId=103419&amp;docType=1&nbsp; 生成RSA密钥：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1&nbsp; 线上创建应用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105310&amp;docType=1#s0 &nbsp; &nbsp; 集成支付宝支付需要用到沙箱环境，上面有沙箱的地址，点击进去登录即可，如果没有账号需要申请注册一个才能使用支付宝的沙箱环境。 登录进去以后首先会看到“必看部分”，APPID是自动生成的，支付宝网关都是一样的，这个是让我们把我们项目中的支付宝请求请求到该接口上，这样就会接到支付宝的回调。RSA2密钥是下载支付宝密钥生成器生成的。接下来是选看部分 商户UID也是自动生成的，授权回调地址就是支付宝的回调请求接口，这个是自己设置的。RSA密钥因为加密过于简单在实际的项目开发中已经不再使用了。如果需要手机支付宝进行调试，请下载手机支付宝沙箱版，支付宝官方会在沙箱账号中随机生成对应的卖家和买家账号信息 这里的所有信息都是自动生成的，在手机支付宝沙箱环境中请使用这里的账号进行登录。账户余额是随便设置的最高99999，不会有真实的交易产生。 以上就是集成支付宝的一些基本操作。 二、支付模块开发-集成支付宝的进一步设置 &nbsp; &nbsp;除了上述基本操作意外，为了方便，还需要把支付宝官网的Demo在自己的项目中调试通，这样可以直接在项目中调用调试好的Api，不用重新再进行配置 （1）alipay.demo.trade-&gt;DemoHbRunner /** * Created by liuyangkly on 15/10/23. 执行调度，主要任务由两个线程完成，交易线程（调用当面付2.0接口）和交易保障线程（轮询），具体需要做的事情 1.当面付程序每执行完一笔交易后将交易结果保存在临时队列 2.轮询线程读取临时队列，获取基础采集信息和最多30条trade_info信息，调用支付宝monitor.heartbeat.syn接口 示例代码仅封装了如何调用该接口api，采集数据，比如采集网络信息、交易耗时、异常信息等，需要系统商开发者自行完成。 */ public class DemoHbRunner extends AbsHbRunner { public DemoHbRunner(AlipayMonitorService monitorService) { super(monitorService); } @Override public String getAppAuthToken() { // 对于系统商，如果是为了商户开发监控保障接口，则需要传此值，否则如果为系统商自己做交易保障接口开发，则可不传。 return null; } @Override public AlipayHeartbeatSynRequestBuilder getBuilder() { // 系统商使用的交易信息格式，json字符串类型，从交易队列中获取 List&lt;SysTradeInfo&gt; sysTradeInfoList = HbQueue.poll(); // 异常信息的采集，系统商自行完成 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); // exceptionInfoList.add(ExceptionInfo.HE_SCANER); // exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // exceptionInfoList.add(ExceptionInfo.HE_OTHER); AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setProduct(Product.FP).setType(Type.CR).setEquipmentId(&quot;cr1000001&quot;) .setEquipmentStatus(EquipStatus.NORMAL).setTime(Utils.toDate(new Date())) .setStoreId(&quot;store10001&quot;).setMac(&quot;0a:00:27:00:00:00&quot;).setNetworkType(&quot;LAN&quot;) .setProviderId(&quot;你的pid&quot;) // 设置系统商pid .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息 .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 ; return builder; } } （2）&nbsp;alipay.demo.trade-&gt;main /** * 简单main函数，用于测试当面付api * sdk和demo的意见和问题反馈请联系：liuyang.kly@alipay.com */ public class Main { private static Log log = LogFactory.getLog(Main.class); // 支付宝当面付2.0服务 private static AlipayTradeService tradeService; // 支付宝当面付2.0服务（集成了交易保障接口逻辑） private static AlipayTradeService tradeWithHBService; // 支付宝交易保障接口服务，供测试接口api使用，请先阅读readme.txt private static AlipayMonitorService monitorService; static { /** 一定要在创建AlipayTradeService之前调用Configs.init()设置默认参数 * Configs会读取classpath下的zfbinfo.properties文件配置信息，如果找不到该文件则确认该文件是否在classpath目录 */ Configs.init(&quot;zfbinfo.properties&quot;); /** 使用Configs提供的默认参数 * AlipayTradeService可以使用单例或者为静态成员对象，不需要反复new */ tradeService = new AlipayTradeServiceImpl.ClientBuilder().build(); // 支付宝当面付2.0服务（集成了交易保障接口逻辑） tradeWithHBService = new AlipayTradeWithHBServiceImpl.ClientBuilder().build(); /** 如果需要在程序中覆盖Configs提供的默认参数, 可以使用ClientBuilder类的setXXX方法修改默认参数 否则使用代码中的默认设置 */ monitorService = new AlipayMonitorServiceImpl.ClientBuilder() .setGatewayUrl(&quot;http://mcloudmonitor.com/gateway.do&quot;).setCharset(&quot;GBK&quot;) .setFormat(&quot;json&quot;).build(); } // 简单打印应答 private void dumpResponse(AlipayResponse response) { if (response != null) { log.info(String.format(&quot;code:%s, msg:%s&quot;, response.getCode(), response.getMsg())); if (StringUtils.isNotEmpty(response.getSubCode())) { log.info(String.format(&quot;subCode:%s, subMsg:%s&quot;, response.getSubCode(), response.getSubMsg())); } log.info(&quot;body:&quot; + response.getBody()); } } public static void main(String[] args) { Main main = new Main(); // 系统商商测试交易保障接口api // main.test_monitor_sys(); // POS厂商测试交易保障接口api // main.test_monitor_pos(); // 测试交易保障接口调度 // main.test_monitor_schedule_logic(); // 测试当面付2.0支付（使用未集成交易保障接口的当面付2.0服务） // main.test_trade_pay(tradeService); // 测试查询当面付2.0交易 // main.test_trade_query(); // 测试当面付2.0退货 // main.test_trade_refund(); // 测试当面付2.0生成支付二维码 main.test_trade_precreate(); } // 测试系统商交易保障调度 public void test_monitor_schedule_logic() { // 启动交易保障线程 DemoHbRunner demoRunner = new DemoHbRunner(monitorService); demoRunner.setDelay(5); // 设置启动后延迟5秒开始调度，不设置则默认3秒 demoRunner.setDuration(10); // 设置间隔10秒进行调度，不设置则默认15 * 60秒 demoRunner.schedule(); // 启动当面付，此处每隔5秒调用一次支付接口，并且当随机数为0时交易保障线程退出 while (Math.random() != 0) { test_trade_pay(tradeWithHBService); Utils.sleep(5 * 1000); } // 满足退出条件后可以调用shutdown优雅安全退出 demoRunner.shutdown(); } // 系统商的调用样例，填写了所有系统商商需要填写的字段 public void test_monitor_sys() { // 系统商使用的交易信息格式，json字符串类型 List&lt;SysTradeInfo&gt; sysTradeInfoList = new ArrayList&lt;SysTradeInfo&gt;(); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000001&quot;, 5.2, HbStatus.S)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000002&quot;, 4.4, HbStatus.F)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000003&quot;, 11.3, HbStatus.P)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000004&quot;, 3.2, HbStatus.X)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000005&quot;, 4.1, HbStatus.X)); // 填写异常信息，如果有的话 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); exceptionInfoList.add(ExceptionInfo.HE_SCANER); // exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // exceptionInfoList.add(ExceptionInfo.HE_OTHER); // 填写扩展参数，如果有的话 Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;(); // extendInfo.put(&quot;SHOP_ID&quot;, &quot;BJ_ZZ_001&quot;); // extendInfo.put(&quot;TERMINAL_ID&quot;, &quot;1234&quot;); String appAuthToken = &quot;应用授权令牌&quot;;//根据真实值填写 AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setAppAuthToken(appAuthToken).setProduct(Product.FP).setType(Type.CR) .setEquipmentId(&quot;cr1000001&quot;).setEquipmentStatus(EquipStatus.NORMAL) .setTime(Utils.toDate(new Date())).setStoreId(&quot;store10001&quot;).setMac(&quot;0a:00:27:00:00:00&quot;) .setNetworkType(&quot;LAN&quot;).setProviderId(&quot;你的pid&quot;) // 设置系统商pid .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息 // .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话 ; MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder); dumpResponse(response); } // POS厂商的调用样例，填写了所有pos厂商需要填写的字段 public void test_monitor_pos() { // POS厂商使用的交易信息格式，字符串类型 List&lt;PosTradeInfo&gt; posTradeInfoList = new ArrayList&lt;PosTradeInfo&gt;(); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, &quot;1324&quot;, 7)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.X, &quot;1326&quot;, 15)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, &quot;1401&quot;, 8)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.F, &quot;1405&quot;, 3)); // 填写异常信息，如果有的话 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // 填写扩展参数，如果有的话 Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;(); // extendInfo.put(&quot;SHOP_ID&quot;, &quot;BJ_ZZ_001&quot;); // extendInfo.put(&quot;TERMINAL_ID&quot;, &quot;1234&quot;); AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setProduct(Product.FP) .setType(Type.SOFT_POS) .setEquipmentId(&quot;soft100001&quot;) .setEquipmentStatus(EquipStatus.NORMAL) .setTime(&quot;2015-09-28 11:14:49&quot;) .setManufacturerPid(&quot;2088000000000009&quot;) // 填写机具商的支付宝pid .setStoreId(&quot;store200001&quot;).setEquipmentPosition(&quot;31.2433190000,121.5090750000&quot;) .setBbsPosition(&quot;2869719733-065|2896507033-091&quot;).setNetworkStatus(&quot;gggbbbgggnnn&quot;) .setNetworkType(&quot;3G&quot;).setBattery(&quot;98&quot;).setWifiMac(&quot;0a:00:27:00:00:00&quot;) .setWifiName(&quot;test_wifi_name&quot;).setIp(&quot;192.168.1.188&quot;) .setPosTradeInfoList(posTradeInfoList) // POS厂商同步trade_info信息 // .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话 ; MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder); dumpResponse(response); } // 测试当面付2.0支付 public void test_trade_pay(AlipayTradeService service) { // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线， // 需保证商户系统端不能重复，建议通过数据库sequence生成， String outTradeNo = &quot;tradepay&quot; + System.currentTimeMillis() + (long) (Math.random() * 10000000L); // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店消费” String subject = &quot;xxx品牌xxx门店当面付消费&quot;; // (必填) 订单总金额，单位为元，不能超过1亿元 // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】 String totalAmount = &quot;0.01&quot;; // (必填) 付款条码，用户支付宝钱包手机app点击“付款”产生的付款条码 String authCode = &quot;用户自己的支付宝付款码&quot;; // 条码示例，286648048691290423 // (可选，根据需要决定是否使用) 订单可打折金额，可以配合商家平台配置折扣活动，如果订单部分商品参与打折，可以将部分商品总价填写至此字段，默认全部商品可打折 // 如果该值未传入,但传入了【订单总金额】,【不可打折金额】 则该值默认为【订单总金额】- 【不可打折金额】 // String discountableAmount = &quot;1.00&quot;; // // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段 // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】 String undiscountableAmount = &quot;0.0&quot;; // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = &quot;&quot;; // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品3件共20.00元&quot; String body = &quot;购买商品3件共20.00元&quot;; // 商户操作员编号，添加此参数可以为商户操作员做销售统计 String operatorId = &quot;test_operator_id&quot;; // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持 String providerId = &quot;你的系统商编号&quot;; ExtendParams extendParams = new ExtendParams(); extendParams.setSysServiceProviderId(providerId); // 支付超时，线下扫码交易定义为5分钟 String timeoutExpress = &quot;5m&quot;; // 商品明细列表，需填写购买商品详细信息， List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;(); // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail GoodsDetail goods1 = GoodsDetail.newInstance(&quot;goods_id001&quot;, &quot;xxx面包&quot;, 1000, 1); // 创建好一个商品后添加至商品明细列表 goodsDetailList.add(goods1); // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件 GoodsDetail goods2 = GoodsDetail.newInstance(&quot;goods_id002&quot;, &quot;xxx牙刷&quot;, 500, 2); goodsDetailList.add(goods2); String appAuthToken = &quot;应用授权令牌&quot;;//根据真实值填写 // 创建条码支付请求builder，设置请求参数 AlipayTradePayRequestBuilder builder = new AlipayTradePayRequestBuilder() // .setAppAuthToken(appAuthToken) .setOutTradeNo(outTradeNo).setSubject(subject).setAuthCode(authCode) .setTotalAmount(totalAmount).setStoreId(storeId) .setUndiscountableAmount(undiscountableAmount).setBody(body).setOperatorId(operatorId) .setExtendParams(extendParams).setSellerId(sellerId) .setGoodsDetailList(goodsDetailList).setTimeoutExpress(timeoutExpress); // 调用tradePay方法获取当面付应答 AlipayF2FPayResult result = service.tradePay(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝支付成功: )&quot;); break; case FAILED: log.error(&quot;支付宝支付失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0查询订单 public void test_trade_query() { // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // 创建查询请求builder，设置请求参数 AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder() .setOutTradeNo(outTradeNo); AlipayF2FQueryResult result = tradeService.queryTradeResult(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;查询返回该订单支付成功: )&quot;); AlipayTradeQueryResponse response = result.getResponse(); dumpResponse(response); log.info(response.getTradeStatus()); if (Utils.isListNotEmpty(response.getFundBillList())) { for (TradeFundBill bill : response.getFundBillList()) { log.info(bill.getFundChannel() + &quot;:&quot; + bill.getAmount()); } } break; case FAILED: log.error(&quot;查询返回该订单支付失败或被关闭!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单支付状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0退款 public void test_trade_refund() { // (必填) 外部订单号，需要退款交易的商户外部订单号 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // (必填) 退款金额，该金额必须小于等于订单的支付金额，单位为元 String refundAmount = &quot;0.01&quot;; // (可选，需要支持重复退货时必填) 商户退款请求号，相同支付宝交易号下的不同退款请求号对应同一笔交易的不同退款申请， // 对于相同支付宝交易号下多笔相同商户退款请求号的退款交易，支付宝只会进行一次退款 String outRequestNo = &quot;&quot;; // (必填) 退款原因，可以说明用户退款原因，方便为商家后台提供统计 String refundReason = &quot;正常退款，用户买多了&quot;; // (必填) 商户门店编号，退款情况下可以为商家后台提供退款权限判定和统计等作用，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 创建退款请求builder，设置请求参数 AlipayTradeRefundRequestBuilder builder = new AlipayTradeRefundRequestBuilder() .setOutTradeNo(outTradeNo).setRefundAmount(refundAmount).setRefundReason(refundReason) .setOutRequestNo(outRequestNo).setStoreId(storeId); AlipayF2FRefundResult result = tradeService.tradeRefund(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝退款成功: )&quot;); break; case FAILED: log.error(&quot;支付宝退款失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单退款状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0生成支付二维码 public void test_trade_precreate() { // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线， // 需保证商户系统端不能重复，建议通过数据库sequence生成， String outTradeNo = &quot;tradeprecreate&quot; + System.currentTimeMillis() + (long) (Math.random() * 10000000L); // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店当面付扫码消费” String subject = &quot;xxx品牌xxx门店当面付扫码消费&quot;; // (必填) 订单总金额，单位为元，不能超过1亿元 // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】 String totalAmount = &quot;0.01&quot;; // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段 // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】 String undiscountableAmount = &quot;0&quot;; // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = &quot;&quot;; // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品2件共15.00元&quot; String body = &quot;购买商品3件共20.00元&quot;; // 商户操作员编号，添加此参数可以为商户操作员做销售统计 String operatorId = &quot;test_operator_id&quot;; // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持 ExtendParams extendParams = new ExtendParams(); extendParams.setSysServiceProviderId(&quot;你的系统商编号&quot;); // 支付超时，定义为120分钟 String timeoutExpress = &quot;120m&quot;; // 商品明细列表，需填写购买商品详细信息， List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;(); // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail GoodsDetail goods1 = GoodsDetail.newInstance(&quot;goods_id001&quot;, &quot;xxx小面包&quot;, 1000, 1); // 创建好一个商品后添加至商品明细列表 goodsDetailList.add(goods1); // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件 GoodsDetail goods2 = GoodsDetail.newInstance(&quot;goods_id002&quot;, &quot;xxx牙刷&quot;, 500, 2); goodsDetailList.add(goods2); // 创建扫码支付请求builder，设置请求参数 AlipayTradePrecreateRequestBuilder builder = new AlipayTradePrecreateRequestBuilder() .setSubject(subject).setTotalAmount(totalAmount).setOutTradeNo(outTradeNo) .setUndiscountableAmount(undiscountableAmount).setSellerId(sellerId).setBody(body) .setOperatorId(operatorId).setStoreId(storeId).setExtendParams(extendParams) .setTimeoutExpress(timeoutExpress) // .setNotifyUrl(&quot;http://www.test-notify-url.com&quot;)//支付宝服务器主动通知商户服务器里指定的页面http路径,根据需要设置 .setGoodsDetailList(goodsDetailList); AlipayF2FPrecreateResult result = tradeService.tradePrecreate(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝预下单成功: )&quot;); AlipayTradePrecreateResponse response = result.getResponse(); dumpResponse(response); // 需要修改为运行机器上的路径 String filePath = String.format(&quot;/Users/sudo/Desktop/qr-%s.png&quot;, response.getOutTradeNo()); log.info(&quot;filePath:&quot; + filePath); // ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath); break; case FAILED: log.error(&quot;支付宝预下单失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，预下单状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } } &nbsp; &nbsp; 重要部分我都做了标红，自己看就能理解。 &nbsp; &nbsp;如果大家把Main调通了就说明支付宝已经成功集成到项目中。 三、支付模块-一些其他注意事项 &nbsp; &nbsp; 如果需要在本地接收到支付宝的回调结果，需要用到natapp外网穿透，这个免费的通道已经不能用了，可以用付费的5元一个月，也不是很贵（付费的相当安全）。 &nbsp; &nbsp; 如果用了付费的，直接把里面的那个url改成自己的调试URL即可，这样支付宝就会走外网穿透将回调结果映射到这个url上，前端直接从这个url中拿到回调信息，如果不做外网穿透，前端就拿不到支付宝回调，这点大家注意一下。 写到这里，支付模块就介绍完了。我们会在订单模块中使用我们自己集成的支付宝服务来完成最后的功能开发。有不懂的欢迎留言，下期再见！！ 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/02/27/87c3836fb8659021283e411bfa691552.html" />
<meta property="og:url" content="https://mlh.app/2018/02/27/87c3836fb8659021283e411bfa691552.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-02-27T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"一、支付模块开发-概述 &nbsp; &nbsp; 本项目使用的支付方式是支付宝支付，在后期会集成微信支付。为了方便大家集成支付宝，我把几篇必要的文章放到了一起。 沙箱登录：https://openhome.alipay.com/platform/appDaily.htm&nbsp; 沙箱环境使用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105311&amp;docType=1&nbsp; 如何使用沙箱环境：https://support.open.alipay.com/support/hotProblemDetail.htm?spm=a219a.7386793.0.0.uS5uZ6&amp;id=251932&amp;tagId=100248&nbsp; 当面付产品介绍：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105072&amp;docType=1&nbsp; 扫码支付接入指引：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.Ia6Wqy&amp;treeId=193&amp;articleId=106078&amp;docType=1&nbsp; 当面付快速接入：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.bROnXf&amp;treeId=193&amp;articleId=105170&amp;docType=1&nbsp; 当面付接入必读：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105322&amp;docType=1&nbsp; 当面付进阶功能：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.YFmkxI&amp;treeId=193&amp;articleId=105190&amp;docType=1&nbsp; 当面付异步通知-仅用于扫码支付：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.BykVSR&amp;treeId=193&amp;articleId=103296&amp;docType=1&nbsp; 当面付SDK&amp;DEMO：https://support.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.k0rwWc&amp;treeId=193&amp;articleId=105201&amp;docType=1&nbsp; 服务端SDK：https://doc.open.alipay.com/doc2/detail?treeId=54&amp;articleId=103419&amp;docType=1&nbsp; 生成RSA密钥：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1&nbsp; 线上创建应用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105310&amp;docType=1#s0 &nbsp; &nbsp; 集成支付宝支付需要用到沙箱环境，上面有沙箱的地址，点击进去登录即可，如果没有账号需要申请注册一个才能使用支付宝的沙箱环境。 登录进去以后首先会看到“必看部分”，APPID是自动生成的，支付宝网关都是一样的，这个是让我们把我们项目中的支付宝请求请求到该接口上，这样就会接到支付宝的回调。RSA2密钥是下载支付宝密钥生成器生成的。接下来是选看部分 商户UID也是自动生成的，授权回调地址就是支付宝的回调请求接口，这个是自己设置的。RSA密钥因为加密过于简单在实际的项目开发中已经不再使用了。如果需要手机支付宝进行调试，请下载手机支付宝沙箱版，支付宝官方会在沙箱账号中随机生成对应的卖家和买家账号信息 这里的所有信息都是自动生成的，在手机支付宝沙箱环境中请使用这里的账号进行登录。账户余额是随便设置的最高99999，不会有真实的交易产生。 以上就是集成支付宝的一些基本操作。 二、支付模块开发-集成支付宝的进一步设置 &nbsp; &nbsp;除了上述基本操作意外，为了方便，还需要把支付宝官网的Demo在自己的项目中调试通，这样可以直接在项目中调用调试好的Api，不用重新再进行配置 （1）alipay.demo.trade-&gt;DemoHbRunner /** * Created by liuyangkly on 15/10/23. 执行调度，主要任务由两个线程完成，交易线程（调用当面付2.0接口）和交易保障线程（轮询），具体需要做的事情 1.当面付程序每执行完一笔交易后将交易结果保存在临时队列 2.轮询线程读取临时队列，获取基础采集信息和最多30条trade_info信息，调用支付宝monitor.heartbeat.syn接口 示例代码仅封装了如何调用该接口api，采集数据，比如采集网络信息、交易耗时、异常信息等，需要系统商开发者自行完成。 */ public class DemoHbRunner extends AbsHbRunner { public DemoHbRunner(AlipayMonitorService monitorService) { super(monitorService); } @Override public String getAppAuthToken() { // 对于系统商，如果是为了商户开发监控保障接口，则需要传此值，否则如果为系统商自己做交易保障接口开发，则可不传。 return null; } @Override public AlipayHeartbeatSynRequestBuilder getBuilder() { // 系统商使用的交易信息格式，json字符串类型，从交易队列中获取 List&lt;SysTradeInfo&gt; sysTradeInfoList = HbQueue.poll(); // 异常信息的采集，系统商自行完成 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); // exceptionInfoList.add(ExceptionInfo.HE_SCANER); // exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // exceptionInfoList.add(ExceptionInfo.HE_OTHER); AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setProduct(Product.FP).setType(Type.CR).setEquipmentId(&quot;cr1000001&quot;) .setEquipmentStatus(EquipStatus.NORMAL).setTime(Utils.toDate(new Date())) .setStoreId(&quot;store10001&quot;).setMac(&quot;0a:00:27:00:00:00&quot;).setNetworkType(&quot;LAN&quot;) .setProviderId(&quot;你的pid&quot;) // 设置系统商pid .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息 .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 ; return builder; } } （2）&nbsp;alipay.demo.trade-&gt;main /** * 简单main函数，用于测试当面付api * sdk和demo的意见和问题反馈请联系：liuyang.kly@alipay.com */ public class Main { private static Log log = LogFactory.getLog(Main.class); // 支付宝当面付2.0服务 private static AlipayTradeService tradeService; // 支付宝当面付2.0服务（集成了交易保障接口逻辑） private static AlipayTradeService tradeWithHBService; // 支付宝交易保障接口服务，供测试接口api使用，请先阅读readme.txt private static AlipayMonitorService monitorService; static { /** 一定要在创建AlipayTradeService之前调用Configs.init()设置默认参数 * Configs会读取classpath下的zfbinfo.properties文件配置信息，如果找不到该文件则确认该文件是否在classpath目录 */ Configs.init(&quot;zfbinfo.properties&quot;); /** 使用Configs提供的默认参数 * AlipayTradeService可以使用单例或者为静态成员对象，不需要反复new */ tradeService = new AlipayTradeServiceImpl.ClientBuilder().build(); // 支付宝当面付2.0服务（集成了交易保障接口逻辑） tradeWithHBService = new AlipayTradeWithHBServiceImpl.ClientBuilder().build(); /** 如果需要在程序中覆盖Configs提供的默认参数, 可以使用ClientBuilder类的setXXX方法修改默认参数 否则使用代码中的默认设置 */ monitorService = new AlipayMonitorServiceImpl.ClientBuilder() .setGatewayUrl(&quot;http://mcloudmonitor.com/gateway.do&quot;).setCharset(&quot;GBK&quot;) .setFormat(&quot;json&quot;).build(); } // 简单打印应答 private void dumpResponse(AlipayResponse response) { if (response != null) { log.info(String.format(&quot;code:%s, msg:%s&quot;, response.getCode(), response.getMsg())); if (StringUtils.isNotEmpty(response.getSubCode())) { log.info(String.format(&quot;subCode:%s, subMsg:%s&quot;, response.getSubCode(), response.getSubMsg())); } log.info(&quot;body:&quot; + response.getBody()); } } public static void main(String[] args) { Main main = new Main(); // 系统商商测试交易保障接口api // main.test_monitor_sys(); // POS厂商测试交易保障接口api // main.test_monitor_pos(); // 测试交易保障接口调度 // main.test_monitor_schedule_logic(); // 测试当面付2.0支付（使用未集成交易保障接口的当面付2.0服务） // main.test_trade_pay(tradeService); // 测试查询当面付2.0交易 // main.test_trade_query(); // 测试当面付2.0退货 // main.test_trade_refund(); // 测试当面付2.0生成支付二维码 main.test_trade_precreate(); } // 测试系统商交易保障调度 public void test_monitor_schedule_logic() { // 启动交易保障线程 DemoHbRunner demoRunner = new DemoHbRunner(monitorService); demoRunner.setDelay(5); // 设置启动后延迟5秒开始调度，不设置则默认3秒 demoRunner.setDuration(10); // 设置间隔10秒进行调度，不设置则默认15 * 60秒 demoRunner.schedule(); // 启动当面付，此处每隔5秒调用一次支付接口，并且当随机数为0时交易保障线程退出 while (Math.random() != 0) { test_trade_pay(tradeWithHBService); Utils.sleep(5 * 1000); } // 满足退出条件后可以调用shutdown优雅安全退出 demoRunner.shutdown(); } // 系统商的调用样例，填写了所有系统商商需要填写的字段 public void test_monitor_sys() { // 系统商使用的交易信息格式，json字符串类型 List&lt;SysTradeInfo&gt; sysTradeInfoList = new ArrayList&lt;SysTradeInfo&gt;(); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000001&quot;, 5.2, HbStatus.S)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000002&quot;, 4.4, HbStatus.F)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000003&quot;, 11.3, HbStatus.P)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000004&quot;, 3.2, HbStatus.X)); sysTradeInfoList.add(SysTradeInfo.newInstance(&quot;00000005&quot;, 4.1, HbStatus.X)); // 填写异常信息，如果有的话 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); exceptionInfoList.add(ExceptionInfo.HE_SCANER); // exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // exceptionInfoList.add(ExceptionInfo.HE_OTHER); // 填写扩展参数，如果有的话 Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;(); // extendInfo.put(&quot;SHOP_ID&quot;, &quot;BJ_ZZ_001&quot;); // extendInfo.put(&quot;TERMINAL_ID&quot;, &quot;1234&quot;); String appAuthToken = &quot;应用授权令牌&quot;;//根据真实值填写 AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setAppAuthToken(appAuthToken).setProduct(Product.FP).setType(Type.CR) .setEquipmentId(&quot;cr1000001&quot;).setEquipmentStatus(EquipStatus.NORMAL) .setTime(Utils.toDate(new Date())).setStoreId(&quot;store10001&quot;).setMac(&quot;0a:00:27:00:00:00&quot;) .setNetworkType(&quot;LAN&quot;).setProviderId(&quot;你的pid&quot;) // 设置系统商pid .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息 // .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话 ; MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder); dumpResponse(response); } // POS厂商的调用样例，填写了所有pos厂商需要填写的字段 public void test_monitor_pos() { // POS厂商使用的交易信息格式，字符串类型 List&lt;PosTradeInfo&gt; posTradeInfoList = new ArrayList&lt;PosTradeInfo&gt;(); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, &quot;1324&quot;, 7)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.X, &quot;1326&quot;, 15)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, &quot;1401&quot;, 8)); posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.F, &quot;1405&quot;, 3)); // 填写异常信息，如果有的话 List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;(); exceptionInfoList.add(ExceptionInfo.HE_PRINTER); // 填写扩展参数，如果有的话 Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;(); // extendInfo.put(&quot;SHOP_ID&quot;, &quot;BJ_ZZ_001&quot;); // extendInfo.put(&quot;TERMINAL_ID&quot;, &quot;1234&quot;); AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder() .setProduct(Product.FP) .setType(Type.SOFT_POS) .setEquipmentId(&quot;soft100001&quot;) .setEquipmentStatus(EquipStatus.NORMAL) .setTime(&quot;2015-09-28 11:14:49&quot;) .setManufacturerPid(&quot;2088000000000009&quot;) // 填写机具商的支付宝pid .setStoreId(&quot;store200001&quot;).setEquipmentPosition(&quot;31.2433190000,121.5090750000&quot;) .setBbsPosition(&quot;2869719733-065|2896507033-091&quot;).setNetworkStatus(&quot;gggbbbgggnnn&quot;) .setNetworkType(&quot;3G&quot;).setBattery(&quot;98&quot;).setWifiMac(&quot;0a:00:27:00:00:00&quot;) .setWifiName(&quot;test_wifi_name&quot;).setIp(&quot;192.168.1.188&quot;) .setPosTradeInfoList(posTradeInfoList) // POS厂商同步trade_info信息 // .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话 .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话 ; MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder); dumpResponse(response); } // 测试当面付2.0支付 public void test_trade_pay(AlipayTradeService service) { // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线， // 需保证商户系统端不能重复，建议通过数据库sequence生成， String outTradeNo = &quot;tradepay&quot; + System.currentTimeMillis() + (long) (Math.random() * 10000000L); // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店消费” String subject = &quot;xxx品牌xxx门店当面付消费&quot;; // (必填) 订单总金额，单位为元，不能超过1亿元 // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】 String totalAmount = &quot;0.01&quot;; // (必填) 付款条码，用户支付宝钱包手机app点击“付款”产生的付款条码 String authCode = &quot;用户自己的支付宝付款码&quot;; // 条码示例，286648048691290423 // (可选，根据需要决定是否使用) 订单可打折金额，可以配合商家平台配置折扣活动，如果订单部分商品参与打折，可以将部分商品总价填写至此字段，默认全部商品可打折 // 如果该值未传入,但传入了【订单总金额】,【不可打折金额】 则该值默认为【订单总金额】- 【不可打折金额】 // String discountableAmount = &quot;1.00&quot;; // // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段 // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】 String undiscountableAmount = &quot;0.0&quot;; // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = &quot;&quot;; // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品3件共20.00元&quot; String body = &quot;购买商品3件共20.00元&quot;; // 商户操作员编号，添加此参数可以为商户操作员做销售统计 String operatorId = &quot;test_operator_id&quot;; // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持 String providerId = &quot;你的系统商编号&quot;; ExtendParams extendParams = new ExtendParams(); extendParams.setSysServiceProviderId(providerId); // 支付超时，线下扫码交易定义为5分钟 String timeoutExpress = &quot;5m&quot;; // 商品明细列表，需填写购买商品详细信息， List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;(); // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail GoodsDetail goods1 = GoodsDetail.newInstance(&quot;goods_id001&quot;, &quot;xxx面包&quot;, 1000, 1); // 创建好一个商品后添加至商品明细列表 goodsDetailList.add(goods1); // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件 GoodsDetail goods2 = GoodsDetail.newInstance(&quot;goods_id002&quot;, &quot;xxx牙刷&quot;, 500, 2); goodsDetailList.add(goods2); String appAuthToken = &quot;应用授权令牌&quot;;//根据真实值填写 // 创建条码支付请求builder，设置请求参数 AlipayTradePayRequestBuilder builder = new AlipayTradePayRequestBuilder() // .setAppAuthToken(appAuthToken) .setOutTradeNo(outTradeNo).setSubject(subject).setAuthCode(authCode) .setTotalAmount(totalAmount).setStoreId(storeId) .setUndiscountableAmount(undiscountableAmount).setBody(body).setOperatorId(operatorId) .setExtendParams(extendParams).setSellerId(sellerId) .setGoodsDetailList(goodsDetailList).setTimeoutExpress(timeoutExpress); // 调用tradePay方法获取当面付应答 AlipayF2FPayResult result = service.tradePay(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝支付成功: )&quot;); break; case FAILED: log.error(&quot;支付宝支付失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0查询订单 public void test_trade_query() { // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // 创建查询请求builder，设置请求参数 AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder() .setOutTradeNo(outTradeNo); AlipayF2FQueryResult result = tradeService.queryTradeResult(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;查询返回该订单支付成功: )&quot;); AlipayTradeQueryResponse response = result.getResponse(); dumpResponse(response); log.info(response.getTradeStatus()); if (Utils.isListNotEmpty(response.getFundBillList())) { for (TradeFundBill bill : response.getFundBillList()) { log.info(bill.getFundChannel() + &quot;:&quot; + bill.getAmount()); } } break; case FAILED: log.error(&quot;查询返回该订单支付失败或被关闭!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单支付状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0退款 public void test_trade_refund() { // (必填) 外部订单号，需要退款交易的商户外部订单号 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // (必填) 退款金额，该金额必须小于等于订单的支付金额，单位为元 String refundAmount = &quot;0.01&quot;; // (可选，需要支持重复退货时必填) 商户退款请求号，相同支付宝交易号下的不同退款请求号对应同一笔交易的不同退款申请， // 对于相同支付宝交易号下多笔相同商户退款请求号的退款交易，支付宝只会进行一次退款 String outRequestNo = &quot;&quot;; // (必填) 退款原因，可以说明用户退款原因，方便为商家后台提供统计 String refundReason = &quot;正常退款，用户买多了&quot;; // (必填) 商户门店编号，退款情况下可以为商家后台提供退款权限判定和统计等作用，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 创建退款请求builder，设置请求参数 AlipayTradeRefundRequestBuilder builder = new AlipayTradeRefundRequestBuilder() .setOutTradeNo(outTradeNo).setRefundAmount(refundAmount).setRefundReason(refundReason) .setOutRequestNo(outRequestNo).setStoreId(storeId); AlipayF2FRefundResult result = tradeService.tradeRefund(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝退款成功: )&quot;); break; case FAILED: log.error(&quot;支付宝退款失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单退款状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } // 测试当面付2.0生成支付二维码 public void test_trade_precreate() { // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线， // 需保证商户系统端不能重复，建议通过数据库sequence生成， String outTradeNo = &quot;tradeprecreate&quot; + System.currentTimeMillis() + (long) (Math.random() * 10000000L); // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店当面付扫码消费” String subject = &quot;xxx品牌xxx门店当面付扫码消费&quot;; // (必填) 订单总金额，单位为元，不能超过1亿元 // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】 String totalAmount = &quot;0.01&quot;; // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段 // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】 String undiscountableAmount = &quot;0&quot;; // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = &quot;&quot;; // 订单描述，可以对交易或商品进行一个详细地描述，比如填写&quot;购买商品2件共15.00元&quot; String body = &quot;购买商品3件共20.00元&quot;; // 商户操作员编号，添加此参数可以为商户操作员做销售统计 String operatorId = &quot;test_operator_id&quot;; // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持 String storeId = &quot;test_store_id&quot;; // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持 ExtendParams extendParams = new ExtendParams(); extendParams.setSysServiceProviderId(&quot;你的系统商编号&quot;); // 支付超时，定义为120分钟 String timeoutExpress = &quot;120m&quot;; // 商品明细列表，需填写购买商品详细信息， List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;(); // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail GoodsDetail goods1 = GoodsDetail.newInstance(&quot;goods_id001&quot;, &quot;xxx小面包&quot;, 1000, 1); // 创建好一个商品后添加至商品明细列表 goodsDetailList.add(goods1); // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件 GoodsDetail goods2 = GoodsDetail.newInstance(&quot;goods_id002&quot;, &quot;xxx牙刷&quot;, 500, 2); goodsDetailList.add(goods2); // 创建扫码支付请求builder，设置请求参数 AlipayTradePrecreateRequestBuilder builder = new AlipayTradePrecreateRequestBuilder() .setSubject(subject).setTotalAmount(totalAmount).setOutTradeNo(outTradeNo) .setUndiscountableAmount(undiscountableAmount).setSellerId(sellerId).setBody(body) .setOperatorId(operatorId).setStoreId(storeId).setExtendParams(extendParams) .setTimeoutExpress(timeoutExpress) // .setNotifyUrl(&quot;http://www.test-notify-url.com&quot;)//支付宝服务器主动通知商户服务器里指定的页面http路径,根据需要设置 .setGoodsDetailList(goodsDetailList); AlipayF2FPrecreateResult result = tradeService.tradePrecreate(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;支付宝预下单成功: )&quot;); AlipayTradePrecreateResponse response = result.getResponse(); dumpResponse(response); // 需要修改为运行机器上的路径 String filePath = String.format(&quot;/Users/sudo/Desktop/qr-%s.png&quot;, response.getOutTradeNo()); log.info(&quot;filePath:&quot; + filePath); // ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath); break; case FAILED: log.error(&quot;支付宝预下单失败!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，预下单状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } } &nbsp; &nbsp; 重要部分我都做了标红，自己看就能理解。 &nbsp; &nbsp;如果大家把Main调通了就说明支付宝已经成功集成到项目中。 三、支付模块-一些其他注意事项 &nbsp; &nbsp; 如果需要在本地接收到支付宝的回调结果，需要用到natapp外网穿透，这个免费的通道已经不能用了，可以用付费的5元一个月，也不是很贵（付费的相当安全）。 &nbsp; &nbsp; 如果用了付费的，直接把里面的那个url改成自己的调试URL即可，这样支付宝就会走外网穿透将回调结果映射到这个url上，前端直接从这个url中拿到回调信息，如果不做外网穿透，前端就拿不到支付宝回调，这点大家注意一下。 写到这里，支付模块就介绍完了。我们会在订单模块中使用我们自己集成的支付宝服务来完成最后的功能开发。有不懂的欢迎留言，下期再见！！ 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/02/27/87c3836fb8659021283e411bfa691552.html","headline":"电商平台搭建–支付模块开发","dateModified":"2018-02-27T00:00:00+08:00","datePublished":"2018-02-27T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/02/27/87c3836fb8659021283e411bfa691552.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>电商平台搭建--支付模块开发</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">一、支付模块开发-概述</span></p>
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">&nbsp; &nbsp; 本项目使用的支付方式是支付宝支付，在后期会集成微信支付。</span><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">为了方便大家集成支付宝，我把几篇必要的文章放到了一起。</span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">沙箱登录：https://openhome.alipay.com/platform/appDaily.htm&nbsp;</span></p>
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">沙箱环境使用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105311&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">如何使用沙箱环境：https://support.open.alipay.com/support/hotProblemDetail.htm?spm=a219a.7386793.0.0.uS5uZ6&amp;id=251932&amp;tagId=100248&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">当面付产品介绍：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105072&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">扫码支付接入指引：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.Ia6Wqy&amp;treeId=193&amp;articleId=106078&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">当面付快速接入：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.bROnXf&amp;treeId=193&amp;articleId=105170&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">当面付接入必读：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.hV5Clx&amp;treeId=193&amp;articleId=105322&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">当面付进阶功能：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.YFmkxI&amp;treeId=193&amp;articleId=105190&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">当面付异步通知-仅用于扫码支付：https://doc.open.alipay.com/docs/doc.htm?spm=a219a.7629140.0.0.BykVSR&amp;treeId=193&amp;articleId=103296&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">当面付SDK&amp;DEMO：https://support.open.alipay.com/docs/doc.htm?spm=a219a.7386797.0.0.k0rwWc&amp;treeId=193&amp;articleId=105201&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">服务端SDK：https://doc.open.alipay.com/doc2/detail?treeId=54&amp;articleId=103419&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">生成RSA密钥：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1&nbsp;</span>
  <br style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">线上创建应用说明：https://doc.open.alipay.com/doc2/detail.htm?treeId=200&amp;articleId=105310&amp;docType=1#s0</span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">&nbsp; &nbsp; 集成支付宝支付需要用到沙箱环境，上面有沙箱的地址，点击进去登录即可，如果没有账号需要申请注册一个才能使用支付宝的沙箱环境。</span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018022709205728" alt=""><br></span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">登录进去以后首先会看到“必看部分”，APPID是自动生成的，支付宝网关都是一样的，这个是让我们把我们项目中的支付宝请求请求到该接口上，这样就会接到支付宝的回调。RSA2密钥是下载支付宝密钥生成器生成的。接下来是选看部分</span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180227092414605" alt=""><br></span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">商户UID也是自动生成的，授权回调地址就是支付宝的回调请求接口，这个是自己设置的。RSA密钥因为加密过于简单在实际的项目开发中已经不再使用了。如果需要手机支付宝进行调试，请下载手机支付宝沙箱版，支付宝官方会在沙箱账号中随机生成对应的卖家和买家账号信息</span></p>
  <p><span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/2018022709403094" alt=""><br></span></p>
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">这里的所有信息都是自动生成的，在手机支付宝沙箱环境中请使用这里的账号进行登录。账户余额是随便设置的最高99999，不会有真实的交易产生。</span></p>
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">以上就是集成支付宝的一些基本操作。</span></p>
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">二、支付模块开发-集成支付宝的进一步设置</span></p>
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">&nbsp; &nbsp;除了上述基本操作意外，为了方便，还需要把支付宝官网的Demo在自己的项目中调试通，这样可以直接在项目中调用调试好的Api，不用重新再进行配置</span></p>
  <p><span style="font-family:Simsun;font-size:14px;color:#000000;">（1）alipay.demo.trade-&gt;DemoHbRunner</span></p>
  <pre><code class="language-java">/**
 * Created by liuyangkly on 15/10/23.
 执行调度，主要任务由两个线程完成，交易线程（调用当面付2.0接口）和交易保障线程（轮询），具体需要做的事情
 1.当面付程序每执行完一笔交易后将交易结果保存在临时队列
 2.轮询线程读取临时队列，获取基础采集信息和最多30条trade_info信息，调用支付宝monitor.heartbeat.syn接口
 示例代码仅封装了如何调用该接口api，采集数据，比如采集网络信息、交易耗时、异常信息等，需要系统商开发者自行完成。
 */
public class DemoHbRunner extends AbsHbRunner {

    public DemoHbRunner(AlipayMonitorService monitorService) {
        super(monitorService);
    }

    @Override
    public String getAppAuthToken() {
        // 对于系统商，如果是为了商户开发监控保障接口，则需要传此值，否则如果为系统商自己做交易保障接口开发，则可不传。
        return null;
    }

    @Override
    public AlipayHeartbeatSynRequestBuilder getBuilder() {
        // 系统商使用的交易信息格式，json字符串类型，从交易队列中获取
        List&lt;SysTradeInfo&gt; sysTradeInfoList = HbQueue.poll();

        // 异常信息的采集，系统商自行完成
        List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;();
        //        exceptionInfoList.add(ExceptionInfo.HE_SCANER);
        //        exceptionInfoList.add(ExceptionInfo.HE_PRINTER);
        //        exceptionInfoList.add(ExceptionInfo.HE_OTHER);

        AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder()
            .setProduct(Product.FP).setType(Type.CR).setEquipmentId("cr1000001")
            .setEquipmentStatus(EquipStatus.NORMAL).setTime(Utils.toDate(new Date()))
            .setStoreId("store10001").setMac("0a:00:27:00:00:00").setNetworkType("LAN")
            .setProviderId("你的pid") // 设置系统商pid
            .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息
            .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话
        ;
        return builder;
    }
}</code></pre>
  <p>（2）&nbsp;<span style="color:rgb(0,0,0);font-family:Simsun;font-size:14px;">alipay.demo.trade-&gt;main</span></p>
  <pre><code class="language-java">/**
 * 简单main函数，用于测试当面付api
 * sdk和demo的意见和问题反馈请联系：liuyang.kly@alipay.com
 */
public class Main {
    private static Log log = LogFactory.getLog(Main.class);

    // 支付宝当面付2.0服务
    private static AlipayTradeService   tradeService;

    // 支付宝当面付2.0服务（集成了交易保障接口逻辑）
    private static AlipayTradeService   tradeWithHBService;

    // 支付宝交易保障接口服务，供测试接口api使用，请先阅读readme.txt
    private static AlipayMonitorService monitorService;

    static {
        /** 一定要在创建AlipayTradeService之前调用Configs.init()设置默认参数
         *  Configs会读取classpath下的zfbinfo.properties文件配置信息，如果找不到该文件则确认该文件是否在classpath目录
         */
        Configs.init("zfbinfo.properties");

        /** 使用Configs提供的默认参数
         *  AlipayTradeService可以使用单例或者为静态成员对象，不需要反复new
         */
        tradeService = new AlipayTradeServiceImpl.ClientBuilder().build();

        // 支付宝当面付2.0服务（集成了交易保障接口逻辑）
        tradeWithHBService = new AlipayTradeWithHBServiceImpl.ClientBuilder().build();

        /** 如果需要在程序中覆盖Configs提供的默认参数, 可以使用ClientBuilder类的setXXX方法修改默认参数 否则使用代码中的默认设置 */
        monitorService = new AlipayMonitorServiceImpl.ClientBuilder()
            .setGatewayUrl("http://mcloudmonitor.com/gateway.do").setCharset("GBK")
            .setFormat("json").build();
    }

    // 简单打印应答
    private void dumpResponse(AlipayResponse response) {
        if (response != null) {
            log.info(String.format("code:%s, msg:%s", response.getCode(), response.getMsg()));
            if (StringUtils.isNotEmpty(response.getSubCode())) {
                log.info(String.format("subCode:%s, subMsg:%s", response.getSubCode(),
                    response.getSubMsg()));
            }
            log.info("body:" + response.getBody());
        }
    }

    public static void main(String[] args) {
        Main main = new Main();

        // 系统商商测试交易保障接口api
        //        main.test_monitor_sys();

        // POS厂商测试交易保障接口api
        //        main.test_monitor_pos();

        // 测试交易保障接口调度
        //        main.test_monitor_schedule_logic();

        // 测试当面付2.0支付（使用未集成交易保障接口的当面付2.0服务）
        //        main.test_trade_pay(tradeService);

        // 测试查询当面付2.0交易
        //        main.test_trade_query();

        // 测试当面付2.0退货
        //        main.test_trade_refund();

        // 测试当面付2.0生成支付二维码
        main.test_trade_precreate();
    }

    // 测试系统商交易保障调度
    public void test_monitor_schedule_logic() {
        // 启动交易保障线程
        DemoHbRunner demoRunner = new DemoHbRunner(monitorService);
        demoRunner.setDelay(5); // 设置启动后延迟5秒开始调度，不设置则默认3秒
        demoRunner.setDuration(10); // 设置间隔10秒进行调度，不设置则默认15 * 60秒
        demoRunner.schedule();

        // 启动当面付，此处每隔5秒调用一次支付接口，并且当随机数为0时交易保障线程退出
        while (Math.random() != 0) {
            test_trade_pay(tradeWithHBService);
            Utils.sleep(5 * 1000);
        }

        // 满足退出条件后可以调用shutdown优雅安全退出
        demoRunner.shutdown();
    }

    // 系统商的调用样例，填写了所有系统商商需要填写的字段
    public void test_monitor_sys() {
        // 系统商使用的交易信息格式，json字符串类型
        List&lt;SysTradeInfo&gt; sysTradeInfoList = new ArrayList&lt;SysTradeInfo&gt;();
        sysTradeInfoList.add(SysTradeInfo.newInstance("00000001", 5.2, HbStatus.S));
        sysTradeInfoList.add(SysTradeInfo.newInstance("00000002", 4.4, HbStatus.F));
        sysTradeInfoList.add(SysTradeInfo.newInstance("00000003", 11.3, HbStatus.P));
        sysTradeInfoList.add(SysTradeInfo.newInstance("00000004", 3.2, HbStatus.X));
        sysTradeInfoList.add(SysTradeInfo.newInstance("00000005", 4.1, HbStatus.X));

        // 填写异常信息，如果有的话
        List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;();
        exceptionInfoList.add(ExceptionInfo.HE_SCANER);
        //        exceptionInfoList.add(ExceptionInfo.HE_PRINTER);
        //        exceptionInfoList.add(ExceptionInfo.HE_OTHER);

        // 填写扩展参数，如果有的话
        Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;();
        //        extendInfo.put("SHOP_ID", "BJ_ZZ_001");
        //        extendInfo.put("TERMINAL_ID", "1234");

        String appAuthToken = "应用授权令牌";//根据真实值填写

        AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder()
            .setAppAuthToken(appAuthToken).setProduct(Product.FP).setType(Type.CR)
            .setEquipmentId("cr1000001").setEquipmentStatus(EquipStatus.NORMAL)
            .setTime(Utils.toDate(new Date())).setStoreId("store10001").setMac("0a:00:27:00:00:00")
            .setNetworkType("LAN").setProviderId("<span style="color:#ff0000;">你的pid</span>") // 设置系统商pid
            .setSysTradeInfoList(sysTradeInfoList) // 系统商同步trade_info信息
            //                .setExceptionInfoList(exceptionInfoList)  // 填写异常信息，如果有的话
            .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话
        ;

        MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder);
        dumpResponse(response);
    }

    // POS厂商的调用样例，填写了所有pos厂商需要填写的字段
    public void test_monitor_pos() {
        // POS厂商使用的交易信息格式，字符串类型
        List&lt;PosTradeInfo&gt; posTradeInfoList = new ArrayList&lt;PosTradeInfo&gt;();
        posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, "1324", 7));
        posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.X, "1326", 15));
        posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.S, "1401", 8));
        posTradeInfoList.add(PosTradeInfo.newInstance(HbStatus.F, "1405", 3));

        // 填写异常信息，如果有的话
        List&lt;ExceptionInfo&gt; exceptionInfoList = new ArrayList&lt;ExceptionInfo&gt;();
        exceptionInfoList.add(ExceptionInfo.HE_PRINTER);

        // 填写扩展参数，如果有的话
        Map&lt;String, Object&gt; extendInfo = new HashMap&lt;String, Object&gt;();
        //        extendInfo.put("SHOP_ID", "BJ_ZZ_001");
        //        extendInfo.put("TERMINAL_ID", "1234");

        AlipayHeartbeatSynRequestBuilder builder = new AlipayHeartbeatSynRequestBuilder()
            .setProduct(Product.FP)
            .setType(Type.SOFT_POS)
            .setEquipmentId("soft100001")
            .setEquipmentStatus(EquipStatus.NORMAL)
            .setTime("2015-09-28 11:14:49")
            .setManufacturerPid("2088000000000009")
            // 填写机具商的支付宝pid
            .setStoreId("store200001").setEquipmentPosition("31.2433190000,121.5090750000")
            .setBbsPosition("2869719733-065|2896507033-091").setNetworkStatus("gggbbbgggnnn")
            .setNetworkType("3G").setBattery("98").setWifiMac("0a:00:27:00:00:00")
            .setWifiName("test_wifi_name").setIp("192.168.1.188")
            .setPosTradeInfoList(posTradeInfoList) // POS厂商同步trade_info信息
            //                .setExceptionInfoList(exceptionInfoList) // 填写异常信息，如果有的话
            .setExtendInfo(extendInfo) // 填写扩展信息，如果有的话
        ;

        MonitorHeartbeatSynResponse response = monitorService.heartbeatSyn(builder);
        dumpResponse(response);
    }

    // 测试当面付2.0支付
    public void test_trade_pay(AlipayTradeService service) {
        // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线，
        // 需保证商户系统端不能重复，建议通过数据库sequence生成，
        String outTradeNo = "tradepay" + System.currentTimeMillis()
                            + (long) (Math.random() * 10000000L);

        // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店消费”
        String subject = "xxx品牌xxx门店当面付消费";

        // (必填) 订单总金额，单位为元，不能超过1亿元
        // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】
        String totalAmount = "0.01";

        // (必填) 付款条码，用户支付宝钱包手机app点击“付款”产生的付款条码
        String authCode = "<span style="color:#ff0000;">用户自己的支付宝付款码</span>"; // 条码示例，286648048691290423
        // (可选，根据需要决定是否使用) 订单可打折金额，可以配合商家平台配置折扣活动，如果订单部分商品参与打折，可以将部分商品总价填写至此字段，默认全部商品可打折
        // 如果该值未传入,但传入了【订单总金额】,【不可打折金额】 则该值默认为【订单总金额】- 【不可打折金额】
        //        String discountableAmount = "1.00"; //

        // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段
        // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】
        String undiscountableAmount = "0.0";

        <span style="color:#ff0000;">// 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号) // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID String sellerId = "";</span>

        // 订单描述，可以对交易或商品进行一个详细地描述，比如填写"购买商品3件共20.00元"
        String body = "购买商品3件共20.00元";

        // 商户操作员编号，添加此参数可以为商户操作员做销售统计
        String operatorId = "test_operator_id";

        // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持
        String storeId = "test_store_id";

        // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持
        String providerId = "<span style="color:#ff0000;">你的系统商编号</span>";
        ExtendParams extendParams = new ExtendParams();
        extendParams.setSysServiceProviderId(providerId);

        // 支付超时，线下扫码交易定义为5分钟
        String timeoutExpress = "5m";

        // 商品明细列表，需填写购买商品详细信息，
        List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;();
        // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail
        GoodsDetail goods1 = GoodsDetail.newInstance("goods_id001", "xxx面包", 1000, 1);
        // 创建好一个商品后添加至商品明细列表
        goodsDetailList.add(goods1);

        // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件
        GoodsDetail goods2 = GoodsDetail.newInstance("goods_id002", "xxx牙刷", 500, 2);
        goodsDetailList.add(goods2);

        String appAuthToken = "应用授权令牌";//根据真实值填写

        // 创建条码支付请求builder，设置请求参数
        AlipayTradePayRequestBuilder builder = new AlipayTradePayRequestBuilder()
            //            .setAppAuthToken(appAuthToken)
            .setOutTradeNo(outTradeNo).setSubject(subject).setAuthCode(authCode)
            .setTotalAmount(totalAmount).setStoreId(storeId)
            .setUndiscountableAmount(undiscountableAmount).setBody(body).setOperatorId(operatorId)
            .setExtendParams(extendParams).setSellerId(sellerId)
            .setGoodsDetailList(goodsDetailList).setTimeoutExpress(timeoutExpress);

        // 调用tradePay方法获取当面付应答
        AlipayF2FPayResult result = service.tradePay(builder);
        switch (result.getTradeStatus()) {
            case SUCCESS:
                log.info("支付宝支付成功: )");
                break;

            case FAILED:
                log.error("支付宝支付失败!!!");
                break;

            case UNKNOWN:
                log.error("系统异常，订单状态未知!!!");
                break;

            default:
                log.error("不支持的交易状态，交易返回异常!!!");
                break;
        }
    }

    // 测试当面付2.0查询订单
    public void test_trade_query() {
        // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态
        String outTradeNo = "tradepay14817938139942440181";

        // 创建查询请求builder，设置请求参数
        AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder()
            .setOutTradeNo(outTradeNo);

        AlipayF2FQueryResult result = tradeService.queryTradeResult(builder);
        switch (result.getTradeStatus()) {
            case SUCCESS:
                log.info("查询返回该订单支付成功: )");

                AlipayTradeQueryResponse response = result.getResponse();
                dumpResponse(response);

                log.info(response.getTradeStatus());
                if (Utils.isListNotEmpty(response.getFundBillList())) {
                    for (TradeFundBill bill : response.getFundBillList()) {
                        log.info(bill.getFundChannel() + ":" + bill.getAmount());
                    }
                }
                break;

            case FAILED:
                log.error("查询返回该订单支付失败或被关闭!!!");
                break;

            case UNKNOWN:
                log.error("系统异常，订单支付状态未知!!!");
                break;

            default:
                log.error("不支持的交易状态，交易返回异常!!!");
                break;
        }
    }

    // 测试当面付2.0退款
    public void test_trade_refund() {
        // (必填) 外部订单号，需要退款交易的商户外部订单号
        String outTradeNo = "tradepay14817938139942440181";

        // (必填) 退款金额，该金额必须小于等于订单的支付金额，单位为元
        String refundAmount = "0.01";

        // (可选，需要支持重复退货时必填) 商户退款请求号，相同支付宝交易号下的不同退款请求号对应同一笔交易的不同退款申请，
        // 对于相同支付宝交易号下多笔相同商户退款请求号的退款交易，支付宝只会进行一次退款
        String outRequestNo = "";

        // (必填) 退款原因，可以说明用户退款原因，方便为商家后台提供统计
        String refundReason = "正常退款，用户买多了";

        // (必填) 商户门店编号，退款情况下可以为商家后台提供退款权限判定和统计等作用，详询支付宝技术支持
        String storeId = "test_store_id";

        // 创建退款请求builder，设置请求参数
        AlipayTradeRefundRequestBuilder builder = new AlipayTradeRefundRequestBuilder()
            .setOutTradeNo(outTradeNo).setRefundAmount(refundAmount).setRefundReason(refundReason)
            .setOutRequestNo(outRequestNo).setStoreId(storeId);

        AlipayF2FRefundResult result = tradeService.tradeRefund(builder);
        switch (result.getTradeStatus()) {
            case SUCCESS:
                log.info("支付宝退款成功: )");
                break;

            case FAILED:
                log.error("支付宝退款失败!!!");
                break;

            case UNKNOWN:
                log.error("系统异常，订单退款状态未知!!!");
                break;

            default:
                log.error("不支持的交易状态，交易返回异常!!!");
                break;
        }
    }

    // 测试当面付2.0生成支付二维码
    public void test_trade_precreate() {
        // (必填) 商户网站订单系统中唯一订单号，64个字符以内，只能包含字母、数字、下划线，
        // 需保证商户系统端不能重复，建议通过数据库sequence生成，
        String outTradeNo = "tradeprecreate" + System.currentTimeMillis()
                            + (long) (Math.random() * 10000000L);

        // (必填) 订单标题，粗略描述用户的支付目的。如“xxx品牌xxx门店当面付扫码消费”
        String subject = "xxx品牌xxx门店当面付扫码消费";

        // (必填) 订单总金额，单位为元，不能超过1亿元
        // 如果同时传入了【打折金额】,【不可打折金额】,【订单总金额】三者,则必须满足如下条件:【订单总金额】=【打折金额】+【不可打折金额】
        String totalAmount = "0.01";

        // (可选) 订单不可打折金额，可以配合商家平台配置折扣活动，如果酒水不参与打折，则将对应金额填写至此字段
        // 如果该值未传入,但传入了【订单总金额】,【打折金额】,则该值默认为【订单总金额】-【打折金额】
        String undiscountableAmount = "0";

        // 卖家支付宝账号ID，用于支持一个签约账号下支持打款到不同的收款账号，(打款到sellerId对应的支付宝账号)
        // 如果该字段为空，则默认为与支付宝签约的商户的PID，也就是appid对应的PID
        String sellerId = "";

        // 订单描述，可以对交易或商品进行一个详细地描述，比如填写"购买商品2件共15.00元"
        String body = "购买商品3件共20.00元";

        // 商户操作员编号，添加此参数可以为商户操作员做销售统计
        String operatorId = "test_operator_id";

        // (必填) 商户门店编号，通过门店号和商家后台可以配置精准到门店的折扣信息，详询支付宝技术支持
        String storeId = "test_store_id";

        // 业务扩展参数，目前可添加由支付宝分配的系统商编号(通过setSysServiceProviderId方法)，详情请咨询支付宝技术支持
        ExtendParams extendParams = new ExtendParams();
        extendParams.setSysServiceProviderId("<span style="color:#ff0000;">你的系统商编号</span>");

        // 支付超时，定义为120分钟
        String timeoutExpress = "120m";

        // 商品明细列表，需填写购买商品详细信息，
        List&lt;GoodsDetail&gt; goodsDetailList = new ArrayList&lt;GoodsDetail&gt;();
        // 创建一个商品信息，参数含义分别为商品id（使用国标）、名称、单价（单位为分）、数量，如果需要添加商品类别，详见GoodsDetail
        GoodsDetail goods1 = GoodsDetail.newInstance("goods_id001", "xxx小面包", 1000, 1);
        // 创建好一个商品后添加至商品明细列表
        goodsDetailList.add(goods1);

        // 继续创建并添加第一条商品信息，用户购买的产品为“黑人牙刷”，单价为5.00元，购买了两件
        GoodsDetail goods2 = GoodsDetail.newInstance("goods_id002", "xxx牙刷", 500, 2);
        goodsDetailList.add(goods2);

        // 创建扫码支付请求builder，设置请求参数
        AlipayTradePrecreateRequestBuilder builder = new AlipayTradePrecreateRequestBuilder()
            .setSubject(subject).setTotalAmount(totalAmount).setOutTradeNo(outTradeNo)
            .setUndiscountableAmount(undiscountableAmount).setSellerId(sellerId).setBody(body)
            .setOperatorId(operatorId).setStoreId(storeId).setExtendParams(extendParams)
            .setTimeoutExpress(timeoutExpress)
            //                .setNotifyUrl("http://www.test-notify-url.com")//支付宝服务器主动通知商户服务器里指定的页面http路径,根据需要设置
            .setGoodsDetailList(goodsDetailList);

        AlipayF2FPrecreateResult result = tradeService.tradePrecreate(builder);
        switch (result.getTradeStatus()) {
            case SUCCESS:
                log.info("支付宝预下单成功: )");

                AlipayTradePrecreateResponse response = result.getResponse();
                dumpResponse(response);

                // 需要修改为运行机器上的路径
                String filePath = String.format("/Users/sudo/Desktop/qr-%s.png",
                    response.getOutTradeNo());
                log.info("filePath:" + filePath);
                //                ZxingUtils.getQRCodeImge(response.getQrCode(), 256, filePath);
                break;

            case FAILED:
                log.error("支付宝预下单失败!!!");
                break;

            case UNKNOWN:
                log.error("系统异常，预下单状态未知!!!");
                break;

            default:
                log.error("不支持的交易状态，交易返回异常!!!");
                break;
        }
    }
}</code></pre>
  <p>&nbsp; &nbsp; 重要部分我都做了标红，自己看就能理解。</p>
  <p>&nbsp; &nbsp;如果大家把Main调通了就说明支付宝已经成功集成到项目中。</p>
  <p>三、支付模块-一些其他注意事项</p>
  <p>&nbsp; &nbsp; 如果需要在本地接收到支付宝的回调结果，需要用到natapp外网穿透，这个免费的通道已经不能用了，可以用付费的5元一个月，也不是很贵（付费的相当安全）。</p>
  <p>&nbsp; &nbsp; 如果用了付费的，直接把里面的那个url改成自己的调试URL即可，这样支付宝就会走外网穿透将回调结果映射到这个url上，前端直接从这个url中拿到回调信息，如果不做外网穿透，前端就拿不到支付宝回调，这点大家注意一下。</p>
  <p>写到这里，支付模块就介绍完了。我们会在订单模块中使用我们自己集成的支付宝服务来完成最后的功能开发。有不懂的欢迎留言，下期再见！！</p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq_36314960/article/details/79383570,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq_36314960/article/details/79383570,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
