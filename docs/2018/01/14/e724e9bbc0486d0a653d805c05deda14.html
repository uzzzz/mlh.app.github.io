<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>一步步教你开发、部署第一个去中心化应用 - 宠物商店 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="一步步教你开发、部署第一个去中心化应用 - 宠物商店" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="今天我们来编写一个完整的去中心化应用（Dapps）, 本文可以和编写智能合约结合起来看。 写在前面 阅读本文前，你应该对以太坊、智能合约有所了解，如果你还不了解，建议你先看以太坊是什么 除此之外，你最好还了解一些HTML及JavaScript知识。 本文通过实例教大家来开发去中心化应用，应用效果如图： 从本文，你可以学习到： * 搭建智能合约开发环境 * 创建Truffle项目 * 编写智能合约 * 编译和部署智能合约到区块链 * 如何通过Web3和智能合约交互 * MetaMask 的使用 小专栏用户在教程结尾处可以下载完整的Dapp代码。 项目背景 Pete有一个宠物店，有16只宠物，他想开发一个去中心化应用，让大家来领养宠物。 在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。 环境搭建 安装Node 安装 Truffle ：npm install -g truffle 安装Ganache Ganache（或Ganache CLI）已经取代了 testrpc。 创建项目 建立项目目录并进入 &gt; mkdir pet-shop-tutorial &gt; cd pet-shop-tutorial 使用truffle unbox 创建项目 &gt; truffle unbox pet-shop Downloading... Unpacking... Setting up... Unbox successful. Sweet! Commands: Compile: truffle compile Migrate: truffle migrate Test contracts: truffle test Run dev server: npm run dev 这一步需要等待一会 也可以使用truffle init 来创建一个全新的项目。 项目目录结构 contracts/ 智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲） migrations/ 用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。 test/ 智能合约测试用例文件夹 truffle.js/ 配置文件 其他代码可以暂时不用管 编写智能合约 智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读 [solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/） 在contracts目录下，添加合约文件Adoption.sol pragma solidity ^0.4.17; contract Adoption { address[16] public adopters; // 保存领养者的地址 // 领养宠物 function adopt(uint petId) public returns (uint) { require(petId &gt;= 0 &amp;&amp; petId &lt;= 15); // 确保id在数组长度内 adopters[petId] = msg.sender; // 保存调用这地址 return petId; } // 返回领养者 function getAdopters() public view returns (address[16]) { return adopters; } } 编译部署智能合约 Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。 编译 Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。 dapp的根目录pet-shop-tutorial下， &gt; truffle compile 输出 Compiling ./contracts/Adoption.sol... Writing artifacts to ./build/contracts 部署 编译之后，就可以部署到区块链上。 在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。 Migrations.sol 用来确保不会部署相同的合约。 现在我们来创建一个自己的部署脚本2_deploy_contracts.js var Adoption = artifacts.require(&quot;Adoption&quot;); module.exports = function(deployer) { deployer.deploy(Adoption); }; 在执行部署之前，需要确保有一个区块链运行, 可以使用 Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 Ganache 启动之后是这样： 接下来执行部署命令: &gt; truffle migrate 执行后，有一下类似的输出， Using network &#39;develop&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0 Saving successful migration to network... ... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying Adoption... ... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4 Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10 Saving successful migration to network... ... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0 Saving artifacts... 在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 这时说明已经智能合约已经部署好了。 测试 现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。 在test目录下新建一个TestAdoption.sol，编写测试合约 pragma solidity ^0.4.17; import &quot;truffle/Assert.sol&quot;; // 引入的断言 import &quot;truffle/DeployedAddresses.sol&quot;; // 用来获取被测试合约的地址 import &quot;../contracts/Adoption.sol&quot;; // 被测试合约 contract TestAdoption { Adoption adoption = Adoption(DeployedAddresses.Adoption()); // 领养测试用例 function testUserCanAdoptPet() public { uint returnedId = adoption.adopt(8); uint expected = 8; Assert.equal(returnedId, expected, &quot;Adoption of pet ID 8 should be recorded.&quot;); } // 宠物所有者测试用例 function testGetAdopterAddressByPetId() public { // 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易， address expected = this; address adopter = adoption.adopters(8); Assert.equal(adopter, expected, &quot;Owner of pet ID 8 should be recorded.&quot;); } // 测试所有领养者 function testGetAdopterAddressByPetIdInArray() public { // 领养者的地址就是本合约地址 address expected = this; address[16] memory adopters = adoption.getAdopters(); Assert.equal(adopters[8], expected, &quot;Owner of pet ID 8 should be recorded.&quot;); } } Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。 TestAdoption合约中添加adopt的测试用例 运行测试用例 在终端中，执行 truffle test 如果测试通过，则终端输出： Using network &#39;develop&#39;. Compiling ./contracts/Adoption.sol... Compiling ./test/TestAdoption.sol... Compiling truffle/Assert.sol... Compiling truffle/DeployedAddresses.sol... TestAdoption ✓ testUserCanAdoptPet (62ms) ✓ testGetAdopterAddressByPetId (53ms) ✓ testGetAdopterAddressByPetIdInArray (73ms) 3 passing (554ms) 创建用户接口和智能合约交互 我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。 在Truffle Box pet-shop里，已经包含了应用的前端代码，代码在src/文件夹下。 在编辑器中打开src/js/app.js 可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3. web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。 初始化web3 接下来，我们来编辑app.js修改initWeb3(): 删除注释，修改为： initWeb3: function() { // Is there an injected web3 instance? if (typeof web3 !== &#39;undefined&#39;) { App.web3Provider = web3.currentProvider; } else { // If no injected web3 instance is detected, fall back to Ganache App.web3Provider = new Web3.providers.HttpProvider(&#39;http://localhost:7545&#39;); } web3 = new Web3(App.web3Provider); return App.initContract(); } 代码中优先使用Mist 或 MetaMask提供的web3实例，如果没有则从本地环境创建一个。 实例化合约 使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下： initContract: function() { // 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息 $.getJSON(&#39;Adoption.json&#39;, function(data) { // 用Adoption.json数据创建一个可交互的TruffleContract合约实例。 var AdoptionArtifact = data; App.contracts.Adoption = TruffleContract(AdoptionArtifact); // Set the provider for our contract App.contracts.Adoption.setProvider(App.web3Provider); // Use our contract to retrieve and mark the adopted pets return App.markAdopted(); }); return App.bindEvents(); } 处理领养 修改markAdopted()代码： markAdopted: function(adopters, account) { var adoptionInstance; App.contracts.Adoption.deployed().then(function(instance) { adoptionInstance = instance; // 调用合约的getAdopters(), 用call读取信息不用消耗gas return adoptionInstance.getAdopters.call(); }).then(function(adopters) { for (i = 0; i &lt; adopters.length; i++) { if (adopters[i] !== &#39;0x0000000000000000000000000000000000000000&#39;) { $(&#39;.panel-pet&#39;).eq(i).find(&#39;button&#39;).text(&#39;Success&#39;).attr(&#39;disabled&#39;, true); } } }).catch(function(err) { console.log(err.message); }); } 修改handleAdopt()代码： handleAdopt: function(event) { event.preventDefault(); var petId = parseInt($(event.target).data(&#39;id&#39;)); var adoptionInstance; // 获取用户账号 web3.eth.getAccounts(function(error, accounts) { if (error) { console.log(error); } var account = accounts[0]; App.contracts.Adoption.deployed().then(function(instance) { adoptionInstance = instance; // 发送交易领养宠物 return adoptionInstance.adopt(petId, {from: account}); }).then(function(result) { return App.markAdopted(); }).catch(function(err) { console.log(err.message); }); }); } 在浏览器中运行 安装 MetaMask MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。 配置钱包 在接受隐私说明后，会出现页面如下： 这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的* Import Existing DEN*，输入Ganache显示的助记词。 candy maple cake sugar pudding cream honey rich smooth crumble sweet treat 然后自己想要的密码，点击OK。 如图： 连接开发区块链网络 默认连接的是以太坊主网（左上角显示），选择Custom RPC，添加一个网络：http://127.0.0.1:7545，点返回后，显示如下： 这是左上角显示为Private Network，账号是Ganache中默认的第一个账号。 至此MetaMask的安装，配置已经完成。 安装和配置lite-server 接下来需要本地的web 服务器提供服务的访问， Truffle Box pet-shop里提供了一个lite-server可以直接使用，我们看看它是如何工作的。 bs-config.json指示了lite-server的工作目录。 { &quot;server&quot;: { &quot;baseDir&quot;: [&quot;./src&quot;, &quot;./build/contracts&quot;] } } ./src 是网站文件目录 ./build/contracts 是合约输出目录 以此同时，在package.json文件的scripts中添加了dev命令： &quot;scripts&quot;: { &quot;dev&quot;: &quot;lite-server&quot;, &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot; }, 当运行npm run dev的时候，就会启动lite-server 启动服务 &gt; npm run dev 会自动打开浏览器显示我们的dapp，如本文的第一张图。 现在领养一直宠物看看，当我们点击Adopt时，MetaMask会提示我们交易的确认，如图： 点击Submit确认后，就可以看到成功领养了这次宠物。 在MetaMask中，也可以看到交易的清单： 好了，恭喜你，即将成为一名去中心化式应用开发者的你已经成为迈出了坚实的一步。 有问题来我的知识星球交流吧。 参考文档 Truffle手册 深入浅出区块链 - 系统学习区块链，打造最好的区块链技术博客。 阅读更多" />
<meta property="og:description" content="今天我们来编写一个完整的去中心化应用（Dapps）, 本文可以和编写智能合约结合起来看。 写在前面 阅读本文前，你应该对以太坊、智能合约有所了解，如果你还不了解，建议你先看以太坊是什么 除此之外，你最好还了解一些HTML及JavaScript知识。 本文通过实例教大家来开发去中心化应用，应用效果如图： 从本文，你可以学习到： * 搭建智能合约开发环境 * 创建Truffle项目 * 编写智能合约 * 编译和部署智能合约到区块链 * 如何通过Web3和智能合约交互 * MetaMask 的使用 小专栏用户在教程结尾处可以下载完整的Dapp代码。 项目背景 Pete有一个宠物店，有16只宠物，他想开发一个去中心化应用，让大家来领养宠物。 在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。 环境搭建 安装Node 安装 Truffle ：npm install -g truffle 安装Ganache Ganache（或Ganache CLI）已经取代了 testrpc。 创建项目 建立项目目录并进入 &gt; mkdir pet-shop-tutorial &gt; cd pet-shop-tutorial 使用truffle unbox 创建项目 &gt; truffle unbox pet-shop Downloading... Unpacking... Setting up... Unbox successful. Sweet! Commands: Compile: truffle compile Migrate: truffle migrate Test contracts: truffle test Run dev server: npm run dev 这一步需要等待一会 也可以使用truffle init 来创建一个全新的项目。 项目目录结构 contracts/ 智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲） migrations/ 用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。 test/ 智能合约测试用例文件夹 truffle.js/ 配置文件 其他代码可以暂时不用管 编写智能合约 智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读 [solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/） 在contracts目录下，添加合约文件Adoption.sol pragma solidity ^0.4.17; contract Adoption { address[16] public adopters; // 保存领养者的地址 // 领养宠物 function adopt(uint petId) public returns (uint) { require(petId &gt;= 0 &amp;&amp; petId &lt;= 15); // 确保id在数组长度内 adopters[petId] = msg.sender; // 保存调用这地址 return petId; } // 返回领养者 function getAdopters() public view returns (address[16]) { return adopters; } } 编译部署智能合约 Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。 编译 Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。 dapp的根目录pet-shop-tutorial下， &gt; truffle compile 输出 Compiling ./contracts/Adoption.sol... Writing artifacts to ./build/contracts 部署 编译之后，就可以部署到区块链上。 在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。 Migrations.sol 用来确保不会部署相同的合约。 现在我们来创建一个自己的部署脚本2_deploy_contracts.js var Adoption = artifacts.require(&quot;Adoption&quot;); module.exports = function(deployer) { deployer.deploy(Adoption); }; 在执行部署之前，需要确保有一个区块链运行, 可以使用 Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 Ganache 启动之后是这样： 接下来执行部署命令: &gt; truffle migrate 执行后，有一下类似的输出， Using network &#39;develop&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0 Saving successful migration to network... ... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying Adoption... ... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4 Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10 Saving successful migration to network... ... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0 Saving artifacts... 在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 这时说明已经智能合约已经部署好了。 测试 现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。 在test目录下新建一个TestAdoption.sol，编写测试合约 pragma solidity ^0.4.17; import &quot;truffle/Assert.sol&quot;; // 引入的断言 import &quot;truffle/DeployedAddresses.sol&quot;; // 用来获取被测试合约的地址 import &quot;../contracts/Adoption.sol&quot;; // 被测试合约 contract TestAdoption { Adoption adoption = Adoption(DeployedAddresses.Adoption()); // 领养测试用例 function testUserCanAdoptPet() public { uint returnedId = adoption.adopt(8); uint expected = 8; Assert.equal(returnedId, expected, &quot;Adoption of pet ID 8 should be recorded.&quot;); } // 宠物所有者测试用例 function testGetAdopterAddressByPetId() public { // 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易， address expected = this; address adopter = adoption.adopters(8); Assert.equal(adopter, expected, &quot;Owner of pet ID 8 should be recorded.&quot;); } // 测试所有领养者 function testGetAdopterAddressByPetIdInArray() public { // 领养者的地址就是本合约地址 address expected = this; address[16] memory adopters = adoption.getAdopters(); Assert.equal(adopters[8], expected, &quot;Owner of pet ID 8 should be recorded.&quot;); } } Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。 TestAdoption合约中添加adopt的测试用例 运行测试用例 在终端中，执行 truffle test 如果测试通过，则终端输出： Using network &#39;develop&#39;. Compiling ./contracts/Adoption.sol... Compiling ./test/TestAdoption.sol... Compiling truffle/Assert.sol... Compiling truffle/DeployedAddresses.sol... TestAdoption ✓ testUserCanAdoptPet (62ms) ✓ testGetAdopterAddressByPetId (53ms) ✓ testGetAdopterAddressByPetIdInArray (73ms) 3 passing (554ms) 创建用户接口和智能合约交互 我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。 在Truffle Box pet-shop里，已经包含了应用的前端代码，代码在src/文件夹下。 在编辑器中打开src/js/app.js 可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3. web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。 初始化web3 接下来，我们来编辑app.js修改initWeb3(): 删除注释，修改为： initWeb3: function() { // Is there an injected web3 instance? if (typeof web3 !== &#39;undefined&#39;) { App.web3Provider = web3.currentProvider; } else { // If no injected web3 instance is detected, fall back to Ganache App.web3Provider = new Web3.providers.HttpProvider(&#39;http://localhost:7545&#39;); } web3 = new Web3(App.web3Provider); return App.initContract(); } 代码中优先使用Mist 或 MetaMask提供的web3实例，如果没有则从本地环境创建一个。 实例化合约 使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下： initContract: function() { // 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息 $.getJSON(&#39;Adoption.json&#39;, function(data) { // 用Adoption.json数据创建一个可交互的TruffleContract合约实例。 var AdoptionArtifact = data; App.contracts.Adoption = TruffleContract(AdoptionArtifact); // Set the provider for our contract App.contracts.Adoption.setProvider(App.web3Provider); // Use our contract to retrieve and mark the adopted pets return App.markAdopted(); }); return App.bindEvents(); } 处理领养 修改markAdopted()代码： markAdopted: function(adopters, account) { var adoptionInstance; App.contracts.Adoption.deployed().then(function(instance) { adoptionInstance = instance; // 调用合约的getAdopters(), 用call读取信息不用消耗gas return adoptionInstance.getAdopters.call(); }).then(function(adopters) { for (i = 0; i &lt; adopters.length; i++) { if (adopters[i] !== &#39;0x0000000000000000000000000000000000000000&#39;) { $(&#39;.panel-pet&#39;).eq(i).find(&#39;button&#39;).text(&#39;Success&#39;).attr(&#39;disabled&#39;, true); } } }).catch(function(err) { console.log(err.message); }); } 修改handleAdopt()代码： handleAdopt: function(event) { event.preventDefault(); var petId = parseInt($(event.target).data(&#39;id&#39;)); var adoptionInstance; // 获取用户账号 web3.eth.getAccounts(function(error, accounts) { if (error) { console.log(error); } var account = accounts[0]; App.contracts.Adoption.deployed().then(function(instance) { adoptionInstance = instance; // 发送交易领养宠物 return adoptionInstance.adopt(petId, {from: account}); }).then(function(result) { return App.markAdopted(); }).catch(function(err) { console.log(err.message); }); }); } 在浏览器中运行 安装 MetaMask MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。 配置钱包 在接受隐私说明后，会出现页面如下： 这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的* Import Existing DEN*，输入Ganache显示的助记词。 candy maple cake sugar pudding cream honey rich smooth crumble sweet treat 然后自己想要的密码，点击OK。 如图： 连接开发区块链网络 默认连接的是以太坊主网（左上角显示），选择Custom RPC，添加一个网络：http://127.0.0.1:7545，点返回后，显示如下： 这是左上角显示为Private Network，账号是Ganache中默认的第一个账号。 至此MetaMask的安装，配置已经完成。 安装和配置lite-server 接下来需要本地的web 服务器提供服务的访问， Truffle Box pet-shop里提供了一个lite-server可以直接使用，我们看看它是如何工作的。 bs-config.json指示了lite-server的工作目录。 { &quot;server&quot;: { &quot;baseDir&quot;: [&quot;./src&quot;, &quot;./build/contracts&quot;] } } ./src 是网站文件目录 ./build/contracts 是合约输出目录 以此同时，在package.json文件的scripts中添加了dev命令： &quot;scripts&quot;: { &quot;dev&quot;: &quot;lite-server&quot;, &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot; }, 当运行npm run dev的时候，就会启动lite-server 启动服务 &gt; npm run dev 会自动打开浏览器显示我们的dapp，如本文的第一张图。 现在领养一直宠物看看，当我们点击Adopt时，MetaMask会提示我们交易的确认，如图： 点击Submit确认后，就可以看到成功领养了这次宠物。 在MetaMask中，也可以看到交易的清单： 好了，恭喜你，即将成为一名去中心化式应用开发者的你已经成为迈出了坚实的一步。 有问题来我的知识星球交流吧。 参考文档 Truffle手册 深入浅出区块链 - 系统学习区块链，打造最好的区块链技术博客。 阅读更多" />
<link rel="canonical" href="https://mlh.app/2018/01/14/e724e9bbc0486d0a653d805c05deda14.html" />
<meta property="og:url" content="https://mlh.app/2018/01/14/e724e9bbc0486d0a653d805c05deda14.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-01-14T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"今天我们来编写一个完整的去中心化应用（Dapps）, 本文可以和编写智能合约结合起来看。 写在前面 阅读本文前，你应该对以太坊、智能合约有所了解，如果你还不了解，建议你先看以太坊是什么 除此之外，你最好还了解一些HTML及JavaScript知识。 本文通过实例教大家来开发去中心化应用，应用效果如图： 从本文，你可以学习到： * 搭建智能合约开发环境 * 创建Truffle项目 * 编写智能合约 * 编译和部署智能合约到区块链 * 如何通过Web3和智能合约交互 * MetaMask 的使用 小专栏用户在教程结尾处可以下载完整的Dapp代码。 项目背景 Pete有一个宠物店，有16只宠物，他想开发一个去中心化应用，让大家来领养宠物。 在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。 环境搭建 安装Node 安装 Truffle ：npm install -g truffle 安装Ganache Ganache（或Ganache CLI）已经取代了 testrpc。 创建项目 建立项目目录并进入 &gt; mkdir pet-shop-tutorial &gt; cd pet-shop-tutorial 使用truffle unbox 创建项目 &gt; truffle unbox pet-shop Downloading... Unpacking... Setting up... Unbox successful. Sweet! Commands: Compile: truffle compile Migrate: truffle migrate Test contracts: truffle test Run dev server: npm run dev 这一步需要等待一会 也可以使用truffle init 来创建一个全新的项目。 项目目录结构 contracts/ 智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲） migrations/ 用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。 test/ 智能合约测试用例文件夹 truffle.js/ 配置文件 其他代码可以暂时不用管 编写智能合约 智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读 [solidity系列文章]（https://learnblockchain.cn/categories/ethereum/Solidity/） 在contracts目录下，添加合约文件Adoption.sol pragma solidity ^0.4.17; contract Adoption { address[16] public adopters; // 保存领养者的地址 // 领养宠物 function adopt(uint petId) public returns (uint) { require(petId &gt;= 0 &amp;&amp; petId &lt;= 15); // 确保id在数组长度内 adopters[petId] = msg.sender; // 保存调用这地址 return petId; } // 返回领养者 function getAdopters() public view returns (address[16]) { return adopters; } } 编译部署智能合约 Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。 编译 Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。 dapp的根目录pet-shop-tutorial下， &gt; truffle compile 输出 Compiling ./contracts/Adoption.sol... Writing artifacts to ./build/contracts 部署 编译之后，就可以部署到区块链上。 在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。 Migrations.sol 用来确保不会部署相同的合约。 现在我们来创建一个自己的部署脚本2_deploy_contracts.js var Adoption = artifacts.require(&quot;Adoption&quot;); module.exports = function(deployer) { deployer.deploy(Adoption); }; 在执行部署之前，需要确保有一个区块链运行, 可以使用 Ganache来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 Ganache 启动之后是这样： 接下来执行部署命令: &gt; truffle migrate 执行后，有一下类似的输出， Using network &#39;develop&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f Migrations: 0x8cdaf0cd259887258bc13a92c0a6da92698644c0 Saving successful migration to network... ... 0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying Adoption... ... 0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4 Adoption: 0x345ca3e014aaf5dca488057592ee47305d9b3e10 Saving successful migration to network... ... 0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0 Saving artifacts... 在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 这时说明已经智能合约已经部署好了。 测试 现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。 在test目录下新建一个TestAdoption.sol，编写测试合约 pragma solidity ^0.4.17; import &quot;truffle/Assert.sol&quot;; // 引入的断言 import &quot;truffle/DeployedAddresses.sol&quot;; // 用来获取被测试合约的地址 import &quot;../contracts/Adoption.sol&quot;; // 被测试合约 contract TestAdoption { Adoption adoption = Adoption(DeployedAddresses.Adoption()); // 领养测试用例 function testUserCanAdoptPet() public { uint returnedId = adoption.adopt(8); uint expected = 8; Assert.equal(returnedId, expected, &quot;Adoption of pet ID 8 should be recorded.&quot;); } // 宠物所有者测试用例 function testGetAdopterAddressByPetId() public { // 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易， address expected = this; address adopter = adoption.adopters(8); Assert.equal(adopter, expected, &quot;Owner of pet ID 8 should be recorded.&quot;); } // 测试所有领养者 function testGetAdopterAddressByPetIdInArray() public { // 领养者的地址就是本合约地址 address expected = this; address[16] memory adopters = adoption.getAdopters(); Assert.equal(adopters[8], expected, &quot;Owner of pet ID 8 should be recorded.&quot;); } } Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。 TestAdoption合约中添加adopt的测试用例 运行测试用例 在终端中，执行 truffle test 如果测试通过，则终端输出： Using network &#39;develop&#39;. Compiling ./contracts/Adoption.sol... Compiling ./test/TestAdoption.sol... Compiling truffle/Assert.sol... Compiling truffle/DeployedAddresses.sol... TestAdoption ✓ testUserCanAdoptPet (62ms) ✓ testGetAdopterAddressByPetId (53ms) ✓ testGetAdopterAddressByPetIdInArray (73ms) 3 passing (554ms) 创建用户接口和智能合约交互 我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。 在Truffle Box pet-shop里，已经包含了应用的前端代码，代码在src/文件夹下。 在编辑器中打开src/js/app.js 可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化web3. web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。 初始化web3 接下来，我们来编辑app.js修改initWeb3(): 删除注释，修改为： initWeb3: function() { // Is there an injected web3 instance? if (typeof web3 !== &#39;undefined&#39;) { App.web3Provider = web3.currentProvider; } else { // If no injected web3 instance is detected, fall back to Ganache App.web3Provider = new Web3.providers.HttpProvider(&#39;http://localhost:7545&#39;); } web3 = new Web3(App.web3Provider); return App.initContract(); } 代码中优先使用Mist 或 MetaMask提供的web3实例，如果没有则从本地环境创建一个。 实例化合约 使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下： initContract: function() { // 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息 $.getJSON(&#39;Adoption.json&#39;, function(data) { // 用Adoption.json数据创建一个可交互的TruffleContract合约实例。 var AdoptionArtifact = data; App.contracts.Adoption = TruffleContract(AdoptionArtifact); // Set the provider for our contract App.contracts.Adoption.setProvider(App.web3Provider); // Use our contract to retrieve and mark the adopted pets return App.markAdopted(); }); return App.bindEvents(); } 处理领养 修改markAdopted()代码： markAdopted: function(adopters, account) { var adoptionInstance; App.contracts.Adoption.deployed().then(function(instance) { adoptionInstance = instance; // 调用合约的getAdopters(), 用call读取信息不用消耗gas return adoptionInstance.getAdopters.call(); }).then(function(adopters) { for (i = 0; i &lt; adopters.length; i++) { if (adopters[i] !== &#39;0x0000000000000000000000000000000000000000&#39;) { $(&#39;.panel-pet&#39;).eq(i).find(&#39;button&#39;).text(&#39;Success&#39;).attr(&#39;disabled&#39;, true); } } }).catch(function(err) { console.log(err.message); }); } 修改handleAdopt()代码： handleAdopt: function(event) { event.preventDefault(); var petId = parseInt($(event.target).data(&#39;id&#39;)); var adoptionInstance; // 获取用户账号 web3.eth.getAccounts(function(error, accounts) { if (error) { console.log(error); } var account = accounts[0]; App.contracts.Adoption.deployed().then(function(instance) { adoptionInstance = instance; // 发送交易领养宠物 return adoptionInstance.adopt(petId, {from: account}); }).then(function(result) { return App.markAdopted(); }).catch(function(err) { console.log(err.message); }); }); } 在浏览器中运行 安装 MetaMask MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此链接安装，安装完成后，浏览器工具条会显示一个小狐狸图标。 配置钱包 在接受隐私说明后，会出现页面如下： 这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的* Import Existing DEN*，输入Ganache显示的助记词。 candy maple cake sugar pudding cream honey rich smooth crumble sweet treat 然后自己想要的密码，点击OK。 如图： 连接开发区块链网络 默认连接的是以太坊主网（左上角显示），选择Custom RPC，添加一个网络：http://127.0.0.1:7545，点返回后，显示如下： 这是左上角显示为Private Network，账号是Ganache中默认的第一个账号。 至此MetaMask的安装，配置已经完成。 安装和配置lite-server 接下来需要本地的web 服务器提供服务的访问， Truffle Box pet-shop里提供了一个lite-server可以直接使用，我们看看它是如何工作的。 bs-config.json指示了lite-server的工作目录。 { &quot;server&quot;: { &quot;baseDir&quot;: [&quot;./src&quot;, &quot;./build/contracts&quot;] } } ./src 是网站文件目录 ./build/contracts 是合约输出目录 以此同时，在package.json文件的scripts中添加了dev命令： &quot;scripts&quot;: { &quot;dev&quot;: &quot;lite-server&quot;, &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot; }, 当运行npm run dev的时候，就会启动lite-server 启动服务 &gt; npm run dev 会自动打开浏览器显示我们的dapp，如本文的第一张图。 现在领养一直宠物看看，当我们点击Adopt时，MetaMask会提示我们交易的确认，如图： 点击Submit确认后，就可以看到成功领养了这次宠物。 在MetaMask中，也可以看到交易的清单： 好了，恭喜你，即将成为一名去中心化式应用开发者的你已经成为迈出了坚实的一步。 有问题来我的知识星球交流吧。 参考文档 Truffle手册 深入浅出区块链 - 系统学习区块链，打造最好的区块链技术博客。 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2018/01/14/e724e9bbc0486d0a653d805c05deda14.html","headline":"一步步教你开发、部署第一个去中心化应用 - 宠物商店","dateModified":"2018-01-14T00:00:00+08:00","datePublished":"2018-01-14T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2018/01/14/e724e9bbc0486d0a653d805c05deda14.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>一步步教你开发、部署第一个去中心化应用 - 宠物商店</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <p>今天我们来编写一个完整的去中心化应用（Dapps）, 本文可以和<a href="https://learnblockchain.cn/2017/11/24/init-env/" rel="nofollow">编写智能合约</a>结合起来看。</p> 
  <h2 id="写在前面">写在前面</h2> 
  <p>阅读本文前，你应该对以太坊、智能合约有所了解，如果你还不了解，建议你先看<a href="https://learnblockchain.cn/2017/11/20/whatiseth/" rel="nofollow">以太坊是什么</a> <br> 除此之外，你最好还了解一些HTML及JavaScript知识。</p> 
  <p>本文通过实例教大家来开发去中心化应用，应用效果如图： <br> <img src="https://learnblockchain.cn/images/Petshop.jpg" alt="" title=""></p> 
  <p>从本文，你可以学习到： <br> * 搭建智能合约开发环境 <br> * 创建Truffle项目 <br> * 编写智能合约 <br> * 编译和部署智能合约到区块链 <br> * 如何通过Web3和智能合约交互 <br> * MetaMask 的使用</p> 
  <p><a href="https://xiaozhuanlan.com/blockchaincore" rel="nofollow">小专栏</a>用户在教程结尾处可以下载完整的Dapp代码。</p> 
  <h2 id="项目背景">项目背景</h2> 
  <p>Pete有一个宠物店，有16只宠物，他想开发一个去中心化应用，让大家来领养宠物。 <br> 在truffle box中，已经提供了pet-shop的网站部分的代码，我们只需要编写合约及交互部分。</p> 
  <h2 id="环境搭建">环境搭建</h2> 
  <ol> 
   <li>安装<a href="https://nodejs.org/en/download/" rel="nofollow">Node</a></li> 
   <li>安装 Truffle ：<code>npm install -g truffle</code></li> 
   <li>安装<a href="http://truffleframework.com/ganache/" rel="nofollow">Ganache</a></li> 
  </ol> 
  <blockquote> 
   <p>Ganache（或Ganache CLI）已经取代了 testrpc。</p> 
  </blockquote> 
  <h2 id="创建项目">创建项目</h2> 
  <ol> 
   <li>建立项目目录并进入</li> 
  </ol> 
  <pre class="prettyprint"><code class="language-shell hljs lasso"><span class="hljs-subst">&gt;</span> mkdir pet<span class="hljs-attribute">-shop</span><span class="hljs-attribute">-tutorial</span>
<span class="hljs-subst">&gt;</span> cd pet<span class="hljs-attribute">-shop</span><span class="hljs-attribute">-tutorial</span></code></pre> 
  <ol> 
   <li>使用truffle unbox 创建项目</li> 
  </ol> 
  <pre class="prettyprint"><code class="language-shell hljs lasso"> <span class="hljs-subst">&gt;</span> truffle unbox pet<span class="hljs-attribute">-shop</span>
 Downloading<span class="hljs-attribute">...</span>
 Unpacking<span class="hljs-attribute">...</span>
 Setting up<span class="hljs-attribute">...</span>
 Unbox successful<span class="hljs-built_in">.</span> Sweet<span class="hljs-subst">!</span>

Commands:

  Compile:        truffle compile
  Migrate:        truffle migrate
  Test contracts: truffle test
  Run dev server: npm run dev</code></pre> 
  <p>这一步需要等待一会</p> 
  <blockquote> 
   <p>也可以使用truffle init 来创建一个全新的项目。</p> 
  </blockquote> 
  <h2 id="项目目录结构">项目目录结构</h2> 
  <p><code>contracts/</code> 智能合约的文件夹，所有的智能合约文件都放置在这里，里面包含一个重要的合约Migrations.sol（稍后再讲） <br> <code>migrations/</code> 用来处理部署（迁移）智能合约 ，迁移是一个额外特别的合约用来保存合约的变化。 <br> <code>test/</code> 智能合约测试用例文件夹 <br> <code>truffle.js/</code> 配置文件</p> 
  <p>其他代码可以暂时不用管</p> 
  <h2 id="编写智能合约">编写智能合约</h2> 
  <p>智能合约承担着分布式应用的后台逻辑和存储。智能合约使用solidity编写，可阅读 <br> [solidity系列文章]（<a href="https://learnblockchain.cn/categories/ethereum/Solidity/" rel="nofollow">https://learnblockchain.cn/categories/ethereum/Solidity/</a>）</p> 
  <p>在contracts目录下，添加合约文件Adoption.sol</p> 
  <pre class="prettyprint"><code class="language-js hljs ">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.17</span>;

contract Adoption {

  address[<span class="hljs-number">16</span>] public adopters;  <span class="hljs-comment">// 保存领养者的地址</span>

    <span class="hljs-comment">// 领养宠物</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">adopt</span><span class="hljs-params">(uint petId)</span> <span class="hljs-title">public</span> <span class="hljs-title">returns</span> <span class="hljs-params">(uint)</span> {</span>
    <span class="hljs-built_in">require</span>(petId &gt;= <span class="hljs-number">0</span> &amp;&amp; petId &lt;= <span class="hljs-number">15</span>);  <span class="hljs-comment">// 确保id在数组长度内</span>

    adopters[petId] = msg.sender;        <span class="hljs-comment">// 保存调用这地址 </span>
    <span class="hljs-keyword">return</span> petId;
  }

  <span class="hljs-comment">// 返回领养者</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getAdopters</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> <span class="hljs-params">(address[16])</span> {</span>
    <span class="hljs-keyword">return</span> adopters;
  }

}</code></pre> 
  <h2 id="编译部署智能合约">编译部署智能合约</h2> 
  <p>Truffle集成了一个开发者控制台，可用来生成一个开发链用来测试和部署智能合约。</p> 
  <h3 id="编译">编译</h3> 
  <p>Solidity是编译型语言，需要把可读的Solidity代码编译为EVM字节码才能运行。 <br> dapp的根目录pet-shop-tutorial下，</p> 
  <pre class="prettyprint"><code class="language-shell hljs markdown"><span class="hljs-blockquote">&gt; truffle compile</span></code></pre> 
  <p>输出</p> 
  <pre class="prettyprint"><code class=" hljs lasso">Compiling <span class="hljs-built_in">.</span>/contracts/Adoption<span class="hljs-built_in">.</span>sol<span class="hljs-attribute">...</span>
Writing artifacts <span class="hljs-keyword">to</span> <span class="hljs-built_in">.</span>/build/contracts</code></pre> 
  <h3 id="部署">部署</h3> 
  <p>编译之后，就可以部署到区块链上。 <br> 在migrations文件夹下已经有一个1_initial_migration.js部署脚本，用来部署Migrations.sol合约。 <br> Migrations.sol 用来确保不会部署相同的合约。</p> 
  <p>现在我们来创建一个自己的部署脚本<code>2_deploy_contracts.js</code></p> 
  <pre class="prettyprint"><code class=" hljs lua">var Adoption = artifacts.<span class="hljs-built_in">require</span>(<span class="hljs-string">"Adoption"</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deployer)</span></span> {
  deployer.deploy(Adoption);
};</code></pre> 
  <p>在执行部署之前，需要确保有一个区块链运行, 可以使用 <br> <a href="http://truffleframework.com/ganache/" rel="nofollow">Ganache</a>来开启一个私链来进行开发测试，默认会在7545端口上运行一个开发链。 <br> Ganache 启动之后是这样： <br> <img src="https://learnblockchain.cn/images/ganache-initial.png" alt="" title=""></p> 
  <p>接下来执行部署命令:</p> 
  <pre class="prettyprint"><code class="language-bash hljs ">&gt; truffle  migrate</code></pre> 
  <p>执行后，有一下类似的输出，</p> 
  <pre class="prettyprint"><code class=" hljs r">Using network <span class="hljs-string">'develop'</span>.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x3076b7dac65afc44ec51508bf6f2b6894f833f0f9560ecad2d6d41ed98a4679f</span>
  Migrations: <span class="hljs-number">0x8cdaf0cd259887258bc13a92c0a6da92698644c0</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0xd7bc86d31bee32fa3988f1c1eabce403a1b5d570340a3a9cdba53a472ee8c956</span>
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying Adoption...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x2c6ab4471c225b5473f2079ee42ca1356007e51d5bb57eb80bfeb406acc35cd4</span>
  Adoption: <span class="hljs-number">0x345ca3e014aaf5dca488057592ee47305d9b3e10</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0xf36163615f41ef7ed8f4a8f192149a0bf633fe1a2398ce001bf44c43dc7bdda0</span>
Saving artifacts...</code></pre> 
  <p>在打开的Ganache里可以看到区块链状态的变化，现在产生了4个区块。 <br> <img src="https://learnblockchain.cn/images/ganache-migrated.png" alt="" title=""> <br> 这时说明已经智能合约已经部署好了。</p> 
  <h2 id="测试">测试</h2> 
  <p>现在我们来测试一下智能合约，测试用例可以用 JavaScript or Solidity来编写，这里使用Solidity。</p> 
  <p>在<code>test</code>目录下新建一个<code>TestAdoption.sol</code>，编写测试合约</p> 
  <pre class="prettyprint"><code class="language-js hljs ">
pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.17</span>;

import <span class="hljs-string">"truffle/Assert.sol"</span>;   <span class="hljs-comment">// 引入的断言</span>
import <span class="hljs-string">"truffle/DeployedAddresses.sol"</span>;  <span class="hljs-comment">// 用来获取被测试合约的地址</span>
import <span class="hljs-string">"../contracts/Adoption.sol"</span>;      <span class="hljs-comment">// 被测试合约</span>

contract TestAdoption {
  Adoption adoption = Adoption(DeployedAddresses.Adoption());

  <span class="hljs-comment">// 领养测试用例</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testUserCanAdoptPet</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> {</span>
    uint returnedId = adoption.adopt(<span class="hljs-number">8</span>);

    uint expected = <span class="hljs-number">8</span>;
    Assert.equal(returnedId, expected, <span class="hljs-string">"Adoption of pet ID 8 should be recorded."</span>);
  }

  <span class="hljs-comment">// 宠物所有者测试用例</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetAdopterAddressByPetId</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> {</span>
    <span class="hljs-comment">// 期望领养者的地址就是本合约地址，因为交易是由测试合约发起交易，</span>
    address expected = <span class="hljs-keyword">this</span>;
    address adopter = adoption.adopters(<span class="hljs-number">8</span>);
    Assert.equal(adopter, expected, <span class="hljs-string">"Owner of pet ID 8 should be recorded."</span>);
  }

    <span class="hljs-comment">// 测试所有领养者</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testGetAdopterAddressByPetIdInArray</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> {</span>
  <span class="hljs-comment">// 领养者的地址就是本合约地址</span>
    address expected = <span class="hljs-keyword">this</span>;
    address[<span class="hljs-number">16</span>] memory adopters = adoption.getAdopters();
    Assert.equal(adopters[<span class="hljs-number">8</span>], expected, <span class="hljs-string">"Owner of pet ID 8 should be recorded."</span>);
  }
}</code></pre> 
  <p>Assert.sol 及 DeployedAddresses.sol是Truffle框架提供，在test目录下并不提供truffle目录。</p> 
  <p>TestAdoption合约中添加adopt的测试用例</p> 
  <h3 id="运行测试用例">运行测试用例</h3> 
  <p>在终端中，执行</p> 
  <pre class="prettyprint"><code class="language-bash hljs ">truffle test</code></pre> 
  <p>如果测试通过，则终端输出：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">Using network <span class="hljs-string">'develop'</span><span class="hljs-built_in">.</span>

Compiling <span class="hljs-built_in">.</span>/contracts/Adoption<span class="hljs-built_in">.</span>sol<span class="hljs-attribute">...</span>
Compiling <span class="hljs-built_in">.</span>/test/TestAdoption<span class="hljs-built_in">.</span>sol<span class="hljs-attribute">...</span>
Compiling truffle/Assert<span class="hljs-built_in">.</span>sol<span class="hljs-attribute">...</span>
Compiling truffle/DeployedAddresses<span class="hljs-built_in">.</span>sol<span class="hljs-attribute">...</span>


  TestAdoption
    ✓ testUserCanAdoptPet (<span class="hljs-number">62</span>ms)
    ✓ testGetAdopterAddressByPetId (<span class="hljs-number">53</span>ms)
    ✓ testGetAdopterAddressByPetIdInArray (<span class="hljs-number">73</span>ms)


  <span class="hljs-number">3</span> passing (<span class="hljs-number">554</span>ms)
</code></pre> 
  <h2 id="创建用户接口和智能合约交互">创建用户接口和智能合约交互</h2> 
  <p>我们已经编写和部署及测试好了我们的合约，接下我们为合约编写UI，让合约真正可以用起来。</p> 
  <p>在Truffle Box <code>pet-shop</code>里，已经包含了应用的前端代码，代码在<code>src/</code>文件夹下。</p> 
  <p>在编辑器中打开<code>src/js/app.js</code> <br> 可以看到用来管理整个应用的App对象，init函数加载宠物信息，就初始化<a href="https://github.com/ethereum/web3.js/" rel="nofollow">web3</a>. <br> web3是一个实现了与以太坊节点通信的库，我们利用web3来和合约进行交互。</p> 
  <h3 id="初始化web3">初始化web3</h3> 
  <p>接下来，我们来编辑app.js修改initWeb3(): <br> 删除注释，修改为：</p> 
  <pre class="prettyprint"><code class="language-js hljs ">  initWeb3: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">// Is there an injected web3 instance?</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> web3 !== <span class="hljs-string">'undefined'</span>) {
      App.web3Provider = web3.currentProvider;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// If no injected web3 instance is detected, fall back to Ganache</span>
      App.web3Provider = <span class="hljs-keyword">new</span> Web3.providers.HttpProvider(<span class="hljs-string">'http://localhost:7545'</span>);
    }
    web3 = <span class="hljs-keyword">new</span> Web3(App.web3Provider);

    <span class="hljs-keyword">return</span> App.initContract();
  }</code></pre> 
  <p>代码中优先使用<a href="https://github.com/ethereum/mist" rel="nofollow">Mist</a> 或 <a href="https://metamask.io/" rel="nofollow">MetaMask</a>提供的web3实例，如果没有则从本地环境创建一个。</p> 
  <h3 id="实例化合约">实例化合约</h3> 
  <p>使用truffle-contract会帮我们保存合约部署的信息，就不需要我们手动修改合约地址，修改initContract()代码如下：</p> 
  <pre class="prettyprint"><code class="language-js hljs ">initContract: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-comment">// 加载Adoption.json，保存了Adoption的ABI（接口说明）信息及部署后的网络(地址)信息，它在编译合约的时候生成ABI，在部署的时候追加网络信息</span>
  $.getJSON(<span class="hljs-string">'Adoption.json'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
    <span class="hljs-comment">// 用Adoption.json数据创建一个可交互的TruffleContract合约实例。</span>
    <span class="hljs-keyword">var</span> AdoptionArtifact = data;
    App.contracts.Adoption = TruffleContract(AdoptionArtifact);

    <span class="hljs-comment">// Set the provider for our contract</span>
    App.contracts.Adoption.setProvider(App.web3Provider);

    <span class="hljs-comment">// Use our contract to retrieve and mark the adopted pets</span>
    <span class="hljs-keyword">return</span> App.markAdopted();
  });
  <span class="hljs-keyword">return</span> App.bindEvents();
}</code></pre> 
  <h3 id="处理领养">处理领养</h3> 
  <p>修改markAdopted()代码：</p> 
  <pre class="prettyprint"><code class="language-js hljs ">  markAdopted: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(adopters, account)</span> {</span>
    <span class="hljs-keyword">var</span> adoptionInstance;

    App.contracts.Adoption.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(instance)</span> {</span>
      adoptionInstance = instance;

      <span class="hljs-comment">// 调用合约的getAdopters(), 用call读取信息不用消耗gas</span>
      <span class="hljs-keyword">return</span> adoptionInstance.getAdopters.call();
    }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(adopters)</span> {</span>
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; adopters.length; i++) {
        <span class="hljs-keyword">if</span> (adopters[i] !== <span class="hljs-string">'0x0000000000000000000000000000000000000000'</span>) {
          $(<span class="hljs-string">'.panel-pet'</span>).eq(i).find(<span class="hljs-string">'button'</span>).text(<span class="hljs-string">'Success'</span>).attr(<span class="hljs-string">'disabled'</span>, <span class="hljs-literal">true</span>);
        }
      }
    }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
      console.log(err.message);
    });
  }</code></pre> 
  <p>修改handleAdopt()代码：</p> 
  <pre class="prettyprint"><code class="language-js hljs ">  handleAdopt: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
    event.preventDefault();

    <span class="hljs-keyword">var</span> petId = <span class="hljs-built_in">parseInt</span>($(event.target).data(<span class="hljs-string">'id'</span>));

    <span class="hljs-keyword">var</span> adoptionInstance;

    <span class="hljs-comment">// 获取用户账号</span>
    web3.eth.getAccounts(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(error, accounts)</span> {</span>
      <span class="hljs-keyword">if</span> (error) {
        console.log(error);
      }

      <span class="hljs-keyword">var</span> account = accounts[<span class="hljs-number">0</span>];

      App.contracts.Adoption.deployed().then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(instance)</span> {</span>
        adoptionInstance = instance;

        <span class="hljs-comment">// 发送交易领养宠物</span>
        <span class="hljs-keyword">return</span> adoptionInstance.adopt(petId, {from: account});
      }).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(result)</span> {</span>
        <span class="hljs-keyword">return</span> App.markAdopted();
      }).catch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span> {</span>
        console.log(err.message);
      });
    });
  }</code></pre> 
  <h2 id="在浏览器中运行">在浏览器中运行</h2> 
  <h3 id="安装-metamask">安装 MetaMask</h3> 
  <p>MetaMask 是一款插件形式的以太坊轻客户端，开发过程中使用MetaMask和我们的dapp进行交互是个很好的选择，通过此<a href="https://metamask.io/" rel="nofollow">链接</a>安装，安装完成后，浏览器工具条会显示一个小狐狸图标。</p> 
  <h3 id="配置钱包">配置钱包</h3> 
  <p>在接受隐私说明后，会出现页面如下： <br> <img src="https://learnblockchain.cn/images/metamask-initial.png" alt="" title=""></p> 
  <p>这里我们通过还原一个Ganache为我们创建好的钱包，作为我们的开发测试钱包。点击页面的<em>* Import Existing DEN*</em>，输入Ganache显示的助记词。</p> 
  <pre class="prettyprint"><code class=" hljs glsl">candy maple cake sugar pudding cream honey rich <span class="hljs-keyword">smooth</span> crumble sweet treat</code></pre> 
  <p>然后自己想要的密码，点击OK。 <br> 如图： <br> <img src="https://learnblockchain.cn/images/metamask-seed.png" alt="" title=""></p> 
  <h3 id="连接开发区块链网络">连接开发区块链网络</h3> 
  <p>默认连接的是以太坊主网（左上角显示），选择<strong>Custom RPC</strong>，添加一个网络：<strong><a href="http://127.0.0.1:7545" rel="nofollow">http://127.0.0.1:7545</a></strong>，点返回后，显示如下： <br> <img src="/images/metamask-account1.png" alt="" title=""> <br> 这是左上角显示为<strong>Private Network</strong>，账号是Ganache中默认的第一个账号。</p> 
  <p>至此MetaMask的安装，配置已经完成。</p> 
  <h3 id="安装和配置lite-server">安装和配置lite-server</h3> 
  <p>接下来需要本地的web 服务器提供服务的访问， Truffle Box <strong>pet-shop</strong>里提供了一个<strong>lite-server</strong>可以直接使用，我们看看它是如何工作的。 <br> <strong>bs-config.json</strong>指示了lite-server的工作目录。</p> 
  <pre class="prettyprint"><code class="language-json hljs ">{
  "<span class="hljs-attribute">server</span>": <span class="hljs-value">{ "<span class="hljs-attribute">baseDir</span>": <span class="hljs-value">[<span class="hljs-string">"./src"</span>, <span class="hljs-string">"./build/contracts"</span>] </span>} </span>}</code></pre> 
  <p>./src 是网站文件目录 <br> ./build/contracts 是合约输出目录</p> 
  <p>以此同时，在package.json文件的scripts中添加了dev命令：</p> 
  <pre class="prettyprint"><code class="language-json hljs "><span class="hljs-string">"scripts"</span>: {
  "<span class="hljs-attribute">dev</span>": <span class="hljs-value"><span class="hljs-string">"lite-server"</span></span>,
  "<span class="hljs-attribute">test</span>": <span class="hljs-value"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span> </span>},</code></pre> 
  <p>当运行npm run dev的时候，就会启动lite-server</p> 
  <h3 id="启动服务">启动服务</h3> 
  <pre class="prettyprint"><code class="language-bash hljs ">&gt; npm run dev</code></pre> 
  <p>会自动打开浏览器显示我们的dapp，如本文的第一张图。 <br> 现在领养一直宠物看看，当我们点击<strong>Adopt</strong>时，MetaMask会提示我们交易的确认，如图：</p> 
  <p><img src="https://learnblockchain.cn/images/metamask-transactionconfirm.png" alt="" title=""></p> 
  <p>点击Submit确认后，就可以看到成功领养了这次宠物。</p> 
  <p>在MetaMask中，也可以看到交易的清单： <br> <img src="https://learnblockchain.cn/images/metamask-transactionsuccess.png" alt="" title=""></p> 
  <p>好了，恭喜你，即将成为一名去中心化式应用开发者的你已经成为迈出了坚实的一步。 <br> 有问题来我的<strong><a href="https://t.xiaomiquan.com/RfAu7uj" rel="nofollow">知识星球</a></strong>交流吧。</p> 
  <h2 id="参考文档">参考文档</h2> 
  <ul> 
   <li><a href="http://truffleframework.com/tutorials/pet-shop" rel="nofollow">Truffle手册</a></li> 
  </ul> 
  <p><a href="https://learnblockchain.cn/" rel="nofollow">深入浅出区块链</a> - 系统学习区块链，打造最好的区块链技术博客。</p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/xilibi2003/article/details/79055025,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/xilibi2003/article/details/79055025,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
