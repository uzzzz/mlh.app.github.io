<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>区块链开发（二）部署和运行第一个以太坊智能合约 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="区块链开发（二）部署和运行第一个以太坊智能合约" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="版权声明：本文为博主原创文章，转载须保留作者信息及原文章链接。 https://blog.csdn.net/sportshark/article/details/52249607 区块链开发（二）部署并运行第一个以太坊智能合约 李赫2016年8月22日 本文首发8BTC &nbsp; &nbsp; &nbsp; &nbsp; 网络上不少部署智能合约的文章，但是都有一个共同的特点，就是采用命令行的方式来部署，先是建立SOLC的编译环境，然后部署Geth或者Eth节点，然后一步一步生成钱包、ABI、合约地址进行部署，对初学者来说晦涩难懂而且容易失败，本文主要介绍如何在图形化界面下一键部署和调用智能合约。对于其他区块链知识，请参考我的其他文章：http://blog.csdn.net/sportshark 一、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约和DAPP概述 1、&nbsp; 智能合约基本概念 &nbsp; &nbsp; &nbsp; &nbsp; 智能合约是一段代码和数据的集合，可以部署以太坊网络上运行。如果做比喻的话智能合约更像是JAVA程序，JAVA程序通过JAVA虚拟机（JVM）将代码解释字节进行执行，以太坊的智能合约通过以太坊虚拟机（EVM）解释成字节码进行执行，如果你学过汇编，会发现编译后的字节码和汇编很类似。同时智能合约有自己的账户，在时间或事件的驱动下能自动执行一些功能，如可以在相互之间传递信息，修改区块链的状态比如账户信息等。以太坊的智能合约最大的特点是图灵完备，通俗来说可以完全模拟一台计算机所能做的所有事情，大家熟知的比特币其实也可以执行一些简单脚本，但是他就不是图灵完备，比如循环指令比特币就无法执行。 以太坊虚拟机（EVM） &nbsp; &nbsp; &nbsp; &nbsp; 以太坊虚拟机（EVM）是以太坊中智能合约的运行环境。它不仅被沙箱封装起来，事实上它被完全隔离运行，也就是说运行在EVM内部的代码不能接触到网络、文件系统或者其它进程，甚至智能合约之间也只有有限的调用。 2、&nbsp; DAPP基本概念 &nbsp; &nbsp; &nbsp; &nbsp; 初学者经常把智能合约和DAPP搞混，以太坊社区把基于智能合约的应用称为去中心化的应用程序(Decentralized App)。DApp的目标是让你的智能合约有一个友好的界面，外加一些额外的有利于用户使用的东西。典型的DApp例子由一个html界面，web3运行库，一段JS代码以及部署在区块链上的一段智能合约组成。与一般CS架构的网站不同，DApp不能在普通的服务器上运行，DApp必须运行在一台能与以太坊节点交互的服务器上，或者任意一个以太坊节点上。DApp通过提交交易到区块链网络与对应的智能合约进行交互，并且从区块链网络而不是中心化数据库比如（MYSQL数据库）读取重要数据。相对于典型的BS架构用户登录系统不同，以太坊用户被表示成一个十六进制的地址而且所有用户数据和其他数据均保存在本地，与目前的web应用架构有很多不同。 3、&nbsp; 智能合约高级语言 &nbsp; &nbsp; &nbsp; &nbsp; 用户不可能直接编写以太坊虚拟机（EVM）字节码，所以以太坊提供了几种编写智能合约的高级语言。 Solidity：类似JavaScript，这是以太坊推荐的旗舰语言，也是最流行的智能合约语言。具体用法参加Solidity文档，地址：https://solidity.readthedocs.io/en/latest/ Serpent：类似Python风格，文档地址：https://github.com/ethereum/wiki/wiki/Serpent LLL：类似Lisp风格，目前已经被终止了。 可以根据不同的习惯选择不同的高级语言，目前最流行的是Solidity。 二、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在以太坊私有链上部署第一个智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 本文的智能合约采用以太坊官方的示例合约，功能就是在区块链上存储一个数字，并能够读取出来。代码如下： contract SimpleStorage { &nbsp;&nbsp;&nbsp; uint storedData; &nbsp;&nbsp;&nbsp; function set(uint x) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; storedData = x; &nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; function get() constant returns (uintretVal) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return storedData; &nbsp;&nbsp;&nbsp; } } &nbsp; &nbsp; &nbsp; &nbsp; 即使没有学过Solidity语言也可以大致看出，该合约set函数存储一个数字在X变量中，get函数从X变量中读取这个数字出来，下面对这个合约进行部署： 1、&nbsp; 启动私有链 &nbsp; &nbsp; &nbsp; &nbsp; 启动以太坊私有链Geth和Ethereum-Wallet图形界面（本文使用Geth 1.41版本, Ethereum-Wallet 0.8.1版本）。如果不知道如何启动，请参考我上一篇文章《区块链开发（一）搭建基于以太坊的私有链环境》地址：http://blog.csdn.net/sportshark/article/details/51855007，启动后界面如下, Ethereum-Wallet会显示红色的PRIVTE-NET标记。 2、创建两个钱包 &nbsp; &nbsp; &nbsp; &nbsp; 点击”ADD ACCOUNT” 按钮，添加一个钱包，程序会弹出一个对话框，提示输入两遍密码，输入完密码后，账号即创建成功。创建其他的账号，一样的操作，从上面的截图可以看到，有三个账号，一个是MAIN ACCOUNT，一个是ACCOUNT2，一个是ACCOUNT3 3、挖矿获取一些以太币 &nbsp; &nbsp; &nbsp; &nbsp; 账号创建后，还没有以太币，需要在私有链上挖矿，切换到Geth界面，输入 miner.start(1) &nbsp; &nbsp; &nbsp; &nbsp; miner命令括号中的1表示用一个线程进行挖矿，如果不配置，就会让CPU全速运行，影响计算机的使用。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;运行一会后，主账号就会获取很多以太币，这个时候屏幕会快速刷屏，不用管，输入命令miner.stop()停止挖矿。 4、&nbsp; 将一个钱包的以太币转到另一个钱包中 &nbsp; &nbsp; &nbsp; &nbsp; 先点击ACCOUNT2账号，进入账号详情的界面，点击右侧的“COPY address”，把ACCOUNT2的地址拷贝下来，系统会提示你现在你处在一个测试网络，不要转入真正的以太币到这个账号。 &nbsp; &nbsp; &nbsp; &nbsp; 点击钱包中“SEND”按钮，从MAINACCOUNT给ACCOUNT2转入一定以太币，同时可以看到执行这笔交易的费用是0.00042个以太币。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 点击发送后会提示如输入密码，但这时还没有发送成功，根据区块链的交易规则，需要矿工的确认，并且每笔交易需要确认12个块，一个块是16秒的生成时间。切换到Geth程序，输入挖矿命令，直到ACCOUNT2上显示100个以太币，然后停止挖矿。 5、&nbsp; 部署智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 点“CONTRACTS”，进入智能合约管理界面，点击“DEPOLY NEW CONTRACT”,开始部署智能合约，选择部署智能合约的账号，并输入智能合约的代码后，如下图 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;输入完毕后点击“DEPLOY”，系统会提示输入账号密码，因为部署智能合约是需要费用的。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 这个时候是看不到部署的智能合约的，切换到Geth界面，进行挖矿，在12个块后，智能合约就能确认并显示出来。 三、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;运行智能合约 1、 在本节点上运行智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 点击“CONTRACTS”进入智能合约界面，可以看到刚才部署的智能合约“SimpleStorage”，点击进入该智能合约，进入详情界面，其中有智能合约写入区域和读取区域，首先启动Geth的挖矿，然后在写入区域选择相应的智能合约函数SET，在下面的数值输入框输入想设置的数值，运行一会后就可以在读取区域看到智能合约函数GET中Retval的返回值有变化。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;其他智能合约的运行也是一样，无非就是函数多点，输入多点。 &nbsp; 2、 在其他节点上运行智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 此时的智能合约只能自己能看到，别人是无法看到和运行的，如果其他人要运行你部署好的智能合约需要提供一些信息，就是其他教程中所说的智能合约的ABI和地址。 进入刚部署的“SimpleStorage”智能合约界面，右侧有四个按钮 A．“Deposit Eher”：向该智能合约发送以太币 B.“Copy address”：拷贝该智能合约的地址 C．“Show QR Code”：显示一个二维码，如果用手机扫描的话，显示该智能合约的地址 D．“Show Interface”：显示该智能合约的JSON接口，也就是ABI &nbsp; &nbsp; &nbsp; &nbsp; 首先我们点“Copy address”，拷贝该智能合约的地址，然后点“Show Interface”将智能合约的JSON接口全部拷贝出来，在另一个需要运行智能合约的节点打开Ethereum-Wallet，打开“CONTRACTS”界面点击“WATCH CONTRACTS”添加一个智能合约。 &nbsp; &nbsp; &nbsp; &nbsp; 如上图所示，CONTRACT NAME随便填，CONTRACT ADDRESS填写智能合约地址，JSON INTERFACE填写刚才在”Show Interface “中拷贝的内容。点OK后，就可以看到这个智能合约并运行了。 四、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的部署原理 1、智能合约的部署架构 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;本文介绍的智能合约的部署虽然是在图形化界面编译和执行，但其实最主要的是依赖于后台运行Geth的节点，此时Geth提供了一个RPC的接口向图形化界面的钱包提供区块链的信息。 RPC接口 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Geth在8545端口提供了JSON RPC API ，数据传输采用JSON格式，可以执行Web3库的各种命令，比如向前端，比如mist等图形化客户端提供区块链的信息，默认访问地址为http://localhost:8545。 &nbsp; &nbsp; &nbsp; &nbsp; 我们部署一个智能合约时，首先Ethereum-Wallet调用SOLC智能合约编译器将代码编译成成EVM字节码，然后将EVM字节码通过Geth的RPC接口发送到以太坊网络，经过全网验证后，同时写入到每个Geth管理的区块链中，架构如下 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、 部署的数据流 &nbsp; &nbsp; &nbsp; &nbsp;首先代码先经过SOLC编译变为了二进制码，然后通过一笔交易来创建智能合约，该笔交易包含了创建者账号、智能合约内容、智能合约的地址这几个关键信息，其中智能合约地址的生成是由创建者的账号和发送的交易数作为随机数输入，通过Kecca-256加密算法重新创建一个地址作为账号。 &nbsp; &nbsp; &nbsp; &nbsp;部署过程中，需要通过交易来部署，同时数据要存储到区块链上，这些需要使用到GAS。 交易（Transactions） &nbsp; &nbsp; &nbsp; &nbsp; 一笔交易是一条消息，从一个账户发送到另一个账户。交易可以包含二进制数据（payload）和以太币。 &nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户包含代码，该代码和输入数据会被执行。 &nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户是零账户（账户地址是0），交易将创建一个新合约。正如上文所讲，这个智能合约地址不是零地址，而是由合约创建者的地址和该地址发出过的交易数量计算得到。创建合约交易的payload被当作EVM字节码执行。执行的输出做为合约代码被永久存储。这意味着，为了创建一个合约，你不需要向合约发送真正的合约代码，而是发送能够返回可执行代码的代码。 Gas &nbsp; &nbsp; &nbsp; &nbsp; 以太坊上的每笔交易都会被收取一定数量的gas，gas的目的是限制执行交易所需的工作量，同时为执行支付费用。当EVM执行智能合约时，gas将按照特定规则被逐渐消耗，其实GAS就是以太币的比较小的单位，如果以太币比作100元，那么GAS可以看作是1分钱。如果只有以太币，会有问题，以太币是需要大家买卖的，市场会有价格波动。可能会出现比特币这样的状况，一天跌50%涨50%。这个对计算的成本是不能接受的，例如今天做一个加法需要十块钱，明天做一个加法需要一百块钱。所以这里引入gas来解耦。把市场的波动和计算的开销来解耦，也就是说以太币和gas之间是有汇率的，以太币涨没关系，gas价格下降就可以了。它要保证我做同样的计算，消耗的法币是一致的。 &nbsp; &nbsp; &nbsp; &nbsp; gas price（gas价格，以太币计）是由交易创建者设置的，发送账户需要预付的交易费用 = gas price * gas amount。 如果执行结束还有gas剩余，这些gas将被返还给发送账户。 &nbsp; &nbsp; &nbsp; &nbsp; 前文中曾经提到部署智能合约使用了0.00042个以太币，换算成gas就是21000个gas。 &nbsp; &nbsp; &nbsp; &nbsp; 无论执行到什么位置，一旦gas被耗尽（比如降为负值），将会触发一个out-of-gas异常。当前调用帧所做的所有状态修改都将被回滚。 五、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的运行原理 &nbsp; &nbsp; &nbsp; &nbsp; 智能合约是部署在区块链的代码，区块链本身不能执行代码，代码的执行是在本地的EVM中，实际上，部署在区块链上代码是能够在本地产生原智能合约代码的代码，可以理解区块链为一个数据库，而客户端从数据库中读取了存储的运行代码，并在本地运行后，将结果写入到了区块链这个数据库中。 &nbsp; &nbsp; &nbsp; &nbsp;本质上，以太坊的钱包也是智能合约的一个应用，以太坊搭建的是一个可供编写各种应用的平台。下一篇，将详细讲述智能合约的开发编写和调试方法 阅读更多" />
<meta property="og:description" content="版权声明：本文为博主原创文章，转载须保留作者信息及原文章链接。 https://blog.csdn.net/sportshark/article/details/52249607 区块链开发（二）部署并运行第一个以太坊智能合约 李赫2016年8月22日 本文首发8BTC &nbsp; &nbsp; &nbsp; &nbsp; 网络上不少部署智能合约的文章，但是都有一个共同的特点，就是采用命令行的方式来部署，先是建立SOLC的编译环境，然后部署Geth或者Eth节点，然后一步一步生成钱包、ABI、合约地址进行部署，对初学者来说晦涩难懂而且容易失败，本文主要介绍如何在图形化界面下一键部署和调用智能合约。对于其他区块链知识，请参考我的其他文章：http://blog.csdn.net/sportshark 一、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约和DAPP概述 1、&nbsp; 智能合约基本概念 &nbsp; &nbsp; &nbsp; &nbsp; 智能合约是一段代码和数据的集合，可以部署以太坊网络上运行。如果做比喻的话智能合约更像是JAVA程序，JAVA程序通过JAVA虚拟机（JVM）将代码解释字节进行执行，以太坊的智能合约通过以太坊虚拟机（EVM）解释成字节码进行执行，如果你学过汇编，会发现编译后的字节码和汇编很类似。同时智能合约有自己的账户，在时间或事件的驱动下能自动执行一些功能，如可以在相互之间传递信息，修改区块链的状态比如账户信息等。以太坊的智能合约最大的特点是图灵完备，通俗来说可以完全模拟一台计算机所能做的所有事情，大家熟知的比特币其实也可以执行一些简单脚本，但是他就不是图灵完备，比如循环指令比特币就无法执行。 以太坊虚拟机（EVM） &nbsp; &nbsp; &nbsp; &nbsp; 以太坊虚拟机（EVM）是以太坊中智能合约的运行环境。它不仅被沙箱封装起来，事实上它被完全隔离运行，也就是说运行在EVM内部的代码不能接触到网络、文件系统或者其它进程，甚至智能合约之间也只有有限的调用。 2、&nbsp; DAPP基本概念 &nbsp; &nbsp; &nbsp; &nbsp; 初学者经常把智能合约和DAPP搞混，以太坊社区把基于智能合约的应用称为去中心化的应用程序(Decentralized App)。DApp的目标是让你的智能合约有一个友好的界面，外加一些额外的有利于用户使用的东西。典型的DApp例子由一个html界面，web3运行库，一段JS代码以及部署在区块链上的一段智能合约组成。与一般CS架构的网站不同，DApp不能在普通的服务器上运行，DApp必须运行在一台能与以太坊节点交互的服务器上，或者任意一个以太坊节点上。DApp通过提交交易到区块链网络与对应的智能合约进行交互，并且从区块链网络而不是中心化数据库比如（MYSQL数据库）读取重要数据。相对于典型的BS架构用户登录系统不同，以太坊用户被表示成一个十六进制的地址而且所有用户数据和其他数据均保存在本地，与目前的web应用架构有很多不同。 3、&nbsp; 智能合约高级语言 &nbsp; &nbsp; &nbsp; &nbsp; 用户不可能直接编写以太坊虚拟机（EVM）字节码，所以以太坊提供了几种编写智能合约的高级语言。 Solidity：类似JavaScript，这是以太坊推荐的旗舰语言，也是最流行的智能合约语言。具体用法参加Solidity文档，地址：https://solidity.readthedocs.io/en/latest/ Serpent：类似Python风格，文档地址：https://github.com/ethereum/wiki/wiki/Serpent LLL：类似Lisp风格，目前已经被终止了。 可以根据不同的习惯选择不同的高级语言，目前最流行的是Solidity。 二、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在以太坊私有链上部署第一个智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 本文的智能合约采用以太坊官方的示例合约，功能就是在区块链上存储一个数字，并能够读取出来。代码如下： contract SimpleStorage { &nbsp;&nbsp;&nbsp; uint storedData; &nbsp;&nbsp;&nbsp; function set(uint x) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; storedData = x; &nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; function get() constant returns (uintretVal) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return storedData; &nbsp;&nbsp;&nbsp; } } &nbsp; &nbsp; &nbsp; &nbsp; 即使没有学过Solidity语言也可以大致看出，该合约set函数存储一个数字在X变量中，get函数从X变量中读取这个数字出来，下面对这个合约进行部署： 1、&nbsp; 启动私有链 &nbsp; &nbsp; &nbsp; &nbsp; 启动以太坊私有链Geth和Ethereum-Wallet图形界面（本文使用Geth 1.41版本, Ethereum-Wallet 0.8.1版本）。如果不知道如何启动，请参考我上一篇文章《区块链开发（一）搭建基于以太坊的私有链环境》地址：http://blog.csdn.net/sportshark/article/details/51855007，启动后界面如下, Ethereum-Wallet会显示红色的PRIVTE-NET标记。 2、创建两个钱包 &nbsp; &nbsp; &nbsp; &nbsp; 点击”ADD ACCOUNT” 按钮，添加一个钱包，程序会弹出一个对话框，提示输入两遍密码，输入完密码后，账号即创建成功。创建其他的账号，一样的操作，从上面的截图可以看到，有三个账号，一个是MAIN ACCOUNT，一个是ACCOUNT2，一个是ACCOUNT3 3、挖矿获取一些以太币 &nbsp; &nbsp; &nbsp; &nbsp; 账号创建后，还没有以太币，需要在私有链上挖矿，切换到Geth界面，输入 miner.start(1) &nbsp; &nbsp; &nbsp; &nbsp; miner命令括号中的1表示用一个线程进行挖矿，如果不配置，就会让CPU全速运行，影响计算机的使用。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;运行一会后，主账号就会获取很多以太币，这个时候屏幕会快速刷屏，不用管，输入命令miner.stop()停止挖矿。 4、&nbsp; 将一个钱包的以太币转到另一个钱包中 &nbsp; &nbsp; &nbsp; &nbsp; 先点击ACCOUNT2账号，进入账号详情的界面，点击右侧的“COPY address”，把ACCOUNT2的地址拷贝下来，系统会提示你现在你处在一个测试网络，不要转入真正的以太币到这个账号。 &nbsp; &nbsp; &nbsp; &nbsp; 点击钱包中“SEND”按钮，从MAINACCOUNT给ACCOUNT2转入一定以太币，同时可以看到执行这笔交易的费用是0.00042个以太币。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 点击发送后会提示如输入密码，但这时还没有发送成功，根据区块链的交易规则，需要矿工的确认，并且每笔交易需要确认12个块，一个块是16秒的生成时间。切换到Geth程序，输入挖矿命令，直到ACCOUNT2上显示100个以太币，然后停止挖矿。 5、&nbsp; 部署智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 点“CONTRACTS”，进入智能合约管理界面，点击“DEPOLY NEW CONTRACT”,开始部署智能合约，选择部署智能合约的账号，并输入智能合约的代码后，如下图 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;输入完毕后点击“DEPLOY”，系统会提示输入账号密码，因为部署智能合约是需要费用的。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 这个时候是看不到部署的智能合约的，切换到Geth界面，进行挖矿，在12个块后，智能合约就能确认并显示出来。 三、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;运行智能合约 1、 在本节点上运行智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 点击“CONTRACTS”进入智能合约界面，可以看到刚才部署的智能合约“SimpleStorage”，点击进入该智能合约，进入详情界面，其中有智能合约写入区域和读取区域，首先启动Geth的挖矿，然后在写入区域选择相应的智能合约函数SET，在下面的数值输入框输入想设置的数值，运行一会后就可以在读取区域看到智能合约函数GET中Retval的返回值有变化。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;其他智能合约的运行也是一样，无非就是函数多点，输入多点。 &nbsp; 2、 在其他节点上运行智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 此时的智能合约只能自己能看到，别人是无法看到和运行的，如果其他人要运行你部署好的智能合约需要提供一些信息，就是其他教程中所说的智能合约的ABI和地址。 进入刚部署的“SimpleStorage”智能合约界面，右侧有四个按钮 A．“Deposit Eher”：向该智能合约发送以太币 B.“Copy address”：拷贝该智能合约的地址 C．“Show QR Code”：显示一个二维码，如果用手机扫描的话，显示该智能合约的地址 D．“Show Interface”：显示该智能合约的JSON接口，也就是ABI &nbsp; &nbsp; &nbsp; &nbsp; 首先我们点“Copy address”，拷贝该智能合约的地址，然后点“Show Interface”将智能合约的JSON接口全部拷贝出来，在另一个需要运行智能合约的节点打开Ethereum-Wallet，打开“CONTRACTS”界面点击“WATCH CONTRACTS”添加一个智能合约。 &nbsp; &nbsp; &nbsp; &nbsp; 如上图所示，CONTRACT NAME随便填，CONTRACT ADDRESS填写智能合约地址，JSON INTERFACE填写刚才在”Show Interface “中拷贝的内容。点OK后，就可以看到这个智能合约并运行了。 四、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的部署原理 1、智能合约的部署架构 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;本文介绍的智能合约的部署虽然是在图形化界面编译和执行，但其实最主要的是依赖于后台运行Geth的节点，此时Geth提供了一个RPC的接口向图形化界面的钱包提供区块链的信息。 RPC接口 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Geth在8545端口提供了JSON RPC API ，数据传输采用JSON格式，可以执行Web3库的各种命令，比如向前端，比如mist等图形化客户端提供区块链的信息，默认访问地址为http://localhost:8545。 &nbsp; &nbsp; &nbsp; &nbsp; 我们部署一个智能合约时，首先Ethereum-Wallet调用SOLC智能合约编译器将代码编译成成EVM字节码，然后将EVM字节码通过Geth的RPC接口发送到以太坊网络，经过全网验证后，同时写入到每个Geth管理的区块链中，架构如下 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、 部署的数据流 &nbsp; &nbsp; &nbsp; &nbsp;首先代码先经过SOLC编译变为了二进制码，然后通过一笔交易来创建智能合约，该笔交易包含了创建者账号、智能合约内容、智能合约的地址这几个关键信息，其中智能合约地址的生成是由创建者的账号和发送的交易数作为随机数输入，通过Kecca-256加密算法重新创建一个地址作为账号。 &nbsp; &nbsp; &nbsp; &nbsp;部署过程中，需要通过交易来部署，同时数据要存储到区块链上，这些需要使用到GAS。 交易（Transactions） &nbsp; &nbsp; &nbsp; &nbsp; 一笔交易是一条消息，从一个账户发送到另一个账户。交易可以包含二进制数据（payload）和以太币。 &nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户包含代码，该代码和输入数据会被执行。 &nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户是零账户（账户地址是0），交易将创建一个新合约。正如上文所讲，这个智能合约地址不是零地址，而是由合约创建者的地址和该地址发出过的交易数量计算得到。创建合约交易的payload被当作EVM字节码执行。执行的输出做为合约代码被永久存储。这意味着，为了创建一个合约，你不需要向合约发送真正的合约代码，而是发送能够返回可执行代码的代码。 Gas &nbsp; &nbsp; &nbsp; &nbsp; 以太坊上的每笔交易都会被收取一定数量的gas，gas的目的是限制执行交易所需的工作量，同时为执行支付费用。当EVM执行智能合约时，gas将按照特定规则被逐渐消耗，其实GAS就是以太币的比较小的单位，如果以太币比作100元，那么GAS可以看作是1分钱。如果只有以太币，会有问题，以太币是需要大家买卖的，市场会有价格波动。可能会出现比特币这样的状况，一天跌50%涨50%。这个对计算的成本是不能接受的，例如今天做一个加法需要十块钱，明天做一个加法需要一百块钱。所以这里引入gas来解耦。把市场的波动和计算的开销来解耦，也就是说以太币和gas之间是有汇率的，以太币涨没关系，gas价格下降就可以了。它要保证我做同样的计算，消耗的法币是一致的。 &nbsp; &nbsp; &nbsp; &nbsp; gas price（gas价格，以太币计）是由交易创建者设置的，发送账户需要预付的交易费用 = gas price * gas amount。 如果执行结束还有gas剩余，这些gas将被返还给发送账户。 &nbsp; &nbsp; &nbsp; &nbsp; 前文中曾经提到部署智能合约使用了0.00042个以太币，换算成gas就是21000个gas。 &nbsp; &nbsp; &nbsp; &nbsp; 无论执行到什么位置，一旦gas被耗尽（比如降为负值），将会触发一个out-of-gas异常。当前调用帧所做的所有状态修改都将被回滚。 五、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的运行原理 &nbsp; &nbsp; &nbsp; &nbsp; 智能合约是部署在区块链的代码，区块链本身不能执行代码，代码的执行是在本地的EVM中，实际上，部署在区块链上代码是能够在本地产生原智能合约代码的代码，可以理解区块链为一个数据库，而客户端从数据库中读取了存储的运行代码，并在本地运行后，将结果写入到了区块链这个数据库中。 &nbsp; &nbsp; &nbsp; &nbsp;本质上，以太坊的钱包也是智能合约的一个应用，以太坊搭建的是一个可供编写各种应用的平台。下一篇，将详细讲述智能合约的开发编写和调试方法 阅读更多" />
<link rel="canonical" href="https://mlh.app/2016/08/22/0607fc070441ecbd73d9e26dad04c45e.html" />
<meta property="og:url" content="https://mlh.app/2016/08/22/0607fc070441ecbd73d9e26dad04c45e.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-08-22T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"版权声明：本文为博主原创文章，转载须保留作者信息及原文章链接。 https://blog.csdn.net/sportshark/article/details/52249607 区块链开发（二）部署并运行第一个以太坊智能合约 李赫2016年8月22日 本文首发8BTC &nbsp; &nbsp; &nbsp; &nbsp; 网络上不少部署智能合约的文章，但是都有一个共同的特点，就是采用命令行的方式来部署，先是建立SOLC的编译环境，然后部署Geth或者Eth节点，然后一步一步生成钱包、ABI、合约地址进行部署，对初学者来说晦涩难懂而且容易失败，本文主要介绍如何在图形化界面下一键部署和调用智能合约。对于其他区块链知识，请参考我的其他文章：http://blog.csdn.net/sportshark 一、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约和DAPP概述 1、&nbsp; 智能合约基本概念 &nbsp; &nbsp; &nbsp; &nbsp; 智能合约是一段代码和数据的集合，可以部署以太坊网络上运行。如果做比喻的话智能合约更像是JAVA程序，JAVA程序通过JAVA虚拟机（JVM）将代码解释字节进行执行，以太坊的智能合约通过以太坊虚拟机（EVM）解释成字节码进行执行，如果你学过汇编，会发现编译后的字节码和汇编很类似。同时智能合约有自己的账户，在时间或事件的驱动下能自动执行一些功能，如可以在相互之间传递信息，修改区块链的状态比如账户信息等。以太坊的智能合约最大的特点是图灵完备，通俗来说可以完全模拟一台计算机所能做的所有事情，大家熟知的比特币其实也可以执行一些简单脚本，但是他就不是图灵完备，比如循环指令比特币就无法执行。 以太坊虚拟机（EVM） &nbsp; &nbsp; &nbsp; &nbsp; 以太坊虚拟机（EVM）是以太坊中智能合约的运行环境。它不仅被沙箱封装起来，事实上它被完全隔离运行，也就是说运行在EVM内部的代码不能接触到网络、文件系统或者其它进程，甚至智能合约之间也只有有限的调用。 2、&nbsp; DAPP基本概念 &nbsp; &nbsp; &nbsp; &nbsp; 初学者经常把智能合约和DAPP搞混，以太坊社区把基于智能合约的应用称为去中心化的应用程序(Decentralized App)。DApp的目标是让你的智能合约有一个友好的界面，外加一些额外的有利于用户使用的东西。典型的DApp例子由一个html界面，web3运行库，一段JS代码以及部署在区块链上的一段智能合约组成。与一般CS架构的网站不同，DApp不能在普通的服务器上运行，DApp必须运行在一台能与以太坊节点交互的服务器上，或者任意一个以太坊节点上。DApp通过提交交易到区块链网络与对应的智能合约进行交互，并且从区块链网络而不是中心化数据库比如（MYSQL数据库）读取重要数据。相对于典型的BS架构用户登录系统不同，以太坊用户被表示成一个十六进制的地址而且所有用户数据和其他数据均保存在本地，与目前的web应用架构有很多不同。 3、&nbsp; 智能合约高级语言 &nbsp; &nbsp; &nbsp; &nbsp; 用户不可能直接编写以太坊虚拟机（EVM）字节码，所以以太坊提供了几种编写智能合约的高级语言。 Solidity：类似JavaScript，这是以太坊推荐的旗舰语言，也是最流行的智能合约语言。具体用法参加Solidity文档，地址：https://solidity.readthedocs.io/en/latest/ Serpent：类似Python风格，文档地址：https://github.com/ethereum/wiki/wiki/Serpent LLL：类似Lisp风格，目前已经被终止了。 可以根据不同的习惯选择不同的高级语言，目前最流行的是Solidity。 二、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在以太坊私有链上部署第一个智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 本文的智能合约采用以太坊官方的示例合约，功能就是在区块链上存储一个数字，并能够读取出来。代码如下： contract SimpleStorage { &nbsp;&nbsp;&nbsp; uint storedData; &nbsp;&nbsp;&nbsp; function set(uint x) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; storedData = x; &nbsp;&nbsp;&nbsp; } &nbsp;&nbsp;&nbsp; function get() constant returns (uintretVal) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return storedData; &nbsp;&nbsp;&nbsp; } } &nbsp; &nbsp; &nbsp; &nbsp; 即使没有学过Solidity语言也可以大致看出，该合约set函数存储一个数字在X变量中，get函数从X变量中读取这个数字出来，下面对这个合约进行部署： 1、&nbsp; 启动私有链 &nbsp; &nbsp; &nbsp; &nbsp; 启动以太坊私有链Geth和Ethereum-Wallet图形界面（本文使用Geth 1.41版本, Ethereum-Wallet 0.8.1版本）。如果不知道如何启动，请参考我上一篇文章《区块链开发（一）搭建基于以太坊的私有链环境》地址：http://blog.csdn.net/sportshark/article/details/51855007，启动后界面如下, Ethereum-Wallet会显示红色的PRIVTE-NET标记。 2、创建两个钱包 &nbsp; &nbsp; &nbsp; &nbsp; 点击”ADD ACCOUNT” 按钮，添加一个钱包，程序会弹出一个对话框，提示输入两遍密码，输入完密码后，账号即创建成功。创建其他的账号，一样的操作，从上面的截图可以看到，有三个账号，一个是MAIN ACCOUNT，一个是ACCOUNT2，一个是ACCOUNT3 3、挖矿获取一些以太币 &nbsp; &nbsp; &nbsp; &nbsp; 账号创建后，还没有以太币，需要在私有链上挖矿，切换到Geth界面，输入 miner.start(1) &nbsp; &nbsp; &nbsp; &nbsp; miner命令括号中的1表示用一个线程进行挖矿，如果不配置，就会让CPU全速运行，影响计算机的使用。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;运行一会后，主账号就会获取很多以太币，这个时候屏幕会快速刷屏，不用管，输入命令miner.stop()停止挖矿。 4、&nbsp; 将一个钱包的以太币转到另一个钱包中 &nbsp; &nbsp; &nbsp; &nbsp; 先点击ACCOUNT2账号，进入账号详情的界面，点击右侧的“COPY address”，把ACCOUNT2的地址拷贝下来，系统会提示你现在你处在一个测试网络，不要转入真正的以太币到这个账号。 &nbsp; &nbsp; &nbsp; &nbsp; 点击钱包中“SEND”按钮，从MAINACCOUNT给ACCOUNT2转入一定以太币，同时可以看到执行这笔交易的费用是0.00042个以太币。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 点击发送后会提示如输入密码，但这时还没有发送成功，根据区块链的交易规则，需要矿工的确认，并且每笔交易需要确认12个块，一个块是16秒的生成时间。切换到Geth程序，输入挖矿命令，直到ACCOUNT2上显示100个以太币，然后停止挖矿。 5、&nbsp; 部署智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 点“CONTRACTS”，进入智能合约管理界面，点击“DEPOLY NEW CONTRACT”,开始部署智能合约，选择部署智能合约的账号，并输入智能合约的代码后，如下图 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;输入完毕后点击“DEPLOY”，系统会提示输入账号密码，因为部署智能合约是需要费用的。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 这个时候是看不到部署的智能合约的，切换到Geth界面，进行挖矿，在12个块后，智能合约就能确认并显示出来。 三、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;运行智能合约 1、 在本节点上运行智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 点击“CONTRACTS”进入智能合约界面，可以看到刚才部署的智能合约“SimpleStorage”，点击进入该智能合约，进入详情界面，其中有智能合约写入区域和读取区域，首先启动Geth的挖矿，然后在写入区域选择相应的智能合约函数SET，在下面的数值输入框输入想设置的数值，运行一会后就可以在读取区域看到智能合约函数GET中Retval的返回值有变化。 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;其他智能合约的运行也是一样，无非就是函数多点，输入多点。 &nbsp; 2、 在其他节点上运行智能合约 &nbsp; &nbsp; &nbsp; &nbsp; 此时的智能合约只能自己能看到，别人是无法看到和运行的，如果其他人要运行你部署好的智能合约需要提供一些信息，就是其他教程中所说的智能合约的ABI和地址。 进入刚部署的“SimpleStorage”智能合约界面，右侧有四个按钮 A．“Deposit Eher”：向该智能合约发送以太币 B.“Copy address”：拷贝该智能合约的地址 C．“Show QR Code”：显示一个二维码，如果用手机扫描的话，显示该智能合约的地址 D．“Show Interface”：显示该智能合约的JSON接口，也就是ABI &nbsp; &nbsp; &nbsp; &nbsp; 首先我们点“Copy address”，拷贝该智能合约的地址，然后点“Show Interface”将智能合约的JSON接口全部拷贝出来，在另一个需要运行智能合约的节点打开Ethereum-Wallet，打开“CONTRACTS”界面点击“WATCH CONTRACTS”添加一个智能合约。 &nbsp; &nbsp; &nbsp; &nbsp; 如上图所示，CONTRACT NAME随便填，CONTRACT ADDRESS填写智能合约地址，JSON INTERFACE填写刚才在”Show Interface “中拷贝的内容。点OK后，就可以看到这个智能合约并运行了。 四、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的部署原理 1、智能合约的部署架构 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;本文介绍的智能合约的部署虽然是在图形化界面编译和执行，但其实最主要的是依赖于后台运行Geth的节点，此时Geth提供了一个RPC的接口向图形化界面的钱包提供区块链的信息。 RPC接口 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Geth在8545端口提供了JSON RPC API ，数据传输采用JSON格式，可以执行Web3库的各种命令，比如向前端，比如mist等图形化客户端提供区块链的信息，默认访问地址为http://localhost:8545。 &nbsp; &nbsp; &nbsp; &nbsp; 我们部署一个智能合约时，首先Ethereum-Wallet调用SOLC智能合约编译器将代码编译成成EVM字节码，然后将EVM字节码通过Geth的RPC接口发送到以太坊网络，经过全网验证后，同时写入到每个Geth管理的区块链中，架构如下 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2、 部署的数据流 &nbsp; &nbsp; &nbsp; &nbsp;首先代码先经过SOLC编译变为了二进制码，然后通过一笔交易来创建智能合约，该笔交易包含了创建者账号、智能合约内容、智能合约的地址这几个关键信息，其中智能合约地址的生成是由创建者的账号和发送的交易数作为随机数输入，通过Kecca-256加密算法重新创建一个地址作为账号。 &nbsp; &nbsp; &nbsp; &nbsp;部署过程中，需要通过交易来部署，同时数据要存储到区块链上，这些需要使用到GAS。 交易（Transactions） &nbsp; &nbsp; &nbsp; &nbsp; 一笔交易是一条消息，从一个账户发送到另一个账户。交易可以包含二进制数据（payload）和以太币。 &nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户包含代码，该代码和输入数据会被执行。 &nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户是零账户（账户地址是0），交易将创建一个新合约。正如上文所讲，这个智能合约地址不是零地址，而是由合约创建者的地址和该地址发出过的交易数量计算得到。创建合约交易的payload被当作EVM字节码执行。执行的输出做为合约代码被永久存储。这意味着，为了创建一个合约，你不需要向合约发送真正的合约代码，而是发送能够返回可执行代码的代码。 Gas &nbsp; &nbsp; &nbsp; &nbsp; 以太坊上的每笔交易都会被收取一定数量的gas，gas的目的是限制执行交易所需的工作量，同时为执行支付费用。当EVM执行智能合约时，gas将按照特定规则被逐渐消耗，其实GAS就是以太币的比较小的单位，如果以太币比作100元，那么GAS可以看作是1分钱。如果只有以太币，会有问题，以太币是需要大家买卖的，市场会有价格波动。可能会出现比特币这样的状况，一天跌50%涨50%。这个对计算的成本是不能接受的，例如今天做一个加法需要十块钱，明天做一个加法需要一百块钱。所以这里引入gas来解耦。把市场的波动和计算的开销来解耦，也就是说以太币和gas之间是有汇率的，以太币涨没关系，gas价格下降就可以了。它要保证我做同样的计算，消耗的法币是一致的。 &nbsp; &nbsp; &nbsp; &nbsp; gas price（gas价格，以太币计）是由交易创建者设置的，发送账户需要预付的交易费用 = gas price * gas amount。 如果执行结束还有gas剩余，这些gas将被返还给发送账户。 &nbsp; &nbsp; &nbsp; &nbsp; 前文中曾经提到部署智能合约使用了0.00042个以太币，换算成gas就是21000个gas。 &nbsp; &nbsp; &nbsp; &nbsp; 无论执行到什么位置，一旦gas被耗尽（比如降为负值），将会触发一个out-of-gas异常。当前调用帧所做的所有状态修改都将被回滚。 五、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的运行原理 &nbsp; &nbsp; &nbsp; &nbsp; 智能合约是部署在区块链的代码，区块链本身不能执行代码，代码的执行是在本地的EVM中，实际上，部署在区块链上代码是能够在本地产生原智能合约代码的代码，可以理解区块链为一个数据库，而客户端从数据库中读取了存储的运行代码，并在本地运行后，将结果写入到了区块链这个数据库中。 &nbsp; &nbsp; &nbsp; &nbsp;本质上，以太坊的钱包也是智能合约的一个应用，以太坊搭建的是一个可供编写各种应用的平台。下一篇，将详细讲述智能合约的开发编写和调试方法 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2016/08/22/0607fc070441ecbd73d9e26dad04c45e.html","headline":"区块链开发（二）部署和运行第一个以太坊智能合约","dateModified":"2016-08-22T00:00:00+08:00","datePublished":"2016-08-22T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2016/08/22/0607fc070441ecbd73d9e26dad04c45e.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>区块链开发（二）部署和运行第一个以太坊智能合约</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="article-copyright">
   版权声明：本文为博主原创文章，转载须保留作者信息及原文章链接。 https://blog.csdn.net/sportshark/article/details/52249607 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-f76675cdea.css"> 
 <div class="htmledit_views"> 
  <p align="center"><strong><span style="font-size:18px;">区块链开发（二）部署并运行第一个以太坊智能合约</span></strong></p> 
  <p align="center"><strong><span style="font-size:18px;">李赫2016年8月22日</span></strong></p> 
  <p align="center"><strong><span style="font-size:18px;">本文首发8BTC</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 网络上不少部署智能合约的文章，但是都有一个共同的特点，就是采用命令行的方式来部署，先是建立SOLC的编译环境，然后部署Geth或者Eth节点，然后一步一步生成钱包、ABI、合约地址进行部署，对初学者来说晦涩难懂而且容易失败，本文主要介绍如何在图形化界面下一键部署和调用智能合约。对于其他区块链知识，请参考我的其他文章：http://blog.csdn.net/sportshark</span></p> 
  <p><span style="font-size:18px;"><strong>一、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约和DAPP概述</strong></span></p> 
  <p><span style="font-size:18px;"><strong>1、&nbsp; 智能合约基本概念</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 智能合约是一段代码和数据的集合，可以部署以太坊网络上运行。如果做比喻的话智能合约更像是JAVA程序，JAVA程序通过JAVA虚拟机（JVM）将代码解释字节进行执行，以太坊的智能合约通过以太坊虚拟机（EVM）解释成字节码进行执行，如果你学过汇编，会发现编译后的字节码和汇编很类似。同时智能合约有自己的账户，在时间或事件的驱动下能自动执行一些功能，如可以在相互之间传递信息，修改区块链的状态比如账户信息等。以太坊的智能合约最大的特点是图灵完备，通俗来说可以完全模拟一台计算机所能做的所有事情，大家熟知的比特币其实也可以执行一些简单脚本，但是他就不是图灵完备，比如循环指令比特币就无法执行。</span></p> 
  <p><strong><span style="font-size:18px;">以太坊虚拟机（EVM）</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 以太坊虚拟机（EVM）是以太坊中智能合约的运行环境。它不仅被沙箱封装起来，事实上它被完全隔离运行，也就是说运行在EVM内部的代码不能接触到网络、文件系统或者其它进程，甚至智能合约之间也只有有限的调用。</span></p> 
  <p><span style="font-size:18px;"><strong>2、&nbsp; DAPP基本概念</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 初学者经常把智能合约和DAPP搞混，以太坊社区把基于智能合约的应用称为去中心化的应用程序(Decentralized App)。DApp的目标是让你的智能合约有一个友好的界面，外加一些额外的有利于用户使用的东西。典型的DApp例子由一个html界面，web3运行库，一段JS代码以及部署在区块链上的一段智能合约组成。与一般CS架构的网站不同，DApp不能在普通的服务器上运行，DApp必须运行在一台能与以太坊节点交互的服务器上，或者任意一个以太坊节点上。DApp通过提交交易到区块链网络与对应的智能合约进行交互，并且从区块链网络而不是中心化数据库比如（MYSQL数据库）读取重要数据。相对于典型的BS架构用户登录系统不同，以太坊用户被表示成一个十六进制的地址而且所有用户数据和其他数据均保存在本地，与目前的web应用架构有很多不同。</span></p> 
  <p><span style="font-size:18px;"><strong>3、&nbsp; 智能合约高级语言</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 用户不可能直接编写以太坊虚拟机（EVM）字节码，所以以太坊提供了几种编写智能合约的高级语言。</span></p> 
  <p><span style="font-size:18px;">Solidity：类似JavaScript，这是以太坊推荐的旗舰语言，也是最流行的智能合约语言。具体用法参加Solidity文档，地址：https://solidity.readthedocs.io/en/latest/</span></p> 
  <p align="left"><span style="font-size:18px;">Serpent：类似Python风格，文档地址：https://github.com/ethereum/wiki/wiki/Serpent</span></p> 
  <p><span style="font-size:18px;">LLL：类似Lisp风格，目前已经被终止了。</span></p> 
  <p><span style="font-size:18px;">可以根据不同的习惯选择不同的高级语言，目前最流行的是Solidity。</span></p> 
  <p><span style="font-size:18px;"><strong>二、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在以太坊私有链上部署第一个智能合约</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 本文的智能合约采用以太坊官方的示例合约，功能就是在区块链上存储一个数字，并能够读取出来。代码如下：</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">contract SimpleStorage {</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp; uint storedData;</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp; function set(uint x) {</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; storedData = x;</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp; }</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp; function get() constant returns (uintretVal) {</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return storedData;</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">&nbsp;&nbsp;&nbsp; }</span></p> 
  <p align="left" style="background:rgb(222,234,246);"><span style="font-size:18px;">}</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 即使没有学过Solidity语言也可以大致看出，该合约set函数存储一个数字在X变量中，get函数从X变量中读取这个数字出来，下面对这个合约进行部署：</span></p> 
  <p align="left"><span style="font-size:18px;"><strong>1、&nbsp; 启动私有链</strong></span></p> 
  <p align="left"><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 启动以太坊私有链Geth和Ethereum-Wallet图形界面（本文使用Geth 1.41版本, Ethereum-Wallet 0.8.1版本）。如果不知道如何启动，请参考我上一篇文章《区块链开发（一）搭建基于以太坊的私有链环境》地址：<a href="http://blog.csdn.net/sportshark/article/details/51855007" rel="nofollow">http://blog.csdn.net/sportshark/article/details/51855007</a>，启动后界面如下, Ethereum-Wallet会显示红色的PRIVTE-NET标记。</span></p> 
  <p align="left" style="text-align:center;"><span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819111725982?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br></span></p> 
  <p align="left"></p> 
  <p><strong><span style="font-size:18px;">2、创建两个钱包</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 点击”ADD ACCOUNT” 按钮，添加一个钱包，程序会弹出一个对话框，提示输入两遍密码，输入完密码后，账号即创建成功。创建其他的账号，一样的操作，从上面的截图可以看到，有三个账号，一个是MAIN ACCOUNT，一个是ACCOUNT2，一个是ACCOUNT3</span></p> 
  <p><strong><span style="font-size:18px;">3、挖矿获取一些以太币</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 账号创建后，还没有以太币，需要在私有链上挖矿，切换到Geth界面，输入</span></p> 
  <p><span style="font-size:18px;">miner.start(1)</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; miner命令括号中的1表示用一个线程进行挖矿，如果不配置，就会让CPU全速运行，影响计算机的使用。</span></p> 
  <p style="text-align:center;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819111755255?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;运行一会后，主账号就会获取很多以太币，这个时候屏幕会快速刷屏，不用管，输入命令miner.stop()停止挖矿。</span></p> 
  <p><span style="font-size:18px;"><strong>4、&nbsp; 将一个钱包的以太币转到另一个钱包中</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 先点击ACCOUNT2账号，进入账号详情的界面，点击右侧的“COPY address”，把ACCOUNT2的地址拷贝下来，系统会提示你现在你处在一个测试网络，不要转入真正的以太币到这个账号。</span></p> 
  <p align="center"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819111826061?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 点击钱包中“SEND”按钮，从MAINACCOUNT给ACCOUNT2转入一定以太币，同时可以看到执行这笔交易的费用是0.00042个以太币。</span></p> 
  <p style="text-align:center;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819111852452?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p> 
  <p></p> 
  <p style="text-align:center;"><span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819111926381?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="">&nbsp; &nbsp; &nbsp;</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; 点击发送后会提示如输入密码，但这时还没有发送成功，根据区块链的交易规则，需要矿工的确认，并且每笔交易需要确认12个块，一个块是16秒的生成时间。切换到Geth程序，输入挖矿命令，直到ACCOUNT2上显示100个以太币，然后停止挖矿。</span></p> 
  <p><span style="font-size:18px;"><strong>5、&nbsp; 部署智能合约</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 点“CONTRACTS”，进入智能合约管理界面，点击“DEPOLY NEW CONTRACT”,开始部署智能合约，选择部署智能合约的账号，并输入智能合约的代码后，如下图</span></p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112023803?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;输入完毕后点击“DEPLOY”，系统会提示输入账号密码，因为部署智能合约是需要费用的。</span></p> 
  <p></p> 
  <p style="text-align:center;"><span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112045100?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; 这个时候是看不到部署的智能合约的，切换到Geth界面，进行挖矿，在12个块后，智能合约就能确认并显示出来。</span></p> 
  <p><span style="font-size:18px;"><strong>三、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;运行智能合约</strong></span></p> 
  <p><span style="font-size:18px;"><strong>1、 在本节点上运行智能合约</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 点击“CONTRACTS”进入智能合约界面，可以看到刚才部署的智能合约“<span style="color:rgb(64,64,64);">SimpleStorage</span>”，点击进入该智能合约，进入详情界面，其中有智能合约写入区域和读取区域，首先启动Geth的挖矿，然后在写入区域选择相应的智能合约函数SET，在下面的数值输入框输入想设置的数值，运行一会后就可以在读取区域看到智能合约函数GET中Retval的返回值有变化。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;其他智能合约的运行也是一样，无非就是函数多点，输入多点。</span></p> 
  <p style="text-align:center;"><span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112202113?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="">&nbsp;</span></p> 
  <p></p> 
  <p><span style="font-size:18px;"><strong>2、 在其他节点上运行智能合约</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 此时的智能合约只能自己能看到，别人是无法看到和运行的，如果其他人要运行你部署好的智能合约需要提供一些信息，就是其他教程中所说的智能合约的ABI和地址。</span></p> 
  <p><span style="font-size:18px;">进入刚部署的“<span style="color:rgb(64,64,64);">SimpleStorage</span>”智能合约界面，右侧有四个按钮</span></p> 
  <p><span style="font-size:18px;">A．“Deposit Eher”：向该智能合约发送以太币</span></p> 
  <p><span style="font-size:18px;">B.“Copy address”：拷贝该智能合约的地址</span></p> 
  <p><span style="font-size:18px;">C．“Show QR Code”：显示一个二维码，如果用手机扫描的话，显示该智能合约的地址</span></p> 
  <p><span style="font-size:18px;">D．“Show Interface”：显示该智能合约的JSON接口，也就是ABI</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 首先我们点“Copy address”，拷贝该智能合约的地址，然后点“Show Interface”将智能合约的JSON接口全部拷贝出来，在另一个需要运行智能合约的节点打开Ethereum-Wallet，打开“CONTRACTS”界面点击“WATCH CONTRACTS”添加一个智能合约。</span></p> 
  <p style="text-align:center;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112227538?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 如上图所示，CONTRACT NAME随便填，CONTRACT ADDRESS填写智能合约地址，JSON INTERFACE填写刚才在”Show Interface “中拷贝的内容。点OK后，就可以看到这个智能合约并运行了。</span></p> 
  <p><span style="font-size:18px;"><strong>四、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的部署原理</strong></span></p> 
  <p><strong><span style="font-size:18px;">1、智能合约的部署架构</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;本文介绍的智能合约的部署虽然是在图形化界面编译和执行，但其实最主要的是依赖于后台运行Geth的节点，此时Geth提供了一个RPC的接口向图形化界面的钱包提供区块链的信息。</span></p> 
  <p><strong><span style="font-size:18px;">RPC接口</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Geth在8545端口提供了JSON RPC API ，数据传输采用JSON格式，可以执行Web3库的各种命令，比如向前端，比如mist等图形化客户端提供区块链的信息，默认访问地址为<a href="http://localhost:8545/" rel="nofollow">http://localhost:8545</a>。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 我们部署一个智能合约时，首先Ethereum-Wallet调用SOLC智能合约编译器将代码编译成成EVM字节码，然后将EVM字节码通过Geth的RPC接口发送到以太坊网络，经过全网验证后，同时写入到每个Geth管理的区块链中，架构如下</span></p> 
  <p style="text-align:center;"><span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112303552?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></p> 
  <p><span style="font-size:18px;"><strong>2、 部署的数据流</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;首先代码先经过SOLC编译变为了二进制码，然后通过一笔交易来创建智能合约，该笔交易包含了创建者账号、智能合约内容、智能合约的地址这几个关键信息，其中智能合约地址的生成是由创建者的账号和发送的交易数作为随机数输入，通过Kecca-256加密算法重新创建一个地址作为账号。</span></p> 
  <p></p> 
  <div style="text-align:center;">
   <span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112419117?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br></span>
  </div> 
  <span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;部署过程中，需要通过交易来部署，同时数据要存储到区块链上，这些需要使用到GAS。</span> 
  <p></p> 
  <p><strong><span style="font-size:18px;">交易（Transactions）</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 一笔交易是一条消息，从一个账户发送到另一个账户。交易可以包含二进制数据（payload）和以太币。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户包含代码，该代码和输入数据会被执行。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 如果目标账户是零账户（账户地址是0），交易将创建一个新合约。正如上文所讲，这个智能合约地址不是零地址，而是由合约创建者的地址和该地址发出过的交易数量计算得到。创建合约交易的payload被当作EVM字节码执行。执行的输出做为合约代码被永久存储。这意味着，为了创建一个合约，你不需要向合约发送真正的合约代码，而是发送能够返回可执行代码的代码。</span></p> 
  <p><strong><span style="font-size:18px;">Gas</span></strong></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 以太坊上的每笔交易都会被收取一定数量的gas，gas的目的是限制执行交易所需的工作量，同时为执行支付费用。当EVM执行智能合约时，gas将按照特定规则被逐渐消耗，其实GAS就是以太币的比较小的单位，如果以太币比作100元，那么GAS可以看作是1分钱。如果只有以太币，会有问题，以太币是需要大家买卖的，市场会有价格波动。可能会出现比特币这样的状况，一天跌50%涨50%。这个对计算的成本是不能接受的，例如今天做一个加法需要十块钱，明天做一个加法需要一百块钱。所以这里引入gas来解耦。把市场的波动和计算的开销来解耦，也就是说以太币和gas之间是有汇率的，以太币涨没关系，gas价格下降就可以了。它要保证我做同样的计算，消耗的法币是一致的。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; gas price（gas价格，以太币计）是由交易创建者设置的，发送账户需要预付的交易费用 = gas price * gas amount。 如果执行结束还有gas剩余，这些gas将被返还给发送账户。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 前文中曾经提到部署智能合约使用了0.00042个以太币，换算成gas就是<span style="color:rgb(51,51,51);">21000</span><span style="color:rgb(51,51,51);">个</span><span style="color:rgb(51,51,51);">gas</span>。</span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 无论执行到什么位置，一旦gas被耗尽（比如降为负值），将会触发一个out-of-gas异常。当前调用帧所做的所有状态修改都将被回滚。</span></p> 
  <p><span style="font-size:18px;"><strong>五、&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;智能合约的运行原理</strong></span></p> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp; 智能合约是部署在区块链的代码，区块链本身不能执行代码，代码的执行是在本地的EVM中，实际上，部署在区块链上代码是能够在本地产生原智能合约代码的代码，可以理解区块链为一个数据库，而客户端从数据库中读取了存储的运行代码，并在本地运行后，将结果写入到了区块链这个数据库中。</span></p> 
  <div style="text-align:center;">
   <span style="font-size:18px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20160819112445523?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br></span>
  </div> 
  <p><span style="font-size:18px;">&nbsp; &nbsp; &nbsp; &nbsp;本质上，以太坊的钱包也是智能合约的一个应用，以太坊搭建的是一个可供编写各种应用的平台。</span><span style="font-size:18px;">下一篇，将详细讲述智能合约的开发编写和调试方法</span></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sportshark/article/details/52249607,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sportshark/article/details/52249607,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
