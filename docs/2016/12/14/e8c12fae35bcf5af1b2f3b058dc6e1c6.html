<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>高速公路ETC卡签之我见2-卡片消费 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="高速公路ETC卡签之我见2-卡片消费" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="﻿﻿ 本部分介绍用户卡当前最主要的一个使用场景----卡片消费的具体交易过程。高速公路使用的ETC卡支持消费、复合应用消费两种类型： 前者交易方式仅仅单独操作卡片的电子钱包文件，交易结果影响的主要也是电子钱包的余额，高速公路缴费已基本不再采取该类型的消费方式，正在拓展当中的商超交易场景可能采取该类型消费方式； 而后者交易方式除了操作电子钱包之外还会同时操作卡片中的复合消费专用文件，交易结束时，电子钱包的余额、复合消费专用文件的改写同步更新，要么都成功要么都失败，确保数据的一致性与完整性，高速公路缴费基本采用该方式。 1.&nbsp;&nbsp;消费交易 1.1.交易流程 1.2.流程说明 1.2.1.发出初始化消费命令 终端发出初始化消费（INITIALIZEFOR PURCHASE）命令启动消费交易。 1.2.2.处理初始化消费命令 IC卡收到初始化消费（INITIALIZEFOR PURCHASE ）命令后，将进行以下操作： 检查是否支持命令中提供的密钥索引号。如果不支持，则回送状态字“9403”（不支持的密钥索引），但不回送其他数据； 检查电子存折余额或电子钱包余额是否大于或等于交易金额。如果小于交易金额，则回送状态字“9401”（资金不足），但不回送其他数据。终端应采取的相应措施不在本部分的范围内。 在通过以上检查之后，IC卡将产生一个伪随机数并生成过程密钥用于验证MAC1。过程密钥（SESPK）（SESPK=3DES(DPK, CRN || PSN || EDCTSN最右2bytes)）是利用DPK并按照《高速公路ETC卡签之我见9-常见算法》中“过程密钥产生”所描述的机制产生的。用于产生该过程密钥的输入数据如下： SESPK：伪随机数（ICC）||电子存折脱机交易序号或电子钱包脱机交易序号||终端交易序号的最右两个字节 &nbsp; 1.2.3.产生 MAC1 使用伪随机数（ICC）和IC卡回送的电子存折脱机交易序号或电子钱包脱机交易序号，终端的安全存取模块（PSAM）将产生一个过程密钥（SESPK）和一个报文鉴别码（MAC1），供IC卡来验证PSAM的合法性。 MAC1的计算机制见《高速公路ETC卡签之我见9-常见算法》中的“MAC计算”。用SESPK对以下数据进行加密产生MAC1（按所列顺序）（MAC1=MAC(SESPK, 00, TV || TT || EDCID || Date || Time)）： 交易金额； 交易类型标识； 终端机编号； 交易日期（终端）； 交易时间（终端）。 1.2.4.发出消费命令 终端发出消费（DEBIT FORPURCHASE）命令。 1.2.5.验证 MAC1 在收到消费（DEBIT FORPURCHASE）命令后，IC卡将验证MAC1的有效性。如果MAC1有效，交易处理将继续执行。否则将向终端回送错误状态字‘9302’（MAC无效）。终端对错误状态的处理不在本部分范围内。 1.2.6.交易处理 IC卡从电子存折余额或电子钱包余额中扣减消费的金额，并将电子存折或电子钱包脱机交易序号加1。IC卡必须成功地完成以上所有步骤或者一个也不完成。只有余额和序号的更新均成功后，交易明细才可更新。 IC卡产生一个报文鉴别码（MAC2）供PSAM对其进行合法性检查，并通过DEBIT FOR PURCHASE命令的响应报文回送终端。MAC2的计算机制见《高速公路ETC卡签之我见9-常见算法》中的“MAC计算”。用SESPK对以下数据进行加密产生MAC2（MAC2,=MAC(SESPK, 00, TV)）： 交易金额。 &nbsp; IC卡按照《高速公路ETC卡签之我见9-常见算法》“MAC计算”中描述的机制用密钥DTK左右8位字节异或运算后的结果产生TAC。TAC将被写入终端交易明细，以便于主机进行交易验证。TAC以明文形式通过消费（DEBIT FOR PURCHASE）命令的响应报文从IC卡传送到终端，下面是用来生成TAC的数据： 交易金额； 交易类型标识； 终端机编号； 终端交易序号； 交易日期（终端）； 交易时间（终端）。 &nbsp; TACKey=DTK_L xor DTK_R TAC=MAC(TACKey, 00, TV ||TT || EDCID ||EDCTSN&nbsp;|| Date || Time) &nbsp; 对于电子存折消费交易和电子钱包消费交易，IC卡将用以下数据组成的一个记录更新交易明细。 电子存折脱机交易序号或电子钱包脱机交易序号； 交易金额； 交易类型标识； 终端机编号； 交易日期（终端）； 交易时间（终端）。 1.2.7.验证 MAC2 在收到IC卡（经过终端）传来的MAC2后，PSAM要验证MAC2的有效性。MAC2验证的结果被传送到终端以便采取必要的措施。 1.3.特别说明 上述交易过程以脱机交易（通过PSAM计算交易过程所需数据，如MA1等）为例；从交易过程看，用户卡其实是不关注也不知道交易过程所需的数据（如MAC1）是由什么设备计算出来的，它只校验数据（如MAC1）本身的有效性。所以，MAC1等数据的计算也可以其他设备计算，如加密机等，从而实现在线交易。 卡片交易过程产生的MAC2码，在交易过程就需进行合法性校验，合法性校验通过的方可认为交易已经完成并且合法；否则，认为该笔交易存在异常，业务上一般不得通过。通过此种方式降低伪卡交易带来的风险。 卡片交易过程产生的TAC码，主要是发卡机构用于校验交易流水的合法性，通常在清分结算时验证，卡片交易过程一般不验证合法性。 &nbsp; 2.&nbsp;&nbsp;复合应用消费交易 2.1.交易流程 &nbsp; 2.2.流程说明 从交易流程可看出，除了橙色背景的两个步骤外，其他的步骤与要求同复合交易的基本是一致的；将各个步骤中交易类型改为复合应用消费交易即可，数据的组装规则也完全一致，此处不再具体介绍，该章节仅对新增的两个步骤进行详细描述。 2.2.1.发出 UPDATECAPP DATA CACHE命令 终端发出UPDATE CAPP DATACACHE命令。 2.2.2.处理 UPDATECAPP DATA CACHE命令 IC卡在收到UPDATE CAP P DATACACHE命令后，将进行以下操作： 如果命令中存在 SFI 域，检查卡片当前应用下是否存在与命令中 SFI值相同的文件。如果不存在，回送状态字“6A82”（未找到文件），但不回送其它数据。终端应终止此次复合应用消费交易； 根据命令中的复合应用类型标识符，查询复合应用专用文件中是否存在相同标识符的记录。如果不存在，则回送状态字“6A83”（未找到记录），但不回送其它数据。终端应终止此次复合应用消费交易； 检查复合应用专用文件中相应记录中的应用锁定标志字节。如果应用锁定标志为设置，则回送状态字“9407”（复合应用禁止），但不回送其它数据。终端应终止此次复合应用消费交易； 检查命令中的数据域长度是否大于复合应用专用文件中相应记录的长度。如果大于，则回送状态字“6A84”（文件中存储空间不够），但不回送其它数据。终端应终止此次复合应用消费交易。 在通过以上检查后，IC卡应暂存命令中的SFI、记录号、复合应用类型标识符和数据域。复合应用专用文件中相应记录中的数据不得通过此命令更新。 3.&nbsp;&nbsp;TAC验证 TAC码，即交易认证码（Transaction&nbsp;Authentication Code / Transaction&nbsp;Authorization &nbsp;Cryptogram），是ETC用户卡在车道交易过程，卡片将交易时间、交易金额等数据项进行加密计算而产生的交易验证码。其设计目的是通过生成和验证基于密钥的TAC，能够保证交易记录产生的合法性，防止人为生成交易记录之类的欺诈行为。 TAC码是卡片在消费/复合消费过程中产生的，由用户卡中的“TAC密钥”对以下数据计算生成： ——交易金额； ——交易类型标识； ——终端机编号； ——终端交易序号； ——交易日期； ——交易时间。 &nbsp; 清分结算时，从流水中获取相关数据组装后与用户卡号一起传到加密机计算得到实际的TAC码（使用“TAC密钥”计算得到）。将该TAC码同流水中的TAC码进行比较，若两者相等，认为流水中的交易信息是真实有效的；若两者不相等，则认为流水中的交易信息可能不是卡片实际交易的，存在伪造的嫌疑。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;校验TAC码的数据具体组装格式如下： 交易金额4(字节)&nbsp;+ 交易类型标识(06/09)1(字节)&nbsp;+ 终端机编号6(字节)&nbsp;+ 终端交易序号4(字节)&nbsp;+ 终端交易日期4（字节）+终端交易时间3(字节) 另外，由于不同省份的“TAC密钥”各不相同，所以各省一般只能校验本省发行的卡片，无法校验外省发行的卡片的TAC码（与在哪里交易无关，省内外消费都是同样的判定）。 阅读更多" />
<meta property="og:description" content="﻿﻿ 本部分介绍用户卡当前最主要的一个使用场景----卡片消费的具体交易过程。高速公路使用的ETC卡支持消费、复合应用消费两种类型： 前者交易方式仅仅单独操作卡片的电子钱包文件，交易结果影响的主要也是电子钱包的余额，高速公路缴费已基本不再采取该类型的消费方式，正在拓展当中的商超交易场景可能采取该类型消费方式； 而后者交易方式除了操作电子钱包之外还会同时操作卡片中的复合消费专用文件，交易结束时，电子钱包的余额、复合消费专用文件的改写同步更新，要么都成功要么都失败，确保数据的一致性与完整性，高速公路缴费基本采用该方式。 1.&nbsp;&nbsp;消费交易 1.1.交易流程 1.2.流程说明 1.2.1.发出初始化消费命令 终端发出初始化消费（INITIALIZEFOR PURCHASE）命令启动消费交易。 1.2.2.处理初始化消费命令 IC卡收到初始化消费（INITIALIZEFOR PURCHASE ）命令后，将进行以下操作： 检查是否支持命令中提供的密钥索引号。如果不支持，则回送状态字“9403”（不支持的密钥索引），但不回送其他数据； 检查电子存折余额或电子钱包余额是否大于或等于交易金额。如果小于交易金额，则回送状态字“9401”（资金不足），但不回送其他数据。终端应采取的相应措施不在本部分的范围内。 在通过以上检查之后，IC卡将产生一个伪随机数并生成过程密钥用于验证MAC1。过程密钥（SESPK）（SESPK=3DES(DPK, CRN || PSN || EDCTSN最右2bytes)）是利用DPK并按照《高速公路ETC卡签之我见9-常见算法》中“过程密钥产生”所描述的机制产生的。用于产生该过程密钥的输入数据如下： SESPK：伪随机数（ICC）||电子存折脱机交易序号或电子钱包脱机交易序号||终端交易序号的最右两个字节 &nbsp; 1.2.3.产生 MAC1 使用伪随机数（ICC）和IC卡回送的电子存折脱机交易序号或电子钱包脱机交易序号，终端的安全存取模块（PSAM）将产生一个过程密钥（SESPK）和一个报文鉴别码（MAC1），供IC卡来验证PSAM的合法性。 MAC1的计算机制见《高速公路ETC卡签之我见9-常见算法》中的“MAC计算”。用SESPK对以下数据进行加密产生MAC1（按所列顺序）（MAC1=MAC(SESPK, 00, TV || TT || EDCID || Date || Time)）： 交易金额； 交易类型标识； 终端机编号； 交易日期（终端）； 交易时间（终端）。 1.2.4.发出消费命令 终端发出消费（DEBIT FORPURCHASE）命令。 1.2.5.验证 MAC1 在收到消费（DEBIT FORPURCHASE）命令后，IC卡将验证MAC1的有效性。如果MAC1有效，交易处理将继续执行。否则将向终端回送错误状态字‘9302’（MAC无效）。终端对错误状态的处理不在本部分范围内。 1.2.6.交易处理 IC卡从电子存折余额或电子钱包余额中扣减消费的金额，并将电子存折或电子钱包脱机交易序号加1。IC卡必须成功地完成以上所有步骤或者一个也不完成。只有余额和序号的更新均成功后，交易明细才可更新。 IC卡产生一个报文鉴别码（MAC2）供PSAM对其进行合法性检查，并通过DEBIT FOR PURCHASE命令的响应报文回送终端。MAC2的计算机制见《高速公路ETC卡签之我见9-常见算法》中的“MAC计算”。用SESPK对以下数据进行加密产生MAC2（MAC2,=MAC(SESPK, 00, TV)）： 交易金额。 &nbsp; IC卡按照《高速公路ETC卡签之我见9-常见算法》“MAC计算”中描述的机制用密钥DTK左右8位字节异或运算后的结果产生TAC。TAC将被写入终端交易明细，以便于主机进行交易验证。TAC以明文形式通过消费（DEBIT FOR PURCHASE）命令的响应报文从IC卡传送到终端，下面是用来生成TAC的数据： 交易金额； 交易类型标识； 终端机编号； 终端交易序号； 交易日期（终端）； 交易时间（终端）。 &nbsp; TACKey=DTK_L xor DTK_R TAC=MAC(TACKey, 00, TV ||TT || EDCID ||EDCTSN&nbsp;|| Date || Time) &nbsp; 对于电子存折消费交易和电子钱包消费交易，IC卡将用以下数据组成的一个记录更新交易明细。 电子存折脱机交易序号或电子钱包脱机交易序号； 交易金额； 交易类型标识； 终端机编号； 交易日期（终端）； 交易时间（终端）。 1.2.7.验证 MAC2 在收到IC卡（经过终端）传来的MAC2后，PSAM要验证MAC2的有效性。MAC2验证的结果被传送到终端以便采取必要的措施。 1.3.特别说明 上述交易过程以脱机交易（通过PSAM计算交易过程所需数据，如MA1等）为例；从交易过程看，用户卡其实是不关注也不知道交易过程所需的数据（如MAC1）是由什么设备计算出来的，它只校验数据（如MAC1）本身的有效性。所以，MAC1等数据的计算也可以其他设备计算，如加密机等，从而实现在线交易。 卡片交易过程产生的MAC2码，在交易过程就需进行合法性校验，合法性校验通过的方可认为交易已经完成并且合法；否则，认为该笔交易存在异常，业务上一般不得通过。通过此种方式降低伪卡交易带来的风险。 卡片交易过程产生的TAC码，主要是发卡机构用于校验交易流水的合法性，通常在清分结算时验证，卡片交易过程一般不验证合法性。 &nbsp; 2.&nbsp;&nbsp;复合应用消费交易 2.1.交易流程 &nbsp; 2.2.流程说明 从交易流程可看出，除了橙色背景的两个步骤外，其他的步骤与要求同复合交易的基本是一致的；将各个步骤中交易类型改为复合应用消费交易即可，数据的组装规则也完全一致，此处不再具体介绍，该章节仅对新增的两个步骤进行详细描述。 2.2.1.发出 UPDATECAPP DATA CACHE命令 终端发出UPDATE CAPP DATACACHE命令。 2.2.2.处理 UPDATECAPP DATA CACHE命令 IC卡在收到UPDATE CAP P DATACACHE命令后，将进行以下操作： 如果命令中存在 SFI 域，检查卡片当前应用下是否存在与命令中 SFI值相同的文件。如果不存在，回送状态字“6A82”（未找到文件），但不回送其它数据。终端应终止此次复合应用消费交易； 根据命令中的复合应用类型标识符，查询复合应用专用文件中是否存在相同标识符的记录。如果不存在，则回送状态字“6A83”（未找到记录），但不回送其它数据。终端应终止此次复合应用消费交易； 检查复合应用专用文件中相应记录中的应用锁定标志字节。如果应用锁定标志为设置，则回送状态字“9407”（复合应用禁止），但不回送其它数据。终端应终止此次复合应用消费交易； 检查命令中的数据域长度是否大于复合应用专用文件中相应记录的长度。如果大于，则回送状态字“6A84”（文件中存储空间不够），但不回送其它数据。终端应终止此次复合应用消费交易。 在通过以上检查后，IC卡应暂存命令中的SFI、记录号、复合应用类型标识符和数据域。复合应用专用文件中相应记录中的数据不得通过此命令更新。 3.&nbsp;&nbsp;TAC验证 TAC码，即交易认证码（Transaction&nbsp;Authentication Code / Transaction&nbsp;Authorization &nbsp;Cryptogram），是ETC用户卡在车道交易过程，卡片将交易时间、交易金额等数据项进行加密计算而产生的交易验证码。其设计目的是通过生成和验证基于密钥的TAC，能够保证交易记录产生的合法性，防止人为生成交易记录之类的欺诈行为。 TAC码是卡片在消费/复合消费过程中产生的，由用户卡中的“TAC密钥”对以下数据计算生成： ——交易金额； ——交易类型标识； ——终端机编号； ——终端交易序号； ——交易日期； ——交易时间。 &nbsp; 清分结算时，从流水中获取相关数据组装后与用户卡号一起传到加密机计算得到实际的TAC码（使用“TAC密钥”计算得到）。将该TAC码同流水中的TAC码进行比较，若两者相等，认为流水中的交易信息是真实有效的；若两者不相等，则认为流水中的交易信息可能不是卡片实际交易的，存在伪造的嫌疑。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;校验TAC码的数据具体组装格式如下： 交易金额4(字节)&nbsp;+ 交易类型标识(06/09)1(字节)&nbsp;+ 终端机编号6(字节)&nbsp;+ 终端交易序号4(字节)&nbsp;+ 终端交易日期4（字节）+终端交易时间3(字节) 另外，由于不同省份的“TAC密钥”各不相同，所以各省一般只能校验本省发行的卡片，无法校验外省发行的卡片的TAC码（与在哪里交易无关，省内外消费都是同样的判定）。 阅读更多" />
<link rel="canonical" href="https://mlh.app/2016/12/14/e8c12fae35bcf5af1b2f3b058dc6e1c6.html" />
<meta property="og:url" content="https://mlh.app/2016/12/14/e8c12fae35bcf5af1b2f3b058dc6e1c6.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-12-14T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"﻿﻿ 本部分介绍用户卡当前最主要的一个使用场景----卡片消费的具体交易过程。高速公路使用的ETC卡支持消费、复合应用消费两种类型： 前者交易方式仅仅单独操作卡片的电子钱包文件，交易结果影响的主要也是电子钱包的余额，高速公路缴费已基本不再采取该类型的消费方式，正在拓展当中的商超交易场景可能采取该类型消费方式； 而后者交易方式除了操作电子钱包之外还会同时操作卡片中的复合消费专用文件，交易结束时，电子钱包的余额、复合消费专用文件的改写同步更新，要么都成功要么都失败，确保数据的一致性与完整性，高速公路缴费基本采用该方式。 1.&nbsp;&nbsp;消费交易 1.1.交易流程 1.2.流程说明 1.2.1.发出初始化消费命令 终端发出初始化消费（INITIALIZEFOR PURCHASE）命令启动消费交易。 1.2.2.处理初始化消费命令 IC卡收到初始化消费（INITIALIZEFOR PURCHASE ）命令后，将进行以下操作： 检查是否支持命令中提供的密钥索引号。如果不支持，则回送状态字“9403”（不支持的密钥索引），但不回送其他数据； 检查电子存折余额或电子钱包余额是否大于或等于交易金额。如果小于交易金额，则回送状态字“9401”（资金不足），但不回送其他数据。终端应采取的相应措施不在本部分的范围内。 在通过以上检查之后，IC卡将产生一个伪随机数并生成过程密钥用于验证MAC1。过程密钥（SESPK）（SESPK=3DES(DPK, CRN || PSN || EDCTSN最右2bytes)）是利用DPK并按照《高速公路ETC卡签之我见9-常见算法》中“过程密钥产生”所描述的机制产生的。用于产生该过程密钥的输入数据如下： SESPK：伪随机数（ICC）||电子存折脱机交易序号或电子钱包脱机交易序号||终端交易序号的最右两个字节 &nbsp; 1.2.3.产生 MAC1 使用伪随机数（ICC）和IC卡回送的电子存折脱机交易序号或电子钱包脱机交易序号，终端的安全存取模块（PSAM）将产生一个过程密钥（SESPK）和一个报文鉴别码（MAC1），供IC卡来验证PSAM的合法性。 MAC1的计算机制见《高速公路ETC卡签之我见9-常见算法》中的“MAC计算”。用SESPK对以下数据进行加密产生MAC1（按所列顺序）（MAC1=MAC(SESPK, 00, TV || TT || EDCID || Date || Time)）： 交易金额； 交易类型标识； 终端机编号； 交易日期（终端）； 交易时间（终端）。 1.2.4.发出消费命令 终端发出消费（DEBIT FORPURCHASE）命令。 1.2.5.验证 MAC1 在收到消费（DEBIT FORPURCHASE）命令后，IC卡将验证MAC1的有效性。如果MAC1有效，交易处理将继续执行。否则将向终端回送错误状态字‘9302’（MAC无效）。终端对错误状态的处理不在本部分范围内。 1.2.6.交易处理 IC卡从电子存折余额或电子钱包余额中扣减消费的金额，并将电子存折或电子钱包脱机交易序号加1。IC卡必须成功地完成以上所有步骤或者一个也不完成。只有余额和序号的更新均成功后，交易明细才可更新。 IC卡产生一个报文鉴别码（MAC2）供PSAM对其进行合法性检查，并通过DEBIT FOR PURCHASE命令的响应报文回送终端。MAC2的计算机制见《高速公路ETC卡签之我见9-常见算法》中的“MAC计算”。用SESPK对以下数据进行加密产生MAC2（MAC2,=MAC(SESPK, 00, TV)）： 交易金额。 &nbsp; IC卡按照《高速公路ETC卡签之我见9-常见算法》“MAC计算”中描述的机制用密钥DTK左右8位字节异或运算后的结果产生TAC。TAC将被写入终端交易明细，以便于主机进行交易验证。TAC以明文形式通过消费（DEBIT FOR PURCHASE）命令的响应报文从IC卡传送到终端，下面是用来生成TAC的数据： 交易金额； 交易类型标识； 终端机编号； 终端交易序号； 交易日期（终端）； 交易时间（终端）。 &nbsp; TACKey=DTK_L xor DTK_R TAC=MAC(TACKey, 00, TV ||TT || EDCID ||EDCTSN&nbsp;|| Date || Time) &nbsp; 对于电子存折消费交易和电子钱包消费交易，IC卡将用以下数据组成的一个记录更新交易明细。 电子存折脱机交易序号或电子钱包脱机交易序号； 交易金额； 交易类型标识； 终端机编号； 交易日期（终端）； 交易时间（终端）。 1.2.7.验证 MAC2 在收到IC卡（经过终端）传来的MAC2后，PSAM要验证MAC2的有效性。MAC2验证的结果被传送到终端以便采取必要的措施。 1.3.特别说明 上述交易过程以脱机交易（通过PSAM计算交易过程所需数据，如MA1等）为例；从交易过程看，用户卡其实是不关注也不知道交易过程所需的数据（如MAC1）是由什么设备计算出来的，它只校验数据（如MAC1）本身的有效性。所以，MAC1等数据的计算也可以其他设备计算，如加密机等，从而实现在线交易。 卡片交易过程产生的MAC2码，在交易过程就需进行合法性校验，合法性校验通过的方可认为交易已经完成并且合法；否则，认为该笔交易存在异常，业务上一般不得通过。通过此种方式降低伪卡交易带来的风险。 卡片交易过程产生的TAC码，主要是发卡机构用于校验交易流水的合法性，通常在清分结算时验证，卡片交易过程一般不验证合法性。 &nbsp; 2.&nbsp;&nbsp;复合应用消费交易 2.1.交易流程 &nbsp; 2.2.流程说明 从交易流程可看出，除了橙色背景的两个步骤外，其他的步骤与要求同复合交易的基本是一致的；将各个步骤中交易类型改为复合应用消费交易即可，数据的组装规则也完全一致，此处不再具体介绍，该章节仅对新增的两个步骤进行详细描述。 2.2.1.发出 UPDATECAPP DATA CACHE命令 终端发出UPDATE CAPP DATACACHE命令。 2.2.2.处理 UPDATECAPP DATA CACHE命令 IC卡在收到UPDATE CAP P DATACACHE命令后，将进行以下操作： 如果命令中存在 SFI 域，检查卡片当前应用下是否存在与命令中 SFI值相同的文件。如果不存在，回送状态字“6A82”（未找到文件），但不回送其它数据。终端应终止此次复合应用消费交易； 根据命令中的复合应用类型标识符，查询复合应用专用文件中是否存在相同标识符的记录。如果不存在，则回送状态字“6A83”（未找到记录），但不回送其它数据。终端应终止此次复合应用消费交易； 检查复合应用专用文件中相应记录中的应用锁定标志字节。如果应用锁定标志为设置，则回送状态字“9407”（复合应用禁止），但不回送其它数据。终端应终止此次复合应用消费交易； 检查命令中的数据域长度是否大于复合应用专用文件中相应记录的长度。如果大于，则回送状态字“6A84”（文件中存储空间不够），但不回送其它数据。终端应终止此次复合应用消费交易。 在通过以上检查后，IC卡应暂存命令中的SFI、记录号、复合应用类型标识符和数据域。复合应用专用文件中相应记录中的数据不得通过此命令更新。 3.&nbsp;&nbsp;TAC验证 TAC码，即交易认证码（Transaction&nbsp;Authentication Code / Transaction&nbsp;Authorization &nbsp;Cryptogram），是ETC用户卡在车道交易过程，卡片将交易时间、交易金额等数据项进行加密计算而产生的交易验证码。其设计目的是通过生成和验证基于密钥的TAC，能够保证交易记录产生的合法性，防止人为生成交易记录之类的欺诈行为。 TAC码是卡片在消费/复合消费过程中产生的，由用户卡中的“TAC密钥”对以下数据计算生成： ——交易金额； ——交易类型标识； ——终端机编号； ——终端交易序号； ——交易日期； ——交易时间。 &nbsp; 清分结算时，从流水中获取相关数据组装后与用户卡号一起传到加密机计算得到实际的TAC码（使用“TAC密钥”计算得到）。将该TAC码同流水中的TAC码进行比较，若两者相等，认为流水中的交易信息是真实有效的；若两者不相等，则认为流水中的交易信息可能不是卡片实际交易的，存在伪造的嫌疑。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;校验TAC码的数据具体组装格式如下： 交易金额4(字节)&nbsp;+ 交易类型标识(06/09)1(字节)&nbsp;+ 终端机编号6(字节)&nbsp;+ 终端交易序号4(字节)&nbsp;+ 终端交易日期4（字节）+终端交易时间3(字节) 另外，由于不同省份的“TAC密钥”各不相同，所以各省一般只能校验本省发行的卡片，无法校验外省发行的卡片的TAC码（与在哪里交易无关，省内外消费都是同样的判定）。 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2016/12/14/e8c12fae35bcf5af1b2f3b058dc6e1c6.html","headline":"高速公路ETC卡签之我见2-卡片消费","dateModified":"2016-12-14T00:00:00+08:00","datePublished":"2016-12-14T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2016/12/14/e8c12fae35bcf5af1b2f3b058dc6e1c6.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>高速公路ETC卡签之我见2-卡片消费</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div>
   ﻿﻿
  </div> 
  <span style="font-family:'宋体';font-size:14px;"></span>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">本部分介绍用户卡当前最主要的一个使用场景</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">----</span></span><span style="font-family:'宋体';">卡片消费</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-size:14px;"><span style="font-family:'宋体';">的具体交易过程。高速公路使用的</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ETC</span></span><span style="font-family:'宋体';">卡支持消费、复合应用消费两种类型：</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-family:'宋体';"><span style="font-size:14px;">前者交易方式仅仅单独操作卡片的电子钱包文件，交易结果影响的主要也是电子钱包的余额，高速公路缴费已基本不再采取该类型的消费方式，正在拓展当中的商超交易场景可能采取该类型消费方式；</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-family:'宋体';"><span style="font-size:14px;">而后者交易方式除了操作电子钱包之外还会同时操作卡片中的复合消费专用文件，交易结束时，电子钱包的余额、复合消费专用文件的改写同步更新，要么都成功要么都失败，确保数据的一致性与完整性，高速公路缴费基本采用该方式。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h1 style="text-indent:-21.25pt;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:32px;">1.</span><span style="font:7pt/normal 'Times New Roman';">&nbsp;&nbsp;</span></span></span><span style="font-family:'宋体';"><span style="font-size:32px;">消费交易</span></span></h1> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h2 style="text-indent:-1cm;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:'Calibri Light';font-size:24px;">1.1.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">交易流程</span></span></h2> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p align="center" style="text-align:center;"><span lang="en-us" xml:lang="en-us"><span style="font-family:'宋体';font-size:14px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20161214142629750?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVpZGx5bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h2 style="text-indent:-1cm;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:'Calibri Light';font-size:24px;">1.2.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">流程说明</span></span></h2> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.1.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">发出初始化消费命令</span></span><span style="font-family:Calibri;font-size:24px;"></span></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">终端发出初始化消费（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">INITIALIZEFOR PURCHASE</span></span><span style="font-family:'宋体';">）命令启动消费交易。</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><a name="_Toc446957606"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.2.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">处理初始化消费命令</span></span></a><span style="font-family:Calibri;font-size:24px;"></span></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡收到初始化消费（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">INITIALIZEFOR PURCHASE </span></span><span style="font-family:'宋体';">）命令后，将进行以下操作：</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">检查是否支持命令中提供的密钥索引号。如果不支持，则回送状态字“</span><span lang="en-us" xml:lang="en-us">9403</span><span style="font-family:'宋体';">”（不支持的密钥索引），但不回送其他数据；</span><span></span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">检查电子存折余额或电子钱包余额是否大于或等于交易金额。如果小于交易金额，则回送状态字“</span><span lang="en-us" xml:lang="en-us">9401</span><span style="font-family:'宋体';">”（资金不足），但不回送其他数据。终端应采取的相应措施不在本部分的范围内。</span><span></span></p> </li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">在通过以上检查之后，</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡将产生一个伪随机数并生成过程密钥用于验证</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC1</span></span><span style="font-family:'宋体';">。过程密钥（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SESPK</span></span><span style="font-family:'宋体';">）（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SESPK=3DES(DPK, CRN || PSN || EDCTSN</span></span><span style="font-family:'宋体';">最右</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">2bytes)</span></span><span style="font-family:'宋体';">）是利用</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">DPK</span></span><span style="font-family:'宋体';">并按照《高速公路</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ETC</span></span><span style="font-family:'宋体';">卡签之我见</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">9-</span></span><span style="font-family:'宋体';">常见算法》中</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-family:'宋体';"><span style="font-size:14px;">“过程密钥产生”所描述的机制产生的。用于产生该过程密钥的输入数据如下：</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:0cm;"><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SESPK</span></span><span style="font-family:'宋体';">：伪随机数（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ICC</span></span><span style="font-family:'宋体';">）</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">||</span></span><span style="font-family:'宋体';">电子存折脱机交易序号或电子钱包脱机交易序号</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">||</span></span><span style="font-family:'宋体';">终端交易序号的最右两个字节</span><span><span style="font-family:Calibri;"></span></span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><a name="_Toc446957607"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.3.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-size:24px;"><span style="font-family:'宋体';">产生</span><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;"> MAC1</span></span></span></a></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">使用伪随机数（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ICC</span></span><span style="font-family:'宋体';">）和</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡回送的电子存折脱机交易序号或电子钱包脱机交易序号，终端的安全存取模块（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">PSAM</span></span><span style="font-family:'宋体';">）将产生一个过程密钥（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SESPK</span></span><span style="font-family:'宋体';">）和一个报文鉴别码（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC1</span></span><span style="font-family:'宋体';">），供</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡来验证</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">PSAM</span></span><span style="font-family:'宋体';">的合法性。</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC1</span></span><span style="font-family:'宋体';">的计算机制见《高速公路</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ETC</span></span><span style="font-family:'宋体';">卡签之我见</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">9-</span></span><span style="font-family:'宋体';">常见算法》中的</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-size:14px;"><span style="font-family:'宋体';">“</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC</span></span><span style="font-family:'宋体';">计算”。用</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SESPK</span></span><span style="font-family:'宋体';">对以下数据进行加密产生</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC1</span></span><span style="font-family:'宋体';">（按所列顺序）（</span></span><span style="font-family:Calibri;"><span style="font-size:14px;"></span><span lang="en-us" xml:lang="en-us"><span style="font-size:14px;">MAC1=MAC(SESPK, 00, TV || TT || EDCID || Date || Time)</span></span></span><span style="font-family:'宋体';"><span style="font-size:14px;">）：</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li>
    <ul style="list-style-type:disc;">
     <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易金额；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
     <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易类型标识；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
     <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端机编号；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
     <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易日期（终端）；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
     <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易时间（终端）。</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
    </ul></li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><a name="_Toc446957608"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.4.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">发出消费命令</span></span></a></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">终端发出消费（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">DEBIT FORPURCHASE</span></span><span style="font-family:'宋体';">）命令。</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><a name="_Toc446957609"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.5.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-size:24px;"><span style="font-family:'宋体';">验证</span><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;"> MAC1</span></span></span></a><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:24px;"></span></span></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">在收到消费（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">DEBIT FORPURCHASE</span></span><span style="font-family:'宋体';">）命令后，</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡将验证</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC1</span></span><span style="font-family:'宋体';">的有效性。如果</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC1</span></span><span style="font-family:'宋体';">有效，交易处理将继续执行。否则将向终端回送错误状态字‘</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">9302</span></span><span style="font-family:'宋体';">’（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC</span></span><span style="font-family:'宋体';">无效）。终端对错误状态的处理不在本部分范围内。</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><a name="_Toc446957610"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.6.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">交易处理</span></span></a><span style="font-family:Calibri;font-size:24px;"></span></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡从电子存折余额或电子钱包余额中扣减消费的金额，</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-size:14px;"><span style="font-family:'宋体';">并将电子存折或电子钱包脱机交易序号加</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">1</span></span><span style="font-family:'宋体';">。</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡必须成功地完成以上所有步骤或者一个也不完成。只有余额和序号的更新均成功后，交易明细才可更新。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡产生一个报文鉴别码（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2</span></span><span style="font-family:'宋体';">）供</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">PSAM</span></span><span style="font-family:'宋体';">对其进行合法性检查，并通过</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">DEBIT FOR PURCHASE</span></span><span style="font-family:'宋体';">命令的响应报文回送终端。</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2</span></span><span style="font-family:'宋体';">的计算机制见《高速公路</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ETC</span></span><span style="font-family:'宋体';">卡签之我见</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">9-</span></span><span style="font-family:'宋体';">常见算法》中的</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-size:14px;"><span style="font-family:'宋体';">“</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC</span></span><span style="font-family:'宋体';">计算”。用</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SESPK</span></span><span style="font-family:'宋体';">对以下数据进行加密产生</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2</span></span><span style="font-family:'宋体';">（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2,=MAC(SESPK, 00, TV)</span></span><span style="font-family:'宋体';">）：</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易金额。</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡按照《高速公路</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">ETC</span></span><span style="font-family:'宋体';">卡签之我见</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">9-</span></span><span style="font-family:'宋体';">常见算法》</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-size:14px;"><span style="font-family:'宋体';">“</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC</span></span><span style="font-family:'宋体';">计算”中描述的机制用密钥</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">DTK</span></span><span style="font-family:'宋体';">左右</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">8</span></span><span style="font-family:'宋体';">位字节异或运算后的结果产生</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">TAC</span></span><span style="font-family:'宋体';">。</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">TAC</span></span><span style="font-family:'宋体';">将被写入终端交易明细，以便于主机进行交易验证。</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">TAC</span></span><span style="font-family:'宋体';">以明文形式通过消费（</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">DEBIT FOR PURCHASE</span></span><span style="font-family:'宋体';">）命令的响应报文从</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡传送到终端，下面是用来生成</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">TAC</span></span><span style="font-family:'宋体';">的数据：</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易金额；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易类型标识；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端机编号；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端交易序号；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易日期（终端）；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易时间（终端）。</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">TACKey=DTK_L xor DTK_R</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;"><span style="font-size:14px;">TAC=MAC(TACKey, 00, TV ||TT || EDCID ||EDCTSN<span>&nbsp;</span></span><span style="font-size:14px;">|| Date || Time)</span></span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">对于电子存折消费交易和电子钱包消费交易，</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡将用以下数据组成的一个记录更新交易明细。</span></span><span style="font-family:Calibri;font-size:14px;"></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">电子存折脱机交易序号或电子钱包脱机交易序号；</span><span> </span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易金额；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易类型标识；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端机编号；</span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易日期（终端）；</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">交易时间（终端）。</span><span lang="en-us" xml:lang="en-us"> </span> </p> </li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><a name="_Toc446957611"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">1.2.7.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-size:24px;"><span style="font-family:'宋体';">验证</span><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;"> MAC2</span></span></span></a></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">在收到</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡（经过终端）传来的</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2</span></span><span style="font-family:'宋体';">后，</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">PSAM</span></span><span style="font-family:'宋体';">要验证</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2</span></span><span style="font-family:'宋体';">的有效性。</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">MAC2</span></span><span style="font-family:'宋体';">验证的结果被传送到终端以便采取必要的措施。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h2 style="text-indent:-1cm;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:'Calibri Light';font-size:24px;">1.3.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">特别说明</span></span></h2> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">上述交易过程以脱机交易（通过</span><span lang="en-us" xml:lang="en-us">PSAM</span><span style="font-family:'宋体';">计算交易过程所需数据，如</span><span lang="en-us" xml:lang="en-us">MA1</span><span style="font-family:'宋体';">等）为例；从交易过程看，用户卡其实是不关注也不知道交易过程所需的数据（如</span><span lang="en-us" xml:lang="en-us">MAC1</span><span style="font-family:'宋体';">）是由什么设备计算出来的，它只校验数据（如</span><span lang="en-us" xml:lang="en-us">MAC1</span><span style="font-family:'宋体';">）本身的有效性。所以，</span><span lang="en-us" xml:lang="en-us">MAC1</span><span style="font-family:'宋体';">等数据的计算也可以其他设备计算，如加密机等，从而实现在线交易。</span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">卡片交易过程产生的</span><span lang="en-us" xml:lang="en-us">MAC2</span><span style="font-family:'宋体';">码，在交易过程就需进行合法性校验，合法性校验通过的方可认为交易已经完成并且合法；否则，认为该笔交易存在异常，业务上一般不得通过。通过此种方式降低伪卡交易带来的风险。</span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">卡片交易过程产生的</span><span lang="en-us" xml:lang="en-us">TAC</span><span style="font-family:'宋体';">码，主要是发卡机构用于校验交易流水的合法性，通常在清分结算时验证，卡片交易过程一般不验证合法性。</span></p> </li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h1 style="text-indent:-21.25pt;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:32px;">2.</span><span style="font:7pt/normal 'Times New Roman';">&nbsp;&nbsp;</span></span></span><span style="font-family:'宋体';"><span style="font-size:32px;">复合应用消费交易</span></span></h1> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h2 style="text-indent:-1cm;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:'Calibri Light';font-size:24px;">2.1.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">交易流程</span></span></h2> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span lang="en-us" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p align="center" style="text-align:center;"><span lang="en-us" xml:lang="en-us"><span style="font-family:'宋体';font-size:14px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20161214142652516?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvSGVpZGx5bg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h2 style="text-indent:-1cm;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:'Calibri Light';font-size:24px;">2.2.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-family:'宋体';"><span style="font-size:24px;">流程说明</span></span></h2> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-family:'宋体';"><span style="font-size:14px;">从交易流程可看出，除了橙色背景的两个步骤外，其他的步骤与要求</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-family:'宋体';"><span style="font-size:14px;">同</span></span><span style="font-family:Calibri;font-size:14px;"></span><span style="font-family:'宋体';"><span style="font-size:14px;">复合交易的基本是一致的；将各个步骤中交易类型改为复合应用消费交易即可，数据的组装规则也完全一致，此处不再具体介绍，该章节仅对新增的两个步骤进行详细描述。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">2.2.1.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-size:24px;"><span style="font-family:'宋体';">发出</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us"> UPDATECAPP DATA CACHE</span></span><span style="font-family:'宋体';">命令</span></span></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">终端发出</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">UPDATE CAPP DATACACHE</span></span><span style="font-family:'宋体';">命令。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h3 style="text-indent:-35.45pt;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:24px;">2.2.2.</span><span style="font:7pt/normal 'Times New Roman';"></span></span></span><span style="font-size:24px;"><span style="font-family:'宋体';">处理</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us"> UPDATECAPP DATA CACHE</span></span><span style="font-family:'宋体';">命令</span></span></h3> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡在收到</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">UPDATE CAP P DATACACHE</span></span><span style="font-family:'宋体';">命令后，将进行以下操作：</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <ul style="list-style-type:disc;">
   <li style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">如果命令中存在</span><span lang="en-us" xml:lang="en-us"> SFI </span><span style="font-family:'宋体';">域，检查卡片当前应用下是否存在与命令中</span><span lang="en-us" xml:lang="en-us"> SFI</span><span style="font-family:'宋体';">值相同的文件。如果不存在，回送状态字“</span><span lang="en-us" xml:lang="en-us">6A82</span><span style="font-family:'宋体';">”（未找到文件），但不回送其它数据。终端应终止此次复合应用消费交易；</span><span></span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">根据命令中的复合应用类型标识符，查询复合应用专用文件中是否存在相同标识符的记录。如果不存在，则回送状态字“</span><span lang="en-us" xml:lang="en-us">6A83</span><span style="font-family:'宋体';">”（未找到记录），但不回送其它数据。</span><span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端应终止此次复合应用消费交易；</span><span lang="en-us" xml:lang="en-us"></span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">检查复合应用专用文件中相应记录中的应用锁定标志字节。如果应用锁定标志为设置，则回送状态字“</span><span lang="en-us" xml:lang="en-us">9407</span><span style="font-family:'宋体';">”（复合应用禁止），但不回送其它数据。</span><span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端应终止此次复合应用消费交易；</span><span lang="en-us" xml:lang="en-us"></span></p> </li>
   <li style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <p style="color:rgb(0,0,0);font-family:Calibri, 'sans-serif';font-size:12pt;font-style:normal;font-weight:normal;"> <span style="font-family:'宋体';">检查命令中的数据域长度是否大于复合应用专用文件中相应记录的长度。如果大于，则回送状态字“</span><span lang="en-us" xml:lang="en-us">6A84</span><span style="font-family:'宋体';">”（文件中存储空间不够），但不回送其它数据。</span><span lang="en-us" style="font-family:'宋体';" xml:lang="en-us">终端应终止此次复合应用消费交易。</span></p> </li>
  </ul>
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';">在通过以上检查后，</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">IC</span></span><span style="font-family:'宋体';">卡应暂存命令中的</span><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">SFI</span></span><span style="font-family:'宋体';">、记录号、复合应用类型标识符和数据域。复合应用专用文件中相应记录中的数据不得通过此命令更新。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <h1 style="text-indent:-21.25pt;"><span lang="en-us" xml:lang="en-us"><span><span style="font-family:Calibri;font-size:32px;">3.</span><span style="font:7pt/normal 'Times New Roman';">&nbsp;&nbsp;</span></span></span><span style="font-size:32px;"><span style="font-family:Calibri;"><span lang="en-us" xml:lang="en-us">TAC</span></span><span style="font-family:'宋体';">验证</span></span></h1> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p align="left" style="text-align:left;text-indent:21pt;"><span style="font-size:14px;"><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码，即交易认证码（</span></span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;"><span style="font-size:14px;">Transaction<span>&nbsp;</span></span><span style="font-size:14px;">Authentication Code / Transaction</span><span><span style="font-size:14px;">&nbsp;</span></span><span style="font-size:14px;">Authorization </span><span><span style="font-size:14px;">&nbsp;</span></span><span style="font-size:14px;">Cryptogram</span></span></span><span style="font-size:14px;"><span style="font-family:'宋体';line-height:150%;">），是</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">ETC</span></span><span style="font-family:'宋体';line-height:150%;">用户卡在车道交易过程，卡片将交易时间、交易金额等数据项进行加密计算而产生的交易验证码。其设计目的是通过生成和验证基于密钥的</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">，能够保证交易记录产生的合法性，防止人为生成交易记录之类的欺诈行为。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码是卡片在消费</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">/</span></span><span style="font-family:'宋体';line-height:150%;">复合消费过程中产生的，由用户卡中的“</span><strong><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">密钥</span></strong><span style="font-family:'宋体';line-height:150%;">”对以下数据计算生成：</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><strong><span style="font-family:'宋体';line-height:150%;"><span style="font-size:14px;">——交易金额；</span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><strong><span style="font-family:'宋体';line-height:150%;"><span style="font-size:14px;">——交易类型标识；</span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><strong><span style="font-family:'宋体';line-height:150%;"><span style="font-size:14px;">——终端机编号；</span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><strong><span style="font-family:'宋体';line-height:150%;"><span style="font-size:14px;">——终端交易序号；</span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><strong><span style="font-family:'宋体';line-height:150%;"><span style="font-size:14px;">——交易日期；</span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><strong><span style="font-family:'宋体';line-height:150%;"><span style="font-size:14px;">——交易时间。</span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;font-size:14px;">&nbsp;</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';line-height:150%;">清分结算时，从流水中获取相关数据组装后与用户卡号一起传到</span><span style="line-height:150%;"><span style="font-family:Calibri;"></span></span><span style="font-family:'宋体';line-height:150%;">加密机</span><span style="line-height:150%;"><span style="font-family:Calibri;"></span></span><span style="font-family:'宋体';line-height:150%;">计算得到实际的</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码（使用“</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">密钥”计算得到）。将该</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码</span><span style="line-height:150%;"><span style="font-family:Calibri;"></span></span><span style="font-family:'宋体';line-height:150%;">同</span><span style="line-height:150%;"><span style="font-family:Calibri;"></span></span><span style="font-family:'宋体';line-height:150%;">流水中的</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码</span><span style="line-height:150%;"><span style="font-family:Calibri;"></span></span><span style="font-family:'宋体';line-height:150%;">进行比较，若两者相等，认为流水中的交易信息是真实有效的；若两者不相等，则认为流水中的交易信息可能不是卡片实际交易的，存在伪造的嫌疑。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span><span style="font-family:Calibri;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></span><span style="font-family:'宋体';line-height:150%;">校验</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码的数据具体组装格式如下：</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><strong><span style="font-family:'宋体';line-height:150%;">交易金额</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">4(</span></span><span style="font-family:'宋体';line-height:150%;">字节</span></strong></span><strong><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;"><span style="font-size:14px;">)<span>&nbsp;</span></span><span style="font-size:14px;">+</span></span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><strong><span style="font-family:'宋体';line-height:150%;">交易类型标识</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">(06/09)1(</span></span><span style="font-family:'宋体';line-height:150%;">字节</span></strong></span><strong><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;"><span style="font-size:14px;">)<span>&nbsp;</span></span><span style="font-size:14px;">+</span></span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><strong><span style="font-family:'宋体';line-height:150%;">终端机编号</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">6(</span></span><span style="font-family:'宋体';line-height:150%;">字节</span></strong></span><strong><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;"><span style="font-size:14px;">)<span>&nbsp;</span></span><span style="font-size:14px;">+</span></span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><strong><span style="font-family:'宋体';line-height:150%;">终端交易序号</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">4(</span></span><span style="font-family:'宋体';line-height:150%;">字节</span></strong></span><strong><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;"><span style="font-size:14px;">)<span>&nbsp;</span></span><span style="font-size:14px;">+</span></span></span></strong></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p><span style="font-size:14px;"><strong><span style="font-family:'宋体';line-height:150%;">终端交易日期</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">4</span></span><span style="font-family:'宋体';line-height:150%;">（字节）</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">+</span></span><span style="font-family:'宋体';line-height:150%;">终端交易时间</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">3(</span></span><span style="font-family:'宋体';line-height:150%;">字节</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">)</span></span></strong></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
  <p style="text-indent:21pt;"><span style="font-size:14px;"><span style="font-family:'宋体';line-height:150%;">另外，由于不同省份的“</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">密钥”各不相同，所以各省一般只能校验本省发行的卡片，无法校验外省发行的卡片的</span><span lang="en-us" style="line-height:150%;" xml:lang="en-us"><span style="font-family:Calibri;">TAC</span></span><span style="font-family:'宋体';line-height:150%;">码（与在哪里交易无关，省内外消费都是同样的判定）。</span></span></p> 
  <span style="font-family:'宋体';font-size:14px;"></span> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/Heidlyn/article/details/53634142,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/Heidlyn/article/details/53634142,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
