<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>部署测试fabric1.0及源码解析 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="部署测试fabric1.0及源码解析" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="开发环境 UBUNTU 16.04 LTS docker docker-compose git go 1.8以上 docker,docker-compose以及go的安装这里不再描述。 部署测试 新建fabric-sample目录(名字可以任意)，进入目录执行: curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/master/scripts/bootstrap-1.0.0-beta.sh | bash 这个脚本会下载需要的docker镜像以及自动化脚本，执行完毕后，首先会在当前目录看到一个release的文件夹，里面有fabric运行环境的启动脚本。 其次，我们需要的docker镜像也会一并拉取过来，如下: hyperledger/fabric-tools latest ae6b0f53cb70 5 months ago 1.32GB hyperledger/fabric-tools x86_64-1.0.0-beta ae6b0f53cb70 5 months ago 1.32GB hyperledger/fabric-couchdb latest 31bbbec3d853 5 months ago 1.48GB hyperledger/fabric-couchdb x86_64-1.0.0-beta 31bbbec3d853 5 months ago 1.48GB hyperledger/fabric-kafka latest c4ac1c9a4797 5 months ago 1.3GB hyperledger/fabric-kafka x86_64-1.0.0-beta c4ac1c9a4797 5 months ago 1.3GB hyperledger/fabric-zookeeper latest 2c4ebacb6f00 5 months ago 1.31GB hyperledger/fabric-zookeeper x86_64-1.0.0-beta 2c4ebacb6f00 5 months ago 1.31GB hyperledger/fabric-orderer latest 11ff350dd297 5 months ago 179MB hyperledger/fabric-orderer x86_64-1.0.0-beta 11ff350dd297 5 months ago 179MB hyperledger/fabric-peer latest e01c2b645f11 5 months ago 182MB hyperledger/fabric-peer x86_64-1.0.0-beta e01c2b645f11 5 months ago 182MB hyperledger/fabric-javaenv latest 61c188dca542 5 months ago 1.42GB hyperledger/fabric-javaenv x86_64-1.0.0-beta 61c188dca542 5 months ago 1.42GB hyperledger/fabric-ccenv latest 7034cca1918d 5 months ago 1.29GB hyperledger/fabric-ccenv x86_64-1.0.0-beta 7034cca1918d 5 months ago 1.29GB hyperledger/fabric-ca latest e549e8c53c2e 5 months ago 238MB hyperledger/fabric-ca x86_64-1.0.0-beta e549e8c53c2e 5 months ago 238MB hyperledger/fabric-ccenv x86_64-1.0.0-alpha2 8c360a57f805 5 months ago 1.29GB hyperledger/fabric-baseos x86_64-0.3.1 4b0cab202084 6 months ago 157MB hyperledger/fabric-baseos x86_64-0.3.2 4b0cab202084 6 months ago 157MB 这里有一点要注意，如果你的环境之前执行过其它的fabric测试，可能会存在其它版本的docker镜像，建议删除。我试过不删除结果后面各种错误，删除之后一切正常。 启动fabric cd ~/fabric-sample/release/linux-amd64 ./network_setup.sh up 注意看有没有报错，正常的话最后会有下面这样的界面。 Query Result: 90 2017-11-10 03:48:00.802 UTC [main] main -&gt; INFO 008 Exiting..... ===================== Query on PEER3 on channel &#39;mychannel&#39; is successful ===================== ===================== All GOOD, End-2-End execution completed ===================== _____ _ _ ____ _____ ____ _____ | ____| | \ | | | _ \ | ____| |___ \ | ____| | _| | \| | | | | | _____ | _| __) | | _| | |___ | |\ | | |_| | |_____| | |___ / __/ | |___ |_____| |_| \_| |____/ |_____| |_____| |_____| 启动成功后，我们用docker ps命令可以看到类似下面这样的信息， root@pony-virtual-machine:~/gopath/src/fabric-sample# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e1f67091b0be dev-peer1.org2.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer1.org2.example.com-mycc-1.0 c1c82b8269d1 dev-peer0.org1.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer0.org1.example.com-mycc-1.0 5610d9ef3dfa dev-peer0.org2.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer0.org2.example.com-mycc-1.0 e5fee400df40 hyperledger/fabric-tools &quot;/bin/bash -c &#39;./s...&quot; 2 hours ago Up 2 hours cli 12252e8c234e hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:8051-&gt;7051/tcp, 0.0.0.0:8053-&gt;7053/tcp peer1.org1.example.com 82c82528a0e3 hyperledger/fabric-orderer &quot;orderer&quot; 2 hours ago Up 2 hours 0.0.0.0:7050-&gt;7050/tcp orderer.example.com 8e9ed0104cc9 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:7051-&gt;7051/tcp, 0.0.0.0:7053-&gt;7053/tcp peer0.org1.example.com 6475f787dd66 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:10051-&gt;7051/tcp, 0.0.0.0:10053-&gt;7053/tcp peer1.org2.example.com 2c65a798dca2 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:9051-&gt;7051/tcp, 0.0.0.0:9053-&gt;7053/tcp peer0.org2.example.com 也就是说，刚才的脚本为我们启动了一个cli客户端，一个orderer节点，4个普通的peer节点。而且，还有三个chaincode运行实例。 新开启一个终端，进入cli容器， docker exec -it cli bash 下面我们首先安装Example02，并指定一个名字，比如我们这里就用devincc： peer chaincode install -n devincc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 这里安装指定的目录是docker容器中的gopath路径下的 github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 目录中的chaincode程序。 下面有个专门的章节我会分析下这部分代码。 运行后可以看到提示运行成功，类似如下的信息: 2017-11-10 03:50:29.907 UTC [golang-platform] GetDeploymentPayload -&gt; DEBU 00c done 2017-11-10 03:50:29.909 UTC [msp/identity] Sign -&gt; DEBU 00d Sign: plaintext: 0AA6070A5C08031A0C0885C494D00510...98F1CF000000FFFF6430F69C001C0000 2017-11-10 03:50:29.909 UTC [msp/identity] Sign -&gt; DEBU 00e Sign: digest: 5779AC7B30E7CFBAA5E698B90762616117CA8FA36144238F83C6A4A047D7A737 2017-11-10 03:50:29.914 UTC [chaincodeCmd] install -&gt; DEBU 00f Installed remotely response:&lt;status:200 payload:&quot;OK&quot; &gt; .... 初始化实例，设置a账户有100元，b账户有200元。 root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; 注意看有没有报错。 用Query命令来看一看a账户的余额： root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:53:25.623 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:53:25.623 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:53:25.623 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08B5C594D00510...696E63631A0A0A0571756572790A0161 2017-11-10 03:53:25.623 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: 00AA703102DBEA060C31B1E9FDD66143AD6454A27C2F1757ADE5265C992207A4 Query Result: 100 余额是100元。 接下来我们把a账户的10元转给b账户，需要调用invoke命令： root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; 2017-11-10 03:54:06.834 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:54:06.834 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:54:06.835 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:54:06.882 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:54:06.882 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:54:06.887 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08DEC594D00510...696E766F6B650A01610A01620A023130 2017-11-10 03:54:06.887 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: CD26EE32A303A100BE43D3CCDDA6403FAA35F497ACA0C96F8C46A95A2487BDFD 2017-11-10 03:54:06.902 UTC [msp/identity] Sign -&gt; DEBU 008 Sign: plaintext: 0AB4070A6A08031A0C08DEC594D00510...82890A68992DCC72B079EC46631ECB78 2017-11-10 03:54:06.902 UTC [msp/identity] Sign -&gt; DEBU 009 Sign: digest: 51965C0B97EEB31A296977BA323972119BC4BE62EE5F18BB70B1EC69CFDF787B 2017-11-10 03:54:06.920 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; DEBU 00a ESCC invoke result: version:1 response:&lt;status:200 message:&quot;OK&quot; &gt; payload:&quot;\n \213&lt;\t\264i\241\247\235\257W\230\242W\236\251\\\2234\256\214\265\243?\236\274Z\200\025AU\377\026\022b\nK\0220\n\007devincc\022%\n\007\n\001a\022\002\010\005\n\007\n\001b\022\002\010\005\032\007\n\001a\032\00290\032\010\n\001b\032\003210\022\027\n\004lscc\022\017\n\r\n\007devincc\022\002\010\005\032\003\010\310\001\&quot;\016\022\007devincc\032\0031.0&quot; endorsement:&lt;endorser:&quot;\n\007Org1MSP\022\325\006-----BEGIN -----\nMIICWTCCAgCgAwIBAgIQahOTRu7gpuR5AtIhNk3n1zAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0xNzExMTAwMzQ2NDNaFw0yNzExMDgwMzQ2NDNa\nMFsxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMR8wHQYDVQQDExZwZWVyMC5vcmcxLmV4YW1wbGUuY29tMFkw\nEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEVn40lbdv6epcF1bx37dS9nbGJdRVCAkG\n7hsUKHdvjOi9fAsU0fatanSZjtv2gJq/fXB/f3huHUijTP9H413zsaOBjTCBijAO\nBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIw\nADArBgNVHSMEJDAigCBKiLTrKKZzBXbm3oXivXoLjt8WfFszW8Ca76+pGi+wQTAo\nBgNVHREEITAfghZwZWVyMC5vcmcxLmV4YW1wbGUuY29tggVwZWVyMDAKBggqhkjO\nPQQDAgNHADBEAiA1uMkgn7nAb3uk3C8sQG0jBNHbY09eDKqb3R6e2uagcwIgJg6w\nybzss2TAuaxqWMYX+JutKEJTlxSThiYjMaHcJds=\n-----END -----\n&quot; signature:&quot;0E\002!\000\341\334cR&gt;\343\273\221\005E#\344[\032\377Q5IR\323qNH\3778\025,\243\243o(W\002 \013\036\220\234V\271\2651\005\254\301p\016&amp;\254\216\202\211\nh\231-\314r\260y\354Fc\036\313x&quot; &gt; 2017-11-10 03:54:06.920 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 00b Chaincode invoke successful. result: status:200 2017-11-10 03:54:06.920 UTC [main] main -&gt; INFO 00c Exiting..... 再调用query命令来查一下b账户的余额，如果没有计算错，应该是210元。 root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;b&quot;]}&#39; 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:54:24.554 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:54:24.554 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:54:24.555 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08F0C594D00510...696E63631A0A0A0571756572790A0162 2017-11-10 03:54:24.555 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: 97999F9BEFEAB1D7976AA68ABF2199668568D00C6EC1CB6C7F2C83C4DF6CAA06 Query Result: 210 测试成功。退出docker容器，然后执行下面的指令退出fabric环境。 root@pony-virtual-machine:~/gopath/src/fabric-sample/release/linux-amd64# ./network_setup.sh down 源码剖析 上面说了，源码目录在$GOPATH/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02目录下。 下面开始分析下这个示例chaincode。 type SimpleChaincode struct { } func (t *SimpleChaincode) Init(stub shim.ChaincodeStubInterface) pb.Response { fmt.Println(&quot;ex02 Init&quot;) _, args := stub.GetFunctionAndParameters() var A, B string // Entities var Aval, Bval int // Asset holdings var err error if len(args) != 4 { return shim.Error(&quot;Incorrect number of arguments. Expecting 4&quot;) } // Initialize the chaincode A = args[0] Aval, err = strconv.Atoi(args[1]) if err != nil { return shim.Error(&quot;Expecting integer value for asset holding&quot;) } B = args[2] Bval, err = strconv.Atoi(args[3]) if err != nil { return shim.Error(&quot;Expecting integer value for asset holding&quot;) } fmt.Printf(&quot;Aval = %d, Bval = %d\n&quot;, Aval, Bval) // Write the state to the ledger err = stub.PutState(A, []byte(strconv.Itoa(Aval))) if err != nil { return shim.Error(err.Error()) } err = stub.PutState(B, []byte(strconv.Itoa(Bval))) if err != nil { return shim.Error(err.Error()) } return shim.Success(nil) } 这里首先定义了一个SimpleChaincode类，并且实现了该类的一个方法Init 这个Init方法不是随便定义的，根据fabric官方指引，一个chaincode需要实现如下的接口， type Chaincode interface { // Init is called during Instantiate transaction after the chaincode container // has been established for the first time, allowing the chaincode to // initialize its internal data Init(stub ChaincodeStubInterface) pb.Response // Invoke is called to update or query the ledger in a proposal transaction. // Updated state variables are not committed to the ledger until the // transaction is committed. Invoke(stub ChaincodeStubInterface) pb.Response } 当我们执行peer chaincode instantiate命令时，系统回调用我们实现的Init方法完成智能合约的初始化动作。 这里Init的实现其实比较简单，首先我们用GetFunctionAndParameters获取实例化传递过来的所有参数，并且要求参数的个数是四个。根据上面的instantiate指令我们知道传递的参数是 [&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;] 可能有人会有疑问，这里不是5个参数吗？ 其实GetFunctionAndParameters会返回两个值，第一个值是函数名，就是这里的”init”，第二个值就是后面的4个参数。 a和b这里我们表示两个账户(或者是两个人也可以)，数字是他们对应的账户余额。然后我们用 strconv.Atoi把数字有字符串转化为整型方便后面打印处理。 PutState会把key和value先放入fabric的写集，并不会马上更新账本。(更新账本由节点完成，chaincode后续不需要参与) 再看看接口里的另外一个方法， func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response { fmt.Println(&quot;ex02 Invoke&quot;) function, args := stub.GetFunctionAndParameters() if function == &quot;invoke&quot; { // Make payment of X units from A to B return t.invoke(stub, args) } else if function == &quot;delete&quot; { // Deletes an entity from its state return t.delete(stub, args) } else if function == &quot;query&quot; { // the old &quot;Query&quot; is now implemtned in invoke return t.query(stub, args) } return shim.Error(&quot;Invalid invoke function name. Expecting \&quot;invoke\&quot; \&quot;delete\&quot; \&quot;query\&quot;&quot;) } 可以看到Invoke并没有做具体的事情，而是根据函数名分发到子函数处理。先来看看query查询的操作。当我们执行 peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 系统调用Invoke，function是”query”，参数是”a”， 进入query方法， func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response { var A string // Entities var err error if len(args) != 1 { return shim.Error(&quot;Incorrect number of arguments. Expecting name of the person to query&quot;) } A = args[0] // Get the state from the ledger Avalbytes, err := stub.GetState(A) if err != nil { jsonResp := &quot;{\&quot;Error\&quot;:\&quot;Failed to get state for &quot; + A + &quot;\&quot;}&quot; return shim.Error(jsonResp) } if Avalbytes == nil { jsonResp := &quot;{\&quot;Error\&quot;:\&quot;Nil amount for &quot; + A + &quot;\&quot;}&quot; return shim.Error(jsonResp) } jsonResp := &quot;{\&quot;Name\&quot;:\&quot;&quot; + A + &quot;\&quot;,\&quot;Amount\&quot;:\&quot;&quot; + string(Avalbytes) + &quot;\&quot;}&quot; fmt.Printf(&quot;Query Response:%s\n&quot;, jsonResp) return shim.Success(Avalbytes) } 关键的代码就是GetState这里，从账本获取指定key的value值，返回的是[]byte类型的值，然后通过shim.Sucess返回。 invoke和delete也都比较简单，这里就不多说了。 参考 http://www.cnblogs.com/studyzy/p/6973334.html 阅读更多" />
<meta property="og:description" content="开发环境 UBUNTU 16.04 LTS docker docker-compose git go 1.8以上 docker,docker-compose以及go的安装这里不再描述。 部署测试 新建fabric-sample目录(名字可以任意)，进入目录执行: curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/master/scripts/bootstrap-1.0.0-beta.sh | bash 这个脚本会下载需要的docker镜像以及自动化脚本，执行完毕后，首先会在当前目录看到一个release的文件夹，里面有fabric运行环境的启动脚本。 其次，我们需要的docker镜像也会一并拉取过来，如下: hyperledger/fabric-tools latest ae6b0f53cb70 5 months ago 1.32GB hyperledger/fabric-tools x86_64-1.0.0-beta ae6b0f53cb70 5 months ago 1.32GB hyperledger/fabric-couchdb latest 31bbbec3d853 5 months ago 1.48GB hyperledger/fabric-couchdb x86_64-1.0.0-beta 31bbbec3d853 5 months ago 1.48GB hyperledger/fabric-kafka latest c4ac1c9a4797 5 months ago 1.3GB hyperledger/fabric-kafka x86_64-1.0.0-beta c4ac1c9a4797 5 months ago 1.3GB hyperledger/fabric-zookeeper latest 2c4ebacb6f00 5 months ago 1.31GB hyperledger/fabric-zookeeper x86_64-1.0.0-beta 2c4ebacb6f00 5 months ago 1.31GB hyperledger/fabric-orderer latest 11ff350dd297 5 months ago 179MB hyperledger/fabric-orderer x86_64-1.0.0-beta 11ff350dd297 5 months ago 179MB hyperledger/fabric-peer latest e01c2b645f11 5 months ago 182MB hyperledger/fabric-peer x86_64-1.0.0-beta e01c2b645f11 5 months ago 182MB hyperledger/fabric-javaenv latest 61c188dca542 5 months ago 1.42GB hyperledger/fabric-javaenv x86_64-1.0.0-beta 61c188dca542 5 months ago 1.42GB hyperledger/fabric-ccenv latest 7034cca1918d 5 months ago 1.29GB hyperledger/fabric-ccenv x86_64-1.0.0-beta 7034cca1918d 5 months ago 1.29GB hyperledger/fabric-ca latest e549e8c53c2e 5 months ago 238MB hyperledger/fabric-ca x86_64-1.0.0-beta e549e8c53c2e 5 months ago 238MB hyperledger/fabric-ccenv x86_64-1.0.0-alpha2 8c360a57f805 5 months ago 1.29GB hyperledger/fabric-baseos x86_64-0.3.1 4b0cab202084 6 months ago 157MB hyperledger/fabric-baseos x86_64-0.3.2 4b0cab202084 6 months ago 157MB 这里有一点要注意，如果你的环境之前执行过其它的fabric测试，可能会存在其它版本的docker镜像，建议删除。我试过不删除结果后面各种错误，删除之后一切正常。 启动fabric cd ~/fabric-sample/release/linux-amd64 ./network_setup.sh up 注意看有没有报错，正常的话最后会有下面这样的界面。 Query Result: 90 2017-11-10 03:48:00.802 UTC [main] main -&gt; INFO 008 Exiting..... ===================== Query on PEER3 on channel &#39;mychannel&#39; is successful ===================== ===================== All GOOD, End-2-End execution completed ===================== _____ _ _ ____ _____ ____ _____ | ____| | \ | | | _ \ | ____| |___ \ | ____| | _| | \| | | | | | _____ | _| __) | | _| | |___ | |\ | | |_| | |_____| | |___ / __/ | |___ |_____| |_| \_| |____/ |_____| |_____| |_____| 启动成功后，我们用docker ps命令可以看到类似下面这样的信息， root@pony-virtual-machine:~/gopath/src/fabric-sample# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e1f67091b0be dev-peer1.org2.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer1.org2.example.com-mycc-1.0 c1c82b8269d1 dev-peer0.org1.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer0.org1.example.com-mycc-1.0 5610d9ef3dfa dev-peer0.org2.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer0.org2.example.com-mycc-1.0 e5fee400df40 hyperledger/fabric-tools &quot;/bin/bash -c &#39;./s...&quot; 2 hours ago Up 2 hours cli 12252e8c234e hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:8051-&gt;7051/tcp, 0.0.0.0:8053-&gt;7053/tcp peer1.org1.example.com 82c82528a0e3 hyperledger/fabric-orderer &quot;orderer&quot; 2 hours ago Up 2 hours 0.0.0.0:7050-&gt;7050/tcp orderer.example.com 8e9ed0104cc9 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:7051-&gt;7051/tcp, 0.0.0.0:7053-&gt;7053/tcp peer0.org1.example.com 6475f787dd66 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:10051-&gt;7051/tcp, 0.0.0.0:10053-&gt;7053/tcp peer1.org2.example.com 2c65a798dca2 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:9051-&gt;7051/tcp, 0.0.0.0:9053-&gt;7053/tcp peer0.org2.example.com 也就是说，刚才的脚本为我们启动了一个cli客户端，一个orderer节点，4个普通的peer节点。而且，还有三个chaincode运行实例。 新开启一个终端，进入cli容器， docker exec -it cli bash 下面我们首先安装Example02，并指定一个名字，比如我们这里就用devincc： peer chaincode install -n devincc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 这里安装指定的目录是docker容器中的gopath路径下的 github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 目录中的chaincode程序。 下面有个专门的章节我会分析下这部分代码。 运行后可以看到提示运行成功，类似如下的信息: 2017-11-10 03:50:29.907 UTC [golang-platform] GetDeploymentPayload -&gt; DEBU 00c done 2017-11-10 03:50:29.909 UTC [msp/identity] Sign -&gt; DEBU 00d Sign: plaintext: 0AA6070A5C08031A0C0885C494D00510...98F1CF000000FFFF6430F69C001C0000 2017-11-10 03:50:29.909 UTC [msp/identity] Sign -&gt; DEBU 00e Sign: digest: 5779AC7B30E7CFBAA5E698B90762616117CA8FA36144238F83C6A4A047D7A737 2017-11-10 03:50:29.914 UTC [chaincodeCmd] install -&gt; DEBU 00f Installed remotely response:&lt;status:200 payload:&quot;OK&quot; &gt; .... 初始化实例，设置a账户有100元，b账户有200元。 root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; 注意看有没有报错。 用Query命令来看一看a账户的余额： root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:53:25.623 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:53:25.623 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:53:25.623 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08B5C594D00510...696E63631A0A0A0571756572790A0161 2017-11-10 03:53:25.623 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: 00AA703102DBEA060C31B1E9FDD66143AD6454A27C2F1757ADE5265C992207A4 Query Result: 100 余额是100元。 接下来我们把a账户的10元转给b账户，需要调用invoke命令： root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; 2017-11-10 03:54:06.834 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:54:06.834 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:54:06.835 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:54:06.882 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:54:06.882 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:54:06.887 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08DEC594D00510...696E766F6B650A01610A01620A023130 2017-11-10 03:54:06.887 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: CD26EE32A303A100BE43D3CCDDA6403FAA35F497ACA0C96F8C46A95A2487BDFD 2017-11-10 03:54:06.902 UTC [msp/identity] Sign -&gt; DEBU 008 Sign: plaintext: 0AB4070A6A08031A0C08DEC594D00510...82890A68992DCC72B079EC46631ECB78 2017-11-10 03:54:06.902 UTC [msp/identity] Sign -&gt; DEBU 009 Sign: digest: 51965C0B97EEB31A296977BA323972119BC4BE62EE5F18BB70B1EC69CFDF787B 2017-11-10 03:54:06.920 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; DEBU 00a ESCC invoke result: version:1 response:&lt;status:200 message:&quot;OK&quot; &gt; payload:&quot;\n \213&lt;\t\264i\241\247\235\257W\230\242W\236\251\\\2234\256\214\265\243?\236\274Z\200\025AU\377\026\022b\nK\0220\n\007devincc\022%\n\007\n\001a\022\002\010\005\n\007\n\001b\022\002\010\005\032\007\n\001a\032\00290\032\010\n\001b\032\003210\022\027\n\004lscc\022\017\n\r\n\007devincc\022\002\010\005\032\003\010\310\001\&quot;\016\022\007devincc\032\0031.0&quot; endorsement:&lt;endorser:&quot;\n\007Org1MSP\022\325\006-----BEGIN -----\nMIICWTCCAgCgAwIBAgIQahOTRu7gpuR5AtIhNk3n1zAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0xNzExMTAwMzQ2NDNaFw0yNzExMDgwMzQ2NDNa\nMFsxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMR8wHQYDVQQDExZwZWVyMC5vcmcxLmV4YW1wbGUuY29tMFkw\nEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEVn40lbdv6epcF1bx37dS9nbGJdRVCAkG\n7hsUKHdvjOi9fAsU0fatanSZjtv2gJq/fXB/f3huHUijTP9H413zsaOBjTCBijAO\nBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIw\nADArBgNVHSMEJDAigCBKiLTrKKZzBXbm3oXivXoLjt8WfFszW8Ca76+pGi+wQTAo\nBgNVHREEITAfghZwZWVyMC5vcmcxLmV4YW1wbGUuY29tggVwZWVyMDAKBggqhkjO\nPQQDAgNHADBEAiA1uMkgn7nAb3uk3C8sQG0jBNHbY09eDKqb3R6e2uagcwIgJg6w\nybzss2TAuaxqWMYX+JutKEJTlxSThiYjMaHcJds=\n-----END -----\n&quot; signature:&quot;0E\002!\000\341\334cR&gt;\343\273\221\005E#\344[\032\377Q5IR\323qNH\3778\025,\243\243o(W\002 \013\036\220\234V\271\2651\005\254\301p\016&amp;\254\216\202\211\nh\231-\314r\260y\354Fc\036\313x&quot; &gt; 2017-11-10 03:54:06.920 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 00b Chaincode invoke successful. result: status:200 2017-11-10 03:54:06.920 UTC [main] main -&gt; INFO 00c Exiting..... 再调用query命令来查一下b账户的余额，如果没有计算错，应该是210元。 root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;b&quot;]}&#39; 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:54:24.554 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:54:24.554 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:54:24.555 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08F0C594D00510...696E63631A0A0A0571756572790A0162 2017-11-10 03:54:24.555 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: 97999F9BEFEAB1D7976AA68ABF2199668568D00C6EC1CB6C7F2C83C4DF6CAA06 Query Result: 210 测试成功。退出docker容器，然后执行下面的指令退出fabric环境。 root@pony-virtual-machine:~/gopath/src/fabric-sample/release/linux-amd64# ./network_setup.sh down 源码剖析 上面说了，源码目录在$GOPATH/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02目录下。 下面开始分析下这个示例chaincode。 type SimpleChaincode struct { } func (t *SimpleChaincode) Init(stub shim.ChaincodeStubInterface) pb.Response { fmt.Println(&quot;ex02 Init&quot;) _, args := stub.GetFunctionAndParameters() var A, B string // Entities var Aval, Bval int // Asset holdings var err error if len(args) != 4 { return shim.Error(&quot;Incorrect number of arguments. Expecting 4&quot;) } // Initialize the chaincode A = args[0] Aval, err = strconv.Atoi(args[1]) if err != nil { return shim.Error(&quot;Expecting integer value for asset holding&quot;) } B = args[2] Bval, err = strconv.Atoi(args[3]) if err != nil { return shim.Error(&quot;Expecting integer value for asset holding&quot;) } fmt.Printf(&quot;Aval = %d, Bval = %d\n&quot;, Aval, Bval) // Write the state to the ledger err = stub.PutState(A, []byte(strconv.Itoa(Aval))) if err != nil { return shim.Error(err.Error()) } err = stub.PutState(B, []byte(strconv.Itoa(Bval))) if err != nil { return shim.Error(err.Error()) } return shim.Success(nil) } 这里首先定义了一个SimpleChaincode类，并且实现了该类的一个方法Init 这个Init方法不是随便定义的，根据fabric官方指引，一个chaincode需要实现如下的接口， type Chaincode interface { // Init is called during Instantiate transaction after the chaincode container // has been established for the first time, allowing the chaincode to // initialize its internal data Init(stub ChaincodeStubInterface) pb.Response // Invoke is called to update or query the ledger in a proposal transaction. // Updated state variables are not committed to the ledger until the // transaction is committed. Invoke(stub ChaincodeStubInterface) pb.Response } 当我们执行peer chaincode instantiate命令时，系统回调用我们实现的Init方法完成智能合约的初始化动作。 这里Init的实现其实比较简单，首先我们用GetFunctionAndParameters获取实例化传递过来的所有参数，并且要求参数的个数是四个。根据上面的instantiate指令我们知道传递的参数是 [&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;] 可能有人会有疑问，这里不是5个参数吗？ 其实GetFunctionAndParameters会返回两个值，第一个值是函数名，就是这里的”init”，第二个值就是后面的4个参数。 a和b这里我们表示两个账户(或者是两个人也可以)，数字是他们对应的账户余额。然后我们用 strconv.Atoi把数字有字符串转化为整型方便后面打印处理。 PutState会把key和value先放入fabric的写集，并不会马上更新账本。(更新账本由节点完成，chaincode后续不需要参与) 再看看接口里的另外一个方法， func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response { fmt.Println(&quot;ex02 Invoke&quot;) function, args := stub.GetFunctionAndParameters() if function == &quot;invoke&quot; { // Make payment of X units from A to B return t.invoke(stub, args) } else if function == &quot;delete&quot; { // Deletes an entity from its state return t.delete(stub, args) } else if function == &quot;query&quot; { // the old &quot;Query&quot; is now implemtned in invoke return t.query(stub, args) } return shim.Error(&quot;Invalid invoke function name. Expecting \&quot;invoke\&quot; \&quot;delete\&quot; \&quot;query\&quot;&quot;) } 可以看到Invoke并没有做具体的事情，而是根据函数名分发到子函数处理。先来看看query查询的操作。当我们执行 peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 系统调用Invoke，function是”query”，参数是”a”， 进入query方法， func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response { var A string // Entities var err error if len(args) != 1 { return shim.Error(&quot;Incorrect number of arguments. Expecting name of the person to query&quot;) } A = args[0] // Get the state from the ledger Avalbytes, err := stub.GetState(A) if err != nil { jsonResp := &quot;{\&quot;Error\&quot;:\&quot;Failed to get state for &quot; + A + &quot;\&quot;}&quot; return shim.Error(jsonResp) } if Avalbytes == nil { jsonResp := &quot;{\&quot;Error\&quot;:\&quot;Nil amount for &quot; + A + &quot;\&quot;}&quot; return shim.Error(jsonResp) } jsonResp := &quot;{\&quot;Name\&quot;:\&quot;&quot; + A + &quot;\&quot;,\&quot;Amount\&quot;:\&quot;&quot; + string(Avalbytes) + &quot;\&quot;}&quot; fmt.Printf(&quot;Query Response:%s\n&quot;, jsonResp) return shim.Success(Avalbytes) } 关键的代码就是GetState这里，从账本获取指定key的value值，返回的是[]byte类型的值，然后通过shim.Sucess返回。 invoke和delete也都比较简单，这里就不多说了。 参考 http://www.cnblogs.com/studyzy/p/6973334.html 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/11/15/0e3feec8ef3cfb6c8080986a08f10df8.html" />
<meta property="og:url" content="https://mlh.app/2017/11/15/0e3feec8ef3cfb6c8080986a08f10df8.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-11-15T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"开发环境 UBUNTU 16.04 LTS docker docker-compose git go 1.8以上 docker,docker-compose以及go的安装这里不再描述。 部署测试 新建fabric-sample目录(名字可以任意)，进入目录执行: curl -sSL https://raw.githubusercontent.com/hyperledger/fabric/master/scripts/bootstrap-1.0.0-beta.sh | bash 这个脚本会下载需要的docker镜像以及自动化脚本，执行完毕后，首先会在当前目录看到一个release的文件夹，里面有fabric运行环境的启动脚本。 其次，我们需要的docker镜像也会一并拉取过来，如下: hyperledger/fabric-tools latest ae6b0f53cb70 5 months ago 1.32GB hyperledger/fabric-tools x86_64-1.0.0-beta ae6b0f53cb70 5 months ago 1.32GB hyperledger/fabric-couchdb latest 31bbbec3d853 5 months ago 1.48GB hyperledger/fabric-couchdb x86_64-1.0.0-beta 31bbbec3d853 5 months ago 1.48GB hyperledger/fabric-kafka latest c4ac1c9a4797 5 months ago 1.3GB hyperledger/fabric-kafka x86_64-1.0.0-beta c4ac1c9a4797 5 months ago 1.3GB hyperledger/fabric-zookeeper latest 2c4ebacb6f00 5 months ago 1.31GB hyperledger/fabric-zookeeper x86_64-1.0.0-beta 2c4ebacb6f00 5 months ago 1.31GB hyperledger/fabric-orderer latest 11ff350dd297 5 months ago 179MB hyperledger/fabric-orderer x86_64-1.0.0-beta 11ff350dd297 5 months ago 179MB hyperledger/fabric-peer latest e01c2b645f11 5 months ago 182MB hyperledger/fabric-peer x86_64-1.0.0-beta e01c2b645f11 5 months ago 182MB hyperledger/fabric-javaenv latest 61c188dca542 5 months ago 1.42GB hyperledger/fabric-javaenv x86_64-1.0.0-beta 61c188dca542 5 months ago 1.42GB hyperledger/fabric-ccenv latest 7034cca1918d 5 months ago 1.29GB hyperledger/fabric-ccenv x86_64-1.0.0-beta 7034cca1918d 5 months ago 1.29GB hyperledger/fabric-ca latest e549e8c53c2e 5 months ago 238MB hyperledger/fabric-ca x86_64-1.0.0-beta e549e8c53c2e 5 months ago 238MB hyperledger/fabric-ccenv x86_64-1.0.0-alpha2 8c360a57f805 5 months ago 1.29GB hyperledger/fabric-baseos x86_64-0.3.1 4b0cab202084 6 months ago 157MB hyperledger/fabric-baseos x86_64-0.3.2 4b0cab202084 6 months ago 157MB 这里有一点要注意，如果你的环境之前执行过其它的fabric测试，可能会存在其它版本的docker镜像，建议删除。我试过不删除结果后面各种错误，删除之后一切正常。 启动fabric cd ~/fabric-sample/release/linux-amd64 ./network_setup.sh up 注意看有没有报错，正常的话最后会有下面这样的界面。 Query Result: 90 2017-11-10 03:48:00.802 UTC [main] main -&gt; INFO 008 Exiting..... ===================== Query on PEER3 on channel &#39;mychannel&#39; is successful ===================== ===================== All GOOD, End-2-End execution completed ===================== _____ _ _ ____ _____ ____ _____ | ____| | \\ | | | _ \\ | ____| |___ \\ | ____| | _| | \\| | | | | | _____ | _| __) | | _| | |___ | |\\ | | |_| | |_____| | |___ / __/ | |___ |_____| |_| \\_| |____/ |_____| |_____| |_____| 启动成功后，我们用docker ps命令可以看到类似下面这样的信息， root@pony-virtual-machine:~/gopath/src/fabric-sample# docker ps CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES e1f67091b0be dev-peer1.org2.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer1.org2.example.com-mycc-1.0 c1c82b8269d1 dev-peer0.org1.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer0.org1.example.com-mycc-1.0 5610d9ef3dfa dev-peer0.org2.example.com-mycc-1.0 &quot;chaincode -peer.a...&quot; 2 hours ago Up 2 hours dev-peer0.org2.example.com-mycc-1.0 e5fee400df40 hyperledger/fabric-tools &quot;/bin/bash -c &#39;./s...&quot; 2 hours ago Up 2 hours cli 12252e8c234e hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:8051-&gt;7051/tcp, 0.0.0.0:8053-&gt;7053/tcp peer1.org1.example.com 82c82528a0e3 hyperledger/fabric-orderer &quot;orderer&quot; 2 hours ago Up 2 hours 0.0.0.0:7050-&gt;7050/tcp orderer.example.com 8e9ed0104cc9 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:7051-&gt;7051/tcp, 0.0.0.0:7053-&gt;7053/tcp peer0.org1.example.com 6475f787dd66 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:10051-&gt;7051/tcp, 0.0.0.0:10053-&gt;7053/tcp peer1.org2.example.com 2c65a798dca2 hyperledger/fabric-peer &quot;peer node start&quot; 2 hours ago Up 2 hours 0.0.0.0:9051-&gt;7051/tcp, 0.0.0.0:9053-&gt;7053/tcp peer0.org2.example.com 也就是说，刚才的脚本为我们启动了一个cli客户端，一个orderer节点，4个普通的peer节点。而且，还有三个chaincode运行实例。 新开启一个终端，进入cli容器， docker exec -it cli bash 下面我们首先安装Example02，并指定一个名字，比如我们这里就用devincc： peer chaincode install -n devincc -v 1.0 -p github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 这里安装指定的目录是docker容器中的gopath路径下的 github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 目录中的chaincode程序。 下面有个专门的章节我会分析下这部分代码。 运行后可以看到提示运行成功，类似如下的信息: 2017-11-10 03:50:29.907 UTC [golang-platform] GetDeploymentPayload -&gt; DEBU 00c done 2017-11-10 03:50:29.909 UTC [msp/identity] Sign -&gt; DEBU 00d Sign: plaintext: 0AA6070A5C08031A0C0885C494D00510...98F1CF000000FFFF6430F69C001C0000 2017-11-10 03:50:29.909 UTC [msp/identity] Sign -&gt; DEBU 00e Sign: digest: 5779AC7B30E7CFBAA5E698B90762616117CA8FA36144238F83C6A4A047D7A737 2017-11-10 03:50:29.914 UTC [chaincodeCmd] install -&gt; DEBU 00f Installed remotely response:&lt;status:200 payload:&quot;OK&quot; &gt; .... 初始化实例，设置a账户有100元，b账户有200元。 root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -v 1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;]}&#39; -P &quot;OR (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; 注意看有没有报错。 用Query命令来看一看a账户的余额： root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:53:25.599 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:53:25.623 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:53:25.623 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:53:25.623 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08B5C594D00510...696E63631A0A0A0571756572790A0161 2017-11-10 03:53:25.623 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: 00AA703102DBEA060C31B1E9FDD66143AD6454A27C2F1757ADE5265C992207A4 Query Result: 100 余额是100元。 接下来我们把a账户的10元转给b账户，需要调用invoke命令： root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;invoke&quot;,&quot;a&quot;,&quot;b&quot;,&quot;10&quot;]}&#39; 2017-11-10 03:54:06.834 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:54:06.834 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:54:06.835 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:54:06.882 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:54:06.882 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:54:06.887 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08DEC594D00510...696E766F6B650A01610A01620A023130 2017-11-10 03:54:06.887 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: CD26EE32A303A100BE43D3CCDDA6403FAA35F497ACA0C96F8C46A95A2487BDFD 2017-11-10 03:54:06.902 UTC [msp/identity] Sign -&gt; DEBU 008 Sign: plaintext: 0AB4070A6A08031A0C08DEC594D00510...82890A68992DCC72B079EC46631ECB78 2017-11-10 03:54:06.902 UTC [msp/identity] Sign -&gt; DEBU 009 Sign: digest: 51965C0B97EEB31A296977BA323972119BC4BE62EE5F18BB70B1EC69CFDF787B 2017-11-10 03:54:06.920 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; DEBU 00a ESCC invoke result: version:1 response:&lt;status:200 message:&quot;OK&quot; &gt; payload:&quot;\\n \\213&lt;\\t\\264i\\241\\247\\235\\257W\\230\\242W\\236\\251\\\\\\2234\\256\\214\\265\\243?\\236\\274Z\\200\\025AU\\377\\026\\022b\\nK\\0220\\n\\007devincc\\022%\\n\\007\\n\\001a\\022\\002\\010\\005\\n\\007\\n\\001b\\022\\002\\010\\005\\032\\007\\n\\001a\\032\\00290\\032\\010\\n\\001b\\032\\003210\\022\\027\\n\\004lscc\\022\\017\\n\\r\\n\\007devincc\\022\\002\\010\\005\\032\\003\\010\\310\\001\\&quot;\\016\\022\\007devincc\\032\\0031.0&quot; endorsement:&lt;endorser:&quot;\\n\\007Org1MSP\\022\\325\\006-----BEGIN -----\\nMIICWTCCAgCgAwIBAgIQahOTRu7gpuR5AtIhNk3n1zAKBggqhkjOPQQDAjBzMQsw\\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\\nb3JnMS5leGFtcGxlLmNvbTAeFw0xNzExMTAwMzQ2NDNaFw0yNzExMDgwMzQ2NDNa\\nMFsxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\\nYW4gRnJhbmNpc2NvMR8wHQYDVQQDExZwZWVyMC5vcmcxLmV4YW1wbGUuY29tMFkw\\nEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEVn40lbdv6epcF1bx37dS9nbGJdRVCAkG\\n7hsUKHdvjOi9fAsU0fatanSZjtv2gJq/fXB/f3huHUijTP9H413zsaOBjTCBijAO\\nBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIw\\nADArBgNVHSMEJDAigCBKiLTrKKZzBXbm3oXivXoLjt8WfFszW8Ca76+pGi+wQTAo\\nBgNVHREEITAfghZwZWVyMC5vcmcxLmV4YW1wbGUuY29tggVwZWVyMDAKBggqhkjO\\nPQQDAgNHADBEAiA1uMkgn7nAb3uk3C8sQG0jBNHbY09eDKqb3R6e2uagcwIgJg6w\\nybzss2TAuaxqWMYX+JutKEJTlxSThiYjMaHcJds=\\n-----END -----\\n&quot; signature:&quot;0E\\002!\\000\\341\\334cR&gt;\\343\\273\\221\\005E#\\344[\\032\\377Q5IR\\323qNH\\3778\\025,\\243\\243o(W\\002 \\013\\036\\220\\234V\\271\\2651\\005\\254\\301p\\016&amp;\\254\\216\\202\\211\\nh\\231-\\314r\\260y\\354Fc\\036\\313x&quot; &gt; 2017-11-10 03:54:06.920 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 00b Chaincode invoke successful. result: status:200 2017-11-10 03:54:06.920 UTC [main] main -&gt; INFO 00c Exiting..... 再调用query命令来查一下b账户的余额，如果没有计算错，应该是210元。 root@e5fee400df40:/opt/gopath/src/github.com/hyperledger/fabric/peer# peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;b&quot;]}&#39; 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 001 intermediate certs folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts: no such file or directory] 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 002 crls folder not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/crls: no such file or directory] 2017-11-10 03:54:24.515 UTC [msp] getMspConfig -&gt; INFO 003 MSP configuration file not found at [/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml]: [stat /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp/config.yaml: no such file or directory] 2017-11-10 03:54:24.554 UTC [msp] GetLocalMSP -&gt; DEBU 004 Returning existing local MSP 2017-11-10 03:54:24.554 UTC [msp] GetDefaultSigningIdentity -&gt; DEBU 005 Obtaining default signing identity 2017-11-10 03:54:24.555 UTC [msp/identity] Sign -&gt; DEBU 006 Sign: plaintext: 0AB4070A6A08031A0C08F0C594D00510...696E63631A0A0A0571756572790A0162 2017-11-10 03:54:24.555 UTC [msp/identity] Sign -&gt; DEBU 007 Sign: digest: 97999F9BEFEAB1D7976AA68ABF2199668568D00C6EC1CB6C7F2C83C4DF6CAA06 Query Result: 210 测试成功。退出docker容器，然后执行下面的指令退出fabric环境。 root@pony-virtual-machine:~/gopath/src/fabric-sample/release/linux-amd64# ./network_setup.sh down 源码剖析 上面说了，源码目录在$GOPATH/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02目录下。 下面开始分析下这个示例chaincode。 type SimpleChaincode struct { } func (t *SimpleChaincode) Init(stub shim.ChaincodeStubInterface) pb.Response { fmt.Println(&quot;ex02 Init&quot;) _, args := stub.GetFunctionAndParameters() var A, B string // Entities var Aval, Bval int // Asset holdings var err error if len(args) != 4 { return shim.Error(&quot;Incorrect number of arguments. Expecting 4&quot;) } // Initialize the chaincode A = args[0] Aval, err = strconv.Atoi(args[1]) if err != nil { return shim.Error(&quot;Expecting integer value for asset holding&quot;) } B = args[2] Bval, err = strconv.Atoi(args[3]) if err != nil { return shim.Error(&quot;Expecting integer value for asset holding&quot;) } fmt.Printf(&quot;Aval = %d, Bval = %d\\n&quot;, Aval, Bval) // Write the state to the ledger err = stub.PutState(A, []byte(strconv.Itoa(Aval))) if err != nil { return shim.Error(err.Error()) } err = stub.PutState(B, []byte(strconv.Itoa(Bval))) if err != nil { return shim.Error(err.Error()) } return shim.Success(nil) } 这里首先定义了一个SimpleChaincode类，并且实现了该类的一个方法Init 这个Init方法不是随便定义的，根据fabric官方指引，一个chaincode需要实现如下的接口， type Chaincode interface { // Init is called during Instantiate transaction after the chaincode container // has been established for the first time, allowing the chaincode to // initialize its internal data Init(stub ChaincodeStubInterface) pb.Response // Invoke is called to update or query the ledger in a proposal transaction. // Updated state variables are not committed to the ledger until the // transaction is committed. Invoke(stub ChaincodeStubInterface) pb.Response } 当我们执行peer chaincode instantiate命令时，系统回调用我们实现的Init方法完成智能合约的初始化动作。 这里Init的实现其实比较简单，首先我们用GetFunctionAndParameters获取实例化传递过来的所有参数，并且要求参数的个数是四个。根据上面的instantiate指令我们知道传递的参数是 [&quot;init&quot;,&quot;a&quot;, &quot;100&quot;, &quot;b&quot;,&quot;200&quot;] 可能有人会有疑问，这里不是5个参数吗？ 其实GetFunctionAndParameters会返回两个值，第一个值是函数名，就是这里的”init”，第二个值就是后面的4个参数。 a和b这里我们表示两个账户(或者是两个人也可以)，数字是他们对应的账户余额。然后我们用 strconv.Atoi把数字有字符串转化为整型方便后面打印处理。 PutState会把key和value先放入fabric的写集，并不会马上更新账本。(更新账本由节点完成，chaincode后续不需要参与) 再看看接口里的另外一个方法， func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response { fmt.Println(&quot;ex02 Invoke&quot;) function, args := stub.GetFunctionAndParameters() if function == &quot;invoke&quot; { // Make payment of X units from A to B return t.invoke(stub, args) } else if function == &quot;delete&quot; { // Deletes an entity from its state return t.delete(stub, args) } else if function == &quot;query&quot; { // the old &quot;Query&quot; is now implemtned in invoke return t.query(stub, args) } return shim.Error(&quot;Invalid invoke function name. Expecting \\&quot;invoke\\&quot; \\&quot;delete\\&quot; \\&quot;query\\&quot;&quot;) } 可以看到Invoke并没有做具体的事情，而是根据函数名分发到子函数处理。先来看看query查询的操作。当我们执行 peer chaincode query -C mychannel -n devincc -c &#39;{&quot;Args&quot;:[&quot;query&quot;,&quot;a&quot;]}&#39; 系统调用Invoke，function是”query”，参数是”a”， 进入query方法， func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response { var A string // Entities var err error if len(args) != 1 { return shim.Error(&quot;Incorrect number of arguments. Expecting name of the person to query&quot;) } A = args[0] // Get the state from the ledger Avalbytes, err := stub.GetState(A) if err != nil { jsonResp := &quot;{\\&quot;Error\\&quot;:\\&quot;Failed to get state for &quot; + A + &quot;\\&quot;}&quot; return shim.Error(jsonResp) } if Avalbytes == nil { jsonResp := &quot;{\\&quot;Error\\&quot;:\\&quot;Nil amount for &quot; + A + &quot;\\&quot;}&quot; return shim.Error(jsonResp) } jsonResp := &quot;{\\&quot;Name\\&quot;:\\&quot;&quot; + A + &quot;\\&quot;,\\&quot;Amount\\&quot;:\\&quot;&quot; + string(Avalbytes) + &quot;\\&quot;}&quot; fmt.Printf(&quot;Query Response:%s\\n&quot;, jsonResp) return shim.Success(Avalbytes) } 关键的代码就是GetState这里，从账本获取指定key的value值，返回的是[]byte类型的值，然后通过shim.Sucess返回。 invoke和delete也都比较简单，这里就不多说了。 参考 http://www.cnblogs.com/studyzy/p/6973334.html 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/11/15/0e3feec8ef3cfb6c8080986a08f10df8.html","headline":"部署测试fabric1.0及源码解析","dateModified":"2017-11-15T00:00:00+08:00","datePublished":"2017-11-15T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/11/15/0e3feec8ef3cfb6c8080986a08f10df8.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>部署测试fabric1.0及源码解析</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h2 id="开发环境">开发环境</h2> 
  <ul> 
   <li>UBUNTU 16.04 LTS</li> 
   <li>docker</li> 
   <li>docker-compose</li> 
   <li>git</li> 
   <li>go 1.8以上</li> 
  </ul> 
  <p>docker,docker-compose以及go的安装这里不再描述。</p> 
  <h2 id="部署测试">部署测试</h2> 
  <p>新建fabric-sample目录(名字可以任意)，进入目录执行:</p> 
  <pre class="prettyprint"><code class=" hljs ruby">curl -sSL <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/raw.githubusercontent.com/hyperledger</span><span class="hljs-regexp">/fabric/master</span><span class="hljs-regexp">/scripts/bootstrap</span>-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>-beta.sh | bash</code></pre> 
  <p>这个脚本会下载需要的docker镜像以及自动化脚本，执行完毕后，首先会在当前目录看到一个release的文件夹，里面有fabric运行环境的启动脚本。</p> 
  <p>其次，我们需要的docker镜像也会一并拉取过来，如下:</p> 
  <pre class="prettyprint"><code class=" hljs lasso">hyperledger/fabric<span class="hljs-attribute">-tools</span>                 latest                ae6b0f53cb70        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.32</span>GB
hyperledger/fabric<span class="hljs-attribute">-tools</span>                 x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     ae6b0f53cb70        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.32</span>GB
hyperledger/fabric<span class="hljs-attribute">-couchdb</span>               latest                <span class="hljs-number">31</span>bbbec3d853        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.48</span>GB
hyperledger/fabric<span class="hljs-attribute">-couchdb</span>               x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     <span class="hljs-number">31</span>bbbec3d853        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.48</span>GB
hyperledger/fabric<span class="hljs-attribute">-kafka</span>                 latest                c4ac1c9a4797        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.3</span>GB
hyperledger/fabric<span class="hljs-attribute">-kafka</span>                 x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     c4ac1c9a4797        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.3</span>GB
hyperledger/fabric<span class="hljs-attribute">-zookeeper</span>             latest                <span class="hljs-number">2</span>c4ebacb6f00        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.31</span>GB
hyperledger/fabric<span class="hljs-attribute">-zookeeper</span>             x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     <span class="hljs-number">2</span>c4ebacb6f00        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.31</span>GB
hyperledger/fabric<span class="hljs-attribute">-orderer</span>               latest                <span class="hljs-number">11</span>ff350dd297        <span class="hljs-number">5</span> months ago        <span class="hljs-number">179</span>MB
hyperledger/fabric<span class="hljs-attribute">-orderer</span>               x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     <span class="hljs-number">11</span>ff350dd297        <span class="hljs-number">5</span> months ago        <span class="hljs-number">179</span>MB
hyperledger/fabric<span class="hljs-attribute">-peer</span>                  latest                e01c2b645f11        <span class="hljs-number">5</span> months ago        <span class="hljs-number">182</span>MB
hyperledger/fabric<span class="hljs-attribute">-peer</span>                  x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     e01c2b645f11        <span class="hljs-number">5</span> months ago        <span class="hljs-number">182</span>MB
hyperledger/fabric<span class="hljs-attribute">-javaenv</span>               latest                <span class="hljs-number">61</span>c188dca542        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.42</span>GB
hyperledger/fabric<span class="hljs-attribute">-javaenv</span>               x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     <span class="hljs-number">61</span>c188dca542        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.42</span>GB
hyperledger/fabric<span class="hljs-attribute">-ccenv</span>                 latest                <span class="hljs-number">7034</span>cca1918d        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.29</span>GB
hyperledger/fabric<span class="hljs-attribute">-ccenv</span>                 x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     <span class="hljs-number">7034</span>cca1918d        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.29</span>GB
hyperledger/fabric<span class="hljs-attribute">-ca</span>                    latest                e549e8c53c2e        <span class="hljs-number">5</span> months ago        <span class="hljs-number">238</span>MB
hyperledger/fabric<span class="hljs-attribute">-ca</span>                    x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-beta</span>     e549e8c53c2e        <span class="hljs-number">5</span> months ago        <span class="hljs-number">238</span>MB
hyperledger/fabric<span class="hljs-attribute">-ccenv</span>                 x86_64<span class="hljs-subst">-</span><span class="hljs-number">1.0</span><span class="hljs-number">.0</span><span class="hljs-attribute">-alpha2</span>   <span class="hljs-number">8</span>c360a57f805        <span class="hljs-number">5</span> months ago        <span class="hljs-number">1.29</span>GB
hyperledger/fabric<span class="hljs-attribute">-baseos</span>                x86_64<span class="hljs-subst">-</span><span class="hljs-number">0.3</span><span class="hljs-number">.1</span>          <span class="hljs-number">4</span>b0cab202084        <span class="hljs-number">6</span> months ago        <span class="hljs-number">157</span>MB
hyperledger/fabric<span class="hljs-attribute">-baseos</span>                x86_64<span class="hljs-subst">-</span><span class="hljs-number">0.3</span><span class="hljs-number">.2</span>          <span class="hljs-number">4</span>b0cab202084        <span class="hljs-number">6</span> months ago        <span class="hljs-number">157</span>MB
</code></pre> 
  <p>这里有一点要注意，如果你的环境之前执行过其它的fabric测试，可能会存在其它版本的docker镜像，建议删除。我试过不删除结果后面各种错误，删除之后一切正常。</p> 
  <p>启动fabric</p> 
  <pre class="prettyprint"><code class=" hljs lasso">cd ~/fabric<span class="hljs-attribute">-sample</span>/release/linux<span class="hljs-attribute">-amd64</span>
<span class="hljs-built_in">.</span>/network_setup<span class="hljs-built_in">.</span>sh up</code></pre> 
  <p>注意看有没有报错，正常的话最后会有下面这样的界面。</p> 
  <pre class="prettyprint"><code class=" hljs markdown">Query Result: 90
2017-11-10 03:48:00.802 UTC [main] main -&gt; INFO 008 Exiting.....
===================== Query on PEER3 on channel 'mychannel' is successful ===================== 

===================== All GOOD, End-2-End execution completed ===================== 


 <span class="hljs-strong">_____</span>   <span class="hljs-emphasis">_ _</span>   <span class="hljs-strong">____ __</span><span class="hljs-strong">___ __</span><span class="hljs-strong">__ __</span><span class="hljs-emphasis">___</span> 
| <span class="hljs-strong">____| | \ | | | _ \ | __</span><span class="hljs-strong">__| |__</span><span class="hljs-emphasis">_ \ | _</span><span class="hljs-emphasis">___</span>|
|  <span class="hljs-emphasis">_| | \| | | | | | _</span><span class="hljs-strong">____ | _| __</span>) | |  _|  
| |<span class="hljs-strong">___ | |\ | | |_| | |__</span><span class="hljs-strong">___| | |__</span><span class="hljs-emphasis">_ / _</span><span class="hljs-emphasis">_/ | |_</span>__ 
|<span class="hljs-strong">_____</span>| |<span class="hljs-emphasis">_| \_</span>| |<span class="hljs-strong">____/ |__</span><span class="hljs-strong">___| |__</span><span class="hljs-strong">___| |__</span><span class="hljs-emphasis">___</span>|

</code></pre> 
  <p>启动成功后，我们用docker ps命令可以看到类似下面这样的信息，</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">root@pony-virtual-machine:~/gopath/src/fabric-sample<span class="hljs-preprocessor"># docker ps</span>
CONTAINER ID        IMAGE                                    COMMAND                  CREATED             STATUS              PORTS                                              NAMES
e1f67091b0be        dev-peer1<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-mycc-<span class="hljs-number">1.0</span>      <span class="hljs-string">"chaincode -peer.a..."</span>   <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours                                                             dev-peer1<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-mycc-<span class="hljs-number">1.0</span>
c1c82b8269d1        dev-peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-mycc-<span class="hljs-number">1.0</span>      <span class="hljs-string">"chaincode -peer.a..."</span>   <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours                                                             dev-peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-mycc-<span class="hljs-number">1.0</span>
<span class="hljs-number">5610</span>d9ef3dfa        dev-peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-mycc-<span class="hljs-number">1.0</span>      <span class="hljs-string">"chaincode -peer.a..."</span>   <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours                                                             dev-peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>-mycc-<span class="hljs-number">1.0</span>
e5fee400df40        hyperledger/fabric-tools                 <span class="hljs-string">"/bin/bash -c './s..."</span>   <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours                                                             <span class="hljs-keyword">cli</span>
<span class="hljs-number">12252e8</span>c234e        hyperledger/fabric-peer                  <span class="hljs-string">"peer node start"</span>        <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">8051</span>-&gt;<span class="hljs-number">7051</span>/tcp, <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">8053</span>-&gt;<span class="hljs-number">7053</span>/tcp     peer1<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>
<span class="hljs-number">82</span>c82528a0e3        hyperledger/fabric-orderer               <span class="hljs-string">"orderer"</span>                <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">7050</span>-&gt;<span class="hljs-number">7050</span>/tcp                             orderer<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>
<span class="hljs-number">8e9</span>ed0104cc9        hyperledger/fabric-peer                  <span class="hljs-string">"peer node start"</span>        <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">7051</span>-&gt;<span class="hljs-number">7051</span>/tcp, <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">7053</span>-&gt;<span class="hljs-number">7053</span>/tcp     peer0<span class="hljs-preprocessor">.org</span>1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>
<span class="hljs-number">6475</span>f787dd66        hyperledger/fabric-peer                  <span class="hljs-string">"peer node start"</span>        <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">10051</span>-&gt;<span class="hljs-number">7051</span>/tcp, <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">10053</span>-&gt;<span class="hljs-number">7053</span>/tcp   peer1<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>
<span class="hljs-number">2</span>c65a798dca2        hyperledger/fabric-peer                  <span class="hljs-string">"peer node start"</span>        <span class="hljs-number">2</span> hours ago         Up <span class="hljs-number">2</span> hours          <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">9051</span>-&gt;<span class="hljs-number">7051</span>/tcp, <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">9053</span>-&gt;<span class="hljs-number">7053</span>/tcp     peer0<span class="hljs-preprocessor">.org</span>2<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>
</code></pre> 
  <p>也就是说，刚才的脚本为我们启动了一个cli客户端，一个orderer节点，4个普通的peer节点。而且，还有三个chaincode运行实例。</p> 
  <p>新开启一个终端，进入cli容器，</p> 
  <pre class="prettyprint"><code class=" hljs bash">docker <span class="hljs-keyword">exec</span> -it cli bash</code></pre> 
  <p>下面我们首先安装Example02，并指定一个名字，比如我们这里就用devincc：</p> 
  <pre class="prettyprint"><code class=" hljs lasso">peer chaincode install <span class="hljs-attribute">-n</span> devincc <span class="hljs-attribute">-v</span> <span class="hljs-number">1.0</span> <span class="hljs-attribute">-p</span> github<span class="hljs-built_in">.</span>com/hyperledger/fabric/examples/chaincode/go/chaincode_example02</code></pre> 
  <p>这里安装指定的目录是docker容器中的gopath路径下的 <br> github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02 <br> 目录中的chaincode程序。</p> 
  <p>下面有个专门的章节我会分析下这部分代码。</p> 
  <p>运行后可以看到提示运行成功，类似如下的信息:</p> 
  <pre class="prettyprint"><code class=" hljs css">2017<span class="hljs-tag">-11-10</span> 03<span class="hljs-pseudo">:50</span><span class="hljs-pseudo">:29</span><span class="hljs-class">.907</span> <span class="hljs-tag">UTC</span> <span class="hljs-attr_selector">[golang-platform]</span> <span class="hljs-tag">GetDeploymentPayload</span> <span class="hljs-tag">-</span>&gt; <span class="hljs-tag">DEBU</span> 00<span class="hljs-tag">c</span> <span class="hljs-tag">done</span>
2017<span class="hljs-tag">-11-10</span> 03<span class="hljs-pseudo">:50</span><span class="hljs-pseudo">:29</span><span class="hljs-class">.909</span> <span class="hljs-tag">UTC</span> <span class="hljs-attr_selector">[msp/identity]</span> <span class="hljs-tag">Sign</span> <span class="hljs-tag">-</span>&gt; <span class="hljs-tag">DEBU</span> 00<span class="hljs-tag">d</span> <span class="hljs-tag">Sign</span>: <span class="hljs-tag">plaintext</span>: 0<span class="hljs-tag">AA6070A5C08031A0C0885C494D00510</span>..<span class="hljs-class">.98F1CF000000FFFF6430F69C001C0000</span> 
2017<span class="hljs-tag">-11-10</span> 03<span class="hljs-pseudo">:50</span><span class="hljs-pseudo">:29</span><span class="hljs-class">.909</span> <span class="hljs-tag">UTC</span> <span class="hljs-attr_selector">[msp/identity]</span> <span class="hljs-tag">Sign</span> <span class="hljs-tag">-</span>&gt; <span class="hljs-tag">DEBU</span> 00<span class="hljs-tag">e</span> <span class="hljs-tag">Sign</span>: <span class="hljs-tag">digest</span>: 5779<span class="hljs-tag">AC7B30E7CFBAA5E698B90762616117CA8FA36144238F83C6A4A047D7A737</span> 
2017<span class="hljs-tag">-11-10</span> 03<span class="hljs-pseudo">:50</span><span class="hljs-pseudo">:29</span><span class="hljs-class">.914</span> <span class="hljs-tag">UTC</span> <span class="hljs-attr_selector">[chaincodeCmd]</span> <span class="hljs-tag">install</span> <span class="hljs-tag">-</span>&gt; <span class="hljs-tag">DEBU</span> 00<span class="hljs-tag">f</span> <span class="hljs-tag">Installed</span> <span class="hljs-tag">remotely</span> <span class="hljs-tag">response</span>:&lt;<span class="hljs-tag">status</span><span class="hljs-pseudo">:200</span> <span class="hljs-tag">payload</span><span class="hljs-pseudo">:"OK"</span> &gt; 
....</code></pre> 
  <p>初始化实例，设置a账户有100元，b账户有200元。</p> 
  <pre class="prettyprint"><code class=" hljs ruby">root<span class="hljs-variable">@e5fee400df40</span><span class="hljs-symbol">:/opt/gopath/src/github</span>.com/hyperledger/fabric/peer<span class="hljs-comment"># peer chaincode instantiate -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -v 1.0 -c '{"Args":["init","a", "100", "b","200"]}' -P "OR ('Org1MSP.member','Org2MSP.member')"</span>
</code></pre> 
  <p>注意看有没有报错。</p> 
  <p>用Query命令来看一看a账户的余额：</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">root@e5fee400df40:/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer<span class="hljs-preprocessor"># peer chaincode query -C mychannel -n devincc -c '{"Args":["query","a"]}'</span>
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.599</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">001</span> intermediate certs folder not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.599</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">002</span> crls folder not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/crls: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.599</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">003</span> MSP configuration file not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/config<span class="hljs-preprocessor">.yaml</span>]: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/config<span class="hljs-preprocessor">.yaml</span>: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.623</span> UTC [msp] GetLocalMSP -&gt; DEBU <span class="hljs-number">004</span> Returning existing local MSP
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.623</span> UTC [msp] GetDefaultSigningIdentity -&gt; DEBU <span class="hljs-number">005</span> Obtaining default signing identity
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.623</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">006</span> Sign: plaintext: <span class="hljs-number">0</span>AB4070A6A08031A0C08B5C594D00510..<span class="hljs-number">.696E63631</span>A0A0A0571756572790A0161 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">53</span>:<span class="hljs-number">25.623</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">007</span> Sign: digest: <span class="hljs-number">00</span>AA703102DBEA060C31B1E9FDD66143AD6454A27C2F1757ADE5265C992207A4 
Query Result: <span class="hljs-number">100</span>
</code></pre> 
  <p>余额是100元。</p> 
  <p>接下来我们把a账户的10元转给b账户，需要调用invoke命令：</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">root@e5fee400df40:/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer<span class="hljs-preprocessor"># peer chaincode invoke -o orderer.example.com:7050 --tls $CORE_PEER_TLS_ENABLED --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/cacerts/ca.example.com-cert.pem -C mychannel -n devincc -c '{"Args":["invoke","a","b","10"]}'</span>
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.834</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">001</span> intermediate certs folder not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.834</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">002</span> crls folder not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/crls: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.835</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">003</span> MSP configuration file not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/config<span class="hljs-preprocessor">.yaml</span>]: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/config<span class="hljs-preprocessor">.yaml</span>: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.882</span> UTC [msp] GetLocalMSP -&gt; DEBU <span class="hljs-number">004</span> Returning existing local MSP
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.882</span> UTC [msp] GetDefaultSigningIdentity -&gt; DEBU <span class="hljs-number">005</span> Obtaining default signing identity
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.887</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">006</span> Sign: plaintext: <span class="hljs-number">0</span>AB4070A6A08031A0C08DEC594D00510..<span class="hljs-number">.696E766</span>F6B650A01610A01620A023130 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.887</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">007</span> Sign: digest: CD26EE32A303A100BE43D3CCDDA6403FAA35F497ACA0C96F8C46A95A2487BDFD 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.902</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">008</span> Sign: plaintext: <span class="hljs-number">0</span>AB4070A6A08031A0C08DEC594D00510..<span class="hljs-number">.82890</span>A68992DCC72B079EC46631ECB78 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.902</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">009</span> Sign: digest: <span class="hljs-number">51965</span>C0B97EEB31A296977BA323972119BC4BE62EE5F18BB70B1EC69CFDF787B 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.920</span> UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; DEBU <span class="hljs-number">00</span>a ESCC invoke result: version:<span class="hljs-number">1</span> response:&lt;status:<span class="hljs-number">200</span> message:<span class="hljs-string">"OK"</span> &gt; payload:<span class="hljs-string">"\n \213&lt;\t\264i\241\247\235\257W\230\242W\236\251\\\2234\256\214\265\243?\236\274Z\200\025AU\377\026\022b\nK\0220\n\007devincc\022%\n\007\n\001a\022\002\010\005\n\007\n\001b\022\002\010\005\032\007\n\001a\032\00290\032\010\n\001b\032\003210\022\027\n\004lscc\022\017\n\r\n\007devincc\022\002\010\005\032\003\010\310\001\"\016\022\007devincc\032\0031.0"</span> endorsement:&lt;endorser:<span class="hljs-string">"\n\007Org1MSP\022\325\006-----BEGIN -----\nMIICWTCCAgCgAwIBAgIQahOTRu7gpuR5AtIhNk3n1zAKBggqhkjOPQQDAjBzMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEZMBcGA1UEChMQb3JnMS5leGFtcGxlLmNvbTEcMBoGA1UEAxMTY2Eu\nb3JnMS5leGFtcGxlLmNvbTAeFw0xNzExMTAwMzQ2NDNaFw0yNzExMDgwMzQ2NDNa\nMFsxCzAJBgNVBAYTAlVTMRMwEQYDVQQIEwpDYWxpZm9ybmlhMRYwFAYDVQQHEw1T\nYW4gRnJhbmNpc2NvMR8wHQYDVQQDExZwZWVyMC5vcmcxLmV4YW1wbGUuY29tMFkw\nEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEVn40lbdv6epcF1bx37dS9nbGJdRVCAkG\n7hsUKHdvjOi9fAsU0fatanSZjtv2gJq/fXB/f3huHUijTP9H413zsaOBjTCBijAO\nBgNVHQ8BAf8EBAMCBaAwEwYDVR0lBAwwCgYIKwYBBQUHAwEwDAYDVR0TAQH/BAIw\nADArBgNVHSMEJDAigCBKiLTrKKZzBXbm3oXivXoLjt8WfFszW8Ca76+pGi+wQTAo\nBgNVHREEITAfghZwZWVyMC5vcmcxLmV4YW1wbGUuY29tggVwZWVyMDAKBggqhkjO\nPQQDAgNHADBEAiA1uMkgn7nAb3uk3C8sQG0jBNHbY09eDKqb3R6e2uagcwIgJg6w\nybzss2TAuaxqWMYX+JutKEJTlxSThiYjMaHcJds=\n-----END -----\n"</span> signature:<span class="hljs-string">"0E\002!\000\341\334cR&gt;\343\273\221\005E#\344[\032\377Q5IR\323qNH\3778\025,\243\243o(W\002 \013\036\220\234V\271\2651\005\254\301p\016&amp;\254\216\202\211\nh\231-\314r\260y\354Fc\036\313x"</span> &gt; 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.920</span> UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO <span class="hljs-number">00</span>b Chaincode invoke successful. result: status:<span class="hljs-number">200</span> 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">06.920</span> UTC [main] main -&gt; INFO <span class="hljs-number">00</span>c Exiting.....</code></pre> 
  <p>再调用query命令来查一下b账户的余额，如果没有计算错，应该是210元。</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">root@e5fee400df40:/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer<span class="hljs-preprocessor"># peer chaincode query -C mychannel -n devincc -c '{"Args":["query","b"]}'</span>
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.515</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">001</span> intermediate certs folder not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.515</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">002</span> crls folder not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/intermediatecerts]. Skipping.: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/crls: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.515</span> UTC [msp] getMspConfig -&gt; INFO <span class="hljs-number">003</span> MSP configuration file not found at [/opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/config<span class="hljs-preprocessor">.yaml</span>]: [stat /opt/gopath/src/github<span class="hljs-preprocessor">.com</span>/hyperledger/fabric/peer/crypto/peerOrganizations/org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/users/Admin@org1<span class="hljs-preprocessor">.example</span><span class="hljs-preprocessor">.com</span>/msp/config<span class="hljs-preprocessor">.yaml</span>: no such file <span class="hljs-keyword">or</span> directory]
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.554</span> UTC [msp] GetLocalMSP -&gt; DEBU <span class="hljs-number">004</span> Returning existing local MSP
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.554</span> UTC [msp] GetDefaultSigningIdentity -&gt; DEBU <span class="hljs-number">005</span> Obtaining default signing identity
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.555</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">006</span> Sign: plaintext: <span class="hljs-number">0</span>AB4070A6A08031A0C08F0C594D00510..<span class="hljs-number">.696E63631</span>A0A0A0571756572790A0162 
<span class="hljs-number">2017</span>-<span class="hljs-number">11</span>-<span class="hljs-number">10</span> <span class="hljs-number">03</span>:<span class="hljs-number">54</span>:<span class="hljs-number">24.555</span> UTC [msp/identity] Sign -&gt; DEBU <span class="hljs-number">007</span> Sign: digest: <span class="hljs-number">97999</span>F9BEFEAB1D7976AA68ABF2199668568D00C6EC1CB6C7F2C83C4DF6CAA06 
Query Result: <span class="hljs-number">210</span></code></pre> 
  <p>测试成功。退出docker容器，然后执行下面的指令退出fabric环境。</p> 
  <pre class="prettyprint"><code class=" hljs ruby">root<span class="hljs-variable">@pony</span>-virtual-<span class="hljs-symbol">machine:</span>~<span class="hljs-regexp">/gopath/src</span><span class="hljs-regexp">/fabric-sample/release</span><span class="hljs-regexp">/linux-amd64# ./network</span>_setup.sh down</code></pre> 
  <h2 id="源码剖析">源码剖析</h2> 
  <p>上面说了，源码目录在$GOPATH/src/github.com/hyperledger/fabric/examples/chaincode/go/chaincode_example02目录下。</p> 
  <p>下面开始分析下这个示例chaincode。</p> 
  <pre class="prettyprint"><code class=" hljs go"><span class="hljs-keyword">type</span> SimpleChaincode <span class="hljs-keyword">struct</span> {
}

<span class="hljs-keyword">func</span> (t *SimpleChaincode) Init(stub shim.ChaincodeStubInterface) pb.Response {
    fmt.Println(<span class="hljs-string">"ex02 Init"</span>)
    _, args := stub.GetFunctionAndParameters()
    <span class="hljs-keyword">var</span> A, B <span class="hljs-typename">string</span>    <span class="hljs-comment">// Entities</span>
    <span class="hljs-keyword">var</span> Aval, Bval <span class="hljs-typename">int</span> <span class="hljs-comment">// Asset holdings</span>
    <span class="hljs-keyword">var</span> err error

    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(args) !=<span class="hljs-number"> 4</span> {
        <span class="hljs-keyword">return</span> shim.Error(<span class="hljs-string">"Incorrect number of arguments. Expecting 4"</span>)
    }

    <span class="hljs-comment">// Initialize the chaincode</span>
    A = args<span class="hljs-number">[0</span>]
    Aval, err = strconv.Atoi(args<span class="hljs-number">[1</span>])
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> shim.Error(<span class="hljs-string">"Expecting integer value for asset holding"</span>)
    }
    B = args<span class="hljs-number">[2</span>]
    Bval, err = strconv.Atoi(args<span class="hljs-number">[3</span>])
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> shim.Error(<span class="hljs-string">"Expecting integer value for asset holding"</span>)
    }
    fmt.Printf(<span class="hljs-string">"Aval = %d, Bval = %d\n"</span>, Aval, Bval)

    <span class="hljs-comment">// Write the state to the ledger</span>
    err = stub.PutState(A, []<span class="hljs-typename">byte</span>(strconv.Itoa(Aval)))
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> shim.Error(err.Error())
    }

    err = stub.PutState(B, []<span class="hljs-typename">byte</span>(strconv.Itoa(Bval)))
    <span class="hljs-keyword">if</span> err != <span class="hljs-constant">nil</span> {
        <span class="hljs-keyword">return</span> shim.Error(err.Error())
    }

    <span class="hljs-keyword">return</span> shim.Success(<span class="hljs-constant">nil</span>)
}</code></pre> 
  <p>这里首先定义了一个SimpleChaincode类，并且实现了该类的一个方法Init</p> 
  <p>这个Init方法不是随便定义的，根据fabric官方指引，一个chaincode需要实现如下的接口，</p> 
  <pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">Chaincode</span> interface <span class="hljs-container">{ // <span class="hljs-type">Init</span> <span class="hljs-title">is</span> <span class="hljs-title">called</span> <span class="hljs-title">during</span> <span class="hljs-type">Instantiate</span> <span class="hljs-title">transaction</span> <span class="hljs-title">after</span> <span class="hljs-title">the</span> <span class="hljs-title">chaincode</span> <span class="hljs-title">container</span> // <span class="hljs-title">has</span> <span class="hljs-title">been</span> <span class="hljs-title">established</span> <span class="hljs-title">for</span> <span class="hljs-title">the</span> <span class="hljs-title">first</span> <span class="hljs-title">time</span>, <span class="hljs-title">allowing</span> <span class="hljs-title">the</span> <span class="hljs-title">chaincode</span> <span class="hljs-title">to</span> // <span class="hljs-title">initialize</span> <span class="hljs-title">its</span> <span class="hljs-title">internal</span> <span class="hljs-title">data</span> <span class="hljs-type">Init</span>(<span class="hljs-title">stub</span> <span class="hljs-type">ChaincodeStubInterface</span>) <span class="hljs-title">pb</span>.<span class="hljs-type">Response</span> // <span class="hljs-type">Invoke</span> <span class="hljs-title">is</span> <span class="hljs-title">called</span> <span class="hljs-title">to</span> <span class="hljs-title">update</span> <span class="hljs-title">or</span> <span class="hljs-title">query</span> <span class="hljs-title">the</span> <span class="hljs-title">ledger</span> <span class="hljs-title">in</span> <span class="hljs-title">a</span> <span class="hljs-title">proposal</span> <span class="hljs-title">transaction</span>. // <span class="hljs-type">Updated</span> <span class="hljs-title">state</span> <span class="hljs-title">variables</span> <span class="hljs-title">are</span> <span class="hljs-title">not</span> <span class="hljs-title">committed</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">ledger</span> <span class="hljs-title">until</span> <span class="hljs-title">the</span> // <span class="hljs-title">transaction</span> <span class="hljs-title">is</span> <span class="hljs-title">committed</span>. <span class="hljs-type">Invoke</span>(<span class="hljs-title">stub</span> <span class="hljs-type">ChaincodeStubInterface</span>) <span class="hljs-title">pb</span>.<span class="hljs-type">Response</span> }</span></span></code></pre> 
  <p>当我们执行peer chaincode instantiate命令时，系统回调用我们实现的Init方法完成智能合约的初始化动作。</p> 
  <p>这里Init的实现其实比较简单，首先我们用GetFunctionAndParameters获取实例化传递过来的所有参数，并且要求参数的个数是四个。根据上面的instantiate指令我们知道传递的参数是</p> 
  <pre class="prettyprint"><code class=" hljs json">[<span class="hljs-string">"init"</span>,<span class="hljs-string">"a"</span>, <span class="hljs-string">"100"</span>, <span class="hljs-string">"b"</span>,<span class="hljs-string">"200"</span>]</code></pre> 
  <p>可能有人会有疑问，这里不是5个参数吗？ </p> 
  <p>其实GetFunctionAndParameters会返回两个值，第一个值是函数名，就是这里的”init”，第二个值就是后面的4个参数。</p> 
  <p>a和b这里我们表示两个账户(或者是两个人也可以)，数字是他们对应的账户余额。然后我们用</p> 
  <p>strconv.Atoi把数字有字符串转化为整型方便后面打印处理。</p> 
  <p>PutState会把key和value先放入fabric的写集，并不会马上更新账本。(更新账本由节点完成，chaincode后续不需要参与)</p> 
  <p>再看看接口里的另外一个方法，</p> 
  <pre class="prettyprint"><code class=" hljs livecodeserver">func (t *SimpleChaincode) Invoke(stub shim.ChaincodeStubInterface) pb.Response {
    fmt.Println(<span class="hljs-string">"ex02 Invoke"</span>)
    <span class="hljs-function"><span class="hljs-keyword">function</span>, <span class="hljs-title">args</span> := <span class="hljs-title">stub</span>.<span class="hljs-title">GetFunctionAndParameters</span>()</span>
    <span class="hljs-keyword">if</span> <span class="hljs-function"><span class="hljs-keyword">function</span> == <span class="hljs-string">"invoke"</span> {</span>
       <span class="hljs-comment"> // Make payment of X units from A to B</span>
        <span class="hljs-constant">return</span> t.invoke(stub, args)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-function"><span class="hljs-keyword">function</span> == <span class="hljs-string">"delete"</span> {</span>
       <span class="hljs-comment"> // Deletes an entity from its state</span>
        <span class="hljs-constant">return</span> t.<span class="hljs-built_in">delete</span>(stub, args)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-function"><span class="hljs-keyword">function</span> == <span class="hljs-string">"query"</span> {</span>
       <span class="hljs-comment"> // the old "Query" is now implemtned in invoke</span>
        <span class="hljs-constant">return</span> t.query(stub, args)
    }

    <span class="hljs-constant">return</span> shim.Error(<span class="hljs-string">"Invalid invoke function name. Expecting \"invoke\" \"delete\" \"query\""</span>)
}
</code></pre> 
  <p>可以看到Invoke并没有做具体的事情，而是根据函数名分发到子函数处理。先来看看query查询的操作。当我们执行</p> 
  <pre class="prettyprint"><code class=" hljs erlang">peer chaincode <span class="hljs-keyword">query</span> -<span class="hljs-variable">C</span> mychannel -n devincc -c '<span class="hljs-tuple">{<span class="hljs-string">"Args"</span>:[<span class="hljs-string">"query"</span>,<span class="hljs-string">"a"</span>]}</span>'</code></pre> 
  <p>系统调用Invoke，function是”query”，参数是”a”， 进入query方法，</p> 
  <pre class="prettyprint"><code class=" hljs autohotkey">func (t *SimpleChaincode) query(stub shim.ChaincodeStubInterface, args []string) pb.Response {
    var <span class="hljs-literal">A</span> string // Entities
    var err error

    <span class="hljs-keyword">if</span> len(args) != <span class="hljs-number">1</span> {
        <span class="hljs-keyword">return</span> shim.Error(<span class="hljs-string">"Incorrect number of arguments. Expecting name of the person to query"</span>)
    }

    <span class="hljs-literal">A</span> = args[<span class="hljs-number">0</span>]

    // Get the state from the ledger
    Avalbytes, err := stub.GetState(<span class="hljs-literal">A</span>)
    <span class="hljs-keyword">if</span> err != nil {
        jsonResp := <span class="hljs-string">"{\"</span>Error\<span class="hljs-string">":\"</span>Failed to get state for <span class="hljs-string">" + A + "</span>\<span class="hljs-string">"}"</span>
        <span class="hljs-keyword">return</span> shim.Error(jsonResp)
    }

    <span class="hljs-keyword">if</span> Avalbytes == nil {
        jsonResp := <span class="hljs-string">"{\"</span>Error\<span class="hljs-string">":\"</span>Nil amount for <span class="hljs-string">" + A + "</span>\<span class="hljs-string">"}"</span>
        <span class="hljs-keyword">return</span> shim.Error(jsonResp)
    }

    jsonResp := <span class="hljs-string">"{\"</span>Name\<span class="hljs-string">":\"</span><span class="hljs-string">" + A + "</span>\<span class="hljs-string">",\"</span>Amount\<span class="hljs-string">":\"</span><span class="hljs-string">" + string(Avalbytes) + "</span>\<span class="hljs-string">"}"</span>
    fmt.Printf(<span class="hljs-string">"Query Response:%s\n"</span>, jsonResp)
    <span class="hljs-keyword">return</span> shim.Success(Avalbytes)
}</code></pre> 
  <p>关键的代码就是GetState这里，从账本获取指定key的value值，返回的是[]byte类型的值，然后通过shim.Sucess返回。</p> 
  <p>invoke和delete也都比较简单，这里就不多说了。</p> 
  <p><strong>参考</strong></p> 
  <p><a href="http://www.cnblogs.com/studyzy/p/6973334.html" rel="nofollow" target="_blank">http://www.cnblogs.com/studyzy/p/6973334.html</a></p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/pony_maggie/article/details/78537529,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/pony_maggie/article/details/78537529,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
