<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>树莓派3B+ 智能家居（HomeKit） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="树莓派3B+ 智能家居（HomeKit）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="树莓派3B+ 智能家居（HomeKit） 当今科技发展日新月异，越来越多的新兴技术步入人们生活，智能家居同样也不例外，然后人们面对新科技却望而却步，因为整套设备的价格是非常昂贵的，而且现在还没有一个厂商能提供一套完整且稳定的系统，导致现在还不能快速普及。如果你想尝尝鲜，那么，一个树莓派就能为你创建一个这样的基础环境。 1.安装脚本 安装过程比较累赘，这里就不做过多的解释了。 安装所需的库 ：Node 和 HAP-NodeJS（Node版本为8.2.1，HAP-NodeJS更新为Nov 6, 2017） 打包链接：http://download.csdn.net/download/kxwinxp/10124545 完整实现脚本如下： #!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin export PATH echo &quot; +---------------------------------------------------------------------- | HAP-NodeJS FOR Debian raspberry +---------------------------------------------------------------------- | Copyright © 2017 kioye All rights reserved. +---------------------------------------------------------------------- &quot; #make sure your confirm. read -p &quot;Do you want to install HAP-NodeJS to the $setup_path directory now?(y/n): &quot; go; if [ &quot;$go&quot; == &#39;n&#39; ]||[ &quot;$go&quot; == &#39;N&#39; ];then exit; fi # get into directory of application cd ~ mkdir application cd application sudo apt-get install -y git avahi-daemon avahi-discover libnss-mdns libavahi-compat-libdnssd-dev build-essential # apt-get update --fix-missing -y sudo service avahi-daemon start wget -O node.tar.gz https://nodejs.org/dist/v8.2.1/node-v8.2.1-linux-armv7l.tar.xz tar -zxvf node.tar.gz mv node-*l usr sudo cp -rf usr / # install node base cross-platform sudo npm install -g -y node-gyp # install C++ lib sudo apt-get install -y libavahi-compat-libdnssd-dev # download HAP-NodeJS git clone https://github.com/KhaosT/HAP-NodeJS.git sudo chmod -R 777 /root ./HAP-NodeJS # get into HAP-NodeJS directory cd HAP-NodeJS # install some access for HAP-NodeJS sudo npm install -y node-persist debug mdns fast-srp-hap ed25519 buffer-shims curve25519-n2 ip python-shell cd .. echo &quot; +---------------------------------------------------------------------- | HAP-NodeJS Installed finish!! +---------------------------------------------------------------------- | start in Bridged mode: | sudo node HAP-NodeJS/BridgedCore.js +---------------------------------------------------------------------- | run as an independent HomeKit device: | sudo node HAP-NodeJS/Core.js +---------------------------------------------------------------------- &quot; exit 0 2.添加到自启动 sudo vim /etc/rc.local // 在 exit 0 前添加如下： # HAP-NodeJS 开机自启脚本（nohup为后台执行,run.log为运行记录。） sudo nohup node /home/pi/application/HAP-NodeJS/Core.js &gt;/home/pi/application/HAP-NodeJS/run.log 2&gt;&amp;1 &amp; # python GPIO口初始化！ python /home/pi/application/HAP-NodeJS/python/init.py GPIO初始化口，我接下来要用的是 11、13和15口。 脚本如下： vim ~/application/HAP-NodeJS/python/init.py // -------------请完整复制粘贴如下内容！！------------------ #!/usr/bin/env python import RPi.GPIO as GPIO import sys def setup(p): GPIO.setmode(GPIO.BOARD) GPIO.setup(p, GPIO.OUT) GPIO.setwarnings(False) # 初始化 11、13和15口。 arr={11,13,15} for gp in arr: setup(gp); sys.exit(0) 3.HAP-NodeJS介绍 GitHub：https://github.com/KhaosT/HAP-NodeJS HAP Nodejs是一个通过Nodejs搭建的HomeKit服务器。因此，它能直接和苹果 家庭（home）应用相连。苹果设备又支持Siri，故可以直接通过Siri控制HomeKit设备。 它有两种启动模式： 桥接模式启动HAP服务器： sudo node HAP-NodeJS/BridgedCore.js 独立模式（各配件作为一个的HomeKit设备启动）： sudo node HAP-NodeJS/Core.js 可自己定义配件： 格式为：accessories/**_accessory.js文件 **为简短的描述，所有此类定义的附件都会在服务器上加载。（非此类将不会加载！） 4.模拟配件 4.1 模拟一个两级亮度的灯 该配件是通过python-shell来控制GPIO，故需安装python的gpio包。 sudo apt-get install -y python-rpi.gpio 一个控制灯的附件代码： 功能：控制 GPIO 13 和 15 口，分别控制灯开关和亮度（两级），默认高电平为开启。 可以直接在var powergp=&#39;13&#39;;和var brightnessgp=&#39;15&#39;;修改GPIO口。 // 创建MyTableLight_accessory.js sudo vim ~/application/HAP-NodeJS/accessories/MyTableLight_accessory.js // -------------请完整复制粘贴如下内容！！------------------ var Accessory = require(&#39;../&#39;).Accessory; var Service = require(&#39;../&#39;).Service; var Characteristic = require(&#39;../&#39;).Characteristic; var uuid = require(&#39;../&#39;).uuid; var PythonShell = require(&#39;python-shell&#39;); var powergp=&#39;13&#39;; var brightnessgp=&#39;15&#39;; var LightController = { name: &quot;My Table Light&quot;, //name of accessory pincode: &quot;031-45-154&quot;, username: &quot;FA:3C:ED:5A:1A:1F&quot;, // MAC like address used by HomeKit to differentiate accessories. manufacturer: &quot;HAP-NodeJS&quot;, //manufacturer (optional) model: &quot;v1.0&quot;, //model (optional) serialNumber: &quot;A12S345KGB&quot;, //serial number (optional) power: false, //curent power status brightness: 100, //current brightness hue: 0, //current hue saturation: 0, //current saturation outputLogs: true, //output logs setPower: function(status) { //set power of accessory if(this.outputLogs) { console.log(&quot;Turning the &#39;%s&#39; %s&quot;, this.name, status ? &quot;on&quot; : &quot;off&quot;); } PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[powergp+&#39;:&#39;+(status?1:0)]}, function (err,results) { if (err) console.log(err); }); this.power = status; }, getPower: function() { //get power of accessory PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[powergp+&#39;:g&#39;]}, function(err,results){ console.log(&#39;results: %j&#39;, results); var resultMap=eval(&#39;(&#39;+results.pop()+&#39;)&#39;); this.power=(resultMap[powergp]==1)?true:false; }); if(this.outputLogs) console.log(&quot;&#39;%s&#39; is %s.&quot;, this.name, this.power ? &quot;on&quot; : &quot;off&quot;); return this.power; }, setBrightness: function(brightness) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; brightness to %s&quot;, this.name, brightness); PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[brightnessgp+&#39;:&#39;+((brightness &lt;= 50)?1:0)]}, function (err,results) { if (err) console.log(err); }); this.brightness = brightness; }, getBrightness: function() { //get brightness PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[brightnessgp+&#39;:g&#39;]}, function(err,results){ console.log(&#39;results: %j&#39;, results); var resultMap=eval(&#39;(&#39;+results.pop()+&#39;)&#39;); this.brightness=(resultMap[brightnessgp]==1)?50:100; }); if(this.outputLogs) console.log(&quot;&#39;%s&#39; brightness is %s&quot;, this.name, this.brightness); return this.brightness; }, setSaturation: function(saturation) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; saturation to %s&quot;, this.name, saturation); this.saturation = saturation; }, getSaturation: function() { //get brightness if(this.outputLogs) console.log(&quot;&#39;%s&#39; saturation is %s&quot;, this.name, this.saturation); return this.saturation; }, setHue: function(hue) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; hue to %s&quot;, this.name, hue); this.hue = hue; }, getHue: function() { //get hue if(this.outputLogs) console.log(&quot;&#39;%s&#39; hue is %s&quot;, this.name, this.hue); return this.hue; }, identify: function() { //identify the accessory if(this.outputLogs) console.log(&quot;Identify the &#39;%s&#39;&quot;, this.name); } } // Generate a consistent UUID for our light Accessory that will remain the same even when // restarting our server. We use the `uuid.generate` helper function to create a deterministic // UUID based on an arbitrary &quot;namespace&quot; and the word &quot;light&quot;. var lightUUID = uuid.generate(&#39;hap-nodejs:accessories:light&#39; + LightController.name); // This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our light. var lightAccessory = exports.accessory = new Accessory(LightController.name, lightUUID); // Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js) lightAccessory.username = LightController.username; lightAccessory.pincode = LightController.pincode; // set some basic properties (these values are arbitrary and setting them is optional) lightAccessory .getService(Service.AccessoryInformation) .setCharacteristic(Characteristic.Manufacturer, LightController.manufacturer) .setCharacteristic(Characteristic.Model, LightController.model) .setCharacteristic(Characteristic.SerialNumber, LightController.serialNumber); // listen for the &quot;identify&quot; event for this Accessory lightAccessory.on(&#39;identify&#39;, function(paired, callback) { LightController.identify(); callback(); }); // Add the actual Lightbulb Service and listen for change events from iOS. // We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js` lightAccessory .addService(Service.Lightbulb, LightController.name) // services exposed to the user should have &quot;names&quot; like &quot;Light&quot; for this case .getCharacteristic(Characteristic.On) .on(&#39;set&#39;, function(value, callback) { LightController.setPower(value); // Our light is synchronous - this value has been successfully set // Invoke the callback when you finished processing the request // If it&#39;s going to take more than 1s to finish the request, try to invoke the callback // after getting the request instead of after finishing it. This avoids blocking other // requests from HomeKit. callback(); }) // We want to intercept requests for our current power state so we can query the hardware itself instead of // allowing HAP-NodeJS to return the cached Characteristic.value. .on(&#39;get&#39;, function(callback) { callback(null, LightController.getPower()); }); // To inform HomeKit about changes occurred outside of HomeKit (like user physically turn on the light) // Please use Characteristic.updateValue // // lightAccessory // .getService(Service.Lightbulb) // .getCharacteristic(Characteristic.On) // .updateValue(true); // also add an &quot;optional&quot; Characteristic for Brightness lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Brightness) .on(&#39;set&#39;, function(value, callback) { LightController.setBrightness(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getBrightness()); }); // also add an &quot;optional&quot; Characteristic for Saturation lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Saturation) .on(&#39;set&#39;, function(value, callback) { LightController.setSaturation(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getSaturation()); }); // also add an &quot;optional&quot; Characteristic for Hue lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Hue) .on(&#39;set&#39;, function(value, callback) { LightController.setHue(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getHue()); }); 准备一个python脚本控制GPIO口： sudo vim ~/application/HAP-NodeJS/python/gpio.py // -------------请完整复制粘贴如下内容！！------------------ #!/usr/bin/env python import RPi.GPIO as GPIO import sys def init(gp): GPIO.setmode(GPIO.BOARD) GPIO.setup(gp, GPIO.OUT) GPIO.setwarnings(False) # simple argument echo script ret={} for arg in sys.argv[1:]: #print arg args=arg.split(&#39;:&#39;) init(int(args[0])) if args[1]==&#39;g&#39;: ret[args[0]]=GPIO.input(int(args[0])) elif args[1]==&#39;0&#39;: GPIO.output(int(args[0]), GPIO.LOW) elif args[1]==&#39;1&#39;: GPIO.output(int(args[0]), GPIO.HIGH) #setup(int(v)) print ret sys.exit(0) 4.2 模拟一个开关插座 我这个插座是接的音响，所以叫“My sound”，不要见怪。 这里使用的是 GPIO 11 口，默认是高电平是开启。 代码如下： // 创建MySound_accessory.js sudo vim ~/application/HAP-NodeJS/accessories/MySound_accessory.js // -------------请完整复制粘贴如下内容！！------------------ var Accessory = require(&#39;../&#39;).Accessory; var Service = require(&#39;../&#39;).Service; var Characteristic = require(&#39;../&#39;).Characteristic; var uuid = require(&#39;../&#39;).uuid; var err = null; // in case there were any problems var PythonShell = require(&#39;python-shell&#39;); var soundgp=&#39;11&#39;; // here&#39;s a fake hardware device that we&#39;ll expose to HomeKit var FAKE_OUTLET = { setPowerOn: function(on) { console.log(&quot;Turning the MySound %s!...&quot;, on ? &quot;on&quot; : &quot;off&quot;); PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[soundgp+&#39;:&#39;+(on?1:0)]}, function (err,results) { if (err) console.log(err); }); FAKE_OUTLET.powerOn=on; }, identify: function() { console.log(&quot;Identify the MySound.&quot;); } } // Generate a consistent UUID for our MySound Accessory that will remain the same even when // restarting our server. We use the `uuid.generate` helper function to create a deterministic // UUID based on an arbitrary &quot;namespace&quot; and the accessory name. var outletUUID = uuid.generate(&#39;hap-nodejs:accessories:MySound&#39;); // This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our fake light. var outlet = exports.accessory = new Accessory(&#39;MySound&#39;, outletUUID); // Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js) outlet.username = &quot;1A:2B:3C:4D:5D:FG&quot;; outlet.pincode = &quot;031-45-154&quot;; // set some basic properties (these values are arbitrary and setting them is optional) outlet .getService(Service.AccessoryInformation) .setCharacteristic(Characteristic.Manufacturer, &quot;Oltica&quot;) .setCharacteristic(Characteristic.Model, &quot;Rev-1&quot;) .setCharacteristic(Characteristic.SerialNumber, &quot;A1S2NASF88EW&quot;); // listen for the &quot;identify&quot; event for this Accessory outlet.on(&#39;identify&#39;, function(paired, callback) { FAKE_OUTLET.identify(); callback(); // success }); // Add the actual MySound Service and listen for change events from iOS. // We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js` outlet .addService(Service.Outlet, &quot;My Sound&quot;) // services exposed to the user should have &quot;names&quot; like &quot;Fake Light&quot; for us .getCharacteristic(Characteristic.On) .on(&#39;set&#39;, function(value, callback) { FAKE_OUTLET.setPowerOn(value); callback(); // Our fake Outlet is synchronous - this value has been successfully set }); // We want to intercept requests for our current power state so we can query the hardware itself instead of // allowing HAP-NodeJS to return the cached Characteristic.value. outlet .getService(Service.Outlet) .getCharacteristic(Characteristic.On) .on(&#39;get&#39;, function(callback) { // this event is emitted when you ask Siri directly whether your light is on or not. you might query // the light hardware itself to find this out, then call the callback. But if you take longer than a // few seconds to respond, Siri will give up. var err = null; // in case there were any problems if (FAKE_OUTLET.powerOn) { console.log(&quot;Are we on? Yes.&quot;); callback(err, true); } else { console.log(&quot;Are we on? No.&quot;); callback(err, false); } }); 控制也是通过调用 gpio.py 的 python 脚本，和 4.1 里面的 python 脚本一样的。 好了，现在可以重启一下树莓派。 5.将HomeKit设备添加到家庭中 如图，选择将这些设备添加进去，输入认证代码 03145154（这个可以在accessary.js修改）。 然后就可以愉快使用 Siri 进行语音控制了！ 阅读更多" />
<meta property="og:description" content="树莓派3B+ 智能家居（HomeKit） 当今科技发展日新月异，越来越多的新兴技术步入人们生活，智能家居同样也不例外，然后人们面对新科技却望而却步，因为整套设备的价格是非常昂贵的，而且现在还没有一个厂商能提供一套完整且稳定的系统，导致现在还不能快速普及。如果你想尝尝鲜，那么，一个树莓派就能为你创建一个这样的基础环境。 1.安装脚本 安装过程比较累赘，这里就不做过多的解释了。 安装所需的库 ：Node 和 HAP-NodeJS（Node版本为8.2.1，HAP-NodeJS更新为Nov 6, 2017） 打包链接：http://download.csdn.net/download/kxwinxp/10124545 完整实现脚本如下： #!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin export PATH echo &quot; +---------------------------------------------------------------------- | HAP-NodeJS FOR Debian raspberry +---------------------------------------------------------------------- | Copyright © 2017 kioye All rights reserved. +---------------------------------------------------------------------- &quot; #make sure your confirm. read -p &quot;Do you want to install HAP-NodeJS to the $setup_path directory now?(y/n): &quot; go; if [ &quot;$go&quot; == &#39;n&#39; ]||[ &quot;$go&quot; == &#39;N&#39; ];then exit; fi # get into directory of application cd ~ mkdir application cd application sudo apt-get install -y git avahi-daemon avahi-discover libnss-mdns libavahi-compat-libdnssd-dev build-essential # apt-get update --fix-missing -y sudo service avahi-daemon start wget -O node.tar.gz https://nodejs.org/dist/v8.2.1/node-v8.2.1-linux-armv7l.tar.xz tar -zxvf node.tar.gz mv node-*l usr sudo cp -rf usr / # install node base cross-platform sudo npm install -g -y node-gyp # install C++ lib sudo apt-get install -y libavahi-compat-libdnssd-dev # download HAP-NodeJS git clone https://github.com/KhaosT/HAP-NodeJS.git sudo chmod -R 777 /root ./HAP-NodeJS # get into HAP-NodeJS directory cd HAP-NodeJS # install some access for HAP-NodeJS sudo npm install -y node-persist debug mdns fast-srp-hap ed25519 buffer-shims curve25519-n2 ip python-shell cd .. echo &quot; +---------------------------------------------------------------------- | HAP-NodeJS Installed finish!! +---------------------------------------------------------------------- | start in Bridged mode: | sudo node HAP-NodeJS/BridgedCore.js +---------------------------------------------------------------------- | run as an independent HomeKit device: | sudo node HAP-NodeJS/Core.js +---------------------------------------------------------------------- &quot; exit 0 2.添加到自启动 sudo vim /etc/rc.local // 在 exit 0 前添加如下： # HAP-NodeJS 开机自启脚本（nohup为后台执行,run.log为运行记录。） sudo nohup node /home/pi/application/HAP-NodeJS/Core.js &gt;/home/pi/application/HAP-NodeJS/run.log 2&gt;&amp;1 &amp; # python GPIO口初始化！ python /home/pi/application/HAP-NodeJS/python/init.py GPIO初始化口，我接下来要用的是 11、13和15口。 脚本如下： vim ~/application/HAP-NodeJS/python/init.py // -------------请完整复制粘贴如下内容！！------------------ #!/usr/bin/env python import RPi.GPIO as GPIO import sys def setup(p): GPIO.setmode(GPIO.BOARD) GPIO.setup(p, GPIO.OUT) GPIO.setwarnings(False) # 初始化 11、13和15口。 arr={11,13,15} for gp in arr: setup(gp); sys.exit(0) 3.HAP-NodeJS介绍 GitHub：https://github.com/KhaosT/HAP-NodeJS HAP Nodejs是一个通过Nodejs搭建的HomeKit服务器。因此，它能直接和苹果 家庭（home）应用相连。苹果设备又支持Siri，故可以直接通过Siri控制HomeKit设备。 它有两种启动模式： 桥接模式启动HAP服务器： sudo node HAP-NodeJS/BridgedCore.js 独立模式（各配件作为一个的HomeKit设备启动）： sudo node HAP-NodeJS/Core.js 可自己定义配件： 格式为：accessories/**_accessory.js文件 **为简短的描述，所有此类定义的附件都会在服务器上加载。（非此类将不会加载！） 4.模拟配件 4.1 模拟一个两级亮度的灯 该配件是通过python-shell来控制GPIO，故需安装python的gpio包。 sudo apt-get install -y python-rpi.gpio 一个控制灯的附件代码： 功能：控制 GPIO 13 和 15 口，分别控制灯开关和亮度（两级），默认高电平为开启。 可以直接在var powergp=&#39;13&#39;;和var brightnessgp=&#39;15&#39;;修改GPIO口。 // 创建MyTableLight_accessory.js sudo vim ~/application/HAP-NodeJS/accessories/MyTableLight_accessory.js // -------------请完整复制粘贴如下内容！！------------------ var Accessory = require(&#39;../&#39;).Accessory; var Service = require(&#39;../&#39;).Service; var Characteristic = require(&#39;../&#39;).Characteristic; var uuid = require(&#39;../&#39;).uuid; var PythonShell = require(&#39;python-shell&#39;); var powergp=&#39;13&#39;; var brightnessgp=&#39;15&#39;; var LightController = { name: &quot;My Table Light&quot;, //name of accessory pincode: &quot;031-45-154&quot;, username: &quot;FA:3C:ED:5A:1A:1F&quot;, // MAC like address used by HomeKit to differentiate accessories. manufacturer: &quot;HAP-NodeJS&quot;, //manufacturer (optional) model: &quot;v1.0&quot;, //model (optional) serialNumber: &quot;A12S345KGB&quot;, //serial number (optional) power: false, //curent power status brightness: 100, //current brightness hue: 0, //current hue saturation: 0, //current saturation outputLogs: true, //output logs setPower: function(status) { //set power of accessory if(this.outputLogs) { console.log(&quot;Turning the &#39;%s&#39; %s&quot;, this.name, status ? &quot;on&quot; : &quot;off&quot;); } PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[powergp+&#39;:&#39;+(status?1:0)]}, function (err,results) { if (err) console.log(err); }); this.power = status; }, getPower: function() { //get power of accessory PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[powergp+&#39;:g&#39;]}, function(err,results){ console.log(&#39;results: %j&#39;, results); var resultMap=eval(&#39;(&#39;+results.pop()+&#39;)&#39;); this.power=(resultMap[powergp]==1)?true:false; }); if(this.outputLogs) console.log(&quot;&#39;%s&#39; is %s.&quot;, this.name, this.power ? &quot;on&quot; : &quot;off&quot;); return this.power; }, setBrightness: function(brightness) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; brightness to %s&quot;, this.name, brightness); PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[brightnessgp+&#39;:&#39;+((brightness &lt;= 50)?1:0)]}, function (err,results) { if (err) console.log(err); }); this.brightness = brightness; }, getBrightness: function() { //get brightness PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[brightnessgp+&#39;:g&#39;]}, function(err,results){ console.log(&#39;results: %j&#39;, results); var resultMap=eval(&#39;(&#39;+results.pop()+&#39;)&#39;); this.brightness=(resultMap[brightnessgp]==1)?50:100; }); if(this.outputLogs) console.log(&quot;&#39;%s&#39; brightness is %s&quot;, this.name, this.brightness); return this.brightness; }, setSaturation: function(saturation) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; saturation to %s&quot;, this.name, saturation); this.saturation = saturation; }, getSaturation: function() { //get brightness if(this.outputLogs) console.log(&quot;&#39;%s&#39; saturation is %s&quot;, this.name, this.saturation); return this.saturation; }, setHue: function(hue) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; hue to %s&quot;, this.name, hue); this.hue = hue; }, getHue: function() { //get hue if(this.outputLogs) console.log(&quot;&#39;%s&#39; hue is %s&quot;, this.name, this.hue); return this.hue; }, identify: function() { //identify the accessory if(this.outputLogs) console.log(&quot;Identify the &#39;%s&#39;&quot;, this.name); } } // Generate a consistent UUID for our light Accessory that will remain the same even when // restarting our server. We use the `uuid.generate` helper function to create a deterministic // UUID based on an arbitrary &quot;namespace&quot; and the word &quot;light&quot;. var lightUUID = uuid.generate(&#39;hap-nodejs:accessories:light&#39; + LightController.name); // This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our light. var lightAccessory = exports.accessory = new Accessory(LightController.name, lightUUID); // Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js) lightAccessory.username = LightController.username; lightAccessory.pincode = LightController.pincode; // set some basic properties (these values are arbitrary and setting them is optional) lightAccessory .getService(Service.AccessoryInformation) .setCharacteristic(Characteristic.Manufacturer, LightController.manufacturer) .setCharacteristic(Characteristic.Model, LightController.model) .setCharacteristic(Characteristic.SerialNumber, LightController.serialNumber); // listen for the &quot;identify&quot; event for this Accessory lightAccessory.on(&#39;identify&#39;, function(paired, callback) { LightController.identify(); callback(); }); // Add the actual Lightbulb Service and listen for change events from iOS. // We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js` lightAccessory .addService(Service.Lightbulb, LightController.name) // services exposed to the user should have &quot;names&quot; like &quot;Light&quot; for this case .getCharacteristic(Characteristic.On) .on(&#39;set&#39;, function(value, callback) { LightController.setPower(value); // Our light is synchronous - this value has been successfully set // Invoke the callback when you finished processing the request // If it&#39;s going to take more than 1s to finish the request, try to invoke the callback // after getting the request instead of after finishing it. This avoids blocking other // requests from HomeKit. callback(); }) // We want to intercept requests for our current power state so we can query the hardware itself instead of // allowing HAP-NodeJS to return the cached Characteristic.value. .on(&#39;get&#39;, function(callback) { callback(null, LightController.getPower()); }); // To inform HomeKit about changes occurred outside of HomeKit (like user physically turn on the light) // Please use Characteristic.updateValue // // lightAccessory // .getService(Service.Lightbulb) // .getCharacteristic(Characteristic.On) // .updateValue(true); // also add an &quot;optional&quot; Characteristic for Brightness lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Brightness) .on(&#39;set&#39;, function(value, callback) { LightController.setBrightness(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getBrightness()); }); // also add an &quot;optional&quot; Characteristic for Saturation lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Saturation) .on(&#39;set&#39;, function(value, callback) { LightController.setSaturation(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getSaturation()); }); // also add an &quot;optional&quot; Characteristic for Hue lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Hue) .on(&#39;set&#39;, function(value, callback) { LightController.setHue(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getHue()); }); 准备一个python脚本控制GPIO口： sudo vim ~/application/HAP-NodeJS/python/gpio.py // -------------请完整复制粘贴如下内容！！------------------ #!/usr/bin/env python import RPi.GPIO as GPIO import sys def init(gp): GPIO.setmode(GPIO.BOARD) GPIO.setup(gp, GPIO.OUT) GPIO.setwarnings(False) # simple argument echo script ret={} for arg in sys.argv[1:]: #print arg args=arg.split(&#39;:&#39;) init(int(args[0])) if args[1]==&#39;g&#39;: ret[args[0]]=GPIO.input(int(args[0])) elif args[1]==&#39;0&#39;: GPIO.output(int(args[0]), GPIO.LOW) elif args[1]==&#39;1&#39;: GPIO.output(int(args[0]), GPIO.HIGH) #setup(int(v)) print ret sys.exit(0) 4.2 模拟一个开关插座 我这个插座是接的音响，所以叫“My sound”，不要见怪。 这里使用的是 GPIO 11 口，默认是高电平是开启。 代码如下： // 创建MySound_accessory.js sudo vim ~/application/HAP-NodeJS/accessories/MySound_accessory.js // -------------请完整复制粘贴如下内容！！------------------ var Accessory = require(&#39;../&#39;).Accessory; var Service = require(&#39;../&#39;).Service; var Characteristic = require(&#39;../&#39;).Characteristic; var uuid = require(&#39;../&#39;).uuid; var err = null; // in case there were any problems var PythonShell = require(&#39;python-shell&#39;); var soundgp=&#39;11&#39;; // here&#39;s a fake hardware device that we&#39;ll expose to HomeKit var FAKE_OUTLET = { setPowerOn: function(on) { console.log(&quot;Turning the MySound %s!...&quot;, on ? &quot;on&quot; : &quot;off&quot;); PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[soundgp+&#39;:&#39;+(on?1:0)]}, function (err,results) { if (err) console.log(err); }); FAKE_OUTLET.powerOn=on; }, identify: function() { console.log(&quot;Identify the MySound.&quot;); } } // Generate a consistent UUID for our MySound Accessory that will remain the same even when // restarting our server. We use the `uuid.generate` helper function to create a deterministic // UUID based on an arbitrary &quot;namespace&quot; and the accessory name. var outletUUID = uuid.generate(&#39;hap-nodejs:accessories:MySound&#39;); // This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our fake light. var outlet = exports.accessory = new Accessory(&#39;MySound&#39;, outletUUID); // Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js) outlet.username = &quot;1A:2B:3C:4D:5D:FG&quot;; outlet.pincode = &quot;031-45-154&quot;; // set some basic properties (these values are arbitrary and setting them is optional) outlet .getService(Service.AccessoryInformation) .setCharacteristic(Characteristic.Manufacturer, &quot;Oltica&quot;) .setCharacteristic(Characteristic.Model, &quot;Rev-1&quot;) .setCharacteristic(Characteristic.SerialNumber, &quot;A1S2NASF88EW&quot;); // listen for the &quot;identify&quot; event for this Accessory outlet.on(&#39;identify&#39;, function(paired, callback) { FAKE_OUTLET.identify(); callback(); // success }); // Add the actual MySound Service and listen for change events from iOS. // We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js` outlet .addService(Service.Outlet, &quot;My Sound&quot;) // services exposed to the user should have &quot;names&quot; like &quot;Fake Light&quot; for us .getCharacteristic(Characteristic.On) .on(&#39;set&#39;, function(value, callback) { FAKE_OUTLET.setPowerOn(value); callback(); // Our fake Outlet is synchronous - this value has been successfully set }); // We want to intercept requests for our current power state so we can query the hardware itself instead of // allowing HAP-NodeJS to return the cached Characteristic.value. outlet .getService(Service.Outlet) .getCharacteristic(Characteristic.On) .on(&#39;get&#39;, function(callback) { // this event is emitted when you ask Siri directly whether your light is on or not. you might query // the light hardware itself to find this out, then call the callback. But if you take longer than a // few seconds to respond, Siri will give up. var err = null; // in case there were any problems if (FAKE_OUTLET.powerOn) { console.log(&quot;Are we on? Yes.&quot;); callback(err, true); } else { console.log(&quot;Are we on? No.&quot;); callback(err, false); } }); 控制也是通过调用 gpio.py 的 python 脚本，和 4.1 里面的 python 脚本一样的。 好了，现在可以重启一下树莓派。 5.将HomeKit设备添加到家庭中 如图，选择将这些设备添加进去，输入认证代码 03145154（这个可以在accessary.js修改）。 然后就可以愉快使用 Siri 进行语音控制了！ 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-11-03T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"树莓派3B+ 智能家居（HomeKit） 当今科技发展日新月异，越来越多的新兴技术步入人们生活，智能家居同样也不例外，然后人们面对新科技却望而却步，因为整套设备的价格是非常昂贵的，而且现在还没有一个厂商能提供一套完整且稳定的系统，导致现在还不能快速普及。如果你想尝尝鲜，那么，一个树莓派就能为你创建一个这样的基础环境。 1.安装脚本 安装过程比较累赘，这里就不做过多的解释了。 安装所需的库 ：Node 和 HAP-NodeJS（Node版本为8.2.1，HAP-NodeJS更新为Nov 6, 2017） 打包链接：http://download.csdn.net/download/kxwinxp/10124545 完整实现脚本如下： #!/bin/bash PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin export PATH echo &quot; +---------------------------------------------------------------------- | HAP-NodeJS FOR Debian raspberry +---------------------------------------------------------------------- | Copyright © 2017 kioye All rights reserved. +---------------------------------------------------------------------- &quot; #make sure your confirm. read -p &quot;Do you want to install HAP-NodeJS to the $setup_path directory now?(y/n): &quot; go; if [ &quot;$go&quot; == &#39;n&#39; ]||[ &quot;$go&quot; == &#39;N&#39; ];then exit; fi # get into directory of application cd ~ mkdir application cd application sudo apt-get install -y git avahi-daemon avahi-discover libnss-mdns libavahi-compat-libdnssd-dev build-essential # apt-get update --fix-missing -y sudo service avahi-daemon start wget -O node.tar.gz https://nodejs.org/dist/v8.2.1/node-v8.2.1-linux-armv7l.tar.xz tar -zxvf node.tar.gz mv node-*l usr sudo cp -rf usr / # install node base cross-platform sudo npm install -g -y node-gyp # install C++ lib sudo apt-get install -y libavahi-compat-libdnssd-dev # download HAP-NodeJS git clone https://github.com/KhaosT/HAP-NodeJS.git sudo chmod -R 777 /root ./HAP-NodeJS # get into HAP-NodeJS directory cd HAP-NodeJS # install some access for HAP-NodeJS sudo npm install -y node-persist debug mdns fast-srp-hap ed25519 buffer-shims curve25519-n2 ip python-shell cd .. echo &quot; +---------------------------------------------------------------------- | HAP-NodeJS Installed finish!! +---------------------------------------------------------------------- | start in Bridged mode: | sudo node HAP-NodeJS/BridgedCore.js +---------------------------------------------------------------------- | run as an independent HomeKit device: | sudo node HAP-NodeJS/Core.js +---------------------------------------------------------------------- &quot; exit 0 2.添加到自启动 sudo vim /etc/rc.local // 在 exit 0 前添加如下： # HAP-NodeJS 开机自启脚本（nohup为后台执行,run.log为运行记录。） sudo nohup node /home/pi/application/HAP-NodeJS/Core.js &gt;/home/pi/application/HAP-NodeJS/run.log 2&gt;&amp;1 &amp; # python GPIO口初始化！ python /home/pi/application/HAP-NodeJS/python/init.py GPIO初始化口，我接下来要用的是 11、13和15口。 脚本如下： vim ~/application/HAP-NodeJS/python/init.py // -------------请完整复制粘贴如下内容！！------------------ #!/usr/bin/env python import RPi.GPIO as GPIO import sys def setup(p): GPIO.setmode(GPIO.BOARD) GPIO.setup(p, GPIO.OUT) GPIO.setwarnings(False) # 初始化 11、13和15口。 arr={11,13,15} for gp in arr: setup(gp); sys.exit(0) 3.HAP-NodeJS介绍 GitHub：https://github.com/KhaosT/HAP-NodeJS HAP Nodejs是一个通过Nodejs搭建的HomeKit服务器。因此，它能直接和苹果 家庭（home）应用相连。苹果设备又支持Siri，故可以直接通过Siri控制HomeKit设备。 它有两种启动模式： 桥接模式启动HAP服务器： sudo node HAP-NodeJS/BridgedCore.js 独立模式（各配件作为一个的HomeKit设备启动）： sudo node HAP-NodeJS/Core.js 可自己定义配件： 格式为：accessories/**_accessory.js文件 **为简短的描述，所有此类定义的附件都会在服务器上加载。（非此类将不会加载！） 4.模拟配件 4.1 模拟一个两级亮度的灯 该配件是通过python-shell来控制GPIO，故需安装python的gpio包。 sudo apt-get install -y python-rpi.gpio 一个控制灯的附件代码： 功能：控制 GPIO 13 和 15 口，分别控制灯开关和亮度（两级），默认高电平为开启。 可以直接在var powergp=&#39;13&#39;;和var brightnessgp=&#39;15&#39;;修改GPIO口。 // 创建MyTableLight_accessory.js sudo vim ~/application/HAP-NodeJS/accessories/MyTableLight_accessory.js // -------------请完整复制粘贴如下内容！！------------------ var Accessory = require(&#39;../&#39;).Accessory; var Service = require(&#39;../&#39;).Service; var Characteristic = require(&#39;../&#39;).Characteristic; var uuid = require(&#39;../&#39;).uuid; var PythonShell = require(&#39;python-shell&#39;); var powergp=&#39;13&#39;; var brightnessgp=&#39;15&#39;; var LightController = { name: &quot;My Table Light&quot;, //name of accessory pincode: &quot;031-45-154&quot;, username: &quot;FA:3C:ED:5A:1A:1F&quot;, // MAC like address used by HomeKit to differentiate accessories. manufacturer: &quot;HAP-NodeJS&quot;, //manufacturer (optional) model: &quot;v1.0&quot;, //model (optional) serialNumber: &quot;A12S345KGB&quot;, //serial number (optional) power: false, //curent power status brightness: 100, //current brightness hue: 0, //current hue saturation: 0, //current saturation outputLogs: true, //output logs setPower: function(status) { //set power of accessory if(this.outputLogs) { console.log(&quot;Turning the &#39;%s&#39; %s&quot;, this.name, status ? &quot;on&quot; : &quot;off&quot;); } PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[powergp+&#39;:&#39;+(status?1:0)]}, function (err,results) { if (err) console.log(err); }); this.power = status; }, getPower: function() { //get power of accessory PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[powergp+&#39;:g&#39;]}, function(err,results){ console.log(&#39;results: %j&#39;, results); var resultMap=eval(&#39;(&#39;+results.pop()+&#39;)&#39;); this.power=(resultMap[powergp]==1)?true:false; }); if(this.outputLogs) console.log(&quot;&#39;%s&#39; is %s.&quot;, this.name, this.power ? &quot;on&quot; : &quot;off&quot;); return this.power; }, setBrightness: function(brightness) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; brightness to %s&quot;, this.name, brightness); PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[brightnessgp+&#39;:&#39;+((brightness &lt;= 50)?1:0)]}, function (err,results) { if (err) console.log(err); }); this.brightness = brightness; }, getBrightness: function() { //get brightness PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[brightnessgp+&#39;:g&#39;]}, function(err,results){ console.log(&#39;results: %j&#39;, results); var resultMap=eval(&#39;(&#39;+results.pop()+&#39;)&#39;); this.brightness=(resultMap[brightnessgp]==1)?50:100; }); if(this.outputLogs) console.log(&quot;&#39;%s&#39; brightness is %s&quot;, this.name, this.brightness); return this.brightness; }, setSaturation: function(saturation) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; saturation to %s&quot;, this.name, saturation); this.saturation = saturation; }, getSaturation: function() { //get brightness if(this.outputLogs) console.log(&quot;&#39;%s&#39; saturation is %s&quot;, this.name, this.saturation); return this.saturation; }, setHue: function(hue) { //set brightness if(this.outputLogs) console.log(&quot;Setting &#39;%s&#39; hue to %s&quot;, this.name, hue); this.hue = hue; }, getHue: function() { //get hue if(this.outputLogs) console.log(&quot;&#39;%s&#39; hue is %s&quot;, this.name, this.hue); return this.hue; }, identify: function() { //identify the accessory if(this.outputLogs) console.log(&quot;Identify the &#39;%s&#39;&quot;, this.name); } } // Generate a consistent UUID for our light Accessory that will remain the same even when // restarting our server. We use the `uuid.generate` helper function to create a deterministic // UUID based on an arbitrary &quot;namespace&quot; and the word &quot;light&quot;. var lightUUID = uuid.generate(&#39;hap-nodejs:accessories:light&#39; + LightController.name); // This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our light. var lightAccessory = exports.accessory = new Accessory(LightController.name, lightUUID); // Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js) lightAccessory.username = LightController.username; lightAccessory.pincode = LightController.pincode; // set some basic properties (these values are arbitrary and setting them is optional) lightAccessory .getService(Service.AccessoryInformation) .setCharacteristic(Characteristic.Manufacturer, LightController.manufacturer) .setCharacteristic(Characteristic.Model, LightController.model) .setCharacteristic(Characteristic.SerialNumber, LightController.serialNumber); // listen for the &quot;identify&quot; event for this Accessory lightAccessory.on(&#39;identify&#39;, function(paired, callback) { LightController.identify(); callback(); }); // Add the actual Lightbulb Service and listen for change events from iOS. // We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js` lightAccessory .addService(Service.Lightbulb, LightController.name) // services exposed to the user should have &quot;names&quot; like &quot;Light&quot; for this case .getCharacteristic(Characteristic.On) .on(&#39;set&#39;, function(value, callback) { LightController.setPower(value); // Our light is synchronous - this value has been successfully set // Invoke the callback when you finished processing the request // If it&#39;s going to take more than 1s to finish the request, try to invoke the callback // after getting the request instead of after finishing it. This avoids blocking other // requests from HomeKit. callback(); }) // We want to intercept requests for our current power state so we can query the hardware itself instead of // allowing HAP-NodeJS to return the cached Characteristic.value. .on(&#39;get&#39;, function(callback) { callback(null, LightController.getPower()); }); // To inform HomeKit about changes occurred outside of HomeKit (like user physically turn on the light) // Please use Characteristic.updateValue // // lightAccessory // .getService(Service.Lightbulb) // .getCharacteristic(Characteristic.On) // .updateValue(true); // also add an &quot;optional&quot; Characteristic for Brightness lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Brightness) .on(&#39;set&#39;, function(value, callback) { LightController.setBrightness(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getBrightness()); }); // also add an &quot;optional&quot; Characteristic for Saturation lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Saturation) .on(&#39;set&#39;, function(value, callback) { LightController.setSaturation(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getSaturation()); }); // also add an &quot;optional&quot; Characteristic for Hue lightAccessory .getService(Service.Lightbulb) .addCharacteristic(Characteristic.Hue) .on(&#39;set&#39;, function(value, callback) { LightController.setHue(value); callback(); }) .on(&#39;get&#39;, function(callback) { callback(null, LightController.getHue()); }); 准备一个python脚本控制GPIO口： sudo vim ~/application/HAP-NodeJS/python/gpio.py // -------------请完整复制粘贴如下内容！！------------------ #!/usr/bin/env python import RPi.GPIO as GPIO import sys def init(gp): GPIO.setmode(GPIO.BOARD) GPIO.setup(gp, GPIO.OUT) GPIO.setwarnings(False) # simple argument echo script ret={} for arg in sys.argv[1:]: #print arg args=arg.split(&#39;:&#39;) init(int(args[0])) if args[1]==&#39;g&#39;: ret[args[0]]=GPIO.input(int(args[0])) elif args[1]==&#39;0&#39;: GPIO.output(int(args[0]), GPIO.LOW) elif args[1]==&#39;1&#39;: GPIO.output(int(args[0]), GPIO.HIGH) #setup(int(v)) print ret sys.exit(0) 4.2 模拟一个开关插座 我这个插座是接的音响，所以叫“My sound”，不要见怪。 这里使用的是 GPIO 11 口，默认是高电平是开启。 代码如下： // 创建MySound_accessory.js sudo vim ~/application/HAP-NodeJS/accessories/MySound_accessory.js // -------------请完整复制粘贴如下内容！！------------------ var Accessory = require(&#39;../&#39;).Accessory; var Service = require(&#39;../&#39;).Service; var Characteristic = require(&#39;../&#39;).Characteristic; var uuid = require(&#39;../&#39;).uuid; var err = null; // in case there were any problems var PythonShell = require(&#39;python-shell&#39;); var soundgp=&#39;11&#39;; // here&#39;s a fake hardware device that we&#39;ll expose to HomeKit var FAKE_OUTLET = { setPowerOn: function(on) { console.log(&quot;Turning the MySound %s!...&quot;, on ? &quot;on&quot; : &quot;off&quot;); PythonShell.run(&#39;../../home/pi/application/HAP-NodeJS/python/gpio.py&#39;, {args:[soundgp+&#39;:&#39;+(on?1:0)]}, function (err,results) { if (err) console.log(err); }); FAKE_OUTLET.powerOn=on; }, identify: function() { console.log(&quot;Identify the MySound.&quot;); } } // Generate a consistent UUID for our MySound Accessory that will remain the same even when // restarting our server. We use the `uuid.generate` helper function to create a deterministic // UUID based on an arbitrary &quot;namespace&quot; and the accessory name. var outletUUID = uuid.generate(&#39;hap-nodejs:accessories:MySound&#39;); // This is the Accessory that we&#39;ll return to HAP-NodeJS that represents our fake light. var outlet = exports.accessory = new Accessory(&#39;MySound&#39;, outletUUID); // Add properties for publishing (in case we&#39;re using Core.js and not BridgedCore.js) outlet.username = &quot;1A:2B:3C:4D:5D:FG&quot;; outlet.pincode = &quot;031-45-154&quot;; // set some basic properties (these values are arbitrary and setting them is optional) outlet .getService(Service.AccessoryInformation) .setCharacteristic(Characteristic.Manufacturer, &quot;Oltica&quot;) .setCharacteristic(Characteristic.Model, &quot;Rev-1&quot;) .setCharacteristic(Characteristic.SerialNumber, &quot;A1S2NASF88EW&quot;); // listen for the &quot;identify&quot; event for this Accessory outlet.on(&#39;identify&#39;, function(paired, callback) { FAKE_OUTLET.identify(); callback(); // success }); // Add the actual MySound Service and listen for change events from iOS. // We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js` outlet .addService(Service.Outlet, &quot;My Sound&quot;) // services exposed to the user should have &quot;names&quot; like &quot;Fake Light&quot; for us .getCharacteristic(Characteristic.On) .on(&#39;set&#39;, function(value, callback) { FAKE_OUTLET.setPowerOn(value); callback(); // Our fake Outlet is synchronous - this value has been successfully set }); // We want to intercept requests for our current power state so we can query the hardware itself instead of // allowing HAP-NodeJS to return the cached Characteristic.value. outlet .getService(Service.Outlet) .getCharacteristic(Characteristic.On) .on(&#39;get&#39;, function(callback) { // this event is emitted when you ask Siri directly whether your light is on or not. you might query // the light hardware itself to find this out, then call the callback. But if you take longer than a // few seconds to respond, Siri will give up. var err = null; // in case there were any problems if (FAKE_OUTLET.powerOn) { console.log(&quot;Are we on? Yes.&quot;); callback(err, true); } else { console.log(&quot;Are we on? No.&quot;); callback(err, false); } }); 控制也是通过调用 gpio.py 的 python 脚本，和 4.1 里面的 python 脚本一样的。 好了，现在可以重启一下树莓派。 5.将HomeKit设备添加到家庭中 如图，选择将这些设备添加进去，输入认证代码 03145154（这个可以在accessary.js修改）。 然后就可以愉快使用 Siri 进行语音控制了！ 阅读更多","@type":"BlogPosting","url":"/2017/11/03/78d16dd6216c25635f11cfca21b7dd01.html","headline":"树莓派3B+ 智能家居（HomeKit）","dateModified":"2017-11-03T00:00:00+08:00","datePublished":"2017-11-03T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2017/11/03/78d16dd6216c25635f11cfca21b7dd01.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>树莓派3B+ 智能家居（HomeKit）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h2 id="树莓派3b-智能家居homekit">树莓派3B+ 智能家居（HomeKit）</h2> 
  <blockquote> 
   <p>当今科技发展日新月异，越来越多的新兴技术步入人们生活，智能家居同样也不例外，然后人们面对新科技却望而却步，因为整套设备的价格是非常昂贵的，而且现在还没有一个厂商能提供一套完整且稳定的系统，导致现在还不能快速普及。如果你想尝尝鲜，那么，一个树莓派就能为你创建一个这样的基础环境。</p> 
  </blockquote> 
  <h3 id="1安装脚本">1.安装脚本</h3> 
  <blockquote> 
   <p>安装过程比较累赘，这里就不做过多的解释了。 <br> 安装所需的库 ：Node 和 HAP-NodeJS（Node版本为8.2.1，HAP-NodeJS更新为Nov 6, 2017） <br> 打包链接：<a href="http://download.csdn.net/download/kxwinxp/10124545" rel="nofollow" target="_blank">http://download.csdn.net/download/kxwinxp/10124545</a></p> 
  </blockquote> 
  <h4 id="完整实现脚本如下">完整实现脚本如下：</h4> 
  <pre class="prettyprint"><code class=" hljs bash"><span class="hljs-shebang">#!/bin/bash</span>
PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
<span class="hljs-keyword">export</span> PATH

<span class="hljs-built_in">echo</span> <span class="hljs-string">" +---------------------------------------------------------------------- | HAP-NodeJS FOR Debian raspberry +---------------------------------------------------------------------- | Copyright © 2017 kioye All rights reserved. +---------------------------------------------------------------------- "</span>
<span class="hljs-comment">#make sure your confirm. </span>
<span class="hljs-built_in">read</span> -p <span class="hljs-string">"Do you want to install HAP-NodeJS to the <span class="hljs-variable">$setup_path</span> directory now?(y/n): "</span> go;

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$go</span>"</span> == <span class="hljs-string">'n'</span> ]||[ <span class="hljs-string">"<span class="hljs-variable">$go</span>"</span> == <span class="hljs-string">'N'</span> ];<span class="hljs-keyword">then</span>
    <span class="hljs-keyword">exit</span>;
<span class="hljs-keyword">fi</span>
<span class="hljs-comment"># get into directory of application</span>
<span class="hljs-built_in">cd</span> ~
mkdir application
<span class="hljs-built_in">cd</span> application

<span class="hljs-built_in">sudo</span> apt-get install -y git avahi-daemon avahi-discover libnss-mdns libavahi-compat-libdnssd-dev build-essential
<span class="hljs-comment"># apt-get update --fix-missing -y</span>
<span class="hljs-built_in">sudo</span> service avahi-daemon start
wget -O node.tar.gz https://nodejs.org/dist/v8.<span class="hljs-number">2.1</span>/node-v8.<span class="hljs-number">2.1</span>-linux-armv7l.tar.xz
tar -zxvf node.tar.gz
mv node-*l usr
<span class="hljs-built_in">sudo</span> cp -rf usr /
<span class="hljs-comment"># install node base cross-platform</span>
<span class="hljs-built_in">sudo</span> npm install -g -y node-gyp
<span class="hljs-comment"># install C++ lib</span>
<span class="hljs-built_in">sudo</span> apt-get install -y libavahi-compat-libdnssd-dev
<span class="hljs-comment"># download HAP-NodeJS</span>
git clone https://github.com/KhaosT/HAP-NodeJS.git
<span class="hljs-built_in">sudo</span> chmod -R <span class="hljs-number">777</span> /root ./HAP-NodeJS
<span class="hljs-comment"># get into HAP-NodeJS directory</span>
<span class="hljs-built_in">cd</span> HAP-NodeJS
<span class="hljs-comment"># install some access for HAP-NodeJS</span>
<span class="hljs-built_in">sudo</span> npm install -y node-persist debug mdns fast-srp-hap ed25519 buffer-shims curve25519-n2 ip python-shell
<span class="hljs-built_in">cd</span> ..
<span class="hljs-built_in">echo</span> <span class="hljs-string">" +---------------------------------------------------------------------- | HAP-NodeJS Installed finish!! +---------------------------------------------------------------------- | start in Bridged mode: | sudo node HAP-NodeJS/BridgedCore.js +---------------------------------------------------------------------- | run as an independent HomeKit device: | sudo node HAP-NodeJS/Core.js +---------------------------------------------------------------------- "</span>
<span class="hljs-keyword">exit</span> <span class="hljs-number">0</span></code></pre> 
  <h3 id="2添加到自启动">2.添加到自启动</h3> 
  <pre class="prettyprint"><code class=" hljs livecodeserver">sudo vim /etc/rc.<span class="hljs-built_in">local</span><span class="hljs-comment"> // 在 exit 0 前添加如下：</span>
<span class="hljs-comment"># HAP-NodeJS 开机自启脚本（nohup为后台执行,run.log为运行记录。）</span>
sudo nohup node /home/<span class="hljs-constant">pi</span>/application/HAP-NodeJS/Core.js &gt;/home/<span class="hljs-constant">pi</span>/application/HAP-NodeJS/run.<span class="hljs-built_in">log</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span> &amp;
<span class="hljs-comment"># python GPIO口初始化！</span>
python /home/<span class="hljs-constant">pi</span>/application/HAP-NodeJS/python/init.py</code></pre> 
  <blockquote> 
   <p>GPIO初始化口，我接下来要用的是 11、13和15口。 <br> 脚本如下：</p> 
  </blockquote> 
  <pre class="prettyprint"><code class=" hljs python">vim ~/application/HAP-NodeJS/python/init.py
// -------------请完整复制粘贴如下内容！！------------------
<span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> RPi.GPIO <span class="hljs-keyword">as</span> GPIO
<span class="hljs-keyword">import</span> sys

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">setup</span><span class="hljs-params">(p)</span>:</span>
    GPIO.setmode(GPIO.BOARD)
    GPIO.setup(p, GPIO.OUT)


GPIO.setwarnings(<span class="hljs-keyword">False</span>)
<span class="hljs-comment"># 初始化 11、13和15口。</span>
arr={<span class="hljs-number">11</span>,<span class="hljs-number">13</span>,<span class="hljs-number">15</span>}
<span class="hljs-keyword">for</span> gp <span class="hljs-keyword">in</span> arr:
    setup(gp);


sys.exit(<span class="hljs-number">0</span>)</code></pre> 
  <h3 id="3hap-nodejs介绍">3.HAP-NodeJS介绍</h3> 
  <blockquote> 
   <p>GitHub：<a href="https://github.com/KhaosT/HAP-NodeJS" rel="nofollow" target="_blank">https://github.com/KhaosT/HAP-NodeJS</a></p> 
  </blockquote> 
  <hr> 
  <blockquote> 
   <p>HAP Nodejs是一个通过Nodejs搭建的HomeKit服务器。因此，它能直接和苹果 家庭（home）应用相连。苹果设备又支持Siri，故可以直接通过Siri控制HomeKit设备。</p> 
  </blockquote> 
  <h4 id="它有两种启动模式">它有两种启动模式：</h4> 
  <ul> 
   <li>桥接模式启动HAP服务器： <br> sudo node HAP-NodeJS/BridgedCore.js</li> 
   <li>独立模式（各配件作为一个的HomeKit设备启动）： <br> sudo node HAP-NodeJS/Core.js</li> 
  </ul> 
  <h4 id="可自己定义配件">可自己定义配件：</h4> 
  <ul> 
   <li>格式为：accessories/**_accessory.js文件 <br> **为简短的描述，所有此类定义的附件都会在服务器上加载。（非此类将不会加载！）</li> 
  </ul> 
  <h3 id="4模拟配件">4.模拟配件</h3> 
  <hr> 
  <h4 id="41-模拟一个两级亮度的灯">4.1 模拟一个两级亮度的灯</h4> 
  <blockquote> 
   <p>该配件是通过python-shell来控制GPIO，故需安装python的gpio包。</p> 
  </blockquote> 
  <pre class="prettyprint"><code class=" hljs lasso">sudo apt<span class="hljs-attribute">-get</span> install <span class="hljs-attribute">-y</span> python<span class="hljs-attribute">-rpi</span><span class="hljs-built_in">.</span>gpio
</code></pre> 
  <h4 id="一个控制灯的附件代码">一个控制灯的附件代码：</h4> 
  <blockquote> 
   <p>功能：控制 GPIO 13 和 15 口，分别控制灯开关和亮度（两级），默认高电平为开启。 <br> 可以直接在<code>var powergp='13';</code>和<code>var brightnessgp='15';</code>修改GPIO口。</p> 
  </blockquote> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171123232116894?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva3h3aW54cA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="GPIO" title=""></p> 
  <pre class="prettyprint"><code class=" hljs javascript"><span class="hljs-comment">// 创建MyTableLight_accessory.js</span>
sudo vim ~<span class="hljs-regexp">/application/</span>HAP-NodeJS/accessories/MyTableLight_accessory.js
<span class="hljs-comment">// -------------请完整复制粘贴如下内容！！------------------</span>
<span class="hljs-keyword">var</span> Accessory = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).Accessory;
<span class="hljs-keyword">var</span> Service = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).Service;
<span class="hljs-keyword">var</span> Characteristic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).Characteristic;
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).uuid;
<span class="hljs-keyword">var</span> PythonShell = <span class="hljs-built_in">require</span>(<span class="hljs-string">'python-shell'</span>);
<span class="hljs-keyword">var</span> powergp=<span class="hljs-string">'13'</span>;
<span class="hljs-keyword">var</span> brightnessgp=<span class="hljs-string">'15'</span>;

<span class="hljs-keyword">var</span> LightController = {
  name: <span class="hljs-string">"My Table Light"</span>, <span class="hljs-comment">//name of accessory</span>
  pincode: <span class="hljs-string">"031-45-154"</span>,
  username: <span class="hljs-string">"FA:3C:ED:5A:1A:1F"</span>, <span class="hljs-comment">// MAC like address used by HomeKit to differentiate accessories. </span>
  manufacturer: <span class="hljs-string">"HAP-NodeJS"</span>, <span class="hljs-comment">//manufacturer (optional)</span>
  model: <span class="hljs-string">"v1.0"</span>, <span class="hljs-comment">//model (optional)</span>
  serialNumber: <span class="hljs-string">"A12S345KGB"</span>, <span class="hljs-comment">//serial number (optional)</span>

  power: <span class="hljs-literal">false</span>, <span class="hljs-comment">//curent power status</span>
  brightness: <span class="hljs-number">100</span>, <span class="hljs-comment">//current brightness</span>
  hue: <span class="hljs-number">0</span>, <span class="hljs-comment">//current hue</span>
  saturation: <span class="hljs-number">0</span>, <span class="hljs-comment">//current saturation</span>

  outputLogs: <span class="hljs-literal">true</span>, <span class="hljs-comment">//output logs</span>

  setPower: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(status)</span> {</span> <span class="hljs-comment">//set power of accessory</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) {
        console.log(<span class="hljs-string">"Turning the '%s' %s"</span>, <span class="hljs-keyword">this</span>.name, status ? <span class="hljs-string">"on"</span> : <span class="hljs-string">"off"</span>);
    }
    PythonShell.run(<span class="hljs-string">'../../home/pi/application/HAP-NodeJS/python/gpio.py'</span>, {args:[powergp+<span class="hljs-string">':'</span>+(status?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)]}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err,results)</span> {</span>
      <span class="hljs-keyword">if</span> (err) console.log(err);
    });
    <span class="hljs-keyword">this</span>.power = status;
  },

  getPower: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-comment">//get power of accessory</span>
    PythonShell.run(<span class="hljs-string">'../../home/pi/application/HAP-NodeJS/python/gpio.py'</span>, {args:[powergp+<span class="hljs-string">':g'</span>]}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,results)</span>{</span>
        console.log(<span class="hljs-string">'results: %j'</span>, results);
        <span class="hljs-keyword">var</span> resultMap=<span class="hljs-built_in">eval</span>(<span class="hljs-string">'('</span>+results.pop()+<span class="hljs-string">')'</span>);
        <span class="hljs-keyword">this</span>.power=(resultMap[powergp]==<span class="hljs-number">1</span>)?<span class="hljs-literal">true</span>:<span class="hljs-literal">false</span>;
    });
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"'%s' is %s."</span>, <span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.power ? <span class="hljs-string">"on"</span> : <span class="hljs-string">"off"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.power;
  },

  setBrightness: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(brightness)</span> {</span> <span class="hljs-comment">//set brightness</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"Setting '%s' brightness to %s"</span>, <span class="hljs-keyword">this</span>.name, brightness);
    PythonShell.run(<span class="hljs-string">'../../home/pi/application/HAP-NodeJS/python/gpio.py'</span>, {args:[brightnessgp+<span class="hljs-string">':'</span>+((brightness &lt;= <span class="hljs-number">50</span>)?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)]}, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err,results)</span> {</span>
      <span class="hljs-keyword">if</span> (err) console.log(err);
    });
    <span class="hljs-keyword">this</span>.brightness = brightness;
  },

  getBrightness: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-comment">//get brightness</span>
    PythonShell.run(<span class="hljs-string">'../../home/pi/application/HAP-NodeJS/python/gpio.py'</span>, {args:[brightnessgp+<span class="hljs-string">':g'</span>]}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err,results)</span>{</span>
        console.log(<span class="hljs-string">'results: %j'</span>, results);
        <span class="hljs-keyword">var</span> resultMap=<span class="hljs-built_in">eval</span>(<span class="hljs-string">'('</span>+results.pop()+<span class="hljs-string">')'</span>);
        <span class="hljs-keyword">this</span>.brightness=(resultMap[brightnessgp]==<span class="hljs-number">1</span>)?<span class="hljs-number">50</span>:<span class="hljs-number">100</span>;
    });
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"'%s' brightness is %s"</span>, <span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.brightness);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.brightness;
  },

  setSaturation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(saturation)</span> {</span> <span class="hljs-comment">//set brightness</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"Setting '%s' saturation to %s"</span>, <span class="hljs-keyword">this</span>.name, saturation);
    <span class="hljs-keyword">this</span>.saturation = saturation;
  },

  getSaturation: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-comment">//get brightness</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"'%s' saturation is %s"</span>, <span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.saturation);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.saturation;
  },

  setHue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(hue)</span> {</span> <span class="hljs-comment">//set brightness</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"Setting '%s' hue to %s"</span>, <span class="hljs-keyword">this</span>.name, hue);
    <span class="hljs-keyword">this</span>.hue = hue;
  },

  getHue: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-comment">//get hue</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"'%s' hue is %s"</span>, <span class="hljs-keyword">this</span>.name, <span class="hljs-keyword">this</span>.hue);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.hue;
  },

  identify: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-comment">//identify the accessory</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.outputLogs) console.log(<span class="hljs-string">"Identify the '%s'"</span>, <span class="hljs-keyword">this</span>.name);
  }
}

<span class="hljs-comment">// Generate a consistent UUID for our light Accessory that will remain the same even when</span>
<span class="hljs-comment">// restarting our server. We use the `uuid.generate` helper function to create a deterministic</span>
<span class="hljs-comment">// UUID based on an arbitrary "namespace" and the word "light".</span>
<span class="hljs-keyword">var</span> lightUUID = uuid.generate(<span class="hljs-string">'hap-nodejs:accessories:light'</span> + LightController.name);

<span class="hljs-comment">// This is the Accessory that we'll return to HAP-NodeJS that represents our light.</span>
<span class="hljs-keyword">var</span> lightAccessory = exports.accessory = <span class="hljs-keyword">new</span> Accessory(LightController.name, lightUUID);

<span class="hljs-comment">// Add properties for publishing (in case we're using Core.js and not BridgedCore.js)</span>
lightAccessory.username = LightController.username;
lightAccessory.pincode = LightController.pincode;

<span class="hljs-comment">// set some basic properties (these values are arbitrary and setting them is optional)</span>
lightAccessory
  .getService(Service.AccessoryInformation)
    .setCharacteristic(Characteristic.Manufacturer, LightController.manufacturer)
    .setCharacteristic(Characteristic.Model, LightController.model)
    .setCharacteristic(Characteristic.SerialNumber, LightController.serialNumber);

<span class="hljs-comment">// listen for the "identify" event for this Accessory</span>
lightAccessory.on(<span class="hljs-string">'identify'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(paired, callback)</span> {</span>
  LightController.identify();
  callback();
});

<span class="hljs-comment">// Add the actual Lightbulb Service and listen for change events from iOS.</span>
<span class="hljs-comment">// We can see the complete list of Services and Characteristics in `lib/gen/HomeKitTypes.js`</span>
lightAccessory
  .addService(Service.Lightbulb, LightController.name) <span class="hljs-comment">// services exposed to the user should have "names" like "Light" for this case</span>
  .getCharacteristic(Characteristic.On)
  .on(<span class="hljs-string">'set'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, callback)</span> {</span>
    LightController.setPower(value);

    <span class="hljs-comment">// Our light is synchronous - this value has been successfully set</span>
    <span class="hljs-comment">// Invoke the callback when you finished processing the request</span>
    <span class="hljs-comment">// If it's going to take more than 1s to finish the request, try to invoke the callback</span>
    <span class="hljs-comment">// after getting the request instead of after finishing it. This avoids blocking other</span>
    <span class="hljs-comment">// requests from HomeKit.</span>
    callback();
  })
  <span class="hljs-comment">// We want to intercept requests for our current power state so we can query the hardware itself instead of</span>
  <span class="hljs-comment">// allowing HAP-NodeJS to return the cached Characteristic.value.</span>
  .on(<span class="hljs-string">'get'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    callback(<span class="hljs-literal">null</span>, LightController.getPower());
  });

<span class="hljs-comment">// To inform HomeKit about changes occurred outside of HomeKit (like user physically turn on the light)</span>
<span class="hljs-comment">// Please use Characteristic.updateValue</span>
<span class="hljs-comment">// </span>
<span class="hljs-comment">// lightAccessory</span>
<span class="hljs-comment">// .getService(Service.Lightbulb)</span>
<span class="hljs-comment">// .getCharacteristic(Characteristic.On)</span>
<span class="hljs-comment">// .updateValue(true);</span>

<span class="hljs-comment">// also add an "optional" Characteristic for Brightness</span>
lightAccessory
  .getService(Service.Lightbulb)
  .addCharacteristic(Characteristic.Brightness)
  .on(<span class="hljs-string">'set'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, callback)</span> {</span>
    LightController.setBrightness(value);
    callback();
  })
  .on(<span class="hljs-string">'get'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    callback(<span class="hljs-literal">null</span>, LightController.getBrightness());
  });

<span class="hljs-comment">// also add an "optional" Characteristic for Saturation</span>
lightAccessory
  .getService(Service.Lightbulb)
  .addCharacteristic(Characteristic.Saturation)
  .on(<span class="hljs-string">'set'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, callback)</span> {</span>
    LightController.setSaturation(value);
    callback();
  })
  .on(<span class="hljs-string">'get'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    callback(<span class="hljs-literal">null</span>, LightController.getSaturation());
  });

<span class="hljs-comment">// also add an "optional" Characteristic for Hue</span>
lightAccessory
  .getService(Service.Lightbulb)
  .addCharacteristic(Characteristic.Hue)
  .on(<span class="hljs-string">'set'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value, callback)</span> {</span>
    LightController.setHue(value);
    callback();
  })
  .on(<span class="hljs-string">'get'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    callback(<span class="hljs-literal">null</span>, LightController.getHue());
  });</code></pre> 
  <h4 id="准备一个python脚本控制gpio口">准备一个python脚本控制GPIO口：</h4> 
  <pre class="prettyprint"><code class=" hljs python">sudo vim ~/application/HAP-NodeJS/python/gpio.py
// -------------请完整复制粘贴如下内容！！------------------
<span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> RPi.GPIO <span class="hljs-keyword">as</span> GPIO
<span class="hljs-keyword">import</span> sys

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init</span><span class="hljs-params">(gp)</span>:</span>
    GPIO.setmode(GPIO.BOARD)
    GPIO.setup(gp, GPIO.OUT)

GPIO.setwarnings(<span class="hljs-keyword">False</span>)
<span class="hljs-comment"># simple argument echo script</span>
ret={}
<span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> sys.argv[<span class="hljs-number">1</span>:]:
    <span class="hljs-comment">#print arg</span>
    args=arg.split(<span class="hljs-string">':'</span>)
    init(int(args[<span class="hljs-number">0</span>]))
    <span class="hljs-keyword">if</span> args[<span class="hljs-number">1</span>]==<span class="hljs-string">'g'</span>:
        ret[args[<span class="hljs-number">0</span>]]=GPIO.input(int(args[<span class="hljs-number">0</span>]))
    <span class="hljs-keyword">elif</span> args[<span class="hljs-number">1</span>]==<span class="hljs-string">'0'</span>:
        GPIO.output(int(args[<span class="hljs-number">0</span>]), GPIO.LOW)
    <span class="hljs-keyword">elif</span> args[<span class="hljs-number">1</span>]==<span class="hljs-string">'1'</span>:
        GPIO.output(int(args[<span class="hljs-number">0</span>]), GPIO.HIGH)
    <span class="hljs-comment">#setup(int(v))</span>

<span class="hljs-keyword">print</span> ret
sys.exit(<span class="hljs-number">0</span>)
</code></pre> 
  <h4 id="42-模拟一个开关插座">4.2 模拟一个开关插座</h4> 
  <blockquote> 
   <p>我这个插座是接的音响，所以叫“My sound”，不要见怪。 <br> 这里使用的是 GPIO 11 口，默认是高电平是开启。 <br> 代码如下：</p> 
  </blockquote> 
  <pre class="prettyprint"><code class=" hljs coffeescript"><span class="hljs-regexp">//</span> 创建MySound_accessory.js
sudo vim ~/application/HAP-NodeJS/accessories/MySound_accessory.js
<span class="hljs-regexp">//</span> -------------请完整复制粘贴如下内容！！------------------
<span class="hljs-reserved">var</span> Accessory = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).Accessory;
<span class="hljs-reserved">var</span> Service = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).Service;
<span class="hljs-reserved">var</span> Characteristic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).Characteristic;
<span class="hljs-reserved">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../'</span>).uuid;
<span class="hljs-reserved">var</span> err = <span class="hljs-literal">null</span>; <span class="hljs-regexp">//</span> <span class="hljs-keyword">in</span> <span class="hljs-reserved">case</span> there were any problems
<span class="hljs-reserved">var</span> PythonShell = <span class="hljs-built_in">require</span>(<span class="hljs-string">'python-shell'</span>);
<span class="hljs-reserved">var</span> soundgp=<span class="hljs-string">'11'</span>;

<span class="hljs-regexp">//</span> here<span class="hljs-string">'s a fake hardware device that we'</span>ll expose to HomeKit
<span class="hljs-reserved">var</span> FAKE_OUTLET = {
    <span class="hljs-attribute">setPowerOn</span>: <span class="hljs-reserved">function</span>(<span class="hljs-literal">on</span>) {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Turning the MySound %s!..."</span>, <span class="hljs-literal">on</span> ? <span class="hljs-string">"on"</span> : <span class="hljs-string">"off"</span>);
    PythonShell.run(<span class="hljs-string">'../../home/pi/application/HAP-NodeJS/python/gpio.py'</span>, {<span class="hljs-attribute">args</span>:[soundgp+<span class="hljs-string">':'</span>+(<span class="hljs-literal">on</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>)]}, <span class="hljs-reserved">function</span> (err,results) {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.log(err);
    });
    FAKE_OUTLET.powerOn=<span class="hljs-literal">on</span>;
  },
    <span class="hljs-attribute">identify</span>: <span class="hljs-reserved">function</span>() {
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Identify the MySound."</span>);
    }
}

<span class="hljs-regexp">//</span> Generate a consistent UUID <span class="hljs-keyword">for</span> our MySound Accessory that will remain the same even <span class="hljs-keyword">when</span>
<span class="hljs-regexp">//</span> restarting our server. We use the `<span class="javascript">uuid.generate</span>` helper <span class="hljs-reserved">function</span> to create a deterministic
<span class="hljs-regexp">//</span> UUID based <span class="hljs-literal">on</span> an arbitrary <span class="hljs-string">"namespace"</span> <span class="hljs-keyword">and</span> the accessory name.
<span class="hljs-reserved">var</span> outletUUID = uuid.generate(<span class="hljs-string">'hap-nodejs:accessories:MySound'</span>);

<span class="hljs-regexp">//</span> This <span class="hljs-keyword">is</span> the Accessory that we<span class="hljs-string">'ll return to HAP-NodeJS that represents our fake light. var outlet = exports.accessory = new Accessory('</span>MySound<span class="hljs-string">', outletUUID); // Add properties for publishing (in case we'</span>re using Core.js <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> BridgedCore.js)
outlet.username = <span class="hljs-string">"1A:2B:3C:4D:5D:FG"</span>;
outlet.pincode = <span class="hljs-string">"031-45-154"</span>;

<span class="hljs-regexp">//</span> set some basic properties (these values are arbitrary <span class="hljs-keyword">and</span> setting them <span class="hljs-keyword">is</span> optional)
outlet
  .getService(Service.AccessoryInformation)
  .setCharacteristic(Characteristic.Manufacturer, <span class="hljs-string">"Oltica"</span>)
  .setCharacteristic(Characteristic.Model, <span class="hljs-string">"Rev-1"</span>)
  .setCharacteristic(Characteristic.SerialNumber, <span class="hljs-string">"A1S2NASF88EW"</span>);

<span class="hljs-regexp">//</span> listen <span class="hljs-keyword">for</span> the <span class="hljs-string">"identify"</span> event <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> Accessory
outlet.<span class="hljs-literal">on</span>(<span class="hljs-string">'identify'</span>, <span class="hljs-reserved">function</span>(paired, callback) {
  FAKE_OUTLET.identify();
  callback(); <span class="hljs-regexp">//</span> success
});

<span class="hljs-regexp">//</span> Add the actual MySound Service <span class="hljs-keyword">and</span> listen <span class="hljs-keyword">for</span> change events from iOS.
<span class="hljs-regexp">//</span> We can see the complete list <span class="hljs-keyword">of</span> Services <span class="hljs-keyword">and</span> Characteristics <span class="hljs-keyword">in</span> `<span class="javascript">lib/gen/HomeKitTypes.js</span>`
outlet
  .addService(Service.Outlet, <span class="hljs-string">"My Sound"</span>) <span class="hljs-regexp">//</span> services exposed to the user should have <span class="hljs-string">"names"</span> like <span class="hljs-string">"Fake Light"</span> <span class="hljs-keyword">for</span> us
  .getCharacteristic(Characteristic.On)
  .<span class="hljs-literal">on</span>(<span class="hljs-string">'set'</span>, <span class="hljs-reserved">function</span>(value, callback) {
    FAKE_OUTLET.setPowerOn(value);
    callback(); <span class="hljs-regexp">//</span> Our fake Outlet <span class="hljs-keyword">is</span> synchronous - <span class="hljs-keyword">this</span> value has been successfully set
  });

<span class="hljs-regexp">//</span> We want to intercept requests <span class="hljs-keyword">for</span> our current power state so we can query the hardware itself instead <span class="hljs-keyword">of</span>
<span class="hljs-regexp">//</span> allowing HAP-NodeJS to <span class="hljs-keyword">return</span> the cached Characteristic.value.
outlet
  .getService(Service.Outlet)
  .getCharacteristic(Characteristic.On)
  .<span class="hljs-literal">on</span>(<span class="hljs-string">'get'</span>, <span class="hljs-reserved">function</span>(callback) {

    <span class="hljs-regexp">//</span> <span class="hljs-keyword">this</span> event <span class="hljs-keyword">is</span> emitted <span class="hljs-keyword">when</span> you ask Siri directly whether your light <span class="hljs-keyword">is</span> <span class="hljs-literal">on</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span>. you might query
    <span class="hljs-regexp">//</span> the light hardware itself to find <span class="hljs-keyword">this</span> out, <span class="hljs-keyword">then</span> call the callback. But <span class="hljs-keyword">if</span> you take longer than a
    <span class="hljs-regexp">//</span> few seconds to respond, Siri will give up.

    <span class="hljs-reserved">var</span> err = <span class="hljs-literal">null</span>; <span class="hljs-regexp">//</span> <span class="hljs-keyword">in</span> <span class="hljs-reserved">case</span> there were any problems

    <span class="hljs-keyword">if</span> (FAKE_OUTLET.powerOn) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Are we on? Yes."</span>);
      callback(err, <span class="hljs-literal">true</span>);
    }
    <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Are we on? No."</span>);
      callback(err, <span class="hljs-literal">false</span>);
    }
  }); </code></pre> 
  <blockquote> 
   <p>控制也是通过调用 gpio.py 的 python 脚本，和 4.1 里面的 python 脚本一样的。</p> 
   <p>好了，现在可以重启一下树莓派。</p> 
  </blockquote> 
  <h3 id="5将homekit设备添加到家庭中">5.将HomeKit设备添加到家庭中</h3> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171117210948168?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva3h3aW54cA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="添加设备" title=""></p> 
  <blockquote> 
   <p>如图，选择将这些设备添加进去，输入认证代码 <code>03145154</code>（这个可以在accessary.js修改）。</p> 
  </blockquote> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171123233146977?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQva3h3aW54cA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <blockquote> 
   <p>然后就可以愉快使用 Siri 进行语音控制了！</p> 
  </blockquote> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/kxwinxp/article/details/78434062,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/kxwinxp/article/details/78434062,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
