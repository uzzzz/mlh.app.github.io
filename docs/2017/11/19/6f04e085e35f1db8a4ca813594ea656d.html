<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>JavaSSM接入支付宝当面付（扫码支付） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="JavaSSM接入支付宝当面付（扫码支付）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="最近做的项目的支付模块需要对接支付宝的当面付，刚做完，想把整个过程以及需要注意的一些点整理罗列下，于是便想着写一写。 接入的大体思路及过程 查看支付宝当面付官方文档（https://docs.open.alipay.com/194） 通过支付宝提供的沙箱环境调试测试（支付宝沙箱环境） 调试通官方提供的Demo（https://docs.open.alipay.com/194/105201/） 根据Demo分析整个处理流程，以及需要重点注意的点 根据官方文档和Demo将当面付集成到自己的项目中 一、支付宝当面付官方文档 题外话：阿里的文档是真的很详细，因此避免了很多坑，所以有不懂的一般翻翻文档就大概知道了。 好了，不说废话了，根据支付宝的官方文档我们首先要了解的是整个业务流程： 以及用户的使用流程： 以上两个都是官方文档提供的图，文档中都有说，我就不复述了。 实际上对接到项目中，属于我们项目本身的处理逻辑主要集中是下图红框内的流程： 以我的项目为例： 系统通过用户订单向支付宝后台发起下单请求–》支付宝后台收到请求并返回订单数据以及二维码–》系统后台接受并处理支付宝的返回数据–》向用户展示二维码–》用户通过支付宝进行扫码操作–》支付宝回调支付数据–》系统后台进行处理 emm，感觉我这个例子太乱的同学可以直接无视=。 = 整个支付宝当面付中需要重点注意的有两点： 1. 密钥的配置 关于支付宝密钥的解释和流程请参考（扫码支付接入指引 ）中的“配置应用 ” 支付宝的密钥有两种：“RSA2(SHA256)密钥”和“RSA(SHA1)密钥”，官方推荐的是“RSA2(SHA256)密钥”，而我使用的也是官方推荐的 下面我将叙述密钥的配置（RSA2(SHA256)密钥）过程： 以下操作均在沙箱环境操作，没有沙箱环境的请务必创建沙箱环境（支付宝沙箱环境） 因为需要生成RSA密钥，所以需要用支付宝提供一键生成工具生成一对RSA密钥（生成RSA密钥） 我的系统是windows的，所以用密钥生成工具的过程是这样的: 生成密钥后，将“商户应用公钥”复制到沙箱应用下的“RSA2(SHA256)密钥”设置中。 保存后系统会生成“支付宝公钥”，可直接点击“查看支付宝公钥”查看。另外，“商户应用私钥”请自行保存，因为后面会用到。 PS：密钥的配置是对交易数据进行双方校验，所以请务必配置正确。 2.避免单边账 以下均引用官方文档（避免单边账）： 一，单边帐是指对于一笔交易，商户端和用户端的结果不一致，分为两种情况： 1.1 商户资损单边账：用户实际未付款成功，但商户系统判定支付成功；或用户支付成功后，商户系统由于逻辑问题发起了撤销。 1.2 用户资损单边账：用户付款成功，但商户系统未得到支付成功的结果，误认为付款失败，再次扫用户付款码发起支付，导致用户多支付了一笔。在用户手机网络不好的情况下，支付成功后用户手机不一定会显示支付成功页面，用户自己也不知道已经付成功了。这种情况在小额场景下尤其容易出现，且难以发现，需要商户和系统商特别注意。 二，为了避免单边帐，建议商户和系统商采取以下措施： 2.1. 每一笔交易一定要闭环，即要么支付成功，要么撤销交易，一定不能有交易一直停留在等待用户付款的状态。 2.2 轮询+撤销的流程中，如轮询的结果一直为未付款，撤销一定要紧接着最后一次查询，当中不能有时间间隔。 2.3 门店收银系统应该具备独立的手动查询功能作为兜底，输入商户订单号（可从用户手机账单中获得）调用支付宝查询接口获得确切的支付状态。 2.4 当遇到网络超时和未知异常时，参考异常处理流程正确处理，对于每一笔交易或退款，一定要得到确切的结果。 2.5 撤销接口调用成功后，需要在收银台页面为收银员展示撤销成功的强提示文案，且按实际业务情况引导收银员进行手工订单查询。如果撤销接口没有明确返回处理结果，如遇到网络超时或支付宝未知异常等情况，则需要在收银台提示文案中表明，撤销正在处理中；若该笔订单已经支付则后续会有发生退款的可能，并和用户做好线下沟通。 2.6 对于经过轮询和撤销仍然无法确认结果的（例如系统故障或门店断网），应上报总部IT或财务，由IT（从系统内）或财务（从支付宝后台），确认支付结果后，通过后台发起退款。或让顾客查询手机支付宝账单，如顾客手机没网络，可拨打支付宝客服热线95188确认支付结果。 2.7 在上述基础上，业务流程培训时应强调支付结果必须以商户端为准，用户手机上的支付宝结果或账单只能做参考，不能作为最终识别标准。如果商户未正确处理业务逻辑和业务流程培训，存在潜在的风险，商户自行承担因此而产生的所有损失。 官方文档叙述的已经足够清楚了，我就不造轮子了，各位重点注意便可。 二、沙箱环境调试测试 支付宝沙箱是支付宝官方提供的沙箱测试环境，里面提供了支付宝的部分功能，但相对来说够用了。 支付宝沙箱环境 注册申请完沙箱环境后，系统会自动生成沙箱应用。在上面的密钥配置了，我们的公钥配置就是在沙箱应用中配置的。 首先我们先说下”沙箱应用“，因为开发操作也主要围绕”沙箱应用“，下图是沙箱应用的介绍图： 图中应用网关因为暂时没用到，所以没有设置，需要关注的主要是密钥配置，其次需要关注的是”授权回调地址”，因为支付宝回调地址要求是外网地址，所以需要进行”内网穿透”，当然你有其他的方法也可以，关于内网穿透，我使用的是”NATAPP”，其他的也有，你们自行按需求配置吧，不做累述。 因为后面测试需要下载沙箱工具： 沙箱版钱包需要用沙箱帐号登录 支付宝提供了一个买家和一个卖家的沙箱帐号供我们测试用。 为保证沙箱长期稳定，支付宝会在每周日中午12点至每周一中午12点沙箱环境进行维护，期间可能出现不可用。 三、当面付官方Demo调试 支付宝当面付官方Demo 通过下载上面链接内的官方Demo后，将项目引入你的IDE中，我用的是IDEA。 引入后可能会因为JDK版本已经jar包问题报错，一般重新配置下JDK和重新引入下jar包就可以了。 然后我们就要对Demo的配置文件进行修改了“zfbinfo.properties” # 支付宝网关名、partnerId和appId open_api_domain = 填写支付宝网关 mcloud_api_domain = http://mcloudmonitor.com/gateway.do pid = 填写沙箱应用中的&quot;商户UID&quot; appid = 填写沙箱应用中的&quot;APPID&quot; # RSA私钥、公钥和支付宝公钥 private_key = 填写商户应用私钥 public_key = 填写商户应用公钥 #SHA1withRsa对应支付宝公钥 #alipay_public_key = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDI6d306Q8fIfCOaTXyiUeJHkrIvYISRcc73s3vF1ZT7XN8RNPwJxo8pWaJMmvyTn9N4HQ632qJBVHf8sxHi/fEsraprwCtzvzQETrNRwVxLO5jVmRGi60j8Ue1efIlzPXV9je9mkjzOmdssymZkh2QhUrCmZYI/FCEa3/cNMW0QIDAQAB #SHA256withRsa对应支付宝公钥 alipay_public_key = 填写支付宝公钥 # 签名类型: RSA-&gt;SHA1withRsa,RSA2-&gt;SHA256withRsa sign_type = RSA2 # 当面付最大查询次数和查询间隔（毫秒） max_query_retry = 5 query_duration = 5000 # 当面付最大撤销次数和撤销间隔（毫秒） max_cancel_retry = 3 cancel_duration = 2000 # 交易保障线程第一次调度延迟和调度间隔（秒） heartbeat_delay = 5 heartbeat_duration = 900 需要特别注意配置的是密钥的配置，密钥的生成请参考第一节的密钥配置，千万别配错了，代码中我用中文已经备注好了“填写XXX”，那些是我们要配置的，其他保持默认就可以了。 配置完后运行Main方法 如无异常，运行结果应该是这样子的: 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.config.Configs init 信息: 配置文件名: zfbinfo.properties 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.config.Configs init 信息: Configs{支付宝openapi网关: https://openapi.alipaydev.com/gateway.do , 支付宝mcloudapi网关域名: http://mcloudmonitor.com/gateway.do , pid: 2088102172412792 , appid: 2016082100304819 , 商户RSA私钥: MIIEvw******KZYA== , 商户RSA公钥: MIIBIj******IDAQAB , 支付宝RSA公钥: MIIBIj******IDAQAB , 签名类型: RSA2 , 查询重试次数: 5 , 查询间隔(毫秒): 5000 , 撤销尝试次数: 3 , 撤销重试间隔(毫秒): 2000 , 交易保障调度延迟(秒): 5 , 交易保障调度间隔(秒): 900 } 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.service.impl.AbsAlipayTradeService tradePrecreate 信息: trade.precreate bizContent:{&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;seller_id&quot;:&quot;&quot;,&quot;total_amount&quot;:&quot;0.01&quot;,&quot;undiscountable_amount&quot;:&quot;0&quot;,&quot;subject&quot;:&quot;xxx品牌xxx门店当面付扫码消费&quot;,&quot;body&quot;:&quot;购买商品3件共20.00元&quot;,&quot;goods_detail&quot;:[{&quot;goods_id&quot;:&quot;goods_id001&quot;,&quot;goods_name&quot;:&quot;xxx小面包&quot;,&quot;quantity&quot;:1,&quot;price&quot;:&quot;10&quot;},{&quot;goods_id&quot;:&quot;goods_id002&quot;,&quot;goods_name&quot;:&quot;xxx牙刷&quot;,&quot;quantity&quot;:2,&quot;price&quot;:&quot;5&quot;}],&quot;operator_id&quot;:&quot;test_operator_id&quot;,&quot;store_id&quot;:&quot;test_store_id&quot;,&quot;extend_params&quot;:{&quot;sys_service_provider_id&quot;:&quot;2088100200300400500&quot;},&quot;timeout_express&quot;:&quot;120m&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.service.impl.AbsAlipayService getResponse 信息: {&quot;alipay_trade_precreate_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;qr_code&quot;:&quot;https:\/\/qr.alipay.com\/bax07752bxnnqtb3s9dn00ce&quot;},&quot;sign&quot;:&quot;yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA==&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main test_trade_precreate 信息: 支付宝预下单成功: ) 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main dumpResponse 信息: code:10000, msg:Success 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main dumpResponse 信息: body:{&quot;alipay_trade_precreate_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;qr_code&quot;:&quot;https:\/\/qr.alipay.com\/bax07752bxnnqtb3s9dn00ce&quot;},&quot;sign&quot;:&quot;yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA==&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main test_trade_precreate 信息: filePath:/Users/sudo/Desktop/qr-tradeprecreate15110946363841555882.png Process finished with exit code 0 状态码返回1000，表示正常。 四、将支付宝当面付集成到自己项目中 首先将Demo中的配置文件以及SDK拷贝到自己项目的相应目录中 另外还有些通用的jar包，我是通过配置Maven的pom.xml引入的，jar包版本和Demo保持一致，各位可以参考下： &lt;!-- alipay --&gt; &lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-configuration&lt;/groupId&gt; &lt;artifactId&gt;commons-configuration&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-lang&lt;/groupId&gt; &lt;artifactId&gt;commons-lang&lt;/artifactId&gt; &lt;version&gt;2.6&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-logging&lt;/groupId&gt; &lt;artifactId&gt;commons-logging&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.zxing&lt;/groupId&gt; &lt;artifactId&gt;core&lt;/artifactId&gt; &lt;version&gt;2.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt; &lt;artifactId&gt;gson&lt;/artifactId&gt; &lt;version&gt;2.3.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.hamcrest&lt;/groupId&gt; &lt;artifactId&gt;hamcrest-core&lt;/artifactId&gt; &lt;version&gt;1.3&lt;/version&gt; &lt;/dependency&gt; &lt;!-- geelynote maven的核心插件之-complier插件默认只支持编译Java 1.4，因此需要加上支持高版本jre的配置，在pom.xml里面加上 增加编译插件 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;source&gt;1.7&lt;/source&gt; &lt;target&gt;1.7&lt;/target&gt; &lt;encoding&gt;UTF-8&lt;/encoding&gt; &lt;compilerArguments&gt; &lt;extdirs&gt;${project.basedir}/src/main/webapp/WEB-INF/lib&lt;/extdirs&gt; &lt;/compilerArguments&gt; &lt;/configuration&gt; &lt;/plugin&gt; 将Demo中alipay.demo.trade包以及其中的两个类拷贝到你的项目中，用来测试配置正不正确。在运行Main方法测试之前，先将支付宝的jar包引入下。 我项目中关于支付宝当面付的接口主要有三个“pay.do”，”query_order_pay_status.do”和“alipay_callback.do”,pay.do是用来根据项目订单，向支付宝发起下单请求，而alipay_callback.do是用来接收支付宝的回调信息，“query_order_pay_status.do”是用来查询订单的支付状态。 各位把这三个接口对应到第一张业务流程图就会很清楚这几个接口的明确作用了。 以上几个接口的实现几乎都是根据官方Demo和自己的项目需求进行修改出来的，所以各位只需根据自己的项目需求，在Demo中寻找自己需要的功能，并对Demo源码进行分析了解就可以了。 以查询订单为例： // 测试当面付2.0查询订单 public void test_trade_query() { // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // 创建查询请求builder，设置请求参数 AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder() .setOutTradeNo(outTradeNo); AlipayF2FQueryResult result = tradeService.queryTradeResult(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;查询返回该订单支付成功: )&quot;); AlipayTradeQueryResponse response = result.getResponse(); dumpResponse(response); log.info(response.getTradeStatus()); if (Utils.isListNotEmpty(response.getFundBillList())) { for (TradeFundBill bill : response.getFundBillList()) { log.info(bill.getFundChannel() + &quot;:&quot; + bill.getAmount()); } } break; case FAILED: log.error(&quot;查询返回该订单支付失败或被关闭!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单支付状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } 上述代码是Demo中Main.java中的案例，如果我们项目中需要查询订单的接口，那么我们可以直接将它拿过来，将“outTradeNo ”改为我们传入的订单号，然后其他的日志以及异常按照自己的需求进行修改就可以了… 实际上整个对接过程中最花时间的是查看官方文档了解需要重点注意的一些点，然后配置调通Demo，就这两个便占了70%的时间，其余30%的时间便是你自己真正设计编码的时间。 并不是说这70%的时间无用，因为只有当你根据文档和Demo了解清楚后，你剩下30%的时间才能轻松完成你的设计以及编码。 emmmmmmm，后面第4节真正接入写的有点敷衍。每个人的项目需求不同，侧重点也不同。即使我把我项目的相关代码贴出来讲，可能也不是各位想要的，我只是希望给各位讲一下我个人对于接入支付宝当面付的思想过程。 如果想看我接入的详细源码，请直接点击查看 阅读更多" />
<meta property="og:description" content="最近做的项目的支付模块需要对接支付宝的当面付，刚做完，想把整个过程以及需要注意的一些点整理罗列下，于是便想着写一写。 接入的大体思路及过程 查看支付宝当面付官方文档（https://docs.open.alipay.com/194） 通过支付宝提供的沙箱环境调试测试（支付宝沙箱环境） 调试通官方提供的Demo（https://docs.open.alipay.com/194/105201/） 根据Demo分析整个处理流程，以及需要重点注意的点 根据官方文档和Demo将当面付集成到自己的项目中 一、支付宝当面付官方文档 题外话：阿里的文档是真的很详细，因此避免了很多坑，所以有不懂的一般翻翻文档就大概知道了。 好了，不说废话了，根据支付宝的官方文档我们首先要了解的是整个业务流程： 以及用户的使用流程： 以上两个都是官方文档提供的图，文档中都有说，我就不复述了。 实际上对接到项目中，属于我们项目本身的处理逻辑主要集中是下图红框内的流程： 以我的项目为例： 系统通过用户订单向支付宝后台发起下单请求–》支付宝后台收到请求并返回订单数据以及二维码–》系统后台接受并处理支付宝的返回数据–》向用户展示二维码–》用户通过支付宝进行扫码操作–》支付宝回调支付数据–》系统后台进行处理 emm，感觉我这个例子太乱的同学可以直接无视=。 = 整个支付宝当面付中需要重点注意的有两点： 1. 密钥的配置 关于支付宝密钥的解释和流程请参考（扫码支付接入指引 ）中的“配置应用 ” 支付宝的密钥有两种：“RSA2(SHA256)密钥”和“RSA(SHA1)密钥”，官方推荐的是“RSA2(SHA256)密钥”，而我使用的也是官方推荐的 下面我将叙述密钥的配置（RSA2(SHA256)密钥）过程： 以下操作均在沙箱环境操作，没有沙箱环境的请务必创建沙箱环境（支付宝沙箱环境） 因为需要生成RSA密钥，所以需要用支付宝提供一键生成工具生成一对RSA密钥（生成RSA密钥） 我的系统是windows的，所以用密钥生成工具的过程是这样的: 生成密钥后，将“商户应用公钥”复制到沙箱应用下的“RSA2(SHA256)密钥”设置中。 保存后系统会生成“支付宝公钥”，可直接点击“查看支付宝公钥”查看。另外，“商户应用私钥”请自行保存，因为后面会用到。 PS：密钥的配置是对交易数据进行双方校验，所以请务必配置正确。 2.避免单边账 以下均引用官方文档（避免单边账）： 一，单边帐是指对于一笔交易，商户端和用户端的结果不一致，分为两种情况： 1.1 商户资损单边账：用户实际未付款成功，但商户系统判定支付成功；或用户支付成功后，商户系统由于逻辑问题发起了撤销。 1.2 用户资损单边账：用户付款成功，但商户系统未得到支付成功的结果，误认为付款失败，再次扫用户付款码发起支付，导致用户多支付了一笔。在用户手机网络不好的情况下，支付成功后用户手机不一定会显示支付成功页面，用户自己也不知道已经付成功了。这种情况在小额场景下尤其容易出现，且难以发现，需要商户和系统商特别注意。 二，为了避免单边帐，建议商户和系统商采取以下措施： 2.1. 每一笔交易一定要闭环，即要么支付成功，要么撤销交易，一定不能有交易一直停留在等待用户付款的状态。 2.2 轮询+撤销的流程中，如轮询的结果一直为未付款，撤销一定要紧接着最后一次查询，当中不能有时间间隔。 2.3 门店收银系统应该具备独立的手动查询功能作为兜底，输入商户订单号（可从用户手机账单中获得）调用支付宝查询接口获得确切的支付状态。 2.4 当遇到网络超时和未知异常时，参考异常处理流程正确处理，对于每一笔交易或退款，一定要得到确切的结果。 2.5 撤销接口调用成功后，需要在收银台页面为收银员展示撤销成功的强提示文案，且按实际业务情况引导收银员进行手工订单查询。如果撤销接口没有明确返回处理结果，如遇到网络超时或支付宝未知异常等情况，则需要在收银台提示文案中表明，撤销正在处理中；若该笔订单已经支付则后续会有发生退款的可能，并和用户做好线下沟通。 2.6 对于经过轮询和撤销仍然无法确认结果的（例如系统故障或门店断网），应上报总部IT或财务，由IT（从系统内）或财务（从支付宝后台），确认支付结果后，通过后台发起退款。或让顾客查询手机支付宝账单，如顾客手机没网络，可拨打支付宝客服热线95188确认支付结果。 2.7 在上述基础上，业务流程培训时应强调支付结果必须以商户端为准，用户手机上的支付宝结果或账单只能做参考，不能作为最终识别标准。如果商户未正确处理业务逻辑和业务流程培训，存在潜在的风险，商户自行承担因此而产生的所有损失。 官方文档叙述的已经足够清楚了，我就不造轮子了，各位重点注意便可。 二、沙箱环境调试测试 支付宝沙箱是支付宝官方提供的沙箱测试环境，里面提供了支付宝的部分功能，但相对来说够用了。 支付宝沙箱环境 注册申请完沙箱环境后，系统会自动生成沙箱应用。在上面的密钥配置了，我们的公钥配置就是在沙箱应用中配置的。 首先我们先说下”沙箱应用“，因为开发操作也主要围绕”沙箱应用“，下图是沙箱应用的介绍图： 图中应用网关因为暂时没用到，所以没有设置，需要关注的主要是密钥配置，其次需要关注的是”授权回调地址”，因为支付宝回调地址要求是外网地址，所以需要进行”内网穿透”，当然你有其他的方法也可以，关于内网穿透，我使用的是”NATAPP”，其他的也有，你们自行按需求配置吧，不做累述。 因为后面测试需要下载沙箱工具： 沙箱版钱包需要用沙箱帐号登录 支付宝提供了一个买家和一个卖家的沙箱帐号供我们测试用。 为保证沙箱长期稳定，支付宝会在每周日中午12点至每周一中午12点沙箱环境进行维护，期间可能出现不可用。 三、当面付官方Demo调试 支付宝当面付官方Demo 通过下载上面链接内的官方Demo后，将项目引入你的IDE中，我用的是IDEA。 引入后可能会因为JDK版本已经jar包问题报错，一般重新配置下JDK和重新引入下jar包就可以了。 然后我们就要对Demo的配置文件进行修改了“zfbinfo.properties” # 支付宝网关名、partnerId和appId open_api_domain = 填写支付宝网关 mcloud_api_domain = http://mcloudmonitor.com/gateway.do pid = 填写沙箱应用中的&quot;商户UID&quot; appid = 填写沙箱应用中的&quot;APPID&quot; # RSA私钥、公钥和支付宝公钥 private_key = 填写商户应用私钥 public_key = 填写商户应用公钥 #SHA1withRsa对应支付宝公钥 #alipay_public_key = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDI6d306Q8fIfCOaTXyiUeJHkrIvYISRcc73s3vF1ZT7XN8RNPwJxo8pWaJMmvyTn9N4HQ632qJBVHf8sxHi/fEsraprwCtzvzQETrNRwVxLO5jVmRGi60j8Ue1efIlzPXV9je9mkjzOmdssymZkh2QhUrCmZYI/FCEa3/cNMW0QIDAQAB #SHA256withRsa对应支付宝公钥 alipay_public_key = 填写支付宝公钥 # 签名类型: RSA-&gt;SHA1withRsa,RSA2-&gt;SHA256withRsa sign_type = RSA2 # 当面付最大查询次数和查询间隔（毫秒） max_query_retry = 5 query_duration = 5000 # 当面付最大撤销次数和撤销间隔（毫秒） max_cancel_retry = 3 cancel_duration = 2000 # 交易保障线程第一次调度延迟和调度间隔（秒） heartbeat_delay = 5 heartbeat_duration = 900 需要特别注意配置的是密钥的配置，密钥的生成请参考第一节的密钥配置，千万别配错了，代码中我用中文已经备注好了“填写XXX”，那些是我们要配置的，其他保持默认就可以了。 配置完后运行Main方法 如无异常，运行结果应该是这样子的: 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.config.Configs init 信息: 配置文件名: zfbinfo.properties 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.config.Configs init 信息: Configs{支付宝openapi网关: https://openapi.alipaydev.com/gateway.do , 支付宝mcloudapi网关域名: http://mcloudmonitor.com/gateway.do , pid: 2088102172412792 , appid: 2016082100304819 , 商户RSA私钥: MIIEvw******KZYA== , 商户RSA公钥: MIIBIj******IDAQAB , 支付宝RSA公钥: MIIBIj******IDAQAB , 签名类型: RSA2 , 查询重试次数: 5 , 查询间隔(毫秒): 5000 , 撤销尝试次数: 3 , 撤销重试间隔(毫秒): 2000 , 交易保障调度延迟(秒): 5 , 交易保障调度间隔(秒): 900 } 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.service.impl.AbsAlipayTradeService tradePrecreate 信息: trade.precreate bizContent:{&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;seller_id&quot;:&quot;&quot;,&quot;total_amount&quot;:&quot;0.01&quot;,&quot;undiscountable_amount&quot;:&quot;0&quot;,&quot;subject&quot;:&quot;xxx品牌xxx门店当面付扫码消费&quot;,&quot;body&quot;:&quot;购买商品3件共20.00元&quot;,&quot;goods_detail&quot;:[{&quot;goods_id&quot;:&quot;goods_id001&quot;,&quot;goods_name&quot;:&quot;xxx小面包&quot;,&quot;quantity&quot;:1,&quot;price&quot;:&quot;10&quot;},{&quot;goods_id&quot;:&quot;goods_id002&quot;,&quot;goods_name&quot;:&quot;xxx牙刷&quot;,&quot;quantity&quot;:2,&quot;price&quot;:&quot;5&quot;}],&quot;operator_id&quot;:&quot;test_operator_id&quot;,&quot;store_id&quot;:&quot;test_store_id&quot;,&quot;extend_params&quot;:{&quot;sys_service_provider_id&quot;:&quot;2088100200300400500&quot;},&quot;timeout_express&quot;:&quot;120m&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.service.impl.AbsAlipayService getResponse 信息: {&quot;alipay_trade_precreate_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;qr_code&quot;:&quot;https:\/\/qr.alipay.com\/bax07752bxnnqtb3s9dn00ce&quot;},&quot;sign&quot;:&quot;yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA==&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main test_trade_precreate 信息: 支付宝预下单成功: ) 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main dumpResponse 信息: code:10000, msg:Success 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main dumpResponse 信息: body:{&quot;alipay_trade_precreate_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;qr_code&quot;:&quot;https:\/\/qr.alipay.com\/bax07752bxnnqtb3s9dn00ce&quot;},&quot;sign&quot;:&quot;yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA==&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main test_trade_precreate 信息: filePath:/Users/sudo/Desktop/qr-tradeprecreate15110946363841555882.png Process finished with exit code 0 状态码返回1000，表示正常。 四、将支付宝当面付集成到自己项目中 首先将Demo中的配置文件以及SDK拷贝到自己项目的相应目录中 另外还有些通用的jar包，我是通过配置Maven的pom.xml引入的，jar包版本和Demo保持一致，各位可以参考下： &lt;!-- alipay --&gt; &lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-configuration&lt;/groupId&gt; &lt;artifactId&gt;commons-configuration&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-lang&lt;/groupId&gt; &lt;artifactId&gt;commons-lang&lt;/artifactId&gt; &lt;version&gt;2.6&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-logging&lt;/groupId&gt; &lt;artifactId&gt;commons-logging&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.zxing&lt;/groupId&gt; &lt;artifactId&gt;core&lt;/artifactId&gt; &lt;version&gt;2.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt; &lt;artifactId&gt;gson&lt;/artifactId&gt; &lt;version&gt;2.3.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.hamcrest&lt;/groupId&gt; &lt;artifactId&gt;hamcrest-core&lt;/artifactId&gt; &lt;version&gt;1.3&lt;/version&gt; &lt;/dependency&gt; &lt;!-- geelynote maven的核心插件之-complier插件默认只支持编译Java 1.4，因此需要加上支持高版本jre的配置，在pom.xml里面加上 增加编译插件 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;source&gt;1.7&lt;/source&gt; &lt;target&gt;1.7&lt;/target&gt; &lt;encoding&gt;UTF-8&lt;/encoding&gt; &lt;compilerArguments&gt; &lt;extdirs&gt;${project.basedir}/src/main/webapp/WEB-INF/lib&lt;/extdirs&gt; &lt;/compilerArguments&gt; &lt;/configuration&gt; &lt;/plugin&gt; 将Demo中alipay.demo.trade包以及其中的两个类拷贝到你的项目中，用来测试配置正不正确。在运行Main方法测试之前，先将支付宝的jar包引入下。 我项目中关于支付宝当面付的接口主要有三个“pay.do”，”query_order_pay_status.do”和“alipay_callback.do”,pay.do是用来根据项目订单，向支付宝发起下单请求，而alipay_callback.do是用来接收支付宝的回调信息，“query_order_pay_status.do”是用来查询订单的支付状态。 各位把这三个接口对应到第一张业务流程图就会很清楚这几个接口的明确作用了。 以上几个接口的实现几乎都是根据官方Demo和自己的项目需求进行修改出来的，所以各位只需根据自己的项目需求，在Demo中寻找自己需要的功能，并对Demo源码进行分析了解就可以了。 以查询订单为例： // 测试当面付2.0查询订单 public void test_trade_query() { // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // 创建查询请求builder，设置请求参数 AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder() .setOutTradeNo(outTradeNo); AlipayF2FQueryResult result = tradeService.queryTradeResult(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;查询返回该订单支付成功: )&quot;); AlipayTradeQueryResponse response = result.getResponse(); dumpResponse(response); log.info(response.getTradeStatus()); if (Utils.isListNotEmpty(response.getFundBillList())) { for (TradeFundBill bill : response.getFundBillList()) { log.info(bill.getFundChannel() + &quot;:&quot; + bill.getAmount()); } } break; case FAILED: log.error(&quot;查询返回该订单支付失败或被关闭!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单支付状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } 上述代码是Demo中Main.java中的案例，如果我们项目中需要查询订单的接口，那么我们可以直接将它拿过来，将“outTradeNo ”改为我们传入的订单号，然后其他的日志以及异常按照自己的需求进行修改就可以了… 实际上整个对接过程中最花时间的是查看官方文档了解需要重点注意的一些点，然后配置调通Demo，就这两个便占了70%的时间，其余30%的时间便是你自己真正设计编码的时间。 并不是说这70%的时间无用，因为只有当你根据文档和Demo了解清楚后，你剩下30%的时间才能轻松完成你的设计以及编码。 emmmmmmm，后面第4节真正接入写的有点敷衍。每个人的项目需求不同，侧重点也不同。即使我把我项目的相关代码贴出来讲，可能也不是各位想要的，我只是希望给各位讲一下我个人对于接入支付宝当面付的思想过程。 如果想看我接入的详细源码，请直接点击查看 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/11/19/6f04e085e35f1db8a4ca813594ea656d.html" />
<meta property="og:url" content="https://mlh.app/2017/11/19/6f04e085e35f1db8a4ca813594ea656d.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-11-19T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"最近做的项目的支付模块需要对接支付宝的当面付，刚做完，想把整个过程以及需要注意的一些点整理罗列下，于是便想着写一写。 接入的大体思路及过程 查看支付宝当面付官方文档（https://docs.open.alipay.com/194） 通过支付宝提供的沙箱环境调试测试（支付宝沙箱环境） 调试通官方提供的Demo（https://docs.open.alipay.com/194/105201/） 根据Demo分析整个处理流程，以及需要重点注意的点 根据官方文档和Demo将当面付集成到自己的项目中 一、支付宝当面付官方文档 题外话：阿里的文档是真的很详细，因此避免了很多坑，所以有不懂的一般翻翻文档就大概知道了。 好了，不说废话了，根据支付宝的官方文档我们首先要了解的是整个业务流程： 以及用户的使用流程： 以上两个都是官方文档提供的图，文档中都有说，我就不复述了。 实际上对接到项目中，属于我们项目本身的处理逻辑主要集中是下图红框内的流程： 以我的项目为例： 系统通过用户订单向支付宝后台发起下单请求–》支付宝后台收到请求并返回订单数据以及二维码–》系统后台接受并处理支付宝的返回数据–》向用户展示二维码–》用户通过支付宝进行扫码操作–》支付宝回调支付数据–》系统后台进行处理 emm，感觉我这个例子太乱的同学可以直接无视=。 = 整个支付宝当面付中需要重点注意的有两点： 1. 密钥的配置 关于支付宝密钥的解释和流程请参考（扫码支付接入指引 ）中的“配置应用 ” 支付宝的密钥有两种：“RSA2(SHA256)密钥”和“RSA(SHA1)密钥”，官方推荐的是“RSA2(SHA256)密钥”，而我使用的也是官方推荐的 下面我将叙述密钥的配置（RSA2(SHA256)密钥）过程： 以下操作均在沙箱环境操作，没有沙箱环境的请务必创建沙箱环境（支付宝沙箱环境） 因为需要生成RSA密钥，所以需要用支付宝提供一键生成工具生成一对RSA密钥（生成RSA密钥） 我的系统是windows的，所以用密钥生成工具的过程是这样的: 生成密钥后，将“商户应用公钥”复制到沙箱应用下的“RSA2(SHA256)密钥”设置中。 保存后系统会生成“支付宝公钥”，可直接点击“查看支付宝公钥”查看。另外，“商户应用私钥”请自行保存，因为后面会用到。 PS：密钥的配置是对交易数据进行双方校验，所以请务必配置正确。 2.避免单边账 以下均引用官方文档（避免单边账）： 一，单边帐是指对于一笔交易，商户端和用户端的结果不一致，分为两种情况： 1.1 商户资损单边账：用户实际未付款成功，但商户系统判定支付成功；或用户支付成功后，商户系统由于逻辑问题发起了撤销。 1.2 用户资损单边账：用户付款成功，但商户系统未得到支付成功的结果，误认为付款失败，再次扫用户付款码发起支付，导致用户多支付了一笔。在用户手机网络不好的情况下，支付成功后用户手机不一定会显示支付成功页面，用户自己也不知道已经付成功了。这种情况在小额场景下尤其容易出现，且难以发现，需要商户和系统商特别注意。 二，为了避免单边帐，建议商户和系统商采取以下措施： 2.1. 每一笔交易一定要闭环，即要么支付成功，要么撤销交易，一定不能有交易一直停留在等待用户付款的状态。 2.2 轮询+撤销的流程中，如轮询的结果一直为未付款，撤销一定要紧接着最后一次查询，当中不能有时间间隔。 2.3 门店收银系统应该具备独立的手动查询功能作为兜底，输入商户订单号（可从用户手机账单中获得）调用支付宝查询接口获得确切的支付状态。 2.4 当遇到网络超时和未知异常时，参考异常处理流程正确处理，对于每一笔交易或退款，一定要得到确切的结果。 2.5 撤销接口调用成功后，需要在收银台页面为收银员展示撤销成功的强提示文案，且按实际业务情况引导收银员进行手工订单查询。如果撤销接口没有明确返回处理结果，如遇到网络超时或支付宝未知异常等情况，则需要在收银台提示文案中表明，撤销正在处理中；若该笔订单已经支付则后续会有发生退款的可能，并和用户做好线下沟通。 2.6 对于经过轮询和撤销仍然无法确认结果的（例如系统故障或门店断网），应上报总部IT或财务，由IT（从系统内）或财务（从支付宝后台），确认支付结果后，通过后台发起退款。或让顾客查询手机支付宝账单，如顾客手机没网络，可拨打支付宝客服热线95188确认支付结果。 2.7 在上述基础上，业务流程培训时应强调支付结果必须以商户端为准，用户手机上的支付宝结果或账单只能做参考，不能作为最终识别标准。如果商户未正确处理业务逻辑和业务流程培训，存在潜在的风险，商户自行承担因此而产生的所有损失。 官方文档叙述的已经足够清楚了，我就不造轮子了，各位重点注意便可。 二、沙箱环境调试测试 支付宝沙箱是支付宝官方提供的沙箱测试环境，里面提供了支付宝的部分功能，但相对来说够用了。 支付宝沙箱环境 注册申请完沙箱环境后，系统会自动生成沙箱应用。在上面的密钥配置了，我们的公钥配置就是在沙箱应用中配置的。 首先我们先说下”沙箱应用“，因为开发操作也主要围绕”沙箱应用“，下图是沙箱应用的介绍图： 图中应用网关因为暂时没用到，所以没有设置，需要关注的主要是密钥配置，其次需要关注的是”授权回调地址”，因为支付宝回调地址要求是外网地址，所以需要进行”内网穿透”，当然你有其他的方法也可以，关于内网穿透，我使用的是”NATAPP”，其他的也有，你们自行按需求配置吧，不做累述。 因为后面测试需要下载沙箱工具： 沙箱版钱包需要用沙箱帐号登录 支付宝提供了一个买家和一个卖家的沙箱帐号供我们测试用。 为保证沙箱长期稳定，支付宝会在每周日中午12点至每周一中午12点沙箱环境进行维护，期间可能出现不可用。 三、当面付官方Demo调试 支付宝当面付官方Demo 通过下载上面链接内的官方Demo后，将项目引入你的IDE中，我用的是IDEA。 引入后可能会因为JDK版本已经jar包问题报错，一般重新配置下JDK和重新引入下jar包就可以了。 然后我们就要对Demo的配置文件进行修改了“zfbinfo.properties” # 支付宝网关名、partnerId和appId open_api_domain = 填写支付宝网关 mcloud_api_domain = http://mcloudmonitor.com/gateway.do pid = 填写沙箱应用中的&quot;商户UID&quot; appid = 填写沙箱应用中的&quot;APPID&quot; # RSA私钥、公钥和支付宝公钥 private_key = 填写商户应用私钥 public_key = 填写商户应用公钥 #SHA1withRsa对应支付宝公钥 #alipay_public_key = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDI6d306Q8fIfCOaTXyiUeJHkrIvYISRcc73s3vF1ZT7XN8RNPwJxo8pWaJMmvyTn9N4HQ632qJBVHf8sxHi/fEsraprwCtzvzQETrNRwVxLO5jVmRGi60j8Ue1efIlzPXV9je9mkjzOmdssymZkh2QhUrCmZYI/FCEa3/cNMW0QIDAQAB #SHA256withRsa对应支付宝公钥 alipay_public_key = 填写支付宝公钥 # 签名类型: RSA-&gt;SHA1withRsa,RSA2-&gt;SHA256withRsa sign_type = RSA2 # 当面付最大查询次数和查询间隔（毫秒） max_query_retry = 5 query_duration = 5000 # 当面付最大撤销次数和撤销间隔（毫秒） max_cancel_retry = 3 cancel_duration = 2000 # 交易保障线程第一次调度延迟和调度间隔（秒） heartbeat_delay = 5 heartbeat_duration = 900 需要特别注意配置的是密钥的配置，密钥的生成请参考第一节的密钥配置，千万别配错了，代码中我用中文已经备注好了“填写XXX”，那些是我们要配置的，其他保持默认就可以了。 配置完后运行Main方法 如无异常，运行结果应该是这样子的: 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.config.Configs init 信息: 配置文件名: zfbinfo.properties 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.config.Configs init 信息: Configs{支付宝openapi网关: https://openapi.alipaydev.com/gateway.do , 支付宝mcloudapi网关域名: http://mcloudmonitor.com/gateway.do , pid: 2088102172412792 , appid: 2016082100304819 , 商户RSA私钥: MIIEvw******KZYA== , 商户RSA公钥: MIIBIj******IDAQAB , 支付宝RSA公钥: MIIBIj******IDAQAB , 签名类型: RSA2 , 查询重试次数: 5 , 查询间隔(毫秒): 5000 , 撤销尝试次数: 3 , 撤销重试间隔(毫秒): 2000 , 交易保障调度延迟(秒): 5 , 交易保障调度间隔(秒): 900 } 十一月 19, 2017 8:30:36 下午 com.alipay.demo.trade.service.impl.AbsAlipayTradeService tradePrecreate 信息: trade.precreate bizContent:{&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;seller_id&quot;:&quot;&quot;,&quot;total_amount&quot;:&quot;0.01&quot;,&quot;undiscountable_amount&quot;:&quot;0&quot;,&quot;subject&quot;:&quot;xxx品牌xxx门店当面付扫码消费&quot;,&quot;body&quot;:&quot;购买商品3件共20.00元&quot;,&quot;goods_detail&quot;:[{&quot;goods_id&quot;:&quot;goods_id001&quot;,&quot;goods_name&quot;:&quot;xxx小面包&quot;,&quot;quantity&quot;:1,&quot;price&quot;:&quot;10&quot;},{&quot;goods_id&quot;:&quot;goods_id002&quot;,&quot;goods_name&quot;:&quot;xxx牙刷&quot;,&quot;quantity&quot;:2,&quot;price&quot;:&quot;5&quot;}],&quot;operator_id&quot;:&quot;test_operator_id&quot;,&quot;store_id&quot;:&quot;test_store_id&quot;,&quot;extend_params&quot;:{&quot;sys_service_provider_id&quot;:&quot;2088100200300400500&quot;},&quot;timeout_express&quot;:&quot;120m&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.service.impl.AbsAlipayService getResponse 信息: {&quot;alipay_trade_precreate_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;qr_code&quot;:&quot;https:\\/\\/qr.alipay.com\\/bax07752bxnnqtb3s9dn00ce&quot;},&quot;sign&quot;:&quot;yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA==&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main test_trade_precreate 信息: 支付宝预下单成功: ) 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main dumpResponse 信息: code:10000, msg:Success 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main dumpResponse 信息: body:{&quot;alipay_trade_precreate_response&quot;:{&quot;code&quot;:&quot;10000&quot;,&quot;msg&quot;:&quot;Success&quot;,&quot;out_trade_no&quot;:&quot;tradeprecreate15110946363841555882&quot;,&quot;qr_code&quot;:&quot;https:\\/\\/qr.alipay.com\\/bax07752bxnnqtb3s9dn00ce&quot;},&quot;sign&quot;:&quot;yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA==&quot;} 十一月 19, 2017 8:30:41 下午 com.alipay.demo.trade.Main test_trade_precreate 信息: filePath:/Users/sudo/Desktop/qr-tradeprecreate15110946363841555882.png Process finished with exit code 0 状态码返回1000，表示正常。 四、将支付宝当面付集成到自己项目中 首先将Demo中的配置文件以及SDK拷贝到自己项目的相应目录中 另外还有些通用的jar包，我是通过配置Maven的pom.xml引入的，jar包版本和Demo保持一致，各位可以参考下： &lt;!-- alipay --&gt; &lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-configuration&lt;/groupId&gt; &lt;artifactId&gt;commons-configuration&lt;/artifactId&gt; &lt;version&gt;1.10&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-lang&lt;/groupId&gt; &lt;artifactId&gt;commons-lang&lt;/artifactId&gt; &lt;version&gt;2.6&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;commons-logging&lt;/groupId&gt; &lt;artifactId&gt;commons-logging&lt;/artifactId&gt; &lt;version&gt;1.1.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.zxing&lt;/groupId&gt; &lt;artifactId&gt;core&lt;/artifactId&gt; &lt;version&gt;2.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt; &lt;artifactId&gt;gson&lt;/artifactId&gt; &lt;version&gt;2.3.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.hamcrest&lt;/groupId&gt; &lt;artifactId&gt;hamcrest-core&lt;/artifactId&gt; &lt;version&gt;1.3&lt;/version&gt; &lt;/dependency&gt; &lt;!-- geelynote maven的核心插件之-complier插件默认只支持编译Java 1.4，因此需要加上支持高版本jre的配置，在pom.xml里面加上 增加编译插件 --&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;configuration&gt; &lt;source&gt;1.7&lt;/source&gt; &lt;target&gt;1.7&lt;/target&gt; &lt;encoding&gt;UTF-8&lt;/encoding&gt; &lt;compilerArguments&gt; &lt;extdirs&gt;${project.basedir}/src/main/webapp/WEB-INF/lib&lt;/extdirs&gt; &lt;/compilerArguments&gt; &lt;/configuration&gt; &lt;/plugin&gt; 将Demo中alipay.demo.trade包以及其中的两个类拷贝到你的项目中，用来测试配置正不正确。在运行Main方法测试之前，先将支付宝的jar包引入下。 我项目中关于支付宝当面付的接口主要有三个“pay.do”，”query_order_pay_status.do”和“alipay_callback.do”,pay.do是用来根据项目订单，向支付宝发起下单请求，而alipay_callback.do是用来接收支付宝的回调信息，“query_order_pay_status.do”是用来查询订单的支付状态。 各位把这三个接口对应到第一张业务流程图就会很清楚这几个接口的明确作用了。 以上几个接口的实现几乎都是根据官方Demo和自己的项目需求进行修改出来的，所以各位只需根据自己的项目需求，在Demo中寻找自己需要的功能，并对Demo源码进行分析了解就可以了。 以查询订单为例： // 测试当面付2.0查询订单 public void test_trade_query() { // (必填) 商户订单号，通过此商户订单号查询当面付的交易状态 String outTradeNo = &quot;tradepay14817938139942440181&quot;; // 创建查询请求builder，设置请求参数 AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder() .setOutTradeNo(outTradeNo); AlipayF2FQueryResult result = tradeService.queryTradeResult(builder); switch (result.getTradeStatus()) { case SUCCESS: log.info(&quot;查询返回该订单支付成功: )&quot;); AlipayTradeQueryResponse response = result.getResponse(); dumpResponse(response); log.info(response.getTradeStatus()); if (Utils.isListNotEmpty(response.getFundBillList())) { for (TradeFundBill bill : response.getFundBillList()) { log.info(bill.getFundChannel() + &quot;:&quot; + bill.getAmount()); } } break; case FAILED: log.error(&quot;查询返回该订单支付失败或被关闭!!!&quot;); break; case UNKNOWN: log.error(&quot;系统异常，订单支付状态未知!!!&quot;); break; default: log.error(&quot;不支持的交易状态，交易返回异常!!!&quot;); break; } } 上述代码是Demo中Main.java中的案例，如果我们项目中需要查询订单的接口，那么我们可以直接将它拿过来，将“outTradeNo ”改为我们传入的订单号，然后其他的日志以及异常按照自己的需求进行修改就可以了… 实际上整个对接过程中最花时间的是查看官方文档了解需要重点注意的一些点，然后配置调通Demo，就这两个便占了70%的时间，其余30%的时间便是你自己真正设计编码的时间。 并不是说这70%的时间无用，因为只有当你根据文档和Demo了解清楚后，你剩下30%的时间才能轻松完成你的设计以及编码。 emmmmmmm，后面第4节真正接入写的有点敷衍。每个人的项目需求不同，侧重点也不同。即使我把我项目的相关代码贴出来讲，可能也不是各位想要的，我只是希望给各位讲一下我个人对于接入支付宝当面付的思想过程。 如果想看我接入的详细源码，请直接点击查看 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/11/19/6f04e085e35f1db8a4ca813594ea656d.html","headline":"JavaSSM接入支付宝当面付（扫码支付）","dateModified":"2017-11-19T00:00:00+08:00","datePublished":"2017-11-19T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/11/19/6f04e085e35f1db8a4ca813594ea656d.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>JavaSSM接入支付宝当面付（扫码支付）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <blockquote> 
   <p>最近做的项目的支付模块需要对接支付宝的当面付，刚做完，想把整个过程以及需要注意的一些点整理罗列下，于是便想着写一写。</p> 
  </blockquote> 
  <p><strong>接入的大体思路及过程</strong></p> 
  <ol> 
   <li>查看支付宝当面付官方文档（<a href="https://docs.open.alipay.com/194" rel="nofollow">https://docs.open.alipay.com/194</a>）</li> 
   <li>通过支付宝提供的沙箱环境调试测试（<a href="https://openhome.alipay.com/platform/appDaily.htm?tab=info" rel="nofollow">支付宝沙箱环境</a>）</li> 
   <li>调试通官方提供的Demo（<a href="https://docs.open.alipay.com/194/105201/" rel="nofollow">https://docs.open.alipay.com/194/105201/</a>）</li> 
   <li>根据Demo分析整个处理流程，以及需要重点注意的点</li> 
   <li>根据官方文档和Demo将当面付集成到自己的项目中</li> 
  </ol> 
  <p><strong>一、支付宝当面付官方文档</strong> <br> 题外话：阿里的文档是真的很详细，因此避免了很多坑，所以有不懂的一般翻翻文档就大概知道了。</p> 
  <p>好了，不说废话了，根据支付宝的官方文档我们首先要了解的是整个<strong>业务流程</strong>： <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119111946980?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>以及用户的<strong>使用流程</strong>：</p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119112937390?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>以上两个都是官方文档提供的图，文档中都有说，我就不复述了。</p> 
  <p>实际上对接到项目中，属于我们项目本身的处理逻辑主要集中是下图红框内的流程：</p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119113752479?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""> <br> 以我的项目为例： <br> 系统通过用户订单向支付宝后台发起下单请求–》支付宝后台收到请求并返回订单数据以及二维码–》系统后台接受并处理支付宝的返回数据–》向用户展示二维码–》用户通过支付宝进行扫码操作–》支付宝回调支付数据–》系统后台进行处理 <br> emm，感觉我这个例子太乱的同学可以直接无视=。 =</p> 
  <p>整个支付宝当面付中需要<strong>重点注意</strong>的有两点：</p> 
  <p><strong>1. 密钥的配置</strong> <br> 关于支付宝密钥的解释和流程请参考（<a href="https://docs.open.alipay.com/194/106078/" rel="nofollow">扫码支付接入指引</a> ）中的“配置应用 ” <br> 支付宝的密钥有两种：“RSA2(SHA256)密钥”和“RSA(SHA1)密钥”，官方推荐的是“RSA2(SHA256)密钥”，而我使用的也是官方推荐的 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119120031588?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>下面我将叙述密钥的<strong>配置</strong>（RSA2(SHA256)密钥）<strong>过程</strong>： <br> 以下操作均在沙箱环境操作，没有沙箱环境的请务必创建沙箱环境（<a href="https://openhome.alipay.com/platform/appDaily.htm?tab=info" rel="nofollow">支付宝沙箱环境</a>）</p> 
  <p>因为需要生成RSA密钥，所以需要用支付宝提供一键生成工具生成一对RSA密钥（<a href="https://docs.open.alipay.com/291/105971" rel="nofollow">生成RSA密钥</a>）</p> 
  <p>我的系统是windows的，所以用密钥生成工具的过程是这样的:</p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119173037483?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>生成密钥后，将“商户应用公钥”复制到沙箱应用下的“RSA2(SHA256)密钥”设置中。</p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119184744371?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""> <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119184800556?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>保存后系统会生成“支付宝公钥”，可直接点击“查看支付宝公钥”查看。另外，“商户应用私钥”请自行保存，因为后面会用到。</p> 
  <blockquote> 
   <p>PS：密钥的配置是对交易数据进行双方校验，所以请务必配置正确。</p> 
  </blockquote> 
  <p><strong>2.避免单边账</strong> <br> 以下均引用官方文档（<a href="https://docs.open.alipay.com/194/105322/" rel="nofollow">避免单边账</a>）：</p> 
  <blockquote> 
   <p>一，单边帐是指对于一笔交易，商户端和用户端的结果不一致，分为两种情况： <br> 1.1 商户资损单边账：用户实际未付款成功，但商户系统判定支付成功；或用户支付成功后，商户系统由于逻辑问题发起了撤销。 <br> 1.2 用户资损单边账：用户付款成功，但商户系统未得到支付成功的结果，误认为付款失败，再次扫用户付款码发起支付，导致用户多支付了一笔。在用户手机网络不好的情况下，支付成功后用户手机不一定会显示支付成功页面，用户自己也不知道已经付成功了。这种情况在小额场景下尤其容易出现，且难以发现，需要商户和系统商特别注意。</p> 
   <p>二，为了避免单边帐，建议商户和系统商采取以下措施： <br> 2.1. 每一笔交易一定要闭环，即要么支付成功，要么撤销交易，一定不能有交易一直停留在等待用户付款的状态。 <br> 2.2 轮询+撤销的流程中，如轮询的结果一直为未付款，撤销一定要紧接着最后一次查询，当中不能有时间间隔。 <br> 2.3 门店收银系统应该具备独立的手动查询功能作为兜底，输入商户订单号（可从用户手机账单中获得）调用支付宝查询接口获得确切的支付状态。 <br> 2.4 当遇到网络超时和未知异常时，参考异常处理流程正确处理，对于每一笔交易或退款，一定要得到确切的结果。 <br> 2.5 撤销接口调用成功后，需要在收银台页面为收银员展示撤销成功的强提示文案，且按实际业务情况引导收银员进行手工订单查询。如果撤销接口没有明确返回处理结果，如遇到网络超时或支付宝未知异常等情况，则需要在收银台提示文案中表明，撤销正在处理中；若该笔订单已经支付则后续会有发生退款的可能，并和用户做好线下沟通。 <br> 2.6 对于经过轮询和撤销仍然无法确认结果的（例如系统故障或门店断网），应上报总部IT或财务，由IT（从系统内）或财务（从支付宝后台），确认支付结果后，通过后台发起退款。或让顾客查询手机支付宝账单，如顾客手机没网络，可拨打支付宝客服热线95188确认支付结果。 <br> 2.7 在上述基础上，业务流程培训时应强调支付结果必须以商户端为准，用户手机上的支付宝结果或账单只能做参考，不能作为最终识别标准。如果商户未正确处理业务逻辑和业务流程培训，存在潜在的风险，商户自行承担因此而产生的所有损失。</p> 
  </blockquote> 
  <p>官方文档叙述的已经足够清楚了，我就不造轮子了，各位重点注意便可。</p> 
  <p><strong>二、沙箱环境调试测试</strong></p> 
  <blockquote> 
   <p>支付宝沙箱是支付宝官方提供的沙箱测试环境，里面提供了支付宝的部分功能，但相对来说够用了。</p> 
  </blockquote> 
  <p><a href="https://openhome.alipay.com/platform/appDaily.htm?tab=info" rel="nofollow">支付宝沙箱环境</a> <br> 注册申请完沙箱环境后，系统会自动生成沙箱应用。在上面的密钥配置了，我们的公钥配置就是在沙箱应用中配置的。</p> 
  <p>首先我们先说下”沙箱应用“，因为开发操作也主要围绕”沙箱应用“，下图是沙箱应用的介绍图： <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119192237941?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>图中应用网关因为暂时没用到，所以没有设置，需要关注的主要是密钥配置，其次需要关注的是”授权回调地址”，因为支付宝回调地址要求是外网地址，所以需要进行”内网穿透”，当然你有其他的方法也可以，关于内网穿透，我使用的是”NATAPP”，其他的也有，你们自行按需求配置吧，不做累述。</p> 
  <p>因为后面测试需要下载沙箱工具： <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119195722005?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>沙箱版钱包需要用沙箱帐号登录</p> 
  <p><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119195753703?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>支付宝提供了一个买家和一个卖家的沙箱帐号供我们测试用。</p> 
  <blockquote> 
   <p>为保证沙箱长期稳定，支付宝会在每周日中午12点至每周一中午12点沙箱环境进行维护，期间可能出现不可用。</p> 
  </blockquote> 
  <p><strong>三、当面付官方Demo调试</strong> <br> <a href="https://docs.open.alipay.com/194/105201/" rel="nofollow">支付宝当面付官方Demo</a> <br> 通过下载上面链接内的官方Demo后，将项目引入你的IDE中，我用的是IDEA。</p> 
  <p>引入后可能会因为JDK版本已经jar包问题报错，一般重新配置下JDK和重新引入下jar包就可以了。</p> 
  <p>然后我们就要对Demo的配置文件进行修改了“zfbinfo.properties”</p> 
  <pre class="prettyprint"><code class=" hljs makefile">
<span class="hljs-comment"># 支付宝网关名、partnerId和appId</span>
<span class="hljs-constant">open_api_domain</span> = 填写支付宝网关
<span class="hljs-constant">mcloud_api_domain</span> = http://mcloudmonitor.com/gateway.do
<span class="hljs-constant">pid</span> = 填写沙箱应用中的"商户UID"
<span class="hljs-constant">appid</span> = 填写沙箱应用中的"APPID"

<span class="hljs-comment"># RSA私钥、公钥和支付宝公钥</span>
<span class="hljs-constant">private_key</span> = 填写商户应用私钥
<span class="hljs-constant">public_key</span> = 填写商户应用公钥

<span class="hljs-comment">#SHA1withRsa对应支付宝公钥</span>
<span class="hljs-comment">#alipay_public_key = MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDDI6d306Q8fIfCOaTXyiUeJHkrIvYISRcc73s3vF1ZT7XN8RNPwJxo8pWaJMmvyTn9N4HQ632qJBVHf8sxHi/fEsraprwCtzvzQETrNRwVxLO5jVmRGi60j8Ue1efIlzPXV9je9mkjzOmdssymZkh2QhUrCmZYI/FCEa3/cNMW0QIDAQAB</span>

<span class="hljs-comment">#SHA256withRsa对应支付宝公钥</span>
<span class="hljs-constant">alipay_public_key</span> = 填写支付宝公钥

<span class="hljs-comment"># 签名类型: RSA-&gt;SHA1withRsa,RSA2-&gt;SHA256withRsa</span>
<span class="hljs-constant">sign_type</span> = RSA2
<span class="hljs-comment"># 当面付最大查询次数和查询间隔（毫秒）</span>
<span class="hljs-constant">max_query_retry</span> = 5
<span class="hljs-constant">query_duration</span> = 5000

<span class="hljs-comment"># 当面付最大撤销次数和撤销间隔（毫秒）</span>
<span class="hljs-constant">max_cancel_retry</span> = 3
<span class="hljs-constant">cancel_duration</span> = 2000

<span class="hljs-comment"># 交易保障线程第一次调度延迟和调度间隔（秒）</span>
<span class="hljs-constant">heartbeat_delay</span> = 5
<span class="hljs-constant">heartbeat_duration</span> = 900
</code></pre> 
  <p>需要特别注意配置的是密钥的配置，密钥的生成请参考第一节的密钥配置，千万别配错了，代码中我用中文已经备注好了“填写XXX”，那些是我们要配置的，其他保持默认就可以了。</p> 
  <p>配置完后运行Main方法 <br> 如无异常，运行结果应该是这样子的:</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">36</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.config</span><span class="hljs-preprocessor">.Configs</span> init
信息: 配置文件名: zfbinfo<span class="hljs-preprocessor">.properties</span>
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">36</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.config</span><span class="hljs-preprocessor">.Configs</span> init
信息: Configs{支付宝openapi网关: https://openapi<span class="hljs-preprocessor">.alipaydev</span><span class="hljs-preprocessor">.com</span>/gateway<span class="hljs-preprocessor">.do</span>
, 支付宝mcloudapi网关域名: http://mcloudmonitor<span class="hljs-preprocessor">.com</span>/gateway<span class="hljs-preprocessor">.do</span>
, pid: <span class="hljs-number">2088102172412792</span>
, appid: <span class="hljs-number">2016082100304819</span>
, 商户RSA私钥: MIIEvw******KZYA==
, 商户RSA公钥: MIIBIj******IDAQAB
, 支付宝RSA公钥: MIIBIj******IDAQAB
, 签名类型: RSA2
, 查询重试次数: <span class="hljs-number">5</span>
, 查询间隔(毫秒): <span class="hljs-number">5000</span>
, 撤销尝试次数: <span class="hljs-number">3</span>
, 撤销重试间隔(毫秒): <span class="hljs-number">2000</span>
, 交易保障调度延迟(秒): <span class="hljs-number">5</span>
, 交易保障调度间隔(秒): <span class="hljs-number">900</span>
}
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">36</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.service</span><span class="hljs-preprocessor">.impl</span><span class="hljs-preprocessor">.AbsAlipayTradeService</span> tradePrecreate
信息: trade<span class="hljs-preprocessor">.precreate</span> bizContent:{<span class="hljs-string">"out_trade_no"</span>:<span class="hljs-string">"tradeprecreate15110946363841555882"</span>,<span class="hljs-string">"seller_id"</span>:<span class="hljs-string">""</span>,<span class="hljs-string">"total_amount"</span>:<span class="hljs-string">"0.01"</span>,<span class="hljs-string">"undiscountable_amount"</span>:<span class="hljs-string">"0"</span>,<span class="hljs-string">"subject"</span>:<span class="hljs-string">"xxx品牌xxx门店当面付扫码消费"</span>,<span class="hljs-string">"body"</span>:<span class="hljs-string">"购买商品3件共20.00元"</span>,<span class="hljs-string">"goods_detail"</span>:[{<span class="hljs-string">"goods_id"</span>:<span class="hljs-string">"goods_id001"</span>,<span class="hljs-string">"goods_name"</span>:<span class="hljs-string">"xxx小面包"</span>,<span class="hljs-string">"quantity"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"price"</span>:<span class="hljs-string">"10"</span>},{<span class="hljs-string">"goods_id"</span>:<span class="hljs-string">"goods_id002"</span>,<span class="hljs-string">"goods_name"</span>:<span class="hljs-string">"xxx牙刷"</span>,<span class="hljs-string">"quantity"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"price"</span>:<span class="hljs-string">"5"</span>}],<span class="hljs-string">"operator_id"</span>:<span class="hljs-string">"test_operator_id"</span>,<span class="hljs-string">"store_id"</span>:<span class="hljs-string">"test_store_id"</span>,<span class="hljs-string">"extend_params"</span>:{<span class="hljs-string">"sys_service_provider_id"</span>:<span class="hljs-string">"2088100200300400500"</span>},<span class="hljs-string">"timeout_express"</span>:<span class="hljs-string">"120m"</span>}
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">41</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.service</span><span class="hljs-preprocessor">.impl</span><span class="hljs-preprocessor">.AbsAlipayService</span> getResponse
信息: {<span class="hljs-string">"alipay_trade_precreate_response"</span>:{<span class="hljs-string">"code"</span>:<span class="hljs-string">"10000"</span>,<span class="hljs-string">"msg"</span>:<span class="hljs-string">"Success"</span>,<span class="hljs-string">"out_trade_no"</span>:<span class="hljs-string">"tradeprecreate15110946363841555882"</span>,<span class="hljs-string">"qr_code"</span>:<span class="hljs-string">"https:\/\/qr.alipay.com\/bax07752bxnnqtb3s9dn00ce"</span>},<span class="hljs-string">"sign"</span>:<span class="hljs-string">"yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA=="</span>}
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">41</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.Main</span> test_trade_precreate
信息: 支付宝预下单成功: )
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">41</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.Main</span> dumpResponse
信息: code:<span class="hljs-number">10000</span>, msg:Success
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">41</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.Main</span> dumpResponse
信息: body:{<span class="hljs-string">"alipay_trade_precreate_response"</span>:{<span class="hljs-string">"code"</span>:<span class="hljs-string">"10000"</span>,<span class="hljs-string">"msg"</span>:<span class="hljs-string">"Success"</span>,<span class="hljs-string">"out_trade_no"</span>:<span class="hljs-string">"tradeprecreate15110946363841555882"</span>,<span class="hljs-string">"qr_code"</span>:<span class="hljs-string">"https:\/\/qr.alipay.com\/bax07752bxnnqtb3s9dn00ce"</span>},<span class="hljs-string">"sign"</span>:<span class="hljs-string">"yS0X5NPxoqLesEVTQPxaXUumC48R1rY89GrWpqVbrByElA3uSkSkpyTQ+ggJPVw5Q7/ZxUTJplTMhCnTU2NvsnFyrUYbZriRhFytMVDl24ndj7T6iFvqCjiyfuLdsuVMPByn88Dy7cRjHK2kS025hlTF46fvTB0xLUq/dgSlEdL84XZuyi/l0XvrXqRpwHDNMNPTIx7o7WPwzYMgHAZQPuiHAtZ3+dMnZGceqd1LyXYGF7DQKnpwhI+s16LIwNKWX+BLAB3b6QYTNHX8mOSkH3ixxfnSYpMeq9twMK88fpdw9b7TXxF22ze8wvyXKPOSdMrgpU0iES3TJttYKfTRgA=="</span>}
十一月 <span class="hljs-number">19</span>, <span class="hljs-number">2017</span> <span class="hljs-number">8</span>:<span class="hljs-number">30</span>:<span class="hljs-number">41</span> 下午 <span class="hljs-keyword">com</span><span class="hljs-preprocessor">.alipay</span><span class="hljs-preprocessor">.demo</span><span class="hljs-preprocessor">.trade</span><span class="hljs-preprocessor">.Main</span> test_trade_precreate
信息: filePath:/Users/sudo/Desktop/qr-tradeprecreate15110946363841555882<span class="hljs-preprocessor">.png</span>

Process finished with exit code <span class="hljs-number">0</span></code></pre> 
  <p>状态码返回1000，表示正常。</p> 
  <p><strong>四、将支付宝当面付集成到自己项目中</strong> <br> 首先将Demo中的配置文件以及SDK拷贝到自己项目的相应目录中 <br> <img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20171119204410670?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvZ2l0aHViXzM5MTA0OTc4/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title=""></p> 
  <p>另外还有些通用的jar包，我是通过配置Maven的pom.xml引入的，jar包版本和Demo保持一致，各位可以参考下：</p> 
  <pre class="prettyprint"><code class=" hljs xml"><span class="hljs-comment">&lt;!-- alipay --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.10<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>commons-configuration<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>commons-configuration<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.10<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.6<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.1.1<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.google.zxing<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>core<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.1<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.google.code.gson<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>gson<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.hamcrest<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>hamcrest-core<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.3<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- geelynote maven的核心插件之-complier插件默认只支持编译Java 1.4，因此需要加上支持高版本jre的配置，在pom.xml里面加上 增加编译插件 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">configuration</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">source</span>&gt;</span>1.7<span class="hljs-tag">&lt;/<span class="hljs-title">source</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">target</span>&gt;</span>1.7<span class="hljs-tag">&lt;/<span class="hljs-title">target</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">encoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-title">encoding</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-title">compilerArguments</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">extdirs</span>&gt;</span>${project.basedir}/src/main/webapp/WEB-INF/lib<span class="hljs-tag">&lt;/<span class="hljs-title">extdirs</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-title">compilerArguments</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">configuration</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">plugin</span>&gt;</span></code></pre> 
  <p>将Demo中alipay.demo.trade包以及其中的两个类拷贝到你的项目中，用来测试配置正不正确。在运行Main方法测试之前，先将支付宝的jar包引入下。</p> 
  <p>我项目中关于支付宝当面付的接口主要有三个“pay.do”，”query_order_pay_status.do”和“alipay_callback.do”,pay.do是用来根据项目订单，向支付宝发起下单请求，而alipay_callback.do是用来接收支付宝的回调信息，“query_order_pay_status.do”是用来查询订单的支付状态。 <br> 各位把这三个接口对应到第一张业务流程图就会很清楚这几个接口的明确作用了。</p> 
  <p>以上几个接口的实现几乎都是根据官方Demo和自己的项目需求进行修改出来的，所以各位只需根据自己的项目需求，在Demo中寻找自己需要的功能，并对Demo源码进行分析了解就可以了。</p> 
  <p>以查询订单为例：</p> 
  <pre class="prettyprint"><code class=" hljs mel"><span class="hljs-comment">// 测试当面付2.0查询订单</span>
    public void test_trade_query() {
        <span class="hljs-comment">// (必填) 商户订单号，通过此商户订单号查询当面付的交易状态</span>
        String outTradeNo = <span class="hljs-string">"tradepay14817938139942440181"</span>;

        <span class="hljs-comment">// 创建查询请求builder，设置请求参数</span>
        AlipayTradeQueryRequestBuilder builder = new AlipayTradeQueryRequestBuilder()
            .setOutTradeNo(outTradeNo);

        AlipayF2FQueryResult result = tradeService.queryTradeResult(builder);
        <span class="hljs-keyword">switch</span> (result.getTradeStatus()) {
            <span class="hljs-keyword">case</span> SUCCESS:
                <span class="hljs-keyword">log</span>.info(<span class="hljs-string">"查询返回该订单支付成功: )"</span>);

                AlipayTradeQueryResponse response = result.getResponse();
                dumpResponse(response);

                <span class="hljs-keyword">log</span>.info(response.getTradeStatus());
                <span class="hljs-keyword">if</span> (Utils.isListNotEmpty(response.getFundBillList())) {
                    <span class="hljs-keyword">for</span> (TradeFundBill bill : response.getFundBillList()) {
                        <span class="hljs-keyword">log</span>.info(bill.getFundChannel() + <span class="hljs-string">":"</span> + bill.getAmount());
                    }
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> FAILED:
                <span class="hljs-keyword">log</span>.<span class="hljs-keyword">error</span>(<span class="hljs-string">"查询返回该订单支付失败或被关闭!!!"</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> UNKNOWN:
                <span class="hljs-keyword">log</span>.<span class="hljs-keyword">error</span>(<span class="hljs-string">"系统异常，订单支付状态未知!!!"</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">log</span>.<span class="hljs-keyword">error</span>(<span class="hljs-string">"不支持的交易状态，交易返回异常!!!"</span>);
                <span class="hljs-keyword">break</span>;
        }
    }</code></pre> 
  <p>上述代码是Demo中Main.java中的案例，如果我们项目中需要查询订单的接口，那么我们可以直接将它拿过来，将“outTradeNo ”改为我们传入的订单号，然后其他的日志以及异常按照自己的需求进行修改就可以了…</p> 
  <p>实际上整个对接过程中最花时间的是查看官方文档了解需要重点注意的一些点，然后配置调通Demo，就这两个便占了70%的时间，其余30%的时间便是你自己真正设计编码的时间。</p> 
  <p>并不是说这70%的时间无用，因为只有当你根据文档和Demo了解清楚后，你剩下30%的时间才能轻松完成你的设计以及编码。</p> 
  <p>emmmmmmm，后面第4节真正接入写的有点敷衍。每个人的项目需求不同，侧重点也不同。即使我把我项目的相关代码贴出来讲，可能也不是各位想要的，我只是希望给各位讲一下我个人对于接入支付宝当面付的思想过程。</p> 
  <p>如果想看我接入的<a href="https://gitee.com/zsmsy_admin/mmall/tree/master/src/main" rel="nofollow">详细源码</a>，请直接点击查看</p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/github_39104978/article/details/78574928,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/github_39104978/article/details/78574928,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
