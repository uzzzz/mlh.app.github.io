<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>geth结构解析和源码分析 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="geth结构解析和源码分析" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="第一部分 看看geth客户端的整体结构 创建私链的时候已经指定所有的信息都放在private-geth目录下，现在是已经有过挖矿的目录。 当时我们把创世文件genesis.json放在该目录下了、 root@i-5tthrr8u:/home/ubuntu/private-geth# ll total 16 drwxr-xr-x 3 root root 4096 Jul 2 17:02 ./ drwxr-xr-x 6 ubuntu ubuntu 4096 Jul 4 14:07 ../ drwx------ 5 root root 4096 Jul 2 17:41 data/ -rw-r--r-- 1 root root 529 Jul 2 16:29 genesis.json 进入真正的存放数据的目录private-geth/data/00 geth中保存的是区块链的相关数据 keystore中保存的是该链条中的用户信息 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00# ll total 20 drwx------ 4 root root 4096 Jul 2 17:23 ./ drwx------ 5 root root 4096 Jul 2 17:41 ../ drwxr-xr-x 5 root root 4096 Jul 2 17:02 geth/ -rw------- 1 root root 1391 Jul 2 17:58 history drwx------ 2 root root 4096 Jul 2 17:10 keystore/ 之前我们这个节点已经创建了两个账户，现在我们可以看到keystore里面有两个账户信息的文件 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/keystore# ll total 16 drwx------ 2 root root 4096 Jul 2 17:10 ./ drwx------ 4 root root 4096 Jul 2 17:23 ../ -rw------- 1 root root 491 Jul 2 17:02 UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 -rw------- 1 root root 491 Jul 2 17:10 UTC--2017-07-02T09-10-28.087401309Z--b4e2e2514eae3684157bf34a0cee2c07c431cf92 每个账户都由一对钥匙定义，一个私钥和一个公钥。 账户以地址为索引，地址由公钥衍生而来，取公钥的最后 20个字节。每对私钥 /地址都编码在一个钥匙文件里。钥匙文件是JSON文本文件，可以用任何文本编辑器打开和浏览。钥匙文件的关键部分，账户私钥，通常用你创建帐户时设置的密码进行加密。钥匙文件的文件名格式为UTC。账号列出时是按字母顺序排列，但是由于时间戳格式，实际上它是按创建顺序排列。如果把秘钥丢了钥匙文件可以在以太坊节点数据目录的keystore子目录下找到，接下来我们进入一个keystore目录文件看看他的信息： root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/keystore# vim UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 {&quot;address&quot;:&quot;28b769b3b9109afd1e9e50a9312c5a3bfae8a699&quot;, &quot;crypto&quot;:{ &quot;cipher&quot;:&quot;aes-128-ctr&quot;, &quot;ciphertext&quot;:&quot;89ce1513b4b5a325735891b559c361ce696bb2c173a7a1b290549e79dad8f847&quot;, &quot;cipherparams&quot;:{&quot;iv&quot;:&quot;982c86418fae2dd39e04d1e51528cffa&quot;}, &quot;kdf&quot;:&quot;scrypt&quot;, &quot;kdfparams&quot;:{&quot;dklen&quot;:32,&quot;n&quot;:262144,&quot;p&quot;:1,&quot;r&quot;:8,&quot;salt&quot;:&quot;4227384ea0e3d15af1bac190f7e01d392543d0a5ca1ec931c1d340f87845f771&quot;}, &quot;mac&quot;:&quot;46cffc6e4f57fa27b69e53dc4ae43a03ce1b93f24c132aa4655f53ddf215f112&quot;}, &quot;id&quot;:&quot;e516b9d4-2161-4648-b3db-fc2ef1c3739c&quot;, &quot;version&quot;:3 } 警告：记住密码并”备份钥匙文件”。为了从账号发送交易，包括发送以太币，你必须同时有钥匙文件和密码。确保钥匙文件有个备份并牢记密码，尽可能安全地存储它们。这里没有逃亡路径，如果钥匙文件丢失或忘记密码，就会丢失所有的以太币。没有密码不可能进入账号，也没有忘记密码选项。所以一定不要忘记密码。 接下来进入geth可以看到chaindata，lightchaindata，nodes目录 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth# ll total 24 drwxr-xr-x 5 root root 4096 Jul 2 17:02 ./ drwx------ 4 root root 4096 Jul 2 17:23 ../ drwxr-xr-x 2 root root 4096 Jul 4 14:12 chaindata/ drwxr-xr-x 2 root root 4096 Jul 2 17:02 lightchaindata/ -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw------- 1 root root 64 Jul 2 17:02 nodekey drwxr-xr-x 2 root root 4096 Jul 4 15:55 nodes/ 进入nodes（我们这条私链有三个节点，所以这里有三个ldb文件） root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/nodes# ll total 5316 drwxr-xr-x 2 root root 4096 Jul 4 15:55 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 405250 Jul 4 15:57 000033.log -rw-r--r-- 1 root root 2132979 Jul 4 15:55 000035.ldb -rw-r--r-- 1 root root 2131238 Jul 4 15:55 000036.ldb -rw-r--r-- 1 root root 739354 Jul 4 15:55 000037.ldb -rw-r--r-- 1 root root 16 Jul 4 14:12 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 8187 Jul 4 15:55 LOG -rw-r--r-- 1 root root 4557 Jul 4 15:55 MANIFEST-000013 进入chaindata，区块链最后的本地存储都是以ldb文件的形势（但这里是不是应该每个区块一个ldb文件呢？） root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/chaindata# ll total 52 drwxr-xr-x 2 root root 4096 Jul 5 09:51 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 5288 Jul 2 17:56 000008.ldb -rw-r--r-- 1 root root 11681 Jul 4 14:12 000009.ldb -rw-r--r-- 1 root root 8921 Jul 4 14:13 000010.log -rw-r--r-- 1 root root 16 Jul 4 14:12 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 2807 Jul 4 14:12 LOG -rw-r--r-- 1 root root 346 Jul 4 14:12 MANIFEST-000011 进入Lightchaindata root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/lightchaindata# ll total 24 drwxr-xr-x 2 root root 4096 Jul 2 17:02 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 1237 Jul 2 17:02 000001.log -rw-r--r-- 1 root root 16 Jul 2 17:02 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 358 Jul 2 17:02 LOG -rw-r--r-- 1 root root 54 Jul 2 17:02 MANIFEST-000000 第二部分 看看源码的结构 1 Core/types/block.go 首先看到的是一个区块的结构 // Block represents an entire block in the Ethereum blockchain. type Block struct { header *Header uncles []*Header transactions Transactions // caches hash和size字段是cache之用，避免多次 hash/sign导致性能损失 hash atomic.Value size atomic.Value // Td is used by package core to store the total difficulty // of the chain up to and including the block.挖矿难度 td *big.Int // These fields are used by package eth to track // inter-peer block relay. ReceivedAt time.Time ReceivedFrom interface{} } 这是一个区块体的结构，区块体是动态的存储数据的，主要包含了交易列表和uncle列表 // Body is a simple (mutable, non-safe) data container for storing and moving // a block&#39;s data contents (transactions and uncles) together. type Body struct { Transactions []*Transaction Uncles []*Header } 区块头的结构体，里面的参数我们都很熟悉就不解释了 // Header represents a block header in the Ethereum blockchain. type Header struct { ParentHash common.Hash `json:&quot;parentHash&quot; gencodec:&quot;required&quot;` UncleHash common.Hash `json:&quot;sha3Uncles&quot; gencodec:&quot;required&quot;` Coinbase common.Address `json:&quot;miner&quot; gencodec:&quot;required&quot;` Root common.Hash `json:&quot;stateRoot&quot; gencodec:&quot;required&quot;` TxHash common.Hash `json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;` ReceiptHash common.Hash `json:&quot;receiptsRoot&quot; gencodec:&quot;required&quot;` Bloom Bloom `json:&quot;logsBloom&quot; gencodec:&quot;required&quot;` Difficulty *big.Int `json:&quot;difficulty&quot; gencodec:&quot;required&quot;` Number *big.Int `json:&quot;number&quot; gencodec:&quot;required&quot;` GasLimit *big.Int `json:&quot;gasLimit&quot; gencodec:&quot;required&quot;` GasUsed *big.Int `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;` Time *big.Int `json:&quot;timestamp&quot; gencodec:&quot;required&quot;` Extra []byte `json:&quot;extraData&quot; gencodec:&quot;required&quot;` MixDigest common.Hash `json:&quot;mixHash&quot; gencodec:&quot;required&quot;` Nonce BlockNonce `json:&quot;nonce&quot; gencodec:&quot;required&quot;` } 2 这是一个交易的结构体 Core/types/transaction.go 1ContractTransaction的区别在于：Recipient == nil ； 2. Transaction能以RLP算法进行Encode和Decode； 3. hash/size/from字段是cache之用，避免多次 hash/sign导致性能损失； type Transaction struct { data txdata // caches hash atomic.Value size atomic.Value from atomic.Value } type txdata struct { AccountNonce uint64 `json:&quot;nonce&quot; gencodec:&quot;required&quot;` Price *big.Int `json:&quot;gasPrice&quot; gencodec:&quot;required&quot;` GasLimit *big.Int `json:&quot;gas&quot; gencodec:&quot;required&quot;` Recipient *common.Address `json:&quot;to&quot; rlp:&quot;nil&quot;` // nil means contract creation Amount *big.Int `json:&quot;value&quot; gencodec:&quot;required&quot;` Payload []byte `json:&quot;input&quot; gencodec:&quot;required&quot;` // Signature values 签名 V *big.Int `json:&quot;v&quot; gencodec:&quot;required&quot;` R *big.Int `json:&quot;r&quot; gencodec:&quot;required&quot;` S *big.Int `json:&quot;s&quot; gencodec:&quot;required&quot;` // This is only used when marshaling to JSON. Hash *common.Hash `json:&quot;hash&quot; rlp:&quot;-&quot;` } 3 Receiptroot我们刚刚在区块头有看到，那他具体包含的是什么呢？它是一个交易的结果，主要包括了poststate,交易所花费的gas,bloom和logs // Receipt represents the results of a transaction. type Receipt struct { // Consensus fields PostState []byte `json:&quot;root&quot; gencodec:&quot;required&quot;` CumulativeGasUsed *big.Int `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;` Bloom Bloom `json:&quot;logsBloom&quot; gencodec:&quot;required&quot;` Logs []*Log `json:&quot;logs&quot; gencodec:&quot;required&quot;` // Implementation fields (don&#39;t reorder!) TxHash common.Hash `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;` ContractAddress common.Address `json:&quot;contractAddress&quot;` GasUsed *big.Int `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;` } 4 一个个交易被打包到区块上面，那区块又是怎么变成去快链的呢？ Core/blockchain.go // BlockChain represents the canonical chain given a database with a genesis block. The Blockchain manages chain imports, reverts, chain reorganisations. // Importing blocks in to the block chain happens according to the set of rules defined by the two stage Validator. （需要两个阶段的验证）Processing of blocks is done using the Processor which processes the included transaction.（第一阶段交易的验证） The validation of the state is done in the second part of the Validator.（第二阶段state的验证） Failing results in aborting of the import. // The BlockChain also helps in returning blocks from **any** chain included in the database as well as blocks that represents the canonical chain. It&#39;s important to note that GetBlock can return any block and does not need to be included in the canonical one where as GetBlockByNumber always represents the canonical chain. type BlockChain struct { config *params.ChainConfig // chain &amp; network configuration hc *HeaderChain chainDb **ethdb**.Database 本地数据库 eventMux *event.TypeMux genesisBlock *types.Block mu sync.RWMutex // global mutex for locking chain operations chainmu sync.RWMutex // blockchain insertion lock procmu sync.RWMutex // block processor lock checkpoint int // checkpoint counts towards the new checkpoint currentBlock *types.Block // Current head of the block chain currentFastBlock *types.Block // Current head of the fast-sync chain (may be above the block chain!) stateCache *state.StateDB // State database to reuse between imports (contains state cache) bodyCache *lru.Cache // Cache for the most recent block bodies bodyRLPCache *lru.Cache // Cache for the most recent block bodies in RLP encoded format blockCache *lru.Cache // Cache for the most recent entire blocks futureBlocks *lru.Cache // future blocks are blocks added for later processing quit chan struct{} // blockchain quit channel running int32 // running must be called atomically // procInterrupt must be atomically called procInterrupt int32 // interrupt signaler for block processing wg sync.WaitGroup // chain processing wait group for shutting down engine consensus.Engine processor Processor // block processor interface validator Validator // block and state validator interface vmConfig vm.Config badBlocks *lru.Cache // Bad block cache } 注意：1. BlockChain无结构化查询需求，仅Hash查询， Key/Value数据库最方便； 2. 低层用LevelDB存储，性能好 5 stateDB用来存储世界状态 Core/state/statedb.go // StateDBs within the ethereum protocol are used to store anything // within the merkle trie. StateDBs take care of caching and storing // nested states. It&#39;s the general query interface to retrieve: // * Contracts // * Accounts type StateDB struct { db ethdb.Database //本地数据库 trie *trie.SecureTrie pastTries []*trie.SecureTrie codeSizeCache *lru.Cache // This map holds &#39;live&#39; objects, which will get modified while processing a state transition. stateObjects map[common.Address]*stateObject stateObjectsDirty map[common.Address]struct{} stateObjectsDestructed map[common.Address]struct{} // The refund counter, also used by state transitioning. refund *big.Int thash, bhash common.Hash txIndex int logs map[common.Hash][]*types.Log logSize uint preimages map[common.Hash][]byte // Journal of state modifications. This is the backbone of // Snapshot and RevertToSnapshot. journal journal validRevisions []revision nextRevisionId int lock sync.Mutex } 注意：1. StateDB完整记录Transaction的执行情况； 2. StateDB的重点是StateObjects； 3. StateDB中的 stateObjects，Account的Address为 key，记录其Balance、nonce、code、codeHash ，以及tire中的 {string:Hash}等信息； 那我们接下来看看stateObject结构体 Core/state/state_object.go // stateObject represents an Ethereum account which is being modified. // // The usage pattern is as follows: // First you need to obtain a state object. // Account values can be accessed and modified through the object. // Finally, call CommitTrie to write the modified storage trie into a database. type stateObject struct { address common.Address // Ethereum address of this account data Account db *StateDB // DB error. // State objects are used by the consensus core and VM which are // unable to deal with database-level errors. Any error that occurs // during a database read is memoized here and will eventually be returned // by StateDB.Commit. dbErr error // Write caches. trie *trie.SecureTrie // storage trie, which becomes non-nil on first access code Code // contract bytecode, which gets set when code is loaded cachedStorage Storage // Storage entry cache to avoid duplicate reads dirtyStorage Storage // Storage entries that need to be flushed to disk // Cache flags. // When an object is marked suicided it will be delete from the trie // during the &quot;update&quot; phase of the state transition. dirtyCode bool // true if the code was updated suicided bool touched bool deleted bool onDirty func(addr common.Address) // Callback method to mark a state object newly dirty } 再看看state的一个接口，可以查看账户的余额，nonce，代码和storage // ChainStateReader wraps access to the state trie of the canonical blockchain. Note that implementations of the interface may be unable to return state values for old blocks. // In many cases, using CallContract can be preferable to reading raw contract storage. type ChainStateReader interface { BalanceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (*big.Int, error) StorageAt(ctx context.Context, account common.Address, key common.Hash, blockNumber *big.Int) ([]byte, error) CodeAt(ctx context.Context, account common.Address, blockNumber *big.Int) ([]byte, error) NonceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (uint64, error) } 所有的结构凑明朗了，那具体的验证过程是怎么样的呢 Core/state_processor.go Core/state_transition.go Core/block_validator.go StateProcessor 1. 调用StateTransition，验证（执行）Transaction； 2. 计算Gas、Recipt、Uncle Reward // StateProcessor is a basic Processor, which takes care of transitioning // state from one point to another. // // StateProcessor implements Processor. type StateProcessor struct { config *params.ChainConfig // Chain configuration options bc *BlockChain // Canonical block chain engine consensus.Engine // Consensus engine used for block rewards } StateTransition 1. 验证（执行）Transaction； 3. 扣除transaction.data.payload计算数据所需要消耗的gas； 4. 在vm中执行code（生成contract or 执行contract）；vm执 行过程中，其gas会被自动消耗。如果gas不足，vm会自 选退出； 5. 将多余的gas退回到sender.balance中； 6. 将消耗的gas换成balance加到当前env.Coinbase()中； /* The State Transitioning Model A state transition is a change made when a transaction is applied to the current world state The state transitioning model does all all the necessary work to work out a valid new state root. 1) Nonce handling 2) Pre pay gas 3) Create a new state object if the recipient is \0*32 4) Value transfer == If contract creation == 4a) Attempt to run transaction data 4b) If valid, use result as code for the new state object == end == 5) Run Script section 6) Derive new state root */ type StateTransition struct { gp *GasPool msg Message gas uint64 gasPrice *big.Int initialGas *big.Int value *big.Int data []byte state vm.StateDB evm *vm.EVM } BlockValidator 1. 验证UsedGas 2. 验证Bloom 3. 验证receiptSha 4. 验证stateDB.IntermediateRoot // BlockValidator is responsible for validating block headers, uncles and // processed state. // // BlockValidator implements Validator. type BlockValidator struct { config *params.ChainConfig // Chain configuration options bc *BlockChain // Canonical block chain engine consensus.Engine // Consensus engine used for validating } 可以注意到刚才的state和block都是写进db数据库的，那我们看一下leveldb数据库结构 type LDBDatabase struct { fn string // filename for reporting db *leveldb.DB // LevelDB instance getTimer gometrics.Timer // Timer for measuring the database get request counts and latencies putTimer gometrics.Timer // Timer for measuring the database put request counts and latencies delTimer gometrics.Timer // Timer for measuring the database delete request counts and latencies missMeter gometrics.Meter // Meter for measuring the missed database get requests readMeter gometrics.Meter // Meter for measuring the database get request data usage writeMeter gometrics.Meter // Meter for measuring the database put request data usage compTimeMeter gometrics.Meter // Meter for measuring the total time spent in database compaction compReadMeter gometrics.Meter // Meter for measuring the data read during compaction compWriteMeter gometrics.Meter // Meter for measuring the data written during compaction quitLock sync.Mutex // Mutex protecting the quit channel access quitChan chan chan error // Quit channel to stop the metrics collection before closing the database log log.Logger // Contextual logger tracking the database path } type Database interface { Put(key []byte, value []byte) error Get(key []byte) ([]byte, error) Delete(key []byte) error Close() NewBatch() Batch } 阅读更多" />
<meta property="og:description" content="第一部分 看看geth客户端的整体结构 创建私链的时候已经指定所有的信息都放在private-geth目录下，现在是已经有过挖矿的目录。 当时我们把创世文件genesis.json放在该目录下了、 root@i-5tthrr8u:/home/ubuntu/private-geth# ll total 16 drwxr-xr-x 3 root root 4096 Jul 2 17:02 ./ drwxr-xr-x 6 ubuntu ubuntu 4096 Jul 4 14:07 ../ drwx------ 5 root root 4096 Jul 2 17:41 data/ -rw-r--r-- 1 root root 529 Jul 2 16:29 genesis.json 进入真正的存放数据的目录private-geth/data/00 geth中保存的是区块链的相关数据 keystore中保存的是该链条中的用户信息 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00# ll total 20 drwx------ 4 root root 4096 Jul 2 17:23 ./ drwx------ 5 root root 4096 Jul 2 17:41 ../ drwxr-xr-x 5 root root 4096 Jul 2 17:02 geth/ -rw------- 1 root root 1391 Jul 2 17:58 history drwx------ 2 root root 4096 Jul 2 17:10 keystore/ 之前我们这个节点已经创建了两个账户，现在我们可以看到keystore里面有两个账户信息的文件 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/keystore# ll total 16 drwx------ 2 root root 4096 Jul 2 17:10 ./ drwx------ 4 root root 4096 Jul 2 17:23 ../ -rw------- 1 root root 491 Jul 2 17:02 UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 -rw------- 1 root root 491 Jul 2 17:10 UTC--2017-07-02T09-10-28.087401309Z--b4e2e2514eae3684157bf34a0cee2c07c431cf92 每个账户都由一对钥匙定义，一个私钥和一个公钥。 账户以地址为索引，地址由公钥衍生而来，取公钥的最后 20个字节。每对私钥 /地址都编码在一个钥匙文件里。钥匙文件是JSON文本文件，可以用任何文本编辑器打开和浏览。钥匙文件的关键部分，账户私钥，通常用你创建帐户时设置的密码进行加密。钥匙文件的文件名格式为UTC。账号列出时是按字母顺序排列，但是由于时间戳格式，实际上它是按创建顺序排列。如果把秘钥丢了钥匙文件可以在以太坊节点数据目录的keystore子目录下找到，接下来我们进入一个keystore目录文件看看他的信息： root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/keystore# vim UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 {&quot;address&quot;:&quot;28b769b3b9109afd1e9e50a9312c5a3bfae8a699&quot;, &quot;crypto&quot;:{ &quot;cipher&quot;:&quot;aes-128-ctr&quot;, &quot;ciphertext&quot;:&quot;89ce1513b4b5a325735891b559c361ce696bb2c173a7a1b290549e79dad8f847&quot;, &quot;cipherparams&quot;:{&quot;iv&quot;:&quot;982c86418fae2dd39e04d1e51528cffa&quot;}, &quot;kdf&quot;:&quot;scrypt&quot;, &quot;kdfparams&quot;:{&quot;dklen&quot;:32,&quot;n&quot;:262144,&quot;p&quot;:1,&quot;r&quot;:8,&quot;salt&quot;:&quot;4227384ea0e3d15af1bac190f7e01d392543d0a5ca1ec931c1d340f87845f771&quot;}, &quot;mac&quot;:&quot;46cffc6e4f57fa27b69e53dc4ae43a03ce1b93f24c132aa4655f53ddf215f112&quot;}, &quot;id&quot;:&quot;e516b9d4-2161-4648-b3db-fc2ef1c3739c&quot;, &quot;version&quot;:3 } 警告：记住密码并”备份钥匙文件”。为了从账号发送交易，包括发送以太币，你必须同时有钥匙文件和密码。确保钥匙文件有个备份并牢记密码，尽可能安全地存储它们。这里没有逃亡路径，如果钥匙文件丢失或忘记密码，就会丢失所有的以太币。没有密码不可能进入账号，也没有忘记密码选项。所以一定不要忘记密码。 接下来进入geth可以看到chaindata，lightchaindata，nodes目录 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth# ll total 24 drwxr-xr-x 5 root root 4096 Jul 2 17:02 ./ drwx------ 4 root root 4096 Jul 2 17:23 ../ drwxr-xr-x 2 root root 4096 Jul 4 14:12 chaindata/ drwxr-xr-x 2 root root 4096 Jul 2 17:02 lightchaindata/ -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw------- 1 root root 64 Jul 2 17:02 nodekey drwxr-xr-x 2 root root 4096 Jul 4 15:55 nodes/ 进入nodes（我们这条私链有三个节点，所以这里有三个ldb文件） root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/nodes# ll total 5316 drwxr-xr-x 2 root root 4096 Jul 4 15:55 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 405250 Jul 4 15:57 000033.log -rw-r--r-- 1 root root 2132979 Jul 4 15:55 000035.ldb -rw-r--r-- 1 root root 2131238 Jul 4 15:55 000036.ldb -rw-r--r-- 1 root root 739354 Jul 4 15:55 000037.ldb -rw-r--r-- 1 root root 16 Jul 4 14:12 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 8187 Jul 4 15:55 LOG -rw-r--r-- 1 root root 4557 Jul 4 15:55 MANIFEST-000013 进入chaindata，区块链最后的本地存储都是以ldb文件的形势（但这里是不是应该每个区块一个ldb文件呢？） root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/chaindata# ll total 52 drwxr-xr-x 2 root root 4096 Jul 5 09:51 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 5288 Jul 2 17:56 000008.ldb -rw-r--r-- 1 root root 11681 Jul 4 14:12 000009.ldb -rw-r--r-- 1 root root 8921 Jul 4 14:13 000010.log -rw-r--r-- 1 root root 16 Jul 4 14:12 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 2807 Jul 4 14:12 LOG -rw-r--r-- 1 root root 346 Jul 4 14:12 MANIFEST-000011 进入Lightchaindata root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/lightchaindata# ll total 24 drwxr-xr-x 2 root root 4096 Jul 2 17:02 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 1237 Jul 2 17:02 000001.log -rw-r--r-- 1 root root 16 Jul 2 17:02 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 358 Jul 2 17:02 LOG -rw-r--r-- 1 root root 54 Jul 2 17:02 MANIFEST-000000 第二部分 看看源码的结构 1 Core/types/block.go 首先看到的是一个区块的结构 // Block represents an entire block in the Ethereum blockchain. type Block struct { header *Header uncles []*Header transactions Transactions // caches hash和size字段是cache之用，避免多次 hash/sign导致性能损失 hash atomic.Value size atomic.Value // Td is used by package core to store the total difficulty // of the chain up to and including the block.挖矿难度 td *big.Int // These fields are used by package eth to track // inter-peer block relay. ReceivedAt time.Time ReceivedFrom interface{} } 这是一个区块体的结构，区块体是动态的存储数据的，主要包含了交易列表和uncle列表 // Body is a simple (mutable, non-safe) data container for storing and moving // a block&#39;s data contents (transactions and uncles) together. type Body struct { Transactions []*Transaction Uncles []*Header } 区块头的结构体，里面的参数我们都很熟悉就不解释了 // Header represents a block header in the Ethereum blockchain. type Header struct { ParentHash common.Hash `json:&quot;parentHash&quot; gencodec:&quot;required&quot;` UncleHash common.Hash `json:&quot;sha3Uncles&quot; gencodec:&quot;required&quot;` Coinbase common.Address `json:&quot;miner&quot; gencodec:&quot;required&quot;` Root common.Hash `json:&quot;stateRoot&quot; gencodec:&quot;required&quot;` TxHash common.Hash `json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;` ReceiptHash common.Hash `json:&quot;receiptsRoot&quot; gencodec:&quot;required&quot;` Bloom Bloom `json:&quot;logsBloom&quot; gencodec:&quot;required&quot;` Difficulty *big.Int `json:&quot;difficulty&quot; gencodec:&quot;required&quot;` Number *big.Int `json:&quot;number&quot; gencodec:&quot;required&quot;` GasLimit *big.Int `json:&quot;gasLimit&quot; gencodec:&quot;required&quot;` GasUsed *big.Int `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;` Time *big.Int `json:&quot;timestamp&quot; gencodec:&quot;required&quot;` Extra []byte `json:&quot;extraData&quot; gencodec:&quot;required&quot;` MixDigest common.Hash `json:&quot;mixHash&quot; gencodec:&quot;required&quot;` Nonce BlockNonce `json:&quot;nonce&quot; gencodec:&quot;required&quot;` } 2 这是一个交易的结构体 Core/types/transaction.go 1ContractTransaction的区别在于：Recipient == nil ； 2. Transaction能以RLP算法进行Encode和Decode； 3. hash/size/from字段是cache之用，避免多次 hash/sign导致性能损失； type Transaction struct { data txdata // caches hash atomic.Value size atomic.Value from atomic.Value } type txdata struct { AccountNonce uint64 `json:&quot;nonce&quot; gencodec:&quot;required&quot;` Price *big.Int `json:&quot;gasPrice&quot; gencodec:&quot;required&quot;` GasLimit *big.Int `json:&quot;gas&quot; gencodec:&quot;required&quot;` Recipient *common.Address `json:&quot;to&quot; rlp:&quot;nil&quot;` // nil means contract creation Amount *big.Int `json:&quot;value&quot; gencodec:&quot;required&quot;` Payload []byte `json:&quot;input&quot; gencodec:&quot;required&quot;` // Signature values 签名 V *big.Int `json:&quot;v&quot; gencodec:&quot;required&quot;` R *big.Int `json:&quot;r&quot; gencodec:&quot;required&quot;` S *big.Int `json:&quot;s&quot; gencodec:&quot;required&quot;` // This is only used when marshaling to JSON. Hash *common.Hash `json:&quot;hash&quot; rlp:&quot;-&quot;` } 3 Receiptroot我们刚刚在区块头有看到，那他具体包含的是什么呢？它是一个交易的结果，主要包括了poststate,交易所花费的gas,bloom和logs // Receipt represents the results of a transaction. type Receipt struct { // Consensus fields PostState []byte `json:&quot;root&quot; gencodec:&quot;required&quot;` CumulativeGasUsed *big.Int `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;` Bloom Bloom `json:&quot;logsBloom&quot; gencodec:&quot;required&quot;` Logs []*Log `json:&quot;logs&quot; gencodec:&quot;required&quot;` // Implementation fields (don&#39;t reorder!) TxHash common.Hash `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;` ContractAddress common.Address `json:&quot;contractAddress&quot;` GasUsed *big.Int `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;` } 4 一个个交易被打包到区块上面，那区块又是怎么变成去快链的呢？ Core/blockchain.go // BlockChain represents the canonical chain given a database with a genesis block. The Blockchain manages chain imports, reverts, chain reorganisations. // Importing blocks in to the block chain happens according to the set of rules defined by the two stage Validator. （需要两个阶段的验证）Processing of blocks is done using the Processor which processes the included transaction.（第一阶段交易的验证） The validation of the state is done in the second part of the Validator.（第二阶段state的验证） Failing results in aborting of the import. // The BlockChain also helps in returning blocks from **any** chain included in the database as well as blocks that represents the canonical chain. It&#39;s important to note that GetBlock can return any block and does not need to be included in the canonical one where as GetBlockByNumber always represents the canonical chain. type BlockChain struct { config *params.ChainConfig // chain &amp; network configuration hc *HeaderChain chainDb **ethdb**.Database 本地数据库 eventMux *event.TypeMux genesisBlock *types.Block mu sync.RWMutex // global mutex for locking chain operations chainmu sync.RWMutex // blockchain insertion lock procmu sync.RWMutex // block processor lock checkpoint int // checkpoint counts towards the new checkpoint currentBlock *types.Block // Current head of the block chain currentFastBlock *types.Block // Current head of the fast-sync chain (may be above the block chain!) stateCache *state.StateDB // State database to reuse between imports (contains state cache) bodyCache *lru.Cache // Cache for the most recent block bodies bodyRLPCache *lru.Cache // Cache for the most recent block bodies in RLP encoded format blockCache *lru.Cache // Cache for the most recent entire blocks futureBlocks *lru.Cache // future blocks are blocks added for later processing quit chan struct{} // blockchain quit channel running int32 // running must be called atomically // procInterrupt must be atomically called procInterrupt int32 // interrupt signaler for block processing wg sync.WaitGroup // chain processing wait group for shutting down engine consensus.Engine processor Processor // block processor interface validator Validator // block and state validator interface vmConfig vm.Config badBlocks *lru.Cache // Bad block cache } 注意：1. BlockChain无结构化查询需求，仅Hash查询， Key/Value数据库最方便； 2. 低层用LevelDB存储，性能好 5 stateDB用来存储世界状态 Core/state/statedb.go // StateDBs within the ethereum protocol are used to store anything // within the merkle trie. StateDBs take care of caching and storing // nested states. It&#39;s the general query interface to retrieve: // * Contracts // * Accounts type StateDB struct { db ethdb.Database //本地数据库 trie *trie.SecureTrie pastTries []*trie.SecureTrie codeSizeCache *lru.Cache // This map holds &#39;live&#39; objects, which will get modified while processing a state transition. stateObjects map[common.Address]*stateObject stateObjectsDirty map[common.Address]struct{} stateObjectsDestructed map[common.Address]struct{} // The refund counter, also used by state transitioning. refund *big.Int thash, bhash common.Hash txIndex int logs map[common.Hash][]*types.Log logSize uint preimages map[common.Hash][]byte // Journal of state modifications. This is the backbone of // Snapshot and RevertToSnapshot. journal journal validRevisions []revision nextRevisionId int lock sync.Mutex } 注意：1. StateDB完整记录Transaction的执行情况； 2. StateDB的重点是StateObjects； 3. StateDB中的 stateObjects，Account的Address为 key，记录其Balance、nonce、code、codeHash ，以及tire中的 {string:Hash}等信息； 那我们接下来看看stateObject结构体 Core/state/state_object.go // stateObject represents an Ethereum account which is being modified. // // The usage pattern is as follows: // First you need to obtain a state object. // Account values can be accessed and modified through the object. // Finally, call CommitTrie to write the modified storage trie into a database. type stateObject struct { address common.Address // Ethereum address of this account data Account db *StateDB // DB error. // State objects are used by the consensus core and VM which are // unable to deal with database-level errors. Any error that occurs // during a database read is memoized here and will eventually be returned // by StateDB.Commit. dbErr error // Write caches. trie *trie.SecureTrie // storage trie, which becomes non-nil on first access code Code // contract bytecode, which gets set when code is loaded cachedStorage Storage // Storage entry cache to avoid duplicate reads dirtyStorage Storage // Storage entries that need to be flushed to disk // Cache flags. // When an object is marked suicided it will be delete from the trie // during the &quot;update&quot; phase of the state transition. dirtyCode bool // true if the code was updated suicided bool touched bool deleted bool onDirty func(addr common.Address) // Callback method to mark a state object newly dirty } 再看看state的一个接口，可以查看账户的余额，nonce，代码和storage // ChainStateReader wraps access to the state trie of the canonical blockchain. Note that implementations of the interface may be unable to return state values for old blocks. // In many cases, using CallContract can be preferable to reading raw contract storage. type ChainStateReader interface { BalanceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (*big.Int, error) StorageAt(ctx context.Context, account common.Address, key common.Hash, blockNumber *big.Int) ([]byte, error) CodeAt(ctx context.Context, account common.Address, blockNumber *big.Int) ([]byte, error) NonceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (uint64, error) } 所有的结构凑明朗了，那具体的验证过程是怎么样的呢 Core/state_processor.go Core/state_transition.go Core/block_validator.go StateProcessor 1. 调用StateTransition，验证（执行）Transaction； 2. 计算Gas、Recipt、Uncle Reward // StateProcessor is a basic Processor, which takes care of transitioning // state from one point to another. // // StateProcessor implements Processor. type StateProcessor struct { config *params.ChainConfig // Chain configuration options bc *BlockChain // Canonical block chain engine consensus.Engine // Consensus engine used for block rewards } StateTransition 1. 验证（执行）Transaction； 3. 扣除transaction.data.payload计算数据所需要消耗的gas； 4. 在vm中执行code（生成contract or 执行contract）；vm执 行过程中，其gas会被自动消耗。如果gas不足，vm会自 选退出； 5. 将多余的gas退回到sender.balance中； 6. 将消耗的gas换成balance加到当前env.Coinbase()中； /* The State Transitioning Model A state transition is a change made when a transaction is applied to the current world state The state transitioning model does all all the necessary work to work out a valid new state root. 1) Nonce handling 2) Pre pay gas 3) Create a new state object if the recipient is \0*32 4) Value transfer == If contract creation == 4a) Attempt to run transaction data 4b) If valid, use result as code for the new state object == end == 5) Run Script section 6) Derive new state root */ type StateTransition struct { gp *GasPool msg Message gas uint64 gasPrice *big.Int initialGas *big.Int value *big.Int data []byte state vm.StateDB evm *vm.EVM } BlockValidator 1. 验证UsedGas 2. 验证Bloom 3. 验证receiptSha 4. 验证stateDB.IntermediateRoot // BlockValidator is responsible for validating block headers, uncles and // processed state. // // BlockValidator implements Validator. type BlockValidator struct { config *params.ChainConfig // Chain configuration options bc *BlockChain // Canonical block chain engine consensus.Engine // Consensus engine used for validating } 可以注意到刚才的state和block都是写进db数据库的，那我们看一下leveldb数据库结构 type LDBDatabase struct { fn string // filename for reporting db *leveldb.DB // LevelDB instance getTimer gometrics.Timer // Timer for measuring the database get request counts and latencies putTimer gometrics.Timer // Timer for measuring the database put request counts and latencies delTimer gometrics.Timer // Timer for measuring the database delete request counts and latencies missMeter gometrics.Meter // Meter for measuring the missed database get requests readMeter gometrics.Meter // Meter for measuring the database get request data usage writeMeter gometrics.Meter // Meter for measuring the database put request data usage compTimeMeter gometrics.Meter // Meter for measuring the total time spent in database compaction compReadMeter gometrics.Meter // Meter for measuring the data read during compaction compWriteMeter gometrics.Meter // Meter for measuring the data written during compaction quitLock sync.Mutex // Mutex protecting the quit channel access quitChan chan chan error // Quit channel to stop the metrics collection before closing the database log log.Logger // Contextual logger tracking the database path } type Database interface { Put(key []byte, value []byte) error Get(key []byte) ([]byte, error) Delete(key []byte) error Close() NewBatch() Batch } 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/07/05/406c3dd9aa86bfb4f7d883e5db461d5c.html" />
<meta property="og:url" content="https://mlh.app/2017/07/05/406c3dd9aa86bfb4f7d883e5db461d5c.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-07-05T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"第一部分 看看geth客户端的整体结构 创建私链的时候已经指定所有的信息都放在private-geth目录下，现在是已经有过挖矿的目录。 当时我们把创世文件genesis.json放在该目录下了、 root@i-5tthrr8u:/home/ubuntu/private-geth# ll total 16 drwxr-xr-x 3 root root 4096 Jul 2 17:02 ./ drwxr-xr-x 6 ubuntu ubuntu 4096 Jul 4 14:07 ../ drwx------ 5 root root 4096 Jul 2 17:41 data/ -rw-r--r-- 1 root root 529 Jul 2 16:29 genesis.json 进入真正的存放数据的目录private-geth/data/00 geth中保存的是区块链的相关数据 keystore中保存的是该链条中的用户信息 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00# ll total 20 drwx------ 4 root root 4096 Jul 2 17:23 ./ drwx------ 5 root root 4096 Jul 2 17:41 ../ drwxr-xr-x 5 root root 4096 Jul 2 17:02 geth/ -rw------- 1 root root 1391 Jul 2 17:58 history drwx------ 2 root root 4096 Jul 2 17:10 keystore/ 之前我们这个节点已经创建了两个账户，现在我们可以看到keystore里面有两个账户信息的文件 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/keystore# ll total 16 drwx------ 2 root root 4096 Jul 2 17:10 ./ drwx------ 4 root root 4096 Jul 2 17:23 ../ -rw------- 1 root root 491 Jul 2 17:02 UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 -rw------- 1 root root 491 Jul 2 17:10 UTC--2017-07-02T09-10-28.087401309Z--b4e2e2514eae3684157bf34a0cee2c07c431cf92 每个账户都由一对钥匙定义，一个私钥和一个公钥。 账户以地址为索引，地址由公钥衍生而来，取公钥的最后 20个字节。每对私钥 /地址都编码在一个钥匙文件里。钥匙文件是JSON文本文件，可以用任何文本编辑器打开和浏览。钥匙文件的关键部分，账户私钥，通常用你创建帐户时设置的密码进行加密。钥匙文件的文件名格式为UTC。账号列出时是按字母顺序排列，但是由于时间戳格式，实际上它是按创建顺序排列。如果把秘钥丢了钥匙文件可以在以太坊节点数据目录的keystore子目录下找到，接下来我们进入一个keystore目录文件看看他的信息： root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/keystore# vim UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 {&quot;address&quot;:&quot;28b769b3b9109afd1e9e50a9312c5a3bfae8a699&quot;, &quot;crypto&quot;:{ &quot;cipher&quot;:&quot;aes-128-ctr&quot;, &quot;ciphertext&quot;:&quot;89ce1513b4b5a325735891b559c361ce696bb2c173a7a1b290549e79dad8f847&quot;, &quot;cipherparams&quot;:{&quot;iv&quot;:&quot;982c86418fae2dd39e04d1e51528cffa&quot;}, &quot;kdf&quot;:&quot;scrypt&quot;, &quot;kdfparams&quot;:{&quot;dklen&quot;:32,&quot;n&quot;:262144,&quot;p&quot;:1,&quot;r&quot;:8,&quot;salt&quot;:&quot;4227384ea0e3d15af1bac190f7e01d392543d0a5ca1ec931c1d340f87845f771&quot;}, &quot;mac&quot;:&quot;46cffc6e4f57fa27b69e53dc4ae43a03ce1b93f24c132aa4655f53ddf215f112&quot;}, &quot;id&quot;:&quot;e516b9d4-2161-4648-b3db-fc2ef1c3739c&quot;, &quot;version&quot;:3 } 警告：记住密码并”备份钥匙文件”。为了从账号发送交易，包括发送以太币，你必须同时有钥匙文件和密码。确保钥匙文件有个备份并牢记密码，尽可能安全地存储它们。这里没有逃亡路径，如果钥匙文件丢失或忘记密码，就会丢失所有的以太币。没有密码不可能进入账号，也没有忘记密码选项。所以一定不要忘记密码。 接下来进入geth可以看到chaindata，lightchaindata，nodes目录 root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth# ll total 24 drwxr-xr-x 5 root root 4096 Jul 2 17:02 ./ drwx------ 4 root root 4096 Jul 2 17:23 ../ drwxr-xr-x 2 root root 4096 Jul 4 14:12 chaindata/ drwxr-xr-x 2 root root 4096 Jul 2 17:02 lightchaindata/ -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw------- 1 root root 64 Jul 2 17:02 nodekey drwxr-xr-x 2 root root 4096 Jul 4 15:55 nodes/ 进入nodes（我们这条私链有三个节点，所以这里有三个ldb文件） root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/nodes# ll total 5316 drwxr-xr-x 2 root root 4096 Jul 4 15:55 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 405250 Jul 4 15:57 000033.log -rw-r--r-- 1 root root 2132979 Jul 4 15:55 000035.ldb -rw-r--r-- 1 root root 2131238 Jul 4 15:55 000036.ldb -rw-r--r-- 1 root root 739354 Jul 4 15:55 000037.ldb -rw-r--r-- 1 root root 16 Jul 4 14:12 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 8187 Jul 4 15:55 LOG -rw-r--r-- 1 root root 4557 Jul 4 15:55 MANIFEST-000013 进入chaindata，区块链最后的本地存储都是以ldb文件的形势（但这里是不是应该每个区块一个ldb文件呢？） root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/chaindata# ll total 52 drwxr-xr-x 2 root root 4096 Jul 5 09:51 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 5288 Jul 2 17:56 000008.ldb -rw-r--r-- 1 root root 11681 Jul 4 14:12 000009.ldb -rw-r--r-- 1 root root 8921 Jul 4 14:13 000010.log -rw-r--r-- 1 root root 16 Jul 4 14:12 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 2807 Jul 4 14:12 LOG -rw-r--r-- 1 root root 346 Jul 4 14:12 MANIFEST-000011 进入Lightchaindata root@i-5tthrr8u:/home/ubuntu/private-geth/data/00/geth/lightchaindata# ll total 24 drwxr-xr-x 2 root root 4096 Jul 2 17:02 ./ drwxr-xr-x 5 root root 4096 Jul 2 17:02 ../ -rw-r--r-- 1 root root 1237 Jul 2 17:02 000001.log -rw-r--r-- 1 root root 16 Jul 2 17:02 CURRENT -rw-r--r-- 1 root root 0 Jul 2 17:02 LOCK -rw-r--r-- 1 root root 358 Jul 2 17:02 LOG -rw-r--r-- 1 root root 54 Jul 2 17:02 MANIFEST-000000 第二部分 看看源码的结构 1 Core/types/block.go 首先看到的是一个区块的结构 // Block represents an entire block in the Ethereum blockchain. type Block struct { header *Header uncles []*Header transactions Transactions // caches hash和size字段是cache之用，避免多次 hash/sign导致性能损失 hash atomic.Value size atomic.Value // Td is used by package core to store the total difficulty // of the chain up to and including the block.挖矿难度 td *big.Int // These fields are used by package eth to track // inter-peer block relay. ReceivedAt time.Time ReceivedFrom interface{} } 这是一个区块体的结构，区块体是动态的存储数据的，主要包含了交易列表和uncle列表 // Body is a simple (mutable, non-safe) data container for storing and moving // a block&#39;s data contents (transactions and uncles) together. type Body struct { Transactions []*Transaction Uncles []*Header } 区块头的结构体，里面的参数我们都很熟悉就不解释了 // Header represents a block header in the Ethereum blockchain. type Header struct { ParentHash common.Hash `json:&quot;parentHash&quot; gencodec:&quot;required&quot;` UncleHash common.Hash `json:&quot;sha3Uncles&quot; gencodec:&quot;required&quot;` Coinbase common.Address `json:&quot;miner&quot; gencodec:&quot;required&quot;` Root common.Hash `json:&quot;stateRoot&quot; gencodec:&quot;required&quot;` TxHash common.Hash `json:&quot;transactionsRoot&quot; gencodec:&quot;required&quot;` ReceiptHash common.Hash `json:&quot;receiptsRoot&quot; gencodec:&quot;required&quot;` Bloom Bloom `json:&quot;logsBloom&quot; gencodec:&quot;required&quot;` Difficulty *big.Int `json:&quot;difficulty&quot; gencodec:&quot;required&quot;` Number *big.Int `json:&quot;number&quot; gencodec:&quot;required&quot;` GasLimit *big.Int `json:&quot;gasLimit&quot; gencodec:&quot;required&quot;` GasUsed *big.Int `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;` Time *big.Int `json:&quot;timestamp&quot; gencodec:&quot;required&quot;` Extra []byte `json:&quot;extraData&quot; gencodec:&quot;required&quot;` MixDigest common.Hash `json:&quot;mixHash&quot; gencodec:&quot;required&quot;` Nonce BlockNonce `json:&quot;nonce&quot; gencodec:&quot;required&quot;` } 2 这是一个交易的结构体 Core/types/transaction.go 1ContractTransaction的区别在于：Recipient == nil ； 2. Transaction能以RLP算法进行Encode和Decode； 3. hash/size/from字段是cache之用，避免多次 hash/sign导致性能损失； type Transaction struct { data txdata // caches hash atomic.Value size atomic.Value from atomic.Value } type txdata struct { AccountNonce uint64 `json:&quot;nonce&quot; gencodec:&quot;required&quot;` Price *big.Int `json:&quot;gasPrice&quot; gencodec:&quot;required&quot;` GasLimit *big.Int `json:&quot;gas&quot; gencodec:&quot;required&quot;` Recipient *common.Address `json:&quot;to&quot; rlp:&quot;nil&quot;` // nil means contract creation Amount *big.Int `json:&quot;value&quot; gencodec:&quot;required&quot;` Payload []byte `json:&quot;input&quot; gencodec:&quot;required&quot;` // Signature values 签名 V *big.Int `json:&quot;v&quot; gencodec:&quot;required&quot;` R *big.Int `json:&quot;r&quot; gencodec:&quot;required&quot;` S *big.Int `json:&quot;s&quot; gencodec:&quot;required&quot;` // This is only used when marshaling to JSON. Hash *common.Hash `json:&quot;hash&quot; rlp:&quot;-&quot;` } 3 Receiptroot我们刚刚在区块头有看到，那他具体包含的是什么呢？它是一个交易的结果，主要包括了poststate,交易所花费的gas,bloom和logs // Receipt represents the results of a transaction. type Receipt struct { // Consensus fields PostState []byte `json:&quot;root&quot; gencodec:&quot;required&quot;` CumulativeGasUsed *big.Int `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;` Bloom Bloom `json:&quot;logsBloom&quot; gencodec:&quot;required&quot;` Logs []*Log `json:&quot;logs&quot; gencodec:&quot;required&quot;` // Implementation fields (don&#39;t reorder!) TxHash common.Hash `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;` ContractAddress common.Address `json:&quot;contractAddress&quot;` GasUsed *big.Int `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;` } 4 一个个交易被打包到区块上面，那区块又是怎么变成去快链的呢？ Core/blockchain.go // BlockChain represents the canonical chain given a database with a genesis block. The Blockchain manages chain imports, reverts, chain reorganisations. // Importing blocks in to the block chain happens according to the set of rules defined by the two stage Validator. （需要两个阶段的验证）Processing of blocks is done using the Processor which processes the included transaction.（第一阶段交易的验证） The validation of the state is done in the second part of the Validator.（第二阶段state的验证） Failing results in aborting of the import. // The BlockChain also helps in returning blocks from **any** chain included in the database as well as blocks that represents the canonical chain. It&#39;s important to note that GetBlock can return any block and does not need to be included in the canonical one where as GetBlockByNumber always represents the canonical chain. type BlockChain struct { config *params.ChainConfig // chain &amp; network configuration hc *HeaderChain chainDb **ethdb**.Database 本地数据库 eventMux *event.TypeMux genesisBlock *types.Block mu sync.RWMutex // global mutex for locking chain operations chainmu sync.RWMutex // blockchain insertion lock procmu sync.RWMutex // block processor lock checkpoint int // checkpoint counts towards the new checkpoint currentBlock *types.Block // Current head of the block chain currentFastBlock *types.Block // Current head of the fast-sync chain (may be above the block chain!) stateCache *state.StateDB // State database to reuse between imports (contains state cache) bodyCache *lru.Cache // Cache for the most recent block bodies bodyRLPCache *lru.Cache // Cache for the most recent block bodies in RLP encoded format blockCache *lru.Cache // Cache for the most recent entire blocks futureBlocks *lru.Cache // future blocks are blocks added for later processing quit chan struct{} // blockchain quit channel running int32 // running must be called atomically // procInterrupt must be atomically called procInterrupt int32 // interrupt signaler for block processing wg sync.WaitGroup // chain processing wait group for shutting down engine consensus.Engine processor Processor // block processor interface validator Validator // block and state validator interface vmConfig vm.Config badBlocks *lru.Cache // Bad block cache } 注意：1. BlockChain无结构化查询需求，仅Hash查询， Key/Value数据库最方便； 2. 低层用LevelDB存储，性能好 5 stateDB用来存储世界状态 Core/state/statedb.go // StateDBs within the ethereum protocol are used to store anything // within the merkle trie. StateDBs take care of caching and storing // nested states. It&#39;s the general query interface to retrieve: // * Contracts // * Accounts type StateDB struct { db ethdb.Database //本地数据库 trie *trie.SecureTrie pastTries []*trie.SecureTrie codeSizeCache *lru.Cache // This map holds &#39;live&#39; objects, which will get modified while processing a state transition. stateObjects map[common.Address]*stateObject stateObjectsDirty map[common.Address]struct{} stateObjectsDestructed map[common.Address]struct{} // The refund counter, also used by state transitioning. refund *big.Int thash, bhash common.Hash txIndex int logs map[common.Hash][]*types.Log logSize uint preimages map[common.Hash][]byte // Journal of state modifications. This is the backbone of // Snapshot and RevertToSnapshot. journal journal validRevisions []revision nextRevisionId int lock sync.Mutex } 注意：1. StateDB完整记录Transaction的执行情况； 2. StateDB的重点是StateObjects； 3. StateDB中的 stateObjects，Account的Address为 key，记录其Balance、nonce、code、codeHash ，以及tire中的 {string:Hash}等信息； 那我们接下来看看stateObject结构体 Core/state/state_object.go // stateObject represents an Ethereum account which is being modified. // // The usage pattern is as follows: // First you need to obtain a state object. // Account values can be accessed and modified through the object. // Finally, call CommitTrie to write the modified storage trie into a database. type stateObject struct { address common.Address // Ethereum address of this account data Account db *StateDB // DB error. // State objects are used by the consensus core and VM which are // unable to deal with database-level errors. Any error that occurs // during a database read is memoized here and will eventually be returned // by StateDB.Commit. dbErr error // Write caches. trie *trie.SecureTrie // storage trie, which becomes non-nil on first access code Code // contract bytecode, which gets set when code is loaded cachedStorage Storage // Storage entry cache to avoid duplicate reads dirtyStorage Storage // Storage entries that need to be flushed to disk // Cache flags. // When an object is marked suicided it will be delete from the trie // during the &quot;update&quot; phase of the state transition. dirtyCode bool // true if the code was updated suicided bool touched bool deleted bool onDirty func(addr common.Address) // Callback method to mark a state object newly dirty } 再看看state的一个接口，可以查看账户的余额，nonce，代码和storage // ChainStateReader wraps access to the state trie of the canonical blockchain. Note that implementations of the interface may be unable to return state values for old blocks. // In many cases, using CallContract can be preferable to reading raw contract storage. type ChainStateReader interface { BalanceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (*big.Int, error) StorageAt(ctx context.Context, account common.Address, key common.Hash, blockNumber *big.Int) ([]byte, error) CodeAt(ctx context.Context, account common.Address, blockNumber *big.Int) ([]byte, error) NonceAt(ctx context.Context, account common.Address, blockNumber *big.Int) (uint64, error) } 所有的结构凑明朗了，那具体的验证过程是怎么样的呢 Core/state_processor.go Core/state_transition.go Core/block_validator.go StateProcessor 1. 调用StateTransition，验证（执行）Transaction； 2. 计算Gas、Recipt、Uncle Reward // StateProcessor is a basic Processor, which takes care of transitioning // state from one point to another. // // StateProcessor implements Processor. type StateProcessor struct { config *params.ChainConfig // Chain configuration options bc *BlockChain // Canonical block chain engine consensus.Engine // Consensus engine used for block rewards } StateTransition 1. 验证（执行）Transaction； 3. 扣除transaction.data.payload计算数据所需要消耗的gas； 4. 在vm中执行code（生成contract or 执行contract）；vm执 行过程中，其gas会被自动消耗。如果gas不足，vm会自 选退出； 5. 将多余的gas退回到sender.balance中； 6. 将消耗的gas换成balance加到当前env.Coinbase()中； /* The State Transitioning Model A state transition is a change made when a transaction is applied to the current world state The state transitioning model does all all the necessary work to work out a valid new state root. 1) Nonce handling 2) Pre pay gas 3) Create a new state object if the recipient is \\0*32 4) Value transfer == If contract creation == 4a) Attempt to run transaction data 4b) If valid, use result as code for the new state object == end == 5) Run Script section 6) Derive new state root */ type StateTransition struct { gp *GasPool msg Message gas uint64 gasPrice *big.Int initialGas *big.Int value *big.Int data []byte state vm.StateDB evm *vm.EVM } BlockValidator 1. 验证UsedGas 2. 验证Bloom 3. 验证receiptSha 4. 验证stateDB.IntermediateRoot // BlockValidator is responsible for validating block headers, uncles and // processed state. // // BlockValidator implements Validator. type BlockValidator struct { config *params.ChainConfig // Chain configuration options bc *BlockChain // Canonical block chain engine consensus.Engine // Consensus engine used for validating } 可以注意到刚才的state和block都是写进db数据库的，那我们看一下leveldb数据库结构 type LDBDatabase struct { fn string // filename for reporting db *leveldb.DB // LevelDB instance getTimer gometrics.Timer // Timer for measuring the database get request counts and latencies putTimer gometrics.Timer // Timer for measuring the database put request counts and latencies delTimer gometrics.Timer // Timer for measuring the database delete request counts and latencies missMeter gometrics.Meter // Meter for measuring the missed database get requests readMeter gometrics.Meter // Meter for measuring the database get request data usage writeMeter gometrics.Meter // Meter for measuring the database put request data usage compTimeMeter gometrics.Meter // Meter for measuring the total time spent in database compaction compReadMeter gometrics.Meter // Meter for measuring the data read during compaction compWriteMeter gometrics.Meter // Meter for measuring the data written during compaction quitLock sync.Mutex // Mutex protecting the quit channel access quitChan chan chan error // Quit channel to stop the metrics collection before closing the database log log.Logger // Contextual logger tracking the database path } type Database interface { Put(key []byte, value []byte) error Get(key []byte) ([]byte, error) Delete(key []byte) error Close() NewBatch() Batch } 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/07/05/406c3dd9aa86bfb4f7d883e5db461d5c.html","headline":"geth结构解析和源码分析","dateModified":"2017-07-05T00:00:00+08:00","datePublished":"2017-07-05T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/07/05/406c3dd9aa86bfb4f7d883e5db461d5c.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>geth结构解析和源码分析</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views prism-atom-one-dark"> 
  <!-- flowchart 箭头图标 勿删 --> 
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
   <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
  </svg> 
  <p><strong>第一部分 看看geth客户端的整体结构</strong> <br> 创建私链的时候已经指定所有的信息都放在private-geth目录下，现在是已经有过挖矿的目录。</p> 
  <p>当时我们把创世文件genesis.json放在该目录下了、</p> 
  <pre class="prettyprint"><code class=" hljs livecodeserver">root@i-<span class="hljs-number">5</span>tthrr8u:/home/ubuntu/<span class="hljs-keyword">private</span>-geth<span class="hljs-comment"># ll</span>
total <span class="hljs-number">16</span>
drwxr-xr-x <span class="hljs-number">3</span> root   root   <span class="hljs-number">4096</span> Jul  <span class="hljs-number">2</span> <span class="hljs-number">17</span>:<span class="hljs-number">02</span> ./
drwxr-xr-x <span class="hljs-number">6</span> ubuntu ubuntu <span class="hljs-number">4096</span> Jul  <span class="hljs-number">4</span> <span class="hljs-number">14</span>:<span class="hljs-number">07</span> ../
drwx<span class="hljs-comment">------ 5 root root 4096 Jul 2 17:41 data/</span>
-rw-r<span class="hljs-comment">--r-- 1 root root 529 Jul 2 16:29 genesis.json</span></code></pre> 
  <p>进入真正的存放数据的目录private-geth/data/00 <br> geth中保存的是区块链的相关数据 <br> keystore中保存的是该链条中的用户信息</p> 
  <pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-title">root</span>@i-<span class="hljs-number">5</span>tthrr8u:/home/ubuntu/private-geth/<span class="hljs-typedef"><span class="hljs-keyword">data</span>/00# ll</span>
<span class="hljs-title">total</span> <span class="hljs-number">20</span>
<span class="hljs-title">drwx</span><span class="hljs-comment">------ 4 root root 4096 Jul 2 17:23 ./</span>
<span class="hljs-title">drwx</span><span class="hljs-comment">------ 5 root root 4096 Jul 2 17:41 ../</span>
<span class="hljs-title">drwxr</span>-xr-x <span class="hljs-number">5</span> root root <span class="hljs-number">4096</span> <span class="hljs-type">Jul</span>  <span class="hljs-number">2</span> <span class="hljs-number">17</span>:<span class="hljs-number">02</span> geth/
-rw<span class="hljs-comment">------- 1 root root 1391 Jul 2 17:58 history</span>
<span class="hljs-title">drwx</span><span class="hljs-comment">------ 2 root root 4096 Jul 2 17:10 keystore/</span></code></pre> 
  <p>之前我们这个节点已经创建了两个账户，现在我们可以看到keystore里面有两个账户信息的文件</p> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">root@i</span><span class="hljs-literal">-</span><span class="hljs-comment">5tthrr8u:/home/ubuntu/private</span><span class="hljs-literal">-</span><span class="hljs-comment">geth/data/00/keystore#</span> <span class="hljs-comment">ll</span>
<span class="hljs-comment">total</span> <span class="hljs-comment">16</span>
<span class="hljs-comment">drwx</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">2</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:10</span> <span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-comment">drwx</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">4</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:23</span> <span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">491</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">UTC</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">2017</span><span class="hljs-literal">-</span><span class="hljs-comment">07</span><span class="hljs-literal">-</span><span class="hljs-comment">02T09</span><span class="hljs-literal">-</span><span class="hljs-comment">02</span><span class="hljs-literal">-</span><span class="hljs-comment">56</span><span class="hljs-string">.</span><span class="hljs-comment">470592674Z</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">28b769b3b9109afd1e9e50a9312c5a3bfae8a699</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">491</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:10</span> <span class="hljs-comment">UTC</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">2017</span><span class="hljs-literal">-</span><span class="hljs-comment">07</span><span class="hljs-literal">-</span><span class="hljs-comment">02T09</span><span class="hljs-literal">-</span><span class="hljs-comment">10</span><span class="hljs-literal">-</span><span class="hljs-comment">28</span><span class="hljs-string">.</span><span class="hljs-comment">087401309Z</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">b4e2e2514eae3684157bf34a0cee2c07c431cf92</span></code></pre> 
  <p>每个账户都由一对钥匙定义，一个私钥和一个公钥。 账户以地址为索引，地址由公钥衍生而来，取公钥的最后 20个字节。每对私钥 /地址都编码在一个钥匙文件里。钥匙文件是JSON文本文件，可以用任何文本编辑器打开和浏览。钥匙文件的关键部分，账户私钥，通常用你创建帐户时设置的密码进行加密。钥匙文件的文件名格式为UTC。账号列出时是按字母顺序排列，但是由于时间戳格式，实际上它是按创建顺序排列。如果把秘钥丢了钥匙文件可以在以太坊节点数据目录的keystore子目录下找到，接下来我们进入一个keystore目录文件看看他的信息：</p> 
  <pre class="prettyprint"><code class=" hljs java">root<span class="hljs-annotation">@i</span>-<span class="hljs-number">5</span>tthrr8u:/home/ubuntu/<span class="hljs-keyword">private</span>-geth/data/00/keystore# vim UTC--2017-07-02T09-02-56.470592674Z--28b769b3b9109afd1e9e50a9312c5a3bfae8a699 

{<span class="hljs-string">"address"</span>:<span class="hljs-string">"28b769b3b9109afd1e9e50a9312c5a3bfae8a699"</span>,
<span class="hljs-string">"crypto"</span>:{
<span class="hljs-string">"cipher"</span>:<span class="hljs-string">"aes-128-ctr"</span>,
<span class="hljs-string">"ciphertext"</span>:<span class="hljs-string">"89ce1513b4b5a325735891b559c361ce696bb2c173a7a1b290549e79dad8f847"</span>,
<span class="hljs-string">"cipherparams"</span>:{<span class="hljs-string">"iv"</span>:<span class="hljs-string">"982c86418fae2dd39e04d1e51528cffa"</span>},
<span class="hljs-string">"kdf"</span>:<span class="hljs-string">"scrypt"</span>,
<span class="hljs-string">"kdfparams"</span>:{<span class="hljs-string">"dklen"</span>:<span class="hljs-number">32</span>,<span class="hljs-string">"n"</span>:<span class="hljs-number">262144</span>,<span class="hljs-string">"p"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"r"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"salt"</span>:<span class="hljs-string">"4227384ea0e3d15af1bac190f7e01d392543d0a5ca1ec931c1d340f87845f771"</span>},
<span class="hljs-string">"mac"</span>:<span class="hljs-string">"46cffc6e4f57fa27b69e53dc4ae43a03ce1b93f24c132aa4655f53ddf215f112"</span>},
<span class="hljs-string">"id"</span>:<span class="hljs-string">"e516b9d4-2161-4648-b3db-fc2ef1c3739c"</span>,
<span class="hljs-string">"version"</span>:<span class="hljs-number">3</span>
}</code></pre> 
  <p>警告：记住密码并”备份钥匙文件”。为了从账号发送交易，包括发送以太币，你必须同时有钥匙文件和密码。确保钥匙文件有个备份并牢记密码，尽可能安全地存储它们。这里没有逃亡路径，如果钥匙文件丢失或忘记密码，就会丢失所有的以太币。没有密码不可能进入账号，也没有忘记密码选项。所以一定不要忘记密码。</p> 
  <p>接下来进入geth可以看到chaindata，lightchaindata，nodes目录</p> 
  <pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-title">root</span>@i-<span class="hljs-number">5</span>tthrr8u:/home/ubuntu/private-geth/<span class="hljs-typedef"><span class="hljs-keyword">data</span>/00/geth# ll</span>
<span class="hljs-title">total</span> <span class="hljs-number">24</span>
<span class="hljs-title">drwxr</span>-xr-x <span class="hljs-number">5</span> root root <span class="hljs-number">4096</span> <span class="hljs-type">Jul</span>  <span class="hljs-number">2</span> <span class="hljs-number">17</span>:<span class="hljs-number">02</span> ./
<span class="hljs-title">drwx</span><span class="hljs-comment">------ 4 root root 4096 Jul 2 17:23 ../</span>
<span class="hljs-title">drwxr</span>-xr-x <span class="hljs-number">2</span> root root <span class="hljs-number">4096</span> <span class="hljs-type">Jul</span>  <span class="hljs-number">4</span> <span class="hljs-number">14</span>:<span class="hljs-number">12</span> chaindata/
<span class="hljs-title">drwxr</span>-xr-x <span class="hljs-number">2</span> root root <span class="hljs-number">4096</span> <span class="hljs-type">Jul</span>  <span class="hljs-number">2</span> <span class="hljs-number">17</span>:<span class="hljs-number">02</span> lightchaindata/
-rw-r<span class="hljs-comment">--r-- 1 root root 0 Jul 2 17:02 LOCK</span>
-rw<span class="hljs-comment">------- 1 root root 64 Jul 2 17:02 nodekey</span>
<span class="hljs-title">drwxr</span>-xr-x <span class="hljs-number">2</span> root root <span class="hljs-number">4096</span> <span class="hljs-type">Jul</span>  <span class="hljs-number">4</span> <span class="hljs-number">15</span>:<span class="hljs-number">55</span> nodes/</code></pre> 
  <p>进入nodes（我们这条私链有三个节点，所以这里有三个ldb文件）</p> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">root@i</span><span class="hljs-literal">-</span><span class="hljs-comment">5tthrr8u:/home/ubuntu/private</span><span class="hljs-literal">-</span><span class="hljs-comment">geth/data/00/geth/nodes#</span> <span class="hljs-comment">ll</span>
<span class="hljs-comment">total</span> <span class="hljs-comment">5316</span>
<span class="hljs-comment">drwxr</span><span class="hljs-literal">-</span><span class="hljs-comment">xr</span><span class="hljs-literal">-</span><span class="hljs-comment">x</span> <span class="hljs-comment">2</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>    <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:55</span> <span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-comment">drwxr</span><span class="hljs-literal">-</span><span class="hljs-comment">xr</span><span class="hljs-literal">-</span><span class="hljs-comment">x</span> <span class="hljs-comment">5</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>    <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">405250</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:57</span> <span class="hljs-comment">000033</span><span class="hljs-string">.</span><span class="hljs-comment">log</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">2132979</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:55</span> <span class="hljs-comment">000035</span><span class="hljs-string">.</span><span class="hljs-comment">ldb</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">2131238</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:55</span> <span class="hljs-comment">000036</span><span class="hljs-string">.</span><span class="hljs-comment">ldb</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">739354</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:55</span> <span class="hljs-comment">000037</span><span class="hljs-string">.</span><span class="hljs-comment">ldb</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>      <span class="hljs-comment">16</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">14:12</span> <span class="hljs-comment">CURRENT</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>       <span class="hljs-comment">0</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">LOCK</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>    <span class="hljs-comment">8187</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:55</span> <span class="hljs-comment">LOG</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>    <span class="hljs-comment">4557</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">15:55</span> <span class="hljs-comment">MANIFEST</span><span class="hljs-literal">-</span><span class="hljs-comment">000013</span></code></pre> 
  <p>进入chaindata，区块链最后的本地存储都是以ldb文件的形势（但这里是不是应该每个区块一个ldb文件呢？）</p> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">root@i</span><span class="hljs-literal">-</span><span class="hljs-comment">5tthrr8u:/home/ubuntu/private</span><span class="hljs-literal">-</span><span class="hljs-comment">geth/data/00/geth/chaindata#</span> <span class="hljs-comment">ll</span>
<span class="hljs-comment">total</span> <span class="hljs-comment">52</span>
<span class="hljs-comment">drwxr</span><span class="hljs-literal">-</span><span class="hljs-comment">xr</span><span class="hljs-literal">-</span><span class="hljs-comment">x</span> <span class="hljs-comment">2</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">5</span> <span class="hljs-comment">09:51</span> <span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-comment">drwxr</span><span class="hljs-literal">-</span><span class="hljs-comment">xr</span><span class="hljs-literal">-</span><span class="hljs-comment">x</span> <span class="hljs-comment">5</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">5288</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:56</span> <span class="hljs-comment">000008</span><span class="hljs-string">.</span><span class="hljs-comment">ldb</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">11681</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">14:12</span> <span class="hljs-comment">000009</span><span class="hljs-string">.</span><span class="hljs-comment">ldb</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">8921</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">14:13</span> <span class="hljs-comment">000010</span><span class="hljs-string">.</span><span class="hljs-comment">log</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>    <span class="hljs-comment">16</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">14:12</span> <span class="hljs-comment">CURRENT</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>     <span class="hljs-comment">0</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">LOCK</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">2807</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">14:12</span> <span class="hljs-comment">LOG</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>   <span class="hljs-comment">346</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">4</span> <span class="hljs-comment">14:12</span> <span class="hljs-comment">MANIFEST</span><span class="hljs-literal">-</span><span class="hljs-comment">000011</span></code></pre> 
  <p>进入Lightchaindata</p> 
  <pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">root@i</span><span class="hljs-literal">-</span><span class="hljs-comment">5tthrr8u:/home/ubuntu/private</span><span class="hljs-literal">-</span><span class="hljs-comment">geth/data/00/geth/lightchaindata#</span> <span class="hljs-comment">ll</span>
<span class="hljs-comment">total</span> <span class="hljs-comment">24</span>
<span class="hljs-comment">drwxr</span><span class="hljs-literal">-</span><span class="hljs-comment">xr</span><span class="hljs-literal">-</span><span class="hljs-comment">x</span> <span class="hljs-comment">2</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-comment">drwxr</span><span class="hljs-literal">-</span><span class="hljs-comment">xr</span><span class="hljs-literal">-</span><span class="hljs-comment">x</span> <span class="hljs-comment">5</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">4096</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-string">.</span><span class="hljs-string">.</span><span class="hljs-comment">/</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span> <span class="hljs-comment">1237</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">000001</span><span class="hljs-string">.</span><span class="hljs-comment">log</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>   <span class="hljs-comment">16</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">CURRENT</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>    <span class="hljs-comment">0</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">LOCK</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>  <span class="hljs-comment">358</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">LOG</span>
<span class="hljs-literal">-</span><span class="hljs-comment">rw</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">r</span><span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-comment">1</span> <span class="hljs-comment">root</span> <span class="hljs-comment">root</span>   <span class="hljs-comment">54</span> <span class="hljs-comment">Jul</span>  <span class="hljs-comment">2</span> <span class="hljs-comment">17:02</span> <span class="hljs-comment">MANIFEST</span><span class="hljs-literal">-</span><span class="hljs-comment">000000</span></code></pre> 
  <p><strong>第二部分 看看源码的结构</strong></p> 
  <p>1 Core/types/block.go <br> 首先看到的是一个区块的结构</p> 
  <pre class="prettyprint"><code class=" hljs haskell">// <span class="hljs-type">Block</span> represents an entire block <span class="hljs-keyword">in</span> the <span class="hljs-type">Ethereum</span> blockchain.

<span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">Block</span> struct <span class="hljs-container">{ <span class="hljs-title">header</span> *<span class="hljs-type">Header</span> <span class="hljs-title">uncles</span> []*<span class="hljs-type">Header</span> <span class="hljs-title">transactions</span> <span class="hljs-type">Transactions</span> // <span class="hljs-title">caches</span> <span class="hljs-title">hash</span>和<span class="hljs-title">size</span>字段是<span class="hljs-title">cache</span>之用，避免多次 <span class="hljs-title">hash</span>/<span class="hljs-title">sign</span>导致性能损失 <span class="hljs-title">hash</span> <span class="hljs-title">atomic</span>.<span class="hljs-type">Value</span> <span class="hljs-title">size</span> <span class="hljs-title">atomic</span>.<span class="hljs-type">Value</span> // <span class="hljs-type">Td</span> <span class="hljs-title">is</span> <span class="hljs-title">used</span> <span class="hljs-title">by</span> <span class="hljs-title">package</span> <span class="hljs-title">core</span> <span class="hljs-title">to</span> <span class="hljs-title">store</span> <span class="hljs-title">the</span> <span class="hljs-title">total</span> <span class="hljs-title">difficulty</span> // <span class="hljs-title">of</span> <span class="hljs-title">the</span> <span class="hljs-title">chain</span> <span class="hljs-title">up</span> <span class="hljs-title">to</span> <span class="hljs-title">and</span> <span class="hljs-title">including</span> <span class="hljs-title">the</span> <span class="hljs-title">block</span>.挖矿难度 <span class="hljs-title">td</span> *<span class="hljs-title">big</span>.<span class="hljs-type">Int</span> // <span class="hljs-type">These</span> <span class="hljs-title">fields</span> <span class="hljs-title">are</span> <span class="hljs-title">used</span> <span class="hljs-title">by</span> <span class="hljs-title">package</span> <span class="hljs-title">eth</span> <span class="hljs-title">to</span> <span class="hljs-title">track</span> // <span class="hljs-title">inter</span>-<span class="hljs-title">peer</span> <span class="hljs-title">block</span> <span class="hljs-title">relay</span>. <span class="hljs-type">ReceivedAt</span> <span class="hljs-title">time</span>.<span class="hljs-type">Time</span> <span class="hljs-type">ReceivedFrom</span> <span class="hljs-title">interface</span>{}</span></span>
}</code></pre> 
  <pre class="prettyprint"><code class=" hljs haskell">这是一个区块体的结构，区块体是动态的存储数据的，主要包含了交易列表和uncle列表
// <span class="hljs-type">Body</span> is a simple (mutable, non-<span class="hljs-keyword">safe</span>) <span class="hljs-typedef"><span class="hljs-keyword">data</span> container for storing and moving</span>
// a block's <span class="hljs-typedef"><span class="hljs-keyword">data</span> contents <span class="hljs-container">(<span class="hljs-title">transactions</span> <span class="hljs-title">and</span> <span class="hljs-title">uncles</span>)</span> together.</span>
<span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">Body</span> struct <span class="hljs-container">{ <span class="hljs-type">Transactions</span> []*<span class="hljs-type">Transaction</span> <span class="hljs-type">Uncles</span> []*<span class="hljs-type">Header</span> }</span></span>
</code></pre> 
  <pre class="prettyprint"><code class=" hljs autohotkey">区块头的结构体，里面的参数我们都很熟悉就不解释了
// Header represents <span class="hljs-literal">a</span> block header in the Ethereum blockchain.
type Header struct {
<span class="hljs-label"> ParentHash common.Hash `json:</span><span class="hljs-string">"parentHash"</span>       gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> UncleHash common.Hash `json:</span><span class="hljs-string">"sha3Uncles"</span>       gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Coinbase common.Address `json:</span><span class="hljs-string">"miner"</span>            gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Root common.Hash `json:</span><span class="hljs-string">"stateRoot"</span>        gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> TxHash common.Hash `json:</span><span class="hljs-string">"transactionsRoot"</span> gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> ReceiptHash common.Hash `json:</span><span class="hljs-string">"receiptsRoot"</span>     gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Bloom Bloom `json:</span><span class="hljs-string">"logsBloom"</span>        gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Difficulty *big.Int `json:</span><span class="hljs-string">"difficulty"</span>       gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Number *big.Int `json:</span><span class="hljs-string">"number"</span>           gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> GasLimit *big.Int `json:</span><span class="hljs-string">"gasLimit"</span>         gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> GasUsed *big.Int `json:</span><span class="hljs-string">"gasUsed"</span>          gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Time *big.Int `json:</span><span class="hljs-string">"timestamp"</span>        gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Extra []byte `json:</span><span class="hljs-string">"extraData"</span>        gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> MixDigest common.Hash `json:</span><span class="hljs-string">"mixHash"</span>          gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Nonce BlockNonce `json:</span><span class="hljs-string">"nonce"</span>            gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span>}
</code></pre> 
  <p>2 这是一个交易的结构体 <br> Core/types/transaction.go</p> 
  <pre class="prettyprint"><code class=" hljs coffeescript"><span class="hljs-number">1</span>ContractTransaction的区别在于：Recipient == nil ； <span class="hljs-number">2.</span> Transaction能以RLP算法进行Encode和Decode； <span class="hljs-number">3.</span> hash/size/from字段是cache之用，避免多次 hash/sign导致性能损失；
type Transaction struct {
    data txdata
    <span class="hljs-regexp">//</span> caches
    hash atomic.Value
    size atomic.Value
    from atomic.Value
}

type txdata struct {
    AccountNonce uint64          `<span class="javascript">json:<span class="hljs-string">"nonce"</span> gencodec:<span class="hljs-string">"required"</span></span>`
    Price        *big.Int        `<span class="javascript">json:<span class="hljs-string">"gasPrice"</span> gencodec:<span class="hljs-string">"required"</span></span>`
    GasLimit     *big.Int        `<span class="javascript">json:<span class="hljs-string">"gas"</span> gencodec:<span class="hljs-string">"required"</span></span>`
    Recipient    *common.Address `<span class="javascript">json:<span class="hljs-string">"to"</span> rlp:<span class="hljs-string">"nil"</span></span>` <span class="hljs-regexp">//</span> nil means contract creation
    Amount       *big.Int        `<span class="javascript">json:<span class="hljs-string">"value"</span> gencodec:<span class="hljs-string">"required"</span></span>`
    Payload      []byte          `<span class="javascript">json:<span class="hljs-string">"input"</span> gencodec:<span class="hljs-string">"required"</span></span>`

    <span class="hljs-regexp">//</span> Signature values 签名
    V *big.Int `<span class="javascript">json:<span class="hljs-string">"v"</span> gencodec:<span class="hljs-string">"required"</span></span>`
    R *big.Int `<span class="javascript">json:<span class="hljs-string">"r"</span> gencodec:<span class="hljs-string">"required"</span></span>`
    S *big.Int `<span class="javascript">json:<span class="hljs-string">"s"</span> gencodec:<span class="hljs-string">"required"</span></span>`

    <span class="hljs-regexp">//</span> This <span class="hljs-keyword">is</span> only used <span class="hljs-keyword">when</span> marshaling to JSON.
    Hash *common.Hash `<span class="javascript">json:<span class="hljs-string">"hash"</span> rlp:<span class="hljs-string">"-"</span></span>`
}</code></pre> 
  <p>3 Receiptroot我们刚刚在区块头有看到，那他具体包含的是什么呢？它是一个交易的结果，主要包括了poststate,交易所花费的gas,bloom和logs</p> 
  <pre class="prettyprint"><code class=" hljs autohotkey">
// Receipt represents the results of <span class="hljs-literal">a</span> transaction.
type Receipt struct {
    // Consensus fields
<span class="hljs-label"> PostState []byte `json:</span><span class="hljs-string">"root"</span>              gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> CumulativeGasUsed *big.Int `json:</span><span class="hljs-string">"cumulativeGasUsed"</span> gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Bloom Bloom `json:</span><span class="hljs-string">"logsBloom"</span>         gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> Logs []*Log `json:</span><span class="hljs-string">"logs"</span>              gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span>
    // Implementation fields (don't reorder!)
<span class="hljs-label"> TxHash common.Hash `json:</span><span class="hljs-string">"transactionHash"</span> gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span><span class="hljs-label"> ContractAddress common.Address `json:</span><span class="hljs-string">"contractAddress"</span><span class="hljs-escape">` </span><span class="hljs-label"> GasUsed *big.Int `json:</span><span class="hljs-string">"gasUsed"</span> gencodec:<span class="hljs-string">"required"</span><span class="hljs-escape">` </span>}
</code></pre> 
  <p>4 一个个交易被打包到区块上面，那区块又是怎么变成去快链的呢？ <br> Core/blockchain.go</p> 
  <pre class="prettyprint"><code class=" hljs haskell">// <span class="hljs-type">BlockChain</span> represents the canonical chain given a database with a genesis block. <span class="hljs-type">The</span> <span class="hljs-type">Blockchain</span> manages chain imports, reverts, chain reorganisations.
// <span class="hljs-type">Importing</span> blocks <span class="hljs-keyword">in</span> to the block chain happens according to the set <span class="hljs-keyword">of</span> rules defined by the two stage <span class="hljs-type">Validator</span>. （需要两个阶段的验证）<span class="hljs-type">Processing</span> <span class="hljs-keyword">of</span> blocks is done using the <span class="hljs-type">Processor</span> which processes the included transaction.（第一阶段交易的验证） <span class="hljs-type">The</span> validation <span class="hljs-keyword">of</span> the state is done <span class="hljs-keyword">in</span> the second part <span class="hljs-keyword">of</span> the <span class="hljs-type">Validator</span>.（第二阶段state的验证） <span class="hljs-type">Failing</span> results <span class="hljs-keyword">in</span> aborting <span class="hljs-keyword">of</span> the <span class="hljs-import"><span class="hljs-keyword">import</span>.</span>
// <span class="hljs-type">The</span> <span class="hljs-type">BlockChain</span> also helps <span class="hljs-keyword">in</span> returning blocks from **any** chain included <span class="hljs-keyword">in</span> the database <span class="hljs-keyword">as</span> well <span class="hljs-keyword">as</span> blocks that represents the canonical chain. <span class="hljs-type">It's</span> important to note that <span class="hljs-type">GetBlock</span> can return any block and does not need to be included <span class="hljs-keyword">in</span> the canonical one <span class="hljs-keyword">where</span> <span class="hljs-keyword">as</span> <span class="hljs-type">GetBlockByNumber</span> always represents the canonical chain.


<span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">BlockChain</span> struct <span class="hljs-container">{ <span class="hljs-title">config</span> *<span class="hljs-title">params</span>.<span class="hljs-type">ChainConfig</span> // <span class="hljs-title">chain</span> &amp; <span class="hljs-title">network</span> <span class="hljs-title">configuration</span> <span class="hljs-title">hc</span> *<span class="hljs-type">HeaderChain</span> <span class="hljs-title">chainDb</span> **<span class="hljs-title">ethdb</span>**.<span class="hljs-type">Database</span> 本地数据库 <span class="hljs-title">eventMux</span> *<span class="hljs-title">event</span>.<span class="hljs-type">TypeMux</span> <span class="hljs-title">genesisBlock</span> *<span class="hljs-title">types</span>.<span class="hljs-type">Block</span> <span class="hljs-title">mu</span> <span class="hljs-title">sync</span>.<span class="hljs-type">RWMutex</span> // <span class="hljs-title">global</span> <span class="hljs-title">mutex</span> <span class="hljs-title">for</span> <span class="hljs-title">locking</span> <span class="hljs-title">chain</span> <span class="hljs-title">operations</span> <span class="hljs-title">chainmu</span> <span class="hljs-title">sync</span>.<span class="hljs-type">RWMutex</span> // <span class="hljs-title">blockchain</span> <span class="hljs-title">insertion</span> <span class="hljs-title">lock</span> <span class="hljs-title">procmu</span> <span class="hljs-title">sync</span>.<span class="hljs-type">RWMutex</span> // <span class="hljs-title">block</span> <span class="hljs-title">processor</span> <span class="hljs-title">lock</span> <span class="hljs-title">checkpoint</span> <span class="hljs-title">int</span> // <span class="hljs-title">checkpoint</span> <span class="hljs-title">counts</span> <span class="hljs-title">towards</span> <span class="hljs-title">the</span> <span class="hljs-title">new</span> <span class="hljs-title">checkpoint</span> <span class="hljs-title">currentBlock</span> *<span class="hljs-title">types</span>.<span class="hljs-type">Block</span> // <span class="hljs-type">Current</span> <span class="hljs-title">head</span> <span class="hljs-title">of</span> <span class="hljs-title">the</span> <span class="hljs-title">block</span> <span class="hljs-title">chain</span> <span class="hljs-title">currentFastBlock</span> *<span class="hljs-title">types</span>.<span class="hljs-type">Block</span> // <span class="hljs-type">Current</span> <span class="hljs-title">head</span> <span class="hljs-title">of</span> <span class="hljs-title">the</span> <span class="hljs-title">fast</span>-<span class="hljs-title">sync</span> <span class="hljs-title">chain</span> (<span class="hljs-title">may</span> <span class="hljs-title">be</span> <span class="hljs-title">above</span> <span class="hljs-title">the</span> <span class="hljs-title">block</span> <span class="hljs-title">chain</span>!) <span class="hljs-title">stateCache</span> *<span class="hljs-title">state</span>.<span class="hljs-type">StateDB</span> // <span class="hljs-type">State</span> <span class="hljs-title">database</span> <span class="hljs-title">to</span> <span class="hljs-title">reuse</span> <span class="hljs-title">between</span> <span class="hljs-title">imports</span> (<span class="hljs-title">contains</span> <span class="hljs-title">state</span> <span class="hljs-title">cache</span>) <span class="hljs-title">bodyCache</span> *<span class="hljs-title">lru</span>.<span class="hljs-type">Cache</span> // <span class="hljs-type">Cache</span> <span class="hljs-title">for</span> <span class="hljs-title">the</span> <span class="hljs-title">most</span> <span class="hljs-title">recent</span> <span class="hljs-title">block</span> <span class="hljs-title">bodies</span> <span class="hljs-title">bodyRLPCache</span> *<span class="hljs-title">lru</span>.<span class="hljs-type">Cache</span> // <span class="hljs-type">Cache</span> <span class="hljs-title">for</span> <span class="hljs-title">the</span> <span class="hljs-title">most</span> <span class="hljs-title">recent</span> <span class="hljs-title">block</span> <span class="hljs-title">bodies</span> <span class="hljs-title">in</span> <span class="hljs-type">RLP</span> <span class="hljs-title">encoded</span> <span class="hljs-title">format</span> <span class="hljs-title">blockCache</span> *<span class="hljs-title">lru</span>.<span class="hljs-type">Cache</span> // <span class="hljs-type">Cache</span> <span class="hljs-title">for</span> <span class="hljs-title">the</span> <span class="hljs-title">most</span> <span class="hljs-title">recent</span> <span class="hljs-title">entire</span> <span class="hljs-title">blocks</span> <span class="hljs-title">futureBlocks</span> *<span class="hljs-title">lru</span>.<span class="hljs-type">Cache</span> // <span class="hljs-title">future</span> <span class="hljs-title">blocks</span> <span class="hljs-title">are</span> <span class="hljs-title">blocks</span> <span class="hljs-title">added</span> <span class="hljs-title">for</span> <span class="hljs-title">later</span> <span class="hljs-title">processing</span> <span class="hljs-title">quit</span> <span class="hljs-title">chan</span> <span class="hljs-title">struct</span>{}</span> // blockchain quit channel</span>
    running int32         // running must be called atomically
    // procInterrupt must be atomically called
    procInterrupt int32          // interrupt signaler for block processing
    wg            sync.<span class="hljs-type">WaitGroup</span> // chain processing wait group for shutting down

    engine    consensus.<span class="hljs-type">Engine</span>
    processor <span class="hljs-type">Processor</span> // block processor interface
    validator <span class="hljs-type">Validator</span> // block and state validator interface
    vmConfig  vm.<span class="hljs-type">Config</span>

    badBlocks *lru.<span class="hljs-type">Cache</span> // <span class="hljs-type">Bad</span> block cache
}
</code></pre> 
  <p>注意：1. BlockChain无结构化查询需求，仅Hash查询， Key/Value数据库最方便； 2. 低层用LevelDB存储，性能好</p> 
  <p>5 stateDB用来存储世界状态 <br> Core/state/statedb.go</p> 
  <pre class="prettyprint"><code class=" hljs go"><span class="hljs-comment">// StateDBs within the ethereum protocol are used to store anything</span>
<span class="hljs-comment">// within the merkle trie. StateDBs take care of caching and storing</span>
<span class="hljs-comment">// nested states. It's the general query interface to retrieve:</span>
<span class="hljs-comment">// * Contracts</span>
<span class="hljs-comment">// * Accounts</span>
<span class="hljs-keyword">type</span> StateDB <span class="hljs-keyword">struct</span> {
    db            ethdb.Database <span class="hljs-comment">//本地数据库</span>
    trie          *trie.SecureTrie
    pastTries     []*trie.SecureTrie
    codeSizeCache *lru.Cache

    <span class="hljs-comment">// This map holds 'live' objects, which will get modified while processing a state transition.</span>
    stateObjects           <span class="hljs-keyword">map</span>[common.Address]*stateObject
    stateObjectsDirty      <span class="hljs-keyword">map</span>[common.Address]<span class="hljs-keyword">struct</span>{}
    stateObjectsDestructed <span class="hljs-keyword">map</span>[common.Address]<span class="hljs-keyword">struct</span>{}

    <span class="hljs-comment">// The refund counter, also used by state transitioning.</span>
    refund *big.Int

    thash, bhash common.Hash
    txIndex      <span class="hljs-typename">int</span>
    logs         <span class="hljs-keyword">map</span>[common.Hash][]*types.Log
    logSize      <span class="hljs-typename">uint</span>

    preimages <span class="hljs-keyword">map</span>[common.Hash][]<span class="hljs-typename">byte</span>

    <span class="hljs-comment">// Journal of state modifications. This is the backbone of</span>
    <span class="hljs-comment">// Snapshot and RevertToSnapshot.</span>
    journal        journal
    validRevisions []revision
    nextRevisionId <span class="hljs-typename">int</span>

    lock sync.Mutex
}</code></pre> 
  <p>注意：1. StateDB完整记录Transaction的执行情况； 2. StateDB的重点是StateObjects； 3. StateDB中的 stateObjects，Account的Address为 key，记录其Balance、nonce、code、codeHash ，以及tire中的 {string:Hash}等信息；</p> 
  <p>那我们接下来看看stateObject结构体 <br> Core/state/state_object.go</p> 
  <pre class="prettyprint"><code class=" hljs sql">// stateObject represents an Ethereum account which is being modified.
//
// The usage pattern is as follows:
// First you need to obtain a state object.
// Account values can be accessed and modified through the object.
// Finally, <span class="hljs-operator"><span class="hljs-keyword">call</span> CommitTrie <span class="hljs-keyword">to</span> <span class="hljs-keyword">write</span> the modified storage trie <span class="hljs-keyword">into</span> a <span class="hljs-keyword">database</span>. type stateObject struct { address common.Address // Ethereum address <span class="hljs-keyword">of</span> this account data Account db *StateDB // DB error. // State objects <span class="hljs-keyword">are</span> used <span class="hljs-keyword">by</span> the consensus core <span class="hljs-keyword">and</span> VM which <span class="hljs-keyword">are</span> // unable <span class="hljs-keyword">to</span> deal <span class="hljs-keyword">with</span> <span class="hljs-keyword">database</span>-<span class="hljs-keyword">level</span> errors. <span class="hljs-keyword">Any</span> error that occurs // during a <span class="hljs-keyword">database</span> <span class="hljs-keyword">read</span> <span class="hljs-keyword">is</span> memoized here <span class="hljs-keyword">and</span> will eventually be returned // <span class="hljs-keyword">by</span> StateDB.<span class="hljs-keyword">Commit</span>. dbErr error // <span class="hljs-keyword">Write</span> caches. trie *trie.SecureTrie // storage trie, which becomes non-nil <span class="hljs-keyword">on</span> <span class="hljs-keyword">first</span> access code Code // contract bytecode, which gets <span class="hljs-keyword">set</span> <span class="hljs-keyword">when</span> code <span class="hljs-keyword">is</span> loaded cachedStorage Storage // Storage entry cache <span class="hljs-keyword">to</span> avoid duplicate reads dirtyStorage Storage // Storage entries that need <span class="hljs-keyword">to</span> be flushed <span class="hljs-keyword">to</span> disk // Cache flags. // <span class="hljs-keyword">When</span> an object <span class="hljs-keyword">is</span> marked suicided it will be <span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> the trie // during the <span class="hljs-string">"update"</span> phase <span class="hljs-keyword">of</span> the state transition. dirtyCode bool // <span class="hljs-keyword">true</span> <span class="hljs-keyword">if</span> the code was updated suicided bool touched bool deleted bool onDirty func(addr common.Address) // Callback method <span class="hljs-keyword">to</span> mark a state object newly dirty } </span></code></pre> 
  <p>再看看state的一个接口，可以查看账户的余额，nonce，代码和storage</p> 
  <pre class="prettyprint"><code class=" hljs haskell">// <span class="hljs-type">ChainStateReader</span> wraps access to the state trie <span class="hljs-keyword">of</span> the canonical blockchain. <span class="hljs-type">Note</span> that implementations <span class="hljs-keyword">of</span> the interface may be unable to return state values for old blocks.
// <span class="hljs-type">In</span> many cases, using <span class="hljs-type">CallContract</span> can be preferable to reading raw contract storage.

<span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">ChainStateReader</span> interface <span class="hljs-container">{ <span class="hljs-type">BalanceAt</span>(<span class="hljs-title">ctx</span> <span class="hljs-title">context</span>.<span class="hljs-type">Context</span>, <span class="hljs-title">account</span> <span class="hljs-title">common</span>.<span class="hljs-type">Address</span>, <span class="hljs-title">blockNumber</span> *<span class="hljs-title">big</span>.<span class="hljs-type">Int</span>) (*<span class="hljs-title">big</span>.<span class="hljs-type">Int</span>, <span class="hljs-title">error</span>) <span class="hljs-type">StorageAt</span>(<span class="hljs-title">ctx</span> <span class="hljs-title">context</span>.<span class="hljs-type">Context</span>, <span class="hljs-title">account</span> <span class="hljs-title">common</span>.<span class="hljs-type">Address</span>, <span class="hljs-title">key</span> <span class="hljs-title">common</span>.<span class="hljs-type">Hash</span>, <span class="hljs-title">blockNumber</span> *<span class="hljs-title">big</span>.<span class="hljs-type">Int</span>) ([]<span class="hljs-title">byte</span>, <span class="hljs-title">error</span>) <span class="hljs-type">CodeAt</span>(<span class="hljs-title">ctx</span> <span class="hljs-title">context</span>.<span class="hljs-type">Context</span>, <span class="hljs-title">account</span> <span class="hljs-title">common</span>.<span class="hljs-type">Address</span>, <span class="hljs-title">blockNumber</span> *<span class="hljs-title">big</span>.<span class="hljs-type">Int</span>) ([]<span class="hljs-title">byte</span>, <span class="hljs-title">error</span>) <span class="hljs-type">NonceAt</span>(<span class="hljs-title">ctx</span> <span class="hljs-title">context</span>.<span class="hljs-type">Context</span>, <span class="hljs-title">account</span> <span class="hljs-title">common</span>.<span class="hljs-type">Address</span>, <span class="hljs-title">blockNumber</span> *<span class="hljs-title">big</span>.<span class="hljs-type">Int</span>) (<span class="hljs-title">uint64</span>, <span class="hljs-title">error</span>) }</span></span></code></pre> 
  <p>所有的结构凑明朗了，那具体的验证过程是怎么样的呢 <br> Core/state_processor.go <br> Core/state_transition.go <br> Core/block_validator.go</p> 
  <p>StateProcessor 1. 调用StateTransition，验证（执行）Transaction； 2. 计算Gas、Recipt、Uncle Reward</p> 
  <pre class="prettyprint"><code class=" hljs haskell">// <span class="hljs-type">StateProcessor</span> is a basic <span class="hljs-type">Processor</span>, which takes care <span class="hljs-keyword">of</span> transitioning
// state from one point to another.
//
// <span class="hljs-type">StateProcessor</span> implements <span class="hljs-type">Processor</span>.
<span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">StateProcessor</span> struct <span class="hljs-container">{ <span class="hljs-title">config</span> *<span class="hljs-title">params</span>.<span class="hljs-type">ChainConfig</span> // <span class="hljs-type">Chain</span> <span class="hljs-title">configuration</span> <span class="hljs-title">options</span> <span class="hljs-title">bc</span> *<span class="hljs-type">BlockChain</span> // <span class="hljs-type">Canonical</span> <span class="hljs-title">block</span> <span class="hljs-title">chain</span> <span class="hljs-title">engine</span> <span class="hljs-title">consensus</span>.<span class="hljs-type">Engine</span> // <span class="hljs-type">Consensus</span> <span class="hljs-title">engine</span> <span class="hljs-title">used</span> <span class="hljs-title">for</span> <span class="hljs-title">block</span> <span class="hljs-title">rewards</span> }</span></span>
</code></pre> 
  <p>StateTransition <br> 1. 验证（执行）Transaction； <br> 3. 扣除transaction.data.payload计算数据所需要消耗的gas； <br> 4. 在vm中执行code（生成contract or 执行contract）；vm执 行过程中，其gas会被自动消耗。如果gas不足，vm会自 选退出； <br> 5. 将多余的gas退回到sender.balance中； <br> 6. 将消耗的gas换成balance加到当前env.Coinbase()中；</p> 
  <pre class="prettyprint"><code class=" hljs asciidoc">/*
The State Transitioning Model

A state transition is a change made when a transaction is applied to the current world state
The state transitioning model does all all the necessary work to work out a valid new state root.

1) Nonce handling
2) Pre pay gas
3) Create a new state object if the recipient is \0*32
4) Value transfer
<span class="hljs-header">== If contract creation ==</span>
<span class="hljs-code"> 4a) Attempt to run transaction data</span>
<span class="hljs-code"> 4b) If valid, use result as code for the new state object</span>
<span class="hljs-header">== end ==</span>
5) Run Script section
6) Derive new state root
<span class="hljs-strong">*/ type StateTransition struct { gp *</span>GasPool
<span class="hljs-code"> msg Message</span>
<span class="hljs-code"> gas uint64</span>
<span class="hljs-code"> gasPrice *big.Int</span>
<span class="hljs-code"> initialGas *big.Int</span>
<span class="hljs-code"> value *big.Int</span>
<span class="hljs-code"> data []byte</span>
<span class="hljs-code"> state vm.StateDB</span>

<span class="hljs-code"> evm *vm.EVM</span>
}
</code></pre> 
  <p>BlockValidator <br> 1. 验证UsedGas <br> 2. 验证Bloom <br> 3. 验证receiptSha <br> 4. 验证stateDB.IntermediateRoot</p> 
  <pre class="prettyprint"><code class=" hljs cs"><span class="hljs-comment">// BlockValidator is responsible for validating block headers, uncles and</span>
<span class="hljs-comment">// processed state.</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// BlockValidator implements Validator.</span>
type BlockValidator <span class="hljs-keyword">struct</span> {
    config *<span class="hljs-keyword">params</span>.ChainConfig <span class="hljs-comment">// Chain configuration options</span>
    bc     *BlockChain         <span class="hljs-comment">// Canonical block chain</span>
    engine consensus.Engine    <span class="hljs-comment">// Consensus engine used for validating</span>
}</code></pre> 
  <p>可以注意到刚才的state和block都是写进db数据库的，那我们看一下leveldb数据库结构</p> 
  <pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">LDBDatabase</span> struct <span class="hljs-container">{ <span class="hljs-title">fn</span> <span class="hljs-title">string</span> // <span class="hljs-title">filename</span> <span class="hljs-title">for</span> <span class="hljs-title">reporting</span> <span class="hljs-title">db</span> *<span class="hljs-title">leveldb</span>.<span class="hljs-type">DB</span> // <span class="hljs-type">LevelDB</span> <span class="hljs-title">instance</span> <span class="hljs-title">getTimer</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Timer</span> // <span class="hljs-type">Timer</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">get</span> <span class="hljs-title">request</span> <span class="hljs-title">counts</span> <span class="hljs-title">and</span> <span class="hljs-title">latencies</span> <span class="hljs-title">putTimer</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Timer</span> // <span class="hljs-type">Timer</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">put</span> <span class="hljs-title">request</span> <span class="hljs-title">counts</span> <span class="hljs-title">and</span> <span class="hljs-title">latencies</span> <span class="hljs-title">delTimer</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Timer</span> // <span class="hljs-type">Timer</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">delete</span> <span class="hljs-title">request</span> <span class="hljs-title">counts</span> <span class="hljs-title">and</span> <span class="hljs-title">latencies</span> <span class="hljs-title">missMeter</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Meter</span> // <span class="hljs-type">Meter</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">missed</span> <span class="hljs-title">database</span> <span class="hljs-title">get</span> <span class="hljs-title">requests</span> <span class="hljs-title">readMeter</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Meter</span> // <span class="hljs-type">Meter</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">get</span> <span class="hljs-title">request</span> <span class="hljs-title">data</span> <span class="hljs-title">usage</span> <span class="hljs-title">writeMeter</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Meter</span> // <span class="hljs-type">Meter</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">put</span> <span class="hljs-title">request</span> <span class="hljs-title">data</span> <span class="hljs-title">usage</span> <span class="hljs-title">compTimeMeter</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Meter</span> // <span class="hljs-type">Meter</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">total</span> <span class="hljs-title">time</span> <span class="hljs-title">spent</span> <span class="hljs-title">in</span> <span class="hljs-title">database</span> <span class="hljs-title">compaction</span> <span class="hljs-title">compReadMeter</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Meter</span> // <span class="hljs-type">Meter</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">data</span> <span class="hljs-title">read</span> <span class="hljs-title">during</span> <span class="hljs-title">compaction</span> <span class="hljs-title">compWriteMeter</span> <span class="hljs-title">gometrics</span>.<span class="hljs-type">Meter</span> // <span class="hljs-type">Meter</span> <span class="hljs-title">for</span> <span class="hljs-title">measuring</span> <span class="hljs-title">the</span> <span class="hljs-title">data</span> <span class="hljs-title">written</span> <span class="hljs-title">during</span> <span class="hljs-title">compaction</span> <span class="hljs-title">quitLock</span> <span class="hljs-title">sync</span>.<span class="hljs-type">Mutex</span> // <span class="hljs-type">Mutex</span> <span class="hljs-title">protecting</span> <span class="hljs-title">the</span> <span class="hljs-title">quit</span> <span class="hljs-title">channel</span> <span class="hljs-title">access</span> <span class="hljs-title">quitChan</span> <span class="hljs-title">chan</span> <span class="hljs-title">chan</span> <span class="hljs-title">error</span> // <span class="hljs-type">Quit</span> <span class="hljs-title">channel</span> <span class="hljs-title">to</span> <span class="hljs-title">stop</span> <span class="hljs-title">the</span> <span class="hljs-title">metrics</span> <span class="hljs-title">collection</span> <span class="hljs-title">before</span> <span class="hljs-title">closing</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">log</span> <span class="hljs-title">log</span>.<span class="hljs-type">Logger</span> // <span class="hljs-type">Contextual</span> <span class="hljs-title">logger</span> <span class="hljs-title">tracking</span> <span class="hljs-title">the</span> <span class="hljs-title">database</span> <span class="hljs-title">path</span> }</span></span>
</code></pre> 
  <pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-typedef"><span class="hljs-keyword">type</span> <span class="hljs-type">Database</span> interface <span class="hljs-container">{ <span class="hljs-type">Put</span>(<span class="hljs-title">key</span> []<span class="hljs-title">byte</span>, <span class="hljs-title">value</span> []<span class="hljs-title">byte</span>) <span class="hljs-title">error</span> <span class="hljs-type">Get</span>(<span class="hljs-title">key</span> []<span class="hljs-title">byte</span>) ([]<span class="hljs-title">byte</span>, <span class="hljs-title">error</span>) <span class="hljs-type">Delete</span>(<span class="hljs-title">key</span> []<span class="hljs-title">byte</span>) <span class="hljs-title">error</span> <span class="hljs-type">Close</span>() <span class="hljs-type">NewBatch</span>() <span class="hljs-type">Batch</span> }</span></span></code></pre> 
 </div> 
 <link href="https://csdnimg.cn/release/phoenix/mdeditor/markdown_views-8cccb36679.css" rel="stylesheet"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/DDFFR/article/details/74389051,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/DDFFR/article/details/74389051,&quot;}">阅读更多</a> 
</div> 
<script>
						(function(){
							function setArticleH(btnReadmore,posi){
								var winH = $(window).height();
								var articleBox = $("div.article_content");
								var artH = articleBox.height();
								if(artH > winH*posi){
									articleBox.css({
										'height':winH*posi+'px',
										'overflow':'hidden'
									})
									btnReadmore.click(function(){
										articleBox.removeAttr("style");
										$(this).parent().remove();
									})
								}else{
									btnReadmore.parent().remove();
								}
							}
							var btnReadmore = $("#btn-readmore");
							if(btnReadmore.length>0){
								if(currentUserName){
									setArticleH(btnReadmore,3);
								}else{
									setArticleH(btnReadmore,1.2);
								}
							}
						})()
					</script>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
