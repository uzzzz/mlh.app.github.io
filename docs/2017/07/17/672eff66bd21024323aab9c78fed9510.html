<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>fabric源码解析4——配置系统 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="fabric源码解析4——配置系统" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="fabric源码解析4——配置系统 fabric的配置系统是程序原始数据的来源之一，虽然简单却很重要。在阅读源码过程中对于具象化程序也很有帮助。在分析peer的具体交易工作之前，我们可以先分析一下fabric的配置系统。我们还将我们的目光聚焦在/fabric/peer/main.go的main函数中，除了一系列mainCmd的命令操作，还有viper进行的一系列配置操作，并通过err := common.InitConfig(cmdRoot)进行了配置的初始化。 fabric索取配置的途径有：环境变量，命令行参数，各种格式的配置文件。其中以配置文件为主，环境变量和命令行参数辅助，三者可以相互作用。主要的配置文件有core.yaml，orderer.yaml等，在/fabric/sampleconfig中有示例。主要使用的配置代码集中在/fabric/core/config下。 viper简介 fabric的配置系统主要运用第三方包viper，可在github.com/spf13/viper下载。viper可以对系统环境变量，yaml/json等格式的配置文件甚至是远程配置进行读取和设置，并可以在不重启服务的情况下动态设置新的配置项的值并使之实时生效，是一个专门处理配置的解决方案。 而且，viper，眼镜蛇，称自己与cobra（见peer命令结构一文）是companion，足见使用viper的理由。 viper的基础用法如下： //设置一个要读取的配置文件名（不包含后缀），一个viper只支持一个文件名 viper.SetConfigName(&quot;config&quot;) //设置一个搜索配置文件的路径，viper的搜索路径可以有多个 viper.AddConfigPath(&quot;/etc/appname/&quot;) viper.AddConfigPath(&quot;.&quot;) //读取配置文件 viper.ReadInConfig() //获取其中一个name项的值 viper.Get(&quot;name&quot;) //将name的值设置为Bill viper.Set(&quot;name&quot;, &quot;Bill&quot;) viper搜索路径和文件 peer命令对core.yaml的引入也是通过viper，具体过程如下： /fabric/peer/main.go中定义const cmdRoot = &quot;core&quot;。 main函数中调用err := common.InitConfig(cmdRoot)，该参数一路向下传递。 InitConfig函数在/fabric/peer/common/common.go中定义，其中调用了config.InitViper(nil, cmdRoot)和viper.ReadInConfig()。 InitViper在/fabric/core/config/config.go中定义，接收cmdRoot作为参数，最终调用了viper.SetConfigName()，也即将core设置为了配置文件名。 common.InitConfig(cmdRoot)中的viper.ReadInConfig()则读取了该配置文件 orderer命令则使用orderer.yaml配置文件，由viper引入，具体过程如下： 在/fabric/orderer/main.go中main函数调用了config.Load()。 Load在/fabric/orderer/localconfig/config.go中定义。该文件中定义了Prefix = &quot;ORDERER&quot;和configName string，并在init初始化函数中将configName赋值为strings.ToLower(Prefix)，即orderer，也即所用的配置文件名为orderer。Load函数新建了一个用于orderer自己的viper，并调用了cf.InitViper(config, configName)，其中config参数为新建的用于orderer自身的viper，configName为配置文件名orderer InitViper在/fabric/core/config/config.go中定义，最终调用了viper.SetConfigName()，也即将orderer设置为了配置文件名 Load随后调用了config.ReadInConfig()，读取了配置文件 InitViper 上述步骤中peer和orderer在初始化配置文件时，最终都将调用的终点指向了/fabric/core/config/config.go中定义InitViper()。下面集中分析InitViper。 首先判断环境变量FABRIC_CFG_PATH是否有值，如果有值，则是手工定义了FABRIC的配置文件所在路径。参考Getting Started中关于手工设置export FABRIC_CFG_PATH=$PWD（当前目录）。 若没有定义该环境变量的值，则用代码添加三个路径作为搜索配置文件的路径：当前工作目录，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric。 当前工作目录，调用addConfigPath(v, “./”)添加，其内部调用的是viper.AddConfigPath()。 $GOPATH/src/github.com/hyperledger/fabric/sampleconfig，通过调用AddDevConfigPath(v)添加。 AddDevConfigPath首先调用GetDevConfigDir()，读取 GOPATH路径下是否存在src/github.com/hyperledger/fabric/sampleconfig目录，若存在，则通过filepath.Join拼接 GOPATH和src/github.com/hyperledger/fabric/sampleconfig，形成完整的路径并返回。 AddDevConfigPath接着调用addConfigPath函数，其内部调用的是viper.AddConfigPath()。 /etc/hyperledger/fabric。定义了OfficialPath = “/etc/hyperledger/fabric”常量，如果该路径存在，则调用addConfigPath加入该路径。 调用SetConfigName()设置配置文件名，所指的的配置文件名configName是由参数传递进来的。 由经由InitViper，形成了以下viper配置： 搜索路径（二选一） FABRIC_CFG_PATH指定的路径 ./，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric 搜索的配置文件名 core —— 核心配置，供各个模块使用 orderer —— orderer配置，orderer使用 另外注意InitViper的第一个参数，v *viper.Viper。在InitViper函数中，无论是添加搜索路径（使用的是addConfigPath函数），还是设置要搜索的配置文件名（viper自身的SetConfigName函数），都分为全局的viper和特定的viper（也就是参数v）。最终由viper.AddConfigPath或viper.SetConfigName完成的，则是全局的，由v.AddConfigPath或v.SetConfigName完成的，则是特定的。这样就可以很方便的初始化需要单独使用viper的模块，如orderer就是单独使用一条毒蛇，其在/fabric/orderer/localconfig/config.go中的Load函数中，config := viper.New()新养了一条自己的蛇，然后将此蛇通过参数传给InitViper，cf.InitViper(config, configName)。 安全文件配置 安全配置相关的代码在/fabric/peer/main.go中没有体现，而是在/fabric/peer/node/start.go中的serve函数中才初次出现。若grpc服务中使用了TLS网络，则需要.key，.crt，.ca文件配套文件。在此简略介绍，关于TLS，将会在将来专门的文章中详细介绍。 在/fabric/peer/node/start.go中的serve函数中secureConfig, err := peer.GetSecureConfig()获取安全配置。 使用的安全配置结构为/fabric/core/comm/server.go中定义的SecureServerConfig，用于一个grpc服务端实例。 .key，.crt，.ca文件所在的目录都是在core.yaml中定义都的tls文件夹中，当使用TLS网络时，会读取这些文件的数据到SecureServerConfig对象中。在GetSecureConfig()函数中，使用ioutil.ReadFile读取由/fabric/core/config/config.go中定义的config.GetPath(“…”)函数获取的tls路径下的相应文件。如/etc/hyperledger/fabric/tls/server.crt。 命令选项配置 以peer start命令为例，在/fabric/peer/node/start.go中startCmd()函数中，flags.BoolVarP(&amp;chaincodeDevMode, &quot;peer-chaincodedev&quot;, &quot;&quot;, false,&quot;Whether peer in chaincode development mode&quot;)设置了peer start命令的选项之一为peer-chaincodedev，用于赋值文件中的全局变量chaincodeDevMode，该变量指定了chaincode的模式。chaincode的模式在core.yaml中也有定义，chaincode.mode的值为net，为默认选项。而当执行peer start 命令时指定了选项peer-chaincodedev=true，也即将chaincodeDevMode赋值为true，在serve()函数中，就会使用viper.Set(&quot;chaincode.mode&quot;, chaincode.DevModeUserRunsChaincode)将chaincode的模式值设置成了dev。 环境变量配置 在fabric目前的阶段，各个peer都是在容器中运行的，因此环境变量指的是各个容器中的环境变量。在各个容器的启动脚本中对容器的一些环境变量也进行了设置。在peer-base-no-tls.yaml（见源码解析1——线头）中，如peer容器中，设置了如下环境变量： - CORE_PEER_ADDRESSAUTODETECT=true - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli_default - CORE_LOGGING_LEVEL=ERROR ... 在fabric/peer/main.go中的开始，即对容器的环境变量进行了获取并设置： //设置了环境变量前置，在此也就是peer viper.SetEnvPrefix(cmdRoot) //将环境变量加载进来了 viper.AutomaticEnv() replacer := strings.NewReplacer(&quot;.&quot;, &quot;_&quot;) //将环境变量中的_换成.，这样就和yaml文件的配置相匹配了。 //因为viper读取yaml文件所形成的配置项就是按层级并以.分隔的格式，如peer.address viper.SetEnvKeyReplacer(replacer) 阅读更多" />
<meta property="og:description" content="fabric源码解析4——配置系统 fabric的配置系统是程序原始数据的来源之一，虽然简单却很重要。在阅读源码过程中对于具象化程序也很有帮助。在分析peer的具体交易工作之前，我们可以先分析一下fabric的配置系统。我们还将我们的目光聚焦在/fabric/peer/main.go的main函数中，除了一系列mainCmd的命令操作，还有viper进行的一系列配置操作，并通过err := common.InitConfig(cmdRoot)进行了配置的初始化。 fabric索取配置的途径有：环境变量，命令行参数，各种格式的配置文件。其中以配置文件为主，环境变量和命令行参数辅助，三者可以相互作用。主要的配置文件有core.yaml，orderer.yaml等，在/fabric/sampleconfig中有示例。主要使用的配置代码集中在/fabric/core/config下。 viper简介 fabric的配置系统主要运用第三方包viper，可在github.com/spf13/viper下载。viper可以对系统环境变量，yaml/json等格式的配置文件甚至是远程配置进行读取和设置，并可以在不重启服务的情况下动态设置新的配置项的值并使之实时生效，是一个专门处理配置的解决方案。 而且，viper，眼镜蛇，称自己与cobra（见peer命令结构一文）是companion，足见使用viper的理由。 viper的基础用法如下： //设置一个要读取的配置文件名（不包含后缀），一个viper只支持一个文件名 viper.SetConfigName(&quot;config&quot;) //设置一个搜索配置文件的路径，viper的搜索路径可以有多个 viper.AddConfigPath(&quot;/etc/appname/&quot;) viper.AddConfigPath(&quot;.&quot;) //读取配置文件 viper.ReadInConfig() //获取其中一个name项的值 viper.Get(&quot;name&quot;) //将name的值设置为Bill viper.Set(&quot;name&quot;, &quot;Bill&quot;) viper搜索路径和文件 peer命令对core.yaml的引入也是通过viper，具体过程如下： /fabric/peer/main.go中定义const cmdRoot = &quot;core&quot;。 main函数中调用err := common.InitConfig(cmdRoot)，该参数一路向下传递。 InitConfig函数在/fabric/peer/common/common.go中定义，其中调用了config.InitViper(nil, cmdRoot)和viper.ReadInConfig()。 InitViper在/fabric/core/config/config.go中定义，接收cmdRoot作为参数，最终调用了viper.SetConfigName()，也即将core设置为了配置文件名。 common.InitConfig(cmdRoot)中的viper.ReadInConfig()则读取了该配置文件 orderer命令则使用orderer.yaml配置文件，由viper引入，具体过程如下： 在/fabric/orderer/main.go中main函数调用了config.Load()。 Load在/fabric/orderer/localconfig/config.go中定义。该文件中定义了Prefix = &quot;ORDERER&quot;和configName string，并在init初始化函数中将configName赋值为strings.ToLower(Prefix)，即orderer，也即所用的配置文件名为orderer。Load函数新建了一个用于orderer自己的viper，并调用了cf.InitViper(config, configName)，其中config参数为新建的用于orderer自身的viper，configName为配置文件名orderer InitViper在/fabric/core/config/config.go中定义，最终调用了viper.SetConfigName()，也即将orderer设置为了配置文件名 Load随后调用了config.ReadInConfig()，读取了配置文件 InitViper 上述步骤中peer和orderer在初始化配置文件时，最终都将调用的终点指向了/fabric/core/config/config.go中定义InitViper()。下面集中分析InitViper。 首先判断环境变量FABRIC_CFG_PATH是否有值，如果有值，则是手工定义了FABRIC的配置文件所在路径。参考Getting Started中关于手工设置export FABRIC_CFG_PATH=$PWD（当前目录）。 若没有定义该环境变量的值，则用代码添加三个路径作为搜索配置文件的路径：当前工作目录，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric。 当前工作目录，调用addConfigPath(v, “./”)添加，其内部调用的是viper.AddConfigPath()。 $GOPATH/src/github.com/hyperledger/fabric/sampleconfig，通过调用AddDevConfigPath(v)添加。 AddDevConfigPath首先调用GetDevConfigDir()，读取 GOPATH路径下是否存在src/github.com/hyperledger/fabric/sampleconfig目录，若存在，则通过filepath.Join拼接 GOPATH和src/github.com/hyperledger/fabric/sampleconfig，形成完整的路径并返回。 AddDevConfigPath接着调用addConfigPath函数，其内部调用的是viper.AddConfigPath()。 /etc/hyperledger/fabric。定义了OfficialPath = “/etc/hyperledger/fabric”常量，如果该路径存在，则调用addConfigPath加入该路径。 调用SetConfigName()设置配置文件名，所指的的配置文件名configName是由参数传递进来的。 由经由InitViper，形成了以下viper配置： 搜索路径（二选一） FABRIC_CFG_PATH指定的路径 ./，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric 搜索的配置文件名 core —— 核心配置，供各个模块使用 orderer —— orderer配置，orderer使用 另外注意InitViper的第一个参数，v *viper.Viper。在InitViper函数中，无论是添加搜索路径（使用的是addConfigPath函数），还是设置要搜索的配置文件名（viper自身的SetConfigName函数），都分为全局的viper和特定的viper（也就是参数v）。最终由viper.AddConfigPath或viper.SetConfigName完成的，则是全局的，由v.AddConfigPath或v.SetConfigName完成的，则是特定的。这样就可以很方便的初始化需要单独使用viper的模块，如orderer就是单独使用一条毒蛇，其在/fabric/orderer/localconfig/config.go中的Load函数中，config := viper.New()新养了一条自己的蛇，然后将此蛇通过参数传给InitViper，cf.InitViper(config, configName)。 安全文件配置 安全配置相关的代码在/fabric/peer/main.go中没有体现，而是在/fabric/peer/node/start.go中的serve函数中才初次出现。若grpc服务中使用了TLS网络，则需要.key，.crt，.ca文件配套文件。在此简略介绍，关于TLS，将会在将来专门的文章中详细介绍。 在/fabric/peer/node/start.go中的serve函数中secureConfig, err := peer.GetSecureConfig()获取安全配置。 使用的安全配置结构为/fabric/core/comm/server.go中定义的SecureServerConfig，用于一个grpc服务端实例。 .key，.crt，.ca文件所在的目录都是在core.yaml中定义都的tls文件夹中，当使用TLS网络时，会读取这些文件的数据到SecureServerConfig对象中。在GetSecureConfig()函数中，使用ioutil.ReadFile读取由/fabric/core/config/config.go中定义的config.GetPath(“…”)函数获取的tls路径下的相应文件。如/etc/hyperledger/fabric/tls/server.crt。 命令选项配置 以peer start命令为例，在/fabric/peer/node/start.go中startCmd()函数中，flags.BoolVarP(&amp;chaincodeDevMode, &quot;peer-chaincodedev&quot;, &quot;&quot;, false,&quot;Whether peer in chaincode development mode&quot;)设置了peer start命令的选项之一为peer-chaincodedev，用于赋值文件中的全局变量chaincodeDevMode，该变量指定了chaincode的模式。chaincode的模式在core.yaml中也有定义，chaincode.mode的值为net，为默认选项。而当执行peer start 命令时指定了选项peer-chaincodedev=true，也即将chaincodeDevMode赋值为true，在serve()函数中，就会使用viper.Set(&quot;chaincode.mode&quot;, chaincode.DevModeUserRunsChaincode)将chaincode的模式值设置成了dev。 环境变量配置 在fabric目前的阶段，各个peer都是在容器中运行的，因此环境变量指的是各个容器中的环境变量。在各个容器的启动脚本中对容器的一些环境变量也进行了设置。在peer-base-no-tls.yaml（见源码解析1——线头）中，如peer容器中，设置了如下环境变量： - CORE_PEER_ADDRESSAUTODETECT=true - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli_default - CORE_LOGGING_LEVEL=ERROR ... 在fabric/peer/main.go中的开始，即对容器的环境变量进行了获取并设置： //设置了环境变量前置，在此也就是peer viper.SetEnvPrefix(cmdRoot) //将环境变量加载进来了 viper.AutomaticEnv() replacer := strings.NewReplacer(&quot;.&quot;, &quot;_&quot;) //将环境变量中的_换成.，这样就和yaml文件的配置相匹配了。 //因为viper读取yaml文件所形成的配置项就是按层级并以.分隔的格式，如peer.address viper.SetEnvKeyReplacer(replacer) 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-07-17T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"fabric源码解析4——配置系统 fabric的配置系统是程序原始数据的来源之一，虽然简单却很重要。在阅读源码过程中对于具象化程序也很有帮助。在分析peer的具体交易工作之前，我们可以先分析一下fabric的配置系统。我们还将我们的目光聚焦在/fabric/peer/main.go的main函数中，除了一系列mainCmd的命令操作，还有viper进行的一系列配置操作，并通过err := common.InitConfig(cmdRoot)进行了配置的初始化。 fabric索取配置的途径有：环境变量，命令行参数，各种格式的配置文件。其中以配置文件为主，环境变量和命令行参数辅助，三者可以相互作用。主要的配置文件有core.yaml，orderer.yaml等，在/fabric/sampleconfig中有示例。主要使用的配置代码集中在/fabric/core/config下。 viper简介 fabric的配置系统主要运用第三方包viper，可在github.com/spf13/viper下载。viper可以对系统环境变量，yaml/json等格式的配置文件甚至是远程配置进行读取和设置，并可以在不重启服务的情况下动态设置新的配置项的值并使之实时生效，是一个专门处理配置的解决方案。 而且，viper，眼镜蛇，称自己与cobra（见peer命令结构一文）是companion，足见使用viper的理由。 viper的基础用法如下： //设置一个要读取的配置文件名（不包含后缀），一个viper只支持一个文件名 viper.SetConfigName(&quot;config&quot;) //设置一个搜索配置文件的路径，viper的搜索路径可以有多个 viper.AddConfigPath(&quot;/etc/appname/&quot;) viper.AddConfigPath(&quot;.&quot;) //读取配置文件 viper.ReadInConfig() //获取其中一个name项的值 viper.Get(&quot;name&quot;) //将name的值设置为Bill viper.Set(&quot;name&quot;, &quot;Bill&quot;) viper搜索路径和文件 peer命令对core.yaml的引入也是通过viper，具体过程如下： /fabric/peer/main.go中定义const cmdRoot = &quot;core&quot;。 main函数中调用err := common.InitConfig(cmdRoot)，该参数一路向下传递。 InitConfig函数在/fabric/peer/common/common.go中定义，其中调用了config.InitViper(nil, cmdRoot)和viper.ReadInConfig()。 InitViper在/fabric/core/config/config.go中定义，接收cmdRoot作为参数，最终调用了viper.SetConfigName()，也即将core设置为了配置文件名。 common.InitConfig(cmdRoot)中的viper.ReadInConfig()则读取了该配置文件 orderer命令则使用orderer.yaml配置文件，由viper引入，具体过程如下： 在/fabric/orderer/main.go中main函数调用了config.Load()。 Load在/fabric/orderer/localconfig/config.go中定义。该文件中定义了Prefix = &quot;ORDERER&quot;和configName string，并在init初始化函数中将configName赋值为strings.ToLower(Prefix)，即orderer，也即所用的配置文件名为orderer。Load函数新建了一个用于orderer自己的viper，并调用了cf.InitViper(config, configName)，其中config参数为新建的用于orderer自身的viper，configName为配置文件名orderer InitViper在/fabric/core/config/config.go中定义，最终调用了viper.SetConfigName()，也即将orderer设置为了配置文件名 Load随后调用了config.ReadInConfig()，读取了配置文件 InitViper 上述步骤中peer和orderer在初始化配置文件时，最终都将调用的终点指向了/fabric/core/config/config.go中定义InitViper()。下面集中分析InitViper。 首先判断环境变量FABRIC_CFG_PATH是否有值，如果有值，则是手工定义了FABRIC的配置文件所在路径。参考Getting Started中关于手工设置export FABRIC_CFG_PATH=$PWD（当前目录）。 若没有定义该环境变量的值，则用代码添加三个路径作为搜索配置文件的路径：当前工作目录，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric。 当前工作目录，调用addConfigPath(v, “./”)添加，其内部调用的是viper.AddConfigPath()。 $GOPATH/src/github.com/hyperledger/fabric/sampleconfig，通过调用AddDevConfigPath(v)添加。 AddDevConfigPath首先调用GetDevConfigDir()，读取 GOPATH路径下是否存在src/github.com/hyperledger/fabric/sampleconfig目录，若存在，则通过filepath.Join拼接 GOPATH和src/github.com/hyperledger/fabric/sampleconfig，形成完整的路径并返回。 AddDevConfigPath接着调用addConfigPath函数，其内部调用的是viper.AddConfigPath()。 /etc/hyperledger/fabric。定义了OfficialPath = “/etc/hyperledger/fabric”常量，如果该路径存在，则调用addConfigPath加入该路径。 调用SetConfigName()设置配置文件名，所指的的配置文件名configName是由参数传递进来的。 由经由InitViper，形成了以下viper配置： 搜索路径（二选一） FABRIC_CFG_PATH指定的路径 ./，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric 搜索的配置文件名 core —— 核心配置，供各个模块使用 orderer —— orderer配置，orderer使用 另外注意InitViper的第一个参数，v *viper.Viper。在InitViper函数中，无论是添加搜索路径（使用的是addConfigPath函数），还是设置要搜索的配置文件名（viper自身的SetConfigName函数），都分为全局的viper和特定的viper（也就是参数v）。最终由viper.AddConfigPath或viper.SetConfigName完成的，则是全局的，由v.AddConfigPath或v.SetConfigName完成的，则是特定的。这样就可以很方便的初始化需要单独使用viper的模块，如orderer就是单独使用一条毒蛇，其在/fabric/orderer/localconfig/config.go中的Load函数中，config := viper.New()新养了一条自己的蛇，然后将此蛇通过参数传给InitViper，cf.InitViper(config, configName)。 安全文件配置 安全配置相关的代码在/fabric/peer/main.go中没有体现，而是在/fabric/peer/node/start.go中的serve函数中才初次出现。若grpc服务中使用了TLS网络，则需要.key，.crt，.ca文件配套文件。在此简略介绍，关于TLS，将会在将来专门的文章中详细介绍。 在/fabric/peer/node/start.go中的serve函数中secureConfig, err := peer.GetSecureConfig()获取安全配置。 使用的安全配置结构为/fabric/core/comm/server.go中定义的SecureServerConfig，用于一个grpc服务端实例。 .key，.crt，.ca文件所在的目录都是在core.yaml中定义都的tls文件夹中，当使用TLS网络时，会读取这些文件的数据到SecureServerConfig对象中。在GetSecureConfig()函数中，使用ioutil.ReadFile读取由/fabric/core/config/config.go中定义的config.GetPath(“…”)函数获取的tls路径下的相应文件。如/etc/hyperledger/fabric/tls/server.crt。 命令选项配置 以peer start命令为例，在/fabric/peer/node/start.go中startCmd()函数中，flags.BoolVarP(&amp;chaincodeDevMode, &quot;peer-chaincodedev&quot;, &quot;&quot;, false,&quot;Whether peer in chaincode development mode&quot;)设置了peer start命令的选项之一为peer-chaincodedev，用于赋值文件中的全局变量chaincodeDevMode，该变量指定了chaincode的模式。chaincode的模式在core.yaml中也有定义，chaincode.mode的值为net，为默认选项。而当执行peer start 命令时指定了选项peer-chaincodedev=true，也即将chaincodeDevMode赋值为true，在serve()函数中，就会使用viper.Set(&quot;chaincode.mode&quot;, chaincode.DevModeUserRunsChaincode)将chaincode的模式值设置成了dev。 环境变量配置 在fabric目前的阶段，各个peer都是在容器中运行的，因此环境变量指的是各个容器中的环境变量。在各个容器的启动脚本中对容器的一些环境变量也进行了设置。在peer-base-no-tls.yaml（见源码解析1——线头）中，如peer容器中，设置了如下环境变量： - CORE_PEER_ADDRESSAUTODETECT=true - CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock - CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=e2ecli_default - CORE_LOGGING_LEVEL=ERROR ... 在fabric/peer/main.go中的开始，即对容器的环境变量进行了获取并设置： //设置了环境变量前置，在此也就是peer viper.SetEnvPrefix(cmdRoot) //将环境变量加载进来了 viper.AutomaticEnv() replacer := strings.NewReplacer(&quot;.&quot;, &quot;_&quot;) //将环境变量中的_换成.，这样就和yaml文件的配置相匹配了。 //因为viper读取yaml文件所形成的配置项就是按层级并以.分隔的格式，如peer.address viper.SetEnvKeyReplacer(replacer) 阅读更多","@type":"BlogPosting","url":"/2017/07/17/672eff66bd21024323aab9c78fed9510.html","headline":"fabric源码解析4——配置系统","dateModified":"2017-07-17T00:00:00+08:00","datePublished":"2017-07-17T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2017/07/17/672eff66bd21024323aab9c78fed9510.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>fabric源码解析4——配置系统</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h1 id="fabric源码解析4配置系统">fabric源码解析4——配置系统</h1> 
  <p>fabric的配置系统是程序原始数据的来源之一，虽然简单却很重要。在阅读源码过程中对于具象化程序也很有帮助。在分析peer的具体交易工作之前，我们可以先分析一下fabric的配置系统。我们还将我们的目光聚焦在/fabric/peer/main.go的main函数中，除了一系列mainCmd的命令操作，还有viper进行的一系列配置操作，并通过<code>err := common.InitConfig(cmdRoot)</code>进行了配置的初始化。</p> 
  <p>fabric索取配置的途径有：环境变量，命令行参数，各种格式的配置文件。其中以配置文件为主，环境变量和命令行参数辅助，三者可以相互作用。主要的配置文件有core.yaml，orderer.yaml等，在/fabric/sampleconfig中有示例。主要使用的配置代码集中在/fabric/core/config下。</p> 
  <h2 id="viper简介">viper简介</h2> 
  <p>fabric的配置系统主要运用第三方包viper，可在github.com/spf13/viper下载。viper可以对系统环境变量，yaml/json等格式的配置文件甚至是远程配置进行读取和设置，并可以在不重启服务的情况下动态设置新的配置项的值并使之实时生效，是一个专门处理配置的解决方案。 而且，viper，眼镜蛇，称自己与cobra（见peer命令结构一文）是companion，足见使用viper的理由。</p> 
  <p>viper的基础用法如下：</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">//设置一个要读取的配置文件名（不包含后缀），一个viper只支持一个文件名
viper<span class="hljs-preprocessor">.SetConfigName</span>(<span class="hljs-string">"config"</span>)
//设置一个搜索配置文件的路径，viper的搜索路径可以有多个
viper<span class="hljs-preprocessor">.AddConfigPath</span>(<span class="hljs-string">"/etc/appname/"</span>)
viper<span class="hljs-preprocessor">.AddConfigPath</span>(<span class="hljs-string">"."</span>)
//读取配置文件
viper<span class="hljs-preprocessor">.ReadInConfig</span>()
//获取其中一个name项的值
viper<span class="hljs-preprocessor">.Get</span>(<span class="hljs-string">"name"</span>)
//将name的值设置为Bill
viper<span class="hljs-preprocessor">.Set</span>(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Bill"</span>)</code></pre> 
  <h2 id="viper搜索路径和文件">viper搜索路径和文件</h2> 
  <p>peer命令对core.yaml的引入也是通过viper，具体过程如下：</p> 
  <ul> 
   <li>/fabric/peer/main.go中定义<code>const cmdRoot = "core"</code>。</li> 
   <li>main函数中调用<code>err := common.InitConfig(cmdRoot)</code>，该参数一路向下传递。</li> 
   <li>InitConfig函数在/fabric/peer/common/common.go中定义，其中调用了<code>config.InitViper(nil, cmdRoot)</code>和<code>viper.ReadInConfig()</code>。</li> 
   <li>InitViper在/fabric/core/config/config.go中定义，接收cmdRoot作为参数，最终调用了<strong>viper.SetConfigName()</strong>，也即将core设置为了配置文件名。</li> 
   <li>common.InitConfig(cmdRoot)中的<strong>viper.ReadInConfig()</strong>则读取了该配置文件</li> 
  </ul> 
  <p>orderer命令则使用orderer.yaml配置文件，由viper引入，具体过程如下：</p> 
  <ul> 
   <li>在/fabric/orderer/main.go中main函数调用了<code>config.Load()</code>。</li> 
   <li>Load在/fabric/orderer/localconfig/config.go中定义。该文件中定义了<code>Prefix = "ORDERER"</code>和<code>configName string</code>，并在<strong>init</strong>初始化函数中将<strong>configName</strong>赋值为<code>strings.ToLower(Prefix)</code>，即<strong>orderer</strong>，也即所用的配置文件名为orderer。Load函数新建了一个用于orderer自己的viper，并调用了<code>cf.InitViper(config, configName)</code>，其中config参数为新建的用于orderer自身的viper，configName为配置文件名orderer</li> 
   <li>InitViper在/fabric/core/config/config.go中定义，最终调用了<strong>viper.SetConfigName()</strong>，也即将<strong>orderer</strong>设置为了配置文件名</li> 
   <li>Load随后调用了<strong>config.ReadInConfig()</strong>，读取了配置文件</li> 
  </ul> 
  <h2 id="initviper">InitViper</h2> 
  <p>上述步骤中peer和orderer在初始化配置文件时，最终都将调用的终点指向了/fabric/core/config/config.go中定义<strong>InitViper()</strong>。下面集中分析InitViper。</p> 
  <ul> 
   <li><p>首先判断环境变量<strong>FABRIC_CFG_PATH</strong>是否有值，如果有值，则是手工定义了FABRIC的配置文件所在路径。参考Getting Started中关于手工设置export FABRIC_CFG_PATH=$PWD（当前目录）。</p></li> 
   <li><p>若没有定义该环境变量的值，则用代码添加三个路径作为搜索配置文件的路径：<strong>当前工作目录，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric</strong>。</p> 
    <ul>
     <li><p>当前工作目录，调用addConfigPath(v, “./”)添加，其内部调用的是viper.AddConfigPath()。</p></li> 
     <li><p>$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，通过调用AddDevConfigPath(v)添加。</p> 
      <ul>
       <li>AddDevConfigPath首先调用GetDevConfigDir()，读取<span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1-Frame" role="textbox" aria-readonly="true">
         <nobr>
          <span class="math" id="MathJax-Span-1" style="width: 29.88em; display: inline-block;"><span style="width: 23.9em; height: 0px; font-size: 125%; display: inline-block; position: relative;"><span style="left: 0em; top: -4em; position: absolute; clip: rect(3.04em, 1000em, 5.89em, -0.43em);"><span class="mrow" id="MathJax-Span-2"><span style="width: 23.9em; height: 0px; display: inline-block; position: relative;"><span style="left: 0em; top: -4em; position: absolute; clip: rect(3.04em, 1000em, 4.41em, -0.43em);"><span class="mi" id="MathJax-Span-3" style="font-family: MathJax_Math; font-style: italic;">G</span><span class="mi" id="MathJax-Span-4" style="font-family: MathJax_Math; font-style: italic;">O</span><span class="mi" id="MathJax-Span-5" style="font-family: MathJax_Math; font-style: italic;">P<span style="width: 0.1em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-6" style="font-family: MathJax_Math; font-style: italic;">A</span><span class="mi" id="MathJax-Span-7" style="font-family: MathJax_Math; font-style: italic;">T<span style="width: 0.12em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-8" style="font-family: MathJax_Math; font-style: italic;">H<span style="width: 0.05em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="texatom" id="MathJax-Span-9"><span class="mrow" id="MathJax-Span-10"><span class="mo" id="MathJax-Span-11"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">路</span></span></span></span><span class="texatom" id="MathJax-Span-12"><span class="mrow" id="MathJax-Span-13"><span class="mo" id="MathJax-Span-14"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">径</span></span></span></span><span class="texatom" id="MathJax-Span-15"><span class="mrow" id="MathJax-Span-16"><span class="mo" id="MathJax-Span-17"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">下</span></span></span></span><span class="texatom" id="MathJax-Span-18"><span class="mrow" id="MathJax-Span-19"><span class="mo" id="MathJax-Span-20"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">是</span></span></span></span><span class="texatom" id="MathJax-Span-21"><span class="mrow" id="MathJax-Span-22"><span class="mo" id="MathJax-Span-23"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">否</span></span></span></span><span class="texatom" id="MathJax-Span-24"><span class="mrow" id="MathJax-Span-25"><span class="mo" id="MathJax-Span-26"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">存</span></span></span></span><span class="texatom" id="MathJax-Span-27"><span class="mrow" id="MathJax-Span-28"><span class="mo" id="MathJax-Span-29"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">在</span></span></span></span><span class="mi" id="MathJax-Span-30" style="font-family: MathJax_Math; font-style: italic;">s</span><span class="mi" id="MathJax-Span-31" style="font-family: MathJax_Math; font-style: italic;">r</span><span class="mi" id="MathJax-Span-32" style="font-family: MathJax_Math; font-style: italic;">c</span><span class="texatom" id="MathJax-Span-33"><span class="mrow" id="MathJax-Span-34"><span class="mo" id="MathJax-Span-35" style="font-family: MathJax_Main;">/</span></span></span><span class="mi" id="MathJax-Span-36" style="font-family: MathJax_Math; font-style: italic;">g<span style="width: 0em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-37" style="font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-38" style="font-family: MathJax_Math; font-style: italic;">t</span><span class="mi" id="MathJax-Span-39" style="font-family: MathJax_Math; font-style: italic;">h</span><span class="mi" id="MathJax-Span-40" style="font-family: MathJax_Math; font-style: italic;">u</span><span class="mi" id="MathJax-Span-41" style="font-family: MathJax_Math; font-style: italic;">b</span><span class="mo" id="MathJax-Span-42" style="font-family: MathJax_Main;">.</span><span class="mi" id="MathJax-Span-43" style="padding-left: 0.16em; font-family: MathJax_Math; font-style: italic;">c</span><span class="mi" id="MathJax-Span-44" style="font-family: MathJax_Math; font-style: italic;">o</span><span class="mi" id="MathJax-Span-45" style="font-family: MathJax_Math; font-style: italic;">m</span><span class="texatom" id="MathJax-Span-46"><span class="mrow" id="MathJax-Span-47"><span class="mo" id="MathJax-Span-48" style="font-family: MathJax_Main;">/</span></span></span><span class="mi" id="MathJax-Span-49" style="font-family: MathJax_Math; font-style: italic;">h</span><span class="mi" id="MathJax-Span-50" style="font-family: MathJax_Math; font-style: italic;">y<span style="width: 0em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-51" style="font-family: MathJax_Math; font-style: italic;">p</span><span class="mi" id="MathJax-Span-52" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-53" style="font-family: MathJax_Math; font-style: italic;">r</span><span class="mi" id="MathJax-Span-54" style="font-family: MathJax_Math; font-style: italic;">l</span><span class="mi" id="MathJax-Span-55" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-56" style="font-family: MathJax_Math; font-style: italic;">d<span style="width: 0em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-57" style="font-family: MathJax_Math; font-style: italic;">g<span style="width: 0em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-58" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-59" style="font-family: MathJax_Math; font-style: italic;">r</span><span class="texatom" id="MathJax-Span-60"><span class="mrow" id="MathJax-Span-61"><span class="mo" id="MathJax-Span-62" style="font-family: MathJax_Main;">/</span></span></span><span class="mi" id="MathJax-Span-63" style="font-family: MathJax_Math; font-style: italic;">f<span style="width: 0.06em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-64" style="font-family: MathJax_Math; font-style: italic;">a</span><span class="mi" id="MathJax-Span-65" style="font-family: MathJax_Math; font-style: italic;">b</span><span class="mi" id="MathJax-Span-66" style="font-family: MathJax_Math; font-style: italic;">r</span><span class="mi" id="MathJax-Span-67" style="font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-68" style="font-family: MathJax_Math; font-style: italic;">c</span><span style="width: 0px; height: 4em; display: inline-block;"></span></span><span style="left: 0em; top: -2.51em; position: absolute; clip: rect(3.04em, 1000em, 4.41em, -0.42em);"><span class="texatom" id="MathJax-Span-69"><span class="mrow" id="MathJax-Span-70"><span class="mo" id="MathJax-Span-71" style="font-family: MathJax_Main;">/</span></span></span><span class="mi" id="MathJax-Span-72" style="font-family: MathJax_Math; font-style: italic;">s</span><span class="mi" id="MathJax-Span-73" style="font-family: MathJax_Math; font-style: italic;">a</span><span class="mi" id="MathJax-Span-74" style="font-family: MathJax_Math; font-style: italic;">m</span><span class="mi" id="MathJax-Span-75" style="font-family: MathJax_Math; font-style: italic;">p</span><span class="mi" id="MathJax-Span-76" style="font-family: MathJax_Math; font-style: italic;">l</span><span class="mi" id="MathJax-Span-77" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-78" style="font-family: MathJax_Math; font-style: italic;">c</span><span class="mi" id="MathJax-Span-79" style="font-family: MathJax_Math; font-style: italic;">o</span><span class="mi" id="MathJax-Span-80" style="font-family: MathJax_Math; font-style: italic;">n</span><span class="mi" id="MathJax-Span-81" style="font-family: MathJax_Math; font-style: italic;">f<span style="width: 0.06em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-82" style="font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-83" style="font-family: MathJax_Math; font-style: italic;">g<span style="width: 0em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="texatom" id="MathJax-Span-84"><span class="mrow" id="MathJax-Span-85"><span class="mo" id="MathJax-Span-86"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">目</span></span></span></span><span class="texatom" id="MathJax-Span-87"><span class="mrow" id="MathJax-Span-88"><span class="mo" id="MathJax-Span-89"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">录</span></span></span></span><span class="texatom" id="MathJax-Span-90"><span class="mrow" id="MathJax-Span-91"><span class="mo" id="MathJax-Span-92"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">，</span></span></span></span><span class="texatom" id="MathJax-Span-93"><span class="mrow" id="MathJax-Span-94"><span class="mo" id="MathJax-Span-95"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">若</span></span></span></span><span class="texatom" id="MathJax-Span-96"><span class="mrow" id="MathJax-Span-97"><span class="mo" id="MathJax-Span-98"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">存</span></span></span></span><span class="texatom" id="MathJax-Span-99"><span class="mrow" id="MathJax-Span-100"><span class="mo" id="MathJax-Span-101"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">在</span></span></span></span><span class="texatom" id="MathJax-Span-102"><span class="mrow" id="MathJax-Span-103"><span class="mo" id="MathJax-Span-104"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">，</span></span></span></span><span class="texatom" id="MathJax-Span-105"><span class="mrow" id="MathJax-Span-106"><span class="mo" id="MathJax-Span-107"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">则</span></span></span></span><span class="texatom" id="MathJax-Span-108"><span class="mrow" id="MathJax-Span-109"><span class="mo" id="MathJax-Span-110"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">通</span></span></span></span><span class="texatom" id="MathJax-Span-111"><span class="mrow" id="MathJax-Span-112"><span class="mo" id="MathJax-Span-113"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">过</span></span></span></span><span class="mi" id="MathJax-Span-114" style="font-family: MathJax_Math; font-style: italic;">f<span style="width: 0.06em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-115" style="font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-116" style="font-family: MathJax_Math; font-style: italic;">l</span><span class="mi" id="MathJax-Span-117" style="font-family: MathJax_Math; font-style: italic;">e</span><span class="mi" id="MathJax-Span-118" style="font-family: MathJax_Math; font-style: italic;">p</span><span class="mi" id="MathJax-Span-119" style="font-family: MathJax_Math; font-style: italic;">a</span><span class="mi" id="MathJax-Span-120" style="font-family: MathJax_Math; font-style: italic;">t</span><span class="mi" id="MathJax-Span-121" style="font-family: MathJax_Math; font-style: italic;">h</span><span class="mo" id="MathJax-Span-122" style="font-family: MathJax_Main;">.</span><span class="mi" id="MathJax-Span-123" style="padding-left: 0.16em; font-family: MathJax_Math; font-style: italic;">J<span style="width: 0.07em; height: 1px; overflow: hidden; display: inline-block;"></span></span><span class="mi" id="MathJax-Span-124" style="font-family: MathJax_Math; font-style: italic;">o</span><span class="mi" id="MathJax-Span-125" style="font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-126" style="font-family: MathJax_Math; font-style: italic;">n</span><span class="texatom" id="MathJax-Span-127"><span class="mrow" id="MathJax-Span-128"><span class="mo" id="MathJax-Span-129"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">拼</span></span></span></span><span class="texatom" id="MathJax-Span-130"><span class="mrow" id="MathJax-Span-131"><span class="mo" id="MathJax-Span-132"><span style="font-family: STIXGeneral,&quot;Arial Unicode MS&quot;,serif; font-size: 80%; font-style: normal; font-weight: normal;">接</span></span></span></span><span style="width: 0px; height: 4em; display: inline-block;"></span></span></span></span><span style="width: 0px; height: 4em; display: inline-block;"></span></span></span><span style="width: 0px; height: 3.29em; overflow: hidden; vertical-align: -2.23em; border-left-color: currentColor; border-left-width: 0em; border-left-style: solid; display: inline-block;"></span></span>
         </nobr></span><script id="MathJax-Element-1" type="math/tex">GOPATH路径下是否存在src/github.com/hyperledger/fabric/sampleconfig目录，若存在，则通过filepath.Join拼接</script>GOPATH和src/github.com/hyperledger/fabric/sampleconfig，形成完整的路径并返回。</li> 
       <li>AddDevConfigPath接着调用addConfigPath函数，其内部调用的是viper.AddConfigPath()。</li>
      </ul></li> 
     <li>/etc/hyperledger/fabric。定义了OfficialPath = “/etc/hyperledger/fabric”常量，如果该路径存在，则调用addConfigPath加入该路径。</li>
    </ul></li> 
   <li><p>调用<strong>SetConfigName()</strong>设置配置文件名，所指的的配置文件名<strong>configName</strong>是由参数传递进来的。</p></li> 
  </ul> 
  <p>由经由InitViper，形成了以下viper配置：</p> 
  <blockquote> 
   <p>搜索路径（二选一）</p> 
   <ul> 
    <li>FABRIC_CFG_PATH指定的路径</li> 
    <li>./，$GOPATH/src/github.com/hyperledger/fabric/sampleconfig，/etc/hyperledger/fabric</li> 
   </ul> 
   <p>搜索的配置文件名</p> 
   <ul> 
    <li>core —— 核心配置，供各个模块使用</li> 
    <li>orderer —— orderer配置，orderer使用</li> 
   </ul> 
  </blockquote> 
  <p>另外注意InitViper的第一个参数，<strong>v *viper.Viper</strong>。在<strong>InitViper</strong>函数中，无论是添加搜索路径（使用的是addConfigPath函数），还是设置要搜索的配置文件名（viper自身的SetConfigName函数），都分为全局的viper和特定的viper（也就是参数<strong>v</strong>）。最终由<strong>viper</strong>.AddConfigPath或<strong>viper</strong>.SetConfigName完成的，则是全局的，由<strong>v</strong>.AddConfigPath或<strong>v</strong>.SetConfigName完成的，则是特定的。这样就可以很方便的初始化需要单独使用viper的模块，如orderer就是单独使用一条毒蛇，其在/fabric/orderer/localconfig/config.go中的Load函数中，config := viper.New()新养了一条自己的蛇，然后将此蛇通过参数传给InitViper，cf.InitViper(config, configName)。</p> 
  <h2 id="安全文件配置">安全文件配置</h2> 
  <p>安全配置相关的代码在/fabric/peer/main.go中没有体现，而是在/fabric/peer/node/start.go中的serve函数中才初次出现。若grpc服务中使用了TLS网络，则需要.key，.crt，.ca文件配套文件。在此简略介绍，关于TLS，将会在将来专门的文章中详细介绍。</p> 
  <p>在/fabric/peer/node/start.go中的serve函数中<code>secureConfig, err := peer.GetSecureConfig()</code>获取安全配置。</p> 
  <p>使用的安全配置结构为/fabric/core/comm/server.go中定义的SecureServerConfig，用于一个grpc服务端实例。 <br> .key，.crt，.ca文件所在的目录都是在core.yaml中定义都的tls文件夹中，当使用TLS网络时，会读取这些文件的数据到SecureServerConfig对象中。在GetSecureConfig()函数中，使用ioutil.ReadFile读取由/fabric/core/config/config.go中定义的config.GetPath(“…”)函数获取的tls路径下的相应文件。如/etc/hyperledger/fabric/tls/server.crt。</p> 
  <h2 id="命令选项配置">命令选项配置</h2> 
  <p>以peer start命令为例，在/fabric/peer/node/start.go中<strong>startCmd()</strong>函数中，<code>flags.BoolVarP(&amp;chaincodeDevMode, "peer-chaincodedev", "", false,"Whether peer in chaincode development mode")</code>设置了peer start命令的选项之一为peer-chaincodedev，用于赋值文件中的全局变量<strong>chaincodeDevMode</strong>，该变量指定了<strong>chaincode的模式</strong>。chaincode的模式在core.yaml中也有定义，chaincode.mode的值为<strong>net</strong>，为默认选项。而当执行peer start 命令时指定了选项peer-chaincodedev=true，也即将chaincodeDevMode赋值为true，在<strong>serve()</strong>函数中，就会使用<code>viper.Set("chaincode.mode", chaincode.DevModeUserRunsChaincode)</code>将chaincode的模式值设置成了<strong>dev</strong>。</p> 
  <h2 id="环境变量配置">环境变量配置</h2> 
  <p>在fabric目前的阶段，各个peer都是在容器中运行的，因此环境变量指的是各个容器中的环境变量。在各个容器的启动脚本中对容器的一些环境变量也进行了设置。在peer-base-no-tls.yaml（见源码解析1——线头）中，如peer容器中，设置了如下环境变量：</p> 
  <pre class="prettyprint"><code class=" hljs haml">    -<span class="ruby"> <span class="hljs-constant">CORE_PEER_ADDRESSAUTODETECT</span>=<span class="hljs-keyword">true</span> </span>    -<span class="ruby"> <span class="hljs-constant">CORE_VM_ENDPOINT</span>=<span class="hljs-symbol">unix:</span>/<span class="hljs-regexp">//host</span><span class="hljs-regexp">/var/run</span><span class="hljs-regexp">/docker.sock </span></span>    -<span class="ruby"> <span class="hljs-constant">CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE</span>=e2ecli_default </span>    -<span class="ruby"> <span class="hljs-constant">CORE_LOGGING_LEVEL</span>=<span class="hljs-constant">ERROR</span> </span>    ...</code></pre> 
  <p>在fabric/peer/main.go中的开始，即对容器的环境变量进行了获取并设置：</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">    //设置了环境变量前置，在此也就是peer
    viper<span class="hljs-preprocessor">.SetEnvPrefix</span>(cmdRoot)
    //将环境变量加载进来了
    viper<span class="hljs-preprocessor">.AutomaticEnv</span>()
    replacer := strings<span class="hljs-preprocessor">.NewReplacer</span>(<span class="hljs-string">"."</span>, <span class="hljs-string">"_"</span>)
    //将环境变量中的_换成.，这样就和yaml文件的配置相匹配了。
    //因为viper读取yaml文件所形成的配置项就是按层级并以.分隔的格式，如peer<span class="hljs-preprocessor">.address</span>
    viper<span class="hljs-preprocessor">.SetEnvKeyReplacer</span>(replacer)</code></pre> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/idsuf698987/article/details/75224228,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/idsuf698987/article/details/75224228,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
