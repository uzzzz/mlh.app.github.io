<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>php实现银联网关/WAP支付接入 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="php实现银联网关/WAP支付接入" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="银联支付用的还是比较少的，而且开发中也没接触多少，不过因为工作项目用银联支付能降低费率，所以还是接入了银联支付。本文支付为银联网关和WAP支付接口。 官方网站SDK&amp;DEMO:https://open.unionpay.com/ajweb/product/detail?id=66 产品API: https://open.unionpay.com/ajweb/product/newProApiShow?proId=1&amp;apiId=63 API文档 https://open.unionpay.com/ajweb/help/api 在开始之前要仔细阅读官方包里的说明文件，必要的证书和商户信息要提前获取。 实例代码及步骤： 修改demo/api_01_gateway/Form_6_2_FrontConsume.php(发送订单参数，跳转支付界面) &lt;?php header ( &#39;Content-type:text/html;charset=utf-8&#39; ); include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; /** * 重要：联调测试时请仔细阅读注释！ * * 产品：跳转网关支付产品&lt;br&gt; * 交易：消费：前台跳转，有前台通知应答和后台通知应答&lt;br&gt; * 日期： 2015-09&lt;br&gt; * 版本： 1.0.0 * 版权： 中国银联&lt;br&gt; * 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能规范性等方面的保障&lt;br&gt; * 提示：该接口参考文档位置：open.unionpay.com帮助中心 下载 产品接口规范 《网关支付产品接口规范》，&lt;br&gt; * 《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表)&lt;br&gt; * 《全渠道平台接入接口规范 第3部分 文件接口》（对账文件格式说明）&lt;br&gt; * 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案： * 调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案 * 测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案 * 2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。 * 交易说明:1）以后台通知或交易状态查询交易确定交易成功,前台通知不能作为判断成功的标准. * 2）交易状态查询交易（Form_6_5_Query）建议调用机制：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。 */ //接收支付数据 $order_data = trim(get_param(&quot;orderDa&quot;)); //订单数据 if($order_data == &quot;&quot; ){ $mssage = &quot;数据不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } $result_order = json_decode(uc_authcode(base64_decode($order_data), &#39;DECODE&#39;, ADMIN_KEY),true); //商户订单号，商户网站订单系统中唯一订单号，必填 $out_trade_no = $result_order[&#39;WIDout_trade_no&#39;]; //付款金额，必填(单位元) $total_amount = $result_order[&#39;WIDtotal_amount&#39;]; //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 //订单发送时间 $send_time = date(&#39;YmdHis&#39;,THIS_DATETIME); //订单超时时间 $time_out = date(&#39;YmdHis&#39;,strtotime(&#39;+15 minutes&#39;,THIS_DATETIME)); //验证数据 $pay_md5 = $result_order[&#39;infoPy&#39;]; //订单验证 if($out_trade_no==&#39;&#39;){ $mssage = &quot;订单号不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } if($total_amount==&#39;&#39; || $total_amount==0){ $mssage = &quot;订单金额不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //购买商品 if($result_order[&#39;flag&#39;]==&#39;paycard&#39;){ //检测是否有订单号 $where = &quot; and o_orderid = &#39;&quot;.$out_trade_no.&quot;&#39; and o_totalprice=&#39;&quot;.$total_amount.&quot;&#39; and o_status=4 &quot;; $info = get_info($GLOBALS[&quot;conn&quot;],&quot;game_order&quot;,array(),$where); if( empty($info) ){ $mssage = &quot;没有此订单！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //验证数据 $p_arr = array( &#39;uid&#39;=&gt;$info[&#39;o_playerid&#39;], &#39;uorder&#39;=&gt;$info[&#39;o_orderid&#39;], &#39;uprice&#39;=&gt;$info[&#39;o_totalprice&#39;],); $p_time = $info[&#39;o_addtime&#39;]; $p_key = ADMIN_KEY; $p_md5 = md5($p_arr.$p_time.$p_key); if( $p_md5 != $pay_md5 ){ $mssage = &quot;请勿非法操作！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } } //申请还款 if($result_order[&#39;flag&#39;]==&#39;repayment&#39;){ //检测是否有订单号 $where = &quot; and l_orderid = &#39;&quot;.$out_trade_no.&quot;&#39; and l_returnnum=&#39;&quot;.$total_amount.&quot;&#39; and l_status=3 &quot;; $info = get_info($GLOBALS[&quot;conn&quot;],&quot;game_loan_order&quot;,array(),$where); if( empty($info) ){ $mssage = &quot;没有此订单！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //验证数据 $p_arr = array( &#39;uid&#39;=&gt;$info[&#39;l_playerid&#39;], &#39;uorder&#39;=&gt;$info[&#39;l_orderid&#39;], &#39;uprice&#39;=&gt;$info[&#39;l_returnnum&#39;]); $p_time = $info[&#39;l_addtime&#39;]; $p_key = ADMIN_KEY; $p_md5 = md5($p_arr.$p_time.$p_key); if( $p_md5 != $pay_md5 ){ $mssage = &quot;请勿非法操作！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } } //记录要提交的订单信息到日志 $log_msg = &quot;订单内容:&quot; . json_encode($result_order); sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;jsapi&quot;); $params = array( //以下信息非特殊情况不需要改动 &#39;version&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;version, //版本号 &#39;encoding&#39; =&gt; &#39;utf-8&#39;, //编码方式 &#39;txnType&#39; =&gt; &#39;01&#39;, //交易类型 &#39;txnSubType&#39; =&gt; &#39;01&#39;, //交易子类 &#39;bizType&#39; =&gt; &#39;000201&#39;, //业务类型 &#39;frontUrl&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;frontUrl, //前台通知地址 &#39;backUrl&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;backUrl, //后台通知地址 &#39;signMethod&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;signMethod, //签名方法 &#39;channelType&#39; =&gt; &#39;08&#39;, //渠道类型，07-PC，08-手机 &#39;accessType&#39; =&gt; &#39;0&#39;, //接入类型 &#39;currencyCode&#39; =&gt; &#39;156&#39;, //交易币种，境内商户固定156 //TODO 以下信息需要填写 &#39;merId&#39; =&gt; &#39;&#39;, //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 &#39;orderId&#39; =&gt; $out_trade_no, //商户订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数，可以自行定制规则 &#39;txnTime&#39; =&gt; $send_time, //订单发送时间，格式为YYYYMMDDhhmmss，取北京时间，此处默认取demo演示页面传递的参数 &#39;txnAmt&#39; =&gt; $total_amount*100, //交易金额，单位分，此处默认取demo演示页面传递的参数 // 订单超时时间。 // 超过此时间后，除网银交易外，其他交易银联系统会拒绝受理，提示超时。 跳转银行网银交易如果超时后交易成功，会自动退款，大约5个工作日金额返还到持卡人账户。 // 此时间建议取支付时的北京时间加15分钟。 // 超过超时时间调查询接口应答origRespCode不是A6或者00的就可以判断为失败。 &#39;payTimeout&#39; =&gt; $time_out // 请求方保留域， // 透传字段，查询、通知、对账文件中均会原样出现，如有需要请启用并修改自己希望透传的数据。 // 出现部分特殊字符时可能影响解析，请按下面建议的方式填写： // 1. 如果能确定内容不会出现&amp;={}[]&quot;&#39;等符号时，可以直接填写数据，建议的方法如下。 // &#39;reqReserved&#39; =&gt;&#39;透传信息1|透传信息2|透传信息3&#39;, // 2. 内容可能出现&amp;={}[]&quot;&#39;符号时： // 1) 如果需要对账文件里能显示，可将字符替换成全角＆＝｛｝【】“‘字符（自己写代码，此处不演示）； // 2) 如果对账文件没有显示要求，可做一下base64（如下）。 // 注意控制数据长度，实际传输的数据长度不能超过1024位。 // 查询、通知等接口解析时使用base64_decode解base64后再对数据做后续解析。 // &#39;reqReserved&#39; =&gt; base64_encode(&#39;任意格式的信息都可以&#39;), //TODO 其他特殊用法请查看 special_use_purchase.php ); com\unionpay\acp\sdk\AcpService::sign ( $params ); $uri = com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;frontTransUrl; $html_form = com\unionpay\acp\sdk\AcpService::createAutoFormHtml( $params, $uri ); echo $html_form; ?&gt; 修改demo/api_01_gateway/FrontReceive.php(前台同步通知) &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; /** * 交易说明： 前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。 * 为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。 * 未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0 */ $logger = com\unionpay\acp\sdk\LogUtil::getLogger(); $logger-&gt;LogInfo(&quot;receive front notify: &quot; . com\unionpay\acp\sdk\createLinkString ( $_POST, false, true )); //页面回跳地址 $fail_back_url = WEBPATH_DIR_INC.&#39;enter-query.html&#39;; $succ_back_url = WEBPATH_DIR_INC.&#39;enter-query.html&#39;; //验签 if (isset ( $_POST [&#39;signature&#39;] )) { $result = com\unionpay\acp\sdk\AcpService::validate ( $_POST ); if($result){//验签成功 $respCode = $_POST [&#39;respCode&#39;];//应答码 if($respCode==&#39;00&#39; || $respCode==&#39;A6&#39;){//交易成功 //请在这里加上商户的业务逻辑程序代码 //返回参数 $orderId = $_POST [&#39;orderId&#39;];//商户订单号 $totalAmount = $_POST[&#39;txnAmt&#39;];//交易金额 $merId = $_POST[&#39;merId&#39;];//商户代码 $res = &#39;success&#39;; //判断支付类型（提现还是借贷） $type = substr($orderId,0,2); //获取对应订单信息 if($type==&#39;tx&#39;){ $order_info = get_order_info($orderId); //验证订单数据 if(empty($order_info)){ $res = &#39;fail&#39;; } if($totalAmount != $order_info[&#39;o_totalprice&#39;]*100){ $res = &#39;fail&#39;; } } if($type==&#39;jd&#39;){ $order_info = get_loan_order_info($orderId); //验证订单数据 if(empty($order_info)){ $res = &#39;fail&#39;; } if($totalAmount != $order_info[&#39;l_returnnum&#39;]*100){ $res = &#39;fail&#39;; } } //验证商户代码 //TODO }else{ $res = &#39;fail&#39;; } }else{ $res = &#39;fail&#39;; } } else { $res = &#39;fail&#39;; } ?&gt; &lt;html&gt; &lt;head&gt; &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;/&gt; &lt;title&gt;银联支付-订单支付&lt;/title&gt; &lt;script type=&quot;text/javascript&quot;&gt; function callpay(){ var res = &#39;&lt;?php echo $res;?&gt;&#39;; if(res==&#39;success&#39;){ var Idiv = document.getElementById(&quot;pay_error2&quot;); }else{ var Idiv = document.getElementById(&quot;pay_error&quot;); } Idiv.style.display = &quot;block&quot;; } //页面进入即进行支付 window.onload = function(){ callpay(); }; &lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;style&gt; *{ margin:0; padding:0; background:#e1e1e1;} #pay_error, #pay_error2{ display:none; width:90%; height:100%; text-align:center; color:#fe5f16; font-size:20px; padding:20px 0; font-weight:bolder; border:1px solid #ccc; margin:0 5%; height:100px; margin-top:50%; border-radius:10px; background:#fff;} #pay_error p,#pay_error2 p{ background:#fff;} #pay_error a,#pay_error2 a{ background:#83da49; color:#fff; text-decoration:none; display:block; padding:10px 0; width:60%; margin-left:20%; margin-top:20px;} &lt;/style&gt; &lt;div id=&quot;pay_error&quot;&gt; &lt;p class=&quot;p1&quot;&gt;支付失败，请重新完成支付！&lt;/p&gt; &lt;p class=&quot;bt&quot;&gt;&lt;a href=&quot;&lt;?php echo $fail_back_url;?&gt;&quot;&gt;确定&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;div id=&quot;pay_error2&quot;&gt; &lt;p class=&quot;p1&quot;&gt;恭喜你，支付成功&lt;/p&gt; &lt;p class=&quot;bt&quot;&gt;&lt;a href=&quot;&lt;?php echo $succ_back_url;?&gt;&quot;&gt;确定&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;/body&gt; &lt;/html&gt; 修改demo/api_01_gateway/BackReceive.php(后台异步通知) &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; include_once &quot;Form_6_5_Query.php&quot;; /** * 交易说明： 前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。 * 为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。 * 未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0 */ $logger = com\unionpay\acp\sdk\LogUtil::getLogger(); $logger-&gt;LogInfo(&quot;receive back notify: &quot; . com\unionpay\acp\sdk\createLinkString ( $_POST, false, true )); //验签 if (isset ( $_POST [&#39;signature&#39;] )) { $result = com\unionpay\acp\sdk\AcpService::validate ( $_POST ); if($result){//验签成功 $respCode = $_POST [&#39;respCode&#39;];//应答码 if($respCode==&#39;00&#39; || $respCode==&#39;A6&#39;){//交易成功 //返回参数 $orderId = $_POST [&#39;orderId&#39;];//商户订单号 $totalAmount = $_POST[&#39;txnAmt&#39;];//交易金额 $merId = $_POST[&#39;merId&#39;];//商户代码 $txnTime = $_POST[&#39;txnTime&#39;];//订单发送时间 $trade_no = $_POST[&#39;queryId&#39;];//银联流水号 //发起查询交易接口 $check_res = check_Trade_Res($orderId,$merId,$txnTime,THIS_DATETIME); if($check_res==&#39;200&#39;){ //成功 //请在这里加上商户的业务逻辑程序代码 //判断支付类型（提现还是借贷） $type = substr($orderId,0,2); //获取对应订单信息 if($type==&#39;tx&#39;){ $order_info = get_order_info($orderId); //验证订单数据 if(empty($order_info)){ echo &#39;fail&#39;; return; } if($totalAmount != $order_info[&#39;o_totalprice&#39;]*100){ echo &#39;fail&#39;; return; } } if($type==&#39;jd&#39;){ $order_info = get_loan_order_info($orderId); //验证订单数据 if(empty($order_info)){ echo &#39;fail&#39;; return; } if($totalAmount != $order_info[&#39;l_returnnum&#39;]*100){ echo &#39;fail&#39;; return; } } //验证商户代码 //TODO //执行成功后的业务程序 if($type==&#39;tx&#39;){ if($order_info[&#39;o_status&#39;]==4){ //执行业务处理 //取出礼包码 $sql = &quot;select sysid,gc_code from &quot;.get_table(&quot;game_gift_code&quot;).&quot; where gc_status=1 limit 1&quot;; $query = $GLOBALS[&quot;conn&quot;]-&gt;Query($sql); $value = $GLOBALS[&#39;conn&#39;]-&gt;FetchArray($query); $up_arr = array( &#39;o_status&#39; =&gt; 1, &#39;o_trade_no&#39; =&gt; $trade_no, &#39;o_giftcode&#39; =&gt; $value[&#39;gc_code&#39;] ); $up_where = &quot; and o_orderid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $row = update_record($GLOBALS[&quot;conn&quot;],&#39;game_order&#39;,$up_arr,array(),$up_where);//更新订单数据 if($row&gt;0){ $msg = &quot;订单 &quot;.$orderId.&quot; 已支付&quot;; $log_msg = &quot;call back:&quot; . $msg; sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;notify_order_success&quot;); //更新礼包码状态 $up_gift = array( &#39;gc_status&#39;=&gt;2, &#39;gc_time&#39; =&gt; THIS_DATETIME, &#39;gc_orderid&#39; =&gt; $orderId ); $gift_where = &quot; and sysid=&quot;.$value[&#39;sysid&#39;]; update_record($GLOBALS[&quot;conn&quot;],&#39;game_gift_code&#39;,$up_gift,array(),$gift_where); //更新商品出售数量 /*$where = &quot; and og_sysid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $garr = get_info($GLOBALS[&#39;conn&#39;],&quot;game_order_goods&quot;,array(&#39;og_goodsid&#39;),$where,&#39;&#39;,true); foreach($garr as $k=&gt;$v){ $up_num = array( &#39;g_sellnum&#39; =&gt; &#39;g_sellnum&#39;+1 ); $num_where = &quot; and g_id=&#39;&quot;.$v.&quot;&#39;&quot;; update_record($GLOBALS[&#39;conn&#39;],&quot;game_goods&quot;,$up_num,array(),$num_where);//更新商品出售 }*/ //新增用户消息 $title = &#39;付款成功，请试用后尽快退款&#39;;//标题 $content = &#39;您的订单[&#39;.$orderId.&#39;]已经付款成功，&lt;br&gt;道具试用后可申请退款退回绑定借记卡，适合现金紧缺的玩家！系统赠送您的游戏兑换码:&#39;.$value[&#39;gc_code&#39;].&#39;，可以在您的游戏中进行使用，感谢您的支持！&lt;br&gt;如需帮助，请点击左上角【帮助】找到您的问题或者联系客服进行人工服务，QQ:2013609564&#39;; add_player_msg($order_info[&#39;o_playerid&#39;],$title,$content); } } } if($type==&#39;jd&#39;){ if($order_info[&#39;l_status&#39;]==3){ //执行业务处理 $up_arr = array( &#39;l_status&#39; =&gt; 4, &#39;l_trade_no&#39; =&gt; $trade_no, &#39;l_returntime&#39; =&gt; THIS_DATETIME ); $up_where = &quot; and l_orderid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $row = update_record($GLOBALS[&quot;conn&quot;],&#39;game_loan_order&#39;,$up_arr,array(),$up_where);//更新订单数据 if($row&gt;0){ $msg = &quot;订单 &quot;.$orderId.&quot; 已支付&quot;; $log_msg = &quot;call back:&quot; . $msg; sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;notify_order_success&quot;); } } } echo &quot;success&quot;; }else{ echo &quot;fail&quot;; } }else{ echo &#39;fail&#39;; } }else{ echo &#39;fail&#39;; } } else { echo &#39;fail&#39;; } ?&gt; 封装主动查询交易结果接口方法 &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); header ( &#39;Content-type:text/html;charset=utf-8&#39; ); //include_once $_SERVER [&#39;DOCUMENT_ROOT&#39;] . &#39;/upacp_demo_b2c/sdk/acp_service.php&#39;; /** * 重要：联调测试时请仔细阅读注释！ * * 产品：跳转网关支付产品&lt;br&gt; * 交易：交易状态查询交易：只有同步应答 &lt;br&gt; * 日期： 2015-09&lt;br&gt; * 版本： 1.0.0 * 版权： 中国银联&lt;br&gt; * 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能及规范性等方面的保障&lt;br&gt; * 该接口参考文档位置：open.unionpay.com帮助中心 下载 产品接口规范 《网关支付产品接口规范》，&lt;br&gt; * 《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表）&lt;br&gt; * 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案： * 调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案 * 测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案 * 2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。 * 交易说明： 1）对前台交易发起交易状态查询：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。 * 2）对后台交易发起交易状态查询：后台类资金类交易同步返回00，成功银联有后台通知，商户也可以发起 查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。 * 后台类资金类同步返03 04 05响应码及未得到银联响应（读超时）需发起查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。 */ function check_Trade_Res($orderId,$merId,$txnTime,$firTime=THIS_DATETIME){ $params = array( //以下信息非特殊情况不需要改动 &#39;version&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;version, //版本号 &#39;encoding&#39; =&gt; &#39;utf-8&#39;, //编码方式 &#39;signMethod&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;signMethod, //签名方法 &#39;txnType&#39; =&gt; &#39;00&#39;, //交易类型 &#39;txnSubType&#39; =&gt; &#39;00&#39;, //交易子类 &#39;bizType&#39; =&gt; &#39;000000&#39;, //业务类型 &#39;accessType&#39; =&gt; &#39;0&#39;, //接入类型 &#39;channelType&#39; =&gt; &#39;07&#39;, //渠道类型 //TODO 以下信息需要填写 &#39;orderId&#39; =&gt; $orderId, //请修改被查询的交易的订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数 &#39;merId&#39; =&gt; $merId, //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 &#39;txnTime&#39; =&gt; $txnTime,//请修改被查询的交易的订单发送时间，格式为YYYYMMDDhhmmss，此处默认取demo演示页面传递的参数 ); com\unionpay\acp\sdk\AcpService::sign ( $params ); // 签名 $url = com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;singleQueryUrl; $result_arr = com\unionpay\acp\sdk\AcpService::post ( $params, $url); if(count($result_arr)&lt;=0) { //没收到200应答的情况 //printResult ( $url, $params, &quot;&quot; ); return; } //printResult ($url, $params, $result_arr ); //页面打印请求应答数据 if (!com\unionpay\acp\sdk\AcpService::validate ($result_arr) ){ return &#39;400&#39;; } if ($result_arr[&quot;respCode&quot;] == &quot;00&quot;){ if ($result_arr[&quot;origRespCode&quot;] == &quot;00&quot;){ //交易成功 //TODO //echo &quot;交易成功。&lt;br&gt;\n&quot;; return &#39;200&#39;; } else if ($result_arr[&quot;origRespCode&quot;] == &quot;03&quot; || $result_arr[&quot;origRespCode&quot;] == &quot;04&quot; || $result_arr[&quot;origRespCode&quot;] == &quot;05&quot;){ //后续需发起交易状态查询交易确定交易状态 //TODO //echo &quot;交易处理中，请稍微查询。&lt;br&gt;\n&quot;; //间隔查询 ignore_user_abort(1); set_time_limit(0); $interval = 60*5;//5分钟 sleep($interval); do{ if(THIS_DATETIME-$firTime&gt;60*120){ return &#39;400&#39;; } check_Trade_Res($orderId,$merId,$txnTime);//再次查询 }while(true); } else { //其他应答码做以失败处理 //TODO //echo &quot;交易失败：&quot; . $result_arr[&quot;origRespMsg&quot;] . &quot;。&lt;br&gt;\n&quot;; return &#39;400&#39;; } } else if ($result_arr[&quot;respCode&quot;] == &quot;03&quot; || $result_arr[&quot;respCode&quot;] == &quot;04&quot; || $result_arr[&quot;respCode&quot;] == &quot;05&quot; ){ //后续需发起交易状态查询交易确定交易状态 //TODO //echo &quot;处理超时，请稍微查询。&lt;br&gt;\n&quot;; //间隔查询 ignore_user_abort(1); set_time_limit(0); $interval = 60*5;//5分钟 sleep($interval); do{ if(THIS_DATETIME-$firTime&gt;60*120){ return &#39;400&#39;; } check_Trade_Res($orderId,$merId,$txnTime);//再次查询 }while(true); } else { //其他应答码做以失败处理 //TODO //echo &quot;失败：&quot; . $result_arr[&quot;respMsg&quot;] . &quot;。&lt;br&gt;\n&quot;; return &#39;400&#39;; } } /** * 打印请求应答 * * @param * $url * @param * $req * @param * $resp */ function printResult($url, $req, $resp) { echo &quot;=============&lt;br&gt;\n&quot;; echo &quot;地址：&quot; . $url . &quot;&lt;br&gt;\n&quot;; echo &quot;请求：&quot; . str_replace ( &quot;\n&quot;, &quot;\n&lt;br&gt;&quot;, htmlentities ( com\unionpay\acp\sdk\createLinkString ( $req, false, true ) ) ) . &quot;&lt;br&gt;\n&quot;; echo &quot;应答：&quot; . str_replace ( &quot;\n&quot;, &quot;\n&lt;br&gt;&quot;, htmlentities ( com\unionpay\acp\sdk\createLinkString ( $resp , false, false )) ) . &quot;&lt;br&gt;\n&quot;; echo &quot;=============&lt;br&gt;\n&quot;; } 阅读更多" />
<meta property="og:description" content="银联支付用的还是比较少的，而且开发中也没接触多少，不过因为工作项目用银联支付能降低费率，所以还是接入了银联支付。本文支付为银联网关和WAP支付接口。 官方网站SDK&amp;DEMO:https://open.unionpay.com/ajweb/product/detail?id=66 产品API: https://open.unionpay.com/ajweb/product/newProApiShow?proId=1&amp;apiId=63 API文档 https://open.unionpay.com/ajweb/help/api 在开始之前要仔细阅读官方包里的说明文件，必要的证书和商户信息要提前获取。 实例代码及步骤： 修改demo/api_01_gateway/Form_6_2_FrontConsume.php(发送订单参数，跳转支付界面) &lt;?php header ( &#39;Content-type:text/html;charset=utf-8&#39; ); include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; /** * 重要：联调测试时请仔细阅读注释！ * * 产品：跳转网关支付产品&lt;br&gt; * 交易：消费：前台跳转，有前台通知应答和后台通知应答&lt;br&gt; * 日期： 2015-09&lt;br&gt; * 版本： 1.0.0 * 版权： 中国银联&lt;br&gt; * 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能规范性等方面的保障&lt;br&gt; * 提示：该接口参考文档位置：open.unionpay.com帮助中心 下载 产品接口规范 《网关支付产品接口规范》，&lt;br&gt; * 《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表)&lt;br&gt; * 《全渠道平台接入接口规范 第3部分 文件接口》（对账文件格式说明）&lt;br&gt; * 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案： * 调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案 * 测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案 * 2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。 * 交易说明:1）以后台通知或交易状态查询交易确定交易成功,前台通知不能作为判断成功的标准. * 2）交易状态查询交易（Form_6_5_Query）建议调用机制：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。 */ //接收支付数据 $order_data = trim(get_param(&quot;orderDa&quot;)); //订单数据 if($order_data == &quot;&quot; ){ $mssage = &quot;数据不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } $result_order = json_decode(uc_authcode(base64_decode($order_data), &#39;DECODE&#39;, ADMIN_KEY),true); //商户订单号，商户网站订单系统中唯一订单号，必填 $out_trade_no = $result_order[&#39;WIDout_trade_no&#39;]; //付款金额，必填(单位元) $total_amount = $result_order[&#39;WIDtotal_amount&#39;]; //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 //订单发送时间 $send_time = date(&#39;YmdHis&#39;,THIS_DATETIME); //订单超时时间 $time_out = date(&#39;YmdHis&#39;,strtotime(&#39;+15 minutes&#39;,THIS_DATETIME)); //验证数据 $pay_md5 = $result_order[&#39;infoPy&#39;]; //订单验证 if($out_trade_no==&#39;&#39;){ $mssage = &quot;订单号不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } if($total_amount==&#39;&#39; || $total_amount==0){ $mssage = &quot;订单金额不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //购买商品 if($result_order[&#39;flag&#39;]==&#39;paycard&#39;){ //检测是否有订单号 $where = &quot; and o_orderid = &#39;&quot;.$out_trade_no.&quot;&#39; and o_totalprice=&#39;&quot;.$total_amount.&quot;&#39; and o_status=4 &quot;; $info = get_info($GLOBALS[&quot;conn&quot;],&quot;game_order&quot;,array(),$where); if( empty($info) ){ $mssage = &quot;没有此订单！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //验证数据 $p_arr = array( &#39;uid&#39;=&gt;$info[&#39;o_playerid&#39;], &#39;uorder&#39;=&gt;$info[&#39;o_orderid&#39;], &#39;uprice&#39;=&gt;$info[&#39;o_totalprice&#39;],); $p_time = $info[&#39;o_addtime&#39;]; $p_key = ADMIN_KEY; $p_md5 = md5($p_arr.$p_time.$p_key); if( $p_md5 != $pay_md5 ){ $mssage = &quot;请勿非法操作！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } } //申请还款 if($result_order[&#39;flag&#39;]==&#39;repayment&#39;){ //检测是否有订单号 $where = &quot; and l_orderid = &#39;&quot;.$out_trade_no.&quot;&#39; and l_returnnum=&#39;&quot;.$total_amount.&quot;&#39; and l_status=3 &quot;; $info = get_info($GLOBALS[&quot;conn&quot;],&quot;game_loan_order&quot;,array(),$where); if( empty($info) ){ $mssage = &quot;没有此订单！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //验证数据 $p_arr = array( &#39;uid&#39;=&gt;$info[&#39;l_playerid&#39;], &#39;uorder&#39;=&gt;$info[&#39;l_orderid&#39;], &#39;uprice&#39;=&gt;$info[&#39;l_returnnum&#39;]); $p_time = $info[&#39;l_addtime&#39;]; $p_key = ADMIN_KEY; $p_md5 = md5($p_arr.$p_time.$p_key); if( $p_md5 != $pay_md5 ){ $mssage = &quot;请勿非法操作！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } } //记录要提交的订单信息到日志 $log_msg = &quot;订单内容:&quot; . json_encode($result_order); sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;jsapi&quot;); $params = array( //以下信息非特殊情况不需要改动 &#39;version&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;version, //版本号 &#39;encoding&#39; =&gt; &#39;utf-8&#39;, //编码方式 &#39;txnType&#39; =&gt; &#39;01&#39;, //交易类型 &#39;txnSubType&#39; =&gt; &#39;01&#39;, //交易子类 &#39;bizType&#39; =&gt; &#39;000201&#39;, //业务类型 &#39;frontUrl&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;frontUrl, //前台通知地址 &#39;backUrl&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;backUrl, //后台通知地址 &#39;signMethod&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;signMethod, //签名方法 &#39;channelType&#39; =&gt; &#39;08&#39;, //渠道类型，07-PC，08-手机 &#39;accessType&#39; =&gt; &#39;0&#39;, //接入类型 &#39;currencyCode&#39; =&gt; &#39;156&#39;, //交易币种，境内商户固定156 //TODO 以下信息需要填写 &#39;merId&#39; =&gt; &#39;&#39;, //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 &#39;orderId&#39; =&gt; $out_trade_no, //商户订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数，可以自行定制规则 &#39;txnTime&#39; =&gt; $send_time, //订单发送时间，格式为YYYYMMDDhhmmss，取北京时间，此处默认取demo演示页面传递的参数 &#39;txnAmt&#39; =&gt; $total_amount*100, //交易金额，单位分，此处默认取demo演示页面传递的参数 // 订单超时时间。 // 超过此时间后，除网银交易外，其他交易银联系统会拒绝受理，提示超时。 跳转银行网银交易如果超时后交易成功，会自动退款，大约5个工作日金额返还到持卡人账户。 // 此时间建议取支付时的北京时间加15分钟。 // 超过超时时间调查询接口应答origRespCode不是A6或者00的就可以判断为失败。 &#39;payTimeout&#39; =&gt; $time_out // 请求方保留域， // 透传字段，查询、通知、对账文件中均会原样出现，如有需要请启用并修改自己希望透传的数据。 // 出现部分特殊字符时可能影响解析，请按下面建议的方式填写： // 1. 如果能确定内容不会出现&amp;={}[]&quot;&#39;等符号时，可以直接填写数据，建议的方法如下。 // &#39;reqReserved&#39; =&gt;&#39;透传信息1|透传信息2|透传信息3&#39;, // 2. 内容可能出现&amp;={}[]&quot;&#39;符号时： // 1) 如果需要对账文件里能显示，可将字符替换成全角＆＝｛｝【】“‘字符（自己写代码，此处不演示）； // 2) 如果对账文件没有显示要求，可做一下base64（如下）。 // 注意控制数据长度，实际传输的数据长度不能超过1024位。 // 查询、通知等接口解析时使用base64_decode解base64后再对数据做后续解析。 // &#39;reqReserved&#39; =&gt; base64_encode(&#39;任意格式的信息都可以&#39;), //TODO 其他特殊用法请查看 special_use_purchase.php ); com\unionpay\acp\sdk\AcpService::sign ( $params ); $uri = com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;frontTransUrl; $html_form = com\unionpay\acp\sdk\AcpService::createAutoFormHtml( $params, $uri ); echo $html_form; ?&gt; 修改demo/api_01_gateway/FrontReceive.php(前台同步通知) &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; /** * 交易说明： 前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。 * 为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。 * 未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0 */ $logger = com\unionpay\acp\sdk\LogUtil::getLogger(); $logger-&gt;LogInfo(&quot;receive front notify: &quot; . com\unionpay\acp\sdk\createLinkString ( $_POST, false, true )); //页面回跳地址 $fail_back_url = WEBPATH_DIR_INC.&#39;enter-query.html&#39;; $succ_back_url = WEBPATH_DIR_INC.&#39;enter-query.html&#39;; //验签 if (isset ( $_POST [&#39;signature&#39;] )) { $result = com\unionpay\acp\sdk\AcpService::validate ( $_POST ); if($result){//验签成功 $respCode = $_POST [&#39;respCode&#39;];//应答码 if($respCode==&#39;00&#39; || $respCode==&#39;A6&#39;){//交易成功 //请在这里加上商户的业务逻辑程序代码 //返回参数 $orderId = $_POST [&#39;orderId&#39;];//商户订单号 $totalAmount = $_POST[&#39;txnAmt&#39;];//交易金额 $merId = $_POST[&#39;merId&#39;];//商户代码 $res = &#39;success&#39;; //判断支付类型（提现还是借贷） $type = substr($orderId,0,2); //获取对应订单信息 if($type==&#39;tx&#39;){ $order_info = get_order_info($orderId); //验证订单数据 if(empty($order_info)){ $res = &#39;fail&#39;; } if($totalAmount != $order_info[&#39;o_totalprice&#39;]*100){ $res = &#39;fail&#39;; } } if($type==&#39;jd&#39;){ $order_info = get_loan_order_info($orderId); //验证订单数据 if(empty($order_info)){ $res = &#39;fail&#39;; } if($totalAmount != $order_info[&#39;l_returnnum&#39;]*100){ $res = &#39;fail&#39;; } } //验证商户代码 //TODO }else{ $res = &#39;fail&#39;; } }else{ $res = &#39;fail&#39;; } } else { $res = &#39;fail&#39;; } ?&gt; &lt;html&gt; &lt;head&gt; &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;/&gt; &lt;title&gt;银联支付-订单支付&lt;/title&gt; &lt;script type=&quot;text/javascript&quot;&gt; function callpay(){ var res = &#39;&lt;?php echo $res;?&gt;&#39;; if(res==&#39;success&#39;){ var Idiv = document.getElementById(&quot;pay_error2&quot;); }else{ var Idiv = document.getElementById(&quot;pay_error&quot;); } Idiv.style.display = &quot;block&quot;; } //页面进入即进行支付 window.onload = function(){ callpay(); }; &lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;style&gt; *{ margin:0; padding:0; background:#e1e1e1;} #pay_error, #pay_error2{ display:none; width:90%; height:100%; text-align:center; color:#fe5f16; font-size:20px; padding:20px 0; font-weight:bolder; border:1px solid #ccc; margin:0 5%; height:100px; margin-top:50%; border-radius:10px; background:#fff;} #pay_error p,#pay_error2 p{ background:#fff;} #pay_error a,#pay_error2 a{ background:#83da49; color:#fff; text-decoration:none; display:block; padding:10px 0; width:60%; margin-left:20%; margin-top:20px;} &lt;/style&gt; &lt;div id=&quot;pay_error&quot;&gt; &lt;p class=&quot;p1&quot;&gt;支付失败，请重新完成支付！&lt;/p&gt; &lt;p class=&quot;bt&quot;&gt;&lt;a href=&quot;&lt;?php echo $fail_back_url;?&gt;&quot;&gt;确定&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;div id=&quot;pay_error2&quot;&gt; &lt;p class=&quot;p1&quot;&gt;恭喜你，支付成功&lt;/p&gt; &lt;p class=&quot;bt&quot;&gt;&lt;a href=&quot;&lt;?php echo $succ_back_url;?&gt;&quot;&gt;确定&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;/body&gt; &lt;/html&gt; 修改demo/api_01_gateway/BackReceive.php(后台异步通知) &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; include_once &quot;Form_6_5_Query.php&quot;; /** * 交易说明： 前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。 * 为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。 * 未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0 */ $logger = com\unionpay\acp\sdk\LogUtil::getLogger(); $logger-&gt;LogInfo(&quot;receive back notify: &quot; . com\unionpay\acp\sdk\createLinkString ( $_POST, false, true )); //验签 if (isset ( $_POST [&#39;signature&#39;] )) { $result = com\unionpay\acp\sdk\AcpService::validate ( $_POST ); if($result){//验签成功 $respCode = $_POST [&#39;respCode&#39;];//应答码 if($respCode==&#39;00&#39; || $respCode==&#39;A6&#39;){//交易成功 //返回参数 $orderId = $_POST [&#39;orderId&#39;];//商户订单号 $totalAmount = $_POST[&#39;txnAmt&#39;];//交易金额 $merId = $_POST[&#39;merId&#39;];//商户代码 $txnTime = $_POST[&#39;txnTime&#39;];//订单发送时间 $trade_no = $_POST[&#39;queryId&#39;];//银联流水号 //发起查询交易接口 $check_res = check_Trade_Res($orderId,$merId,$txnTime,THIS_DATETIME); if($check_res==&#39;200&#39;){ //成功 //请在这里加上商户的业务逻辑程序代码 //判断支付类型（提现还是借贷） $type = substr($orderId,0,2); //获取对应订单信息 if($type==&#39;tx&#39;){ $order_info = get_order_info($orderId); //验证订单数据 if(empty($order_info)){ echo &#39;fail&#39;; return; } if($totalAmount != $order_info[&#39;o_totalprice&#39;]*100){ echo &#39;fail&#39;; return; } } if($type==&#39;jd&#39;){ $order_info = get_loan_order_info($orderId); //验证订单数据 if(empty($order_info)){ echo &#39;fail&#39;; return; } if($totalAmount != $order_info[&#39;l_returnnum&#39;]*100){ echo &#39;fail&#39;; return; } } //验证商户代码 //TODO //执行成功后的业务程序 if($type==&#39;tx&#39;){ if($order_info[&#39;o_status&#39;]==4){ //执行业务处理 //取出礼包码 $sql = &quot;select sysid,gc_code from &quot;.get_table(&quot;game_gift_code&quot;).&quot; where gc_status=1 limit 1&quot;; $query = $GLOBALS[&quot;conn&quot;]-&gt;Query($sql); $value = $GLOBALS[&#39;conn&#39;]-&gt;FetchArray($query); $up_arr = array( &#39;o_status&#39; =&gt; 1, &#39;o_trade_no&#39; =&gt; $trade_no, &#39;o_giftcode&#39; =&gt; $value[&#39;gc_code&#39;] ); $up_where = &quot; and o_orderid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $row = update_record($GLOBALS[&quot;conn&quot;],&#39;game_order&#39;,$up_arr,array(),$up_where);//更新订单数据 if($row&gt;0){ $msg = &quot;订单 &quot;.$orderId.&quot; 已支付&quot;; $log_msg = &quot;call back:&quot; . $msg; sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;notify_order_success&quot;); //更新礼包码状态 $up_gift = array( &#39;gc_status&#39;=&gt;2, &#39;gc_time&#39; =&gt; THIS_DATETIME, &#39;gc_orderid&#39; =&gt; $orderId ); $gift_where = &quot; and sysid=&quot;.$value[&#39;sysid&#39;]; update_record($GLOBALS[&quot;conn&quot;],&#39;game_gift_code&#39;,$up_gift,array(),$gift_where); //更新商品出售数量 /*$where = &quot; and og_sysid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $garr = get_info($GLOBALS[&#39;conn&#39;],&quot;game_order_goods&quot;,array(&#39;og_goodsid&#39;),$where,&#39;&#39;,true); foreach($garr as $k=&gt;$v){ $up_num = array( &#39;g_sellnum&#39; =&gt; &#39;g_sellnum&#39;+1 ); $num_where = &quot; and g_id=&#39;&quot;.$v.&quot;&#39;&quot;; update_record($GLOBALS[&#39;conn&#39;],&quot;game_goods&quot;,$up_num,array(),$num_where);//更新商品出售 }*/ //新增用户消息 $title = &#39;付款成功，请试用后尽快退款&#39;;//标题 $content = &#39;您的订单[&#39;.$orderId.&#39;]已经付款成功，&lt;br&gt;道具试用后可申请退款退回绑定借记卡，适合现金紧缺的玩家！系统赠送您的游戏兑换码:&#39;.$value[&#39;gc_code&#39;].&#39;，可以在您的游戏中进行使用，感谢您的支持！&lt;br&gt;如需帮助，请点击左上角【帮助】找到您的问题或者联系客服进行人工服务，QQ:2013609564&#39;; add_player_msg($order_info[&#39;o_playerid&#39;],$title,$content); } } } if($type==&#39;jd&#39;){ if($order_info[&#39;l_status&#39;]==3){ //执行业务处理 $up_arr = array( &#39;l_status&#39; =&gt; 4, &#39;l_trade_no&#39; =&gt; $trade_no, &#39;l_returntime&#39; =&gt; THIS_DATETIME ); $up_where = &quot; and l_orderid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $row = update_record($GLOBALS[&quot;conn&quot;],&#39;game_loan_order&#39;,$up_arr,array(),$up_where);//更新订单数据 if($row&gt;0){ $msg = &quot;订单 &quot;.$orderId.&quot; 已支付&quot;; $log_msg = &quot;call back:&quot; . $msg; sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;notify_order_success&quot;); } } } echo &quot;success&quot;; }else{ echo &quot;fail&quot;; } }else{ echo &#39;fail&#39;; } }else{ echo &#39;fail&#39;; } } else { echo &#39;fail&#39;; } ?&gt; 封装主动查询交易结果接口方法 &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); header ( &#39;Content-type:text/html;charset=utf-8&#39; ); //include_once $_SERVER [&#39;DOCUMENT_ROOT&#39;] . &#39;/upacp_demo_b2c/sdk/acp_service.php&#39;; /** * 重要：联调测试时请仔细阅读注释！ * * 产品：跳转网关支付产品&lt;br&gt; * 交易：交易状态查询交易：只有同步应答 &lt;br&gt; * 日期： 2015-09&lt;br&gt; * 版本： 1.0.0 * 版权： 中国银联&lt;br&gt; * 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能及规范性等方面的保障&lt;br&gt; * 该接口参考文档位置：open.unionpay.com帮助中心 下载 产品接口规范 《网关支付产品接口规范》，&lt;br&gt; * 《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表）&lt;br&gt; * 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案： * 调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案 * 测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案 * 2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。 * 交易说明： 1）对前台交易发起交易状态查询：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。 * 2）对后台交易发起交易状态查询：后台类资金类交易同步返回00，成功银联有后台通知，商户也可以发起 查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。 * 后台类资金类同步返03 04 05响应码及未得到银联响应（读超时）需发起查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。 */ function check_Trade_Res($orderId,$merId,$txnTime,$firTime=THIS_DATETIME){ $params = array( //以下信息非特殊情况不需要改动 &#39;version&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;version, //版本号 &#39;encoding&#39; =&gt; &#39;utf-8&#39;, //编码方式 &#39;signMethod&#39; =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;signMethod, //签名方法 &#39;txnType&#39; =&gt; &#39;00&#39;, //交易类型 &#39;txnSubType&#39; =&gt; &#39;00&#39;, //交易子类 &#39;bizType&#39; =&gt; &#39;000000&#39;, //业务类型 &#39;accessType&#39; =&gt; &#39;0&#39;, //接入类型 &#39;channelType&#39; =&gt; &#39;07&#39;, //渠道类型 //TODO 以下信息需要填写 &#39;orderId&#39; =&gt; $orderId, //请修改被查询的交易的订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数 &#39;merId&#39; =&gt; $merId, //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 &#39;txnTime&#39; =&gt; $txnTime,//请修改被查询的交易的订单发送时间，格式为YYYYMMDDhhmmss，此处默认取demo演示页面传递的参数 ); com\unionpay\acp\sdk\AcpService::sign ( $params ); // 签名 $url = com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;singleQueryUrl; $result_arr = com\unionpay\acp\sdk\AcpService::post ( $params, $url); if(count($result_arr)&lt;=0) { //没收到200应答的情况 //printResult ( $url, $params, &quot;&quot; ); return; } //printResult ($url, $params, $result_arr ); //页面打印请求应答数据 if (!com\unionpay\acp\sdk\AcpService::validate ($result_arr) ){ return &#39;400&#39;; } if ($result_arr[&quot;respCode&quot;] == &quot;00&quot;){ if ($result_arr[&quot;origRespCode&quot;] == &quot;00&quot;){ //交易成功 //TODO //echo &quot;交易成功。&lt;br&gt;\n&quot;; return &#39;200&#39;; } else if ($result_arr[&quot;origRespCode&quot;] == &quot;03&quot; || $result_arr[&quot;origRespCode&quot;] == &quot;04&quot; || $result_arr[&quot;origRespCode&quot;] == &quot;05&quot;){ //后续需发起交易状态查询交易确定交易状态 //TODO //echo &quot;交易处理中，请稍微查询。&lt;br&gt;\n&quot;; //间隔查询 ignore_user_abort(1); set_time_limit(0); $interval = 60*5;//5分钟 sleep($interval); do{ if(THIS_DATETIME-$firTime&gt;60*120){ return &#39;400&#39;; } check_Trade_Res($orderId,$merId,$txnTime);//再次查询 }while(true); } else { //其他应答码做以失败处理 //TODO //echo &quot;交易失败：&quot; . $result_arr[&quot;origRespMsg&quot;] . &quot;。&lt;br&gt;\n&quot;; return &#39;400&#39;; } } else if ($result_arr[&quot;respCode&quot;] == &quot;03&quot; || $result_arr[&quot;respCode&quot;] == &quot;04&quot; || $result_arr[&quot;respCode&quot;] == &quot;05&quot; ){ //后续需发起交易状态查询交易确定交易状态 //TODO //echo &quot;处理超时，请稍微查询。&lt;br&gt;\n&quot;; //间隔查询 ignore_user_abort(1); set_time_limit(0); $interval = 60*5;//5分钟 sleep($interval); do{ if(THIS_DATETIME-$firTime&gt;60*120){ return &#39;400&#39;; } check_Trade_Res($orderId,$merId,$txnTime);//再次查询 }while(true); } else { //其他应答码做以失败处理 //TODO //echo &quot;失败：&quot; . $result_arr[&quot;respMsg&quot;] . &quot;。&lt;br&gt;\n&quot;; return &#39;400&#39;; } } /** * 打印请求应答 * * @param * $url * @param * $req * @param * $resp */ function printResult($url, $req, $resp) { echo &quot;=============&lt;br&gt;\n&quot;; echo &quot;地址：&quot; . $url . &quot;&lt;br&gt;\n&quot;; echo &quot;请求：&quot; . str_replace ( &quot;\n&quot;, &quot;\n&lt;br&gt;&quot;, htmlentities ( com\unionpay\acp\sdk\createLinkString ( $req, false, true ) ) ) . &quot;&lt;br&gt;\n&quot;; echo &quot;应答：&quot; . str_replace ( &quot;\n&quot;, &quot;\n&lt;br&gt;&quot;, htmlentities ( com\unionpay\acp\sdk\createLinkString ( $resp , false, false )) ) . &quot;&lt;br&gt;\n&quot;; echo &quot;=============&lt;br&gt;\n&quot;; } 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/12/05/6988b04ae83ea2660ac7d3eb5c918735.html" />
<meta property="og:url" content="https://mlh.app/2017/12/05/6988b04ae83ea2660ac7d3eb5c918735.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-12-05T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"银联支付用的还是比较少的，而且开发中也没接触多少，不过因为工作项目用银联支付能降低费率，所以还是接入了银联支付。本文支付为银联网关和WAP支付接口。 官方网站SDK&amp;DEMO:https://open.unionpay.com/ajweb/product/detail?id=66 产品API: https://open.unionpay.com/ajweb/product/newProApiShow?proId=1&amp;apiId=63 API文档 https://open.unionpay.com/ajweb/help/api 在开始之前要仔细阅读官方包里的说明文件，必要的证书和商户信息要提前获取。 实例代码及步骤： 修改demo/api_01_gateway/Form_6_2_FrontConsume.php(发送订单参数，跳转支付界面) &lt;?php header ( &#39;Content-type:text/html;charset=utf-8&#39; ); include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; /** * 重要：联调测试时请仔细阅读注释！ * * 产品：跳转网关支付产品&lt;br&gt; * 交易：消费：前台跳转，有前台通知应答和后台通知应答&lt;br&gt; * 日期： 2015-09&lt;br&gt; * 版本： 1.0.0 * 版权： 中国银联&lt;br&gt; * 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能规范性等方面的保障&lt;br&gt; * 提示：该接口参考文档位置：open.unionpay.com帮助中心 下载 产品接口规范 《网关支付产品接口规范》，&lt;br&gt; * 《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表)&lt;br&gt; * 《全渠道平台接入接口规范 第3部分 文件接口》（对账文件格式说明）&lt;br&gt; * 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案： * 调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案 * 测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案 * 2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。 * 交易说明:1）以后台通知或交易状态查询交易确定交易成功,前台通知不能作为判断成功的标准. * 2）交易状态查询交易（Form_6_5_Query）建议调用机制：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。 */ //接收支付数据 $order_data = trim(get_param(&quot;orderDa&quot;)); //订单数据 if($order_data == &quot;&quot; ){ $mssage = &quot;数据不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } $result_order = json_decode(uc_authcode(base64_decode($order_data), &#39;DECODE&#39;, ADMIN_KEY),true); //商户订单号，商户网站订单系统中唯一订单号，必填 $out_trade_no = $result_order[&#39;WIDout_trade_no&#39;]; //付款金额，必填(单位元) $total_amount = $result_order[&#39;WIDtotal_amount&#39;]; //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 //订单发送时间 $send_time = date(&#39;YmdHis&#39;,THIS_DATETIME); //订单超时时间 $time_out = date(&#39;YmdHis&#39;,strtotime(&#39;+15 minutes&#39;,THIS_DATETIME)); //验证数据 $pay_md5 = $result_order[&#39;infoPy&#39;]; //订单验证 if($out_trade_no==&#39;&#39;){ $mssage = &quot;订单号不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } if($total_amount==&#39;&#39; || $total_amount==0){ $mssage = &quot;订单金额不能为空&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //购买商品 if($result_order[&#39;flag&#39;]==&#39;paycard&#39;){ //检测是否有订单号 $where = &quot; and o_orderid = &#39;&quot;.$out_trade_no.&quot;&#39; and o_totalprice=&#39;&quot;.$total_amount.&quot;&#39; and o_status=4 &quot;; $info = get_info($GLOBALS[&quot;conn&quot;],&quot;game_order&quot;,array(),$where); if( empty($info) ){ $mssage = &quot;没有此订单！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //验证数据 $p_arr = array( &#39;uid&#39;=&gt;$info[&#39;o_playerid&#39;], &#39;uorder&#39;=&gt;$info[&#39;o_orderid&#39;], &#39;uprice&#39;=&gt;$info[&#39;o_totalprice&#39;],); $p_time = $info[&#39;o_addtime&#39;]; $p_key = ADMIN_KEY; $p_md5 = md5($p_arr.$p_time.$p_key); if( $p_md5 != $pay_md5 ){ $mssage = &quot;请勿非法操作！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } } //申请还款 if($result_order[&#39;flag&#39;]==&#39;repayment&#39;){ //检测是否有订单号 $where = &quot; and l_orderid = &#39;&quot;.$out_trade_no.&quot;&#39; and l_returnnum=&#39;&quot;.$total_amount.&quot;&#39; and l_status=3 &quot;; $info = get_info($GLOBALS[&quot;conn&quot;],&quot;game_loan_order&quot;,array(),$where); if( empty($info) ){ $mssage = &quot;没有此订单！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } //验证数据 $p_arr = array( &#39;uid&#39;=&gt;$info[&#39;l_playerid&#39;], &#39;uorder&#39;=&gt;$info[&#39;l_orderid&#39;], &#39;uprice&#39;=&gt;$info[&#39;l_returnnum&#39;]); $p_time = $info[&#39;l_addtime&#39;]; $p_key = ADMIN_KEY; $p_md5 = md5($p_arr.$p_time.$p_key); if( $p_md5 != $pay_md5 ){ $mssage = &quot;请勿非法操作！&quot;; showinfo($mssage,&#39;&#39; ,3); exit; } } //记录要提交的订单信息到日志 $log_msg = &quot;订单内容:&quot; . json_encode($result_order); sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;jsapi&quot;); $params = array( //以下信息非特殊情况不需要改动 &#39;version&#39; =&gt; com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;version, //版本号 &#39;encoding&#39; =&gt; &#39;utf-8&#39;, //编码方式 &#39;txnType&#39; =&gt; &#39;01&#39;, //交易类型 &#39;txnSubType&#39; =&gt; &#39;01&#39;, //交易子类 &#39;bizType&#39; =&gt; &#39;000201&#39;, //业务类型 &#39;frontUrl&#39; =&gt; com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;frontUrl, //前台通知地址 &#39;backUrl&#39; =&gt; com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;backUrl, //后台通知地址 &#39;signMethod&#39; =&gt; com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;signMethod, //签名方法 &#39;channelType&#39; =&gt; &#39;08&#39;, //渠道类型，07-PC，08-手机 &#39;accessType&#39; =&gt; &#39;0&#39;, //接入类型 &#39;currencyCode&#39; =&gt; &#39;156&#39;, //交易币种，境内商户固定156 //TODO 以下信息需要填写 &#39;merId&#39; =&gt; &#39;&#39;, //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 &#39;orderId&#39; =&gt; $out_trade_no, //商户订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数，可以自行定制规则 &#39;txnTime&#39; =&gt; $send_time, //订单发送时间，格式为YYYYMMDDhhmmss，取北京时间，此处默认取demo演示页面传递的参数 &#39;txnAmt&#39; =&gt; $total_amount*100, //交易金额，单位分，此处默认取demo演示页面传递的参数 // 订单超时时间。 // 超过此时间后，除网银交易外，其他交易银联系统会拒绝受理，提示超时。 跳转银行网银交易如果超时后交易成功，会自动退款，大约5个工作日金额返还到持卡人账户。 // 此时间建议取支付时的北京时间加15分钟。 // 超过超时时间调查询接口应答origRespCode不是A6或者00的就可以判断为失败。 &#39;payTimeout&#39; =&gt; $time_out // 请求方保留域， // 透传字段，查询、通知、对账文件中均会原样出现，如有需要请启用并修改自己希望透传的数据。 // 出现部分特殊字符时可能影响解析，请按下面建议的方式填写： // 1. 如果能确定内容不会出现&amp;={}[]&quot;&#39;等符号时，可以直接填写数据，建议的方法如下。 // &#39;reqReserved&#39; =&gt;&#39;透传信息1|透传信息2|透传信息3&#39;, // 2. 内容可能出现&amp;={}[]&quot;&#39;符号时： // 1) 如果需要对账文件里能显示，可将字符替换成全角＆＝｛｝【】“‘字符（自己写代码，此处不演示）； // 2) 如果对账文件没有显示要求，可做一下base64（如下）。 // 注意控制数据长度，实际传输的数据长度不能超过1024位。 // 查询、通知等接口解析时使用base64_decode解base64后再对数据做后续解析。 // &#39;reqReserved&#39; =&gt; base64_encode(&#39;任意格式的信息都可以&#39;), //TODO 其他特殊用法请查看 special_use_purchase.php ); com\\unionpay\\acp\\sdk\\AcpService::sign ( $params ); $uri = com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;frontTransUrl; $html_form = com\\unionpay\\acp\\sdk\\AcpService::createAutoFormHtml( $params, $uri ); echo $html_form; ?&gt; 修改demo/api_01_gateway/FrontReceive.php(前台同步通知) &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; /** * 交易说明： 前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。 * 为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。 * 未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0 */ $logger = com\\unionpay\\acp\\sdk\\LogUtil::getLogger(); $logger-&gt;LogInfo(&quot;receive front notify: &quot; . com\\unionpay\\acp\\sdk\\createLinkString ( $_POST, false, true )); //页面回跳地址 $fail_back_url = WEBPATH_DIR_INC.&#39;enter-query.html&#39;; $succ_back_url = WEBPATH_DIR_INC.&#39;enter-query.html&#39;; //验签 if (isset ( $_POST [&#39;signature&#39;] )) { $result = com\\unionpay\\acp\\sdk\\AcpService::validate ( $_POST ); if($result){//验签成功 $respCode = $_POST [&#39;respCode&#39;];//应答码 if($respCode==&#39;00&#39; || $respCode==&#39;A6&#39;){//交易成功 //请在这里加上商户的业务逻辑程序代码 //返回参数 $orderId = $_POST [&#39;orderId&#39;];//商户订单号 $totalAmount = $_POST[&#39;txnAmt&#39;];//交易金额 $merId = $_POST[&#39;merId&#39;];//商户代码 $res = &#39;success&#39;; //判断支付类型（提现还是借贷） $type = substr($orderId,0,2); //获取对应订单信息 if($type==&#39;tx&#39;){ $order_info = get_order_info($orderId); //验证订单数据 if(empty($order_info)){ $res = &#39;fail&#39;; } if($totalAmount != $order_info[&#39;o_totalprice&#39;]*100){ $res = &#39;fail&#39;; } } if($type==&#39;jd&#39;){ $order_info = get_loan_order_info($orderId); //验证订单数据 if(empty($order_info)){ $res = &#39;fail&#39;; } if($totalAmount != $order_info[&#39;l_returnnum&#39;]*100){ $res = &#39;fail&#39;; } } //验证商户代码 //TODO }else{ $res = &#39;fail&#39;; } }else{ $res = &#39;fail&#39;; } } else { $res = &#39;fail&#39;; } ?&gt; &lt;html&gt; &lt;head&gt; &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;/&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;/&gt; &lt;title&gt;银联支付-订单支付&lt;/title&gt; &lt;script type=&quot;text/javascript&quot;&gt; function callpay(){ var res = &#39;&lt;?php echo $res;?&gt;&#39;; if(res==&#39;success&#39;){ var Idiv = document.getElementById(&quot;pay_error2&quot;); }else{ var Idiv = document.getElementById(&quot;pay_error&quot;); } Idiv.style.display = &quot;block&quot;; } //页面进入即进行支付 window.onload = function(){ callpay(); }; &lt;/script&gt; &lt;/head&gt; &lt;body&gt; &lt;style&gt; *{ margin:0; padding:0; background:#e1e1e1;} #pay_error, #pay_error2{ display:none; width:90%; height:100%; text-align:center; color:#fe5f16; font-size:20px; padding:20px 0; font-weight:bolder; border:1px solid #ccc; margin:0 5%; height:100px; margin-top:50%; border-radius:10px; background:#fff;} #pay_error p,#pay_error2 p{ background:#fff;} #pay_error a,#pay_error2 a{ background:#83da49; color:#fff; text-decoration:none; display:block; padding:10px 0; width:60%; margin-left:20%; margin-top:20px;} &lt;/style&gt; &lt;div id=&quot;pay_error&quot;&gt; &lt;p class=&quot;p1&quot;&gt;支付失败，请重新完成支付！&lt;/p&gt; &lt;p class=&quot;bt&quot;&gt;&lt;a href=&quot;&lt;?php echo $fail_back_url;?&gt;&quot;&gt;确定&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;div id=&quot;pay_error2&quot;&gt; &lt;p class=&quot;p1&quot;&gt;恭喜你，支付成功&lt;/p&gt; &lt;p class=&quot;bt&quot;&gt;&lt;a href=&quot;&lt;?php echo $succ_back_url;?&gt;&quot;&gt;确定&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;/body&gt; &lt;/html&gt; 修改demo/api_01_gateway/BackReceive.php(后台异步通知) &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . &#39;./../../sdk/acp_service.php&#39;; include_once &quot;Form_6_5_Query.php&quot;; /** * 交易说明： 前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。 * 为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。 * 未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0 */ $logger = com\\unionpay\\acp\\sdk\\LogUtil::getLogger(); $logger-&gt;LogInfo(&quot;receive back notify: &quot; . com\\unionpay\\acp\\sdk\\createLinkString ( $_POST, false, true )); //验签 if (isset ( $_POST [&#39;signature&#39;] )) { $result = com\\unionpay\\acp\\sdk\\AcpService::validate ( $_POST ); if($result){//验签成功 $respCode = $_POST [&#39;respCode&#39;];//应答码 if($respCode==&#39;00&#39; || $respCode==&#39;A6&#39;){//交易成功 //返回参数 $orderId = $_POST [&#39;orderId&#39;];//商户订单号 $totalAmount = $_POST[&#39;txnAmt&#39;];//交易金额 $merId = $_POST[&#39;merId&#39;];//商户代码 $txnTime = $_POST[&#39;txnTime&#39;];//订单发送时间 $trade_no = $_POST[&#39;queryId&#39;];//银联流水号 //发起查询交易接口 $check_res = check_Trade_Res($orderId,$merId,$txnTime,THIS_DATETIME); if($check_res==&#39;200&#39;){ //成功 //请在这里加上商户的业务逻辑程序代码 //判断支付类型（提现还是借贷） $type = substr($orderId,0,2); //获取对应订单信息 if($type==&#39;tx&#39;){ $order_info = get_order_info($orderId); //验证订单数据 if(empty($order_info)){ echo &#39;fail&#39;; return; } if($totalAmount != $order_info[&#39;o_totalprice&#39;]*100){ echo &#39;fail&#39;; return; } } if($type==&#39;jd&#39;){ $order_info = get_loan_order_info($orderId); //验证订单数据 if(empty($order_info)){ echo &#39;fail&#39;; return; } if($totalAmount != $order_info[&#39;l_returnnum&#39;]*100){ echo &#39;fail&#39;; return; } } //验证商户代码 //TODO //执行成功后的业务程序 if($type==&#39;tx&#39;){ if($order_info[&#39;o_status&#39;]==4){ //执行业务处理 //取出礼包码 $sql = &quot;select sysid,gc_code from &quot;.get_table(&quot;game_gift_code&quot;).&quot; where gc_status=1 limit 1&quot;; $query = $GLOBALS[&quot;conn&quot;]-&gt;Query($sql); $value = $GLOBALS[&#39;conn&#39;]-&gt;FetchArray($query); $up_arr = array( &#39;o_status&#39; =&gt; 1, &#39;o_trade_no&#39; =&gt; $trade_no, &#39;o_giftcode&#39; =&gt; $value[&#39;gc_code&#39;] ); $up_where = &quot; and o_orderid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $row = update_record($GLOBALS[&quot;conn&quot;],&#39;game_order&#39;,$up_arr,array(),$up_where);//更新订单数据 if($row&gt;0){ $msg = &quot;订单 &quot;.$orderId.&quot; 已支付&quot;; $log_msg = &quot;call back:&quot; . $msg; sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;notify_order_success&quot;); //更新礼包码状态 $up_gift = array( &#39;gc_status&#39;=&gt;2, &#39;gc_time&#39; =&gt; THIS_DATETIME, &#39;gc_orderid&#39; =&gt; $orderId ); $gift_where = &quot; and sysid=&quot;.$value[&#39;sysid&#39;]; update_record($GLOBALS[&quot;conn&quot;],&#39;game_gift_code&#39;,$up_gift,array(),$gift_where); //更新商品出售数量 /*$where = &quot; and og_sysid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $garr = get_info($GLOBALS[&#39;conn&#39;],&quot;game_order_goods&quot;,array(&#39;og_goodsid&#39;),$where,&#39;&#39;,true); foreach($garr as $k=&gt;$v){ $up_num = array( &#39;g_sellnum&#39; =&gt; &#39;g_sellnum&#39;+1 ); $num_where = &quot; and g_id=&#39;&quot;.$v.&quot;&#39;&quot;; update_record($GLOBALS[&#39;conn&#39;],&quot;game_goods&quot;,$up_num,array(),$num_where);//更新商品出售 }*/ //新增用户消息 $title = &#39;付款成功，请试用后尽快退款&#39;;//标题 $content = &#39;您的订单[&#39;.$orderId.&#39;]已经付款成功，&lt;br&gt;道具试用后可申请退款退回绑定借记卡，适合现金紧缺的玩家！系统赠送您的游戏兑换码:&#39;.$value[&#39;gc_code&#39;].&#39;，可以在您的游戏中进行使用，感谢您的支持！&lt;br&gt;如需帮助，请点击左上角【帮助】找到您的问题或者联系客服进行人工服务，QQ:2013609564&#39;; add_player_msg($order_info[&#39;o_playerid&#39;],$title,$content); } } } if($type==&#39;jd&#39;){ if($order_info[&#39;l_status&#39;]==3){ //执行业务处理 $up_arr = array( &#39;l_status&#39; =&gt; 4, &#39;l_trade_no&#39; =&gt; $trade_no, &#39;l_returntime&#39; =&gt; THIS_DATETIME ); $up_where = &quot; and l_orderid=&#39;&quot;.$orderId.&quot;&#39;&quot;; $row = update_record($GLOBALS[&quot;conn&quot;],&#39;game_loan_order&#39;,$up_arr,array(),$up_where);//更新订单数据 if($row&gt;0){ $msg = &quot;订单 &quot;.$orderId.&quot; 已支付&quot;; $log_msg = &quot;call back:&quot; . $msg; sys_log_write_content( $log_msg.__FILE__.__LINE__ ,&quot;pay_log&quot;,&quot;notify_order_success&quot;); } } } echo &quot;success&quot;; }else{ echo &quot;fail&quot;; } }else{ echo &#39;fail&#39;; } }else{ echo &#39;fail&#39;; } } else { echo &#39;fail&#39;; } ?&gt; 封装主动查询交易结果接口方法 &lt;?php include_once(&quot;../../../../include/config.inc.php&quot;); header ( &#39;Content-type:text/html;charset=utf-8&#39; ); //include_once $_SERVER [&#39;DOCUMENT_ROOT&#39;] . &#39;/upacp_demo_b2c/sdk/acp_service.php&#39;; /** * 重要：联调测试时请仔细阅读注释！ * * 产品：跳转网关支付产品&lt;br&gt; * 交易：交易状态查询交易：只有同步应答 &lt;br&gt; * 日期： 2015-09&lt;br&gt; * 版本： 1.0.0 * 版权： 中国银联&lt;br&gt; * 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能及规范性等方面的保障&lt;br&gt; * 该接口参考文档位置：open.unionpay.com帮助中心 下载 产品接口规范 《网关支付产品接口规范》，&lt;br&gt; * 《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表）&lt;br&gt; * 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案： * 调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案 * 测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案 * 2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。 * 交易说明： 1）对前台交易发起交易状态查询：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。 * 2）对后台交易发起交易状态查询：后台类资金类交易同步返回00，成功银联有后台通知，商户也可以发起 查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。 * 后台类资金类同步返03 04 05响应码及未得到银联响应（读超时）需发起查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。 */ function check_Trade_Res($orderId,$merId,$txnTime,$firTime=THIS_DATETIME){ $params = array( //以下信息非特殊情况不需要改动 &#39;version&#39; =&gt; com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;version, //版本号 &#39;encoding&#39; =&gt; &#39;utf-8&#39;, //编码方式 &#39;signMethod&#39; =&gt; com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;signMethod, //签名方法 &#39;txnType&#39; =&gt; &#39;00&#39;, //交易类型 &#39;txnSubType&#39; =&gt; &#39;00&#39;, //交易子类 &#39;bizType&#39; =&gt; &#39;000000&#39;, //业务类型 &#39;accessType&#39; =&gt; &#39;0&#39;, //接入类型 &#39;channelType&#39; =&gt; &#39;07&#39;, //渠道类型 //TODO 以下信息需要填写 &#39;orderId&#39; =&gt; $orderId, //请修改被查询的交易的订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数 &#39;merId&#39; =&gt; $merId, //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数 &#39;txnTime&#39; =&gt; $txnTime,//请修改被查询的交易的订单发送时间，格式为YYYYMMDDhhmmss，此处默认取demo演示页面传递的参数 ); com\\unionpay\\acp\\sdk\\AcpService::sign ( $params ); // 签名 $url = com\\unionpay\\acp\\sdk\\SDKConfig::getSDKConfig()-&gt;singleQueryUrl; $result_arr = com\\unionpay\\acp\\sdk\\AcpService::post ( $params, $url); if(count($result_arr)&lt;=0) { //没收到200应答的情况 //printResult ( $url, $params, &quot;&quot; ); return; } //printResult ($url, $params, $result_arr ); //页面打印请求应答数据 if (!com\\unionpay\\acp\\sdk\\AcpService::validate ($result_arr) ){ return &#39;400&#39;; } if ($result_arr[&quot;respCode&quot;] == &quot;00&quot;){ if ($result_arr[&quot;origRespCode&quot;] == &quot;00&quot;){ //交易成功 //TODO //echo &quot;交易成功。&lt;br&gt;\\n&quot;; return &#39;200&#39;; } else if ($result_arr[&quot;origRespCode&quot;] == &quot;03&quot; || $result_arr[&quot;origRespCode&quot;] == &quot;04&quot; || $result_arr[&quot;origRespCode&quot;] == &quot;05&quot;){ //后续需发起交易状态查询交易确定交易状态 //TODO //echo &quot;交易处理中，请稍微查询。&lt;br&gt;\\n&quot;; //间隔查询 ignore_user_abort(1); set_time_limit(0); $interval = 60*5;//5分钟 sleep($interval); do{ if(THIS_DATETIME-$firTime&gt;60*120){ return &#39;400&#39;; } check_Trade_Res($orderId,$merId,$txnTime);//再次查询 }while(true); } else { //其他应答码做以失败处理 //TODO //echo &quot;交易失败：&quot; . $result_arr[&quot;origRespMsg&quot;] . &quot;。&lt;br&gt;\\n&quot;; return &#39;400&#39;; } } else if ($result_arr[&quot;respCode&quot;] == &quot;03&quot; || $result_arr[&quot;respCode&quot;] == &quot;04&quot; || $result_arr[&quot;respCode&quot;] == &quot;05&quot; ){ //后续需发起交易状态查询交易确定交易状态 //TODO //echo &quot;处理超时，请稍微查询。&lt;br&gt;\\n&quot;; //间隔查询 ignore_user_abort(1); set_time_limit(0); $interval = 60*5;//5分钟 sleep($interval); do{ if(THIS_DATETIME-$firTime&gt;60*120){ return &#39;400&#39;; } check_Trade_Res($orderId,$merId,$txnTime);//再次查询 }while(true); } else { //其他应答码做以失败处理 //TODO //echo &quot;失败：&quot; . $result_arr[&quot;respMsg&quot;] . &quot;。&lt;br&gt;\\n&quot;; return &#39;400&#39;; } } /** * 打印请求应答 * * @param * $url * @param * $req * @param * $resp */ function printResult($url, $req, $resp) { echo &quot;=============&lt;br&gt;\\n&quot;; echo &quot;地址：&quot; . $url . &quot;&lt;br&gt;\\n&quot;; echo &quot;请求：&quot; . str_replace ( &quot;\\n&quot;, &quot;\\n&lt;br&gt;&quot;, htmlentities ( com\\unionpay\\acp\\sdk\\createLinkString ( $req, false, true ) ) ) . &quot;&lt;br&gt;\\n&quot;; echo &quot;应答：&quot; . str_replace ( &quot;\\n&quot;, &quot;\\n&lt;br&gt;&quot;, htmlentities ( com\\unionpay\\acp\\sdk\\createLinkString ( $resp , false, false )) ) . &quot;&lt;br&gt;\\n&quot;; echo &quot;=============&lt;br&gt;\\n&quot;; } 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/12/05/6988b04ae83ea2660ac7d3eb5c918735.html","headline":"php实现银联网关/WAP支付接入","dateModified":"2017-12-05T00:00:00+08:00","datePublished":"2017-12-05T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/12/05/6988b04ae83ea2660ac7d3eb5c918735.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>php实现银联网关/WAP支付接入</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>银联支付用的还是比较少的，而且开发中也没接触多少，不过因为工作项目用银联支付能降低费率，所以还是接入了银联支付。本文支付为银联网关和WAP支付接口。</p> 
  <p>官方网站SDK&amp;DEMO:https://open.unionpay.com/ajweb/product/detail?id=66</p> 
  <p><span></span></p> 
  <div>
   产品API:
   <a href="https://open.unionpay.com/ajweb/product/newProApiShow?proId=1&amp;apiId=63" rel="nofollow">https://open.unionpay.com/ajweb/product/newProApiShow?proId=1&amp;apiId=63</a>
  </div> 
  <div>
   API文档
   <a href="https://open.unionpay.com/ajweb/help/api" rel="nofollow">https://open.unionpay.com/ajweb/help/api</a>
  </div> 在开始之前要仔细阅读官方包里的说明文件，必要的证书和商户信息要提前获取。 
  <p></p> 
  <p>实例代码及步骤：</p> 
  <p><span><span style="font-size:14pt;">修改demo/api_01_gateway/Form_6_2_FrontConsume.php(发送订单参数，跳转支付界面)</span></span></p> 
  <p></p>
  <pre><code class="language-html">&lt;?php
header ( 'Content-type:text/html;charset=utf-8' );
include_once("../../../../include/config.inc.php");
include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . './../../sdk/acp_service.php';

/**
* 重要：联调测试时请仔细阅读注释！
*
* 产品：跳转网关支付产品&lt;br&gt;
* 交易：消费：前台跳转，有前台通知应答和后台通知应答&lt;br&gt;
* 日期： 2015-09&lt;br&gt;
* 版本： 1.0.0
* 版权： 中国银联&lt;br&gt;
* 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能规范性等方面的保障&lt;br&gt;
* 提示：该接口参考文档位置：open.unionpay.com帮助中心 下载  产品接口规范  《网关支付产品接口规范》，&lt;br&gt;
*              《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表)&lt;br&gt;
*              《全渠道平台接入接口规范 第3部分 文件接口》（对账文件格式说明）&lt;br&gt;
* 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案：
*                                调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案
*                             测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案
*                          2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。
* 交易说明:1）以后台通知或交易状态查询交易确定交易成功,前台通知不能作为判断成功的标准.
*       2）交易状态查询交易（Form_6_5_Query）建议调用机制：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。
*/

//接收支付数据
$order_data       = trim(get_param("orderDa")); //订单数据
if($order_data == "" ){
    $mssage = "数据不能为空";
    showinfo($mssage,'' ,3);
    exit;
}
$result_order = json_decode(uc_authcode(base64_decode($order_data), 'DECODE', ADMIN_KEY),true);

//商户订单号，商户网站订单系统中唯一订单号，必填
$out_trade_no = $result_order['WIDout_trade_no'];

//付款金额，必填(单位元)
$total_amount = $result_order['WIDtotal_amount'];

//商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数


//订单发送时间
$send_time = date('YmdHis',THIS_DATETIME);

//订单超时时间
$time_out = date('YmdHis',strtotime('+15 minutes',THIS_DATETIME));

//验证数据
$pay_md5      = $result_order['infoPy'];            //订单验证

if($out_trade_no==''){
    $mssage = "订单号不能为空";
    showinfo($mssage,'' ,3);
    exit;
}
if($total_amount=='' || $total_amount==0){
    $mssage = "订单金额不能为空";
    showinfo($mssage,'' ,3);
    exit;
}

//购买商品
if($result_order['flag']=='paycard'){
    //检测是否有订单号
    $where = " and o_orderid = '".$out_trade_no."' and o_totalprice='".$total_amount."' and o_status=4  ";
    $info  = get_info($GLOBALS["conn"],"game_order",array(),$where);

    if( empty($info) ){
        $mssage = "没有此订单！";
        showinfo($mssage,'' ,3);
        exit;
    }
    //验证数据
    $p_arr  = array( 'uid'=&gt;$info['o_playerid'], 'uorder'=&gt;$info['o_orderid'], 'uprice'=&gt;$info['o_totalprice'],);
    $p_time = $info['o_addtime'];
    $p_key  = ADMIN_KEY;
    $p_md5  = md5($p_arr.$p_time.$p_key);
    if( $p_md5 != $pay_md5 ){
        $mssage = "请勿非法操作！";
        showinfo($mssage,'' ,3);
        exit;
    }
}

//申请还款
if($result_order['flag']=='repayment'){
    //检测是否有订单号
    $where = " and l_orderid = '".$out_trade_no."' and l_returnnum='".$total_amount."' and l_status=3  ";
    $info  = get_info($GLOBALS["conn"],"game_loan_order",array(),$where);

    if( empty($info) ){
        $mssage = "没有此订单！";
        showinfo($mssage,'' ,3);
        exit;
    }
    //验证数据
    $p_arr  = array( 'uid'=&gt;$info['l_playerid'], 'uorder'=&gt;$info['l_orderid'], 'uprice'=&gt;$info['l_returnnum']);
    $p_time = $info['l_addtime'];
    $p_key  = ADMIN_KEY;
    $p_md5  = md5($p_arr.$p_time.$p_key);
    if( $p_md5 != $pay_md5 ){
        $mssage = "请勿非法操作！";
        showinfo($mssage,'' ,3);
        exit;
    }
}

//记录要提交的订单信息到日志
$log_msg = "订单内容:" . json_encode($result_order);
sys_log_write_content( $log_msg.__FILE__.__LINE__ ,"pay_log","jsapi");

$params = array(
       
       //以下信息非特殊情况不需要改动
        'version' =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;version,                 //版本号
        'encoding' =&gt; 'utf-8',             //编码方式
        'txnType' =&gt; '01',                  //交易类型
        'txnSubType' =&gt; '01',              //交易子类
        'bizType' =&gt; '000201',             //业务类型
        'frontUrl' =&gt;  com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;frontUrl,  //前台通知地址
        'backUrl' =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;backUrl,     //后台通知地址
        'signMethod' =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;signMethod,                 //签名方法
        'channelType' =&gt; '08',              //渠道类型，07-PC，08-手机
        'accessType' =&gt; '0',                //接入类型
        'currencyCode' =&gt; '156',            //交易币种，境内商户固定156
       
       //TODO 以下信息需要填写
       'merId' =&gt; '',    //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数
        'orderId' =&gt; $out_trade_no,   //商户订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数，可以自行定制规则
        'txnTime' =&gt; $send_time,  //订单发送时间，格式为YYYYMMDDhhmmss，取北京时间，此处默认取demo演示页面传递的参数
        'txnAmt' =&gt; $total_amount*100,    //交易金额，单位分，此处默认取demo演示页面传递的参数
        
        // 订单超时时间。
        // 超过此时间后，除网银交易外，其他交易银联系统会拒绝受理，提示超时。 跳转银行网银交易如果超时后交易成功，会自动退款，大约5个工作日金额返还到持卡人账户。
        // 此时间建议取支付时的北京时间加15分钟。
        // 超过超时时间调查询接口应答origRespCode不是A6或者00的就可以判断为失败。
        'payTimeout' =&gt; $time_out

       // 请求方保留域，
        // 透传字段，查询、通知、对账文件中均会原样出现，如有需要请启用并修改自己希望透传的数据。
        // 出现部分特殊字符时可能影响解析，请按下面建议的方式填写：
        // 1. 如果能确定内容不会出现&amp;={}[]"'等符号时，可以直接填写数据，建议的方法如下。
        //    'reqReserved' =&gt;'透传信息1|透传信息2|透传信息3',
       // 2. 内容可能出现&amp;={}[]"'符号时：
        // 1) 如果需要对账文件里能显示，可将字符替换成全角＆＝｛｝【】“‘字符（自己写代码，此处不演示）；
        // 2) 如果对账文件没有显示要求，可做一下base64（如下）。
        //    注意控制数据长度，实际传输的数据长度不能超过1024位。
        //    查询、通知等接口解析时使用base64_decode解base64后再对数据做后续解析。
        //    'reqReserved' =&gt; base64_encode('任意格式的信息都可以'),
       
       //TODO 其他特殊用法请查看 special_use_purchase.php
    );

com\unionpay\acp\sdk\AcpService::sign ( $params );
$uri = com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;frontTransUrl;
$html_form = com\unionpay\acp\sdk\AcpService::createAutoFormHtml( $params, $uri );
echo $html_form;
?&gt;
</code></pre>
  <br>
  <span><span style="font-size:14pt;">修改demo/api_01_gateway/FrontReceive.php(前台同步通知)</span></span> 
  <p></p>
  <pre><code class="language-html">&lt;?php
include_once("../../../../include/config.inc.php");
include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . './../../sdk/acp_service.php';
/**
* 交易说明：   前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。
*              为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。
*              未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0
*/

$logger = com\unionpay\acp\sdk\LogUtil::getLogger();
$logger-&gt;LogInfo("receive front notify: " . com\unionpay\acp\sdk\createLinkString ( $_POST, false, true ));

//页面回跳地址
$fail_back_url = WEBPATH_DIR_INC.'enter-query.html';
$succ_back_url = WEBPATH_DIR_INC.'enter-query.html';

//验签
if (isset ( $_POST ['signature'] )) {
    $result = com\unionpay\acp\sdk\AcpService::validate ( $_POST );
    if($result){//验签成功
        $respCode = $_POST ['respCode'];//应答码
        if($respCode=='00' || $respCode=='A6'){//交易成功
            //请在这里加上商户的业务逻辑程序代码
            //返回参数
            $orderId = $_POST ['orderId'];//商户订单号
            $totalAmount = $_POST['txnAmt'];//交易金额
            $merId = $_POST['merId'];//商户代码

            $res = 'success';
            //判断支付类型（提现还是借贷）
            $type = substr($orderId,0,2);

            //获取对应订单信息
            if($type=='tx'){
                $order_info = get_order_info($orderId);

                //验证订单数据
                if(empty($order_info)){
                    $res = 'fail';
                }
                if($totalAmount != $order_info['o_totalprice']*100){
                    $res = 'fail';
                }
            }

            if($type=='jd'){
                $order_info = get_loan_order_info($orderId);

                //验证订单数据
                if(empty($order_info)){
                    $res = 'fail';
                }
                if($totalAmount != $order_info['l_returnnum']*100){
                    $res = 'fail';
                }
            }

            //验证商户代码
            //TODO



        }else{
            $res = 'fail';
        }
    }else{
        $res = 'fail';
    }
} else {
    $res =  'fail';
}

?&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv="content-type" content="text/html;charset=utf-8"/&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1"/&gt;
    &lt;title&gt;银联支付-订单支付&lt;/title&gt;
    &lt;script type="text/javascript"&gt;
        function callpay(){
            var res = '&lt;?php echo $res;?&gt;';
            if(res=='success'){
                var Idiv = document.getElementById("pay_error2");
            }else{
                var Idiv = document.getElementById("pay_error");
            }
            Idiv.style.display = "block";
        }



        //页面进入即进行支付
        window.onload = function(){     callpay();     };

    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;style&gt;
    *{ margin:0; padding:0; background:#e1e1e1;}
    #pay_error, #pay_error2{ display:none; width:90%; height:100%; text-align:center; color:#fe5f16; font-size:20px; padding:20px 0; font-weight:bolder; border:1px solid #ccc; margin:0 5%; height:100px; margin-top:50%; border-radius:10px; background:#fff;}
    #pay_error p,#pay_error2 p{ background:#fff;}
    #pay_error a,#pay_error2 a{ background:#83da49; color:#fff; text-decoration:none; display:block; padding:10px 0; width:60%; margin-left:20%; margin-top:20px;}
&lt;/style&gt;
&lt;div id="pay_error"&gt;
    &lt;p class="p1"&gt;支付失败，请重新完成支付！&lt;/p&gt;
    &lt;p class="bt"&gt;&lt;a href="&lt;?php echo $fail_back_url;?&gt;"&gt;确定&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div id="pay_error2"&gt;
    &lt;p class="p1"&gt;恭喜你，支付成功&lt;/p&gt;
    &lt;p class="bt"&gt;&lt;a href="&lt;?php echo $succ_back_url;?&gt;"&gt;确定&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
  <br>
  <span><span style="font-size:14pt;">修改demo/api_01_gateway/BackReceive.php(后台异步通知)</span></span>
  <pre><code class="language-html">&lt;?php
include_once("../../../../include/config.inc.php");
include_once dirname ( __FILE__ ).DIRECTORY_SEPARATOR . './../../sdk/acp_service.php';
include_once "Form_6_5_Query.php";
/**
* 交易说明：   前台类交易成功才会发送后台通知。后台类交易（有后台通知的接口）交易结束之后成功失败都会发通知。
*              为保证安全，涉及资金类的交易，收到通知后请再发起查询接口确认交易成功。不涉及资金的交易可以以通知接口respCode=00判断成功。
*              未收到通知时，查询接口调用时间点请参照此FAQ：https://open.unionpay.com/ajweb/help/faq/list?id=77&amp;level=0&amp;from=0
*/

$logger = com\unionpay\acp\sdk\LogUtil::getLogger();
$logger-&gt;LogInfo("receive back notify: " . com\unionpay\acp\sdk\createLinkString ( $_POST, false, true ));

//验签
if (isset ( $_POST ['signature'] )) {
    $result = com\unionpay\acp\sdk\AcpService::validate ( $_POST );
    if($result){//验签成功
        $respCode = $_POST ['respCode'];//应答码
        if($respCode=='00' || $respCode=='A6'){//交易成功
            //返回参数
            $orderId = $_POST ['orderId'];//商户订单号
            $totalAmount = $_POST['txnAmt'];//交易金额
            $merId = $_POST['merId'];//商户代码
            $txnTime = $_POST['txnTime'];//订单发送时间
            $trade_no = $_POST['queryId'];//银联流水号

            //发起查询交易接口
            $check_res = check_Trade_Res($orderId,$merId,$txnTime,THIS_DATETIME);
            if($check_res=='200'){
                //成功
                //请在这里加上商户的业务逻辑程序代码
                //判断支付类型（提现还是借贷）
                $type = substr($orderId,0,2);

                //获取对应订单信息
                if($type=='tx'){
                    $order_info = get_order_info($orderId);

                    //验证订单数据
                    if(empty($order_info)){
                        echo 'fail';
                        return;
                    }
                    if($totalAmount != $order_info['o_totalprice']*100){
                        echo 'fail';
                        return;
                    }
                }

                if($type=='jd'){
                    $order_info = get_loan_order_info($orderId);

                    //验证订单数据
                    if(empty($order_info)){
                        echo 'fail';
                        return;
                    }
                    if($totalAmount != $order_info['l_returnnum']*100){
                        echo 'fail';
                        return;
                    }
                }

                //验证商户代码
                //TODO

                //执行成功后的业务程序
                if($type=='tx'){
                    if($order_info['o_status']==4){
                        //执行业务处理
                        //取出礼包码
                        $sql = "select sysid,gc_code from ".get_table("game_gift_code")." where gc_status=1 limit 1";
                        $query = $GLOBALS["conn"]-&gt;Query($sql);
                        $value = $GLOBALS['conn']-&gt;FetchArray($query);

                        $up_arr = array(
                            'o_status' =&gt; 1,
                            'o_trade_no' =&gt; $trade_no,
                            'o_giftcode' =&gt; $value['gc_code']
                        );
                        $up_where = " and o_orderid='".$orderId."'";
                        $row = update_record($GLOBALS["conn"],'game_order',$up_arr,array(),$up_where);//更新订单数据
                        if($row&gt;0){
                            $msg = "订单 ".$orderId." 已支付";
                            $log_msg = "call back:" . $msg;
                            sys_log_write_content( $log_msg.__FILE__.__LINE__ ,"pay_log","notify_order_success");

                            //更新礼包码状态
                            $up_gift = array(
                                'gc_status'=&gt;2,
                                'gc_time' =&gt; THIS_DATETIME,
                                'gc_orderid' =&gt; $orderId
                            );
                            $gift_where = " and sysid=".$value['sysid'];
                            update_record($GLOBALS["conn"],'game_gift_code',$up_gift,array(),$gift_where);

                            //更新商品出售数量
                            /*$where = " and og_sysid='".$orderId."'";
                            $garr = get_info($GLOBALS['conn'],"game_order_goods",array('og_goodsid'),$where,'',true);
                            foreach($garr as $k=&gt;$v){
                                $up_num = array(
                                    'g_sellnum' =&gt; 'g_sellnum'+1
                                );
                                $num_where = " and g_id='".$v."'";
                                update_record($GLOBALS['conn'],"game_goods",$up_num,array(),$num_where);//更新商品出售
                            }*/

                            //新增用户消息
                            $title = '付款成功，请试用后尽快退款';//标题
                            $content = '您的订单['.$orderId.']已经付款成功，&lt;br&gt;道具试用后可申请退款退回绑定借记卡，适合现金紧缺的玩家！系统赠送您的游戏兑换码:'.$value['gc_code'].'，可以在您的游戏中进行使用，感谢您的支持！&lt;br&gt;如需帮助，请点击左上角【帮助】找到您的问题或者联系客服进行人工服务，QQ:2013609564';
                            add_player_msg($order_info['o_playerid'],$title,$content);
                        }
                    }
                }

                if($type=='jd'){
                    if($order_info['l_status']==3){
                        //执行业务处理
                        $up_arr = array(
                            'l_status' =&gt; 4,
                            'l_trade_no' =&gt; $trade_no,
                            'l_returntime' =&gt; THIS_DATETIME
                        );
                        $up_where = " and l_orderid='".$orderId."'";
                        $row = update_record($GLOBALS["conn"],'game_loan_order',$up_arr,array(),$up_where);//更新订单数据
                        if($row&gt;0){
                            $msg = "订单 ".$orderId." 已支付";
                            $log_msg = "call back:" . $msg;
                            sys_log_write_content( $log_msg.__FILE__.__LINE__ ,"pay_log","notify_order_success");
                        }
                    }
                }

                echo "success";
            }else{
                echo "fail";
            }
        }else{
            echo 'fail';
        }
    }else{
        echo 'fail';
    }
} else {
    echo 'fail';
}

?&gt;

</code></pre>
  <span><span style="font-size:14pt;">封装主动查询交易结果接口方法</span></span> 
  <p></p>
  <pre><code class="language-html">&lt;?php
include_once("../../../../include/config.inc.php");
header ( 'Content-type:text/html;charset=utf-8' );
//include_once $_SERVER ['DOCUMENT_ROOT'] . '/upacp_demo_b2c/sdk/acp_service.php';

/**
* 重要：联调测试时请仔细阅读注释！
*
* 产品：跳转网关支付产品&lt;br&gt;
* 交易：交易状态查询交易：只有同步应答 &lt;br&gt;
* 日期： 2015-09&lt;br&gt;
* 版本： 1.0.0
* 版权： 中国银联&lt;br&gt;
* 说明：以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己需要，按照技术文档编写。该代码仅供参考，不提供编码性能及规范性等方面的保障&lt;br&gt;
* 该接口参考文档位置：open.unionpay.com帮助中心 下载  产品接口规范  《网关支付产品接口规范》，&lt;br&gt;
*              《平台接入接口规范-第5部分-附录》（内包含应答码接口规范，全渠道平台银行名称-简码对照表）&lt;br&gt;
* 测试过程中的如果遇到疑问或问题您可以：1）优先在open平台中查找答案：
*                                调试过程中的问题或其他问题请在 https://open.unionpay.com/ajweb/help/faq/list帮助中心 FAQ 搜索解决方案
*                             测试过程中产生的7位应答码问题疑问请在https://open.unionpay.com/ajweb/help/respCode/respCodeList输入应答码搜索解决方案
*                           2） 咨询在线人工支持： open.unionpay.com注册一个用户并登陆在右上角点击“在线客服”，咨询人工QQ测试支持。
* 交易说明： 1）对前台交易发起交易状态查询：前台类交易建议间隔（5分、10分、30分、60分、120分）发起交易查询，如果查询到结果成功，则不用再查询。（失败，处理中，查询不到订单均可能为中间状态）。也可以建议商户使用payTimeout（支付超时时间），过了这个时间点查询，得到的结果为最终结果。
*        2）对后台交易发起交易状态查询：后台类资金类交易同步返回00，成功银联有后台通知，商户也可以发起 查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。
*                                 后台类资金类同步返03 04 05响应码及未得到银联响应（读超时）需发起查询交易，可查询N次（不超过6次），每次时间间隔2N秒发起,即间隔1，2，4，8，16，32S查询（查询到03，04，05继续查询，否则终止查询）。
*/

function check_Trade_Res($orderId,$merId,$txnTime,$firTime=THIS_DATETIME){
    $params = array(
        //以下信息非特殊情况不需要改动
        'version' =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;version,        //版本号
        'encoding' =&gt; 'utf-8',      //编码方式
        'signMethod' =&gt; com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;signMethod,         //签名方法
        'txnType' =&gt; '00',          //交易类型
        'txnSubType' =&gt; '00',       //交易子类
        'bizType' =&gt; '000000',      //业务类型
        'accessType' =&gt; '0',        //接入类型
        'channelType' =&gt; '07',      //渠道类型

        //TODO 以下信息需要填写
        'orderId' =&gt; $orderId,   //请修改被查询的交易的订单号，8-32位数字字母，不能含“-”或“_”，此处默认取demo演示页面传递的参数
        'merId' =&gt; $merId,    //商户代码，请改自己的测试商户号，此处默认取demo演示页面传递的参数
        'txnTime' =&gt; $txnTime,//请修改被查询的交易的订单发送时间，格式为YYYYMMDDhhmmss，此处默认取demo演示页面传递的参数
    );

    com\unionpay\acp\sdk\AcpService::sign ( $params ); // 签名
    $url = com\unionpay\acp\sdk\SDKConfig::getSDKConfig()-&gt;singleQueryUrl;

    $result_arr = com\unionpay\acp\sdk\AcpService::post ( $params, $url);
    if(count($result_arr)&lt;=0) { //没收到200应答的情况
        //printResult ( $url, $params, "" );
        return;
    }

    //printResult ($url, $params, $result_arr ); //页面打印请求应答数据

    if (!com\unionpay\acp\sdk\AcpService::validate ($result_arr) ){
        return '400';
    }

    if ($result_arr["respCode"] == "00"){
        if ($result_arr["origRespCode"] == "00"){
            //交易成功
            //TODO
            //echo "交易成功。&lt;br&gt;\n";
            return '200';
        } else if ($result_arr["origRespCode"] == "03"
            || $result_arr["origRespCode"] == "04"
            || $result_arr["origRespCode"] == "05"){
            //后续需发起交易状态查询交易确定交易状态
            //TODO
            //echo "交易处理中，请稍微查询。&lt;br&gt;\n";
            //间隔查询
            ignore_user_abort(1);
            set_time_limit(0);
            $interval = 60*5;//5分钟
            sleep($interval);
            do{
                if(THIS_DATETIME-$firTime&gt;60*120){
                    return '400';
                }
                check_Trade_Res($orderId,$merId,$txnTime);//再次查询
            }while(true);
        } else {
            //其他应答码做以失败处理
            //TODO
            //echo "交易失败：" . $result_arr["origRespMsg"] . "。&lt;br&gt;\n";
            return '400';
        }
    } else if ($result_arr["respCode"] == "03"
        || $result_arr["respCode"] == "04"
        || $result_arr["respCode"] == "05" ){
        //后续需发起交易状态查询交易确定交易状态
        //TODO
        //echo "处理超时，请稍微查询。&lt;br&gt;\n";
        //间隔查询
        ignore_user_abort(1);
        set_time_limit(0);
        $interval = 60*5;//5分钟
        sleep($interval);
        do{
            if(THIS_DATETIME-$firTime&gt;60*120){
                return '400';
            }
            check_Trade_Res($orderId,$merId,$txnTime);//再次查询
        }while(true);
    } else {
        //其他应答码做以失败处理
        //TODO
        //echo "失败：" . $result_arr["respMsg"] . "。&lt;br&gt;\n";
        return '400';
    }
}


/**
* 打印请求应答
*
* @param
*         $url
* @param
*         $req
* @param
*         $resp
*/
function printResult($url, $req, $resp) {
    echo "=============&lt;br&gt;\n";
    echo "地址：" . $url . "&lt;br&gt;\n";
    echo "请求：" . str_replace ( "\n", "\n&lt;br&gt;", htmlentities ( com\unionpay\acp\sdk\createLinkString ( $req, false, true ) ) ) . "&lt;br&gt;\n";
    echo "应答：" . str_replace ( "\n", "\n&lt;br&gt;", htmlentities ( com\unionpay\acp\sdk\createLinkString ( $resp , false, false )) ) . "&lt;br&gt;\n";
    echo "=============&lt;br&gt;\n";
}</code></pre>
  <br>
  <br>
  <br> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq603283912/article/details/78720960,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/qq603283912/article/details/78720960,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
