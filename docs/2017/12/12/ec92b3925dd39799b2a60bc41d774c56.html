<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>EMV学习过程中问题解决及汇总 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="EMV学习过程中问题解决及汇总" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="﻿﻿ 应用选择： 1.ADF、DDF、AEF、EF、DF有什么区别 ADF、DDF、AEF就是PBOC规范里面的名词了，ADF和DDF其实就是DF的一个映射，AEF就是EF的映射，我们不能直接操作DF和EF，只能操作ADF和DDF以及AEF，就相当于内存管理里面物理地址和虚拟地址一样，程序不能直接使用物理地址，只能使用虚拟地址，而内存管理的单元回去实现虚拟地址到物理地址的映射。 2.既然ADF和DDF都是DF的映射，那他们两个有啥区别呢？ DDF还是一个目录，这个目录下面可能有ADF，也可能还是有DDF的。 ADF也是一个目录，但是这个目录已经是aid的目录了，这个目录的名称就是AID了。 再根据ADF名称去选择ADF，ADF下面都是AEF，也就是这个AID多对应的有用数据文件，终端在GPO时候根据返回的AFL，再去读取对应的文件。 3.目录选择法在选择完PSE后是如何获得AID的 选择完PSE之后，PSE目录会返回SFI（tag 88），然后终端根据SFI，再执行READ RECORD命令读取记录，读记录根据SFI循环读取，直到卡片返回6A83为止，这个时候终端已经获取到卡片支持的AID（tag 4F）。 4.当卡片和终端有多个应用支持时，终端是根据什么判断是否需要持卡人选择应用的 根据应用优先级指示器的bit8来判断是否需要提示持卡人选择应用。 5.选择应用时如果在未读到记录之前或者读记录后检查数据非法等情况怎么办？ 如果遇到上述情况，则均可认为是目录选择法失败，这时候就需要改用AID选择法。 6.Qpboc和借贷记应用的在选择应用部分的区别 Q选择的是PPSE，借贷记选择的是PSE；Q不支持持卡人选择应用和AID列表选择法，Q的流程相对精简。 Q在选择完PPSE之后已经可以获取到AID（可能是多个）、应用优先级、应用指示器，Q不支持持卡人选择应用，所以如果有多个AID的时候，需要根据应用优先级选择优先级最高的AID，再根据AID选择ADF，就可以获取到PDOL（关键数据）、发行卡代码等数据。 借贷记需要根据选择PSE返回的SFI读记录获取AID，再根据AID去选择ADF，再去读数据；Q在选择PPSE之后就可以获取到AID，直接选择ADF了。 &nbsp; 应用初始化&amp;&amp;读应用数据 1.GPO命令是怎么组的？ 应用选择完成后，终端获取到了PDOL数据，GPO根据PDOL中的TAG组数据域传送给卡片 2.终端一定会有PDOL吗，没有PDOL哪些交易不能进行？ 卡片可以不给终端提供PDOL，如果终端没有获取到PDOL，则GPO数据域直接传递8300，如果卡片不提供PDOL的话，后续这张卡是不能做电子现金和Q的交易 3.GPO命令后的读记录命令是根据什么读的，怎么知道哪些记录用于数据认证 读记录命令是根据AFL读的，其包含终端将要读取用来交易处理的卡片数据文件的SFI和记录范围。每个要读取的文件在AFL中对应四个字节，含义如下： 字节1：短文件标识符 字节2：文件中要读取的第1个记录的记录号 字节3：文件中要读取的最后一个记录的记录号 字节4：从第1个记录开始的用于脱机数据认证的连续记录数 4.根据什么知道终端要执行哪些过程？ 后续的过程根据终端性能和卡片的支持能力决定哪些步骤要执行，支持哪种数据认证，是否支持持卡人认证，是否支持发卡行认证等，但风险管理是强制执行的不依据AIP里的值 5.QPBOC联机和QPBOC脱机的GPO响应数据有比较大的区别？ qPBOC联机交易或拒绝交易的GPO响应数据中是不返回AFL的，而QPBOC脱机的GPO响应数据中返回AFL 6.如何判断非接中到底是走QPBOC流程还是走非接触借贷记流程？ ——如果卡片响应GPO命令的状态字为“9000”，假设终端仅支持一种非接触选项（qPBOC或非接触式借记/贷记应用），则终端应按此选项继续处理，不必判断AIP； ——如果卡片响应GPO命令的状态字为“9000”，并且AIP第2字节第8位置‘0’，假设终端支持qPBOC，并且应用密文（标签“9F26”）在GPO命令响应中出现，则终端应按照qPBOC处理交易。如果标签为“9F26”的数据项不出现，则终端应按照非接触式借记/贷记应用处理交易。 7.QPBOC的GPO数据返回数据量为什么比较大？ 为了提高交互速度，减少终端与卡片交互次数，为此提高了单次交互的数据量，所以Q的GPO返回的数据量比较大，除了AIP和AFL之外，还有应用密文，交易计数器，发卡行应用数据，二磁道数据等多个数据。 8.SFI文件范围1-10,11-20,21-30的区别？ 1－10：EMV数据文件； 11－20：支付系统数据文件； 21－30：发卡行数据文件；&nbsp; 9.在读应用数据中,终端出现哪几种情况会终止交易? (1)卡片在一条或多条记录中返回同一个标签两次及两次以上； (2)卡片在某条记录中返回了卡片已经在GPO响应中返回的标签； (3)卡片中缺少必须有的数据； (4)数据格式错； (5)READ RECORD 命令返回状态字不是“9000“。 &nbsp; 脱机数据认证： 1.终端根据什么来决定执行哪种脱机数据认证方式？ 取决于两个要素AIP和终端性能。 2.应用开发工程师在分析IC卡交易失败的时候要看什么做判断？ 交易没走步都要首先分析AIP和终端性能的各个位的情况，而交易每执行完一步都要对TVR和TSI进行置位或者清零。 在分析IC卡失败交易的第一步应该是看TVR和TSI，看看终端做过什么，终端哪一步失败了，然后在分析某个步骤失败的原因。 3.对于参与脱机数据认证的SFI有明确分类，分为SFI从1-10以及11-30两类，这两类在参与认证上有什么区别？ 1-10的SFI在参与脱机数据认证的时候，其文件标志“70”和记录长度不参与脱机数据认证，而SFI为11-30的，则70和记录长度也要参与脱机数据认证。 4.静态数据认证SDA是如何认证的？ 三步走：一步获取认证中心公钥，二步恢复发卡行公钥，三步进行数据认证 一步获取认证中心公钥：首先通过公钥下载将服务端的公钥挨个下载到终端，在获取认证中心公钥的时候要做两个判一个判断是选择AID的5个字节为RID，另一个判断是需要用到度记录时获取到的发卡行公钥索引（8F），通过RID和索引可以选择到唯一的一组公钥，选择完成后，获取中心公钥即成功 二步恢复发卡行公钥：首先读记录的时候已经获取到发卡行90（签名处理过的发卡行公钥，92（发卡行公钥余项），9F32（发卡行公钥指数），所以这个时候可以用CA公钥利用RSA算法对90的数据解密。解密后的数据为一个比较复杂的数据格式，需要对数据的头尾，以及中间数据做判断，其中对后续才做有用的数据是“哈希值”，执行完这一步，终端已经获取到了卡片计算出的哈希值，执行完这一步，终端已经获取到了卡片计算出的哈希值，卡片计算哈希值的方法和终端的一样，故只要知道这里获取到了发卡行公钥或者发卡行公钥最左边的部分以及获取到了哈希值就OK了。 卡片已经返回了哈希值，终端自然也要计算一个哈希值，计算方法： 首先组织一长串数据，格式：证书格式 +发卡行标识(主账号最左面的3 -8个数字) +证书失效日期 +证书序列号 +哈希算法标识 +发卡行公钥算法标识 +发卡行公钥长度 +发卡行公钥指数长度 +发卡行公钥模数的完整数据 128个字节+发卡行公钥指数 特别说明：发卡行公钥模数的完整数据一部分是在还原发行卡公钥数据过程中获取的，还有另外一部分是在卡片读记录的时候通过92tag获取到的。除此之外，其他数据都为卡片返回原始数据，或者是一些固定写死的值。 然后用组好的数据进行哈希值计算，计算出的哈希值和我们在恢复发卡行公钥中获取到的哈希值一样，至此恢复发卡行公钥的步骤已完成，其中任何一步失败都会认为是静态数据认证失败。 第三步验证签名数据：用发卡行公钥来恢复签名的静态数据（过程与第二步雷同），恢复中有一部分是终端用来计算哈希值（将表5中的第二个到第五个数据元素（即从签名数据格式直到填充字节）从左到右连接，再把本规范第三册的第II部分中指明的需认证的静态数据加在后面。如果静态数据认证标签列表存在，并且其包含非‘82’的标签，那么静态数据认证失败），组织签名数据首先按照之前描述的sfi的规则获取脱机认证数据，还有个特别的地方，如果存在9F4A的话，需要将AIP作为签名数据,不需要包含tag和L，只要V就可以。最后对组织好的数据，进行sha1运算，获得hash值，然后和恢复签名数据时获取的哈希值比较，如果相等则SDA成功，然后将计算出的hash保存在9F45的标签中。SDA流程就算是结束了。 5.9F4A静态数据认证标签列表只存在在静态数据认证过程中吗？ 不是，SDA和DDA中都存在这个要素。DDA中主要用这个来做发卡行公钥恢复和IC卡公钥恢复，所以这个标签的作用主要是用来组建一组静态数据用于脱机数据认证。切不要以为因为它的名字叫做“静态数据认证标签列表”而忽略了在DDA中的应用。 6.动态数据认证DDA是如何认证的？ 首先需要恢复出发卡行公钥，这个和SDA的步骤一样，就不讨论了。 恢复出发卡行公钥后，DDA中还需要恢复IC卡公钥，这个步骤中，和恢复发卡行公钥类似，恢复出IC卡公钥以后也需要利用恢复后得到的数据再加上用于脱机数据认证的数据（SFI那边获得的）进行HASH值的计算，计算结果与恢复出的结果一致，则恢复出的IC卡公钥合法可用。 前面的内容SDA和DDA大同小异，没什么差别，但是DDA从恢复完IC卡公钥后和SDA就有很大区别了，下面我们一步一步讨论。 第一步，动态签名的生成 读记录的时候，需要一个关键数据DDOL（9F49），这个数据是卡片告诉终端（如果卡片没有返回，终端也需要有默认值，如果都没有则交易终止；如果DDOL中不含有9F37不可预知数，则交易终止）卡片需要终端的哪些数据来做动态签名。 终端组织好DDOL的数据之后，通过内部认证命令将数据提供给卡片，卡片会返回签名后的动态数据。卡片返回的数据时签名后的动态认证数据（tag为80时和tag为77时不一样的处理，与GPO是返回数据的处理类似），需要终端再利用IC卡公钥进行还原。还原后的数据中会有HASH。然后终端利用还原后得到的数据，再加上DDOL构成一个规范要求的数据串，然后在做SHA1运算获得HASH值，对比卡片返回的hash值和终端计算的是否一致，如果一致，证明DDA成功，再将HASH值保存到9F4C，则DDA已经结束了。 从分析来看，DDA其实是包含了SDA的过程，并且有了内部认证的处理，使得其安全性大于SDA，所以现在目前国内发行的卡基本上都是采用DDA作为脱机数据认证方式。 7.CDA认证 之前脱机数据认证，包括后面的GAC都忽略了CDA的存在，现在专门讨论一下CDA。 先从脱机数据认证开始，第一次遇到CDA。 CDA的前面三个步骤（获取ca公钥、恢复发卡行公钥、恢复IC卡公钥）和DDA一样，DDA是通过内部认证指令获取签名动态数据，CDA是通过GAC指令来获取的。 终端行为分析过程中正好有一次GAC，所以采用脱机数据认证的时候，前面只完成还原IC卡公钥就行了，CDA后续的部分放在终端行为分析GAC之后。 但是CDA的GAC和请求应用密文的GAC指令不一样，控制参数不一样，所以请求得到的结果也不一样。 CDA是用GAC指令请求，对于GAC指令请求，返回为格式2，也就是之前提到的77开头的格式，需要解析TLV，解析到9F4B签名动态应用数据。 这一步完成后，CDA比DDA多了一个步骤，终端首先将将恢复的密文数据和GAC返回的密文数据比较。 比较完成后终端需要将一些在GAC中返回的数据等一起组织起来，计算hash值，与恢复出的哈希值是否一致进行比较，如果一致则认为CDA到目前为止还是成功的。 然后还需要将GAC恢复数据得到的IC卡动态数据在进行处理，IC卡动态数据中也有一个hash值，还需要终端再按要求计算一个hash值，然后再和IC卡动态数据中的HASH值比较。 可以看得出是两层数据套在了一起，先解析外层，再解析内层，一层一层还原，最终 如果这个时候卡片返回的是TC，那么脱机交易就OK了，如果返回是ARQC的话，就发起联机。 联机过程忽略不谈，联机处理过程CDA和DDA一样，没什么区别。 如果联机失败，这个时候又要进行卡片行为分析。而且由于第一次GAC指令要求执行CDA，那么第二次GAC指令也要执行CDA。 &nbsp; 对比CDA和DDA，可以看得出CDA复杂了很多，首先CDA将应用密文也加入到签名数据，其次CDA在响应GAC指令的时候对于密文的数有进行了一次加密封装，进而更加增强了安全性。 CDA的卡现在太少了，除了专业测试的，其他几乎没有银行发行CDA卡的，所以这块没有办法取到数据，只能通过代码和文档进行理解和分析。&nbsp; 8.动态数据认证有哪几种原因？ 1.DDOL中不包含随机数（“9F37”） 2.在获取CA公钥，发卡行公钥，IC卡公钥任何一个公钥缺失都会导致失败。 3.CA公钥恢复发卡行公钥过程中恢复出的数据头尾格式和公钥格式和公钥指示符不合法。 4.恢复出的哈希值不等于计算出的哈希值。 5.发卡方ID号不等于PAN的前几位。 6.发卡行公钥证书过期 7.内部认证命令返回状态字不是“9000“。 8.签名动态应用数据和IC卡公钥模长度不一致 &nbsp; &nbsp; 处理限制： 1.应用用途控制的作用即及判断 卡片会返回一个AUC（9F07），通过判断这个数据域来允许或者拒绝交易。 判断的逻辑也很清晰，比如一个pos终端，判断AUC的标志位给出ATM有效，除ATM外的终端无效，那POS终端肯定要拒绝这个交易了。或者就是根据终端的国家代码和卡片的国家代码是否一致来判断为国际交易还是国内交易。AUC的各个位又明确给出了国际交易和国内交易的允许情况，终端根据当前交易的状态，以及这些位来判断交易允许或者拒绝 2.应用日期有什么限制？应用过期怎么办？ 应用生效日期要早与当前日期，应用失效日期要晚于当前日期。若应用过期，则在TVR中将相应位设置为‘1‘。 &nbsp; 持卡人认证： 1.持卡人认证这块EMV和PBOC的区别 EMV流程和PBOC流程差别在于对于CVM的支持有差异，即EMV支持脱机密文PIN验证，不支持持卡人证件验证，而PBOC不支持脱机密文PIN验证，支持持卡人证件验证。 2.解释一下CVM，CVM对于验证是怎么处理的 一个CVM含2个主要元素： (1)两个金额，X金额和Y金额。 (2)持卡人验证方法条目（可能含有多个） a.持卡人验证方法，即第9字节的bit7，用来表明持卡人验证失败后的操作。 b..持卡人验证方法类型，即第9字节的bit6--bit1，用来表明采用什么样的方法做持卡人验证。 c.持卡人验证方法条件，即第10字节，用来表明在什么情况下做持卡人验证。 3.结合实例谈谈对cvm的理解 这是一个标准的cvm列表，X金额为0，Y金额为0，后续每两个字节表示一个持卡人验证方法条目，5E的二进制位01 011110这表明如果持卡人验证失败则使用后续的CVM，CVM验证方法为签名，03表示“如果终端支持这个CVM”。 这样估计还是比较抽象，我用语言再描述一下。 首先5E的bit8 bit7为01，这表明如果这个cvm失败，那就要用到后面的1F 00作为持卡人验证方法。 再看5E的bit6到bit1，这个规范上说的很明确，现在的6个数字就是代表使用签名。 再看03，03的含义是“如果终端支持这个CVM”，这个怎么理解呢？终端有一个很重要的数据，终端性能，终端性能中明确指出了终端所支持的验证方法，所以03的意思就是如果终端支持持卡人签名验证，那么这个交易就使用签名作为验证方法。当持卡人验证条件为03时，内核对于终端性能的判断也是直接影响持卡人验证成功与失败的关键要素。 后面的1F00就不做分析了，分析方法同理。 程序分析完CVM列表后，再根据分析结果提示持卡人进行操作，然后就相当于持卡人认证已经完成。 &nbsp;4.脱机PIN加密过程 (1)&nbsp;终端把用户输入的明文PIN按照一定的格式补位对齐,&nbsp;然后用get&nbsp;challenge命令从卡片中取一个8字节的随机数.&nbsp; (2)&nbsp;终端自己产生一组长度为N-17的随机数(N为PIN加密公钥的长度),&nbsp;然后把补位后的PIN,卡片中取的随机数以及终端产生的随机数拼接在一起,&nbsp;与PIN加密公钥做RSA运算.&nbsp; (3)把上一步运算的结果通过verify命令发给IC卡. (4)&nbsp;卡片用PIN加密私钥解密数据,&nbsp;首先检查解出来的8字节随机数是否与自己产生的一致，然后卡片检查恢复的数据头字节是否有效,&nbsp;最后一步是验证PIN是否合法.&nbsp;只有所有的条件都满足，脱机加密PIN才算成功.&nbsp; &nbsp; 终端风险管理： 1.为什么要进行最低限额检查？如何进行？ 最低限额检查用于控制交易当前交易金额或同一张卡片连续几笔交易累积金额超过某个数值时则要求联机授权。 如果终端不支持交易日志，则终端直接比较授权金额和最低限额。如果交易授权金额大于或等于最低限额，终端将TVR中的“交易超过最低限额”位设为‘1’。即使最低限额为0，终端也进行同样检查，这种情况会导致所有交易的TVR中的“交易超过最低限额”位都设为‘1’。 如果终端支持交易日志，则终端在交易日志中寻找与当前交易的PAN和PAN序列号（如果终端交易日志和卡片中都存在）相同的一个交易记录，将其对应的累计交易金额与当前交易的授权金额相加，如果和大于或等于最低限额，则TVR中的“交易超过最低限额”位设为‘1’。 特别说明：终端风险管理，没有联机能力的终端可以不做后续的内容，直接跳过后面的步骤，进入终端行为分析。简而言之，电子现金交易，这一流程的后续两步可以直接跳过。 2.随机选中交易实例理解 终端风险管理参数示例 参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;值 终端最低限额&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100&nbsp;&nbsp;&nbsp;（AID参数下发） 终端随机数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;&nbsp;（终端随机生成） 偏置随机选择的阈值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; （AID参数下发） 随机选择目标百分比&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20％ （AID参数下发） 偏置随机选择的最大目标百分比&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50％（AID参数下发） 情形1： 交易金额是20。因为交易金额小于偏置随机选择阈值，因此执行随机选择。 比较终端随机数与目标百分数。因为随机数（25）大于目标百分数（20），所以交易不被选中作联机处理。 情形2： 交易金额是60。这个金额大于偏置随机选择的阈值，但小于终端最低限额。因此应用偏置随机选择。 交易金额比阈值高20，该差值是终端最低限额与阈值差值（100－40＝60）的1/3。因此将最大目标百分数与目标百分数的差值的1/3（50％－20％＝30％×1/3＝10％）加到目标百分数上，得到交易目标百分数为30％（20％＋10％＝30％）。 终端随机数为25，小于交易目标百分数（30），所以交易被选中进行联机处理。 情形3： 交易金额为150。因该金额大于终端最低限额，因此交易不进行随机选择。而是进行最低限额检查而联机处理。 3.频度检查执行条件 如果连续脱机交易次数下限LCOL(标签‘9F14’)与连续脱机交易次数上限UCOL(标签‘9F23’)都存在，则执行，否则不执行。 如果执行，终端需要先GET DATA获取9F36和9F13，然后再和UCOL和LCOL比较，判断满足交易频度检查条件。 如果获取到的9F13为0，则将该卡标志位新卡。新卡是不允许脱机交易的，IC卡cos会对这个有要求，主要是安全考虑，因为新卡做脱机交易不可控。 &nbsp; 终端行为分析： 1.终端行为分析需要用到哪些重要数据？ 发卡行行为代码（IAC） 发卡行行为代码，来自读记录文件卡片返回 发卡行行为代码有三个数据元，即发卡行行为代码-拒绝、发卡行行为代码-联机、发卡行行为代码-缺省。每个发卡行行为代码由一组与终端验证结果（TVR）中的位相对应的位 组成 IAC－拒绝位设置为“1”反映了交易被脱机拒绝的终端验证结果条件 IAC－联机位设置为“1”代表需要联机授权条件 IAC－缺省位设置为“1”是当联机处理不可行时脱机拒绝所需的条件 终端行为代码(TAC)&nbsp; TAC有三个数据元，它们都是由一系列的位组成的，这些位对应于TVR中的数据位。终端行为代码来自emv参数下载交易。 TAC－拒绝&nbsp;收单行设置的能够导致交易脱机拒绝的TVR条件位 TAC－联机&nbsp;收单行设置的能够导致交易联机的TVR条件位 TAC－缺省 收单行设置的在交易联机无法进行的情况下能够导致脱机拒绝的TVR条件位 这6个代码的查看方法和TVR查看方式一样，使用时也是配合TVR进行使用。 2.终端是如何判断其行为的？ 检查过程完全由终端利用先前从卡片获取的IAC数据和终端保存的TAC数据进行，无需与其它设备进行交互处理。 在处理过程中，终端比较IAC和TAC中与终端验证结果（TVR）对应的位。如果TVR和IAC或TAC中相应的位都被设置为“1”，则采纳对应的IAC或TAC。示例如下： 终端的处理步骤如下： 步骤 1：终端比较 IAC－拒绝和 TVR。如果不存在 IAC－拒绝，则采用缺省值‘0000000000’。如果IAC－拒绝和 TVR 的任何对应位同时设为‘1’，终端必须： ——&nbsp;&nbsp;把授权响应码置为‘Z1’(脱机拒绝)； ——&nbsp;&nbsp;把 GENERATE AC（产生应用密文）命令的 P1参数设为请求应用认证密文（AAC）； ——&nbsp;&nbsp;进行请求应用密文步骤。 步骤 2：终端对 TAC－拒绝和 TVR进行类似的比较。如果不存在 TAC－拒绝，则采用缺省值‘0000000000’。如果 TAC－拒绝和 TVR的任何对应位同时设为‘1’，终端必须采取与 IAC－拒绝相同的处理。 步骤 3：如果终端具有联机处理能力（仅联机的终端除外），则它应该使用 IAC－联机和TAC－联机与TVR比较。如果 IAC－联机不存在，则使用缺省值‘FFFFFFFFFF’，如果 TAC－联机不存在，则使用缺省值‘0000000000’。如果 IAC－联机和 TVR的任何对应位同时置为‘1’，则终端： ——&nbsp;把产生应用密文（GENERATE AC）命令的 P1参数设为授权请求密文（ARQC），以进行联机授权请求； ——&nbsp;进行生成应用密文步骤。 对于仅联机的终端，如果在步骤 1和步骤 2中未决定脱机拒绝，则终端不必进行 IAC－联机和 TAC－联机与 TVR的比较，而直接按照 IAC－联机或 TAC－联机和 TVR的任何对应位同时置为‘1’的情况来处理，通过请求联机来继续进行交易。 步骤 4：如果终端是仅脱机终端或者当有联机处理能力的终端出于某种原因不能联机时，则使用 IAC——缺省和 TAC——缺省与 TVR 比较。如果没有 IAC－缺省，则使用缺省值‘FFFFFFFFFF’，如果 TAC——缺省不存在，则使用缺省值‘0000000000’。如果比较结果的任何对应位同时为‘1’，则终端： ——&nbsp;把授权响应码置为‘Z3’（不能联机，脱机拒绝），仅脱机终端授权响应码置为‘Z1’； ——&nbsp;把产生应用密文（GENERATE AC）命令的的 P1参数设置为请求 AAC； ——&nbsp;进行生成应用密文步骤。 对于仅联机的终端，当无法进行联机时，它可以选择正常的处理TAC/IAC－缺省，也可以选择跳过TAC/IAC——缺省的处理。对于跳过TAC/IAC——缺省处理的终端应该直接按照TAC/IAC——缺省与TVR匹配进行处理，并且在第2个GENERATE AC请求AAC。对于正常处理TAC/IAC——缺省的终端，应该根据TAC/IAC——缺省与TVR匹配的结果生成应用密文，这时仅联机的终端可能脱机完成交易。 步骤 5：如果在以上的比较中没有出现对应位同时为‘1’的情况，则终端： ——&nbsp;把授权响应码置为‘Y1’（脱机批准）； ——&nbsp;把 GENERATE AC（请求应用密文）命令的 P1参数设置为请求交易证书（TC）； ——&nbsp;进行请求应用密文步骤。 这里的GENERATE AC就是我们所说的第一次GAC，如果脱机批准了，获取到的TC值需要在上送交易明细时上送到后台。如果卡片返回ARQC，那么在联机交易结束后，还需要再做第二次GAC，这个内容后续再讨论。 &nbsp; 联机处理&amp;&amp;交易结束 1.联机交易处理流程 第一步： 处理ARPC（如果不包含，则跳过；如果包含并且AIP特性标志不支持发卡行认证，则跳过） 收到联机返回报文后，获取tag“91”，即ARPC，通过外部认证指令将ARPC发给卡片，如果卡片响应9000，说明ARPC校验通过，否则发起冲正。 第二步： 处理发卡行脚本 再看tag72（或71，在圈存交易时，不允许出现两个脚本），这个是发卡行返回脚本采用tag72作为标签，72后面还是一个TLV，解析tag86（发卡行脚本命令），获取到。再通过指令将这个命令给到卡片，整个数据就是一个指令，不需要再添加内容 第三步： 第二次GAC，第一次GAC发送GAC指令时组织数据采用的是CDOL1，第二次GAC组织命令时用的是CDOL2，CDOL2也是在读记录时候获取到的。 2.假如卡片请求ARQC。但终端执行联机交易失败怎么办？ 卡片请求ARQC，但是终端无法联机，并不是代表这个交易终止了，终端和卡片还有最后一次尝试，就是所谓的脱机转联机，联机失败再转脱机。 这就好像买东西一样，先去第一家店看了看，觉得东西还行，但是先不买，然后再去第二家店，结果发现第二家店的东西又贵又不好，那再回去第一家店看看，价格能不能商量一下，如果能谈妥，OK，那么就交易。 这个时候首先又需要检查IAC-缺省和TAC缺省执行终端行为分析（这部分在之前终端行为分析中有表详细的描述），并且根绝结果发送第二次GAC指令。 如果第二次GAC指令能够成功返回TC，那么脱机交易批准，如果返回ACC，则交易拒绝，，这个时候不可能再返回ARQC了。 如果脱机成功则响应码为Y3，但是，如果终端在第一次GAC就获取TC批准脱机交易的话，响应码是Y1，所以通过Y1和Y3就可以知道是哪一种脱机批准。 到此为止，整个借贷记交易和电子现金的交易就已经全部处理完了。 &nbsp; &nbsp; QPBOC和借记贷记对比 1.QPBOC和EMV在PDOL中有什么区别？ 非接中的GPO对于PDOL的要求是必须含有9F66（借贷记的GPO是可以支持没有PDOL的，终端在GPO只要发送8300就行），如果没有，终端直接拒绝交易。 2.QPBOC的持卡人认证 QPBOC的持卡人认证和借贷记电子现金不同，QPBOC的持卡人认证结果只有2种情况：签名，联机。通过判断卡片交易属性（9F6C）和终端交易属性（9F66）来判断采用哪种持卡人验证方式。 3.QPBOC的处理限制与借贷记流程的有什么区别？ QPBOC的处理限制只做一件事，就是判断卡有效期，相当于借贷记流程中的一个小步骤。 4.QPBOC的脱机数据认证与借贷记流程的有什么区别？ 因为卡片不会再和终端有指令交互，所以数据认证使用的QPBOC自己定义的一种FDDA。FDDA的执行同样需要根据AIP的情况作出判断。FDDA签名的动态数据通过9F4B在读记录时返回，借贷记是通过内部认证获取到的。这个动态数据的获得，也是区分FDDA版本为01还是00.所以缺少了DDA的内部认证指令，所以叫做FDDA。而用来参于组织签名数据的是通过一个固定数据域组织的，借贷记是通过DDOL获取的。 特别说明:PB0C3.新增了一个9F69的标签，需要在版本01的FDDA中加入到签名数据域。 &nbsp; 交易限额 终端最低限额（9F1B）、终端电子现金交易限额（9F7B）、非解最低限额（DF19）、非解交易限额（DF20）、CVM限额（DF21） 9F1B，就是所谓的Floorlimt，这个参数主要用在终端风险管理终端中的第一个步骤-------最低限额检查。 9F7B，当交易金额小于9F7B的时候，终端可以执行电子现金脱机交易。 特别说明：我一直觉得这个限额只应该对接触式电子现金交易有效，但是现在不管是客户还是同事，很多人都认为这个限额应该对Qpboc也要做判断。虽然目前代码是这么做的，但是我还是觉得这个限额应该只是对电子现金有效。 DF19、DF20、DF21三个TAG值都是连续的限额，就是针对于QPBOC的三个限额，这三个限额主要是在QPBOC预处理阶段进行判断。 DF19，交易金额必须大于DF19，才允许做非解交易。 DF20，交易金额不能大于DF20，否则交易拒绝，提示持卡人采用别的方式交易。 DF21，超过该限额，终端应该在交易属性9F66中置位“要求CVM”，进而在GPO的时候告诉卡片终端需要CVM。但是这个值实际有什么意义也不清楚。Q的持卡人验证只有签名和联机两种方式，卡片返回的9F6C再加上终端交易属性已经可以决定持卡人验证方式了。CVM在这个时候确实没啥用了。 还有一个额度不得不提，就是卡片余额，当交易金额大于卡片余额，但是不满足上面任何一种拒绝交易的情况时，终端会选择脱机转联机交易。 当然了，如果交易金额没有超过卡片余额，但是却大于上述的DF20，终端就直接拒绝交易。 &nbsp; &nbsp; ﻿﻿ ﻿﻿ 阅读更多" />
<meta property="og:description" content="﻿﻿ 应用选择： 1.ADF、DDF、AEF、EF、DF有什么区别 ADF、DDF、AEF就是PBOC规范里面的名词了，ADF和DDF其实就是DF的一个映射，AEF就是EF的映射，我们不能直接操作DF和EF，只能操作ADF和DDF以及AEF，就相当于内存管理里面物理地址和虚拟地址一样，程序不能直接使用物理地址，只能使用虚拟地址，而内存管理的单元回去实现虚拟地址到物理地址的映射。 2.既然ADF和DDF都是DF的映射，那他们两个有啥区别呢？ DDF还是一个目录，这个目录下面可能有ADF，也可能还是有DDF的。 ADF也是一个目录，但是这个目录已经是aid的目录了，这个目录的名称就是AID了。 再根据ADF名称去选择ADF，ADF下面都是AEF，也就是这个AID多对应的有用数据文件，终端在GPO时候根据返回的AFL，再去读取对应的文件。 3.目录选择法在选择完PSE后是如何获得AID的 选择完PSE之后，PSE目录会返回SFI（tag 88），然后终端根据SFI，再执行READ RECORD命令读取记录，读记录根据SFI循环读取，直到卡片返回6A83为止，这个时候终端已经获取到卡片支持的AID（tag 4F）。 4.当卡片和终端有多个应用支持时，终端是根据什么判断是否需要持卡人选择应用的 根据应用优先级指示器的bit8来判断是否需要提示持卡人选择应用。 5.选择应用时如果在未读到记录之前或者读记录后检查数据非法等情况怎么办？ 如果遇到上述情况，则均可认为是目录选择法失败，这时候就需要改用AID选择法。 6.Qpboc和借贷记应用的在选择应用部分的区别 Q选择的是PPSE，借贷记选择的是PSE；Q不支持持卡人选择应用和AID列表选择法，Q的流程相对精简。 Q在选择完PPSE之后已经可以获取到AID（可能是多个）、应用优先级、应用指示器，Q不支持持卡人选择应用，所以如果有多个AID的时候，需要根据应用优先级选择优先级最高的AID，再根据AID选择ADF，就可以获取到PDOL（关键数据）、发行卡代码等数据。 借贷记需要根据选择PSE返回的SFI读记录获取AID，再根据AID去选择ADF，再去读数据；Q在选择PPSE之后就可以获取到AID，直接选择ADF了。 &nbsp; 应用初始化&amp;&amp;读应用数据 1.GPO命令是怎么组的？ 应用选择完成后，终端获取到了PDOL数据，GPO根据PDOL中的TAG组数据域传送给卡片 2.终端一定会有PDOL吗，没有PDOL哪些交易不能进行？ 卡片可以不给终端提供PDOL，如果终端没有获取到PDOL，则GPO数据域直接传递8300，如果卡片不提供PDOL的话，后续这张卡是不能做电子现金和Q的交易 3.GPO命令后的读记录命令是根据什么读的，怎么知道哪些记录用于数据认证 读记录命令是根据AFL读的，其包含终端将要读取用来交易处理的卡片数据文件的SFI和记录范围。每个要读取的文件在AFL中对应四个字节，含义如下： 字节1：短文件标识符 字节2：文件中要读取的第1个记录的记录号 字节3：文件中要读取的最后一个记录的记录号 字节4：从第1个记录开始的用于脱机数据认证的连续记录数 4.根据什么知道终端要执行哪些过程？ 后续的过程根据终端性能和卡片的支持能力决定哪些步骤要执行，支持哪种数据认证，是否支持持卡人认证，是否支持发卡行认证等，但风险管理是强制执行的不依据AIP里的值 5.QPBOC联机和QPBOC脱机的GPO响应数据有比较大的区别？ qPBOC联机交易或拒绝交易的GPO响应数据中是不返回AFL的，而QPBOC脱机的GPO响应数据中返回AFL 6.如何判断非接中到底是走QPBOC流程还是走非接触借贷记流程？ ——如果卡片响应GPO命令的状态字为“9000”，假设终端仅支持一种非接触选项（qPBOC或非接触式借记/贷记应用），则终端应按此选项继续处理，不必判断AIP； ——如果卡片响应GPO命令的状态字为“9000”，并且AIP第2字节第8位置‘0’，假设终端支持qPBOC，并且应用密文（标签“9F26”）在GPO命令响应中出现，则终端应按照qPBOC处理交易。如果标签为“9F26”的数据项不出现，则终端应按照非接触式借记/贷记应用处理交易。 7.QPBOC的GPO数据返回数据量为什么比较大？ 为了提高交互速度，减少终端与卡片交互次数，为此提高了单次交互的数据量，所以Q的GPO返回的数据量比较大，除了AIP和AFL之外，还有应用密文，交易计数器，发卡行应用数据，二磁道数据等多个数据。 8.SFI文件范围1-10,11-20,21-30的区别？ 1－10：EMV数据文件； 11－20：支付系统数据文件； 21－30：发卡行数据文件；&nbsp; 9.在读应用数据中,终端出现哪几种情况会终止交易? (1)卡片在一条或多条记录中返回同一个标签两次及两次以上； (2)卡片在某条记录中返回了卡片已经在GPO响应中返回的标签； (3)卡片中缺少必须有的数据； (4)数据格式错； (5)READ RECORD 命令返回状态字不是“9000“。 &nbsp; 脱机数据认证： 1.终端根据什么来决定执行哪种脱机数据认证方式？ 取决于两个要素AIP和终端性能。 2.应用开发工程师在分析IC卡交易失败的时候要看什么做判断？ 交易没走步都要首先分析AIP和终端性能的各个位的情况，而交易每执行完一步都要对TVR和TSI进行置位或者清零。 在分析IC卡失败交易的第一步应该是看TVR和TSI，看看终端做过什么，终端哪一步失败了，然后在分析某个步骤失败的原因。 3.对于参与脱机数据认证的SFI有明确分类，分为SFI从1-10以及11-30两类，这两类在参与认证上有什么区别？ 1-10的SFI在参与脱机数据认证的时候，其文件标志“70”和记录长度不参与脱机数据认证，而SFI为11-30的，则70和记录长度也要参与脱机数据认证。 4.静态数据认证SDA是如何认证的？ 三步走：一步获取认证中心公钥，二步恢复发卡行公钥，三步进行数据认证 一步获取认证中心公钥：首先通过公钥下载将服务端的公钥挨个下载到终端，在获取认证中心公钥的时候要做两个判一个判断是选择AID的5个字节为RID，另一个判断是需要用到度记录时获取到的发卡行公钥索引（8F），通过RID和索引可以选择到唯一的一组公钥，选择完成后，获取中心公钥即成功 二步恢复发卡行公钥：首先读记录的时候已经获取到发卡行90（签名处理过的发卡行公钥，92（发卡行公钥余项），9F32（发卡行公钥指数），所以这个时候可以用CA公钥利用RSA算法对90的数据解密。解密后的数据为一个比较复杂的数据格式，需要对数据的头尾，以及中间数据做判断，其中对后续才做有用的数据是“哈希值”，执行完这一步，终端已经获取到了卡片计算出的哈希值，执行完这一步，终端已经获取到了卡片计算出的哈希值，卡片计算哈希值的方法和终端的一样，故只要知道这里获取到了发卡行公钥或者发卡行公钥最左边的部分以及获取到了哈希值就OK了。 卡片已经返回了哈希值，终端自然也要计算一个哈希值，计算方法： 首先组织一长串数据，格式：证书格式 +发卡行标识(主账号最左面的3 -8个数字) +证书失效日期 +证书序列号 +哈希算法标识 +发卡行公钥算法标识 +发卡行公钥长度 +发卡行公钥指数长度 +发卡行公钥模数的完整数据 128个字节+发卡行公钥指数 特别说明：发卡行公钥模数的完整数据一部分是在还原发行卡公钥数据过程中获取的，还有另外一部分是在卡片读记录的时候通过92tag获取到的。除此之外，其他数据都为卡片返回原始数据，或者是一些固定写死的值。 然后用组好的数据进行哈希值计算，计算出的哈希值和我们在恢复发卡行公钥中获取到的哈希值一样，至此恢复发卡行公钥的步骤已完成，其中任何一步失败都会认为是静态数据认证失败。 第三步验证签名数据：用发卡行公钥来恢复签名的静态数据（过程与第二步雷同），恢复中有一部分是终端用来计算哈希值（将表5中的第二个到第五个数据元素（即从签名数据格式直到填充字节）从左到右连接，再把本规范第三册的第II部分中指明的需认证的静态数据加在后面。如果静态数据认证标签列表存在，并且其包含非‘82’的标签，那么静态数据认证失败），组织签名数据首先按照之前描述的sfi的规则获取脱机认证数据，还有个特别的地方，如果存在9F4A的话，需要将AIP作为签名数据,不需要包含tag和L，只要V就可以。最后对组织好的数据，进行sha1运算，获得hash值，然后和恢复签名数据时获取的哈希值比较，如果相等则SDA成功，然后将计算出的hash保存在9F45的标签中。SDA流程就算是结束了。 5.9F4A静态数据认证标签列表只存在在静态数据认证过程中吗？ 不是，SDA和DDA中都存在这个要素。DDA中主要用这个来做发卡行公钥恢复和IC卡公钥恢复，所以这个标签的作用主要是用来组建一组静态数据用于脱机数据认证。切不要以为因为它的名字叫做“静态数据认证标签列表”而忽略了在DDA中的应用。 6.动态数据认证DDA是如何认证的？ 首先需要恢复出发卡行公钥，这个和SDA的步骤一样，就不讨论了。 恢复出发卡行公钥后，DDA中还需要恢复IC卡公钥，这个步骤中，和恢复发卡行公钥类似，恢复出IC卡公钥以后也需要利用恢复后得到的数据再加上用于脱机数据认证的数据（SFI那边获得的）进行HASH值的计算，计算结果与恢复出的结果一致，则恢复出的IC卡公钥合法可用。 前面的内容SDA和DDA大同小异，没什么差别，但是DDA从恢复完IC卡公钥后和SDA就有很大区别了，下面我们一步一步讨论。 第一步，动态签名的生成 读记录的时候，需要一个关键数据DDOL（9F49），这个数据是卡片告诉终端（如果卡片没有返回，终端也需要有默认值，如果都没有则交易终止；如果DDOL中不含有9F37不可预知数，则交易终止）卡片需要终端的哪些数据来做动态签名。 终端组织好DDOL的数据之后，通过内部认证命令将数据提供给卡片，卡片会返回签名后的动态数据。卡片返回的数据时签名后的动态认证数据（tag为80时和tag为77时不一样的处理，与GPO是返回数据的处理类似），需要终端再利用IC卡公钥进行还原。还原后的数据中会有HASH。然后终端利用还原后得到的数据，再加上DDOL构成一个规范要求的数据串，然后在做SHA1运算获得HASH值，对比卡片返回的hash值和终端计算的是否一致，如果一致，证明DDA成功，再将HASH值保存到9F4C，则DDA已经结束了。 从分析来看，DDA其实是包含了SDA的过程，并且有了内部认证的处理，使得其安全性大于SDA，所以现在目前国内发行的卡基本上都是采用DDA作为脱机数据认证方式。 7.CDA认证 之前脱机数据认证，包括后面的GAC都忽略了CDA的存在，现在专门讨论一下CDA。 先从脱机数据认证开始，第一次遇到CDA。 CDA的前面三个步骤（获取ca公钥、恢复发卡行公钥、恢复IC卡公钥）和DDA一样，DDA是通过内部认证指令获取签名动态数据，CDA是通过GAC指令来获取的。 终端行为分析过程中正好有一次GAC，所以采用脱机数据认证的时候，前面只完成还原IC卡公钥就行了，CDA后续的部分放在终端行为分析GAC之后。 但是CDA的GAC和请求应用密文的GAC指令不一样，控制参数不一样，所以请求得到的结果也不一样。 CDA是用GAC指令请求，对于GAC指令请求，返回为格式2，也就是之前提到的77开头的格式，需要解析TLV，解析到9F4B签名动态应用数据。 这一步完成后，CDA比DDA多了一个步骤，终端首先将将恢复的密文数据和GAC返回的密文数据比较。 比较完成后终端需要将一些在GAC中返回的数据等一起组织起来，计算hash值，与恢复出的哈希值是否一致进行比较，如果一致则认为CDA到目前为止还是成功的。 然后还需要将GAC恢复数据得到的IC卡动态数据在进行处理，IC卡动态数据中也有一个hash值，还需要终端再按要求计算一个hash值，然后再和IC卡动态数据中的HASH值比较。 可以看得出是两层数据套在了一起，先解析外层，再解析内层，一层一层还原，最终 如果这个时候卡片返回的是TC，那么脱机交易就OK了，如果返回是ARQC的话，就发起联机。 联机过程忽略不谈，联机处理过程CDA和DDA一样，没什么区别。 如果联机失败，这个时候又要进行卡片行为分析。而且由于第一次GAC指令要求执行CDA，那么第二次GAC指令也要执行CDA。 &nbsp; 对比CDA和DDA，可以看得出CDA复杂了很多，首先CDA将应用密文也加入到签名数据，其次CDA在响应GAC指令的时候对于密文的数有进行了一次加密封装，进而更加增强了安全性。 CDA的卡现在太少了，除了专业测试的，其他几乎没有银行发行CDA卡的，所以这块没有办法取到数据，只能通过代码和文档进行理解和分析。&nbsp; 8.动态数据认证有哪几种原因？ 1.DDOL中不包含随机数（“9F37”） 2.在获取CA公钥，发卡行公钥，IC卡公钥任何一个公钥缺失都会导致失败。 3.CA公钥恢复发卡行公钥过程中恢复出的数据头尾格式和公钥格式和公钥指示符不合法。 4.恢复出的哈希值不等于计算出的哈希值。 5.发卡方ID号不等于PAN的前几位。 6.发卡行公钥证书过期 7.内部认证命令返回状态字不是“9000“。 8.签名动态应用数据和IC卡公钥模长度不一致 &nbsp; &nbsp; 处理限制： 1.应用用途控制的作用即及判断 卡片会返回一个AUC（9F07），通过判断这个数据域来允许或者拒绝交易。 判断的逻辑也很清晰，比如一个pos终端，判断AUC的标志位给出ATM有效，除ATM外的终端无效，那POS终端肯定要拒绝这个交易了。或者就是根据终端的国家代码和卡片的国家代码是否一致来判断为国际交易还是国内交易。AUC的各个位又明确给出了国际交易和国内交易的允许情况，终端根据当前交易的状态，以及这些位来判断交易允许或者拒绝 2.应用日期有什么限制？应用过期怎么办？ 应用生效日期要早与当前日期，应用失效日期要晚于当前日期。若应用过期，则在TVR中将相应位设置为‘1‘。 &nbsp; 持卡人认证： 1.持卡人认证这块EMV和PBOC的区别 EMV流程和PBOC流程差别在于对于CVM的支持有差异，即EMV支持脱机密文PIN验证，不支持持卡人证件验证，而PBOC不支持脱机密文PIN验证，支持持卡人证件验证。 2.解释一下CVM，CVM对于验证是怎么处理的 一个CVM含2个主要元素： (1)两个金额，X金额和Y金额。 (2)持卡人验证方法条目（可能含有多个） a.持卡人验证方法，即第9字节的bit7，用来表明持卡人验证失败后的操作。 b..持卡人验证方法类型，即第9字节的bit6--bit1，用来表明采用什么样的方法做持卡人验证。 c.持卡人验证方法条件，即第10字节，用来表明在什么情况下做持卡人验证。 3.结合实例谈谈对cvm的理解 这是一个标准的cvm列表，X金额为0，Y金额为0，后续每两个字节表示一个持卡人验证方法条目，5E的二进制位01 011110这表明如果持卡人验证失败则使用后续的CVM，CVM验证方法为签名，03表示“如果终端支持这个CVM”。 这样估计还是比较抽象，我用语言再描述一下。 首先5E的bit8 bit7为01，这表明如果这个cvm失败，那就要用到后面的1F 00作为持卡人验证方法。 再看5E的bit6到bit1，这个规范上说的很明确，现在的6个数字就是代表使用签名。 再看03，03的含义是“如果终端支持这个CVM”，这个怎么理解呢？终端有一个很重要的数据，终端性能，终端性能中明确指出了终端所支持的验证方法，所以03的意思就是如果终端支持持卡人签名验证，那么这个交易就使用签名作为验证方法。当持卡人验证条件为03时，内核对于终端性能的判断也是直接影响持卡人验证成功与失败的关键要素。 后面的1F00就不做分析了，分析方法同理。 程序分析完CVM列表后，再根据分析结果提示持卡人进行操作，然后就相当于持卡人认证已经完成。 &nbsp;4.脱机PIN加密过程 (1)&nbsp;终端把用户输入的明文PIN按照一定的格式补位对齐,&nbsp;然后用get&nbsp;challenge命令从卡片中取一个8字节的随机数.&nbsp; (2)&nbsp;终端自己产生一组长度为N-17的随机数(N为PIN加密公钥的长度),&nbsp;然后把补位后的PIN,卡片中取的随机数以及终端产生的随机数拼接在一起,&nbsp;与PIN加密公钥做RSA运算.&nbsp; (3)把上一步运算的结果通过verify命令发给IC卡. (4)&nbsp;卡片用PIN加密私钥解密数据,&nbsp;首先检查解出来的8字节随机数是否与自己产生的一致，然后卡片检查恢复的数据头字节是否有效,&nbsp;最后一步是验证PIN是否合法.&nbsp;只有所有的条件都满足，脱机加密PIN才算成功.&nbsp; &nbsp; 终端风险管理： 1.为什么要进行最低限额检查？如何进行？ 最低限额检查用于控制交易当前交易金额或同一张卡片连续几笔交易累积金额超过某个数值时则要求联机授权。 如果终端不支持交易日志，则终端直接比较授权金额和最低限额。如果交易授权金额大于或等于最低限额，终端将TVR中的“交易超过最低限额”位设为‘1’。即使最低限额为0，终端也进行同样检查，这种情况会导致所有交易的TVR中的“交易超过最低限额”位都设为‘1’。 如果终端支持交易日志，则终端在交易日志中寻找与当前交易的PAN和PAN序列号（如果终端交易日志和卡片中都存在）相同的一个交易记录，将其对应的累计交易金额与当前交易的授权金额相加，如果和大于或等于最低限额，则TVR中的“交易超过最低限额”位设为‘1’。 特别说明：终端风险管理，没有联机能力的终端可以不做后续的内容，直接跳过后面的步骤，进入终端行为分析。简而言之，电子现金交易，这一流程的后续两步可以直接跳过。 2.随机选中交易实例理解 终端风险管理参数示例 参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;值 终端最低限额&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100&nbsp;&nbsp;&nbsp;（AID参数下发） 终端随机数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;&nbsp;（终端随机生成） 偏置随机选择的阈值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; （AID参数下发） 随机选择目标百分比&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20％ （AID参数下发） 偏置随机选择的最大目标百分比&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50％（AID参数下发） 情形1： 交易金额是20。因为交易金额小于偏置随机选择阈值，因此执行随机选择。 比较终端随机数与目标百分数。因为随机数（25）大于目标百分数（20），所以交易不被选中作联机处理。 情形2： 交易金额是60。这个金额大于偏置随机选择的阈值，但小于终端最低限额。因此应用偏置随机选择。 交易金额比阈值高20，该差值是终端最低限额与阈值差值（100－40＝60）的1/3。因此将最大目标百分数与目标百分数的差值的1/3（50％－20％＝30％×1/3＝10％）加到目标百分数上，得到交易目标百分数为30％（20％＋10％＝30％）。 终端随机数为25，小于交易目标百分数（30），所以交易被选中进行联机处理。 情形3： 交易金额为150。因该金额大于终端最低限额，因此交易不进行随机选择。而是进行最低限额检查而联机处理。 3.频度检查执行条件 如果连续脱机交易次数下限LCOL(标签‘9F14’)与连续脱机交易次数上限UCOL(标签‘9F23’)都存在，则执行，否则不执行。 如果执行，终端需要先GET DATA获取9F36和9F13，然后再和UCOL和LCOL比较，判断满足交易频度检查条件。 如果获取到的9F13为0，则将该卡标志位新卡。新卡是不允许脱机交易的，IC卡cos会对这个有要求，主要是安全考虑，因为新卡做脱机交易不可控。 &nbsp; 终端行为分析： 1.终端行为分析需要用到哪些重要数据？ 发卡行行为代码（IAC） 发卡行行为代码，来自读记录文件卡片返回 发卡行行为代码有三个数据元，即发卡行行为代码-拒绝、发卡行行为代码-联机、发卡行行为代码-缺省。每个发卡行行为代码由一组与终端验证结果（TVR）中的位相对应的位 组成 IAC－拒绝位设置为“1”反映了交易被脱机拒绝的终端验证结果条件 IAC－联机位设置为“1”代表需要联机授权条件 IAC－缺省位设置为“1”是当联机处理不可行时脱机拒绝所需的条件 终端行为代码(TAC)&nbsp; TAC有三个数据元，它们都是由一系列的位组成的，这些位对应于TVR中的数据位。终端行为代码来自emv参数下载交易。 TAC－拒绝&nbsp;收单行设置的能够导致交易脱机拒绝的TVR条件位 TAC－联机&nbsp;收单行设置的能够导致交易联机的TVR条件位 TAC－缺省 收单行设置的在交易联机无法进行的情况下能够导致脱机拒绝的TVR条件位 这6个代码的查看方法和TVR查看方式一样，使用时也是配合TVR进行使用。 2.终端是如何判断其行为的？ 检查过程完全由终端利用先前从卡片获取的IAC数据和终端保存的TAC数据进行，无需与其它设备进行交互处理。 在处理过程中，终端比较IAC和TAC中与终端验证结果（TVR）对应的位。如果TVR和IAC或TAC中相应的位都被设置为“1”，则采纳对应的IAC或TAC。示例如下： 终端的处理步骤如下： 步骤 1：终端比较 IAC－拒绝和 TVR。如果不存在 IAC－拒绝，则采用缺省值‘0000000000’。如果IAC－拒绝和 TVR 的任何对应位同时设为‘1’，终端必须： ——&nbsp;&nbsp;把授权响应码置为‘Z1’(脱机拒绝)； ——&nbsp;&nbsp;把 GENERATE AC（产生应用密文）命令的 P1参数设为请求应用认证密文（AAC）； ——&nbsp;&nbsp;进行请求应用密文步骤。 步骤 2：终端对 TAC－拒绝和 TVR进行类似的比较。如果不存在 TAC－拒绝，则采用缺省值‘0000000000’。如果 TAC－拒绝和 TVR的任何对应位同时设为‘1’，终端必须采取与 IAC－拒绝相同的处理。 步骤 3：如果终端具有联机处理能力（仅联机的终端除外），则它应该使用 IAC－联机和TAC－联机与TVR比较。如果 IAC－联机不存在，则使用缺省值‘FFFFFFFFFF’，如果 TAC－联机不存在，则使用缺省值‘0000000000’。如果 IAC－联机和 TVR的任何对应位同时置为‘1’，则终端： ——&nbsp;把产生应用密文（GENERATE AC）命令的 P1参数设为授权请求密文（ARQC），以进行联机授权请求； ——&nbsp;进行生成应用密文步骤。 对于仅联机的终端，如果在步骤 1和步骤 2中未决定脱机拒绝，则终端不必进行 IAC－联机和 TAC－联机与 TVR的比较，而直接按照 IAC－联机或 TAC－联机和 TVR的任何对应位同时置为‘1’的情况来处理，通过请求联机来继续进行交易。 步骤 4：如果终端是仅脱机终端或者当有联机处理能力的终端出于某种原因不能联机时，则使用 IAC——缺省和 TAC——缺省与 TVR 比较。如果没有 IAC－缺省，则使用缺省值‘FFFFFFFFFF’，如果 TAC——缺省不存在，则使用缺省值‘0000000000’。如果比较结果的任何对应位同时为‘1’，则终端： ——&nbsp;把授权响应码置为‘Z3’（不能联机，脱机拒绝），仅脱机终端授权响应码置为‘Z1’； ——&nbsp;把产生应用密文（GENERATE AC）命令的的 P1参数设置为请求 AAC； ——&nbsp;进行生成应用密文步骤。 对于仅联机的终端，当无法进行联机时，它可以选择正常的处理TAC/IAC－缺省，也可以选择跳过TAC/IAC——缺省的处理。对于跳过TAC/IAC——缺省处理的终端应该直接按照TAC/IAC——缺省与TVR匹配进行处理，并且在第2个GENERATE AC请求AAC。对于正常处理TAC/IAC——缺省的终端，应该根据TAC/IAC——缺省与TVR匹配的结果生成应用密文，这时仅联机的终端可能脱机完成交易。 步骤 5：如果在以上的比较中没有出现对应位同时为‘1’的情况，则终端： ——&nbsp;把授权响应码置为‘Y1’（脱机批准）； ——&nbsp;把 GENERATE AC（请求应用密文）命令的 P1参数设置为请求交易证书（TC）； ——&nbsp;进行请求应用密文步骤。 这里的GENERATE AC就是我们所说的第一次GAC，如果脱机批准了，获取到的TC值需要在上送交易明细时上送到后台。如果卡片返回ARQC，那么在联机交易结束后，还需要再做第二次GAC，这个内容后续再讨论。 &nbsp; 联机处理&amp;&amp;交易结束 1.联机交易处理流程 第一步： 处理ARPC（如果不包含，则跳过；如果包含并且AIP特性标志不支持发卡行认证，则跳过） 收到联机返回报文后，获取tag“91”，即ARPC，通过外部认证指令将ARPC发给卡片，如果卡片响应9000，说明ARPC校验通过，否则发起冲正。 第二步： 处理发卡行脚本 再看tag72（或71，在圈存交易时，不允许出现两个脚本），这个是发卡行返回脚本采用tag72作为标签，72后面还是一个TLV，解析tag86（发卡行脚本命令），获取到。再通过指令将这个命令给到卡片，整个数据就是一个指令，不需要再添加内容 第三步： 第二次GAC，第一次GAC发送GAC指令时组织数据采用的是CDOL1，第二次GAC组织命令时用的是CDOL2，CDOL2也是在读记录时候获取到的。 2.假如卡片请求ARQC。但终端执行联机交易失败怎么办？ 卡片请求ARQC，但是终端无法联机，并不是代表这个交易终止了，终端和卡片还有最后一次尝试，就是所谓的脱机转联机，联机失败再转脱机。 这就好像买东西一样，先去第一家店看了看，觉得东西还行，但是先不买，然后再去第二家店，结果发现第二家店的东西又贵又不好，那再回去第一家店看看，价格能不能商量一下，如果能谈妥，OK，那么就交易。 这个时候首先又需要检查IAC-缺省和TAC缺省执行终端行为分析（这部分在之前终端行为分析中有表详细的描述），并且根绝结果发送第二次GAC指令。 如果第二次GAC指令能够成功返回TC，那么脱机交易批准，如果返回ACC，则交易拒绝，，这个时候不可能再返回ARQC了。 如果脱机成功则响应码为Y3，但是，如果终端在第一次GAC就获取TC批准脱机交易的话，响应码是Y1，所以通过Y1和Y3就可以知道是哪一种脱机批准。 到此为止，整个借贷记交易和电子现金的交易就已经全部处理完了。 &nbsp; &nbsp; QPBOC和借记贷记对比 1.QPBOC和EMV在PDOL中有什么区别？ 非接中的GPO对于PDOL的要求是必须含有9F66（借贷记的GPO是可以支持没有PDOL的，终端在GPO只要发送8300就行），如果没有，终端直接拒绝交易。 2.QPBOC的持卡人认证 QPBOC的持卡人认证和借贷记电子现金不同，QPBOC的持卡人认证结果只有2种情况：签名，联机。通过判断卡片交易属性（9F6C）和终端交易属性（9F66）来判断采用哪种持卡人验证方式。 3.QPBOC的处理限制与借贷记流程的有什么区别？ QPBOC的处理限制只做一件事，就是判断卡有效期，相当于借贷记流程中的一个小步骤。 4.QPBOC的脱机数据认证与借贷记流程的有什么区别？ 因为卡片不会再和终端有指令交互，所以数据认证使用的QPBOC自己定义的一种FDDA。FDDA的执行同样需要根据AIP的情况作出判断。FDDA签名的动态数据通过9F4B在读记录时返回，借贷记是通过内部认证获取到的。这个动态数据的获得，也是区分FDDA版本为01还是00.所以缺少了DDA的内部认证指令，所以叫做FDDA。而用来参于组织签名数据的是通过一个固定数据域组织的，借贷记是通过DDOL获取的。 特别说明:PB0C3.新增了一个9F69的标签，需要在版本01的FDDA中加入到签名数据域。 &nbsp; 交易限额 终端最低限额（9F1B）、终端电子现金交易限额（9F7B）、非解最低限额（DF19）、非解交易限额（DF20）、CVM限额（DF21） 9F1B，就是所谓的Floorlimt，这个参数主要用在终端风险管理终端中的第一个步骤-------最低限额检查。 9F7B，当交易金额小于9F7B的时候，终端可以执行电子现金脱机交易。 特别说明：我一直觉得这个限额只应该对接触式电子现金交易有效，但是现在不管是客户还是同事，很多人都认为这个限额应该对Qpboc也要做判断。虽然目前代码是这么做的，但是我还是觉得这个限额应该只是对电子现金有效。 DF19、DF20、DF21三个TAG值都是连续的限额，就是针对于QPBOC的三个限额，这三个限额主要是在QPBOC预处理阶段进行判断。 DF19，交易金额必须大于DF19，才允许做非解交易。 DF20，交易金额不能大于DF20，否则交易拒绝，提示持卡人采用别的方式交易。 DF21，超过该限额，终端应该在交易属性9F66中置位“要求CVM”，进而在GPO的时候告诉卡片终端需要CVM。但是这个值实际有什么意义也不清楚。Q的持卡人验证只有签名和联机两种方式，卡片返回的9F6C再加上终端交易属性已经可以决定持卡人验证方式了。CVM在这个时候确实没啥用了。 还有一个额度不得不提，就是卡片余额，当交易金额大于卡片余额，但是不满足上面任何一种拒绝交易的情况时，终端会选择脱机转联机交易。 当然了，如果交易金额没有超过卡片余额，但是却大于上述的DF20，终端就直接拒绝交易。 &nbsp; &nbsp; ﻿﻿ ﻿﻿ 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/12/12/ec92b3925dd39799b2a60bc41d774c56.html" />
<meta property="og:url" content="https://mlh.app/2017/12/12/ec92b3925dd39799b2a60bc41d774c56.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-12-12T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"﻿﻿ 应用选择： 1.ADF、DDF、AEF、EF、DF有什么区别 ADF、DDF、AEF就是PBOC规范里面的名词了，ADF和DDF其实就是DF的一个映射，AEF就是EF的映射，我们不能直接操作DF和EF，只能操作ADF和DDF以及AEF，就相当于内存管理里面物理地址和虚拟地址一样，程序不能直接使用物理地址，只能使用虚拟地址，而内存管理的单元回去实现虚拟地址到物理地址的映射。 2.既然ADF和DDF都是DF的映射，那他们两个有啥区别呢？ DDF还是一个目录，这个目录下面可能有ADF，也可能还是有DDF的。 ADF也是一个目录，但是这个目录已经是aid的目录了，这个目录的名称就是AID了。 再根据ADF名称去选择ADF，ADF下面都是AEF，也就是这个AID多对应的有用数据文件，终端在GPO时候根据返回的AFL，再去读取对应的文件。 3.目录选择法在选择完PSE后是如何获得AID的 选择完PSE之后，PSE目录会返回SFI（tag 88），然后终端根据SFI，再执行READ RECORD命令读取记录，读记录根据SFI循环读取，直到卡片返回6A83为止，这个时候终端已经获取到卡片支持的AID（tag 4F）。 4.当卡片和终端有多个应用支持时，终端是根据什么判断是否需要持卡人选择应用的 根据应用优先级指示器的bit8来判断是否需要提示持卡人选择应用。 5.选择应用时如果在未读到记录之前或者读记录后检查数据非法等情况怎么办？ 如果遇到上述情况，则均可认为是目录选择法失败，这时候就需要改用AID选择法。 6.Qpboc和借贷记应用的在选择应用部分的区别 Q选择的是PPSE，借贷记选择的是PSE；Q不支持持卡人选择应用和AID列表选择法，Q的流程相对精简。 Q在选择完PPSE之后已经可以获取到AID（可能是多个）、应用优先级、应用指示器，Q不支持持卡人选择应用，所以如果有多个AID的时候，需要根据应用优先级选择优先级最高的AID，再根据AID选择ADF，就可以获取到PDOL（关键数据）、发行卡代码等数据。 借贷记需要根据选择PSE返回的SFI读记录获取AID，再根据AID去选择ADF，再去读数据；Q在选择PPSE之后就可以获取到AID，直接选择ADF了。 &nbsp; 应用初始化&amp;&amp;读应用数据 1.GPO命令是怎么组的？ 应用选择完成后，终端获取到了PDOL数据，GPO根据PDOL中的TAG组数据域传送给卡片 2.终端一定会有PDOL吗，没有PDOL哪些交易不能进行？ 卡片可以不给终端提供PDOL，如果终端没有获取到PDOL，则GPO数据域直接传递8300，如果卡片不提供PDOL的话，后续这张卡是不能做电子现金和Q的交易 3.GPO命令后的读记录命令是根据什么读的，怎么知道哪些记录用于数据认证 读记录命令是根据AFL读的，其包含终端将要读取用来交易处理的卡片数据文件的SFI和记录范围。每个要读取的文件在AFL中对应四个字节，含义如下： 字节1：短文件标识符 字节2：文件中要读取的第1个记录的记录号 字节3：文件中要读取的最后一个记录的记录号 字节4：从第1个记录开始的用于脱机数据认证的连续记录数 4.根据什么知道终端要执行哪些过程？ 后续的过程根据终端性能和卡片的支持能力决定哪些步骤要执行，支持哪种数据认证，是否支持持卡人认证，是否支持发卡行认证等，但风险管理是强制执行的不依据AIP里的值 5.QPBOC联机和QPBOC脱机的GPO响应数据有比较大的区别？ qPBOC联机交易或拒绝交易的GPO响应数据中是不返回AFL的，而QPBOC脱机的GPO响应数据中返回AFL 6.如何判断非接中到底是走QPBOC流程还是走非接触借贷记流程？ ——如果卡片响应GPO命令的状态字为“9000”，假设终端仅支持一种非接触选项（qPBOC或非接触式借记/贷记应用），则终端应按此选项继续处理，不必判断AIP； ——如果卡片响应GPO命令的状态字为“9000”，并且AIP第2字节第8位置‘0’，假设终端支持qPBOC，并且应用密文（标签“9F26”）在GPO命令响应中出现，则终端应按照qPBOC处理交易。如果标签为“9F26”的数据项不出现，则终端应按照非接触式借记/贷记应用处理交易。 7.QPBOC的GPO数据返回数据量为什么比较大？ 为了提高交互速度，减少终端与卡片交互次数，为此提高了单次交互的数据量，所以Q的GPO返回的数据量比较大，除了AIP和AFL之外，还有应用密文，交易计数器，发卡行应用数据，二磁道数据等多个数据。 8.SFI文件范围1-10,11-20,21-30的区别？ 1－10：EMV数据文件； 11－20：支付系统数据文件； 21－30：发卡行数据文件；&nbsp; 9.在读应用数据中,终端出现哪几种情况会终止交易? (1)卡片在一条或多条记录中返回同一个标签两次及两次以上； (2)卡片在某条记录中返回了卡片已经在GPO响应中返回的标签； (3)卡片中缺少必须有的数据； (4)数据格式错； (5)READ RECORD 命令返回状态字不是“9000“。 &nbsp; 脱机数据认证： 1.终端根据什么来决定执行哪种脱机数据认证方式？ 取决于两个要素AIP和终端性能。 2.应用开发工程师在分析IC卡交易失败的时候要看什么做判断？ 交易没走步都要首先分析AIP和终端性能的各个位的情况，而交易每执行完一步都要对TVR和TSI进行置位或者清零。 在分析IC卡失败交易的第一步应该是看TVR和TSI，看看终端做过什么，终端哪一步失败了，然后在分析某个步骤失败的原因。 3.对于参与脱机数据认证的SFI有明确分类，分为SFI从1-10以及11-30两类，这两类在参与认证上有什么区别？ 1-10的SFI在参与脱机数据认证的时候，其文件标志“70”和记录长度不参与脱机数据认证，而SFI为11-30的，则70和记录长度也要参与脱机数据认证。 4.静态数据认证SDA是如何认证的？ 三步走：一步获取认证中心公钥，二步恢复发卡行公钥，三步进行数据认证 一步获取认证中心公钥：首先通过公钥下载将服务端的公钥挨个下载到终端，在获取认证中心公钥的时候要做两个判一个判断是选择AID的5个字节为RID，另一个判断是需要用到度记录时获取到的发卡行公钥索引（8F），通过RID和索引可以选择到唯一的一组公钥，选择完成后，获取中心公钥即成功 二步恢复发卡行公钥：首先读记录的时候已经获取到发卡行90（签名处理过的发卡行公钥，92（发卡行公钥余项），9F32（发卡行公钥指数），所以这个时候可以用CA公钥利用RSA算法对90的数据解密。解密后的数据为一个比较复杂的数据格式，需要对数据的头尾，以及中间数据做判断，其中对后续才做有用的数据是“哈希值”，执行完这一步，终端已经获取到了卡片计算出的哈希值，执行完这一步，终端已经获取到了卡片计算出的哈希值，卡片计算哈希值的方法和终端的一样，故只要知道这里获取到了发卡行公钥或者发卡行公钥最左边的部分以及获取到了哈希值就OK了。 卡片已经返回了哈希值，终端自然也要计算一个哈希值，计算方法： 首先组织一长串数据，格式：证书格式 +发卡行标识(主账号最左面的3 -8个数字) +证书失效日期 +证书序列号 +哈希算法标识 +发卡行公钥算法标识 +发卡行公钥长度 +发卡行公钥指数长度 +发卡行公钥模数的完整数据 128个字节+发卡行公钥指数 特别说明：发卡行公钥模数的完整数据一部分是在还原发行卡公钥数据过程中获取的，还有另外一部分是在卡片读记录的时候通过92tag获取到的。除此之外，其他数据都为卡片返回原始数据，或者是一些固定写死的值。 然后用组好的数据进行哈希值计算，计算出的哈希值和我们在恢复发卡行公钥中获取到的哈希值一样，至此恢复发卡行公钥的步骤已完成，其中任何一步失败都会认为是静态数据认证失败。 第三步验证签名数据：用发卡行公钥来恢复签名的静态数据（过程与第二步雷同），恢复中有一部分是终端用来计算哈希值（将表5中的第二个到第五个数据元素（即从签名数据格式直到填充字节）从左到右连接，再把本规范第三册的第II部分中指明的需认证的静态数据加在后面。如果静态数据认证标签列表存在，并且其包含非‘82’的标签，那么静态数据认证失败），组织签名数据首先按照之前描述的sfi的规则获取脱机认证数据，还有个特别的地方，如果存在9F4A的话，需要将AIP作为签名数据,不需要包含tag和L，只要V就可以。最后对组织好的数据，进行sha1运算，获得hash值，然后和恢复签名数据时获取的哈希值比较，如果相等则SDA成功，然后将计算出的hash保存在9F45的标签中。SDA流程就算是结束了。 5.9F4A静态数据认证标签列表只存在在静态数据认证过程中吗？ 不是，SDA和DDA中都存在这个要素。DDA中主要用这个来做发卡行公钥恢复和IC卡公钥恢复，所以这个标签的作用主要是用来组建一组静态数据用于脱机数据认证。切不要以为因为它的名字叫做“静态数据认证标签列表”而忽略了在DDA中的应用。 6.动态数据认证DDA是如何认证的？ 首先需要恢复出发卡行公钥，这个和SDA的步骤一样，就不讨论了。 恢复出发卡行公钥后，DDA中还需要恢复IC卡公钥，这个步骤中，和恢复发卡行公钥类似，恢复出IC卡公钥以后也需要利用恢复后得到的数据再加上用于脱机数据认证的数据（SFI那边获得的）进行HASH值的计算，计算结果与恢复出的结果一致，则恢复出的IC卡公钥合法可用。 前面的内容SDA和DDA大同小异，没什么差别，但是DDA从恢复完IC卡公钥后和SDA就有很大区别了，下面我们一步一步讨论。 第一步，动态签名的生成 读记录的时候，需要一个关键数据DDOL（9F49），这个数据是卡片告诉终端（如果卡片没有返回，终端也需要有默认值，如果都没有则交易终止；如果DDOL中不含有9F37不可预知数，则交易终止）卡片需要终端的哪些数据来做动态签名。 终端组织好DDOL的数据之后，通过内部认证命令将数据提供给卡片，卡片会返回签名后的动态数据。卡片返回的数据时签名后的动态认证数据（tag为80时和tag为77时不一样的处理，与GPO是返回数据的处理类似），需要终端再利用IC卡公钥进行还原。还原后的数据中会有HASH。然后终端利用还原后得到的数据，再加上DDOL构成一个规范要求的数据串，然后在做SHA1运算获得HASH值，对比卡片返回的hash值和终端计算的是否一致，如果一致，证明DDA成功，再将HASH值保存到9F4C，则DDA已经结束了。 从分析来看，DDA其实是包含了SDA的过程，并且有了内部认证的处理，使得其安全性大于SDA，所以现在目前国内发行的卡基本上都是采用DDA作为脱机数据认证方式。 7.CDA认证 之前脱机数据认证，包括后面的GAC都忽略了CDA的存在，现在专门讨论一下CDA。 先从脱机数据认证开始，第一次遇到CDA。 CDA的前面三个步骤（获取ca公钥、恢复发卡行公钥、恢复IC卡公钥）和DDA一样，DDA是通过内部认证指令获取签名动态数据，CDA是通过GAC指令来获取的。 终端行为分析过程中正好有一次GAC，所以采用脱机数据认证的时候，前面只完成还原IC卡公钥就行了，CDA后续的部分放在终端行为分析GAC之后。 但是CDA的GAC和请求应用密文的GAC指令不一样，控制参数不一样，所以请求得到的结果也不一样。 CDA是用GAC指令请求，对于GAC指令请求，返回为格式2，也就是之前提到的77开头的格式，需要解析TLV，解析到9F4B签名动态应用数据。 这一步完成后，CDA比DDA多了一个步骤，终端首先将将恢复的密文数据和GAC返回的密文数据比较。 比较完成后终端需要将一些在GAC中返回的数据等一起组织起来，计算hash值，与恢复出的哈希值是否一致进行比较，如果一致则认为CDA到目前为止还是成功的。 然后还需要将GAC恢复数据得到的IC卡动态数据在进行处理，IC卡动态数据中也有一个hash值，还需要终端再按要求计算一个hash值，然后再和IC卡动态数据中的HASH值比较。 可以看得出是两层数据套在了一起，先解析外层，再解析内层，一层一层还原，最终 如果这个时候卡片返回的是TC，那么脱机交易就OK了，如果返回是ARQC的话，就发起联机。 联机过程忽略不谈，联机处理过程CDA和DDA一样，没什么区别。 如果联机失败，这个时候又要进行卡片行为分析。而且由于第一次GAC指令要求执行CDA，那么第二次GAC指令也要执行CDA。 &nbsp; 对比CDA和DDA，可以看得出CDA复杂了很多，首先CDA将应用密文也加入到签名数据，其次CDA在响应GAC指令的时候对于密文的数有进行了一次加密封装，进而更加增强了安全性。 CDA的卡现在太少了，除了专业测试的，其他几乎没有银行发行CDA卡的，所以这块没有办法取到数据，只能通过代码和文档进行理解和分析。&nbsp; 8.动态数据认证有哪几种原因？ 1.DDOL中不包含随机数（“9F37”） 2.在获取CA公钥，发卡行公钥，IC卡公钥任何一个公钥缺失都会导致失败。 3.CA公钥恢复发卡行公钥过程中恢复出的数据头尾格式和公钥格式和公钥指示符不合法。 4.恢复出的哈希值不等于计算出的哈希值。 5.发卡方ID号不等于PAN的前几位。 6.发卡行公钥证书过期 7.内部认证命令返回状态字不是“9000“。 8.签名动态应用数据和IC卡公钥模长度不一致 &nbsp; &nbsp; 处理限制： 1.应用用途控制的作用即及判断 卡片会返回一个AUC（9F07），通过判断这个数据域来允许或者拒绝交易。 判断的逻辑也很清晰，比如一个pos终端，判断AUC的标志位给出ATM有效，除ATM外的终端无效，那POS终端肯定要拒绝这个交易了。或者就是根据终端的国家代码和卡片的国家代码是否一致来判断为国际交易还是国内交易。AUC的各个位又明确给出了国际交易和国内交易的允许情况，终端根据当前交易的状态，以及这些位来判断交易允许或者拒绝 2.应用日期有什么限制？应用过期怎么办？ 应用生效日期要早与当前日期，应用失效日期要晚于当前日期。若应用过期，则在TVR中将相应位设置为‘1‘。 &nbsp; 持卡人认证： 1.持卡人认证这块EMV和PBOC的区别 EMV流程和PBOC流程差别在于对于CVM的支持有差异，即EMV支持脱机密文PIN验证，不支持持卡人证件验证，而PBOC不支持脱机密文PIN验证，支持持卡人证件验证。 2.解释一下CVM，CVM对于验证是怎么处理的 一个CVM含2个主要元素： (1)两个金额，X金额和Y金额。 (2)持卡人验证方法条目（可能含有多个） a.持卡人验证方法，即第9字节的bit7，用来表明持卡人验证失败后的操作。 b..持卡人验证方法类型，即第9字节的bit6--bit1，用来表明采用什么样的方法做持卡人验证。 c.持卡人验证方法条件，即第10字节，用来表明在什么情况下做持卡人验证。 3.结合实例谈谈对cvm的理解 这是一个标准的cvm列表，X金额为0，Y金额为0，后续每两个字节表示一个持卡人验证方法条目，5E的二进制位01 011110这表明如果持卡人验证失败则使用后续的CVM，CVM验证方法为签名，03表示“如果终端支持这个CVM”。 这样估计还是比较抽象，我用语言再描述一下。 首先5E的bit8 bit7为01，这表明如果这个cvm失败，那就要用到后面的1F 00作为持卡人验证方法。 再看5E的bit6到bit1，这个规范上说的很明确，现在的6个数字就是代表使用签名。 再看03，03的含义是“如果终端支持这个CVM”，这个怎么理解呢？终端有一个很重要的数据，终端性能，终端性能中明确指出了终端所支持的验证方法，所以03的意思就是如果终端支持持卡人签名验证，那么这个交易就使用签名作为验证方法。当持卡人验证条件为03时，内核对于终端性能的判断也是直接影响持卡人验证成功与失败的关键要素。 后面的1F00就不做分析了，分析方法同理。 程序分析完CVM列表后，再根据分析结果提示持卡人进行操作，然后就相当于持卡人认证已经完成。 &nbsp;4.脱机PIN加密过程 (1)&nbsp;终端把用户输入的明文PIN按照一定的格式补位对齐,&nbsp;然后用get&nbsp;challenge命令从卡片中取一个8字节的随机数.&nbsp; (2)&nbsp;终端自己产生一组长度为N-17的随机数(N为PIN加密公钥的长度),&nbsp;然后把补位后的PIN,卡片中取的随机数以及终端产生的随机数拼接在一起,&nbsp;与PIN加密公钥做RSA运算.&nbsp; (3)把上一步运算的结果通过verify命令发给IC卡. (4)&nbsp;卡片用PIN加密私钥解密数据,&nbsp;首先检查解出来的8字节随机数是否与自己产生的一致，然后卡片检查恢复的数据头字节是否有效,&nbsp;最后一步是验证PIN是否合法.&nbsp;只有所有的条件都满足，脱机加密PIN才算成功.&nbsp; &nbsp; 终端风险管理： 1.为什么要进行最低限额检查？如何进行？ 最低限额检查用于控制交易当前交易金额或同一张卡片连续几笔交易累积金额超过某个数值时则要求联机授权。 如果终端不支持交易日志，则终端直接比较授权金额和最低限额。如果交易授权金额大于或等于最低限额，终端将TVR中的“交易超过最低限额”位设为‘1’。即使最低限额为0，终端也进行同样检查，这种情况会导致所有交易的TVR中的“交易超过最低限额”位都设为‘1’。 如果终端支持交易日志，则终端在交易日志中寻找与当前交易的PAN和PAN序列号（如果终端交易日志和卡片中都存在）相同的一个交易记录，将其对应的累计交易金额与当前交易的授权金额相加，如果和大于或等于最低限额，则TVR中的“交易超过最低限额”位设为‘1’。 特别说明：终端风险管理，没有联机能力的终端可以不做后续的内容，直接跳过后面的步骤，进入终端行为分析。简而言之，电子现金交易，这一流程的后续两步可以直接跳过。 2.随机选中交易实例理解 终端风险管理参数示例 参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;值 终端最低限额&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100&nbsp;&nbsp;&nbsp;（AID参数下发） 终端随机数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;&nbsp;（终端随机生成） 偏置随机选择的阈值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; （AID参数下发） 随机选择目标百分比&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20％ （AID参数下发） 偏置随机选择的最大目标百分比&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50％（AID参数下发） 情形1： 交易金额是20。因为交易金额小于偏置随机选择阈值，因此执行随机选择。 比较终端随机数与目标百分数。因为随机数（25）大于目标百分数（20），所以交易不被选中作联机处理。 情形2： 交易金额是60。这个金额大于偏置随机选择的阈值，但小于终端最低限额。因此应用偏置随机选择。 交易金额比阈值高20，该差值是终端最低限额与阈值差值（100－40＝60）的1/3。因此将最大目标百分数与目标百分数的差值的1/3（50％－20％＝30％×1/3＝10％）加到目标百分数上，得到交易目标百分数为30％（20％＋10％＝30％）。 终端随机数为25，小于交易目标百分数（30），所以交易被选中进行联机处理。 情形3： 交易金额为150。因该金额大于终端最低限额，因此交易不进行随机选择。而是进行最低限额检查而联机处理。 3.频度检查执行条件 如果连续脱机交易次数下限LCOL(标签‘9F14’)与连续脱机交易次数上限UCOL(标签‘9F23’)都存在，则执行，否则不执行。 如果执行，终端需要先GET DATA获取9F36和9F13，然后再和UCOL和LCOL比较，判断满足交易频度检查条件。 如果获取到的9F13为0，则将该卡标志位新卡。新卡是不允许脱机交易的，IC卡cos会对这个有要求，主要是安全考虑，因为新卡做脱机交易不可控。 &nbsp; 终端行为分析： 1.终端行为分析需要用到哪些重要数据？ 发卡行行为代码（IAC） 发卡行行为代码，来自读记录文件卡片返回 发卡行行为代码有三个数据元，即发卡行行为代码-拒绝、发卡行行为代码-联机、发卡行行为代码-缺省。每个发卡行行为代码由一组与终端验证结果（TVR）中的位相对应的位 组成 IAC－拒绝位设置为“1”反映了交易被脱机拒绝的终端验证结果条件 IAC－联机位设置为“1”代表需要联机授权条件 IAC－缺省位设置为“1”是当联机处理不可行时脱机拒绝所需的条件 终端行为代码(TAC)&nbsp; TAC有三个数据元，它们都是由一系列的位组成的，这些位对应于TVR中的数据位。终端行为代码来自emv参数下载交易。 TAC－拒绝&nbsp;收单行设置的能够导致交易脱机拒绝的TVR条件位 TAC－联机&nbsp;收单行设置的能够导致交易联机的TVR条件位 TAC－缺省 收单行设置的在交易联机无法进行的情况下能够导致脱机拒绝的TVR条件位 这6个代码的查看方法和TVR查看方式一样，使用时也是配合TVR进行使用。 2.终端是如何判断其行为的？ 检查过程完全由终端利用先前从卡片获取的IAC数据和终端保存的TAC数据进行，无需与其它设备进行交互处理。 在处理过程中，终端比较IAC和TAC中与终端验证结果（TVR）对应的位。如果TVR和IAC或TAC中相应的位都被设置为“1”，则采纳对应的IAC或TAC。示例如下： 终端的处理步骤如下： 步骤 1：终端比较 IAC－拒绝和 TVR。如果不存在 IAC－拒绝，则采用缺省值‘0000000000’。如果IAC－拒绝和 TVR 的任何对应位同时设为‘1’，终端必须： ——&nbsp;&nbsp;把授权响应码置为‘Z1’(脱机拒绝)； ——&nbsp;&nbsp;把 GENERATE AC（产生应用密文）命令的 P1参数设为请求应用认证密文（AAC）； ——&nbsp;&nbsp;进行请求应用密文步骤。 步骤 2：终端对 TAC－拒绝和 TVR进行类似的比较。如果不存在 TAC－拒绝，则采用缺省值‘0000000000’。如果 TAC－拒绝和 TVR的任何对应位同时设为‘1’，终端必须采取与 IAC－拒绝相同的处理。 步骤 3：如果终端具有联机处理能力（仅联机的终端除外），则它应该使用 IAC－联机和TAC－联机与TVR比较。如果 IAC－联机不存在，则使用缺省值‘FFFFFFFFFF’，如果 TAC－联机不存在，则使用缺省值‘0000000000’。如果 IAC－联机和 TVR的任何对应位同时置为‘1’，则终端： ——&nbsp;把产生应用密文（GENERATE AC）命令的 P1参数设为授权请求密文（ARQC），以进行联机授权请求； ——&nbsp;进行生成应用密文步骤。 对于仅联机的终端，如果在步骤 1和步骤 2中未决定脱机拒绝，则终端不必进行 IAC－联机和 TAC－联机与 TVR的比较，而直接按照 IAC－联机或 TAC－联机和 TVR的任何对应位同时置为‘1’的情况来处理，通过请求联机来继续进行交易。 步骤 4：如果终端是仅脱机终端或者当有联机处理能力的终端出于某种原因不能联机时，则使用 IAC——缺省和 TAC——缺省与 TVR 比较。如果没有 IAC－缺省，则使用缺省值‘FFFFFFFFFF’，如果 TAC——缺省不存在，则使用缺省值‘0000000000’。如果比较结果的任何对应位同时为‘1’，则终端： ——&nbsp;把授权响应码置为‘Z3’（不能联机，脱机拒绝），仅脱机终端授权响应码置为‘Z1’； ——&nbsp;把产生应用密文（GENERATE AC）命令的的 P1参数设置为请求 AAC； ——&nbsp;进行生成应用密文步骤。 对于仅联机的终端，当无法进行联机时，它可以选择正常的处理TAC/IAC－缺省，也可以选择跳过TAC/IAC——缺省的处理。对于跳过TAC/IAC——缺省处理的终端应该直接按照TAC/IAC——缺省与TVR匹配进行处理，并且在第2个GENERATE AC请求AAC。对于正常处理TAC/IAC——缺省的终端，应该根据TAC/IAC——缺省与TVR匹配的结果生成应用密文，这时仅联机的终端可能脱机完成交易。 步骤 5：如果在以上的比较中没有出现对应位同时为‘1’的情况，则终端： ——&nbsp;把授权响应码置为‘Y1’（脱机批准）； ——&nbsp;把 GENERATE AC（请求应用密文）命令的 P1参数设置为请求交易证书（TC）； ——&nbsp;进行请求应用密文步骤。 这里的GENERATE AC就是我们所说的第一次GAC，如果脱机批准了，获取到的TC值需要在上送交易明细时上送到后台。如果卡片返回ARQC，那么在联机交易结束后，还需要再做第二次GAC，这个内容后续再讨论。 &nbsp; 联机处理&amp;&amp;交易结束 1.联机交易处理流程 第一步： 处理ARPC（如果不包含，则跳过；如果包含并且AIP特性标志不支持发卡行认证，则跳过） 收到联机返回报文后，获取tag“91”，即ARPC，通过外部认证指令将ARPC发给卡片，如果卡片响应9000，说明ARPC校验通过，否则发起冲正。 第二步： 处理发卡行脚本 再看tag72（或71，在圈存交易时，不允许出现两个脚本），这个是发卡行返回脚本采用tag72作为标签，72后面还是一个TLV，解析tag86（发卡行脚本命令），获取到。再通过指令将这个命令给到卡片，整个数据就是一个指令，不需要再添加内容 第三步： 第二次GAC，第一次GAC发送GAC指令时组织数据采用的是CDOL1，第二次GAC组织命令时用的是CDOL2，CDOL2也是在读记录时候获取到的。 2.假如卡片请求ARQC。但终端执行联机交易失败怎么办？ 卡片请求ARQC，但是终端无法联机，并不是代表这个交易终止了，终端和卡片还有最后一次尝试，就是所谓的脱机转联机，联机失败再转脱机。 这就好像买东西一样，先去第一家店看了看，觉得东西还行，但是先不买，然后再去第二家店，结果发现第二家店的东西又贵又不好，那再回去第一家店看看，价格能不能商量一下，如果能谈妥，OK，那么就交易。 这个时候首先又需要检查IAC-缺省和TAC缺省执行终端行为分析（这部分在之前终端行为分析中有表详细的描述），并且根绝结果发送第二次GAC指令。 如果第二次GAC指令能够成功返回TC，那么脱机交易批准，如果返回ACC，则交易拒绝，，这个时候不可能再返回ARQC了。 如果脱机成功则响应码为Y3，但是，如果终端在第一次GAC就获取TC批准脱机交易的话，响应码是Y1，所以通过Y1和Y3就可以知道是哪一种脱机批准。 到此为止，整个借贷记交易和电子现金的交易就已经全部处理完了。 &nbsp; &nbsp; QPBOC和借记贷记对比 1.QPBOC和EMV在PDOL中有什么区别？ 非接中的GPO对于PDOL的要求是必须含有9F66（借贷记的GPO是可以支持没有PDOL的，终端在GPO只要发送8300就行），如果没有，终端直接拒绝交易。 2.QPBOC的持卡人认证 QPBOC的持卡人认证和借贷记电子现金不同，QPBOC的持卡人认证结果只有2种情况：签名，联机。通过判断卡片交易属性（9F6C）和终端交易属性（9F66）来判断采用哪种持卡人验证方式。 3.QPBOC的处理限制与借贷记流程的有什么区别？ QPBOC的处理限制只做一件事，就是判断卡有效期，相当于借贷记流程中的一个小步骤。 4.QPBOC的脱机数据认证与借贷记流程的有什么区别？ 因为卡片不会再和终端有指令交互，所以数据认证使用的QPBOC自己定义的一种FDDA。FDDA的执行同样需要根据AIP的情况作出判断。FDDA签名的动态数据通过9F4B在读记录时返回，借贷记是通过内部认证获取到的。这个动态数据的获得，也是区分FDDA版本为01还是00.所以缺少了DDA的内部认证指令，所以叫做FDDA。而用来参于组织签名数据的是通过一个固定数据域组织的，借贷记是通过DDOL获取的。 特别说明:PB0C3.新增了一个9F69的标签，需要在版本01的FDDA中加入到签名数据域。 &nbsp; 交易限额 终端最低限额（9F1B）、终端电子现金交易限额（9F7B）、非解最低限额（DF19）、非解交易限额（DF20）、CVM限额（DF21） 9F1B，就是所谓的Floorlimt，这个参数主要用在终端风险管理终端中的第一个步骤-------最低限额检查。 9F7B，当交易金额小于9F7B的时候，终端可以执行电子现金脱机交易。 特别说明：我一直觉得这个限额只应该对接触式电子现金交易有效，但是现在不管是客户还是同事，很多人都认为这个限额应该对Qpboc也要做判断。虽然目前代码是这么做的，但是我还是觉得这个限额应该只是对电子现金有效。 DF19、DF20、DF21三个TAG值都是连续的限额，就是针对于QPBOC的三个限额，这三个限额主要是在QPBOC预处理阶段进行判断。 DF19，交易金额必须大于DF19，才允许做非解交易。 DF20，交易金额不能大于DF20，否则交易拒绝，提示持卡人采用别的方式交易。 DF21，超过该限额，终端应该在交易属性9F66中置位“要求CVM”，进而在GPO的时候告诉卡片终端需要CVM。但是这个值实际有什么意义也不清楚。Q的持卡人验证只有签名和联机两种方式，卡片返回的9F6C再加上终端交易属性已经可以决定持卡人验证方式了。CVM在这个时候确实没啥用了。 还有一个额度不得不提，就是卡片余额，当交易金额大于卡片余额，但是不满足上面任何一种拒绝交易的情况时，终端会选择脱机转联机交易。 当然了，如果交易金额没有超过卡片余额，但是却大于上述的DF20，终端就直接拒绝交易。 &nbsp; &nbsp; ﻿﻿ ﻿﻿ 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/12/12/ec92b3925dd39799b2a60bc41d774c56.html","headline":"EMV学习过程中问题解决及汇总","dateModified":"2017-12-12T00:00:00+08:00","datePublished":"2017-12-12T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/12/12/ec92b3925dd39799b2a60bc41d774c56.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>EMV学习过程中问题解决及汇总</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div>
   ﻿﻿
  </div> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:15pt">应用选择：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="font-family:'宋体'">1.</span><span lang="en-us" style="font-family:'宋体'; color:#ff0000"></span><span lang="en-us" style="font-family:'宋体'; color:#000000">ADF</span></span><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">、<span lang="en-us">DDF</span></span><span style="font-size:14px">、</span><span lang="en-us"><span style="font-size:14px">AEF</span></span><span style="font-size:14px">、</span><span lang="en-us"><span style="font-size:14px">EF</span></span><span style="font-size:14px">、</span><span lang="en-us"><span style="font-size:14px">DF</span></span><span style="font-size:14px">有什么区别</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">、</span><span style="font-family:Calibri"><span lang="en-us">DDF</span></span><span style="font-family:'宋体'">、</span><span style="font-family:Calibri"><span lang="en-us">AEF</span></span><span style="font-family:'宋体'">就是</span><span style="font-family:Calibri"><span lang="en-us">PBOC</span></span><span style="font-family:'宋体'">规范里面的名词了，</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDF</span></span><span style="font-family:'宋体'">其实就是</span><span style="font-family:Calibri"><span lang="en-us">DF</span></span><span style="font-family:'宋体'">的一个映射，</span><span style="font-family:Calibri"><span lang="en-us">AEF</span></span><span style="font-family:'宋体'">就是</span><span style="font-family:Calibri"><span lang="en-us">EF</span></span><span style="font-family:'宋体'">的映射，我们不能直接操作</span><span style="font-family:Calibri"><span lang="en-us">DF</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">EF</span></span><span style="font-family:'宋体'">，只能操作</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDF</span></span><span style="font-family:'宋体'">以及</span><span style="font-family:Calibri"><span lang="en-us">AEF</span></span><span style="font-family:'宋体'">，就相当于内存管理里面物理地址和虚拟地址一样，程序不能直接使用物理地址，只能使用虚拟地址，而内存管理的单元回去实现虚拟地址到物理地址的映射。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">2.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#ff0000; font-size:12pt"></span><span style="font-size:14px"><span style="font-family:'宋体'">既然</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDF</span></span><span style="font-family:'宋体'">都是</span><span style="font-family:Calibri"><span lang="en-us">DF</span></span><span style="font-family:'宋体'">的映射，那他们两个有啥区别呢？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">DDF</span></span><span style="font-family:'宋体'">还是一个目录，这个目录下面可能有</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">，也可能还是有</span><span style="font-family:Calibri"><span lang="en-us">DDF</span></span><span style="font-family:'宋体'">的。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">也是一个目录，但是这个目录已经是</span><span style="font-family:Calibri"><span lang="en-us">aid</span></span><span style="font-family:'宋体'">的目录了，这个目录的名称就是</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">再根据</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">名称去选择</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">，</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">下面都是</span><span style="font-family:Calibri"><span lang="en-us">AEF</span></span><span style="font-family:'宋体'">，也就是这个</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">多对应的有用数据文件，终端在</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">时候根据返回的</span><span style="font-family:Calibri"><span lang="en-us">AFL</span></span><span style="font-family:'宋体'">，再去读取对应的文件。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">3.</span></span><span style="font-family:'宋体'">目录选择法在选择完</span><span style="font-family:Calibri"><span lang="en-us">PSE</span></span><span style="font-family:'宋体'">后是如何获得</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">的</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">选择完</span><span style="font-family:Calibri"><span lang="en-us">PSE</span></span><span style="font-family:'宋体'">之后，</span><span style="font-family:Calibri"><span lang="en-us">PSE</span></span><span style="font-family:'宋体'">目录会返回</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">（</span><span style="font-family:Calibri"><span lang="en-us">tag 88</span></span><span style="font-family:'宋体'">），然后终端根据</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">，再执行</span><span style="font-family:Calibri"><span lang="en-us">READ RECORD</span></span><span style="font-family:'宋体'">命令读取记录，读记录根据</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">循环读取，直到卡片返回</span><span style="font-family:Calibri"><span lang="en-us">6A83</span></span><span style="font-family:'宋体'">为止，这个时候终端已经获取到卡片支持的</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">（</span><span style="font-family:Calibri"><span lang="en-us">tag 4F</span></span><span style="font-family:'宋体'">）。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">4.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:13.5pt"></span><span style="font-family:'宋体'"><span style="font-size:14px">当卡片和终端有多个应用支持时，终端是根据什么判断是否需要持卡人选择应用的</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">根据应用优先级指示器的</span><span style="font-family:Calibri"><span lang="en-us">bit8</span></span><span style="font-family:'宋体'">来判断是否需要提示持卡人选择应用。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">5.</span></span><span style="font-family:'宋体'">选择应用时如果在未读到记录之前或者读记录后检查数据非法等情况怎么办？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">如果遇到上述情况，则均可认为是目录选择法失败，这时候就需要改用</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">选择法。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">6.Qpboc</span></span><span style="font-family:'宋体'">和借贷记应用的在选择应用部分的区别</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">选择的是</span><span style="font-family:Calibri"><span lang="en-us">PPSE</span></span><span style="font-family:'宋体'">，借贷记选择的是</span><span style="font-family:Calibri"><span lang="en-us">PSE</span></span><span style="font-family:'宋体'">；</span><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">不支持持卡人选择应用和</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">列表选择法，</span><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">的流程相对精简。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">在选择完</span><span style="font-family:Calibri"><span lang="en-us">PPSE</span></span><span style="font-family:'宋体'">之后已经可以获取到</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">（可能是多个）、应用优先级、应用指示器，</span><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">不支持持卡人选择应用，所以如果有多个</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">的时候，需要根据应用优先级选择优先级最高的</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">，再根据</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">选择</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">，就可以获取到</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">（关键数据）、发行卡代码等数据。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">借贷记需要根据选择</span><span style="font-family:Calibri"><span lang="en-us">PSE</span></span><span style="font-family:'宋体'">返回的</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">读记录获取</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">，再根据</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">去选择</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">，再去读数据；</span><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">在选择</span><span style="font-family:Calibri"><span lang="en-us">PPSE</span></span><span style="font-family:'宋体'">之后就可以获取到</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">，直接选择</span><span style="font-family:Calibri"><span lang="en-us">ADF</span></span><span style="font-family:'宋体'">了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:15pt">应用初始化</span><span lang="en-us" style="font-size:15pt"><span style="font-family:Calibri">&amp;&amp;</span></span><span style="font-family:'宋体'; font-size:15pt">读应用数据</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1.GPO</span></span><span style="font-family:'宋体'">命令是怎么组的？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">应用选择完成后，终端获取到了</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">数据，</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">根据</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">中的</span><span style="font-family:Calibri"><span lang="en-us">TAG</span></span><span style="font-family:'宋体'">组数据域传送给卡片</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">2.</span></span><span style="font-family:'宋体'">终端一定会有</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">吗，没有</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">哪些交易不能进行？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">卡片可以不给终端提供</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">，如果终端没有获取到</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">，则</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">数据域直接传递</span><span style="font-family:Calibri"><span lang="en-us">8300</span></span><span style="font-family:'宋体'">，如果卡片不提供</span><span style="font-family:Calibri"><span lang="en-us">PDOL</span></span><span style="font-family:'宋体'">的话，后续这张卡是不能做电子现金和</span><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">的交易</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">3.GPO</span></span><span style="font-family:'宋体'">命令后的读记录命令是根据什么读的，怎么知道哪些记录用于数据认证</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">读记录命令是根据</span><span style="font-family:Calibri"><span lang="en-us">AFL</span></span><span style="font-family:'宋体'">读的，其包含终端将要读取用来交易处理的卡片数据文件的</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">和记录范围。每个要读取的文件在</span><span style="font-family:Calibri"><span lang="en-us">AFL</span></span><span style="font-family:'宋体'">中对应四个字节，含义如下：</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">字节</span><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">：短文件标识符</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">字节</span><span style="font-family:Calibri"><span lang="en-us">2</span></span><span style="font-family:'宋体'">：文件中要读取的第</span><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">个记录的记录号</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">字节</span><span style="font-family:Calibri"><span lang="en-us">3</span></span><span style="font-family:'宋体'">：文件中要读取的最后一个记录的记录号</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">字节</span><span style="font-family:Calibri"><span lang="en-us">4</span></span><span style="font-family:'宋体'">：从第</span><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">个记录开始的用于脱机数据认证的连续记录数</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">4.</span></span><span style="font-family:'宋体'">根据什么知道终端要执行哪些过程？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">后续的过程根据终端性能和卡片的支持能力决定哪些步骤要执行，支持哪种数据认证，是否支持持卡人认证，是否支持发卡行认证等，但风险管理是强制执行的不依据</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">里的值</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">5.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:13.5pt"></span><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">QPBOC</span></span><span style="font-family:'宋体'">联机和</span><span style="font-family:Calibri"><span lang="en-us">QPBOC</span></span><span style="font-family:'宋体'">脱机的</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">响应数据有比较大的区别？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">qPBOC</span></span><span style="font-family:'宋体'">联机交易或拒绝交易的</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">响应数据中是不返回</span><span style="font-family:Calibri"><span lang="en-us">AFL</span></span><span style="font-family:'宋体'">的，而</span><span style="font-family:Calibri"><span lang="en-us">QPBOC</span></span><span style="font-family:'宋体'">脱机的</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">响应数据中返回</span><span lang="en-us"><span style="font-family:Calibri">AFL</span></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">6.</span></span><span style="font-family:'宋体'">如何判断非接中到底是走</span><span style="font-family:Calibri"><span lang="en-us">QPBOC</span></span><span style="font-family:'宋体'">流程还是走非接触借贷记流程？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">——如果卡片响应</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">命令的状态字为“</span><span style="font-family:Calibri"><span lang="en-us">9000</span></span><span style="font-family:'宋体'">”，假设终端仅支持一种非接触选项（</span><span style="font-family:Calibri"><span lang="en-us">qPBOC</span></span><span style="font-family:'宋体'">或非接触式借记</span><span style="font-family:Calibri"><span lang="en-us">/</span></span><span style="font-family:'宋体'">贷记应用），则终端应按此选项继续处理，不必判断</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">；</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">——如果卡片响应</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">命令的状态字为“</span><span style="font-family:Calibri"><span lang="en-us">9000</span></span><span style="font-family:'宋体'">”，并且</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">第</span><span style="font-family:Calibri"><span lang="en-us">2</span></span><span style="font-family:'宋体'">字节第</span><span style="font-family:Calibri"><span lang="en-us">8</span></span><span style="font-family:'宋体'">位置‘</span><span style="font-family:Calibri"><span lang="en-us">0</span></span><span style="font-family:'宋体'">’，假设终端支持</span><span style="font-family:Calibri"><span lang="en-us">qPBOC</span></span><span style="font-family:'宋体'">，并且应用密文（标签“</span><span style="font-family:Calibri"><span lang="en-us">9F26</span></span><span style="font-family:'宋体'">”）在</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">命令响应中出现，则终端应按照</span><span style="font-family:Calibri"><span lang="en-us">qPBOC</span></span><span style="font-family:'宋体'">处理交易。如果标签为“</span><span style="font-family:Calibri"><span lang="en-us">9F26</span></span><span style="font-family:'宋体'">”的数据项不出现，则终端应按照非接触式借记</span><span style="font-family:Calibri"><span lang="en-us">/</span></span><span style="font-family:'宋体'">贷记应用处理交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">7.QPBOC</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">数据返回数据量为什么比较大？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">为了提高交互速度，减少终端与卡片交互次数，为此提高了单次交互的数据量，所以</span><span style="font-family:Calibri"><span lang="en-us">Q</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">返回的数据量比较大，除了</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">AFL</span></span><span style="font-family:'宋体'">之外，还有应用密文，交易计数器，发卡行应用数据，二磁道数据等多个数据。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">8.SFI</span></span><span style="font-family:'宋体'">文件范围</span><span style="font-family:Calibri"><span lang="en-us">1-10,11-20,21-30</span></span><span style="font-family:'宋体'">的区别？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">－</span><span style="font-family:Calibri"><span lang="en-us">10</span></span><span style="font-family:'宋体'">：</span><span style="font-family:Calibri"><span lang="en-us">EMV</span></span><span style="font-family:'宋体'">数据文件；</span></span><span style="font-family:Calibri; font-size:14px"></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">11</span></span><span style="font-family:'宋体'">－</span><span style="font-family:Calibri"><span lang="en-us">20</span></span><span style="font-family:'宋体'">：支付系统数据文件；</span></span><span style="font-family:Calibri; font-size:14px"></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">21</span></span><span style="font-family:'宋体'">－</span><span style="font-family:Calibri"><span lang="en-us">30</span></span><span style="font-family:'宋体'">：发卡行数据文件；<span style="font-size:14px"><span style="font-family:'宋体'"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;<span style="font-family:'宋体'"></span></span></span></span></span></span></span></p> 
  <span style="font-size:14px"><span style="font-family:'宋体'"><span lang="en-us"><span style="font-family:Calibri; font-size:14px"></span></span></span></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">9.</span><span style="font-family:'宋体'">在读应用数据中</span><span lang="en-us">,</span><span style="font-family:'宋体'">终端出现哪几种情况会终止交易</span><span lang="en-us">?</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">(1)</span><span style="font-family:'宋体'">卡片在一条或多条记录中返回同一个标签两次及两次以上；</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">(2)</span><span style="font-family:'宋体'">卡片在某条记录中返回了卡片已经在</span><span lang="en-us">GPO</span><span style="font-family:'宋体'">响应中返回的标签；</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">(3)</span><span style="font-family:'宋体'">卡片中缺少必须有的数据；</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">(4)</span><span style="font-family:'宋体'">数据格式错；</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">(5)READ RECORD </span> <span style="font-family:'宋体'">命令返回状态字不是“</span><span lang="en-us">9000“</span><span style="font-family:'宋体'">。</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"></p> 
  <p style="margin:0cm 0cm 0pt"></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:15pt">脱机数据认证：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1.</span></span><span style="font-family:'宋体'">终端根据什么来决定执行哪种脱机数据认证方式？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">取决于两个要素</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">和终端性能。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">2.</span></span><span style="font-family:'宋体'">应用开发工程师在分析</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡交易失败的时候要看什么做判断？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">交易没走步都要首先分析</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">和终端性能的各个位的情况，而交易每执行完一步都要对</span><span style="font-family:Calibri"><span lang="en-us">TVR</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">TSI</span></span><span style="font-family:'宋体'">进行置位或者清零。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">在分析</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡失败交易的第一步应该是看</span><span style="font-family:Calibri"><span lang="en-us">TVR</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">TSI</span></span><span style="font-family:'宋体'">，看看终端做过什么，终端哪一步失败了，然后在分析某个步骤失败的原因。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">3.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:13.5pt"></span><span style="font-size:14px"><span style="font-family:'宋体'">对于参与脱机数据认证的</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">有明确分类，分为</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">从</span><span style="font-family:Calibri"><span lang="en-us">1-10</span></span><span style="font-family:'宋体'">以及</span><span style="font-family:Calibri"><span lang="en-us">11-30</span></span><span style="font-family:'宋体'">两类，这两类在参与认证上有什么区别？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1-10</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">在参与脱机数据认证的时候，其文件标志“</span><span style="font-family:Calibri"><span lang="en-us">70</span></span><span style="font-family:'宋体'">”和记录长度不参与脱机数据认证，而</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">为</span><span style="font-family:Calibri"><span lang="en-us">11-30</span></span><span style="font-family:'宋体'">的，则</span><span style="font-family:Calibri"><span lang="en-us">70</span></span><span style="font-family:'宋体'">和记录长度也要参与脱机数据认证。</span></span><span lang="en-us"><br> <span style="font-family:Calibri; font-size:14px">4.</span></span><span style="font-size:14px"><span style="font-family:'宋体'">静态数据认证</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">是如何认证的？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">三步走：一步获取认证中心公钥，二步恢复发卡行公钥，三步进行数据认证</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">一步获取认证中心公钥：首先通过公钥下载将服务端的公钥挨个下载到终端，在获取认证中心公钥的时候要做两个判一个判断是选择</span><span style="font-family:Calibri"><span lang="en-us">AID</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">5</span></span><span style="font-family:'宋体'">个字节为</span><span style="font-family:Calibri"><span lang="en-us">RID</span></span><span style="font-family:'宋体'">，另一个判断是需要用到度记录时获取到的发卡行公钥索引（</span><span style="font-family:Calibri"><span lang="en-us">8F</span></span><span style="font-family:'宋体'">），通过</span><span style="font-family:Calibri"><span lang="en-us">RID</span></span><span style="font-family:'宋体'">和索引可以选择到唯一的一组公钥，选择完成后，获取中心公钥即成功</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">二步恢复发卡行公钥：首先读记录的时候已经获取到发卡行</span><span style="font-family:Calibri"><span lang="en-us">90</span></span><span style="font-family:'宋体'">（签名处理过的发卡行公钥，</span><span style="font-family:Calibri"><span lang="en-us">92</span></span><span style="font-family:'宋体'">（发卡行公钥余项），</span><span style="font-family:Calibri"><span lang="en-us">9F32</span></span><span style="font-family:'宋体'">（发卡行公钥指数），所以这个时候可以用</span><span style="font-family:Calibri"><span lang="en-us">CA</span></span><span style="font-family:'宋体'">公钥利用</span><span style="font-family:Calibri"><span lang="en-us">RSA</span></span><span style="font-family:'宋体'">算法对</span><span style="font-family:Calibri"><span lang="en-us">90</span></span><span style="font-family:'宋体'">的数据解密。解密后的数据为一个比较复杂的数据格式，需要对数据的头尾，以及中间数据做判断，其中对后续才做有用的数据是“哈希值”，执行完这一步，终端已经获取到了卡片计算出的哈希值，执行完这一步，终端已经获取到了卡片计算出的哈希值，卡片计算哈希值的方法和终端的一样，故只要知道这里获取到了发卡行公钥或者发卡行公钥最左边的部分以及获取到了哈希值就</span><span style="font-family:Calibri"><span lang="en-us">OK</span></span><span style="font-family:'宋体'">了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">卡片已经返回了哈希值，终端自然也要计算一个哈希值，计算方法：</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">首先组织一长串数据，格式：证书格式</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">发卡行标识</span><span style="font-family:Calibri"><span lang="en-us">(</span></span><span style="font-family:'宋体'">主账号最左面的</span><span style="font-family:Calibri"><span lang="en-us">3 -8</span></span><span style="font-family:'宋体'">个数字</span><span style="font-family:Calibri"><span lang="en-us">) +</span></span><span style="font-family:'宋体'">证书失效日期</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">证书序列号</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">哈希算法标识</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">发卡行公钥算法标识</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">发卡行公钥长度</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">发卡行公钥指数长度</span><span style="font-family:Calibri"><span lang="en-us"> +</span></span><span style="font-family:'宋体'">发卡行公钥模数的完整数据</span><span style="font-family:Calibri"><span lang="en-us"> 128</span></span><span style="font-family:'宋体'">个字节</span><span style="font-family:Calibri"><span lang="en-us">+</span></span><span style="font-family:'宋体'">发卡行公钥指数</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:7.5pt">特别说明：发卡行公钥模数的完整数据一部分是在还原发行卡公钥数据过程中获取的，还有另外一部分是在卡片读记录的时候通过</span><span lang="en-us" style="font-size:7.5pt"><span style="font-family:Calibri">92tag</span></span><span style="font-family:'宋体'; font-size:7.5pt">获取到的。除此之外，其他数据都为卡片返回原始数据，或者是一些固定写死的值</span><span style="font-family:'宋体'"><span style="font-size:14px">。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">然后用组好的数据进行哈希值计算，计算出的哈希值和我们在恢复发卡行公钥中获取到的哈希值一样，至此恢复发卡行公钥的步骤已完成，其中任何一步失败都会认为是静态数据认证失败。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">第三步验证签名数据：用发卡行公钥来恢复签名的静态数据（过程与第二步雷同），恢复中有一部分是终端用来计算哈希值（将表</span><span style="font-family:Calibri"><span lang="en-us">5</span></span><span style="font-family:'宋体'">中的第二个到第五个数据元素（即从签名数据格式直到填充字节）从左到右连接，再把本规范第三册的第</span><span style="font-family:Calibri"><span lang="en-us">II</span></span><span style="font-family:'宋体'">部分中指明的需认证的静态数据加在后面。如果静态数据认证标签列表存在，并且其包含非‘</span><span style="font-family:Calibri"><span lang="en-us">82</span></span><span style="font-family:'宋体'">’的标签，那么静态数据认证失败），组织签名数据首先按照之前描述的</span><span style="font-family:Calibri"><span lang="en-us">sfi</span></span><span style="font-family:'宋体'">的规则获取脱机认证数据，还有个特别的地方，如果存在</span><span style="font-family:Calibri"><span lang="en-us">9F4A</span></span><span style="font-family:'宋体'">的话，需要将</span><span style="font-family:Calibri"><span lang="en-us">AIP</span></span><span style="font-family:'宋体'">作为签名数据</span><span style="font-family:Calibri"><span lang="en-us">,</span></span><span style="font-family:'宋体'">不需要包含</span><span style="font-family:Calibri"><span lang="en-us">tag</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">L</span></span><span style="font-family:'宋体'">，只要</span><span style="font-family:Calibri"><span lang="en-us">V</span></span><span style="font-family:'宋体'">就可以。最后对组织好的数据，进行</span><span style="font-family:Calibri"><span lang="en-us">sha1</span></span><span style="font-family:'宋体'">运算，获得</span><span style="font-family:Calibri"><span lang="en-us">hash</span></span><span style="font-family:'宋体'">值，然后和恢复签名数据时获取的哈希值比较，如果相等则</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">成功，然后将计算出的</span><span style="font-family:Calibri"><span lang="en-us">hash</span></span><span style="font-family:'宋体'">保存在</span><span style="font-family:Calibri"><span lang="en-us">9F45</span></span><span style="font-family:'宋体'">的标签中。</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">流程就算是结束了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">5.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#ff0000; font-size:9pt"></span><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">9F4A</span></span><span style="font-family:'宋体'">静态数据认证标签列表只存在在静态数据认证过程中吗？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">不是，</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">中都存在这个要素。</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">中主要用这个来做发卡行公钥恢复和</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥恢复，所以这个标签的作用主要是用来组建一组静态数据用于脱机数据认证。切不要以为因为它的名字叫做“静态数据认证标签列表”而忽略了在</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">中的应用。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">6.</span></span><span style="font-family:'宋体'">动态数据认证</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">是如何认证的？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">首先需要恢复出发卡行公钥，这个和</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">的步骤一样，就不讨论了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">恢复出发卡行公钥后，</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">中还需要恢复</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥，这个步骤中，和恢复发卡行公钥类似，</span></span><span style="font-family:Calibri; font-size:14px"></span><span style="font-size:14px"><span style="font-family:'宋体'">恢复出</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥以后也需要利用恢复后得到的数据再加上用于脱机数据认证的数据（</span><span style="font-family:Calibri"><span lang="en-us">SFI</span></span><span style="font-family:'宋体'">那边获得的）进行</span><span style="font-family:Calibri"><span lang="en-us">HASH</span></span><span style="font-family:'宋体'">值的计算，计算结果与恢复出的结果一致，则恢复出的</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥合法可用。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">前面的内容</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">大同小异，没什么差别，但是</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">从恢复完</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥后和</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">就有很大区别了，下面我们一步一步讨论。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">第一步，动态签名的生成</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">读记录的时候，需要一个关键数据</span><span style="font-family:Calibri"><span lang="en-us">DDOL</span></span><span style="font-family:'宋体'">（</span><span style="font-family:Calibri"><span lang="en-us">9F49</span></span><span style="font-family:'宋体'">），这个数据是卡片告诉终端（如果卡片没有返回，终端也需要有默认值，如果都没有则交易终止；如果</span><span style="font-family:Calibri"><span lang="en-us">DDOL</span></span><span style="font-family:'宋体'">中不含有</span><span style="font-family:Calibri"><span lang="en-us">9F37</span></span><span style="font-family:'宋体'">不可预知数，则交易终止）卡片需要终端的哪些数据来做动态签名。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">终端组织好</span><span style="font-family:Calibri"><span lang="en-us">DDOL</span></span><span style="font-family:'宋体'">的数据之后，通过内部认证命令将数据提供给卡片，卡片会返回签名后的动态数据。卡片返回的数据时签名后的动态认证数据（</span><span style="font-family:Calibri"><span lang="en-us">tag</span></span><span style="font-family:'宋体'">为</span><span style="font-family:Calibri"><span lang="en-us">80</span></span><span style="font-family:'宋体'">时和</span><span style="font-family:Calibri"><span lang="en-us">tag</span></span><span style="font-family:'宋体'">为</span><span style="font-family:Calibri"><span lang="en-us">77</span></span><span style="font-family:'宋体'">时不一样的处理，与</span><span style="font-family:Calibri"><span lang="en-us">GPO</span></span><span style="font-family:'宋体'">是返回数据的处理类似），需要终端再利用</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥进行还原。还原后的数据中会有</span><span style="font-family:Calibri"><span lang="en-us">HASH</span></span><span style="font-family:'宋体'">。然后终端利用还原后得到的数据，再加上</span><span style="font-family:Calibri"><span lang="en-us">DDOL</span></span><span style="font-family:'宋体'">构成一个规范要求的数据串，然后在做</span><span style="font-family:Calibri"><span lang="en-us">SHA1</span></span><span style="font-family:'宋体'">运算获得</span><span style="font-family:Calibri"><span lang="en-us">HASH</span></span><span style="font-family:'宋体'">值，对比卡片返回的</span><span style="font-family:Calibri"><span lang="en-us">hash</span></span><span style="font-family:'宋体'">值和终端计算的是否一致，如果一致，证明</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">成功，再将</span><span style="font-family:Calibri"><span lang="en-us">HASH</span></span><span style="font-family:'宋体'">值保存到</span><span style="font-family:Calibri"><span lang="en-us">9F4C</span></span><span style="font-family:'宋体'">，则</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">已经结束了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">从分析来看，</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">其实是包含了</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">的过程，并且有了内部认证的处理，使得其安全性大于</span><span style="font-family:Calibri"><span lang="en-us">SDA</span></span><span style="font-family:'宋体'">，所以现在目前国内发行的卡基本上都是采用</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">作为脱机数据认证方式。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">7.CDA</span></span><span style="font-family:'宋体'">认证</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">之前脱机数据认证，包括后面的</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">都忽略了</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">的存在，现在专门讨论一下</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">先从脱机数据认证开始，第一次遇到</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">的前面三个步骤（获取</span><span style="font-family:Calibri"><span lang="en-us">ca</span></span><span style="font-family:'宋体'">公钥、恢复发卡行公钥、恢复</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥）和</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">一样，</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">是通过内部认证指令获取签名动态数据，</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">是通过</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令来获取的。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">终端行为分析过程中正好有一次</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">，所以采用脱机数据认证的时候，前面只完成还原</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡公钥就行了，</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">后续的部分放在终端行为分析</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">之后。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">但是</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">和请求应用密文的</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令不一样，控制参数不一样，所以请求得到的结果也不一样。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">是用</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令请求，对于</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令请求，返回为格式</span><span style="font-family:Calibri"><span lang="en-us">2</span></span><span style="font-family:'宋体'">，也就是之前提到的</span><span style="font-family:Calibri"><span lang="en-us">77</span></span><span style="font-family:'宋体'">开头的格式，需要解析</span><span style="font-family:Calibri"><span lang="en-us">TLV</span></span><span style="font-family:'宋体'">，解析到</span><span style="font-family:Calibri"><span lang="en-us">9F4B</span></span><span style="font-family:'宋体'">签名动态应用数据。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">这一步完成后，</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">比</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">多了一个步骤，终端首先将将恢复的密文数据和</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">返回的密文数据比较。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">比较完成后终端需要将一些在</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">中返回的数据等一起组织起来，计算</span><span style="font-family:Calibri"><span lang="en-us">hash</span></span><span style="font-family:'宋体'">值，与恢复出的哈希值是否一致进行比较，如果一致则认为</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">到目前为止还是成功的。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">然后还需要将</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">恢复数据得到的</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡动态数据在进行处理，</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡动态数据中也有一个</span><span style="font-family:Calibri"><span lang="en-us">hash</span></span><span style="font-family:'宋体'">值，还需要终端再按要求计算一个</span><span style="font-family:Calibri"><span lang="en-us">hash</span></span><span style="font-family:'宋体'">值，然后再和</span></span><span lang="en-us"><span style="font-family:Calibri; font-size:14px">IC</span></span><span style="font-size:14px"><span style="font-family:'宋体'">卡动态数据中的</span><span style="font-family:Calibri"><span lang="en-us">HASH</span></span><span style="font-family:'宋体'">值比较。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">可以看得出是两层数据套在了一起，先解析外层，再解析内层，一层一层还原，最终</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">如果这个时候卡片返回的是</span><span style="font-family:Calibri"><span lang="en-us">TC</span></span><span style="font-family:'宋体'">，那么脱机交易就</span><span style="font-family:Calibri"><span lang="en-us">OK</span></span><span style="font-family:'宋体'">了，如果返回是</span><span style="font-family:Calibri"><span lang="en-us">ARQC</span></span><span style="font-family:'宋体'">的话，就发起联机。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">联机过程忽略不谈，联机处理过程</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">一样，没什么区别。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">如果联机失败，这个时候又要进行卡片行为分析。而且由于第一次</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令要求执行</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">，那么第二次</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令也要执行</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">对比</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">DDA</span></span><span style="font-family:'宋体'">，可以看得出</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">复杂了很多，首先</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">将应用密文也加入到签名数据，其次</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">在响应</span><span style="font-family:Calibri"><span lang="en-us">GAC</span></span><span style="font-family:'宋体'">指令的时候对于密文的数有进行了一次加密封装，进而更加增强了安全性。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">的卡现在太少了，除了专业测试的，其他几乎没有银行发行</span><span style="font-family:Calibri"><span lang="en-us">CDA</span></span><span style="font-family:'宋体'">卡的，所以这块没有办法取到数据，只能通过代码和文档进行理解和分析。<span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;<span style="font-family:'宋体'"></span></span></span></span></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">8.</span><span style="font-family:'宋体'">动态数据认证有哪几种原因？</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">1.DDOL</span><span style="font-family:'宋体'">中不包含随机数（“</span><span lang="en-us">9F37”</span><span style="font-family:'宋体'">）</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">2.</span><span style="font-family:'宋体'">在获取</span><span lang="en-us">CA</span><span style="font-family:'宋体'">公钥，发卡行公钥，</span><span lang="en-us">IC</span><span style="font-family:'宋体'">卡公钥任何一个公钥缺失都会导致失败。</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">3.CA</span><span style="font-family:'宋体'">公钥恢复发卡行公钥过程中恢复出的数据头尾格式和公钥格式和公钥指示符不合法。</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">4.</span><span style="font-family:'宋体'">恢复出的哈希值不等于计算出的哈希值。</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">5.</span><span style="font-family:'宋体'">发卡方</span><span lang="en-us">ID</span><span style="font-family:'宋体'">号不等于</span><span lang="en-us">PAN</span><span style="font-family:'宋体'">的前几位。</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">6.</span><span style="font-family:'宋体'">发卡行公钥证书过期</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">7.</span><span style="font-family:'宋体'">内部认证命令返回状态字不是“</span><span lang="en-us">9000“</span><span style="font-family:'宋体'">。</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">8.</span><span style="font-family:'宋体'">签名动态应用数据和</span><span lang="en-us">IC</span><span style="font-family:'宋体'">卡公钥模长度不一致</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us">&nbsp;</span></p> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"></span></p> 
  <p style="margin:0cm 0cm 0pt"></p> 
  <p style="margin:0cm 0cm 0pt"></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:15pt">处理限制：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1.</span></span><span style="font-family:'宋体'">应用用途控制的作用即及判断</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">卡片会返回一个</span><span style="font-family:Calibri"><span lang="en-us">AUC</span></span><span style="font-family:'宋体'">（</span><span style="font-family:Calibri"><span lang="en-us">9F07</span></span><span style="font-family:'宋体'">），通过判断这个数据域来允许或者拒绝交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">判断的逻辑也很清晰，比如一个</span><span style="font-family:Calibri"><span lang="en-us">pos</span></span><span style="font-family:'宋体'">终端，判断</span><span style="font-family:Calibri"><span lang="en-us">AUC</span></span><span style="font-family:'宋体'">的标志位给出</span><span style="font-family:Calibri"><span lang="en-us">ATM</span></span><span style="font-family:'宋体'">有效，除</span><span style="font-family:Calibri"><span lang="en-us">ATM</span></span><span style="font-family:'宋体'">外的终端无效，那</span><span style="font-family:Calibri"><span lang="en-us">POS</span></span><span style="font-family:'宋体'">终端肯定要拒绝这个交易了。或者就是根据终端的国家代码和卡片的国家代码是否一致来判断为国际交易还是国内交易。</span><span style="font-family:Calibri"><span lang="en-us">AUC</span></span><span style="font-family:'宋体'">的各个位又明确给出了国际交易和国内交易的允许情况，终端根据当前交易的状态，以及这些位来判断交易允许或者拒绝</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">2.</span></span><span style="font-family:'宋体'">应用日期有什么限制？应用过期怎么办？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">应用生效日期要早与当前日期，应用失效日期要晚于当前日期。若应用过期，则在</span><span style="font-family:Calibri"><span lang="en-us">TVR</span></span><span style="font-family:'宋体'">中将相应位设置为</span><span style="font-family:Calibri"><span lang="en-us">‘1‘</span></span><span style="font-family:'宋体'">。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:15pt">持卡人认证：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1.</span></span><span style="font-family:'宋体'">持卡人认证这块</span><span style="font-family:Calibri"><span lang="en-us">EMV</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">PBOC</span></span><span style="font-family:'宋体'">的区别</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">EMV</span></span><span style="font-family:'宋体'">流程和</span><span style="font-family:Calibri"><span lang="en-us">PBOC</span></span><span style="font-family:'宋体'">流程差别在于对于</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">的支持有差异，即</span><span style="font-family:Calibri"><span lang="en-us">EMV</span></span><span style="font-family:'宋体'">支持脱机密文</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">验证，不支持持卡人证件验证，而</span><span style="font-family:Calibri"><span lang="en-us">PBOC</span></span><span style="font-family:'宋体'">不支持脱机密文</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">验证，支持持卡人证件验证。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">2.</span></span><span style="font-family:'宋体'">解释一下</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">，</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">对于验证是怎么处理的</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">一个</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">含</span><span style="font-family:Calibri"><span lang="en-us">2</span></span><span style="font-family:'宋体'">个主要元素：</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">(1)</span></span><span style="font-family:'宋体'">两个金额，</span><span style="font-family:Calibri"><span lang="en-us">X</span></span><span style="font-family:'宋体'">金额和</span><span style="font-family:Calibri"><span lang="en-us">Y</span></span><span style="font-family:'宋体'">金额。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">(2)</span></span><span style="font-family:'宋体'">持卡人验证方法条目（可能含有多个）</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">a.</span></span><span style="font-family:'宋体'">持卡人验证方法，即第</span><span style="font-family:Calibri"><span lang="en-us">9</span></span><span style="font-family:'宋体'">字节的</span><span style="font-family:Calibri"><span lang="en-us">bit7</span></span><span style="font-family:'宋体'">，用来表明持卡人验证失败后的操作。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">b.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:13.5pt"></span><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">.</span></span><span style="font-family:'宋体'">持卡人验证方法类型，即第</span><span style="font-family:Calibri"><span lang="en-us">9</span></span><span style="font-family:'宋体'">字节的</span><span style="font-family:Calibri"><span lang="en-us">bit6--bit1</span></span><span style="font-family:'宋体'">，用来表明采用什么样的方法做持卡人验证。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">c.</span></span><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:13.5pt"></span><span style="font-size:14px"><span style="font-family:'宋体'">持卡人验证方法条件，即第</span><span style="font-family:Calibri"><span lang="en-us">10</span></span><span style="font-family:'宋体'">字节，用来表明在什么情况下做持卡人验证。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">3.</span></span><span style="font-family:'宋体'">结合实例谈谈对</span><span style="font-family:Calibri"><span lang="en-us">cvm</span></span><span style="font-family:'宋体'">的理解</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:'宋体'; font-size:14px"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180119171417078?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTFlYX1dJTg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">这是一个标准的</span><span style="font-family:Calibri"><span lang="en-us">cvm</span></span><span style="font-family:'宋体'">列表，</span><span style="font-family:Calibri"><span lang="en-us">X</span></span><span style="font-family:'宋体'">金额为</span><span style="font-family:Calibri"><span lang="en-us">0</span></span><span style="font-family:'宋体'">，</span><span style="font-family:Calibri"><span lang="en-us">Y</span></span><span style="font-family:'宋体'">金额为</span><span style="font-family:Calibri"><span lang="en-us">0</span></span><span style="font-family:'宋体'">，后续每两个字节表示一个持卡人验证方法条目，</span><span style="font-family:Calibri"><span lang="en-us">5E</span></span><span style="font-family:'宋体'">的二进制位</span><span style="font-family:Calibri"><span lang="en-us">01 011110</span></span><span style="font-family:'宋体'">这表明如果持卡人验证失败则使用后续的</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">，</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">验证方法为签名，</span><span style="font-family:Calibri"><span lang="en-us">03</span></span><span style="font-family:'宋体'">表示“如果终端支持这个</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">”。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">这样估计还是比较抽象，我用语言再描述一下。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">首先</span><span style="font-family:Calibri"><span lang="en-us">5E</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">bit8 bit7</span></span><span style="font-family:'宋体'">为</span><span style="font-family:Calibri"><span lang="en-us">01</span></span><span style="font-family:'宋体'">，这表明如果这个</span><span style="font-family:Calibri"><span lang="en-us">cvm</span></span><span style="font-family:'宋体'">失败，那就要用到后面的</span><span style="font-family:Calibri"><span lang="en-us">1F 00</span></span><span style="font-family:'宋体'">作为持卡人验证方法。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">再看</span><span style="font-family:Calibri"><span lang="en-us">5E</span></span><span style="font-family:'宋体'">的</span><span style="font-family:Calibri"><span lang="en-us">bit6</span></span><span style="font-family:'宋体'">到</span><span style="font-family:Calibri"><span lang="en-us">bit1</span></span><span style="font-family:'宋体'">，这个规范上说的很明确，现在的</span><span style="font-family:Calibri"><span lang="en-us">6</span></span><span style="font-family:'宋体'">个数字就是代表使用签名。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">再看</span><span style="font-family:Calibri"><span lang="en-us">03</span></span><span style="font-family:'宋体'">，</span><span style="font-family:Calibri"><span lang="en-us">03</span></span><span style="font-family:'宋体'">的含义是“如果终端支持这个</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">”，这个怎么理解呢？终端有一个很重要的数据，终端性能，终端性能中明确指出了终端所支持的验证方法，所以</span><span style="font-family:Calibri"><span lang="en-us">03</span></span><span style="font-family:'宋体'">的意思就是如果终端支持持卡人签名验证，那么这个交易就使用签名作为验证方法。当持卡人验证条件为</span><span lang="en-us"><span style="font-family:Calibri">03</span></span></span><span style="font-family:'宋体'"><span style="font-size:14px">时，内核对于终端性能的判断也是直接影响持卡人验证成功与失败的关键要素。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">后面的</span><span style="font-family:Calibri"><span lang="en-us">1F00</span></span><span style="font-family:'宋体'">就不做分析了，分析方法同理。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">程序分析完</span><span style="font-family:Calibri"><span lang="en-us">CVM</span></span><span style="font-family:'宋体'">列表后，再根据分析结果提示持卡人进行操作，然后就相当于持卡人认证已经完成。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">&nbsp;4.</span></span><span style="font-family:'宋体'">脱机</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">加密过程</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">(1)&nbsp;</span></span><span style="font-family:'宋体'">终端把用户输入的明文</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">按照一定的格式补位对齐</span><span style="font-family:Calibri"><span lang="en-us">,&nbsp;</span></span><span style="font-family:'宋体'">然后用</span><span style="font-family:Calibri"><span lang="en-us">get&nbsp;challenge</span></span><span style="font-family:'宋体'">命令从卡片中取一个</span><span style="font-family:Calibri"><span lang="en-us">8</span></span><span style="font-family:'宋体'">字节的随机数</span><span lang="en-us"><span style="font-family:Calibri">.&nbsp;</span></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">(2)&nbsp;</span></span><span style="font-family:'宋体'">终端自己产生一组长度为</span><span style="font-family:Calibri"><span lang="en-us">N-17</span></span><span style="font-family:'宋体'">的随机数</span><span style="font-family:Calibri"><span lang="en-us">(N</span></span><span style="font-family:'宋体'">为</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">加密公钥的长度</span><span style="font-family:Calibri"><span lang="en-us">),&nbsp;</span></span><span style="font-family:'宋体'">然后把补位后的</span><span style="font-family:Calibri"><span lang="en-us">PIN,</span></span><span style="font-family:'宋体'">卡片中取的随机数以及终端产生的随机数拼接在一起</span><span style="font-family:Calibri"><span lang="en-us">,&nbsp;</span></span><span style="font-family:'宋体'">与</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">加密公钥做</span><span style="font-family:Calibri"><span lang="en-us">RSA</span></span><span style="font-family:'宋体'">运算</span><span lang="en-us"><span style="font-family:Calibri">.&nbsp;</span></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">(3)</span></span><span lang="en-us" style="font-family:Consolas; color:#454545; font-size:9pt"></span><span style="font-size:14px"><span style="font-family:'宋体'">把上一步运算的结果通过</span><span style="font-family:Calibri"><span lang="en-us">verify</span></span><span style="font-family:'宋体'">命令发给</span><span style="font-family:Calibri"><span lang="en-us">IC</span></span><span style="font-family:'宋体'">卡</span><span lang="en-us"><span style="font-family:Calibri">.</span></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">(4)&nbsp;</span></span><span style="font-family:'宋体'">卡片用</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">加密私钥解密数据</span><span style="font-family:Calibri"><span lang="en-us">,&nbsp;</span></span><span style="font-family:'宋体'">首先检查解出来的</span><span style="font-family:Calibri"><span lang="en-us">8</span></span><span style="font-family:'宋体'">字节随机数是否与自己产生的一致，然后卡片检查恢复的数据头字节是否有效</span><span style="font-family:Calibri"><span lang="en-us">,&nbsp;</span></span><span style="font-family:'宋体'">最后一步是验证</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">是否合法</span><span style="font-family:Calibri"><span lang="en-us">.&nbsp;</span></span><span style="font-family:'宋体'">只有所有的条件都满足，脱机加密</span><span style="font-family:Calibri"><span lang="en-us">PIN</span></span><span style="font-family:'宋体'">才算成功</span><span lang="en-us"><span style="font-family:Calibri">.&nbsp;</span></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; font-size:15pt">终端风险管理：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:Calibri"><span lang="en-us">1.</span></span><span style="font-family:'宋体'">为什么要进行最低限额检查？如何进行？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'"><span style="font-size:14px">最低限额检查用于控制交易当前交易金额或同一张卡片连续几笔交易累积金额超过某个数值时则要求联机授权。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">如果终端不支持交易日志，则终端直接比较授权金额和最低限额。如果交易授权金额大于或等于最低限额，终端将</span><span style="font-family:Calibri"><span lang="en-us">TVR</span></span><span style="font-family:'宋体'">中的“交易超过最低限额”位设为‘</span><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">’。即使最低限额为</span><span style="font-family:Calibri"><span lang="en-us">0</span></span><span style="font-family:'宋体'">，终端也进行同样检查，这种情况会导致所有交易的</span><span style="font-family:Calibri"><span lang="en-us">TVR</span></span><span style="font-family:'宋体'">中的“交易超过最低限额”位都设为‘</span><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">’。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'">如果终端支持交易日志，则终端在交易日志中寻找与当前交易的</span><span style="font-family:Calibri"><span lang="en-us">PAN</span></span><span style="font-family:'宋体'">和</span><span style="font-family:Calibri"><span lang="en-us">PAN</span></span><span style="font-family:'宋体'">序列号（如果终端交易日志和卡片中都存在）相同的一个交易记录，将其对应的累计交易金额与当前交易的授权金额相加，如果和大于或等于最低限额，则</span><span style="font-family:Calibri"><span lang="en-us">TVR</span></span><span style="font-family:'宋体'">中的“交易超过最低限额”位设为‘</span><span style="font-family:Calibri"><span lang="en-us">1</span></span><span style="font-family:'宋体'">’。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#ff0000; font-size:9pt">特别说明：终端风险管理，没有联机能力的终端可以不做后续的内容，直接跳过后面的步骤，进入终端行为分析。简而言之，电子现金交易，这一流程的后续两步可以直接跳过。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">2.</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">随机选中交易实例理解</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">终端风险管理参数示例<span lang="en-us"><br> </span>参数<span lang="en-us">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>值<span lang="en-us"><br> </span>终端最低限额<span lang="en-us">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100&nbsp;&nbsp;&nbsp;</span>（<span lang="en-us">AID</span>参数下发）<span lang="en-us"><br> </span>终端随机数<span lang="en-us">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;&nbsp;</span>（终端随机生成）<span lang="en-us"><br> </span>偏置随机选择的阈值<span lang="en-us">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span> （<span lang="en-us">AID</span>参数下发）<span lang="en-us"><br> </span>随机选择目标百分比<span lang="en-us">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20</span>％ （<span lang="en-us">AID</span>参数下发）<span lang="en-us"><br> </span>偏置随机选择的最大目标百分比<span lang="en-us">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50</span>％（<span lang="en-us">AID</span>参数下发）<span lang="en-us"><br> </span>情形<span lang="en-us">1</span>：<span lang="en-us"><br> </span>交易金额是<span lang="en-us">20</span>。因为交易金额小于偏置随机选择阈值，因此执行随机选择。<span lang="en-us"><br> </span>比较终端随机数与目标百分数。因为随机数（<span lang="en-us">25</span>）大于目标百分数（<span lang="en-us">20</span>），所以交易不被选中作联机处理。<span lang="en-us"><br> </span>情形<span lang="en-us">2</span>：<span lang="en-us"><br> </span>交易金额是<span lang="en-us">60</span>。这个金额大于偏置随机选择的阈值，但小于终端最低限额。因此应用偏置随机选择。<span lang="en-us"><br> </span>交易金额比阈值高<span lang="en-us">20</span>，该差值是终端最低限额与阈值差值（<span lang="en-us">100</span>－<span lang="en-us">40</span>＝<span lang="en-us">60</span>）的<span lang="en-us">1/3</span>。因此将最大目标百分数与目标百分数的差值的<span lang="en-us">1/3</span>（<span lang="en-us">50</span>％－<span lang="en-us">20</span>％＝<span lang="en-us">30</span>％×<span lang="en-us">1/3</span>＝<span lang="en-us">10</span>％）加到目标百分数上，得到交易目标百分数为<span lang="en-us">30</span>％（<span lang="en-us">20</span>％＋<span lang="en-us">10</span>％＝<span lang="en-us">30</span>％）。<span lang="en-us"><br> </span>终端随机数为<span lang="en-us">25</span>，小于交易目标百分数（<span lang="en-us">30</span>），所以交易被选中进行联机处理。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">情形<span lang="en-us">3</span>：<span lang="en-us"><br> </span>交易金额为<span lang="en-us">150</span>。因该金额大于终端最低限额，因此交易不进行随机选择。而是进行最低限额检查而联机处理。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">3.</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">频度检查执行条件</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">如果连续脱机交易次数下限<span lang="en-us">LCOL(</span>标签‘<span lang="en-us">9F14</span>’<span lang="en-us">)</span>与连续脱机交易次数上限<span lang="en-us">UCOL(</span>标签‘<span lang="en-us">9F23</span>’<span lang="en-us">)</span>都存在，则执行，否则不执行。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">如果执行，终端需要先<span lang="en-us">GET DATA</span>获取<span lang="en-us">9F36</span>和<span lang="en-us">9F13</span>，然后再和<span lang="en-us">UCOL</span>和<span lang="en-us">LCOL</span>比较，判断满足交易频度检查条件。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">如果获取到的<span lang="en-us">9F13</span>为<span lang="en-us">0</span>，则将该卡标志位新卡。新卡是不允许脱机交易的，<span lang="en-us">IC</span>卡<span lang="en-us">cos</span>会对这个有要求，主要是安全考虑，因为新卡做脱机交易不可控。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">&nbsp;</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:15pt">终端行为分析：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">1.</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">终端行为分析需要用到哪些重要数据？</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">发卡行行为代码（<span lang="en-us">IAC</span>） 发卡行行为代码，来自读记录文件卡片返回</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">发卡行行为代码有三个数据元，即发卡行行为代码<span lang="en-us">-</span>拒绝、发卡行行为代码<span lang="en-us">-</span>联机、发卡行行为代码<span lang="en-us">-</span>缺省。每个发卡行行为代码由一组与终端验证结果（<span lang="en-us">TVR</span>）中的位相对应的位</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">组成</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">IAC</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">－拒绝位设置为“<span lang="en-us">1</span>”反映了交易被脱机拒绝的终端验证结果条件</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">IAC</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">－联机位设置为“<span lang="en-us">1</span>”代表需要联机授权条件</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">IAC</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">－缺省位设置为“<span lang="en-us">1</span>”是当联机处理不可行时脱机拒绝所需的条件</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">终端行为代码<span lang="en-us">(TAC)&nbsp; TAC</span>有三个数据元，它们都是由一系列的位组成的，这些位对应于<span lang="en-us">TVR</span>中的数据位。终端行为代码来自<span lang="en-us">emv</span>参数下载交易。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">TAC</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">－拒绝<span lang="en-us">&nbsp;</span>收单行设置的能够导致交易脱机拒绝的<span lang="en-us">TVR</span>条件位 </span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">TAC</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">－联机<span lang="en-us">&nbsp;</span>收单行设置的能够导致交易联机的<span lang="en-us">TVR</span>条件位 </span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">TAC</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">－缺省 收单行设置的在交易联机无法进行的情况下能够导致脱机拒绝的<span lang="en-us">TVR</span>条件位</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">这<span lang="en-us">6</span>个代码的查看方法和<span lang="en-us">TVR</span>查看方式一样，使用时也是配合<span lang="en-us">TVR</span>进行使用。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">2.</span><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">终端是如何判断其行为的？</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#000000; font-size:9pt">检查过程完全由终端利用先前从卡片获取的<span lang="en-us">IAC</span>数据和终端保存的<span lang="en-us">TAC</span>数据进行，无需与其它设备进行交互处理。<span lang="en-us"><br> </span>在处理过程中，终端比较<span lang="en-us">IAC</span>和<span lang="en-us">TAC</span>中与终端验证结果（<span lang="en-us">TVR</span>）对应的位。如果<span lang="en-us">TVR</span>和<span lang="en-us">IAC</span>或<span lang="en-us">TAC</span>中相应的位都被设置为“<span lang="en-us">1</span>”，则采纳对应的<span lang="en-us">IAC</span>或<span lang="en-us">TAC</span>。示例如下：</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000"><span style="font-family:'宋体'; font-size:14px"><span lang="en-us"><span style="font-family:'宋体'; font-size:14px"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20180119171459307?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTFlYX1dJTg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""></span></span></span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">终端的处理步骤如下：</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 1</span></span><span style="font-family:'宋体'; color:#000000">：终端比较</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR</span></span><span style="font-family:'宋体'; color:#000000">。如果不存在</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝，则采用缺省值‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">0000000000</span></span><span style="font-family:'宋体'; color:#000000">’。如果</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">IAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR </span></span><span style="font-family:'宋体'; color:#000000">的任何对应位同时设为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1</span></span><span style="font-family:'宋体'; color:#000000">’，终端必须：</span></span><span lang="en-us" style="color:#000000"><br> <span style="font-family:Calibri; font-size:14px"></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把授权响应码置为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Z1</span></span><span style="font-family:'宋体'; color:#000000">’</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">(</span></span><span style="font-family:'宋体'; color:#000000">脱机拒绝</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">)</span></span><span style="font-family:'宋体'; color:#000000">；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> GENERATE AC</span></span><span style="font-family:'宋体'; color:#000000">（产生应用密文）命令的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> P1</span></span><span style="font-family:'宋体'; color:#000000">参数设为请求应用认证密文（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">AAC</span></span><span style="font-family:'宋体'; color:#000000">）；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">进行请求应用密文步骤。</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 2</span></span><span style="font-family:'宋体'; color:#000000">：终端对</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR</span></span><span style="font-family:'宋体'; color:#000000">进行类似的比较。如果不存在</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝，则采用缺省值‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">0000000000</span></span><span style="font-family:'宋体'; color:#000000">’。如果</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR</span></span><span style="font-family:'宋体'; color:#000000">的任何对应位同时设为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1</span></span><span style="font-family:'宋体'; color:#000000">’，终端必须采取与</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－拒绝相同的处理。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 3</span></span><span style="font-family:'宋体'; color:#000000">：如果终端具有联机处理能力（仅联机的终端除外），则它应该使用</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－联机和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC</span></span><span style="font-family:'宋体'; color:#000000">－联机与</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TVR</span></span><span style="font-family:'宋体'; color:#000000">比较。如果</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－联机不存在，则使用缺省值‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FFFFFFFFFF</span></span><span style="font-family:'宋体'; color:#000000">’，如果</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">－联机不存在，则使用缺省值‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">0000000000</span></span><span style="font-family:'宋体'; color:#000000">’。如果</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－联机和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR</span></span><span style="font-family:'宋体'; color:#000000">的任何对应位同时置为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1</span></span><span style="font-family:'宋体'; color:#000000">’，则终端：</span></span><span lang="en-us" style="color:#000000"><br> <span style="font-family:Calibri; font-size:14px"></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把产生应用密文（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GENERATE AC</span></span><span style="font-family:'宋体'; color:#000000">）命令的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> P1</span></span><span style="font-family:'宋体'; color:#000000">参数设为授权请求密文（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARQC</span></span><span style="font-family:'宋体'; color:#000000">），以进行联机授权请求；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">进行生成应用密文步骤。</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">对于仅联机的终端，如果在步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 1</span></span><span style="font-family:'宋体'; color:#000000">和步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 2</span></span><span style="font-family:'宋体'; color:#000000">中未决定脱机拒绝，则终端不必进行</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－联机和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">－联机与</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR</span></span><span style="font-family:'宋体'; color:#000000">的比较，而直接按照</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－联机或</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">－联机和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR</span></span><span style="font-family:'宋体'; color:#000000">的任何对应位同时置为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1</span></span><span style="font-family:'宋体'; color:#000000">’的情况来处理，通过请求联机来继续进行交易。</span></span><span lang="en-us" style="color:#000000"><br> <span style="font-family:Calibri; font-size:14px"></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 4</span></span><span style="font-family:'宋体'; color:#000000">：如果终端是仅脱机终端或者当有联机处理能力的终端出于某种原因不能联机时，则使用</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省与</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TVR </span></span><span style="font-family:'宋体'; color:#000000">比较。如果没有</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> IAC</span></span><span style="font-family:'宋体'; color:#000000">－缺省，则使用缺省值‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FFFFFFFFFF</span></span><span style="font-family:'宋体'; color:#000000">’，如果</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> TAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省不存在，则使用缺省值‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">0000000000</span></span><span style="font-family:'宋体'; color:#000000">’。如果比较结果的任何对应位同时为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1</span></span><span style="font-family:'宋体'; color:#000000">’，则终端：</span></span><span lang="en-us" style="color:#000000"><br> <span style="font-family:Calibri; font-size:14px"></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把授权响应码置为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Z3</span></span><span style="font-family:'宋体'; color:#000000">’（不能联机，脱机拒绝），仅脱机终端授权响应码置为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Z1</span></span><span style="font-family:'宋体'; color:#000000">’；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把产生应用密文（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GENERATE AC</span></span><span style="font-family:'宋体'; color:#000000">）命令的的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> P1</span></span><span style="font-family:'宋体'; color:#000000">参数设置为请求</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> AAC</span></span><span style="font-family:'宋体'; color:#000000">；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">进行生成应用密文步骤。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">对于仅联机的终端，当无法进行联机时，它可以选择正常的处理</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC/IAC</span></span><span style="font-family:'宋体'; color:#000000">－缺省，也可以选择跳过</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC/IAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省的处理。对于跳过</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC/IAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省处理的终端应该直接按照</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC/IAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省与</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TVR</span></span><span style="font-family:'宋体'; color:#000000">匹配进行处理，并且在第</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">2</span></span><span style="font-family:'宋体'; color:#000000">个</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GENERATE AC</span></span><span style="font-family:'宋体'; color:#000000">请求</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">AAC</span></span><span style="font-family:'宋体'; color:#000000">。对于正常处理</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC/IAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省的终端，应该根据</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC/IAC</span></span><span style="font-family:'宋体'; color:#000000">——缺省与</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TVR</span></span><span style="font-family:'宋体'; color:#000000">匹配的结果生成应用密文，这时仅联机的终端可能脱机完成交易。</span></span><span lang="en-us" style="color:#000000"><br> <span style="font-family:Calibri; font-size:14px"></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> 5</span></span><span style="font-family:'宋体'; color:#000000">：如果在以上的比较中没有出现对应位同时为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1</span></span><span style="font-family:'宋体'; color:#000000">’的情况，则终端：</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把授权响应码置为‘</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Y1</span></span><span style="font-family:'宋体'; color:#000000">’（脱机批准）；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">把</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> GENERATE AC</span></span><span style="font-family:'宋体'; color:#000000">（请求应用密文）命令的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"> P1</span></span><span style="font-family:'宋体'; color:#000000">参数设置为请求交易证书（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TC</span></span><span style="font-family:'宋体'; color:#000000">）；</span></span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri"><span style="font-size:14px"><br> </span><span style="font-size:14px"></span></span></span><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">——</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">&nbsp;</span></span><span style="font-family:'宋体'; color:#000000">进行请求应用密文步骤。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">这里的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GENERATE AC</span></span><span style="font-family:'宋体'; color:#000000">就是我们所说的第一次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">，如果脱机批准了，获取到的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TC</span></span><span style="font-family:'宋体'; color:#000000">值需要在上送交易明细时上送到后台。如果卡片返回</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARQC</span></span><span style="font-family:'宋体'; color:#000000">，那么在联机交易结束后，还需要再做第二次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">，这个内容后续再讨论。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000; font-size:15pt">联机处理</span><span lang="en-us" style="color:#000000; font-size:15pt"><span style="font-family:Calibri">&amp;&amp;</span></span><span style="font-family:'宋体'; color:#000000; font-size:15pt">交易结束</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1.</span></span><span style="font-family:'宋体'; color:#000000">联机交易处理流程</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">第一步：</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">处理</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARPC</span></span><span style="font-family:'宋体'; color:#000000">（如果不包含，则跳过；如果包含并且</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">AIP</span></span><span style="font-family:'宋体'; color:#000000">特性标志不支持发卡行认证，则跳过）</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">收到联机返回报文后，获取</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">tag</span></span><span style="font-family:'宋体'; color:#000000">“</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">91</span></span><span style="font-family:'宋体'; color:#000000">”，即</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARPC</span></span><span style="font-family:'宋体'; color:#000000">，通过外部认证指令将</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARPC</span></span><span style="font-family:'宋体'; color:#000000">发给卡片，如果卡片响应</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9000</span></span><span style="font-family:'宋体'; color:#000000">，说明</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARPC</span></span><span style="font-family:'宋体'; color:#000000">校验通过，否则发起冲正。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">第二步：</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">处理发卡行脚本</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">再看</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">tag72</span></span><span style="font-family:'宋体'; color:#000000">（或</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">71</span></span><span style="font-family:'宋体'; color:#000000">，在圈存交易时，不允许出现两个脚本），这个是发卡行返回脚本采用</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">tag72</span></span><span style="font-family:'宋体'; color:#000000">作为标签，</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">72</span></span><span style="font-family:'宋体'; color:#000000">后面还是一个</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TLV</span></span><span style="font-family:'宋体'; color:#000000">，解析</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">tag86</span></span><span style="font-family:'宋体'; color:#000000">（发卡行脚本命令），获取到。再通过指令将这个命令给到卡片，整个数据就是一个指令，不需要再添加内容</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">第三步：</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">第二次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">，第一次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">发送</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">指令时组织数据采用的是</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CDOL1</span></span><span style="font-family:'宋体'; color:#000000">，第二次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">组织命令时用的是</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CDOL2</span></span><span style="font-family:'宋体'; color:#000000">，</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CDOL2</span></span><span style="font-family:'宋体'; color:#000000">也是在读记录时候获取到的。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">2.</span></span><span style="font-family:'宋体'; color:#000000">假如卡片请求</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARQC</span></span><span style="font-family:'宋体'; color:#000000">。但终端执行联机交易失败怎么办？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">卡片请求</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARQC</span></span><span style="font-family:'宋体'; color:#000000">，但是终端无法联机，并不是代表这个交易终止了，终端和卡片还有最后一次尝试，就是所谓的脱机转联机，联机失败再转脱机。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#ff0000; font-size:7.5pt">这就好像买东西一样，先去第一家店看了看，觉得东西还行，但是先不买，然后再去第二家店，结果发现第二家店的东西又贵又不好，那再回去第一家店看看，价格能不能商量一下，如果能谈妥，</span><span lang="en-us" style="color:#ff0000; font-size:7.5pt"><span style="font-family:Calibri">OK</span></span><span style="font-family:'宋体'; color:#ff0000; font-size:7.5pt">，那么就交易。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">这个时候首先又需要检查</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">IAC-</span></span><span style="font-family:'宋体'; color:#000000">缺省和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAC</span></span><span style="font-family:'宋体'; color:#000000">缺省执行终端行为分析（这部分在之前终端行为分析中有表详细的描述），并且根绝结果发送第二次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">指令。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">如果第二次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">指令能够成功返回</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TC</span></span><span style="font-family:'宋体'; color:#000000">，那么脱机交易批准，如果返回</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ACC</span></span><span style="font-family:'宋体'; color:#000000">，则交易拒绝，，这个时候不可能再返回</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">ARQC</span></span><span style="font-family:'宋体'; color:#000000">了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">如果脱机成功则响应码为</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Y3</span></span><span style="font-family:'宋体'; color:#000000">，但是，如果终端在第一次</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GAC</span></span><span style="font-family:'宋体'; color:#000000">就获取</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TC</span></span><span style="font-family:'宋体'; color:#000000">批准脱机交易的话，响应码是</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Y1</span></span><span style="font-family:'宋体'; color:#000000">，所以通过</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Y1</span></span><span style="font-family:'宋体'; color:#000000">和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Y3</span></span><span style="font-family:'宋体'; color:#000000">就可以知道是哪一种脱机批准。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">到此为止，整个借贷记交易和电子现金的交易就已经全部处理完了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000; font-size:15pt"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000; font-size:15pt">和借记贷记对比</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">1.QPBOC</span></span><span style="font-family:'宋体'; color:#000000">和</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">EMV</span></span><span style="font-family:'宋体'; color:#000000">在</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">PDOL</span></span><span style="font-family:'宋体'; color:#000000">中有什么区别？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">非接中的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GPO</span></span><span style="font-family:'宋体'; color:#000000">对于</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">PDOL</span></span><span style="font-family:'宋体'; color:#000000">的要求是必须含有</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F66</span></span><span style="font-family:'宋体'; color:#000000">（借贷记的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GPO</span></span><span style="font-family:'宋体'; color:#000000">是可以支持没有</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">PDOL</span></span><span style="font-family:'宋体'; color:#000000">的，终端在</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GPO</span></span><span style="font-family:'宋体'; color:#000000">只要发送</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">8300</span></span><span style="font-family:'宋体'; color:#000000">就行），如果没有，终端直接拒绝交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">2.QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的持卡人认证</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的持卡人认证和借贷记电子现金不同，</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的持卡人认证结果只有</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">2</span></span><span style="font-family:'宋体'; color:#000000">种情况：签名，联机。通过判断卡片交易属性（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F6C</span></span><span style="font-family:'宋体'; color:#000000">）和终端交易属性（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F66</span></span><span style="font-family:'宋体'; color:#000000">）来判断采用哪种持卡人验证方式。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">3.QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的处理限制与借贷记流程的有什么区别？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的处理限制只做一件事，就是判断卡有效期，相当于借贷记流程中的一个小步骤。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">4.QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的脱机数据认证与借贷记流程的有什么区别？</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">因为卡片不会再和终端有指令交互，所以数据认证使用的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000">自己定义的一种</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FDDA</span></span><span style="font-family:'宋体'; color:#000000">。</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FDDA</span></span><span style="font-family:'宋体'; color:#000000">的执行同样需要根据</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">AIP</span></span><span style="font-family:'宋体'; color:#000000">的情况作出判断。</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FDDA</span></span><span style="font-family:'宋体'; color:#000000">签名的动态数据通过</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F4B</span></span><span style="font-family:'宋体'; color:#000000">在读记录时返回，借贷记是通过内部认证获取到的。这个动态数据的获得，也是区分</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FDDA</span></span><span style="font-family:'宋体'; color:#000000">版本为</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">01</span></span><span style="font-family:'宋体'; color:#000000">还是</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">00.</span></span><span style="font-family:'宋体'; color:#000000">所以缺少了</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DDA</span></span><span style="font-family:'宋体'; color:#000000">的内部认证指令，所以叫做</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">FDDA</span></span><span style="font-family:'宋体'; color:#000000">。而用来参于组织签名数据的是通过一个固定数据域组织的，借贷记是通过</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DDOL</span></span><span style="font-family:'宋体'; color:#000000">获取的。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:9pt">特别说明<span lang="en-us">:PB0C3.</span>新增了一个<span lang="en-us">9F69</span>的标签，需要在版本<span lang="en-us">01</span>的<span lang="en-us">FDDA</span>中加入到签名数据域。</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:9pt">&nbsp;</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'微软雅黑','sans-serif'; color:#454545; font-size:15pt">交易限额</span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">终端最低限额（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F1B</span></span><span style="font-family:'宋体'; color:#000000">）、终端电子现金交易限额（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F7B</span></span><span style="font-family:'宋体'; color:#000000">）、非解最低限额（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF19</span></span><span style="font-family:'宋体'; color:#000000">）、非解交易限额（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF20</span></span><span style="font-family:'宋体'; color:#000000">）、</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CVM</span></span><span style="font-family:'宋体'; color:#000000">限额（</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF21</span></span><span style="font-family:'宋体'; color:#000000">）</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F1B</span></span><span style="font-family:'宋体'; color:#000000">，就是所谓的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Floorlimt</span></span><span style="font-family:'宋体'; color:#000000">，这个参数主要用在终端风险管理终端中的第一个步骤</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">-------</span></span><span style="font-family:'宋体'; color:#000000">最低限额检查。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F7B</span></span><span style="font-family:'宋体'; color:#000000">，当交易金额小于</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F7B</span></span><span style="font-family:'宋体'; color:#000000">的时候，终端可以执行电子现金脱机交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">特别说明：我一直觉得这个限额只应该对接触式电子现金交易有效，但是现在不管是客户还是同事，很多人都认为这个限额应该对</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Qpboc</span></span><span style="font-family:'宋体'; color:#000000">也要做判断。虽然目前代码是这么做的，但是我还是觉得这个限额应该只是对电子现金有效。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF19</span></span><span style="font-family:'宋体'; color:#000000">、</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF20</span></span><span style="font-family:'宋体'; color:#000000">、</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF21</span></span><span style="font-family:'宋体'; color:#000000">三个</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">TAG</span></span><span style="font-family:'宋体'; color:#000000">值都是连续的限额，就是针对于</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000">的三个限额，这三个限额主要是在</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">QPBOC</span></span><span style="font-family:'宋体'; color:#000000">预处理阶段进行判断。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF19</span></span><span style="font-family:'宋体'; color:#000000">，交易金额必须大于</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF19</span></span><span style="font-family:'宋体'; color:#000000">，才允许做非解交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF20</span></span><span style="font-family:'宋体'; color:#000000">，交易金额不能大于</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF20</span></span><span style="font-family:'宋体'; color:#000000">，否则交易拒绝，提示持卡人采用别的方式交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF21</span></span><span style="font-family:'宋体'; color:#000000">，超过该限额，终端应该在交易属性</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F66</span></span><span style="font-family:'宋体'; color:#000000">中置位“要求</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CVM</span></span><span style="font-family:'宋体'; color:#000000">”，进而在</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">GPO</span></span><span style="font-family:'宋体'; color:#000000">的时候告诉卡片终端需要</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CVM</span></span><span style="font-family:'宋体'; color:#000000">。但是这个值实际有什么意义也不清楚。</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">Q</span></span><span style="font-family:'宋体'; color:#000000">的持卡人验证只有签名和联机两种方式，卡片返回的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">9F6C</span></span><span style="font-family:'宋体'; color:#000000">再加上终端交易属性已经可以决定持卡人验证方式了。</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">CVM</span></span><span style="font-family:'宋体'; color:#000000">在这个时候确实没啥用了。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-family:'宋体'; color:#000000"><span style="font-size:14px">还有一个额度不得不提，就是卡片余额，当交易金额大于卡片余额，但是不满足上面任何一种拒绝交易的情况时，终端会选择脱机转联机交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span style="font-size:14px"><span style="font-family:'宋体'; color:#000000">当然了，如果交易金额没有超过卡片余额，但是却大于上述的</span><span lang="en-us" style="color:#000000"><span style="font-family:Calibri">DF20</span></span><span style="font-family:'宋体'; color:#000000">，终端就直接拒绝交易。</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <p style="margin:0cm 0cm 0pt"><span lang="en-us" style="color:#000000"><span style="font-family:Calibri; font-size:14px">&nbsp;</span></span></p> 
  <span style="font-family:'宋体'; font-size:14px"></span> 
  <div>
   ﻿﻿
  </div> 
  <div style="top:3664px">
   ﻿﻿
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/LYX_WIN/article/details/78781508,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/LYX_WIN/article/details/78781508,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
