<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>用Kubernetes部署超级账本Fabric的区块链即服务(3) | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="用Kubernetes部署超级账本Fabric的区块链即服务(3)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="题图摄于北京中轴线：鼓楼、玲珑塔、钉子塔、盘古大观 前2期文章我们分别介绍了用 Kubernetes 部署 Fabric&nbsp;（可点击）的总体架构和网络、存储的规划以及模板设计。作为可能是国内首篇关于 Kubernetes 部署 Fabric 1.0 的文章，详细到代码级，本文受到广泛的关注和欢迎。笔者们也百忙中快马加鞭，完成最后一部分，以飨读者。本期为连载之三，详述部署工具的具体实现步骤。文后附下载全文PDF版本和源代码的方法。 (接上期) 3.4 &nbsp;源码使用 &nbsp; 以下操作都在图 2-1的&nbsp;cmd&nbsp;客户机上进行，NFS&nbsp;的共享目录为&nbsp;/opt/share&nbsp;，该共享目录的 拥有者:用户组 建议设为&nbsp;nobody:nogroup&nbsp;。 &nbsp; a．生成启动文件 &nbsp; 步骤： 1. 把 NFS 的 /opt/share 目录挂载到 host 的 /opt/share 。 &nbsp; 2.&nbsp;下载本文配套源码并进入&nbsp;Fabric-on-K8S/&nbsp;目录，通过以下命令下载 Fabric 的 cryptogen 等工具： $ curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/linux-amd64-1.0.0/hyperledger-fabric-linux-amd64-1.0.0.tar.gz| tar xz &nbsp; 下载完毕后会在当前目录生成一个 bin 目录，该目录包含 cryptogen 和 configtx 等文件。 &nbsp; 3. 更改 templates/fabric_1_0_template_pod_cli 的 NFS 地址，如图 3-3所示。 图 3- 3 &nbsp; 4. 更改 templates/fabric_1_0_template_pod_namespace 的 NFS 地址，如图 3-4。 图 3- 4 &nbsp; 5.&nbsp; 依照 3.2 的说明配置 cluster-config.yaml 和 configtx.yaml 。 &nbsp; 6.&nbsp;&nbsp;&nbsp;通过以下命令生成启动所需要的文件: &nbsp; $ sudo bash generateAll.sh &nbsp;&nbsp; 运行 generateAll.sh 脚本时，除了调用 cryptogen 生成 crypto-config 目录之外，还在目录中的各个 organization 子目录下插入相应的 K8S 配置文件。以org1 为例，其目录下会有几个 yaml 文件用于启动： crypto-config &nbsp; --- peerOrganizations &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-ca.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-cli.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-namespace.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer0.org1.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---peer1.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer1.org1.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp; b.&nbsp;&nbsp;&nbsp;运行启动脚本 &nbsp; &nbsp; 通过以下命令启动Fabric集群(需要安装PyYAML-3.5): &nbsp; $ python3.5 transform/run.py &nbsp;对每个Fabric的 PeerOrganization ，启动脚本的工作流程如下： ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在 Kubernetes 中创建org的 namespace； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 ca pod ； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 CLI pod ； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 遍历 orgM/peers 的子目录找出相应的 yaml 文件，并启动所有 peer 。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; c.&nbsp;&nbsp;&nbsp;查看 cluster 状态 &nbsp; 创建完成后，查看各个 pod 的状态，若都显示为 running 则说明所有部件工作正常，命令如下，结果如图3-5： $ kubectl get pods–all-namespaces 图 3- 5 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 4. 测试Fabric集群 假设已经成功启动&nbsp;3.2.a&nbsp;中定义的 Fabric 集群，下面通过运行测试 chaincode 来判断 Fabric 集群是否如预期般工作。 首先创建和加入 channel，使用 configtx 工具来生成与 channel 相关的文件： [1]&nbsp;&nbsp;进入 CMD 客户机的 Fabric-on-K8S/setupCluster/ 目录: &nbsp; $ cd Fabric-on-K8S/setupCluster/ &nbsp; [2]&nbsp;&nbsp;创建 channel 的 channel.tx 文件，该 channel 的 ID 为 mychannel : &nbsp; $ ../bin/configtxgen -profileTwoOrgsChannel \ -outputCreateChannelTx \ ./channel-artifacts/channel.tx \ -channelID mychannel &nbsp; [3]&nbsp;&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org1 的 anchor peer : $ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel&nbsp; -outputAnchorPeersUpdate\ ./channel-artifacts/Org1MSPanchors.tx \ -channelID mychannel -asOrg Org1MSP &nbsp; [4]&nbsp;&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org2 的 anchor peer: $ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel \ -outputAnchorPeersUpdate\ ./channel-artifacts/Org2MSPanchors.tx\ -channelID mychannel -asOrg Org2MSP &nbsp; [5]&nbsp;&nbsp;由于每个 Org 的 CLI Pod 需要用到以上步骤创建的文件，可以通过 NFS 来跟 CLI Pod 共享这些文件: &nbsp; $ sudo cp -r ./channel-artifacts /opt/share/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 完成以上工作后，就可以通过各组织的 CLI Pod 来测试集群是否正常运行。 通过以下操作进入任意 org 的 CLI Pod 内部，以 org1 为例： 1. 查看 namespace 为 org1下的所有 Pod ： $ kubectl get pods –namespaces org1&nbsp; 图 4- 1 &nbsp;&nbsp; 如图 4-1所示 org1 的 CLI Pod 为 cli-2586364563-vclmr。 &nbsp; 2.&nbsp;&nbsp;&nbsp;&nbsp;进入 cli-2586364563-vclmr Pod： &nbsp; $ kubectl exec -it cli-2586364563-vclmr bash --namespace=org1 &nbsp; 进入 CLI Pod 后，可以执行以下命令以测试 Fabric 集群： a.&nbsp;&nbsp;&nbsp;创建channel $ peer channel create -o orderer0.orgorderer1:7050 \ -c mychannel -f./channel-artifacts/channel.tx &nbsp; b.&nbsp;&nbsp;&nbsp;拷贝 mychannel.block 到 channel-artifacts 目录： $ cp mychannel.block./channel-artifacts &nbsp; c.&nbsp;&nbsp;&nbsp;加入 mychannel $ peer channel join -b./channel-artifacts/mychannel.block &nbsp; d.&nbsp;&nbsp;&nbsp;更新 anchor peer，每个 org 只需执行一次 $ peer channel update -o orderer0.orgorderer1:7050 \ -c mychannel -f./channel-artifacts/Org1MSPanchors.tx &nbsp; e.&nbsp;&nbsp;&nbsp;安装chaincode 请读者下载&nbsp;Fabric&nbsp;的&nbsp;chaincode_example02&nbsp;目录并将其放置在&nbsp;CMD&nbsp;客户机的&nbsp;/opt/share/channel-artifacts&nbsp;目录下： $ peer chaincode install -n mycc -v 1.0 \ -p github.com/hyperledger/fabric/peer/channel-artifacts/chaincode_example02 &nbsp; f. 实例化 chaincode $ peer chaincode instantiate -o orderer0.orgorderer1:7050 \ -C mychannel -n mycc -v1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39;\ -P &quot;OR&nbsp;&nbsp;&nbsp; (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &nbsp; 通过以上命令实例化 mycc 后，读者可以自行切换到其他 org 的 CLI Pod 上通过加入 channel 等步骤，验证账本是否同步。 &nbsp; 4.1 外部调用 在配置文件中 ca、peer 和 orderer 的 service 类型定义为 NodePort，这样做的目的是为了让用户在 K8S 外也能访问到Fabric中的各个成员，端口映射规则如下 (以下出现 N 和 M 的范围分别为 N&gt;=1, M&gt;=0 ): &nbsp; 1.&nbsp;&nbsp;&nbsp;orgN 端口范围是 30000+(N-1)*100 ~ 30000+(N)*100-1，也就是说每一个 org 最多能分配到 100 个端口号，如 org1 的端口范围是 30000 到 30099。 &nbsp; 2.&nbsp;&nbsp;&nbsp;CA 的 7054 的映射关系如下： ca.orgN:7054 -&gt; &nbsp;worker:30000+(N-1)*100 &nbsp; 3.&nbsp;&nbsp;&nbsp;由于每个peer需要映射7051和7052两个端口，因此org中peerM的端口映射关系如下: &nbsp; peerM.orgN:7051 -&gt;worker:30000+(N-1)*100 + 2 * M + 1 peerM.orgN:7052 -&gt;worker:30000+(N-1)*100 + 2 * M + 2 &nbsp; 4.&nbsp;&nbsp;&nbsp;ordererN 的映射关系为： ordererN:7050 -&gt; worker:23700+N &nbsp; 若 worker1 的IP地址为 192.168.0.7，它运行 peer0.org1 ，则 Kubernetes 外的用户需要通过 192.168.0.7:30001 地址才能访问 peer0.org1 。 4.2 删除集群 当需要删除集群的时候，可以通过 transform 目录下的 delete.py 脚本来清理环境，该脚本会遍历 crypto-config 目录，找出所有的 yaml 文件，并通过 kuberclt delete -f xxx.yaml 的方式将资源逐个删除。 &nbsp; 5. 小结 本文阐述了 Kubernetes 与 Fabric 结合的重要性，并给出 Fabric 与 Kubernetes 结合的思路与框架，然后结合脚本工具来解析快捷部署的实现方式，最后是测试部署的集群是否正常工作。本文介绍的部署方法，是基于 Kubernetes 容器云平台实现 BaaS 的基础步骤。在此之上，可以增加更多的区块链层管理功能，图形化运维界面，使得开发人员投入更多的精力到应用的业务逻辑上。 &nbsp; （全文完） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多" />
<meta property="og:description" content="题图摄于北京中轴线：鼓楼、玲珑塔、钉子塔、盘古大观 前2期文章我们分别介绍了用 Kubernetes 部署 Fabric&nbsp;（可点击）的总体架构和网络、存储的规划以及模板设计。作为可能是国内首篇关于 Kubernetes 部署 Fabric 1.0 的文章，详细到代码级，本文受到广泛的关注和欢迎。笔者们也百忙中快马加鞭，完成最后一部分，以飨读者。本期为连载之三，详述部署工具的具体实现步骤。文后附下载全文PDF版本和源代码的方法。 (接上期) 3.4 &nbsp;源码使用 &nbsp; 以下操作都在图 2-1的&nbsp;cmd&nbsp;客户机上进行，NFS&nbsp;的共享目录为&nbsp;/opt/share&nbsp;，该共享目录的 拥有者:用户组 建议设为&nbsp;nobody:nogroup&nbsp;。 &nbsp; a．生成启动文件 &nbsp; 步骤： 1. 把 NFS 的 /opt/share 目录挂载到 host 的 /opt/share 。 &nbsp; 2.&nbsp;下载本文配套源码并进入&nbsp;Fabric-on-K8S/&nbsp;目录，通过以下命令下载 Fabric 的 cryptogen 等工具： $ curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/linux-amd64-1.0.0/hyperledger-fabric-linux-amd64-1.0.0.tar.gz| tar xz &nbsp; 下载完毕后会在当前目录生成一个 bin 目录，该目录包含 cryptogen 和 configtx 等文件。 &nbsp; 3. 更改 templates/fabric_1_0_template_pod_cli 的 NFS 地址，如图 3-3所示。 图 3- 3 &nbsp; 4. 更改 templates/fabric_1_0_template_pod_namespace 的 NFS 地址，如图 3-4。 图 3- 4 &nbsp; 5.&nbsp; 依照 3.2 的说明配置 cluster-config.yaml 和 configtx.yaml 。 &nbsp; 6.&nbsp;&nbsp;&nbsp;通过以下命令生成启动所需要的文件: &nbsp; $ sudo bash generateAll.sh &nbsp;&nbsp; 运行 generateAll.sh 脚本时，除了调用 cryptogen 生成 crypto-config 目录之外，还在目录中的各个 organization 子目录下插入相应的 K8S 配置文件。以org1 为例，其目录下会有几个 yaml 文件用于启动： crypto-config &nbsp; --- peerOrganizations &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-ca.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-cli.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-namespace.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer0.org1.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---peer1.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer1.org1.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp; b.&nbsp;&nbsp;&nbsp;运行启动脚本 &nbsp; &nbsp; 通过以下命令启动Fabric集群(需要安装PyYAML-3.5): &nbsp; $ python3.5 transform/run.py &nbsp;对每个Fabric的 PeerOrganization ，启动脚本的工作流程如下： ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在 Kubernetes 中创建org的 namespace； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 ca pod ； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 CLI pod ； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 遍历 orgM/peers 的子目录找出相应的 yaml 文件，并启动所有 peer 。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; c.&nbsp;&nbsp;&nbsp;查看 cluster 状态 &nbsp; 创建完成后，查看各个 pod 的状态，若都显示为 running 则说明所有部件工作正常，命令如下，结果如图3-5： $ kubectl get pods–all-namespaces 图 3- 5 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 4. 测试Fabric集群 假设已经成功启动&nbsp;3.2.a&nbsp;中定义的 Fabric 集群，下面通过运行测试 chaincode 来判断 Fabric 集群是否如预期般工作。 首先创建和加入 channel，使用 configtx 工具来生成与 channel 相关的文件： [1]&nbsp;&nbsp;进入 CMD 客户机的 Fabric-on-K8S/setupCluster/ 目录: &nbsp; $ cd Fabric-on-K8S/setupCluster/ &nbsp; [2]&nbsp;&nbsp;创建 channel 的 channel.tx 文件，该 channel 的 ID 为 mychannel : &nbsp; $ ../bin/configtxgen -profileTwoOrgsChannel \ -outputCreateChannelTx \ ./channel-artifacts/channel.tx \ -channelID mychannel &nbsp; [3]&nbsp;&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org1 的 anchor peer : $ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel&nbsp; -outputAnchorPeersUpdate\ ./channel-artifacts/Org1MSPanchors.tx \ -channelID mychannel -asOrg Org1MSP &nbsp; [4]&nbsp;&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org2 的 anchor peer: $ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel \ -outputAnchorPeersUpdate\ ./channel-artifacts/Org2MSPanchors.tx\ -channelID mychannel -asOrg Org2MSP &nbsp; [5]&nbsp;&nbsp;由于每个 Org 的 CLI Pod 需要用到以上步骤创建的文件，可以通过 NFS 来跟 CLI Pod 共享这些文件: &nbsp; $ sudo cp -r ./channel-artifacts /opt/share/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 完成以上工作后，就可以通过各组织的 CLI Pod 来测试集群是否正常运行。 通过以下操作进入任意 org 的 CLI Pod 内部，以 org1 为例： 1. 查看 namespace 为 org1下的所有 Pod ： $ kubectl get pods –namespaces org1&nbsp; 图 4- 1 &nbsp;&nbsp; 如图 4-1所示 org1 的 CLI Pod 为 cli-2586364563-vclmr。 &nbsp; 2.&nbsp;&nbsp;&nbsp;&nbsp;进入 cli-2586364563-vclmr Pod： &nbsp; $ kubectl exec -it cli-2586364563-vclmr bash --namespace=org1 &nbsp; 进入 CLI Pod 后，可以执行以下命令以测试 Fabric 集群： a.&nbsp;&nbsp;&nbsp;创建channel $ peer channel create -o orderer0.orgorderer1:7050 \ -c mychannel -f./channel-artifacts/channel.tx &nbsp; b.&nbsp;&nbsp;&nbsp;拷贝 mychannel.block 到 channel-artifacts 目录： $ cp mychannel.block./channel-artifacts &nbsp; c.&nbsp;&nbsp;&nbsp;加入 mychannel $ peer channel join -b./channel-artifacts/mychannel.block &nbsp; d.&nbsp;&nbsp;&nbsp;更新 anchor peer，每个 org 只需执行一次 $ peer channel update -o orderer0.orgorderer1:7050 \ -c mychannel -f./channel-artifacts/Org1MSPanchors.tx &nbsp; e.&nbsp;&nbsp;&nbsp;安装chaincode 请读者下载&nbsp;Fabric&nbsp;的&nbsp;chaincode_example02&nbsp;目录并将其放置在&nbsp;CMD&nbsp;客户机的&nbsp;/opt/share/channel-artifacts&nbsp;目录下： $ peer chaincode install -n mycc -v 1.0 \ -p github.com/hyperledger/fabric/peer/channel-artifacts/chaincode_example02 &nbsp; f. 实例化 chaincode $ peer chaincode instantiate -o orderer0.orgorderer1:7050 \ -C mychannel -n mycc -v1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39;\ -P &quot;OR&nbsp;&nbsp;&nbsp; (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &nbsp; 通过以上命令实例化 mycc 后，读者可以自行切换到其他 org 的 CLI Pod 上通过加入 channel 等步骤，验证账本是否同步。 &nbsp; 4.1 外部调用 在配置文件中 ca、peer 和 orderer 的 service 类型定义为 NodePort，这样做的目的是为了让用户在 K8S 外也能访问到Fabric中的各个成员，端口映射规则如下 (以下出现 N 和 M 的范围分别为 N&gt;=1, M&gt;=0 ): &nbsp; 1.&nbsp;&nbsp;&nbsp;orgN 端口范围是 30000+(N-1)*100 ~ 30000+(N)*100-1，也就是说每一个 org 最多能分配到 100 个端口号，如 org1 的端口范围是 30000 到 30099。 &nbsp; 2.&nbsp;&nbsp;&nbsp;CA 的 7054 的映射关系如下： ca.orgN:7054 -&gt; &nbsp;worker:30000+(N-1)*100 &nbsp; 3.&nbsp;&nbsp;&nbsp;由于每个peer需要映射7051和7052两个端口，因此org中peerM的端口映射关系如下: &nbsp; peerM.orgN:7051 -&gt;worker:30000+(N-1)*100 + 2 * M + 1 peerM.orgN:7052 -&gt;worker:30000+(N-1)*100 + 2 * M + 2 &nbsp; 4.&nbsp;&nbsp;&nbsp;ordererN 的映射关系为： ordererN:7050 -&gt; worker:23700+N &nbsp; 若 worker1 的IP地址为 192.168.0.7，它运行 peer0.org1 ，则 Kubernetes 外的用户需要通过 192.168.0.7:30001 地址才能访问 peer0.org1 。 4.2 删除集群 当需要删除集群的时候，可以通过 transform 目录下的 delete.py 脚本来清理环境，该脚本会遍历 crypto-config 目录，找出所有的 yaml 文件，并通过 kuberclt delete -f xxx.yaml 的方式将资源逐个删除。 &nbsp; 5. 小结 本文阐述了 Kubernetes 与 Fabric 结合的重要性，并给出 Fabric 与 Kubernetes 结合的思路与框架，然后结合脚本工具来解析快捷部署的实现方式，最后是测试部署的集群是否正常工作。本文介绍的部署方法，是基于 Kubernetes 容器云平台实现 BaaS 的基础步骤。在此之上，可以增加更多的区块链层管理功能，图形化运维界面，使得开发人员投入更多的精力到应用的业务逻辑上。 &nbsp; （全文完） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-08-22T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"题图摄于北京中轴线：鼓楼、玲珑塔、钉子塔、盘古大观 前2期文章我们分别介绍了用 Kubernetes 部署 Fabric&nbsp;（可点击）的总体架构和网络、存储的规划以及模板设计。作为可能是国内首篇关于 Kubernetes 部署 Fabric 1.0 的文章，详细到代码级，本文受到广泛的关注和欢迎。笔者们也百忙中快马加鞭，完成最后一部分，以飨读者。本期为连载之三，详述部署工具的具体实现步骤。文后附下载全文PDF版本和源代码的方法。 (接上期) 3.4 &nbsp;源码使用 &nbsp; 以下操作都在图 2-1的&nbsp;cmd&nbsp;客户机上进行，NFS&nbsp;的共享目录为&nbsp;/opt/share&nbsp;，该共享目录的 拥有者:用户组 建议设为&nbsp;nobody:nogroup&nbsp;。 &nbsp; a．生成启动文件 &nbsp; 步骤： 1. 把 NFS 的 /opt/share 目录挂载到 host 的 /opt/share 。 &nbsp; 2.&nbsp;下载本文配套源码并进入&nbsp;Fabric-on-K8S/&nbsp;目录，通过以下命令下载 Fabric 的 cryptogen 等工具： $ curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/linux-amd64-1.0.0/hyperledger-fabric-linux-amd64-1.0.0.tar.gz| tar xz &nbsp; 下载完毕后会在当前目录生成一个 bin 目录，该目录包含 cryptogen 和 configtx 等文件。 &nbsp; 3. 更改 templates/fabric_1_0_template_pod_cli 的 NFS 地址，如图 3-3所示。 图 3- 3 &nbsp; 4. 更改 templates/fabric_1_0_template_pod_namespace 的 NFS 地址，如图 3-4。 图 3- 4 &nbsp; 5.&nbsp; 依照 3.2 的说明配置 cluster-config.yaml 和 configtx.yaml 。 &nbsp; 6.&nbsp;&nbsp;&nbsp;通过以下命令生成启动所需要的文件: &nbsp; $ sudo bash generateAll.sh &nbsp;&nbsp; 运行 generateAll.sh 脚本时，除了调用 cryptogen 生成 crypto-config 目录之外，还在目录中的各个 organization 子目录下插入相应的 K8S 配置文件。以org1 为例，其目录下会有几个 yaml 文件用于启动： crypto-config &nbsp; --- peerOrganizations &nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-ca.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-cli.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-namespace.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer0.org1.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---peer1.org1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer1.org1.yaml &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp; b.&nbsp;&nbsp;&nbsp;运行启动脚本 &nbsp; &nbsp; 通过以下命令启动Fabric集群(需要安装PyYAML-3.5): &nbsp; $ python3.5 transform/run.py &nbsp;对每个Fabric的 PeerOrganization ，启动脚本的工作流程如下： ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在 Kubernetes 中创建org的 namespace； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 ca pod ； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 CLI pod ； ·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 遍历 orgM/peers 的子目录找出相应的 yaml 文件，并启动所有 peer 。 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; c.&nbsp;&nbsp;&nbsp;查看 cluster 状态 &nbsp; 创建完成后，查看各个 pod 的状态，若都显示为 running 则说明所有部件工作正常，命令如下，结果如图3-5： $ kubectl get pods–all-namespaces 图 3- 5 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 4. 测试Fabric集群 假设已经成功启动&nbsp;3.2.a&nbsp;中定义的 Fabric 集群，下面通过运行测试 chaincode 来判断 Fabric 集群是否如预期般工作。 首先创建和加入 channel，使用 configtx 工具来生成与 channel 相关的文件： [1]&nbsp;&nbsp;进入 CMD 客户机的 Fabric-on-K8S/setupCluster/ 目录: &nbsp; $ cd Fabric-on-K8S/setupCluster/ &nbsp; [2]&nbsp;&nbsp;创建 channel 的 channel.tx 文件，该 channel 的 ID 为 mychannel : &nbsp; $ ../bin/configtxgen -profileTwoOrgsChannel \\ -outputCreateChannelTx \\ ./channel-artifacts/channel.tx \\ -channelID mychannel &nbsp; [3]&nbsp;&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org1 的 anchor peer : $ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel&nbsp; -outputAnchorPeersUpdate\\ ./channel-artifacts/Org1MSPanchors.tx \\ -channelID mychannel -asOrg Org1MSP &nbsp; [4]&nbsp;&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org2 的 anchor peer: $ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel \\ -outputAnchorPeersUpdate\\ ./channel-artifacts/Org2MSPanchors.tx\\ -channelID mychannel -asOrg Org2MSP &nbsp; [5]&nbsp;&nbsp;由于每个 Org 的 CLI Pod 需要用到以上步骤创建的文件，可以通过 NFS 来跟 CLI Pod 共享这些文件: &nbsp; $ sudo cp -r ./channel-artifacts /opt/share/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 完成以上工作后，就可以通过各组织的 CLI Pod 来测试集群是否正常运行。 通过以下操作进入任意 org 的 CLI Pod 内部，以 org1 为例： 1. 查看 namespace 为 org1下的所有 Pod ： $ kubectl get pods –namespaces org1&nbsp; 图 4- 1 &nbsp;&nbsp; 如图 4-1所示 org1 的 CLI Pod 为 cli-2586364563-vclmr。 &nbsp; 2.&nbsp;&nbsp;&nbsp;&nbsp;进入 cli-2586364563-vclmr Pod： &nbsp; $ kubectl exec -it cli-2586364563-vclmr bash --namespace=org1 &nbsp; 进入 CLI Pod 后，可以执行以下命令以测试 Fabric 集群： a.&nbsp;&nbsp;&nbsp;创建channel $ peer channel create -o orderer0.orgorderer1:7050 \\ -c mychannel -f./channel-artifacts/channel.tx &nbsp; b.&nbsp;&nbsp;&nbsp;拷贝 mychannel.block 到 channel-artifacts 目录： $ cp mychannel.block./channel-artifacts &nbsp; c.&nbsp;&nbsp;&nbsp;加入 mychannel $ peer channel join -b./channel-artifacts/mychannel.block &nbsp; d.&nbsp;&nbsp;&nbsp;更新 anchor peer，每个 org 只需执行一次 $ peer channel update -o orderer0.orgorderer1:7050 \\ -c mychannel -f./channel-artifacts/Org1MSPanchors.tx &nbsp; e.&nbsp;&nbsp;&nbsp;安装chaincode 请读者下载&nbsp;Fabric&nbsp;的&nbsp;chaincode_example02&nbsp;目录并将其放置在&nbsp;CMD&nbsp;客户机的&nbsp;/opt/share/channel-artifacts&nbsp;目录下： $ peer chaincode install -n mycc -v 1.0 \\ -p github.com/hyperledger/fabric/peer/channel-artifacts/chaincode_example02 &nbsp; f. 实例化 chaincode $ peer chaincode instantiate -o orderer0.orgorderer1:7050 \\ -C mychannel -n mycc -v1.0 -c &#39;{&quot;Args&quot;:[&quot;init&quot;,&quot;a&quot;,&quot;100&quot;,&quot;b&quot;,&quot;200&quot;]}&#39;\\ -P &quot;OR&nbsp;&nbsp;&nbsp; (&#39;Org1MSP.member&#39;,&#39;Org2MSP.member&#39;)&quot; &nbsp; 通过以上命令实例化 mycc 后，读者可以自行切换到其他 org 的 CLI Pod 上通过加入 channel 等步骤，验证账本是否同步。 &nbsp; 4.1 外部调用 在配置文件中 ca、peer 和 orderer 的 service 类型定义为 NodePort，这样做的目的是为了让用户在 K8S 外也能访问到Fabric中的各个成员，端口映射规则如下 (以下出现 N 和 M 的范围分别为 N&gt;=1, M&gt;=0 ): &nbsp; 1.&nbsp;&nbsp;&nbsp;orgN 端口范围是 30000+(N-1)*100 ~ 30000+(N)*100-1，也就是说每一个 org 最多能分配到 100 个端口号，如 org1 的端口范围是 30000 到 30099。 &nbsp; 2.&nbsp;&nbsp;&nbsp;CA 的 7054 的映射关系如下： ca.orgN:7054 -&gt; &nbsp;worker:30000+(N-1)*100 &nbsp; 3.&nbsp;&nbsp;&nbsp;由于每个peer需要映射7051和7052两个端口，因此org中peerM的端口映射关系如下: &nbsp; peerM.orgN:7051 -&gt;worker:30000+(N-1)*100 + 2 * M + 1 peerM.orgN:7052 -&gt;worker:30000+(N-1)*100 + 2 * M + 2 &nbsp; 4.&nbsp;&nbsp;&nbsp;ordererN 的映射关系为： ordererN:7050 -&gt; worker:23700+N &nbsp; 若 worker1 的IP地址为 192.168.0.7，它运行 peer0.org1 ，则 Kubernetes 外的用户需要通过 192.168.0.7:30001 地址才能访问 peer0.org1 。 4.2 删除集群 当需要删除集群的时候，可以通过 transform 目录下的 delete.py 脚本来清理环境，该脚本会遍历 crypto-config 目录，找出所有的 yaml 文件，并通过 kuberclt delete -f xxx.yaml 的方式将资源逐个删除。 &nbsp; 5. 小结 本文阐述了 Kubernetes 与 Fabric 结合的重要性，并给出 Fabric 与 Kubernetes 结合的思路与框架，然后结合脚本工具来解析快捷部署的实现方式，最后是测试部署的集群是否正常工作。本文介绍的部署方法，是基于 Kubernetes 容器云平台实现 BaaS 的基础步骤。在此之上，可以增加更多的区块链层管理功能，图形化运维界面，使得开发人员投入更多的精力到应用的业务逻辑上。 &nbsp; （全文完） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多","@type":"BlogPosting","url":"/2017/08/22/86b07295717e98dba459dfcc86c1b9c9.html","headline":"用Kubernetes部署超级账本Fabric的区块链即服务(3)","dateModified":"2017-08-22T00:00:00+08:00","datePublished":"2017-08-22T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2017/08/22/86b07295717e98dba459dfcc86c1b9c9.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>用Kubernetes部署超级账本Fabric的区块链即服务(3)</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div class="rich_media_content"> 
   <p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_jpg/VKmSsh8NadaILibSCibKVdFGENOwvfQia76l3RBicfa6N727FGZEk1ibNl5wLxb39SHxACZEb2aiaXAic2xZXpSkwB4qA/0?wx_fmt=jpeg" alt="0?wx_fmt=jpeg"><br></p>
   <p style="text-align:center;"><span style="font-size:12px;color:rgb(136,136,136);">题图摄于北京中轴线：鼓楼、玲珑塔、钉子塔、盘古大观</span></p>
   <p><br></p>
   <blockquote>
    <p><span style="font-size:14px;color:rgb(136,136,136);">前2期文章我们分别介绍了</span><a href="http://mp.weixin.qq.com/s?__biz=MzAwNzUyNzI5Mw==&amp;mid=2730790574&amp;idx=1&amp;sn=de8eb13d15dcb561f8d21e52f32cc827&amp;chksm=bc4ce0bc8b3b69aaa8616be3726c9d968e7948b7a23210349dedcfac6de670fa7f642977340a&amp;scene=21#wechat_redirect" rel="nofollow" style="color:rgb(0,82,255);text-decoration:underline;font-size:14px;"><span>用 Kubernetes 部署 Fabric&nbsp;</span></a><span style="font-size:14px;color:rgb(136,136,136);">（可点击）的总体架构和网络、存储的规划以及模板设计。作为可能是国内首篇关于 Kubernetes 部署 Fabric 1.0 的文章，详细到代码级，本文受到广泛的关注和欢迎。笔者们也百忙中快马加鞭，完成最后一部分，以飨读者。本期为连载之三，详述部署工具的具体实现步骤。文后附下载全文PDF版本和源代码的方法。</span></p>
   </blockquote>
   <p><br></p>
   <p><span style="font-size:12px;">(接上期)</span></p>
   <p><br></p>
   <p><span style="font-size:16px;"><strong>3.4 &nbsp;源码使用</strong></span></p>
   <p>&nbsp;</p>
   <p>以下操作都在图 2-1的&nbsp;cmd&nbsp;客户机上进行，NFS&nbsp;的共享目录为&nbsp;/opt/share&nbsp;，该共享目录的 拥有者:用户组 建议设为&nbsp;nobody:nogroup&nbsp;。</p>
   <p>&nbsp;</p>
   <p><strong>a．生成启动文件</strong></p>
   <p>&nbsp;</p>
   <p>步骤：</p>
   <p><strong>1. </strong>把 NFS 的 /opt/share 目录挂载到 host 的 /opt/share 。</p>
   <p>&nbsp;</p>
   <p><strong>2.&nbsp;</strong>下载本文配套源码并进入&nbsp;Fabric-on-K8S/&nbsp;目录，通过以下命令下载 Fabric 的 cryptogen 等工具：</p>
   <p><br></p>
   <p><span style="font-size:12px;color:rgb(171,25,66);">$ curl https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/linux-amd64-1.0.0/hyperledger-fabric-linux-amd64-1.0.0.tar.gz| tar xz</span></p>
   <p>&nbsp;</p>
   <p>下载完毕后会在当前目录生成一个 bin 目录，该目录包含 cryptogen 和 configtx 等文件。</p>
   <p>&nbsp;</p>
   <p><strong>3. </strong>更改 templates/fabric_1_0_template_pod_cli 的 NFS 地址，如图 3-3所示。</p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadazpTNBIspNKjBjGw5hbxBtNvvVATJDpHum3Wj9g3wbnoPWbeiaN5qjYd4Z4GsF8lBR7Nqml1tiazjQ/0?wx_fmt=png" alt="0?wx_fmt=png"></p>
   <p style="text-align:center;"><span style="font-size:12px;color:rgb(136,136,136);">图 3- 3</span></p>
   <p>&nbsp;</p>
   <p><strong>4. </strong>更改 templates/fabric_1_0_template_pod_namespace 的 NFS 地址，如图 3-4。</p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadazpTNBIspNKjBjGw5hbxBtuUOMt2Fib9hbhBR6tev117e7Wlvbl3zRjLTaTZBo8ibqYp4p5ic5hsW1w/0?wx_fmt=png" alt="0?wx_fmt=png"></p>
   <p style="text-align:center;"><span style="color:rgb(136,136,136);font-size:12px;">图 3- 4</span></p>
   <p>&nbsp;</p>
   <p><strong>5.&nbsp; </strong>依照 3.2 的说明配置 cluster-config.yaml 和 configtx.yaml 。</p>
   <p>&nbsp;</p>
   <p><strong>6.&nbsp;&nbsp;&nbsp;</strong>通过以下命令生成启动所需要的文件:</p>
   <p>&nbsp;</p>
   <p><span style="color:rgb(171,25,66);font-size:12px;">$ sudo bash generateAll.sh</span></p>
   <p>&nbsp;&nbsp;</p>
   <p>运行 generateAll.sh 脚本时，除了调用 cryptogen 生成 crypto-config 目录之外，还在目录中的各个 organization 子目录下插入相应的 K8S 配置文件。以org1 为例，其目录下会有几个 yaml 文件用于启动：</p>
   <p><br></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">crypto-config</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; --- peerOrganizations</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-ca.yaml</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-cli.yaml</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---org1-namespace.yaml</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --- tlsca</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer0.org1.yaml</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- tls</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ---peer1.org1</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peer1.org1.yaml</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls</span></p>
   <p>&nbsp;</p>
   <p><strong>b.&nbsp;&nbsp;&nbsp;运行启动脚本</strong></p>
   <p>&nbsp;</p>
   <p>&nbsp; 通过以下命令启动Fabric集群(需要安装PyYAML-3.5):</p>
   <p><br></p>
   <p>&nbsp;<strong><span style="color:rgb(171,25,66);font-size:12px;"> $ python3.5 transform/run.py</span></strong></p>
   <p><br></p>
   <p>&nbsp;对每个Fabric的 PeerOrganization ，启动脚本的工作流程如下：</p>
   <p>·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在 Kubernetes 中创建org的 namespace；</p>
   <p>·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 ca pod ；</p>
   <p>·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 创建 org 的 CLI pod ；</p>
   <p>·&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 遍历 orgM/peers 的子目录找出相应的 yaml 文件，并启动所有 peer 。</p>
   <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;</p>
   <p>c.&nbsp;&nbsp;&nbsp;查看 cluster 状态</p>
   <p>&nbsp;</p>
   <p>创建完成后，查看各个 pod 的状态，若都显示为 running 则说明所有部件工作正常，命令如下，结果如图3-5：</p>
   <p><br></p>
   <p><strong><span style="color:rgb(171,25,66);font-size:12px;">$ kubectl get pods–all-namespaces</span></strong></p>
   <p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadazpTNBIspNKjBjGw5hbxBtiaqfPHylToHiclFJncrtzerlziccnJF1cDPWeVpyWG0520zZkMOiaN7aCA/0?wx_fmt=png" alt="0?wx_fmt=png"></p>
   <p style="text-align:center;"><span style="color:rgb(136,136,136);font-size:12px;">图 3- 5</span></p>
   <p><strong style="color:rgb(62,62,62);font-size:14px;">【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“</strong><strong style="color:rgb(62,62,62);font-size:14px;"><span style="color:rgb(2,30,170);">区块链即服务</span></strong><strong style="color:rgb(62,62,62);font-size:14px;"><span>”&nbsp;</span><strong><strong><span>或&nbsp;</span><strong><span>“</span><span style="color:rgb(2,30,170);">baas</span><span>”</span></strong></strong></strong><span>即可。】</span></strong></p>
   <p><strong style="color:rgb(62,62,62);font-size:14px;"><span><br></span></strong></p>
   <p><strong>4. 测试Fabric集群</strong></p>
   <p><br></p>
   <p>假设已经成功启动&nbsp;<strong>3.2.a&nbsp;</strong>中定义的 Fabric 集群，下面通过运行测试 chaincode 来判断 Fabric 集群是否如预期般工作。</p>
   <p><br></p>
   <p>首先创建和加入 channel，使用 configtx 工具来生成与 channel 相关的文件：</p>
   <p><br></p>
   <p><strong>[1]&nbsp;&nbsp;</strong>进入 CMD 客户机的 Fabric-on-K8S/setupCluster/ 目录:</p>
   <p>&nbsp;</p>
   <p><strong><span style="color:rgb(171,25,66);font-size:12px;">$ cd Fabric-on-K8S/setupCluster/</span></strong></p>
   <p>&nbsp;</p>
   <p><strong>[2]&nbsp;</strong>&nbsp;创建 channel 的 channel.tx 文件，该 channel 的 ID 为 mychannel :</p>
   <p>&nbsp;</p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">$ ../bin/configtxgen -profileTwoOrgsChannel \</span></strong></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">-outputCreateChannelTx \</span></strong></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">./channel-artifacts/channel.tx \</span></strong></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">-channelID mychannel</span></strong></p>
   <p>&nbsp;</p>
   <p><strong>[3]&nbsp;</strong>&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org1 的 anchor peer :</p>
   <p><br></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">$ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel&nbsp;</span></strong></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">-outputAnchorPeersUpdate\</span></strong></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">./channel-artifacts/Org1MSPanchors.tx \</span></strong></p>
   <p style="line-height:normal;"><strong><span style="color:rgb(171,25,66);font-size:12px;">-channelID mychannel -asOrg Org1MSP</span></strong></p>
   <p>&nbsp;</p>
   <p><strong>[4]&nbsp;</strong>&nbsp;创建 channel 的升级文件，该文件用于更新 mychannel 中 Org2 的 anchor peer:</p>
   <p><br></p>
   <p style="line-height:normal;"><span style="font-size:12px;color:rgb(171,25,66);"><strong>$ ../bin/configtxgen&nbsp; -profile TwoOrgsChannel \</strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;color:rgb(171,25,66);"><strong>-outputAnchorPeersUpdate\</strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;color:rgb(171,25,66);"><strong>./channel-artifacts/Org2MSPanchors.tx\</strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;color:rgb(171,25,66);"><strong>-channelID mychannel -asOrg Org2MSP</strong></span></p>
   <p>&nbsp;</p>
   <p><strong>[5]&nbsp;</strong>&nbsp;由于每个 Org 的 CLI Pod 需要用到以上步骤创建的文件，可以通过 NFS 来跟 CLI Pod 共享这些文件:</p>
   <p>&nbsp;</p>
   <p><span style="font-size:12px;"><strong><span style="color:rgb(171,25,66);">$ sudo cp -r ./channel-artifacts /opt/share/</span></strong></span></p>
   <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;</p>
   <p>完成以上工作后，就可以通过各组织的 CLI Pod 来测试集群是否正常运行。</p>
   <p><br></p>
   <p>通过以下操作进入任意 org 的 CLI Pod 内部，以 org1 为例：</p>
   <p><br></p>
   <p><strong>1. </strong>查看 namespace 为 org1下的所有 Pod ：</p>
   <p><br></p>
   <p><strong><span style="color:rgb(171,25,66);font-size:12px;">$ kubectl get pods –namespaces org1&nbsp;</span></strong></p>
   <p><img src="https://ss.csdn.net/p?https://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadazpTNBIspNKjBjGw5hbxBt7XOFibWicpjhZgWSYK3kATfI1Ny6geCLfxGhB0oMhSlZTGnnJZcCNhEw/0?wx_fmt=png" alt="0?wx_fmt=png"></p>
   <p style="text-align:center;"><span style="color:rgb(136,136,136);font-size:12px;">图 4- 1</span></p>
   <p>&nbsp;&nbsp;</p>
   <p>如图 4-1所示 org1 的 CLI Pod 为 cli-2586364563-vclmr。</p>
   <p>&nbsp;</p>
   <p><strong>2.&nbsp;&nbsp;&nbsp;&nbsp;</strong>进入 cli-2586364563-vclmr Pod：</p>
   <p>&nbsp;</p>
   <p><span style="color:rgb(171,25,66);font-size:12px;"><strong>$ kubectl exec -it cli-2586364563-vclmr bash --namespace=org1</strong></span><span style="color:rgb(171,25,66);"></span></p>
   <p>&nbsp;</p>
   <p>进入 CLI Pod 后，可以执行以下命令以测试 Fabric 集群：</p>
   <p><br></p>
   <p><strong>a.&nbsp;&nbsp;&nbsp;</strong>创建channel</p>
   <p><br></p>
   <p><strong><span style="color:rgb(171,25,66);font-size:12px;">$ peer channel create -o orderer0.orgorderer1:7050 \</span></strong></p>
   <p><strong><span style="color:rgb(171,25,66);font-size:12px;">-c mychannel -f./channel-artifacts/channel.tx</span></strong></p>
   <p>&nbsp;</p>
   <p><strong>b.&nbsp;</strong>&nbsp;&nbsp;拷贝 mychannel.block 到 channel-artifacts 目录：</p>
   <p><br></p>
   <p><span style="font-size:12px;"><strong><span style="color:rgb(171,25,66);">$ cp mychannel.block./channel-artifacts</span></strong></span></p>
   <p>&nbsp;</p>
   <p><strong>c.&nbsp;&nbsp;</strong>&nbsp;加入 mychannel</p>
   <p><br></p>
   <p><span style="font-size:12px;"><strong><span style="color:rgb(171,25,66);">$ peer channel join -b./channel-artifacts/mychannel.block</span></strong></span></p>
   <p>&nbsp;</p>
   <p><strong>d.&nbsp;&nbsp;</strong>&nbsp;更新 anchor peer，每个 org 只需执行一次</p>
   <p><br></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="color:rgb(171,25,66);">$ peer channel update -o orderer0.orgorderer1:7050 \</span></strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">-c mychannel -f./channel-artifacts/Org1MSPanchors.tx</span></strong></span></p>
   <p>&nbsp;</p>
   <p><strong>e.&nbsp;&nbsp;</strong>&nbsp;安装chaincode</p>
   <p>请读者下载&nbsp;Fabric&nbsp;的&nbsp;chaincode_example02&nbsp;目录并将其放置在&nbsp;CMD&nbsp;客户机的&nbsp;/opt/share/channel-artifacts&nbsp;目录下：</p>
   <p><br></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">$ peer chaincode install -n mycc -v 1.0 \</span></strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">-p github.com/hyperledger/fabric/peer/channel-artifacts/chaincode_example02</span></strong></span></p>
   <p>&nbsp;</p>
   <p><strong>f.</strong> 实例化 chaincode</p>
   <p><br></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">$ peer chaincode instantiate -o orderer0.orgorderer1:7050 \</span></strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">-C mychannel -n mycc -v1.0 -c '{"Args":["init","a","100","b","200"]}'\</span></strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">-P "OR&nbsp;&nbsp;&nbsp; ('Org1MSP.member','Org2MSP.member')"</span></strong></span></p>
   <p>&nbsp;</p>
   <p>通过以上命令实例化 mycc 后，读者可以自行切换到其他 org 的 CLI Pod 上通过加入 channel 等步骤，验证账本是否同步。</p>
   <p>&nbsp;</p>
   <p><strong>4.1 外部调用</strong></p>
   <p><br></p>
   <p>在配置文件中 ca、peer 和 orderer 的 service 类型定义为 NodePort，这样做的目的是为了让用户在 K8S 外也能访问到Fabric中的各个成员，端口映射规则如下 (以下出现 N 和 M 的范围分别为 N&gt;=1, M&gt;=0 ):</p>
   <p>&nbsp;</p>
   <p><strong>1.&nbsp;&nbsp;</strong>&nbsp;orgN 端口范围是 <span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">30000+(N-1)*100 ~ 30000+(N)*100-1</span></strong></span>，也就是说每一个 org 最多能分配到 100 个端口号，如 org1 的端口范围是 30000 到 30099。</p>
   <p>&nbsp;</p>
   <p><strong>2.&nbsp;&nbsp;&nbsp;</strong>CA 的 7054 的映射关系如下：</p>
   <p><br></p>
   <p><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">ca.orgN:7054 -&gt; &nbsp;worker:30000+(N-1)*100</span></strong></span></p>
   <p>&nbsp;</p>
   <p><strong>3.&nbsp;&nbsp;&nbsp;</strong>由于每个peer需要映射7051和7052两个端口，因此org中peerM的端口映射关系如下:</p>
   <p>&nbsp;</p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">peerM.orgN:7051 -&gt;worker:30000+(N-1)*100 + 2 * M + 1</span></strong></span></p>
   <p style="line-height:normal;"><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">peerM.orgN:7052 -&gt;worker:30000+(N-1)*100 + 2 * M + 2</span></strong></span></p>
   <p>&nbsp;</p>
   <p><strong>4.&nbsp;&nbsp;&nbsp;</strong>ordererN 的映射关系为：</p>
   <p><br></p>
   <p><span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">ordererN:7050 -&gt; worker:23700+N</span></strong></span></p>
   <p>&nbsp;</p>
   <p>若 worker1 的IP地址为 192.168.0.7，它运行 peer0.org1 ，则 Kubernetes 外的用户需要通过 192.168.0.7:30001 地址才能访问 peer0.org1 。</p>
   <p><br></p>
   <p><strong>4.2 删除集群</strong></p>
   <p><br></p>
   <p>当需要删除集群的时候，可以通过 transform 目录下的 delete.py 脚本来清理环境，该脚本会遍历 crypto-config 目录，找出所有的 yaml 文件，并通过 <span style="font-size:12px;"><strong><span style="font-size:12px;color:rgb(171,25,66);">kuberclt delete -f xxx.yaml </span></strong></span>的方式将资源逐个删除。</p>
   <p>&nbsp;</p>
   <p><strong>5. 小结</strong></p>
   <p><br></p>
   <p>本文阐述了 Kubernetes 与 Fabric 结合的重要性，并给出 Fabric 与 Kubernetes 结合的思路与框架，然后结合脚本工具来解析快捷部署的实现方式，最后是测试部署的集群是否正常工作。本文介绍的部署方法，是基于 Kubernetes 容器云平台实现 BaaS 的基础步骤。在此之上，可以增加更多的区块链层管理功能，图形化运维界面，使得开发人员投入更多的精力到应用的业务逻辑上。</p>
   <p>&nbsp;</p>
   <p><span style="color:rgb(62,62,62);font-size:12px;">（全文完）</span></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><br></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:15px;"><strong style="font-size:14px;"><span>欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。</span></strong></span></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;"><span><br></span></strong></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;">【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“</strong><strong style="font-size:14px;"><span style="color:rgb(2,30,170);">区块链即服务</span></strong><strong style="font-size:14px;"><span>”&nbsp;</span><strong><strong><span>或&nbsp;</span><strong><span>“</span><span style="color:rgb(2,30,170);">baas</span><span>”</span></strong></strong></strong><span>即可。】</span></strong></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;"><span><br></span></strong></p>
   <p><span style="font-family:SimSun;"></span></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:14px;"><strong>相关文章：<a href="http://mp.weixin.qq.com/s?__biz=MzAwNzUyNzI5Mw==&amp;mid=2730790527&amp;idx=1&amp;sn=3b9ecce4440b168cddfb385215b3622a&amp;chksm=bc4ce06d8b3b697ba772d8e742aeac6958c830c2f0570b5cbe53ebe5ec35521595045ca15b14&amp;scene=21#wechat_redirect" rel="nofollow">超级账本Fabric 1.0 多节点集群的部署</a></strong></span></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;"><span><br></span></strong></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:18px;border-style:none none none solid;border-color:rgb(102,102,102);line-height:25px;border-left-width:10px;background-color:rgb(243,243,243);"><strong><span>《区块链技术指南》介绍</span></strong></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:15px;">更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的<span><strong>《区块链技术指南》</strong></span><strong>，</strong>机械工业出版社：</span><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/VKmSsh8NadZfbGu6EpecqArnOTg6S5ONuANFZFxYgMHwnunThmGCPfjyjtXV3CudjK4HQxTtG4AX9GWLJYWQ0w/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"><br></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="background-color:rgb(255,255,255);">京东购买链接：</span><br></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:18px;background-color:rgb(255,255,255);"><span style="font-size:14px;"><strong><span style="color:rgb(2,30,170);">http://item.jd.com/12007317.html</span></strong></span></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:14px;"><strong><span style="color:rgb(2,30,170);"><br></span></strong></span></p>
   <hr style="color:rgb(62,62,62);font-size:16px;">
   <p style="min-height:1em;color:rgb(62,62,62);font-size:18px;"><span style="font-size:14px;"><span>欢迎读者们继续在文后点赞、留言交流，</span><strong style="font-size:16px;">亨利笔记</strong><span>主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp;</span></span></p>
   <img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz/VKmSsh8NadafdodhmiaAia3WZZIQsUTbdKQ8ZkBbPvEfbHazZ66yYiaicw1CAkP3UWDYvlWHX4gvT7PUymIP4LCTNw/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p><br></p> 
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/q48S71bCzBeYLOu9T0n/article/details/77988159,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/q48S71bCzBeYLOu9T0n/article/details/77988159,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
