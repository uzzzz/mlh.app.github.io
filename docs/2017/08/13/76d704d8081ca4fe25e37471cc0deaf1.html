<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>用Kubernetes部署超级账本Fabric的区块链即服务(1) | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="用Kubernetes部署超级账本Fabric的区块链即服务(1)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="题图摄于旧金山市区：云海中的 Twin Peaks 不久前，我们发表了如何部署多节点 Fabric 1.0集群（可点击）的方法，主要是描述手动部署的步骤。在本次连载中，我们将探讨如何把 Fabric v1.0自动化部署在现今最流行的 Kubernetes 容器平台上，从而实现对分布式区块链平台的管理和监控等功能。 关注本公众号的读者可能发现，笔者主要研究区块链和云原生应用两个方面。看似不太相关的两领域，在本文中得到完美结合，印证了笔者经常分享的一句话：做技术总有会师的时候！ 本文编写过程中，我们团队的工程师贾燚星对 Kubernetes 部分给出了建议和纠正，在此表示感谢。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 概述 盼望着，盼望着，超级账本 Fabric 1.0 正式来了，社区用户为之欢呼雀跃：终于等到一个企业级区块链应用平台了。然而在激动过后，回归平静之时，人们却往往发现，搭建Fabric平台是个相当披荆斩棘的历程。不仅要具备密码学、分布式计算、共识算法等区块链理论基础，而且要熟悉容器、Golang / Node.js 这些企业用户不常用的工程技术，这常常是很多人把区块链放弃在起跑线的原因。降低使用门槛，提高易用性，将是今后一段时间内推广企业区块链应用的重要工作。 &nbsp; 之前我们的文章描述过安装部署多节点 Fabric 集群的步骤，旨在说明Fabric基本的运作原理，因此部署过程是手 &nbsp;(cao) &nbsp;动 &nbsp;(gen) &nbsp;的安装方式。在实际的开发测试中，需要自动化部署来提高效率，本文介绍如何利用容器平台Kubernetes（K8s）来自动部署 Fabric 1.0，实现区块链即服务 (Blockchain as a Service, BaaS) 的基础。 &nbsp; 需要指出的是，BaaS目前多用于开发测试，即在同一个BaaS平台，部署多个区块链节点，每个节点代表不同组织机构。这样显然是中心化的部署方式，只能用于开发测试用途。真实环境的部署需要分布在网络中多个BaaS协同工作才能完成，这是另外一个尚待完善的工作。 &nbsp; 我们选择把 Fabric 部署在 K8s 上有几个原因。首先 Fabric 的组件都经过容器封装好的，很方便部署在 K8s 这类容器平台上，并借助平台实现高可用、监控管理、自动化运维等目的。 其次，Fabric 是分布式系统，根据应用的具体需求，集群的各个组件数会有不同，需要灵活地配置和调整。而 K8s 是面向微服务架构的容器平台，扩展方便，能够很好地满足 Fabric 这方面的要求。 还有就是 K8s 具备了多租户的能力，可在同一个平台中运行多个互相隔离的 Fabric 实例，方便开发测试，比如一个实例作为开发用，另一个实例作为测试用。 &nbsp; 在超级账本中有个子项目叫 Cello ，其目的是提供 Hyperledger 的 BaaS 。据了解，目前已经支持把 Fabric 部署在 Docker 和 Swarm 上，有关 K8s 的支持还在开发中。由于 Fabric 的设计中没有考虑到 K8s 等平台的特点，因此把 Fabric 部署在 K8s 上还需要一些变通的处理方法，后文相关部分会提到。 &nbsp; 整体架构 2.1 基础设施 &nbsp; 1) &nbsp; 网络部分 &nbsp; Kubernetes 集群由多个节点组成，为使得集群上的容器正常通信，需要创建一个 overlay 网络，并把集群上的容器都连接到这个网络上。 图 2- 1&nbsp; 如图2-1所示，宿主机网络由蓝色线标记，节点有 cmd 客户机, Kubernetes 的 master 和 worker ，还有 NFS 服务器。其中，cmd 客户机作为操作 K8S和 Fabric 集群的命令行客户机。NFS服务器在各个节点间用于共享 Fabric 和 K8s 的各种配置文件，也可以用其他 K8s 支持的共享存储代替。 &nbsp; 通过 Kubernetes 的 cluster add-ons 可以很方便地创建 overlay 网络，如 Flannel 。如图 2-1的红色线所示(为说明Flannel作用省去部分细节)，Kubernetes 把所有pod加入到 Flannel 网络中，因此 pod 中的容器可以相互通信。 Flannel网络的地址段可以在 add-on 的配置文件中指定，同时 kube_dns 的 IP 地址也可以通过配置修改，但该IP地址必须处于指定地址段中。如图2-1中 Flannel 的网络为10.0.0.1/16，kube_dns 的 IP 地址为10.0.0.10。 在 Fabric 设计中， chaincode 目前是以 Docker 容器的方式运行在 peer 容器所在的宿主机上，peer 容器需要调用 Docker 引擎的接口来构建和创建chaincode 容器，调用接口是通过这个连接： unix:///var/run/docker.sock 这种方式其实是有安全隐患的，这里不作过多讨论。正确的姿势应该是调用chaincode 专用的运行环境，如新起一个 Docker Host ，用 TCP 接口远程调用。 &nbsp; 通过docker.sock 创建的容器脱离在 Kubernetes 的体系之外，虽然它仍在 Flannel 的网络上，但却无法获得 peer 节点的 IP 地址。这是因为创建该容器的 Docker 引擎使用宿主机默认的 DNS 解析来 peer 的域名，所以无法找到。 &nbsp; 为了解决解析域名的问题，需要在每个 worker 的 DOCKER_OPTS 中加入相关参数，以图 2-1为例，kube_dns 的 IP 为10.0.0.10，宿主机网络 DNS 的 IP 地址假设为192.168.0.1，为使得 chaincode 的容器可以解析到 peer 节点，修改步骤如下： &nbsp; 1. 编辑 /etc/default/docker，在 DOCKER_OPTS 中添加以下参数，设置 Kubernetes 使用的 DNS （很重要！）: &quot;--dns=10.0.0.10 --dns=192.168.0.1&nbsp; --dns-search \&nbsp; default.svc.cluster.local--dns-search svc.cluster.local \--dns-opt ndots:2 --dns-opt timeout:2 --dns-opt attempts:2&quot; &nbsp; 2. 运行以下命令重启Docker (注: 不同的Linux环境中命令可能会有不同)： systemctl daemon-reload systemctl restart docker systemctl restart docker.service 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】&nbsp; 2) &nbsp;共享存储 &nbsp; K8s 和 Fabric 集群需要较多的配置文件，为方便管理，可通过 NFS 服务器来统一储存这些文件，如图 2-1所示。 &nbsp; cmd客户机可通过 cryptogen 工具生成 crypto-config 目录，该用于储存 Fabric 集群中节点的配置文件，如 peer0.org1 所用到的 msp 存放在以下目录： &nbsp; crypto-config/PeerOrganization/org1/peers/peer0/msp &nbsp; cmd客户机只需要把 NFS 的共享目录挂载到本地 /opt/share/ ，再把 crypto-config 写到该目录，即可让各个节点访问到配置文件。 &nbsp; 在 Kubernetes 中，通过 PV 和 PVC 来把 NFS 上的文件挂载到容器中，除了创建相应的 PV 和 PVC 外，还需在节点的配置文件中把正确的路径挂载进去。若NFS 服务器的共享目录为 /opt/share ，创建 PV 时可指定 peer.org1 的挂载点为：&nbsp;&nbsp; &nbsp; /opt/share/crypto-config/PeerOrganization/org1/ &nbsp; 然后创建与该 PV 相对应的 PVC ，这样在节点的配置文件中就可以使用 PVC 来挂载这个目录。节点需要根据自己的 ID 在挂载点后面加上相应的路径来保证挂载的配置文件无误，如 peer0.org1 应在路径后加上 peers/peer0/msp ，则其挂载目录的完整路径如下： &nbsp; /opt/share/crypto-config/PeerOrganization/org1/peers/peer0/msp &nbsp; 2.2 &nbsp;组件划分 &nbsp; 在 Kubernetes 中，Namespace 是一个很重要的概念，它用于划分不同的虚拟集群，而 Fabric 中 organization 基于证书签发机构划分，把 K8S 的 namespace 与 Fabric 的 organization 对应，既使得 organization 之间相互独立，又充分利用了 K8S 的 DNS 服务，各个 organization 可以通过域名区分。采用 namespace 分隔各个组织的组件，还可实现网络策略 (network policy) 来隔离不同组织，实现多租户的能力 (本文未涉及)。 图 2- 2 如图 2-2所示，假设 Fabric 网络中有多个 peer organization 和 orderer organization ，下面阐述如何在 Kubernetes 进行划分和对应： a.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 peer organization 的域名为 orgN，则其在 Kubernetes 上对应的 namespace 设置为 orgN ，在该 namespace 下有多个 pod，pod 的类型如下： 1)&nbsp;&nbsp;&nbsp;Peer Pod：包括 Fabric peer，couchDB （可选），代表每个组织的 peer节点。 2)&nbsp;&nbsp;&nbsp;CA Server Pod： Fabric CA Server。 3)&nbsp;&nbsp;&nbsp;CLI Pod：（可选）提供命令行工具的环境，用于操作本组织的节点、channel 或 chaincode。 &nbsp; b.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 orderer organization 的域名为 orgordererN ，则其在Kubernetes 上对应的 namespace 为 orgordererN ，该 namespace 下只有一种 &nbsp;Pod ，它用于运行 orderer 节点。 &nbsp; c.&nbsp;&nbsp;&nbsp;Kafka namespace 与 Fabric 的 organization 并无关系，它只用来运行和管理Zookeeper和Kafka容器，实现共识算法。 2.3&nbsp; Pod之间的通信 Kubernetes&nbsp;中的每个&nbsp;Pod&nbsp;都有独立的&nbsp;IP&nbsp;地址，然而在各个&nbsp;Pod&nbsp;之间直接通过&nbsp;IP:port&nbsp;的方式来通信会带来很多麻烦，因此有必要给每一个&nbsp;Pod&nbsp;绑定一个的&nbsp;service&nbsp;，以便用&nbsp;service&nbsp;名称来访问。 &nbsp; service&nbsp;的命名方式应当遵循以下原则，彰显与其绑定的&nbsp;Pod&nbsp;信息： 1)&nbsp;&nbsp;&nbsp;service&nbsp;与&nbsp;pod&nbsp;的&nbsp;namespace&nbsp;应当一致。 2)&nbsp;&nbsp;&nbsp;service&nbsp;的&nbsp;name&nbsp;应与&nbsp;Pod&nbsp;中容器的&nbsp;id&nbsp;一致。 &nbsp; 例如，Fabric&nbsp;中属于&nbsp;org1&nbsp;的&nbsp;peer0&nbsp;节点，在&nbsp;K8S&nbsp;中用&nbsp;namespace&nbsp;为&nbsp;org1、名字为&nbsp;peer0&nbsp;的&nbsp;Pod&nbsp;来运行，与该&nbsp;Pod&nbsp;绑定的&nbsp;service&nbsp;全称应为&nbsp;peer0.org1&nbsp;。其中&nbsp;peer0&nbsp;为&nbsp;service&nbsp;的名称，org1&nbsp;为&nbsp;service&nbsp;的&nbsp;namespace&nbsp;。这样的映射关系已经和主机域名很接近了。 （未完待续） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多" />
<meta property="og:description" content="题图摄于旧金山市区：云海中的 Twin Peaks 不久前，我们发表了如何部署多节点 Fabric 1.0集群（可点击）的方法，主要是描述手动部署的步骤。在本次连载中，我们将探讨如何把 Fabric v1.0自动化部署在现今最流行的 Kubernetes 容器平台上，从而实现对分布式区块链平台的管理和监控等功能。 关注本公众号的读者可能发现，笔者主要研究区块链和云原生应用两个方面。看似不太相关的两领域，在本文中得到完美结合，印证了笔者经常分享的一句话：做技术总有会师的时候！ 本文编写过程中，我们团队的工程师贾燚星对 Kubernetes 部分给出了建议和纠正，在此表示感谢。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 概述 盼望着，盼望着，超级账本 Fabric 1.0 正式来了，社区用户为之欢呼雀跃：终于等到一个企业级区块链应用平台了。然而在激动过后，回归平静之时，人们却往往发现，搭建Fabric平台是个相当披荆斩棘的历程。不仅要具备密码学、分布式计算、共识算法等区块链理论基础，而且要熟悉容器、Golang / Node.js 这些企业用户不常用的工程技术，这常常是很多人把区块链放弃在起跑线的原因。降低使用门槛，提高易用性，将是今后一段时间内推广企业区块链应用的重要工作。 &nbsp; 之前我们的文章描述过安装部署多节点 Fabric 集群的步骤，旨在说明Fabric基本的运作原理，因此部署过程是手 &nbsp;(cao) &nbsp;动 &nbsp;(gen) &nbsp;的安装方式。在实际的开发测试中，需要自动化部署来提高效率，本文介绍如何利用容器平台Kubernetes（K8s）来自动部署 Fabric 1.0，实现区块链即服务 (Blockchain as a Service, BaaS) 的基础。 &nbsp; 需要指出的是，BaaS目前多用于开发测试，即在同一个BaaS平台，部署多个区块链节点，每个节点代表不同组织机构。这样显然是中心化的部署方式，只能用于开发测试用途。真实环境的部署需要分布在网络中多个BaaS协同工作才能完成，这是另外一个尚待完善的工作。 &nbsp; 我们选择把 Fabric 部署在 K8s 上有几个原因。首先 Fabric 的组件都经过容器封装好的，很方便部署在 K8s 这类容器平台上，并借助平台实现高可用、监控管理、自动化运维等目的。 其次，Fabric 是分布式系统，根据应用的具体需求，集群的各个组件数会有不同，需要灵活地配置和调整。而 K8s 是面向微服务架构的容器平台，扩展方便，能够很好地满足 Fabric 这方面的要求。 还有就是 K8s 具备了多租户的能力，可在同一个平台中运行多个互相隔离的 Fabric 实例，方便开发测试，比如一个实例作为开发用，另一个实例作为测试用。 &nbsp; 在超级账本中有个子项目叫 Cello ，其目的是提供 Hyperledger 的 BaaS 。据了解，目前已经支持把 Fabric 部署在 Docker 和 Swarm 上，有关 K8s 的支持还在开发中。由于 Fabric 的设计中没有考虑到 K8s 等平台的特点，因此把 Fabric 部署在 K8s 上还需要一些变通的处理方法，后文相关部分会提到。 &nbsp; 整体架构 2.1 基础设施 &nbsp; 1) &nbsp; 网络部分 &nbsp; Kubernetes 集群由多个节点组成，为使得集群上的容器正常通信，需要创建一个 overlay 网络，并把集群上的容器都连接到这个网络上。 图 2- 1&nbsp; 如图2-1所示，宿主机网络由蓝色线标记，节点有 cmd 客户机, Kubernetes 的 master 和 worker ，还有 NFS 服务器。其中，cmd 客户机作为操作 K8S和 Fabric 集群的命令行客户机。NFS服务器在各个节点间用于共享 Fabric 和 K8s 的各种配置文件，也可以用其他 K8s 支持的共享存储代替。 &nbsp; 通过 Kubernetes 的 cluster add-ons 可以很方便地创建 overlay 网络，如 Flannel 。如图 2-1的红色线所示(为说明Flannel作用省去部分细节)，Kubernetes 把所有pod加入到 Flannel 网络中，因此 pod 中的容器可以相互通信。 Flannel网络的地址段可以在 add-on 的配置文件中指定，同时 kube_dns 的 IP 地址也可以通过配置修改，但该IP地址必须处于指定地址段中。如图2-1中 Flannel 的网络为10.0.0.1/16，kube_dns 的 IP 地址为10.0.0.10。 在 Fabric 设计中， chaincode 目前是以 Docker 容器的方式运行在 peer 容器所在的宿主机上，peer 容器需要调用 Docker 引擎的接口来构建和创建chaincode 容器，调用接口是通过这个连接： unix:///var/run/docker.sock 这种方式其实是有安全隐患的，这里不作过多讨论。正确的姿势应该是调用chaincode 专用的运行环境，如新起一个 Docker Host ，用 TCP 接口远程调用。 &nbsp; 通过docker.sock 创建的容器脱离在 Kubernetes 的体系之外，虽然它仍在 Flannel 的网络上，但却无法获得 peer 节点的 IP 地址。这是因为创建该容器的 Docker 引擎使用宿主机默认的 DNS 解析来 peer 的域名，所以无法找到。 &nbsp; 为了解决解析域名的问题，需要在每个 worker 的 DOCKER_OPTS 中加入相关参数，以图 2-1为例，kube_dns 的 IP 为10.0.0.10，宿主机网络 DNS 的 IP 地址假设为192.168.0.1，为使得 chaincode 的容器可以解析到 peer 节点，修改步骤如下： &nbsp; 1. 编辑 /etc/default/docker，在 DOCKER_OPTS 中添加以下参数，设置 Kubernetes 使用的 DNS （很重要！）: &quot;--dns=10.0.0.10 --dns=192.168.0.1&nbsp; --dns-search \&nbsp; default.svc.cluster.local--dns-search svc.cluster.local \--dns-opt ndots:2 --dns-opt timeout:2 --dns-opt attempts:2&quot; &nbsp; 2. 运行以下命令重启Docker (注: 不同的Linux环境中命令可能会有不同)： systemctl daemon-reload systemctl restart docker systemctl restart docker.service 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】&nbsp; 2) &nbsp;共享存储 &nbsp; K8s 和 Fabric 集群需要较多的配置文件，为方便管理，可通过 NFS 服务器来统一储存这些文件，如图 2-1所示。 &nbsp; cmd客户机可通过 cryptogen 工具生成 crypto-config 目录，该用于储存 Fabric 集群中节点的配置文件，如 peer0.org1 所用到的 msp 存放在以下目录： &nbsp; crypto-config/PeerOrganization/org1/peers/peer0/msp &nbsp; cmd客户机只需要把 NFS 的共享目录挂载到本地 /opt/share/ ，再把 crypto-config 写到该目录，即可让各个节点访问到配置文件。 &nbsp; 在 Kubernetes 中，通过 PV 和 PVC 来把 NFS 上的文件挂载到容器中，除了创建相应的 PV 和 PVC 外，还需在节点的配置文件中把正确的路径挂载进去。若NFS 服务器的共享目录为 /opt/share ，创建 PV 时可指定 peer.org1 的挂载点为：&nbsp;&nbsp; &nbsp; /opt/share/crypto-config/PeerOrganization/org1/ &nbsp; 然后创建与该 PV 相对应的 PVC ，这样在节点的配置文件中就可以使用 PVC 来挂载这个目录。节点需要根据自己的 ID 在挂载点后面加上相应的路径来保证挂载的配置文件无误，如 peer0.org1 应在路径后加上 peers/peer0/msp ，则其挂载目录的完整路径如下： &nbsp; /opt/share/crypto-config/PeerOrganization/org1/peers/peer0/msp &nbsp; 2.2 &nbsp;组件划分 &nbsp; 在 Kubernetes 中，Namespace 是一个很重要的概念，它用于划分不同的虚拟集群，而 Fabric 中 organization 基于证书签发机构划分，把 K8S 的 namespace 与 Fabric 的 organization 对应，既使得 organization 之间相互独立，又充分利用了 K8S 的 DNS 服务，各个 organization 可以通过域名区分。采用 namespace 分隔各个组织的组件，还可实现网络策略 (network policy) 来隔离不同组织，实现多租户的能力 (本文未涉及)。 图 2- 2 如图 2-2所示，假设 Fabric 网络中有多个 peer organization 和 orderer organization ，下面阐述如何在 Kubernetes 进行划分和对应： a.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 peer organization 的域名为 orgN，则其在 Kubernetes 上对应的 namespace 设置为 orgN ，在该 namespace 下有多个 pod，pod 的类型如下： 1)&nbsp;&nbsp;&nbsp;Peer Pod：包括 Fabric peer，couchDB （可选），代表每个组织的 peer节点。 2)&nbsp;&nbsp;&nbsp;CA Server Pod： Fabric CA Server。 3)&nbsp;&nbsp;&nbsp;CLI Pod：（可选）提供命令行工具的环境，用于操作本组织的节点、channel 或 chaincode。 &nbsp; b.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 orderer organization 的域名为 orgordererN ，则其在Kubernetes 上对应的 namespace 为 orgordererN ，该 namespace 下只有一种 &nbsp;Pod ，它用于运行 orderer 节点。 &nbsp; c.&nbsp;&nbsp;&nbsp;Kafka namespace 与 Fabric 的 organization 并无关系，它只用来运行和管理Zookeeper和Kafka容器，实现共识算法。 2.3&nbsp; Pod之间的通信 Kubernetes&nbsp;中的每个&nbsp;Pod&nbsp;都有独立的&nbsp;IP&nbsp;地址，然而在各个&nbsp;Pod&nbsp;之间直接通过&nbsp;IP:port&nbsp;的方式来通信会带来很多麻烦，因此有必要给每一个&nbsp;Pod&nbsp;绑定一个的&nbsp;service&nbsp;，以便用&nbsp;service&nbsp;名称来访问。 &nbsp; service&nbsp;的命名方式应当遵循以下原则，彰显与其绑定的&nbsp;Pod&nbsp;信息： 1)&nbsp;&nbsp;&nbsp;service&nbsp;与&nbsp;pod&nbsp;的&nbsp;namespace&nbsp;应当一致。 2)&nbsp;&nbsp;&nbsp;service&nbsp;的&nbsp;name&nbsp;应与&nbsp;Pod&nbsp;中容器的&nbsp;id&nbsp;一致。 &nbsp; 例如，Fabric&nbsp;中属于&nbsp;org1&nbsp;的&nbsp;peer0&nbsp;节点，在&nbsp;K8S&nbsp;中用&nbsp;namespace&nbsp;为&nbsp;org1、名字为&nbsp;peer0&nbsp;的&nbsp;Pod&nbsp;来运行，与该&nbsp;Pod&nbsp;绑定的&nbsp;service&nbsp;全称应为&nbsp;peer0.org1&nbsp;。其中&nbsp;peer0&nbsp;为&nbsp;service&nbsp;的名称，org1&nbsp;为&nbsp;service&nbsp;的&nbsp;namespace&nbsp;。这样的映射关系已经和主机域名很接近了。 （未完待续） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/08/13/76d704d8081ca4fe25e37471cc0deaf1.html" />
<meta property="og:url" content="https://mlh.app/2017/08/13/76d704d8081ca4fe25e37471cc0deaf1.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-08-13T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"题图摄于旧金山市区：云海中的 Twin Peaks 不久前，我们发表了如何部署多节点 Fabric 1.0集群（可点击）的方法，主要是描述手动部署的步骤。在本次连载中，我们将探讨如何把 Fabric v1.0自动化部署在现今最流行的 Kubernetes 容器平台上，从而实现对分布式区块链平台的管理和监控等功能。 关注本公众号的读者可能发现，笔者主要研究区块链和云原生应用两个方面。看似不太相关的两领域，在本文中得到完美结合，印证了笔者经常分享的一句话：做技术总有会师的时候！ 本文编写过程中，我们团队的工程师贾燚星对 Kubernetes 部分给出了建议和纠正，在此表示感谢。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 概述 盼望着，盼望着，超级账本 Fabric 1.0 正式来了，社区用户为之欢呼雀跃：终于等到一个企业级区块链应用平台了。然而在激动过后，回归平静之时，人们却往往发现，搭建Fabric平台是个相当披荆斩棘的历程。不仅要具备密码学、分布式计算、共识算法等区块链理论基础，而且要熟悉容器、Golang / Node.js 这些企业用户不常用的工程技术，这常常是很多人把区块链放弃在起跑线的原因。降低使用门槛，提高易用性，将是今后一段时间内推广企业区块链应用的重要工作。 &nbsp; 之前我们的文章描述过安装部署多节点 Fabric 集群的步骤，旨在说明Fabric基本的运作原理，因此部署过程是手 &nbsp;(cao) &nbsp;动 &nbsp;(gen) &nbsp;的安装方式。在实际的开发测试中，需要自动化部署来提高效率，本文介绍如何利用容器平台Kubernetes（K8s）来自动部署 Fabric 1.0，实现区块链即服务 (Blockchain as a Service, BaaS) 的基础。 &nbsp; 需要指出的是，BaaS目前多用于开发测试，即在同一个BaaS平台，部署多个区块链节点，每个节点代表不同组织机构。这样显然是中心化的部署方式，只能用于开发测试用途。真实环境的部署需要分布在网络中多个BaaS协同工作才能完成，这是另外一个尚待完善的工作。 &nbsp; 我们选择把 Fabric 部署在 K8s 上有几个原因。首先 Fabric 的组件都经过容器封装好的，很方便部署在 K8s 这类容器平台上，并借助平台实现高可用、监控管理、自动化运维等目的。 其次，Fabric 是分布式系统，根据应用的具体需求，集群的各个组件数会有不同，需要灵活地配置和调整。而 K8s 是面向微服务架构的容器平台，扩展方便，能够很好地满足 Fabric 这方面的要求。 还有就是 K8s 具备了多租户的能力，可在同一个平台中运行多个互相隔离的 Fabric 实例，方便开发测试，比如一个实例作为开发用，另一个实例作为测试用。 &nbsp; 在超级账本中有个子项目叫 Cello ，其目的是提供 Hyperledger 的 BaaS 。据了解，目前已经支持把 Fabric 部署在 Docker 和 Swarm 上，有关 K8s 的支持还在开发中。由于 Fabric 的设计中没有考虑到 K8s 等平台的特点，因此把 Fabric 部署在 K8s 上还需要一些变通的处理方法，后文相关部分会提到。 &nbsp; 整体架构 2.1 基础设施 &nbsp; 1) &nbsp; 网络部分 &nbsp; Kubernetes 集群由多个节点组成，为使得集群上的容器正常通信，需要创建一个 overlay 网络，并把集群上的容器都连接到这个网络上。 图 2- 1&nbsp; 如图2-1所示，宿主机网络由蓝色线标记，节点有 cmd 客户机, Kubernetes 的 master 和 worker ，还有 NFS 服务器。其中，cmd 客户机作为操作 K8S和 Fabric 集群的命令行客户机。NFS服务器在各个节点间用于共享 Fabric 和 K8s 的各种配置文件，也可以用其他 K8s 支持的共享存储代替。 &nbsp; 通过 Kubernetes 的 cluster add-ons 可以很方便地创建 overlay 网络，如 Flannel 。如图 2-1的红色线所示(为说明Flannel作用省去部分细节)，Kubernetes 把所有pod加入到 Flannel 网络中，因此 pod 中的容器可以相互通信。 Flannel网络的地址段可以在 add-on 的配置文件中指定，同时 kube_dns 的 IP 地址也可以通过配置修改，但该IP地址必须处于指定地址段中。如图2-1中 Flannel 的网络为10.0.0.1/16，kube_dns 的 IP 地址为10.0.0.10。 在 Fabric 设计中， chaincode 目前是以 Docker 容器的方式运行在 peer 容器所在的宿主机上，peer 容器需要调用 Docker 引擎的接口来构建和创建chaincode 容器，调用接口是通过这个连接： unix:///var/run/docker.sock 这种方式其实是有安全隐患的，这里不作过多讨论。正确的姿势应该是调用chaincode 专用的运行环境，如新起一个 Docker Host ，用 TCP 接口远程调用。 &nbsp; 通过docker.sock 创建的容器脱离在 Kubernetes 的体系之外，虽然它仍在 Flannel 的网络上，但却无法获得 peer 节点的 IP 地址。这是因为创建该容器的 Docker 引擎使用宿主机默认的 DNS 解析来 peer 的域名，所以无法找到。 &nbsp; 为了解决解析域名的问题，需要在每个 worker 的 DOCKER_OPTS 中加入相关参数，以图 2-1为例，kube_dns 的 IP 为10.0.0.10，宿主机网络 DNS 的 IP 地址假设为192.168.0.1，为使得 chaincode 的容器可以解析到 peer 节点，修改步骤如下： &nbsp; 1. 编辑 /etc/default/docker，在 DOCKER_OPTS 中添加以下参数，设置 Kubernetes 使用的 DNS （很重要！）: &quot;--dns=10.0.0.10 --dns=192.168.0.1&nbsp; --dns-search \\&nbsp; default.svc.cluster.local--dns-search svc.cluster.local \\--dns-opt ndots:2 --dns-opt timeout:2 --dns-opt attempts:2&quot; &nbsp; 2. 运行以下命令重启Docker (注: 不同的Linux环境中命令可能会有不同)： systemctl daemon-reload systemctl restart docker systemctl restart docker.service 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】&nbsp; 2) &nbsp;共享存储 &nbsp; K8s 和 Fabric 集群需要较多的配置文件，为方便管理，可通过 NFS 服务器来统一储存这些文件，如图 2-1所示。 &nbsp; cmd客户机可通过 cryptogen 工具生成 crypto-config 目录，该用于储存 Fabric 集群中节点的配置文件，如 peer0.org1 所用到的 msp 存放在以下目录： &nbsp; crypto-config/PeerOrganization/org1/peers/peer0/msp &nbsp; cmd客户机只需要把 NFS 的共享目录挂载到本地 /opt/share/ ，再把 crypto-config 写到该目录，即可让各个节点访问到配置文件。 &nbsp; 在 Kubernetes 中，通过 PV 和 PVC 来把 NFS 上的文件挂载到容器中，除了创建相应的 PV 和 PVC 外，还需在节点的配置文件中把正确的路径挂载进去。若NFS 服务器的共享目录为 /opt/share ，创建 PV 时可指定 peer.org1 的挂载点为：&nbsp;&nbsp; &nbsp; /opt/share/crypto-config/PeerOrganization/org1/ &nbsp; 然后创建与该 PV 相对应的 PVC ，这样在节点的配置文件中就可以使用 PVC 来挂载这个目录。节点需要根据自己的 ID 在挂载点后面加上相应的路径来保证挂载的配置文件无误，如 peer0.org1 应在路径后加上 peers/peer0/msp ，则其挂载目录的完整路径如下： &nbsp; /opt/share/crypto-config/PeerOrganization/org1/peers/peer0/msp &nbsp; 2.2 &nbsp;组件划分 &nbsp; 在 Kubernetes 中，Namespace 是一个很重要的概念，它用于划分不同的虚拟集群，而 Fabric 中 organization 基于证书签发机构划分，把 K8S 的 namespace 与 Fabric 的 organization 对应，既使得 organization 之间相互独立，又充分利用了 K8S 的 DNS 服务，各个 organization 可以通过域名区分。采用 namespace 分隔各个组织的组件，还可实现网络策略 (network policy) 来隔离不同组织，实现多租户的能力 (本文未涉及)。 图 2- 2 如图 2-2所示，假设 Fabric 网络中有多个 peer organization 和 orderer organization ，下面阐述如何在 Kubernetes 进行划分和对应： a.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 peer organization 的域名为 orgN，则其在 Kubernetes 上对应的 namespace 设置为 orgN ，在该 namespace 下有多个 pod，pod 的类型如下： 1)&nbsp;&nbsp;&nbsp;Peer Pod：包括 Fabric peer，couchDB （可选），代表每个组织的 peer节点。 2)&nbsp;&nbsp;&nbsp;CA Server Pod： Fabric CA Server。 3)&nbsp;&nbsp;&nbsp;CLI Pod：（可选）提供命令行工具的环境，用于操作本组织的节点、channel 或 chaincode。 &nbsp; b.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 orderer organization 的域名为 orgordererN ，则其在Kubernetes 上对应的 namespace 为 orgordererN ，该 namespace 下只有一种 &nbsp;Pod ，它用于运行 orderer 节点。 &nbsp; c.&nbsp;&nbsp;&nbsp;Kafka namespace 与 Fabric 的 organization 并无关系，它只用来运行和管理Zookeeper和Kafka容器，实现共识算法。 2.3&nbsp; Pod之间的通信 Kubernetes&nbsp;中的每个&nbsp;Pod&nbsp;都有独立的&nbsp;IP&nbsp;地址，然而在各个&nbsp;Pod&nbsp;之间直接通过&nbsp;IP:port&nbsp;的方式来通信会带来很多麻烦，因此有必要给每一个&nbsp;Pod&nbsp;绑定一个的&nbsp;service&nbsp;，以便用&nbsp;service&nbsp;名称来访问。 &nbsp; service&nbsp;的命名方式应当遵循以下原则，彰显与其绑定的&nbsp;Pod&nbsp;信息： 1)&nbsp;&nbsp;&nbsp;service&nbsp;与&nbsp;pod&nbsp;的&nbsp;namespace&nbsp;应当一致。 2)&nbsp;&nbsp;&nbsp;service&nbsp;的&nbsp;name&nbsp;应与&nbsp;Pod&nbsp;中容器的&nbsp;id&nbsp;一致。 &nbsp; 例如，Fabric&nbsp;中属于&nbsp;org1&nbsp;的&nbsp;peer0&nbsp;节点，在&nbsp;K8S&nbsp;中用&nbsp;namespace&nbsp;为&nbsp;org1、名字为&nbsp;peer0&nbsp;的&nbsp;Pod&nbsp;来运行，与该&nbsp;Pod&nbsp;绑定的&nbsp;service&nbsp;全称应为&nbsp;peer0.org1&nbsp;。其中&nbsp;peer0&nbsp;为&nbsp;service&nbsp;的名称，org1&nbsp;为&nbsp;service&nbsp;的&nbsp;namespace&nbsp;。这样的映射关系已经和主机域名很接近了。 （未完待续） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/08/13/76d704d8081ca4fe25e37471cc0deaf1.html","headline":"用Kubernetes部署超级账本Fabric的区块链即服务(1)","dateModified":"2017-08-13T00:00:00+08:00","datePublished":"2017-08-13T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/08/13/76d704d8081ca4fe25e37471cc0deaf1.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>用Kubernetes部署超级账本Fabric的区块链即服务(1)</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div class="rich_media_content"> 
   <p><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/VKmSsh8NadaILibSCibKVdFGENOwvfQia76vrYBlzujNWtWnFNl6rqz7foicemFdrqhsza5h0zV4LWU9WB9IHkJpoQ/0?wx_fmt=jpeg" alt="0?wx_fmt=jpeg"></p>
   <p style="text-align:center;"><span style="color:rgb(136,136,136);font-size:12px;">题图摄于旧金山市区：云海中的 Twin Peaks</span></p>
   <p><br></p>
   <blockquote>
    <p style="margin-left:8px;"><span style="font-size:14px;color:rgb(136,136,136);">不久前，我们发表了如何</span><a href="http://mp.weixin.qq.com/s?__biz=MzAwNzUyNzI5Mw==&amp;mid=2730790527&amp;idx=1&amp;sn=3b9ecce4440b168cddfb385215b3622a&amp;chksm=bc4ce06d8b3b697ba772d8e742aeac6958c830c2f0570b5cbe53ebe5ec35521595045ca15b14&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:14px;color:rgb(0,82,255);"><span style="font-size:14px;color:rgb(0,82,255);">部署多节点 Fabric 1.0集群</span></a><span style="font-size:14px;color:rgb(136,136,136);">（可点击）的方法，主要是描述手动部署的步骤。在本次连载中，我们将探讨如何把 Fabric v1.0自动化部署在现今最流行的 Kubernetes 容器平台上，从而实现对分布式区块链平台的管理和监控等功能。</span></p>
    <p style="margin-left:8px;"><span style="color:rgb(136,136,136);font-size:14px;"><br></span></p>
    <p style="margin-left:8px;"><span style="color:rgb(136,136,136);font-size:14px;">关注本公众号的读者可能发现，笔者主要研究区块链和云原生应用两个方面。看似不太相关的两领域，在本文中得到完美结合，印证了笔者经常分享的一句话：</span><strong style="color:rgb(136,136,136);font-size:14px;">做</strong><strong style="color:rgb(136,136,136);font-size:14px;">技术总有会师的时候！</strong></p>
    <p style="margin-left:8px;"><span style="font-size:14px;color:rgb(136,136,136);"></span><br></p>
    <p style="margin-left:8px;"><span style="font-size:14px;color:rgb(136,136,136);"><span style="color:rgb(136,136,136);font-size:14px;">本文编写过程中，我们</span></span><span style="font-size:14px;color:rgb(136,136,136);">团队的工程师</span><span style="color:rgb(136,136,136);font-size:14px;font-family:'Helvetica Neue';">贾燚星对 Kubernetes 部分给出了建议和纠正，在此表示感谢。</span></p>
   </blockquote>
   <p style="margin-left:8px;"><span style="font-size:14px;"><strong style="color:rgb(62,62,62);font-size:14px;"><br></strong></span></p>
   <p style="margin-left:8px;"><span style="font-size:14px;"><strong style="color:rgb(62,62,62);font-size:14px;">【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“</strong><strong style="font-size:14px;"><span style="color:#021eaa;">区块链即服务</span></strong><strong style="font-size:14px;"><span style="color:#3e3e3e;">”&nbsp;</span><strong><strong><span style="color:#3e3e3e;">或&nbsp;</span><strong><span style="color:#3e3e3e;">“</span><span style="color:#021eaa;">baas</span><span style="color:#3e3e3e;">”</span></strong></strong></strong><span style="color:#3e3e3e;">即可。】</span></strong></span></p>
   <p style="margin-left:8px;"><br></p>
   <p style="color:rgb(62,62,62);font-size:18px;border-style:none none none solid;border-color:rgb(102,102,102);line-height:25px;border-left-width:10px;background-color:rgb(243,243,243);margin-left:8px;"><span><strong>概述</strong></span></p>
   <p style="margin-left:8px;"><strong><span><br></span></strong></p>
   <p style="margin-left:8px;">盼望着，盼望着，超级账本 Fabric 1.0 正式来了，社区用户为之欢呼雀跃：终于等到一个企业级区块链应用平台了。然而在激动过后，回归平静之时，人们却往往发现，搭建Fabric平台是个相当披荆斩棘的历程。不仅要具备密码学、分布式计算、共识算法等区块链理论基础，而且要熟悉容器、Golang / Node.js 这些企业用户不常用的工程技术，这常常是很多人把区块链放弃在起跑线的原因。降低使用门槛，提高易用性，将是今后一段时间内推广企业区块链应用的重要工作。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">之前我们的文章描述过安装部署多节点 Fabric 集群的步骤，旨在说明Fabric基本的运作原理，因此部署过程是手 &nbsp;(cao) &nbsp;动 &nbsp;(gen) &nbsp;的安装方式。在实际的开发测试中，需要自动化部署来提高效率，本文介绍如何利用容器平台Kubernetes（K8s）来自动部署 Fabric 1.0，实现区块链即服务 (Blockchain as a Service, BaaS) 的基础。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">需要指出的是，BaaS目前多用于开发测试，即在同一个BaaS平台，部署多个区块链节点，每个节点代表不同组织机构。这样显然是中心化的部署方式，只能用于开发测试用途。真实环境的部署需要分布在网络中多个BaaS协同工作才能完成，这是另外一个尚待完善的工作。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">我们选择把 Fabric 部署在 K8s 上有几个原因。首先 Fabric 的组件都经过容器封装好的，很方便部署在 K8s 这类容器平台上，并借助平台实现高可用、监控管理、自动化运维等目的。</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">其次，Fabric 是分布式系统，根据应用的具体需求，集群的各个组件数会有不同，需要灵活地配置和调整。而 K8s 是面向微服务架构的容器平台，扩展方便，能够很好地满足 Fabric 这方面的要求。</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">还有就是 K8s 具备了多租户的能力，可在同一个平台中运行多个互相隔离的 Fabric 实例，方便开发测试，比如一个实例作为开发用，另一个实例作为测试用。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">在超级账本中有个子项目叫 Cello ，其目的是提供 Hyperledger 的 BaaS 。据了解，目前已经支持把 Fabric 部署在 Docker 和 Swarm 上，有关 K8s 的支持还在开发中。由于 Fabric 的设计中没有考虑到 K8s 等平台的特点，因此把 Fabric 部署在 K8s 上还需要一些变通的处理方法，后文相关部分会提到。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;color:rgb(62,62,62);font-size:18px;border-style:none none none solid;border-color:rgb(102,102,102);line-height:25px;border-left-width:10px;background-color:rgb(243,243,243);"><span><strong>整体架构</strong></span></p>
   <p><br></p>
   <p style="margin-left:8px;"><span style="font-size:18px;"><strong>2.1 基础设施</strong></span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>1) &nbsp; 网络部分</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">Kubernetes 集群由多个节点组成，为使得集群上的容器正常通信，需要创建一个 overlay 网络，并把集群上的容器都连接到这个网络上。</p>
   <p><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadZYxekUw9ydic1lFTyz6f5zibP6c1zzl1jiaxfibub0EHmEicgAOA2vvHQMLucY6f4KibjjxqkKATOZTssQ/0?wx_fmt=png" alt="0?wx_fmt=png"></p>
   <p style="margin-left:8px;text-align:center;"><span style="color:rgb(136,136,136);font-size:14px;text-align:center;">图 2- 1</span>&nbsp;</p>
   <p style="margin-left:8px;">如图2-1所示，宿主机网络由蓝色线标记，节点有 cmd 客户机, Kubernetes 的 master 和 worker ，还有 NFS 服务器。其中，cmd 客户机作为操作 K8S和 Fabric 集群的命令行客户机。NFS服务器在各个节点间用于共享 Fabric 和 K8s 的各种配置文件，也可以用其他 K8s 支持的共享存储代替。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">通过 Kubernetes 的 cluster add-ons 可以很方便地创建 overlay 网络，如 Flannel 。如图 2-1的红色线所示(为说明Flannel作用省去部分细节)，Kubernetes 把所有pod加入到 Flannel 网络中，因此 pod 中的容器可以相互通信。</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">Flannel网络的地址段可以在 add-on 的配置文件中指定，同时 kube_dns 的 IP 地址也可以通过配置修改，但该IP地址必须处于指定地址段中。如图2-1中 Flannel 的网络为10.0.0.1/16，kube_dns 的 IP 地址为10.0.0.10。</p>
   <p style="margin-left:8px;">在 Fabric 设计中， chaincode 目前是以 Docker 容器的方式运行在 peer 容器所在的宿主机上，peer 容器需要调用 Docker 引擎的接口来构建和创建chaincode 容器，调用接口是通过这个连接：</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;text-align:left;"><span style="color:rgb(217,33,66);font-size:14px;">unix:///var/run/docker.sock</span></p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">这种方式其实是有安全隐患的，这里不作过多讨论。正确的姿势应该是调用chaincode 专用的运行环境，如新起一个 Docker Host ，用 TCP 接口远程调用。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">通过docker.sock 创建的容器脱离在 Kubernetes 的体系之外，虽然它仍在 Flannel 的网络上，但却无法获得 peer 节点的 IP 地址。这是因为创建该容器的 Docker 引擎使用宿主机默认的 DNS 解析来 peer 的域名，所以无法找到。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">为了解决解析域名的问题，需要在每个 worker 的 DOCKER_OPTS 中加入相关参数，以图 2-1为例，kube_dns 的 IP 为10.0.0.10，宿主机网络 DNS 的 IP 地址假设为192.168.0.1，为使得 chaincode 的容器可以解析到 peer 节点，修改步骤如下：</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">1. 编辑<span style="color:rgb(217,33,66);"> /etc/default/docker</span>，在 DOCKER_OPTS 中添加以下参数，设置 Kubernetes 使用的 DNS （很重要！）:</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">"--dns=10.0.0.10 --dns=192.168.0.1&nbsp; --dns-search \&nbsp;</span></p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">default.svc.cluster.local--dns-search svc.cluster.local \<br>--dns-opt ndots:2 --dns-opt timeout:2 --dns-opt attempts:2"</span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">2. 运行以下命令重启Docker (注: 不同的Linux环境中命令可能会有不同)：</p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">systemctl daemon-reload</span></p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">systemctl restart docker</span></p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">systemctl restart docker.service</span></p>
   <p style="margin-left:8px;"><strong style="font-size:14px;color:rgb(62,62,62);"><br></strong></p>
   <p style="margin-left:8px;"><strong><span style="font-size:12px;">【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“<span style="font-size:12px;color:rgb(0,82,255);">区块链即服务</span>”&nbsp;或&nbsp;“<span style="font-size:12px;color:rgb(0,82,255);">baas</span>”即可。】</span><span style="font-size:12px;">&nbsp;</span></strong></p>
   <p style="margin-left:8px;"><strong><br></strong></p>
   <p style="margin-left:8px;"><strong>2) &nbsp;共享存储</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">K8s 和 Fabric 集群需要较多的配置文件，为方便管理，可通过 NFS 服务器来统一储存这些文件，如图 2-1所示。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">cmd客户机可通过 cryptogen 工具生成 crypto-config 目录，该用于储存 Fabric 集群中节点的配置文件，如 peer0.org1 所用到的 msp 存放在以下目录：</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><span style="font-size:14px;color:rgb(217,33,66);">crypto-config/PeerOrganization/org1/peers/peer0/msp</span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">cmd客户机只需要把 NFS 的共享目录挂载到本地 /opt/share/ ，再把 crypto-config 写到该目录，即可让各个节点访问到配置文件。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">在 Kubernetes 中，通过 PV 和 PVC 来把 NFS 上的文件挂载到容器中，除了创建相应的 PV 和 PVC 外，还需在节点的配置文件中把正确的路径挂载进去。若NFS 服务器的共享目录为 /opt/share ，创建 PV 时可指定 peer.org1 的挂载点为：&nbsp;&nbsp;</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">/opt/share/crypto-config/PeerOrganization/org1/</span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">然后创建与该 PV 相对应的 PVC ，这样在节点的配置文件中就可以使用 PVC 来挂载这个目录。节点需要根据自己的 ID 在挂载点后面加上相应的路径来保证挂载的配置文件无误，如 peer0.org1 应在路径后加上 peers/peer0/msp ，则其挂载目录的完整路径如下：</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><span style="color:rgb(217,33,66);font-size:12px;">/opt/share/crypto-config/PeerOrganization/org1/peers/peer0/msp</span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong><span style="font-size:18px;">2.2 &nbsp;组件划分</span></strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">在 Kubernetes 中，Namespace 是一个很重要的概念，它用于划分不同的虚拟集群，而 Fabric 中 organization 基于证书签发机构划分，把 K8S 的 namespace 与 Fabric 的 organization 对应，既使得 organization 之间相互独立，又充分利用了 K8S 的 DNS 服务，各个 organization 可以通过域名区分。采用 namespace 分隔各个组织的组件，还可实现网络策略 (network policy) 来隔离不同组织，实现多租户的能力 (本文未涉及)。</p>
   <p><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadZYxekUw9ydic1lFTyz6f5zibKdiaGgRy8ugrMyg1SP23oYgxg56aXb5u3q5OjXxUYb6OzOAwRTllB0w/0?wx_fmt=png" alt="0?wx_fmt=png"></p>
   <p style="margin-left:8px;text-align:center;"><span style="font-size:14px;color:rgb(136,136,136);">图 2- 2</span></p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">如图 2-2所示，假设 Fabric 网络中有多个 peer organization 和 orderer organization ，下面阐述如何在 Kubernetes 进行划分和对应：</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">a.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 peer organization 的域名为 orgN，则其在 Kubernetes 上对应的 namespace 设置为 orgN ，在该 namespace 下有多个 pod，pod 的类型如下：</p>
   <p style="margin-left:8px;">1)&nbsp;&nbsp;&nbsp;Peer Pod：包括 Fabric peer，couchDB （可选），代表每个组织的 peer节点。</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">2)&nbsp;&nbsp;&nbsp;CA Server Pod： Fabric CA Server。</p>
   <p style="margin-left:8px;"><br></p>
   <p style="margin-left:8px;">3)&nbsp;&nbsp;&nbsp;CLI Pod：（可选）提供命令行工具的环境，用于操作本组织的节点、channel 或 chaincode。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">b.&nbsp;&nbsp;&nbsp;若第N个 Fabric 的 orderer organization 的域名为 orgordererN ，则其在Kubernetes 上对应的 namespace 为 orgordererN ，该 namespace 下只有一种 &nbsp;Pod ，它用于运行 orderer 节点。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">c.&nbsp;&nbsp;&nbsp;Kafka namespace 与 Fabric 的 organization 并无关系，它只用来运行和管理Zookeeper和Kafka容器，实现共识算法。</p>
   <p><br></p>
   <p style="margin-left:8px;"><strong>2.3&nbsp; Pod之间的通信</strong></p>
   <p style="margin-left:8px;">Kubernetes&nbsp;中的每个&nbsp;Pod&nbsp;都有独立的&nbsp;IP&nbsp;地址，然而在各个&nbsp;Pod&nbsp;之间直接通过&nbsp;IP:port&nbsp;的方式来通信会带来很多麻烦，因此有必要给每一个&nbsp;Pod&nbsp;绑定一个的&nbsp;service&nbsp;，以便用&nbsp;service&nbsp;名称来访问。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">service&nbsp;的命名方式应当遵循以下原则，彰显与其绑定的&nbsp;Pod&nbsp;信息：</p>
   <p style="margin-left:8px;">1)&nbsp;&nbsp;&nbsp;service&nbsp;与&nbsp;pod&nbsp;的&nbsp;namespace&nbsp;应当一致。</p>
   <p style="margin-left:8px;">2)&nbsp;&nbsp;&nbsp;service&nbsp;的&nbsp;name&nbsp;应与&nbsp;Pod&nbsp;中容器的&nbsp;id&nbsp;一致。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">例如，Fabric&nbsp;中属于&nbsp;org1&nbsp;的&nbsp;peer0&nbsp;节点，在&nbsp;K8S&nbsp;中用&nbsp;namespace&nbsp;为&nbsp;org1、名字为&nbsp;peer0&nbsp;的&nbsp;Pod&nbsp;来运行，与该&nbsp;Pod&nbsp;绑定的&nbsp;service&nbsp;全称应为&nbsp;peer0.org1&nbsp;。其中&nbsp;peer0&nbsp;为&nbsp;service&nbsp;的名称，org1&nbsp;为&nbsp;service&nbsp;的&nbsp;namespace&nbsp;。这样的映射关系已经和主机域名很接近了。</p>
   <p><br></p>
   <p style="margin-left:8px;">（未完待续）</p>
   <p style="margin-left:8px;"><strong style="font-size:14px;"><span style="color:rgb(62,62,62);">欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。</span></strong></p>
   <p style="margin-left:8px;"><strong style="font-size:14px;"><span style="color:rgb(62,62,62);"><br></span></strong></p>
   <p style="margin-left:8px;"><strong style="font-size:14px;color:rgb(62,62,62);">【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“</strong><strong style="font-size:14px;"><span style="color:rgb(2,30,170);">区块链即服务</span></strong><strong style="font-size:14px;"><span style="color:rgb(62,62,62);">”&nbsp;</span><strong><strong><span style="color:rgb(62,62,62);">或&nbsp;</span><strong><span style="color:rgb(62,62,62);">“</span><span style="color:rgb(2,30,170);">baas</span><span style="color:rgb(62,62,62);">”</span></strong></strong></strong><span style="color:rgb(62,62,62);">即可。】</span></strong></p>
   <p><strong style="font-size:14px;"><span style="color:rgb(62,62,62);"><span style="font-size:14px;"><br></span></span></strong></p>
   <p><span style="color:#3e3e3e;"><span style="font-size:14px;"><strong>相关文章：<a href="http://mp.weixin.qq.com/s?__biz=MzAwNzUyNzI5Mw==&amp;mid=2730790527&amp;idx=1&amp;sn=3b9ecce4440b168cddfb385215b3622a&amp;chksm=bc4ce06d8b3b697ba772d8e742aeac6958c830c2f0570b5cbe53ebe5ec35521595045ca15b14&amp;scene=21#wechat_redirect" rel="nofollow">超级账本Fabric 1.0 多节点集群的部署</a></strong></span></span></p>
   <p><strong style="font-size:14px;"><span style="color:rgb(62,62,62);"><span style="font-size:14px;"><br></span></span></strong></p>
   <p style="color:rgb(62,62,62);font-size:18px;border-style:none none none solid;border-color:rgb(102,102,102);line-height:25px;border-left-width:10px;background-color:rgb(243,243,243);margin-left:8px;"><strong><span>《区块链技术指南》介绍</span></strong></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;margin-left:16px;">更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的<span style="font-size:18px;"><strong>《区块链技术指南》</strong></span><strong>，</strong>机械工业出版社：<img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/VKmSsh8NadZfbGu6EpecqArnOTg6S5ONuANFZFxYgMHwnunThmGCPfjyjtXV3CudjK4HQxTtG4AX9GWLJYWQ0w/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"><br></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;margin-left:8px;"><span style="background-color:rgb(255,255,255);">京东购买链接：</span><br></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:18px;background-color:rgb(255,255,255);margin-left:8px;"><span style="font-size:14px;"><strong><span style="color:rgb(2,30,170);">http://item.jd.com/12007317.html</span></strong></span></p>
   <p><span style="font-size:14px;"><strong><span style="color:rgb(2,30,170);"><br></span></strong></span></p>
   <hr>
   <p style="min-height:1em;font-size:18px;"><span style="font-size:14px;"><span>欢迎读者们继续在文后点赞、留言交流，</span><strong style="font-size:16px;">亨利笔记</strong><span>主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp;</span></span></p>
   <img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz/VKmSsh8NadafdodhmiaAia3WZZIQsUTbdKQ8ZkBbPvEfbHazZ66yYiaicw1CAkP3UWDYvlWHX4gvT7PUymIP4LCTNw/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
   <p><br></p> 
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/q48S71bCzBeYLOu9T0n/article/details/77988173,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/q48S71bCzBeYLOu9T0n/article/details/77988173,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
