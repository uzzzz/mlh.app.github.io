<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>用Kubernetes部署超级账本Fabric的区块链即服务(2) | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="用Kubernetes部署超级账本Fabric的区块链即服务(2)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="题图摄于三藩市Pier 7：Coit Tower 上次我们介绍了用 Kubernetes 部署 Fabric （可点击）的总体架构和网络、存储的规划，本期为连载之二，详述部署工具设计的细节，包括模板的定制和配置的设定。文后附下载PDF版本的方法。 3. 源码的说明与使用 3.1&nbsp;环境准备 假定&nbsp;K8s&nbsp;平台已经成功部署，并且在各个&nbsp;worker&nbsp;节点已经预先下载相应的&nbsp;Fabric v1.0.0 的 Docker&nbsp;镜像，如表3-1。（预先下载镜像是由于国内网速较慢，在一台机器预先下载后，可用Docker命令导出并导入其他机器。） &nbsp; IMAGE TAG ID hyperledger/fabric-tools x86_64-1.0.0 0403fd1c72c7 hyperledger/fabric-orderer x86_64-1.0.0 e317ca5638ba hyperledger/fabric-peer x86_64-1.0.0 6830dcd7b9b5 hyperledger/fabric-ccenv x86_64-1.0.0 7182c260a5ca hyperledger/fabric-ca x86_64-1.0.0 a15c59ecda5b hyperledger/fabric-baseimage x86_64-0.3.1 9f2e9ec7c527 hyperledger/fabric-baseos x86_64-0.3.1 4b0cab202084 表 3- 1 本文涉及代码的目录结构及其作用如下： Fabric-on-k8s &nbsp; &nbsp;- README.md &nbsp; &nbsp;- setupCluster &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;generateALL.sh &nbsp; &nbsp; &nbsp; &nbsp;// 负责生成K8S部署文件 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;transform &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // 用于启动部署文件 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- templates &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 存放模板 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- cluster-config.yaml // 用于配置Fabric集群 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- configtx.yaml &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 用于配置channel &nbsp; 3.2 配置文件说明 在规划 Fabric 集群部署时，要按实际需求，编辑以下两个 Fabric 集群的定义文件： a.&nbsp;&nbsp;&nbsp;cluster-config.yaml &nbsp; cryptogen 工具根据 cluster-config.yaml 来生成 Fabric 成员的证书，一个简单的例子如下: OrdererOrgs: &nbsp;- Name: Orderer &nbsp;&nbsp; Domain: orgorderer1 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 1 &nbsp; PeerOrgs: &nbsp;- Name: Org1 &nbsp;&nbsp; Domain: org1 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 2 &nbsp; &nbsp;- Name: Org2 &nbsp;&nbsp; Domain: org2 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 2 &nbsp;&nbsp; 其中 OrdererOrgs 和 PeerOrgs 关键字区分 organization 的类型，两种组织的内部结构如下： 1)&nbsp;OrdererOrgs 中定义了一个名字为 Orderer ，域名为 orgorderer1 的 org ，并且它指定 template 中 count 的数值为 1，则在该 org 下只有一个 orderer ，其 id 为 orderer0 。 2)&nbsp;PeerOrgs 中定义了两个 org ，分别为 Org1 和 Org2 ，对应的域名为 org1、 org2 与 orderer 类似，每个 org 生成了两个 peers ，虽然 org1 中 peer0 和 org2 中 peer0 的ID重复，但是他不属于同一个 org ，通过域名很容易就能区分出它们。 &nbsp; 需要注意的是，由于 K8S 中的 namespace 不支持‘.’和大写字母，因此各个组织的域名不能包含这些字符。 &nbsp; 更多关于 cluster-config.yaml 的配置方式，请读者可参考 Fabric 源码中的关于cryptogen 的描述 ( fabric/common/tools/cryptogen/main.go ) &nbsp; 以上定义的 cluster-config.yaml ，cryptogen 工具会生成 crypto-config 目录，该目录的结构如下： &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crypto-config &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---ordererOrganizations &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orgorderer1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orderers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---orderer0.orgorderer1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peerOrganizations &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;--- peer1.org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;---&nbsp; ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- peer1.org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp; 可以看出，每个 org 都包含了 msp、 ca、 tlsca 和 users 目录，然后根据 org 类型的不同，还分别有 peers 和 orderers 目录，里面存放着 org 中每个成员的 msp 和 tls 文件。 &nbsp; b.&nbsp;&nbsp;&nbsp;configtx.yaml &nbsp; configtxgen 工具根据该文件生成 Orderer 初始化的时候要使用的 genesis.block，获知 organization 的各种信息，因此，用户要根据 cluster-config.yaml 中关于 organization 的定义来修改 configtx.yaml 以生成合适的 genesis.block 。例如，用户在 cluster-config.yaml 中增加了一个 Org3 ，并且要创建一个包含 Org1， Org2， Org3 的集群，则应该通过以下两步修改 configtx.yaml ：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 1. 在 profile 中增加 Org3 ，如图3-1。 图 3- 1 &nbsp; 2. 在 Organization 中增加 Org3 的 MSPDir ，如图3-2: 图 3-2 注意的是每个 organization 中的 MSPDir 的值必须是这种形式： crypto-config/{OrgType}/{OrgName}/mps 3.3 模板文件 &nbsp; 在 Kubernetes 中部署 Fabric 时，需要为每个节点编写相应的配置文件。由于节点数可能很多，这是既复杂又易错的重复劳动。为提高效率，可通过模板自动生成配置文件。本文使用了5个模板文件，可用脚本替换其中的变量，均在笔者给出示例代码中的 templates 目录中，这些模板的作用如下： &nbsp; a.&nbsp;&nbsp;&nbsp;fabric_1_0_tmeplate_namespace.yaml &nbsp; 定义Fabric集群在 K8s 中的 namespace ，它对应着 organization 的域名。为了在多节点共享证书等文件，使用了 NFS 服务器作为存储。在 K8s 中通过相应的 PV 和 PVC ，namespace 下的 Pod 可以通过 PVC 来获取与之相应的文件。 &nbsp; b.&nbsp;&nbsp;&nbsp;fabric_1_0_template_cli.yaml&nbsp; &nbsp;&nbsp; &nbsp; CLI pod 模板，每个 organization 中都配备了一个 CLI pod，目的是提供命令行界面，可统一管理组织内的所有 peer ，其中包括 channel 的创建， chaincode 的安装等。CLI Pod 的 CORE_PEER_ADDRESS 环境变量默认值为 org 中的第一个 peer，可以通过修改该环境变量来连接不同的 peer 。 &nbsp; yaml 文件中的 command 是为了防止 CLI pod 自动退出，CLI 的默认工作目录为/opt/gopath/src/github.com/hyperledger/fabric/peer。由于该目录下的 channel-artifacts&nbsp;挂载了 NFS 上&nbsp;/opt/share/channel-artifacts，因此把创建 channel 时返回的 xxx.block 文件放在该目录下供所有 CLI Pod共享。 &nbsp; c.&nbsp;&nbsp;&nbsp;fabric_1_0_template_ca.yaml &nbsp; Fabric 的 CA 服务的 pod 定义模板，用于 organization 中的证书管理，其 yaml 文件除了定义 deployment 外，还定义了 service 。service 通过 selector 与 deployment 绑定，其中 deployment 中的 label 是 selector 与其绑定的根据。 &nbsp;&nbsp; &nbsp; d.&nbsp;&nbsp;&nbsp;fabcric_1_0_template_orderer.yaml &nbsp; Orderer 的 pod 定义模板，需要注意的是，cryptogen 并不会生成 genesis.block ，然而缺少该文件时，orderer 会启动失败，因此在启动 orderer 之前需要预先生成 genesis.block ，并将其放在相应的 org 目录下。 &nbsp; e.&nbsp;&nbsp;&nbsp;fabric_1_0_template_peer.yaml &nbsp; 每个 peer pod 的定义模板。在该 yaml 中分别定义了 peer 和 couchDB 两个container 。在实例化 chaincode &nbsp;(cc) 时，peer 需要连接 Docker 引擎来创建 cc 容器，因此要把 worker 宿主机的 var/run/docker.sock 映射到 peer 容器内部（参见图2-1）。 （未完待续） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多" />
<meta property="og:description" content="题图摄于三藩市Pier 7：Coit Tower 上次我们介绍了用 Kubernetes 部署 Fabric （可点击）的总体架构和网络、存储的规划，本期为连载之二，详述部署工具设计的细节，包括模板的定制和配置的设定。文后附下载PDF版本的方法。 3. 源码的说明与使用 3.1&nbsp;环境准备 假定&nbsp;K8s&nbsp;平台已经成功部署，并且在各个&nbsp;worker&nbsp;节点已经预先下载相应的&nbsp;Fabric v1.0.0 的 Docker&nbsp;镜像，如表3-1。（预先下载镜像是由于国内网速较慢，在一台机器预先下载后，可用Docker命令导出并导入其他机器。） &nbsp; IMAGE TAG ID hyperledger/fabric-tools x86_64-1.0.0 0403fd1c72c7 hyperledger/fabric-orderer x86_64-1.0.0 e317ca5638ba hyperledger/fabric-peer x86_64-1.0.0 6830dcd7b9b5 hyperledger/fabric-ccenv x86_64-1.0.0 7182c260a5ca hyperledger/fabric-ca x86_64-1.0.0 a15c59ecda5b hyperledger/fabric-baseimage x86_64-0.3.1 9f2e9ec7c527 hyperledger/fabric-baseos x86_64-0.3.1 4b0cab202084 表 3- 1 本文涉及代码的目录结构及其作用如下： Fabric-on-k8s &nbsp; &nbsp;- README.md &nbsp; &nbsp;- setupCluster &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;generateALL.sh &nbsp; &nbsp; &nbsp; &nbsp;// 负责生成K8S部署文件 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;transform &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // 用于启动部署文件 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- templates &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 存放模板 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- cluster-config.yaml // 用于配置Fabric集群 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- configtx.yaml &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 用于配置channel &nbsp; 3.2 配置文件说明 在规划 Fabric 集群部署时，要按实际需求，编辑以下两个 Fabric 集群的定义文件： a.&nbsp;&nbsp;&nbsp;cluster-config.yaml &nbsp; cryptogen 工具根据 cluster-config.yaml 来生成 Fabric 成员的证书，一个简单的例子如下: OrdererOrgs: &nbsp;- Name: Orderer &nbsp;&nbsp; Domain: orgorderer1 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 1 &nbsp; PeerOrgs: &nbsp;- Name: Org1 &nbsp;&nbsp; Domain: org1 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 2 &nbsp; &nbsp;- Name: Org2 &nbsp;&nbsp; Domain: org2 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 2 &nbsp;&nbsp; 其中 OrdererOrgs 和 PeerOrgs 关键字区分 organization 的类型，两种组织的内部结构如下： 1)&nbsp;OrdererOrgs 中定义了一个名字为 Orderer ，域名为 orgorderer1 的 org ，并且它指定 template 中 count 的数值为 1，则在该 org 下只有一个 orderer ，其 id 为 orderer0 。 2)&nbsp;PeerOrgs 中定义了两个 org ，分别为 Org1 和 Org2 ，对应的域名为 org1、 org2 与 orderer 类似，每个 org 生成了两个 peers ，虽然 org1 中 peer0 和 org2 中 peer0 的ID重复，但是他不属于同一个 org ，通过域名很容易就能区分出它们。 &nbsp; 需要注意的是，由于 K8S 中的 namespace 不支持‘.’和大写字母，因此各个组织的域名不能包含这些字符。 &nbsp; 更多关于 cluster-config.yaml 的配置方式，请读者可参考 Fabric 源码中的关于cryptogen 的描述 ( fabric/common/tools/cryptogen/main.go ) &nbsp; 以上定义的 cluster-config.yaml ，cryptogen 工具会生成 crypto-config 目录，该目录的结构如下： &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crypto-config &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---ordererOrganizations &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orgorderer1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orderers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---orderer0.orgorderer1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peerOrganizations &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;--- peer1.org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;---&nbsp; ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- peer1.org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp; 可以看出，每个 org 都包含了 msp、 ca、 tlsca 和 users 目录，然后根据 org 类型的不同，还分别有 peers 和 orderers 目录，里面存放着 org 中每个成员的 msp 和 tls 文件。 &nbsp; b.&nbsp;&nbsp;&nbsp;configtx.yaml &nbsp; configtxgen 工具根据该文件生成 Orderer 初始化的时候要使用的 genesis.block，获知 organization 的各种信息，因此，用户要根据 cluster-config.yaml 中关于 organization 的定义来修改 configtx.yaml 以生成合适的 genesis.block 。例如，用户在 cluster-config.yaml 中增加了一个 Org3 ，并且要创建一个包含 Org1， Org2， Org3 的集群，则应该通过以下两步修改 configtx.yaml ：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 1. 在 profile 中增加 Org3 ，如图3-1。 图 3- 1 &nbsp; 2. 在 Organization 中增加 Org3 的 MSPDir ，如图3-2: 图 3-2 注意的是每个 organization 中的 MSPDir 的值必须是这种形式： crypto-config/{OrgType}/{OrgName}/mps 3.3 模板文件 &nbsp; 在 Kubernetes 中部署 Fabric 时，需要为每个节点编写相应的配置文件。由于节点数可能很多，这是既复杂又易错的重复劳动。为提高效率，可通过模板自动生成配置文件。本文使用了5个模板文件，可用脚本替换其中的变量，均在笔者给出示例代码中的 templates 目录中，这些模板的作用如下： &nbsp; a.&nbsp;&nbsp;&nbsp;fabric_1_0_tmeplate_namespace.yaml &nbsp; 定义Fabric集群在 K8s 中的 namespace ，它对应着 organization 的域名。为了在多节点共享证书等文件，使用了 NFS 服务器作为存储。在 K8s 中通过相应的 PV 和 PVC ，namespace 下的 Pod 可以通过 PVC 来获取与之相应的文件。 &nbsp; b.&nbsp;&nbsp;&nbsp;fabric_1_0_template_cli.yaml&nbsp; &nbsp;&nbsp; &nbsp; CLI pod 模板，每个 organization 中都配备了一个 CLI pod，目的是提供命令行界面，可统一管理组织内的所有 peer ，其中包括 channel 的创建， chaincode 的安装等。CLI Pod 的 CORE_PEER_ADDRESS 环境变量默认值为 org 中的第一个 peer，可以通过修改该环境变量来连接不同的 peer 。 &nbsp; yaml 文件中的 command 是为了防止 CLI pod 自动退出，CLI 的默认工作目录为/opt/gopath/src/github.com/hyperledger/fabric/peer。由于该目录下的 channel-artifacts&nbsp;挂载了 NFS 上&nbsp;/opt/share/channel-artifacts，因此把创建 channel 时返回的 xxx.block 文件放在该目录下供所有 CLI Pod共享。 &nbsp; c.&nbsp;&nbsp;&nbsp;fabric_1_0_template_ca.yaml &nbsp; Fabric 的 CA 服务的 pod 定义模板，用于 organization 中的证书管理，其 yaml 文件除了定义 deployment 外，还定义了 service 。service 通过 selector 与 deployment 绑定，其中 deployment 中的 label 是 selector 与其绑定的根据。 &nbsp;&nbsp; &nbsp; d.&nbsp;&nbsp;&nbsp;fabcric_1_0_template_orderer.yaml &nbsp; Orderer 的 pod 定义模板，需要注意的是，cryptogen 并不会生成 genesis.block ，然而缺少该文件时，orderer 会启动失败，因此在启动 orderer 之前需要预先生成 genesis.block ，并将其放在相应的 org 目录下。 &nbsp; e.&nbsp;&nbsp;&nbsp;fabric_1_0_template_peer.yaml &nbsp; 每个 peer pod 的定义模板。在该 yaml 中分别定义了 peer 和 couchDB 两个container 。在实例化 chaincode &nbsp;(cc) 时，peer 需要连接 Docker 引擎来创建 cc 容器，因此要把 worker 宿主机的 var/run/docker.sock 映射到 peer 容器内部（参见图2-1）。 （未完待续） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/08/17/e5c0bc5668fb833fddeb678b657da8dd.html" />
<meta property="og:url" content="https://mlh.app/2017/08/17/e5c0bc5668fb833fddeb678b657da8dd.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-08-17T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"题图摄于三藩市Pier 7：Coit Tower 上次我们介绍了用 Kubernetes 部署 Fabric （可点击）的总体架构和网络、存储的规划，本期为连载之二，详述部署工具设计的细节，包括模板的定制和配置的设定。文后附下载PDF版本的方法。 3. 源码的说明与使用 3.1&nbsp;环境准备 假定&nbsp;K8s&nbsp;平台已经成功部署，并且在各个&nbsp;worker&nbsp;节点已经预先下载相应的&nbsp;Fabric v1.0.0 的 Docker&nbsp;镜像，如表3-1。（预先下载镜像是由于国内网速较慢，在一台机器预先下载后，可用Docker命令导出并导入其他机器。） &nbsp; IMAGE TAG ID hyperledger/fabric-tools x86_64-1.0.0 0403fd1c72c7 hyperledger/fabric-orderer x86_64-1.0.0 e317ca5638ba hyperledger/fabric-peer x86_64-1.0.0 6830dcd7b9b5 hyperledger/fabric-ccenv x86_64-1.0.0 7182c260a5ca hyperledger/fabric-ca x86_64-1.0.0 a15c59ecda5b hyperledger/fabric-baseimage x86_64-0.3.1 9f2e9ec7c527 hyperledger/fabric-baseos x86_64-0.3.1 4b0cab202084 表 3- 1 本文涉及代码的目录结构及其作用如下： Fabric-on-k8s &nbsp; &nbsp;- README.md &nbsp; &nbsp;- setupCluster &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;generateALL.sh &nbsp; &nbsp; &nbsp; &nbsp;// 负责生成K8S部署文件 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;transform &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // 用于启动部署文件 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- templates &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 存放模板 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- cluster-config.yaml // 用于配置Fabric集群 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- configtx.yaml &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 用于配置channel &nbsp; 3.2 配置文件说明 在规划 Fabric 集群部署时，要按实际需求，编辑以下两个 Fabric 集群的定义文件： a.&nbsp;&nbsp;&nbsp;cluster-config.yaml &nbsp; cryptogen 工具根据 cluster-config.yaml 来生成 Fabric 成员的证书，一个简单的例子如下: OrdererOrgs: &nbsp;- Name: Orderer &nbsp;&nbsp; Domain: orgorderer1 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 1 &nbsp; PeerOrgs: &nbsp;- Name: Org1 &nbsp;&nbsp; Domain: org1 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 2 &nbsp; &nbsp;- Name: Org2 &nbsp;&nbsp; Domain: org2 &nbsp;&nbsp; Template: &nbsp;&nbsp;&nbsp;&nbsp; Count: 2 &nbsp;&nbsp; 其中 OrdererOrgs 和 PeerOrgs 关键字区分 organization 的类型，两种组织的内部结构如下： 1)&nbsp;OrdererOrgs 中定义了一个名字为 Orderer ，域名为 orgorderer1 的 org ，并且它指定 template 中 count 的数值为 1，则在该 org 下只有一个 orderer ，其 id 为 orderer0 。 2)&nbsp;PeerOrgs 中定义了两个 org ，分别为 Org1 和 Org2 ，对应的域名为 org1、 org2 与 orderer 类似，每个 org 生成了两个 peers ，虽然 org1 中 peer0 和 org2 中 peer0 的ID重复，但是他不属于同一个 org ，通过域名很容易就能区分出它们。 &nbsp; 需要注意的是，由于 K8S 中的 namespace 不支持‘.’和大写字母，因此各个组织的域名不能包含这些字符。 &nbsp; 更多关于 cluster-config.yaml 的配置方式，请读者可参考 Fabric 源码中的关于cryptogen 的描述 ( fabric/common/tools/cryptogen/main.go ) &nbsp; 以上定义的 cluster-config.yaml ，cryptogen 工具会生成 crypto-config 目录，该目录的结构如下： &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crypto-config &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---ordererOrganizations &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orgorderer1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orderers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---orderer0.orgorderer1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peerOrganizations &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;--- peer1.org1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;---&nbsp; ca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- users &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- peers &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- peer1.org2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls &nbsp; 可以看出，每个 org 都包含了 msp、 ca、 tlsca 和 users 目录，然后根据 org 类型的不同，还分别有 peers 和 orderers 目录，里面存放着 org 中每个成员的 msp 和 tls 文件。 &nbsp; b.&nbsp;&nbsp;&nbsp;configtx.yaml &nbsp; configtxgen 工具根据该文件生成 Orderer 初始化的时候要使用的 genesis.block，获知 organization 的各种信息，因此，用户要根据 cluster-config.yaml 中关于 organization 的定义来修改 configtx.yaml 以生成合适的 genesis.block 。例如，用户在 cluster-config.yaml 中增加了一个 Org3 ，并且要创建一个包含 Org1， Org2， Org3 的集群，则应该通过以下两步修改 configtx.yaml ：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 1. 在 profile 中增加 Org3 ，如图3-1。 图 3- 1 &nbsp; 2. 在 Organization 中增加 Org3 的 MSPDir ，如图3-2: 图 3-2 注意的是每个 organization 中的 MSPDir 的值必须是这种形式： crypto-config/{OrgType}/{OrgName}/mps 3.3 模板文件 &nbsp; 在 Kubernetes 中部署 Fabric 时，需要为每个节点编写相应的配置文件。由于节点数可能很多，这是既复杂又易错的重复劳动。为提高效率，可通过模板自动生成配置文件。本文使用了5个模板文件，可用脚本替换其中的变量，均在笔者给出示例代码中的 templates 目录中，这些模板的作用如下： &nbsp; a.&nbsp;&nbsp;&nbsp;fabric_1_0_tmeplate_namespace.yaml &nbsp; 定义Fabric集群在 K8s 中的 namespace ，它对应着 organization 的域名。为了在多节点共享证书等文件，使用了 NFS 服务器作为存储。在 K8s 中通过相应的 PV 和 PVC ，namespace 下的 Pod 可以通过 PVC 来获取与之相应的文件。 &nbsp; b.&nbsp;&nbsp;&nbsp;fabric_1_0_template_cli.yaml&nbsp; &nbsp;&nbsp; &nbsp; CLI pod 模板，每个 organization 中都配备了一个 CLI pod，目的是提供命令行界面，可统一管理组织内的所有 peer ，其中包括 channel 的创建， chaincode 的安装等。CLI Pod 的 CORE_PEER_ADDRESS 环境变量默认值为 org 中的第一个 peer，可以通过修改该环境变量来连接不同的 peer 。 &nbsp; yaml 文件中的 command 是为了防止 CLI pod 自动退出，CLI 的默认工作目录为/opt/gopath/src/github.com/hyperledger/fabric/peer。由于该目录下的 channel-artifacts&nbsp;挂载了 NFS 上&nbsp;/opt/share/channel-artifacts，因此把创建 channel 时返回的 xxx.block 文件放在该目录下供所有 CLI Pod共享。 &nbsp; c.&nbsp;&nbsp;&nbsp;fabric_1_0_template_ca.yaml &nbsp; Fabric 的 CA 服务的 pod 定义模板，用于 organization 中的证书管理，其 yaml 文件除了定义 deployment 外，还定义了 service 。service 通过 selector 与 deployment 绑定，其中 deployment 中的 label 是 selector 与其绑定的根据。 &nbsp;&nbsp; &nbsp; d.&nbsp;&nbsp;&nbsp;fabcric_1_0_template_orderer.yaml &nbsp; Orderer 的 pod 定义模板，需要注意的是，cryptogen 并不会生成 genesis.block ，然而缺少该文件时，orderer 会启动失败，因此在启动 orderer 之前需要预先生成 genesis.block ，并将其放在相应的 org 目录下。 &nbsp; e.&nbsp;&nbsp;&nbsp;fabric_1_0_template_peer.yaml &nbsp; 每个 peer pod 的定义模板。在该 yaml 中分别定义了 peer 和 couchDB 两个container 。在实例化 chaincode &nbsp;(cc) 时，peer 需要连接 Docker 引擎来创建 cc 容器，因此要把 worker 宿主机的 var/run/docker.sock 映射到 peer 容器内部（参见图2-1）。 （未完待续） 欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。 【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“区块链即服务”&nbsp;或&nbsp;“baas”即可。】 相关文章：超级账本Fabric 1.0 多节点集群的部署 《区块链技术指南》介绍 更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的《区块链技术指南》，机械工业出版社： 京东购买链接： http://item.jd.com/12007317.html 欢迎读者们继续在文后点赞、留言交流，亨利笔记主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp; 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/08/17/e5c0bc5668fb833fddeb678b657da8dd.html","headline":"用Kubernetes部署超级账本Fabric的区块链即服务(2)","dateModified":"2017-08-17T00:00:00+08:00","datePublished":"2017-08-17T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/08/17/e5c0bc5668fb833fddeb678b657da8dd.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>用Kubernetes部署超级账本Fabric的区块链即服务(2)</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div class="rich_media_content"> 
   <p><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/VKmSsh8NadYIJTcWSKObibhfM6578RpsalfVzTU7bksmF4pPCPuxNOuzxyVtTFaCicAfhltdGiamlaqHFgP2V4M0w/0?wx_fmt=jpeg" alt="0?wx_fmt=jpeg"><br></p>
   <p style="text-align:center;"><span style="color:rgb(136,136,136);font-size:12px;">题图摄于三藩市Pier 7：Coit Tower</span></p>
   <p style="margin-left:8px;"><br></p>
   <blockquote>
    <p><span style="font-size:14px;color:rgb(136,136,136);">上次我们介绍了</span><a href="http://mp.weixin.qq.com/s?__biz=MzAwNzUyNzI5Mw==&amp;mid=2730790574&amp;idx=1&amp;sn=de8eb13d15dcb561f8d21e52f32cc827&amp;chksm=bc4ce0bc8b3b69aaa8616be3726c9d968e7948b7a23210349dedcfac6de670fa7f642977340a&amp;scene=21#wechat_redirect" rel="nofollow" style="text-decoration:underline;font-size:14px;color:rgb(0,82,255);"><span style="font-size:14px;color:rgb(0,82,255);">用 Kubernetes 部署 Fabric </span></a><span style="font-size:14px;color:rgb(136,136,136);">（可点击）的总体架构和网络、存储的规划，本期为连载之二，详述部署工具设计的细节，包括模板的定制和配置的设定。文后附下载PDF版本的方法。</span></p>
   </blockquote>
   <p style="margin-left:8px;"><br></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:18px;border-style:none none none solid;border-color:rgb(102,102,102);line-height:25px;border-left-width:10px;background-color:rgb(243,243,243);margin-left:0px;"><strong><span>3. 源码的说明与使用</span></strong></p>
   <p style="margin-left:8px;font-size:16px;min-height:1em;color:rgb(62,62,62);"><br></p>
   <p style="margin-left:8px;"><strong>3.1&nbsp;环境准备</strong></p>
   <p><br></p>
   <p style="margin-left:8px;">假定&nbsp;K8s&nbsp;平台已经成功部署，并且在各个&nbsp;worker&nbsp;节点已经预先下载相应的&nbsp;Fabric v1.0.0 的 Docker&nbsp;镜像，如表3-1。（预先下载镜像是由于国内网速较慢，在一台机器预先下载后，可用Docker命令导出并导入其他机器。）</p>
   <p>&nbsp;</p>
   <table cellspacing="0" cellpadding="0">
    <tbody>
     <tr>
      <td valign="top" style="border-width:1px;border-color:rgb(191,191,191);background-color:rgb(174,170,170);"><p><strong><span style="font-size:12px;">IMAGE</span></strong></p></td>
      <td valign="top" style="border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-color:rgb(191,191,191);border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-style:none;background-color:rgb(174,170,170);"><p><strong><span style="font-size:12px;">TAG </span></strong></p></td>
      <td valign="top" style="border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-top-color:rgb(191,191,191);border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-style:none;background-color:rgb(174,170,170);"><p><strong><span style="font-size:12px;">ID</span></strong></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-tools</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-1.0.0 </span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">0403fd1c72c7 </span></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-orderer</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-1.0.0 </span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">e317ca5638ba</span></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-peer</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-1.0.0</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">6830dcd7b9b5</span></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-ccenv</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-1.0.0</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">7182c260a5ca</span></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-ca</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-1.0.0</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">a15c59ecda5b</span></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-baseimage </span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-0.3.1</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">9f2e9ec7c527 </span></p></td>
     </tr>
     <tr>
      <td valign="top" style="border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-right-color:rgb(191,191,191);border-bottom-color:rgb(191,191,191);border-left-color:rgb(191,191,191);border-top-style:none;"><p><span style="font-size:12px;">hyperledger/fabric-baseos</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">x86_64-0.3.1</span></p></td>
      <td valign="top" style="border-top-style:none;border-left-style:none;border-bottom-width:1px;border-bottom-color:rgb(191,191,191);border-right-width:1px;border-right-color:rgb(191,191,191);"><p><span style="font-size:12px;">4b0cab202084</span></p></td>
     </tr>
    </tbody>
   </table>
   <p style="text-align:center;"><span style="font-size:12px;color:rgb(136,136,136);">表 3- 1</span></p>
   <p><br></p>
   <p style="margin-left:8px;">本文涉及代码的目录结构及其作用如下：</p>
   <p><br></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">Fabric-on-k8s</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp; &nbsp;- README.md</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp; &nbsp;- setupCluster</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;generateALL.sh &nbsp; &nbsp; &nbsp; &nbsp;// 负责生成K8S部署文件</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&nbsp;transform &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // 用于启动部署文件</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- templates &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 存放模板</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- cluster-config.yaml // 用于配置Fabric集群</span></p>
   <p style="margin-left:8px;"><span style="font-size:12px;color:rgb(171,25,66);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- configtx.yaml &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// 用于配置channel</span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>3.2 配置文件说明</strong></p>
   <p style="margin-left:8px;">在规划 Fabric 集群部署时，要按实际需求，编辑以下两个 Fabric 集群的定义文件：</p>
   <p><br></p>
   <p style="margin-left:8px;"><strong>a.&nbsp;&nbsp;&nbsp;cluster-config.yaml</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">cryptogen 工具根据 cluster-config.yaml 来生成 Fabric 成员的证书，一个简单的例子如下:</p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="font-size:12px;">OrdererOrgs:</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;- Name: Orderer</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp; Domain: orgorderer1</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp; Template:</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp; Count: 1</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">PeerOrgs:</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;- Name: Org1</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp; Domain: org1</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp; Template:</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp; Count: 2</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;- Name: Org2</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp; Domain: org2</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp; Template:</span></strong></span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);"><strong><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp; Count: 2</span></strong></span></p>
   <p style="margin-left:8px;">&nbsp;&nbsp;</p>
   <p style="margin-left:8px;">其中 OrdererOrgs 和 PeerOrgs 关键字区分 organization 的类型，两种组织的内部结构如下：</p>
   <p><br></p>
   <p style="margin-left:8px;"><strong>1)&nbsp;</strong>OrdererOrgs 中定义了一个名字为 Orderer ，域名为 orgorderer1 的 org ，并且它指定 template 中 count 的数值为 1，则在该 org 下只有一个 orderer ，其 id 为 orderer0 。</p>
   <p><br></p>
   <p style="margin-left:8px;"><strong>2)&nbsp;</strong>PeerOrgs 中定义了两个 org ，分别为 Org1 和 Org2 ，对应的域名为 org1、 org2 与 orderer 类似，每个 org 生成了两个 peers ，虽然 org1 中 peer0 和 org2 中 peer0 的ID重复，但是他不属于同一个 org ，通过域名很容易就能区分出它们。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">需要注意的是，由于 K8S 中的 namespace 不支持‘.’和大写字母，因此各个组织的域名不能包含这些字符。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">更多关于 cluster-config.yaml 的配置方式，请读者可参考 Fabric 源码中的关于cryptogen 的描述 ( <span style="color:rgb(171,25,66);font-size:12px;">fabric/common/tools/cryptogen/main.go</span> )</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">以上定义的 cluster-config.yaml ，cryptogen 工具会生成 crypto-config 目录，该目录的结构如下：</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="line-height:normal;margin-left:8px;">&nbsp;&nbsp;&nbsp;<span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;crypto-config</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ---ordererOrganizations</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orgorderer1</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- orderers</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---orderer0.orgorderer1</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;---peerOrganizations</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; --- org1</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;---&nbsp;ca</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- users</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- peers</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org1</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;--- peer1.org1</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;--- tls</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--- org2</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;---&nbsp; ca</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- tlsca</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- users</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;--- peers</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---peer0.org2</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; --- peer1.org2</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- msp</span></p>
   <p style="line-height:normal;margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;--- tls</span></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">可以看出，每个 org 都包含了 msp、 ca、 tlsca 和 users 目录，然后根据 org 类型的不同，还分别有 peers 和 orderers 目录，里面存放着 org 中每个成员的 msp 和 tls 文件。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>b.&nbsp;&nbsp;&nbsp;configtx.yaml</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">configtxgen 工具根据该文件生成 Orderer 初始化的时候要使用的 genesis.block，获知 organization 的各种信息，因此，用户要根据 cluster-config.yaml 中关于 organization 的定义来修改 configtx.yaml 以生成合适的 genesis.block 。例如，用户在 cluster-config.yaml 中增加了一个 Org3 ，并且要创建一个包含 Org1， Org2， Org3 的集群，则应该通过以下两步修改 configtx.yaml ：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">1. 在 profile 中增加 Org3 ，如图3-1。</p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadazpTNBIspNKjBjGw5hbxBtFoNEa51Se77UWWVyEKP6LAKCWHtiaybrL8ECS6NjzicG2fvB3wAOyj1A/0?wx_fmt=png" alt="0?wx_fmt=png"><br></p>
   <p style="margin-left:8px;text-align:center;">图 3- 1</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">2. 在 Organization 中增加 Org3 的 MSPDir ，如图3-2:</p>
   <p style="text-align:center;"><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/VKmSsh8NadYwO0pXIbkicFibOq1GFYib0pqtRRsZKPukLYwannc2b3CQpJ579PHsC8xia01GY2CzrdMGOs89TQPJdg/0?wx_fmt=png" alt="0?wx_fmt=png"><span style="text-align:center;color:rgb(136,136,136);font-size:14px;">图 3-2</span></p>
   <p><br></p>
   <p style="margin-left:8px;">注意的是每个<span style="color:#00f900;"> </span>organization 中的 MSPDir 的值必须是这种形式：</p>
   <p style="margin-left:8px;"><span style="color:rgb(171,25,66);font-size:12px;"><strong>crypto-config/{OrgType}/{OrgName}/mps</strong></span></p>
   <p><br></p>
   <p style="margin-left:8px;"><strong>3.3 模板文件</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">在 Kubernetes 中部署 Fabric 时，需要为每个节点编写相应的配置文件。由于节点数可能很多，这是既复杂又易错的重复劳动。为提高效率，可通过模板自动生成配置文件。本文使用了5个模板文件，可用脚本替换其中的变量，均在笔者给出示例代码中的 templates 目录中，这些模板的作用如下：</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>a.&nbsp;&nbsp;&nbsp;fabric_1_0_tmeplate_namespace.yaml</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">定义Fabric集群在 K8s 中的 namespace ，它对应着 organization 的域名。为了在多节点共享证书等文件，使用了 NFS 服务器作为存储。在 K8s 中通过相应的 PV 和 PVC ，namespace 下的 Pod 可以通过 PVC 来获取与之相应的文件。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>b.&nbsp;&nbsp;&nbsp;fabric_1_0_template_cli.yaml&nbsp; </strong>&nbsp;&nbsp;</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">CLI pod 模板，每个 organization 中都配备了一个 CLI pod，目的是提供命令行界面，可统一管理组织内的所有 peer ，其中包括 channel 的创建， chaincode 的安装等。CLI Pod 的 CORE_PEER_ADDRESS 环境变量默认值为 org 中的第一个 peer，可以通过修改该环境变量来连接不同的 peer 。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">yaml 文件中的 command 是为了防止 CLI pod 自动退出，CLI 的默认工作目录为<span style="color:rgb(171,25,66);font-size:12px;">/opt/gopath/src/github.com/hyperledger/fabric/peer</span>。由于该目录下的 <span style="color:rgb(171,25,66);font-size:12px;">channel-artifacts&nbsp;</span>挂载了 NFS 上&nbsp;<span style="color:rgb(171,25,66);font-size:12px;">/opt/share/channel-artifacts</span>，因此把创建 channel 时返回的 xxx.block 文件放在该目录下供所有 CLI Pod共享。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>c.&nbsp;&nbsp;&nbsp;fabric_1_0_template_ca.yaml</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">Fabric 的 CA 服务的 pod 定义模板，用于 organization 中的证书管理，其 yaml 文件除了定义 deployment 外，还定义了 service 。service 通过 selector 与 deployment 绑定，其中 deployment 中的 label 是 selector 与其绑定的根据。 &nbsp;&nbsp;</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>d.&nbsp;&nbsp;&nbsp;fabcric_1_0_template_orderer.yaml</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">Orderer 的 pod 定义模板，需要注意的是，cryptogen 并不会生成 genesis.block ，然而缺少该文件时，orderer 会启动失败，因此在启动 orderer 之前需要预先生成 genesis.block ，并将其放在相应的 org 目录下。</p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;"><strong>e.&nbsp;&nbsp;&nbsp;fabric_1_0_template_peer.yaml</strong></p>
   <p style="margin-left:8px;">&nbsp;</p>
   <p style="margin-left:8px;">每个 peer pod 的定义模板。在该 yaml 中分别定义了 peer 和 couchDB 两个container 。在实例化 chaincode &nbsp;(cc) 时，peer 需要连接 Docker 引擎来创建 cc 容器，因此要把 worker 宿主机的 var/run/docker.sock 映射到 peer 容器内部（参见图2-1）。</p>
   <p><br></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;margin-left:8px;"><span style="font-size:14px;">（未完待续）</span></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><br></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:15px;"><strong style="font-size:14px;"><span>欢迎读者们继续在文后点赞、留言交流，告诉我们你喜欢这样的文章。</span></strong></span></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;"><span><br></span></strong></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;">【注：下载本文PDF版本以及本文源代码，可关注本公众号：亨利笔记，后台发送消息“</strong><strong style="font-size:14px;"><span style="color:rgb(2,30,170);">区块链即服务</span></strong><strong style="font-size:14px;"><span>”&nbsp;</span><strong><strong><span>或&nbsp;</span><strong><span>“</span><span style="color:rgb(2,30,170);">baas</span><span>”</span></strong></strong></strong><span>即可。】</span></strong></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;"><strong style="font-size:14px;"><span><br></span></strong></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:14px;"><strong>相关文章：<a href="http://mp.weixin.qq.com/s?__biz=MzAwNzUyNzI5Mw==&amp;mid=2730790527&amp;idx=1&amp;sn=3b9ecce4440b168cddfb385215b3622a&amp;chksm=bc4ce06d8b3b697ba772d8e742aeac6958c830c2f0570b5cbe53ebe5ec35521595045ca15b14&amp;scene=21#wechat_redirect" rel="nofollow">超级账本Fabric 1.0 多节点集群的部署</a></strong></span></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;margin-left:8px;"><strong style="font-size:14px;"><span><br></span></strong></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:18px;border-style:none none none solid;border-color:rgb(102,102,102);line-height:25px;border-left-width:10px;background-color:rgb(243,243,243);margin-left:8px;"><strong><span>《区块链技术指南》介绍</span></strong></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;margin-left:8px;"><span style="font-size:15px;">更多关于超级账本的信息，以及区块链的技术细节，包括比特币、以太坊、公有链、联盟链、侧链、闪电网络等等，请参考笔者和邹均博士等作者合著的<span><strong>《区块链技术指南》</strong></span><strong>，</strong>机械工业出版社：</span><img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_jpg/VKmSsh8NadZfbGu6EpecqArnOTg6S5ONuANFZFxYgMHwnunThmGCPfjyjtXV3CudjK4HQxTtG4AX9GWLJYWQ0w/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg"><br></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="background-color:rgb(255,255,255);">京东购买链接：</span><br></p>
   <p style="margin-left:8px;min-height:1em;color:rgb(62,62,62);font-size:18px;background-color:rgb(255,255,255);"><span style="font-size:14px;"><strong><span style="color:rgb(2,30,170);">http://item.jd.com/12007317.html</span></strong></span></p>
   <p style="min-height:1em;color:rgb(62,62,62);font-size:16px;"><span style="font-size:14px;"><strong><span style="color:rgb(2,30,170);"><br></span></strong></span></p>
   <hr style="color:rgb(62,62,62);font-size:16px;">
   <p style="min-height:1em;color:rgb(62,62,62);font-size:18px;"><span style="font-size:14px;"><span>欢迎读者们继续在文后点赞、留言交流，</span><strong style="font-size:16px;">亨利笔记</strong><span>主要包含关于区块链、云计算的技术文章，欢迎关注：&nbsp;</span></span></p>
   <img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz/VKmSsh8NadafdodhmiaAia3WZZIQsUTbdKQ8ZkBbPvEfbHazZ66yYiaicw1CAkP3UWDYvlWHX4gvT7PUymIP4LCTNw/640?wx_fmt=jpeg" alt="640?wx_fmt=jpeg">
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/q48S71bCzBeYLOu9T0n/article/details/77988164,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/q48S71bCzBeYLOu9T0n/article/details/77988164,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
