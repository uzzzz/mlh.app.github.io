<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>【支付系统学习笔记】-二支付设计（银行卡支付） | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="【支付系统学习笔记】-二支付设计（银行卡支付）" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="前言： &nbsp; 本文属于学习笔记，首先感谢原作者：凤凰牌老熊，博客链接：http://blog.lixf.cn/&nbsp; 一 支付与交易 作者先明确了概念： 交易是生成订单；支付是对订单进行付款。&nbsp; 支付行为有多种：我们碰到的大部分都是单次支付，其次还有转账和退款。以常见的单次支付来说明流程。 二 银行卡支付 先说大家比较熟悉的银行卡支付，它分为线上支付和线下支付两种形式。线下支付就是通常说的POS收单，这里不介绍这个内容。对线上支付，按照卡的类别，分为贷记卡支付，也叫motopay、ePOS，即信用卡支付；和借记卡支付。按照支付形态，又分为认证支付、网银支付、快捷支付几种形态。银行卡网银支付要求银行卡必须开通在线支付功能，而快捷支付并不需要开通在线支付功能。主要利用支付验证要素（卡号、密码、手机号、CVN2、CVV2等），结合安全认证（例如短信验证码），让持卡人完成互联网支付。 认证支付 指用户在绑卡时，将卡信息提供给电商。这样在支付时，用户无需再输入这些信息，由电商在服务器侧保留用户的账户信息，比如身份证号，卡号，手机号。在用户支付时，无需再输入这些内容，最多就提供个密码或者校验码，就可以完成支付。这基本不会打断用户的使用体验，所以也是电商喜欢的支付方式。但认证支付最让人诟病的就是安全性。一方面需要向电商暴露个人信息，一旦被窃取，资金就容易被盗走。还有在手机上执行支付，一旦手机丢失，窃取者就可以轻而易举的使用或者转移资金。 快捷支付 快捷支付和认证支付类似，不同点在于绑卡之后，有些银行接口会返回token，后续使用token来作为支付凭证，无需提供卡号信息，这样电商也不需要本地保留卡号了。目前主要是银联有提供token接口。 网银支付 相对来说，网银支付要安全很多。网银支付是由银联或者银行提供支付界面，用户必须在页面上输入卡号，密码等验证信息才可以执行支付。大部分银行还要求用户使用U盾或者其它安全硬件。但安全和易用永远是个矛盾。网银使用会打断用户体验，增加用户使用难度。对使用硬件加密的支付，不可能天天带着U盘跑。另外网银主要用在web端，在手机端，嵌入网银页面，还是比较难看的。 三 支付流程 走一个具体的例子看看吧。比如用户在电商系统中买了200块钱的东西，然后通过浦发银行卡做结算，用的是快捷支付。这个过程是： 用户在交易界面上，提交订单到交易系统中； 交易系统确认订单无误后，请求支付系统进行结算。这是在交易系统做的，后面工作就进入支付系统。 用户被引导到收银台页面， 让用户确认交易金额，选择支付方式，调用支付系统接口。 支付系统接收到支付请求，验证请求的各个字段是否有问题，确认无误后，调用支付网关执行支付。 支付网关请求浦发银行的快捷支付接口执行支付。 支付网关接收到支付结果报文后，对结果报文做解析，获取结果，并将结果告知交易系统。这可以通过URL或者RPC调用来实现。 商城系统收到支付结果后，开始执行后续操作。如果是支付成功，则开始准备出库。这一步在交易系统中处理，这里不做介绍。 网银支付，和快捷相比，就在第4步，插入一个步骤，将用户导航到网银页面输入支付信息，后续步骤是一样的。在资金流上也是相同的。 而在第五步获取返回结果上，一般银行就直接同步返回，银联是分为同步和异步返回。同步告知操作成功或者失败，异步告知扣款成功或者失败。同步操作和异步操作都需要调用方提供一个回调的URL地址，银联会将参数附加在这个地址上。通过解析这些参数可以得到执行结果。异步操作一般有2-3秒的延迟，取决于网络，以及该交易处理的复杂度。 四 资金流 上一节说的是支付的信息流，那资金流应该是怎么走的？ 在第三步，会触发资金流。资金从用户个人账户上转移到电商公司的账户。当然，银行也不是活雷锋，这一笔交易是要收手续费的。资金是实时到账的，手续费一般是按月结算。有按交易笔数计费的，但大部分还是按照交易金额来收费。 同行快捷支付是比较简单的场景，让我们来逐步增加难度。如果支付系统没有对接浦发银行，那对浦发卡，就得走其它支付方式:银联或者第三方支付。 先说银联快捷。银联提供的多种接入方式，常说的快捷支付，在银联文档中叫商户侧开通token接口。通过这个接口，可以实现同行和跨行资金结算。不管收款行是浦发还是其它行，都可以完成结算。对本地和用户来说，体验是一样的。而在银联侧，后台资金流处理却不一样。了解这个资金流，有助于在异常情况下，了解资金到底跑到哪里了。 如果收款行也是浦发银行，银联发报文给浦发，浦发使用内部系统完成两个账户间的转帐，即时完成。 如果收款行是他行，比如工行。银联发指令给浦发和工行，分别完成各自账户上资金余额的增减，对个人和电商来说，这笔资金算是落地了。但实际资金流并不是立即发生。银联会在半夜做清结算后处理这笔资金。这个过程就是金融机构之间的清结算了，一般不需要关注。 如果使用的是第三方支付，对用户来说，处理的流程和银联一样。但资金流会不一样。 第三方支付在浦发和工行一般都会有落地的托管资金。 发生交易后，一般来说不会产生跨行资金流动。用户在浦发行的钱会被结算到第三方支付在浦发行的托管账户，而在工行的钱，会由第三方支付在工行的账户打到客户账户上。 这就降低了跨行资金流动成本。 目前国内主要银行都提供快捷和直联的接口。对电商来说，要对接哪些银行是个需要考虑的问题。（参见支付渠道） 银联Token支付 一般来说，大部分银行都提供直联和网银接口，但不需要直接对接所有银行。银联和第三方支付也提供直联接口，可以直接对接国内主要银行。也不是所有银行都被银联支持，这和银联签约的接口有关，需要在对接时咨询银联。从我们使用情况看， 浦发借记卡、邮储银行卡是不支持的。 另外 交行、平安（含原深发）、上海银行、浦发、北京银行，上述银行卡需通过&nbsp;这个地址&nbsp;开通银联在线支付业务。 五 对接银行 大部分银行提供的银行卡支付接口，借记卡支付和贷记卡支付是不一样的。但也有几个好心的银行，可以用一套接口同时开通借记卡和贷记卡。点名赞一下这些银行： 宇宙第一大行工商银行和建设银行。作为国内最保守的软件团队，和银行对接时务必做好足够的准备。在商务谈判完成、拿到银行的接口文档后，需要考虑两个问题：专线问题、加密问题。 卡bin 对接银行有一个逃避不了的问题，就是如何根据卡号判断发卡行？这就需要卡bin。 BIN号即银行标识代码的英文缩写。BIN由6位数字表示，出现在卡号的前6位，由国际标准化组织(ISO)分配给各从事跨行转接交换的银行卡组织。银行卡的卡号是标识发卡机构和持卡人信息的号码，由以下三部分组成：发卡行标识代码(BIN号)、发卡行自定义位、校验码。目前，国内的 银行卡 按照数字打头的不同分别归属于不同的银行卡组织，其中以BIN号“4”字打头的银行卡属于VISA卡组织，以“5”字打头的属于MASTERCARD卡组织，以“9”字和“62”、“60”打头的属于中国银联，而“62”、“60”打头的银联卡是符合国际标准的银联标准卡 ，可以在国外使用，这也是中国银联近几年来主要发行的银行卡片。 大部分银行卡号前6位即可确定发卡行和卡类型，但也有非标卡需要6-10位才可以判断出来。需要维护一个卡bin库. 发卡机构 BIN 范围 卡号长度 验证方式 美国运通国际股份有限公司 （America Express） 340000~349999 370000~379999 15位 LUHN 银联 620000~629999 16-19位 LUHN 大莱信用卡有限公司 （Diners Club） 300000-305999 300000-305999 309000-309999 360000-369999 380000-399999 14位 LUHN 大莱信用卡有限公司 （美国加拿大） 540000-559999 16位 LUHN 日本JCB 352800-358999 16位 LUHN 万事达卡 （MasterCard） 510000-559999 222100-272000 16位 LUHN 维萨卡 Visa 400000 - 499999 13,16,19位 LUHN 1.从卡号最后一位数字开始，逆向将奇数位(1、3、5…)相加。 2.从卡号最后一位数字开始，逆向将偶数位数字先乘以2，如果乘积结果为两位数，则将其减去9，再求和。 3.将奇数位总和加上偶数位总和，结果应该可以被10整除。 加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。 ***************************************规则比较简单，照着规则写实现验证了一下，代码如下****************************************************** package com.daojia.luhn; public class LuhnTest { public static void main(String[] args) { // TODO Auto-generated method stub System.out.println(isLuhn(&quot;6214830122080566&quot;)); } public static boolean isLuhn(String cardno){ System.out.println(&quot;input num=&quot;+cardno); if(null==cardno||cardno.equals(&quot;&quot;)) { return false; } //校验数字 int length = cardno.length(); int[] wei = new int[length]; int oddsum =0; int evensum =0; for(int i=0;i&lt;length;i++) { //从后往前截取数字 wei[i]= Integer.valueOf(cardno.substring(length-i-1, length-i)); //数字下表从0开始,相对于规则奇数 if(i%2==0) { evensum = evensum+ wei[i]; }else{ //偶数规则：计算 int dounum = doublecount(wei[i]); oddsum = oddsum+ dounum; } } System.out.println(&quot;oddsum=&quot;+oddsum); System.out.println(&quot;evensum=&quot;+evensum); if ((oddsum + evensum) % 10 == 0) { return true; }else{ return false; } } public static int doublecount(int num) { int result = 0; return result=(num*2&gt;=10)?(num*2-9):num*2; } } 输出： 在加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。 我理解这个应该在前段做js校验，校验有问题的提示不强求。 短信和身份验证 一般绑卡操作第五步需要银行下发短信验证码。 短信验证的接口，不同银行还不一样。有些银行是短信和身份验证一起做了；有些银行是可以配置身份验证是否同时发短信。还有些比较奇葩的机构，比如某联，接口中让你传身份信息，但实际上没传也是可以的，也不验证身份信息到底对不对。这在对接渠道时需要特别注意。 版本号：当前接口的版本号； 编码方式： 默认都是UTF-8，指传输的内容的编码方式； 签名和签名方法： 生成报文的签名。 不是所有的字段都需要放到签名中，文档中会说明哪些字段需要签名； 签名算法：生成签名的算法，RSA, RSA128， MD5等。 商户代码：在渠道侧注册的商户号。 商户订单号：即发送给渠道的订单号； 发送时间：该请求送出的时间。 账号和账号类型： 银行卡、存折、IC卡等支持的账号类型以及对应的账号； 卡的加密信息：如信用卡的CVN2，有效期等。 开户行信息：开户行所在地以及名称；大部分是不需要的。 身份证件类型和身份证号： 可以用于实名验证的证件，指 身份证、军官证、护照、回乡证、台胞证、警官证、士兵证等。不同银行可以支持的证件类型不一样，这也不是问题。大部分就是身份证了。 姓名：真实姓名，必须和身份证一致； 手机号：在所在银行注册的手机号。 系统会返回上述数据的验证结果。如果验证通过，则会发短信。具体参数一接口文档为准。 绑卡接口 绑卡接口和发短信接口类似，还需要将用户的卡号，身份证等信息传递过去。在绑卡成功后，会返回一个签约号。这个签约号是后续调用支付，解约等接口所必须的。银行都不支持重复绑卡，作者这里列举一些国内银行校验方法。 银联绑卡 银联直联绑卡和银行绑卡类似，但是得注意验证接口，仅验证卡号和姓名，不验证身份证号和手机号。这导致第5步无法正常进行。银联只有到第六步执行绑卡时才做身份验证。 所以在处理上，还需要做一些调整，来确保和银行的流程的一致。 一种处理方法是，对银联，在第五步就开始调用银联接口执行绑卡操作，但是在本地标记为预绑卡状态；商户侧发送短信验证码，验证通过后，才将状态设置为绑卡成功。 银联网银绑卡处理起来比较麻烦。用户在电商页面上输入卡号，然后被导航到银联页面上去完成绑卡操作，成功后，银联返回一个token作为签约号，用于支持后续操作。这问题就来了，用户可以在银联页面上绑定一个别人的卡，而电商侧是无法知道这个卡的情况的。所以这种方式尽量不要用。 实名认证 绑卡操作有个不错的副产品，就是实名认证。常说的二要素，三要素，四要素认证，可以通过这个操作完成。 二要素指姓名和身份证号，三要素加上银行卡号，四要素则加上手机号。看起来，似乎银行都应该支持四要素验证，但大部分银行接口仅支持三要素，毕竟手机号还是非常容易变。 当然，实名认证，也就是二要素认证，是应用最多的认证了。国内唯一的库是在公安部这，由NCIIC负责对外提供接口。 这里有第三方公司对接实名认证接口，从我们对接后上线来看，存在个别的人员因为行政区划调整，公安三方库不存在，但是去派出所查查到的case。 需要注意的问题： 验证短信由谁来发送。 对接的是总行还是分行接口； 是否支持重复绑卡，重复绑卡返回的Token是一样的还是不同的？ 身份验证是三要素还是四要素验证 Token和账号是否相同。 阅读更多" />
<meta property="og:description" content="前言： &nbsp; 本文属于学习笔记，首先感谢原作者：凤凰牌老熊，博客链接：http://blog.lixf.cn/&nbsp; 一 支付与交易 作者先明确了概念： 交易是生成订单；支付是对订单进行付款。&nbsp; 支付行为有多种：我们碰到的大部分都是单次支付，其次还有转账和退款。以常见的单次支付来说明流程。 二 银行卡支付 先说大家比较熟悉的银行卡支付，它分为线上支付和线下支付两种形式。线下支付就是通常说的POS收单，这里不介绍这个内容。对线上支付，按照卡的类别，分为贷记卡支付，也叫motopay、ePOS，即信用卡支付；和借记卡支付。按照支付形态，又分为认证支付、网银支付、快捷支付几种形态。银行卡网银支付要求银行卡必须开通在线支付功能，而快捷支付并不需要开通在线支付功能。主要利用支付验证要素（卡号、密码、手机号、CVN2、CVV2等），结合安全认证（例如短信验证码），让持卡人完成互联网支付。 认证支付 指用户在绑卡时，将卡信息提供给电商。这样在支付时，用户无需再输入这些信息，由电商在服务器侧保留用户的账户信息，比如身份证号，卡号，手机号。在用户支付时，无需再输入这些内容，最多就提供个密码或者校验码，就可以完成支付。这基本不会打断用户的使用体验，所以也是电商喜欢的支付方式。但认证支付最让人诟病的就是安全性。一方面需要向电商暴露个人信息，一旦被窃取，资金就容易被盗走。还有在手机上执行支付，一旦手机丢失，窃取者就可以轻而易举的使用或者转移资金。 快捷支付 快捷支付和认证支付类似，不同点在于绑卡之后，有些银行接口会返回token，后续使用token来作为支付凭证，无需提供卡号信息，这样电商也不需要本地保留卡号了。目前主要是银联有提供token接口。 网银支付 相对来说，网银支付要安全很多。网银支付是由银联或者银行提供支付界面，用户必须在页面上输入卡号，密码等验证信息才可以执行支付。大部分银行还要求用户使用U盾或者其它安全硬件。但安全和易用永远是个矛盾。网银使用会打断用户体验，增加用户使用难度。对使用硬件加密的支付，不可能天天带着U盘跑。另外网银主要用在web端，在手机端，嵌入网银页面，还是比较难看的。 三 支付流程 走一个具体的例子看看吧。比如用户在电商系统中买了200块钱的东西，然后通过浦发银行卡做结算，用的是快捷支付。这个过程是： 用户在交易界面上，提交订单到交易系统中； 交易系统确认订单无误后，请求支付系统进行结算。这是在交易系统做的，后面工作就进入支付系统。 用户被引导到收银台页面， 让用户确认交易金额，选择支付方式，调用支付系统接口。 支付系统接收到支付请求，验证请求的各个字段是否有问题，确认无误后，调用支付网关执行支付。 支付网关请求浦发银行的快捷支付接口执行支付。 支付网关接收到支付结果报文后，对结果报文做解析，获取结果，并将结果告知交易系统。这可以通过URL或者RPC调用来实现。 商城系统收到支付结果后，开始执行后续操作。如果是支付成功，则开始准备出库。这一步在交易系统中处理，这里不做介绍。 网银支付，和快捷相比，就在第4步，插入一个步骤，将用户导航到网银页面输入支付信息，后续步骤是一样的。在资金流上也是相同的。 而在第五步获取返回结果上，一般银行就直接同步返回，银联是分为同步和异步返回。同步告知操作成功或者失败，异步告知扣款成功或者失败。同步操作和异步操作都需要调用方提供一个回调的URL地址，银联会将参数附加在这个地址上。通过解析这些参数可以得到执行结果。异步操作一般有2-3秒的延迟，取决于网络，以及该交易处理的复杂度。 四 资金流 上一节说的是支付的信息流，那资金流应该是怎么走的？ 在第三步，会触发资金流。资金从用户个人账户上转移到电商公司的账户。当然，银行也不是活雷锋，这一笔交易是要收手续费的。资金是实时到账的，手续费一般是按月结算。有按交易笔数计费的，但大部分还是按照交易金额来收费。 同行快捷支付是比较简单的场景，让我们来逐步增加难度。如果支付系统没有对接浦发银行，那对浦发卡，就得走其它支付方式:银联或者第三方支付。 先说银联快捷。银联提供的多种接入方式，常说的快捷支付，在银联文档中叫商户侧开通token接口。通过这个接口，可以实现同行和跨行资金结算。不管收款行是浦发还是其它行，都可以完成结算。对本地和用户来说，体验是一样的。而在银联侧，后台资金流处理却不一样。了解这个资金流，有助于在异常情况下，了解资金到底跑到哪里了。 如果收款行也是浦发银行，银联发报文给浦发，浦发使用内部系统完成两个账户间的转帐，即时完成。 如果收款行是他行，比如工行。银联发指令给浦发和工行，分别完成各自账户上资金余额的增减，对个人和电商来说，这笔资金算是落地了。但实际资金流并不是立即发生。银联会在半夜做清结算后处理这笔资金。这个过程就是金融机构之间的清结算了，一般不需要关注。 如果使用的是第三方支付，对用户来说，处理的流程和银联一样。但资金流会不一样。 第三方支付在浦发和工行一般都会有落地的托管资金。 发生交易后，一般来说不会产生跨行资金流动。用户在浦发行的钱会被结算到第三方支付在浦发行的托管账户，而在工行的钱，会由第三方支付在工行的账户打到客户账户上。 这就降低了跨行资金流动成本。 目前国内主要银行都提供快捷和直联的接口。对电商来说，要对接哪些银行是个需要考虑的问题。（参见支付渠道） 银联Token支付 一般来说，大部分银行都提供直联和网银接口，但不需要直接对接所有银行。银联和第三方支付也提供直联接口，可以直接对接国内主要银行。也不是所有银行都被银联支持，这和银联签约的接口有关，需要在对接时咨询银联。从我们使用情况看， 浦发借记卡、邮储银行卡是不支持的。 另外 交行、平安（含原深发）、上海银行、浦发、北京银行，上述银行卡需通过&nbsp;这个地址&nbsp;开通银联在线支付业务。 五 对接银行 大部分银行提供的银行卡支付接口，借记卡支付和贷记卡支付是不一样的。但也有几个好心的银行，可以用一套接口同时开通借记卡和贷记卡。点名赞一下这些银行： 宇宙第一大行工商银行和建设银行。作为国内最保守的软件团队，和银行对接时务必做好足够的准备。在商务谈判完成、拿到银行的接口文档后，需要考虑两个问题：专线问题、加密问题。 卡bin 对接银行有一个逃避不了的问题，就是如何根据卡号判断发卡行？这就需要卡bin。 BIN号即银行标识代码的英文缩写。BIN由6位数字表示，出现在卡号的前6位，由国际标准化组织(ISO)分配给各从事跨行转接交换的银行卡组织。银行卡的卡号是标识发卡机构和持卡人信息的号码，由以下三部分组成：发卡行标识代码(BIN号)、发卡行自定义位、校验码。目前，国内的 银行卡 按照数字打头的不同分别归属于不同的银行卡组织，其中以BIN号“4”字打头的银行卡属于VISA卡组织，以“5”字打头的属于MASTERCARD卡组织，以“9”字和“62”、“60”打头的属于中国银联，而“62”、“60”打头的银联卡是符合国际标准的银联标准卡 ，可以在国外使用，这也是中国银联近几年来主要发行的银行卡片。 大部分银行卡号前6位即可确定发卡行和卡类型，但也有非标卡需要6-10位才可以判断出来。需要维护一个卡bin库. 发卡机构 BIN 范围 卡号长度 验证方式 美国运通国际股份有限公司 （America Express） 340000~349999 370000~379999 15位 LUHN 银联 620000~629999 16-19位 LUHN 大莱信用卡有限公司 （Diners Club） 300000-305999 300000-305999 309000-309999 360000-369999 380000-399999 14位 LUHN 大莱信用卡有限公司 （美国加拿大） 540000-559999 16位 LUHN 日本JCB 352800-358999 16位 LUHN 万事达卡 （MasterCard） 510000-559999 222100-272000 16位 LUHN 维萨卡 Visa 400000 - 499999 13,16,19位 LUHN 1.从卡号最后一位数字开始，逆向将奇数位(1、3、5…)相加。 2.从卡号最后一位数字开始，逆向将偶数位数字先乘以2，如果乘积结果为两位数，则将其减去9，再求和。 3.将奇数位总和加上偶数位总和，结果应该可以被10整除。 加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。 ***************************************规则比较简单，照着规则写实现验证了一下，代码如下****************************************************** package com.daojia.luhn; public class LuhnTest { public static void main(String[] args) { // TODO Auto-generated method stub System.out.println(isLuhn(&quot;6214830122080566&quot;)); } public static boolean isLuhn(String cardno){ System.out.println(&quot;input num=&quot;+cardno); if(null==cardno||cardno.equals(&quot;&quot;)) { return false; } //校验数字 int length = cardno.length(); int[] wei = new int[length]; int oddsum =0; int evensum =0; for(int i=0;i&lt;length;i++) { //从后往前截取数字 wei[i]= Integer.valueOf(cardno.substring(length-i-1, length-i)); //数字下表从0开始,相对于规则奇数 if(i%2==0) { evensum = evensum+ wei[i]; }else{ //偶数规则：计算 int dounum = doublecount(wei[i]); oddsum = oddsum+ dounum; } } System.out.println(&quot;oddsum=&quot;+oddsum); System.out.println(&quot;evensum=&quot;+evensum); if ((oddsum + evensum) % 10 == 0) { return true; }else{ return false; } } public static int doublecount(int num) { int result = 0; return result=(num*2&gt;=10)?(num*2-9):num*2; } } 输出： 在加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。 我理解这个应该在前段做js校验，校验有问题的提示不强求。 短信和身份验证 一般绑卡操作第五步需要银行下发短信验证码。 短信验证的接口，不同银行还不一样。有些银行是短信和身份验证一起做了；有些银行是可以配置身份验证是否同时发短信。还有些比较奇葩的机构，比如某联，接口中让你传身份信息，但实际上没传也是可以的，也不验证身份信息到底对不对。这在对接渠道时需要特别注意。 版本号：当前接口的版本号； 编码方式： 默认都是UTF-8，指传输的内容的编码方式； 签名和签名方法： 生成报文的签名。 不是所有的字段都需要放到签名中，文档中会说明哪些字段需要签名； 签名算法：生成签名的算法，RSA, RSA128， MD5等。 商户代码：在渠道侧注册的商户号。 商户订单号：即发送给渠道的订单号； 发送时间：该请求送出的时间。 账号和账号类型： 银行卡、存折、IC卡等支持的账号类型以及对应的账号； 卡的加密信息：如信用卡的CVN2，有效期等。 开户行信息：开户行所在地以及名称；大部分是不需要的。 身份证件类型和身份证号： 可以用于实名验证的证件，指 身份证、军官证、护照、回乡证、台胞证、警官证、士兵证等。不同银行可以支持的证件类型不一样，这也不是问题。大部分就是身份证了。 姓名：真实姓名，必须和身份证一致； 手机号：在所在银行注册的手机号。 系统会返回上述数据的验证结果。如果验证通过，则会发短信。具体参数一接口文档为准。 绑卡接口 绑卡接口和发短信接口类似，还需要将用户的卡号，身份证等信息传递过去。在绑卡成功后，会返回一个签约号。这个签约号是后续调用支付，解约等接口所必须的。银行都不支持重复绑卡，作者这里列举一些国内银行校验方法。 银联绑卡 银联直联绑卡和银行绑卡类似，但是得注意验证接口，仅验证卡号和姓名，不验证身份证号和手机号。这导致第5步无法正常进行。银联只有到第六步执行绑卡时才做身份验证。 所以在处理上，还需要做一些调整，来确保和银行的流程的一致。 一种处理方法是，对银联，在第五步就开始调用银联接口执行绑卡操作，但是在本地标记为预绑卡状态；商户侧发送短信验证码，验证通过后，才将状态设置为绑卡成功。 银联网银绑卡处理起来比较麻烦。用户在电商页面上输入卡号，然后被导航到银联页面上去完成绑卡操作，成功后，银联返回一个token作为签约号，用于支持后续操作。这问题就来了，用户可以在银联页面上绑定一个别人的卡，而电商侧是无法知道这个卡的情况的。所以这种方式尽量不要用。 实名认证 绑卡操作有个不错的副产品，就是实名认证。常说的二要素，三要素，四要素认证，可以通过这个操作完成。 二要素指姓名和身份证号，三要素加上银行卡号，四要素则加上手机号。看起来，似乎银行都应该支持四要素验证，但大部分银行接口仅支持三要素，毕竟手机号还是非常容易变。 当然，实名认证，也就是二要素认证，是应用最多的认证了。国内唯一的库是在公安部这，由NCIIC负责对外提供接口。 这里有第三方公司对接实名认证接口，从我们对接后上线来看，存在个别的人员因为行政区划调整，公安三方库不存在，但是去派出所查查到的case。 需要注意的问题： 验证短信由谁来发送。 对接的是总行还是分行接口； 是否支持重复绑卡，重复绑卡返回的Token是一样的还是不同的？ 身份验证是三要素还是四要素验证 Token和账号是否相同。 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/08/15/f20892bd698f3b373174e62f1cfc1d19.html" />
<meta property="og:url" content="https://mlh.app/2017/08/15/f20892bd698f3b373174e62f1cfc1d19.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-08-15T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"前言： &nbsp; 本文属于学习笔记，首先感谢原作者：凤凰牌老熊，博客链接：http://blog.lixf.cn/&nbsp; 一 支付与交易 作者先明确了概念： 交易是生成订单；支付是对订单进行付款。&nbsp; 支付行为有多种：我们碰到的大部分都是单次支付，其次还有转账和退款。以常见的单次支付来说明流程。 二 银行卡支付 先说大家比较熟悉的银行卡支付，它分为线上支付和线下支付两种形式。线下支付就是通常说的POS收单，这里不介绍这个内容。对线上支付，按照卡的类别，分为贷记卡支付，也叫motopay、ePOS，即信用卡支付；和借记卡支付。按照支付形态，又分为认证支付、网银支付、快捷支付几种形态。银行卡网银支付要求银行卡必须开通在线支付功能，而快捷支付并不需要开通在线支付功能。主要利用支付验证要素（卡号、密码、手机号、CVN2、CVV2等），结合安全认证（例如短信验证码），让持卡人完成互联网支付。 认证支付 指用户在绑卡时，将卡信息提供给电商。这样在支付时，用户无需再输入这些信息，由电商在服务器侧保留用户的账户信息，比如身份证号，卡号，手机号。在用户支付时，无需再输入这些内容，最多就提供个密码或者校验码，就可以完成支付。这基本不会打断用户的使用体验，所以也是电商喜欢的支付方式。但认证支付最让人诟病的就是安全性。一方面需要向电商暴露个人信息，一旦被窃取，资金就容易被盗走。还有在手机上执行支付，一旦手机丢失，窃取者就可以轻而易举的使用或者转移资金。 快捷支付 快捷支付和认证支付类似，不同点在于绑卡之后，有些银行接口会返回token，后续使用token来作为支付凭证，无需提供卡号信息，这样电商也不需要本地保留卡号了。目前主要是银联有提供token接口。 网银支付 相对来说，网银支付要安全很多。网银支付是由银联或者银行提供支付界面，用户必须在页面上输入卡号，密码等验证信息才可以执行支付。大部分银行还要求用户使用U盾或者其它安全硬件。但安全和易用永远是个矛盾。网银使用会打断用户体验，增加用户使用难度。对使用硬件加密的支付，不可能天天带着U盘跑。另外网银主要用在web端，在手机端，嵌入网银页面，还是比较难看的。 三 支付流程 走一个具体的例子看看吧。比如用户在电商系统中买了200块钱的东西，然后通过浦发银行卡做结算，用的是快捷支付。这个过程是： 用户在交易界面上，提交订单到交易系统中； 交易系统确认订单无误后，请求支付系统进行结算。这是在交易系统做的，后面工作就进入支付系统。 用户被引导到收银台页面， 让用户确认交易金额，选择支付方式，调用支付系统接口。 支付系统接收到支付请求，验证请求的各个字段是否有问题，确认无误后，调用支付网关执行支付。 支付网关请求浦发银行的快捷支付接口执行支付。 支付网关接收到支付结果报文后，对结果报文做解析，获取结果，并将结果告知交易系统。这可以通过URL或者RPC调用来实现。 商城系统收到支付结果后，开始执行后续操作。如果是支付成功，则开始准备出库。这一步在交易系统中处理，这里不做介绍。 网银支付，和快捷相比，就在第4步，插入一个步骤，将用户导航到网银页面输入支付信息，后续步骤是一样的。在资金流上也是相同的。 而在第五步获取返回结果上，一般银行就直接同步返回，银联是分为同步和异步返回。同步告知操作成功或者失败，异步告知扣款成功或者失败。同步操作和异步操作都需要调用方提供一个回调的URL地址，银联会将参数附加在这个地址上。通过解析这些参数可以得到执行结果。异步操作一般有2-3秒的延迟，取决于网络，以及该交易处理的复杂度。 四 资金流 上一节说的是支付的信息流，那资金流应该是怎么走的？ 在第三步，会触发资金流。资金从用户个人账户上转移到电商公司的账户。当然，银行也不是活雷锋，这一笔交易是要收手续费的。资金是实时到账的，手续费一般是按月结算。有按交易笔数计费的，但大部分还是按照交易金额来收费。 同行快捷支付是比较简单的场景，让我们来逐步增加难度。如果支付系统没有对接浦发银行，那对浦发卡，就得走其它支付方式:银联或者第三方支付。 先说银联快捷。银联提供的多种接入方式，常说的快捷支付，在银联文档中叫商户侧开通token接口。通过这个接口，可以实现同行和跨行资金结算。不管收款行是浦发还是其它行，都可以完成结算。对本地和用户来说，体验是一样的。而在银联侧，后台资金流处理却不一样。了解这个资金流，有助于在异常情况下，了解资金到底跑到哪里了。 如果收款行也是浦发银行，银联发报文给浦发，浦发使用内部系统完成两个账户间的转帐，即时完成。 如果收款行是他行，比如工行。银联发指令给浦发和工行，分别完成各自账户上资金余额的增减，对个人和电商来说，这笔资金算是落地了。但实际资金流并不是立即发生。银联会在半夜做清结算后处理这笔资金。这个过程就是金融机构之间的清结算了，一般不需要关注。 如果使用的是第三方支付，对用户来说，处理的流程和银联一样。但资金流会不一样。 第三方支付在浦发和工行一般都会有落地的托管资金。 发生交易后，一般来说不会产生跨行资金流动。用户在浦发行的钱会被结算到第三方支付在浦发行的托管账户，而在工行的钱，会由第三方支付在工行的账户打到客户账户上。 这就降低了跨行资金流动成本。 目前国内主要银行都提供快捷和直联的接口。对电商来说，要对接哪些银行是个需要考虑的问题。（参见支付渠道） 银联Token支付 一般来说，大部分银行都提供直联和网银接口，但不需要直接对接所有银行。银联和第三方支付也提供直联接口，可以直接对接国内主要银行。也不是所有银行都被银联支持，这和银联签约的接口有关，需要在对接时咨询银联。从我们使用情况看， 浦发借记卡、邮储银行卡是不支持的。 另外 交行、平安（含原深发）、上海银行、浦发、北京银行，上述银行卡需通过&nbsp;这个地址&nbsp;开通银联在线支付业务。 五 对接银行 大部分银行提供的银行卡支付接口，借记卡支付和贷记卡支付是不一样的。但也有几个好心的银行，可以用一套接口同时开通借记卡和贷记卡。点名赞一下这些银行： 宇宙第一大行工商银行和建设银行。作为国内最保守的软件团队，和银行对接时务必做好足够的准备。在商务谈判完成、拿到银行的接口文档后，需要考虑两个问题：专线问题、加密问题。 卡bin 对接银行有一个逃避不了的问题，就是如何根据卡号判断发卡行？这就需要卡bin。 BIN号即银行标识代码的英文缩写。BIN由6位数字表示，出现在卡号的前6位，由国际标准化组织(ISO)分配给各从事跨行转接交换的银行卡组织。银行卡的卡号是标识发卡机构和持卡人信息的号码，由以下三部分组成：发卡行标识代码(BIN号)、发卡行自定义位、校验码。目前，国内的 银行卡 按照数字打头的不同分别归属于不同的银行卡组织，其中以BIN号“4”字打头的银行卡属于VISA卡组织，以“5”字打头的属于MASTERCARD卡组织，以“9”字和“62”、“60”打头的属于中国银联，而“62”、“60”打头的银联卡是符合国际标准的银联标准卡 ，可以在国外使用，这也是中国银联近几年来主要发行的银行卡片。 大部分银行卡号前6位即可确定发卡行和卡类型，但也有非标卡需要6-10位才可以判断出来。需要维护一个卡bin库. 发卡机构 BIN 范围 卡号长度 验证方式 美国运通国际股份有限公司 （America Express） 340000~349999 370000~379999 15位 LUHN 银联 620000~629999 16-19位 LUHN 大莱信用卡有限公司 （Diners Club） 300000-305999 300000-305999 309000-309999 360000-369999 380000-399999 14位 LUHN 大莱信用卡有限公司 （美国加拿大） 540000-559999 16位 LUHN 日本JCB 352800-358999 16位 LUHN 万事达卡 （MasterCard） 510000-559999 222100-272000 16位 LUHN 维萨卡 Visa 400000 - 499999 13,16,19位 LUHN 1.从卡号最后一位数字开始，逆向将奇数位(1、3、5…)相加。 2.从卡号最后一位数字开始，逆向将偶数位数字先乘以2，如果乘积结果为两位数，则将其减去9，再求和。 3.将奇数位总和加上偶数位总和，结果应该可以被10整除。 加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。 ***************************************规则比较简单，照着规则写实现验证了一下，代码如下****************************************************** package com.daojia.luhn; public class LuhnTest { public static void main(String[] args) { // TODO Auto-generated method stub System.out.println(isLuhn(&quot;6214830122080566&quot;)); } public static boolean isLuhn(String cardno){ System.out.println(&quot;input num=&quot;+cardno); if(null==cardno||cardno.equals(&quot;&quot;)) { return false; } //校验数字 int length = cardno.length(); int[] wei = new int[length]; int oddsum =0; int evensum =0; for(int i=0;i&lt;length;i++) { //从后往前截取数字 wei[i]= Integer.valueOf(cardno.substring(length-i-1, length-i)); //数字下表从0开始,相对于规则奇数 if(i%2==0) { evensum = evensum+ wei[i]; }else{ //偶数规则：计算 int dounum = doublecount(wei[i]); oddsum = oddsum+ dounum; } } System.out.println(&quot;oddsum=&quot;+oddsum); System.out.println(&quot;evensum=&quot;+evensum); if ((oddsum + evensum) % 10 == 0) { return true; }else{ return false; } } public static int doublecount(int num) { int result = 0; return result=(num*2&gt;=10)?(num*2-9):num*2; } } 输出： 在加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。 我理解这个应该在前段做js校验，校验有问题的提示不强求。 短信和身份验证 一般绑卡操作第五步需要银行下发短信验证码。 短信验证的接口，不同银行还不一样。有些银行是短信和身份验证一起做了；有些银行是可以配置身份验证是否同时发短信。还有些比较奇葩的机构，比如某联，接口中让你传身份信息，但实际上没传也是可以的，也不验证身份信息到底对不对。这在对接渠道时需要特别注意。 版本号：当前接口的版本号； 编码方式： 默认都是UTF-8，指传输的内容的编码方式； 签名和签名方法： 生成报文的签名。 不是所有的字段都需要放到签名中，文档中会说明哪些字段需要签名； 签名算法：生成签名的算法，RSA, RSA128， MD5等。 商户代码：在渠道侧注册的商户号。 商户订单号：即发送给渠道的订单号； 发送时间：该请求送出的时间。 账号和账号类型： 银行卡、存折、IC卡等支持的账号类型以及对应的账号； 卡的加密信息：如信用卡的CVN2，有效期等。 开户行信息：开户行所在地以及名称；大部分是不需要的。 身份证件类型和身份证号： 可以用于实名验证的证件，指 身份证、军官证、护照、回乡证、台胞证、警官证、士兵证等。不同银行可以支持的证件类型不一样，这也不是问题。大部分就是身份证了。 姓名：真实姓名，必须和身份证一致； 手机号：在所在银行注册的手机号。 系统会返回上述数据的验证结果。如果验证通过，则会发短信。具体参数一接口文档为准。 绑卡接口 绑卡接口和发短信接口类似，还需要将用户的卡号，身份证等信息传递过去。在绑卡成功后，会返回一个签约号。这个签约号是后续调用支付，解约等接口所必须的。银行都不支持重复绑卡，作者这里列举一些国内银行校验方法。 银联绑卡 银联直联绑卡和银行绑卡类似，但是得注意验证接口，仅验证卡号和姓名，不验证身份证号和手机号。这导致第5步无法正常进行。银联只有到第六步执行绑卡时才做身份验证。 所以在处理上，还需要做一些调整，来确保和银行的流程的一致。 一种处理方法是，对银联，在第五步就开始调用银联接口执行绑卡操作，但是在本地标记为预绑卡状态；商户侧发送短信验证码，验证通过后，才将状态设置为绑卡成功。 银联网银绑卡处理起来比较麻烦。用户在电商页面上输入卡号，然后被导航到银联页面上去完成绑卡操作，成功后，银联返回一个token作为签约号，用于支持后续操作。这问题就来了，用户可以在银联页面上绑定一个别人的卡，而电商侧是无法知道这个卡的情况的。所以这种方式尽量不要用。 实名认证 绑卡操作有个不错的副产品，就是实名认证。常说的二要素，三要素，四要素认证，可以通过这个操作完成。 二要素指姓名和身份证号，三要素加上银行卡号，四要素则加上手机号。看起来，似乎银行都应该支持四要素验证，但大部分银行接口仅支持三要素，毕竟手机号还是非常容易变。 当然，实名认证，也就是二要素认证，是应用最多的认证了。国内唯一的库是在公安部这，由NCIIC负责对外提供接口。 这里有第三方公司对接实名认证接口，从我们对接后上线来看，存在个别的人员因为行政区划调整，公安三方库不存在，但是去派出所查查到的case。 需要注意的问题： 验证短信由谁来发送。 对接的是总行还是分行接口； 是否支持重复绑卡，重复绑卡返回的Token是一样的还是不同的？ 身份验证是三要素还是四要素验证 Token和账号是否相同。 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/08/15/f20892bd698f3b373174e62f1cfc1d19.html","headline":"【支付系统学习笔记】-二支付设计（银行卡支付）","dateModified":"2017-08-15T00:00:00+08:00","datePublished":"2017-08-15T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/08/15/f20892bd698f3b373174e62f1cfc1d19.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>【支付系统学习笔记】-二支付设计（银行卡支付）</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p><span style="color:rgb(102,102,102);font-family:'microsoft yahei';font-size:14px;line-height:24px;text-indent:28px;">前言： &nbsp; 本文属于学习笔记，首先感谢原作者：凤凰牌老熊，博客链接：http://blog.lixf.cn/&nbsp;</span></p> 
  <h1><span style="text-indent:28px;">一 支付与交易</span></h1> 
  <p style="text-indent:28px;"><span style="font-family:'microsoft yahei';color:#666666;"><span style="font-size:14px;line-height:24px;">作者先明确了概念：</span></span></p> 
  <p style="text-indent:28px;"><span style="font-family:'microsoft yahei';color:#666666;"><span style="font-size:14px;line-height:24px;"><span style="color:rgb(64,64,64);font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;">交易是生成订单；支付是对订单进行付款。&nbsp;</span><br></span></span></p> 
  <p>支付行为有多种：我们碰到的大部分都是单次支付，其次还有转账和退款。以常见的单次支付来说明流程。</p> 
  <h1>二 银行卡支付</h1> 
  <p><span style="color:rgb(64,64,64);font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;">先说大家比较熟悉的银行卡支付，它分为线上支付和线下支付两种形式。线下支付就是通常说的POS收单，这里不介绍这个内容。对线上支付，按照卡的类别，分为贷记卡支付，也叫motopay、ePOS，即信用卡支付；和借记卡支付。按照支付形态，又分为认证支付、网银支付、快捷支付几种形态。银行卡网银支付要求银行卡必须开通在线支付功能，而快捷支付并不需要开通在线支付功能。主要利用支付验证要素（卡号、密码、手机号、CVN2、CVV2等），结合安全认证（例如短信验证码），让持卡人完成互联网支付。</span><br></p> 
  <p></p> 
  <h2> 认证支付</h2> 
  <span style="color:rgb(64,64,64);font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;">指用户在绑卡时，将卡信息提供给电商。这样在支付时，用户无需再输入这些信息，由电商在服务器侧保留用户的账户信息，比如身份证号，卡号，手机号。在用户支付时，无需再输入这些内容，最多就提供个密码或者校验码，就可以完成支付。这基本不会打断用户的使用体验，所以也是电商喜欢的支付方式。但认证支付最让人诟病的就是安全性。一方面需要向电商暴露个人信息，一旦被窃取，资金就容易被盗走。还有在手机上执行支付，一旦手机丢失，窃取者就可以轻而易举的使用或者转移资金。</span>
  <br>
  <p></p> 
  <p></p> 
  <h2> 快捷支付</h2> 
  <br>
  <p></p> 
  <p><span style="color:rgb(64,64,64);font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;"><span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">快捷支付和认证支付类似，不同点在于绑卡之后，有些银行接口会返回token，后续使用token来作为支付凭证，无需提供卡号信息，这样电商也不需要本地保留卡号了。目前主要是银联有提供token接口。</span><br></span></p> 
  <p></p> 
  <h2>网银支付</h2> 
  <span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">相对来说，网银支付要安全很多。网银支付是由银联或者银行提供支付界面，用户必须在页面上输入卡号，密码等验证信息才可以执行支付。大部分银行还要求用户使用U盾或者其它安全硬件。但安全和易用永远是个矛盾。网银使用会打断用户体验，增加用户使用难度。对使用硬件加密的支付，不可能天天带着U盘跑。另外网银主要用在web端，在手机端，嵌入网银页面，还是比较难看的。</span>
  <br>
  <p></p> 
  <p></p> 
  <h1> 三 支付流程</h1> 
  <p></p> 
  <p style="clear:both;min-height:1em;font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;color:rgb(64,64,64);"> 走一个具体的例子看看吧。比如用户在电商系统中买了200块钱的东西，然后通过浦发银行卡做结算，用的是快捷支付。这个过程是：</p> 
  <ul class="list-paddingleft-2" style="font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;color:rgb(64,64,64);">
   <li> <p style="clear:both;min-height:1em;"> 用户在交易界面上，提交订单到交易系统中； 交易系统确认订单无误后，请求支付系统进行结算。这是在交易系统做的，后面工作就进入支付系统。</p> </li>
   <li> <p style="clear:both;min-height:1em;"> 用户被引导到收银台页面， 让用户确认交易金额，选择支付方式，调用支付系统接口。</p> </li>
   <li> <p style="clear:both;min-height:1em;"> 支付系统接收到支付请求，验证请求的各个字段是否有问题，确认无误后，调用支付网关执行支付。</p> </li>
   <li> <p style="clear:both;min-height:1em;"> 支付网关请求浦发银行的快捷支付接口执行支付。</p> </li>
   <li> <p style="clear:both;min-height:1em;"> 支付网关接收到支付结果报文后，对结果报文做解析，获取结果，并将结果告知交易系统。这可以通过URL或者RPC调用来实现。</p> </li>
   <li> <p style="clear:both;min-height:1em;"> 商城系统收到支付结果后，开始执行后续操作。如果是支付成功，则开始准备出库。这一步在交易系统中处理，这里不做介绍。</p> </li>
  </ul>
  <p style="clear:both;min-height:1em;"> <span style="font-size:14px;">网银支付，和快捷相比，就在第4步，插入一个步骤，将用户导航到网银页面输入支付信息，后续步骤是一样的。在资金流上也是相同的。 而在第五步获取返回结果上，一般银行就直接同步返回，银联是分为同步和异步返回。同步告知操作成功或者失败，异步告知扣款成功或者失败。同步操作和异步操作都需要调用方提供一个回调的URL地址，银联会将参数附加在这个地址上。通过解析这些参数可以得到执行结果。异步操作一般有2-3秒的延迟，取决于网络，以及该交易处理的复杂度。</span></p> 
  <h1>四 资金流</h1> 
  <p><span style="font-size:14px;">上一节说的是支付的信息流，那资金流应该是怎么走的？ 在第三步，会触发资金流。资金从用户个人账户上转移到电商公司的账户。当然，银行也不是活雷锋，这一笔交易是要收手续费的。资金是实时到账的，手续费一般是按月结算。有按交易笔数计费的，但大部分还是按照交易金额来收费。</span></p> 
  <p><span style="font-size:14px;">同行快捷支付是比较简单的场景，让我们来逐步增加难度。如果支付系统没有对接浦发银行，那对浦发卡，就得走其它支付方式:银联或者第三方支付。</span></p> 
  <p><span style="font-size:14px;">先说银联快捷。银联提供的多种接入方式，常说的快捷支付，在银联文档中叫商户侧开通token接口。通过这个接口，可以实现同行和跨行资金结算。不管收款行是浦发还是其它行，都可以完成结算。对本地和用户来说，体验是一样的。而在银联侧，后台资金流处理却不一样。了解这个资金流，有助于在异常情况下，了解资金到底跑到哪里了。</span></p> 
  <p>如果收款行也是浦发银行，银联发报文给浦发，浦发使用内部系统完成两个账户间的转帐，即时完成。<br></p> 
  <p><span style="font-size:14px;">如果收款行是他行，比如工行。银联发指令给浦发和工行，分别完成各自账户上资金余额的增减，对个人和电商来说，这笔资金算是落地了。但实际资金流并不是立即发生。银联会在半夜做清结算后处理这笔资金。这个过程就是金融机构之间的清结算了，一般不需要关注。</span></p> 
  <p><span style="font-size:14px;">如果使用的是第三方支付，对用户来说，处理的流程和银联一样。但资金流会不一样。 第三方支付在浦发和工行一般都会有落地的托管资金。 发生交易后，一般来说不会产生跨行资金流动。用户在浦发行的钱会被结算到第三方支付在浦发行的托管账户，而在工行的钱，会由第三方支付在工行的账户打到客户账户上。 这就降低了跨行资金流动成本。</span></p> 
  <p><span style="font-size:14px;">目前国内主要银行都提供快捷和直联的接口。对电商来说，要对接哪些银行是个需要考虑的问题。（参见支付渠道）</span></p> 
  <p><span style="font-size:14px;"></span></p> 
  <h2> 银联Token支付</h2> 
  <p></p> 
  <p>一般来说，大部分银行都提供直联和网银接口，但不需要直接对接所有银行。银联和第三方支付也提供直联接口，可以直接对接国内主要银行。也不是所有银行都被银联支持，这和银联签约的接口有关，需要在对接时咨询银联。从我们使用情况看， 浦发借记卡、邮储银行卡是不支持的。 另外 交行、平安（含原深发）、上海银行、浦发、北京银行，上述银行卡需通过&nbsp;这个地址&nbsp;开通银联在线支付业务。</p> 
  <h1>五 对接银行</h1> 
  <p><span style="color:rgb(64,64,64);font-family:'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif;font-size:16px;line-height:25.6px;">大部分银行提供的银行卡支付接口，借记卡支付和贷记卡支付是不一样的。但也有几个好心的银行，可以用一套接口同时开通借记卡和贷记卡。点名赞一下这些银行： 宇宙第一大行工商银行和建设银行。作为国内最保守的软件团队，和银行对接时务必做好足够的准备。在商务谈判完成、拿到银行的接口文档后，需要考虑两个问题：专线问题、加密问题。</span><br></p> 
  <h2>卡bin</h2> 
  <p><span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">对接银行有一个逃避不了的问题，就是如何根据卡号判断发卡行？这就需要卡bin。 BIN号即银行标识代码的英文缩写。BIN由6位数字表示，出现在卡号的前6位，由国际标准化组织(ISO)分配给各从事跨行转接交换的银行卡组织。银行卡的卡号是标识发卡机构和持卡人信息的号码，由以下三部分组成：发卡行标识代码(BIN号)、发卡行自定义位、校验码。目前，国内的 银行卡 按照数字打头的不同分别归属于不同的银行卡组织，其中以BIN号“4”字打头的银行卡属于VISA卡组织，以“5”字打头的属于MASTERCARD卡组织，以“9”字和“62”、“60”打头的属于中国银联，而“62”、“60”打头的银联卡是符合国际标准的银联标准卡 ，可以在国外使用，这也是中国银联近几年来主要发行的银行卡片。 大部分银行卡号前6位即可确定发卡行和卡类型，但也有非标卡需要6-10位才可以判断出来。需要维护一个卡bin库.</span><br></p> 
  <p></p> 
  <div class="table-responsive" style="min-height:.01%;color:rgb(64,64,64);font-size:16px;line-height:27.2px;"> 
   <table class="table" style="border-spacing:0px;border-collapse:collapse;background-color:transparent;">
    <thead>
     <tr>
      <th style="border-top-width:0px;border-bottom-width:2px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);line-height:1.42857;vertical-align:bottom;border-right-width:1px !important;border-left-width:1px !important;border-right-style:solid !important;border-left-style:solid !important;border-right-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;"> 发卡机构</th> 
      <th style="border-top-width:0px;border-bottom-width:2px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);line-height:1.42857;vertical-align:bottom;border-right-width:1px !important;border-left-width:1px !important;border-right-style:solid !important;border-left-style:solid !important;border-right-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;"> BIN 范围</th> 
      <th style="border-top-width:0px;border-bottom-width:2px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);line-height:1.42857;vertical-align:bottom;border-right-width:1px !important;border-left-width:1px !important;border-right-style:solid !important;border-left-style:solid !important;border-right-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;"> 卡号长度</th> 
      <th style="border-top-width:0px;border-bottom-width:2px;border-bottom-style:solid;border-bottom-color:rgb(221,221,221);line-height:1.42857;vertical-align:bottom;border-right-width:1px !important;border-left-width:1px !important;border-right-style:solid !important;border-left-style:solid !important;border-right-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;"> 验证方式</th> 
     </tr>
    </thead>
    <tbody>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 美国运通国际股份有限公司<br> （America Express）</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 340000~349999<br> 370000~379999</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 15位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 银联</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 620000~629999</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 16-19位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 大莱信用卡有限公司<br> （Diners Club）</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 300000-305999<br> 300000-305999<br> 309000-309999<br> 360000-369999<br> 380000-399999</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 14位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 大莱信用卡有限公司<br> （美国加拿大）</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 540000-559999</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 16位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 日本JCB</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 352800-358999</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 16位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 万事达卡<br> （MasterCard）</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 510000-559999<br> 222100-272000</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 16位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
     <tr>
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 维萨卡<br> Visa</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 400000 - 499999</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> 13,16,19位</td> 
      <td style="border-top-width:1px;border-right-width:1px !important;border-bottom-width:1px !important;border-left-width:1px !important;border-top-style:solid;border-right-style:solid !important;border-bottom-style:solid !important;border-left-style:solid !important;border-top-color:rgb(221,221,221);border-right-color:rgb(238,238,238) !important;border-bottom-color:rgb(238,238,238) !important;border-left-color:rgb(238,238,238) !important;line-height:1.42857;vertical-align:top;"> LUHN</td> 
     </tr>
    </tbody>
   </table>
  </div> 
  <p></p> 
  <p>1.从卡号最后一位数字开始，逆向将奇数位(1、3、5…)相加。<br> 2.从卡号最后一位数字开始，逆向将偶数位数字先乘以2，如果乘积结果为两位数，则将其减去9，再求和。<br> 3.将奇数位总和加上偶数位总和，结果应该可以被10整除。</p> 
  <p><span style="line-height:27.2px;">加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。</span></p> 
  <p><span style="line-height:27.2px;">***************************************规则比较简单，照着规则写实现验证了一下，代码如下******************************************************</span></p> 
  <p><span style="line-height:27.2px;"></span></p> 
  <pre><code class="language-java">package com.daojia.luhn;

public class LuhnTest {

	public static void main(String[] args) {
		// TODO Auto-generated method stub
		System.out.println(isLuhn("6214830122080566"));
	}
	
	public static boolean isLuhn(String cardno){
		System.out.println("input num="+cardno);
		if(null==cardno||cardno.equals(""))
		{
			return false;
		}
		//校验数字
		int length = cardno.length();
		int[] wei = new int[length];
		int oddsum =0;
		int evensum =0;
		for(int i=0;i&lt;length;i++)
		{
			//从后往前截取数字
			wei[i]= Integer.valueOf(cardno.substring(length-i-1, length-i));
		    //数字下表从0开始,相对于规则奇数
			if(i%2==0)
			{
				evensum = evensum+ wei[i];				
			}else{
				//偶数规则：计算
				int dounum = doublecount(wei[i]);
				oddsum = oddsum+ dounum;
			}
			
		}
		System.out.println("oddsum="+oddsum);
		System.out.println("evensum="+evensum);
		if ((oddsum + evensum) % 10 == 0)
		{
			return true;
		}else{
			return false;
		}
	}
	public static int doublecount(int num)
	{
		int result = 0;		
		return result=(num*2&gt;=10)?(num*2-9):num*2;
	}
	
}
</code></pre>输出： 
  <p></p> 
  <p><span style="line-height:27.2px;"><img src="https://blog.uzzz.org/_p?https://img-blog.csdn.net/20170815155217120?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvYm9odTgz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt=""><br><span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">在加卡的时候先做LUHN，可以排除一部分输错卡号的情况。但要注意，国内有些银行的卡号不符合上述各种规定。</span><br></span></p> 
  <p><span style="line-height:27.2px;"><span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">我理解这个应该在前段做js校验，校验有问题的提示不强求。</span></span></p> 
  <p></p> 
  <h2 id="短信和身份验证">短信和身份验证</h2> 
  <div>
   <span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">一般绑卡操作第五步需要银行下发短信验证码。 短信验证的接口，不同银行还不一样。有些银行是短信和身份验证一起做了；有些银行是可以配置身份验证是否同时发短信。还有些比较奇葩的机构，比如某联，接口中让你传身份信息，但实际上没传也是可以的，也不验证身份信息到底对不对。这在对接渠道时需要特别注意。</span>
   <br>
  </div> 
  <div> 
   <ul>
    <li> <p>版本号：当前接口的版本号；</p> </li>
    <li> <p>编码方式： 默认都是UTF-8，指传输的内容的编码方式；</p> </li>
    <li> <p>签名和签名方法： 生成报文的签名。 不是所有的字段都需要放到签名中，文档中会说明哪些字段需要签名；</p> </li>
    <li> <p>签名算法：生成签名的算法，RSA, RSA128， MD5等。</p> </li>
    <li> <p>商户代码：在渠道侧注册的商户号。</p> </li>
    <li> <p>商户订单号：即发送给渠道的订单号；</p> </li>
    <li> <p>发送时间：该请求送出的时间。</p> </li>
    <li> <p>账号和账号类型： 银行卡、存折、IC卡等支持的账号类型以及对应的账号；</p> </li>
    <li> <p>卡的加密信息：如信用卡的CVN2，有效期等。</p> </li>
    <li> <p>开户行信息：开户行所在地以及名称；大部分是不需要的。</p> </li>
    <li> <p>身份证件类型和身份证号： 可以用于实名验证的证件，指 身份证、军官证、护照、回乡证、台胞证、警官证、士兵证等。不同银行可以支持的证件类型不一样，这也不是问题。大部分就是身份证了。</p> </li>
    <li> <p>姓名：真实姓名，必须和身份证一致；</p> </li>
    <li> <p>手机号：在所在银行注册的手机号。</p> </li>
   </ul> 系统会返回上述数据的验证结果。如果验证通过，则会发短信。具体参数一接口文档为准。
  </div> 
  <h2>绑卡接口</h2> 
  <div>
   <span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">绑卡接口和发短信接口类似，还需要将用户的卡号，身份证等信息传递过去。在绑卡成功后，会返回一个签约号。这个签约号是后续调用支付，解约等接口所必须的。<span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">银行都不支持重复绑卡，作者这里列举一些国内银行校验方法。</span></span>
   <br>
  </div> 
  <h2>银联绑卡</h2> 
  <div> 
   <p style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;"> 银联直联绑卡和银行绑卡类似，但是得注意验证接口，仅验证卡号和姓名，不验证身份证号和手机号。这导致第5步无法正常进行。银联只有到第六步执行绑卡时才做身份验证。 所以在处理上，还需要做一些调整，来确保和银行的流程的一致。 一种处理方法是，对银联，在第五步就开始调用银联接口执行绑卡操作，但是在本地标记为预绑卡状态；商户侧发送短信验证码，验证通过后，才将状态设置为绑卡成功。</p> 
   <p style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;"> 银联网银绑卡处理起来比较麻烦。用户在电商页面上输入卡号，然后被导航到银联页面上去完成绑卡操作，成功后，银联返回一个token作为签约号，用于支持后续操作。这问题就来了，用户可以在银联页面上绑定一个别人的卡，而电商侧是无法知道这个卡的情况的。所以这种方式尽量不要用。</p> 
   <h2>实名认证</h2> 
  </div> 
  <div>
   <span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;"><span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;"><span style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">绑卡操作有个不错的副产品，就是实名认证。常说的二要素，三要素，四要素认证，可以通过这个操作完成。 二要素指姓名和身份证号，三要素加上银行卡号，四要素则加上手机号。看起来，似乎银行都应该支持四要素验证，但大部分银行接口仅支持三要素，毕竟手机号还是非常容易变。 当然，实名认证，也就是二要素认证，是应用最多的认证了。国内唯一的库是在公安部这，由NCIIC负责对外提供接口。</span><br></span></span>
  </div> 
  <p>这里有第三方公司对接实名认证接口，从我们对接后上线来看，存在个别的人员因为行政区划调整，公安三方库不存在，但是去派出所查查到的case。</p> 
  <p></p> 
  <p style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;"> 需要注意的问题：</p> 
  <ol style="color:rgb(64,64,64);font-size:16px;line-height:27.2px;">
   <li>验证短信由谁来发送。</li>
   <li>对接的是总行还是分行接口；</li>
   <li>是否支持重复绑卡，重复绑卡返回的Token是一样的还是不同的？</li>
   <li>身份验证是三要素还是四要素验证</li>
   <li>Token和账号是否相同。</li>
  </ol> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/bohu83/article/details/77186555,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/bohu83/article/details/77186555,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
