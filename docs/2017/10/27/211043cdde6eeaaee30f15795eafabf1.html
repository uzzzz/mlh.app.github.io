<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>如何编写智能合约（Smart Contract）- 从零构建和部署去中心化投票App，decentralization Voting Dapp | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="如何编写智能合约（Smart Contract）- 从零构建和部署去中心化投票App，decentralization Voting Dapp" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="孔壹学院：国内区块链职业教育领先品牌 作者：黎跃春，区块链、高可用架构工程师 微信：liyc1215 QQ群：348924182 博客：http://liyuechun.org 课程目标 了解区块链智能合约 学会搭建智能合约开发环境 学会如何编译智能合约 学会如何将智能合约部署到区块链 学会如何通过WebApp和智能合约尽心互动 掌握DApp（去中心化App）的整个开发部署流程 掌握去中心化在实战产品中应用的重大意义 项目效果图 编辑器选择 理论上讲任何编辑器都可以编写Solidity合约代码，比如：WebStorm，VSCode，Sublime，等等。我选择的是Atom，没有任何理由，因为Atom轻量并且界面漂亮。 移步https://atom.io/地址，下载安装Atom。 autocomplete-solidity代码自动补齐 linter-solium、linter-solidity代码错误检查 language-ethereum支持Solidity代码高亮以及Solidity代码片段 安装所需工具 首先开发机上必须装好Node.js，再使用以下命令安装所需的工具： $ npm install -g ethereumjs-testrpc truffle liyuechun:~ yuechunli$ npm install -g ethereumjs-testrpc truffle /usr/local/bin/testrpc -&gt; /usr/local/lib/node_modules/ethereumjs-testrpc/build/cli.node.js /usr/local/bin/truffle -&gt; /usr/local/lib/node_modules/truffle/build/cli.bundled.js + truffle@3.4.9 + ethereumjs-testrpc@4.1.3 added 1 package and updated 7 packages in 76.132s liyuechun:~ yuechunli$ 创建项目 /Users/liyuechun/Desktop/1012/Voting liyuechun:Voting yuechunli$ ls liyuechun:Voting yuechunli$ pwd /Users/liyuechun/Desktop/1012/Voting liyuechun:Voting yuechunli$ truffle unbox react-box Downloading... Unpacking... Setting up... Unbox successful. Sweet! Commands: Compile: truffle compile Migrate: truffle migrate Test contracts: truffle test Test dapp: npm test Run dev server: npm run start Build for production: npm run build liyuechun:Voting yuechunli$ 项目结构 contracts：编写智能合约的文件夹，所有的智能合约文件都放置在这里 migrations：部署合约配置的文件夹 src：基于React的Web端源码 test：智能合约测试用例文件夹 编写投票Dapp智能合约 在contracts文件夹下创建Voting.sol文件，将下面的代码拷贝到文件中。 pragma solidity ^0.4.4; contract Voting { // liyuechun -&gt; 10 // xietingfeng -&gt; 5 // liudehua -&gt; 20 mapping (bytes32 =&gt; uint8) public votesReceived; // 存储候选人名字的数组 bytes32[] public candidateList; // 构造函数 初始化候选人名单 function Voting(bytes32[] candidateNames) { candidateList = candidateNames; } // 查询某个候选人的总票数 function totalVotesFor(bytes32 candidate) constant returns (uint8) { require(validCandidate(candidate) == true); // 或者 // assert(validCandidate(candidate) == true); return votesReceived[candidate]; } // 为某个候选人投票 function voteForCandidate(bytes32 candidate) { assert(validCandidate(candidate) == true); votesReceived[candidate] += 1; } // 检索投票的姓名是不是候选人的名字 function validCandidate(bytes32 candidate) constant returns (bool) { for(uint i = 0; i &lt; candidateList.length; i++) { if (candidateList[i] == candidate) { return true; } } return false; } } 通过remix + metamask部署合约到Kovan Test Net 在Google浏览器里面安装MetaMask插件 打开https://remix.ethereum.org将合约代码拷贝到里面 确保MetaMask账号处于等于状态，并且有一定的以太币支付给矿工。 确保Environment是Injected Web3，如果切换不过来，关掉浏览器重新启动 在create函数中输入一个数组，数组里面的内容为候选人名单 点击create按钮，会弹出MetaMask界面让你确认，确认提交，过一会儿，合约就部署成功 可以测试给某个候选人投票，查询某个候选人的票数 拷贝合约地址 0xd3f33a2e553b363b432d7f81f721a2a6202ecc67 编译合约 liyuechun:Voting yuechunli$ truffle compile Compiling ./contracts/Migrations.sol... Compiling ./contracts/SimpleStorage.sol... Compiling ./contracts/Voting.sol... Writing artifacts to ./build/contracts liyuechun:Voting yuechunli$ 编译完合约以后在build/contracts文件夹下面会有一个Voting.json的abi文件。 查看Voting.json文件内容 { &quot;contract_name&quot;: &quot;Voting&quot;, &quot;abi&quot;: [ { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;totalVotesFor&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;validCandidate&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;votesReceived&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;candidateList&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;voteForCandidate&quot;, &quot;outputs&quot;: [], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidateNames&quot;, &quot;type&quot;: &quot;bytes32[]&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;constructor&quot; } ], &quot;unlinked_binary&quot;: &quot;0x6060604052341561000f57600080fd5b6040516103113803806103118339810160405280805190910190505b600181805161003e929160200190610046565b505b506100b5565b828054828255906000526020600020908101928215610083579160200282015b828111156100835782518255602090920191600190910190610066565b5b50610090929150610094565b5090565b6100b291905b80821115610090576000815560010161009a565b5090565b90565b61024d806100c46000396000f300606060405263ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416632f265cf78114610069578063392e6678146100955780637021939f146100bf578063b13c744b146100eb578063cc9ab26714610113575b600080fd5b341561007457600080fd5b61007f60043561012b565b60405160ff909116815260200160405180910390f35b34156100a057600080fd5b6100ab60043561015d565b604051901515815260200160405180910390f35b34156100ca57600080fd5b61007f6004356101af565b60405160ff909116815260200160405180910390f35b34156100f657600080fd5b6101016004356101c4565b60405190815260200160405180910390f35b341561011e57600080fd5b6101296004356101e7565b005b60006101368261015d565b151560011461014457600080fd5b5060008181526020819052604090205460ff165b919050565b6000805b6001548110156101a457600180548491908390811061017c57fe5b906000526020600020900160005b5054141561019b57600191506101a9565b5b600101610161565b600091505b50919050565b60006020819052908152604090205460ff1681565b60018054829081106101d257fe5b906000526020600020900160005b5054905081565b6101f08161015d565b15156001146101fb57fe5b6000818152602081905260409020805460ff8082166001011660ff199091161790555b505600a165627a7a723058206783a7ff47eae16f18011a9db2a3cc983350b779bf3181b7623c18d4bce363180029&quot;, &quot;networks&quot;: {}, &quot;schema_version&quot;: &quot;0.0.5&quot;, &quot;updated_at&quot;: 1507806214330 } 这个文件是编译后的abi文件，待会儿需要将这个文件的json导入到App.json中。 查看src/utils/getWeb3.js文件内容 import Web3 from &#39;web3&#39; let getWeb3 = new Promise(function(resolve, reject) { // Wait for loading completion to avoid race conditions with web3 injection timing. window.addEventListener(&#39;load&#39;, function() { var results var web3 = window.web3 // Checking if Web3 has been injected by the browser (Mist/MetaMask) if (typeof web3 !== &#39;undefined&#39;) { // Use Mist/MetaMask&#39;s provider. web3 = new Web3(web3.currentProvider) results = { web3: web3 } console.log(&#39;Injected web3 detected.&#39;); resolve(results) } else { // Fallback to localhost if no web3 injection. var provider = new Web3.providers.HttpProvider(&#39;http://localhost:8545&#39;) web3 = new Web3(provider) results = { web3: web3 } console.log(&#39;No web3 instance injected, using Local web3.&#39;); resolve(results) } }) }) export default getWeb3 这个文件主要是封装了一个getWeb3的promiss供我们直接使用，可以从getWeb3直接获取到web3对象供App.js文件中使用。 修改app.js前端代码和合约进行互动 import React, { Component } from &#39;react&#39; import VotingContract from &#39;../build/contracts/Voting.json&#39; import getWeb3 from &#39;./utils/getWeb3&#39; import &#39;./css/oswald.css&#39; import &#39;./css/open-sans.css&#39; import &#39;./css/pure-min.css&#39; import &#39;./App.css&#39; const contractAddress = &quot;0xd3f33a2e553b363b432d7f81f721a2a6202ecc67&quot;; var votingContractInstance; var _modifyVotingCount = (candidates,i,votingCount) =&gt; { console.log(&quot;---------&quot;); console.log(candidates); console.log(i); console.log(votingCount); let obj = candidates[i]; obj.votingCount = votingCount; return candidates; } class App extends Component { constructor(props) { super(props) this.state = { candidates: [ { &quot;name&quot;: &quot;Rama&quot;, &quot;id&quot;: 100, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;Nick&quot;, &quot;id&quot;: 101, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;Jose&quot;, &quot;id&quot;: 102, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;liyuechun&quot;, &quot;id&quot;: 103, &quot;votingCount&quot;: 0 } ], candidatesVoteCount: [&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;], web3: null } } componentWillMount() { // Get network provider and web3 instance. // See utils/getWeb3 for more info. getWeb3 .then(results =&gt; { this.setState({ web3: results.web3 }) // Instantiate contract once web3 provided. this.instantiateContract() }) .catch(() =&gt; { console.log(&#39;Error finding web3.&#39;) }) } instantiateContract() { /* * SMART CONTRACT EXAMPLE * * Normally these functions would be called in the context of a * state management library, but for convenience I&#39;ve placed them here. */ const contract = require(&#39;truffle-contract&#39;) const votingContract = contract(VotingContract) votingContract.setProvider(this.state.web3.currentProvider) // Declaring this for later so we can chain functions on SimpleStorage. // Get accounts. this.state.web3.eth.getAccounts((error, accounts) =&gt; { votingContract.at(contractAddress).then((instance) =&gt; { votingContractInstance = instance; for (let i = 0; i &lt; this.state.candidates.length; i++) { let object = this.state.candidates[i]; console.log(accounts[0]); console.log(votingContractInstance); console.log(votingContractInstance.totalVotesFor(object.name)); votingContractInstance.totalVotesFor(object.name).then(result =&gt; { console.log(i); console.log(result.c[0]); this.setState({ candidates: _modifyVotingCount(this.state.candidates,i,result.c[0]) }); }); } }) }) } render() { return ( &lt;div className=&quot;App&quot;&gt; &lt;ul&gt; { this.state.candidates.map((object) =&gt; { console.log(object); return ( &lt;li key={object.id}&gt;候选人：{object.name} 支持票数：{object.votingCount}&lt;/li&gt; ) }) } &lt;/ul&gt; &lt;input style={{width: 200,height: 30,borderWidth: 2,marginLeft: 40}} placeholder=&quot;请输入候选人姓名...&quot; ref=&quot;candidateInput&quot; /&gt; &lt;button style={{height: 30,borderWidth: 2,marginLeft: 20}} onClick={() =&gt; { console.log(this.refs.candidateInput); console.log(this.refs.candidateInput.value); let candidateName = this.refs.candidateInput.value; console.log(this.state.web3.eth.accounts[0]); votingContractInstance.voteForCandidate(candidateName).then((result =&gt; { console.log(result); console.log(candidateName); let number = 0; for(let i = 0; i &lt; this.state.candidates.length; i++) { let object = this.state.candidates[i]; if (object.name === candidateName) { number = i; break; } } votingContractInstance.totalVotesFor(candidateName).then(result =&gt; { this.setState({ candidates: _modifyVotingCount(this.state.candidates,number,result.c[0]) }); }); })); }}&gt;Voting&lt;/button&gt; &lt;/div&gt; ); } } export default App 打赏地址 **比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645 技术交流 区块链技术交流QQ群：348924182 阅读更多" />
<meta property="og:description" content="孔壹学院：国内区块链职业教育领先品牌 作者：黎跃春，区块链、高可用架构工程师 微信：liyc1215 QQ群：348924182 博客：http://liyuechun.org 课程目标 了解区块链智能合约 学会搭建智能合约开发环境 学会如何编译智能合约 学会如何将智能合约部署到区块链 学会如何通过WebApp和智能合约尽心互动 掌握DApp（去中心化App）的整个开发部署流程 掌握去中心化在实战产品中应用的重大意义 项目效果图 编辑器选择 理论上讲任何编辑器都可以编写Solidity合约代码，比如：WebStorm，VSCode，Sublime，等等。我选择的是Atom，没有任何理由，因为Atom轻量并且界面漂亮。 移步https://atom.io/地址，下载安装Atom。 autocomplete-solidity代码自动补齐 linter-solium、linter-solidity代码错误检查 language-ethereum支持Solidity代码高亮以及Solidity代码片段 安装所需工具 首先开发机上必须装好Node.js，再使用以下命令安装所需的工具： $ npm install -g ethereumjs-testrpc truffle liyuechun:~ yuechunli$ npm install -g ethereumjs-testrpc truffle /usr/local/bin/testrpc -&gt; /usr/local/lib/node_modules/ethereumjs-testrpc/build/cli.node.js /usr/local/bin/truffle -&gt; /usr/local/lib/node_modules/truffle/build/cli.bundled.js + truffle@3.4.9 + ethereumjs-testrpc@4.1.3 added 1 package and updated 7 packages in 76.132s liyuechun:~ yuechunli$ 创建项目 /Users/liyuechun/Desktop/1012/Voting liyuechun:Voting yuechunli$ ls liyuechun:Voting yuechunli$ pwd /Users/liyuechun/Desktop/1012/Voting liyuechun:Voting yuechunli$ truffle unbox react-box Downloading... Unpacking... Setting up... Unbox successful. Sweet! Commands: Compile: truffle compile Migrate: truffle migrate Test contracts: truffle test Test dapp: npm test Run dev server: npm run start Build for production: npm run build liyuechun:Voting yuechunli$ 项目结构 contracts：编写智能合约的文件夹，所有的智能合约文件都放置在这里 migrations：部署合约配置的文件夹 src：基于React的Web端源码 test：智能合约测试用例文件夹 编写投票Dapp智能合约 在contracts文件夹下创建Voting.sol文件，将下面的代码拷贝到文件中。 pragma solidity ^0.4.4; contract Voting { // liyuechun -&gt; 10 // xietingfeng -&gt; 5 // liudehua -&gt; 20 mapping (bytes32 =&gt; uint8) public votesReceived; // 存储候选人名字的数组 bytes32[] public candidateList; // 构造函数 初始化候选人名单 function Voting(bytes32[] candidateNames) { candidateList = candidateNames; } // 查询某个候选人的总票数 function totalVotesFor(bytes32 candidate) constant returns (uint8) { require(validCandidate(candidate) == true); // 或者 // assert(validCandidate(candidate) == true); return votesReceived[candidate]; } // 为某个候选人投票 function voteForCandidate(bytes32 candidate) { assert(validCandidate(candidate) == true); votesReceived[candidate] += 1; } // 检索投票的姓名是不是候选人的名字 function validCandidate(bytes32 candidate) constant returns (bool) { for(uint i = 0; i &lt; candidateList.length; i++) { if (candidateList[i] == candidate) { return true; } } return false; } } 通过remix + metamask部署合约到Kovan Test Net 在Google浏览器里面安装MetaMask插件 打开https://remix.ethereum.org将合约代码拷贝到里面 确保MetaMask账号处于等于状态，并且有一定的以太币支付给矿工。 确保Environment是Injected Web3，如果切换不过来，关掉浏览器重新启动 在create函数中输入一个数组，数组里面的内容为候选人名单 点击create按钮，会弹出MetaMask界面让你确认，确认提交，过一会儿，合约就部署成功 可以测试给某个候选人投票，查询某个候选人的票数 拷贝合约地址 0xd3f33a2e553b363b432d7f81f721a2a6202ecc67 编译合约 liyuechun:Voting yuechunli$ truffle compile Compiling ./contracts/Migrations.sol... Compiling ./contracts/SimpleStorage.sol... Compiling ./contracts/Voting.sol... Writing artifacts to ./build/contracts liyuechun:Voting yuechunli$ 编译完合约以后在build/contracts文件夹下面会有一个Voting.json的abi文件。 查看Voting.json文件内容 { &quot;contract_name&quot;: &quot;Voting&quot;, &quot;abi&quot;: [ { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;totalVotesFor&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;validCandidate&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;votesReceived&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;candidateList&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;voteForCandidate&quot;, &quot;outputs&quot;: [], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidateNames&quot;, &quot;type&quot;: &quot;bytes32[]&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;constructor&quot; } ], &quot;unlinked_binary&quot;: &quot;0x6060604052341561000f57600080fd5b6040516103113803806103118339810160405280805190910190505b600181805161003e929160200190610046565b505b506100b5565b828054828255906000526020600020908101928215610083579160200282015b828111156100835782518255602090920191600190910190610066565b5b50610090929150610094565b5090565b6100b291905b80821115610090576000815560010161009a565b5090565b90565b61024d806100c46000396000f300606060405263ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416632f265cf78114610069578063392e6678146100955780637021939f146100bf578063b13c744b146100eb578063cc9ab26714610113575b600080fd5b341561007457600080fd5b61007f60043561012b565b60405160ff909116815260200160405180910390f35b34156100a057600080fd5b6100ab60043561015d565b604051901515815260200160405180910390f35b34156100ca57600080fd5b61007f6004356101af565b60405160ff909116815260200160405180910390f35b34156100f657600080fd5b6101016004356101c4565b60405190815260200160405180910390f35b341561011e57600080fd5b6101296004356101e7565b005b60006101368261015d565b151560011461014457600080fd5b5060008181526020819052604090205460ff165b919050565b6000805b6001548110156101a457600180548491908390811061017c57fe5b906000526020600020900160005b5054141561019b57600191506101a9565b5b600101610161565b600091505b50919050565b60006020819052908152604090205460ff1681565b60018054829081106101d257fe5b906000526020600020900160005b5054905081565b6101f08161015d565b15156001146101fb57fe5b6000818152602081905260409020805460ff8082166001011660ff199091161790555b505600a165627a7a723058206783a7ff47eae16f18011a9db2a3cc983350b779bf3181b7623c18d4bce363180029&quot;, &quot;networks&quot;: {}, &quot;schema_version&quot;: &quot;0.0.5&quot;, &quot;updated_at&quot;: 1507806214330 } 这个文件是编译后的abi文件，待会儿需要将这个文件的json导入到App.json中。 查看src/utils/getWeb3.js文件内容 import Web3 from &#39;web3&#39; let getWeb3 = new Promise(function(resolve, reject) { // Wait for loading completion to avoid race conditions with web3 injection timing. window.addEventListener(&#39;load&#39;, function() { var results var web3 = window.web3 // Checking if Web3 has been injected by the browser (Mist/MetaMask) if (typeof web3 !== &#39;undefined&#39;) { // Use Mist/MetaMask&#39;s provider. web3 = new Web3(web3.currentProvider) results = { web3: web3 } console.log(&#39;Injected web3 detected.&#39;); resolve(results) } else { // Fallback to localhost if no web3 injection. var provider = new Web3.providers.HttpProvider(&#39;http://localhost:8545&#39;) web3 = new Web3(provider) results = { web3: web3 } console.log(&#39;No web3 instance injected, using Local web3.&#39;); resolve(results) } }) }) export default getWeb3 这个文件主要是封装了一个getWeb3的promiss供我们直接使用，可以从getWeb3直接获取到web3对象供App.js文件中使用。 修改app.js前端代码和合约进行互动 import React, { Component } from &#39;react&#39; import VotingContract from &#39;../build/contracts/Voting.json&#39; import getWeb3 from &#39;./utils/getWeb3&#39; import &#39;./css/oswald.css&#39; import &#39;./css/open-sans.css&#39; import &#39;./css/pure-min.css&#39; import &#39;./App.css&#39; const contractAddress = &quot;0xd3f33a2e553b363b432d7f81f721a2a6202ecc67&quot;; var votingContractInstance; var _modifyVotingCount = (candidates,i,votingCount) =&gt; { console.log(&quot;---------&quot;); console.log(candidates); console.log(i); console.log(votingCount); let obj = candidates[i]; obj.votingCount = votingCount; return candidates; } class App extends Component { constructor(props) { super(props) this.state = { candidates: [ { &quot;name&quot;: &quot;Rama&quot;, &quot;id&quot;: 100, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;Nick&quot;, &quot;id&quot;: 101, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;Jose&quot;, &quot;id&quot;: 102, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;liyuechun&quot;, &quot;id&quot;: 103, &quot;votingCount&quot;: 0 } ], candidatesVoteCount: [&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;], web3: null } } componentWillMount() { // Get network provider and web3 instance. // See utils/getWeb3 for more info. getWeb3 .then(results =&gt; { this.setState({ web3: results.web3 }) // Instantiate contract once web3 provided. this.instantiateContract() }) .catch(() =&gt; { console.log(&#39;Error finding web3.&#39;) }) } instantiateContract() { /* * SMART CONTRACT EXAMPLE * * Normally these functions would be called in the context of a * state management library, but for convenience I&#39;ve placed them here. */ const contract = require(&#39;truffle-contract&#39;) const votingContract = contract(VotingContract) votingContract.setProvider(this.state.web3.currentProvider) // Declaring this for later so we can chain functions on SimpleStorage. // Get accounts. this.state.web3.eth.getAccounts((error, accounts) =&gt; { votingContract.at(contractAddress).then((instance) =&gt; { votingContractInstance = instance; for (let i = 0; i &lt; this.state.candidates.length; i++) { let object = this.state.candidates[i]; console.log(accounts[0]); console.log(votingContractInstance); console.log(votingContractInstance.totalVotesFor(object.name)); votingContractInstance.totalVotesFor(object.name).then(result =&gt; { console.log(i); console.log(result.c[0]); this.setState({ candidates: _modifyVotingCount(this.state.candidates,i,result.c[0]) }); }); } }) }) } render() { return ( &lt;div className=&quot;App&quot;&gt; &lt;ul&gt; { this.state.candidates.map((object) =&gt; { console.log(object); return ( &lt;li key={object.id}&gt;候选人：{object.name} 支持票数：{object.votingCount}&lt;/li&gt; ) }) } &lt;/ul&gt; &lt;input style={{width: 200,height: 30,borderWidth: 2,marginLeft: 40}} placeholder=&quot;请输入候选人姓名...&quot; ref=&quot;candidateInput&quot; /&gt; &lt;button style={{height: 30,borderWidth: 2,marginLeft: 20}} onClick={() =&gt; { console.log(this.refs.candidateInput); console.log(this.refs.candidateInput.value); let candidateName = this.refs.candidateInput.value; console.log(this.state.web3.eth.accounts[0]); votingContractInstance.voteForCandidate(candidateName).then((result =&gt; { console.log(result); console.log(candidateName); let number = 0; for(let i = 0; i &lt; this.state.candidates.length; i++) { let object = this.state.candidates[i]; if (object.name === candidateName) { number = i; break; } } votingContractInstance.totalVotesFor(candidateName).then(result =&gt; { this.setState({ candidates: _modifyVotingCount(this.state.candidates,number,result.c[0]) }); }); })); }}&gt;Voting&lt;/button&gt; &lt;/div&gt; ); } } export default App 打赏地址 **比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645 技术交流 区块链技术交流QQ群：348924182 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/10/27/211043cdde6eeaaee30f15795eafabf1.html" />
<meta property="og:url" content="https://mlh.app/2017/10/27/211043cdde6eeaaee30f15795eafabf1.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-10-27T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"孔壹学院：国内区块链职业教育领先品牌 作者：黎跃春，区块链、高可用架构工程师 微信：liyc1215 QQ群：348924182 博客：http://liyuechun.org 课程目标 了解区块链智能合约 学会搭建智能合约开发环境 学会如何编译智能合约 学会如何将智能合约部署到区块链 学会如何通过WebApp和智能合约尽心互动 掌握DApp（去中心化App）的整个开发部署流程 掌握去中心化在实战产品中应用的重大意义 项目效果图 编辑器选择 理论上讲任何编辑器都可以编写Solidity合约代码，比如：WebStorm，VSCode，Sublime，等等。我选择的是Atom，没有任何理由，因为Atom轻量并且界面漂亮。 移步https://atom.io/地址，下载安装Atom。 autocomplete-solidity代码自动补齐 linter-solium、linter-solidity代码错误检查 language-ethereum支持Solidity代码高亮以及Solidity代码片段 安装所需工具 首先开发机上必须装好Node.js，再使用以下命令安装所需的工具： $ npm install -g ethereumjs-testrpc truffle liyuechun:~ yuechunli$ npm install -g ethereumjs-testrpc truffle /usr/local/bin/testrpc -&gt; /usr/local/lib/node_modules/ethereumjs-testrpc/build/cli.node.js /usr/local/bin/truffle -&gt; /usr/local/lib/node_modules/truffle/build/cli.bundled.js + truffle@3.4.9 + ethereumjs-testrpc@4.1.3 added 1 package and updated 7 packages in 76.132s liyuechun:~ yuechunli$ 创建项目 /Users/liyuechun/Desktop/1012/Voting liyuechun:Voting yuechunli$ ls liyuechun:Voting yuechunli$ pwd /Users/liyuechun/Desktop/1012/Voting liyuechun:Voting yuechunli$ truffle unbox react-box Downloading... Unpacking... Setting up... Unbox successful. Sweet! Commands: Compile: truffle compile Migrate: truffle migrate Test contracts: truffle test Test dapp: npm test Run dev server: npm run start Build for production: npm run build liyuechun:Voting yuechunli$ 项目结构 contracts：编写智能合约的文件夹，所有的智能合约文件都放置在这里 migrations：部署合约配置的文件夹 src：基于React的Web端源码 test：智能合约测试用例文件夹 编写投票Dapp智能合约 在contracts文件夹下创建Voting.sol文件，将下面的代码拷贝到文件中。 pragma solidity ^0.4.4; contract Voting { // liyuechun -&gt; 10 // xietingfeng -&gt; 5 // liudehua -&gt; 20 mapping (bytes32 =&gt; uint8) public votesReceived; // 存储候选人名字的数组 bytes32[] public candidateList; // 构造函数 初始化候选人名单 function Voting(bytes32[] candidateNames) { candidateList = candidateNames; } // 查询某个候选人的总票数 function totalVotesFor(bytes32 candidate) constant returns (uint8) { require(validCandidate(candidate) == true); // 或者 // assert(validCandidate(candidate) == true); return votesReceived[candidate]; } // 为某个候选人投票 function voteForCandidate(bytes32 candidate) { assert(validCandidate(candidate) == true); votesReceived[candidate] += 1; } // 检索投票的姓名是不是候选人的名字 function validCandidate(bytes32 candidate) constant returns (bool) { for(uint i = 0; i &lt; candidateList.length; i++) { if (candidateList[i] == candidate) { return true; } } return false; } } 通过remix + metamask部署合约到Kovan Test Net 在Google浏览器里面安装MetaMask插件 打开https://remix.ethereum.org将合约代码拷贝到里面 确保MetaMask账号处于等于状态，并且有一定的以太币支付给矿工。 确保Environment是Injected Web3，如果切换不过来，关掉浏览器重新启动 在create函数中输入一个数组，数组里面的内容为候选人名单 点击create按钮，会弹出MetaMask界面让你确认，确认提交，过一会儿，合约就部署成功 可以测试给某个候选人投票，查询某个候选人的票数 拷贝合约地址 0xd3f33a2e553b363b432d7f81f721a2a6202ecc67 编译合约 liyuechun:Voting yuechunli$ truffle compile Compiling ./contracts/Migrations.sol... Compiling ./contracts/SimpleStorage.sol... Compiling ./contracts/Voting.sol... Writing artifacts to ./build/contracts liyuechun:Voting yuechunli$ 编译完合约以后在build/contracts文件夹下面会有一个Voting.json的abi文件。 查看Voting.json文件内容 { &quot;contract_name&quot;: &quot;Voting&quot;, &quot;abi&quot;: [ { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;totalVotesFor&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;validCandidate&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bool&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;votesReceived&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint8&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: true, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;candidateList&quot;, &quot;outputs&quot;: [ { &quot;name&quot;: &quot;&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;constant&quot;: false, &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidate&quot;, &quot;type&quot;: &quot;bytes32&quot; } ], &quot;name&quot;: &quot;voteForCandidate&quot;, &quot;outputs&quot;: [], &quot;payable&quot;: false, &quot;type&quot;: &quot;function&quot; }, { &quot;inputs&quot;: [ { &quot;name&quot;: &quot;candidateNames&quot;, &quot;type&quot;: &quot;bytes32[]&quot; } ], &quot;payable&quot;: false, &quot;type&quot;: &quot;constructor&quot; } ], &quot;unlinked_binary&quot;: &quot;0x6060604052341561000f57600080fd5b6040516103113803806103118339810160405280805190910190505b600181805161003e929160200190610046565b505b506100b5565b828054828255906000526020600020908101928215610083579160200282015b828111156100835782518255602090920191600190910190610066565b5b50610090929150610094565b5090565b6100b291905b80821115610090576000815560010161009a565b5090565b90565b61024d806100c46000396000f300606060405263ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416632f265cf78114610069578063392e6678146100955780637021939f146100bf578063b13c744b146100eb578063cc9ab26714610113575b600080fd5b341561007457600080fd5b61007f60043561012b565b60405160ff909116815260200160405180910390f35b34156100a057600080fd5b6100ab60043561015d565b604051901515815260200160405180910390f35b34156100ca57600080fd5b61007f6004356101af565b60405160ff909116815260200160405180910390f35b34156100f657600080fd5b6101016004356101c4565b60405190815260200160405180910390f35b341561011e57600080fd5b6101296004356101e7565b005b60006101368261015d565b151560011461014457600080fd5b5060008181526020819052604090205460ff165b919050565b6000805b6001548110156101a457600180548491908390811061017c57fe5b906000526020600020900160005b5054141561019b57600191506101a9565b5b600101610161565b600091505b50919050565b60006020819052908152604090205460ff1681565b60018054829081106101d257fe5b906000526020600020900160005b5054905081565b6101f08161015d565b15156001146101fb57fe5b6000818152602081905260409020805460ff8082166001011660ff199091161790555b505600a165627a7a723058206783a7ff47eae16f18011a9db2a3cc983350b779bf3181b7623c18d4bce363180029&quot;, &quot;networks&quot;: {}, &quot;schema_version&quot;: &quot;0.0.5&quot;, &quot;updated_at&quot;: 1507806214330 } 这个文件是编译后的abi文件，待会儿需要将这个文件的json导入到App.json中。 查看src/utils/getWeb3.js文件内容 import Web3 from &#39;web3&#39; let getWeb3 = new Promise(function(resolve, reject) { // Wait for loading completion to avoid race conditions with web3 injection timing. window.addEventListener(&#39;load&#39;, function() { var results var web3 = window.web3 // Checking if Web3 has been injected by the browser (Mist/MetaMask) if (typeof web3 !== &#39;undefined&#39;) { // Use Mist/MetaMask&#39;s provider. web3 = new Web3(web3.currentProvider) results = { web3: web3 } console.log(&#39;Injected web3 detected.&#39;); resolve(results) } else { // Fallback to localhost if no web3 injection. var provider = new Web3.providers.HttpProvider(&#39;http://localhost:8545&#39;) web3 = new Web3(provider) results = { web3: web3 } console.log(&#39;No web3 instance injected, using Local web3.&#39;); resolve(results) } }) }) export default getWeb3 这个文件主要是封装了一个getWeb3的promiss供我们直接使用，可以从getWeb3直接获取到web3对象供App.js文件中使用。 修改app.js前端代码和合约进行互动 import React, { Component } from &#39;react&#39; import VotingContract from &#39;../build/contracts/Voting.json&#39; import getWeb3 from &#39;./utils/getWeb3&#39; import &#39;./css/oswald.css&#39; import &#39;./css/open-sans.css&#39; import &#39;./css/pure-min.css&#39; import &#39;./App.css&#39; const contractAddress = &quot;0xd3f33a2e553b363b432d7f81f721a2a6202ecc67&quot;; var votingContractInstance; var _modifyVotingCount = (candidates,i,votingCount) =&gt; { console.log(&quot;---------&quot;); console.log(candidates); console.log(i); console.log(votingCount); let obj = candidates[i]; obj.votingCount = votingCount; return candidates; } class App extends Component { constructor(props) { super(props) this.state = { candidates: [ { &quot;name&quot;: &quot;Rama&quot;, &quot;id&quot;: 100, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;Nick&quot;, &quot;id&quot;: 101, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;Jose&quot;, &quot;id&quot;: 102, &quot;votingCount&quot;: 0 }, { &quot;name&quot;: &quot;liyuechun&quot;, &quot;id&quot;: 103, &quot;votingCount&quot;: 0 } ], candidatesVoteCount: [&quot;0&quot;,&quot;0&quot;,&quot;0&quot;,&quot;0&quot;], web3: null } } componentWillMount() { // Get network provider and web3 instance. // See utils/getWeb3 for more info. getWeb3 .then(results =&gt; { this.setState({ web3: results.web3 }) // Instantiate contract once web3 provided. this.instantiateContract() }) .catch(() =&gt; { console.log(&#39;Error finding web3.&#39;) }) } instantiateContract() { /* * SMART CONTRACT EXAMPLE * * Normally these functions would be called in the context of a * state management library, but for convenience I&#39;ve placed them here. */ const contract = require(&#39;truffle-contract&#39;) const votingContract = contract(VotingContract) votingContract.setProvider(this.state.web3.currentProvider) // Declaring this for later so we can chain functions on SimpleStorage. // Get accounts. this.state.web3.eth.getAccounts((error, accounts) =&gt; { votingContract.at(contractAddress).then((instance) =&gt; { votingContractInstance = instance; for (let i = 0; i &lt; this.state.candidates.length; i++) { let object = this.state.candidates[i]; console.log(accounts[0]); console.log(votingContractInstance); console.log(votingContractInstance.totalVotesFor(object.name)); votingContractInstance.totalVotesFor(object.name).then(result =&gt; { console.log(i); console.log(result.c[0]); this.setState({ candidates: _modifyVotingCount(this.state.candidates,i,result.c[0]) }); }); } }) }) } render() { return ( &lt;div className=&quot;App&quot;&gt; &lt;ul&gt; { this.state.candidates.map((object) =&gt; { console.log(object); return ( &lt;li key={object.id}&gt;候选人：{object.name} 支持票数：{object.votingCount}&lt;/li&gt; ) }) } &lt;/ul&gt; &lt;input style={{width: 200,height: 30,borderWidth: 2,marginLeft: 40}} placeholder=&quot;请输入候选人姓名...&quot; ref=&quot;candidateInput&quot; /&gt; &lt;button style={{height: 30,borderWidth: 2,marginLeft: 20}} onClick={() =&gt; { console.log(this.refs.candidateInput); console.log(this.refs.candidateInput.value); let candidateName = this.refs.candidateInput.value; console.log(this.state.web3.eth.accounts[0]); votingContractInstance.voteForCandidate(candidateName).then((result =&gt; { console.log(result); console.log(candidateName); let number = 0; for(let i = 0; i &lt; this.state.candidates.length; i++) { let object = this.state.candidates[i]; if (object.name === candidateName) { number = i; break; } } votingContractInstance.totalVotesFor(candidateName).then(result =&gt; { this.setState({ candidates: _modifyVotingCount(this.state.candidates,number,result.c[0]) }); }); })); }}&gt;Voting&lt;/button&gt; &lt;/div&gt; ); } } export default App 打赏地址 **比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645 技术交流 区块链技术交流QQ群：348924182 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/10/27/211043cdde6eeaaee30f15795eafabf1.html","headline":"如何编写智能合约（Smart Contract）- 从零构建和部署去中心化投票App，decentralization Voting Dapp","dateModified":"2017-10-27T00:00:00+08:00","datePublished":"2017-10-27T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/10/27/211043cdde6eeaaee30f15795eafabf1.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>如何编写智能合约（Smart Contract）- 从零构建和部署去中心化投票App，decentralization Voting Dapp</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <blockquote> 
   <p><a href="http://www.kongyixueyuan.com" rel="nofollow">孔壹学院：国内区块链职业教育领先品牌</a></p> 
   <p>作者：黎跃春，区块链、高可用架构工程师 <br> 微信：liyc1215 QQ群：348924182 博客：<a href="http://liyuechun.org" rel="nofollow">http://liyuechun.org</a></p> 
  </blockquote> 
  <h3 id="课程目标">课程目标</h3> 
  <ol> 
   <li>了解区块链智能合约</li> 
   <li>学会搭建智能合约开发环境</li> 
   <li>学会如何编译智能合约</li> 
   <li>学会如何将智能合约部署到区块链</li> 
   <li>学会如何通过WebApp和智能合约尽心互动</li> 
   <li>掌握DApp（去中心化App）的整个开发部署流程</li> 
   <li>掌握去中心化在实战产品中应用的重大意义</li> 
  </ol> 
  <h3 id="项目效果图">项目效果图</h3> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/dappxiaoguotu.gif" alt="去中心化投票App" title=""></p> 
  <h3 id="编辑器选择">编辑器选择</h3> 
  <p>理论上讲任何编辑器都可以编写<code>Solidity</code>合约代码，比如：WebStorm，VSCode，Sublime，等等。我选择的是Atom，没有任何理由，因为Atom轻量并且界面漂亮。</p> 
  <ul> 
   <li><p>移步<a href="https://atom.io/" rel="nofollow" target="_blank">https://atom.io/</a>地址，下载安装Atom。</p></li> 
   <li><p><code>autocomplete-solidity</code>代码自动补齐</p></li> 
  </ul> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/autocomplete-solidity.gif" alt="autocomplete-solidity" title=""></p> 
  <ul> 
   <li><p><code>linter-solium</code>、<code>linter-solidity</code>代码错误检查</p></li> 
   <li><p><code>language-ethereum</code>支持<code>Solidity</code>代码高亮以及<code>Solidity</code>代码片段</p></li> 
  </ul> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/language-ethereum--.png" alt="language-ethereum" title=""></p> 
  <h3 id="安装所需工具">安装所需工具</h3> 
  <p>首先开发机上必须装好Node.js，再使用以下命令安装所需的工具：</p> 
  <pre class="prettyprint"><code class="language-js hljs ">$ npm install -g ethereumjs-testrpc truffle</code></pre> 
  <pre class="prettyprint"><code class="language-js hljs ">liyuechun:~ yuechunli$ npm install -g ethereumjs-testrpc truffle
/usr/local/bin/testrpc -&gt; <span class="hljs-regexp">/usr/</span>local/lib/node_modules/ethereumjs-testrpc/build/cli.node.js
/usr/local/bin/truffle -&gt; <span class="hljs-regexp">/usr/</span>local/lib/node_modules/truffle/build/cli.bundled.js
+ truffle@<span class="hljs-number">3.4</span><span class="hljs-number">.9</span>
+ ethereumjs-testrpc@<span class="hljs-number">4.1</span><span class="hljs-number">.3</span>
added <span class="hljs-number">1</span> package and updated <span class="hljs-number">7</span> packages <span class="hljs-keyword">in</span> <span class="hljs-number">76.132</span>s
liyuechun:~ yuechunli$ </code></pre> 
  <h3 id="创建项目">创建项目</h3> 
  <pre class="prettyprint"><code class=" hljs ruby">/<span class="hljs-constant">Users</span>/liyuechun/<span class="hljs-constant">Desktop</span>/<span class="hljs-number">1012</span>/<span class="hljs-constant">Voting</span>
<span class="hljs-symbol">liyuechun:</span><span class="hljs-constant">Voting</span> yuechunli<span class="hljs-variable">$ </span>ls
<span class="hljs-symbol">liyuechun:</span><span class="hljs-constant">Voting</span> yuechunli<span class="hljs-variable">$ </span>pwd
/<span class="hljs-constant">Users</span>/liyuechun/<span class="hljs-constant">Desktop</span>/<span class="hljs-number">1012</span>/<span class="hljs-constant">Voting</span>
<span class="hljs-symbol">liyuechun:</span><span class="hljs-constant">Voting</span> yuechunli<span class="hljs-variable">$ </span>truffle unbox react-box
<span class="hljs-constant">Downloading</span>...
<span class="hljs-constant">Unpacking</span>...
<span class="hljs-constant">Setting</span> up...
<span class="hljs-constant">Unbox</span> successful. <span class="hljs-constant">Sweet</span>!

<span class="hljs-constant">Commands</span><span class="hljs-symbol">:</span>

  <span class="hljs-constant">Compile</span><span class="hljs-symbol">:</span>              truffle compile
  <span class="hljs-constant">Migrate</span><span class="hljs-symbol">:</span>              truffle migrate
  <span class="hljs-constant">Test</span> <span class="hljs-symbol">contracts:</span>       truffle test
  <span class="hljs-constant">Test</span> <span class="hljs-symbol">dapp:</span>            npm test
  <span class="hljs-constant">Run</span> dev <span class="hljs-symbol">server:</span>       npm run start
  <span class="hljs-constant">Build</span> <span class="hljs-keyword">for</span> <span class="hljs-symbol">production:</span> npm run build
<span class="hljs-symbol">liyuechun:</span><span class="hljs-constant">Voting</span> yuechunli<span class="hljs-variable">$ </span></code></pre> 
  <h3 id="项目结构">项目结构</h3> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/WX20171012-155634@2x.png" alt="truffle unbox react-box" title=""> </p> 
  <ul> 
   <li><code>contracts：</code>编写智能合约的文件夹，所有的智能合约文件都放置在这里</li> 
   <li><code>migrations：</code>部署合约配置的文件夹</li> 
   <li><code>src：</code>基于React的Web端源码</li> 
   <li><code>test：</code>智能合约测试用例文件夹</li> 
  </ul> 
  <h3 id="编写投票dapp智能合约">编写投票Dapp智能合约</h3> 
  <p>在<code>contracts</code>文件夹下创建<code>Voting.sol</code>文件，将下面的代码拷贝到文件中。</p> 
  <pre class="prettyprint"><code class=" hljs php">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.4</span>;

contract Voting {

  <span class="hljs-comment">// liyuechun -&gt; 10</span>
  <span class="hljs-comment">// xietingfeng -&gt; 5</span>
  <span class="hljs-comment">// liudehua -&gt; 20</span>
  mapping (bytes32 =&gt; uint8) <span class="hljs-keyword">public</span> votesReceived;


  <span class="hljs-comment">// 存储候选人名字的数组</span>
  bytes32[] <span class="hljs-keyword">public</span> candidateList;


  <span class="hljs-comment">// 构造函数 初始化候选人名单</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Voting</span><span class="hljs-params">(bytes32[] candidateNames)</span> {</span>

    candidateList = candidateNames;
  }

  <span class="hljs-comment">// 查询某个候选人的总票数</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">totalVotesFor</span><span class="hljs-params">(bytes32 candidate)</span> <span class="hljs-title">constant</span> <span class="hljs-title">returns</span> <span class="hljs-params">(uint8)</span> {</span>
    <span class="hljs-keyword">require</span>(validCandidate(candidate) == <span class="hljs-keyword">true</span>);
    <span class="hljs-comment">// 或者</span>
    <span class="hljs-comment">// assert(validCandidate(candidate) == true);</span>
    <span class="hljs-keyword">return</span> votesReceived[candidate];
  }

  <span class="hljs-comment">// 为某个候选人投票</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">voteForCandidate</span><span class="hljs-params">(bytes32 candidate)</span> {</span>
    assert(validCandidate(candidate) == <span class="hljs-keyword">true</span>);
    votesReceived[candidate] += <span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 检索投票的姓名是不是候选人的名字</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validCandidate</span><span class="hljs-params">(bytes32 candidate)</span> <span class="hljs-title">constant</span> <span class="hljs-title">returns</span> <span class="hljs-params">(bool)</span> {</span>
    <span class="hljs-keyword">for</span>(uint i = <span class="hljs-number">0</span>; i &lt; candidateList.length; i++) {
      <span class="hljs-keyword">if</span> (candidateList[i] == candidate) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
  }
}</code></pre> 
  <h3 id="通过remix-metamask部署合约到kovan-test-net">通过remix + metamask部署合约到Kovan Test Net</h3> 
  <ul> 
   <li>在Google浏览器里面安装<code>MetaMask</code>插件</li> 
  </ul> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/111111222222.png" alt="" title=""></p> 
  <ul> 
   <li>打开<a href="https://remix.ethereum.org" rel="nofollow" target="_blank">https://remix.ethereum.org</a>将合约代码拷贝到里面</li> 
  </ul> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/WX20171012-182046@2x.png" alt="" title=""></p> 
  <ul> 
   <li>确保<code>MetaMask</code>账号处于等于状态，并且有一定的以太币支付给矿工。</li> 
   <li>确保<code>Environment</code>是<code>Injected Web3</code>，如果切换不过来，关掉浏览器重新启动</li> 
   <li>在<code>create</code>函数中输入一个数组，数组里面的内容为<strong>候选人名单</strong></li> 
   <li>点击<code>create</code>按钮，会弹出<code>MetaMask</code>界面让你确认，确认提交，过一会儿，合约就部署成功</li> 
   <li>可以测试给某个候选人投票，查询某个候选人的票数</li> 
  </ul> 
  <h3 id="拷贝合约地址">拷贝合约地址</h3> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/WX20171012-182122@2x.png" alt="" title=""></p> 
  <pre class="prettyprint"><code class=" hljs ">0xd3f33a2e553b363b432d7f81f721a2a6202ecc67</code></pre> 
  <h3 id="编译合约">编译合约</h3> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">liyuechun:</span>Voting yuechunli$ truffle compile
Compiling ./contracts/Migrations<span class="hljs-preprocessor">.sol</span>...
Compiling ./contracts/SimpleStorage<span class="hljs-preprocessor">.sol</span>...
Compiling ./contracts/Voting<span class="hljs-preprocessor">.sol</span>...
Writing artifacts to ./build/contracts

<span class="hljs-label">liyuechun:</span>Voting yuechunli$ </code></pre> 
  <p>编译完合约以后在<code>build/contracts</code>文件夹下面会有一个<code>Voting.json</code>的<code>abi</code>文件。</p> 
  <h3 id="查看votingjson文件内容">查看Voting.json文件内容</h3> 
  <pre class="prettyprint"><code class=" hljs json">{
  "<span class="hljs-attribute">contract_name</span>": <span class="hljs-value"><span class="hljs-string">"Voting"</span></span>,
  "<span class="hljs-attribute">abi</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">constant</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>, "<span class="hljs-attribute">inputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"candidate"</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bytes32"</span> </span>} ]</span>, "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"totalVotesFor"</span></span>, "<span class="hljs-attribute">outputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">""</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"uint8"</span> </span>} ]</span>, "<span class="hljs-attribute">payable</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"function"</span> </span>}, { "<span class="hljs-attribute">constant</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>, "<span class="hljs-attribute">inputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"candidate"</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bytes32"</span> </span>} ]</span>, "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"validCandidate"</span></span>, "<span class="hljs-attribute">outputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">""</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bool"</span> </span>} ]</span>, "<span class="hljs-attribute">payable</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"function"</span> </span>}, { "<span class="hljs-attribute">constant</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>, "<span class="hljs-attribute">inputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">""</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bytes32"</span> </span>} ]</span>, "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"votesReceived"</span></span>, "<span class="hljs-attribute">outputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">""</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"uint8"</span> </span>} ]</span>, "<span class="hljs-attribute">payable</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"function"</span> </span>}, { "<span class="hljs-attribute">constant</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>, "<span class="hljs-attribute">inputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">""</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"uint256"</span> </span>} ]</span>, "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"candidateList"</span></span>, "<span class="hljs-attribute">outputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">""</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bytes32"</span> </span>} ]</span>, "<span class="hljs-attribute">payable</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"function"</span> </span>}, { "<span class="hljs-attribute">constant</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">inputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"candidate"</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bytes32"</span> </span>} ]</span>, "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"voteForCandidate"</span></span>, "<span class="hljs-attribute">outputs</span>": <span class="hljs-value">[]</span>, "<span class="hljs-attribute">payable</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"function"</span> </span>}, { "<span class="hljs-attribute">inputs</span>": <span class="hljs-value">[ { "<span class="hljs-attribute">name</span>": <span class="hljs-value"><span class="hljs-string">"candidateNames"</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"bytes32[]"</span> </span>} ]</span>, "<span class="hljs-attribute">payable</span>": <span class="hljs-value"><span class="hljs-literal">false</span></span>, "<span class="hljs-attribute">type</span>": <span class="hljs-value"><span class="hljs-string">"constructor"</span> </span>} ]</span>,
  "<span class="hljs-attribute">unlinked_binary</span>": <span class="hljs-value"><span class="hljs-string">"0x6060604052341561000f57600080fd5b6040516103113803806103118339810160405280805190910190505b600181805161003e929160200190610046565b505b506100b5565b828054828255906000526020600020908101928215610083579160200282015b828111156100835782518255602090920191600190910190610066565b5b50610090929150610094565b5090565b6100b291905b80821115610090576000815560010161009a565b5090565b90565b61024d806100c46000396000f300606060405263ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416632f265cf78114610069578063392e6678146100955780637021939f146100bf578063b13c744b146100eb578063cc9ab26714610113575b600080fd5b341561007457600080fd5b61007f60043561012b565b60405160ff909116815260200160405180910390f35b34156100a057600080fd5b6100ab60043561015d565b604051901515815260200160405180910390f35b34156100ca57600080fd5b61007f6004356101af565b60405160ff909116815260200160405180910390f35b34156100f657600080fd5b6101016004356101c4565b60405190815260200160405180910390f35b341561011e57600080fd5b6101296004356101e7565b005b60006101368261015d565b151560011461014457600080fd5b5060008181526020819052604090205460ff165b919050565b6000805b6001548110156101a457600180548491908390811061017c57fe5b906000526020600020900160005b5054141561019b57600191506101a9565b5b600101610161565b600091505b50919050565b60006020819052908152604090205460ff1681565b60018054829081106101d257fe5b906000526020600020900160005b5054905081565b6101f08161015d565b15156001146101fb57fe5b6000818152602081905260409020805460ff8082166001011660ff199091161790555b505600a165627a7a723058206783a7ff47eae16f18011a9db2a3cc983350b779bf3181b7623c18d4bce363180029"</span></span>,
  "<span class="hljs-attribute">networks</span>": <span class="hljs-value">{}</span>,
  "<span class="hljs-attribute">schema_version</span>": <span class="hljs-value"><span class="hljs-string">"0.0.5"</span></span>,
  "<span class="hljs-attribute">updated_at</span>": <span class="hljs-value"><span class="hljs-number">1507806214330</span> </span>}</code></pre> 
  <p>这个文件是编译后的<strong>abi</strong>文件，待会儿需要将这个文件的<strong>json</strong>导入到<strong>App.json</strong>中。</p> 
  <h3 id="查看srcutilsgetweb3js文件内容">查看src/utils/getWeb3.js文件内容</h3> 
  <pre class="prettyprint"><code class=" hljs javascript">import Web3 from <span class="hljs-string">'web3'</span>

<span class="hljs-keyword">let</span> getWeb3 = <span class="hljs-keyword">new</span> Promise(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resolve, reject)</span> {</span>
  <span class="hljs-comment">// Wait for loading completion to avoid race conditions with web3 injection timing.</span>
  window.addEventListener(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> results
    <span class="hljs-keyword">var</span> web3 = window.web3

    <span class="hljs-comment">// Checking if Web3 has been injected by the browser (Mist/MetaMask)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> web3 !== <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-comment">// Use Mist/MetaMask's provider.</span>
      web3 = <span class="hljs-keyword">new</span> Web3(web3.currentProvider)

      results = {
        web3: web3
      }

      console.log(<span class="hljs-string">'Injected web3 detected.'</span>);

      resolve(results)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Fallback to localhost if no web3 injection.</span>
      <span class="hljs-keyword">var</span> provider = <span class="hljs-keyword">new</span> Web3.providers.HttpProvider(<span class="hljs-string">'http://localhost:8545'</span>)

      web3 = <span class="hljs-keyword">new</span> Web3(provider)

      results = {
        web3: web3
      }

      console.log(<span class="hljs-string">'No web3 instance injected, using Local web3.'</span>);

      resolve(results)
    }
  })
})

export <span class="hljs-keyword">default</span> getWeb3</code></pre> 
  <p>这个文件主要是封装了一个<code>getWeb3</code>的<code>promiss</code>供我们直接使用，可以从<code>getWeb3</code>直接获取到<code>web3</code>对象供<code>App.js</code>文件中使用。</p> 
  <h3 id="修改appjs前端代码和合约进行互动">修改app.js前端代码和合约进行互动</h3> 
  <pre class="prettyprint"><code class=" hljs coffeescript"><span class="hljs-reserved">import</span> React, { Component } from <span class="hljs-string">'react'</span>
<span class="hljs-reserved">import</span> VotingContract from <span class="hljs-string">'../build/contracts/Voting.json'</span>
<span class="hljs-reserved">import</span> getWeb3 from <span class="hljs-string">'./utils/getWeb3'</span>

<span class="hljs-reserved">import</span> <span class="hljs-string">'./css/oswald.css'</span>
<span class="hljs-reserved">import</span> <span class="hljs-string">'./css/open-sans.css'</span>
<span class="hljs-reserved">import</span> <span class="hljs-string">'./css/pure-min.css'</span>
<span class="hljs-reserved">import</span> <span class="hljs-string">'./App.css'</span>


<span class="hljs-reserved">const</span> contractAddress = <span class="hljs-string">"0xd3f33a2e553b363b432d7f81f721a2a6202ecc67"</span>;
<span class="hljs-reserved">var</span> votingContractInstance;


<span class="hljs-reserved">var</span> <span class="hljs-function"><span class="hljs-title">_modifyVotingCount</span> = <span class="hljs-params">(candidates,i,votingCount)</span> =&gt;</span> {

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"---------"</span>);
    <span class="hljs-built_in">console</span>.log(candidates);
    <span class="hljs-built_in">console</span>.log(i);
    <span class="hljs-built_in">console</span>.log(votingCount);

    <span class="hljs-reserved">let</span> obj = candidates[i];
    obj.votingCount = votingCount;
    <span class="hljs-keyword">return</span> candidates;
}


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> {</span>
  constructor(props) {
    <span class="hljs-keyword">super</span>(props)

    <span class="hljs-keyword">this</span>.state = {
      <span class="hljs-attribute">candidates</span>: [
                    {
                      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Rama"</span>,
                      <span class="hljs-string">"id"</span>: <span class="hljs-number">100</span>,
                      <span class="hljs-string">"votingCount"</span>: <span class="hljs-number">0</span>
                    },
                    {
                      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Nick"</span>,
                      <span class="hljs-string">"id"</span>: <span class="hljs-number">101</span>,
                      <span class="hljs-string">"votingCount"</span>: <span class="hljs-number">0</span>
                    },
                    {
                      <span class="hljs-string">"name"</span>: <span class="hljs-string">"Jose"</span>,
                      <span class="hljs-string">"id"</span>: <span class="hljs-number">102</span>,
                      <span class="hljs-string">"votingCount"</span>: <span class="hljs-number">0</span>
                    },
                    {
                      <span class="hljs-string">"name"</span>: <span class="hljs-string">"liyuechun"</span>,
                      <span class="hljs-string">"id"</span>: <span class="hljs-number">103</span>,
                      <span class="hljs-string">"votingCount"</span>: <span class="hljs-number">0</span>
                    }
                  ],
      <span class="hljs-attribute">candidatesVoteCount</span>: [<span class="hljs-string">"0"</span>,<span class="hljs-string">"0"</span>,<span class="hljs-string">"0"</span>,<span class="hljs-string">"0"</span>],
      <span class="hljs-attribute">web3</span>: <span class="hljs-literal">null</span>
    }
  }

  componentWillMount() {
    <span class="hljs-regexp">//</span> Get network provider <span class="hljs-keyword">and</span> web3 instance.
    <span class="hljs-regexp">//</span> See utils/getWeb3 <span class="hljs-keyword">for</span> more info.

    getWeb3
    .<span class="hljs-keyword">then</span>(results<span class="hljs-function"> =&gt;</span> {
      <span class="hljs-keyword">this</span>.setState({
        <span class="hljs-attribute">web3</span>: results.web3
      })

      <span class="hljs-regexp">//</span> Instantiate contract once web3 provided.
      <span class="hljs-keyword">this</span>.instantiateContract()
    })
    .<span class="hljs-keyword">catch</span><span class="hljs-function"><span class="hljs-params">(() =&gt; { <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Error finding web3.'</span>) })</span> } <span class="hljs-title">instantiateContract</span><span class="hljs-params">()</span> { /* * <span class="hljs-title">SMART</span> <span class="hljs-title">CONTRACT</span> <span class="hljs-title">EXAMPLE</span> * * <span class="hljs-title">Normally</span> <span class="hljs-title">these</span> <span class="hljs-title">functions</span> <span class="hljs-title">would</span> <span class="hljs-title">be</span> <span class="hljs-title">called</span> <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">context</span> <span class="hljs-title">of</span> <span class="hljs-title">a</span> * <span class="hljs-title">state</span> <span class="hljs-title">management</span> <span class="hljs-title">library</span>, <span class="hljs-title">but</span> <span class="hljs-title">for</span> <span class="hljs-title">convenience</span> <span class="hljs-title">I</span>'<span class="hljs-title">ve</span> <span class="hljs-title">placed</span> <span class="hljs-title">them</span> <span class="hljs-title">here</span>. */ <span class="hljs-title">const</span> <span class="hljs-title">contract</span> = <span class="hljs-title">require</span><span class="hljs-params">(<span class="hljs-string">'truffle-contract'</span>)</span> <span class="hljs-title">const</span> <span class="hljs-title">votingContract</span> = <span class="hljs-title">contract</span><span class="hljs-params">(VotingContract)</span> <span class="hljs-title">votingContract</span>.<span class="hljs-title">setProvider</span><span class="hljs-params">(<span class="hljs-keyword">this</span>.state.web3.currentProvider)</span> // <span class="hljs-title">Declaring</span> <span class="hljs-title">this</span> <span class="hljs-title">for</span> <span class="hljs-title">later</span> <span class="hljs-title">so</span> <span class="hljs-title">we</span> <span class="hljs-title">can</span> <span class="hljs-title">chain</span> <span class="hljs-title">functions</span> <span class="hljs-title">on</span> <span class="hljs-title">SimpleStorage</span>. // <span class="hljs-title">Get</span> <span class="hljs-title">accounts</span>. <span class="hljs-title">this</span>.<span class="hljs-title">state</span>.<span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">getAccounts</span><span class="hljs-params">((error, accounts) =&gt; { votingContract.at(contractAddress).<span class="hljs-keyword">then</span>((instance) =&gt; { votingContractInstance = instance; <span class="hljs-keyword">for</span> (<span class="hljs-reserved">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.state.candidates.length; i++) { <span class="hljs-reserved">let</span> object = <span class="hljs-keyword">this</span>.state.candidates[i]; <span class="hljs-built_in">console</span>.log(accounts[<span class="hljs-number">0</span>]); <span class="hljs-built_in">console</span>.log(votingContractInstance); <span class="hljs-built_in">console</span>.log(votingContractInstance.totalVotesFor(object.name)); votingContractInstance.totalVotesFor(object.name).<span class="hljs-keyword">then</span>(result =&gt; { <span class="hljs-built_in">console</span>.log(i); <span class="hljs-built_in">console</span>.log(result.c[<span class="hljs-number">0</span>]); <span class="hljs-keyword">this</span>.setState({ candidates: _modifyVotingCount(<span class="hljs-keyword">this</span>.state.candidates,i,result.c[<span class="hljs-number">0</span>]) }); }); } }) })</span> } <span class="hljs-title">render</span><span class="hljs-params">()</span> { <span class="hljs-title">return</span> <span class="hljs-params">( &lt;div className=<span class="hljs-string">"App"</span>&gt; &lt;ul&gt; { <span class="hljs-keyword">this</span>.state.candidates.map((object) =&gt; { <span class="hljs-built_in">console</span>.log(object); <span class="hljs-keyword">return</span> ( &lt;li key={object.id}&gt;候选人：{object.name} 支持票数：{object.votingCount}&lt;/li&gt; ) }) } &lt;/ul&gt; &lt;input style={{width: <span class="hljs-number">200</span>,height: <span class="hljs-number">30</span>,borderWidth: <span class="hljs-number">2</span>,marginLeft: <span class="hljs-number">40</span>}} placeholder=<span class="hljs-string">"请输入候选人姓名..."</span> ref=<span class="hljs-string">"candidateInput"</span> /&gt; &lt;button style={{height: <span class="hljs-number">30</span>,borderWidth: <span class="hljs-number">2</span>,marginLeft: <span class="hljs-number">20</span>}} onClick={() =&gt; { <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.refs.candidateInput); <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.refs.candidateInput.value); <span class="hljs-reserved">let</span> candidateName = <span class="hljs-keyword">this</span>.refs.candidateInput.value; <span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.state.web3.eth.accounts[<span class="hljs-number">0</span>]); votingContractInstance.voteForCandidate(candidateName).<span class="hljs-keyword">then</span>((result =&gt; { <span class="hljs-built_in">console</span>.log(result); <span class="hljs-built_in">console</span>.log(candidateName); <span class="hljs-reserved">let</span> number = <span class="hljs-number">0</span>; <span class="hljs-keyword">for</span>(<span class="hljs-reserved">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.state.candidates.length; i++) { <span class="hljs-reserved">let</span> object = <span class="hljs-keyword">this</span>.state.candidates[i]; <span class="hljs-keyword">if</span> (object.name === candidateName) { number = i; <span class="hljs-keyword">break</span>; } } votingContractInstance.totalVotesFor(candidateName).<span class="hljs-keyword">then</span>(result =&gt; { <span class="hljs-keyword">this</span>.setState({ candidates: _modifyVotingCount(<span class="hljs-keyword">this</span>.state.candidates,number,result.c[<span class="hljs-number">0</span>]) }); }); })); }}&gt;Voting&lt;/button&gt; &lt;/div&gt; )</span>; } } <span class="hljs-title">export</span> <span class="hljs-title">default</span> <span class="hljs-title">App</span></span></code></pre> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/dappxiaoguotu.gif" alt="去中心化投票App" title=""></p> 
  <h3 id="打赏地址">打赏地址</h3> 
  <p>**比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn <br> **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645</p> 
  <h3 id="技术交流">技术交流</h3> 
  <ul> 
   <li>区块链技术交流QQ群：348924182</li> 
  </ul> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/liyuechun520/article/details/78370398,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/liyuechun520/article/details/78370398,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
