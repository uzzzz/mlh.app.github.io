<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Apple Pay接入详细流程 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Apple Pay接入详细流程" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Apple Pay运行环境：iPhone6以上设备，操作系统最低iOS9.0以上，部分信息设置需要iOS9.2以上。目前还不支持企业证书添加。 环境搭建好后可以在模拟器上面运行，xcode7.2.1+iPhone6SP9.2系统下，系统会绑定几种虚拟的银行卡，和几个联系人，方便调试，支付也不会发生真实的付款，真的很方便。 业务方面 首先你要明白，ApplePay和支付宝、微信支付最大的不同点：用户的资金不存放在ApplePay。 支付宝、微信支付把用户的钱从银行卡里面拿出来放到阿里腾讯公司，ApplePay没有，钱还是在银行卡里面，所以说ApplePay相当于只是一个卡包，帮你存放实体卡而已。ApplePay里面的Pay，其实并不属于苹果的业务，只是苹果公司和银行合作产生的一种业务，如果没有银行就没有ApplePay，和银行是强关联的，和苹果公司是弱关联的。 银行会喜欢ApplePay而不是喜欢支付宝、微信，为什么？ 互联网金融时代，支付宝、微信等网络支付渠道把用户的资金从银行卡拿到自己的公司账户里面，导致了银行只看到一条的资金流向是支付宝、微信，但是并不清楚用户把这些钱干嘛了，是投资了还是买买奶粉了。大数据时代这些信息是很珍贵的，(我知道一个做安全的专家从来不在网上购物，即使网上购物已经成了我们生活不可缺少的一部分，知道他怎么做吗，他让自己的秘书去网上帮自己买想要的东西，然后付现金给秘书，注意是现金，不是转账，扯远了)。通过ApplePay银行就可以了解到用户的资金流向了 钱支付成功后去哪了？ 这个问题主要是因为我们没有签约之前发生了虚拟交易，客户端签约方式是和第三方支付平台签约，实体店接入ApplePay的方式是升级POS机，支持NFC的POS机，就是和银行更新合约。 ApplePay完全不中转用户的资金，只是一个保存信用卡、借记卡信息的钱包，并且省去了用户签名的过程。所以你除了支持用户使用这种支付方式，关键还是要和银行签约。 客户端方面，苹果目前建议是和第三方合作接入Applepay，比如银联等等，省去了一家家银行签约的过程，由第三方和一家家银行沟通事项，商户之和第三方沟通。所以签约部分就是和第三方支付平台签约了，钱会进入和第三方签约的银行卡内。 苹果目前提供以下几个第三方平台签约中国银联连连支付首信易支付易宝支付银联商务 一般来说银联这些第三方支付会把ApplePay的流程代码写入到他们的SDK里面，如果说你不想了解Applepay的内部怎么实现的，就没有必要继续阅读了，你只需要去阅读第三方SDK的接入文档就行了。 准备工作 在接入Apple Pay之前，首先要申请MerchantID及对应证书。 请移步我写的申请MerchantID及对应证书详细图文教程 工程设置 bundleID设置 Capability中启用Apple Pay权限，并选择merchantID。 之后项目会多一个Applepay的配置文件ApplePayYasin.entitlements 需要引用的库 Xcode7.0以上不需要再手动添加需要引用的库了，只需要导入头文件就可以了 #import &lt;PassKit/PassKit.h&gt; //用户绑定的银行卡信息 #import &lt;PassKit/PKPaymentAuthorizationViewController.h&gt; //Apple pay的展示控件 #import &lt;AddressBook/AddressBook.h&gt; //用户联系信息相关 设备Applepay权限检测 if (![PKPaymentAuthorizationViewController class]) { //PKPaymentAuthorizationViewController需iOS8.0以上支持 NSLog(@&quot;操作系统不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持&quot;); return; } //检查当前设备是否可以支付 if (![PKPaymentAuthorizationViewController canMakePayments]) { //支付需iOS9.0以上支持 NSLog(@&quot;设备不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持&quot;); return; } //检查用户是否可进行某种卡的支付，是否支持Amex、MasterCard、Visa与银联四种卡，根据自己项目的需要进行检测 NSArray *supportedNetworks = @[PKPaymentNetworkAmex, PKPaymentNetworkMasterCard,PKPaymentNetworkVisa,PKPaymentNetworkChinaUnionPay]; if (![PKPaymentAuthorizationViewController canMakePaymentsUsingNetworks:supportedNetworks]) { NSLog(@&quot;没有绑定支付卡&quot;); return; } 创建支付请求PKPaymentRequest 初始化PKPaymentRequest 这里需要注意RMB的币种代码是CNY //设置币种、国家码及merchant标识符等基本信息 PKPaymentRequest *payRequest = [[PKPaymentRequest alloc]init]; payRequest.countryCode = @&quot;CN&quot;; //国家代码 payRequest.currencyCode = @&quot;CNY&quot;; //RMB的币种代码 payRequest.merchantIdentifier = @&quot;merchant.ApplePayDemoYasin&quot;; //申请的merchantID payRequest.supportedNetworks = supportedNetworks; //用户可进行支付的银行卡 payRequest.merchantCapabilities = PKMerchantCapability3DS|PKMerchantCapabilityEMV; //设置支持的交易处理协议，3DS必须支持，EMV为可选，目前国内的话还是使用两者吧 设置发票配送信息和货物配送地址信息,用户设置后可以通过代理回调代理获取信息的更新 // payRequest.requiredBillingAddressFields = PKAddressFieldEmail; //如果需要邮寄账单可以选择进行设置，默认PKAddressFieldNone(不邮寄账单) //楼主感觉账单邮寄地址可以事先让用户选择是否需要，否则会增加客户的输入麻烦度，体验不好， payRequest.requiredShippingAddressFields = PKAddressFieldPostalAddress|PKAddressFieldPhone|PKAddressFieldName; //送货地址信息，这里设置需要地址和联系方式和姓名，如果需要进行设置，默认PKAddressFieldNone(没有送货地址) 设置货物的配送方式，不需要不配置 //设置两种配送方式 PKShippingMethod *freeShipping = [PKShippingMethod summaryItemWithLabel:@&quot;包邮&quot; amount:[NSDecimalNumber zero]]; freeShipping.identifier = @&quot;freeshipping&quot;; freeShipping.detail = @&quot;6-8 天 送达&quot;; PKShippingMethod *expressShipping = [PKShippingMethod summaryItemWithLabel:@&quot;极速送达&quot; amount:[NSDecimalNumber decimalNumberWithString:@&quot;10.00&quot;]]; expressShipping.identifier = @&quot;expressshipping&quot;; expressShipping.detail = @&quot;2-3 小时 送达&quot;; payRequest.shippingMethods = @[freeShipping, expressShipping]; 账单信息的设置 每条账单的设置 账单列表使用PKPaymentSummaryItem添加描述和价格，价格使用NSDecimalNumber。 PKPaymentSummaryItem初始化： label为商品名字或者是描述，amount为商品价格，折扣为负数，type为该条账单为最终价格还是估算价格(比如出租车价格预估)+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount;+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount type:(PKPaymentSummaryItemType)type NS_AVAILABLE(NA, 9_0); NSDecimalNumber初始化： NSDecimalNumber可以使用数字初始化，也可以使用字符串。 使用方法请移步我写的NSDecimalNumber--十进制数 添加账单列表： NSDecimalNumber *subtotalAmount = [NSDecimalNumber decimalNumberWithMantissa:1275 exponent:-2 isNegative:NO]; //12.75 PKPaymentSummaryItem *subtotal = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;商品价格&quot; amount:subtotalAmount]; NSDecimalNumber *discountAmount = [NSDecimalNumber decimalNumberWithString:@&quot;-12.74&quot;]; //-12.74 PKPaymentSummaryItem *discount = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;优惠折扣&quot; amount:discountAmount]; NSDecimalNumber *methodsAmount = [NSDecimalNumber zero]; PKPaymentSummaryItem *methods = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;包邮&quot; amount:methodsAmount]; NSDecimalNumber *totalAmount = [NSDecimalNumber zero]; totalAmount = [totalAmount decimalNumberByAdding:subtotalAmount]; totalAmount = [totalAmount decimalNumberByAdding:discountAmount]; totalAmount = [totalAmount decimalNumberByAdding:methodsAmount]; PKPaymentSummaryItem *total = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;Yasin&quot; amount:totalAmount]; //最后这个是支付给谁。哈哈，快支付给我 summaryItems = [NSMutableArray arrayWithArray:@[subtotal, discount, methods, total]]; //summaryItems为账单列表，类型是 NSMutableArray，这里设置成成员变量，在后续的代理回调中可以进行支付金额的调整。 payRequest.paymentSummaryItems = summaryItems; 显示购物信息并进行支付 //ApplePay控件 PKPaymentAuthorizationViewController *view = [[PKPaymentAuthorizationViewController alloc]initWithPaymentRequest:payRequest]; view.delegate = self; [self presentViewController:view animated:YES completion:nil]; PKPaymentAuthorizationViewControllerDelegate代理 这里还有两个类要介绍 PKPayment 支付成功信息 PKPaymentToken *payToken = payment.token; //支付凭据，发给服务端进行验证支付是否真实有效 PKContact *billingContact = payment.billingContact; //账单信息 PKContact *shippingContact = payment.shippingContact; //送货信息 PKContact *shippingMethod = payment.shippingMethod; //送货方式 PKContact 联系人信息 NSPersonNameComponents *name = contact.name; //联系人姓名 CNPostalAddress *postalAddress = contact.postalAddress; //联系人地址 NSString *emailAddress = contact.emailAddress; //联系人邮箱 CNPhoneNumber *phoneNumber = contact.phoneNumber; //联系人手机 NSString *supplementarySubLocality = contact.supplementarySubLocality; //补充信息，地址详细描述，其他备注等等,iOS9.2及以上才有 代理说明 送货地址回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingContact:(PKContact *)contact completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //contact送货地址信息，PKContact类型 //送货信息选择回调，如果需要根据送货地址调整送货方式，比如普通地区包邮+极速配送，偏远地区只有付费普通配送，进行支付金额重新计算，可以实现该代理，返回给系统：shippingMethods配送方式，summaryItems账单列表，如果不支持该送货信息返回想要的PKPaymentAuthorizationStatus completion(PKPaymentAuthorizationStatusSuccess, shippingMethods, summaryItems); } 送货方式回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingMethod:(PKShippingMethod *)shippingMethod completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //配送方式回调，如果需要根据不同的送货方式进行支付金额的调整，比如包邮和付费加速配送，可以实现该代理 PKShippingMethod *oldShippingMethod = [summaryItems objectAtIndex:2]; PKPaymentSummaryItem *total = [summaryItems lastObject]; total.amount = [total.amount decimalNumberBySubtracting:oldShippingMethod.amount]; total.amount = [total.amount decimalNumberByAdding:shippingMethod.amount]; [summaryItems replaceObjectAtIndex:2 withObject:shippingMethod]; [summaryItems replaceObjectAtIndex:3 withObject:total]; completion(PKPaymentAuthorizationStatusSuccess, summaryItems); } 支付卡选择回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectPaymentMethod:(PKPaymentMethod *)paymentMethod completion:(void (^)(NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //支付银行卡回调，如果需要根据不同的银行调整付费金额，可以实现该代理 completion(summaryItems); } 送货地址回调，已弃用 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingAddress:(ABRecordRef)address completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //送货地址回调，已弃用 } 付款成功苹果服务器返回信息回调，做服务器验证 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didAuthorizePayment:(PKPayment *)payment completion:(void (^)(PKPaymentAuthorizationStatus status))completion { PKPaymentToken *payToken = payment.token; //支付凭据，发给服务端进行验证支付是否真实有效 PKContact *billingContact = payment.billingContact; //账单信息 PKContact *shippingContact = payment.shippingContact; //送货信息 PKContact *shippingMethod = payment.shippingMethod; //送货方式 //等待服务器返回结果后再进行系统block调用 dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ //模拟服务器通信 completion(PKPaymentAuthorizationStatusSuccess); }); } 支付完成回调 -(void)paymentAuthorizationViewControllerDidFinish:(PKPaymentAuthorizationViewController *)controller{ [controller dismissViewControllerAnimated:YES completion:nil]; } 阅读更多" />
<meta property="og:description" content="Apple Pay运行环境：iPhone6以上设备，操作系统最低iOS9.0以上，部分信息设置需要iOS9.2以上。目前还不支持企业证书添加。 环境搭建好后可以在模拟器上面运行，xcode7.2.1+iPhone6SP9.2系统下，系统会绑定几种虚拟的银行卡，和几个联系人，方便调试，支付也不会发生真实的付款，真的很方便。 业务方面 首先你要明白，ApplePay和支付宝、微信支付最大的不同点：用户的资金不存放在ApplePay。 支付宝、微信支付把用户的钱从银行卡里面拿出来放到阿里腾讯公司，ApplePay没有，钱还是在银行卡里面，所以说ApplePay相当于只是一个卡包，帮你存放实体卡而已。ApplePay里面的Pay，其实并不属于苹果的业务，只是苹果公司和银行合作产生的一种业务，如果没有银行就没有ApplePay，和银行是强关联的，和苹果公司是弱关联的。 银行会喜欢ApplePay而不是喜欢支付宝、微信，为什么？ 互联网金融时代，支付宝、微信等网络支付渠道把用户的资金从银行卡拿到自己的公司账户里面，导致了银行只看到一条的资金流向是支付宝、微信，但是并不清楚用户把这些钱干嘛了，是投资了还是买买奶粉了。大数据时代这些信息是很珍贵的，(我知道一个做安全的专家从来不在网上购物，即使网上购物已经成了我们生活不可缺少的一部分，知道他怎么做吗，他让自己的秘书去网上帮自己买想要的东西，然后付现金给秘书，注意是现金，不是转账，扯远了)。通过ApplePay银行就可以了解到用户的资金流向了 钱支付成功后去哪了？ 这个问题主要是因为我们没有签约之前发生了虚拟交易，客户端签约方式是和第三方支付平台签约，实体店接入ApplePay的方式是升级POS机，支持NFC的POS机，就是和银行更新合约。 ApplePay完全不中转用户的资金，只是一个保存信用卡、借记卡信息的钱包，并且省去了用户签名的过程。所以你除了支持用户使用这种支付方式，关键还是要和银行签约。 客户端方面，苹果目前建议是和第三方合作接入Applepay，比如银联等等，省去了一家家银行签约的过程，由第三方和一家家银行沟通事项，商户之和第三方沟通。所以签约部分就是和第三方支付平台签约了，钱会进入和第三方签约的银行卡内。 苹果目前提供以下几个第三方平台签约中国银联连连支付首信易支付易宝支付银联商务 一般来说银联这些第三方支付会把ApplePay的流程代码写入到他们的SDK里面，如果说你不想了解Applepay的内部怎么实现的，就没有必要继续阅读了，你只需要去阅读第三方SDK的接入文档就行了。 准备工作 在接入Apple Pay之前，首先要申请MerchantID及对应证书。 请移步我写的申请MerchantID及对应证书详细图文教程 工程设置 bundleID设置 Capability中启用Apple Pay权限，并选择merchantID。 之后项目会多一个Applepay的配置文件ApplePayYasin.entitlements 需要引用的库 Xcode7.0以上不需要再手动添加需要引用的库了，只需要导入头文件就可以了 #import &lt;PassKit/PassKit.h&gt; //用户绑定的银行卡信息 #import &lt;PassKit/PKPaymentAuthorizationViewController.h&gt; //Apple pay的展示控件 #import &lt;AddressBook/AddressBook.h&gt; //用户联系信息相关 设备Applepay权限检测 if (![PKPaymentAuthorizationViewController class]) { //PKPaymentAuthorizationViewController需iOS8.0以上支持 NSLog(@&quot;操作系统不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持&quot;); return; } //检查当前设备是否可以支付 if (![PKPaymentAuthorizationViewController canMakePayments]) { //支付需iOS9.0以上支持 NSLog(@&quot;设备不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持&quot;); return; } //检查用户是否可进行某种卡的支付，是否支持Amex、MasterCard、Visa与银联四种卡，根据自己项目的需要进行检测 NSArray *supportedNetworks = @[PKPaymentNetworkAmex, PKPaymentNetworkMasterCard,PKPaymentNetworkVisa,PKPaymentNetworkChinaUnionPay]; if (![PKPaymentAuthorizationViewController canMakePaymentsUsingNetworks:supportedNetworks]) { NSLog(@&quot;没有绑定支付卡&quot;); return; } 创建支付请求PKPaymentRequest 初始化PKPaymentRequest 这里需要注意RMB的币种代码是CNY //设置币种、国家码及merchant标识符等基本信息 PKPaymentRequest *payRequest = [[PKPaymentRequest alloc]init]; payRequest.countryCode = @&quot;CN&quot;; //国家代码 payRequest.currencyCode = @&quot;CNY&quot;; //RMB的币种代码 payRequest.merchantIdentifier = @&quot;merchant.ApplePayDemoYasin&quot;; //申请的merchantID payRequest.supportedNetworks = supportedNetworks; //用户可进行支付的银行卡 payRequest.merchantCapabilities = PKMerchantCapability3DS|PKMerchantCapabilityEMV; //设置支持的交易处理协议，3DS必须支持，EMV为可选，目前国内的话还是使用两者吧 设置发票配送信息和货物配送地址信息,用户设置后可以通过代理回调代理获取信息的更新 // payRequest.requiredBillingAddressFields = PKAddressFieldEmail; //如果需要邮寄账单可以选择进行设置，默认PKAddressFieldNone(不邮寄账单) //楼主感觉账单邮寄地址可以事先让用户选择是否需要，否则会增加客户的输入麻烦度，体验不好， payRequest.requiredShippingAddressFields = PKAddressFieldPostalAddress|PKAddressFieldPhone|PKAddressFieldName; //送货地址信息，这里设置需要地址和联系方式和姓名，如果需要进行设置，默认PKAddressFieldNone(没有送货地址) 设置货物的配送方式，不需要不配置 //设置两种配送方式 PKShippingMethod *freeShipping = [PKShippingMethod summaryItemWithLabel:@&quot;包邮&quot; amount:[NSDecimalNumber zero]]; freeShipping.identifier = @&quot;freeshipping&quot;; freeShipping.detail = @&quot;6-8 天 送达&quot;; PKShippingMethod *expressShipping = [PKShippingMethod summaryItemWithLabel:@&quot;极速送达&quot; amount:[NSDecimalNumber decimalNumberWithString:@&quot;10.00&quot;]]; expressShipping.identifier = @&quot;expressshipping&quot;; expressShipping.detail = @&quot;2-3 小时 送达&quot;; payRequest.shippingMethods = @[freeShipping, expressShipping]; 账单信息的设置 每条账单的设置 账单列表使用PKPaymentSummaryItem添加描述和价格，价格使用NSDecimalNumber。 PKPaymentSummaryItem初始化： label为商品名字或者是描述，amount为商品价格，折扣为负数，type为该条账单为最终价格还是估算价格(比如出租车价格预估)+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount;+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount type:(PKPaymentSummaryItemType)type NS_AVAILABLE(NA, 9_0); NSDecimalNumber初始化： NSDecimalNumber可以使用数字初始化，也可以使用字符串。 使用方法请移步我写的NSDecimalNumber--十进制数 添加账单列表： NSDecimalNumber *subtotalAmount = [NSDecimalNumber decimalNumberWithMantissa:1275 exponent:-2 isNegative:NO]; //12.75 PKPaymentSummaryItem *subtotal = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;商品价格&quot; amount:subtotalAmount]; NSDecimalNumber *discountAmount = [NSDecimalNumber decimalNumberWithString:@&quot;-12.74&quot;]; //-12.74 PKPaymentSummaryItem *discount = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;优惠折扣&quot; amount:discountAmount]; NSDecimalNumber *methodsAmount = [NSDecimalNumber zero]; PKPaymentSummaryItem *methods = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;包邮&quot; amount:methodsAmount]; NSDecimalNumber *totalAmount = [NSDecimalNumber zero]; totalAmount = [totalAmount decimalNumberByAdding:subtotalAmount]; totalAmount = [totalAmount decimalNumberByAdding:discountAmount]; totalAmount = [totalAmount decimalNumberByAdding:methodsAmount]; PKPaymentSummaryItem *total = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;Yasin&quot; amount:totalAmount]; //最后这个是支付给谁。哈哈，快支付给我 summaryItems = [NSMutableArray arrayWithArray:@[subtotal, discount, methods, total]]; //summaryItems为账单列表，类型是 NSMutableArray，这里设置成成员变量，在后续的代理回调中可以进行支付金额的调整。 payRequest.paymentSummaryItems = summaryItems; 显示购物信息并进行支付 //ApplePay控件 PKPaymentAuthorizationViewController *view = [[PKPaymentAuthorizationViewController alloc]initWithPaymentRequest:payRequest]; view.delegate = self; [self presentViewController:view animated:YES completion:nil]; PKPaymentAuthorizationViewControllerDelegate代理 这里还有两个类要介绍 PKPayment 支付成功信息 PKPaymentToken *payToken = payment.token; //支付凭据，发给服务端进行验证支付是否真实有效 PKContact *billingContact = payment.billingContact; //账单信息 PKContact *shippingContact = payment.shippingContact; //送货信息 PKContact *shippingMethod = payment.shippingMethod; //送货方式 PKContact 联系人信息 NSPersonNameComponents *name = contact.name; //联系人姓名 CNPostalAddress *postalAddress = contact.postalAddress; //联系人地址 NSString *emailAddress = contact.emailAddress; //联系人邮箱 CNPhoneNumber *phoneNumber = contact.phoneNumber; //联系人手机 NSString *supplementarySubLocality = contact.supplementarySubLocality; //补充信息，地址详细描述，其他备注等等,iOS9.2及以上才有 代理说明 送货地址回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingContact:(PKContact *)contact completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //contact送货地址信息，PKContact类型 //送货信息选择回调，如果需要根据送货地址调整送货方式，比如普通地区包邮+极速配送，偏远地区只有付费普通配送，进行支付金额重新计算，可以实现该代理，返回给系统：shippingMethods配送方式，summaryItems账单列表，如果不支持该送货信息返回想要的PKPaymentAuthorizationStatus completion(PKPaymentAuthorizationStatusSuccess, shippingMethods, summaryItems); } 送货方式回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingMethod:(PKShippingMethod *)shippingMethod completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //配送方式回调，如果需要根据不同的送货方式进行支付金额的调整，比如包邮和付费加速配送，可以实现该代理 PKShippingMethod *oldShippingMethod = [summaryItems objectAtIndex:2]; PKPaymentSummaryItem *total = [summaryItems lastObject]; total.amount = [total.amount decimalNumberBySubtracting:oldShippingMethod.amount]; total.amount = [total.amount decimalNumberByAdding:shippingMethod.amount]; [summaryItems replaceObjectAtIndex:2 withObject:shippingMethod]; [summaryItems replaceObjectAtIndex:3 withObject:total]; completion(PKPaymentAuthorizationStatusSuccess, summaryItems); } 支付卡选择回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectPaymentMethod:(PKPaymentMethod *)paymentMethod completion:(void (^)(NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //支付银行卡回调，如果需要根据不同的银行调整付费金额，可以实现该代理 completion(summaryItems); } 送货地址回调，已弃用 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingAddress:(ABRecordRef)address completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //送货地址回调，已弃用 } 付款成功苹果服务器返回信息回调，做服务器验证 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didAuthorizePayment:(PKPayment *)payment completion:(void (^)(PKPaymentAuthorizationStatus status))completion { PKPaymentToken *payToken = payment.token; //支付凭据，发给服务端进行验证支付是否真实有效 PKContact *billingContact = payment.billingContact; //账单信息 PKContact *shippingContact = payment.shippingContact; //送货信息 PKContact *shippingMethod = payment.shippingMethod; //送货方式 //等待服务器返回结果后再进行系统block调用 dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ //模拟服务器通信 completion(PKPaymentAuthorizationStatusSuccess); }); } 支付完成回调 -(void)paymentAuthorizationViewControllerDidFinish:(PKPaymentAuthorizationViewController *)controller{ [controller dismissViewControllerAnimated:YES completion:nil]; } 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/03/27/523ae577faff5866205f670730c6c837.html" />
<meta property="og:url" content="https://mlh.app/2017/03/27/523ae577faff5866205f670730c6c837.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-27T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"Apple Pay运行环境：iPhone6以上设备，操作系统最低iOS9.0以上，部分信息设置需要iOS9.2以上。目前还不支持企业证书添加。 环境搭建好后可以在模拟器上面运行，xcode7.2.1+iPhone6SP9.2系统下，系统会绑定几种虚拟的银行卡，和几个联系人，方便调试，支付也不会发生真实的付款，真的很方便。 业务方面 首先你要明白，ApplePay和支付宝、微信支付最大的不同点：用户的资金不存放在ApplePay。 支付宝、微信支付把用户的钱从银行卡里面拿出来放到阿里腾讯公司，ApplePay没有，钱还是在银行卡里面，所以说ApplePay相当于只是一个卡包，帮你存放实体卡而已。ApplePay里面的Pay，其实并不属于苹果的业务，只是苹果公司和银行合作产生的一种业务，如果没有银行就没有ApplePay，和银行是强关联的，和苹果公司是弱关联的。 银行会喜欢ApplePay而不是喜欢支付宝、微信，为什么？ 互联网金融时代，支付宝、微信等网络支付渠道把用户的资金从银行卡拿到自己的公司账户里面，导致了银行只看到一条的资金流向是支付宝、微信，但是并不清楚用户把这些钱干嘛了，是投资了还是买买奶粉了。大数据时代这些信息是很珍贵的，(我知道一个做安全的专家从来不在网上购物，即使网上购物已经成了我们生活不可缺少的一部分，知道他怎么做吗，他让自己的秘书去网上帮自己买想要的东西，然后付现金给秘书，注意是现金，不是转账，扯远了)。通过ApplePay银行就可以了解到用户的资金流向了 钱支付成功后去哪了？ 这个问题主要是因为我们没有签约之前发生了虚拟交易，客户端签约方式是和第三方支付平台签约，实体店接入ApplePay的方式是升级POS机，支持NFC的POS机，就是和银行更新合约。 ApplePay完全不中转用户的资金，只是一个保存信用卡、借记卡信息的钱包，并且省去了用户签名的过程。所以你除了支持用户使用这种支付方式，关键还是要和银行签约。 客户端方面，苹果目前建议是和第三方合作接入Applepay，比如银联等等，省去了一家家银行签约的过程，由第三方和一家家银行沟通事项，商户之和第三方沟通。所以签约部分就是和第三方支付平台签约了，钱会进入和第三方签约的银行卡内。 苹果目前提供以下几个第三方平台签约中国银联连连支付首信易支付易宝支付银联商务 一般来说银联这些第三方支付会把ApplePay的流程代码写入到他们的SDK里面，如果说你不想了解Applepay的内部怎么实现的，就没有必要继续阅读了，你只需要去阅读第三方SDK的接入文档就行了。 准备工作 在接入Apple Pay之前，首先要申请MerchantID及对应证书。 请移步我写的申请MerchantID及对应证书详细图文教程 工程设置 bundleID设置 Capability中启用Apple Pay权限，并选择merchantID。 之后项目会多一个Applepay的配置文件ApplePayYasin.entitlements 需要引用的库 Xcode7.0以上不需要再手动添加需要引用的库了，只需要导入头文件就可以了 #import &lt;PassKit/PassKit.h&gt; //用户绑定的银行卡信息 #import &lt;PassKit/PKPaymentAuthorizationViewController.h&gt; //Apple pay的展示控件 #import &lt;AddressBook/AddressBook.h&gt; //用户联系信息相关 设备Applepay权限检测 if (![PKPaymentAuthorizationViewController class]) { //PKPaymentAuthorizationViewController需iOS8.0以上支持 NSLog(@&quot;操作系统不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持&quot;); return; } //检查当前设备是否可以支付 if (![PKPaymentAuthorizationViewController canMakePayments]) { //支付需iOS9.0以上支持 NSLog(@&quot;设备不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持&quot;); return; } //检查用户是否可进行某种卡的支付，是否支持Amex、MasterCard、Visa与银联四种卡，根据自己项目的需要进行检测 NSArray *supportedNetworks = @[PKPaymentNetworkAmex, PKPaymentNetworkMasterCard,PKPaymentNetworkVisa,PKPaymentNetworkChinaUnionPay]; if (![PKPaymentAuthorizationViewController canMakePaymentsUsingNetworks:supportedNetworks]) { NSLog(@&quot;没有绑定支付卡&quot;); return; } 创建支付请求PKPaymentRequest 初始化PKPaymentRequest 这里需要注意RMB的币种代码是CNY //设置币种、国家码及merchant标识符等基本信息 PKPaymentRequest *payRequest = [[PKPaymentRequest alloc]init]; payRequest.countryCode = @&quot;CN&quot;; //国家代码 payRequest.currencyCode = @&quot;CNY&quot;; //RMB的币种代码 payRequest.merchantIdentifier = @&quot;merchant.ApplePayDemoYasin&quot;; //申请的merchantID payRequest.supportedNetworks = supportedNetworks; //用户可进行支付的银行卡 payRequest.merchantCapabilities = PKMerchantCapability3DS|PKMerchantCapabilityEMV; //设置支持的交易处理协议，3DS必须支持，EMV为可选，目前国内的话还是使用两者吧 设置发票配送信息和货物配送地址信息,用户设置后可以通过代理回调代理获取信息的更新 // payRequest.requiredBillingAddressFields = PKAddressFieldEmail; //如果需要邮寄账单可以选择进行设置，默认PKAddressFieldNone(不邮寄账单) //楼主感觉账单邮寄地址可以事先让用户选择是否需要，否则会增加客户的输入麻烦度，体验不好， payRequest.requiredShippingAddressFields = PKAddressFieldPostalAddress|PKAddressFieldPhone|PKAddressFieldName; //送货地址信息，这里设置需要地址和联系方式和姓名，如果需要进行设置，默认PKAddressFieldNone(没有送货地址) 设置货物的配送方式，不需要不配置 //设置两种配送方式 PKShippingMethod *freeShipping = [PKShippingMethod summaryItemWithLabel:@&quot;包邮&quot; amount:[NSDecimalNumber zero]]; freeShipping.identifier = @&quot;freeshipping&quot;; freeShipping.detail = @&quot;6-8 天 送达&quot;; PKShippingMethod *expressShipping = [PKShippingMethod summaryItemWithLabel:@&quot;极速送达&quot; amount:[NSDecimalNumber decimalNumberWithString:@&quot;10.00&quot;]]; expressShipping.identifier = @&quot;expressshipping&quot;; expressShipping.detail = @&quot;2-3 小时 送达&quot;; payRequest.shippingMethods = @[freeShipping, expressShipping]; 账单信息的设置 每条账单的设置 账单列表使用PKPaymentSummaryItem添加描述和价格，价格使用NSDecimalNumber。 PKPaymentSummaryItem初始化： label为商品名字或者是描述，amount为商品价格，折扣为负数，type为该条账单为最终价格还是估算价格(比如出租车价格预估)+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount;+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount type:(PKPaymentSummaryItemType)type NS_AVAILABLE(NA, 9_0); NSDecimalNumber初始化： NSDecimalNumber可以使用数字初始化，也可以使用字符串。 使用方法请移步我写的NSDecimalNumber--十进制数 添加账单列表： NSDecimalNumber *subtotalAmount = [NSDecimalNumber decimalNumberWithMantissa:1275 exponent:-2 isNegative:NO]; //12.75 PKPaymentSummaryItem *subtotal = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;商品价格&quot; amount:subtotalAmount]; NSDecimalNumber *discountAmount = [NSDecimalNumber decimalNumberWithString:@&quot;-12.74&quot;]; //-12.74 PKPaymentSummaryItem *discount = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;优惠折扣&quot; amount:discountAmount]; NSDecimalNumber *methodsAmount = [NSDecimalNumber zero]; PKPaymentSummaryItem *methods = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;包邮&quot; amount:methodsAmount]; NSDecimalNumber *totalAmount = [NSDecimalNumber zero]; totalAmount = [totalAmount decimalNumberByAdding:subtotalAmount]; totalAmount = [totalAmount decimalNumberByAdding:discountAmount]; totalAmount = [totalAmount decimalNumberByAdding:methodsAmount]; PKPaymentSummaryItem *total = [PKPaymentSummaryItem summaryItemWithLabel:@&quot;Yasin&quot; amount:totalAmount]; //最后这个是支付给谁。哈哈，快支付给我 summaryItems = [NSMutableArray arrayWithArray:@[subtotal, discount, methods, total]]; //summaryItems为账单列表，类型是 NSMutableArray，这里设置成成员变量，在后续的代理回调中可以进行支付金额的调整。 payRequest.paymentSummaryItems = summaryItems; 显示购物信息并进行支付 //ApplePay控件 PKPaymentAuthorizationViewController *view = [[PKPaymentAuthorizationViewController alloc]initWithPaymentRequest:payRequest]; view.delegate = self; [self presentViewController:view animated:YES completion:nil]; PKPaymentAuthorizationViewControllerDelegate代理 这里还有两个类要介绍 PKPayment 支付成功信息 PKPaymentToken *payToken = payment.token; //支付凭据，发给服务端进行验证支付是否真实有效 PKContact *billingContact = payment.billingContact; //账单信息 PKContact *shippingContact = payment.shippingContact; //送货信息 PKContact *shippingMethod = payment.shippingMethod; //送货方式 PKContact 联系人信息 NSPersonNameComponents *name = contact.name; //联系人姓名 CNPostalAddress *postalAddress = contact.postalAddress; //联系人地址 NSString *emailAddress = contact.emailAddress; //联系人邮箱 CNPhoneNumber *phoneNumber = contact.phoneNumber; //联系人手机 NSString *supplementarySubLocality = contact.supplementarySubLocality; //补充信息，地址详细描述，其他备注等等,iOS9.2及以上才有 代理说明 送货地址回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingContact:(PKContact *)contact completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //contact送货地址信息，PKContact类型 //送货信息选择回调，如果需要根据送货地址调整送货方式，比如普通地区包邮+极速配送，偏远地区只有付费普通配送，进行支付金额重新计算，可以实现该代理，返回给系统：shippingMethods配送方式，summaryItems账单列表，如果不支持该送货信息返回想要的PKPaymentAuthorizationStatus completion(PKPaymentAuthorizationStatusSuccess, shippingMethods, summaryItems); } 送货方式回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingMethod:(PKShippingMethod *)shippingMethod completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //配送方式回调，如果需要根据不同的送货方式进行支付金额的调整，比如包邮和付费加速配送，可以实现该代理 PKShippingMethod *oldShippingMethod = [summaryItems objectAtIndex:2]; PKPaymentSummaryItem *total = [summaryItems lastObject]; total.amount = [total.amount decimalNumberBySubtracting:oldShippingMethod.amount]; total.amount = [total.amount decimalNumberByAdding:shippingMethod.amount]; [summaryItems replaceObjectAtIndex:2 withObject:shippingMethod]; [summaryItems replaceObjectAtIndex:3 withObject:total]; completion(PKPaymentAuthorizationStatusSuccess, summaryItems); } 支付卡选择回调 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectPaymentMethod:(PKPaymentMethod *)paymentMethod completion:(void (^)(NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //支付银行卡回调，如果需要根据不同的银行调整付费金额，可以实现该代理 completion(summaryItems); } 送货地址回调，已弃用 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didSelectShippingAddress:(ABRecordRef)address completion:(void (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{ //送货地址回调，已弃用 } 付款成功苹果服务器返回信息回调，做服务器验证 -(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller didAuthorizePayment:(PKPayment *)payment completion:(void (^)(PKPaymentAuthorizationStatus status))completion { PKPaymentToken *payToken = payment.token; //支付凭据，发给服务端进行验证支付是否真实有效 PKContact *billingContact = payment.billingContact; //账单信息 PKContact *shippingContact = payment.shippingContact; //送货信息 PKContact *shippingMethod = payment.shippingMethod; //送货方式 //等待服务器返回结果后再进行系统block调用 dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ //模拟服务器通信 completion(PKPaymentAuthorizationStatusSuccess); }); } 支付完成回调 -(void)paymentAuthorizationViewControllerDidFinish:(PKPaymentAuthorizationViewController *)controller{ [controller dismissViewControllerAnimated:YES completion:nil]; } 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/03/27/523ae577faff5866205f670730c6c837.html","headline":"Apple Pay接入详细流程","dateModified":"2017-03-27T00:00:00+08:00","datePublished":"2017-03-27T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/03/27/523ae577faff5866205f670730c6c837.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>Apple Pay接入详细流程</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> Apple Pay运行环境：iPhone6以上设备，操作系统最低iOS9.0以上，部分信息设置需要iOS9.2以上。目前还不支持企业证书添加。<br> 环境搭建好后可以在模拟器上面运行，xcode7.2.1+iPhone6SP9.2系统下，系统会绑定几种虚拟的银行卡，和几个联系人，方便调试，支付也不会发生真实的付款，真的很方便。<br></p> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 业务方面</h4> 
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 首先你要明白，ApplePay和支付宝、微信支付最大的不同点：用户的资金不存放在ApplePay。<br> 支付宝、微信支付把用户的钱从银行卡里面拿出来放到阿里腾讯公司，ApplePay没有，钱还是在银行卡里面，所以说ApplePay相当于只是一个卡包，帮你存放实体卡而已。<br><code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">ApplePay</code>里面的<code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">Pay</code>，其实并不属于苹果的业务，只是苹果公司和银行合作产生的一种业务，如果没有银行就没有ApplePay，和银行是强关联的，和苹果公司是弱关联的。</p> 
  <ul style="margin-left:22px;color:rgb(47,47,47);font-size:16px;line-height:27.2px;">
   <li style="line-height:30px;"> <p style="overflow:visible;"> 银行会喜欢ApplePay而不是喜欢支付宝、微信，为什么？<br> 互联网金融时代，支付宝、微信等网络支付渠道把用户的资金从银行卡拿到自己的公司账户里面，导致了银行只看到一条的资金流向是支付宝、微信，但是并不清楚用户把这些钱干嘛了，是投资了还是买买奶粉了。大数据时代这些信息是很珍贵的，(我知道一个做安全的专家从来不在网上购物，即使网上购物已经成了我们生活不可缺少的一部分，知道他怎么做吗，他让自己的秘书去网上帮自己买想要的东西，然后付现金给秘书，注意是现金，不是转账，扯远了)。通过ApplePay银行就可以了解到用户的资金流向了</p> </li>
   <li style="line-height:30px;"> <p style="overflow:visible;"> 钱支付成功后去哪了？<br> 这个问题主要是因为我们没有签约之前发生了虚拟交易，客户端签约方式是和第三方支付平台签约，实体店接入ApplePay的方式是升级POS机，支持NFC的POS机，就是和银行更新合约。<br> ApplePay完全不中转用户的资金，只是一个保存信用卡、借记卡信息的钱包，并且省去了用户签名的过程。所以你除了支持<code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">用户</code>使用这种支付方式，关键还是要和银行签约。<br> 客户端方面，苹果目前建议是和第三方合作接入Applepay，比如银联等等，省去了一家家银行签约的过程，由第三方和一家家银行沟通事项，商户之和第三方沟通。所以签约部分就是和第三方支付平台签约了，钱会进入和第三方签约的银行卡内。<br> 苹果目前提供以下几个第三方平台签约<br><a href="http://cn.unionpay.com/" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">中国银联</a><br><a href="https://apple.lianlianpay.com/" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">连连支付</a><br><a href="https://www.beijing.com.cn/product/ApplePay_ch.jsp" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">首信易支付</a><br><a href="https://www.yeepay.com/applepay" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">易宝支付</a><br><a href="http://www.chinaums.com/static/ums2013/chinaums/app/download/applepay.html" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">银联商务</a></p> </li>
  </ul>
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 一般来说银联这些第三方支付会把ApplePay的流程代码写入到他们的SDK里面，如果说你不想了解Applepay的内部怎么实现的，就没有必要继续阅读了，你只需要去阅读第三方SDK的接入文档就行了。</p> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 准备工作</h4> 
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 在接入Apple Pay之前，首先要申请MerchantID及对应证书。<br> 请移步我写的<a href="http://blog.csdn.net/wgl_happy/article/details/67634929" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">申请MerchantID及对应证书详细图文教程</a></p> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 工程设置</h4> 
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> bundleID设置<br></p> 
  <div class="image-package" style="width:700px;margin-left:-40px;text-align:center;color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 
   <img src="http://upload-images.jianshu.io/upload_images/1024259-16fff81828406887.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" style="border:0px;vertical-align:middle;">
   <br>
  </div> 
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> Capability中启用Apple Pay权限，并选择merchantID。<br></p> 
  <div class="image-package" style="width:700px;margin-left:-40px;text-align:center;color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 
   <img src="http://upload-images.jianshu.io/upload_images/1024259-21c046559eb3d59a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" style="border:0px;vertical-align:middle;">
   <br>
  </div> 
  <p style="color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 之后项目会多一个Applepay的配置文件ApplePayYasin.entitlements<br></p> 
  <div class="image-package" style="width:700px;margin-left:-40px;text-align:center;color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 
   <img src="http://upload-images.jianshu.io/upload_images/1024259-35739a7c9011a540.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" style="border:0px;vertical-align:middle;">
   <br>
  </div> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 需要引用的库</h4> 
  <blockquote style="font-size:16px;border-left-width:6px;border-left-style:solid;border-left-color:rgb(180,180,180);line-height:30px;color:rgb(47,47,47);background-color:rgb(247,247,247);"> 
   <p style="line-height:1.7;"> Xcode7.0以上不需要再手动添加需要引用的库了，只需要导入头文件就可以了</p> 
  </blockquote> 
  <pre><code class="language-cpp"><code class="cpp" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-meta">#import <span class="hljs-meta-string">&lt;PassKit/PassKit.h&gt;</span> <span class="hljs-comment" style="color:rgb(147,161,161);">//用户绑定的银行卡信息</span></span> <span class="hljs-meta">#import <span class="hljs-meta-string">&lt;PassKit/PKPaymentAuthorizationViewController.h&gt;</span> <span class="hljs-comment" style="color:rgb(147,161,161);">//Apple pay的展示控件</span></span> <span class="hljs-meta">#import <span class="hljs-meta-string">&lt;AddressBook/AddressBook.h&gt;</span> <span class="hljs-comment" style="color:rgb(147,161,161);">//用户联系信息相关</span></span></code></code></pre> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 设备Applepay权限检测</h4> 
  <pre class="hljs kotlin" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="kotlin" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">    <span class="hljs-keyword" style="color:rgb(133,153,0);">if</span> (![PKPaymentAuthorizationViewController <span class="hljs-class"><span class="hljs-keyword" style="color:rgb(133,153,0);">class</span>]) </span>{
        <span class="hljs-comment" style="color:rgb(147,161,161);">//PKPaymentAuthorizationViewController需iOS8.0以上支持</span>
        NSLog(@<span class="hljs-string" style="color:rgb(42,161,152);">"操作系统不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持"</span>);
        <span class="hljs-keyword" style="color:rgb(133,153,0);">return</span>;
    }
    <span class="hljs-comment" style="color:rgb(147,161,161);">//检查当前设备是否可以支付</span>
    <span class="hljs-keyword" style="color:rgb(133,153,0);">if</span> (![PKPaymentAuthorizationViewController canMakePayments]) {
        <span class="hljs-comment" style="color:rgb(147,161,161);">//支付需iOS9.0以上支持</span>
        NSLog(@<span class="hljs-string" style="color:rgb(42,161,152);">"设备不支持ApplePay，请升级至9.0以上版本，且iPhone6以上设备才支持"</span>);
        <span class="hljs-keyword" style="color:rgb(133,153,0);">return</span>;
    }
    <span class="hljs-comment" style="color:rgb(147,161,161);">//检查用户是否可进行某种卡的支付，是否支持Amex、MasterCard、Visa与银联四种卡，根据自己项目的需要进行检测</span>
    NSArray *supportedNetworks = @[PKPaymentNetworkAmex, PKPaymentNetworkMasterCard,PKPaymentNetworkVisa,PKPaymentNetworkChinaUnionPay];
    <span class="hljs-keyword" style="color:rgb(133,153,0);">if</span> (![PKPaymentAuthorizationViewController canMakePaymentsUsingNetworks:supportedNetworks]) {
        NSLog(@<span class="hljs-string" style="color:rgb(42,161,152);">"没有绑定支付卡"</span>);
        <span class="hljs-keyword" style="color:rgb(133,153,0);">return</span>;
    }</code></pre> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 创建支付请求PKPaymentRequest</h4> 
  <ul style="margin-left:22px;color:rgb(47,47,47);font-size:16px;line-height:27.2px;">
   <li style="line-height:30px;">初始化PKPaymentRequest<br> 这里需要注意RMB的币种代码是CNY <pre class="hljs protobuf" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="protobuf" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-comment" style="color:rgb(147,161,161);">//设置币种、国家码及merchant标识符等基本信息</span>
  PKPaymentRequest *payRequest = [[PKPaymentRequest alloc]init];
  payRequest.countryCode = @<span class="hljs-string" style="color:rgb(42,161,152);">"CN"</span>;     <span class="hljs-comment" style="color:rgb(147,161,161);">//国家代码</span>
  payRequest.currencyCode = @<span class="hljs-string" style="color:rgb(42,161,152);">"CNY"</span>;       <span class="hljs-comment" style="color:rgb(147,161,161);">//RMB的币种代码</span>
  payRequest.merchantIdentifier = @<span class="hljs-string" style="color:rgb(42,161,152);">"merchant.ApplePayDemoYasin"</span>;  <span class="hljs-comment" style="color:rgb(147,161,161);">//申请的merchantID</span>
  payRequest.supportedNetworks = supportedNetworks;   <span class="hljs-comment" style="color:rgb(147,161,161);">//用户可进行支付的银行卡</span>
  payRequest.merchantCapabilities = PKMerchantCapability3DS|PKMerchantCapabilityEMV;      <span class="hljs-comment" style="color:rgb(147,161,161);">//设置支持的交易处理协议，3DS必须支持，EMV为可选，目前国内的话还是使用两者吧</span></code></pre> </li>
   <li style="line-height:30px;">设置发票配送信息和货物配送地址信息,用户设置后可以通过代理回调代理获取信息的更新 <pre class="hljs 1c" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="1c" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-comment" style="color:rgb(147,161,161);">// payRequest.requiredBillingAddressFields = PKAddressFieldEmail; </span>
<span class="hljs-comment" style="color:rgb(147,161,161);">//如果需要邮寄账单可以选择进行设置，默认PKAddressFieldNone(不邮寄账单)</span>
<span class="hljs-comment" style="color:rgb(147,161,161);">//楼主感觉账单邮寄地址可以事先让用户选择是否需要，否则会增加客户的输入麻烦度，体验不好，</span>
  payRequest.requiredShippingAddressFields = PKAddressFieldPostalAddress<span class="hljs-string" style="color:rgb(42,161,152);">|PKAddressFieldPhone|PKAddressFieldName;</span>
  <span class="hljs-comment" style="color:rgb(147,161,161);">//送货地址信息，这里设置需要地址和联系方式和姓名，如果需要进行设置，默认PKAddressFieldNone(没有送货地址)</span></code></pre> </li>
  </ul>
  <div class="image-package" style="width:700px;margin-left:-40px;text-align:center;color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 
   <img src="http://upload-images.jianshu.io/upload_images/1024259-43c63c7a57cc2a08.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" style="border:0px;vertical-align:middle;">
   <br>
  </div> 
  <ul style="margin-left:22px;color:rgb(47,47,47);font-size:16px;line-height:27.2px;">
   <li style="line-height:30px;"> <p style="overflow:visible;"> 设置货物的配送方式，不需要不配置</p> <pre class="hljs nix" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="nix" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">//设置两种配送方式
  PKShippingMethod *<span class="hljs-attr">freeShipping</span> = [PKShippingMethod summaryItemWithLabel:@<span class="hljs-string" style="color:rgb(42,161,152);">"包邮"</span> amount:[NSDecimalNumber zero]];
  freeShipping.<span class="hljs-attr">identifier</span> = @<span class="hljs-string" style="color:rgb(42,161,152);">"freeshipping"</span>;
  freeShipping.<span class="hljs-attr">detail</span> = @<span class="hljs-string" style="color:rgb(42,161,152);">"6-8 天 送达"</span>;

  PKShippingMethod *<span class="hljs-attr">expressShipping</span> = [PKShippingMethod summaryItemWithLabel:@<span class="hljs-string" style="color:rgb(42,161,152);">"极速送达"</span> amount:[NSDecimalNumber decimalNumberWithString:@<span class="hljs-string" style="color:rgb(42,161,152);">"10.00"</span>]];
  expressShipping.<span class="hljs-attr">identifier</span> = @<span class="hljs-string" style="color:rgb(42,161,152);">"expressshipping"</span>;
  expressShipping.<span class="hljs-attr">detail</span> = @<span class="hljs-string" style="color:rgb(42,161,152);">"2-3 小时 送达"</span>;

  payRequest.<span class="hljs-attr">shippingMethods</span> = @[freeShipping, expressShipping];</code></pre> 
    <div class="image-package" style="margin-left:0px !important;text-align:center;"> 
     <img src="http://upload-images.jianshu.io/upload_images/1024259-c8a390d491efc6ef.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" style="border:0px;vertical-align:middle;">
     <br>
    </div> </li>
  </ul>
  <div class="image-package" style="width:700px;margin-left:-40px;text-align:center;color:rgb(47,47,47);font-size:16px;line-height:27.2px;"> 
   <img src="http://upload-images.jianshu.io/upload_images/1024259-ff33c2d6e59a960b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" style="border:0px;vertical-align:middle;">
   <br>
  </div> 
  <ul style="margin-left:22px;color:rgb(47,47,47);font-size:16px;line-height:27.2px;">
   <li style="line-height:30px;"> <p style="overflow:visible;"> 账单信息的设置</p> 
    <ul style="margin-left:22px;">
     <li>每条账单的设置<br> 账单列表使用<code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">PKPaymentSummaryItem</code>添加描述和价格，价格使用<code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">NSDecimalNumber</code>。<br> PKPaymentSummaryItem初始化：<br> label为商品名字或者是描述，amount为商品价格，折扣为负数，type为该条账单为最终价格还是估算价格(比如出租车价格预估)<br><code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount;</code><br><code style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;color:rgb(101,123,131);border:none;background-color:rgb(246,246,246);">+ (instancetype)summaryItemWithLabel:(NSString *)label amount:(NSDecimalNumber *)amount type:(PKPaymentSummaryItemType)type NS_AVAILABLE(NA, 9_0);</code></li>
     <li>NSDecimalNumber初始化：<br> NSDecimalNumber可以使用数字初始化，也可以使用字符串。<br> 使用方法请移步我写的<a href="http://www.jianshu.com/p/4703d704c953" rel="nofollow" style="color:rgb(49,148,208);text-decoration:none;background-color:transparent;">NSDecimalNumber--十进制数</a></li>
     <li> <p style="overflow:visible;"> 添加账单列表：</p> <pre class="hljs groovy" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="groovy" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">NSDecimalNumber *subtotalAmount = [NSDecimalNumber <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberWithMantissa:</span><span class="hljs-number" style="color:rgb(42,161,152);">1275</span> <span class="hljs-string" style="color:rgb(42,161,152);">exponent:</span><span class="hljs-number" style="color:rgb(42,161,152);">-2</span> <span class="hljs-string" style="color:rgb(42,161,152);">isNegative:</span>NO];   <span class="hljs-comment" style="color:rgb(147,161,161);">//12.75</span>
PKPaymentSummaryItem *subtotal = [PKPaymentSummaryItem <span class="hljs-string" style="color:rgb(42,161,152);">summaryItemWithLabel:</span>@<span class="hljs-string" style="color:rgb(42,161,152);">"商品价格"</span> <span class="hljs-string" style="color:rgb(42,161,152);">amount:</span>subtotalAmount];

NSDecimalNumber *discountAmount = [NSDecimalNumber <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberWithString:</span>@<span class="hljs-string" style="color:rgb(42,161,152);">"-12.74"</span>];      <span class="hljs-comment" style="color:rgb(147,161,161);">//-12.74</span>
PKPaymentSummaryItem *discount = [PKPaymentSummaryItem <span class="hljs-string" style="color:rgb(42,161,152);">summaryItemWithLabel:</span>@<span class="hljs-string" style="color:rgb(42,161,152);">"优惠折扣"</span> <span class="hljs-string" style="color:rgb(42,161,152);">amount:</span>discountAmount];

NSDecimalNumber *methodsAmount = [NSDecimalNumber zero];
PKPaymentSummaryItem *methods = [PKPaymentSummaryItem <span class="hljs-string" style="color:rgb(42,161,152);">summaryItemWithLabel:</span>@<span class="hljs-string" style="color:rgb(42,161,152);">"包邮"</span> <span class="hljs-string" style="color:rgb(42,161,152);">amount:</span>methodsAmount];

NSDecimalNumber *totalAmount = [NSDecimalNumber zero];
totalAmount = [totalAmount <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberByAdding:</span>subtotalAmount];
totalAmount = [totalAmount <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberByAdding:</span>discountAmount];
totalAmount = [totalAmount <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberByAdding:</span>methodsAmount];
PKPaymentSummaryItem *total = [PKPaymentSummaryItem <span class="hljs-string" style="color:rgb(42,161,152);">summaryItemWithLabel:</span>@<span class="hljs-string" style="color:rgb(42,161,152);">"Yasin"</span> <span class="hljs-string" style="color:rgb(42,161,152);">amount:</span>totalAmount];  <span class="hljs-comment" style="color:rgb(147,161,161);">//最后这个是支付给谁。哈哈，快支付给我</span>

summaryItems = [NSMutableArray <span class="hljs-string" style="color:rgb(42,161,152);">arrayWithArray:</span>@[subtotal, discount, methods, total]];
<span class="hljs-comment" style="color:rgb(147,161,161);">//summaryItems为账单列表，类型是 NSMutableArray，这里设置成成员变量，在后续的代理回调中可以进行支付金额的调整。</span>
payRequest.paymentSummaryItems = summaryItems;</code></pre> </li>
    </ul></li>
  </ul>
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> 显示购物信息并进行支付</h4> 
  <pre class="hljs groovy" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="groovy" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-comment" style="color:rgb(147,161,161);">//ApplePay控件</span>
    PKPaymentAuthorizationViewController *view = [[PKPaymentAuthorizationViewController alloc]<span class="hljs-string" style="color:rgb(42,161,152);">initWithPaymentRequest:</span>payRequest];
    view.delegate = self;
    [self <span class="hljs-string" style="color:rgb(42,161,152);">presentViewController:</span>view <span class="hljs-string" style="color:rgb(42,161,152);">animated:</span>YES <span class="hljs-string" style="color:rgb(42,161,152);">completion:</span>nil];</code></pre> 
  <h4 style="line-height:1.7;color:rgb(47,47,47);font-size:20px;"> PKPaymentAuthorizationViewControllerDelegate代理</h4> 
  <ul style="margin-left:22px;color:rgb(47,47,47);font-size:16px;line-height:27.2px;">
   <li style="line-height:30px;">这里还有两个类要介绍 
    <ul style="margin-left:22px;">
     <li>PKPayment 支付成功信息 <pre class="hljs protobuf" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="protobuf" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">PKPaymentToken *payToken = payment.token;
<span class="hljs-comment" style="color:rgb(147,161,161);">//支付凭据，发给服务端进行验证支付是否真实有效</span>
PKContact *billingContact = payment.billingContact;     <span class="hljs-comment" style="color:rgb(147,161,161);">//账单信息</span>
PKContact *shippingContact = payment.shippingContact;   <span class="hljs-comment" style="color:rgb(147,161,161);">//送货信息</span>
PKContact *shippingMethod = payment.shippingMethod;     <span class="hljs-comment" style="color:rgb(147,161,161);">//送货方式</span></code></pre> </li>
     <li>PKContact 联系人信息 <pre class="hljs objectivec" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="objectivec" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-built_in" style="color:rgb(38,139,210);">NSPersonNameComponents</span> *name = contact.name;                <span class="hljs-comment" style="color:rgb(147,161,161);">//联系人姓名</span>
<span class="hljs-built_in" style="color:rgb(38,139,210);">CNPostalAddress</span> *postalAddress = contact.postalAddress;     <span class="hljs-comment" style="color:rgb(147,161,161);">//联系人地址</span>
<span class="hljs-built_in" style="color:rgb(38,139,210);">NSString</span> *emailAddress = contact.emailAddress;              <span class="hljs-comment" style="color:rgb(147,161,161);">//联系人邮箱</span>
<span class="hljs-built_in" style="color:rgb(38,139,210);">CNPhoneNumber</span> *phoneNumber = contact.phoneNumber;           <span class="hljs-comment" style="color:rgb(147,161,161);">//联系人手机</span>
<span class="hljs-built_in" style="color:rgb(38,139,210);">NSString</span> *supplementarySubLocality = contact.supplementarySubLocality;  <span class="hljs-comment" style="color:rgb(147,161,161);">//补充信息，地址详细描述，其他备注等等,iOS9.2及以上才有</span></code></pre> </li>
    </ul></li>
   <li style="line-height:30px;"> <p style="overflow:visible;"> 代理说明<br> 送货地址回调</p> <pre class="hljs less" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="less" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-selector-tag">-</span>(void)<span class="hljs-selector-tag">paymentAuthorizationViewController</span><span class="hljs-selector-pseudo">:(PKPaymentAuthorizationViewController</span> *)<span class="hljs-selector-tag">controller</span>
                <span class="hljs-selector-tag">didSelectShippingContact</span><span class="hljs-selector-pseudo">:(PKContact</span> *)<span class="hljs-selector-tag">contact</span>
                              <span class="hljs-selector-tag">completion</span><span class="hljs-selector-pseudo">:(void</span> (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))<span class="hljs-selector-tag">completion</span>{
  <span class="hljs-comment" style="color:rgb(147,161,161);">//contact送货地址信息，PKContact类型</span>
  <span class="hljs-comment" style="color:rgb(147,161,161);">//送货信息选择回调，如果需要根据送货地址调整送货方式，比如普通地区包邮+极速配送，偏远地区只有付费普通配送，进行支付金额重新计算，可以实现该代理，返回给系统：shippingMethods配送方式，summaryItems账单列表，如果不支持该送货信息返回想要的PKPaymentAuthorizationStatus</span>
  <span class="hljs-selector-tag">completion</span>(PKPaymentAuthorizationStatusSuccess, shippingMethods, summaryItems);
}</code></pre> <p style="overflow:visible;"> 送货方式回调</p> <pre class="hljs groovy" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="groovy" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">-(<span class="hljs-keyword" style="color:rgb(133,153,0);">void</span>)<span class="hljs-string" style="color:rgb(42,161,152);">paymentAuthorizationViewController:</span>(PKPaymentAuthorizationViewController *)controller
<span class="hljs-symbol" style="color:rgb(203,75,22);"> didSelectShippingMethod:</span>(PKShippingMethod *)shippingMethod
<span class="hljs-symbol" style="color:rgb(203,75,22);"> completion:</span>(<span class="hljs-keyword" style="color:rgb(133,153,0);">void</span> (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))completion{
  <span class="hljs-comment" style="color:rgb(147,161,161);">//配送方式回调，如果需要根据不同的送货方式进行支付金额的调整，比如包邮和付费加速配送，可以实现该代理</span>
  PKShippingMethod *oldShippingMethod = [summaryItems <span class="hljs-string" style="color:rgb(42,161,152);">objectAtIndex:</span><span class="hljs-number" style="color:rgb(42,161,152);">2</span>];
  PKPaymentSummaryItem *total = [summaryItems lastObject];
  total.amount = [total.amount <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberBySubtracting:</span>oldShippingMethod.amount];
  total.amount = [total.amount <span class="hljs-string" style="color:rgb(42,161,152);">decimalNumberByAdding:</span>shippingMethod.amount];

  [summaryItems <span class="hljs-string" style="color:rgb(42,161,152);">replaceObjectAtIndex:</span><span class="hljs-number" style="color:rgb(42,161,152);">2</span> <span class="hljs-string" style="color:rgb(42,161,152);">withObject:</span>shippingMethod];
  [summaryItems <span class="hljs-string" style="color:rgb(42,161,152);">replaceObjectAtIndex:</span><span class="hljs-number" style="color:rgb(42,161,152);">3</span> <span class="hljs-string" style="color:rgb(42,161,152);">withObject:</span>total];

  completion(PKPaymentAuthorizationStatusSuccess, summaryItems);
}</code></pre> <p style="overflow:visible;"> 支付卡选择回调</p> <pre class="hljs less" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="less" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-selector-tag">-</span>(void)<span class="hljs-selector-tag">paymentAuthorizationViewController</span><span class="hljs-selector-pseudo">:(PKPaymentAuthorizationViewController</span> *)<span class="hljs-selector-tag">controller</span> <span class="hljs-selector-tag">didSelectPaymentMethod</span><span class="hljs-selector-pseudo">:(PKPaymentMethod</span> *)<span class="hljs-selector-tag">paymentMethod</span> <span class="hljs-selector-tag">completion</span><span class="hljs-selector-pseudo">:(void</span> (^)(NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))<span class="hljs-selector-tag">completion</span>{
  <span class="hljs-comment" style="color:rgb(147,161,161);">//支付银行卡回调，如果需要根据不同的银行调整付费金额，可以实现该代理</span>
  <span class="hljs-selector-tag">completion</span>(summaryItems);
}</code></pre> <p style="overflow:visible;"> 送货地址回调，已弃用</p> <pre class="hljs less" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="less" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;"><span class="hljs-selector-tag">-</span>(void)<span class="hljs-selector-tag">paymentAuthorizationViewController</span><span class="hljs-selector-pseudo">:(PKPaymentAuthorizationViewController</span> *)<span class="hljs-selector-tag">controller</span> <span class="hljs-selector-tag">didSelectShippingAddress</span><span class="hljs-selector-pseudo">:(ABRecordRef)address</span> <span class="hljs-selector-tag">completion</span><span class="hljs-selector-pseudo">:(void</span> (^)(PKPaymentAuthorizationStatus, NSArray&lt;PKShippingMethod *&gt; * _Nonnull, NSArray&lt;PKPaymentSummaryItem *&gt; * _Nonnull))<span class="hljs-selector-tag">completion</span>{
  <span class="hljs-comment" style="color:rgb(147,161,161);">//送货地址回调，已弃用</span>
}</code></pre> <p style="overflow:visible;"> 付款成功苹果服务器返回信息回调，做服务器验证</p> <pre class="hljs protobuf" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="protobuf" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">-(void)paymentAuthorizationViewController:(PKPaymentAuthorizationViewController *)controller
                     didAuthorizePayment:(PKPayment *)payment
                              completion:(void (^)(PKPaymentAuthorizationStatus status))completion {
  PKPaymentToken *payToken = payment.token;
  <span class="hljs-comment" style="color:rgb(147,161,161);">//支付凭据，发给服务端进行验证支付是否真实有效</span>
  PKContact *billingContact = payment.billingContact;     <span class="hljs-comment" style="color:rgb(147,161,161);">//账单信息</span>
  PKContact *shippingContact = payment.shippingContact;   <span class="hljs-comment" style="color:rgb(147,161,161);">//送货信息</span>
  PKContact *shippingMethod = payment.shippingMethod;     <span class="hljs-comment" style="color:rgb(147,161,161);">//送货方式</span>
  <span class="hljs-comment" style="color:rgb(147,161,161);">//等待服务器返回结果后再进行系统block调用</span>
  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number" style="color:rgb(42,161,152);">3</span> * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
      <span class="hljs-comment" style="color:rgb(147,161,161);">//模拟服务器通信</span>
      completion(PKPaymentAuthorizationStatusSuccess);
  });
}</code></pre> <p style="overflow:visible;"> 支付完成回调</p> <pre class="hljs groovy" style="overflow:auto;font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;line-height:1.42857;color:rgb(101,123,131);border:1px solid rgb(204,204,204);background:rgb(246,246,246);"><code class="groovy" style="font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:12px;border:none;background-color:transparent;">-(<span class="hljs-keyword" style="color:rgb(133,153,0);">void</span>)<span class="hljs-string" style="color:rgb(42,161,152);">paymentAuthorizationViewControllerDidFinish:</span>(PKPaymentAuthorizationViewController *)controller{
  [controller <span class="hljs-string" style="color:rgb(42,161,152);">dismissViewControllerAnimated:</span>YES <span class="hljs-string" style="color:rgb(42,161,152);">completion:</span>nil];
}</code></pre> </li>
  </ul> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wgl_happy/article/details/66972421,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/wgl_happy/article/details/66972421,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
