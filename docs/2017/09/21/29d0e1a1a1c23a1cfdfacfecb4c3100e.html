<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>如何编写智能合约（Smart Contract）？（II）建立加密代币 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="如何编写智能合约（Smart Contract）？（II）建立加密代币" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="如何编写智能合约（Smart Contract）？（II）建立加密代币 接着上一篇如何编写智能合约（Smart Contract）？，本篇文章，我们将写一个简单的加密代币的智能合约来给大家诠释加密代币的原理，当然这篇文章只是告诉你加密代币的原理，存在很多漏洞，不能直接使用。 启动testrpc 打开终端，启动testrpc，相关环境在如何编写智能合约（Smart Contract）？这篇文章里面已经有具体说明。 liyuechun:~ yuechunli$ testrpc EthereumJS TestRPC v4.1.3 (ganache-core: 1.1.3) ... 接下来我们就可以一步步的创建我们的加密代币项目了。 代币合约的基本概念 代币合约扮演的角色相当于银行的角色。使用者在代币合约中，用自己的以太币帐户地址当作银行帐户，可以透过代币合约执行转账（transfer，将代币由一个帐户转到另一个帐户），查询余额（balanceOf，查询指定帐户中拥有的代币）等原本由银行负责的工作。因为合约部署在公开区块链上，所有的交易都是公开透明，可供检验的。 创建代币合约项目 liyuechun:EncryptedToken yuechunli$ pwd /Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken liyuechun:EncryptedToken yuechunli$ truffle init Downloading project... Project initialized. Documentation: http://truffleframework.com/docs Commands: Compile: truffle compile Migrate: truffle migrate Test: truffle test liyuechun:EncryptedToken yuechunli$ 新建代币合约 终端执行truffle create contract EncryptedToken命令创建EncryptedToken.sol合约。 编写合约代码 将下面的合约代码拷贝，替换EncryptedToken.sol文件的代码。 pragma solidity ^0.4.4; contract EncryptedToken { uint256 INITIAL_SUPPLY = 666666; mapping(address =&gt; uint256) balances; function EncryptedToken() { balances[msg.sender] = INITIAL_SUPPLY; } // 转账到一个指定的地址 function transfer(address _to, uint256 _amount) { assert(balances[msg.sender] &lt; _amount); balances[msg.sender] -= _amount; balances[_to] += _amount; } // 查看指定地址的余额 function balanceOf(address _owner) constant returns (uint256) { return balances[_owner]; } } pragma solidity ^0.4.4中的0.4.4代表solidity的版本，^代表0.4.4 ~ 0.4.9之间的solidity都可以正常编译当前版本的合约。 contract相当于其他语言中的class，EncryptedToken相当于类的名字。contract EncryptedToken可以理解为class EncryptedToken extends Contract。 uint256 INITIAL_SUPPLY = 666666声明了一个变量INITIAL_SUPPLY，初始化存储了一个666666的整数作为部署当前合约的钱包地址的代币数。 mapping(address =&gt; uint256) balances;，balances是一个key类型为address，value类型为uint256的键值对(mapping)，相当于Java中的map、iOS中的NSDictionary。 function EncryptedToken()函数是EncryptedToken合约的构造函数(contructor)，当EncryptedToken合约调用时，会先执行它的构造函数。 在构造函数中，会以当前部署合约的钱包地址为key，以INITIAL_SUPPLY为value初始化一个键值对。 function transfer(address _to, uint256 _amount) { assert(balances[msg.sender] &lt; _amount); balances[msg.sender] -= _amount; balances[_to] += _amount; } transfer函数是声明用来从转账到指定钱包地址的函数，_to代表转账的目的地地址，_amount代表转账金额。 assert(balances[msg.sender] &lt; _amount)，这句代码中，我声明了一个断言，当balances[msg.sender] &lt; _amount，即当前钱包余额小于要转账的额度时，就会抛出异常。 balances[msg.sender] -= _amount;从当前钱包额度中减去_amount。 balances[_to] += _amount;，将目标地址的额度增加_amount。 function balanceOf(address _owner) constant returns (uint256) { return balances[_owner]; } balanceOf(address _owner)函数是用来查询指定钱包地址的余额，_owner即是指定的钱包地址，returns (uint256)代表返回值的类型为uint256，constant关键字的作用是，当我们调用balanceOf函数时，它会自动调用call()方法，表明只是读书数据，而不需要往区块链写入数据，调用这个方法，不需要花费手续费。 编译与部署 在migrations/目录下创建一个名字叫做3_deploy_contract.js的文件。文件中的内容为： var EncryptedToken = artifacts.require(&#39;./EncryptedToken.sol&#39;); module.exports = function(deployer) { deployer.deploy(EncryptedToken); } 接下来执行compile和migrate命令： liyuechun:EncryptedToken yuechunli$ truffle compile Compiling ./contracts/ConvertLib.sol... Compiling ./contracts/EncryptedToken.sol... Compiling ./contracts/MetaCoin.sol... Compiling ./contracts/Migrations.sol... Writing artifacts to ./build/contracts liyuechun:EncryptedToken yuechunli$ truffle migrate Using network &#39;development&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x8b31575b8ac09efae7bdf933823fcf91885b4e1c93b4d9b37421d22ab73cef25 Migrations: 0x9b34fffa8e0d2e6d09f59ee289db13e0662b68fe Saving successful migration to network... ... 0x45ba02af03a7e94f66bebbb72eebf547ffe128a49f01437aca6b45c2f489b0a1 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying ConvertLib... ... 0xae9c5fd334d8925b027d8de3ca9aeb13e2bd1d2d3b95b49ef3c7b472446d73ae ConvertLib: 0x3f7fff3afe38a0a152806a0f4f416e52a338829f Linking ConvertLib to MetaCoin Deploying MetaCoin... ... 0x8da8a4c881eb9bb62a1477db13044ce84707aac0df54f7ab1baf8b7f0904d251 MetaCoin: 0x7b9cc3ebba27a1ef8dda0b1825ae47369d647739 Saving successful migration to network... ... 0x319cebe2651f0dfbb4adb0a187745a6d47bde22243e4cb32346790ea9abbc5c8 Saving artifacts... Running migration: 3_deploy_contract.js Deploying EncryptedToken... ... 0x5e6203aaf1280bac1f991cb3d2858342d9287c0970da8068eeae657b54022cab EncryptedToken: 0x16685fb5d7e88293fc1c79a0428f3ab9d2165384 Saving successful migration to network... ... 0x713227a22cafea3ff1fa3bd35ff38cb367d9c8dbdc698124053f72020d37bf28 Saving artifacts... liyuechun:EncryptedToken yuechunli$ 如上所示，我们已经将EncryptedToken代币合约部署到了testrpc上。 合约验证 合约部署完成后，我们通过truffle console开启console控制台，在这个控制台中对已经部署的合约进行验证。 liyuechun:EncryptedToken yuechunli$ truffle console truffle(development)&gt; web3.eth.coinbase &#39;0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1&#39; truffle(development)&gt; web3.eth.accounts[0] &#39;0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1&#39; truffle(development)&gt; web3.eth.accounts[1] &#39;0xedbbf7b06f3f35fd32ab8157e6cd4ced257451e8&#39; truffle(development)&gt; web3.eth.accounts[2] &#39;0xfdb73d8ed20f7e9981264be7639346e57db28698&#39; truffle(development)&gt; web3.eth.accounts[3] &#39;0x77f0688b69c236f0fb9264a9daf8ca06952f278f&#39; truffle(development)&gt; web3.eth.accounts[4] &#39;0x4f1ed5c8c87fad9c37ab509203026d041e00417b&#39; truffle(development)&gt; web3.eth.accounts[5] &#39;0xdead10c6c02ef4121e0d2f63d979daa3b9a692be&#39; truffle(development)&gt; web3.eth.accounts[6] &#39;0xf265663d195078f445a08966a660fbffff421d20&#39; truffle(development)&gt; web3.eth.accounts[7] &#39;0x1d822a897b9ca697ee03766b3d13a5a0c7235b78&#39; truffle(development)&gt; web3.eth.accounts[8] &#39;0xafcc21dc7a09c8e23532aba4c8cc64b1b7831892&#39; truffle(development)&gt; web3.eth.accounts[9] &#39;0x4693ab1bc520ac1314e77077645b7ee15f7510ce&#39; truffle(development)&gt; 在testrpc启动时，系统会给我们分配10个钱包地址，如上图所示我们可以通过web3.eth.coinbase或者web3.eth.accounts[0]获取首个钱包地址，当然也可以根据索引获取其他的钱包地址。 接下来声明一个合约变量存储EncryptedToken合约实例。 truffle(development)&gt; let contract; undefined truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance) ..... truffle(development)&gt; 验证web3.eth.coinbase和web3.eth.accounts[1]中的余额。 truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666666&#39;] s: 1, e: 5, c: [ 666666 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;0&#39;] s: 1, e: 0, c: [ 0 ] } truffle(development)&gt; 经验证，第0个钱包地址中的代币余额为666666，第1个钱包地址中的代币余额为0。 下一步，我们将从第0个账号中向第1个账号转账666个代币。 truffle(development)&gt; contract.transfer(web3.eth.accounts[1], 666) Error: VM Exception while processing transaction: invalid opcode at Object.InvalidResponse (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:37295:16) at /usr/local/lib/node_modules/truffle/build/cli.bundled.js:224765:36 at /usr/local/lib/node_modules/truffle/build/cli.bundled.js:208348:9 at XMLHttpRequest.request.onreadystatechange (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:209773:13) at XMLHttpRequestEventTarget.dispatchEvent (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67130:18) at XMLHttpRequest._setReadyState (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67420:12) at XMLHttpRequest._onHttpResponseEnd (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67575:12) at IncomingMessage.&lt;anonymous&gt; (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67535:24) at emitNone (events.js:110:20) at IncomingMessage.emit (events.js:207:7) truffle(development)&gt; 如上所示，转账过程中出现了异常，转账失败，仔细检查一下，不难发现是因为在我们合约代码EncryptedToken.sol中有这么一句代码assert(balances[msg.sender] &lt; _amount);，也就是说只有当balances[msg.sender]小于_amount时，才不会出现异常，所以我们应该将&lt;符号换成&gt;符号，即当balances[msg.sender]余额不足时抛出异常。 代码修改后，需要重新编译，部署。 liyuechun:EncryptedToken yuechunli$ pwd /Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken liyuechun:EncryptedToken yuechunli$ ls build contracts migrations test truffle.js liyuechun:EncryptedToken yuechunli$ rm -rf build/ liyuechun:EncryptedToken yuechunli$ ls contracts migrations test truffle.js liyuechun:EncryptedToken yuechunli$ truffle compile Compiling ./contracts/ConvertLib.sol... Compiling ./contracts/EncryptedToken.sol... Compiling ./contracts/MetaCoin.sol... Compiling ./contracts/Migrations.sol... Writing artifacts to ./build/contracts liyuechun:EncryptedToken yuechunli$ truffle migrate --reset Using network &#39;development&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x04c008d8e7008afa1ace7c0dc294eb2e5b02a94960e559811d12187c53b07e56 Migrations: 0x192929621fd7cf4dd2ac72b42c5f52b40ccfa999 Saving successful migration to network... ... 0xd4c65a206e68caab63957343e59282f7a34d92b0f1e1ac99cf77c127d014f958 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying ConvertLib... ... 0x4d9e476d05e1b7aea3764c0fd44799ce984d04006435d2959a87b97f62ee2c5a ConvertLib: 0xdf7dc01c43772881f21f857f2d689ea591a66a20 Linking ConvertLib to MetaCoin Deploying MetaCoin... ... 0xe4ef8fc746d9772a964d8137af4c14eab4c03a7071e1b1b1f27ec963a28558b0 MetaCoin: 0x685a10d1a8d5196e20a8ae31e0fe80f122e4dd47 Saving successful migration to network... ... 0xdd3a300b3f22997540ae019f31f0de4b6b8117cf1dcbc61ed5c2b25bb8011e7c Saving artifacts... Running migration: 3_deploy_contract.js Deploying EncryptedToken... ... 0x08ff437889f6bca7650550491937ed078d09bbbec5a2986146824ba7b7bd0e27 EncryptedToken: 0xe4de630b2c2818dc18a1ac16935a945634c33a03 Saving successful migration to network... ... 0x6eadbc688aca46b34d11696ceca3564ded694dec772412ecf3da4cb6310f7d23 Saving artifacts... liyuechun:EncryptedToken yuechunli$ 备注：编译时，一定要先将build文件夹删除，其次在部署合约时，一定要添加--reset，否则修改后的合约没法部署成功。 打开控制台，按照如下操作进行验证。 liyuechun:EncryptedToken yuechunli$ truffle console truffle(development)&gt; let contract undefined truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance) truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666666&#39;] s: 1, e: 5, c: [ 666666 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;0&#39;] s: 1, e: 0, c: [ 0 ] } truffle(development)&gt; contract.transfer(web3.eth.accounts[1], 666) { tx: &#39;0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d&#39;, receipt: { transactionHash: &#39;0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d&#39;, transactionIndex: 0, blockHash: &#39;0xe02e7c9859d43e398bf0ece48e3a15510bb76beefa9bd48ce46a39022ccf5a43&#39;, blockNumber: 31, gasUsed: 48952, cumulativeGasUsed: 48952, contractAddress: null, logs: [] }, logs: [] } truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666000&#39;] s: 1, e: 5, c: [ 666000 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;666&#39;] s: 1, e: 2, c: [ 666 ] } truffle(development)&gt; 如上所示，代币转账成功。 总结 在这篇文章中，只是简单介绍了代币系统的逻辑，并没有对安全进行相关操作，比如：余额不够的处理、地址合不合法的处理等等。当然，通过这篇文章的学习，你再回头看我们初始项目中的MetaCoin代码时，你就应该能看懂了。 打赏地址 **比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645 技术交流 区块链技术交流QQ群：348924182 「区块链部落」官方公众号 参考资料 [1] http://solidity.readthedocs.io/en/latest/index.html [2] https://ethereum.github.io/browser-solidity/ [3] http://truffleframework.com/ [4] https://github.com/iurimatias/embark-framework [5] https://github.com/ethereum/ens [6] https://github.com/ethereumjs/testrpc [7] https://github.com/ethereumjs/ethereumjs-vm [8] http://web3js.readthedocs.io/en/1.0/index.html 阅读更多" />
<meta property="og:description" content="如何编写智能合约（Smart Contract）？（II）建立加密代币 接着上一篇如何编写智能合约（Smart Contract）？，本篇文章，我们将写一个简单的加密代币的智能合约来给大家诠释加密代币的原理，当然这篇文章只是告诉你加密代币的原理，存在很多漏洞，不能直接使用。 启动testrpc 打开终端，启动testrpc，相关环境在如何编写智能合约（Smart Contract）？这篇文章里面已经有具体说明。 liyuechun:~ yuechunli$ testrpc EthereumJS TestRPC v4.1.3 (ganache-core: 1.1.3) ... 接下来我们就可以一步步的创建我们的加密代币项目了。 代币合约的基本概念 代币合约扮演的角色相当于银行的角色。使用者在代币合约中，用自己的以太币帐户地址当作银行帐户，可以透过代币合约执行转账（transfer，将代币由一个帐户转到另一个帐户），查询余额（balanceOf，查询指定帐户中拥有的代币）等原本由银行负责的工作。因为合约部署在公开区块链上，所有的交易都是公开透明，可供检验的。 创建代币合约项目 liyuechun:EncryptedToken yuechunli$ pwd /Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken liyuechun:EncryptedToken yuechunli$ truffle init Downloading project... Project initialized. Documentation: http://truffleframework.com/docs Commands: Compile: truffle compile Migrate: truffle migrate Test: truffle test liyuechun:EncryptedToken yuechunli$ 新建代币合约 终端执行truffle create contract EncryptedToken命令创建EncryptedToken.sol合约。 编写合约代码 将下面的合约代码拷贝，替换EncryptedToken.sol文件的代码。 pragma solidity ^0.4.4; contract EncryptedToken { uint256 INITIAL_SUPPLY = 666666; mapping(address =&gt; uint256) balances; function EncryptedToken() { balances[msg.sender] = INITIAL_SUPPLY; } // 转账到一个指定的地址 function transfer(address _to, uint256 _amount) { assert(balances[msg.sender] &lt; _amount); balances[msg.sender] -= _amount; balances[_to] += _amount; } // 查看指定地址的余额 function balanceOf(address _owner) constant returns (uint256) { return balances[_owner]; } } pragma solidity ^0.4.4中的0.4.4代表solidity的版本，^代表0.4.4 ~ 0.4.9之间的solidity都可以正常编译当前版本的合约。 contract相当于其他语言中的class，EncryptedToken相当于类的名字。contract EncryptedToken可以理解为class EncryptedToken extends Contract。 uint256 INITIAL_SUPPLY = 666666声明了一个变量INITIAL_SUPPLY，初始化存储了一个666666的整数作为部署当前合约的钱包地址的代币数。 mapping(address =&gt; uint256) balances;，balances是一个key类型为address，value类型为uint256的键值对(mapping)，相当于Java中的map、iOS中的NSDictionary。 function EncryptedToken()函数是EncryptedToken合约的构造函数(contructor)，当EncryptedToken合约调用时，会先执行它的构造函数。 在构造函数中，会以当前部署合约的钱包地址为key，以INITIAL_SUPPLY为value初始化一个键值对。 function transfer(address _to, uint256 _amount) { assert(balances[msg.sender] &lt; _amount); balances[msg.sender] -= _amount; balances[_to] += _amount; } transfer函数是声明用来从转账到指定钱包地址的函数，_to代表转账的目的地地址，_amount代表转账金额。 assert(balances[msg.sender] &lt; _amount)，这句代码中，我声明了一个断言，当balances[msg.sender] &lt; _amount，即当前钱包余额小于要转账的额度时，就会抛出异常。 balances[msg.sender] -= _amount;从当前钱包额度中减去_amount。 balances[_to] += _amount;，将目标地址的额度增加_amount。 function balanceOf(address _owner) constant returns (uint256) { return balances[_owner]; } balanceOf(address _owner)函数是用来查询指定钱包地址的余额，_owner即是指定的钱包地址，returns (uint256)代表返回值的类型为uint256，constant关键字的作用是，当我们调用balanceOf函数时，它会自动调用call()方法，表明只是读书数据，而不需要往区块链写入数据，调用这个方法，不需要花费手续费。 编译与部署 在migrations/目录下创建一个名字叫做3_deploy_contract.js的文件。文件中的内容为： var EncryptedToken = artifacts.require(&#39;./EncryptedToken.sol&#39;); module.exports = function(deployer) { deployer.deploy(EncryptedToken); } 接下来执行compile和migrate命令： liyuechun:EncryptedToken yuechunli$ truffle compile Compiling ./contracts/ConvertLib.sol... Compiling ./contracts/EncryptedToken.sol... Compiling ./contracts/MetaCoin.sol... Compiling ./contracts/Migrations.sol... Writing artifacts to ./build/contracts liyuechun:EncryptedToken yuechunli$ truffle migrate Using network &#39;development&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x8b31575b8ac09efae7bdf933823fcf91885b4e1c93b4d9b37421d22ab73cef25 Migrations: 0x9b34fffa8e0d2e6d09f59ee289db13e0662b68fe Saving successful migration to network... ... 0x45ba02af03a7e94f66bebbb72eebf547ffe128a49f01437aca6b45c2f489b0a1 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying ConvertLib... ... 0xae9c5fd334d8925b027d8de3ca9aeb13e2bd1d2d3b95b49ef3c7b472446d73ae ConvertLib: 0x3f7fff3afe38a0a152806a0f4f416e52a338829f Linking ConvertLib to MetaCoin Deploying MetaCoin... ... 0x8da8a4c881eb9bb62a1477db13044ce84707aac0df54f7ab1baf8b7f0904d251 MetaCoin: 0x7b9cc3ebba27a1ef8dda0b1825ae47369d647739 Saving successful migration to network... ... 0x319cebe2651f0dfbb4adb0a187745a6d47bde22243e4cb32346790ea9abbc5c8 Saving artifacts... Running migration: 3_deploy_contract.js Deploying EncryptedToken... ... 0x5e6203aaf1280bac1f991cb3d2858342d9287c0970da8068eeae657b54022cab EncryptedToken: 0x16685fb5d7e88293fc1c79a0428f3ab9d2165384 Saving successful migration to network... ... 0x713227a22cafea3ff1fa3bd35ff38cb367d9c8dbdc698124053f72020d37bf28 Saving artifacts... liyuechun:EncryptedToken yuechunli$ 如上所示，我们已经将EncryptedToken代币合约部署到了testrpc上。 合约验证 合约部署完成后，我们通过truffle console开启console控制台，在这个控制台中对已经部署的合约进行验证。 liyuechun:EncryptedToken yuechunli$ truffle console truffle(development)&gt; web3.eth.coinbase &#39;0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1&#39; truffle(development)&gt; web3.eth.accounts[0] &#39;0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1&#39; truffle(development)&gt; web3.eth.accounts[1] &#39;0xedbbf7b06f3f35fd32ab8157e6cd4ced257451e8&#39; truffle(development)&gt; web3.eth.accounts[2] &#39;0xfdb73d8ed20f7e9981264be7639346e57db28698&#39; truffle(development)&gt; web3.eth.accounts[3] &#39;0x77f0688b69c236f0fb9264a9daf8ca06952f278f&#39; truffle(development)&gt; web3.eth.accounts[4] &#39;0x4f1ed5c8c87fad9c37ab509203026d041e00417b&#39; truffle(development)&gt; web3.eth.accounts[5] &#39;0xdead10c6c02ef4121e0d2f63d979daa3b9a692be&#39; truffle(development)&gt; web3.eth.accounts[6] &#39;0xf265663d195078f445a08966a660fbffff421d20&#39; truffle(development)&gt; web3.eth.accounts[7] &#39;0x1d822a897b9ca697ee03766b3d13a5a0c7235b78&#39; truffle(development)&gt; web3.eth.accounts[8] &#39;0xafcc21dc7a09c8e23532aba4c8cc64b1b7831892&#39; truffle(development)&gt; web3.eth.accounts[9] &#39;0x4693ab1bc520ac1314e77077645b7ee15f7510ce&#39; truffle(development)&gt; 在testrpc启动时，系统会给我们分配10个钱包地址，如上图所示我们可以通过web3.eth.coinbase或者web3.eth.accounts[0]获取首个钱包地址，当然也可以根据索引获取其他的钱包地址。 接下来声明一个合约变量存储EncryptedToken合约实例。 truffle(development)&gt; let contract; undefined truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance) ..... truffle(development)&gt; 验证web3.eth.coinbase和web3.eth.accounts[1]中的余额。 truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666666&#39;] s: 1, e: 5, c: [ 666666 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;0&#39;] s: 1, e: 0, c: [ 0 ] } truffle(development)&gt; 经验证，第0个钱包地址中的代币余额为666666，第1个钱包地址中的代币余额为0。 下一步，我们将从第0个账号中向第1个账号转账666个代币。 truffle(development)&gt; contract.transfer(web3.eth.accounts[1], 666) Error: VM Exception while processing transaction: invalid opcode at Object.InvalidResponse (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:37295:16) at /usr/local/lib/node_modules/truffle/build/cli.bundled.js:224765:36 at /usr/local/lib/node_modules/truffle/build/cli.bundled.js:208348:9 at XMLHttpRequest.request.onreadystatechange (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:209773:13) at XMLHttpRequestEventTarget.dispatchEvent (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67130:18) at XMLHttpRequest._setReadyState (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67420:12) at XMLHttpRequest._onHttpResponseEnd (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67575:12) at IncomingMessage.&lt;anonymous&gt; (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67535:24) at emitNone (events.js:110:20) at IncomingMessage.emit (events.js:207:7) truffle(development)&gt; 如上所示，转账过程中出现了异常，转账失败，仔细检查一下，不难发现是因为在我们合约代码EncryptedToken.sol中有这么一句代码assert(balances[msg.sender] &lt; _amount);，也就是说只有当balances[msg.sender]小于_amount时，才不会出现异常，所以我们应该将&lt;符号换成&gt;符号，即当balances[msg.sender]余额不足时抛出异常。 代码修改后，需要重新编译，部署。 liyuechun:EncryptedToken yuechunli$ pwd /Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken liyuechun:EncryptedToken yuechunli$ ls build contracts migrations test truffle.js liyuechun:EncryptedToken yuechunli$ rm -rf build/ liyuechun:EncryptedToken yuechunli$ ls contracts migrations test truffle.js liyuechun:EncryptedToken yuechunli$ truffle compile Compiling ./contracts/ConvertLib.sol... Compiling ./contracts/EncryptedToken.sol... Compiling ./contracts/MetaCoin.sol... Compiling ./contracts/Migrations.sol... Writing artifacts to ./build/contracts liyuechun:EncryptedToken yuechunli$ truffle migrate --reset Using network &#39;development&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x04c008d8e7008afa1ace7c0dc294eb2e5b02a94960e559811d12187c53b07e56 Migrations: 0x192929621fd7cf4dd2ac72b42c5f52b40ccfa999 Saving successful migration to network... ... 0xd4c65a206e68caab63957343e59282f7a34d92b0f1e1ac99cf77c127d014f958 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying ConvertLib... ... 0x4d9e476d05e1b7aea3764c0fd44799ce984d04006435d2959a87b97f62ee2c5a ConvertLib: 0xdf7dc01c43772881f21f857f2d689ea591a66a20 Linking ConvertLib to MetaCoin Deploying MetaCoin... ... 0xe4ef8fc746d9772a964d8137af4c14eab4c03a7071e1b1b1f27ec963a28558b0 MetaCoin: 0x685a10d1a8d5196e20a8ae31e0fe80f122e4dd47 Saving successful migration to network... ... 0xdd3a300b3f22997540ae019f31f0de4b6b8117cf1dcbc61ed5c2b25bb8011e7c Saving artifacts... Running migration: 3_deploy_contract.js Deploying EncryptedToken... ... 0x08ff437889f6bca7650550491937ed078d09bbbec5a2986146824ba7b7bd0e27 EncryptedToken: 0xe4de630b2c2818dc18a1ac16935a945634c33a03 Saving successful migration to network... ... 0x6eadbc688aca46b34d11696ceca3564ded694dec772412ecf3da4cb6310f7d23 Saving artifacts... liyuechun:EncryptedToken yuechunli$ 备注：编译时，一定要先将build文件夹删除，其次在部署合约时，一定要添加--reset，否则修改后的合约没法部署成功。 打开控制台，按照如下操作进行验证。 liyuechun:EncryptedToken yuechunli$ truffle console truffle(development)&gt; let contract undefined truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance) truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666666&#39;] s: 1, e: 5, c: [ 666666 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;0&#39;] s: 1, e: 0, c: [ 0 ] } truffle(development)&gt; contract.transfer(web3.eth.accounts[1], 666) { tx: &#39;0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d&#39;, receipt: { transactionHash: &#39;0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d&#39;, transactionIndex: 0, blockHash: &#39;0xe02e7c9859d43e398bf0ece48e3a15510bb76beefa9bd48ce46a39022ccf5a43&#39;, blockNumber: 31, gasUsed: 48952, cumulativeGasUsed: 48952, contractAddress: null, logs: [] }, logs: [] } truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666000&#39;] s: 1, e: 5, c: [ 666000 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;666&#39;] s: 1, e: 2, c: [ 666 ] } truffle(development)&gt; 如上所示，代币转账成功。 总结 在这篇文章中，只是简单介绍了代币系统的逻辑，并没有对安全进行相关操作，比如：余额不够的处理、地址合不合法的处理等等。当然，通过这篇文章的学习，你再回头看我们初始项目中的MetaCoin代码时，你就应该能看懂了。 打赏地址 **比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645 技术交流 区块链技术交流QQ群：348924182 「区块链部落」官方公众号 参考资料 [1] http://solidity.readthedocs.io/en/latest/index.html [2] https://ethereum.github.io/browser-solidity/ [3] http://truffleframework.com/ [4] https://github.com/iurimatias/embark-framework [5] https://github.com/ethereum/ens [6] https://github.com/ethereumjs/testrpc [7] https://github.com/ethereumjs/ethereumjs-vm [8] http://web3js.readthedocs.io/en/1.0/index.html 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/09/21/29d0e1a1a1c23a1cfdfacfecb4c3100e.html" />
<meta property="og:url" content="https://mlh.app/2017/09/21/29d0e1a1a1c23a1cfdfacfecb4c3100e.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-21T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"如何编写智能合约（Smart Contract）？（II）建立加密代币 接着上一篇如何编写智能合约（Smart Contract）？，本篇文章，我们将写一个简单的加密代币的智能合约来给大家诠释加密代币的原理，当然这篇文章只是告诉你加密代币的原理，存在很多漏洞，不能直接使用。 启动testrpc 打开终端，启动testrpc，相关环境在如何编写智能合约（Smart Contract）？这篇文章里面已经有具体说明。 liyuechun:~ yuechunli$ testrpc EthereumJS TestRPC v4.1.3 (ganache-core: 1.1.3) ... 接下来我们就可以一步步的创建我们的加密代币项目了。 代币合约的基本概念 代币合约扮演的角色相当于银行的角色。使用者在代币合约中，用自己的以太币帐户地址当作银行帐户，可以透过代币合约执行转账（transfer，将代币由一个帐户转到另一个帐户），查询余额（balanceOf，查询指定帐户中拥有的代币）等原本由银行负责的工作。因为合约部署在公开区块链上，所有的交易都是公开透明，可供检验的。 创建代币合约项目 liyuechun:EncryptedToken yuechunli$ pwd /Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken liyuechun:EncryptedToken yuechunli$ truffle init Downloading project... Project initialized. Documentation: http://truffleframework.com/docs Commands: Compile: truffle compile Migrate: truffle migrate Test: truffle test liyuechun:EncryptedToken yuechunli$ 新建代币合约 终端执行truffle create contract EncryptedToken命令创建EncryptedToken.sol合约。 编写合约代码 将下面的合约代码拷贝，替换EncryptedToken.sol文件的代码。 pragma solidity ^0.4.4; contract EncryptedToken { uint256 INITIAL_SUPPLY = 666666; mapping(address =&gt; uint256) balances; function EncryptedToken() { balances[msg.sender] = INITIAL_SUPPLY; } // 转账到一个指定的地址 function transfer(address _to, uint256 _amount) { assert(balances[msg.sender] &lt; _amount); balances[msg.sender] -= _amount; balances[_to] += _amount; } // 查看指定地址的余额 function balanceOf(address _owner) constant returns (uint256) { return balances[_owner]; } } pragma solidity ^0.4.4中的0.4.4代表solidity的版本，^代表0.4.4 ~ 0.4.9之间的solidity都可以正常编译当前版本的合约。 contract相当于其他语言中的class，EncryptedToken相当于类的名字。contract EncryptedToken可以理解为class EncryptedToken extends Contract。 uint256 INITIAL_SUPPLY = 666666声明了一个变量INITIAL_SUPPLY，初始化存储了一个666666的整数作为部署当前合约的钱包地址的代币数。 mapping(address =&gt; uint256) balances;，balances是一个key类型为address，value类型为uint256的键值对(mapping)，相当于Java中的map、iOS中的NSDictionary。 function EncryptedToken()函数是EncryptedToken合约的构造函数(contructor)，当EncryptedToken合约调用时，会先执行它的构造函数。 在构造函数中，会以当前部署合约的钱包地址为key，以INITIAL_SUPPLY为value初始化一个键值对。 function transfer(address _to, uint256 _amount) { assert(balances[msg.sender] &lt; _amount); balances[msg.sender] -= _amount; balances[_to] += _amount; } transfer函数是声明用来从转账到指定钱包地址的函数，_to代表转账的目的地地址，_amount代表转账金额。 assert(balances[msg.sender] &lt; _amount)，这句代码中，我声明了一个断言，当balances[msg.sender] &lt; _amount，即当前钱包余额小于要转账的额度时，就会抛出异常。 balances[msg.sender] -= _amount;从当前钱包额度中减去_amount。 balances[_to] += _amount;，将目标地址的额度增加_amount。 function balanceOf(address _owner) constant returns (uint256) { return balances[_owner]; } balanceOf(address _owner)函数是用来查询指定钱包地址的余额，_owner即是指定的钱包地址，returns (uint256)代表返回值的类型为uint256，constant关键字的作用是，当我们调用balanceOf函数时，它会自动调用call()方法，表明只是读书数据，而不需要往区块链写入数据，调用这个方法，不需要花费手续费。 编译与部署 在migrations/目录下创建一个名字叫做3_deploy_contract.js的文件。文件中的内容为： var EncryptedToken = artifacts.require(&#39;./EncryptedToken.sol&#39;); module.exports = function(deployer) { deployer.deploy(EncryptedToken); } 接下来执行compile和migrate命令： liyuechun:EncryptedToken yuechunli$ truffle compile Compiling ./contracts/ConvertLib.sol... Compiling ./contracts/EncryptedToken.sol... Compiling ./contracts/MetaCoin.sol... Compiling ./contracts/Migrations.sol... Writing artifacts to ./build/contracts liyuechun:EncryptedToken yuechunli$ truffle migrate Using network &#39;development&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x8b31575b8ac09efae7bdf933823fcf91885b4e1c93b4d9b37421d22ab73cef25 Migrations: 0x9b34fffa8e0d2e6d09f59ee289db13e0662b68fe Saving successful migration to network... ... 0x45ba02af03a7e94f66bebbb72eebf547ffe128a49f01437aca6b45c2f489b0a1 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying ConvertLib... ... 0xae9c5fd334d8925b027d8de3ca9aeb13e2bd1d2d3b95b49ef3c7b472446d73ae ConvertLib: 0x3f7fff3afe38a0a152806a0f4f416e52a338829f Linking ConvertLib to MetaCoin Deploying MetaCoin... ... 0x8da8a4c881eb9bb62a1477db13044ce84707aac0df54f7ab1baf8b7f0904d251 MetaCoin: 0x7b9cc3ebba27a1ef8dda0b1825ae47369d647739 Saving successful migration to network... ... 0x319cebe2651f0dfbb4adb0a187745a6d47bde22243e4cb32346790ea9abbc5c8 Saving artifacts... Running migration: 3_deploy_contract.js Deploying EncryptedToken... ... 0x5e6203aaf1280bac1f991cb3d2858342d9287c0970da8068eeae657b54022cab EncryptedToken: 0x16685fb5d7e88293fc1c79a0428f3ab9d2165384 Saving successful migration to network... ... 0x713227a22cafea3ff1fa3bd35ff38cb367d9c8dbdc698124053f72020d37bf28 Saving artifacts... liyuechun:EncryptedToken yuechunli$ 如上所示，我们已经将EncryptedToken代币合约部署到了testrpc上。 合约验证 合约部署完成后，我们通过truffle console开启console控制台，在这个控制台中对已经部署的合约进行验证。 liyuechun:EncryptedToken yuechunli$ truffle console truffle(development)&gt; web3.eth.coinbase &#39;0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1&#39; truffle(development)&gt; web3.eth.accounts[0] &#39;0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1&#39; truffle(development)&gt; web3.eth.accounts[1] &#39;0xedbbf7b06f3f35fd32ab8157e6cd4ced257451e8&#39; truffle(development)&gt; web3.eth.accounts[2] &#39;0xfdb73d8ed20f7e9981264be7639346e57db28698&#39; truffle(development)&gt; web3.eth.accounts[3] &#39;0x77f0688b69c236f0fb9264a9daf8ca06952f278f&#39; truffle(development)&gt; web3.eth.accounts[4] &#39;0x4f1ed5c8c87fad9c37ab509203026d041e00417b&#39; truffle(development)&gt; web3.eth.accounts[5] &#39;0xdead10c6c02ef4121e0d2f63d979daa3b9a692be&#39; truffle(development)&gt; web3.eth.accounts[6] &#39;0xf265663d195078f445a08966a660fbffff421d20&#39; truffle(development)&gt; web3.eth.accounts[7] &#39;0x1d822a897b9ca697ee03766b3d13a5a0c7235b78&#39; truffle(development)&gt; web3.eth.accounts[8] &#39;0xafcc21dc7a09c8e23532aba4c8cc64b1b7831892&#39; truffle(development)&gt; web3.eth.accounts[9] &#39;0x4693ab1bc520ac1314e77077645b7ee15f7510ce&#39; truffle(development)&gt; 在testrpc启动时，系统会给我们分配10个钱包地址，如上图所示我们可以通过web3.eth.coinbase或者web3.eth.accounts[0]获取首个钱包地址，当然也可以根据索引获取其他的钱包地址。 接下来声明一个合约变量存储EncryptedToken合约实例。 truffle(development)&gt; let contract; undefined truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance) ..... truffle(development)&gt; 验证web3.eth.coinbase和web3.eth.accounts[1]中的余额。 truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666666&#39;] s: 1, e: 5, c: [ 666666 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;0&#39;] s: 1, e: 0, c: [ 0 ] } truffle(development)&gt; 经验证，第0个钱包地址中的代币余额为666666，第1个钱包地址中的代币余额为0。 下一步，我们将从第0个账号中向第1个账号转账666个代币。 truffle(development)&gt; contract.transfer(web3.eth.accounts[1], 666) Error: VM Exception while processing transaction: invalid opcode at Object.InvalidResponse (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:37295:16) at /usr/local/lib/node_modules/truffle/build/cli.bundled.js:224765:36 at /usr/local/lib/node_modules/truffle/build/cli.bundled.js:208348:9 at XMLHttpRequest.request.onreadystatechange (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:209773:13) at XMLHttpRequestEventTarget.dispatchEvent (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67130:18) at XMLHttpRequest._setReadyState (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67420:12) at XMLHttpRequest._onHttpResponseEnd (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67575:12) at IncomingMessage.&lt;anonymous&gt; (/usr/local/lib/node_modules/truffle/build/cli.bundled.js:67535:24) at emitNone (events.js:110:20) at IncomingMessage.emit (events.js:207:7) truffle(development)&gt; 如上所示，转账过程中出现了异常，转账失败，仔细检查一下，不难发现是因为在我们合约代码EncryptedToken.sol中有这么一句代码assert(balances[msg.sender] &lt; _amount);，也就是说只有当balances[msg.sender]小于_amount时，才不会出现异常，所以我们应该将&lt;符号换成&gt;符号，即当balances[msg.sender]余额不足时抛出异常。 代码修改后，需要重新编译，部署。 liyuechun:EncryptedToken yuechunli$ pwd /Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken liyuechun:EncryptedToken yuechunli$ ls build contracts migrations test truffle.js liyuechun:EncryptedToken yuechunli$ rm -rf build/ liyuechun:EncryptedToken yuechunli$ ls contracts migrations test truffle.js liyuechun:EncryptedToken yuechunli$ truffle compile Compiling ./contracts/ConvertLib.sol... Compiling ./contracts/EncryptedToken.sol... Compiling ./contracts/MetaCoin.sol... Compiling ./contracts/Migrations.sol... Writing artifacts to ./build/contracts liyuechun:EncryptedToken yuechunli$ truffle migrate --reset Using network &#39;development&#39;. Running migration: 1_initial_migration.js Deploying Migrations... ... 0x04c008d8e7008afa1ace7c0dc294eb2e5b02a94960e559811d12187c53b07e56 Migrations: 0x192929621fd7cf4dd2ac72b42c5f52b40ccfa999 Saving successful migration to network... ... 0xd4c65a206e68caab63957343e59282f7a34d92b0f1e1ac99cf77c127d014f958 Saving artifacts... Running migration: 2_deploy_contracts.js Deploying ConvertLib... ... 0x4d9e476d05e1b7aea3764c0fd44799ce984d04006435d2959a87b97f62ee2c5a ConvertLib: 0xdf7dc01c43772881f21f857f2d689ea591a66a20 Linking ConvertLib to MetaCoin Deploying MetaCoin... ... 0xe4ef8fc746d9772a964d8137af4c14eab4c03a7071e1b1b1f27ec963a28558b0 MetaCoin: 0x685a10d1a8d5196e20a8ae31e0fe80f122e4dd47 Saving successful migration to network... ... 0xdd3a300b3f22997540ae019f31f0de4b6b8117cf1dcbc61ed5c2b25bb8011e7c Saving artifacts... Running migration: 3_deploy_contract.js Deploying EncryptedToken... ... 0x08ff437889f6bca7650550491937ed078d09bbbec5a2986146824ba7b7bd0e27 EncryptedToken: 0xe4de630b2c2818dc18a1ac16935a945634c33a03 Saving successful migration to network... ... 0x6eadbc688aca46b34d11696ceca3564ded694dec772412ecf3da4cb6310f7d23 Saving artifacts... liyuechun:EncryptedToken yuechunli$ 备注：编译时，一定要先将build文件夹删除，其次在部署合约时，一定要添加--reset，否则修改后的合约没法部署成功。 打开控制台，按照如下操作进行验证。 liyuechun:EncryptedToken yuechunli$ truffle console truffle(development)&gt; let contract undefined truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance) truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666666&#39;] s: 1, e: 5, c: [ 666666 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;0&#39;] s: 1, e: 0, c: [ 0 ] } truffle(development)&gt; contract.transfer(web3.eth.accounts[1], 666) { tx: &#39;0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d&#39;, receipt: { transactionHash: &#39;0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d&#39;, transactionIndex: 0, blockHash: &#39;0xe02e7c9859d43e398bf0ece48e3a15510bb76beefa9bd48ce46a39022ccf5a43&#39;, blockNumber: 31, gasUsed: 48952, cumulativeGasUsed: 48952, contractAddress: null, logs: [] }, logs: [] } truffle(development)&gt; contract.balanceOf(web3.eth.coinbase) { [String: &#39;666000&#39;] s: 1, e: 5, c: [ 666000 ] } truffle(development)&gt; contract.balanceOf(web3.eth.accounts[1]) { [String: &#39;666&#39;] s: 1, e: 2, c: [ 666 ] } truffle(development)&gt; 如上所示，代币转账成功。 总结 在这篇文章中，只是简单介绍了代币系统的逻辑，并没有对安全进行相关操作，比如：余额不够的处理、地址合不合法的处理等等。当然，通过这篇文章的学习，你再回头看我们初始项目中的MetaCoin代码时，你就应该能看懂了。 打赏地址 **比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645 技术交流 区块链技术交流QQ群：348924182 「区块链部落」官方公众号 参考资料 [1] http://solidity.readthedocs.io/en/latest/index.html [2] https://ethereum.github.io/browser-solidity/ [3] http://truffleframework.com/ [4] https://github.com/iurimatias/embark-framework [5] https://github.com/ethereum/ens [6] https://github.com/ethereumjs/testrpc [7] https://github.com/ethereumjs/ethereumjs-vm [8] http://web3js.readthedocs.io/en/1.0/index.html 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/09/21/29d0e1a1a1c23a1cfdfacfecb4c3100e.html","headline":"如何编写智能合约（Smart Contract）？（II）建立加密代币","dateModified":"2017-09-21T00:00:00+08:00","datePublished":"2017-09-21T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/09/21/29d0e1a1a1c23a1cfdfacfecb4c3100e.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>如何编写智能合约（Smart Contract）？（II）建立加密代币</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h1 id="如何编写智能合约smart-contractii建立加密代币">如何编写智能合约（Smart Contract）？（II）建立加密代币</h1> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/%E9%BB%8E%E8%B7%83%E6%98%A5-%E4%B8%AA%E4%BA%BA%E7%AE%80%E4%BB%8B-13331184066.png" alt="" title=""></p> 
  <p>接着上一篇<a href="http://liyuechun.org/2017/09/19/how-to-code-smart-contract/" rel="nofollow" target="_blank">如何编写智能合约（Smart Contract）？</a>，本篇文章，我们将写一个简单的加密代币的智能合约来给大家诠释加密代币的原理，当然这篇文章只是告诉你加密代币的原理，存在很多漏洞，不能直接使用。</p> 
  <h2 id="启动testrpc">启动testrpc</h2> 
  <p>打开终端，启动<code>testrpc</code>，相关环境在<a href="http://liyuechun.org/2017/09/19/how-to-code-smart-contract/" rel="nofollow" target="_blank">如何编写智能合约（Smart Contract）？</a>这篇文章里面已经有具体说明。</p> 
  <pre class="prettyprint"><code class=" hljs r">liyuechun:~ yuechunli$ testrpc
EthereumJS TestRPC v4.1.3 (ganache-core: <span class="hljs-number">1.1</span><span class="hljs-number">.3</span>)
<span class="hljs-keyword">...</span></code></pre> 
  <p>接下来我们就可以一步步的创建我们的加密代币项目了。</p> 
  <h2 id="代币合约的基本概念">代币合约的基本概念</h2> 
  <p>代币合约扮演的角色相当于银行的角色。使用者在代币合约中，用自己的<code>以太币帐户地址</code>当作银行帐户，可以透过代币合约执行转账（<code>transfer</code>，将代币由一个帐户转到另一个帐户），查询余额（<code>balanceOf</code>，查询指定帐户中拥有的代币）等原本由银行负责的工作。因为合约部署在公开区块链上，所有的交易都是公开透明，可供检验的。</p> 
  <h2 id="创建代币合约项目">创建代币合约项目</h2> 
  <pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">liyuechun:</span>EncryptedToken yuechunli$ pwd
/Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken
<span class="hljs-label">liyuechun:</span>EncryptedToken yuechunli$ truffle init
Downloading project...
Project initialized.

  Documentation: http://truffleframework<span class="hljs-preprocessor">.com</span>/docs

<span class="hljs-label">Commands:</span>

  Compile: truffle compile
  Migrate: truffle migrate
  Test:    truffle test

<span class="hljs-label">liyuechun:</span>EncryptedToken yuechunli$ </code></pre> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/Snip20170920_1.png" alt="" title=""></p> 
  <h2 id="新建代币合约">新建代币合约</h2> 
  <p>终端执行<code>truffle create contract EncryptedToken</code>命令创建<code>EncryptedToken.sol</code>合约。</p> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/create%20contract%20EncryptedToken.gif" alt="" title=""></p> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/Snip20170920_2.png" alt="" title=""></p> 
  <h2 id="编写合约代码">编写合约代码</h2> 
  <p>将下面的合约代码拷贝，替换<code>EncryptedToken.sol</code>文件的代码。</p> 
  <pre class="prettyprint"><code class=" hljs php">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.4</span>;

contract EncryptedToken {
  uint256 INITIAL_SUPPLY = <span class="hljs-number">666666</span>;
  mapping(address =&gt; uint256) balances;
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">EncryptedToken</span><span class="hljs-params">()</span> {</span>
    balances[msg.sender] = INITIAL_SUPPLY;
  }
  <span class="hljs-comment">// 转账到一个指定的地址</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span><span class="hljs-params">(address _to, uint256 _amount)</span> {</span>
    assert(balances[msg.sender] &lt; _amount);
    balances[msg.sender] -= _amount;
    balances[_to] += _amount;
  }
  <span class="hljs-comment">// 查看指定地址的余额</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">balanceOf</span><span class="hljs-params">(address _owner)</span> <span class="hljs-title">constant</span> <span class="hljs-title">returns</span> <span class="hljs-params">(uint256)</span> {</span>
    <span class="hljs-keyword">return</span> balances[_owner];
  }
}</code></pre> 
  <p><code>pragma solidity ^0.4.4</code>中的<code>0.4.4</code>代表<code>solidity</code>的版本，<code>^</code>代表<code>0.4.4 ~ 0.4.9</code>之间的<code>solidity</code>都可以正常编译当前版本的合约。</p> 
  <p><code>contract</code>相当于其他语言中的<code>class</code>，<code>EncryptedToken</code>相当于<code>类</code>的名字。<code>contract EncryptedToken</code>可以理解为<code>class EncryptedToken extends Contract</code>。</p> 
  <p><code>uint256 INITIAL_SUPPLY = 666666</code>声明了一个变量<code>INITIAL_SUPPLY</code>，初始化存储了一个<code>666666</code>的整数作为部署当前合约的钱包地址的代币数。</p> 
  <p><code>mapping(address =&gt; uint256) balances;</code>，<code>balances</code>是一个<code>key</code>类型为<code>address</code>，<code>value</code>类型为<code>uint256</code>的键值对(mapping)，相当于Java中的<code>map</code>、iOS中的<code>NSDictionary</code>。</p> 
  <p><code>function EncryptedToken()</code>函数是<code>EncryptedToken</code>合约的构造函数(contructor)，当<code>EncryptedToken</code>合约调用时，会先执行它的构造函数。</p> 
  <p>在构造函数中，会以当前部署合约的钱包地址为<code>key</code>，以<code>INITIAL_SUPPLY</code>为<code>value</code>初始化一个键值对。</p> 
  <pre class="prettyprint"><code class=" hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transfer</span><span class="hljs-params">(address _to, uint256 _amount)</span></span> {
    <span class="hljs-built_in">assert</span>(balances[msg.sender] &lt; _amount);
    balances[msg.sender] -= _amount;
    balances[_to] += _amount;
}</code></pre> 
  <p><code>transfer</code>函数是声明用来从转账到指定钱包地址的函数，<code>_to</code>代表转账的目的地地址，<code>_amount</code>代表转账金额。</p> 
  <p><code>assert(balances[msg.sender] &lt; _amount)</code>，这句代码中，我声明了一个断言，当<code>balances[msg.sender] &lt; _amount</code>，即当前钱包余额小于要转账的额度时，就会抛出异常。</p> 
  <p><code>balances[msg.sender] -= _amount;</code>从当前钱包额度中减去<code>_amount</code>。</p> 
  <p><code>balances[_to] += _amount;</code>，将目标地址的额度增加<code>_amount</code>。</p> 
  <pre class="prettyprint"><code class=" hljs javascript"> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">balanceOf</span><span class="hljs-params">(address _owner)</span> <span class="hljs-title">constant</span> <span class="hljs-title">returns</span> <span class="hljs-params">(uint256)</span> {</span>

    <span class="hljs-keyword">return</span> balances[_owner];
 }</code></pre> 
  <p><code>balanceOf(address _owner)</code>函数是用来查询指定钱包地址的余额，<code>_owner</code>即是指定的钱包地址，<code>returns (uint256)</code>代表返回值的类型为<code>uint256</code>，<code>constant</code>关键字的作用是，当我们调用<code>balanceOf</code>函数时，它会自动调用<code>call()</code>方法，表明只是读书数据，而不需要往区块链写入数据，调用这个方法，不需要花费手续费。</p> 
  <h2 id="编译与部署">编译与部署</h2> 
  <p>在<code>migrations/</code>目录下创建一个名字叫做<code>3_deploy_contract.js</code>的文件。文件中的内容为：</p> 
  <pre class="prettyprint"><code class=" hljs lua">var EncryptedToken = artifacts.<span class="hljs-built_in">require</span>(<span class="hljs-string">'./EncryptedToken.sol'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deployer)</span></span> {
  deployer.deploy(EncryptedToken);
}</code></pre> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/Snip20170920_7.png" alt="" title=""></p> 
  <p>接下来执行<code>compile</code>和<code>migrate</code>命令：</p> 
  <pre class="prettyprint"><code class=" hljs r">liyuechun:EncryptedToken yuechunli$ truffle compile
Compiling ./contracts/ConvertLib.sol...
Compiling ./contracts/EncryptedToken.sol...
Compiling ./contracts/MetaCoin.sol...
Compiling ./contracts/Migrations.sol...
Writing artifacts to ./build/contracts

liyuechun:EncryptedToken yuechunli$ truffle migrate
Using network <span class="hljs-string">'development'</span>.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x8b31575b8ac09efae7bdf933823fcf91885b4e1c93b4d9b37421d22ab73cef25</span>
  Migrations: <span class="hljs-number">0x9b34fffa8e0d2e6d09f59ee289db13e0662b68fe</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x45ba02af03a7e94f66bebbb72eebf547ffe128a49f01437aca6b45c2f489b0a1</span>
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying ConvertLib...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0xae9c5fd334d8925b027d8de3ca9aeb13e2bd1d2d3b95b49ef3c7b472446d73ae</span>
  ConvertLib: <span class="hljs-number">0x3f7fff3afe38a0a152806a0f4f416e52a338829f</span>
  Linking ConvertLib to MetaCoin
  Deploying MetaCoin...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x8da8a4c881eb9bb62a1477db13044ce84707aac0df54f7ab1baf8b7f0904d251</span>
  MetaCoin: <span class="hljs-number">0x7b9cc3ebba27a1ef8dda0b1825ae47369d647739</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x319cebe2651f0dfbb4adb0a187745a6d47bde22243e4cb32346790ea9abbc5c8</span>
Saving artifacts...
Running migration: 3_deploy_contract.js
  Deploying EncryptedToken...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x5e6203aaf1280bac1f991cb3d2858342d9287c0970da8068eeae657b54022cab</span>
  EncryptedToken: <span class="hljs-number">0x16685fb5d7e88293fc1c79a0428f3ab9d2165384</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x713227a22cafea3ff1fa3bd35ff38cb367d9c8dbdc698124053f72020d37bf28</span>
Saving artifacts...
liyuechun:EncryptedToken yuechunli$ </code></pre> 
  <p>如上所示，我们已经将<code>EncryptedToken</code>代币合约部署到了<code>testrpc</code>上。</p> 
  <h2 id="合约验证">合约验证</h2> 
  <p>合约部署完成后，我们通过<code>truffle console</code>开启<code>console</code>控制台，在这个控制台中对已经部署的合约进行验证。</p> 
  <pre class="prettyprint"><code class=" hljs erlang">liyuechun:<span class="hljs-variable">EncryptedToken</span> yuechunli$ truffle console
<span class="hljs-function"><span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">coinbase</span> <span class="hljs-title">'0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[0] <span class="hljs-title">'0x38ae16e70a31ba8679cdcac1cac6ffda7226f2d1'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[1] <span class="hljs-title">'0xedbbf7b06f3f35fd32ab8157e6cd4ced257451e8'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[2] <span class="hljs-title">'0xfdb73d8ed20f7e9981264be7639346e57db28698'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[3] <span class="hljs-title">'0x77f0688b69c236f0fb9264a9daf8ca06952f278f'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[4] <span class="hljs-title">'0x4f1ed5c8c87fad9c37ab509203026d041e00417b'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[5] <span class="hljs-title">'0xdead10c6c02ef4121e0d2f63d979daa3b9a692be'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[6] <span class="hljs-title">'0xf265663d195078f445a08966a660fbffff421d20'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[7] <span class="hljs-title">'0x1d822a897b9ca697ee03766b3d13a5a0c7235b78'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[8] <span class="hljs-title">'0xafcc21dc7a09c8e23532aba4c8cc64b1b7831892'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; <span class="hljs-title">web3</span>.<span class="hljs-title">eth</span>.<span class="hljs-title">accounts</span>[9] <span class="hljs-title">'0x4693ab1bc520ac1314e77077645b7ee15f7510ce'</span> <span class="hljs-title">truffle</span><span class="hljs-params">(development)</span>&gt; </span></code></pre> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/Snip20170920_8.png" alt="" title=""></p> 
  <p>在<code>testrpc</code>启动时，系统会给我们分配10个钱包地址，如上图所示我们可以通过<code>web3.eth.coinbase</code>或者<code>web3.eth.accounts[0]</code>获取首个钱包地址，当然也可以根据索引获取其他的钱包地址。</p> 
  <p>接下来声明一个合约变量存储<code>EncryptedToken</code>合约实例。</p> 
  <pre class="prettyprint"><code class=" hljs haskell"><span class="hljs-title">truffle</span>(development)&gt; <span class="hljs-keyword">let</span> contract;
<span class="hljs-title">undefined</span>
<span class="hljs-title">truffle</span>(development)&gt; <span class="hljs-type">EncryptedToken</span>.deployed().<span class="hljs-keyword">then</span>(<span class="hljs-keyword">instance</span> =&gt; contract = <span class="hljs-keyword">instance</span>)
.....
<span class="hljs-title">truffle</span>(development)&gt; </code></pre> 
  <p>验证<code>web3.eth.coinbase</code>和<code>web3.eth.accounts[1]</code>中的余额。</p> 
  <pre class="prettyprint"><code class=" hljs css"><span class="hljs-tag">truffle</span>(<span class="hljs-tag">development</span>)&gt; <span class="hljs-tag">contract</span><span class="hljs-class">.balanceOf</span>(<span class="hljs-tag">web3</span><span class="hljs-class">.eth</span><span class="hljs-class">.coinbase</span>)
<span class="hljs-rules">{ <span class="hljs-rule">[<span class="hljs-attribute">String</span>:<span class="hljs-value"> <span class="hljs-string">'666666'</span>] s: <span class="hljs-number">1</span>, e: <span class="hljs-number">5</span>, c: [ <span class="hljs-number">666666</span> ] </span></span></span>}
<span class="hljs-tag">truffle</span>(<span class="hljs-tag">development</span>)&gt; <span class="hljs-tag">contract</span><span class="hljs-class">.balanceOf</span>(<span class="hljs-tag">web3</span><span class="hljs-class">.eth</span><span class="hljs-class">.accounts</span><span class="hljs-attr_selector">[1]</span>)
<span class="hljs-rules">{ <span class="hljs-rule">[<span class="hljs-attribute">String</span>:<span class="hljs-value"> <span class="hljs-string">'0'</span>] s: <span class="hljs-number">1</span>, e: <span class="hljs-number">0</span>, c: [ <span class="hljs-number">0</span> ] </span></span></span>}
<span class="hljs-tag">truffle</span>(<span class="hljs-tag">development</span>)&gt; </code></pre> 
  <p>经验证，第0个钱包地址中的代币余额为<code>666666</code>，第1个钱包地址中的代币余额为<code>0</code>。</p> 
  <p>下一步，我们将从第0个账号中向第1个账号转账<code>666</code>个代币。</p> 
  <pre class="prettyprint"><code class=" hljs avrasm">truffle(development)&gt; contract<span class="hljs-preprocessor">.transfer</span>(web3<span class="hljs-preprocessor">.eth</span><span class="hljs-preprocessor">.accounts</span>[<span class="hljs-number">1</span>], <span class="hljs-number">666</span>)
<span class="hljs-label">Error:</span> VM Exception while processing transaction: invalid opcode
    at Object<span class="hljs-preprocessor">.InvalidResponse</span> (/usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">37295</span>:<span class="hljs-number">16</span>)
    at /usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">224765</span>:<span class="hljs-number">36</span>
    at /usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">208348</span>:<span class="hljs-number">9</span>
    at XMLHttpRequest<span class="hljs-preprocessor">.request</span><span class="hljs-preprocessor">.onreadystatechange</span> (/usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">209773</span>:<span class="hljs-number">13</span>)
    at XMLHttpRequestEventTarget<span class="hljs-preprocessor">.dispatchEvent</span> (/usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">67130</span>:<span class="hljs-number">18</span>)
    at XMLHttpRequest._setReadyState (/usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">67420</span>:<span class="hljs-number">12</span>)
    at XMLHttpRequest._onHttpResponseEnd (/usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">67575</span>:<span class="hljs-number">12</span>)
    at IncomingMessage.&lt;anonymous&gt; (/usr/local/lib/node_modules/truffle/build/<span class="hljs-keyword">cli</span><span class="hljs-preprocessor">.bundled</span><span class="hljs-preprocessor">.js</span>:<span class="hljs-number">67535</span>:<span class="hljs-number">24</span>)
    at emitNone (events<span class="hljs-preprocessor">.js</span>:<span class="hljs-number">110</span>:<span class="hljs-number">20</span>)
    at IncomingMessage<span class="hljs-preprocessor">.emit</span> (events<span class="hljs-preprocessor">.js</span>:<span class="hljs-number">207</span>:<span class="hljs-number">7</span>)
truffle(development)&gt; </code></pre> 
  <p>如上所示，转账过程中出现了异常，转账失败，仔细检查一下，不难发现是因为在我们合约代码<code>EncryptedToken.sol</code>中有这么一句代码<code>assert(balances[msg.sender] &lt; _amount);</code>，也就是说只有当<code>balances[msg.sender]</code>小于<code>_amount</code>时，才不会出现异常，所以我们应该将<code>&lt;</code>符号换成<code>&gt;</code>符号，即当<code>balances[msg.sender]</code>余额不足时抛出异常。</p> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/Snip20170920_11.png" alt="" title=""></p> 
  <p>代码修改后，需要重新编译，部署。</p> 
  <pre class="prettyprint"><code class=" hljs r">liyuechun:EncryptedToken yuechunli$ pwd
/Users/liyuechun/Desktop/SmartContractDemo/EncryptedToken
liyuechun:EncryptedToken yuechunli$ ls
build       contracts   migrations  test        truffle.js
liyuechun:EncryptedToken yuechunli$ rm -rf build/
liyuechun:EncryptedToken yuechunli$ ls
contracts   migrations  test        truffle.js
liyuechun:EncryptedToken yuechunli$ truffle compile
Compiling ./contracts/ConvertLib.sol...
Compiling ./contracts/EncryptedToken.sol...
Compiling ./contracts/MetaCoin.sol...
Compiling ./contracts/Migrations.sol...
Writing artifacts to ./build/contracts

liyuechun:EncryptedToken yuechunli$ truffle migrate --reset
Using network <span class="hljs-string">'development'</span>.

Running migration: 1_initial_migration.js
  Deploying Migrations...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x04c008d8e7008afa1ace7c0dc294eb2e5b02a94960e559811d12187c53b07e56</span>
  Migrations: <span class="hljs-number">0x192929621fd7cf4dd2ac72b42c5f52b40ccfa999</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0xd4c65a206e68caab63957343e59282f7a34d92b0f1e1ac99cf77c127d014f958</span>
Saving artifacts...
Running migration: 2_deploy_contracts.js
  Deploying ConvertLib...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x4d9e476d05e1b7aea3764c0fd44799ce984d04006435d2959a87b97f62ee2c5a</span>
  ConvertLib: <span class="hljs-number">0xdf7dc01c43772881f21f857f2d689ea591a66a20</span>
  Linking ConvertLib to MetaCoin
  Deploying MetaCoin...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0xe4ef8fc746d9772a964d8137af4c14eab4c03a7071e1b1b1f27ec963a28558b0</span>
  MetaCoin: <span class="hljs-number">0x685a10d1a8d5196e20a8ae31e0fe80f122e4dd47</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0xdd3a300b3f22997540ae019f31f0de4b6b8117cf1dcbc61ed5c2b25bb8011e7c</span>
Saving artifacts...
Running migration: 3_deploy_contract.js
  Deploying EncryptedToken...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x08ff437889f6bca7650550491937ed078d09bbbec5a2986146824ba7b7bd0e27</span>
  EncryptedToken: <span class="hljs-number">0xe4de630b2c2818dc18a1ac16935a945634c33a03</span>
Saving successful migration to network...
  <span class="hljs-keyword">...</span> <span class="hljs-number">0x6eadbc688aca46b34d11696ceca3564ded694dec772412ecf3da4cb6310f7d23</span>
Saving artifacts...
liyuechun:EncryptedToken yuechunli$ </code></pre> 
  <p><strong>备注</strong>：编译时，一定要先将<code>build</code>文件夹删除，其次在部署合约时，一定要添加<code>--reset</code>，否则修改后的合约没法部署成功。</p> 
  <p>打开控制台，按照如下操作进行验证。</p> 
  <pre class="prettyprint"><code class=" hljs javascript">liyuechun:EncryptedToken yuechunli$ truffle console
truffle(development)&gt; <span class="hljs-keyword">let</span> contract
<span class="hljs-literal">undefined</span>
truffle(development)&gt; EncryptedToken.deployed().then(instance =&gt; contract = instance)
truffle(development)&gt; contract.balanceOf(web3.eth.coinbase)
{ [<span class="hljs-built_in">String</span>: <span class="hljs-string">'666666'</span>] s: <span class="hljs-number">1</span>, e: <span class="hljs-number">5</span>, c: [ <span class="hljs-number">666666</span> ] }
truffle(development)&gt; contract.balanceOf(web3.eth.accounts[<span class="hljs-number">1</span>])
{ [<span class="hljs-built_in">String</span>: <span class="hljs-string">'0'</span>] s: <span class="hljs-number">1</span>, e: <span class="hljs-number">0</span>, c: [ <span class="hljs-number">0</span> ] }
truffle(development)&gt; contract.transfer(web3.eth.accounts[<span class="hljs-number">1</span>], <span class="hljs-number">666</span>)
{ tx: <span class="hljs-string">'0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d'</span>,
  receipt: 
   { transactionHash: <span class="hljs-string">'0x93a38d9c86520cdd5c033511bb67f4aa5230811acf8eb6a703d907d31a4d044d'</span>,
     transactionIndex: <span class="hljs-number">0</span>,
     blockHash: <span class="hljs-string">'0xe02e7c9859d43e398bf0ece48e3a15510bb76beefa9bd48ce46a39022ccf5a43'</span>,
     blockNumber: <span class="hljs-number">31</span>,
     gasUsed: <span class="hljs-number">48952</span>,
     cumulativeGasUsed: <span class="hljs-number">48952</span>,
     contractAddress: <span class="hljs-literal">null</span>,
     logs: [] },
  logs: [] }
truffle(development)&gt; contract.balanceOf(web3.eth.coinbase)
{ [<span class="hljs-built_in">String</span>: <span class="hljs-string">'666000'</span>] s: <span class="hljs-number">1</span>, e: <span class="hljs-number">5</span>, c: [ <span class="hljs-number">666000</span> ] }
truffle(development)&gt; contract.balanceOf(web3.eth.accounts[<span class="hljs-number">1</span>])
{ [<span class="hljs-built_in">String</span>: <span class="hljs-string">'666'</span>] s: <span class="hljs-number">1</span>, e: <span class="hljs-number">2</span>, c: [ <span class="hljs-number">666</span> ] }
truffle(development)&gt; </code></pre> 
  <p>如上所示，代币转账成功。</p> 
  <h2 id="总结">总结</h2> 
  <p>在这篇文章中，只是简单介绍了代币系统的逻辑，并没有对安全进行相关操作，比如：余额不够的处理、地址合不合法的处理等等。当然，通过这篇文章的学习，你再回头看我们初始项目中的<code>MetaCoin</code>代码时，你就应该能看懂了。</p> 
  <h2 id="打赏地址">打赏地址</h2> 
  <p>**比特币：**1FcbBw62FHBJKTiLGNoguSwkBdVnJQ9NUn <br> **以太坊：**0xF055775eBD516e7419ae486C1d50C682d4170645</p> 
  <h2 id="技术交流">技术交流</h2> 
  <ul> 
   <li><p>区块链技术交流QQ群：348924182</p></li> 
   <li><p>「区块链部落」官方公众号</p></li> 
  </ul> 
  <p><img src="http://om1c35wrq.bkt.clouddn.com/%E5%8C%BA%E5%9D%97%E9%93%BE%E9%83%A8%E8%90%BD.png" alt="" title=""></p> 
  <h2 id="参考资料">参考资料</h2> 
  <ul> 
   <li>[1] <a href="http://solidity.readthedocs.io/en/latest/index.html" rel="nofollow">http://solidity.readthedocs.io/en/latest/index.html</a></li> 
   <li>[2] <a href="https://ethereum.github.io/browser-solidity/" rel="nofollow">https://ethereum.github.io/browser-solidity/</a></li> 
   <li>[3] <a href="http://truffleframework.com/" rel="nofollow">http://truffleframework.com/</a></li> 
   <li>[4] <a href="https://github.com/iurimatias/embark-framework" rel="nofollow">https://github.com/iurimatias/embark-framework</a></li> 
   <li>[5] <a href="https://github.com/ethereum/ens" rel="nofollow">https://github.com/ethereum/ens</a></li> 
   <li>[6] <a href="https://github.com/ethereumjs/testrpc" rel="nofollow">https://github.com/ethereumjs/testrpc</a></li> 
   <li>[7] <a href="https://github.com/ethereumjs/ethereumjs-vm" rel="nofollow">https://github.com/ethereumjs/ethereumjs-vm</a></li> 
   <li>[8] <a href="http://web3js.readthedocs.io/en/1.0/index.html" rel="nofollow">http://web3js.readthedocs.io/en/1.0/index.html</a></li> 
  </ul> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/liyuechun520/article/details/78049950,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/liyuechun520/article/details/78049950,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
