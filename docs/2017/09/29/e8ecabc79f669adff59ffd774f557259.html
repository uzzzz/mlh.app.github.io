<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>ASP.NET Core 2.0 使用支付宝PC网站支付 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="ASP.NET Core 2.0 使用支付宝PC网站支付" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="前言 最近在使用ASP.NET Core来进行开发，刚好有个接入支付宝支付的需求，百度了一下没找到相关的资料，看了官方的SDK以及Demo都还是.NET Framework的，所以就先根据官方SDK的源码，用.NET Standard 2.0 实现了支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET CORE 2.0。为了使用方便，已上传至Nuget可以直接使用。 支付宝有比较多的支付产品，比如当面付、APP支付、手机网站支付、电脑网站支付等，本次将的是电脑网站支付。 如果你没有时间阅读文章，可以直接从github获取Demo原来进行查看，非常简单。github:&nbsp;https://github.com/stulzq/Alipay.Demo.PCPayment 创建项目 新建一个ASP.NET Core 2.0 MVC项目 配置 由于我在开发的时候支付接口并没有申请下来，所以使用的是支付宝沙箱环境来进行开发的。 支付宝沙箱环境介绍：蚂蚁沙箱环境(Beta)是协助开发者进行接口功能开发及主要功能联调的辅助环境。沙箱环境模拟了开放平台部分产品的主要功能和主要逻辑，在开发者应用上线审核前，开发者可以根据自身需求，先在沙箱环境中了解、组合和调试各种开放接口，进行开发调通工作，从而帮助开发者在应用上线审核完成后，能更快速、更顺利的进行线上调试和验收工作。 如果在签约或创建应用前想要进行集成测试，可以使用沙箱环境。 沙箱环境支持使用个人账号或企业账号登陆。 沙箱环境地址：https://openhome.alipay.com/platform/appDaily.htm?tab=info 1.生成密钥 下载支付宝官方提供的密钥生成工具来进行生成，详细介绍：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1 2.设置应用公钥 我们生成密钥之后，需要到支付宝后台设置应用公钥，就是我们生成的公钥。 设置之后，支付宝会给我们一个支付宝公钥，保存这个支付宝公钥 这个支付宝公钥和我们自己生成的公钥是不一样的，我们在配置SDK时用的公钥就是支付宝公钥 3.配置SDK 新建一个Config类，在里面存储我们的配置。 public class Config{ &nbsp; &nbsp;// 应用ID,您的APPID &nbsp; &nbsp;public static string AppId = &quot;&quot;; &nbsp; &nbsp;// 支付宝网关 &nbsp; &nbsp;public static string Gatewayurl = &quot;&quot;; &nbsp; &nbsp;// 商户私钥，您的原始格式RSA私钥 &nbsp; &nbsp;public static string PrivateKey = &quot;&quot;; &nbsp; &nbsp;// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。 &nbsp; &nbsp;public static string AlipayPublicKey = &quot;&quot;; &nbsp; &nbsp;// 签名方式 &nbsp; &nbsp;public static string SignType = &quot;RSA2&quot;; &nbsp; &nbsp;// 编码格式 &nbsp; &nbsp;public static string CharSet = &quot;UTF-8&quot;; } 应用ID和支付宝网关都可以在支付宝后台查看。 商户私钥即我们自己生成的私钥，公钥就是支付宝公钥这里一定要注意，别用错了。这里的公钥私钥直接填写字符串即可。 签名方式推荐使用RSA2，使用RSA2，支付宝会用SHA256withRsa算法进行接口调用时的验签（不限制密钥长度）。 编码格式，如果我们是直接配置的字符串（公钥、私钥），那么就是我们代码的编码，如果使用的是文件（公钥、私钥），那么就是文件的编码。 完成配置如下： 添加SDK 官方SDK的源码（.NET Framework），用.NET Standard 2.0 实现的支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET Core 2.0。 通过Nuget安装：Install-Package Alipay.AopSdk.Core 支付 添加一个控制器&nbsp;PayController /// 发起支付请求/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;外部订单号，商户网站订单系统中唯一的订单号&lt;/param&gt;/// &lt;param name=&quot;subject&quot;&gt;订单名称&lt;/param&gt;/// &lt;param name=&quot;totalAmout&quot;&gt;付款金额&lt;/param&gt;/// &lt;param name=&quot;itemBody&quot;&gt;商品描述&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public void PayRequest(string tradeno,string subject,string totalAmout,string itemBody){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;// 组装业务参数model &nbsp; &nbsp;AlipayTradePagePayModel model = new AlipayTradePagePayModel(); &nbsp; &nbsp;model.Body = itemBody; &nbsp; &nbsp;model.Subject = subject; &nbsp; &nbsp;model.TotalAmount = totalAmout; &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.ProductCode = &quot;FAST_INSTANT_TRADE_PAY&quot;; &nbsp; &nbsp;AlipayTradePagePayRequest request = new AlipayTradePagePayRequest(); &nbsp; &nbsp;// 设置同步回调地址 &nbsp; &nbsp;request.SetReturnUrl(&quot;http://localhost:5000/Pay/Callback&quot;); &nbsp; &nbsp;// 设置异步通知接收地址 &nbsp; &nbsp;request.SetNotifyUrl(&quot;&quot;); &nbsp; &nbsp;// 将业务model载入到request &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.SdkExecute(request); &nbsp; &nbsp;Console.WriteLine($&quot;订单支付发起成功，订单号：{tradeno}&quot;); &nbsp; &nbsp;//跳转支付宝支付 &nbsp; &nbsp;Response.Redirect(Config.Gatewayurl + &quot;?&quot; + response.Body); } 运行： 图1 图2 图3 支付异步回调通知 支付宝同步回调通知（支付成功后跳转到商户网站），是不可靠的，所以这里必须使用异步通知来获取支付结果，异步通知即支付宝主动请求我们提供的地址，我们根据请求数据来校验，获取支付结果。 /// &lt;summary&gt;/// 支付异步回调通知 需配置域名 因为是支付宝主动post请求这个action 所以要通过域名访问或者公网ip/// &lt;/summary&gt;public async void Notify(){ &nbsp; &nbsp;/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/ &nbsp; &nbsp;Dictionary&lt;string, string&gt; sArray = GetRequestPost(); &nbsp; &nbsp;if (sArray.Count != 0) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;bool flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey,Config.CharSet, Config.SignType, false); &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;if (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//交易状态 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//判断该笔订单是否在商户网站中已经做过处理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//请务必判断请求时的total_amount与通知时获取的total_fee为一致的 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//如果有做过处理，不执行商户的业务程序 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//注意： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(Request.Form[&quot;trade_status&quot;]); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;await Response.WriteAsync(&quot;success&quot;); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;await Response.WriteAsync(&quot;fail&quot;); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} } 同步回调 同步回调即支付成功跳转回商户网站 运行： /// &lt;summary&gt;/// 支付同步回调/// &lt;/summary&gt;[HttpGet]public &nbsp;IActionResult Callback(){ &nbsp; &nbsp;/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/ &nbsp; &nbsp;Dictionary&lt;string, string&gt; sArray = GetRequestGet(); &nbsp; &nbsp;&nbsp;if (sArray.Count != 0) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;bool flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey, Config.CharSet, Config.SignType, false); &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;if (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($&quot;同步验证通过，订单号：{sArray[&quot;out_trade_no&quot;]}&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[&quot;PayResult&quot;] = &quot;同步验证通过&quot;; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($&quot;同步验证失败，订单号：{sArray[&quot;out_trade_no&quot;]}&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[&quot;PayResult&quot;] = &quot;同步验证失败&quot;; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp; &nbsp;return View(); } 订单查询 查询订单当前状态：已付款、未付款等等。 运行： [HttpPost]public JsonResult Query(string tradeno, string alipayTradeNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeQueryModel model = new AlipayTradeQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeQueryRequest request = new AlipayTradeQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 订单退款 退回该订单金额。 运行： /// &lt;summary&gt;/// 订单退款/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;param name=&quot;refundAmount&quot;&gt;退款金额&lt;/param&gt;/// &lt;param name=&quot;refundReason&quot;&gt;退款原因&lt;/param&gt;/// &lt;param name=&quot;refundNo&quot;&gt;退款单号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult Refund(string tradeno,string alipayTradeNo,string refundAmount,string refundReason,string refundNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeRefundModel model = new AlipayTradeRefundModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.RefundAmount = refundAmount; &nbsp; &nbsp;model.RefundReason = refundReason; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeRefundRequest request = new AlipayTradeRefundRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 退款查询 查询退款信息。 运行： /// &lt;summary&gt;/// 退款查询/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;param name=&quot;refundNo&quot;&gt;退款单号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult RefundQuery(string tradeno,string alipayTradeNo,string refundNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;if (string.IsNullOrEmpty(refundNo)) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;refundNo = tradeno; &nbsp; &nbsp;} &nbsp; &nbsp;AlipayTradeFastpayRefundQueryModel model = new AlipayTradeFastpayRefundQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeFastpayRefundQueryRequest request = new AlipayTradeFastpayRefundQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 订单关闭 对一定时间以后没有进行付款的订单进行关闭，订单状态需为：待付款，已完成支付的订单无法关闭。 运行： /// &lt;summary&gt;/// 关闭订单/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult OrderClose(string tradeno, string alipayTradeNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeCloseModel model = new AlipayTradeCloseModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeCloseRequest request = new AlipayTradeCloseRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 地址集合 支付宝API文档 支付宝沙箱环境 支付宝密钥生成工具 支付宝服务端SDK源码 支付宝服务端SDK Nuget 最重要的： 本文Demo：https://github.com/stulzq/Alipay.Demo.PCPayment 原文地址：http://www.cnblogs.com/stulzq/p/7606164.html .NET社区新闻，深度好文，微信中搜索dotNET跨平台或扫描二维码关注 阅读更多" />
<meta property="og:description" content="前言 最近在使用ASP.NET Core来进行开发，刚好有个接入支付宝支付的需求，百度了一下没找到相关的资料，看了官方的SDK以及Demo都还是.NET Framework的，所以就先根据官方SDK的源码，用.NET Standard 2.0 实现了支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET CORE 2.0。为了使用方便，已上传至Nuget可以直接使用。 支付宝有比较多的支付产品，比如当面付、APP支付、手机网站支付、电脑网站支付等，本次将的是电脑网站支付。 如果你没有时间阅读文章，可以直接从github获取Demo原来进行查看，非常简单。github:&nbsp;https://github.com/stulzq/Alipay.Demo.PCPayment 创建项目 新建一个ASP.NET Core 2.0 MVC项目 配置 由于我在开发的时候支付接口并没有申请下来，所以使用的是支付宝沙箱环境来进行开发的。 支付宝沙箱环境介绍：蚂蚁沙箱环境(Beta)是协助开发者进行接口功能开发及主要功能联调的辅助环境。沙箱环境模拟了开放平台部分产品的主要功能和主要逻辑，在开发者应用上线审核前，开发者可以根据自身需求，先在沙箱环境中了解、组合和调试各种开放接口，进行开发调通工作，从而帮助开发者在应用上线审核完成后，能更快速、更顺利的进行线上调试和验收工作。 如果在签约或创建应用前想要进行集成测试，可以使用沙箱环境。 沙箱环境支持使用个人账号或企业账号登陆。 沙箱环境地址：https://openhome.alipay.com/platform/appDaily.htm?tab=info 1.生成密钥 下载支付宝官方提供的密钥生成工具来进行生成，详细介绍：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1 2.设置应用公钥 我们生成密钥之后，需要到支付宝后台设置应用公钥，就是我们生成的公钥。 设置之后，支付宝会给我们一个支付宝公钥，保存这个支付宝公钥 这个支付宝公钥和我们自己生成的公钥是不一样的，我们在配置SDK时用的公钥就是支付宝公钥 3.配置SDK 新建一个Config类，在里面存储我们的配置。 public class Config{ &nbsp; &nbsp;// 应用ID,您的APPID &nbsp; &nbsp;public static string AppId = &quot;&quot;; &nbsp; &nbsp;// 支付宝网关 &nbsp; &nbsp;public static string Gatewayurl = &quot;&quot;; &nbsp; &nbsp;// 商户私钥，您的原始格式RSA私钥 &nbsp; &nbsp;public static string PrivateKey = &quot;&quot;; &nbsp; &nbsp;// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。 &nbsp; &nbsp;public static string AlipayPublicKey = &quot;&quot;; &nbsp; &nbsp;// 签名方式 &nbsp; &nbsp;public static string SignType = &quot;RSA2&quot;; &nbsp; &nbsp;// 编码格式 &nbsp; &nbsp;public static string CharSet = &quot;UTF-8&quot;; } 应用ID和支付宝网关都可以在支付宝后台查看。 商户私钥即我们自己生成的私钥，公钥就是支付宝公钥这里一定要注意，别用错了。这里的公钥私钥直接填写字符串即可。 签名方式推荐使用RSA2，使用RSA2，支付宝会用SHA256withRsa算法进行接口调用时的验签（不限制密钥长度）。 编码格式，如果我们是直接配置的字符串（公钥、私钥），那么就是我们代码的编码，如果使用的是文件（公钥、私钥），那么就是文件的编码。 完成配置如下： 添加SDK 官方SDK的源码（.NET Framework），用.NET Standard 2.0 实现的支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET Core 2.0。 通过Nuget安装：Install-Package Alipay.AopSdk.Core 支付 添加一个控制器&nbsp;PayController /// 发起支付请求/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;外部订单号，商户网站订单系统中唯一的订单号&lt;/param&gt;/// &lt;param name=&quot;subject&quot;&gt;订单名称&lt;/param&gt;/// &lt;param name=&quot;totalAmout&quot;&gt;付款金额&lt;/param&gt;/// &lt;param name=&quot;itemBody&quot;&gt;商品描述&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public void PayRequest(string tradeno,string subject,string totalAmout,string itemBody){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;// 组装业务参数model &nbsp; &nbsp;AlipayTradePagePayModel model = new AlipayTradePagePayModel(); &nbsp; &nbsp;model.Body = itemBody; &nbsp; &nbsp;model.Subject = subject; &nbsp; &nbsp;model.TotalAmount = totalAmout; &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.ProductCode = &quot;FAST_INSTANT_TRADE_PAY&quot;; &nbsp; &nbsp;AlipayTradePagePayRequest request = new AlipayTradePagePayRequest(); &nbsp; &nbsp;// 设置同步回调地址 &nbsp; &nbsp;request.SetReturnUrl(&quot;http://localhost:5000/Pay/Callback&quot;); &nbsp; &nbsp;// 设置异步通知接收地址 &nbsp; &nbsp;request.SetNotifyUrl(&quot;&quot;); &nbsp; &nbsp;// 将业务model载入到request &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.SdkExecute(request); &nbsp; &nbsp;Console.WriteLine($&quot;订单支付发起成功，订单号：{tradeno}&quot;); &nbsp; &nbsp;//跳转支付宝支付 &nbsp; &nbsp;Response.Redirect(Config.Gatewayurl + &quot;?&quot; + response.Body); } 运行： 图1 图2 图3 支付异步回调通知 支付宝同步回调通知（支付成功后跳转到商户网站），是不可靠的，所以这里必须使用异步通知来获取支付结果，异步通知即支付宝主动请求我们提供的地址，我们根据请求数据来校验，获取支付结果。 /// &lt;summary&gt;/// 支付异步回调通知 需配置域名 因为是支付宝主动post请求这个action 所以要通过域名访问或者公网ip/// &lt;/summary&gt;public async void Notify(){ &nbsp; &nbsp;/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/ &nbsp; &nbsp;Dictionary&lt;string, string&gt; sArray = GetRequestPost(); &nbsp; &nbsp;if (sArray.Count != 0) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;bool flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey,Config.CharSet, Config.SignType, false); &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;if (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//交易状态 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//判断该笔订单是否在商户网站中已经做过处理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//请务必判断请求时的total_amount与通知时获取的total_fee为一致的 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//如果有做过处理，不执行商户的业务程序 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//注意： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(Request.Form[&quot;trade_status&quot;]); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;await Response.WriteAsync(&quot;success&quot;); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;await Response.WriteAsync(&quot;fail&quot;); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} } 同步回调 同步回调即支付成功跳转回商户网站 运行： /// &lt;summary&gt;/// 支付同步回调/// &lt;/summary&gt;[HttpGet]public &nbsp;IActionResult Callback(){ &nbsp; &nbsp;/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/ &nbsp; &nbsp;Dictionary&lt;string, string&gt; sArray = GetRequestGet(); &nbsp; &nbsp;&nbsp;if (sArray.Count != 0) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;bool flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey, Config.CharSet, Config.SignType, false); &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;if (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($&quot;同步验证通过，订单号：{sArray[&quot;out_trade_no&quot;]}&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[&quot;PayResult&quot;] = &quot;同步验证通过&quot;; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($&quot;同步验证失败，订单号：{sArray[&quot;out_trade_no&quot;]}&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[&quot;PayResult&quot;] = &quot;同步验证失败&quot;; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp; &nbsp;return View(); } 订单查询 查询订单当前状态：已付款、未付款等等。 运行： [HttpPost]public JsonResult Query(string tradeno, string alipayTradeNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeQueryModel model = new AlipayTradeQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeQueryRequest request = new AlipayTradeQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 订单退款 退回该订单金额。 运行： /// &lt;summary&gt;/// 订单退款/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;param name=&quot;refundAmount&quot;&gt;退款金额&lt;/param&gt;/// &lt;param name=&quot;refundReason&quot;&gt;退款原因&lt;/param&gt;/// &lt;param name=&quot;refundNo&quot;&gt;退款单号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult Refund(string tradeno,string alipayTradeNo,string refundAmount,string refundReason,string refundNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeRefundModel model = new AlipayTradeRefundModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.RefundAmount = refundAmount; &nbsp; &nbsp;model.RefundReason = refundReason; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeRefundRequest request = new AlipayTradeRefundRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 退款查询 查询退款信息。 运行： /// &lt;summary&gt;/// 退款查询/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;param name=&quot;refundNo&quot;&gt;退款单号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult RefundQuery(string tradeno,string alipayTradeNo,string refundNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;if (string.IsNullOrEmpty(refundNo)) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;refundNo = tradeno; &nbsp; &nbsp;} &nbsp; &nbsp;AlipayTradeFastpayRefundQueryModel model = new AlipayTradeFastpayRefundQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeFastpayRefundQueryRequest request = new AlipayTradeFastpayRefundQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 订单关闭 对一定时间以后没有进行付款的订单进行关闭，订单状态需为：待付款，已完成支付的订单无法关闭。 运行： /// &lt;summary&gt;/// 关闭订单/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult OrderClose(string tradeno, string alipayTradeNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeCloseModel model = new AlipayTradeCloseModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeCloseRequest request = new AlipayTradeCloseRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 地址集合 支付宝API文档 支付宝沙箱环境 支付宝密钥生成工具 支付宝服务端SDK源码 支付宝服务端SDK Nuget 最重要的： 本文Demo：https://github.com/stulzq/Alipay.Demo.PCPayment 原文地址：http://www.cnblogs.com/stulzq/p/7606164.html .NET社区新闻，深度好文，微信中搜索dotNET跨平台或扫描二维码关注 阅读更多" />
<link rel="canonical" href="https://mlh.app/2017/09/29/e8ecabc79f669adff59ffd774f557259.html" />
<meta property="og:url" content="https://mlh.app/2017/09/29/e8ecabc79f669adff59ffd774f557259.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-09-29T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"前言 最近在使用ASP.NET Core来进行开发，刚好有个接入支付宝支付的需求，百度了一下没找到相关的资料，看了官方的SDK以及Demo都还是.NET Framework的，所以就先根据官方SDK的源码，用.NET Standard 2.0 实现了支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET CORE 2.0。为了使用方便，已上传至Nuget可以直接使用。 支付宝有比较多的支付产品，比如当面付、APP支付、手机网站支付、电脑网站支付等，本次将的是电脑网站支付。 如果你没有时间阅读文章，可以直接从github获取Demo原来进行查看，非常简单。github:&nbsp;https://github.com/stulzq/Alipay.Demo.PCPayment 创建项目 新建一个ASP.NET Core 2.0 MVC项目 配置 由于我在开发的时候支付接口并没有申请下来，所以使用的是支付宝沙箱环境来进行开发的。 支付宝沙箱环境介绍：蚂蚁沙箱环境(Beta)是协助开发者进行接口功能开发及主要功能联调的辅助环境。沙箱环境模拟了开放平台部分产品的主要功能和主要逻辑，在开发者应用上线审核前，开发者可以根据自身需求，先在沙箱环境中了解、组合和调试各种开放接口，进行开发调通工作，从而帮助开发者在应用上线审核完成后，能更快速、更顺利的进行线上调试和验收工作。 如果在签约或创建应用前想要进行集成测试，可以使用沙箱环境。 沙箱环境支持使用个人账号或企业账号登陆。 沙箱环境地址：https://openhome.alipay.com/platform/appDaily.htm?tab=info 1.生成密钥 下载支付宝官方提供的密钥生成工具来进行生成，详细介绍：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1 2.设置应用公钥 我们生成密钥之后，需要到支付宝后台设置应用公钥，就是我们生成的公钥。 设置之后，支付宝会给我们一个支付宝公钥，保存这个支付宝公钥 这个支付宝公钥和我们自己生成的公钥是不一样的，我们在配置SDK时用的公钥就是支付宝公钥 3.配置SDK 新建一个Config类，在里面存储我们的配置。 public class Config{ &nbsp; &nbsp;// 应用ID,您的APPID &nbsp; &nbsp;public static string AppId = &quot;&quot;; &nbsp; &nbsp;// 支付宝网关 &nbsp; &nbsp;public static string Gatewayurl = &quot;&quot;; &nbsp; &nbsp;// 商户私钥，您的原始格式RSA私钥 &nbsp; &nbsp;public static string PrivateKey = &quot;&quot;; &nbsp; &nbsp;// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。 &nbsp; &nbsp;public static string AlipayPublicKey = &quot;&quot;; &nbsp; &nbsp;// 签名方式 &nbsp; &nbsp;public static string SignType = &quot;RSA2&quot;; &nbsp; &nbsp;// 编码格式 &nbsp; &nbsp;public static string CharSet = &quot;UTF-8&quot;; } 应用ID和支付宝网关都可以在支付宝后台查看。 商户私钥即我们自己生成的私钥，公钥就是支付宝公钥这里一定要注意，别用错了。这里的公钥私钥直接填写字符串即可。 签名方式推荐使用RSA2，使用RSA2，支付宝会用SHA256withRsa算法进行接口调用时的验签（不限制密钥长度）。 编码格式，如果我们是直接配置的字符串（公钥、私钥），那么就是我们代码的编码，如果使用的是文件（公钥、私钥），那么就是文件的编码。 完成配置如下： 添加SDK 官方SDK的源码（.NET Framework），用.NET Standard 2.0 实现的支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET Core 2.0。 通过Nuget安装：Install-Package Alipay.AopSdk.Core 支付 添加一个控制器&nbsp;PayController /// 发起支付请求/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;外部订单号，商户网站订单系统中唯一的订单号&lt;/param&gt;/// &lt;param name=&quot;subject&quot;&gt;订单名称&lt;/param&gt;/// &lt;param name=&quot;totalAmout&quot;&gt;付款金额&lt;/param&gt;/// &lt;param name=&quot;itemBody&quot;&gt;商品描述&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public void PayRequest(string tradeno,string subject,string totalAmout,string itemBody){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;// 组装业务参数model &nbsp; &nbsp;AlipayTradePagePayModel model = new AlipayTradePagePayModel(); &nbsp; &nbsp;model.Body = itemBody; &nbsp; &nbsp;model.Subject = subject; &nbsp; &nbsp;model.TotalAmount = totalAmout; &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.ProductCode = &quot;FAST_INSTANT_TRADE_PAY&quot;; &nbsp; &nbsp;AlipayTradePagePayRequest request = new AlipayTradePagePayRequest(); &nbsp; &nbsp;// 设置同步回调地址 &nbsp; &nbsp;request.SetReturnUrl(&quot;http://localhost:5000/Pay/Callback&quot;); &nbsp; &nbsp;// 设置异步通知接收地址 &nbsp; &nbsp;request.SetNotifyUrl(&quot;&quot;); &nbsp; &nbsp;// 将业务model载入到request &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.SdkExecute(request); &nbsp; &nbsp;Console.WriteLine($&quot;订单支付发起成功，订单号：{tradeno}&quot;); &nbsp; &nbsp;//跳转支付宝支付 &nbsp; &nbsp;Response.Redirect(Config.Gatewayurl + &quot;?&quot; + response.Body); } 运行： 图1 图2 图3 支付异步回调通知 支付宝同步回调通知（支付成功后跳转到商户网站），是不可靠的，所以这里必须使用异步通知来获取支付结果，异步通知即支付宝主动请求我们提供的地址，我们根据请求数据来校验，获取支付结果。 /// &lt;summary&gt;/// 支付异步回调通知 需配置域名 因为是支付宝主动post请求这个action 所以要通过域名访问或者公网ip/// &lt;/summary&gt;public async void Notify(){ &nbsp; &nbsp;/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/ &nbsp; &nbsp;Dictionary&lt;string, string&gt; sArray = GetRequestPost(); &nbsp; &nbsp;if (sArray.Count != 0) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;bool flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey,Config.CharSet, Config.SignType, false); &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;if (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//交易状态 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//判断该笔订单是否在商户网站中已经做过处理 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//请务必判断请求时的total_amount与通知时获取的total_fee为一致的 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//如果有做过处理，不执行商户的业务程序 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//注意： &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(Request.Form[&quot;trade_status&quot;]); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;await Response.WriteAsync(&quot;success&quot;); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;await Response.WriteAsync(&quot;fail&quot;); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} } 同步回调 同步回调即支付成功跳转回商户网站 运行： /// &lt;summary&gt;/// 支付同步回调/// &lt;/summary&gt;[HttpGet]public &nbsp;IActionResult Callback(){ &nbsp; &nbsp;/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/ &nbsp; &nbsp;Dictionary&lt;string, string&gt; sArray = GetRequestGet(); &nbsp; &nbsp;&nbsp;if (sArray.Count != 0) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;bool flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey, Config.CharSet, Config.SignType, false); &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp;if (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($&quot;同步验证通过，订单号：{sArray[&quot;out_trade_no&quot;]}&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[&quot;PayResult&quot;] = &quot;同步验证通过&quot;; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;else &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($&quot;同步验证失败，订单号：{sArray[&quot;out_trade_no&quot;]}&quot;); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[&quot;PayResult&quot;] = &quot;同步验证失败&quot;; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp; &nbsp;return View(); } 订单查询 查询订单当前状态：已付款、未付款等等。 运行： [HttpPost]public JsonResult Query(string tradeno, string alipayTradeNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeQueryModel model = new AlipayTradeQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeQueryRequest request = new AlipayTradeQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 订单退款 退回该订单金额。 运行： /// &lt;summary&gt;/// 订单退款/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;param name=&quot;refundAmount&quot;&gt;退款金额&lt;/param&gt;/// &lt;param name=&quot;refundReason&quot;&gt;退款原因&lt;/param&gt;/// &lt;param name=&quot;refundNo&quot;&gt;退款单号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult Refund(string tradeno,string alipayTradeNo,string refundAmount,string refundReason,string refundNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeRefundModel model = new AlipayTradeRefundModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.RefundAmount = refundAmount; &nbsp; &nbsp;model.RefundReason = refundReason; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeRefundRequest request = new AlipayTradeRefundRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 退款查询 查询退款信息。 运行： /// &lt;summary&gt;/// 退款查询/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;param name=&quot;refundNo&quot;&gt;退款单号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult RefundQuery(string tradeno,string alipayTradeNo,string refundNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;if (string.IsNullOrEmpty(refundNo)) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;refundNo = tradeno; &nbsp; &nbsp;} &nbsp; &nbsp;AlipayTradeFastpayRefundQueryModel model = new AlipayTradeFastpayRefundQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeFastpayRefundQueryRequest request = new AlipayTradeFastpayRefundQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 订单关闭 对一定时间以后没有进行付款的订单进行关闭，订单状态需为：待付款，已完成支付的订单无法关闭。 运行： /// &lt;summary&gt;/// 关闭订单/// &lt;/summary&gt;/// &lt;param name=&quot;tradeno&quot;&gt;商户订单号&lt;/param&gt;/// &lt;param name=&quot;alipayTradeNo&quot;&gt;支付宝交易号&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;[HttpPost]public JsonResult OrderClose(string tradeno, string alipayTradeNo){ &nbsp; &nbsp;DefaultAopClient client = new DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, &quot;json&quot;, &quot;2.0&quot;, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, false); &nbsp; &nbsp;AlipayTradeCloseModel model = new AlipayTradeCloseModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeCloseRequest request = new AlipayTradeCloseRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;var response = client.Execute(request); &nbsp; &nbsp;return Json(response.Body); } 地址集合 支付宝API文档 支付宝沙箱环境 支付宝密钥生成工具 支付宝服务端SDK源码 支付宝服务端SDK Nuget 最重要的： 本文Demo：https://github.com/stulzq/Alipay.Demo.PCPayment 原文地址：http://www.cnblogs.com/stulzq/p/7606164.html .NET社区新闻，深度好文，微信中搜索dotNET跨平台或扫描二维码关注 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2017/09/29/e8ecabc79f669adff59ffd774f557259.html","headline":"ASP.NET Core 2.0 使用支付宝PC网站支付","dateModified":"2017-09-29T00:00:00+08:00","datePublished":"2017-09-29T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2017/09/29/e8ecabc79f669adff59ffd774f557259.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>ASP.NET Core 2.0 使用支付宝PC网站支付</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <div class="rich_media_content" id="js_content"> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 前言</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 最近在使用ASP.NET Core来进行开发，刚好有个接入支付宝支付的需求，百度了一下没找到相关的资料，看了官方的SDK以及Demo都还是.NET Framework的，所以就先根据官方SDK的源码，用.NET Standard 2.0 实现了支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET CORE 2.0。为了使用方便，已上传至Nuget可以直接使用。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 支付宝有比较多的支付产品，比如当面付、APP支付、手机网站支付、电脑网站支付等，本次将的是电脑网站支付。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KwyYUG6eaicyoKJNWtP2Ju1eNnL1ibzapt6dQRX1P3aIzKxCnVaqdPCEw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1" style="border:none;visibility:visible !important;" alt="640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 如果你没有时间阅读文章，可以直接从github获取Demo原来进行查看，非常简单。github:&nbsp;https://github.com/stulzq/Alipay.Demo.PCPayment</p> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 创建项目</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 新建一个ASP.NET Core 2.0 MVC项目</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9K6hhQiatib8OBU4ZMgWLAFibc6YAa5dHjAjd4NiboFIq6LzOuTGZzvPJwIg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1" style="border:none;visibility:visible !important;" alt="640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1"></p> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 配置</h1> 
   <blockquote style="background:rgb(255,255,255) none;border-top:none;border-right:none;border-bottom:none;border-left-width:5px;border-left-color:rgb(221,221,221);color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;"> 
    <p style="color:rgb(119,119,119);">由于我在开发的时候支付接口并没有申请下来，所以使用的是支付宝沙箱环境来进行开发的。</p> 
   </blockquote> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <strong>支付宝沙箱环境介绍</strong>：蚂蚁沙箱环境(Beta)是协助开发者进行接口功能开发及主要功能联调的辅助环境。沙箱环境模拟了开放平台部分产品的主要功能和主要逻辑，在开发者应用上线审核前，开发者可以根据自身需求，先在沙箱环境中了解、组合和调试各种开放接口，进行开发调通工作，从而帮助开发者在应用上线审核完成后，能更快速、更顺利的进行线上调试和验收工作。<br> 如果在签约或创建应用前想要进行集成测试，可以使用沙箱环境。<br> 沙箱环境支持使用个人账号或企业账号登陆。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 沙箱环境地址：https://openhome.alipay.com/platform/appDaily.htm?tab=info</p> 
   <h2 style="font-size:15px;font-weight:bold;line-height:23px;background:rgb(43,102,0);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 1.生成密钥</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 下载支付宝官方提供的密钥生成工具来进行生成，详细介绍：https://doc.open.alipay.com/docs/doc.htm?treeId=291&amp;articleId=105971&amp;docType=1</p> 
   <h2 style="font-size:15px;font-weight:bold;line-height:23px;background:rgb(43,102,0);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 2.设置应用公钥</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 我们生成密钥之后，需要到支付宝后台设置应用公钥，就是我们生成的公钥。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KmVJXweibpD3E9AHTMWluXkEadDJ9Gv2QXB5kxhwFUTRhVQ7pcHDgRmw/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 设置之后，支付宝会给我们一个支付宝公钥，保存这个<strong>支付宝公钥</strong></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9K1ACPOLYvBUWTLaY6NF2ru4xKhTyKqQkfrGBSD7db9sK7dqhCamRDOw/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 这个支付宝公钥和我们自己生成的公钥是不一样的，我们在配置SDK时用的公钥就是支付宝公钥</p> 
   <h2 style="font-size:15px;font-weight:bold;line-height:23px;background:rgb(43,102,0);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 3.配置SDK</h2> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 新建一个<code style="line-height:1.8;vertical-align:middle;display:inline-block;">Config</code>类，在里面存储我们的配置。</p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">class</span> <span class="hljs-title" style="color:rgb(163,21,21);">Config</span>{ &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 应用ID,您的APPID</span> &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> AppId = <span class="hljs-string" style="color:rgb(163,21,21);">""</span>; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 支付宝网关</span> &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> Gatewayurl = <span class="hljs-string" style="color:rgb(163,21,21);">""</span>; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 商户私钥，您的原始格式RSA私钥</span> &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> PrivateKey = <span class="hljs-string" style="color:rgb(163,21,21);">""</span>; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 支付宝公钥,查看地址：https://openhome.alipay.com/platform/keyManage.htm 对应APPID下的支付宝公钥。</span> &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> AlipayPublicKey = <span class="hljs-string" style="color:rgb(163,21,21);">""</span>; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 签名方式</span> &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> SignType = <span class="hljs-string" style="color:rgb(163,21,21);">"RSA2"</span>; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 编码格式</span> &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">static</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> CharSet = <span class="hljs-string" style="color:rgb(163,21,21);">"UTF-8"</span>; }</code></code></pre> 
   <ul class="list-paddingleft-2" style="margin-left:40px;">
    <li> <p>应用ID和支付宝网关都可以在支付宝后台查看。</p> </li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KfBaqbZI2JgoHnI5cX6ElCHShm5jDaaQmED93s0JSHHSJHMxORh5HpQ/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <ul class="list-paddingleft-2" style="margin-left:40px;">
    <li> <p>商户私钥即我们自己生成的私钥，公钥就是<strong>支付宝公钥</strong>这里一定要注意，别用错了。这里的公钥私钥直接填写字符串即可。</p> </li>
    <li> <p>签名方式推荐使用<code style="line-height:1.8;vertical-align:middle;display:inline-block;">RSA2</code>，使用RSA2，支付宝会用SHA256withRsa算法进行接口调用时的验签（不限制密钥长度）。</p> </li>
    <li> <p>编码格式，如果我们是直接配置的字符串（公钥、私钥），那么就是我们代码的编码，如果使用的是文件（公钥、私钥），那么就是文件的编码。</p> </li>
    <li> <p>完成配置如下：</p> </li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KKQv9Cu4pG4IAOY9bJ4WXOibzE5aRIAn6IJTU4yalWyE3KnHyWibLUbjA/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 添加SDK</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 官方SDK的源码（.NET Framework），用.NET Standard 2.0 实现的支付宝服务端SDK，Alipay.AopSdk.Core（github:https://github.com/stulzq/Alipay.AopSdk.Core） ，支持.NET Core 2.0。<br> 通过Nuget安装：<code style="line-height:1.8;vertical-align:middle;display:inline-block;">Install-Package Alipay.AopSdk.Core</code></p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KQ6wsmENiaVxnpIibKicM27HZg9LjXMyxNTkjdud04KBgvyR1T3x7vSbEw/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 支付</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 添加一个控制器&nbsp;<code style="line-height:1.8;vertical-align:middle;display:inline-block;">PayController</code></p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 发起支付请求<br></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="tradeno"&gt;</span>外部订单号，商户网站订单系统中唯一的订单号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="subject"&gt;</span>订单名称<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="totalAmout"&gt;</span>付款金额<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="itemBody"&gt;</span>商品描述<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;returns&gt;</span><span class="hljs-doctag" style="color:#808080;">&lt;/returns&gt;<br></span></span>[HttpPost]<br><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">PayRequest</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> tradeno,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> subject,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> totalAmout,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> itemBody</span>)</span>{ &nbsp; &nbsp;DefaultAopClient client = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, <span class="hljs-string" style="color:rgb(163,21,21);">"json"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"2.0"</span>, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 组装业务参数model</span> &nbsp; &nbsp;AlipayTradePagePayModel model = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradePagePayModel(); &nbsp; &nbsp;model.Body = itemBody; &nbsp; &nbsp;model.Subject = subject; &nbsp; &nbsp;model.TotalAmount = totalAmout; &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.ProductCode = <span class="hljs-string" style="color:rgb(163,21,21);">"FAST_INSTANT_TRADE_PAY"</span>; &nbsp; &nbsp;AlipayTradePagePayRequest request = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradePagePayRequest(); &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 设置同步回调地址</span> &nbsp; &nbsp;request.SetReturnUrl(<span class="hljs-string" style="color:rgb(163,21,21);">"http://localhost:5000/Pay/Callback"</span>); &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 设置异步通知接收地址</span> &nbsp; &nbsp;request.SetNotifyUrl(<span class="hljs-string" style="color:rgb(163,21,21);">""</span>); &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">// 将业务model载入到request</span> &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> response = client.SdkExecute(request); &nbsp; &nbsp;Console.WriteLine($<span class="hljs-string" style="color:rgb(163,21,21);">"订单支付发起成功，订单号：{tradeno}"</span>); &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//跳转支付宝支付</span> &nbsp; &nbsp;Response.Redirect(Config.Gatewayurl + <span class="hljs-string" style="color:rgb(163,21,21);">"?"</span> + response.Body); }</code></code></pre> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 运行：</p> 
   <ul class="list-paddingleft-2" style="margin-left:40px;">
    <li> <p>图1</p> </li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KsonTtfHBkKtD03lG0JHrPTnPRqTlv259IdCwn7AjWUQp2xqmoXxDqw/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <ul class="list-paddingleft-2" style="margin-left:40px;">
    <li> <p>图2</p> </li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9K2MWsVxxGPCFzMHBHM2KQk4pH5GSuU6YmnQ31m38JfibYMCJr0FHiasHQ/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <ul class="list-paddingleft-2" style="margin-left:40px;">
    <li> <p>图3</p> </li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9Kys15hBC1C9UcWBAaibv4Y7yyvwibcVlzX7svmjbwBBribq3zBz6qNyfPA/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 支付异步回调通知</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 支付宝同步回调通知（支付成功后跳转到商户网站），是不可靠的，所以这里必须使用异步通知来获取支付结果，异步通知即支付宝主动请求我们提供的地址，我们根据请求数据来校验，获取支付结果。</p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 支付异步回调通知 需配置域名 因为是支付宝主动post请求这个action 所以要通过域名访问或者公网ip<br></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;<br></span></span><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">async</span> <span class="hljs-keyword" style="color:rgb(0,0,255);">void</span> <span class="hljs-title" style="color:rgb(163,21,21);">Notify</span>(<span class="hljs-params">)</span>{ &nbsp; &nbsp;<br><span class="hljs-comment" style="color:#008000;">/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/</span> &nbsp; &nbsp;Dictionary&lt;<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>, <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>&gt; sArray = GetRequestPost(); &nbsp; <br>&nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (sArray.Count != <span class="hljs-number">0</span>) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">bool</span> flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey,Config.CharSet, Config.SignType, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; <br>&nbsp; &nbsp;&nbsp; &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//交易状态</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//判断该笔订单是否在商户网站中已经做过处理</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//请务必判断请求时的total_amount与通知时获取的total_fee为一致的</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//如果有做过处理，不执行商户的业务程序</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//注意：</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-comment" style="color:#008000;">//退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(Request.Form[<span class="hljs-string" style="color:rgb(163,21,21);">"trade_status"</span>]); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> Response.WriteAsync(<span class="hljs-string" style="color:rgb(163,21,21);">"success"</span>); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">else</span> &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">await</span> Response.WriteAsync(<span class="hljs-string" style="color:rgb(163,21,21);">"fail"</span>); &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} }</span></code></code></pre> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 同步回调</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 同步回调即支付成功跳转回商户网站</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 运行：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KSwrDibjJtQHrLWDsr03N9IRfIY9AdbMUECJiaUbkqArUdPPq7AocXIBA/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 支付同步回调<br></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;<br></span></span>[HttpGet]<br><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> &nbsp;IActionResult <span class="hljs-title" style="color:rgb(163,21,21);">Callback</span>(<span class="hljs-params">)</span>{ &nbsp; <br>&nbsp;<span class="hljs-comment" style="color:#008000;">/* 实际验证过程建议商户添加以下校验。 &nbsp; &nbsp;1、商户需要验证该通知数据中的out_trade_no是否为商户系统中创建的订单号， &nbsp; &nbsp;2、判断total_amount是否确实为该订单的实际金额（即商户订单创建时的金额）， &nbsp; &nbsp;3、校验通知中的seller_id（或者seller_email) 是否为out_trade_no这笔单据的对应的操作方（有的时候，一个商户可能有多个seller_id/seller_email） &nbsp; &nbsp;4、验证app_id是否为该商户本身。 &nbsp; &nbsp;*/</span> &nbsp; &nbsp;Dictionary&lt;<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>, <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>&gt; sArray = GetRequestGet(); &nbsp; &nbsp;<br>&nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (sArray.Count != <span class="hljs-number">0</span>) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp;<br>&nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">bool</span> flag = AlipaySignature.RSACheckV1(sArray, Config.AlipayPublicKey, Config.CharSet, Config.SignType, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; &nbsp; <br>&nbsp; &nbsp;&nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (flag) &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($<span class="hljs-string" style="color:rgb(163,21,21);">"同步验证通过，订单号：{sArray["</span>out_trade_no<span class="hljs-string" style="color:rgb(163,21,21);">"]}"</span>); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[<span class="hljs-string" style="color:rgb(163,21,21);">"PayResult"</span>] = <span class="hljs-string" style="color:rgb(163,21,21);">"同步验证通过"</span>; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp; &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">else</span> &nbsp; &nbsp; &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine($<span class="hljs-string" style="color:rgb(163,21,21);">"同步验证失败，订单号：{sArray["</span>out_trade_no<span class="hljs-string" style="color:rgb(163,21,21);">"]}"</span>); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ViewData[<span class="hljs-string" style="color:rgb(163,21,21);">"PayResult"</span>] = <span class="hljs-string" style="color:rgb(163,21,21);">"同步验证失败"</span>; &nbsp; &nbsp; &nbsp; &nbsp;} &nbsp; &nbsp;} &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">return</span> View(); }</span></code></code></pre> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 订单查询</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 查询订单当前状态：已付款、未付款等等。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 运行：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KLnJ76cnqjLfiaFcZoIhImILTbGI7NK0XPnLFhL6QYQzqg3ra6Dh431A/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;">[HttpPost]<br><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> JsonResult <span class="hljs-title" style="color:rgb(163,21,21);">Query</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> tradeno, <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> alipayTradeNo</span>)</span>{ &nbsp; &nbsp;DefaultAopClient client = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, <span class="hljs-string" style="color:rgb(163,21,21);">"json"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"2.0"</span>, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; &nbsp;AlipayTradeQueryModel model = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeQueryRequest request = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> response = client.Execute(request); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">return</span> Json(response.Body); }</code></code></pre> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 订单退款</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 退回该订单金额。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 运行：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9K8QI2zKxH0SHeibwwXHY6H0YqbY9g07sHlnBiby7Xh7NnnN8C4mSbZF7Q/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 订单退款<br></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="tradeno"&gt;</span>商户订单号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="alipayTradeNo"&gt;</span>支付宝交易号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="refundAmount"&gt;</span>退款金额<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="refundReason"&gt;</span>退款原因<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="refundNo"&gt;</span>退款单号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;returns&gt;</span><span class="hljs-doctag" style="color:#808080;">&lt;/returns&gt;</span></span>[HttpPost]<span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> JsonResult <span class="hljs-title" style="color:rgb(163,21,21);">Refund</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> tradeno,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> alipayTradeNo,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> refundAmount,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> refundReason,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> refundNo</span>)</span>{ &nbsp; &nbsp;DefaultAopClient client = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, <span class="hljs-string" style="color:rgb(163,21,21);">"json"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"2.0"</span>, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; &nbsp;AlipayTradeRefundModel model = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeRefundModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.RefundAmount = refundAmount; &nbsp; &nbsp;model.RefundReason = refundReason; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeRefundRequest request = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeRefundRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> response = client.Execute(request); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">return</span> Json(response.Body); }<br></code></code></pre> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 退款查询</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 查询退款信息。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 运行：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9KfJbg0TBeJ5rPtLRYx0tNMPV55eAPjR5g77E9LHia36JZAT7icTDicYia7w/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 退款查询<br>/</span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">//</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="tradeno"&gt;</span>商户订单号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="alipayTradeNo"&gt;</span>支付宝交易号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="refundNo"&gt;</span>退款单号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;returns&gt;</span><span class="hljs-doctag" style="color:#808080;">&lt;/returns&gt;<br></span></span>[HttpPost]<br><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> JsonResult <span class="hljs-title" style="color:rgb(163,21,21);">RefundQuery</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> tradeno,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> alipayTradeNo,<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> refundNo</span>)</span>{ &nbsp; &nbsp;DefaultAopClient client = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, <span class="hljs-string" style="color:rgb(163,21,21);">"json"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"2.0"</span>, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">if</span> (<span class="hljs-keyword" style="color:rgb(0,0,255);">string</span>.IsNullOrEmpty(refundNo)) &nbsp; &nbsp;{ &nbsp; &nbsp; &nbsp; &nbsp;refundNo = tradeno; &nbsp; &nbsp;} &nbsp; &nbsp;AlipayTradeFastpayRefundQueryModel model = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeFastpayRefundQueryModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;model.OutRequestNo = refundNo; &nbsp; &nbsp;AlipayTradeFastpayRefundQueryRequest request = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeFastpayRefundQueryRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> response = client.Execute(request); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">return</span> Json(response.Body); }</code></code></pre> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 订单关闭</h1> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 对一定时间以后没有进行付款的订单进行关闭，订单状态需为：待付款，已完成支付的订单无法关闭。</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 运行：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> <img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz_png/gak2lhVxV6KFpsnAQo9m33UtbVB15M9K8W3kial3kibKcqQcxQpsiatyoJL6lmSds5hdDFN4avicwNpH0iaGCr6Gib2w/0?wx_fmt=png" style="border:none;" alt="0?wx_fmt=png"></p> 
   <pre><code class="language-csharp"><code class="hljs cs" style="vertical-align:middle;display:block;color:rgb(0,0,0);line-height:1.5 !important;"><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> 关闭订单<br></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;/summary&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="tradeno"&gt;</span>商户订单号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;param name="alipayTradeNo"&gt;</span>支付宝交易号<span class="hljs-doctag" style="color:#808080;">&lt;/param&gt;<br></span></span><span class="hljs-comment" style="color:#008000;"><span class="hljs-doctag" style="color:#808080;">///</span> <span class="hljs-doctag" style="color:#808080;">&lt;returns&gt;</span><span class="hljs-doctag" style="color:#808080;">&lt;/returns&gt;<br></span></span>[HttpPost]<br><span class="hljs-function"><span class="hljs-keyword" style="color:rgb(0,0,255);">public</span> JsonResult <span class="hljs-title" style="color:rgb(163,21,21);">OrderClose</span>(<span class="hljs-params"><span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> tradeno, <span class="hljs-keyword" style="color:rgb(0,0,255);">string</span> alipayTradeNo</span>)</span>{ &nbsp; &nbsp;DefaultAopClient client = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> DefaultAopClient(Config.Gatewayurl, Config.AppId, Config.PrivateKey, <span class="hljs-string" style="color:rgb(163,21,21);">"json"</span>, <span class="hljs-string" style="color:rgb(163,21,21);">"2.0"</span>, &nbsp; &nbsp; &nbsp; &nbsp;Config.SignType, Config.AlipayPublicKey, Config.CharSet, <span class="hljs-keyword" style="color:rgb(0,0,255);">false</span>); &nbsp; &nbsp;AlipayTradeCloseModel model = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeCloseModel(); &nbsp; &nbsp;model.OutTradeNo = tradeno; &nbsp; &nbsp;model.TradeNo = alipayTradeNo; &nbsp; &nbsp;AlipayTradeCloseRequest request = <span class="hljs-keyword" style="color:rgb(0,0,255);">new</span> AlipayTradeCloseRequest(); &nbsp; &nbsp;request.SetBizModel(model); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">var</span> response = client.Execute(request); &nbsp; &nbsp;<span class="hljs-keyword" style="color:rgb(0,0,255);">return</span> Json(response.Body); }</code></code></pre> 
   <h1 style="font-size:18px;font-weight:bold;line-height:25px;background:rgb(43,102,149);color:rgb(255,255,255);font-family:'微软雅黑', '宋体', '黑体', Arial;"> 地址集合</h1> 
   <ul class="list-paddingleft-2" style="margin-left:40px;">
    <li> <p>支付宝API文档</p> </li>
    <li> <p>支付宝沙箱环境</p> </li>
    <li> <p>支付宝密钥生成工具</p> </li>
    <li> <p>支付宝服务端SDK源码</p> </li>
    <li> <p>支付宝服务端SDK Nuget</p> </li>
   </ul>
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 最重要的：</p> 
   <p style="color:rgb(51,51,51);font-family:Verdana, Arial, Helvetica, sans-serif;font-size:14px;background-color:rgb(255,255,255);"> 本文Demo：https://github.com/stulzq/Alipay.Demo.PCPayment</p> 
   <pre style="color:rgb(62,62,62);font-size:16px;background-color:rgb(255,255,255);list-style-type:none;"></pre>
   <p style="min-height:1em;line-height:34.1333px;"><span style="font-size:14px;">原文地址：http://www.cnblogs.com/stulzq/p/7606164.html<span style="line-height:34.1333px;"></span><br></span></p>
   <hr style="line-height:28.4444px;">
   <p style="min-height:1em;line-height:28.4444px;"><span style="font-size:14px;"><strong style="line-height:25.6px;"><span style="text-align:center;color:rgb(39,42,48);">.NET社区新闻，深度好文，微信中搜索</span><span style="text-align:center;color:rgb(210,34,34);">dotNET跨平台</span><span style="text-align:center;color:rgb(39,42,48);">或扫描二维码关注</span></strong></span></p>
   <p style="min-height:1em;line-height:28.4444px;text-align:center;"><img class="img_loading" src="https://ss.csdn.net/p?http://mmbiz.qpic.cn/mmbiz/gak2lhVxV6IzK1WqqQ4VMXw51RcUR5Q7EPlULUntWYqFPSqYyXXtBctZ6zAdoiaJgXHv1NHClMt34HLtqaEpdVA/640?wx_fmt=jpeg" style="border:medium;line-height:23.27px;visibility:visible !important;" alt="640?wx_fmt=jpeg"></p> 
  </div> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sD7O95O/article/details/78130927,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/sD7O95O/article/details/78130927,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
