<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Python2.7获取QQ照片墙 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Python2.7获取QQ照片墙" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="通过wireshark抓电脑版QQ的http数据包得到的结果 接口调用： http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json 现在照片墙还没有上限，你可以将num=400改得尽量大，接口中的uin表示你自己的QQ，g_tk需要计算得出，实际上这两个参数服务器不会校验，可以任意取，也不需要带cookies 如果没有照片返回结果是这样的 {&quot;code&quot;:0,&quot;data&quot;:{&quot;next_offset&quot;:-1,&quot;total&quot;:0,&quot;uin&quot;:123456789,&quot;uptime&quot;:1397711082},&quot;message&quot;:&quot;&quot;,&quot;subcode&quot;:0}如果有照片，返回结果是这样的 {&quot;code&quot;:0,&quot;data&quot;:{&quot;next_offset&quot;:-1,&quot;photo_list&quot;:[{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/640&quot;,&quot;ctime&quot;:1446960924,&quot;filekey&quot;:&quot;44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/640&quot;,&quot;ctime&quot;:1446960912,&quot;filekey&quot;:&quot;e1a706fd3d78430d5c0e3d46ae76770581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/640&quot;,&quot;ctime&quot;:1446960903,&quot;filekey&quot;:&quot;1b3740ab132fec2567d281a6ae4ce65b81cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/640&quot;,&quot;ctime&quot;:1412657386,&quot;filekey&quot;:&quot;bf318cb2191b3a6300acf8cde68f21c681cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/640&quot;,&quot;ctime&quot;:1411656582,&quot;filekey&quot;:&quot;f3659f9cecef0cf36feea13022f4786881cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/640&quot;,&quot;ctime&quot;:1411656581,&quot;filekey&quot;:&quot;c0d3c192c33c54e978f01ec49690265481cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/640&quot;,&quot;ctime&quot;:1411656541,&quot;filekey&quot;:&quot;288d4e40e8635b229c36c99c9869c50381cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/640&quot;,&quot;ctime&quot;:1411656539,&quot;filekey&quot;:&quot;115617c351047bef607a86f68373ee3581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/640&quot;,&quot;ctime&quot;:1397190206,&quot;filekey&quot;:&quot;b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/640&quot;,&quot;ctime&quot;:1397190195,&quot;filekey&quot;:&quot;56bf5ea1f5096671cf365d56ab63ade781cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/640&quot;,&quot;ctime&quot;:1397190180,&quot;filekey&quot;:&quot;7acfe7c6c2e48b5b22de8e32086726d881cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/640&quot;,&quot;ctime&quot;:1390318130,&quot;filekey&quot;:&quot;82f7911a6b9a458e6ced939223964b4581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/640&quot;,&quot;ctime&quot;:1375022218,&quot;filekey&quot;:&quot;4a2e9886148db7689dcf88a9d128f72681cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/100&quot;}],&quot;total&quot;:13,&quot;uin&quot;:123456789,&quot;uptime&quot;:1446960924},&quot;message&quot;:&quot;&quot;,&quot;subcode&quot;:0} 我们关注total和ourl字段就可以了，total表示照片总数，ourl表示原图，其它的url是缩放过的图 老规矩，你要查的qq号做个无BOM的utf-8编码的txt放同目录下，每个QQ号占一行，最后一个QQ号需要再加一个或多个空行，文件格式根据文件头智能识别 代码如下 # -*- coding: UTF-8 -*- import httplib2 import json import os import shutil import time import binascii dir=&#39;QQWallPhotos/&#39; try: os.makedirs(dir) # 建立相应的文件夹 except: shutil.rmtree(dir) # 无论文件夹是否为空都移除该文件夹 os.makedirs(dir) fp = open(&#39;qqlist.txt&#39;, &#39;r&#39;) qqlist = fp.readlines() for i in range(len(qqlist)): qqlist[i] = qqlist[i][:-1] fp.close() h = httplib2.Http(timeout=6) for target in qqlist: url = &#39;http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json&#39; if len(target) == 0 : # 防止因为出现空行删除所有照片 continue try: os.makedirs(dir + target) # 建立相应的文件夹 except : shutil.rmtree(dir + target) # 无论文件夹是否为空都移除该文件夹 os.makedirs(dir + target) print(u&#39;当前QQ：&#39; + target) url=url.replace(&#39;qqnumber&#39;,target) resp = None content = None for t1 in (1,6): try: resp, content = h.request(url) break except: print(&quot;-----socket timout:&quot;,url) continue print content try: output = json.loads(content) # json字符串转字典 except: break # json字符串转字典出现异常，退出循环 print output if output[&#39;code&#39;] != 0 : # 返回结果异常，退出本次循环 continue total = output[&#39;data&#39;][&#39;total&#39;] # 照片墙总数，如果为0表示没有照片 print total if total != 0 : for i in range(0, len(output[&#39;data&#39;][&#39;photo_list&#39;])): ctime = output[&#39;data&#39;][&#39;photo_list&#39;][i][&#39;ctime&#39;] filename = time.strftime(&quot;%Y%m%d%H%M%S&quot;,time.localtime(ctime)) url = output[&#39;data&#39;][&#39;photo_list&#39;][i][&#39;ourl&#39;] print url resp = None content = None for t2 in (1,6): try: resp, content = h.request(url) break except: print(&quot;-----socket timout:&quot;,url) continue fmt = binascii.b2a_hex(content[0:4]) # 读取前4字节转化为16进制字符串 print fmt phototype = {&#39;47494638&#39;: &#39;.gif&#39;, &#39;ffd8ffe0&#39;: &#39;.jpg&#39;, &#39;ffd8ffe1&#39;: &#39;.jpg&#39;, &#39;ffd8ffdb&#39;: &#39;.jpg&#39;, &#39;89504e47&#39;: &#39;.png&#39;} # 智能识别文件格式 qualified_file_name = dir + target + &#39;/&#39; + filename + phototype[fmt] open(qualified_file_name, &#39;wb&#39;).write(content) if total == 0 : shutil.rmtree(dir + target) print(u&#39;下载完成&#39;) 更新1：增加ffd8ffdb的jpg格式 更新2：修复连接超时导致下载中断的异常 更新3：加入超时重发3次请求的机制，根据笔者监测到的情况，超时设为6秒时，超时一般出现在获取json的时候，笔者300好友数最多重发两次解决问题，总重发次数在10次以内 更新4：修复变量名命名不当以及变量未清空导致获取到上一次结果的问题 阅读更多" />
<meta property="og:description" content="通过wireshark抓电脑版QQ的http数据包得到的结果 接口调用： http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json 现在照片墙还没有上限，你可以将num=400改得尽量大，接口中的uin表示你自己的QQ，g_tk需要计算得出，实际上这两个参数服务器不会校验，可以任意取，也不需要带cookies 如果没有照片返回结果是这样的 {&quot;code&quot;:0,&quot;data&quot;:{&quot;next_offset&quot;:-1,&quot;total&quot;:0,&quot;uin&quot;:123456789,&quot;uptime&quot;:1397711082},&quot;message&quot;:&quot;&quot;,&quot;subcode&quot;:0}如果有照片，返回结果是这样的 {&quot;code&quot;:0,&quot;data&quot;:{&quot;next_offset&quot;:-1,&quot;photo_list&quot;:[{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/640&quot;,&quot;ctime&quot;:1446960924,&quot;filekey&quot;:&quot;44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/640&quot;,&quot;ctime&quot;:1446960912,&quot;filekey&quot;:&quot;e1a706fd3d78430d5c0e3d46ae76770581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/640&quot;,&quot;ctime&quot;:1446960903,&quot;filekey&quot;:&quot;1b3740ab132fec2567d281a6ae4ce65b81cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/640&quot;,&quot;ctime&quot;:1412657386,&quot;filekey&quot;:&quot;bf318cb2191b3a6300acf8cde68f21c681cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/640&quot;,&quot;ctime&quot;:1411656582,&quot;filekey&quot;:&quot;f3659f9cecef0cf36feea13022f4786881cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/640&quot;,&quot;ctime&quot;:1411656581,&quot;filekey&quot;:&quot;c0d3c192c33c54e978f01ec49690265481cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/640&quot;,&quot;ctime&quot;:1411656541,&quot;filekey&quot;:&quot;288d4e40e8635b229c36c99c9869c50381cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/640&quot;,&quot;ctime&quot;:1411656539,&quot;filekey&quot;:&quot;115617c351047bef607a86f68373ee3581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/640&quot;,&quot;ctime&quot;:1397190206,&quot;filekey&quot;:&quot;b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/640&quot;,&quot;ctime&quot;:1397190195,&quot;filekey&quot;:&quot;56bf5ea1f5096671cf365d56ab63ade781cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/640&quot;,&quot;ctime&quot;:1397190180,&quot;filekey&quot;:&quot;7acfe7c6c2e48b5b22de8e32086726d881cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/640&quot;,&quot;ctime&quot;:1390318130,&quot;filekey&quot;:&quot;82f7911a6b9a458e6ced939223964b4581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/100&quot;},{&quot;burl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/640&quot;,&quot;ctime&quot;:1375022218,&quot;filekey&quot;:&quot;4a2e9886148db7689dcf88a9d128f72681cd4e2091&quot;,&quot;murl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/160&quot;,&quot;ourl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/0&quot;,&quot;surl&quot;:&quot;http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/100&quot;}],&quot;total&quot;:13,&quot;uin&quot;:123456789,&quot;uptime&quot;:1446960924},&quot;message&quot;:&quot;&quot;,&quot;subcode&quot;:0} 我们关注total和ourl字段就可以了，total表示照片总数，ourl表示原图，其它的url是缩放过的图 老规矩，你要查的qq号做个无BOM的utf-8编码的txt放同目录下，每个QQ号占一行，最后一个QQ号需要再加一个或多个空行，文件格式根据文件头智能识别 代码如下 # -*- coding: UTF-8 -*- import httplib2 import json import os import shutil import time import binascii dir=&#39;QQWallPhotos/&#39; try: os.makedirs(dir) # 建立相应的文件夹 except: shutil.rmtree(dir) # 无论文件夹是否为空都移除该文件夹 os.makedirs(dir) fp = open(&#39;qqlist.txt&#39;, &#39;r&#39;) qqlist = fp.readlines() for i in range(len(qqlist)): qqlist[i] = qqlist[i][:-1] fp.close() h = httplib2.Http(timeout=6) for target in qqlist: url = &#39;http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json&#39; if len(target) == 0 : # 防止因为出现空行删除所有照片 continue try: os.makedirs(dir + target) # 建立相应的文件夹 except : shutil.rmtree(dir + target) # 无论文件夹是否为空都移除该文件夹 os.makedirs(dir + target) print(u&#39;当前QQ：&#39; + target) url=url.replace(&#39;qqnumber&#39;,target) resp = None content = None for t1 in (1,6): try: resp, content = h.request(url) break except: print(&quot;-----socket timout:&quot;,url) continue print content try: output = json.loads(content) # json字符串转字典 except: break # json字符串转字典出现异常，退出循环 print output if output[&#39;code&#39;] != 0 : # 返回结果异常，退出本次循环 continue total = output[&#39;data&#39;][&#39;total&#39;] # 照片墙总数，如果为0表示没有照片 print total if total != 0 : for i in range(0, len(output[&#39;data&#39;][&#39;photo_list&#39;])): ctime = output[&#39;data&#39;][&#39;photo_list&#39;][i][&#39;ctime&#39;] filename = time.strftime(&quot;%Y%m%d%H%M%S&quot;,time.localtime(ctime)) url = output[&#39;data&#39;][&#39;photo_list&#39;][i][&#39;ourl&#39;] print url resp = None content = None for t2 in (1,6): try: resp, content = h.request(url) break except: print(&quot;-----socket timout:&quot;,url) continue fmt = binascii.b2a_hex(content[0:4]) # 读取前4字节转化为16进制字符串 print fmt phototype = {&#39;47494638&#39;: &#39;.gif&#39;, &#39;ffd8ffe0&#39;: &#39;.jpg&#39;, &#39;ffd8ffe1&#39;: &#39;.jpg&#39;, &#39;ffd8ffdb&#39;: &#39;.jpg&#39;, &#39;89504e47&#39;: &#39;.png&#39;} # 智能识别文件格式 qualified_file_name = dir + target + &#39;/&#39; + filename + phototype[fmt] open(qualified_file_name, &#39;wb&#39;).write(content) if total == 0 : shutil.rmtree(dir + target) print(u&#39;下载完成&#39;) 更新1：增加ffd8ffdb的jpg格式 更新2：修复连接超时导致下载中断的异常 更新3：加入超时重发3次请求的机制，根据笔者监测到的情况，超时设为6秒时，超时一般出现在获取json的时候，笔者300好友数最多重发两次解决问题，总重发次数在10次以内 更新4：修复变量名命名不当以及变量未清空导致获取到上一次结果的问题 阅读更多" />
<link rel="canonical" href="https://mlh.app/2015/11/27/74a9c92c62a4a9824364aa17a882c81b.html" />
<meta property="og:url" content="https://mlh.app/2015/11/27/74a9c92c62a4a9824364aa17a882c81b.html" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-11-27T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"通过wireshark抓电脑版QQ的http数据包得到的结果 接口调用： http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json 现在照片墙还没有上限，你可以将num=400改得尽量大，接口中的uin表示你自己的QQ，g_tk需要计算得出，实际上这两个参数服务器不会校验，可以任意取，也不需要带cookies 如果没有照片返回结果是这样的 {&quot;code&quot;:0,&quot;data&quot;:{&quot;next_offset&quot;:-1,&quot;total&quot;:0,&quot;uin&quot;:123456789,&quot;uptime&quot;:1397711082},&quot;message&quot;:&quot;&quot;,&quot;subcode&quot;:0}如果有照片，返回结果是这样的 {&quot;code&quot;:0,&quot;data&quot;:{&quot;next_offset&quot;:-1,&quot;photo_list&quot;:[{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\\/640&quot;,&quot;ctime&quot;:1446960924,&quot;filekey&quot;:&quot;44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\\/640&quot;,&quot;ctime&quot;:1446960912,&quot;filekey&quot;:&quot;e1a706fd3d78430d5c0e3d46ae76770581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\\/640&quot;,&quot;ctime&quot;:1446960903,&quot;filekey&quot;:&quot;1b3740ab132fec2567d281a6ae4ce65b81cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\\/640&quot;,&quot;ctime&quot;:1412657386,&quot;filekey&quot;:&quot;bf318cb2191b3a6300acf8cde68f21c681cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/f3659f9cecef0cf36feea13022f4786881cd4e2091\\/640&quot;,&quot;ctime&quot;:1411656582,&quot;filekey&quot;:&quot;f3659f9cecef0cf36feea13022f4786881cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/f3659f9cecef0cf36feea13022f4786881cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/f3659f9cecef0cf36feea13022f4786881cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/f3659f9cecef0cf36feea13022f4786881cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/c0d3c192c33c54e978f01ec49690265481cd4e2091\\/640&quot;,&quot;ctime&quot;:1411656581,&quot;filekey&quot;:&quot;c0d3c192c33c54e978f01ec49690265481cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/c0d3c192c33c54e978f01ec49690265481cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/c0d3c192c33c54e978f01ec49690265481cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/c0d3c192c33c54e978f01ec49690265481cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/288d4e40e8635b229c36c99c9869c50381cd4e2091\\/640&quot;,&quot;ctime&quot;:1411656541,&quot;filekey&quot;:&quot;288d4e40e8635b229c36c99c9869c50381cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/288d4e40e8635b229c36c99c9869c50381cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/288d4e40e8635b229c36c99c9869c50381cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/288d4e40e8635b229c36c99c9869c50381cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/115617c351047bef607a86f68373ee3581cd4e2091\\/640&quot;,&quot;ctime&quot;:1411656539,&quot;filekey&quot;:&quot;115617c351047bef607a86f68373ee3581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/115617c351047bef607a86f68373ee3581cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/115617c351047bef607a86f68373ee3581cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/115617c351047bef607a86f68373ee3581cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\\/640&quot;,&quot;ctime&quot;:1397190206,&quot;filekey&quot;:&quot;b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\\/640&quot;,&quot;ctime&quot;:1397190195,&quot;filekey&quot;:&quot;56bf5ea1f5096671cf365d56ab63ade781cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\\/640&quot;,&quot;ctime&quot;:1397190180,&quot;filekey&quot;:&quot;7acfe7c6c2e48b5b22de8e32086726d881cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/82f7911a6b9a458e6ced939223964b4581cd4e2091\\/640&quot;,&quot;ctime&quot;:1390318130,&quot;filekey&quot;:&quot;82f7911a6b9a458e6ced939223964b4581cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/82f7911a6b9a458e6ced939223964b4581cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/82f7911a6b9a458e6ced939223964b4581cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/82f7911a6b9a458e6ced939223964b4581cd4e2091\\/100&quot;},{&quot;burl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\\/640&quot;,&quot;ctime&quot;:1375022218,&quot;filekey&quot;:&quot;4a2e9886148db7689dcf88a9d128f72681cd4e2091&quot;,&quot;murl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\\/160&quot;,&quot;ourl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\\/0&quot;,&quot;surl&quot;:&quot;http:\\/\\/ugc.qpic.cn\\/mqq_photo\\/0\\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\\/100&quot;}],&quot;total&quot;:13,&quot;uin&quot;:123456789,&quot;uptime&quot;:1446960924},&quot;message&quot;:&quot;&quot;,&quot;subcode&quot;:0} 我们关注total和ourl字段就可以了，total表示照片总数，ourl表示原图，其它的url是缩放过的图 老规矩，你要查的qq号做个无BOM的utf-8编码的txt放同目录下，每个QQ号占一行，最后一个QQ号需要再加一个或多个空行，文件格式根据文件头智能识别 代码如下 # -*- coding: UTF-8 -*- import httplib2 import json import os import shutil import time import binascii dir=&#39;QQWallPhotos/&#39; try: os.makedirs(dir) # 建立相应的文件夹 except: shutil.rmtree(dir) # 无论文件夹是否为空都移除该文件夹 os.makedirs(dir) fp = open(&#39;qqlist.txt&#39;, &#39;r&#39;) qqlist = fp.readlines() for i in range(len(qqlist)): qqlist[i] = qqlist[i][:-1] fp.close() h = httplib2.Http(timeout=6) for target in qqlist: url = &#39;http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json&#39; if len(target) == 0 : # 防止因为出现空行删除所有照片 continue try: os.makedirs(dir + target) # 建立相应的文件夹 except : shutil.rmtree(dir + target) # 无论文件夹是否为空都移除该文件夹 os.makedirs(dir + target) print(u&#39;当前QQ：&#39; + target) url=url.replace(&#39;qqnumber&#39;,target) resp = None content = None for t1 in (1,6): try: resp, content = h.request(url) break except: print(&quot;-----socket timout:&quot;,url) continue print content try: output = json.loads(content) # json字符串转字典 except: break # json字符串转字典出现异常，退出循环 print output if output[&#39;code&#39;] != 0 : # 返回结果异常，退出本次循环 continue total = output[&#39;data&#39;][&#39;total&#39;] # 照片墙总数，如果为0表示没有照片 print total if total != 0 : for i in range(0, len(output[&#39;data&#39;][&#39;photo_list&#39;])): ctime = output[&#39;data&#39;][&#39;photo_list&#39;][i][&#39;ctime&#39;] filename = time.strftime(&quot;%Y%m%d%H%M%S&quot;,time.localtime(ctime)) url = output[&#39;data&#39;][&#39;photo_list&#39;][i][&#39;ourl&#39;] print url resp = None content = None for t2 in (1,6): try: resp, content = h.request(url) break except: print(&quot;-----socket timout:&quot;,url) continue fmt = binascii.b2a_hex(content[0:4]) # 读取前4字节转化为16进制字符串 print fmt phototype = {&#39;47494638&#39;: &#39;.gif&#39;, &#39;ffd8ffe0&#39;: &#39;.jpg&#39;, &#39;ffd8ffe1&#39;: &#39;.jpg&#39;, &#39;ffd8ffdb&#39;: &#39;.jpg&#39;, &#39;89504e47&#39;: &#39;.png&#39;} # 智能识别文件格式 qualified_file_name = dir + target + &#39;/&#39; + filename + phototype[fmt] open(qualified_file_name, &#39;wb&#39;).write(content) if total == 0 : shutil.rmtree(dir + target) print(u&#39;下载完成&#39;) 更新1：增加ffd8ffdb的jpg格式 更新2：修复连接超时导致下载中断的异常 更新3：加入超时重发3次请求的机制，根据笔者监测到的情况，超时设为6秒时，超时一般出现在获取json的时候，笔者300好友数最多重发两次解决问题，总重发次数在10次以内 更新4：修复变量名命名不当以及变量未清空导致获取到上一次结果的问题 阅读更多","@type":"BlogPosting","url":"https://mlh.app/2015/11/27/74a9c92c62a4a9824364aa17a882c81b.html","headline":"Python2.7获取QQ照片墙","dateModified":"2015-11-27T00:00:00+08:00","datePublished":"2015-11-27T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://mlh.app/2015/11/27/74a9c92c62a4a9824364aa17a882c81b.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-3');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>Python2.7获取QQ照片墙</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/ck_htmledit_views-e2445db1a8.css"> 
 <div class="htmledit_views"> 
  <p>通过wireshark抓电脑版QQ的http数据包得到的结果<br></p> 
  <p>接口调用：</p> 
  <p>http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json</p> 
  <p>现在照片墙还没有上限，你可以将num=400改得尽量大，接口中的uin表示你自己的QQ，g_tk需要计算得出，实际上这两个参数服务器不会校验，可以任意取，也不需要带cookies</p> 
  <p>如果没有照片返回结果是这样的</p> 
  <p></p> 
  <pre><code class="language-plain">{"code":0,"data":{"next_offset":-1,"total":0,"uin":123456789,"uptime":1397711082},"message":"","subcode":0}</code></pre>如果有照片，返回结果是这样的 
  <p></p> 
  <p></p> 
  <pre><code class="language-plain">{"code":0,"data":{"next_offset":-1,"photo_list":[{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/640","ctime":1446960924,"filekey":"44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/44c23f8ad0f5d5e0c15fcf39d14267e081cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/640","ctime":1446960912,"filekey":"e1a706fd3d78430d5c0e3d46ae76770581cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/e1a706fd3d78430d5c0e3d46ae76770581cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/640","ctime":1446960903,"filekey":"1b3740ab132fec2567d281a6ae4ce65b81cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/1b3740ab132fec2567d281a6ae4ce65b81cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/640","ctime":1412657386,"filekey":"bf318cb2191b3a6300acf8cde68f21c681cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/bf318cb2191b3a6300acf8cde68f21c681cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/640","ctime":1411656582,"filekey":"f3659f9cecef0cf36feea13022f4786881cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/f3659f9cecef0cf36feea13022f4786881cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/640","ctime":1411656581,"filekey":"c0d3c192c33c54e978f01ec49690265481cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/c0d3c192c33c54e978f01ec49690265481cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/640","ctime":1411656541,"filekey":"288d4e40e8635b229c36c99c9869c50381cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/288d4e40e8635b229c36c99c9869c50381cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/640","ctime":1411656539,"filekey":"115617c351047bef607a86f68373ee3581cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/115617c351047bef607a86f68373ee3581cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/640","ctime":1397190206,"filekey":"b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/b6e7e988888ace6b4d12d7ffc32f2ca781cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/640","ctime":1397190195,"filekey":"56bf5ea1f5096671cf365d56ab63ade781cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/56bf5ea1f5096671cf365d56ab63ade781cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/640","ctime":1397190180,"filekey":"7acfe7c6c2e48b5b22de8e32086726d881cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/7acfe7c6c2e48b5b22de8e32086726d881cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/640","ctime":1390318130,"filekey":"82f7911a6b9a458e6ced939223964b4581cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/82f7911a6b9a458e6ced939223964b4581cd4e2091\/100"},{"burl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/640","ctime":1375022218,"filekey":"4a2e9886148db7689dcf88a9d128f72681cd4e2091","murl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/160","ourl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/0","surl":"http:\/\/ugc.qpic.cn\/mqq_photo\/0\/4a2e9886148db7689dcf88a9d128f72681cd4e2091\/100"}],"total":13,"uin":123456789,"uptime":1446960924},"message":"","subcode":0}
</code></pre>我们关注total和ourl字段就可以了，total表示照片总数，ourl表示原图，其它的url是缩放过的图 
  <p></p> 
  <p>老规矩，你要查的qq号做个无BOM的utf-8编码的txt放同目录下，每个QQ号占一行，最后一个QQ号需要再加一个或多个空行，文件格式根据文件头智能识别<br></p> 
  <p>代码如下</p> 
  <p></p>
  <pre><code class="language-python"># -*- coding: UTF-8 -*-
import httplib2
import json
import os
import shutil
import time
import binascii

dir='QQWallPhotos/'  
try:  
    os.makedirs(dir)  # 建立相应的文件夹  
except:  
    shutil.rmtree(dir)  # 无论文件夹是否为空都移除该文件夹  
    os.makedirs(dir)  
  
fp = open('qqlist.txt', 'r')  
qqlist = fp.readlines() 

for i in range(len(qqlist)):  
    qqlist[i] = qqlist[i][:-1]  
fp.close()  

h = httplib2.Http(timeout=6) 
for target in qqlist:
    
    url = 'http://taotao.qq.com/cgi-bin/photo_wall_cgi_list?uin=10001&amp;g_tk=112308395&amp;hostUin=qqnumber&amp;pos=0&amp;num=400&amp;lastfilekey=&amp;lasttime=0&amp;photo_source=1&amp;requester=1&amp;format=json' 
    if len(target) == 0 :  # 防止因为出现空行删除所有照片  
        continue
    try:  
        os.makedirs(dir + target)  # 建立相应的文件夹  
    except :  
        shutil.rmtree(dir + target)  # 无论文件夹是否为空都移除该文件夹  
        os.makedirs(dir + target)    
    print(u'当前QQ：' + target)  
    url=url.replace('qqnumber',target) 
    resp = None
    content = None
    for t1 in (1,6):
        try:
            resp, content = h.request(url)
            break
        except:
            print("-----socket timout:",url)
            continue
    print content
    try:
        output = json.loads(content)  # json字符串转字典
    except:
        break # json字符串转字典出现异常，退出循环
    print output 
    if output['code'] != 0 :  # 返回结果异常，退出本次循环 
        continue   
    total = output['data']['total'] # 照片墙总数，如果为0表示没有照片
    print total
    if total != 0 :
        for i in range(0, len(output['data']['photo_list'])): 
            ctime = output['data']['photo_list'][i]['ctime']
            filename =  time.strftime("%Y%m%d%H%M%S",time.localtime(ctime))
            url =  output['data']['photo_list'][i]['ourl']
            print url
            resp = None
            content = None            
            for t2 in (1,6):
                try:
                    resp, content = h.request(url)
                    break
                except:
                    print("-----socket timout:",url)
                    continue                
            fmt = binascii.b2a_hex(content[0:4]) # 读取前4字节转化为16进制字符串
            print fmt  
            phototype = {'47494638': '.gif', 'ffd8ffe0': '.jpg', 'ffd8ffe1': '.jpg', 'ffd8ffdb': '.jpg', '89504e47': '.png'}  # 智能识别文件格式             
            qualified_file_name = dir + target + '/' + filename + phototype[fmt]  
            open(qualified_file_name, 'wb').write(content)
    if total == 0 :
        shutil.rmtree(dir + target)
print(u'下载完成') 


</code></pre>
  <br> 更新1：增加ffd8ffdb的jpg格式
  <br>
  <p>更新2：修复连接超时导致下载中断的异常</p> 
  <p>更新3：加入超时重发3次请求的机制，根据笔者监测到的情况，超时设为6秒时，超时一般出现在获取json的时候，笔者300好友数最多重发两次解决问题，总重发次数在10次以内</p> 
  <p>更新4：修复变量名命名不当以及变量未清空导致获取到上一次结果的问题<br></p> 
  <p></p> 
 </div> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/gsls200808/article/details/50067981,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/gsls200808/article/details/50067981,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?0d1dbe5a3e5863242418b768d1601633";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
