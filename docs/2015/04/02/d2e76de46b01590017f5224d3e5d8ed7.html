<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Docker实践9：备份方案 | 有组织在！</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Docker实践9：备份方案" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="1 两个文件系统 先提一下两个重要的文件系统概念，一个是aufs，一个是vfs. aufs是一个类似于Unionfs的可堆叠联合文件系统。它将多个目录整合成单一的目录。ubuntu对其有良好的支持，因此docker的镜像就存储在aufs文件系统下。 vfs是linux的内核中一个重要概念，这个虚拟文件系统可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型就可以工作的粘合层。 2 docker镜像与容器的存储 docker的层次结构如上图。 docker安装在/var/lib/docker目录，来这里访问需要root权限。 /var/lib/docker# du -sh * 1.8G aufs 80K containers 36K execdriver 452K graph 15M init 8.0K linkgraph.db 4.0K repositories-aufs 240M tmp 8.0K trust 203M vfs 28K volumes 从文件夹大小就可以看出aufs和vfs是实际存东西的，在最开始的时候，我的只把重点放在了aufs上。 当前有两个docker镜像，使用docker-compose部署的mediawiki。 # docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE mysql 5.7.5 c171a2256c3b 3 weeks ago 322.8 MB nickstenning/mediawiki latest d32d732341b0 16 months ago 619.5 MB 与之对应的repositories-aufs如下： /var/lib/docker# cat repositories-aufs | python -mjson.tool { &quot;Repositories&quot;: { &quot;mysql&quot;: { &quot;5.7.5&quot;: &quot;c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366&quot; }, &quot;nickstenning/mediawiki&quot;: { &quot;latest&quot;: &quot;d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b&quot; } } } 趁着tree参数可用，我们来看看images的层级结构： # docker images -tree Warning: &#39;-tree&#39; is deprecated, it will be removed soon. See usage. ├─511136ea3c5a Virtual Size: 0 B │ └─36669626e49c Virtual Size: 84.98 MB │ └─d5570ef1464a Virtual Size: 84.98 MB │ └─170ff2cfa64a Virtual Size: 85.3 MB │ └─ef7c16d26957 Virtual Size: 116.7 MB │ └─3749ee37c2a6 Virtual Size: 116.8 MB │ └─5431d6b9bc80 Virtual Size: 116.8 MB │ └─0dc7d8240120 Virtual Size: 116.8 MB │ └─a37379b8d1ce Virtual Size: 116.8 MB │ └─cad6baf3ee5b Virtual Size: 322.8 MB │ └─facdf8305638 Virtual Size: 322.8 MB │ └─a10cdfaf13cf Virtual Size: 322.8 MB │ └─444b88bd8367 Virtual Size: 322.8 MB │ └─83dfd5776ff8 Virtual Size: 322.8 MB │ └─7d0b9c0b29d2 Virtual Size: 322.8 MB │ └─c171a2256c3b Virtual Size: 322.8 MB Tags: mysql:5.7.5 └─8dbd9e392a96 Virtual Size: 128 MB └─be647841828f Virtual Size: 128 MB └─7f06ad8f23b1 Virtual Size: 272.5 MB └─9fc1b767f7ff Virtual Size: 383.1 MB └─46af893ffb5f Virtual Size: 439.2 MB └─00a79ad7ea4a Virtual Size: 439.2 MB └─69f7b013792e Virtual Size: 439.2 MB └─854a5bd5be72 Virtual Size: 439.2 MB └─c219ca4d0d53 Virtual Size: 439.2 MB └─42c69a7e8ad3 Virtual Size: 439.2 MB └─09652ed5f7ef Virtual Size: 459.6 MB └─814a97e8dc1c Virtual Size: 539.6 MB └─a7bc400b42c2 Virtual Size: 539.6 MB └─68013db1eb6d Virtual Size: 619.5 MB └─ca839611a34f Virtual Size: 619.5 MB └─63e9d31943ea Virtual Size: 619.5 MB └─1b95e1c4efd9 Virtual Size: 619.5 MB └─9df1e07fdf78 Virtual Size: 619.5 MB └─3e8e8966dcfb Virtual Size: 619.5 MB └─3e0c3340e16e Virtual Size: 619.5 MB └─d32d732341b0 Virtual Size: 619.5 MB Tags: nickstenning/mediawiki:latest 再去看看graph目录： /var/lib/docker/graph# ls 00a79ad7ea4a77bac24386226563b86ee92db49073e6417ce10dbe175777b7ff 814a97e8dc1c5b86b3a4a21e2c64abac2e69ad1214f084c60e78b7b9b4d91e75 09652ed5f7efeb035c7f29e7fe16b600ff4066362ea95f678974d7940f89f021 83dfd5776ff844e112fa504701370e7a0e20ecdf43afc75cf9018f05c6e46699 0dc7d82401208db703d519db581d7dddb39a090e2bf0dd6b5a64dcf9a743e6aa 854a5bd5be7280e1a53d451e3806aaf202a4cfffdf1701cf10cd1036bccb6bdc 170ff2cfa64adbd757c0dad0c1cb4bbb61e11301a16cd8f29b40cb3217ec7254 8dbd9e392a964056420e5d58ca5cc376ef18e2de93b5cc90e868a1bbc8318c1c 1b95e1c4efd993116df499fa9951b865ec99e8a455427cffc9c61364bc3c5295 9df1e07fdf780918f8fafaba0f5470d1c6357232617e42b6d190383fd0710e37 36669626e49c623f3b2aea41052bbc9de0506807d92137bf76c0fd3264eaff34 9fc1b767f7ff6d935efd6e897882d202fcbd041a154c400b595b9e0f1b2092dc 3749ee37c2a6df4df9f720c7c07ecc5af695a2a5853bac1f8ba6450ddc310343 a10cdfaf13cf8dbaa07798f29265ec37a5bec4dc5f2b6f8c449edb2658b0a571 3e0c3340e16e991af227912b27441b392762476f15d6749c3c1333fab63c5927 a37379b8d1ce392404d50d97a02afb92bd774a45191b3dc98c512fa6af394335 3e8e8966dcfba21708e772ec165edcb617061028572e279decf7b374f4f3a866 a7bc400b42c28673642376884b7a8a93c76548198ebb4c4993a65cdfaf81ccd2 42c69a7e8ad3ba37bfddeaf52ea54381d487311ba5c75d6a91811abeaad8438b be647841828f846812df2968e24aa9db46c1a2033c0c60577e2b91fdcf7d4c09 444b88bd8367b8fc2d023b5ceb77cec3784963bbfc03d1d30f96b97a22cfbc44 c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366 46af893ffb5fe47b7de23a3f2f8972dbf51e78a0327ca46b7848c1cdfd48f97d c219ca4d0d536c79955628e17aa8d6e6b6a61bc50c486bcd304a70a790985627 511136ea3c5a64f264b78b5433614aec563103b4d4702f3ba7d4d2698e22c158 ca839611a34f4eb30e582694d9a1cdabf11d96b4c36bf69c1a82fb069ba0509a 5431d6b9bc80429667488287e8189cc4d4b14791e43e45b374e132e340fb15db cad6baf3ee5b2798947cdcfbdd3bf4c38c3f094bfbec876fb27da426528107fa 63e9d31943ea386e435763524d9ea3a8cb253747113abbb53191121b815572da d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b 68013db1eb6d12803db7cbb52e95e6f29c8141c095b8cb50d245925d7f70d774 d5570ef1464a43fe282dd2705b38a2d739812b0b8036a49cfa09811737cfbed4 69f7b013792e1f9c63176a7e348cb38277182f8bcf3d1d6d2c26ff9c4885b4ec ef7c16d26957dc5dea9ad23433c7dd6400ab0a1a5cf461a080312dfaea50eeee 7d0b9c0b29d271a8be6ca9252da15ae4f01dd386ac2b452563232aaaddd5eaf9 facdf830563864336b80233167577315520bca3fbbd86d8f995e40f0e81e238c 7f06ad8f23b10227423823e3acc7e368c012f41a30660c3fbad661a9a4f8fe67 _tmp 长id与tree的短id是对应的，这样就明晰了。在上文中给container传文件用到了神奇通道，其实就是aufs中的mnt。 备份方案 第一种情况，挂载host目录的，比如之前的hg-server。备份就很简单，直接把那些hg源码目录在host做备份即可。 第二种情况，需要在container中安装新软件。用export或者save命令吧。 sudo docker commit 9ab6e234c9ba linc-wiki sudo docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE linc-wiki latest b5a1e34b01c2 14 seconds ago 689.7 MB sudo docker export 9ab6e234c9ba &gt; /home/linc/docker/images-bk/linc-wiki-export.tar sudo docker save linc-wiki &gt; ../images-bk/linc-wiki-save.tar $ du -sh * 495M linc-wiki-export.tar 672M linc-wiki-save.tar sudo cat /home/linc/docker/images-bk/linc-wiki-export.tar | sudo docker import - docker_hgweb sudo docker load --input ../images-bk/linc-wiki-save.tar 第三种情况，mysql中的数据哪里去啦？ 这个问题困扰我几天了。就拿部署的mediawiki说吧，没有将数据文件链接到host中，而是放到了/var/lib/mysql中，如下： /var/lib/mysql# ls auto.cnf ib_logfile0 ib_logfile1 ibdata1 ibtmp1 my_wiki mysql performance_schema 我嘗試着新设置volume不过没有成功，也做了其他努力，都失败了。最后一次大搜索中，发现这些数据文件被放在了vfs中。 /var/lib/docker/vfs# tree -L 3 . └── dir └── cb4012594631102fc8a69aa6cb4a9aa2dd2be3d39d2564c94ae91ac5e3eb4aec ├── auto.cnf ├── ibdata1 ├── ib_logfile0 ├── ib_logfile1 ├── ibtmp1 ├── mysql ├── my_wiki └── performance_schema 5 directories, 5 files 尝试了将其放入我的ubuntu server虚拟机中的docker相同目录下，mediawiki用host中save后的镜像，我的mediawiki在ubuntu server虚拟机中完美复活！ 也就是说，我只需要备份host系统中docker下的vfs的数据就可以了。问题解决，可以肆意在wiki中添加重要内容而不担心被毁掉了。 参考： http://www.programfish.com/blog/?p=9 http://blog.csdn.net/junjun16818/article/details/38423391 gitlab的维护：http://www.tuicool.com/articles/bYbi2mJ 阅读更多" />
<meta property="og:description" content="1 两个文件系统 先提一下两个重要的文件系统概念，一个是aufs，一个是vfs. aufs是一个类似于Unionfs的可堆叠联合文件系统。它将多个目录整合成单一的目录。ubuntu对其有良好的支持，因此docker的镜像就存储在aufs文件系统下。 vfs是linux的内核中一个重要概念，这个虚拟文件系统可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型就可以工作的粘合层。 2 docker镜像与容器的存储 docker的层次结构如上图。 docker安装在/var/lib/docker目录，来这里访问需要root权限。 /var/lib/docker# du -sh * 1.8G aufs 80K containers 36K execdriver 452K graph 15M init 8.0K linkgraph.db 4.0K repositories-aufs 240M tmp 8.0K trust 203M vfs 28K volumes 从文件夹大小就可以看出aufs和vfs是实际存东西的，在最开始的时候，我的只把重点放在了aufs上。 当前有两个docker镜像，使用docker-compose部署的mediawiki。 # docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE mysql 5.7.5 c171a2256c3b 3 weeks ago 322.8 MB nickstenning/mediawiki latest d32d732341b0 16 months ago 619.5 MB 与之对应的repositories-aufs如下： /var/lib/docker# cat repositories-aufs | python -mjson.tool { &quot;Repositories&quot;: { &quot;mysql&quot;: { &quot;5.7.5&quot;: &quot;c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366&quot; }, &quot;nickstenning/mediawiki&quot;: { &quot;latest&quot;: &quot;d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b&quot; } } } 趁着tree参数可用，我们来看看images的层级结构： # docker images -tree Warning: &#39;-tree&#39; is deprecated, it will be removed soon. See usage. ├─511136ea3c5a Virtual Size: 0 B │ └─36669626e49c Virtual Size: 84.98 MB │ └─d5570ef1464a Virtual Size: 84.98 MB │ └─170ff2cfa64a Virtual Size: 85.3 MB │ └─ef7c16d26957 Virtual Size: 116.7 MB │ └─3749ee37c2a6 Virtual Size: 116.8 MB │ └─5431d6b9bc80 Virtual Size: 116.8 MB │ └─0dc7d8240120 Virtual Size: 116.8 MB │ └─a37379b8d1ce Virtual Size: 116.8 MB │ └─cad6baf3ee5b Virtual Size: 322.8 MB │ └─facdf8305638 Virtual Size: 322.8 MB │ └─a10cdfaf13cf Virtual Size: 322.8 MB │ └─444b88bd8367 Virtual Size: 322.8 MB │ └─83dfd5776ff8 Virtual Size: 322.8 MB │ └─7d0b9c0b29d2 Virtual Size: 322.8 MB │ └─c171a2256c3b Virtual Size: 322.8 MB Tags: mysql:5.7.5 └─8dbd9e392a96 Virtual Size: 128 MB └─be647841828f Virtual Size: 128 MB └─7f06ad8f23b1 Virtual Size: 272.5 MB └─9fc1b767f7ff Virtual Size: 383.1 MB └─46af893ffb5f Virtual Size: 439.2 MB └─00a79ad7ea4a Virtual Size: 439.2 MB └─69f7b013792e Virtual Size: 439.2 MB └─854a5bd5be72 Virtual Size: 439.2 MB └─c219ca4d0d53 Virtual Size: 439.2 MB └─42c69a7e8ad3 Virtual Size: 439.2 MB └─09652ed5f7ef Virtual Size: 459.6 MB └─814a97e8dc1c Virtual Size: 539.6 MB └─a7bc400b42c2 Virtual Size: 539.6 MB └─68013db1eb6d Virtual Size: 619.5 MB └─ca839611a34f Virtual Size: 619.5 MB └─63e9d31943ea Virtual Size: 619.5 MB └─1b95e1c4efd9 Virtual Size: 619.5 MB └─9df1e07fdf78 Virtual Size: 619.5 MB └─3e8e8966dcfb Virtual Size: 619.5 MB └─3e0c3340e16e Virtual Size: 619.5 MB └─d32d732341b0 Virtual Size: 619.5 MB Tags: nickstenning/mediawiki:latest 再去看看graph目录： /var/lib/docker/graph# ls 00a79ad7ea4a77bac24386226563b86ee92db49073e6417ce10dbe175777b7ff 814a97e8dc1c5b86b3a4a21e2c64abac2e69ad1214f084c60e78b7b9b4d91e75 09652ed5f7efeb035c7f29e7fe16b600ff4066362ea95f678974d7940f89f021 83dfd5776ff844e112fa504701370e7a0e20ecdf43afc75cf9018f05c6e46699 0dc7d82401208db703d519db581d7dddb39a090e2bf0dd6b5a64dcf9a743e6aa 854a5bd5be7280e1a53d451e3806aaf202a4cfffdf1701cf10cd1036bccb6bdc 170ff2cfa64adbd757c0dad0c1cb4bbb61e11301a16cd8f29b40cb3217ec7254 8dbd9e392a964056420e5d58ca5cc376ef18e2de93b5cc90e868a1bbc8318c1c 1b95e1c4efd993116df499fa9951b865ec99e8a455427cffc9c61364bc3c5295 9df1e07fdf780918f8fafaba0f5470d1c6357232617e42b6d190383fd0710e37 36669626e49c623f3b2aea41052bbc9de0506807d92137bf76c0fd3264eaff34 9fc1b767f7ff6d935efd6e897882d202fcbd041a154c400b595b9e0f1b2092dc 3749ee37c2a6df4df9f720c7c07ecc5af695a2a5853bac1f8ba6450ddc310343 a10cdfaf13cf8dbaa07798f29265ec37a5bec4dc5f2b6f8c449edb2658b0a571 3e0c3340e16e991af227912b27441b392762476f15d6749c3c1333fab63c5927 a37379b8d1ce392404d50d97a02afb92bd774a45191b3dc98c512fa6af394335 3e8e8966dcfba21708e772ec165edcb617061028572e279decf7b374f4f3a866 a7bc400b42c28673642376884b7a8a93c76548198ebb4c4993a65cdfaf81ccd2 42c69a7e8ad3ba37bfddeaf52ea54381d487311ba5c75d6a91811abeaad8438b be647841828f846812df2968e24aa9db46c1a2033c0c60577e2b91fdcf7d4c09 444b88bd8367b8fc2d023b5ceb77cec3784963bbfc03d1d30f96b97a22cfbc44 c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366 46af893ffb5fe47b7de23a3f2f8972dbf51e78a0327ca46b7848c1cdfd48f97d c219ca4d0d536c79955628e17aa8d6e6b6a61bc50c486bcd304a70a790985627 511136ea3c5a64f264b78b5433614aec563103b4d4702f3ba7d4d2698e22c158 ca839611a34f4eb30e582694d9a1cdabf11d96b4c36bf69c1a82fb069ba0509a 5431d6b9bc80429667488287e8189cc4d4b14791e43e45b374e132e340fb15db cad6baf3ee5b2798947cdcfbdd3bf4c38c3f094bfbec876fb27da426528107fa 63e9d31943ea386e435763524d9ea3a8cb253747113abbb53191121b815572da d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b 68013db1eb6d12803db7cbb52e95e6f29c8141c095b8cb50d245925d7f70d774 d5570ef1464a43fe282dd2705b38a2d739812b0b8036a49cfa09811737cfbed4 69f7b013792e1f9c63176a7e348cb38277182f8bcf3d1d6d2c26ff9c4885b4ec ef7c16d26957dc5dea9ad23433c7dd6400ab0a1a5cf461a080312dfaea50eeee 7d0b9c0b29d271a8be6ca9252da15ae4f01dd386ac2b452563232aaaddd5eaf9 facdf830563864336b80233167577315520bca3fbbd86d8f995e40f0e81e238c 7f06ad8f23b10227423823e3acc7e368c012f41a30660c3fbad661a9a4f8fe67 _tmp 长id与tree的短id是对应的，这样就明晰了。在上文中给container传文件用到了神奇通道，其实就是aufs中的mnt。 备份方案 第一种情况，挂载host目录的，比如之前的hg-server。备份就很简单，直接把那些hg源码目录在host做备份即可。 第二种情况，需要在container中安装新软件。用export或者save命令吧。 sudo docker commit 9ab6e234c9ba linc-wiki sudo docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE linc-wiki latest b5a1e34b01c2 14 seconds ago 689.7 MB sudo docker export 9ab6e234c9ba &gt; /home/linc/docker/images-bk/linc-wiki-export.tar sudo docker save linc-wiki &gt; ../images-bk/linc-wiki-save.tar $ du -sh * 495M linc-wiki-export.tar 672M linc-wiki-save.tar sudo cat /home/linc/docker/images-bk/linc-wiki-export.tar | sudo docker import - docker_hgweb sudo docker load --input ../images-bk/linc-wiki-save.tar 第三种情况，mysql中的数据哪里去啦？ 这个问题困扰我几天了。就拿部署的mediawiki说吧，没有将数据文件链接到host中，而是放到了/var/lib/mysql中，如下： /var/lib/mysql# ls auto.cnf ib_logfile0 ib_logfile1 ibdata1 ibtmp1 my_wiki mysql performance_schema 我嘗試着新设置volume不过没有成功，也做了其他努力，都失败了。最后一次大搜索中，发现这些数据文件被放在了vfs中。 /var/lib/docker/vfs# tree -L 3 . └── dir └── cb4012594631102fc8a69aa6cb4a9aa2dd2be3d39d2564c94ae91ac5e3eb4aec ├── auto.cnf ├── ibdata1 ├── ib_logfile0 ├── ib_logfile1 ├── ibtmp1 ├── mysql ├── my_wiki └── performance_schema 5 directories, 5 files 尝试了将其放入我的ubuntu server虚拟机中的docker相同目录下，mediawiki用host中save后的镜像，我的mediawiki在ubuntu server虚拟机中完美复活！ 也就是说，我只需要备份host系统中docker下的vfs的数据就可以了。问题解决，可以肆意在wiki中添加重要内容而不担心被毁掉了。 参考： http://www.programfish.com/blog/?p=9 http://blog.csdn.net/junjun16818/article/details/38423391 gitlab的维护：http://www.tuicool.com/articles/bYbi2mJ 阅读更多" />
<meta property="og:site_name" content="有组织在！" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2015-04-02T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"1 两个文件系统 先提一下两个重要的文件系统概念，一个是aufs，一个是vfs. aufs是一个类似于Unionfs的可堆叠联合文件系统。它将多个目录整合成单一的目录。ubuntu对其有良好的支持，因此docker的镜像就存储在aufs文件系统下。 vfs是linux的内核中一个重要概念，这个虚拟文件系统可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型就可以工作的粘合层。 2 docker镜像与容器的存储 docker的层次结构如上图。 docker安装在/var/lib/docker目录，来这里访问需要root权限。 /var/lib/docker# du -sh * 1.8G aufs 80K containers 36K execdriver 452K graph 15M init 8.0K linkgraph.db 4.0K repositories-aufs 240M tmp 8.0K trust 203M vfs 28K volumes 从文件夹大小就可以看出aufs和vfs是实际存东西的，在最开始的时候，我的只把重点放在了aufs上。 当前有两个docker镜像，使用docker-compose部署的mediawiki。 # docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE mysql 5.7.5 c171a2256c3b 3 weeks ago 322.8 MB nickstenning/mediawiki latest d32d732341b0 16 months ago 619.5 MB 与之对应的repositories-aufs如下： /var/lib/docker# cat repositories-aufs | python -mjson.tool { &quot;Repositories&quot;: { &quot;mysql&quot;: { &quot;5.7.5&quot;: &quot;c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366&quot; }, &quot;nickstenning/mediawiki&quot;: { &quot;latest&quot;: &quot;d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b&quot; } } } 趁着tree参数可用，我们来看看images的层级结构： # docker images -tree Warning: &#39;-tree&#39; is deprecated, it will be removed soon. See usage. ├─511136ea3c5a Virtual Size: 0 B │ └─36669626e49c Virtual Size: 84.98 MB │ └─d5570ef1464a Virtual Size: 84.98 MB │ └─170ff2cfa64a Virtual Size: 85.3 MB │ └─ef7c16d26957 Virtual Size: 116.7 MB │ └─3749ee37c2a6 Virtual Size: 116.8 MB │ └─5431d6b9bc80 Virtual Size: 116.8 MB │ └─0dc7d8240120 Virtual Size: 116.8 MB │ └─a37379b8d1ce Virtual Size: 116.8 MB │ └─cad6baf3ee5b Virtual Size: 322.8 MB │ └─facdf8305638 Virtual Size: 322.8 MB │ └─a10cdfaf13cf Virtual Size: 322.8 MB │ └─444b88bd8367 Virtual Size: 322.8 MB │ └─83dfd5776ff8 Virtual Size: 322.8 MB │ └─7d0b9c0b29d2 Virtual Size: 322.8 MB │ └─c171a2256c3b Virtual Size: 322.8 MB Tags: mysql:5.7.5 └─8dbd9e392a96 Virtual Size: 128 MB └─be647841828f Virtual Size: 128 MB └─7f06ad8f23b1 Virtual Size: 272.5 MB └─9fc1b767f7ff Virtual Size: 383.1 MB └─46af893ffb5f Virtual Size: 439.2 MB └─00a79ad7ea4a Virtual Size: 439.2 MB └─69f7b013792e Virtual Size: 439.2 MB └─854a5bd5be72 Virtual Size: 439.2 MB └─c219ca4d0d53 Virtual Size: 439.2 MB └─42c69a7e8ad3 Virtual Size: 439.2 MB └─09652ed5f7ef Virtual Size: 459.6 MB └─814a97e8dc1c Virtual Size: 539.6 MB └─a7bc400b42c2 Virtual Size: 539.6 MB └─68013db1eb6d Virtual Size: 619.5 MB └─ca839611a34f Virtual Size: 619.5 MB └─63e9d31943ea Virtual Size: 619.5 MB └─1b95e1c4efd9 Virtual Size: 619.5 MB └─9df1e07fdf78 Virtual Size: 619.5 MB └─3e8e8966dcfb Virtual Size: 619.5 MB └─3e0c3340e16e Virtual Size: 619.5 MB └─d32d732341b0 Virtual Size: 619.5 MB Tags: nickstenning/mediawiki:latest 再去看看graph目录： /var/lib/docker/graph# ls 00a79ad7ea4a77bac24386226563b86ee92db49073e6417ce10dbe175777b7ff 814a97e8dc1c5b86b3a4a21e2c64abac2e69ad1214f084c60e78b7b9b4d91e75 09652ed5f7efeb035c7f29e7fe16b600ff4066362ea95f678974d7940f89f021 83dfd5776ff844e112fa504701370e7a0e20ecdf43afc75cf9018f05c6e46699 0dc7d82401208db703d519db581d7dddb39a090e2bf0dd6b5a64dcf9a743e6aa 854a5bd5be7280e1a53d451e3806aaf202a4cfffdf1701cf10cd1036bccb6bdc 170ff2cfa64adbd757c0dad0c1cb4bbb61e11301a16cd8f29b40cb3217ec7254 8dbd9e392a964056420e5d58ca5cc376ef18e2de93b5cc90e868a1bbc8318c1c 1b95e1c4efd993116df499fa9951b865ec99e8a455427cffc9c61364bc3c5295 9df1e07fdf780918f8fafaba0f5470d1c6357232617e42b6d190383fd0710e37 36669626e49c623f3b2aea41052bbc9de0506807d92137bf76c0fd3264eaff34 9fc1b767f7ff6d935efd6e897882d202fcbd041a154c400b595b9e0f1b2092dc 3749ee37c2a6df4df9f720c7c07ecc5af695a2a5853bac1f8ba6450ddc310343 a10cdfaf13cf8dbaa07798f29265ec37a5bec4dc5f2b6f8c449edb2658b0a571 3e0c3340e16e991af227912b27441b392762476f15d6749c3c1333fab63c5927 a37379b8d1ce392404d50d97a02afb92bd774a45191b3dc98c512fa6af394335 3e8e8966dcfba21708e772ec165edcb617061028572e279decf7b374f4f3a866 a7bc400b42c28673642376884b7a8a93c76548198ebb4c4993a65cdfaf81ccd2 42c69a7e8ad3ba37bfddeaf52ea54381d487311ba5c75d6a91811abeaad8438b be647841828f846812df2968e24aa9db46c1a2033c0c60577e2b91fdcf7d4c09 444b88bd8367b8fc2d023b5ceb77cec3784963bbfc03d1d30f96b97a22cfbc44 c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366 46af893ffb5fe47b7de23a3f2f8972dbf51e78a0327ca46b7848c1cdfd48f97d c219ca4d0d536c79955628e17aa8d6e6b6a61bc50c486bcd304a70a790985627 511136ea3c5a64f264b78b5433614aec563103b4d4702f3ba7d4d2698e22c158 ca839611a34f4eb30e582694d9a1cdabf11d96b4c36bf69c1a82fb069ba0509a 5431d6b9bc80429667488287e8189cc4d4b14791e43e45b374e132e340fb15db cad6baf3ee5b2798947cdcfbdd3bf4c38c3f094bfbec876fb27da426528107fa 63e9d31943ea386e435763524d9ea3a8cb253747113abbb53191121b815572da d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b 68013db1eb6d12803db7cbb52e95e6f29c8141c095b8cb50d245925d7f70d774 d5570ef1464a43fe282dd2705b38a2d739812b0b8036a49cfa09811737cfbed4 69f7b013792e1f9c63176a7e348cb38277182f8bcf3d1d6d2c26ff9c4885b4ec ef7c16d26957dc5dea9ad23433c7dd6400ab0a1a5cf461a080312dfaea50eeee 7d0b9c0b29d271a8be6ca9252da15ae4f01dd386ac2b452563232aaaddd5eaf9 facdf830563864336b80233167577315520bca3fbbd86d8f995e40f0e81e238c 7f06ad8f23b10227423823e3acc7e368c012f41a30660c3fbad661a9a4f8fe67 _tmp 长id与tree的短id是对应的，这样就明晰了。在上文中给container传文件用到了神奇通道，其实就是aufs中的mnt。 备份方案 第一种情况，挂载host目录的，比如之前的hg-server。备份就很简单，直接把那些hg源码目录在host做备份即可。 第二种情况，需要在container中安装新软件。用export或者save命令吧。 sudo docker commit 9ab6e234c9ba linc-wiki sudo docker images REPOSITORY TAG IMAGE ID CREATED VIRTUAL SIZE linc-wiki latest b5a1e34b01c2 14 seconds ago 689.7 MB sudo docker export 9ab6e234c9ba &gt; /home/linc/docker/images-bk/linc-wiki-export.tar sudo docker save linc-wiki &gt; ../images-bk/linc-wiki-save.tar $ du -sh * 495M linc-wiki-export.tar 672M linc-wiki-save.tar sudo cat /home/linc/docker/images-bk/linc-wiki-export.tar | sudo docker import - docker_hgweb sudo docker load --input ../images-bk/linc-wiki-save.tar 第三种情况，mysql中的数据哪里去啦？ 这个问题困扰我几天了。就拿部署的mediawiki说吧，没有将数据文件链接到host中，而是放到了/var/lib/mysql中，如下： /var/lib/mysql# ls auto.cnf ib_logfile0 ib_logfile1 ibdata1 ibtmp1 my_wiki mysql performance_schema 我嘗試着新设置volume不过没有成功，也做了其他努力，都失败了。最后一次大搜索中，发现这些数据文件被放在了vfs中。 /var/lib/docker/vfs# tree -L 3 . └── dir └── cb4012594631102fc8a69aa6cb4a9aa2dd2be3d39d2564c94ae91ac5e3eb4aec ├── auto.cnf ├── ibdata1 ├── ib_logfile0 ├── ib_logfile1 ├── ibtmp1 ├── mysql ├── my_wiki └── performance_schema 5 directories, 5 files 尝试了将其放入我的ubuntu server虚拟机中的docker相同目录下，mediawiki用host中save后的镜像，我的mediawiki在ubuntu server虚拟机中完美复活！ 也就是说，我只需要备份host系统中docker下的vfs的数据就可以了。问题解决，可以肆意在wiki中添加重要内容而不担心被毁掉了。 参考： http://www.programfish.com/blog/?p=9 http://blog.csdn.net/junjun16818/article/details/38423391 gitlab的维护：http://www.tuicool.com/articles/bYbi2mJ 阅读更多","@type":"BlogPosting","url":"/2015/04/02/d2e76de46b01590017f5224d3e5d8ed7.html","headline":"Docker实践9：备份方案","dateModified":"2015-04-02T00:00:00+08:00","datePublished":"2015-04-02T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/2015/04/02/d2e76de46b01590017f5224d3e5d8ed7.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script src="/assets/js/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-123344652-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-123344652-1');
    </script>
    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8889449066804352",
        enable_page_level_ads: true
      });
    </script>
    
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
    
    <style>
      @media screen and (max-width:760px){
        .sm-hidden{display:none; }
      }
    </style>

  </head>
  <body>
    
        <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-8889449066804352">
        </amp-auto-ads>
    
    <div class="wrapper">
      <header  class="without-description" >
        <h1>Docker实践9：备份方案</h1>
        
        
        <ul>
            <li><a href="https://uzshare.com/" style="line-height: unset;" target="_blank"><strong>柚子社区</strong></a></li>
        </ul>
        
        
        
      </header>
      <section>

<div style="margin:0 0 8px 0;">
<style>
table.gsc-input {
    margin: 0;
}
.cse .gsc-control-cse, .gsc-control-cse {
    padding: 0;
    width: auto;
}
.gsc-search-box td {
    border-bottom: none;
}
</style>
<script>
  (function() {
    var cx = '004431708863642777669:qan2_6ugotw';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>
<gcse:search></gcse:search>
</div>
	

        <div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h1 id="1-两个文件系统">1 两个文件系统</h1> 
  <p>先提一下两个重要的文件系统概念，一个是aufs，一个是vfs.</p> 
  <p>aufs是一个类似于Unionfs的可堆叠联合文件系统。它将多个目录整合成单一的目录。ubuntu对其有良好的支持，因此docker的镜像就存储在aufs文件系统下。</p> 
  <p>vfs是linux的内核中一个重要概念，这个虚拟文件系统可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型就可以工作的粘合层。</p> 
  <h1 id="2-docker镜像与容器的存储">2 docker镜像与容器的存储</h1> 
  <p><img src="https://img-blog.csdn.net/20150402184552662" alt="这里写图片描述" title=""> <br> docker的层次结构如上图。 <br> docker安装在/var/lib/docker目录，来这里访问需要root权限。</p> 
  <pre class="prettyprint"><code class=" hljs mathematica">/var/lib/docker# du -sh *
<span class="hljs-number">1.8</span>G    aufs
<span class="hljs-number">80</span><span class="hljs-keyword">K</span> containers
<span class="hljs-number">36</span><span class="hljs-keyword">K</span> execdriver
<span class="hljs-number">452</span><span class="hljs-keyword">K</span>    graph
<span class="hljs-number">15</span>M init
<span class="hljs-number">8.0</span><span class="hljs-keyword">K</span>    linkgraph.db
<span class="hljs-number">4.0</span><span class="hljs-keyword">K</span>    repositories-aufs
<span class="hljs-number">240</span>M    tmp
<span class="hljs-number">8.0</span><span class="hljs-keyword">K</span>    trust
<span class="hljs-number">203</span>M    vfs
<span class="hljs-number">28</span><span class="hljs-keyword">K</span> volumes</code></pre> 
  <p>从文件夹大小就可以看出aufs和vfs是实际存东西的，在最开始的时候，我的只把重点放在了aufs上。</p> 
  <p>当前有两个docker镜像，使用docker-compose部署的mediawiki。</p> 
  <pre class="prettyprint"><code class=" hljs vala"><span class="hljs-preprocessor"># docker images</span>
REPOSITORY              <span class="hljs-constant"> TAG </span>               <span class="hljs-constant"> IMAGE </span>ID           <span class="hljs-constant"> CREATED </span>           <span class="hljs-constant"> VIRTUAL </span>SIZE
mysql                    <span class="hljs-number">5.7</span><span class="hljs-number">.5</span>               c171a2256c3b        <span class="hljs-number">3</span> weeks ago         <span class="hljs-number">322.8</span> MB
nickstenning/mediawiki   latest              d32d732341b0        <span class="hljs-number">16</span> months ago       <span class="hljs-number">619.5</span> MB
</code></pre> 
  <p>与之对应的repositories-aufs如下：</p> 
  <pre class="prettyprint"><code class=" hljs cs">/<span class="hljs-keyword">var</span>/lib/docker<span class="hljs-preprocessor"># cat repositories-aufs | python -mjson.tool</span>
{
    <span class="hljs-string">"Repositories"</span>: {
        <span class="hljs-string">"mysql"</span>: {
            <span class="hljs-string">"5.7.5"</span>: <span class="hljs-string">"c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366"</span>
        },
        <span class="hljs-string">"nickstenning/mediawiki"</span>: {
            <span class="hljs-string">"latest"</span>: <span class="hljs-string">"d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b"</span>
        }
    }
}
</code></pre> 
  <p>趁着tree参数可用，我们来看看images的层级结构：</p> 
  <pre class="prettyprint"><code class=" hljs oxygene"># docker images -tree
Warning: <span class="hljs-string">'-tree'</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">deprecated</span>, it will be removed soon. See usage.
├─<span class="hljs-number">511136</span>ea3c5a <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">0</span> B
│ └─<span class="hljs-number">36669626</span>e49c <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">84.98</span> MB
│   └─d5570ef1464a <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">84.98</span> MB
│     └─<span class="hljs-number">170</span>ff2cfa64a <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">85.3</span> MB
│       └─ef7c16d26957 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">116.7</span> MB
│         └─<span class="hljs-number">3749</span>ee37c2a6 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">116.8</span> MB
│           └─<span class="hljs-number">5431</span>d6b9bc80 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">116.8</span> MB
│             └─<span class="hljs-number">0</span>dc7d8240120 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">116.8</span> MB
│               └─a37379b8d1ce <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">116.8</span> MB
│                 └─cad6baf3ee5b <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB
│                   └─facdf8305638 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB
│                     └─a10cdfaf13cf <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB
│                       └─<span class="hljs-number">444</span>b88bd8367 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB
│                         └─<span class="hljs-number">83</span>dfd5776ff8 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB
│                           └─<span class="hljs-number">7</span>d0b9c0b29d2 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB
│                             └─c171a2256c3b <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">322.8</span> MB Tags: mysql:<span class="hljs-number">5.7</span>.<span class="hljs-number">5</span>
└─<span class="hljs-number">8</span>dbd9e392a96 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">128</span> MB
  └─be647841828f <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">128</span> MB
    └─<span class="hljs-number">7</span>f06ad8f23b1 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">272.5</span> MB
      └─<span class="hljs-number">9</span>fc1b767f7ff <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">383.1</span> MB
        └─<span class="hljs-number">46</span>af893ffb5f <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">439.2</span> MB
          └─<span class="hljs-number">00</span>a79ad7ea4a <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">439.2</span> MB
            └─<span class="hljs-number">69</span>f7b013792e <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">439.2</span> MB
              └─<span class="hljs-number">854</span>a5bd5be72 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">439.2</span> MB
                └─c219ca4d0d53 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">439.2</span> MB
                  └─<span class="hljs-number">42</span>c69a7e8ad3 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">439.2</span> MB
                    └─<span class="hljs-number">09652</span>ed5f7ef <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">459.6</span> MB
                      └─<span class="hljs-number">814</span>a97e8dc1c <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">539.6</span> MB
                        └─a7bc400b42c2 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">539.6</span> MB
                          └─<span class="hljs-number">68013</span>db1eb6d <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                            └─ca839611a34f <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                              └─<span class="hljs-number">63</span>e9d31943ea <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                                └─<span class="hljs-number">1</span>b95e1c4efd9 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                                  └─<span class="hljs-number">9</span>df1e07fdf78 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                                    └─<span class="hljs-number">3</span>e8e8966dcfb <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                                      └─<span class="hljs-number">3</span>e0c3340e16e <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB
                                        └─d32d732341b0 <span class="hljs-keyword">Virtual</span> Size: <span class="hljs-number">619.5</span> MB Tags: nickstenning/mediawiki:latest
</code></pre> 
  <p>再去看看graph目录：</p> 
  <pre class="prettyprint"><code class=" hljs cpp">/var/lib/docker/graph<span class="hljs-preprocessor"># ls</span>
<span class="hljs-number">00</span>a79ad7ea4a77bac24386226563b86ee92db49073e6417ce10dbe175777b7ff  <span class="hljs-number">814</span>a97e8dc1c5b86b3a4a21e2c64abac2e69ad1214f084c60e78b7b9b4d91e75
<span class="hljs-number">09652</span>ed5f7efeb035c7f29e7fe16b600ff4066362ea95f678974d7940f89f021  <span class="hljs-number">83</span>dfd5776ff844e112fa504701370e7a0e20ecdf43afc75cf9018f05c6e46699
<span class="hljs-number">0</span>dc7d82401208db703d519db581d7dddb39a090e2bf0dd6b5a64dcf9a743e6aa  <span class="hljs-number">854</span>a5bd5be7280e1a53d451e3806aaf202a4cfffdf1701cf10cd1036bccb6bdc
<span class="hljs-number">170f</span>f2cfa64adbd757c0dad0c1cb4bbb61e11301a16cd8f29b40cb3217ec7254  <span class="hljs-number">8</span>dbd9e392a964056420e5d58ca5cc376ef18e2de93b5cc90e868a1bbc8318c1c
<span class="hljs-number">1</span>b95e1c4efd993116df499fa9951b865ec99e8a455427cffc9c61364bc3c5295  <span class="hljs-number">9</span>df1e07fdf780918f8fafaba0f5470d1c6357232617e42b6d190383fd0710e37
<span class="hljs-number">36669626e49</span>c623f3b2aea41052bbc9de0506807d92137bf76c0fd3264eaff34  <span class="hljs-number">9f</span>c1b767f7ff6d935efd6e897882d202fcbd041a154c400b595b9e0f1b2092dc
<span class="hljs-number">3749</span>ee37c2a6df4df9f720c7c07ecc5af695a2a5853bac1f8ba6450ddc310343  a10cdfaf13cf8dbaa07798f29265ec37a5bec4dc5f2b6f8c449edb2658b0a571
<span class="hljs-number">3e0</span>c3340e16e991af227912b27441b392762476f15d6749c3c1333fab63c5927  a37379b8d1ce392404d50d97a02afb92bd774a45191b3dc98c512fa6af394335
<span class="hljs-number">3e8</span>e8966dcfba21708e772ec165edcb617061028572e279decf7b374f4f3a866  a7bc400b42c28673642376884b7a8a93c76548198ebb4c4993a65cdfaf81ccd2
<span class="hljs-number">42</span>c69a7e8ad3ba37bfddeaf52ea54381d487311ba5c75d6a91811abeaad8438b  be647841828f846812df2968e24aa9db46c1a2033c0c60577e2b91fdcf7d4c09
<span class="hljs-number">444</span>b88bd8367b8fc2d023b5ceb77cec3784963bbfc03d1d30f96b97a22cfbc44  c171a2256c3b9d13c77b2b3773eaaad95a9b4a8735613ce46722f79fa29fa366
<span class="hljs-number">46</span>af893ffb5fe47b7de23a3f2f8972dbf51e78a0327ca46b7848c1cdfd48f97d  c219ca4d0d536c79955628e17aa8d6e6b6a61bc50c486bcd304a70a790985627
<span class="hljs-number">511136</span>ea3c5a64f264b78b5433614aec563103b4d4702f3ba7d4d2698e22c158  ca839611a34f4eb30e582694d9a1cdabf11d96b4c36bf69c1a82fb069ba0509a
<span class="hljs-number">5431</span>d6b9bc80429667488287e8189cc4d4b14791e43e45b374e132e340fb15db  cad6baf3ee5b2798947cdcfbdd3bf4c38c3f094bfbec876fb27da426528107fa
<span class="hljs-number">63e9</span>d31943ea386e435763524d9ea3a8cb253747113abbb53191121b815572da  d32d732341b07cfc87006d09ea75514d8c10774dfbc83c74034ac28b1491557b
<span class="hljs-number">68013</span>db1eb6d12803db7cbb52e95e6f29c8141c095b8cb50d245925d7f70d774  d5570ef1464a43fe282dd2705b38a2d739812b0b8036a49cfa09811737cfbed4
<span class="hljs-number">69f</span>7b013792e1f9c63176a7e348cb38277182f8bcf3d1d6d2c26ff9c4885b4ec  ef7c16d26957dc5dea9ad23433c7dd6400ab0a1a5cf461a080312dfaea50eeee
<span class="hljs-number">7</span>d0b9c0b29d271a8be6ca9252da15ae4f01dd386ac2b452563232aaaddd5eaf9  facdf830563864336b80233167577315520bca3fbbd86d8f995e40f0e81e238c
<span class="hljs-number">7f</span>06ad8f23b10227423823e3acc7e368c012f41a30660c3fbad661a9a4f8fe67  _tmp
</code></pre> 
  <p>长id与tree的短id是对应的，这样就明晰了。在上文中给container传文件用到了神奇通道，其实就是aufs中的mnt。</p> 
  <h1 id="备份方案">备份方案</h1> 
  <p>第一种情况，挂载host目录的，比如之前的hg-server。备份就很简单，直接把那些hg源码目录在host做备份即可。</p> 
  <p>第二种情况，需要在container中安装新软件。用export或者save命令吧。</p> 
  <pre class="prettyprint"><code class=" hljs lasso">sudo docker commit <span class="hljs-number">9</span>ab6e234c9ba linc<span class="hljs-attribute">-wiki</span>

sudo docker images REPOSITORY               <span class="hljs-built_in">TAG</span>                 IMAGE ID            CREATED             VIRTUAL SIZE linc<span class="hljs-attribute">-wiki</span>                latest              b5a1e34b01c2        <span class="hljs-number">14</span> seconds ago      <span class="hljs-number">689.7</span> MB

sudo docker export <span class="hljs-number">9</span>ab6e234c9ba <span class="hljs-subst">&gt;</span> /home/linc/docker/images<span class="hljs-attribute">-bk</span>/linc<span class="hljs-attribute">-wiki</span><span class="hljs-attribute">-export</span><span class="hljs-built_in">.</span>tar
sudo docker save linc<span class="hljs-attribute">-wiki</span> <span class="hljs-subst">&gt;</span> <span class="hljs-built_in">..</span>/images<span class="hljs-attribute">-bk</span>/linc<span class="hljs-attribute">-wiki</span><span class="hljs-attribute">-save</span><span class="hljs-built_in">.</span>tar

$ du <span class="hljs-attribute">-sh</span> <span class="hljs-subst">*</span>
<span class="hljs-number">495</span>M    linc<span class="hljs-attribute">-wiki</span><span class="hljs-attribute">-export</span><span class="hljs-built_in">.</span>tar
<span class="hljs-number">672</span>M    linc<span class="hljs-attribute">-wiki</span><span class="hljs-attribute">-save</span><span class="hljs-built_in">.</span>tar

sudo cat /home/linc/docker/images<span class="hljs-attribute">-bk</span>/linc<span class="hljs-attribute">-wiki</span><span class="hljs-attribute">-export</span><span class="hljs-built_in">.</span>tar <span class="hljs-subst">|</span> sudo docker <span class="hljs-keyword">import</span> <span class="hljs-subst">-</span> docker_hgweb
sudo docker load <span class="hljs-subst">--</span>input <span class="hljs-built_in">..</span>/images<span class="hljs-attribute">-bk</span>/linc<span class="hljs-attribute">-wiki</span><span class="hljs-attribute">-save</span><span class="hljs-built_in">.</span>tar</code></pre> 
  <p>第三种情况，mysql中的数据哪里去啦？ <br> 这个问题困扰我几天了。就拿部署的mediawiki说吧，没有将数据文件链接到host中，而是放到了/var/lib/mysql中，如下：</p> 
  <pre class="prettyprint"><code class=" hljs vbnet">/var/<span class="hljs-keyword">lib</span>/mysql<span class="hljs-preprocessor"># ls</span>
<span class="hljs-keyword">auto</span>.cnf  ib_logfile0  ib_logfile1  ibdata1  ibtmp1  my_wiki  mysql  performance_schema</code></pre> 
  <p>我嘗試着新设置volume不过没有成功，也做了其他努力，都失败了。最后一次大搜索中，发现这些数据文件被放在了vfs中。</p> 
  <pre class="prettyprint"><code class=" hljs livecodeserver">/var/lib/docker/vfs<span class="hljs-comment"># tree -L 3</span>
.
└── dir
    └── cb4012594631102fc8a69aa6cb4a9aa2dd2be3d39d2564c94ae91ac5e3eb4aec
        ├── auto.cnf
        ├── ibdata1
        ├── ib_logfile0
        ├── ib_logfile1
        ├── ibtmp1
        ├── mysql
        ├── my_wiki
        └── performance_schema

<span class="hljs-number">5</span> <span class="hljs-built_in">directories</span>, <span class="hljs-number">5</span> <span class="hljs-built_in">files</span></code></pre> 
  <p>尝试了将其放入我的ubuntu server虚拟机中的docker相同目录下，mediawiki用host中save后的镜像，我的mediawiki在ubuntu server虚拟机中完美复活！ <br> 也就是说，我只需要备份host系统中docker下的vfs的数据就可以了。问题解决，可以肆意在wiki中添加重要内容而不担心被毁掉了。</p> 
  <p>参考： <br> <a href="http://www.programfish.com/blog/?p=9" rel="nofollow">http://www.programfish.com/blog/?p=9</a> <br> <a href="http://blog.csdn.net/junjun16818/article/details/38423391" rel="nofollow">http://blog.csdn.net/junjun16818/article/details/38423391</a> <br> gitlab的维护：<a href="http://www.tuicool.com/articles/bYbi2mJ" rel="nofollow">http://www.tuicool.com/articles/bYbi2mJ</a></p> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lincyang/article/details/44835799,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/lincyang/article/details/44835799,&quot;}">阅读更多</a> 
</div>

	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<!-- 自定义广告 -->
	<ins class="adsbygoogle"
	     style="display:block"
	     data-ad-client="ca-pub-8889449066804352"
	     data-ad-slot="1494696990"
	     data-ad-format="auto"
	     data-full-width-responsive="true"></ins>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({});
	</script>


        <br />
        <a href="https://uzshare.com/">更多精彩内容</a>
      </section>
      
      <header style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
        <ul style="display: block;">
          <li><a href="/" style="line-height: 40px;padding-top:0px;">回首页</a></li>
        </ul>
      </header>
      <header class="sm-hidden" style="right: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/imgqcode.png" style="width:160px;" />
      </header>
      
      <header class="sm-hidden" style="left: 0;position: fixed;bottom: 60px;z-index: 100;background: none;border-bottom:none;">
          <img src="https://uzzz.org.cn/hou_imgqcode.png" style="width:160px;">
      </header>
    </div>
    
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?ee64533f3c6a7a284cd39a37ee732c8b";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

  </body>
</html>
