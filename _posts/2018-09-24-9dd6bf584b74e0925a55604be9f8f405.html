---
layout: default
title: 区块链学习1.4-比特币源码的学习-比特币基础
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3E%3Cstrong%3E1.3%E5%B0%B1%E5%B7%B2%E7%BB%8F%E6%8F%90%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%9B%9B%E5%A4%A7%E6%8A%80%E6%9C%AF%E7%BB%84%E5%90%88%EF%BC%8C%E6%88%91%E8%AE%A4%E4%B8%BA%E8%BF%98%E6%98%AF%E6%9C%89%E5%BF%85%E8%A6%81%E4%BA%86%E8%A7%A3%E8%83%8C%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86%E7%9A%84%E3%80%82%E4%B8%8B%E9%9D%A2%E5%81%9A%E4%B8%80%E4%B8%AA%E7%AE%80%E8%A6%81%E7%9A%84%E4%BB%8B%E7%BB%8D%E3%80%82%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Ch1%3E%E4%B8%80.+%E5%8C%BA%E5%9D%97%E9%93%BE%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95%3C%2Fh1%3E+%0A++%3Ch2%3E1.%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84Merkel%E6%A0%91%3C%2Fh2%3E+%0A++%3Cp%3E%E8%AF%B4%E5%88%B0merkle%E6%A0%91%E5%B0%B1%E4%B8%8D%E5%BE%97%E4%B8%8D%E8%B0%88%E5%88%B0%E4%BA%A4%E6%98%93%EF%BC%8Cmerkle%E6%A0%91%E5%B0%B1%E6%98%AF%E7%94%A8%E4%BA%8E%E5%AD%98%E6%94%BE%E4%BA%A4%E6%98%93%E7%9A%84+%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%82%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22WX20180224-010301%402x.png-61.3kB%22+class%3D%22has%22+src%3D%22http%3A%2F%2Fstatic.zybuluo.com%2FrenqHIT%2Ffar07jrcaeswpvnb6m89u30l%2FWX20180224-010301%402x.png%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AA%E5%93%88%E5%B8%8C%E4%BA%8C%E5%8F%89%E6%A0%91%EF%BC%8C%E5%93%88%E5%B8%8C%E7%9A%84%E8%BF%87%E7%A8%8B%E5%A6%82%E4%B8%8A%E5%9B%BE%E6%89%80%E7%A4%BA%E3%80%82merkleroot%E8%A1%A8%E7%A4%BA%E6%95%B4%E6%9D%A1%E9%93%BE%E7%9A%84%E4%BA%A4%E6%98%93%E6%91%98%E8%A6%81%E5%93%88%E5%B8%8C%E5%80%BC%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%85%B6%E4%B8%AD%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%A1%E6%81%AF%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode%3E%7B%0A++++%22size%22%3A+43560%2C%0A++++%22version%22%3A+2%2C%0A++++%22previousblockhash%22%3A+%2200000000000000027e7ba6fe7bad39faf3b5a83daed765f05f7d1b71a1632249%22%2C%0A++++%22merkleroot%22%3A+%225e049f4030e0ab2debb92378f53c0a6e09548aea083f3ab25e1d94ea1155e29d%22%2C%0A++++%22time%22%3A+1388185038%2C%0A++++%22difficulty%22%3A+1180923195.25802612%2C%0A++++%22nonce%22%3A+4215469401%2C%0A++++%22tx%22%3A+%5B%22257e7497fb8bc68421eb2c7b699dbab234831600e7352f0d9e6522c7cf3f6c77%22%2C+%23+%5B...many+more+transactions+omitted...%5D%0A++++++++%2205cfd38f6ae6aa83674cc99e4d75a1458c165b7ab84725eda41d018a09176634%22%0A++++%5D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%85%B6%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E1%EF%BC%89%E5%85%83%E4%BF%A1%E6%81%AF%EF%BC%9Asize%EF%BC%8Cversion%EF%BC%8Ctime%3C%2Fp%3E+%0A++%3Cp%3E2%EF%BC%89%E6%8C%96%E7%9F%BF%E4%BF%A1%E6%81%AF%EF%BC%9Anonce%EF%BC%8Cdifficulty%3C%2Fp%3E+%0A++%3Cp%3E3%EF%BC%89%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%EF%BC%9Atx%3C%2Fp%3E+%0A++%3Cp%3E4%EF%BC%89%E4%BA%A4%E6%98%93%E6%91%98%E8%A6%81%EF%BC%9Amerkleroot%EF%BC%8Cpreviousblockhash%3C%2Fp%3E+%0A++%3Cp%3E%E5%A6%82%E4%B8%8B%E6%98%AF%E4%B8%80%E4%B8%AA%E9%93%BE%E7%9A%84%E7%A4%BA%E4%BE%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22WX20180224-004307%402x.png-337.5kB%22+class%3D%22has%22+src%3D%22http%3A%2F%2Fstatic.zybuluo.com%2FrenqHIT%2Fccfr1cl2ki0v8dbuh4vhaxzf%2FWX20180224-004307%402x.png%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%E5%85%B6%E4%B8%AD%E6%9C%89%E5%85%B3merkle%E6%A0%91%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9C%A8%26nbsp%3B+consensus%2Fmerkle.cpp%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode%3E%2F%2F+Copyright+%28c%29+2015-2017+The+Bitcoin+Core+developers%0A%2F%2F+Distributed+under+the+MIT+software+license%2C+see+the+accompanying%0A%2F%2F+file+COPYING+or+http%3A%2F%2Fwww.opensource.org%2Flicenses%2Fmit-license.php.%0A%0A%23include+%26lt%3Bconsensus%2Fmerkle.h%26gt%3B%0A%23include+%26lt%3Bhash.h%26gt%3B%0A%23include+%26lt%3Butilstrencodings.h%26gt%3B%0A%0A%2F*+++++WARNING%21+If+you%27re+reading+this+because+you%27re+learning+about+crypto%0A+++++++and%2For+designing+a+new+system+that+will+use+merkle+trees%2C+keep+in+mind%0A+++++++that+the+following+merkle+tree+algorithm+has+a+serious+flaw+related+to%0A+++++++duplicate+txids%2C+resulting+in+a+vulnerability+%28CVE-2012-2459%29.%0A%0A+++++++The+reason+is+that+if+the+number+of+hashes+in+the+list+at+a+given+time%0A+++++++is+odd%2C+the+last+one+is+duplicated+before+computing+the+next+level+%28which%0A+++++++is+unusual+in+Merkle+trees%29.+This+results+in+certain+sequences+of%0A+++++++transactions+leading+to+the+same+merkle+root.+For+example%2C+these+two%0A+++++++trees%3A%0A%0A++++++++++++++++++++A+++++++++++++++A%0A++++++++++++++++++%2F++%5C++++++++++++%2F+++%5C%0A++++++++++++++++B+++++C+++++++++B+++++++C%0A+++++++++++++++%2F+%5C++++%7C++++++++%2F+%5C+++++%2F+%5C%0A++++++++++++++D+++E+++F+++++++D+++E+++F+++F%0A+++++++++++++%2F+%5C+%2F+%5C+%2F+%5C+++++%2F+%5C+%2F+%5C+%2F+%5C+%2F+%5C%0A+++++++++++++1+2+3+4+5+6+++++1+2+3+4+5+6+5+6%0A%0A+++++++for+transaction+lists+%5B1%2C2%2C3%2C4%2C5%2C6%5D+and+%5B1%2C2%2C3%2C4%2C5%2C6%2C5%2C6%5D+%28where+5+and%0A+++++++6+are+repeated%29+result+in+the+same+root+hash+A+%28because+the+hash+of+both%0A+++++++of+%28F%29+and+%28F%2CF%29+is+C%29.%0A%0A+++++++The+vulnerability+results+from+being+able+to+send+a+block+with+such+a%0A+++++++transaction+list%2C+with+the+same+merkle+root%2C+and+the+same+block+hash+as%0A+++++++the+original+without+duplication%2C+resulting+in+failed+validation.+If+the%0A+++++++receiving+node+proceeds+to+mark+that+block+as+permanently+invalid%0A+++++++however%2C+it+will+fail+to+accept+further+unmodified+%28and+thus+potentially%0A+++++++valid%29+versions+of+the+same+block.+We+defend+against+this+by+detecting%0A+++++++the+case+where+we+would+hash+two+identical+hashes+at+the+end+of+the+list%0A+++++++together%2C+and+treating+that+identically+to+the+block+having+an+invalid%0A+++++++merkle+root.+Assuming+no+double-SHA256+collisions%2C+this+will+detect+all%0A+++++++known+ways+of+changing+the+transactions+without+affecting+the+merkle%0A+++++++root.%0A*%2F%0A%0A%0Auint256+ComputeMerkleRoot%28std%3A%3Avector%26lt%3Buint256%26gt%3B+hashes%2C+bool*+mutated%29+%7B%0A++++bool+mutation+%3D+false%3B%0A++++while+%28hashes.size%28%29+%26gt%3B+1%29+%7B%2F%2Fif+mutation+is+true%2Cthen+it+means+that+found+a+duplicate+subtree%0A++++++++if+%28mutated%29+%7B%0A++++++++++++for+%28size_t+pos+%3D+0%3B+pos+%2B+1+%26lt%3B+hashes.size%28%29%3B+pos+%2B%3D+2%29+%7B%0A++++++++++++++++if+%28hashes%5Bpos%5D+%3D%3D+hashes%5Bpos+%2B+1%5D%29%0A++++++++++++++++++++mutation+%3D+true%3B%0A++++++++++++%7D%0A++++++++%7D%0A++++++++if+%28hashes.size%28%29+%26amp%3B+1%29+%7B%0A++++++++++++hashes.push_back%28hashes.back%28%29%29%3B%0A++++++++%7D%0A++++++++SHA256D64%28hashes%5B0%5D.begin%28%29%2C+hashes%5B0%5D.begin%28%29%2C+hashes.size%28%29+%2F+2%29%3B%0A++++++++hashes.resize%28hashes.size%28%29+%2F+2%29%3B%0A++++%7D%0A++++if+%28mutated%29%0A++++++++*mutated+%3D+mutation%3B%0A++++if+%28hashes.size%28%29+%3D%3D+0%29%0A++++++++return+uint256%28%29%3B%0A%0A++++return+hashes%5B0%5D%3B%0A%7D%0A%0A%0Auint256+BlockMerkleRoot%28const+CBlock%26amp%3B+block%2C+bool*+mutated%29%0A%7B%0A++++std%3A%3Avector%26lt%3Buint256%26gt%3B+leaves%3B%0A++++leaves.resize%28block.vtx.size%28%29%29%3B%0A++++for+%28size_t+s+%3D+0%3B+s+%26lt%3B+block.vtx.size%28%29%3B+s%2B%2B%29+%7B%0A++++++++leaves%5Bs%5D+%3D+block.vtx%5Bs%5D-%26gt%3BGetHash%28%29%3B%0A++++%7D%0A++++return+ComputeMerkleRoot%28std%3A%3Amove%28leaves%29%2C+mutated%29%3B%0A%7D%0A%0Auint256+BlockWitnessMerkleRoot%28const+CBlock%26amp%3B+block%2C+bool*+mutated%29%0A%7B%0A++++std%3A%3Avector%26lt%3Buint256%26gt%3B+leaves%3B%0A++++leaves.resize%28block.vtx.size%28%29%29%3B%0A++++leaves%5B0%5D.SetNull%28%29%3B+%2F%2F+The+witness+hash+of+the+coinbase+is+0.%0A++++for+%28size_t+s+%3D+1%3B+s+%26lt%3B+block.vtx.size%28%29%3B+s%2B%2B%29+%7B%0A++++++++leaves%5Bs%5D+%3D+block.vtx%5Bs%5D-%26gt%3BGetWitnessHash%28%29%3B%0A++++%7D%0A++++return+ComputeMerkleRoot%28std%3A%3Amove%28leaves%29%2C+mutated%29%3B%0A%7D%0A%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch2%3E2.+%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95%3C%2Fh2%3E+%0A++%3Ch2%3E2.1+%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E7%AE%97%E6%B3%95%3C%2Fh2%3E+%0A++%3Cp%3E%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E5%AF%86%E7%A0%81%E5%AD%A6%EF%BC%88Elliptic+curve+cryptography%EF%BC%89%EF%BC%8C%E7%AE%80%E7%A7%B0ECC%EF%BC%8C%E6%98%AF%E4%B8%80%E7%A7%8D%E5%BB%BA%E7%AB%8B%E5%85%AC%E5%BC%80%E5%AF%86%E9%92%A5%E5%8A%A0%E5%AF%86%E7%9A%84%E7%AE%97%E6%B3%95%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E9%9D%9E%E5%AF%B9%E7%A7%B0%E5%8A%A0%E5%AF%86%E3%80%82%E7%B1%BB%E4%BC%BC%E7%9A%84%E8%BF%98%E6%9C%89RSA%EF%BC%8CElGamal%E7%AE%97%E6%B3%95%E7%AD%89%E3%80%82ECC%E8%A2%AB%E5%85%AC%E8%AE%A4%E4%B8%BA%E5%9C%A8%E7%BB%99%E5%AE%9A%E5%AF%86%E9%92%A5%E9%95%BF%E5%BA%A6%E4%B8%8B%E6%9C%80%E5%AE%89%E5%85%A8%E7%9A%84%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E3%80%82%E6%AF%94%E7%89%B9%E5%B8%81%E4%B8%AD%E7%9A%84%E5%85%AC%E7%A7%81%E9%92%A5%E7%94%9F%E6%88%90%E4%BB%A5%E5%8F%8A%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95ECDSA%E9%83%BD%E6%98%AF%E5%9F%BA%E4%BA%8EECC%E7%9A%84%E3%80%82%E4%B8%8B%E9%9D%A2%E7%AE%80%E5%8D%95%E4%BB%8B%E7%BB%8DECC%E4%BB%A5%E5%8F%8AECDSA%E7%9A%84%E5%8E%9F%E7%90%86%E3%80%82%EF%BC%88%E6%88%91%E8%AE%A4%E4%B8%BA%E6%9C%89%E9%AB%98%E4%BA%BA%E8%83%BD%E8%A7%A3%E9%87%8A%E7%9A%84%E6%9B%B4%E6%B8%85%E6%A5%9A%EF%BC%8C%E8%B4%B4%E9%93%BE%E6%8E%A5%EF%BC%89%3C%2Fp%3E+%0A++%3Cp%3E%3Ca+href%3D%22https%3A%2F%2Fjuejin.im%2Fpost%2F5a67f3836fb9a01c9b661bd3%22+rel%3D%22nofollow%22%3E%E6%A4%AD%E5%9C%86%E6%9B%B2%E7%BA%BF%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%3C%2Fa%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Ch2%3E2.2+HASH%E7%AE%97%E6%B3%95%3C%2Fh2%3E+%0A++%3Cp%3E%E5%85%B6%E6%AC%A1%E5%B0%B1%E6%98%AF%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%EF%BC%8CSHA-256%EF%BC%8C%E6%AD%A4%E7%AE%97%E6%B3%95%E7%94%A8%E9%80%94%E5%BE%88%E5%B9%BF%E6%B3%9B%EF%BC%8C%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%85%AC%E9%92%A5%EF%BC%8C%E6%8C%96%E7%9F%BF%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%AD%A4%E5%A4%84%E7%AE%80%E8%A6%81%E8%B4%B4%E4%B8%80%E4%B8%8B%E7%94%B1%E5%85%AC%E9%92%A5%E7%94%9F%E6%88%90%E6%AF%94%E7%89%B9%E5%B8%81%E7%9A%84%E5%9C%B0%E5%9D%80%E7%9A%84%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%E5%85%AC%E9%92%A5-%E6%AF%94%E7%89%B9%E5%B8%81%E5%9C%B0%E5%9D%80.png-158.2kB%22+class%3D%22has%22+src%3D%22http%3A%2F%2Fstatic.zybuluo.com%2FrenqHIT%2Faiypemwfigo9zizw50gjuwjz%2F%25E5%2585%25AC%25E9%2592%25A5-%25E6%25AF%2594%25E7%2589%25B9%25E5%25B8%2581%25E5%259C%25B0%25E5%259D%2580.png%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%E5%9C%A8%E6%BA%90%E7%A0%81%E4%B8%ADSHA-256%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9A%E5%9C%A8+src%2Fcrypto%2Fsha256.cpp+%E4%B8%AD%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%A4%AA%E9%95%BF%EF%BC%8C%E6%AD%A4%E5%A4%84%E5%B0%B1%E4%B8%8D%E8%B4%B4%E4%BA%86%E3%80%82%E5%85%B7%E4%BD%93%E8%A7%A3%E9%87%8A%E6%B3%A8%E9%87%8A%E5%9F%BA%E6%9C%AC%E5%86%99%E6%B8%85%E4%BA%86%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Ch1%3E%E4%BA%8C.+%E4%BA%A4%E6%98%93%3C%2Fh1%3E+%0A++%3Ch2%3E2.1%E4%BA%A4%E6%98%93%E6%A0%BC%E5%BC%8F%3C%2Fh2%3E+%0A++%3Cp%3E%E7%8E%B0%E5%AD%98%E7%9A%84%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%9B%BA%E6%9C%89%E6%80%9D%E7%BB%B4%E6%98%AF%E7%BB%99%E6%AF%8F%E4%B8%AA%E4%BA%BA%E5%BB%BA%E7%AB%8B%E8%B4%A6%E6%88%B7%EF%BC%8C%E8%B4%A6%E6%88%B7%E9%87%8C%E6%9C%89%E4%BD%99%E9%A2%9D%E3%80%82%E6%AF%8F%E6%AC%A1%E8%BF%9B%E8%A1%8C%E4%BA%A4%E6%98%93%E6%97%B6%EF%BC%8C%E4%B8%AD%E5%A4%AE%E7%9A%84%E4%BA%A4%E6%98%93%E7%B3%BB%E7%BB%9F%E4%BC%9A%E7%A1%AE%E8%AE%A4%E5%8F%91%E8%B5%B7%E4%BA%BA%E6%98%AF%E5%90%A6%E6%9C%89%E9%82%A3%E4%B9%88%E5%A4%9A%E9%92%B1%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%89%EF%BC%8C%E6%89%8D%E4%BC%9A%E6%94%AF%E4%BB%98%E7%BB%99%E8%A6%81%E6%94%AF%E4%BB%98%E7%9A%84%E4%BA%BA%EF%BC%8C%E4%BA%A4%E6%98%93%E6%89%8D%E7%AE%97%E6%88%90%E5%8A%9F%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E8%80%8C%E6%AF%94%E7%89%B9%E5%B8%81%E7%9A%84%E5%A4%84%E7%90%86%E6%80%9D%E8%B7%AF%E6%98%AF%E6%B2%A1%E6%9C%89%E4%B8%AA%E4%BA%BA%E7%9A%84%E8%B4%A6%E6%88%B7%E4%BD%99%E9%A2%9D%EF%BC%8C%E4%BB%96%E5%9C%A8%E8%AE%B0%E5%BD%95%E5%8E%86%E5%8F%B2%E4%B8%8A%E5%8F%91%E7%94%9F%E7%9A%84%E4%BA%A4%E6%98%93%E8%AE%B0%E5%BD%95%EF%BC%8C%E4%BB%A5%E6%9C%AA%E6%B6%88%E8%B4%B9%E4%BA%A4%E6%98%93%E8%BE%93%E5%87%BA%EF%BC%88UTXO%EF%BC%89%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E4%BF%9D%E5%AD%98%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%8C%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9%E5%85%B1%E5%90%8C%E9%AA%8C%E8%AF%81UTXO%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95%E3%80%82%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E7%9A%84%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%EF%BC%8C%E4%BB%A3%E8%A1%A8%E4%B8%80%E7%BB%84UTXO%E9%9B%86%E5%90%88%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%88%B0%E5%8F%A6%E5%A4%96%E4%B8%80%E7%BB%84UTXO%E9%9B%86%E5%90%88%E7%8A%B6%E6%80%81%E3%80%82%E4%BA%A7%E7%94%9F%E6%96%B0%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E6%97%B6%EF%BC%8CUTXO%E9%9B%86%E5%90%88%E5%A4%A7%E5%B0%8F%E4%BC%9A%E5%A2%9E%E5%8A%A0%E3%80%82%E9%82%A3%E4%B9%88%E4%B8%AA%E4%BA%BA%E7%9A%84%E8%B4%A6%E6%88%B7%E4%BD%99%E9%A2%9D%E7%9B%B8%E5%BD%93%E4%BA%8E%E5%8F%AF%E4%BB%A5%E6%B6%88%E8%B4%B9UTXO%E7%9A%84%E6%80%BB%E9%A2%9D%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E7%9A%84%E5%86%85%E5%AE%B9%E5%85%B7%E4%BD%93%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode%3E%7B%0A++++%22version%22%3A+1%2C%0A++++%22locktime%22%3A+0%2C%0A++++%22vin%22%3A+%5B%7B%0A++++++++%22txid%22%3A+%227957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18%22%2C%0A++++++++%22vout%22%3A+0%2C%0A++++++++%22scriptSig%22%3A+%223045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204+b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813%5BALL%5D+0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d1+72787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf%22%2C%0A++++++++%22sequence%22%3A+4294967295%0A++++%7D%5D%2C%0A++++%22vout%22%3A+%5B%7B%0A++++++++%22value%22%3A+0.01500000%2C%0A++++++++%22scriptPubKey%22%3A+%22OP_DUP+OP_HASH160+ab68025513c3dbd2f7b92a94e0581f5d50f654e7+OP_EQUALVERIFY+OP_CHECKSIG+%22%0A++++%7D%2C+%7B%0A++++++++%22value%22%3A+0.08450000%2C%0A++++++++%22scriptPubKey%22%3A+%22OP_DUP+OP_HASH160+7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8+OP_EQUALVERIFY+OP_CHECKSIG%22%0A++++%7D%5D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Evin%E4%BB%A3%E8%A1%A8%E8%BE%93%E5%85%A5%EF%BC%8C%E6%AF%8F%E4%B8%AA%E8%BE%93%E5%85%A5%E9%83%BD%E4%BC%9A%E5%8C%85%E5%90%AB%E4%B8%80%E9%A1%B9scriptSig%EF%BC%9Bvout%E4%BB%A3%E8%A1%A8%E8%BE%93%E5%87%BA%EF%BC%8C%E6%AF%8F%E4%B8%AA%E8%BE%93%E5%87%BA%E9%83%BD%E4%BC%9A%E5%8C%85%E5%90%ABscriptPubKey%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%AF%94%E7%89%B9%E5%B8%81%E4%BA%A4%E6%98%93%E7%BB%93%E6%9E%84%E5%A4%A7%E8%87%B4%E5%A6%82%E4%B8%8B%EF%BC%9A%E8%A7%81src%2Fprimitives%2Ftransaction.h%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode%3E%2F**+An+outpoint+-+a+combination+of+a+transaction+hash+and+an+index+n+into+its+vout+*%2F%0Aclass+COutPoint%0A%0A%0A%2F**+An+input+of+a+transaction.++It+contains+the+location+of+the+previous%0A+*+transaction%27s+output+that+it+claims+and+a+signature+that+matches+the%0A+*+output%27s+public+key.%0A+*%2F%0Aclass+CTxIn%0A%0A%0A%2F**+An+output+of+a+transaction.++It+contains+the+public+key+that+the+next+input%0A+*+must+be+able+to+sign+with+to+claim+it.%0A+*%2F%0Aclass+CTxOut%0A%0A%0A%2F**%0A+*+Basic+transaction+serialization+format%3A%0A+*+-+int32_t+nVersion%0A+*+-+std%3A%3Avector%26lt%3BCTxIn%26gt%3B+vin%0A+*+-+std%3A%3Avector%26lt%3BCTxOut%26gt%3B+vout%0A+*+-+uint32_t+nLockTime%0A+*%0A+*+Extended+transaction+serialization+format%3A%0A+*+-+int32_t+nVersion%0A+*+-+unsigned+char+dummy+%3D+0x00%0A+*+-+unsigned+char+flags+%28%21%3D+0%29%0A+*+-+std%3A%3Avector%26lt%3BCTxIn%26gt%3B+vin%0A+*+-+std%3A%3Avector%26lt%3BCTxOut%26gt%3B+vout%0A+*+-+if+%28flags+%26amp%3B+1%29%3A%0A+*+++-+CTxWitness+wit%3B%0A+*+-+uint32_t+nLockTime%0A+*%2F%0Atemplate%26lt%3Btypename+Stream%2C+typename+TxType%26gt%3B%0Ainline+void+UnserializeTransaction%28TxType%26amp%3B+tx%2C+Stream%26amp%3B+s%29+%0A%0A%0A%0Atemplate%26lt%3Btypename+Stream%2C+typename+TxType%26gt%3B%0Ainline+void+SerializeTransaction%28const+TxType%26amp%3B+tx%2C+Stream%26amp%3B+s%29%0A%0A%0A%2F**+The+basic+transaction+that+is+broadcasted+on+the+network+and+contained+in%0A+*+blocks.++A+transaction+can+contain+multiple+inputs+and+outputs.%0A+*%2F%0Aclass+CTransaction%0A%0A%0A%2F**+A+mutable+version+of+CTransaction.+*%2F%0Astruct+CMutableTransaction%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%BB%93%E6%9E%84%E5%A6%82%E4%B8%8A%EF%BC%8C%E6%B3%A8%E9%87%8A%E4%B9%9F%E9%83%BD%E8%B4%B4%E4%B8%8A%E4%BA%86%E3%80%82%E5%85%B7%E4%BD%93%E5%9C%A8%E6%BA%90%E7%A0%81%E9%87%8C%E9%9D%A2%E5%8F%AF%E4%BB%A5%E8%AF%BB%E5%88%B0%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E2.2+%E4%BA%A4%E6%98%93%E8%84%9A%E6%9C%AC%3C%2Fh2%3E+%0A++%3Cp%3E%E6%AF%94%E7%89%B9%E5%B8%81%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E6%98%AF%E4%B8%93%E4%B8%BA%E6%AF%94%E7%89%B9%E5%B8%81%E8%AE%BE%E8%AE%A1%E7%9A%84%E7%A8%8B%E5%BA%8F%E8%AF%AD%E8%A8%80%E3%80%82%E6%AF%94%E7%89%B9%E5%B8%81%E8%84%9A%E6%9C%AC%E8%AF%AD%E8%A8%80%E6%98%AF%E9%9D%9E%E5%9B%BE%E7%81%B5%E5%AE%8C%E5%A4%87%E8%AF%AD%E8%A8%80%EF%BC%8C%E8%AE%A1%E7%AE%97%E8%A1%A8%E8%BE%BE%E8%AF%AD%E8%A8%80%E5%8F%97%E5%88%B0%E4%BA%86%E4%B8%80%E5%AE%9A%E7%9A%84%E9%99%90%E5%88%B6%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%AF%94%E7%89%B9%E5%B8%81%E8%84%9A%E6%9C%AC%E4%B8%8D%E6%94%AF%E6%8C%81%E5%BE%AA%E7%8E%AF%EF%BC%9B%E6%AF%94%E7%89%B9%E5%B8%81%E7%9A%84%E8%84%9A%E6%9C%AC%E5%8F%AF%E7%94%A8%E5%86%85%E5%AD%98%E5%92%8C%E6%97%B6%E9%97%B4%E8%A2%AB%E9%99%90%E5%88%B6%EF%BC%9B%E6%95%B0%E6%8D%AE%E5%AD%98%E5%9C%A8%E6%A0%88%E4%B8%AD%EF%BC%8C%E4%B8%8D%E6%94%AF%E6%8C%81%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E2.3+UTXO%3C%2Fh2%3E+%0A++%3Cp%3E%E6%BA%90%E7%A0%81%E5%9C%A8src%2Fcoins.h%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode%3E%2F%2F+Copyright+%28c%29+2009-2010+Satoshi+Nakamoto%0A%2F%2F+Copyright+%28c%29+2009-2017+The+Bitcoin+Core+developers%0A%2F%2F+Distributed+under+the+MIT+software+license%2C+see+the+accompanying%0A%2F%2F+file+COPYING+or+http%3A%2F%2Fwww.opensource.org%2Flicenses%2Fmit-license.php.%0A%0A%23ifndef+BITCOIN_COINS_H%0A%23define+BITCOIN_COINS_H%0A%0A%23include+%26lt%3Bprimitives%2Ftransaction.h%26gt%3B%0A%23include+%26lt%3Bcompressor.h%26gt%3B%0A%23include+%26lt%3Bcore_memusage.h%26gt%3B%0A%23include+%26lt%3Bhash.h%26gt%3B%0A%23include+%26lt%3Bmemusage.h%26gt%3B%0A%23include+%26lt%3Bserialize.h%26gt%3B%0A%23include+%26lt%3Buint256.h%26gt%3B%0A%0A%23include+%26lt%3Bassert.h%26gt%3B%0A%23include+%26lt%3Bstdint.h%26gt%3B%0A%0A%23include+%26lt%3Bunordered_map%26gt%3B%0A%0A%2F**%0A+*+A+UTXO+entry.%0A+*%0A+*+Serialized+format%3A%0A+*+-+VARINT%28%28coinbase+%3F+1+%3A+0%29+%7C+%28height+%26lt%3B%26lt%3B+1%29%29%0A+*+-+the+non-spent+CTxOut+%28via+CTxOutCompressor%29%0A+*%2F%0Aclass+Coin%0A%7B%0Apublic%3A%0A++++%2F%2F%21+unspent+transaction+output%0A++++CTxOut+out%3B%0A%0A++++%2F%2F%21+whether+containing+transaction+was+a+coinbase%0A++++unsigned+int+fCoinBase+%3A+1%3B%0A%0A++++%2F%2F%21+at+which+height+this+containing+transaction+was+included+in+the+active+block+chain%0A++++uint32_t+nHeight+%3A+31%3B%0A%0A++++%2F%2F%21+construct+a+Coin+from+a+CTxOut+and+height%2Fcoinbase+information.%0A++++Coin%28CTxOut%26amp%3B%26amp%3B+outIn%2C+int+nHeightIn%2C+bool+fCoinBaseIn%29+%3A+out%28std%3A%3Amove%28outIn%29%29%2C+fCoinBase%28fCoinBaseIn%29%2C+nHeight%28nHeightIn%29+%7B%7D%0A++++Coin%28const+CTxOut%26amp%3B+outIn%2C+int+nHeightIn%2C+bool+fCoinBaseIn%29+%3A+out%28outIn%29%2C+fCoinBase%28fCoinBaseIn%29%2CnHeight%28nHeightIn%29+%7B%7D%0A%0A++++void+Clear%28%29+%7B%0A++++++++out.SetNull%28%29%3B%0A++++++++fCoinBase+%3D+false%3B%0A++++++++nHeight+%3D+0%3B%0A++++%7D%0A%0A++++%2F%2F%21+empty+constructor%0A++++Coin%28%29+%3A+fCoinBase%28false%29%2C+nHeight%280%29+%7B+%7D%0A%0A++++bool+IsCoinBase%28%29+const+%7B%0A++++++++return+fCoinBase%3B%0A++++%7D%0A%0A++++template%26lt%3Btypename+Stream%26gt%3B%0A++++void+Serialize%28Stream+%26amp%3Bs%29+const+%7B%0A++++++++assert%28%21IsSpent%28%29%29%3B%0A++++++++uint32_t+code+%3D+nHeight+*+2+%2B+fCoinBase%3B%0A++++++++%3A%3ASerialize%28s%2C+VARINT%28code%29%29%3B%0A++++++++%3A%3ASerialize%28s%2C+CTxOutCompressor%28REF%28out%29%29%29%3B%0A++++%7D%0A%0A++++template%26lt%3Btypename+Stream%26gt%3B%0A++++void+Unserialize%28Stream+%26amp%3Bs%29+%7B%0A++++++++uint32_t+code+%3D+0%3B%0A++++++++%3A%3AUnserialize%28s%2C+VARINT%28code%29%29%3B%0A++++++++nHeight+%3D+code+%26gt%3B%26gt%3B+1%3B%0A++++++++fCoinBase+%3D+code+%26amp%3B+1%3B%0A++++++++%3A%3AUnserialize%28s%2C+CTxOutCompressor%28out%29%29%3B%0A++++%7D%0A%0A++++bool+IsSpent%28%29+const+%7B%0A++++++++return+out.IsNull%28%29%3B%0A++++%7D%0A%0A++++size_t+DynamicMemoryUsage%28%29+const+%7B%0A++++++++return+memusage%3A%3ADynamicUsage%28out.scriptPubKey%29%3B%0A++++%7D%0A%7D%3B%0A%0Aclass+SaltedOutpointHasher%0A%7B%0Aprivate%3A%0A++++%2F**+Salt+*%2F%0A++++const+uint64_t+k0%2C+k1%3B%0A%0Apublic%3A%0A++++SaltedOutpointHasher%28%29%3B%0A%0A++++%2F**%0A+++++*+This+*must*+return+size_t.+With+Boost+1.46+on+32-bit+systems+the%0A+++++*+unordered_map+will+behave+unpredictably+if+the+custom+hasher+returns+a%0A+++++*+uint64_t%2C+resulting+in+failures+when+syncing+the+chain+%28%234634%29.%0A+++++*%2F%0A++++size_t+operator%28%29%28const+COutPoint%26amp%3B+id%29+const+%7B%0A++++++++return+SipHashUint256Extra%28k0%2C+k1%2C+id.hash%2C+id.n%29%3B%0A++++%7D%0A%7D%3B%0A%0Astruct+CCoinsCacheEntry%0A%7B%0A++++Coin+coin%3B+%2F%2F+The+actual+cached+data.%0A++++unsigned+char+flags%3B%0A%0A++++enum+Flags+%7B%0A++++++++DIRTY+%3D+%281+%26lt%3B%26lt%3B+0%29%2C+%2F%2F+This+cache+entry+is+potentially+different+from+the+version+in+the+parent+view.%0A++++++++FRESH+%3D+%281+%26lt%3B%26lt%3B+1%29%2C+%2F%2F+The+parent+view+does+not+have+this+entry+%28or+it+is+pruned%29.%0A++++++++%2F*+Note+that+FRESH+is+a+performance+optimization+with+which+we+can%0A+++++++++*+erase+coins+that+are+fully+spent+if+we+know+we+do+not+need+to%0A+++++++++*+flush+the+changes+to+the+parent+cache.++It+is+always+safe+to%0A+++++++++*+not+mark+FRESH+if+that+condition+is+not+guaranteed.%0A+++++++++*%2F%0A++++%7D%3B%0A%0A++++CCoinsCacheEntry%28%29+%3A+flags%280%29+%7B%7D%0A++++explicit+CCoinsCacheEntry%28Coin%26amp%3B%26amp%3B+coin_%29+%3A+coin%28std%3A%3Amove%28coin_%29%29%2C+flags%280%29+%7B%7D%0A%7D%3B%0A%0Atypedef+std%3A%3Aunordered_map%26lt%3BCOutPoint%2C+CCoinsCacheEntry%2C+SaltedOutpointHasher%26gt%3B+CCoinsMap%3B%0A%0A%2F**+Cursor+for+iterating+over+CoinsView+state+*%2F%0Aclass+CCoinsViewCursor%0A%7B%0Apublic%3A%0A++++CCoinsViewCursor%28const+uint256+%26amp%3BhashBlockIn%29%3A+hashBlock%28hashBlockIn%29+%7B%7D%0A++++virtual+%7ECCoinsViewCursor%28%29+%7B%7D%0A%0A++++virtual+bool+GetKey%28COutPoint+%26amp%3Bkey%29+const+%3D+0%3B%0A++++virtual+bool+GetValue%28Coin+%26amp%3Bcoin%29+const+%3D+0%3B%0A++++virtual+unsigned+int+GetValueSize%28%29+const+%3D+0%3B%0A%0A++++virtual+bool+Valid%28%29+const+%3D+0%3B%0A++++virtual+void+Next%28%29+%3D+0%3B%0A%0A++++%2F%2F%21+Get+best+block+at+the+time+this+cursor+was+created%0A++++const+uint256+%26amp%3BGetBestBlock%28%29+const+%7B+return+hashBlock%3B+%7D%0Aprivate%3A%0A++++uint256+hashBlock%3B%0A%7D%3B%0A%0A%2F**+Abstract+view+on+the+open+txout+dataset.+*%2F%0Aclass+CCoinsView%0A%7B%0Apublic%3A%0A++++%2F**+Retrieve+the+Coin+%28unspent+transaction+output%29+for+a+given+outpoint.%0A+++++*++Returns+true+only+when+an+unspent+coin+was+found%2C+which+is+returned+in+coin.%0A+++++*++When+false+is+returned%2C+coin%27s+value+is+unspecified.%0A+++++*%2F%0A++++virtual+bool+GetCoin%28const+COutPoint+%26amp%3Boutpoint%2C+Coin+%26amp%3Bcoin%29+const%3B%0A%0A++++%2F%2F%21+Just+check+whether+a+given+outpoint+is+unspent.%0A++++virtual+bool+HaveCoin%28const+COutPoint+%26amp%3Boutpoint%29+const%3B%0A%0A++++%2F%2F%21+Retrieve+the+block+hash+whose+state+this+CCoinsView+currently+represents%0A++++virtual+uint256+GetBestBlock%28%29+const%3B%0A%0A++++%2F%2F%21+Retrieve+the+range+of+blocks+that+may+have+been+only+partially+written.%0A++++%2F%2F%21+If+the+database+is+in+a+consistent+state%2C+the+result+is+the+empty+vector.%0A++++%2F%2F%21+Otherwise%2C+a+two-element+vector+is+returned+consisting+of+the+new+and%0A++++%2F%2F%21+the+old+block+hash%2C+in+that+order.%0A++++virtual+std%3A%3Avector%26lt%3Buint256%26gt%3B+GetHeadBlocks%28%29+const%3B%0A%0A++++%2F%2F%21+Do+a+bulk+modification+%28multiple+Coin+changes+%2B+BestBlock+change%29.%0A++++%2F%2F%21+The+passed+mapCoins+can+be+modified.%0A++++virtual+bool+BatchWrite%28CCoinsMap+%26amp%3BmapCoins%2C+const+uint256+%26amp%3BhashBlock%29%3B%0A%0A++++%2F%2F%21+Get+a+cursor+to+iterate+over+the+whole+state%0A++++virtual+CCoinsViewCursor+*Cursor%28%29+const%3B%0A%0A++++%2F%2F%21+As+we+use+CCoinsViews+polymorphically%2C+have+a+virtual+destructor%0A++++virtual+%7ECCoinsView%28%29+%7B%7D%0A%0A++++%2F%2F%21+Estimate+database+size+%280+if+not+implemented%29%0A++++virtual+size_t+EstimateSize%28%29+const+%7B+return+0%3B+%7D%0A%7D%3B%0A%0A%0A%2F**+CCoinsView+backed+by+another+CCoinsView+*%2F%0Aclass+CCoinsViewBacked+%3A+public+CCoinsView%0A%7B%0Aprotected%3A%0A++++CCoinsView+*base%3B%0A%0Apublic%3A%0A++++CCoinsViewBacked%28CCoinsView+*viewIn%29%3B%0A++++bool+GetCoin%28const+COutPoint+%26amp%3Boutpoint%2C+Coin+%26amp%3Bcoin%29+const+override%3B%0A++++bool+HaveCoin%28const+COutPoint+%26amp%3Boutpoint%29+const+override%3B%0A++++uint256+GetBestBlock%28%29+const+override%3B%0A++++std%3A%3Avector%26lt%3Buint256%26gt%3B+GetHeadBlocks%28%29+const+override%3B%0A++++void+SetBackend%28CCoinsView+%26amp%3BviewIn%29%3B%0A++++bool+BatchWrite%28CCoinsMap+%26amp%3BmapCoins%2C+const+uint256+%26amp%3BhashBlock%29+override%3B%0A++++CCoinsViewCursor+*Cursor%28%29+const+override%3B%0A++++size_t+EstimateSize%28%29+const+override%3B%0A%7D%3B%0A%0A%0A%2F**+CCoinsView+that+adds+a+memory+cache+for+transactions+to+another+CCoinsView+*%2F%0Aclass+CCoinsViewCache+%3A+public+CCoinsViewBacked%0A%7B%0Aprotected%3A%0A++++%2F**%0A+++++*+Make+mutable+so+that+we+can+%22fill+the+cache%22+even+from+Get-methods%0A+++++*+declared+as+%22const%22.%0A+++++*%2F%0A++++mutable+uint256+hashBlock%3B%0A++++mutable+CCoinsMap+cacheCoins%3B%0A%0A++++%2F*+Cached+dynamic+memory+usage+for+the+inner+Coin+objects.+*%2F%0A++++mutable+size_t+cachedCoinsUsage%3B%0A%0Apublic%3A%0A++++CCoinsViewCache%28CCoinsView+*baseIn%29%3B%0A%0A++++%2F**%0A+++++*+By+deleting+the+copy+constructor%2C+we+prevent+accidentally+using+it+when+one+intends+to+create+a+cache+on+top+of+a+base+cache.%0A+++++*%2F%0A++++CCoinsViewCache%28const+CCoinsViewCache+%26amp%3B%29+%3D+delete%3B%0A%0A++++%2F%2F+Standard+CCoinsView+methods%0A++++bool+GetCoin%28const+COutPoint+%26amp%3Boutpoint%2C+Coin+%26amp%3Bcoin%29+const+override%3B%0A++++bool+HaveCoin%28const+COutPoint+%26amp%3Boutpoint%29+const+override%3B%0A++++uint256+GetBestBlock%28%29+const+override%3B%0A++++void+SetBestBlock%28const+uint256+%26amp%3BhashBlock%29%3B%0A++++bool+BatchWrite%28CCoinsMap+%26amp%3BmapCoins%2C+const+uint256+%26amp%3BhashBlock%29+override%3B%0A++++CCoinsViewCursor*+Cursor%28%29+const+override+%7B%0A++++++++throw+std%3A%3Alogic_error%28%22CCoinsViewCache+cursor+iteration+not+supported.%22%29%3B%0A++++%7D%0A%0A++++%2F**%0A+++++*+Check+if+we+have+the+given+utxo+already+loaded+in+this+cache.%0A+++++*+The+semantics+are+the+same+as+HaveCoin%28%29%2C+but+no+calls+to%0A+++++*+the+backing+CCoinsView+are+made.%0A+++++*%2F%0A++++bool+HaveCoinInCache%28const+COutPoint+%26amp%3Boutpoint%29+const%3B%0A%0A++++%2F**%0A+++++*+Return+a+reference+to+Coin+in+the+cache%2C+or+a+pruned+one+if+not+found.+This+is%0A+++++*+more+efficient+than+GetCoin.%0A+++++*%0A+++++*+Generally%2C+do+not+hold+the+reference+returned+for+more+than+a+short+scope.%0A+++++*+While+the+current+implementation+allows+for+modifications+to+the+contents%0A+++++*+of+the+cache+while+holding+the+reference%2C+this+behavior+should+not+be+relied%0A+++++*+on%21+To+be+safe%2C+best+to+not+hold+the+returned+reference+through+any+other%0A+++++*+calls+to+this+cache.%0A+++++*%2F%0A++++const+Coin%26amp%3B+AccessCoin%28const+COutPoint+%26amp%3Boutput%29+const%3B%0A%0A++++%2F**%0A+++++*+Add+a+coin.+Set+potential_overwrite+to+true+if+a+non-pruned+version+may%0A+++++*+already+exist.%0A+++++*%2F%0A++++void+AddCoin%28const+COutPoint%26amp%3B+outpoint%2C+Coin%26amp%3B%26amp%3B+coin%2C+bool+potential_overwrite%29%3B%0A%0A++++%2F**%0A+++++*+Spend+a+coin.+Pass+moveto+in+order+to+get+the+deleted+data.%0A+++++*+If+no+unspent+output+exists+for+the+passed+outpoint%2C+this+call%0A+++++*+has+no+effect.%0A+++++*%2F%0A++++bool+SpendCoin%28const+COutPoint+%26amp%3Boutpoint%2C+Coin*+moveto+%3D+nullptr%29%3B%0A%0A++++%2F**%0A+++++*+Push+the+modifications+applied+to+this+cache+to+its+base.%0A+++++*+Failure+to+call+this+method+before+destruction+will+cause+the+changes+to+be+forgotten.%0A+++++*+If+false+is+returned%2C+the+state+of+this+cache+%28and+its+backing+view%29+will+be+undefined.%0A+++++*%2F%0A++++bool+Flush%28%29%3B%0A%0A++++%2F**%0A+++++*+Removes+the+UTXO+with+the+given+outpoint+from+the+cache%2C+if+it+is%0A+++++*+not+modified.%0A+++++*%2F%0A++++void+Uncache%28const+COutPoint+%26amp%3Boutpoint%29%3B%0A%0A++++%2F%2F%21+Calculate+the+size+of+the+cache+%28in+number+of+transaction+outputs%29%0A++++unsigned+int+GetCacheSize%28%29+const%3B%0A%0A++++%2F%2F%21+Calculate+the+size+of+the+cache+%28in+bytes%29%0A++++size_t+DynamicMemoryUsage%28%29+const%3B%0A%0A++++%2F**%0A+++++*+Amount+of+bitcoins+coming+in+to+a+transaction%0A+++++*+Note+that+lightweight+clients+may+not+know+anything+besides+the+hash+of+previous+transactions%2C%0A+++++*+so+may+not+be+able+to+calculate+this.%0A+++++*%0A+++++*+%40param%5Bin%5D+tx%09transaction+for+which+we+are+checking+input+total%0A+++++*+%40return%09Sum+of+value+of+all+inputs+%28scriptSigs%29%0A+++++*%2F%0A++++CAmount+GetValueIn%28const+CTransaction%26amp%3B+tx%29+const%3B%0A%0A++++%2F%2F%21+Check+whether+all+prevouts+of+the+transaction+are+present+in+the+UTXO+set+represented+by+this+view%0A++++bool+HaveInputs%28const+CTransaction%26amp%3B+tx%29+const%3B%0A%0Aprivate%3A%0A++++CCoinsMap%3A%3Aiterator+FetchCoin%28const+COutPoint+%26amp%3Boutpoint%29+const%3B%0A%7D%3B%0A%0A%2F%2F%21+Utility+function+to+add+all+of+a+transaction%27s+outputs+to+a+cache.%0A%2F%2F+When+check+is+false%2C+this+assumes+that+overwrites+are+only+possible+for+coinbase+transactions.%0A%2F%2F+When+check+is+true%2C+the+underlying+view+may+be+queried+to+determine+whether+an+addition+is%0A%2F%2F+an+overwrite.%0A%2F%2F+TODO%3A+pass+in+a+boolean+to+limit+these+possible+overwrites+to+known%0A%2F%2F+%28pre-BIP34%29+cases.%0Avoid+AddCoins%28CCoinsViewCache%26amp%3B+cache%2C+const+CTransaction%26amp%3B+tx%2C+int+nHeight%2C+bool+check+%3D+false%29%3B%0A%0A%2F%2F%21+Utility+function+to+find+any+unspent+output+with+a+given+txid.%0A%2F%2F+This+function+can+be+quite+expensive+because+in+the+event+of+a+transaction%0A%2F%2F+which+is+not+found+in+the+cache%2C+it+can+cause+up+to+MAX_OUTPUTS_PER_BLOCK%0A%2F%2F+lookups+to+database%2C+so+it+should+be+used+with+care.%0Aconst+Coin%26amp%3B+AccessByTxid%28const+CCoinsViewCache%26amp%3B+cache%2C+const+uint256%26amp%3B+txid%29%3B%0A%0A%23endif+%2F%2F+BITCOIN_COINS_H%0A%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FBilly1900%2Farticle%2Fdetails%2F82826845%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FBilly1900%2Farticle%2Fdetails%2F82826845%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A+%3C%21--+%3Ca+class%3D%22btn%22+href%3D%22https%3A%2F%2Fpassport.csdn.net%2Faccount%2Flogin%3Futm_source%3Dcsdn_blog_pc_more_login%22+target%3D%22_self%22+id%3D%22btn-lobinreadmore%22+data-track-view%3D%27%7B%22mod%22%3A%22popu_557%22%2C%22con%22%3A%22%2Chttps%3A%2F%2Fblog.csdn.net%2FBilly1900%2Farticle%2Fdetails%2F82826845%2C%22%7D%27+data-track-click%3D%27%7B%22mod%22%3A%22popu_557%22%2C%22con%22%3A%22%2Chttps%3A%2F%2Fblog.csdn.net%2FBilly1900%2Farticle%2Fdetails%2F82826845%2C%22%7D%27%3E%E7%99%BB%E5%BD%95%E5%90%8E%E8%87%AA%E5%8A%A8%E5%B1%95%E5%BC%80%3C%2Fa%3E+--%3E+%0A%3C%2Fdiv%3E" | url_decode}}