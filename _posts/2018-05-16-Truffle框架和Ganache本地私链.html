---
layout: default
title: Truffle框架和Ganache本地私链
---

<div id="article_content" class="article_content clearfix csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post"> 
 <div class="markdown_views"> 
  <h1 id="truffle框架和ganache本地私链">Truffle框架和Ganache本地私链</h1> 
  <h2 id="安装truffle">安装Truffle</h2> 
  <blockquote> 
   <p>Truffle是一个世界级的开发环境，测试框架，以太坊的资源管理通道，致力于让以太坊上的开发变得简单。</p> 
  </blockquote> 
  <ul> 
   <li><p>Github源码地址</p> 
    <blockquote> 
     <p><a href="https://github.com/trufflesuite/truffle" rel="nofollow">https://github.com/trufflesuite/truffle</a></p> 
    </blockquote></li> 
   <li><p>安装Npm和NodeJS</p></li> 
   <li><p>安装Truffle</p> <pre class="prettyprint"><code class=" hljs cmake">npm <span class="hljs-keyword">install</span> -g truffle</code></pre></li> 
  </ul> 
  <h2 id="创建工程">创建工程</h2> 
  <ul> 
   <li><p>创建一个空工程</p> <pre class="prettyprint"><code class=" hljs ">truffle init</code></pre></li> 
   <li><p>创建包含metacoin的工程</p> <p>新版本truffle引入了box的概念，所有的示例代码都以box的形式提供。下载metacoin的示例代码：</p> <pre class="prettyprint"><code class=" hljs ">truffle unbox metacoin</code></pre></li> 
   <li><p>工程结构</p> <p>工程结构如图：</p> <p><img src="http://of0qa2hzs.bkt.clouddn.com/20180516152645842074616.png" alt="" title=""></p> 
    <ul>
     <li><p><code>contracts</code> 目录中包含 <code>Solidity</code> 合约代码，其中 <code>Migrations.sol</code> 是必须的，其他的是合约代码（这里是示例的 <code>MetaCoin</code> 代码）。</p></li> 
     <li><p><code>migrations</code> 目录中包含合约部署脚本， <code>1_initial_migration.js</code> 用来部署 <code>Migrations.sol</code> ，其他的脚本会按照顺序依次执行。</p></li> 
     <li><p><code>test</code> 目录中是测试代码。</p></li>
    </ul></li> 
   <li><p>MetaCoin</p> <p>MetaCoin的代码主要实现了三个接口：发币，查看余额，查看Eth余额。</p> <pre class="prettyprint"><code class="language-js hljs ">contract MetaCoin {
    mapping (address =&gt; uint) balances;

    event Transfer(address indexed _from, address indexed _to, uint256 _value);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">MetaCoin</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> {</span>
        balances[tx.origin] = <span class="hljs-number">10000</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendCoin</span><span class="hljs-params">(address receiver, uint amount)</span> <span class="hljs-title">public</span> <span class="hljs-title">returns</span><span class="hljs-params">(bool sufficient)</span> {</span>
        <span class="hljs-keyword">if</span> (balances[msg.sender] &lt; amount) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        balances[msg.sender] -= amount;
        balances[receiver] += amount;
        Transfer(msg.sender, receiver, amount);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBalanceInEth</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span><span class="hljs-params">(uint)</span>{</span>
        <span class="hljs-keyword">return</span> ConvertLib.convert(getBalance(addr),<span class="hljs-number">2</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getBalance</span><span class="hljs-params">(address addr)</span> <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span><span class="hljs-params">(uint)</span> {</span>
        <span class="hljs-keyword">return</span> balances[addr];
    }
}</code></pre></li> 
  </ul> 
  <h2 id="安装以太坊客户端ganache">安装以太坊客户端Ganache</h2> 
  <p>智能合约必须要部署到链上进行测试。可以选择部署到一些公共的测试链比如 <code>Rinkeby</code> 或者 <code>Ropsten</code> 上，缺点是：<code>部署和测试时间比较长</code>，<code>需要申请一些假的代币</code>。所以对于开发者，最好的方式是部署到私链上。 <br> <code>Ganache</code>是​​您以太坊开发的个人区块链。他的前身是 <code>testRPC</code> ，很多旧的教程介绍的都是 <code>testRPC</code> 。</p> 
  <ul> 
   <li><p>GitHub源码地址</p> 
    <blockquote> 
     <p><a href="https://github.com/trufflesuite/ganache" rel="nofollow">https://github.com/trufflesuite/ganache</a></p> 
    </blockquote></li> 
   <li><p>图像界面</p> <p><code>Ganache</code> 提供图像界面（挺好用的）的版本：</p> 
    <blockquote> 
     <p><a href="https://github.com/trufflesuite/ganache/releases" rel="nofollow">https://github.com/trufflesuite/ganache/releases</a></p> 
    </blockquote></li> 
   <li><p>命令行版本</p> <pre class="prettyprint"><code class=" hljs lasso">npm install <span class="hljs-attribute">-g</span> ganache<span class="hljs-attribute">-cli</span>  </code></pre></li> 
  </ul> 
  <h2 id="编译和部署合约">编译和部署合约</h2> 
  <ul> 
   <li><p><code>Ganache</code> 默认运行在本地 <code>7545</code> 端口，运行后默认创建10个账号，每个账号里有100ETH的余额。</p> <p><img src="http://of0qa2hzs.bkt.clouddn.com/201805161526461060219.png" alt="" title=""></p></li> 
   <li><p>修改truffle.js</p> <p>要部署到链上，需要把IP、端口、网络ID告诉truffle。修改truffle.js：</p> <pre class="prettyprint"><code class=" hljs coffeescript"><span class="hljs-built_in">module</span>.<span class="hljs-built_in">exports</span> = {  
    <span class="hljs-attribute">networks</span>: {  
        <span class="hljs-attribute">development</span>: {  
            <span class="hljs-attribute">host</span>: <span class="hljs-string">'localhost'</span>,  
            <span class="hljs-attribute">port</span>: <span class="hljs-string">'7545'</span>,  
            <span class="hljs-attribute">network_id</span>: <span class="hljs-string">'*'</span> <span class="hljs-regexp">//</span> Match any network id  
        }  
    }  
}; </code></pre></li> 
   <li><p>编译和部署</p> <pre class="prettyprint"><code class=" hljs ">truffle compile  
truffle migrate</code></pre></li> 
  </ul> 
  <h2 id="测试合约">测试合约</h2> 
  <ul> 
   <li><p>测试内容</p> <p>MetaCoin的示例代码里已经把测试代码写好了，主要测试 <code>MetaCoin</code> 的接口是否可用:</p> <pre class="prettyprint"><code class="language-js hljs ">contract TestMetacoin {

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testInitialBalanceUsingDeployedContract</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> {</span>
    MetaCoin meta = MetaCoin(DeployedAddresses.MetaCoin());

    uint expected = <span class="hljs-number">10000</span>;

    Assert.equal(meta.getBalance(tx.origin), expected, <span class="hljs-string">"Owner should have 10000 MetaCoin initially"</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testInitialBalanceWithNewMetaCoin</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> {</span>
    MetaCoin meta = <span class="hljs-keyword">new</span> MetaCoin();

    uint expected = <span class="hljs-number">10000</span>;

    Assert.equal(meta.getBalance(tx.origin), expected, <span class="hljs-string">"Owner should have 10000 MetaCoin initially"</span>);
}

}</code></pre></li> 
   <li><p>测试合约</p> <p>直接输入测试合约的命令：</p> <pre class="prettyprint"><code class=" hljs ">truffle test</code></pre> <p>结果显示5个测试都通过：</p> <p><img src="http://of0qa2hzs.bkt.clouddn.com/20180516152646197069199.png" alt="" title=""></p></li> 
   <li><p>Ganache</p> <p>查看Ganache上的运行结果：</p> 
    <ul>
     <li><p>Accounts标签：第一个账户里ETH略有减少，因为交易消耗了gas</p></li> 
     <li><p>Blocks标签：Ganache是自动挖矿，生成了6个新区块，每个区块里有一个交易</p></li> 
     <li><p>Transactions标签：有6笔新交易，可以点开看交易详情</p></li> 
     <li><p>Logs标签：显示交易和挖矿日志</p></li>
    </ul> <p><img src="http://of0qa2hzs.bkt.clouddn.com/20180516152646230427177.png" alt="" title=""></p></li> 
  </ul> 
 </div> 
 <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/markdown_views-ea0013b516.css"> 
</div> 
<div class="hide-article-box text-center"> 
 <a class="btn btn-red-hollow" id="btn-readmore" data-track-view="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/MyHerux/article/details/80340095,&quot;}" data-track-click="{&quot;mod&quot;:&quot;popu_376&quot;,&quot;con&quot;:&quot;,https://blog.csdn.net/MyHerux/article/details/80340095,&quot;}">阅读更多</a> 
</div>