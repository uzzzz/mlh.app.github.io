---
layout: default
title: 生死看淡，不服就GAN(八)----WGAN的改进版本WGAN-GP
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22article-copyright%22%3E%0A+++%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%EF%BC%9A%E8%BD%AC%E8%BD%BD%E8%AF%B7%E6%B3%A8%E6%98%8E%E5%87%BA%E5%A4%84%EF%BC%88%E4%BD%9C%E8%80%85%EF%BC%9AEphemeroptera%EF%BC%89+https%3A%2F%2Fblog.csdn.net%2FEphemeroptera%2Farticle%2Fdetails%2F89074498+%0A+%3C%2Fdiv%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-f57960eb32.css%22%3E+%0A+%3Cdiv+id%3D%22content_views%22+class%3D%22markdown_views+prism-tomorrow-night-eighties%22%3E+%0A++%3C%21--+flowchart+%E7%AE%AD%E5%A4%B4%E5%9B%BE%E6%A0%87+%E5%8B%BF%E5%88%A0+--%3E+%0A++%3Csvg+xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22+style%3D%22display%3A+none%3B%22%3E%0A+++%3Cpath+stroke-linecap%3D%22round%22+d%3D%22M5%2C0+0%2C2.5+5%2C5z%22+id%3D%22raphael-marker-block%22+style%3D%22-webkit-tap-highlight-color%3A+rgba%280%2C+0%2C+0%2C+0%29%3B%22%3E%3C%2Fpath%3E%0A++%3C%2Fsvg%3E+%0A++%3Ch4%3E%3Ca+id%3D%22WGANGPWGANWGAN_GANWGANGPWGANWGANLipschitz_weight_clipping_0%22%3E%3C%2Fa%3EWGAN-GP%E6%98%AF%E9%92%88%E5%AF%B9WGAN%E7%9A%84%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98%E6%8F%90%E5%87%BA%E6%9D%A5%E7%9A%84%EF%BC%8CWGAN%E5%9C%A8%E7%9C%9F%E5%AE%9E%E7%9A%84%E5%AE%9E%E9%AA%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BE%9D%E6%97%A7%E5%AD%98%E5%9C%A8%E7%9D%80%E8%AE%AD%E7%BB%83%E5%9B%B0%E9%9A%BE%E3%80%81%E6%94%B6%E6%95%9B%E9%80%9F%E5%BA%A6%E6%85%A2%E7%9A%84+%E9%97%AE%E9%A2%98%EF%BC%8C%E7%9B%B8%E6%AF%94%E8%BE%83%E4%BC%A0%E7%BB%9FGAN%E5%9C%A8%E5%AE%9E%E9%AA%8C%E4%B8%8A%E6%8F%90%E5%8D%87%E4%B8%8D%E6%98%AF%E5%BE%88%E6%98%8E%E6%98%BE%E3%80%82WGAN-GP%E5%9C%A8%E6%96%87%E7%AB%A0%E4%B8%AD%E6%8C%87%E5%87%BA%E4%BA%86WGAN%E5%AD%98%E5%9C%A8%E9%97%AE%E9%A2%98%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%8C%E9%82%A3%E5%B0%B1%E6%98%AFWGAN%E5%9C%A8%E5%A4%84%E7%90%86Lipschitz%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6%E6%97%B6%E7%9B%B4%E6%8E%A5%E9%87%87%E7%94%A8%E4%BA%86+weight+clipping%E3%80%82%E7%9B%B8%E5%85%B3%E8%AE%B2%E8%A7%A3%E8%AF%B7%E5%8F%82%E8%80%83%3C%2Fh4%3E+%0A++%3Cp%3E%3Ca+href%3D%22https%3A%2F%2Fblog.csdn.net%2Fweixin_41036461%2Farticle%2Fdetails%2F82385334%22+rel%3D%22nofollow%22%3EWGAN-GP%E7%9A%84%E4%BB%8B%E7%BB%8D%3C%2Fa%3E%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22cifarcifar6_3%22%3E%3C%2Fa%3E%E5%90%8C%E5%BE%80%E6%9C%9F%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%BE%9D%E7%84%B6%E4%BB%A5%E7%94%9F%E6%88%90cifar%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%AD%E9%A9%AC%E7%9A%84%E5%BD%A9%E8%89%B2%E5%9B%BE%E7%89%87%E4%B8%BA%E4%BE%8B%EF%BC%8C%E5%85%B3%E4%BA%8Ecifar%E6%95%B0%E6%8D%AE%E9%9B%86%E7%9A%84%E8%AF%BB%E5%8F%96%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%AA%8C%E8%AF%81%E8%AF%B7%E5%8F%82%E8%80%83%E7%AC%AC6%E6%9C%9F%EF%BC%9A%3C%2Fh4%3E+%0A++%3Cp%3E%3Ca+href%3D%22https%3A%2F%2Fblog.csdn.net%2FEphemeroptera%2Farticle%2Fdetails%2F89019873%22+rel%3D%22nofollow%22%3E%E7%94%A8DCGAN%E7%94%9F%E6%88%90%E9%A9%AC%E7%9A%84%E5%BD%A9%E8%89%B2%E5%9B%BE%E7%89%87%3C%2Fa%3E%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22WGANGP_6%22%3E%3C%2Fa%3E%E4%B8%8B%E9%9D%A2%E7%BB%99%E5%87%BAWGAN-GP%E6%A1%86%E6%9E%B6%3C%2Fh4%3E+%0A++%3Cpre%3E%3Ccode%3E%22%22%22%0A-------------------------------------------------------%E7%94%9F%E6%AD%BB%E7%9C%8B%E6%B7%A1%EF%BC%8C%E4%B8%8D%E6%9C%8D%E5%B0%B1GAN-------------------------------------------------------------------------%0APROJECT%3A+CIFAR10_WGAN-GP%0AAuthor%3A+Ephemeroptera%0ADate%3A2019-3-19%0AQQ%3A605686962%0A%0A%22%22%22%0A%22%22%22%0AWGAN%E8%AF%B4%E6%98%8E%EF%BC%9A%E7%9B%B8%E6%AF%94%E8%BE%83WGAN%EF%BC%8CWGAN-GP%E6%8F%90%E5%87%BA%E4%BB%A5%E4%B8%8B%E6%94%B9%E8%BF%9B%EF%BC%9A%0A++++++++++++++++++++++++++++++++++++++++%EF%BC%881%EF%BC%89%E7%94%A8%E5%AF%B9%E5%88%A4%E5%88%AB%E5%99%A8%E6%A2%AF%E5%BA%A6%E6%83%A9%E7%BD%9A%E5%8F%96%E4%BB%A3WGAN%E7%9A%84%E5%88%A4%E5%86%B3%E5%99%A8%E6%9D%83%E5%80%BC%E5%8C%BA%E9%97%B4%E6%88%AA%E6%96%AD%0A++++++++++++++++++++++++++++++++++++++++%EF%BC%882%EF%BC%89%E5%88%A4%E5%88%AB%E5%99%A8%E5%8F%96%E6%B6%88BN%E6%93%8D%E4%BD%9C%0A++++++++++++++++++++++++++++++++++++++++%EF%BC%883%EF%BC%89%E4%BC%98%E5%8C%96%E5%99%A8%E4%BD%BF%E7%94%A8ADAM%0A%22%22%22%0A%23+%E5%AF%BC%E5%85%A5%E5%8C%85%0Aimport+numpy+as+np%0Aimport+tensorflow+as+tf%0Aimport+pickle%0Aimport+TFRecordTools%0Aimport+time%0A%0A%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23+%E8%AE%BE%E7%BD%AE%E5%8F%82%E6%95%B0+%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%0A%0Areal_shape+%3D+%5B-1%2C32%2C32%2C3%5D+%23+%E7%9C%9F%E5%AE%9E%E6%A0%B7%E6%9C%AC%E5%B0%BA%E5%AF%B8%0Adata_total+%3D+5000+%23+%E7%9C%9F%E5%AE%9E%E6%A0%B7%E6%9C%AC%E4%B8%AA%E6%95%B0%0Abatch_size+%3D+64+%23+%E6%89%B9%E5%A4%A7%E5%B0%8F%0Anoise_size+%3D+128+%23+%E5%99%AA%E5%A3%B0%E7%BB%B4%E5%BA%A6%0Amax_iters+%3D+50000+%23%E7%9A%84%E6%9C%80%E5%A4%A7%E8%BF%AD%E4%BB%A3%E6%AC%A1%E6%95%B0%0Alearning_rate+%3D+5e-5+%23+%E5%AD%A6%E4%B9%A0%E7%8E%87%0Abeta1+%3D+0.5%23+ADAM%E5%8F%82%E6%95%B01%0Abeta2+%3D+0.9%23+ADAM%E5%8F%82%E6%95%B02%0ACRITIC_NUM+%3D+5+%23+%E6%AF%8F%E6%AC%A1%E8%BF%AD%E4%BB%A3%E5%88%A4%E5%88%AB%E5%99%A8%E8%AE%AD%E7%BB%83%E6%AC%A1%E6%95%B0%0Alam+%3D+10+%23%E6%A2%AF%E5%BA%A6%E6%83%A9%E7%BD%9A%E6%9D%83%E9%87%8D%0A%0A%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23+%E5%AE%9A%E4%B9%89%E7%94%9F%E6%88%90%E5%99%A8%E5%92%8C%E5%88%A4%E5%88%AB%E5%99%A8+%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%0A%0A%23+%E5%AE%9A%E4%B9%89%E7%94%9F%E6%88%90%E5%99%A8%EF%BC%8832x32%E5%9B%BE%E7%89%87%EF%BC%89%0Adef+Generator_DC_32x32%28z%2C+channel%2C+is_train%3DTrue%29%3A%0A++++%22%22%22%0A++++%3Aparam+z%3A+%E5%99%AA%E5%A3%B0%E4%BF%A1%E5%8F%B7%EF%BC%8Ctensor%E7%B1%BB%E5%9E%8B%0A++++%3Aparam+channnel%3A+%E7%94%9F%E6%88%90%E5%9B%BE%E7%89%87%E7%9A%84%E9%80%9A%E9%81%93%E6%95%B0%0A++++%3Aparam+is_train%3A+%E6%98%AF%E5%90%A6%E4%B8%BA%E8%AE%AD%E7%BB%83%E7%8A%B6%E6%80%81%EF%BC%8C%E8%AF%A5%E5%8F%82%E6%95%B0%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BA%8E%E4%BD%9C%E4%B8%BAbatch_normalization%E6%96%B9%E6%B3%95%E4%B8%AD%E7%9A%84%E5%8F%82%E6%95%B0%E4%BD%BF%E7%94%A8%28%E8%AE%AD%E7%BB%83%E6%97%B6%E5%80%99%E5%BC%80%E5%90%AF%29%0A++++%22%22%22%0A++++%23+%E8%AE%AD%E7%BB%83%E6%97%B6%E7%94%9F%E6%88%90%E5%99%A8%E4%B8%8D%E5%85%81%E8%AE%B8%E5%A4%8D%E7%94%A8%0A++++with+tf.variable_scope%28%22generator%22%2C+reuse%3D%28not+is_train%29%29%3A%0A%0A++++++++%23+layer1%3A+noise_dim+--%26gt%3B+4*4*512+--%26gt%3B+4x4x512+--%26gt%3BBN%2Brelu%0A++++++++layer1+%3D+tf.layers.dense%28z%2C+4+*+4+*+512%29%0A++++++++layer1+%3D+tf.reshape%28layer1%2C+%5B-1%2C+4%2C+4%2C+512%5D%29%0A++++++++layer1+%3D+tf.layers.batch_normalization%28layer1%2C+training%3Dis_train%2C%29%0A++++++++layer1+%3D+tf.nn.relu%28layer1%29%0A++++++++%23+layer1+%3D+tf.nn.dropout%28layer1%2C+keep_prob%3D0.8%29%23+dropout%0A%0A++++++++%23+layer2%3A+deconv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%3A4x4x512+--%26gt%3B+8x8x256+--%26gt%3B+BN%2Brelu%0A++++++++layer2+%3D+tf.layers.conv2d_transpose%28layer1%2C+256%2C+3%2C+strides%3D2%2C+padding%3D%27same%27%2C%0A++++++++++++++++++++++++++++++++++++++++++++kernel_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%2C%0A++++++++++++++++++++++++++++++++++++++++++++bias_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%29%0A++++++++layer2+%3D+tf.layers.batch_normalization%28layer2%2C+training%3Dis_train%29%0A++++++++layer2+%3D+tf.nn.relu%28layer2%29%0A++++++++%23+layer2+%3D+tf.nn.dropout%28layer2%2C+keep_prob%3D0.8%29%23+dropout%0A%0A++++++++%23+layer3%3A+deconv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%3A8x8x256+--%26gt%3B+16x16x128+--%26gt%3B+BN%2Brelu%0A++++++++layer3+%3D+tf.layers.conv2d_transpose%28layer2%2C+128%2C+3%2C+strides%3D2%2C+padding%3D%27same%27%2C%0A++++++++++++++++++++++++++++++++++++++++++++kernel_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%2C%0A++++++++++++++++++++++++++++++++++++++++++++bias_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%29%0A++++++++layer3+%3D+tf.layers.batch_normalization%28layer3%2C+training%3Dis_train%29%0A++++++++layer3+%3D+tf.nn.relu%28layer3%29%0A++++++++%23+layer3+%3D+tf.nn.dropout%28layer3%2C+keep_prob%3D0.8%29%23+dropout%0A%0A++++++++%23+layer4%3A+deconv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%3A16x16x128+--%26gt%3B+32x32x64--%26gt%3B+BN%2Brelu%0A++++++++layer4+%3D+tf.layers.conv2d_transpose%28layer3%2C+64%2C+3%2C+strides%3D2%2C+padding%3D%27same%27%2C%0A++++++++++++++++++++++++++++++++++++++++++++kernel_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%2C%0A++++++++++++++++++++++++++++++++++++++++++++bias_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%29%0A++++++++layer4+%3D+tf.layers.batch_normalization%28layer4%2C+training%3Dis_train%29%0A++++++++layer4+%3D+tf.nn.relu%28layer4%29%0A++++++++%23+layer4+%3D+tf.nn.dropout%28layer3%2C+keep_prob%3D0.8%29%23+dropout%0A%0A++++++++%23+logits%3A+deconv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%3A32x32x64+--%26gt%3B+32x32x3%0A++++++++logits+%3D+tf.layers.conv2d_transpose%28layer4%2C+channel%2C+3%2C+strides%3D1%2C+padding%3D%27same%27%2C%0A++++++++++++++++++++++++++++++++++++++++++++kernel_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%2C%0A++++++++++++++++++++++++++++++++++++++++++++bias_initializer%3Dtf.random_normal_initializer%280%2C+0.02%29%29%0A++++++++%23+outputs%0A++++++++outputs+%3D+tf.tanh%28logits%29%0A%0A++++++++return+logits%2Coutputs%0A%0A%23+%E5%AE%9A%E4%B9%89%E5%88%A4%E5%88%AB%E5%99%A8%EF%BC%8832x32%EF%BC%89%0Adef+Discriminator_DC_32x32%28inputs_img%2C+reuse%3DFalse%2C+GAN+%3D+False%2CGP%3D+False%2Calpha%3D0.2%29%3A%0A++++%22%22%22%0A++++%40param+inputs_img%3A+%E8%BE%93%E5%85%A5%E5%9B%BE%E7%89%87%EF%BC%8Ctensor%E7%B1%BB%E5%9E%8B%0A++++%40param+reuse%3A%E5%88%A4%E5%88%AB%E5%99%A8%E5%A4%8D%E7%94%A8%0A++++%40param+GP%3A+%E4%BD%BF%E7%94%A8WGAN-GP%E6%97%B6%E5%85%B3%E9%97%ADBN%0A++++%40param+alpha%3A+Leaky+ReLU%E7%B3%BB%E6%95%B0%0A++++%22%22%22%0A%0A++++with+tf.variable_scope%28%22discriminator%22%2C+reuse%3Dreuse%29%3A%0A%0A++++++++%23+layer1%3A+conv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%2Blrelu+--%26gt%3B32x32x3+to+16x16x128%0A++++++++layer1+%3D+tf.layers.conv2d%28inputs_img%2C+128%2C+3%2C+strides%3D2%2C+padding%3D%27same%27%29%0A++++++++if+GP+is+False%3A%0A++++++++++++layer1+%3D+tf.layers.batch_normalization%28layer1%2C+training%3DTrue%29%0A++++++++layer1+%3D+tf.nn.leaky_relu%28layer1%2Calpha%3Dalpha%29%0A++++++++%23+layer1+%3D+tf.nn.dropout%28layer1%2C+keep_prob%3D0.8%29%0A%0A++++++++%23+layer2%3A+conv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%2BBN%2Blrelu+--%26gt%3B16x16x128+to+8x8x256%0A++++++++layer2+%3D+tf.layers.conv2d%28layer1%2C+256%2C+3%2C+strides%3D2%2C+padding%3D%27same%27%29%0A++++++++if+GP+is+False%3A%0A++++++++++++layer2+%3D+tf.layers.batch_normalization%28layer2%2C+training%3DTrue%29%0A++++++++layer2+%3D+tf.nn.leaky_relu%28layer2%2C+alpha%3Dalpha%29%0A++++++++%23+layer2+%3D+tf.nn.dropout%28layer2%2C+keep_prob%3D0.8%29%0A%0A++++++++%23+layer3%3A+conv%28ks%3D3x3%2Cs%3D2%2Cpadding%3Dsame%29%2BBN%2Blrelu+--%26gt%3B8x8x256+to+4x4x512%0A++++++++layer3+%3D+tf.layers.conv2d%28layer2%2C+512%2C+3%2C+strides%3D2%2C+padding%3D%27same%27%29%0A++++++++if+GP+is+False%3A%0A++++++++++++layer3+%3D+tf.layers.batch_normalization%28layer3%2C+training%3DTrue%29%0A++++++++layer3+%3D+tf.nn.leaky_relu%28layer3%2C+alpha%3Dalpha%29%0A++++++++layer3+%3D+tf.reshape%28layer3%2C+%5B-1%2C+4*4*+512%5D%29%0A++++++++%23+layer3+%3D+tf.nn.dropout%28layer2%2C+keep_prob%3D0.8%29%0A%0A++++++++%23+logits%2Coutput%3A%0A++++++++logits+%3D+tf.layers.dense%28layer3%2C+1%29%0A++++++++%22WGAN%3A%E5%8E%BB%E9%99%A4sigmoid%22%0A++++++++if+GAN%3A%0A++++++++++++outputs+%3D+None%0A++++++++else%3A%0A++++++++++++outputs+%3D+tf.sigmoid%28logits%29%0A%0A++++++++return+logits%2C+outputs%0A%0A%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23+%E5%AE%9A%E4%B9%89%E8%AE%A1%E7%AE%97%E5%9B%BE%EF%BC%88%E7%BD%91%E7%BB%9C%EF%BC%89+%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%0A%0A%23----------------------%E8%BE%93%E5%85%A5----------------%0A%0Ainputs_real+%3D+tf.placeholder%28tf.float32%2C+%5BNone%2C+real_shape%5B1%5D%2C+real_shape%5B2%5D%2C+real_shape%5B3%5D%5D%2C+name%3D%27inputs_real%27%29+%23+%E7%9C%9F%E5%AE%9E%E6%A0%B7%E6%9C%AC%E8%BE%93%E5%85%A5%0Ainputs_noise+%3D+tf.placeholder%28tf.float32%2C+%5BNone%2C+noise_size%5D%2C+name%3D%27inputs_noise%27%29+%23+%E7%94%9F%E6%88%90%E6%A0%B7%E6%9C%AC%E8%BE%93%E5%85%A5%0A%0A%23-------------------%E7%94%9F%E6%88%90%E5%92%8C%E5%88%A4%E5%88%AB--------------%0A%23+%E7%94%9F%E6%88%90%E6%A0%B7%E6%9C%AC%0A_%2Cg_outputs+%3D+Generator_DC_32x32%28inputs_noise%2C+real_shape%5B3%5D%2C+is_train%3DTrue%29+%23+%E8%AE%AD%E7%BB%83%E7%94%9F%E6%88%90%E5%99%A8%0A_%2Cg_test+%3D+Generator_DC_32x32%28inputs_noise%2C+real_shape%5B3%5D%2C+is_train%3DFalse%29+%23+%E6%B5%8B%E8%AF%95%E7%94%9F%E6%88%90%E5%99%A8%0A%23+%E5%88%A4%E5%88%AB%E6%A0%B7%E6%9C%AC%0A%27WGAN-GP%3A%E5%88%A4%E5%88%AB%E5%99%A8%E5%BA%9F%E9%99%A4%E6%89%B9%E5%BD%92%E4%B8%80%E5%8C%96%27%0Ad_logits_real%2C+_+%3D+Discriminator_DC_32x32%28inputs_real%2CGAN%3DTrue%2CGP%3DTrue%29+%23%E8%AF%86%E5%88%AB%E7%9C%9F%E6%A0%B7%E6%9C%AC%0Ad_logits_fake%2C+_+%3D+Discriminator_DC_32x32%28g_outputs%2CGAN%3DTrue%2CGP%3DTrue%2Creuse%3DTrue%29+%23%E8%AF%86%E5%88%AB%E5%81%87%E6%A0%B7%E6%9C%AC%0A%0A%23------------%E5%AE%9A%E4%B9%89%E5%8E%9F%E5%A7%8BGAN%E7%9A%84%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0--------------%0A%22WGAN%3A%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%E5%8E%BBlog%EF%BC%8C%E9%87%87%E7%94%A8Wasserstein%E8%B7%9D%E7%A6%BB%E5%BD%A2%E5%BC%8F%22%0A%23+%E7%94%9F%E6%88%90%E5%99%A8%0Ag_loss+%3D+tf.reduce_mean%28-d_logits_fake%29%0A%23+%E5%88%A4%E5%88%AB%E5%99%A8%0Ad_loss+%3D+tf.reduce_mean%28d_logits_fake+-+d_logits_real%29%0A%27WGAN-GP%3A%E5%8A%A0%E5%85%A5%E5%88%A4%E5%88%AB%E5%99%A8%E6%A2%AF%E5%BA%A6%E6%83%A9%E7%BD%9A%E9%A1%B9%27%0A%23+%E5%88%A4%E5%88%AB%E5%99%A8%E6%A2%AF%E5%BA%A6%E6%83%A9%E7%BD%9A%E9%A1%B9%0Aalpha_dist+%3D+tf.contrib.distributions.Uniform%28low%3D0.%2C+high%3D1.%29%23%E8%8E%B7%E5%8F%96%5B0%2C1%5D%E4%B9%8B%E9%97%B4%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%0Aalpha+%3D+alpha_dist.sample%28%28batch_size%2C+1%2C+1%2C+1%29%29%0Ainterpolated+%3D+inputs_real+%2B+alpha*%28g_outputs-inputs_real%29%23+%E5%AF%B9%E7%9C%9F%E5%AE%9E%E6%A0%B7%E6%9C%AC%E5%92%8C%E7%94%9F%E6%88%90%E6%A0%B7%E6%9C%AC%E4%B9%8B%E9%97%B4%E6%8F%92%E5%80%BC%0Ainte_logit%2C_+%3D+Discriminator_DC_32x32%28interpolated%2C+GAN%3DTrue%2CGP%3DTrue%2Creuse%3DTrue%29%0Agradients+%3D+tf.gradients%28inte_logit%2C+%5Binterpolated%2C%5D%29%5B0%5D%23+%E6%B1%82%E5%BE%97%E5%88%A4%E5%88%AB%E5%99%A8%E6%A2%AF%E5%BA%A6%0Agrad_l2+%3D+tf.sqrt%28tf.reduce_sum%28tf.square%28gradients%29%2C+axis%3D%5B1%2C2%2C3%5D%29%29%0Agradient_penalty+%3D+tf.reduce_mean%28%28grad_l2-1%29**2%29+%23+%E5%AE%9A%E4%B9%89%E6%83%A9%E7%BD%9A%E9%A1%B9%0A%23+%E5%8A%A0%E5%85%A5d_loss%0Ad_loss%2B%3Dgradient_penalty*lam%0A%23-------------------%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B-----------------%0A%23+%E5%88%86%E5%88%AB%E8%8E%B7%E5%8F%96%E7%94%9F%E6%88%90%E5%99%A8%E5%92%8C%E5%88%A4%E5%88%AB%E5%99%A8%E7%9A%84%E5%8F%98%E9%87%8F%E7%A9%BA%E9%97%B4%0Atrain_vars+%3D+tf.trainable_variables%28%29%0Ag_vars+%3D+%5Bvar+for+var+in+train_vars+if+var.name.startswith%28%22generator%22%29%5D%0Ad_vars+%3D+%5Bvar+for+var+in+train_vars+if+var.name.startswith%28%22discriminator%22%29%5D%0A%0A%23+Optimizer%0Awith+tf.control_dependencies%28tf.get_collection%28tf.GraphKeys.UPDATE_OPS%29%29%3A%23+%E4%BF%9D%E8%AF%81%E5%88%86%E5%B8%83%E7%99%BD%E5%8C%96%E5%85%88%E5%AE%8C%E6%88%90%0A++++g_train_opt+%3D+tf.train.AdamOptimizer%28learning_rate%3Dlearning_rate%2C+beta1%3Dbeta1%2C+beta2%3Dbeta2%29.minimize%28g_loss%2C+var_list%3Dg_vars%29%0A++++d_train_opt+%3D+tf.train.AdamOptimizer%28learning_rate%3Dlearning_rate%2C+beta1%3Dbeta1%2C+beta2%3Dbeta2%29.minimize%28d_loss%2C+var_list%3Dd_vars%29%0A%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23+%E8%B0%83%E7%94%A8TFRecord%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE+%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%0A%0A%23+%E8%AF%BB%E5%8F%96TFR%2C%E4%B8%8D%E6%89%93%E4%B9%B1%E6%96%87%E4%BB%B6%E9%A1%BA%E5%BA%8F%EF%BC%8C%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%BC%80%E5%90%AF%E5%A4%9A%E7%BA%BF%E7%A8%8B%0A%5Bdata%2Clabel%5D+%3D+TFRecordTools.ReadFromTFRecord%28sameName%3D+r%27.%5CTFR%5Cclass7-*%27%2CisShuffle%3D+False%2Cdatatype%3D+tf.float64%2C%0A++++++++++++++++++++++++++++++++labeltype%3D+tf.int32%2CisMultithreading%3D+True%29%0A%23+%E6%89%B9%E9%87%8F%E5%A4%84%E7%90%86%EF%BC%8C%E9%80%81%E5%85%A5%E9%98%9F%E5%88%97%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE%E5%A4%A7%E5%B0%8F%EF%BC%8C%E6%89%93%E4%B9%B1%E6%95%B0%E6%8D%AE%E9%A1%B9%EF%BC%8C%E8%AE%BE%E7%BD%AE%E6%89%B9%E6%AC%A1%E5%A4%A7%E5%B0%8F64%0A%5Bdata_batch%2Clabel_batch%5D+%3D+TFRecordTools.DataBatch%28data%2Clabel%2CdataSize%3D+32*32*3%2ClabelSize%3D+1%2C%0A+++++++++++++++++++++++++++++++++++++++++++++++++++isShuffle%3D+True%2CbatchSize%3D+64%29%0A%0A%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23+%E8%BF%AD%E4%BB%A3+%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%23%0A%0A%23+%E5%AD%98%E5%82%A8%E8%AE%AD%E7%BB%83%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%94%9F%E6%88%90%E6%97%A5%E5%BF%97%0AGenLog+%3D+%5B%5D%0A%23+%E5%AD%98%E5%82%A8loss%0Alosses+%3D+%5B%5D%0A%23+%E4%BF%9D%E5%AD%98%E7%94%9F%E6%88%90%E5%99%A8%E5%8F%98%E9%87%8F%28%E4%BB%85%E4%BF%9D%E5%AD%98%E7%94%9F%E6%88%90%E5%99%A8%E6%A8%A1%E5%9E%8B%EF%BC%8C%E4%BF%9D%E5%AD%98%E6%9C%80%E8%BF%915%E4%B8%AA%29%0Asaver+%3D+tf.train.Saver%28var_list%3D%5Bvar+for+var+in+tf.trainable_variables%28%29%0A+++++++++++++++++++++++++++++++++if+var.name.startswith%28%22generator%22%29%5D%2Cmax_to_keep%3D5%29%0A%23+%E5%AE%9A%E4%B9%89%E6%89%B9%E9%A2%84%E5%A4%84%E7%90%86%0Adef+batch_preprocess%28data_batch%29%3A%0A++++%23+%E6%8F%90%E5%8F%96%E6%89%B9%E6%95%B0%E6%8D%AE%0A++++batch+%3D+sess.run%28data_batch%29%0A++++%23+%E6%95%B4%E7%90%86%E6%88%90RGB%EF%BC%88Nx32x32x3%EF%BC%89%0A++++batch_images+%3D+np.reshape%28batch%2C+%5B-1%2C+3%2C+32%2C+32%5D%29.transpose%28%280%2C+2%2C+3%2C+1%29%29++%23+%28-1%2C32%2C32%2C3%29%0A++++%23+scale+to+-1%2C+1%0A++++batch_images+%3D+batch_images+*+2+-+1%0A++++return++batch_images%0A%0A%23+%E7%94%9F%E6%88%90%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95%E4%BF%9D%E5%AD%98%E7%94%9F%E6%88%90%E4%BF%A1%E6%81%AF%0Adef+GEN_DIR%28%29%3A%0A++++import+os%0A++++if+not+os.path.isdir%28%27ckpt%27%29%3A%0A++++++++print%28%27%E6%96%87%E4%BB%B6%E5%A4%B9ckpt%E6%9C%AA%E5%88%9B%E5%BB%BA%EF%BC%8C%E7%8E%B0%E5%9C%A8%E5%9C%A8%E5%BD%93%E5%89%8D%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%88%9B%E5%BB%BA..%27%29%0A++++++++os.mkdir%28%27ckpt%27%29%0A++++if+not+os.path.isdir%28%27trainLog%27%29%3A%0A++++++++print%28%27%E6%96%87%E4%BB%B6%E5%A4%B9ckpt%E6%9C%AA%E5%88%9B%E5%BB%BA%EF%BC%8C%E7%8E%B0%E5%9C%A8%E5%9C%A8%E5%BD%93%E5%89%8D%E7%9B%AE%E5%BD%95%E4%B8%8B%E5%88%9B%E5%BB%BA..%27%29%0A++++++++os.mkdir%28%27trainLog%27%29%0A%0A%23+%E5%BC%80%E5%90%AF%E4%BC%9A%E8%AF%9D%0Awith+tf.Session%28%29+as+sess%3A%0A++++%23+%E7%94%9F%E6%88%90%E7%9B%B8%E5%85%B3%E7%9B%AE%E5%BD%95%0A++++GEN_DIR%28%29%0A%0A++++%23+%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%98%E9%87%8F%0A++++init+%3D+%28tf.global_variables_initializer%28%29%2C+tf.local_variables_initializer%28%29%29%0A++++sess.run%28init%29%0A%0A++++%23+%E5%BC%80%E5%90%AF%E5%8D%8F%E8%B0%83%E5%99%A8%0A++++coord+%3D+tf.train.Coordinator%28%29%0A++++%23+%E5%90%AF%E5%8A%A8%E7%BA%BF%E7%A8%8B%0A++++threads+%3D+tf.train.start_queue_runners%28sess%3Dsess%2C+coord%3Dcoord%29%0A%0A++++time_start+%3D+time.time%28%29+%23+%E5%BC%80%E5%A7%8B%E8%AE%A1%E6%97%B6%0A++++for+steps+in+range%28max_iters%29%3A%0A++++++++steps+%2B%3D+1%0A%0A++++++++%23+%E5%88%A4%E5%88%AB%E5%99%A8%E9%87%8D%E5%A4%8D%E8%AE%AD%E7%BB%83%E8%AE%BE%E7%BD%AE%0A++++++++if+steps+%26lt%3B+25+or+steps+%25+500+%3D%3D+0%3A%0A++++++++++++critic_num+%3D+100%0A++++++++else%3A%0A++++++++++++critic_num+%3D+CRITIC_NUM%0A%0A++++++++%23+%E9%87%8D%E5%A4%8D%E8%AE%AD%E7%BB%83%E5%88%A4%E5%88%AB%E5%99%A8%0A++++++++for+i+in+range%28CRITIC_NUM%29%3A%0A++++++++++++batch_images+%3D+batch_preprocess%28data_batch%29++%23+images%0A++++++++++++batch_noise+%3D+np.random.normal%28size%3D%28batch_size%2C+noise_size%29%29++%23+noise%28normal%29%0A++++++++++++_+%3D+sess.run%28d_train_opt%2C+feed_dict%3D%7Binputs_real%3A+batch_images%2C%0A+++++++++++++++++++++++++++++++++++++++++++++++++inputs_noise%3A+batch_noise%7D%29%0A%0A++++++++%23+%E8%AE%AD%E7%BB%83%E7%94%9F%E6%88%90%E5%99%A8%0A++++++++batch_images+%3D+batch_preprocess%28data_batch%29++%23+images%0A++++++++batch_noise+%3D+np.random.normal%28size%3D%28batch_size%2C+noise_size%29%29++%23+noise%28normal%29%0A++++++++_+%3D+sess.run%28g_train_opt%2C+feed_dict%3D%7Binputs_real%3A+batch_images%2C%0A+++++++++++++++++++++++++++++++++++++++++++++inputs_noise%3A+batch_noise%7D%29%0A%0A++++++++%23++%E8%AE%B0%E5%BD%95%E8%AE%AD%E7%BB%83%E4%BF%A1%E6%81%AF%0A++++++++if+steps+%25+5+%3D%3D+1%3A%0A++++++++++++%23+%EF%BC%881%EF%BC%89%E8%AE%B0%E5%BD%95%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%0A++++++++++++train_loss_d+%3D+d_loss.eval%28%7Binputs_real%3A+batch_images%2C%0A++++++++++++++++++++++++++++++++++++++++inputs_noise%3A+batch_noise%7D%29%0A++++++++++++train_loss_g+%3D+g_loss.eval%28%7Binputs_real%3A+batch_images%2C%0A++++++++++++++++++++++++++++++++++++++++inputs_noise%3A+batch_noise%7D%29%0A++++++++++++losses.append%28%5Btrain_loss_d%2C+train_loss_g%2Csteps%5D%29%0A%0A++++++++++++%23+%EF%BC%882%EF%BC%89%E8%AE%B0%E5%BD%95%E7%94%9F%E6%88%90%E6%A0%B7%E6%9C%AC%0A++++++++++++batch_noise+%3D+np.random.normal%28size%3D%28batch_size%2C+noise_size%29%29%0A++++++++++++gen_samples+%3D+sess.run%28g_test%2C+feed_dict%3D%7Binputs_noise%3A+batch_noise%7D%29%0A++++++++++++genLog+%3D+%28gen_samples%5B0%3A11%5D+%2B+1%29+%2F+2++%23+%E6%81%A2%E5%A4%8D%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%28%E5%8F%9610%E5%BC%A0%29%0A++++++++++++GenLog.append%28genLog%29%0A%0A++++++++++++%23+%283%29%E6%89%93%E5%8D%B0%E4%BF%A1%E6%81%AF%0A++++++++++++print%28%27step+%7B%7D...%27.format%28steps%29%2C%0A++++++++++++++++++%22Discriminator+Loss%3A+%7B%3A.4f%7D...%22.format%28train_loss_d%29%2C%0A++++++++++++++++++%22Generator+Loss%3A+%7B%3A.4f%7D...%22.format%28train_loss_g%29%29%0A%0A++++++++%23+%EF%BC%884%EF%BC%89%E4%BF%9D%E5%AD%98%E7%94%9F%E6%88%90%E6%A8%A1%E5%9E%8B%0A++++++++if+steps+%25+300+%3D%3D0%3A%0A++++++++++++saver.save%28sess%2C+%27.%2Fckpt%2Fgenerator.ckpt%27%2C+global_step%3Dsteps%29%0A%0A++++%23+%E5%85%B3%E9%97%AD%E7%BA%BF%E7%A8%8B%0A++++coord.request_stop%28%29%0A++++coord.join%28threads%29%0A%0A%23%E8%AE%A1%E6%97%B6%E7%BB%93%E6%9D%9F%EF%BC%9A%0Atime_end+%3D+time.time%28%29%0Aprint%28%27%E8%BF%AD%E4%BB%A3%E7%BB%93%E6%9D%9F%EF%BC%8C%E8%80%97%E6%97%B6%EF%BC%9A%25.2f%E7%A7%92%27%25%28time_end-time_start%29%29%0A%0A%23+%E4%BF%9D%E5%AD%98%E4%BF%A1%E6%81%AF%0A%23++%E4%BF%9D%E5%AD%98loss%E8%AE%B0%E5%BD%95%0Awith+open%28%27.%2FtrainLog%2Floss_variation.loss%27%2C+%27wb%27%29+as+l%3A%0A++++losses+%3D+np.array%28losses%29%0A++++pickle.dump%28losses%2Cl%29%0A++++print%28%27%E4%BF%9D%E5%AD%98loss%E4%BF%A1%E6%81%AF..%27%29%0A%0A%23+%E4%BF%9D%E5%AD%98%E7%94%9F%E6%88%90%E6%97%A5%E5%BF%97%0Awith+open%28%27.%2FtrainLog%2FGenLog.log%27%2C+%27wb%27%29+as+g%3A%0A++++pickle.dump%28GenLog%2C+g%29%0A++++print%28%27%E4%BF%9D%E5%AD%98GenLog%E4%BF%A1%E6%81%AF..%27%29%0A%0A%0A%0A%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_304%22%3E%3C%2Fa%3E%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA%3C%2Fh4%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_305%22%3E%3C%2Fa%3E%E6%9C%80%E5%90%8E%E4%B8%80%E6%AC%A1%E7%94%9F%E6%88%90%E6%A0%B7%E6%9C%AC%3C%2Fh4%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org.cn%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdnimg.cn%2F20190407202655285.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0VwaGVtZXJvcHRlcmE%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22+alt%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_307%22%3E%3C%2Fa%3E%E8%AE%AD%E7%BB%83%E6%9C%9F%E9%97%B4%E7%94%9F%E6%88%90%E6%97%A5%E5%BF%97%3C%2Fh4%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org.cn%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdnimg.cn%2F20190407202744977.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0VwaGVtZXJvcHRlcmE%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22+alt%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_309%22%3E%3C%2Fa%3E%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%3C%2Fh4%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org.cn%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdnimg.cn%2F20190407202838373.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0VwaGVtZXJvcHRlcmE%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22+alt%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_311%22%3E%3C%2Fa%3E%E9%AA%8C%E8%AF%81%E7%94%9F%E6%88%90%E5%99%A8%3C%2Fh4%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org.cn%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdnimg.cn%2F20190407202906915.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0VwaGVtZXJvcHRlcmE%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22+alt%3D%22%22%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A+%3Clink+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Fmdeditor%2Fmarkdown_views-258a4616f7.css%22+rel%3D%22stylesheet%22%3E+%0A%3C%2Fdiv%3E" | url_decode}}