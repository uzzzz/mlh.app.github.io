---
layout: default
title: iOS开发笔记--使用iOS验证OpenSSL产生的ECDSA签名
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22article-copyright%22%3E%0A+++%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%EF%BC%9A%E6%9C%AC%E6%96%87%E4%B8%BA%E5%8D%9A%E4%B8%BB%E5%8E%9F%E5%88%9B%E6%96%87%E7%AB%A0%2C%E6%9C%AA%E7%BB%8F%E5%8D%9A%E4%B8%BB%E5%90%8C%E6%84%8F%E4%B8%8D%E5%BE%97%E8%BD%AC%E8%BD%BD%E3%80%82+https%3A%2F%2Fblog.csdn.net%2FiDivines%2Farticle%2Fdetails%2F81943210+%0A+%3C%2Fdiv%3E+%0A+%3Cdiv+class%3D%22markdown_views+prism-atom-one-dark%22%3E+%0A++%3C%21--+flowchart+%E7%AE%AD%E5%A4%B4%E5%9B%BE%E6%A0%87+%E5%8B%BF%E5%88%A0+--%3E+%0A++%3Csvg+xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22+style%3D%22display%3A+none%3B%22%3E%0A+++%3Cpath+stroke-linecap%3D%22round%22+d%3D%22M5%2C0+0%2C2.5+5%2C5z%22+id%3D%22raphael-marker-block%22+style%3D%22-webkit-tap-highlight-color%3A+rgba%280%2C+0%2C+0%2C+0%29%3B%22%3E%3C%2Fpath%3E%0A++%3C%2Fsvg%3E+%0A++%3Cpre%3E%3Ccode%3E++++int++++++++ret%3B%0A++++int++++++++nid%3B%0A++++ECDSA_SIG+*sig%3B%0A++++EC_KEY++++*eckey%3B%0A++++unsigned+char+digest+%5B20%5D%3B%0A++++size_t+dataToSignLen+%3D+20%3B%0A++++uint8_t+hash%5BCC_SHA256_DIGEST_LENGTH%5D%3B%0A++++CC_SHA256%28digest%2C+%28uint32_t%29dataToSignLen%2C+hash%29%3B%0A%2F%2F++++NID_X9_62_c2tnb191v1%0A++++nid+%3D+OBJ_sn2nid%28%22prime256v1%22%29%3B%0A++++%0A++++eckey+%3D+EC_KEY_new_by_curve_name%28nid%29%3B%0A++++if+%28eckey+%3D%3D+NULL%29%0A++++%7B%0A++++++++%2F*+error+*%2F%0A++++++++perror%28%22EC_KEY_new_by_curve_name%22%29%3B%0A++++%7D%0A++++%0A++++if+%28%21EC_KEY_generate_key%28eckey%29%29%0A++++%7B%0A++++++++%2F*+error+*%2F%0A++++%7D%0A++++else%0A++++%7B%2F%2F+%E6%89%93%E5%8D%B0%E4%B8%80%E4%B8%8Bec%E7%9A%84%E7%A7%81%E9%92%A5%E5%92%8C%E5%85%AC%E9%92%A5%0A++++++++EC_KEY_print_fp%28stdout%2C+eckey%2C+0%29%3B%0A++++%7D%0A++++%2F%2F+Second+step%3A+compute+the+ECDSA+signature+of+a+SHA-1+hash+value+using+ECDSA_do_sign%0A++++%0A++++%0A++++sig+%3D+ECDSA_do_sign%28hash%2C+CC_SHA256_DIGEST_LENGTH%2C+eckey%29%3B%2F%2F+%E7%AD%BE%E5%90%8D%0A++++if+%28sig+%3D%3D+NULL%29%0A++++%7B%0A++++++++%2F*+error+*%2F%0A++++++++perror%28%22ECDSA_do_sign%22%29%3B%0A++++%7D%0A++++else%0A++++%7B%2F%2F+%E6%89%93%E5%8D%B0%E4%B8%80%E4%B8%8B%E7%AD%BE%E5%90%8D%EF%BC%8Cr%E5%92%8Cs%0A++++++++printf%28%22Signature%3A%5Cn%5Ctr%3D%25s%5Cn%5Cts%3D%25s%5Cn%22%2C+BN_bn2hex%28sig-%26gt%3Br%29%2C+BN_bn2hex%28sig-%26gt%3Bs%29%29%3B%0A++++%7D%0A++++%0A++++%2F%2F+Third+step%3A+verify+the+created+ECDSA+signature+using+ECDSA_do_verify%0A++++ret+%3D+ECDSA_do_verify%28hash%2C+CC_SHA256_DIGEST_LENGTH%2C+sig%2C+eckey%29%3B%2F%2F+%E9%AA%8C%E8%AF%81%0A++++%0A++++if+%28ret+%3D%3D+-1%29%0A++++%7B%0A++++++++%2F*+error+*%2F%0A++++++++perror%28%22ECDSA_do_verify%22%29%3B%0A++++%7D%0A++++else+if+%28ret+%3D%3D+0%29%0A++++%7B%0A++++++++%2F*+incorrect+signature+*%2F%0A++++++++printf%28%22Verified+Failure%5Cn%22%29%3B%0A++++%7D%0A++++else+++%2F*+ret+%3D%3D+1+*%2F%0A++++%7B%0A++++++++%2F*+signature+ok+*%2F%0A++++++++printf%28%22Verified+OK%5Cn%22%29%3B%0A++++++++%0A++++%7D%0A++++%0A++++%2F%2F1.%E8%8E%B7%E5%8F%96%E7%AD%BE%E5%90%8D%E7%BB%93%E6%9E%9C%0A++++unsigned+char+signChar%5B100%5D+%3D+%7B0%7D%3B%0A++++unsigned+char+*p+%3D+signChar%3B%0A++++int+len+%3D+i2d_ECDSA_SIG%28sig%2C+%26amp%3Bp%29%3B%0A++++NSData+*signature+%3D+%5BNSData+dataWithBytes%3AsignChar+length%3Alen%5D%3B%0A++++NSLog%28%40%22%25%40%22%2Csignature%29%3B%0A++++%0A++++%2F%2F2.%E8%8E%B7%E5%8F%96%E5%85%AC%E9%92%A5%0A++++const+EC_POINT+*pubkey+%3D+EC_KEY_get0_public_key%28eckey%29%3B%0A++++const+EC_GROUP+*ec_group+%3D+EC_KEY_get0_group%28eckey%29%3B%0A++++BIGNUM+*x+%3D+BN_new%28%29%3B%0A++++BIGNUM+*y+%3D+BN_new%28%29%3B%0A++++%0A++++if+%28EC_POINT_get_affine_coordinates_GFp%28ec_group%2C+pubkey%2C+x%2C+y%2C+NULL%29%29+%7B%0A++++++++printf%28%22%E5%85%AC%E9%92%A5%3A%5Cn%22%29%3B%0A++++++++BN_print_fp%28stdout%2C+x%29%3B%0A++++++++putc%28%27%5Cn%27%2C+stdout%29%3B%0A++++++++BN_print_fp%28stdout%2C+y%29%3B%0A++++++++putc%28%27%5Cn%27%2C+stdout%29%3B%0A++++%7D%0A++++%0A++++unsigned+char+char_x%5B32%5D+%3D+%7B0%7D%3B%0A++++unsigned+char+char_y%5B32%5D+%3D+%7B0%7D%3B%0A++++BN_bn2bin%28x%2Cchar_x%29%3B%0A++++BN_bn2bin%28y%2Cchar_y%29%3B%0A++++%0A++++unsigned+char+pubkeyChar%5B65%5D+%3D+%7B0%7D%3B%0A++++pubkeyChar%5B0%5D+%3D+0x04%3B%0A++++for%28int+i%3D0%3B+i%26lt%3B32%3B+i%2B%2B%29%7B%0A++++++++pubkeyChar%5Bi%2B1%5D+%3D+char_x%5Bi%5D%3B%0A++++++++pubkeyChar%5Bi%2B1%2B32%5D+%3D+char_y%5Bi%5D%3B%0A++++%7D%0A++++NSData+*pubKeyData+%3D+%5BNSData+dataWithBytes%3ApubkeyChar+length%3A65%5D%3B%0A++++NSLog%28%40%22%25%40%22%2CpubKeyData%29%3B%0A++++%0A++++%2F%2F3.%E4%BA%A7%E7%94%9FIOS%E4%BD%BF%E7%94%A8%E7%9A%84%E5%85%AC%E9%92%A5%E5%AF%B9%E8%B1%A1%0A++++NSDictionary+*dic+%3D+%40%7B%0A++++++++++++++++++++++++++%28__bridge+id%29kSecAttrKeyType+%3A+%28__bridge+id%29kSecAttrKeyTypeEC%2C%0A++++++++++++++++++++++++++%28__bridge+id%29kSecAttrKeyClass+%3A+%28__bridge+id%29kSecAttrKeyClassPublic%2C%0A++++++++++++++++++++++++++%28__bridge+id%29kSecAttrKeySizeInBits+%3A+%40%28256%29%0A++++++++++++++++++++++++++%7D%3B%0A++++%0A++++NSError+*error+%3D+nil%3B%0A++++SecKeyRef+pubSecKey+%3D+SecKeyCreateWithData%28%28CFDataRef%29pubKeyData%2C+%28CFDictionaryRef%29dic%2C+%28void+*%29%26amp%3Berror%29%3B%0A++++if%28error%29%7B%0A++++++++NSLog%28%40%22%E4%BA%A7%E7%94%9FIOS%E4%BD%BF%E7%94%A8%E7%9A%84%E5%85%AC%E9%92%A5%E5%AF%B9%E8%B1%A1%E5%A4%B1%E8%B4%A5%22%29%3B%0A++++%7Delse%7B%0A++++++++NSLog%28%40%22%E4%BA%A7%E7%94%9FIOS%E4%BD%BF%E7%94%A8%E7%9A%84%E5%85%AC%E9%92%A5%E5%AF%B9%E8%B1%A1%E6%88%90%E5%8A%9F%22%29%3B%0A++++%7D%0A++++%0A++++%2F%2F4.%E9%AA%8C%E8%AF%81%E7%AD%BE%E5%90%8D%0A++++SecKeyAlgorithm+algorithm+%3D+kSecKeyAlgorithmECDSASignatureMessageX962SHA256%3B%0A++++BOOL+canEncrypt+%3D+SecKeyIsAlgorithmSupported%28pubSecKey%2C+kSecKeyOperationTypeVerify%2C+algorithm%29%3B%0A++++if%28%21canEncrypt%29%7B%0A++++++++return%3B%0A++++%7D%0A++++%0A++++NSData+*signedData+%3D+%5BNSData+dataWithBytes%3Adigest+length%3A20%5D%3B%0A++++SecKeyVerifySignature%28pubSecKey%2C+kSecKeyAlgorithmECDSASignatureMessageX962SHA256%2C+%28CFDataRef%29signedData%2C+%28CFDataRef%29signature%2C+%28void+*%29%26amp%3Berror%29%3B%0A++++if%28error%29%7B%0A++++++++NSLog%28%40%22IOS%E9%AA%8C%E8%AF%81%E7%AD%BE%E5%90%8D%E5%A4%B1%E8%B4%A5%22%29%3B%0A++++%7Delse%7B%0A++++++++NSLog%28%40%22IOS%E9%AA%8C%E8%AF%81%E7%AD%BE%E5%90%8D%E6%88%90%E5%8A%9F%22%29%3B%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A+%3C%2Fdiv%3E+%0A+%3Clink+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Fmdeditor%2Fmarkdown_views-778f64ae39.css%22+rel%3D%22stylesheet%22%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FiDivines%2Farticle%2Fdetails%2F81943210%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FiDivines%2Farticle%2Fdetails%2F81943210%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}