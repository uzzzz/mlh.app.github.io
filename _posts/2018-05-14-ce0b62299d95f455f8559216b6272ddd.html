---
layout: default
title: 以太坊源码分析(34)eth-downloader源码分析
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cdiv+style%3D%22color%3Argb%28212%2C212%2C212%29%3Bbackground-color%3Argb%2830%2C30%2C30%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3Bfont-size%3A14px%3Bline-height%3A19px%3B%22%3E%0A+++%3Cdiv%3E%0A++++downloader%E4%B8%BB%E8%A6%81%E8%B4%9F%E8%B4%A3%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9C%80%E5%BC%80%E5%A7%8B%E7%9A%84%E5%90%8C%E6%AD%A5%E5%B7%A5%E4%BD%9C%EF%BC%8C%E5%BD%93%E5%89%8D%E7%9A%84%E5%90%8C%E6%AD%A5%E6%9C%89%E4%B8%A4%E7%A7%8D%E6%A8%A1%E5%BC%8F%EF%BC%8C%E4%B8%80%E7%A7%8D%E6%98%AF%E4%BC%A0%E7%BB%9F%E7%9A%84fullmode%2C%E8%BF%99%E7%A7%8D%E6%A8%A1%E5%BC%8F%E9%80%9A%E8%BF%87%E4%B8%8B%E8%BD%BD%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%92%8C%E5%8C%BA%E5%9D%97%E4%BD%93%E6%9D%A5%E6%9E%84%E5%BB%BA%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%90%8C%E6%AD%A5%E7%9A%84%E8%BF%87%E7%A8%8B%E5%B0%B1%E5%92%8C%E6%99%AE%E9%80%9A%E7%9A%84%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%8C%85%E6%8B%AC%E5%8C%BA%E5%9D%97%E5%A4%B4%E7%9A%84%E9%AA%8C%E8%AF%81%EF%BC%8C%E4%BA%A4%E6%98%93%E7%9A%84%E9%AA%8C%E8%AF%81%EF%BC%8C%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%EF%BC%8C%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%E7%9A%84%E6%94%B9%E5%8F%98%E7%AD%89%E6%93%8D%E4%BD%9C%EF%BC%8C%E8%BF%99%E5%85%B6%E5%AE%9E%E6%98%AF%E4%B8%80%E4%B8%AA%E6%AF%94%E8%BE%83%E6%B6%88%E8%80%97CPU%E5%92%8C%E7%A3%81%E7%9B%98%E7%9A%84%E4%B8%80%E4%B8%AA%E8%BF%87%E7%A8%8B%E3%80%82+%E5%8F%A6%E4%B8%80%E7%A7%8D%E6%A8%A1%E5%BC%8F%E5%B0%B1%E6%98%AF+%E5%BF%AB%E9%80%9F%E5%90%8C%E6%AD%A5%E7%9A%84fast+sync%E6%A8%A1%E5%BC%8F%EF%BC%8C+%E8%BF%99%E7%A7%8D%E6%A8%A1%E5%BC%8F%E6%9C%89%E4%B8%93%E9%97%A8%E7%9A%84%E6%96%87%E6%A1%A3%E6%9D%A5%E6%8F%8F%E8%BF%B0%E3%80%82%E8%AF%B7%E5%8F%82%E8%80%83fast+sync%E7%9A%84%E6%96%87%E6%A1%A3%E3%80%82%E7%AE%80%E5%8D%95%E7%9A%84%E8%AF%B4+fast+sync%E7%9A%84%E6%A8%A1%E5%BC%8F%E4%BC%9A%E4%B8%8B%E8%BD%BD%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%8C%BA%E5%9D%97%E4%BD%93%E5%92%8C%E6%94%B6%E6%8D%AE%EF%BC%8C+%E6%8F%92%E5%85%A5%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%8D%E4%BC%9A%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%AB%98%E5%BA%A6%28%E6%9C%80%E9%AB%98%E7%9A%84%E5%8C%BA%E5%9D%97%E9%AB%98%E5%BA%A6+-+1024%29%E7%9A%84%E6%97%B6%E5%80%99%E5%90%8C%E6%AD%A5%E6%89%80%E6%9C%89%E7%9A%84%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%EF%BC%8C%E5%90%8E%E9%9D%A2%E7%9A%841024%E4%B8%AA%E5%8C%BA%E5%9D%97%E4%BC%9A%E9%87%87%E7%94%A8fullmode%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E6%9E%84%E5%BB%BA%E3%80%82+%E8%BF%99%E7%A7%8D%E6%A8%A1%E5%BC%8F%E4%BC%9A%E5%8A%A0%E5%8C%BA%E5%9D%97%E7%9A%84%E6%8F%92%E5%85%A5%E6%97%B6%E9%97%B4%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B8%8D%E4%BC%9A%E4%BA%A7%E7%94%9F%E5%A4%A7%E9%87%8F%E7%9A%84%E5%8E%86%E5%8F%B2%E7%9A%84%E8%B4%A6%E6%88%B7%E4%BF%A1%E6%81%AF%E3%80%82%E4%BC%9A%E7%9B%B8%E5%AF%B9%E8%8A%82%E7%BA%A6%E7%A3%81%E7%9B%98%EF%BC%8C+%E4%BD%86%E6%98%AF%E5%AF%B9%E4%BA%8E%E7%BD%91%E7%BB%9C%E7%9A%84%E6%B6%88%E8%80%97%E4%BC%9A%E6%9B%B4%E9%AB%98%E3%80%82+%E5%9B%A0%E4%B8%BA%E9%9C%80%E8%A6%81%E4%B8%8B%E8%BD%BD%E6%94%B6%E6%8D%AE%E5%92%8C%E7%8A%B6%E6%80%81%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%3Cspan+style%3D%22color%3A%23569cd6%3B%22%3E%3Cstrong%3E%23%23+downloader+%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%3C%2Fstrong%3E%3C%2Fspan%3E%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btype+Downloader+struct+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmode+SyncMode+%2F%2F+Synchronisation+mode+defining+the+strategy+used+%28per+sync+cycle%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmux+*event.TypeMux+%2F%2F+Event+multiplexer+to+announce+sync+operation+events%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+queue+%E5%AF%B9%E8%B1%A1%E7%94%A8%E6%9D%A5%E8%B0%83%E5%BA%A6+%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E4%BA%A4%E6%98%93%EF%BC%8C%E5%92%8C%E6%94%B6%E6%8D%AE%E7%9A%84%E4%B8%8B%E8%BD%BD%EF%BC%8C%E4%BB%A5%E5%8F%8A%E4%B8%8B%E8%BD%BD%E5%AE%8C%E4%B9%8B%E5%90%8E%E7%9A%84%E7%BB%84%E8%A3%85%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bqueue+*queue+%2F%2F+Scheduler+for+selecting+the+hashes+to+download%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%AF%B9%E7%AB%AF%E7%9A%84%E9%9B%86%E5%90%88%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeers+*peerSet+%2F%2F+Set+of+active+peers+from+which+download+can+proceed%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateDB+ethdb.Database%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fast+sync+%E4%B8%AD%E7%9A%84+Pivot+point%E5%8C%BA%E5%9D%97%E7%9A%84%E5%A4%B4%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BfsPivotLock+*types.Header+%2F%2F+Pivot+header+on+critical+section+entry+%28cannot+change+between+retries%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BfsPivotFails+uint32+%2F%2F+Number+of+subsequent+fast+sync+failures+in+the+critical+section%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E4%B8%8B%E8%BD%BD%E7%9A%84%E5%BE%80%E8%BF%94%E6%97%B6%E5%BB%B6%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BrttEstimate+uint64+%2F%2F+Round+trip+time+to+target+for+download+requests%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BrttConfidence+uint64+%2F%2F+Confidence+in+the+estimated+RTT+%28unit%3A+millionths+to+allow+atomic+ops%29+%E4%BC%B0%E8%AE%A1RTT%E7%9A%84%E4%BF%A1%E5%BF%83%28%E5%8D%95%E4%BD%8D%EF%BC%9A%E5%85%81%E8%AE%B8%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C%E7%9A%84%E7%99%BE%E4%B8%87%E5%88%86%E4%B9%8B%E4%B8%80%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Statistics+%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF%EF%BC%8C+%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsyncStatsChainOrigin+uint64+%2F%2F+Origin+block+number+where+syncing+started+at%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsyncStatsChainHeight+uint64+%2F%2F+Highest+block+number+known+when+syncing+started%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsyncStatsState+stateSyncStats%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsyncStatsLock+sync.RWMutex+%2F%2F+Lock+protecting+the+sync+stats+fields%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blightchain+LightChain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bblockchain+BlockChain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Callbacks%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BdropPeer+peerDropFn+%2F%2F+Drops+a+peer+for+misbehaving%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Status%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsynchroniseMock+func%28id+string%2C+hash+common.Hash%29+error+%2F%2F+Replacement+for+synchronise+during+testing%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bsynchronising+int32%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bnotified+int32%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Channels%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderCh+chan+dataPack+%2F%2F+%5Beth%2F62%5D+Channel+receiving+inbound+block+headers+header%E7%9A%84%E8%BE%93%E5%85%A5%E9%80%9A%E9%81%93%EF%BC%8C%E4%BB%8E%E7%BD%91%E7%BB%9C%E4%B8%8B%E8%BD%BD%E7%9A%84header%E4%BC%9A%E8%A2%AB%E9%80%81%E5%88%B0%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BbodyCh+chan+dataPack+%2F%2F+%5Beth%2F62%5D+Channel+receiving+inbound+block+bodies+bodies%E7%9A%84%E8%BE%93%E5%85%A5%E9%80%9A%E9%81%93%EF%BC%8C%E4%BB%8E%E7%BD%91%E7%BB%9C%E4%B8%8B%E8%BD%BD%E7%9A%84bodies%E4%BC%9A%E8%A2%AB%E9%80%81%E5%88%B0%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptCh+chan+dataPack+%2F%2F+%5Beth%2F63%5D+Channel+receiving+inbound+receipts+receipts%E7%9A%84%E8%BE%93%E5%85%A5%E9%80%9A%E9%81%93%EF%BC%8C%E4%BB%8E%E7%BD%91%E7%BB%9C%E4%B8%8B%E8%BD%BD%E7%9A%84receipts%E4%BC%9A%E8%A2%AB%E9%80%81%E5%88%B0%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BbodyWakeCh+chan+bool+%2F%2F+%5Beth%2F62%5D+Channel+to+signal+the+block+body+fetcher+of+new+tasks+%E7%94%A8%E6%9D%A5%E4%BC%A0%E8%BE%93body+fetcher%E6%96%B0%E4%BB%BB%E5%8A%A1%E7%9A%84%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptWakeCh+chan+bool+%2F%2F+%5Beth%2F63%5D+Channel+to+signal+the+receipt+fetcher+of+new+tasks%26nbsp%3B%26nbsp%3B%26nbsp%3B+%E7%94%A8%E6%9D%A5%E4%BC%A0%E8%BE%93receipt+fetcher+%E6%96%B0%E4%BB%BB%E5%8A%A1%E7%9A%84%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderProcCh+chan+%5B%5D*types.Header+%2F%2F+%5Beth%2F62%5D+Channel+to+feed+the+header+processor+new+tasks%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%E9%80%9A%E9%81%93%E4%B8%BAheader%E5%A4%84%E7%90%86%E8%80%85%E6%8F%90%E4%BE%9B%E6%96%B0%E7%9A%84%E4%BB%BB%E5%8A%A1%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+for+stateFetcher%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateSyncStart+chan+*stateSync+%2F%2F%E7%94%A8%E6%9D%A5%E5%90%AF%E5%8A%A8%E6%96%B0%E7%9A%84+state+fetcher%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BtrackStateReq+chan+*stateReq%26nbsp%3B%26nbsp%3B%26nbsp%3B+%2F%2F+TODO%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateCh+chan+dataPack+%2F%2F+%5Beth%2F63%5D+Channel+receiving+inbound+node+state+data%26nbsp%3B%26nbsp%3B+state%E7%9A%84%E8%BE%93%E5%85%A5%E9%80%9A%E9%81%93%EF%BC%8C%E4%BB%8E%E7%BD%91%E7%BB%9C%E4%B8%8B%E8%BD%BD%E7%9A%84state%E4%BC%9A%E8%A2%AB%E9%80%81%E5%88%B0%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Cancellation+and+termination%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BcancelPeer+string+%2F%2F+Identifier+of+the+peer+currently+being+used+as+the+master+%28cancel+on+drop%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BcancelCh+chan+struct%7B%7D+%2F%2F+Channel+to+cancel+mid-flight+syncs%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BcancelLock+sync.RWMutex+%2F%2F+Lock+to+protect+the+cancel+channel+and+peer+in+delivers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BquitCh+chan+struct%7B%7D+%2F%2F+Quit+channel+to+signal+termination%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BquitLock+sync.RWMutex+%2F%2F+Lock+to+prevent+double+closes%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Testing+hooks%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsyncInitHook+func%28uint64%2C+uint64%29+%2F%2F+Method+to+call+upon+initiating+a+new+sync+run%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BbodyFetchHook+func%28%5B%5D*types.Header%29+%2F%2F+Method+to+call+upon+starting+a+block+body+fetch%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptFetchHook+func%28%5B%5D*types.Header%29+%2F%2F+Method+to+call+upon+starting+a+receipt+fetch%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BchainInsertHook+func%28%5B%5D*fetchResult%29+%2F%2F+Method+to+call+upon+inserting+a+chain+of+blocks+%28possibly+in+multiple+invocations%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+New+creates+a+new+downloader+to+fetch+hashes+and+blocks+from+remote+peers.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+New%28mode+SyncMode%2C+stateDb+ethdb.Database%2C+mux+*event.TypeMux%2C+chain+BlockChain%2C+lightchain+LightChain%2C+dropPeer+peerDropFn%29+*Downloader+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+lightchain+%3D%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blightchain+%3D+chain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdl+%3A%3D+%26amp%3BDownloader%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmode%3A+mode%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateDB%3A+stateDb%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmux%3A+mux%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bqueue%3A+newQueue%28%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeers%3A+newPeerSet%28%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BrttEstimate%3A+uint64%28rttMaxEstimate%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BrttConfidence%3A+uint64%281000000%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bblockchain%3A+chain%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blightchain%3A+lightchain%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BdropPeer%3A+dropPeer%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderCh%3A+make%28chan+dataPack%2C+1%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BbodyCh%3A+make%28chan+dataPack%2C+1%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptCh%3A+make%28chan+dataPack%2C+1%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BbodyWakeCh%3A+make%28chan+bool%2C+1%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptWakeCh%3A+make%28chan+bool%2C+1%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderProcCh%3A+make%28chan+%5B%5D*types.Header%2C+1%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BquitCh%3A+make%28chan+struct%7B%7D%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateCh%3A+make%28chan+dataPack%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateSyncStart%3A+make%28chan+*stateSync%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BtrackStateReq%3A+make%28chan+*stateReq%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+dl.qosTuner%28%29+%2F%2F%E7%AE%80%E5%8D%95+%E4%B8%BB%E8%A6%81%E7%94%A8%E6%9D%A5%E8%AE%A1%E7%AE%97rttEstimate%E5%92%8CrttConfidence%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+dl.stateFetcher%28%29+%2F%2F%E5%90%AF%E5%8A%A8stateFetcher%E7%9A%84%E4%BB%BB%E5%8A%A1%E7%9B%91%E5%90%AC%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99%E8%BF%98%E6%B2%A1%E6%9C%89%E7%94%9F%E6%88%90state+fetcher%E7%9A%84%E4%BB%BB%E5%8A%A1%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+dl%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%3Cspan+style%3D%22color%3A%23569cd6%3B%22%3E%3Cstrong%3E%23%23+%E5%90%8C%E6%AD%A5%E4%B8%8B%E8%BD%BD%3C%2Fstrong%3E%3C%2Fspan%3E%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++Synchronise%E8%AF%95%E5%9B%BE%E5%92%8C%E4%B8%80%E4%B8%AApeer%E6%9D%A5%E5%90%8C%E6%AD%A5%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%90%8C%E6%AD%A5%E8%BF%87%E7%A8%8B%E4%B8%AD%E9%81%87%E5%88%B0%E4%B8%80%E4%BA%9B%E9%94%99%E8%AF%AF%EF%BC%8C%E9%82%A3%E4%B9%88%E4%BC%9A%E5%88%A0%E9%99%A4%E6%8E%89Peer%E3%80%82%E7%84%B6%E5%90%8E%E4%BC%9A%E8%A2%AB%E9%87%8D%E8%AF%95%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Synchronise+tries+to+sync+up+our+local+block+chain+with+a+remote+peer%2C+both%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+adding+various+sanity+checks+as+well+as+wrapping+it+with+various+log+entries.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+Synchronise%28id+string%2C+head+common.Hash%2C+td+*big.Int%2C+mode+SyncMode%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Berr+%3A%3D+d.synchronise%28id%2C+head%2C+td%2C+mode%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bswitch+err+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+nil%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+errBusy%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+errTimeout%2C+errBadPeer%2C+errStallingPeer%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BerrEmptyHeaderSet%2C+errPeersUnavailable%2C+errTooOld%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BerrInvalidAncestor%2C+errInvalidChain%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Warn%28%22Synchronisation+failed%2C+dropping+peer%22%2C+%22peer%22%2C+id%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.dropPeer%28id%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Warn%28%22Synchronisation+failed%2C+retrying%22%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++synchronise%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+synchronise+will+select+the+peer+and+use+it+for+synchronising.+If+an+empty+string+is+given%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+it+will+use+the+best+peer+possible+and+synchronize+if+it%27s+TD+is+higher+than+our+own.+If+any+of+the%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+checks+fail+an+error+will+be+returned.+This+method+is+synchronous%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+synchronise%28id+string%2C+hash+common.Hash%2C+td+*big.Int%2C+mode+SyncMode%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Mock+out+the+synchronisation+if+testing%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.synchroniseMock+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+d.synchroniseMock%28id%2C+hash%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Make+sure+only+one+goroutine+is+ever+allowed+past+this+point+at+once%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%90%8C%E6%97%B6%E5%8F%AA%E8%83%BD%E8%BF%90%E8%A1%8C%E4%B8%80%E4%B8%AA%EF%BC%8C+%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21atomic.CompareAndSwapInt32%28%26amp%3Bd.synchronising%2C+0%2C+1%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errBusy%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+atomic.StoreInt32%28%26amp%3Bd.synchronising%2C+0%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Post+a+user+notification+of+the+sync+%28only+once+per+session%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+atomic.CompareAndSwapInt32%28%26amp%3Bd.notified%2C+0%2C+1%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Info%28%22Block+synchronisation+started%22%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Reset+the+queue%2C+peer+set+and+wake+channels+to+clean+any+internal+leftover+state%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E9%87%8D%E7%BD%AEqueue%E5%92%8Cpeer%E7%9A%84%E7%8A%B6%E6%80%81%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.Reset%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.peers.Reset%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%B8%85%E7%A9%BAd.bodyWakeCh%2C+d.receiptWakeCh%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+ch+%3A%3D+range+%5B%5Dchan+bool%7Bd.bodyWakeCh%2C+d.receiptWakeCh%7D+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-ch%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%B8%85%E7%A9%BAd.headerCh%2C+d.bodyCh%2C+d.receiptCh%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+ch+%3A%3D+range+%5B%5Dchan+dataPack%7Bd.headerCh%2C+d.bodyCh%2C+d.receiptCh%7D+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+empty+%3A%3D+false%3B+%21empty%3B+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-ch%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bempty+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%B8%85%E7%A9%BAheaderProcCh%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+empty+%3A%3D+false%3B+%21empty%3B+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.headerProcCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bempty+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Create+cancel+channel+for+aborting+mid-flight+and+mark+the+master+peer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.cancelLock.Lock%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.cancelCh+%3D+make%28chan+struct%7B%7D%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.cancelPeer+%3D+id%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.cancelLock.Unlock%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+d.Cancel%28%29+%2F%2F+No+matter+what%2C+we+can%27t+leave+the+cancel+channel+open%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Set+the+requested+sync+mode%2C+unless+it%27s+forbidden%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.mode+%3D+mode%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%3D%3D+FastSync+%26amp%3B%26amp%3B+atomic.LoadUint32%28%26amp%3Bd.fsPivotFails%29+%26gt%3B%3D+fsCriticalTrials+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.mode+%3D+FullSync%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Retrieve+the+origin+peer+and+initiate+the+downloading+process%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp+%3A%3D+d.peers.Peer%28id%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+p+%3D%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errUnknownPeer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+d.syncWithPeer%28p%2C+hash%2C+td%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++syncWithPeer%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+syncWithPeer+starts+a+block+synchronization+based+on+the+hash+chain+from+the%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+specified+peer+and+head+hash.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+syncWithPeer%28p+*peerConnection%2C+hash+common.Hash%2C+td+*big.Int%29+%28err+error%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B...%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Look+up+the+sync+boundaries%3A+the+common+ancestor+and+the+target+block%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E4%BD%BF%E7%94%A8hash%E6%8C%87%E6%9D%A5%E8%8E%B7%E5%8F%96%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E9%87%8C%E9%9D%A2%E4%BC%9A%E8%AE%BF%E9%97%AE%E7%BD%91%E7%BB%9C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blatest%2C+err+%3A%3D+d.fetchHeight%28p%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bheight+%3A%3D+latest.Number.Uint64%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+findAncestor%E8%AF%95%E5%9B%BE%E6%9D%A5%E8%8E%B7%E5%8F%96%E5%A4%A7%E5%AE%B6%E5%85%B1%E5%90%8C%E7%9A%84%E7%A5%96%E5%85%88%EF%BC%8C%E4%BB%A5%E4%BE%BF%E6%89%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%BC%80%E5%A7%8B%E5%90%8C%E6%AD%A5%E7%9A%84%E7%82%B9%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Borigin%2C+err+%3A%3D+d.findAncestor%28p%2C+height%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.syncStatsLock.Lock%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.syncStatsChainHeight+%26lt%3B%3D+origin+%7C%7C+d.syncStatsChainOrigin+%26gt%3B+origin+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.syncStatsChainOrigin+%3D+origin%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.syncStatsChainHeight+%3D+height%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.syncStatsLock.Unlock%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Initiate+the+sync+using+a+concurrent+header+and+content+retrieval+algorithm%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpivot+%3A%3D+uint64%280%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bswitch+d.mode+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+LightSync%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpivot+%3D+height%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+FastSync%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Calculate+the+new+fast%2Fslow+sync+pivot+point%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9Cpivot%E8%BF%99%E4%B8%AA%E7%82%B9%E6%B2%A1%E6%9C%89%E8%A2%AB%E9%94%81%E5%AE%9A%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.fsPivotLock+%3D%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BpivotOffset%2C+err+%3A%3D+rand.Int%28rand.Reader%2C+big.NewInt%28int64%28fsPivotInterval%29%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpanic%28fmt.Sprintf%28%22Failed+to+access+crypto+random+source%3A+%25v%22%2C+err%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+height+%26gt%3B+uint64%28fsMinFullBlocks%29%2BpivotOffset.Uint64%28%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpivot+%3D+height+-+uint64%28fsMinFullBlocks%29+-+pivotOffset.Uint64%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+%7B+%2F%2F+%E5%A6%82%E8%BF%87%E8%BF%99%E4%B8%AA%E7%82%B9%E5%B7%B2%E7%BB%8F%E8%A2%AB%E9%94%81%E5%AE%9A%E4%BA%86%E3%80%82%E9%82%A3%E4%B9%88%E5%B0%B1%E4%BD%BF%E7%94%A8%E8%BF%99%E4%B8%AA%E7%82%B9%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Pivot+point+locked+in%2C+use+this+and+do+not+pick+a+new+one%21%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpivot+%3D+d.fsPivotLock.Number.Uint64%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+the+point+is+below+the+origin%2C+move+origin+back+to+ensure+state+download%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+pivot+%26lt%3B+origin+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+pivot+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Borigin+%3D+pivot+-+1%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Borigin+%3D+0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Fast+syncing+until+pivot+block%22%2C+%22pivot%22%2C+pivot%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.Prepare%28origin%2B1%2C+d.mode%2C+pivot%2C+latest%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.syncInitHook+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.syncInitHook%28origin%2C+height%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%90%AF%E5%8A%A8%E5%87%A0%E4%B8%AAfetcher+%E5%88%86%E5%88%AB%E8%B4%9F%E8%B4%A3header%2Cbodies%2Creceipts%2C%E5%A4%84%E7%90%86headers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfetchers+%3A%3D+%5B%5Dfunc%28%29+error%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc%28%29+error+%7B+return+d.fetchHeaders%28p%2C+origin%2B1%29+%7D%2C+%2F%2F+Headers+are+always+retrieved%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc%28%29+error+%7B+return+d.fetchBodies%28origin+%2B+1%29+%7D%2C+%2F%2F+Bodies+are+retrieved+during+normal+and+fast+sync%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc%28%29+error+%7B+return+d.fetchReceipts%28origin+%2B+1%29+%7D%2C+%2F%2F+Receipts+are+retrieved+during+fast+sync%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc%28%29+error+%7B+return+d.processHeaders%28origin%2B1%2C+td%29+%7D%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%3D%3D+FastSync+%7B+%2F%2F%E6%A0%B9%E6%8D%AE%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%B8%8D%E5%90%8C%EF%BC%8C%E5%A2%9E%E5%8A%A0%E6%96%B0%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfetchers+%3D+append%28fetchers%2C+func%28%29+error+%7B+return+d.processFastSyncContent%28latest%29+%7D%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+if+d.mode+%3D%3D+FullSync+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfetchers+%3D+append%28fetchers%2C+d.processFullSyncContent%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Berr+%3D+d.spawnSync%28fetchers%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+nil+%26amp%3B%26amp%3B+d.mode+%3D%3D+FastSync+%26amp%3B%26amp%3B+d.fsPivotLock+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+sync+failed+in+the+critical+section%2C+bump+the+fail+counter.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Batomic.AddUint32%28%26amp%3Bd.fsPivotFails%2C+1%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++spawnSync%E7%BB%99%E6%AF%8F%E4%B8%AAfetcher%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AAgoroutine%2C+%E7%84%B6%E5%90%8E%E9%98%BB%E5%A1%9E%E7%9A%84%E7%AD%89%E5%BE%85fetcher%E5%87%BA%E9%94%99%E3%80%82+%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+spawnSync+runs+d.process+and+all+given+fetcher+functions+to+completion+in%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+separate+goroutines%2C+returning+the+first+error+that+appears.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+spawnSync%28fetchers+%5B%5Dfunc%28%29+error%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bvar+wg+sync.WaitGroup%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Berrc+%3A%3D+make%28chan+error%2C+len%28fetchers%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bwg.Add%28len%28fetchers%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+fn+%3A%3D+range+fetchers+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfn+%3A%3D+fn%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+func%28%29+%7B+defer+wg.Done%28%29%3B+errc+%26lt%3B-+fn%28%29+%7D%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Wait+for+the+first+error%2C+then+terminate+the+others.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bvar+err+error%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+i+%3A%3D+0%3B+i+%26lt%3B+len%28fetchers%29%3B+i%2B%2B+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+i+%3D%3D+len%28fetchers%29-1+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Close+the+queue+when+all+fetchers+have+exited.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+This+will+cause+the+block+processor+to+end+when%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+it+has+processed+the+queue.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.Close%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3D+%26lt%3B-errc%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bbreak%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.Close%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.Cancel%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bwg.Wait%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%3Cspan+style%3D%22color%3A%23569cd6%3B%22%3E%3Cstrong%3E%23%23+headers%E7%9A%84%E5%A4%84%E7%90%86%3C%2Fstrong%3E%3C%2Fspan%3E%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++fetchHeaders%E6%96%B9%E6%B3%95%E7%94%A8%E6%9D%A5%E8%8E%B7%E5%8F%96header%E3%80%82+%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E8%8E%B7%E5%8F%96%E7%9A%84header%E5%8E%BB%E8%8E%B7%E5%8F%96body%E5%92%8Creceipt%E7%AD%89%E4%BF%A1%E6%81%AF%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fetchHeaders+keeps+retrieving+headers+concurrently+from+the+number%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+requested%2C+until+no+more+are+returned%2C+potentially+throttling+on+the+way.+To%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+facilitate+concurrency+but+still+protect+against+malicious+nodes+sending+bad%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+headers%2C+we+construct+a+header+chain+skeleton+using+the+%22origin%22+peer+we+are%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+syncing+with%2C+and+fill+in+the+missing+headers+using+anyone+else.+Headers+from%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+other+peers+are+only+accepted+if+they+map+cleanly+to+the+skeleton.+If+no+one%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+can+fill+in+the+skeleton+-+not+even+the+origin+peer+-+it%27s+assumed+invalid+and%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+the+origin+is+dropped.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BfetchHeaders%E4%B8%8D%E6%96%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E8%BF%99%E6%A0%B7%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%8F%91%E9%80%81header%E8%AF%B7%E6%B1%82%EF%BC%8C%E7%AD%89%E5%BE%85%E6%89%80%E6%9C%89%E7%9A%84%E8%BF%94%E5%9B%9E%E3%80%82%E7%9B%B4%E5%88%B0%E5%AE%8C%E6%88%90%E6%89%80%E6%9C%89%E7%9A%84header%E8%AF%B7%E6%B1%82%E3%80%82+%E4%B8%BA%E4%BA%86%E6%8F%90%E9%AB%98%E5%B9%B6%E5%8F%91%E6%80%A7%EF%BC%8C%E5%90%8C%E6%97%B6%E4%BB%8D%E7%84%B6%E8%83%BD%E5%A4%9F%E9%98%B2%E6%AD%A2%E6%81%B6%E6%84%8F%E8%8A%82%E7%82%B9%E5%8F%91%E9%80%81%E9%94%99%E8%AF%AF%E7%9A%84header%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BD%BF%E7%94%A8%E6%88%91%E4%BB%AC%E6%AD%A3%E5%9C%A8%E5%90%8C%E6%AD%A5%E7%9A%84%E2%80%9Corigin%E2%80%9Dpeer%E6%9E%84%E9%80%A0%E4%B8%80%E4%B8%AA%E5%A4%B4%E6%96%87%E4%BB%B6%E9%93%BE%E9%AA%A8%E6%9E%B6%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%B6%E4%BB%96%E4%BA%BA%E5%A1%AB%E5%85%85%E7%BC%BA%E5%A4%B1%E7%9A%84header%E3%80%82+%E5%85%B6%E4%BB%96peer%E7%9A%84header%E5%8F%AA%E6%9C%89%E5%9C%A8%E5%B9%B2%E5%87%80%E5%9C%B0%E6%98%A0%E5%B0%84%E5%88%B0%E9%AA%A8%E6%9E%B6%E4%B8%8A%E6%97%B6%E6%89%8D%E8%A2%AB%E6%8E%A5%E5%8F%97%E3%80%82+%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E4%BA%BA%E8%83%BD%E5%A4%9F%E5%A1%AB%E5%85%85%E9%AA%A8%E6%9E%B6+-+%E7%94%9A%E8%87%B3origin+peer%E4%B9%9F%E4%B8%8D%E8%83%BD%E5%A1%AB%E5%85%85+-+%E5%AE%83%E8%A2%AB%E8%AE%A4%E4%B8%BA%E6%98%AF%E6%97%A0%E6%95%88%E7%9A%84%EF%BC%8C%E5%B9%B6%E4%B8%94origin+peer%E4%B9%9F%E8%A2%AB%E4%B8%A2%E5%BC%83%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+fetchHeaders%28p+*peerConnection%2C+from+uint64%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Debug%28%22Directing+header+downloads%22%2C+%22origin%22%2C+from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+p.log.Debug%28%22Header+download+terminated%22%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Create+a+timeout+timer%2C+and+the+associated+header+fetcher%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bskeleton+%3A%3D+true+%2F%2F+Skeleton+assembly+phase+or+finishing+up%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brequest+%3A%3D+time.Now%28%29+%2F%2F+time+of+the+last+skeleton+fetch+request%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btimeout+%3A%3D+time.NewTimer%280%29+%2F%2F+timer+to+dump+a+non-responsive+active+peer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26lt%3B-timeout.C+%2F%2F+timeout+channel+should+be+initially+empty%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+timeout.Stop%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bvar+ttl+time.Duration%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BgetHeaders+%3A%3D+func%28from+uint64%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brequest+%3D+time.Now%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bttl+%3D+d.requestTTL%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btimeout.Reset%28ttl%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+skeleton+%7B+%2F%2F%E5%A1%AB%E5%85%85%E9%AA%A8%E6%9E%B6%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Trace%28%22Fetching+skeleton+headers%22%2C+%22count%22%2C+MaxHeaderFetch%2C+%22from%22%2C+from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+p.peer.RequestHeadersByNumber%28from%2Buint64%28MaxHeaderFetch%29-1%2C+MaxSkeletonSize%2C+MaxHeaderFetch-1%2C+false%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+%7B+%2F%2F+%E7%9B%B4%E6%8E%A5%E8%AF%B7%E6%B1%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Trace%28%22Fetching+full+headers%22%2C+%22count%22%2C+MaxHeaderFetch%2C+%22from%22%2C+from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+p.peer.RequestHeadersByNumber%28from%2C+MaxHeaderFetch%2C+0%2C+false%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Start+pulling+the+header+chain+skeleton+until+all+is+done%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BgetHeaders%28from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancelHeaderFetch%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+packet+%3A%3D+%26lt%3B-d.headerCh%3A+%2F%2F%E7%BD%91%E7%BB%9C%E4%B8%8A%E8%BF%94%E5%9B%9E%E7%9A%84header%E4%BC%9A%E6%8A%95%E9%80%92%E5%88%B0headerCh%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Make+sure+the+active+peer+is+giving+us+the+skeleton+headers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+packet.PeerId%28%29+%21%3D+p.id+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Received+skeleton+from+incorrect+peer%22%2C+%22peer%22%2C+packet.PeerId%28%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bbreak%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderReqTimer.UpdateSince%28request%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btimeout.Stop%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+the+skeleton%27s+finished%2C+pull+any+remaining+head+headers+directly+from+the+origin%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+packet.Items%28%29+%3D%3D+0+%26amp%3B%26amp%3B+skeleton+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bskeleton+%3D+false%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BgetHeaders%28from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcontinue%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+no+more+headers+are+inbound%2C+notify+the+content+fetchers+and+return%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E6%9B%B4%E5%A4%9A%E7%9A%84%E8%BF%94%E5%9B%9E%E4%BA%86%E3%80%82+%E9%82%A3%E4%B9%88%E5%91%8A%E8%AF%89headerProcCh%E9%80%9A%E9%81%93%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+packet.Items%28%29+%3D%3D+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Debug%28%22No+more+headers+available%22%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+d.headerProcCh+%26lt%3B-+nil%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancelHeaderFetch%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bheaders+%3A%3D+packet.%28*headerPack%29.headers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+we+received+a+skeleton+batch%2C+resolve+internals+concurrently%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+skeleton+%7B+%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E9%9C%80%E8%A6%81%E5%A1%AB%E5%85%85%E9%AA%A8%E6%9E%B6%EF%BC%8C%E9%82%A3%E4%B9%88%E5%9C%A8%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E9%87%8C%E9%9D%A2%E5%A1%AB%E5%85%85%E5%A5%BD%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfilled%2C+proced%2C+err+%3A%3D+d.fillHeaderSkeleton%28from%2C+headers%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Debug%28%22Skeleton+chain+invalid%22%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errInvalidChain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bheaders+%3D+filled%5Bproced%3A%5D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+proced%E4%BB%A3%E8%A1%A8%E5%B7%B2%E7%BB%8F%E5%A4%84%E7%90%86%E5%AE%8C%E4%BA%86%E5%A4%9A%E5%B0%91%E4%B8%AA%E4%BA%86%E3%80%82+%E6%89%80%E4%BB%A5%E5%8F%AA%E9%9C%80%E8%A6%81proced%3A%E5%90%8E%E9%9D%A2%E7%9A%84headers%E4%BA%86%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfrom+%2B%3D+uint64%28proced%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Insert+all+the+new+headers+and+fetch+the+next+batch%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28headers%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Trace%28%22Scheduling+new+headers%22%2C+%22count%22%2C+len%28headers%29%2C+%22from%22%2C+from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%E6%8A%95%E9%80%92%E5%88%B0headerProcCh+%E7%84%B6%E5%90%8E%E7%BB%A7%E7%BB%AD%E5%BE%AA%E7%8E%AF%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+d.headerProcCh+%26lt%3B-+headers%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancelHeaderFetch%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfrom+%2B%3D+uint64%28len%28headers%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BgetHeaders%28from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-timeout.C%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Header+retrieval+timed+out%2C+consider+the+peer+bad+and+drop%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Debug%28%22Header+request+timed+out%22%2C+%22elapsed%22%2C+ttl%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderTimeoutMeter.Mark%281%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.dropPeer%28p.id%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Finish+the+sync+gracefully+instead+of+dumping+the+gathered+data+though%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+ch+%3A%3D+range+%5B%5Dchan+bool%7Bd.bodyWakeCh%2C+d.receiptWakeCh%7D+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+ch+%26lt%3B-+false%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+d.headerProcCh+%26lt%3B-+nil%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errBadPeer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++processHeaders%E6%96%B9%E6%B3%95%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E4%BB%8EheaderProcCh%E9%80%9A%E9%81%93%E6%9D%A5%E8%8E%B7%E5%8F%96header%E3%80%82%E5%B9%B6%E6%8A%8A%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84header%E4%B8%A2%E5%85%A5%E5%88%B0queue%E6%9D%A5%E8%BF%9B%E8%A1%8C%E8%B0%83%E5%BA%A6%EF%BC%8C%E8%BF%99%E6%A0%B7body+fetcher%E6%88%96%E8%80%85%E6%98%AFreceipt+fetcher%E5%B0%B1%E5%8F%AF%E4%BB%A5%E9%A2%86%E5%8F%96%E5%88%B0fetch%E4%BB%BB%E5%8A%A1%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+processHeaders+takes+batches+of+retrieved+headers+from+an+input+channel+and%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+keeps+processing+and+scheduling+them+into+the+header+chain+and+downloader%27s%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+queue+until+the+stream+ends+or+a+failure+occurs.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+processHeaders%E6%89%B9%E9%87%8F%E7%9A%84%E8%8E%B7%E5%8F%96headers%EF%BC%8C+%E5%A4%84%E7%90%86%E4%BB%96%E4%BB%AC%EF%BC%8C%E5%B9%B6%E9%80%9A%E8%BF%87downloader%E7%9A%84queue%E5%AF%B9%E8%B1%A1%E6%9D%A5%E8%B0%83%E5%BA%A6%E4%BB%96%E4%BB%AC%E3%80%82+%E7%9B%B4%E5%88%B0%E9%94%99%E8%AF%AF%E5%8F%91%E7%94%9F%E6%88%96%E8%80%85%E5%A4%84%E7%90%86%E7%BB%93%E6%9D%9F%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+processHeaders%28origin+uint64%2C+td+*big.Int%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Calculate+the+pivoting+point+for+switching+from+fast+to+slow+sync%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpivot+%3A%3D+d.queue.FastSyncPivot%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Keep+a+count+of+uncertain+headers+to+roll+back%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+rollback+%E7%94%A8%E6%9D%A5%E5%A4%84%E7%90%86%E8%BF%99%E7%A7%8D%E9%80%BB%E8%BE%91%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9F%90%E4%B8%AA%E7%82%B9%E5%A4%B1%E8%B4%A5%E4%BA%86%E3%80%82%E9%82%A3%E4%B9%88%E4%B9%8B%E5%89%8D%E6%8F%92%E5%85%A5%E7%9A%842048%E4%B8%AA%E8%8A%82%E7%82%B9%E9%83%BD%E8%A6%81%E5%9B%9E%E6%BB%9A%E3%80%82%E5%9B%A0%E4%B8%BA%E5%AE%89%E5%85%A8%E6%80%A7%E8%BE%BE%E4%B8%8D%E5%88%B0%E8%A6%81%E6%B1%82%EF%BC%8C+%E5%8F%AF%E4%BB%A5%E8%AF%A6%E7%BB%86%E5%8F%82%E8%80%83fast+sync%E7%9A%84%E6%96%87%E6%A1%A3%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brollback+%3A%3D+%5B%5D*types.Header%7B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+func%28%29+%7B+%2F%2F+%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E7%94%A8%E6%9D%A5%E9%94%99%E8%AF%AF%E9%80%80%E5%87%BA%E7%9A%84%E6%97%B6%E5%80%99%E8%BF%9B%E8%A1%8C%E5%9B%9E%E6%BB%9A%E3%80%82+TODO%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28rollback%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Flatten+the+headers+and+roll+them+back%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bhashes+%3A%3D+make%28%5B%5Dcommon.Hash%2C+len%28rollback%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+i%2C+header+%3A%3D+range+rollback+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bhashes%5Bi%5D+%3D+header.Hash%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BlastHeader%2C+lastFastBlock%2C+lastBlock+%3A%3D+d.lightchain.CurrentHeader%28%29.Number%2C+common.Big0%2C+common.Big0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%21%3D+LightSync+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BlastFastBlock+%3D+d.blockchain.CurrentFastBlock%28%29.Number%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BlastBlock+%3D+d.blockchain.CurrentBlock%28%29.Number%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.lightchain.Rollback%28hashes%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BcurFastBlock%2C+curBlock+%3A%3D+common.Big0%2C+common.Big0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%21%3D+LightSync+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BcurFastBlock+%3D+d.blockchain.CurrentFastBlock%28%29.Number%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BcurBlock+%3D+d.blockchain.CurrentBlock%28%29.Number%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Warn%28%22Rolled+back+headers%22%2C+%22count%22%2C+len%28hashes%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%22header%22%2C+fmt.Sprintf%28%22%25d-%26gt%3B%25d%22%2C+lastHeader%2C+d.lightchain.CurrentHeader%28%29.Number%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%22fast%22%2C+fmt.Sprintf%28%22%25d-%26gt%3B%25d%22%2C+lastFastBlock%2C+curFastBlock%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%22block%22%2C+fmt.Sprintf%28%22%25d-%26gt%3B%25d%22%2C+lastBlock%2C+curBlock%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+we%27re+already+past+the+pivot+point%2C+this+could+be+an+attack%2C+thread+carefully%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+rollback%5Blen%28rollback%29-1%5D.Number.Uint64%28%29+%26gt%3B+pivot+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+we+didn%27t+ever+fail%2C+lock+in+the+pivot+header+%28must%21+not%21+change%21%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+atomic.LoadUint32%28%26amp%3Bd.fsPivotFails%29+%3D%3D+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+header+%3A%3D+range+rollback+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+header.Number.Uint64%28%29+%3D%3D+pivot+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Warn%28%22Fast-sync+pivot+locked+in%22%2C+%22number%22%2C+pivot%2C+%22hash%22%2C+header.Hash%28%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.fsPivotLock+%3D+header%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Wait+for+batches+of+headers+to+process%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BgotHeaders+%3A%3D+false%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancelHeaderProcessing%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+headers+%3A%3D+%26lt%3B-d.headerProcCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Terminate+header+processing+if+we+synced+up%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28headers%29+%3D%3D+0+%7B+%2F%2F%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Notify+everyone+that+headers+are+fully+processed%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+ch+%3A%3D+range+%5B%5Dchan+bool%7Bd.bodyWakeCh%2C+d.receiptWakeCh%7D+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+ch+%26lt%3B-+false%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+no+headers+were+retrieved+at+all%2C+the+peer+violated+it%27s+TD+promise+that+it+had+a%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+better+chain+compared+to+ours.+The+only+exception+is+if+it%27s+promised+blocks+were%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+already+imported+by+other+means+%28e.g.+fecher%29%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+R+%26lt%3Bremote+peer%26gt%3B%2C+L+%26lt%3Blocal+node%26gt%3B%3A+Both+at+block+10%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+R%3A+Mine+block+11%2C+and+propagate+it+to+L%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+L%3A+Queue+block+11+for+import%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+L%3A+Notice+that+R%27s+head+and+TD+increased+compared+to+ours%2C+start+sync%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+L%3A+Import+of+block+11+finishes%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+L%3A+Sync+begins%2C+and+finds+common+ancestor+at+11%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+L%3A+Request+new+headers+up+from+11+%28R%27s+TD+was+higher%2C+it+must+have+something%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+R%3A+Nothing+to+give%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%21%3D+LightSync+%7B+%2F%2F+%E5%AF%B9%E6%96%B9%E7%9A%84TD%E6%AF%94%E6%88%91%E4%BB%AC%E5%A4%A7%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E8%8E%B7%E5%8F%96%E5%88%B0%E4%BB%BB%E4%BD%95%E4%B8%9C%E8%A5%BF%E3%80%82+%E9%82%A3%E4%B9%88%E8%AE%A4%E4%B8%BA%E5%AF%B9%E6%96%B9%E6%98%AF%E9%94%99%E8%AF%AF%E7%9A%84%E5%AF%B9%E6%96%B9%E3%80%82+%E4%BC%9A%E6%96%AD%E5%BC%80%E5%92%8C%E5%AF%B9%E6%96%B9%E7%9A%84%E8%81%94%E7%B3%BB%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21gotHeaders+%26amp%3B%26amp%3B+td.Cmp%28d.blockchain.GetTdByHash%28d.blockchain.CurrentBlock%28%29.Hash%28%29%29%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errStallingPeer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+fast+or+light+syncing%2C+ensure+promised+headers+are+indeed+delivered.+This+is%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+needed+to+detect+scenarios+where+an+attacker+feeds+a+bad+pivot+and+then+bails+out%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+of+delivering+the+post-pivot+blocks+that+would+flag+the+invalid+content.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+This+check+cannot+be+executed+%22as+is%22+for+full+imports%2C+since+blocks+may+still+be%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+queued+for+processing+when+the+header+download+completes.+However%2C+as+long+as+the%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+peer+gave+us+something+useful%2C+we%27re+already+happy%2Fprogressed+%28above+check%29.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%3D%3D+FastSync+%7C%7C+d.mode+%3D%3D+LightSync+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+td.Cmp%28d.lightchain.GetTdByHash%28d.lightchain.CurrentHeader%28%29.Hash%28%29%29%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errStallingPeer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Disable+any+rollback+and+return%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brollback+%3D+nil%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Otherwise+split+the+chunk+of+headers+into+batches+and+process+them%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BgotHeaders+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+len%28headers%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Terminate+if+something+failed+in+between+processing+chunks%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancelHeaderProcessing%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Select+the+next+chunk+of+headers+to+import%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blimit+%3A%3D+maxHeadersProcess%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+limit+%26gt%3B+len%28headers%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blimit+%3D+len%28headers%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bchunk+%3A%3D+headers%5B%3Alimit%5D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+In+case+of+header+only+syncing%2C+validate+the+chunk+immediately%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%3D%3D+FastSync+%7C%7C+d.mode+%3D%3D+LightSync+%7B+%2F%2F%E5%A6%82%E6%9E%9C%E6%98%AF%E5%BF%AB%E9%80%9F%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%EF%BC%8C%E6%88%96%E8%80%85%E6%98%AF%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%28%E5%8F%AA%E4%B8%8B%E8%BD%BD%E5%8C%BA%E5%9D%97%E5%A4%B4%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Collect+the+yet+unknown+headers+to+mark+them+as+uncertain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bunknown+%3A%3D+make%28%5B%5D*types.Header%2C+0%2C+len%28headers%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+header+%3A%3D+range+chunk+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21d.lightchain.HasHeader%28header.Hash%28%29%2C+header.Number.Uint64%28%29%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bunknown+%3D+append%28unknown%2C+header%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+we%27re+importing+pure+headers%2C+verify+based+on+their+recentness%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%AF%8F%E9%9A%94%E5%A4%9A%E5%B0%91%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%AA%8C%E8%AF%81%E4%B8%80%E6%AC%A1%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfrequency+%3A%3D+fsHeaderCheckFrequency%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+chunk%5Blen%28chunk%29-1%5D.Number.Uint64%28%29%2Buint64%28fsHeaderForceVerify%29+%26gt%3B+pivot+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfrequency+%3D+1%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+lightchain%E9%BB%98%E8%AE%A4%E6%98%AF%E7%AD%89%E4%BA%8Echain%E7%9A%84%E3%80%82+%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E5%A4%B4%E3%80%82%E5%A6%82%E6%9E%9C%E5%A4%B1%E8%B4%A5%E9%82%A3%E4%B9%88%E9%9C%80%E8%A6%81%E5%9B%9E%E6%BB%9A%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+n%2C+err+%3A%3D+d.lightchain.InsertHeaderChain%28chunk%2C+frequency%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+some+headers+were+inserted%2C+add+them+too+to+the+rollback+list%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+n+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brollback+%3D+append%28rollback%2C+chunk%5B%3An%5D...%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Invalid+header+encountered%22%2C+%22number%22%2C+chunk%5Bn%5D.Number%2C+%22hash%22%2C+chunk%5Bn%5D.Hash%28%29%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errInvalidChain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+All+verifications+passed%2C+store+newly+found+uncertain+headers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brollback+%3D+append%28rollback%2C+unknown...%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28rollback%29+%26gt%3B+fsHeaderSafetyNet+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brollback+%3D+append%28rollback%5B%3A0%5D%2C+rollback%5Blen%28rollback%29-fsHeaderSafetyNet%3A%5D...%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+we%27re+fast+syncing+and+just+pulled+in+the+pivot%2C+make+sure+it%27s+the+one+locked+in%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%3D%3D+FastSync+%26amp%3B%26amp%3B+d.fsPivotLock+%21%3D+nil+%26amp%3B%26amp%3B+chunk%5B0%5D.Number.Uint64%28%29+%26lt%3B%3D+pivot+%26amp%3B%26amp%3B+chunk%5Blen%28chunk%29-1%5D.Number.Uint64%28%29+%26gt%3B%3D+pivot+%7B+%2F%2F%E5%A6%82%E6%9E%9CPivotLock%2C%E6%A3%80%E6%9F%A5%E4%B8%80%E4%B8%8BHash%E6%98%AF%E5%90%A6%E7%9B%B8%E5%90%8C%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+pivot+%3A%3D+chunk%5Bint%28pivot-chunk%5B0%5D.Number.Uint64%28%29%29%5D%3B+pivot.Hash%28%29+%21%3D+d.fsPivotLock.Hash%28%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Warn%28%22Pivot+doesn%27t+match+locked+in+one%22%2C+%22remoteNumber%22%2C+pivot.Number%2C+%22remoteHash%22%2C+pivot.Hash%28%29%2C+%22localNumber%22%2C+d.fsPivotLock.Number%2C+%22localHash%22%2C+d.fsPivotLock.Hash%28%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errInvalidChain%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Unless+we%27re+doing+light+chains%2C+schedule+the+headers+for+associated+content+retrieval%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E5%A4%84%E7%90%86%E5%AE%8C%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%93%BE%E3%80%82+%E8%B0%83%E5%BA%A6header%E6%9D%A5%E8%BF%9B%E8%A1%8C%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%9A%84%E8%8E%B7%E5%8F%96%E3%80%82body%EF%BC%8Creceipts%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.mode+%3D%3D+FullSync+%7C%7C+d.mode+%3D%3D+FastSync+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+we%27ve+reached+the+allowed+number+of+pending+headers%2C+stall+a+bit%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8Dqueue%E7%9A%84%E5%AE%B9%E9%87%8F%E5%AE%B9%E7%BA%B3%E4%B8%8D%E4%B8%8B%E4%BA%86%E3%80%82%E9%82%A3%E4%B9%88%E7%AD%89%E5%BE%85%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+d.queue.PendingBlocks%28%29+%26gt%3B%3D+maxQueuedHeaders+%7C%7C+d.queue.PendingReceipts%28%29+%26gt%3B%3D+maxQueuedHeaders+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancelHeaderProcessing%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-time.After%28time.Second%29%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Otherwise+insert+the+headers+for+content+retrieval%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E8%B0%83%E7%94%A8Queue%E8%BF%9B%E8%A1%8C%E8%B0%83%E5%BA%A6%EF%BC%8C%E4%B8%8B%E8%BD%BDbody%E5%92%8Creceipts%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Binserts+%3A%3D+d.queue.Schedule%28chunk%2C+origin%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28inserts%29+%21%3D+len%28chunk%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Stale+headers%22%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errBadPeer%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bheaders+%3D+headers%5Blimit%3A%5D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Borigin+%2B%3D+uint64%28limit%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Signal+the+content+downloaders+of+the+availablility+of+new+tasks%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E7%BB%99%E9%80%9A%E9%81%93d.bodyWakeCh%2C+d.receiptWakeCh%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%EF%BC%8C%E5%94%A4%E9%86%92%E5%A4%84%E7%90%86%E7%BA%BF%E7%A8%8B%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+ch+%3A%3D+range+%5B%5Dchan+bool%7Bd.bodyWakeCh%2C+d.receiptWakeCh%7D+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+ch+%26lt%3B-+true%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%3Cspan+style%3D%22color%3A%23569cd6%3B%22%3E%3Cstrong%3E%23%23+bodies%E5%A4%84%E7%90%86%3C%2Fstrong%3E%3C%2Fspan%3E%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++fetchBodies%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E4%BA%86%E4%B8%80%E4%BA%9B%E9%97%AD%E5%8C%85%E5%87%BD%E6%95%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8%E4%BA%86fetchParts%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fetchBodies+iteratively+downloads+the+scheduled+block+bodies%2C+taking+any%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+available+peers%2C+reserving+a+chunk+of+blocks+for+each%2C+waiting+for+delivery%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+and+also+periodically+checking+for+timeouts.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fetchBodies+%E6%8C%81%E7%BB%AD%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%8C%BA%E5%9D%97%E4%BD%93%EF%BC%8C%E4%B8%AD%E9%97%B4%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%88%B0%E4%BB%BB%E4%BD%95%E5%8F%AF%E4%BB%A5%E7%94%A8%E7%9A%84%E9%93%BE%E6%8E%A5%EF%BC%8C%E4%B8%BA%E6%AF%8F%E4%B8%80%E4%B8%AA%E9%93%BE%E6%8E%A5%E4%BF%9D%E7%95%99%E4%B8%80%E9%83%A8%E5%88%86%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BD%93%EF%BC%8C%E7%AD%89%E5%BE%85%E5%8C%BA%E5%9D%97%E8%A2%AB%E4%BA%A4%E4%BB%98%EF%BC%8C%E5%B9%B6%E5%AE%9A%E6%9C%9F%E7%9A%84%E6%A3%80%E6%9F%A5%E6%98%AF%E5%90%A6%E8%B6%85%E6%97%B6%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+fetchBodies%28from+uint64%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Downloading+block+bodies%22%2C+%22origin%22%2C+from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bvar+%28%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdeliver+%3D+func%28packet+dataPack%29+%28int%2C+error%29+%7B+%2F%2F%E4%B8%8B%E8%BD%BD%E5%AE%8C%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BD%93%E7%9A%84%E4%BA%A4%E4%BB%98%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpack+%3A%3D+packet.%28*bodyPack%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+d.queue.DeliverBodies%28pack.peerId%2C+pack.transactions%2C+pack.uncles%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bexpire+%3D+func%28%29+map%5Bstring%5Dint+%7B+return+d.queue.ExpireBodies%28d.requestTTL%28%29%29+%7D+%2F%2F%E8%B6%85%E6%97%B6%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfetch+%3D+func%28p+*peerConnection%2C+req+*fetchRequest%29+error+%7B+return+p.FetchBodies%28req%29+%7D+%2F%2F+fetch%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcapacity+%3D+func%28p+*peerConnection%29+int+%7B+return+p.BlockCapacity%28d.requestRTT%28%29%29+%7D+%2F%2F+%E5%AF%B9%E7%AB%AF%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsetIdle+%3D+func%28p+*peerConnection%2C+accepted+int%29+%7B+p.SetBodiesIdle%28accepted%29+%7D+%2F%2F+%E8%AE%BE%E7%BD%AEpeer%E4%B8%BAidle%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Berr+%3A%3D+d.fetchParts%28errCancelBodyFetch%2C+d.bodyCh%2C+deliver%2C+d.bodyWakeCh%2C+expire%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.PendingBlocks%2C+d.queue.InFlightBlocks%2C+d.queue.ShouldThrottleBlocks%2C+d.queue.ReserveBodies%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.bodyFetchHook%2C+fetch%2C+d.queue.CancelBodies%2C+capacity%2C+d.peers.BodyIdlePeers%2C+setIdle%2C+%22bodies%22%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Block+body+download+terminated%22%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++fetchParts%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fetchParts+iteratively+downloads+scheduled+block+parts%2C+taking+any+available%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+peers%2C+reserving+a+chunk+of+fetch+requests+for+each%2C+waiting+for+delivery+and%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+also+periodically+checking+for+timeouts.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fetchParts%E8%BF%AD%E4%BB%A3%E5%9C%B0%E4%B8%8B%E8%BD%BD%E9%A2%84%E5%AE%9A%E7%9A%84%E5%9D%97%E9%83%A8%E5%88%86%EF%BC%8C%E5%8F%96%E5%BE%97%E4%BB%BB%E4%BD%95%E5%8F%AF%E7%94%A8%E7%9A%84%E5%AF%B9%E7%AD%89%E4%BD%93%EF%BC%8C%E4%B8%BA%E6%AF%8F%E4%B8%AA%E9%83%A8%E5%88%86%E9%A2%84%E7%95%99%E5%A4%A7%E9%87%8F%E7%9A%84%E6%8F%90%E5%8F%96%E8%AF%B7%E6%B1%82%EF%BC%8C%E7%AD%89%E5%BE%85%E4%BA%A4%E4%BB%98%E5%B9%B6%E4%B8%94%E8%BF%98%E5%AE%9A%E6%9C%9F%E6%A3%80%E6%9F%A5%E8%B6%85%E6%97%B6%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+As+the+scheduling%2Ftimeout+logic+mostly+is+the+same+for+all+downloaded+data%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+types%2C+this+method+is+used+by+each+for+data+gathering+and+is+instrumented+with%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+various+callbacks+to+handle+the+slight+differences+between+processing+them.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E7%94%B1%E4%BA%8E%E8%B0%83%E5%BA%A6%2F%E8%B6%85%E6%97%B6%E9%80%BB%E8%BE%91%E5%AF%B9%E4%BA%8E%E6%89%80%E6%9C%89%E4%B8%8B%E8%BD%BD%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%A4%A7%E9%83%A8%E5%88%86%E6%98%AF%E7%9B%B8%E5%90%8C%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E8%A2%AB%E7%94%A8%E4%BA%8E%E4%B8%8D%E5%90%8C%E7%9A%84%E5%8C%BA%E5%9D%97%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%B8%8B%E8%BD%BD%EF%BC%8C%E5%B9%B6%E4%B8%94%E7%94%A8%E5%90%84%E7%A7%8D%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E6%9D%A5%E5%A4%84%E7%90%86%E5%AE%83%E4%BB%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E7%BB%86%E5%BE%AE%E5%B7%AE%E5%88%AB%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+The+instrumentation+parameters%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+errCancel%3A+error+type+to+return+if+the+fetch+operation+is+cancelled+%28mostly+makes+logging+nicer%29+%E5%A6%82%E6%9E%9Cfetch%E6%93%8D%E4%BD%9C%E8%A2%AB%E5%8F%96%E6%B6%88%EF%BC%8C%E4%BC%9A%E5%9C%A8%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%E4%B8%8A%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+deliveryCh%3A+channel+from+which+to+retrieve+downloaded+data+packets+%28merged+from+all+concurrent+peers%29+%E6%95%B0%E6%8D%AE%E8%A2%AB%E4%B8%8B%E8%BD%BD%E5%AE%8C%E6%88%90%E5%90%8E%E6%8A%95%E9%80%92%E7%9A%84%E7%9B%AE%E7%9A%84%E5%9C%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+deliver%3A+processing+callback+to+deliver+data+packets+into+type+specific+download+queues+%28usually+within+%60queue%60%29+%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%E5%90%8E%E6%95%B0%E6%8D%AE%E8%A2%AB%E6%8A%95%E9%80%92%E5%88%B0%E5%93%AA%E4%B8%AA%E9%98%9F%E5%88%97%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+wakeCh%3A+notification+channel+for+waking+the+fetcher+when+new+tasks+are+available+%28or+sync+completed%29+%E7%94%A8%E6%9D%A5%E9%80%9A%E7%9F%A5fetcher+%E6%96%B0%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%88%B0%E6%9D%A5%EF%BC%8C%E6%88%96%E8%80%85%E6%98%AF%E5%90%8C%E6%AD%A5%E5%AE%8C%E6%88%90%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+expire%3A+task+callback+method+to+abort+requests+that+took+too+long+and+return+the+faulty+peers+%28traffic+shaping%29+%E5%9B%A0%E4%B8%BA%E8%B6%85%E6%97%B6%E6%9D%A5%E7%BB%88%E6%AD%A2%E8%AF%B7%E6%B1%82%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+pending%3A+task+callback+for+the+number+of+requests+still+needing+download+%28detect+completion%2Fnon-completability%29+%E8%BF%98%E9%9C%80%E8%A6%81%E4%B8%8B%E8%BD%BD%E7%9A%84%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%95%B0%E9%87%8F%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+inFlight%3A+task+callback+for+the+number+of+in-progress+requests+%28wait+for+all+active+downloads+to+finish%29+%E6%AD%A3%E5%9C%A8%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E8%AF%B7%E6%B1%82%E6%95%B0%E9%87%8F%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+throttle%3A+task+callback+to+check+if+the+processing+queue+is+full+and+activate+throttling+%28bound+memory+use%29+%E7%94%A8%E6%9D%A5%E6%A3%80%E6%9F%A5%E5%A4%84%E7%90%86%E9%98%9F%E5%88%97%E6%98%AF%E5%90%A6%E6%BB%A1%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+reserve%3A+task+callback+to+reserve+new+download+tasks+to+a+particular+peer+%28also+signals+partial+completions%29+%E7%94%A8%E6%9D%A5%E4%B8%BA%E6%9F%90%E4%B8%AApeer%E6%9D%A5%E9%A2%84%E5%AE%9A%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+fetchHook%3A+tester+callback+to+notify+of+new+tasks+being+initiated+%28allows+testing+the+scheduling+logic%29+%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+fetch%3A+network+callback+to+actually+send+a+particular+download+request+to+a+physical+remote+peer+%2F%2F%E5%8F%91%E9%80%81%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+cancel%3A+task+callback+to+abort+an+in-flight+download+request+and+allow+rescheduling+it+%28in+case+of+lost+peer%29+%E7%94%A8%E6%9D%A5%E5%8F%96%E6%B6%88%E6%AD%A3%E5%9C%A8%E5%A4%84%E7%90%86%E7%9A%84%E4%BB%BB%E5%8A%A1%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+capacity%3A+network+callback+to+retrieve+the+estimated+type-specific+bandwidth+capacity+of+a+peer+%28traffic+shaping%29+%E7%BD%91%E7%BB%9C%E5%AE%B9%E9%87%8F%E6%88%96%E8%80%85%E6%98%AF%E5%B8%A6%E5%AE%BD%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+idle%3A+network+callback+to+retrieve+the+currently+%28type+specific%29+idle+peers+that+can+be+assigned+tasks+peer%E6%98%AF%E5%90%A6%E7%A9%BA%E9%97%B2%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+setIdle%3A+network+callback+to+set+a+peer+back+to+idle+and+update+its+estimated+capacity+%28traffic+shaping%29+%E8%AE%BE%E7%BD%AEpeer%E4%B8%BA%E7%A9%BA%E9%97%B2%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+-+kind%3A+textual+label+of+the+type+being+downloaded+to+display+in+log+mesages+%E4%B8%8B%E8%BD%BD%E7%B1%BB%E5%9E%8B%EF%BC%8C%E7%94%A8%E4%BA%8E%E6%97%A5%E5%BF%97%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+fetchParts%28errCancel+error%2C+deliveryCh+chan+dataPack%2C+deliver+func%28dataPack%29+%28int%2C+error%29%2C+wakeCh+chan+bool%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bexpire+func%28%29+map%5Bstring%5Dint%2C+pending+func%28%29+int%2C+inFlight+func%28%29+bool%2C+throttle+func%28%29+bool%2C+reserve+func%28*peerConnection%2C+int%29+%28*fetchRequest%2C+bool%2C+error%29%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BfetchHook+func%28%5B%5D*types.Header%29%2C+fetch+func%28*peerConnection%2C+*fetchRequest%29+error%2C+cancel+func%28*fetchRequest%29%2C+capacity+func%28*peerConnection%29+int%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bidle+func%28%29+%28%5B%5D*peerConnection%2C+int%29%2C+setIdle+func%28*peerConnection%2C+int%29%2C+kind+string%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Create+a+ticker+to+detect+expired+retrieval+tasks%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bticker+%3A%3D+time.NewTicker%28100+*+time.Millisecond%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+ticker.Stop%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bupdate+%3A%3D+make%28chan+struct%7B%7D%2C+1%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Prepare+the+queue+and+fetch+block+parts+until+the+block+header+fetcher%27s+done%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfinished+%3A%3D+false%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-d.cancelCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errCancel%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+packet+%3A%3D+%26lt%3B-deliveryCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+the+peer+was+previously+banned+and+failed+to+deliver+it%27s+pack%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+in+a+reasonable+time+frame%2C+ignore+it%27s+message.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9Cpeer%E5%9C%A8%E4%B9%8B%E5%89%8D%E8%A2%AB%E7%A6%81%E6%AD%A2%E8%80%8C%E4%B8%94%E6%B2%A1%E6%9C%89%E5%9C%A8%E5%90%88%E9%80%82%E7%9A%84%E6%97%B6%E9%97%B4deliver%E5%AE%83%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E9%82%A3%E4%B9%88%E5%BF%BD%E7%95%A5%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+peer+%3A%3D+d.peers.Peer%28packet.PeerId%28%29%29%3B+peer+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Deliver+the+received+chunk+of+data+and+check+chain+validity%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Baccepted%2C+err+%3A%3D+deliver%28packet%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3D%3D+errInvalidChain+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Unless+a+peer+delivered+something+completely+else+than+requested+%28usually%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+caused+by+a+timed+out+request+which+came+through+in+the+end%29%2C+set+it+to%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+idle.+If+the+delivery%27s+stale%2C+the+peer+should+have+already+been+idled.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+errStaleDelivery+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsetIdle%28peer%2C+accepted%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Issue+a+log+to+the+user+to+see+what%27s+going+on%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bswitch+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+err+%3D%3D+nil+%26amp%3B%26amp%3B+packet.Items%28%29+%3D%3D+0%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Requested+data+not+delivered%22%2C+%22type%22%2C+kind%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+err+%3D%3D+nil%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Delivered+new+batch+of+data%22%2C+%22type%22%2C+kind%2C+%22count%22%2C+packet.Stats%28%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Failed+to+deliver+retrieved+data%22%2C+%22type%22%2C+kind%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Blocks+assembled%2C+try+to+update+the+progress%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+update+%26lt%3B-+struct%7B%7D%7B%7D%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+cont+%3A%3D+%26lt%3B-wakeCh%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+The+header+fetcher+sent+a+continuation+flag%2C+check+if+it%27s+done%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%BD%93%E6%89%80%E6%9C%89%E7%9A%84%E4%BB%BB%E5%8A%A1%E5%AE%8C%E6%88%90%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E5%86%99%E5%85%A5%E8%BF%99%E4%B8%AA%E9%98%9F%E5%88%97%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21cont+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfinished+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Headers+arrive%2C+try+to+update+the+progress%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+update+%26lt%3B-+struct%7B%7D%7B%7D%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-ticker.C%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Sanity+check+update+the+progress%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bselect+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+update+%26lt%3B-+struct%7B%7D%7B%7D%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefault%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcase+%26lt%3B-update%3A%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Short+circuit+if+we+lost+all+our+peers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.peers.Len%28%29+%3D%3D+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errNoPeers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Check+for+fetch+request+timeouts+and+demote+the+responsible+peers%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+pid%2C+fails+%3A%3D+range+expire%28%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+peer+%3A%3D+d.peers.Peer%28pid%29%3B+peer+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+a+lot+of+retrieval+elements+expired%2C+we+might+have+overestimated+the+remote+peer+or+perhaps%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+ourselves.+Only+reset+to+minimal+throughput+but+don%27t+drop+just+yet.+If+even+the+minimal+times%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+out+that+sync+wise+we+need+to+get+rid+of+the+peer.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%E5%A6%82%E6%9E%9C%E5%BE%88%E5%A4%9A%E6%A3%80%E7%B4%A2%E5%85%83%E7%B4%A0%E8%BF%87%E6%9C%9F%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E8%83%BD%E9%AB%98%E4%BC%B0%E4%BA%86%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E6%88%96%E8%80%85%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E3%80%82+%E5%8F%AA%E8%83%BD%E9%87%8D%E7%BD%AE%E4%B8%BA%E6%9C%80%E5%B0%8F%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F%EF%BC%8C%E4%BD%86%E4%B8%8D%E8%A6%81%E4%B8%A2%E5%BC%83%E3%80%82+%E5%A6%82%E6%9E%9C%E5%8D%B3%E4%BD%BF%E6%9C%80%E5%B0%8F%E7%9A%84%E5%90%8C%E6%AD%A5%E4%BB%BB%E7%84%B6%E8%B6%85%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E9%9C%80%E8%A6%81%E5%88%A0%E9%99%A4peer%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+The+reason+the+minimum+threshold+is+2+is+because+the+downloader+tries+to+estimate+the+bandwidth%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+and+latency+of+a+peer+separately%2C+which+requires+pushing+the+measures+capacity+a+bit+and+seeing%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+how+response+times+reacts%2C+to+it+always+requests+one+more+than+the+minimum+%28i.e.+min+2%29.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%9C%80%E5%B0%8F%E9%98%88%E5%80%BC%E4%B8%BA2%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AF%E5%9B%A0%E4%B8%BA%E4%B8%8B%E8%BD%BD%E5%99%A8%E8%AF%95%E5%9B%BE%E5%88%86%E5%88%AB%E4%BC%B0%E8%AE%A1%E5%AF%B9%E7%AD%89%E4%BD%93%E7%9A%84%E5%B8%A6%E5%AE%BD%E5%92%8C%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%EF%BC%8C%E8%BF%99%E9%9C%80%E8%A6%81%E7%A8%8D%E5%BE%AE%E6%8E%A8%E5%8A%A8%E6%B5%8B%E9%87%8F%E5%AE%B9%E9%87%8F%E5%B9%B6%E4%B8%94%E7%9C%8B%E5%88%B0%E5%93%8D%E5%BA%94%E6%97%B6%E9%97%B4%E5%A6%82%E4%BD%95%E5%8F%8D%E5%BA%94%EF%BC%8C%E6%80%BB%E6%98%AF%E8%A6%81%E6%B1%82%E6%AF%94%E6%9C%80%E5%B0%8F%E5%80%BC%EF%BC%88%E5%8D%B3%EF%BC%8C%E6%9C%80%E5%B0%8F%E5%80%BC2%EF%BC%89%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+fails+%26gt%3B+2+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Data+delivery+timed+out%22%2C+%22type%22%2C+kind%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsetIdle%28peer%2C+0%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Debug%28%22Stalling+delivery%2C+dropping%22%2C+%22type%22%2C+kind%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.dropPeer%28pid%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+there%27s+nothing+more+to+fetch%2C+wait+or+terminate%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E4%BB%BB%E5%8A%A1%E5%85%A8%E9%83%A8%E5%AE%8C%E6%88%90%E3%80%82+%E9%82%A3%E4%B9%88%E9%80%80%E5%87%BA%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+pending%28%29+%3D%3D+0+%7B+%2F%2F%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E7%AD%89%E5%BE%85%E5%88%86%E9%85%8D%E7%9A%84%E4%BB%BB%E5%8A%A1%EF%BC%8C+%E9%82%A3%E4%B9%88break%E3%80%82%E4%B8%8D%E7%94%A8%E6%89%A7%E8%A1%8C%E4%B8%8B%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E4%BA%86%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21inFlight%28%29+%26amp%3B%26amp%3B+finished+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Data+fetching+completed%22%2C+%22type%22%2C+kind%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bbreak%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Send+a+download+request+to+all+idle+peers%2C+until+throttled%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bprogressed%2C+throttled%2C+running+%3A%3D+false%2C+false%2C+inFlight%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bidles%2C+total+%3A%3D+idle%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+peer+%3A%3D+range+idles+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Short+circuit+if+throttling+activated%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+throttle%28%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bthrottled+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bbreak%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Short+circuit+if+there+is+no+more+available+task.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+pending%28%29+%3D%3D+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bbreak%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Reserve+a+chunk+of+fetches+for+a+peer.+A+nil+can+mean+either+that%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+no+more+headers+are+available%2C+or+that+the+peer+is+known+not+to%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+have+them.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E4%B8%BA%E6%9F%90%E4%B8%AApeer%E8%AF%B7%E6%B1%82%E5%88%86%E9%85%8D%E4%BB%BB%E5%8A%A1%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brequest%2C+progress%2C+err+%3A%3D+reserve%28peer%2C+capacity%28peer%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+progress+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bprogressed+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+request+%3D%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcontinue%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+request.From+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Requesting+new+batch+of+data%22%2C+%22type%22%2C+kind%2C+%22from%22%2C+request.From%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+if+len%28request.Headers%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Requesting+new+batch+of+data%22%2C+%22type%22%2C+kind%2C+%22count%22%2C+len%28request.Headers%29%2C+%22from%22%2C+request.Headers%5B0%5D.Number%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.log.Trace%28%22Requesting+new+batch+of+data%22%2C+%22type%22%2C+kind%2C+%22count%22%2C+len%28request.Hashes%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Fetch+the+chunk+and+make+sure+any+errors+return+the+hashes+to+the+queue%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+fetchHook+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BfetchHook%28request.Headers%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3A%3D+fetch%28peer%2C+request%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Although+we+could+try+and+make+an+attempt+to+fix+this%2C+this+error+really%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+means+that+we%27ve+double+allocated+a+fetch+task+to+a+peer.+If+that+is+the%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+case%2C+the+internal+state+of+the+downloader+and+the+queue+is+very+wrong+so%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+better+hard+crash+and+note+the+error+instead+of+silently+accumulating+into%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+a+much+bigger+issue.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpanic%28fmt.Sprintf%28%22%25v%3A+%25s+fetch+assignment+failed%22%2C+peer%2C+kind%29%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brunning+%3D+true%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Make+sure+that+we+have+peers+available+for+fetching.+If+all+peers+have+been+tried%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+and+all+failed+throw+an+error%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21progressed+%26amp%3B%26amp%3B+%21throttled+%26amp%3B%26amp%3B+%21running+%26amp%3B%26amp%3B+len%28idles%29+%3D%3D+total+%26amp%3B%26amp%3B+pending%28%29+%26gt%3B+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errPeersUnavailable%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%3Cspan+style%3D%22color%3A%23569cd6%3B%22%3E%3Cstrong%3E%23%23+receipt%E7%9A%84%E5%A4%84%E7%90%86%3C%2Fstrong%3E%3C%2Fspan%3E%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++receipt%E7%9A%84%E5%A4%84%E7%90%86%E5%92%8Cbody%E7%B1%BB%E4%BC%BC%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+fetchReceipts+iteratively+downloads+the+scheduled+block+receipts%2C+taking+any%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+available+peers%2C+reserving+a+chunk+of+receipts+for+each%2C+waiting+for+delivery%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+and+also+periodically+checking+for+timeouts.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+fetchReceipts%28from+uint64%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Downloading+transaction+receipts%22%2C+%22origin%22%2C+from%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bvar+%28%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdeliver+%3D+func%28packet+dataPack%29+%28int%2C+error%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpack+%3A%3D+packet.%28*receiptPack%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+d.queue.DeliverReceipts%28pack.peerId%2C+pack.receipts%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bexpire+%3D+func%28%29+map%5Bstring%5Dint+%7B+return+d.queue.ExpireReceipts%28d.requestTTL%28%29%29+%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfetch+%3D+func%28p+*peerConnection%2C+req+*fetchRequest%29+error+%7B+return+p.FetchReceipts%28req%29+%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bcapacity+%3D+func%28p+*peerConnection%29+int+%7B+return+p.ReceiptCapacity%28d.requestRTT%28%29%29+%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BsetIdle+%3D+func%28p+*peerConnection%2C+accepted+int%29+%7B+p.SetReceiptsIdle%28accepted%29+%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Berr+%3A%3D+d.fetchParts%28errCancelReceiptFetch%2C+d.receiptCh%2C+deliver%2C+d.receiptWakeCh%2C+expire%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.PendingReceipts%2C+d.queue.InFlightReceipts%2C+d.queue.ShouldThrottleReceipts%2C+d.queue.ReserveReceipts%2C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.receiptFetchHook%2C+fetch%2C+d.queue.CancelReceipts%2C+capacity%2C+d.peers.ReceiptIdlePeers%2C+setIdle%2C+%22receipts%22%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog.Debug%28%22Transaction+receipt+download+terminated%22%2C+%22err%22%2C+err%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%3Cspan+style%3D%22color%3A%23569cd6%3B%22%3E%3Cstrong%3E%23%23+processFastSyncContent+%E5%92%8C+processFullSyncContent%3C%2Fstrong%3E%3C%2Fspan%3E%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+processFastSyncContent+takes+fetch+results+from+the+queue+and+writes+them+to+the%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+database.+It+also+controls+the+synchronisation+of+state+nodes+of+the+pivot+block.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+processFastSyncContent%28latest+*types.Header%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Start+syncing+state+of+the+reported+head+block.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+This+should+get+us+most+of+the+state+of+the+pivot+block.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%90%AF%E5%8A%A8%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateSync+%3A%3D+d.syncState%28latest.Root%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+stateSync.Cancel%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+func%28%29+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3A%3D+stateSync.Wait%28%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.queue.Close%28%29+%2F%2F+wake+up+WaitResults%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpivot+%3A%3D+d.queue.FastSyncPivot%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bresults+%3A%3D+d.queue.WaitResults%28%29+%2F%2F+%E7%AD%89%E5%BE%85%E9%98%9F%E5%88%97%E8%BE%93%E5%87%BA%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%E7%9A%84%E5%8C%BA%E5%9D%97%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28results%29+%3D%3D+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+stateSync.Cancel%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.chainInsertHook+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.chainInsertHook%28results%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BP%2C+beforeP%2C+afterP+%3A%3D+splitAroundPivot%28pivot%2C+results%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%8F%92%E5%85%A5fast+sync%E7%9A%84%E6%95%B0%E6%8D%AE%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3A%3D+d.commitFastSyncData%28beforeP%2C+stateSync%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+P+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E5%B7%B2%E7%BB%8F%E8%BE%BE%E5%88%B0%E4%BA%86+pivot+point+%E9%82%A3%E4%B9%88%E7%AD%89%E5%BE%85%E7%8A%B6%E6%80%81%E5%90%8C%E6%AD%A5%E5%AE%8C%E6%88%90%EF%BC%8C%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateSync.Cancel%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3A%3D+d.commitPivotBlock%28P%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%AF%B9%E4%BA%8Epivot+point+%E4%B9%8B%E5%90%8E%E7%9A%84%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%8C%E9%83%BD%E9%9C%80%E8%A6%81%E6%8C%89%E7%85%A7%E5%AE%8C%E5%85%A8%E7%9A%84%E5%A4%84%E7%90%86%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3A%3D+d.importBlockResults%28afterP%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A+++%3Cdiv%3E%0A++++processFullSyncContent%2C%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%E3%80%82+%E4%BB%8E%E9%98%9F%E5%88%97%E9%87%8C%E9%9D%A2%E8%8E%B7%E5%8F%96%E5%8C%BA%E5%9D%97%E7%84%B6%E5%90%8E%E6%8F%92%E5%85%A5%E3%80%82%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+processFullSyncContent+takes+fetch+results+from+the+queue+and+imports+them+into+the+chain.%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28d+*Downloader%29+processFullSyncContent%28%29+error+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bresults+%3A%3D+d.queue.WaitResults%28%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28results%29+%3D%3D+0+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+d.chainInsertHook+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bd.chainInsertHook%28results%29%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+err+%3A%3D+d.importBlockResults%28results%29%3B+err+%21%3D+nil+%7B%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+err%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cdiv%3E%0A++++%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%0A+++%3C%2Fdiv%3E%0A+++%3Cbr%3E%0A++%3C%2Fdiv%3E%0A++%3Ch2+style%3D%22font-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180430224554793%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3Cbr%3E%3C%2Fh2%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180425001235188%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180425001144107%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%E7%BD%91%E5%9D%80%EF%BC%9Ahttp%3A%2F%2Fwww.qukuailianxueyuan.io%2F%3Cbr%3E%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180426145827720%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F2018042614570887%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%E6%AC%B2%E9%A2%86%E5%8F%96%E9%80%A0%E5%B8%81%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%85%A8%E5%A5%97%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%B5%84%E6%96%99%3C%2Fp%3E%0A++%3Cp+style%3D%22font-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%3Cspan+style%3D%22color%3Argb%2825%2C25%2C25%29%3B%22%3E%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E4%BA%A4%E6%B5%81QQ%E7%BE%A4%EF%BC%9A%3C%2Fspan%3E%3Cspan+style%3D%22color%3Argb%28255%2C0%2C0%29%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E756146052%26nbsp%3B%26nbsp%3B%3C%2Fspan%3E%3Cspan+style%3D%22color%3Argb%2825%2C25%2C25%29%3B%22%3E%E5%A4%87%E6%B3%A8%EF%BC%9ACSDN%3C%2Fspan%3E%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%E5%B0%B9%E6%88%90%E5%AD%A6%E9%99%A2%E5%BE%AE%E4%BF%A1%EF%BC%9A%E5%A4%87%E6%B3%A8%EF%BC%9ACSDN%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2825%2C25%2C25%29%3Btext-align%3Acenter%3Bfont-family%3AConsolas%2C+%27Courier+New%27%2C+monospace%3B%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180425000635656%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3lpbmNoZW5nMDE%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3C%2Fp%3E%0A++%3Cdiv%3E%0A+++%3Cbr%3E%0A++%3C%2Fdiv%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fitcastcpp%2Farticle%2Fdetails%2F80305326%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fitcastcpp%2Farticle%2Fdetails%2F80305326%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}