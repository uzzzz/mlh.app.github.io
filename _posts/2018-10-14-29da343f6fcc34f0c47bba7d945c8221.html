---
layout: default
title: 【我的区块链之路】- 以太坊源码剖析之Geth节点启动全量过程详解
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-f76675cdea.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%E3%80%90%E8%BD%AC%E8%BD%BD%E8%AF%B7%E6%A0%87%E6%98%8E%E5%87%BA%E5%A4%84%E3%80%91%3C%2Fspan%3E%3Ca+href%3D%22https%3A%2F%2Fblog.csdn.net%2Fqq_25870633%2Farticle%2Fdetails%2F82992805%22+rel%3D%22nofollow%22%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3Ehttps%3A%2F%2Fblog.csdn.net%2Fqq_25870633%2Farticle%2Fdetails%2F82992805%3C%2Fspan%3E%3C%2Fa%3E%3C%2Fp%3E+%0A++%3Cp%3E%E6%9C%80%E8%BF%91%E5%9C%A8%E6%95%B4%E7%90%86%E5%89%8D%E7%AB%AF%E6%97%B6%E9%97%B4%E5%AD%A6%E4%B9%A0%E7%9A%84%E6%BA%90%E7%A0%81%EF%BC%8C%E7%94%B1%E4%BA%8E%E6%BA%90%E7%A0%81%E7%9A%84%E5%AD%A6%E4%B9%A0%E6%98%AF%E7%89%87%E6%AE%B5%E7%9A%84%EF%BC%8C%E9%82%A3%E4%B9%88%E6%88%91%E4%BB%AC%E5%9C%A8%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E4%B8%AD%E6%8A%8A%E5%AE%83%E5%85%B3%E8%81%94%E8%B5%B7%E6%9D%A5%EF%BC%8C%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E6%88%91%E4%BB%AC%E8%AE%B2P2P%E9%83%A8%E5%88%86%EF%BC%8C%E6%88%91%E4%BB%AC%E4%BC%9A%E4%BB%8EGeth%E7%9A%84%E5%85%A5%E5%8F%A3%E4%B8%80%E7%9B%B4%E5%88%B0%E5%90%8E%E9%9D%A2%E7%9A%84%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0%EF%BC%8C%E8%8A%82%E7%82%B9%E9%97%B4%E5%B9%BF%E6%92%AD%E5%8F%8A%E5%90%8C%E6%AD%A5TX%E5%92%8CBlock%E7%9A%84%E8%AE%B2%E8%A7%A3%E3%80%82%E9%A6%96%E5%85%88%EF%BC%8C%E6%88%91%E8%BF%99%E9%87%8C%E5%85%88%E4%B8%8D%E8%AF%B4fetcher+%E5%8F%8Adownloader%E7%9A%84%E5%85%B7%E4%BD%93%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%8C%E5%8F%AA%E6%98%AF%E4%BB%8Egeth%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%85%A5%E5%8F%A3%EF%BC%8C%E6%8A%8A%E5%AE%83%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E4%BA%8B%E6%83%85%EF%BC%8C%E5%8F%8A%E5%92%8Cp2p%E7%9B%B8%E5%85%B3%E7%9A%84%E9%83%A8%E5%88%86%E7%BB%86%E5%8C%96%E5%BE%81%E7%A8%8B%E4%B8%80%E5%BC%A0%E6%B5%81%E7%A8%8B%E5%9B%BE%E5%85%88%E5%B1%95%E7%A4%BA%E5%87%BA%E6%9D%A5%EF%BC%8C%E7%84%B6%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E5%9C%A8%E8%B7%9F%E7%9D%80%E4%BB%A3%E7%A0%81%E4%B8%80%E6%AD%A5%E6%AD%A5%E7%9A%84%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%BA%9F%E8%AF%9D%E4%B8%8D%E5%A4%9A%E8%AF%B4%EF%BC%8C%E5%85%88%E4%B8%8A%E5%9B%BE%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20181014130829364%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%E5%A5%BD%E4%BA%86%EF%BC%8C%E6%88%91%E7%9F%A5%E9%81%93%E7%9A%84%E6%B5%81%E7%A8%8B%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%EF%BC%8C%E5%9B%BE%E4%B9%9F%E5%BE%88%E5%A4%A7%EF%BC%8C%E6%88%91%E8%BF%99%E9%87%8C%E5%B7%B2%E7%BB%8F%E5%AF%B9+fetcher+%E5%92%8Cdownloader+%E9%83%A8%E5%88%86%E5%89%AA%E5%87%BA%E6%9D%A5%EF%BC%8C%E5%8D%95%E7%8B%AC%E5%81%9A%E6%88%90%E5%9B%BE%E5%8F%A6%E5%A4%96%E8%AE%B2%E8%A7%A3%E4%BA%86%EF%BC%81%E9%82%A3%E4%B9%88%EF%BC%8C%E9%95%BF%E8%AF%9D%E7%9F%AD%E8%AF%B4%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E4%BA%86%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%85%88%E7%9C%8B%E4%B8%8B+go-ehereum%2Fcmd%2Fgeth%E8%B7%AF%E5%BE%84%E4%B8%8B%E7%9A%84main.go+%E6%96%87%E4%BB%B6%E7%9A%84main%E5%87%BD%E6%95%B0%E4%B8%AD%E5%81%9A%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88%E4%BA%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+height%3D%22194%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20181013211658279%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+width%3D%22508%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%3Cstrong%3Eapp.Run%28os.Args%29%3C%2Fstrong%3E%E3%80%82%E5%9B%A0%E4%B8%BA%E5%9C%A8%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%AD%E6%98%AF%E7%94%A8%E4%BA%86%E4%B8%80%E4%B8%AA%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E6%9D%A5%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4%E8%A1%8C%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Egopkg.in%2Furfave%2Fcli.v1%3C%2Fstrong%3E%3C%2Fspan%3E+%E6%89%80%E4%BB%A5%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%EF%BC%8Capp%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AA%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E7%9A%84%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%9C%A8%E5%BD%93%E5%89%8Dmain.go%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%80%E4%B8%8A%E9%9D%A2%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E6%9C%89%E4%B8%80%E8%A1%8C%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+height%3D%22208%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20181013212246509%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+width%3D%22787%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%E7%84%B6%E5%90%8E%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%88%E5%9C%A8init%E5%87%BD%E6%95%B0%E4%B8%AD%E5%8F%91%E7%8E%B0%E4%BA%86%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+height%3D%22218%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F2018101321232156%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+width%3D%22774%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%80%E8%A1%8C%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E5%8F%AA%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E5%85%B6%E5%AE%9Eapp.Run%E5%B0%B1%E6%98%AF%E4%BC%9A%E8%B0%83%E7%94%A8app.Action+%E6%88%90%E5%91%98%E6%89%80%E5%BC%95%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0%E3%80%82%E4%B8%8D%E5%BF%85%E6%B7%B1%E7%A9%B6%E8%BF%99%E4%B8%AA%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8%EF%BC%8C%E8%BF%99%E4%B8%8D%E6%98%AF%E6%88%91%E4%BB%AC%E6%9C%AC%E6%96%87%E7%9A%84%E9%87%8D%E7%82%B9%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%85%88%E7%9C%8B%E4%B8%8B+%3Cstrong%3Egeth+%3C%2Fstrong%3E%E5%87%BD%E6%95%B0%E4%B8%AD%E5%81%9A%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88%E4%BA%8B%E6%83%85%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+height%3D%22256%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F2018101321245957%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+width%3D%22722%22%3E%3C%2Fp%3E+%0A++%3Cp%3EOK%EF%BC%8C%E9%87%8C%E9%9D%A2%E6%80%BB%E5%85%B1%E5%B0%B1%E5%81%9A%E4%BA%86%E4%B8%89%E4%BB%B6%E4%BA%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Col%3E%0A+++%3Cli%3E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0node%E5%AE%9E%E4%BE%8B%3C%2Fli%3E+%0A+++%3Cli%3E%E5%90%AF%E5%8A%A8%E6%9C%AC%E5%9C%B0%E7%9A%84node%E5%AE%9E%E4%BE%8B%3C%2Fli%3E+%0A+++%3Cli%3E%E9%98%BB%E5%A1%9E%E6%9C%AC%E5%9C%B0node%E5%AE%9E%E4%BE%8B%E8%BF%9B%E7%A8%8B%28%E7%9B%91%E5%90%AC%E9%80%80%E5%87%BA%E4%BA%8B%E4%BB%B6%29%3C%2Fli%3E+%0A++%3C%2Fol%3E%0A++%3Cp%3E%E4%BD%86%E6%98%AF%EF%BC%8C%E8%BF%99%E4%B8%89%E4%BB%B6%E4%BA%8B%EF%BC%8C%E5%85%B6%E5%AE%9E%E6%98%AF%E5%BA%95%E5%B1%82%E7%9A%84%E5%BE%88%E5%A4%9A%E4%BB%B6%E4%BA%8B%E6%83%85%E7%BC%96%E7%BB%87%E5%88%B0%E4%B8%80%E8%B5%B7%E7%9A%84%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E4%B8%80%E4%B8%AA%E4%B8%80%E4%B8%AA%E6%9D%A5%E5%AF%B9%E8%BF%99%E4%B8%89%E4%BB%B6%E4%BA%8B%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90%EF%BC%8C%E9%A6%96%E5%85%88%E7%9C%8B%E7%9C%8B%E5%AE%9E%E4%BE%8B%E5%8C%96node%E5%AE%9E%E4%BE%8B%E9%87%8C%E9%9D%A2%E5%81%9A%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch1%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%E5%88%9D%E5%A7%8B%E5%8C%96node%E8%8A%82%E7%82%B9%3C%2Fspan%3E%EF%BC%9A%3C%2Fh1%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+makeFullNode%28ctx+*cli.Context%29+*node.Node+%7B%0A%09stack%2C+cfg+%3A%3D+makeConfigNode%28ctx%29%0A%0A%09utils.RegisterEthService%28stack%2C+%26amp%3Bcfg.Eth%29%0A%0A%09if+ctx.GlobalBool%28utils.DashboardEnabledFlag.Name%29+%7B%0A%09%09utils.RegisterDashboardService%28stack%2C+%26amp%3Bcfg.Dashboard%2C+gitCommit%29%0A%09%7D%0A%09%2F%2F+Whisper+must+be+explicitly+enabled+by+specifying+at+least+1+whisper+flag+or+in+dev+mode%0A%09shhEnabled+%3A%3D+enableWhisper%28ctx%29%0A%09shhAutoEnabled+%3A%3D+%21ctx.GlobalIsSet%28utils.WhisperEnabledFlag.Name%29+%26amp%3B%26amp%3B+ctx.GlobalIsSet%28utils.DeveloperFlag.Name%29%0A%09if+shhEnabled+%7C%7C+shhAutoEnabled+%7B%0A%09%09if+ctx.GlobalIsSet%28utils.WhisperMaxMessageSizeFlag.Name%29+%7B%0A%09%09%09cfg.Shh.MaxMessageSize+%3D+uint32%28ctx.Int%28utils.WhisperMaxMessageSizeFlag.Name%29%29%0A%09%09%7D%0A%09%09if+ctx.GlobalIsSet%28utils.WhisperMinPOWFlag.Name%29+%7B%0A%09%09%09cfg.Shh.MinimumAcceptedPOW+%3D+ctx.Float64%28utils.WhisperMinPOWFlag.Name%29%0A%09%09%7D%0A%09%09utils.RegisterShhService%28stack%2C+%26amp%3Bcfg.Shh%29%0A%09%7D%0A%0A%09%2F%2F+Add+the+Ethereum+Stats+daemon+if+requested.%0A%09if+cfg.Ethstats.URL+%21%3D+%22%22+%7B%0A%09%09utils.RegisterEthStatsService%28stack%2C+cfg.Ethstats.URL%29%0A%09%7D%0A%09return+stack%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%A0%B9%E6%8D%AE%E4%B9%8B%E5%89%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E9%85%8D%E7%BD%AE%28%3Cstrong%3E%E5%88%9B%E5%BB%BAapp%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%97%B6%E5%80%99%3C%2Fstrong%3E%29%EF%BC%8C%E5%85%88%E8%B0%83%E7%94%A8%26nbsp%3B%3Cstrong%3Estack%2C+cfg+%3A%3D+makeConfigNode%28ctx%29+%3C%2Fstrong%3E%E6%9E%84%E9%80%A0%E5%87%BA%E4%B8%80%E4%B8%AA%3Cstrong%3Enode%3C%2Fstrong%3E%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%8F%8A%E7%9B%B8%E5%85%B3%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF+%3Cstrong%3Ecfg%3C%2Fstrong%3E%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E7%84%B6%E5%90%8E%EF%BC%8C%E7%B4%A7%E6%8E%A5%E7%9D%80%E5%88%86%E5%88%AB%E6%B3%A8%E5%86%8C%E4%BA%86+%3Cstrong%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3EEth%E6%9C%8D%E5%8A%A1%3C%2Fspan%3E%E3%80%81%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3Edashboard%E6%9C%8D%E5%8A%A1%3C%2Fspan%3E%E3%80%81%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3Eshh%E6%9C%8D%E5%8A%A1%3C%2Fspan%3E%E5%8F%8A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3EEthStats%E6%9C%8D%E5%8A%A1%3C%2Fspan%3E%3C%2Fstrong%3E%E3%80%82%E5%85%B6%E4%B8%AD%E6%B3%A8%E5%86%8C%E7%9A%84%E5%8A%A8%E4%BD%9C%EF%BC%8C%E9%83%BD%E6%98%AF%E8%B0%83%E7%94%A8%E4%BA%86+%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Eutils.RegisterEthService%28...%29%3C%2Fstrong%3E%3C%2Fspan%3E+%E6%96%B9%E6%B3%95%E5%81%9A%E7%9A%84%EF%BC%8C%E6%88%91%E4%BB%AC%E8%B7%9F%E8%BF%9B%E5%8E%BB%E7%9C%8B%E9%87%8C%E9%9D%A2%E5%88%B0%E5%BA%95%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%E4%BA%8B%E6%83%85%E3%80%82%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+%E6%B3%A8%E5%86%8CEth%E6%9C%8D%E5%8A%A1%0Afunc+RegisterEthService%28stack+*node.Node%2C+cfg+*eth.Config%29+%7B%0A%09var+err+error%0A%09if+cfg.SyncMode+%3D%3D+downloader.LightSync+%7B%0A%09%09err+%3D+stack.Register%28func%28ctx+*node.ServiceContext%29+%28node.Service%2C+error%29+%7B%0A%09%09%09return+les.New%28ctx%2C+cfg%29%0A%09%09%7D%29%0A%09%7D+else+%7B%0A%09%09err+%3D+stack.Register%28func%28ctx+*node.ServiceContext%29+%28node.Service%2C+error%29+%7B%0A%09%09%09fullNode%2C+err+%3A%3D+eth.New%28ctx%2C+cfg%29%0A%09%09%09if+fullNode+%21%3D+nil+%26amp%3B%26amp%3B+cfg.LightServ+%26gt%3B+0+%7B%0A%09%09%09%09ls%2C+_+%3A%3D+les.NewLesServer%28fullNode%2C+cfg%29%0A%09%09%09%09fullNode.AddLesServer%28ls%29%0A%09%09%09%7D%0A%09%09%09return+fullNode%2C+err%0A%09%09%7D%29%0A%09%7D%0A%09if+err+%21%3D+nil+%7B%0A%09%09Fatalf%28%22Failed+to+register+the+Ethereum+service%3A+%25v%22%2C+err%29%0A%09%7D%0A%7D%0A%0A%2F%2F+%E6%B3%A8%E5%86%8Cdashboard%E6%9C%8D%E5%8A%A1%0Afunc+RegisterDashboardService%28stack+*node.Node%2C+cfg+*dashboard.Config%2C+commit+string%29+%7B%0A%09stack.Register%28func%28ctx+*node.ServiceContext%29+%28node.Service%2C+error%29+%7B%0A%09%09return+dashboard.New%28cfg%2C+commit%2C+ctx.ResolvePath%28%22logs%22%29%29%2C+nil%0A%09%7D%29%0A%7D%0A%0A%0A%2F%2F+%E6%B3%A8%E5%86%8Cshh%E6%9C%8D%E5%8A%A1%0Afunc+RegisterShhService%28stack+*node.Node%2C+cfg+*whisper.Config%29+%7B%0A%09if+err+%3A%3D+stack.Register%28func%28n+*node.ServiceContext%29+%28node.Service%2C+error%29+%7B%0A%09%09return+whisper.New%28cfg%29%2C+nil%0A%09%7D%29%3B+err+%21%3D+nil+%7B%0A%09%09Fatalf%28%22Failed+to+register+the+Whisper+service%3A+%25v%22%2C+err%29%0A%09%7D%0A%7D%0A%0A%0A%2F%2F+%E6%B3%A8%E5%86%8CEthStats%E6%9C%8D%E5%8A%A1%0Afunc+RegisterEthStatsService%28stack+*node.Node%2C+url+string%29+%7B%0A%09if+err+%3A%3D+stack.Register%28func%28ctx+*node.ServiceContext%29+%28node.Service%2C+error%29+%7B%0A%09%09%2F%2F+Retrieve+both+eth+and+les+services%0A%09%09var+ethServ+*eth.Ethereum%0A%09%09ctx.Service%28%26amp%3BethServ%29%0A%0A%09%09var+lesServ+*les.LightEthereum%0A%09%09ctx.Service%28%26amp%3BlesServ%29%0A%0A%09%09return+ethstats.New%28url%2C+ethServ%2C+lesServ%29%0A%09%7D%29%3B+err+%21%3D+nil+%7B%0A%09%09Fatalf%28%22Failed+to+register+the+Ethereum+Stats+service%3A+%25v%22%2C+err%29%0A%09%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%AF%8F%E4%B8%80%E7%A7%8D%E6%B3%A8%E5%86%8C%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%85%B6%E5%AE%9E%E9%83%BD%E6%98%AF%E8%B0%83%E7%94%A8%E4%BA%86%26nbsp%3B%26nbsp%3B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Estack.Register%28func%28ctx+*node.ServiceContext%29+%28node.Service%2C+error%29+%7B%7D%29%3C%2Fstrong%3E%3C%2Fspan%3E+%E5%87%BD%E6%95%B0%EF%BC%8C%E5%86%8D%E8%B7%9F%E8%BF%9B%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9C%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28n+*Node%29+Register%28constructor+ServiceConstructor%29+error+%7B%0A%09n.lock.Lock%28%29%0A%09defer+n.lock.Unlock%28%29%0A%0A%09if+n.server+%21%3D+nil+%7B%0A%09%09return+ErrNodeRunning%0A%09%7D%0A%09n.serviceFuncs+%3D+append%28n.serviceFuncs%2C+constructor%29%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%BE%88%E7%AE%80%E5%8D%95%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%8A%8A%E5%85%A5%E5%8F%82%E7%9A%84+%E5%90%84%E7%B1%BBService%E7%9A%84%E5%88%9B%E5%BB%BA%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%85%A5%E5%8F%82%EF%BC%8C%E5%B9%B6%E9%83%BD%E6%94%B6%E9%9B%86%E5%88%B0node%E5%AE%9E%E4%BE%8B%E7%9A%84+serviceFuncs+%E5%88%87%E7%89%87%E4%B8%AD%E3%80%82%E9%82%A3%E4%B9%88%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E6%88%91%E4%BB%AC%E7%8E%B0%E5%9C%A8%E5%B0%B1%E5%B7%B2%E7%BB%8F%E7%90%86%E8%A7%A3%E4%BA%86%E4%BB%80%E4%B9%88%E6%98%AF%E6%83%B3node%E8%8A%82%E7%82%B9%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E4%BA%86%E3%80%82%E6%97%A0%E9%9D%9E%E5%B0%B1%E6%98%AF%E6%8A%8A%E5%90%84%E4%B8%AA%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1%E7%9A%84%E5%87%BD%E6%95%B0%E5%85%A8%E9%83%A8%E9%83%BD%E6%94%B6%E9%9B%86%E5%88%B0node%E5%AE%9E%E4%BE%8B%E7%9A%84serviceFuncs%E5%88%87%E7%89%87%E4%B8%AD%E5%8E%BB%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%82%EF%BC%88%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%3Cstrong%3E%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E5%9D%97%E9%80%BB%E8%BE%91%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%90%8E%E7%BB%AD%E6%88%91%E4%BB%AC%E4%BC%9A%E7%94%A8%E5%88%B0%3C%2Fstrong%3E%3C%2Fspan%3E%EF%BC%89%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%9B%A0%E4%B8%BA%E6%98%AF%E6%B6%89%E5%8F%8A%E8%AE%B2P2P%E9%83%A8%E5%88%86%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E6%89%80%E4%BB%A5%E6%88%91%E4%BB%AC%E8%BF%99%E9%87%8C%E5%8F%AA%E6%B3%A8%E9%87%8D%E5%B0%86%3Cstrong%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3EEth%E6%9C%8D%E5%8A%A1%E9%83%A8%E5%88%86%3C%2Fspan%3E%3C%2Fstrong%3E%E3%80%82%E6%88%91%E4%BB%AC%E7%9C%8B%E7%9C%8B%E5%9C%A8%E6%B3%A8%E5%86%8CEth%E6%9C%8D%E5%8A%A1%E6%98%AF%E5%85%A5%E5%8F%82%E7%9A%84%E6%89%80%E8%B0%93EthService%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%98%AF%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84+%28%E5%8D%B3%EF%BC%9A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Eeth.New%28ctx%2C+cfg%29%3C%2Fstrong%3E%3C%2Fspan%3E+%E7%9A%84%E5%AE%9E%E7%8E%B0%29%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+New%28ctx+*node.ServiceContext%2C+config+*Config%29+%28*Ethereum%2C+error%29+%7B%0A%09if+config.SyncMode+%3D%3D+downloader.LightSync+%7B%0A%09%09return+nil%2C+errors.New%28%22can%27t+run+eth.Ethereum+in+light+sync+mode%2C+use+les.LightEthereum%22%29%0A%09%7D%0A%09if+%21config.SyncMode.IsValid%28%29+%7B%0A%09%09return+nil%2C+fmt.Errorf%28%22invalid+sync+mode+%25d%22%2C+config.SyncMode%29%0A%09%7D%0A%09chainDb%2C+err+%3A%3D+CreateDB%28ctx%2C+config%2C+%22chaindata%22%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%09%7D%0A%09chainConfig%2C+genesisHash%2C+genesisErr+%3A%3D+core.SetupGenesisBlock%28chainDb%2C+config.Genesis%29%0A%09if+_%2C+ok+%3A%3D+genesisErr.%28*params.ConfigCompatError%29%3B+genesisErr+%21%3D+nil+%26amp%3B%26amp%3B+%21ok+%7B%0A%09%09return+nil%2C+genesisErr%0A%09%7D%0A%09log.Info%28%22Initialised+chain+configuration%22%2C+%22config%22%2C+chainConfig%29%0A%0A%09eth+%3A%3D+%26amp%3BEthereum%7B%0A%09%09config%3A+++++++++config%2C%0A%09%09chainDb%3A++++++++chainDb%2C%0A%09%09chainConfig%3A++++chainConfig%2C%0A%09%09eventMux%3A+++++++ctx.EventMux%2C%0A%09%09accountManager%3A+ctx.AccountManager%2C%0A%09%09engine%3A+++++++++CreateConsensusEngine%28ctx%2C+%26amp%3Bconfig.Ethash%2C+chainConfig%2C+chainDb%29%2C%0A%09%09shutdownChan%3A+++make%28chan+bool%29%2C%0A%09%09networkID%3A++++++config.NetworkId%2C%0A%09%09gasPrice%3A+++++++config.GasPrice%2C%0A%09%09etherbase%3A++++++config.Etherbase%2C%0A%09%09bloomRequests%3A++make%28chan+chan+*bloombits.Retrieval%29%2C%0A%09%09bloomIndexer%3A+++NewBloomIndexer%28chainDb%2C+params.BloomBitsBlocks%29%2C%0A%09%7D%0A%0A%09log.Info%28%22Initialising+Ethereum+protocol%22%2C+%22versions%22%2C+ProtocolVersions%2C+%22network%22%2C+config.NetworkId%29%0A%0A%09if+%21config.SkipBcVersionCheck+%7B%0A%09%09bcVersion+%3A%3D+rawdb.ReadDatabaseVersion%28chainDb%29%0A%09%09if+bcVersion+%21%3D+core.BlockChainVersion+%26amp%3B%26amp%3B+bcVersion+%21%3D+0+%7B%0A%09%09%09return+nil%2C+fmt.Errorf%28%22Blockchain+DB+version+mismatch+%28%25d+%2F+%25d%29.+Run+geth+upgradedb.%5Cn%22%2C+bcVersion%2C+core.BlockChainVersion%29%0A%09%09%7D%0A%09%09rawdb.WriteDatabaseVersion%28chainDb%2C+core.BlockChainVersion%29%0A%09%7D%0A%09var+%28%0A%09%09vmConfig++++%3D+vm.Config%7BEnablePreimageRecording%3A+config.EnablePreimageRecording%7D%0A%09%09cacheConfig+%3D+%26amp%3Bcore.CacheConfig%7BDisabled%3A+config.NoPruning%2C+TrieNodeLimit%3A+config.TrieCache%2C+TrieTimeLimit%3A+config.TrieTimeout%7D%0A%09%29%0A%09eth.blockchain%2C+err+%3D+core.NewBlockChain%28chainDb%2C+cacheConfig%2C+eth.chainConfig%2C+eth.engine%2C+vmConfig%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%09%7D%0A%09%2F%2F+Rewind+the+chain+in+case+of+an+incompatible+config+upgrade.%0A%09if+compat%2C+ok+%3A%3D+genesisErr.%28*params.ConfigCompatError%29%3B+ok+%7B%0A%09%09log.Warn%28%22Rewinding+chain+to+upgrade+configuration%22%2C+%22err%22%2C+compat%29%0A%09%09eth.blockchain.SetHead%28compat.RewindTo%29%0A%09%09rawdb.WriteChainConfig%28chainDb%2C+genesisHash%2C+chainConfig%29%0A%09%7D%0A%09eth.bloomIndexer.Start%28eth.blockchain%29%0A%0A%09if+config.TxPool.Journal+%21%3D+%22%22+%7B%0A%09%09config.TxPool.Journal+%3D+ctx.ResolvePath%28config.TxPool.Journal%29%0A%09%7D%0A%09eth.txPool+%3D+core.NewTxPool%28config.TxPool%2C+eth.chainConfig%2C+eth.blockchain%29%0A%0A%09if+eth.protocolManager%2C+err+%3D+NewProtocolManager%28eth.chainConfig%2C+config.SyncMode%2C+config.NetworkId%2C+eth.eventMux%2C+eth.txPool%2C+eth.engine%2C+eth.blockchain%2C+chainDb%29%3B+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%09%7D%0A%09eth.miner+%3D+miner.New%28eth%2C+eth.chainConfig%2C+eth.EventMux%28%29%2C+eth.engine%29%0A%09eth.miner.SetExtra%28makeExtraData%28config.ExtraData%29%29%0A%0A%09eth.APIBackend+%3D+%26amp%3BEthAPIBackend%7Beth%2C+nil%7D%0A%09gpoParams+%3A%3D+config.GPO%0A%09if+gpoParams.Default+%3D%3D+nil+%7B%0A%09%09gpoParams.Default+%3D+config.GasPrice%0A%09%7D%0A%09eth.APIBackend.gpo+%3D+gasprice.NewOracle%28eth.APIBackend%2C+gpoParams%29%0A%0A%09return+eth%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%BE%97%E5%87%BA%E6%9D%A5%EF%BC%8C%E4%BB%A3%E7%A0%81%E8%BF%98%E6%98%AF%E4%B8%8D%E5%B0%91%E7%9A%84%EF%BC%8C%E9%82%A3%E4%B9%88%E8%AF%A5%E5%87%BD%E6%95%B0%E4%B8%80%E8%BF%9B%E6%9D%A5%E5%B0%B1%E5%81%9A%E4%BA%86%E8%BF%99%E4%B9%88%E5%87%A0%E4%BB%B6%E4%BA%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Col%3E%0A+++%3Cli%3E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9C%E9%93%BE%E7%9A%84DB%E5%AE%9E%E4%BE%8B%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3EchainDb%2C+err+%3A%3D+CreateDB%28ctx%2C+config%2C+%22chaindata%22%29%3C%2Fcode%3E%3C%2Fpre%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E6%A0%B9%E6%8D%AEDB%E5%AE%9E%E4%BE%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%9B%E4%B8%96%E5%9D%97%E5%8F%8A%E7%9B%B8%E5%85%B3%E9%93%BE%E7%9A%84%E5%88%9D%E8%AF%86%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3EchainConfig%2C+genesisHash%2C+genesisErr+%3A%3D+core.SetupGenesisBlock%28chainDb%2C+config.Genesis%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%80%E9%A1%B6%E5%B1%82%E7%9A%84%E7%BB%93%E6%9E%84Ethereum%E7%BB%93%E6%9E%84%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eeth+%3A%3D+%26amp%3BEthereum%7B%0A%09%09config%3A+++++++++config%2C%0A%09%09chainDb%3A++++++++chainDb%2C%0A%09%09chainConfig%3A++++chainConfig%2C%0A%09%09eventMux%3A+++++++ctx.EventMux%2C%0A%09%09accountManager%3A+ctx.AccountManager%2C%0A%09%09engine%3A+++++++++CreateConsensusEngine%28ctx%2C+%26amp%3Bconfig.Ethash%2C+chainConfig%2C+chainDb%29%2C%0A%09%09shutdownChan%3A+++make%28chan+bool%29%2C%0A%09%09networkID%3A++++++config.NetworkId%2C%0A%09%09gasPrice%3A+++++++config.GasPrice%2C%0A%09%09etherbase%3A++++++config.Etherbase%2C%0A%09%09bloomRequests%3A++make%28chan+chan+*bloombits.Retrieval%29%2C%0A%09%09bloomIndexer%3A+++NewBloomIndexer%28chainDb%2C+params.BloomBitsBlocks%29%2C%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%EF%BC%88%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%3C%2Fstrong%3E%3C%2Fspan%3E%E5%8F%8A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E6%9C%8D%E5%8A%A1%3C%2Fstrong%3E%3C%2Fspan%3E%E4%B9%9F%E5%90%8C%E6%97%B6%E8%A2%AB%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%9C%A8Ethereum%E5%AF%B9%E8%B1%A1%E4%B8%AD%EF%BC%89%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E6%A3%80%E6%9F%A5DB%E7%9A%84%E7%89%88%E6%9C%AC%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+%21config.SkipBcVersionCheck+%7B%0A%09%09bcVersion+%3A%3D+rawdb.ReadDatabaseVersion%28chainDb%29%0A%09%09if+bcVersion+%21%3D+core.BlockChainVersion+%26amp%3B%26amp%3B+bcVersion+%21%3D+0+%7B%0A%09%09%09return+nil%2C+fmt.Errorf%28%22Blockchain+DB+version+mismatch+%28%25d+%2F+%25d%29.+Run+geth+upgradedb.%5Cn%22%2C+bcVersion%2C+core.BlockChainVersion%29%0A%09%09%7D%0A%09%09rawdb.WriteDatabaseVersion%28chainDb%2C+core.BlockChainVersion%29%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%8A%A0%E8%BD%BD%E6%95%B4%E6%9D%A1%E5%AE%8C%E6%95%B4%E9%93%BE%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eeth.blockchain%2C+err+%3D+core.NewBlockChain%28chainDb%2C+cacheConfig%2C+eth.chainConfig%2C+eth.engine%2C+vmConfig%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%28%E8%BF%99%E9%87%8C%E5%90%8E%E7%BB%AD%E6%96%87%E7%AB%A0%E4%B8%AD%E5%86%8D%E5%81%9A%E7%BB%86%E8%AE%B2%29%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%90%AF%E5%8A%A8%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E6%9C%8D%E5%8A%A1%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eeth.bloomIndexer.Start%28eth.blockchain%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%A4%E6%98%93%E6%B1%A0%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eeth.txPool+%3D+core.NewTxPool%28config.TxPool%2C+eth.chainConfig%2C+eth.blockchain%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%88%9D%E5%A7%8B%E5%8C%96P2P%E5%8D%8F%E8%AE%AE%E7%AE%A1%E7%90%86+pm+%E5%AE%9E%E4%BE%8B%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+eth.protocolManager%2C+err+%3D+NewProtocolManager%28eth.chainConfig%2C+config.SyncMode%2C+config.NetworkId%2C+eth.eventMux%2C+eth.txPool%2C+eth.engine%2C+eth.blockchain%2C+chainDb%29%3B+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%3Ch3%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91%EF%BC%9A%E8%BF%99%E4%B8%AA%E6%98%AF%E8%B6%85%E7%BA%A7%E8%B6%85%E7%BA%A7%E9%87%8D%E7%82%B9%E7%9A%84%EF%BC%8C%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E9%87%8C%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%8B%E9%9D%A2%E8%AE%B2%3C%2Fstrong%3E%3C%2Fspan%3E%3C%2Fh3%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E7%9F%BF%E5%B7%A5%E5%AE%9E%E4%BE%8B%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eeth.miner+%3D+miner.New%28eth%2C+eth.chainConfig%2C+eth.EventMux%28%29%2C+eth.engine%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%88%9D%E5%A7%8B%E5%8C%96Gas%E9%A2%84%E8%A8%80%E6%9C%BA%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eeth.APIBackend.gpo+%3D+gasprice.NewOracle%28eth.APIBackend%2C+gpoParams%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A++%3C%2Fol%3E%0A++%3Cp%3E%E4%BB%A5%E4%B8%8A%E5%B0%B1%E6%98%AF%E5%9C%A8EthService%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E4%B8%AD%E5%8E%BB%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%80%E4%B8%AAEthService%E5%AE%9E%E7%8E%B0%E6%89%80%E5%81%9A%E7%9A%84%E4%BA%8B%E6%83%85%E3%80%82%E7%94%B1%E4%BA%8E%E6%9C%AC%E6%96%87%E6%B3%A8%E9%87%8D%E8%AE%B2P2P%E9%83%A8%E5%88%86%EF%BC%8C%E6%89%80%E4%BB%A5%E5%9C%A8%E4%B8%8A%E9%9D%A2%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E7%AC%AC8%E7%82%B9%3C%2Fstrong%3E%3C%2Fspan%3E%E4%B8%AD%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%3Cstrong%3E%E5%8D%8F%E8%AE%AE%E7%AE%A1%E7%90%86pm%E5%AE%9E%E4%BE%8B%3C%2Fstrong%3E%E6%98%AF%E4%B8%80%E9%83%A8%E8%B6%85%E7%BA%A7%E9%87%8D%E8%A6%81%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E8%B7%9F%E8%BF%9B%E5%8E%BB%E7%9C%8B%E7%9C%8B%EF%BC%9A%E4%B8%8A%E6%BA%90%E7%A0%81%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+NewProtocolManager%28config+*params.ChainConfig%2C+mode+downloader.SyncMode%2C+networkID+uint64%2C+mux+*event.TypeMux%2C+txpool+txPool%2C+engine+consensus.Engine%2C+blockchain+*core.BlockChain%2C+chaindb+ethdb.Database%29+%28*ProtocolManager%2C+error%29+%7B%0A%09%2F%2F+Create+the+protocol+manager+with+the+base+fields%0A%09manager+%3A%3D+%26amp%3BProtocolManager%7B%0A%09%09networkID%3A+++networkID%2C%0A%09%09eventMux%3A++++mux%2C%0A%09%09txpool%3A++++++txpool%2C%0A%09%09blockchain%3A++blockchain%2C%0A%09%09chainconfig%3A+config%2C%0A%09%09peers%3A+++++++newPeerSet%28%29%2C%0A%09%09newPeerCh%3A+++make%28chan+*peer%29%2C%0A%09%09noMorePeers%3A+make%28chan+struct%7B%7D%29%2C%0A%09%09txsyncCh%3A++++make%28chan+*txsync%29%2C%0A%09%09quitSync%3A++++make%28chan+struct%7B%7D%29%2C%0A%09%7D%0A%09%2F%2F+Figure+out+whether+to+allow+fast+sync+or+not%0A%09if+mode+%3D%3D+downloader.FastSync+%26amp%3B%26amp%3B+blockchain.CurrentBlock%28%29.NumberU64%28%29+%26gt%3B+0+%7B%0A%09%09log.Warn%28%22Blockchain+not+empty%2C+fast+sync+disabled%22%29%0A%09%09mode+%3D+downloader.FullSync%0A%09%7D%0A%09if+mode+%3D%3D+downloader.FastSync+%7B%0A%09%09manager.fastSync+%3D+uint32%281%29%0A%09%7D%0A%09%2F%2F+Initiate+a+sub-protocol+for+every+implemented+version+we+can+handle%0A%09manager.SubProtocols+%3D+make%28%5B%5Dp2p.Protocol%2C+0%2C+len%28ProtocolVersions%29%29%0A%09for+i%2C+version+%3A%3D+range+ProtocolVersions+%7B%0A%09%09%2F%2F+Skip+protocol+version+if+incompatible+with+the+mode+of+operation%0A%09%09if+mode+%3D%3D+downloader.FastSync+%26amp%3B%26amp%3B+version+%26lt%3B+eth63+%7B%0A%09%09%09continue%0A%09%09%7D%0A%09%09%2F%2F+Compatible%3B+initialise+the+sub-protocol%0A%09%09version+%3A%3D+version+%2F%2F+Closure+for+the+run%0A%09%09manager.SubProtocols+%3D+append%28manager.SubProtocols%2C+p2p.Protocol%7B%0A%09%09%09Name%3A++++ProtocolName%2C%0A%09%09%09Version%3A+version%2C%0A%09%09%09Length%3A++ProtocolLengths%5Bi%5D%2C%0A%09%09%09Run%3A+func%28p+*p2p.Peer%2C+rw+p2p.MsgReadWriter%29+error+%7B%0A%09%09%09%09peer+%3A%3D+manager.newPeer%28int%28version%29%2C+p%2C+rw%29%0A%09%09%09%09select+%7B%0A%09%09%09%09case+manager.newPeerCh+%26lt%3B-+peer%3A%0A%09%09%09%09%09manager.wg.Add%281%29%0A%09%09%09%09%09defer+manager.wg.Done%28%29%0A%09%09%09%09%09return+manager.handle%28peer%29%0A%09%09%09%09case+%26lt%3B-manager.quitSync%3A%0A%09%09%09%09%09return+p2p.DiscQuitting%0A%09%09%09%09%7D%0A%09%09%09%7D%2C%0A%09%09%09NodeInfo%3A+func%28%29+interface%7B%7D+%7B%0A%09%09%09%09return+manager.NodeInfo%28%29%0A%09%09%09%7D%2C%0A%09%09%09PeerInfo%3A+func%28id+discover.NodeID%29+interface%7B%7D+%7B%0A%09%09%09%09if+p+%3A%3D+manager.peers.Peer%28fmt.Sprintf%28%22%25x%22%2C+id%5B%3A8%5D%29%29%3B+p+%21%3D+nil+%7B%0A%09%09%09%09%09return+p.Info%28%29%0A%09%09%09%09%7D%0A%09%09%09%09return+nil%0A%09%09%09%7D%2C%0A%09%09%7D%29%0A%09%7D%0A%09if+len%28manager.SubProtocols%29+%3D%3D+0+%7B%0A%09%09return+nil%2C+errIncompatibleConfig%0A%09%7D%0A%09%2F%2F+Construct+the+different+synchronisation+mechanisms%0A%09manager.downloader+%3D+downloader.New%28mode%2C+chaindb%2C+manager.eventMux%2C+blockchain%2C+nil%2C+manager.removePeer%29%0A%0A%09validator+%3A%3D+func%28header+*types.Header%29+error+%7B%0A%09%09return+engine.VerifyHeader%28blockchain%2C+header%2C+true%29%0A%09%7D%0A%09heighter+%3A%3D+func%28%29+uint64+%7B%0A%09%09return+blockchain.CurrentBlock%28%29.NumberU64%28%29%0A%09%7D%0A%09inserter+%3A%3D+func%28blocks+types.Blocks%29+%28int%2C+error%29+%7B%0A%09%09%2F%2F+If+fast+sync+is+running%2C+deny+importing+weird+blocks%0A%09%09if+atomic.LoadUint32%28%26amp%3Bmanager.fastSync%29+%3D%3D+1+%7B%0A%09%09%09log.Warn%28%22Discarded+bad+propagated+block%22%2C+%22number%22%2C+blocks%5B0%5D.Number%28%29%2C+%22hash%22%2C+blocks%5B0%5D.Hash%28%29%29%0A%09%09%09return+0%2C+nil%0A%09%09%7D%0A%09%09atomic.StoreUint32%28%26amp%3Bmanager.acceptTxs%2C+1%29+%2F%2F+Mark+initial+sync+done+on+any+fetcher+import%0A%09%09return+manager.blockchain.InsertChain%28blocks%29%0A%09%7D%0A%09manager.fetcher+%3D+fetcher.New%28blockchain.GetBlockByHash%2C+validator%2C+manager.BroadcastBlock%2C+heighter%2C+inserter%2C+manager.removePeer%29%0A%0A%09return+manager%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%BB%A5%E4%B8%8A%E5%87%BD%E6%95%B0%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96pm%E5%AE%9E%E4%BE%8B%E6%97%B6%EF%BC%8C%E4%B8%BB%E8%A6%81%E5%81%9A%E4%BA%86%E4%BB%A5%E4%B8%8B%E6%93%8D%E4%BD%9C%EF%BC%9A%3C%2Fp%3E+%0A++%3Col%3E%0A+++%3Cli%3E%E5%88%9D%E5%A7%8B%E5%8C%96ProtocolManager%E5%AE%9E%E4%BE%8B%EF%BC%9A+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Create+the+protocol+manager+with+the+base+fields%0A%09manager+%3A%3D+%26amp%3BProtocolManager%7B%0A%09%09networkID%3A+++networkID%2C%0A%09%09eventMux%3A++++mux%2C%0A%09%09txpool%3A++++++txpool%2C%0A%09%09blockchain%3A++blockchain%2C%0A%09%09chainconfig%3A+config%2C%0A%09%09peers%3A+++++++newPeerSet%28%29%2C%0A%09%09newPeerCh%3A+++make%28chan+*peer%29%2C%0A%09%09noMorePeers%3A+make%28chan+struct%7B%7D%29%2C%0A%09%09txsyncCh%3A++++make%28chan+*txsync%29%2C%0A%09%09quitSync%3A++++make%28chan+struct%7B%7D%29%2C%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%EF%BC%88%E7%B1%BB%E4%BC%BCEthereum%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%9C%A8%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%87%AA%E8%BA%AB%E7%9A%84%E5%90%8C%E6%97%B6%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%BA%9B%E9%87%8D%E8%A6%81%E7%9A%84%E6%88%90%E5%91%98%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%9C%80%E4%B8%BB%E8%A6%81%E7%9A%84%E4%B8%BA%EF%BC%9A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3EnewPeerSet%28%29+%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E8%BF%9C%E7%AB%AFpeer%E5%AE%9E%E4%BE%8B%E7%9A%84Set%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%81%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%3Cstrong%3EnewPeerCh+%E7%9B%91%E5%90%AC%E6%96%B0%E8%8A%82%E7%82%B9%E7%9A%84%E9%80%9A%E9%81%93%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%81%3Cspan+style%3D%22color%3A%237c79e5%3B%22%3E%3Cstrong%3EtxsyncCh+%E7%9B%91%E5%90%AC%E7%94%B1+%E8%BF%9C%E7%AB%AF%E8%8A%82%E7%82%B9%E5%8F%8A%E6%9C%AC%E5%9C%B0%E4%BA%A4%E6%98%93%E6%B1%A0%E4%B8%AD%E4%BA%A4%E6%98%93%E6%95%B0%E7%BB%84%E7%BB%84%E6%88%90%E7%9A%84+%E4%BF%A1%E6%81%AF%E7%9A%84%E9%80%9A%E9%81%93%3C%2Fstrong%3E%3C%2Fspan%3E%EF%BC%89%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E4%BD%BF%E7%94%A8for%E5%BE%AA%E7%8E%AF%E5%8E%BB%E6%94%B6%E9%9B%86%E5%88%9B%E5%BB%BA%E5%A5%BD%E7%9A%84+Protocol+%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%9C%A8Protocol%E5%88%9B%E5%BB%BA%E6%97%B6%EF%BC%8C%E4%BC%9A%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84%E5%87%A0%E4%B8%AA%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B%E6%88%90%E5%91%98%E8%B5%8B%E5%80%BC%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E6%98%AFRun%E5%87%BD%E6%95%B0%E7%9A%84%E8%B5%8B%E5%80%BC%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8B%E4%BB%A3%E7%A0%81%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BA%EF%BC%8C%E9%87%8C%E9%9D%A2%E5%81%9A%E4%BA%86%E4%B8%A4%E4%BB%B6%E4%BA%8B%E6%83%85%EF%BC%8Ca%EF%BC%9A%E6%8A%8A%E6%96%B0%E5%8A%A0%E5%85%A5%E7%9A%84%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF%E5%B0%81%E8%A3%85%E6%88%90%E4%B8%80%E4%B8%AApeer%EF%BC%8C%E5%BE%80%E9%80%9A%E9%81%93%26nbsp%3BnewPeerCh+%E4%B8%AD%E5%8F%91%E9%80%81%EF%BC%8C%E4%B8%94%E4%BC%9A%E5%9B%9E%E8%B0%83pm%E5%AE%9E%E4%BE%8B%E7%9A%84Handle+%E5%87%BD%E6%95%B0%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%90%E6%B3%A8%E6%84%8F%EF%BC%9A%E8%BF%99%E4%B8%AARun%E5%87%BD%E6%95%B0%E8%B6%85%E7%BA%A7%E9%87%8D%E8%A6%81%E3%80%91%EF%BC%9B%3C%2Fli%3E+%0A+++%3Cli%3E%E5%AE%9E%E4%BE%8B%E5%8C%96downloader+%EF%BC%9A%EF%BC%88%3Cstrong%3E%E5%90%8E%E9%9D%A2%E8%AE%B2downloader%E6%97%B6%E5%86%8D%E8%AE%B2%3C%2Fstrong%3E%EF%BC%89+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Construct+the+different+synchronisation+mechanisms%0A%09manager.downloader+%3D+downloader.New%28mode%2C+chaindb%2C+manager.eventMux%2C+blockchain%2C+nil%2C+manager.removePeer%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A+++%3Cli%3E%E5%AE%9E%E4%BE%8B%E5%8C%96%26nbsp%3Bfetcher+%EF%BC%9A%EF%BC%88%3Cstrong%3E%E5%90%8E%E9%9D%A2%E8%AE%B2fetcher%E6%97%B6%E5%86%8D%E8%AE%B2%3C%2Fstrong%3E%EF%BC%89+%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Emanager.fetcher+%3D+fetcher.New%28blockchain.GetBlockByHash%2C+validator%2C+manager.BroadcastBlock%2C+heighter%2C+inserter%2C+manager.removePeer%29%3C%2Fcode%3E%3C%2Fpre%3E+%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%3C%2Fli%3E+%0A++%3C%2Fol%3E%0A++%3Cp%3E%E7%84%B6%E5%90%8E%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E6%88%91%E4%BB%AC%E5%9C%A8%E4%B8%8A%E9%9D%A2%E7%9F%A5%E9%81%93%E4%BA%86%E5%9C%A8pm%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%98%AF%E4%BC%9A%E5%8E%BB%E5%AE%9E%E4%BE%8B%E5%8C%96protocol%E5%AE%9E%E4%BE%8B%E5%B9%B6%E6%94%B6%E9%9B%86%E8%B5%B7%E6%9D%A5%EF%BC%8C%E8%80%8Cprotocol%E5%AE%9E%E5%8A%9B%E5%9C%A8%E5%88%9B%E5%BB%BA%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%9C%A8%E8%87%AA%E5%B7%B1%E7%9A%84Run%E5%87%BD%E6%95%B0%E4%B8%AD%E5%9B%9E%E8%B0%83pm%E7%9A%84Handle+%E5%87%BD%E6%95%B0%3C%2Fstrong%3E%3C%2Fspan%3E%EF%BC%8C%E9%82%A3%E4%B9%88%E5%85%B6%E5%AE%9E%EF%BC%8C%E5%BE%88%E5%A4%9A+tx%E5%8F%8ABlock%E3%80%81BlockHash%E7%9A%84%E5%B9%BF%E6%92%AD%EF%BC%8C%E5%90%8C%E6%AD%A5%E7%AD%89%E6%93%8D%E4%BD%9C%E9%83%BD%E4%BC%9A%E5%9C%A8+pm%E7%9A%84Handle%E5%87%BD%E6%95%B0%E4%B8%AD%E5%AE%8C%E6%88%90%EF%BC%8C%E4%B9%8B%E6%89%80%E4%BB%A5%E6%98%AF%E7%94%A8%E4%BA%86%E5%9B%9E%E8%B0%83%EF%BC%8C%E6%98%AF%E5%9B%A0%E4%B8%BA%E9%9C%80%E8%A6%81%EF%BC%9A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E6%AF%8F%E5%BD%93%E6%9C%89%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E8%BF%9C%E7%AB%AF%E8%8A%82%E7%82%B9%E4%B8%8E%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E5%8F%91%E7%94%9FTCP%E8%BF%9E%E6%8E%A5%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%AA%E8%A6%81%E5%90%8E%E7%BB%AD%E6%8A%8Aprotocol%E7%BB%99Run%E8%B5%B7%E6%9D%A5%E7%9A%84%E8%AF%9D%EF%BC%8C%E5%B0%B1%E4%BC%9A%E8%A7%A6%E5%8F%91pm.Handle%28%29+%E7%9A%84%E5%9B%9E%E8%B0%83%E5%8E%BB%E5%81%9A%E5%90%84%E7%A7%8D%E5%90%84%E6%A0%B7%E7%9A%84%E4%BA%8B%E6%83%85%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%82%E4%B8%8B%E9%9D%A2%EF%BC%8C%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E7%9C%8Bpm%E7%9A%84Handle%E5%87%BD%E6%95%B0%E5%8F%88%E6%98%AF%E5%81%9A%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88%E4%BA%8B%E6%83%85%E5%91%A2%EF%BC%9F%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E4%B8%80%E8%BF%9B%E6%9D%A5%E5%85%88%E5%81%9A%E4%BA%86%E4%B8%80%E6%AD%A5%E6%9C%AC%E5%9C%B0node%E6%A0%B9%E6%8D%AE%E7%BC%93%E5%AD%98%E5%9C%A8%E6%9C%AC%E5%9C%B0%E7%9A%84peer%E4%BF%A1%E6%81%AF%E5%8E%BB%E5%92%8C%E8%AF%A5peer%E7%9A%84%E7%9C%9F%E5%AE%9E%E8%BF%9C%E7%AB%AF%E8%8A%82%E7%82%B9%E5%81%9A%E6%8F%A1%E6%89%8B%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28p+*peer%29+Handshake%28network+uint64%2C+td+*big.Int%2C+head+common.Hash%2C+genesis+common.Hash%29+error+%7B%0A%09%2F%2F+Send+out+own+handshake+in+a+new+thread%0A%09errc+%3A%3D+make%28chan+error%2C+2%29%0A%09var+status+statusData+%2F%2F+safe+to+read+after+two+values+have+been+received+from+errc%0A%0A%09go+func%28%29+%7B%0A%09%09errc+%26lt%3B-+p2p.Send%28p.rw%2C+StatusMsg%2C+%26amp%3BstatusData%7B%0A%09%09%09ProtocolVersion%3A+uint32%28p.version%29%2C%0A%09%09%09NetworkId%3A+++++++network%2C%0A%09%09%09TD%3A++++++++++++++td%2C%0A%09%09%09CurrentBlock%3A++++head%2C%0A%09%09%09GenesisBlock%3A++++genesis%2C%0A%09%09%7D%29%0A%09%7D%28%29%0A%09go+func%28%29+%7B%0A%09%09errc+%26lt%3B-+p.readStatus%28network%2C+%26amp%3Bstatus%2C+genesis%29%0A%09%7D%28%29%0A%09timeout+%3A%3D+time.NewTimer%28handshakeTimeout%29%0A%09defer+timeout.Stop%28%29%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+2%3B+i%2B%2B+%7B%0A%09%09select+%7B%0A%09%09case+err+%3A%3D+%26lt%3B-errc%3A%0A%09%09%09if+err+%21%3D+nil+%7B%0A%09%09%09%09return+err%0A%09%09%09%7D%0A%09%09case+%26lt%3B-timeout.C%3A%0A%09%09%09return+p2p.DiscReadTimeout%0A%09%09%7D%0A%09%7D%0A%09p.td%2C+p.head+%3D+status.TD%2C+status.CurrentBlock%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%97%A0%E9%9D%9E%E5%B0%B1%E6%98%AFSend%E4%BA%86%E4%B8%AA%26nbsp%3BStatusMsg+%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B5%B7%E4%B8%80%E4%B8%AA%E7%9B%91%E5%90%AC%26nbsp%3Bp.readStatus%28network%2C+%26amp%3Bstatus%2C+genesis%29+%EF%BC%8C%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91%E8%BF%99%E4%B8%A4%E4%B8%AA%E6%98%AF%E5%B1%9E%E4%BA%8E%E4%B8%A4%E4%B8%AAP2P%E8%8A%82%E7%82%B9%E7%9A%84%E4%B8%80%E6%9D%A5%E4%B8%80%E5%9B%9E%E7%9A%84%E5%93%A6%3C%2Fp%3E+%0A++%3Cp%3E2%E3%80%81%E6%83%B3%E6%9C%AC%E5%9C%B0pm%E7%9A%84peerSet%E4%B8%AD%E6%B3%A8%E5%86%8C%E8%BF%99%E4%B8%AA%E6%96%B0%E8%BF%9E%E6%8E%A5%E7%9A%84peer%E5%AE%9E%E4%BE%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Register+the+peer+locally%0A%09if+err+%3A%3D+pm.peers.Register%28p%29%3B+err+%21%3D+nil+%7B%0A%09%09p.Log%28%29.Error%28%22Ethereum+peer+registration+failed%22%2C+%22err%22%2C+err%29%0A%09%09return+err%0A%09%7D%0A%09defer+pm.removePeer%28p.id%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%AA%E9%87%8C%E9%9D%A2%E5%85%B6%E5%AE%9E%E4%B9%9F%E5%8F%AA%E6%98%AF%E5%81%9A%E4%BA%86%E4%B8%8B%E9%9D%A2%E6%89%BE%E4%B8%AA%E5%87%A0%E4%BB%B6%E4%BA%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28ps+*peerSet%29+Register%28p+*peer%29+error+%7B%0A%09ps.lock.Lock%28%29%0A%09defer+ps.lock.Unlock%28%29%0A%0A%09if+ps.closed+%7B%0A%09%09return+errClosed%0A%09%7D%0A%09if+_%2C+ok+%3A%3D+ps.peers%5Bp.id%5D%3B+ok+%7B%0A%09%09return+errAlreadyRegistered%0A%09%7D%0A%09ps.peers%5Bp.id%5D+%3D+p%0A%09go+p.broadcast%28%29%0A%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28p+*peer%29+broadcast%28%29+%7B%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+txs+%3A%3D+%26lt%3B-p.queuedTxs%3A%0A%09%09%09if+err+%3A%3D+p.SendTransactions%28txs%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09return%0A%09%09%09%7D%0A%09%09%09p.Log%28%29.Trace%28%22Broadcast+transactions%22%2C+%22count%22%2C+len%28txs%29%29%0A%0A%09%09case+prop+%3A%3D+%26lt%3B-p.queuedProps%3A%0A%09%09%09if+err+%3A%3D+p.SendNewBlock%28prop.block%2C+prop.td%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09return%0A%09%09%09%7D%0A%09%09%09p.Log%28%29.Trace%28%22Propagated+block%22%2C+%22number%22%2C+prop.block.Number%28%29%2C+%22hash%22%2C+prop.block.Hash%28%29%2C+%22td%22%2C+prop.td%29%0A%0A%09%09case+block+%3A%3D+%26lt%3B-p.queuedAnns%3A%0A%09%09%09if+err+%3A%3D+p.SendNewBlockHashes%28%5B%5Dcommon.Hash%7Bblock.Hash%28%29%7D%2C+%5B%5Duint64%7Bblock.NumberU64%28%29%7D%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09return%0A%09%09%09%7D%0A%09%09%09p.Log%28%29.Trace%28%22Announced+block%22%2C+%22number%22%2C+block.Number%28%29%2C+%22hash%22%2C+block.Hash%28%29%29%0A%0A%09%09case+%26lt%3B-p.term%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Ea%E3%80%81%E5%85%88%E6%8A%8A%E8%AF%A5%E8%8A%82%E7%82%B9%E5%AE%9E%E4%BE%8B%E6%94%BE%E7%BD%AEpm%E7%9A%84peerSet%E4%B8%AD%3C%2Fp%3E+%0A++%3Cp%3Eb%E3%80%81%E5%BC%82%E6%AD%A5%E5%8F%91%E8%B5%B7%E7%9C%9F%E5%AE%9E%E7%9A%84P2P%E5%B9%BF%E6%92%AD%EF%BC%8C%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E8%B5%B7%E4%BA%86%E4%B8%80%E4%B8%AA%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E4%B8%80%E7%9B%B4%E5%BE%AA%E7%8E%AF%3C%2Fstrong%3E%3C%2Fspan%3E%E5%A4%84%E7%90%86+%E5%88%86%E5%88%AB%E8%B0%83%E4%BA%86%E4%B8%89%E4%B8%AA%E6%96%B9%E6%B3%95%EF%BC%9A%E6%8A%8A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E7%BC%93%E5%AD%98%E5%9C%A8%E6%9C%AC%E5%9C%B0%E7%9A%84peerSet%E4%B8%AD%E7%9A%84peer%E5%86%85%E9%83%A8%3C%2Fstrong%3E%3C%2Fspan%3E%E7%9A%84%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AFtxs%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%81%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E5%8C%BA%E5%9D%97%E4%BF%A1%E6%81%AFBlock%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%81%3Cstrong%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%E5%8C%BA%E5%9D%97%E5%A4%B4Hash+%3C%2Fspan%3E%3C%2Fstrong%3E%E9%83%BD%E4%BD%BF%E7%94%A8P2P%E7%9A%84%E6%96%B9%E5%BC%8F%E5%8F%91%E7%BB%99%E5%BD%93%E5%89%8Dpeer%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E3%E3%80%81%E5%B0%86%E5%BD%93%E5%89%8Dpeer%E6%B3%A8%E5%86%8C%E5%88%B0downloader%E4%B8%AD%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+err+%3A%3D+pm.downloader.RegisterPeer%28p.id%2C+p.version%2C+p%29%3B+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E4%E3%80%81%E6%8A%8A%E6%9C%AC%E5%9C%B0%E4%BA%A4%E6%98%93%E6%B1%A0txpool%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF%E5%88%86%E5%88%AB%E6%8C%89%E7%85%A7%E7%BC%93%E5%AD%98%E5%9C%A8%E6%9C%AC%E5%9C%B0pm%E4%B8%AD%E7%9A%84peer%E9%80%90%E4%B8%AA%E6%9E%84%E5%BB%BA+%3Cstrong%3Etxsync+%3C%2Fstrong%3E%E7%BB%93%E6%9E%84%E4%BD%93%E5%B9%B6%E5%A1%9E%E5%85%A5%26nbsp%3B%3Cstrong%3Epm.txsyncCh+%E9%80%9A%E9%81%93%3C%2Fstrong%3E+%E3%80%90%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E4%B8%AA%E9%80%9A%E9%81%93%E3%80%91%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%90%8E%E7%BB%AD%E5%88%86peer%E5%8E%BB%E5%B9%BF%E6%92%ADtxs%E3%80%82%3Cstrong%3E%E8%BF%99%E6%97%B6%E5%80%99%E5%85%B6%E5%AE%9E%E6%98%AF%E8%BF%98%E6%B2%A1%E6%9C%89%E5%8F%91%E8%B5%B7%E7%9C%9F%E5%AE%9E%E7%9A%84P2P%E5%93%A6%E3%80%82%E5%92%8C%E4%B8%8A%E9%9D%A2%E7%AC%AC2%E6%AD%A5%E4%B8%AD%E9%82%A3%E4%B8%89%E4%B8%AA%E5%8F%91P2P%E7%9A%84%E4%B8%8D%E4%B8%80%E6%A0%B7%E5%93%A6%3C%2Fstrong%3E%E3%80%82%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Epm.syncTransactions%28p%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28pm+*ProtocolManager%29+syncTransactions%28p+*peer%29+%7B%0A%09var+txs+types.Transactions%0A%09pending%2C+_+%3A%3D+pm.txpool.Pending%28%29%0A%09for+_%2C+batch+%3A%3D+range+pending+%7B%0A%09%09txs+%3D+append%28txs%2C+batch...%29%0A%09%7D%0A%09if+len%28txs%29+%3D%3D+0+%7B%0A%09%09return%0A%09%7D%0A%09select+%7B%0A%09case+pm.txsyncCh+%26lt%3B-+%26amp%3Btxsync%7Bp%2C+txs%7D%3A%0A%09case+%26lt%3B-pm.quitSync%3A%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E5%E3%80%81%E6%AD%BB%E5%BE%AA%E7%8E%AF%E4%B8%80%E7%9B%B4%E5%9C%A8%E5%A4%84%E7%90%86%E8%BF%99+handleMsg+%E6%96%B9%E6%B3%95%EF%BC%9A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E8%B6%85%E7%BA%A7%E9%87%8D%E8%A6%81%EF%BC%8C%E6%98%AF%E4%B8%80%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%3C%2Fstrong%3E%3C%2Fspan%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efor+%7B%0A%09%09if+err+%3A%3D+pm.handleMsg%28p%29%3B+err+%21%3D+nil+%7B%0A%09%09%09p.Log%28%29.Debug%28%22Ethereum+message+handling+failed%22%2C+%22err%22%2C+err%29%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28pm+*ProtocolManager%29+handleMsg%28p+*peer%29+error+%7B%0A%09%2F%2F+Read+the+next+message+from+the+remote+peer%2C+and+ensure+it%27s+fully+consumed%0A%09msg%2C+err+%3A%3D+p.rw.ReadMsg%28%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09if+msg.Size+%26gt%3B+ProtocolMaxMsgSize+%7B%0A%09%09return+errResp%28ErrMsgTooLarge%2C+%22%25v+%26gt%3B+%25v%22%2C+msg.Size%2C+ProtocolMaxMsgSize%29%0A%09%7D%0A%09defer+msg.Discard%28%29%0A%0A%09%2F%2F+Handle+the+message+depending+on+its+contents%0A%09switch+%7B%0A%09case+msg.Code+%3D%3D+StatusMsg%3A%0A%09%09%2F%2F+Status+messages+should+never+arrive+after+the+handshake%0A%09%09return+errResp%28ErrExtraStatusMsg%2C+%22uncontrolled+status+message%22%29%0A%0A%09%2F%2F+Block+header+query%2C+collect+the+requested+headers+and+reply%0A%09case+msg.Code+%3D%3D+GetBlockHeadersMsg%3A%0A%09%09%2F%2F+Decode+the+complex+header+query%0A%09%09var+query+getBlockHeadersData%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Bquery%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09hashMode+%3A%3D+query.Origin.Hash+%21%3D+%28common.Hash%7B%7D%29%0A%09%09first+%3A%3D+true%0A%09%09maxNonCanonical+%3A%3D+uint64%28100%29%0A%0A%09%09%2F%2F+Gather+headers+until+the+fetch+or+network+limits+is+reached%0A%09%09var+%28%0A%09%09%09bytes+++common.StorageSize%0A%09%09%09headers+%5B%5D*types.Header%0A%09%09%09unknown+bool%0A%09%09%29%0A%09%09for+%21unknown+%26amp%3B%26amp%3B+len%28headers%29+%26lt%3B+int%28query.Amount%29+%26amp%3B%26amp%3B+bytes+%26lt%3B+softResponseLimit+%26amp%3B%26amp%3B+len%28headers%29+%26lt%3B+downloader.MaxHeaderFetch+%7B%0A%09%09%09%2F%2F+Retrieve+the+next+header+satisfying+the+query%0A%09%09%09var+origin+*types.Header%0A%09%09%09if+hashMode+%7B%0A%09%09%09%09if+first+%7B%0A%09%09%09%09%09first+%3D+false%0A%09%09%09%09%09origin+%3D+pm.blockchain.GetHeaderByHash%28query.Origin.Hash%29%0A%09%09%09%09%09if+origin+%21%3D+nil+%7B%0A%09%09%09%09%09%09query.Origin.Number+%3D+origin.Number.Uint64%28%29%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D+else+%7B%0A%09%09%09%09%09origin+%3D+pm.blockchain.GetHeader%28query.Origin.Hash%2C+query.Origin.Number%29%0A%09%09%09%09%7D%0A%09%09%09%7D+else+%7B%0A%09%09%09%09origin+%3D+pm.blockchain.GetHeaderByNumber%28query.Origin.Number%29%0A%09%09%09%7D%0A%09%09%09if+origin+%3D%3D+nil+%7B%0A%09%09%09%09break%0A%09%09%09%7D%0A%09%09%09headers+%3D+append%28headers%2C+origin%29%0A%09%09%09bytes+%2B%3D+estHeaderRlpSize%0A%0A%09%09%09%2F%2F+Advance+to+the+next+header+of+the+query%0A%09%09%09switch+%7B%0A%09%09%09case+hashMode+%26amp%3B%26amp%3B+query.Reverse%3A%0A%09%09%09%09%2F%2F+Hash+based+traversal+towards+the+genesis+block%0A%09%09%09%09ancestor+%3A%3D+query.Skip+%2B+1%0A%09%09%09%09if+ancestor+%3D%3D+0+%7B%0A%09%09%09%09%09unknown+%3D+true%0A%09%09%09%09%7D+else+%7B%0A%09%09%09%09%09query.Origin.Hash%2C+query.Origin.Number+%3D+pm.blockchain.GetAncestor%28query.Origin.Hash%2C+query.Origin.Number%2C+ancestor%2C+%26amp%3BmaxNonCanonical%29%0A%09%09%09%09%09unknown+%3D+%28query.Origin.Hash+%3D%3D+common.Hash%7B%7D%29%0A%09%09%09%09%7D%0A%09%09%09case+hashMode+%26amp%3B%26amp%3B+%21query.Reverse%3A%0A%09%09%09%09%2F%2F+Hash+based+traversal+towards+the+leaf+block%0A%09%09%09%09var+%28%0A%09%09%09%09%09current+%3D+origin.Number.Uint64%28%29%0A%09%09%09%09%09next++++%3D+current+%2B+query.Skip+%2B+1%0A%09%09%09%09%29%0A%09%09%09%09if+next+%26lt%3B%3D+current+%7B%0A%09%09%09%09%09infos%2C+_+%3A%3D+json.MarshalIndent%28p.Peer.Info%28%29%2C+%22%22%2C+%22++%22%29%0A%09%09%09%09%09p.Log%28%29.Warn%28%22GetBlockHeaders+skip+overflow+attack%22%2C+%22current%22%2C+current%2C+%22skip%22%2C+query.Skip%2C+%22next%22%2C+next%2C+%22attacker%22%2C+infos%29%0A%09%09%09%09%09unknown+%3D+true%0A%09%09%09%09%7D+else+%7B%0A%09%09%09%09%09if+header+%3A%3D+pm.blockchain.GetHeaderByNumber%28next%29%3B+header+%21%3D+nil+%7B%0A%09%09%09%09%09%09nextHash+%3A%3D+header.Hash%28%29%0A%09%09%09%09%09%09expOldHash%2C+_+%3A%3D+pm.blockchain.GetAncestor%28nextHash%2C+next%2C+query.Skip%2B1%2C+%26amp%3BmaxNonCanonical%29%0A%09%09%09%09%09%09if+expOldHash+%3D%3D+query.Origin.Hash+%7B%0A%09%09%09%09%09%09%09query.Origin.Hash%2C+query.Origin.Number+%3D+nextHash%2C+next%0A%09%09%09%09%09%09%7D+else+%7B%0A%09%09%09%09%09%09%09unknown+%3D+true%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%7D+else+%7B%0A%09%09%09%09%09%09unknown+%3D+true%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%0A%09%09%09case+query.Reverse%3A%0A%09%09%09%09%2F%2F+Number+based+traversal+towards+the+genesis+block%0A%09%09%09%09if+query.Origin.Number+%26gt%3B%3D+query.Skip%2B1+%7B%0A%09%09%09%09%09query.Origin.Number+-%3D+query.Skip+%2B+1%0A%09%09%09%09%7D+else+%7B%0A%09%09%09%09%09unknown+%3D+true%0A%09%09%09%09%7D%0A%0A%09%09%09case+%21query.Reverse%3A%0A%09%09%09%09%2F%2F+Number+based+traversal+towards+the+leaf+block%0A%09%09%09%09query.Origin.Number+%2B%3D+query.Skip+%2B+1%0A%09%09%09%7D%0A%09%09%7D%0A%09%09return+p.SendBlockHeaders%28headers%29%0A%0A%09case+msg.Code+%3D%3D+BlockHeadersMsg%3A%0A%09%09%2F%2F+A+batch+of+headers+arrived+to+one+of+our+previous+requests%0A%09%09var+headers+%5B%5D*types.Header%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Bheaders%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09%2F%2F+If+no+headers+were+received%2C+but+we%27re+expending+a+DAO+fork+check%2C+maybe+it%27s+that%0A%09%09if+len%28headers%29+%3D%3D+0+%26amp%3B%26amp%3B+p.forkDrop+%21%3D+nil+%7B%0A%09%09%09%2F%2F+Possibly+an+empty+reply+to+the+fork+header+checks%2C+sanity+check+TDs%0A%09%09%09verifyDAO+%3A%3D+true%0A%0A%09%09%09%2F%2F+If+we+already+have+a+DAO+header%2C+we+can+check+the+peer%27s+TD+against+it.+If%0A%09%09%09%2F%2F+the+peer%27s+ahead+of+this%2C+it+too+must+have+a+reply+to+the+DAO+check%0A%09%09%09if+daoHeader+%3A%3D+pm.blockchain.GetHeaderByNumber%28pm.chainconfig.DAOForkBlock.Uint64%28%29%29%3B+daoHeader+%21%3D+nil+%7B%0A%09%09%09%09if+_%2C+td+%3A%3D+p.Head%28%29%3B+td.Cmp%28pm.blockchain.GetTd%28daoHeader.Hash%28%29%2C+daoHeader.Number.Uint64%28%29%29%29+%26gt%3B%3D+0+%7B%0A%09%09%09%09%09verifyDAO+%3D+false%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%09%2F%2F+If+we%27re+seemingly+on+the+same+chain%2C+disable+the+drop+timer%0A%09%09%09if+verifyDAO+%7B%0A%09%09%09%09p.Log%28%29.Debug%28%22Seems+to+be+on+the+same+side+of+the+DAO+fork%22%29%0A%09%09%09%09p.forkDrop.Stop%28%29%0A%09%09%09%09p.forkDrop+%3D+nil%0A%09%09%09%09return+nil%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+Filter+out+any+explicitly+requested+headers%2C+deliver+the+rest+to+the+downloader%0A%09%09filter+%3A%3D+len%28headers%29+%3D%3D+1%0A%09%09if+filter+%7B%0A%09%09%09%2F%2F+If+it%27s+a+potential+DAO+fork+check%2C+validate+against+the+rules%0A%09%09%09if+p.forkDrop+%21%3D+nil+%26amp%3B%26amp%3B+pm.chainconfig.DAOForkBlock.Cmp%28headers%5B0%5D.Number%29+%3D%3D+0+%7B%0A%09%09%09%09%2F%2F+Disable+the+fork+drop+timer%0A%09%09%09%09p.forkDrop.Stop%28%29%0A%09%09%09%09p.forkDrop+%3D+nil%0A%0A%09%09%09%09%2F%2F+Validate+the+header+and+either+drop+the+peer+or+continue%0A%09%09%09%09if+err+%3A%3D+misc.VerifyDAOHeaderExtraData%28pm.chainconfig%2C+headers%5B0%5D%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09%09p.Log%28%29.Debug%28%22Verified+to+be+on+the+other+side+of+the+DAO+fork%2C+dropping%22%29%0A%09%09%09%09%09return+err%0A%09%09%09%09%7D%0A%09%09%09%09p.Log%28%29.Debug%28%22Verified+to+be+on+the+same+side+of+the+DAO+fork%22%29%0A%09%09%09%09return+nil%0A%09%09%09%7D%0A%09%09%09%2F%2F+Irrelevant+of+the+fork+checks%2C+send+the+header+to+the+fetcher+just+in+case%0A%09%09%09headers+%3D+pm.fetcher.FilterHeaders%28p.id%2C+headers%2C+time.Now%28%29%29%0A%09%09%7D%0A%09%09if+len%28headers%29+%26gt%3B+0+%7C%7C+%21filter+%7B%0A%09%09%09err+%3A%3D+pm.downloader.DeliverHeaders%28p.id%2C+headers%29%0A%09%09%09if+err+%21%3D+nil+%7B%0A%09%09%09%09log.Debug%28%22Failed+to+deliver+headers%22%2C+%22err%22%2C+err%29%0A%09%09%09%7D%0A%09%09%7D%0A%0A%09case+msg.Code+%3D%3D+GetBlockBodiesMsg%3A%0A%09%09%2F%2F+Decode+the+retrieval+message%0A%09%09msgStream+%3A%3D+rlp.NewStream%28msg.Payload%2C+uint64%28msg.Size%29%29%0A%09%09if+_%2C+err+%3A%3D+msgStream.List%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09%2F%2F+Gather+blocks+until+the+fetch+or+network+limits+is+reached%0A%09%09var+%28%0A%09%09%09hash+++common.Hash%0A%09%09%09bytes++int%0A%09%09%09bodies+%5B%5Drlp.RawValue%0A%09%09%29%0A%09%09for+bytes+%26lt%3B+softResponseLimit+%26amp%3B%26amp%3B+len%28bodies%29+%26lt%3B+downloader.MaxBlockFetch+%7B%0A%09%09%09%2F%2F+Retrieve+the+hash+of+the+next+block%0A%09%09%09if+err+%3A%3D+msgStream.Decode%28%26amp%3Bhash%29%3B+err+%3D%3D+rlp.EOL+%7B%0A%09%09%09%09break%0A%09%09%09%7D+else+if+err+%21%3D+nil+%7B%0A%09%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Retrieve+the+requested+block+body%2C+stopping+if+enough+was+found%0A%09%09%09if+data+%3A%3D+pm.blockchain.GetBodyRLP%28hash%29%3B+len%28data%29+%21%3D+0+%7B%0A%09%09%09%09bodies+%3D+append%28bodies%2C+data%29%0A%09%09%09%09bytes+%2B%3D+len%28data%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09return+p.SendBlockBodiesRLP%28bodies%29%0A%0A%09case+msg.Code+%3D%3D+BlockBodiesMsg%3A%0A%09%09%2F%2F+A+batch+of+block+bodies+arrived+to+one+of+our+previous+requests%0A%09%09var+request+blockBodiesData%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Brequest%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09%2F%2F+Deliver+them+all+to+the+downloader+for+queuing%0A%09%09transactions+%3A%3D+make%28%5B%5D%5B%5D*types.Transaction%2C+len%28request%29%29%0A%09%09uncles+%3A%3D+make%28%5B%5D%5B%5D*types.Header%2C+len%28request%29%29%0A%0A%09%09for+i%2C+body+%3A%3D+range+request+%7B%0A%09%09%09transactions%5Bi%5D+%3D+body.Transactions%0A%09%09%09uncles%5Bi%5D+%3D+body.Uncles%0A%09%09%7D%0A%09%09%2F%2F+Filter+out+any+explicitly+requested+bodies%2C+deliver+the+rest+to+the+downloader%0A%09%09filter+%3A%3D+len%28transactions%29+%26gt%3B+0+%7C%7C+len%28uncles%29+%26gt%3B+0%0A%09%09if+filter+%7B%0A%09%09%09transactions%2C+uncles+%3D+pm.fetcher.FilterBodies%28p.id%2C+transactions%2C+uncles%2C+time.Now%28%29%29%0A%09%09%7D%0A%09%09if+len%28transactions%29+%26gt%3B+0+%7C%7C+len%28uncles%29+%26gt%3B+0+%7C%7C+%21filter+%7B%0A%09%09%09err+%3A%3D+pm.downloader.DeliverBodies%28p.id%2C+transactions%2C+uncles%29%0A%09%09%09if+err+%21%3D+nil+%7B%0A%09%09%09%09log.Debug%28%22Failed+to+deliver+bodies%22%2C+%22err%22%2C+err%29%0A%09%09%09%7D%0A%09%09%7D%0A%0A%09case+p.version+%26gt%3B%3D+eth63+%26amp%3B%26amp%3B+msg.Code+%3D%3D+GetNodeDataMsg%3A%0A%09%09%2F%2F+Decode+the+retrieval+message%0A%09%09msgStream+%3A%3D+rlp.NewStream%28msg.Payload%2C+uint64%28msg.Size%29%29%0A%09%09if+_%2C+err+%3A%3D+msgStream.List%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09%2F%2F+Gather+state+data+until+the+fetch+or+network+limits+is+reached%0A%09%09var+%28%0A%09%09%09hash++common.Hash%0A%09%09%09bytes+int%0A%09%09%09data++%5B%5D%5B%5Dbyte%0A%09%09%29%0A%09%09for+bytes+%26lt%3B+softResponseLimit+%26amp%3B%26amp%3B+len%28data%29+%26lt%3B+downloader.MaxStateFetch+%7B%0A%09%09%09%2F%2F+Retrieve+the+hash+of+the+next+state+entry%0A%09%09%09if+err+%3A%3D+msgStream.Decode%28%26amp%3Bhash%29%3B+err+%3D%3D+rlp.EOL+%7B%0A%09%09%09%09break%0A%09%09%09%7D+else+if+err+%21%3D+nil+%7B%0A%09%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Retrieve+the+requested+state+entry%2C+stopping+if+enough+was+found%0A%09%09%09if+entry%2C+err+%3A%3D+pm.blockchain.TrieNode%28hash%29%3B+err+%3D%3D+nil+%7B%0A%09%09%09%09data+%3D+append%28data%2C+entry%29%0A%09%09%09%09bytes+%2B%3D+len%28entry%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09return+p.SendNodeData%28data%29%0A%0A%09case+p.version+%26gt%3B%3D+eth63+%26amp%3B%26amp%3B+msg.Code+%3D%3D+NodeDataMsg%3A%0A%09%09%2F%2F+A+batch+of+node+state+data+arrived+to+one+of+our+previous+requests%0A%09%09var+data+%5B%5D%5B%5Dbyte%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Bdata%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09%2F%2F+Deliver+all+to+the+downloader%0A%09%09if+err+%3A%3D+pm.downloader.DeliverNodeData%28p.id%2C+data%29%3B+err+%21%3D+nil+%7B%0A%09%09%09log.Debug%28%22Failed+to+deliver+node+state+data%22%2C+%22err%22%2C+err%29%0A%09%09%7D%0A%0A%09case+p.version+%26gt%3B%3D+eth63+%26amp%3B%26amp%3B+msg.Code+%3D%3D+GetReceiptsMsg%3A%0A%09%09%2F%2F+Decode+the+retrieval+message%0A%09%09msgStream+%3A%3D+rlp.NewStream%28msg.Payload%2C+uint64%28msg.Size%29%29%0A%09%09if+_%2C+err+%3A%3D+msgStream.List%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09%2F%2F+Gather+state+data+until+the+fetch+or+network+limits+is+reached%0A%09%09var+%28%0A%09%09%09hash+++++common.Hash%0A%09%09%09bytes++++int%0A%09%09%09receipts+%5B%5Drlp.RawValue%0A%09%09%29%0A%09%09for+bytes+%26lt%3B+softResponseLimit+%26amp%3B%26amp%3B+len%28receipts%29+%26lt%3B+downloader.MaxReceiptFetch+%7B%0A%09%09%09%2F%2F+Retrieve+the+hash+of+the+next+block%0A%09%09%09if+err+%3A%3D+msgStream.Decode%28%26amp%3Bhash%29%3B+err+%3D%3D+rlp.EOL+%7B%0A%09%09%09%09break%0A%09%09%09%7D+else+if+err+%21%3D+nil+%7B%0A%09%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Retrieve+the+requested+block%27s+receipts%2C+skipping+if+unknown+to+us%0A%09%09%09results+%3A%3D+pm.blockchain.GetReceiptsByHash%28hash%29%0A%09%09%09if+results+%3D%3D+nil+%7B%0A%09%09%09%09if+header+%3A%3D+pm.blockchain.GetHeaderByHash%28hash%29%3B+header+%3D%3D+nil+%7C%7C+header.ReceiptHash+%21%3D+types.EmptyRootHash+%7B%0A%09%09%09%09%09continue%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%09%2F%2F+If+known%2C+encode+and+queue+for+response+packet%0A%09%09%09if+encoded%2C+err+%3A%3D+rlp.EncodeToBytes%28results%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09log.Error%28%22Failed+to+encode+receipt%22%2C+%22err%22%2C+err%29%0A%09%09%09%7D+else+%7B%0A%09%09%09%09receipts+%3D+append%28receipts%2C+encoded%29%0A%09%09%09%09bytes+%2B%3D+len%28encoded%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09return+p.SendReceiptsRLP%28receipts%29%0A%0A%09case+p.version+%26gt%3B%3D+eth63+%26amp%3B%26amp%3B+msg.Code+%3D%3D+ReceiptsMsg%3A%0A%09%09%2F%2F+A+batch+of+receipts+arrived+to+one+of+our+previous+requests%0A%09%09var+receipts+%5B%5D%5B%5D*types.Receipt%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Breceipts%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09%2F%2F+Deliver+all+to+the+downloader%0A%09%09if+err+%3A%3D+pm.downloader.DeliverReceipts%28p.id%2C+receipts%29%3B+err+%21%3D+nil+%7B%0A%09%09%09log.Debug%28%22Failed+to+deliver+receipts%22%2C+%22err%22%2C+err%29%0A%09%09%7D%0A%0A%09case+msg.Code+%3D%3D+NewBlockHashesMsg%3A%0A%09%09var+announces+newBlockHashesData%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Bannounces%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09%2F%2F+Mark+the+hashes+as+present+at+the+remote+node%0A%09%09for+_%2C+block+%3A%3D+range+announces+%7B%0A%09%09%09p.MarkBlock%28block.Hash%29%0A%09%09%7D%0A%09%09%2F%2F+Schedule+all+the+unknown+hashes+for+retrieval%0A%09%09unknown+%3A%3D+make%28newBlockHashesData%2C+0%2C+len%28announces%29%29%0A%09%09for+_%2C+block+%3A%3D+range+announces+%7B%0A%09%09%09if+%21pm.blockchain.HasBlock%28block.Hash%2C+block.Number%29+%7B%0A%09%09%09%09unknown+%3D+append%28unknown%2C+block%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09for+_%2C+block+%3A%3D+range+unknown+%7B%0A%09%09%09pm.fetcher.Notify%28p.id%2C+block.Hash%2C+block.Number%2C+time.Now%28%29%2C+p.RequestOneHeader%2C+p.RequestBodies%29%0A%09%09%7D%0A%0A%09case+msg.Code+%3D%3D+NewBlockMsg%3A%0A%09%09%2F%2F+Retrieve+and+decode+the+propagated+block%0A%09%09var+request+newBlockData%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Brequest%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09request.Block.ReceivedAt+%3D+msg.ReceivedAt%0A%09%09request.Block.ReceivedFrom+%3D+p%0A%0A%09%09%2F%2F+Mark+the+peer+as+owning+the+block+and+schedule+it+for+import%0A%09%09p.MarkBlock%28request.Block.Hash%28%29%29%0A%09%09pm.fetcher.Enqueue%28p.id%2C+request.Block%29%0A%0A%09%09%2F%2F+Assuming+the+block+is+importable+by+the+peer%2C+but+possibly+not+yet+done+so%2C%0A%09%09%2F%2F+calculate+the+head+hash+and+TD+that+the+peer+truly+must+have.%0A%09%09var+%28%0A%09%09%09trueHead+%3D+request.Block.ParentHash%28%29%0A%09%09%09trueTD+++%3D+new%28big.Int%29.Sub%28request.TD%2C+request.Block.Difficulty%28%29%29%0A%09%09%29%0A%09%09%2F%2F+Update+the+peers+total+difficulty+if+better+than+the+previous%0A%09%09if+_%2C+td+%3A%3D+p.Head%28%29%3B+trueTD.Cmp%28td%29+%26gt%3B+0+%7B%0A%09%09%09p.SetHead%28trueHead%2C+trueTD%29%0A%0A%09%09%09%2F%2F+Schedule+a+sync+if+above+ours.+Note%2C+this+will+not+fire+a+sync+for+a+gap+of%0A%09%09%09%2F%2F+a+singe+block+%28as+the+true+TD+is+below+the+propagated+block%29%2C+however+this%0A%09%09%09%2F%2F+scenario+should+easily+be+covered+by+the+fetcher.%0A%09%09%09currentBlock+%3A%3D+pm.blockchain.CurrentBlock%28%29%0A%09%09%09if+trueTD.Cmp%28pm.blockchain.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%29+%26gt%3B+0+%7B%0A%09%09%09%09go+pm.synchronise%28p%29%0A%09%09%09%7D%0A%09%09%7D%0A%0A%09case+msg.Code+%3D%3D+TxMsg%3A%0A%09%09%2F%2F+Transactions+arrived%2C+make+sure+we+have+a+valid+and+fresh+chain+to+handle+them%0A%09%09if+atomic.LoadUint32%28%26amp%3Bpm.acceptTxs%29+%3D%3D+0+%7B%0A%09%09%09break%0A%09%09%7D%0A%09%09%2F%2F+Transactions+can+be+processed%2C+parse+all+of+them+and+deliver+to+the+pool%0A%09%09var+txs+%5B%5D*types.Transaction%0A%09%09if+err+%3A%3D+msg.Decode%28%26amp%3Btxs%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+errResp%28ErrDecode%2C+%22msg+%25v%3A+%25v%22%2C+msg%2C+err%29%0A%09%09%7D%0A%09%09for+i%2C+tx+%3A%3D+range+txs+%7B%0A%09%09%09%2F%2F+Validate+and+mark+the+remote+transaction%0A%09%09%09if+tx+%3D%3D+nil+%7B%0A%09%09%09%09return+errResp%28ErrDecode%2C+%22transaction+%25d+is+nil%22%2C+i%29%0A%09%09%09%7D%0A%09%09%09p.MarkTransaction%28tx.Hash%28%29%29%0A%09%09%7D%0A%09%09pm.txpool.AddRemotes%28txs%29%0A%0A%09default%3A%0A%09%09return+errResp%28ErrInvalidMsgCode%2C+%22%25v%22%2C+msg.Code%29%0A%09%7D%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%B8%8D%E9%9A%BE%E7%9C%8B%E5%87%BA%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E8%B6%85%E7%BA%A7%E7%9A%84%E9%95%BF%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8D%B4%E6%98%AF%E5%B1%9E%E4%BA%8E%E7%94%B1%E4%B8%80%E4%B8%AA%E6%AD%BB%E5%BE%AA%E7%8E%AF%E4%B8%80%E7%9B%B4%E5%9C%A8%E5%A4%84%E7%90%86%E7%9A%84%EF%BC%8C%E8%80%8C%E6%96%B9%E6%B3%95%E9%87%8C%E9%9D%A2%E6%97%A0%E9%9D%9E%E5%B0%B1%E6%98%AF%E5%AF%B9P2P%E8%8A%82%E7%82%B9%E5%8F%8C%E5%8F%91%E5%8F%91%E6%9D%A5%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%A7%A3%E6%9E%90%E5%AF%B9%E5%BA%94%E7%9A%84Msg.Code+%E6%9D%A5%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E7%9A%84%E8%AF%B7%E6%B1%82%E7%8A%B6%E6%80%81%EF%BC%8C%E5%8E%BB%E5%81%9A%E5%AF%B9%E5%BA%94%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E3%80%82%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E6%B3%A8%E9%87%8D%E8%AE%B2%E5%85%B6%E4%B8%AD%E5%87%A0%E4%B8%AA%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3Ea%E3%80%81%E5%BD%93%E6%94%B6%E5%88%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AF%26nbsp%3B%26nbsp%3B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3ENewBlockHashesMsg+%3C%2Fstrong%3E%3C%2Fspan%3E%E6%97%B6%EF%BC%9A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E8%A1%A8%E7%A4%BA%E6%8E%A5%E6%94%B6%E5%88%B0%E4%BA%86%E8%BF%9C%E7%AB%AF%E5%B9%BF%E6%92%AD%E8%BF%87%E6%9D%A5%E7%9A%84BlockHash%3C%2Fstrong%3E%3C%2Fspan%3E%EF%BC%8C%E5%85%88%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E8%8E%B7%E5%8F%96%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E+announces%E6%95%B0%E7%BB%84%3C%2Fstrong%3E%3C%2Fspan%3E%EF%BC%9B%E9%81%8D%E5%8E%86announces%E6%95%B0%E7%BB%84%E5%AF%B9%E6%AF%94%E5%87%BA%E6%9C%AC%E5%9C%B0%E9%93%BE%E4%B8%8A%E6%9C%AA%E5%87%BA%E7%8E%B0%E7%9A%84Block%E7%9A%84hash%E5%8F%8Anumber%E6%94%B6%E9%9B%86%E5%88%B0%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Eunknown%E6%95%B0%E7%BB%84%3C%2Fstrong%3E%3C%2Fspan%3E%E4%B8%AD%EF%BC%8C+%E5%86%8D%E6%A0%B9%E6%8D%AE%E9%80%90%E4%B8%80%E8%B0%83%E7%94%A8%26nbsp%3B%26nbsp%3B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Epm.fetcher.Notify%28p.id%2C+block.Hash%2C+block.Number%2C+time.Now%28%29%2C+p.RequestOneHeader%2C+p.RequestBodies%29%3C%2Fstrong%3E%3C%2Fspan%3E+%E5%B9%B6%E6%8A%8A+%E8%AF%B7%E6%B1%82%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%8F%8A%E8%AF%B7%E6%B1%82%E5%8C%BA%E5%9D%97%E4%BD%93%E7%9A%84%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E4%BC%A0%E8%BF%9B%E5%8E%BB%E4%BB%A5%E5%A4%87%E5%90%8E%E7%BB%AD%E4%BD%BF%E7%94%A8%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3Eb%E3%80%81%E5%BD%93%E6%94%B6%E5%88%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AF%26nbsp%3B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3EBlockHeadersMsg+%3C%2Fstrong%3E%3C%2Fspan%3E%E6%97%B6%EF%BC%9A%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E8%A1%A8%E7%A4%BA%E6%8E%A5%E6%94%B6%E5%88%B0%E4%BA%86%E8%BF%9C%E7%AB%AF%E5%B9%BF%E6%92%AD%E8%BF%87%E6%9D%A5%E7%9A%84+BlockHeader%3C%2Fstrong%3E%3C%2Fspan%3E%EF%BC%8C%E5%85%88%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E8%8E%B7%E5%8F%96%26nbsp%3Bheaders+%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8%26nbsp%3Bheaders+%3D+%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Epm.fetcher.FilterHeaders%28p.id%2C+headers%2C+time.Now%28%29%29%3C%2Fstrong%3E%3C%2Fspan%3E+%E8%BF%87%E6%BB%A4%E6%8E%89%E4%B8%8D%E5%90%88%E6%B3%95%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E4%BD%BF%E7%94%A8+%3Cstrong%3Edownloader%3C%2Fstrong%3E%E5%8E%BB%E5%A4%84%E7%90%86%E5%8C%BA%E5%9D%97%E5%A4%B4%26nbsp%3B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3Epm.downloader.DeliverHeaders%28p.id%2C+headers%29%3C%2Fstrong%3E%3C%2Fspan%3E+%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3Ec%E3%80%81%E5%BD%93%E6%8E%A5%E6%94%B6%E5%88%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AF%26nbsp%3B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3EBlockBodiesMsg+%3C%2Fstrong%3E%3C%2Fspan%3E%E6%97%B6%EF%BC%9A%E8%A1%A8%E7%A4%BA%E6%8E%A5%E6%94%B6%E5%88%B0%E4%BA%86%E8%BF%9C%E7%AB%AF%E5%B9%BF%E6%92%AD%E8%BF%87%E6%9D%A5%E7%9A%84+bodies+%E6%95%B0%E7%BB%84%26nbsp%3BblockBodiesData%E3%80%82%E5%85%88%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%BF%87%E6%BB%A4%E9%9D%9E%E6%B3%95%E7%9A%84body%EF%BC%9Apm.fetcher.FilterBodies%EF%BC%88...%EF%BC%89%EF%BC%8C%E4%BD%BF%E7%94%A8downloader%E5%A4%84%E7%90%86+body%EF%BC%9Apm.downloader.DeliverBodies%EF%BC%88...%EF%BC%89%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%86%8D%E5%BE%80%E4%B8%8B%E5%B0%B1%E6%98%AF+fetcher+%E5%92%8Cdownloader%E7%9A%84%E9%80%BB%E8%BE%91%E4%B8%AD%E5%86%8D%E7%BB%86%E8%AE%B2%E4%BA%86%E3%80%82%E5%88%B0%E7%9B%AE%E5%89%8D%E4%B8%BA%E6%AD%A2%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96node%E7%9A%84%E6%97%B6%E5%80%99%E6%8A%8A%E5%85%B3%E4%BA%8EP2P+%E9%83%A8%E5%88%86%E3%80%90%3Cstrong%3E%E4%B8%BB%E8%A6%81%E6%98%AFtx%E5%8F%8Ablock%E5%B9%BF%E6%92%AD%E7%AD%89%E5%A4%84%E7%90%86%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E4%BD%86%E6%98%AF%E7%9B%AE%E5%89%8D%E8%BF%99%E4%BA%9B%E6%96%B9%E6%B3%95%E9%83%BD%E5%8F%AA%E6%98%AF%E5%9C%A8Protocol.Run+%E4%B8%AD%E5%86%99%E4%BA%86+pm.Handle%28%29+%E7%9A%84%E5%9B%9E%E8%B0%83%E8%80%8C%E5%B7%B2%EF%BC%8C%E8%BF%98%E8%AF%B6%E6%9C%89%E5%8F%91%E8%B5%B7%E7%9C%9F%E5%AE%9E%E7%9A%84%E8%B0%83%E7%94%A8%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AA%E7%9B%B8%E5%BD%93%E4%BA%8E%E6%98%AF%E6%B3%A8%E5%86%8C%E8%80%8C%E5%B7%B2%EF%BC%8C%E7%9C%9F%E5%AE%9E%E7%9A%84%E8%B0%83%E7%94%A8%E9%9C%80%E8%A6%81%E5%9C%A8node%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%E6%89%8D%E4%BC%9A%E6%9C%89%E8%B0%83%E5%88%B0%E8%BF%99%E9%87%8C%E6%9D%A5%3C%2Fstrong%3E%E3%80%91%E7%BB%99%E8%AE%B2%E8%A7%A3%E5%AE%8C%E4%BA%86%EF%BC%8C%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E6%9D%A5%E6%9F%A5%E7%9C%8Bnode%E5%90%AF%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%8C%E5%8F%8AP2P+%E8%AF%B7%E6%B1%82%E9%83%A8%E5%88%86%E7%9A%84%E9%80%BB%E8%BE%91%E3%80%82%3C%2Fp%3E+%0A++%3Ch1%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%E5%90%AF%E5%8A%A8%E6%9C%AC%E5%9C%B0node%E8%8A%82%E7%82%B9%E5%AE%9E%E4%BE%8B%3C%2Fspan%3E%EF%BC%9A%3C%2Fh1%3E+%0A++%3Cp%3E%E7%94%B1%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%EF%BC%8C%E4%B8%BB%E8%A6%81%E5%81%9A%E4%BA%86%E4%BB%A5%E4%B8%8B%E5%87%A0%E4%BB%B6%E4%BA%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%90%AF%E5%8A%A8node%E8%87%AA%E8%BA%AB%EF%BC%9A%E3%80%90%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E8%BF%99%E4%B8%AA%E8%B6%85%E7%BA%A7%E9%87%8D%E8%A6%81%EF%BC%8C%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E8%A6%81%E7%BB%86%E8%AE%B2%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%91%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Start+up+the+node+itself%0A%09utils.StartNode%28stack%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E2%E3%80%81%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%A7%A3%E9%94%81%E8%B4%A6%E6%88%B7%E7%9B%B8%E5%85%B3%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Unlock+any+account+specifically+requested%0A%09ks+%3A%3D+stack.AccountManager%28%29.Backends%28keystore.KeyStoreType%29%5B0%5D.%28*keystore.KeyStore%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E3%E3%80%81%E8%AE%A2%E9%98%85%E9%92%B1%E5%8C%85%E4%BA%8B%E4%BB%B6%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Estack.AccountManager%28%29.Subscribe%28events%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E4%E3%80%81%E5%88%9B%E5%BB%BARPC+client%E8%BF%9E%E6%8E%A5%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3ErpcClient%2C+err+%3A%3D+stack.Attach%28%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E5%E3%80%81%E6%A3%80%E7%B4%A2%E8%BF%90%E8%A1%8C%E7%9A%84Ethereum%E6%9C%8D%E5%8A%A1%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+err+%3A%3D+stack.Service%28%26amp%3Bethereum%29%3B+err+%21%3D+nil+%7B%0A%09%09%09utils.Fatalf%28%22Ethereum+service+not+running%3A+%25v%22%2C+err%29%0A%09%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E6%E3%80%81%E8%AE%BE%E7%BD%AE%E6%8C%96%E7%9F%BF%E5%BC%80%E5%90%AF%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Use+a+reduced+number+of+threads+if+requested%0A%09%09if+threads+%3A%3D+ctx.GlobalInt%28utils.MinerThreadsFlag.Name%29%3B+threads+%26gt%3B+0+%7B%0A%09%09%09type+threaded+interface+%7B%0A%09%09%09%09SetThreads%28threads+int%29%0A%09%09%09%7D%0A%09%09%09if+th%2C+ok+%3A%3D+ethereum.Engine%28%29.%28threaded%29%3B+ok+%7B%0A%09%09%09%09th.SetThreads%28threads%29%0A%09%09%09%7D%0A%09%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E7%E3%80%81%E6%A0%B9%E6%8D%AE%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%AE%BE%E7%BD%AEtxpool%E7%9A%84gasPrice%EF%BC%8C%E7%94%B1%E7%9F%BF%E5%B7%A5%E5%86%B3%E5%AE%9A%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Set+the+gas+price+to+the+limits+from+the+CLI+and+start+mining%0A%09%09ethereum.TxPool%28%29.SetGasPrice%28utils.GlobalBig%28ctx%2C+utils.GasPriceFlag.Name%29%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E8%E3%80%81%E5%90%AF%E5%8A%A8%E6%8C%96%E7%9F%BF%E4%BB%BB%E5%8A%A1%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+err+%3A%3D+ethereum.StartMining%28true%29%3B+err+%21%3D+nil+%7B%0A%09%09%09utils.Fatalf%28%22Failed+to+start+mining%3A+%25v%22%2C+err%29%0A%09%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%A5%BD%E4%BA%86%EF%BC%8C%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E6%B3%A8%E9%87%8D%E8%AE%B2%E8%A7%A3%EF%BC%8C%E5%90%AF%E5%8A%A8node%E8%87%AA%E8%BA%AB%E8%BF%99%E9%83%A8%E5%88%86%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E5%9B%A0%E4%B8%BA%E9%87%8C%E9%9D%A2%E6%89%8D%E6%98%AF%E5%8C%85%E5%90%AB%E4%BA%86%E7%9C%9F%E6%AD%A3%E7%9A%84P2P%E9%83%A8%E5%88%86%E3%80%82%3C%2Fp%3E+%0A++%3Ch3%3E%3Cstrong%3E%E5%90%AF%E5%8A%A8node%E8%87%AA%E8%BA%AB%EF%BC%9A%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Cp%3E%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+StartNode%28stack+*node.Node%29+%7B%0A%09if+err+%3A%3D+stack.Start%28%29%3B+err+%21%3D+nil+%7B%0A%09%09Fatalf%28%22Error+starting+protocol+stack%3A+%25v%22%2C+err%29%0A%09%7D%0A%09go+func%28%29+%7B%0A%09%09sigc+%3A%3D+make%28chan+os.Signal%2C+1%29%0A%09%09signal.Notify%28sigc%2C+syscall.SIGINT%2C+syscall.SIGTERM%29%0A%09%09defer+signal.Stop%28sigc%29%0A%09%09%26lt%3B-sigc%0A%09%09log.Info%28%22Got+interrupt%2C+shutting+down...%22%29%0A%09%09go+stack.Stop%28%29%0A%09%09for+i+%3A%3D+10%3B+i+%26gt%3B+0%3B+i--+%7B%0A%09%09%09%26lt%3B-sigc%0A%09%09%09if+i+%26gt%3B+1+%7B%0A%09%09%09%09log.Warn%28%22Already+shutting+down%2C+interrupt+more+to+panic.%22%2C+%22times%22%2C+i-1%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09debug.Exit%28%29+%2F%2F+ensure+trace+and+CPU+profile+data+is+flushed.%0A%09%09debug.LoudPanic%28%22boom%22%29%0A%09%7D%28%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E4%B8%80%E8%BF%9B%E6%9D%A5%E5%B0%B1%E5%81%9A%E4%BA%86%E4%B8%A4%E4%BB%B6%E4%BA%8B%EF%BC%8C%3Cstrong%3E%E4%B8%80%E4%BB%B6%E6%98%AFnode.Start%28%29%3C%2Fstrong%3E%EF%BC%9B%3Cstrong%3E%E4%B8%80%E4%BB%B6%E6%98%AF%E7%9B%91%E5%90%AC%E7%B3%BB%E7%BB%9F%E7%9A%84%E9%80%80%E5%87%BA%E4%BF%A1%E5%8F%B7%E6%9D%A5%E5%81%9A%E7%A8%8B%E5%BA%8F%E9%80%80%E5%87%BA%3C%2Fstrong%3E%EF%BC%8C%E8%BF%99%E9%87%8C%E6%98%AF%E5%90%A7+node.Wait%28%29+%E9%87%8C%E9%9D%A2%E7%9B%91%E5%90%AC%E7%9A%84%E9%98%BB%E5%A1%9E%E9%80%9A%E9%81%93%E7%BB%99stop%E6%8E%89%E3%80%82%E5%86%8D%E8%B7%9F%E8%BF%9Bnode.Start%28%29+%E4%B8%AD%E7%9C%8B%E7%9C%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28n+*Node%29+Start%28%29+error+%7B%0A%09n.lock.Lock%28%29%0A%09defer+n.lock.Unlock%28%29%0A%0A%09%2F%2F+Short+circuit+if+the+node%27s+already+running%0A%09if+n.server+%21%3D+nil+%7B%0A%09%09return+ErrNodeRunning%0A%09%7D%0A%09if+err+%3A%3D+n.openDataDir%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%0A%09%2F%2F+Initialize+the+p2p+server.+This+creates+the+node+key+and%0A%09%2F%2F+discovery+databases.%0A%09n.serverConfig+%3D+n.config.P2P%0A%09n.serverConfig.PrivateKey+%3D+n.config.NodeKey%28%29%0A%09n.serverConfig.Name+%3D+n.config.NodeName%28%29%0A%09n.serverConfig.Logger+%3D+n.log%0A%09if+n.serverConfig.StaticNodes+%3D%3D+nil+%7B%0A%09%09n.serverConfig.StaticNodes+%3D+n.config.StaticNodes%28%29%0A%09%7D%0A%09if+n.serverConfig.TrustedNodes+%3D%3D+nil+%7B%0A%09%09n.serverConfig.TrustedNodes+%3D+n.config.TrustedNodes%28%29%0A%09%7D%0A%09if+n.serverConfig.NodeDatabase+%3D%3D+%22%22+%7B%0A%09%09n.serverConfig.NodeDatabase+%3D+n.config.NodeDB%28%29%0A%09%7D%0A%09running+%3A%3D+%26amp%3Bp2p.Server%7BConfig%3A+n.serverConfig%7D%0A%09n.log.Info%28%22Starting+peer-to-peer+node%22%2C+%22instance%22%2C+n.serverConfig.Name%29%0A%0A%09%2F%2F+Otherwise+copy+and+specialize+the+P2P+configuration%0A%09services+%3A%3D+make%28map%5Breflect.Type%5DService%29%0A%09for+_%2C+constructor+%3A%3D+range+n.serviceFuncs+%7B%0A%09%09%2F%2F+Create+a+new+context+for+the+particular+service%0A%09%09ctx+%3A%3D+%26amp%3BServiceContext%7B%0A%09%09%09config%3A+++++++++n.config%2C%0A%09%09%09services%3A+++++++make%28map%5Breflect.Type%5DService%29%2C%0A%09%09%09EventMux%3A+++++++n.eventmux%2C%0A%09%09%09AccountManager%3A+n.accman%2C%0A%09%09%7D%0A%09%09for+kind%2C+s+%3A%3D+range+services+%7B+%2F%2F+copy+needed+for+threaded+access%0A%09%09%09ctx.services%5Bkind%5D+%3D+s%0A%09%09%7D%0A%09%09%2F%2F+Construct+and+save+the+service%0A%09%09service%2C+err+%3A%3D+constructor%28ctx%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09kind+%3A%3D+reflect.TypeOf%28service%29%0A%09%09if+_%2C+exists+%3A%3D+services%5Bkind%5D%3B+exists+%7B%0A%09%09%09return+%26amp%3BDuplicateServiceError%7BKind%3A+kind%7D%0A%09%09%7D%0A%09%09services%5Bkind%5D+%3D+service%0A%09%7D%0A%09%2F%2F+Gather+the+protocols+and+start+the+freshly+assembled+P2P+server%0A%09for+_%2C+service+%3A%3D+range+services+%7B%0A%09%09running.Protocols+%3D+append%28running.Protocols%2C+service.Protocols%28%29...%29%0A%09%7D%0A%09if+err+%3A%3D+running.Start%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+convertFileLockError%28err%29%0A%09%7D%0A%09%2F%2F+Start+each+of+the+services%0A%09started+%3A%3D+%5B%5Dreflect.Type%7B%7D%0A%09for+kind%2C+service+%3A%3D+range+services+%7B%0A%09%09%2F%2F+Start+the+next+service%2C+stopping+all+previous+upon+failure%0A%09%09if+err+%3A%3D+service.Start%28running%29%3B+err+%21%3D+nil+%7B%0A%09%09%09for+_%2C+kind+%3A%3D+range+started+%7B%0A%09%09%09%09services%5Bkind%5D.Stop%28%29%0A%09%09%09%7D%0A%09%09%09running.Stop%28%29%0A%0A%09%09%09return+err%0A%09%09%7D%0A%09%09%2F%2F+Mark+the+service+started+for+potential+cleanup%0A%09%09started+%3D+append%28started%2C+kind%29%0A%09%7D%0A%09%2F%2F+Lastly+start+the+configured+RPC+interfaces%0A%09if+err+%3A%3D+n.startRPC%28services%29%3B+err+%21%3D+nil+%7B%0A%09%09for+_%2C+service+%3A%3D+range+services+%7B%0A%09%09%09service.Stop%28%29%0A%09%09%7D%0A%09%09running.Stop%28%29%0A%09%09return+err%0A%09%7D%0A%09%2F%2F+Finish+initializing+the+startup%0A%09n.services+%3D+services%0A%09n.server+%3D+running%0A%09n.stop+%3D+make%28chan+struct%7B%7D%29%0A%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%B8%BB%E8%A6%81%E5%81%9A%E4%BA%86%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%BB%B6%E4%BA%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAp2p.Server+%E5%AE%9E%E4%BE%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Erunning+%3A%3D+%26amp%3Bp2p.Server%7BConfig%3A+n.serverConfig%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E2%E3%80%81%E4%BD%BF%E7%94%A8for%E5%BE%AA%E7%8E%AF%E9%80%90%E4%B8%AA%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B9%8B%E5%89%8D%E5%88%9D%E5%A7%8B%E5%8C%96node%E6%97%B6%E8%A2%AB%E6%94%B6%E9%9B%86%E5%88%B0node.ServiceFuns%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%EF%BC%8C%E6%9D%A5%E5%88%9D%E8%AF%86%E5%8C%96%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E3%E3%80%81%E9%80%90%E4%B8%AA%E7%9A%84%E6%8A%8A%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%9A%84Protocol%E6%94%B6%E9%9B%86%E5%88%B0p2pServer%E4%B8%AD%EF%BC%8C%E5%BE%85%E5%90%8E%E9%9D%A2%E6%9C%89%E7%94%A8%E3%80%82%E3%80%90%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E8%BF%99%E9%87%8C%E7%9A%84Protocol%E5%B0%B1%E6%98%AF%E4%B9%8B%E5%89%8D%E6%94%B6%E9%9B%86%E5%88%B0ProtocolManager%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84%E5%85%B7%E6%9C%89Run%E5%87%BD%E6%95%B0%E5%B9%B6%E5%9B%9E%E8%B0%83pm.Handle%28%29+%E7%9A%84%E9%82%A3%E4%BA%9BProtocol%E5%AE%9E%E4%BE%8B%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%91%3C%2Fp%3E+%0A++%3Cp%3E4%E3%80%81%E5%90%AF%E5%8A%A8p2pServer%EF%BC%9A%E3%80%90%E8%B6%85%E7%BA%A7%E9%87%8D%E8%A6%81%E4%B8%8B%E9%9D%A2%E7%BB%86%E8%AE%B2%E3%80%91%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+err+%3A%3D+running.Start%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+convertFileLockError%28err%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E5%E3%80%81%E6%A0%B9%E6%8D%AEp2pServer%E9%80%90%E4%B8%AA%E7%9A%84%E6%8A%8A%E5%90%84%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%EF%BC%9A%E3%80%90%E8%B6%85%E7%BA%A7%E9%87%8D%E8%A6%81%E4%B8%8B%E9%9D%A2%E7%BB%86%E8%AE%B2%E3%80%91%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efor+kind%2C+service+%3A%3D+range+services+%7B%0A%09%09%2F%2F+Start+the+next+service%2C+stopping+all+previous+upon+failure%0A%09%09if+err+%3A%3D+service.Start%28running%29%3B+err+%21%3D+nil+%7B%0A%09%09%09for+_%2C+kind+%3A%3D+range+started+%7B%0A%09%09%09%09services%5Bkind%5D.Stop%28%29%0A%09%09%09%7D%0A%09%09%09running.Stop%28%29%0A%0A%09%09%09return+err%0A%09%09%7D%0A%09%09%2F%2F+Mark+the+service+started+for+potential+cleanup%0A%09%09started+%3D+append%28started%2C+kind%29%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E6%E3%80%81%E5%90%AF%E5%8A%A8RPC%E6%9C%8D%E5%8A%A1%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%E9%87%8C%E9%9D%A2%E5%88%86%E5%88%AB%E5%AF%B9%E5%BA%94%E7%9D%80http%E3%80%81ws%E7%AD%89%E7%AD%89rpc%E6%9C%8D%E5%8A%A1%E7%9A%84api%E7%AD%89%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+err+%3A%3D+n.startRPC%28services%29%3B+err+%21%3D+nil+%7B%0A%09%09for+_%2C+service+%3A%3D+range+services+%7B%0A%09%09%09service.Stop%28%29%0A%09%09%7D%0A%09%09running.Stop%28%29%0A%09%09return+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch2%3E%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%E5%90%AF%E5%8A%A8p2pServer%3C%2Fspan%3E%EF%BC%9A%3C%2Fh2%3E+%0A++%3Cp%3E1%E3%80%81%E6%A0%B9%E6%8D%AE%E9%9C%80%E8%A6%81%E5%AE%9A%E4%B9%89%E5%BA%95%E5%B1%82%E5%8D%8F%E8%AE%AE%E4%BC%A0%E8%BE%93%E5%AE%9E%E7%8E%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+srv.newTransport+%3D%3D+nil+%7B%0A%09%09srv.newTransport+%3D+newRLPX%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E2%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E5%A4%A7%E5%A0%86%E9%80%9A%E9%81%93%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Esrv.quit+%3D+make%28chan+struct%7B%7D%29%0Asrv.addpeer+%3D+make%28chan+*conn%29%0Asrv.delpeer+%3D+make%28chan+peerDrop%29%0Asrv.posthandshake+%3D+make%28chan+*conn%29%0Asrv.addstatic+%3D+make%28chan+*discover.Node%29%0Asrv.removestatic+%3D+make%28chan+*discover.Node%29%0Asrv.peerOp+%3D+make%28chan+peerOpFunc%29%0Asrv.peerOpDone+%3D+make%28chan+struct%7B%7D%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%85%B6%E4%B8%AD%E6%88%91%E4%BB%AC%E4%B8%BB%E8%A6%81%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%EF%BC%9A%3Cstrong%3Esrv.posthandshake%3C%2Fstrong%3E+%E5%92%8C%26nbsp%3B%3Cstrong%3E%26nbsp%3Bsrv.addpeer%3C%2Fstrong%3E+%E8%BF%99%E4%B8%A4%E4%B8%AA%E9%80%9A%E9%81%93%E3%80%82%E3%80%90%3Cstrong%3E%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E4%B8%A4%E4%B8%AA%E9%80%9A%E9%81%93%3C%2Fstrong%3E%E3%80%91%3C%2Fp%3E+%0A++%3Cp%3E3%E3%80%81nat%E8%AE%B0%E5%BD%95UDP%E7%9A%84%E5%86%85%E5%A4%96%E7%BD%91%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+srv.NAT+%21%3D+nil+%7B%0A%09%09%09if+%21realaddr.IP.IsLoopback%28%29+%7B%0A%09%09%09%09go+nat.Map%28srv.NAT%2C+srv.quit%2C+%22udp%22%2C+realaddr.Port%2C+realaddr.Port%2C+%22ethereum+discovery%22%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+TODO%3A+react+to+external+IP+changes+over+time.%0A%09%09%09if+ext%2C+err+%3A%3D+srv.NAT.ExternalIP%28%29%3B+err+%3D%3D+nil+%7B%0A%09%09%09%09realaddr+%3D+%26amp%3Bnet.UDPAddr%7BIP%3A+ext%2C+Port%3A+realaddr.Port%7D%0A%09%09%09%7D%0A%09%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E4%E3%80%81%3Cstrong%3E%E5%90%AF%E5%8A%A8UDP%3C%2Fstrong%3E%EF%BC%9A%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E9%83%A8%E5%88%86%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%BE%88%E9%87%8D%E8%A6%81%EF%BC%8C%E4%B8%8B%E9%9D%A2%E7%BB%86%E8%AE%B2%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+%21srv.NoDiscovery+%7B%0A%09%09cfg+%3A%3D+discover.Config%7B%0A%09%09%09PrivateKey%3A+++srv.PrivateKey%2C%0A%09%09%09AnnounceAddr%3A+realaddr%2C%0A%09%09%09NodeDBPath%3A+++srv.NodeDatabase%2C%0A%09%09%09NetRestrict%3A++srv.NetRestrict%2C%0A%09%09%09Bootnodes%3A++++srv.BootstrapNodes%2C%0A%09%09%09Unhandled%3A++++unhandled%2C%0A%09%09%7D%0A%09%09ntab%2C+err+%3A%3D+discover.ListenUDP%28conn%2C+cfg%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09srv.ntab+%3D+ntab%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E5%E3%80%81%E5%8A%A0%E8%BD%BD%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E4%B8%AD%E7%9A%84%E8%BF%9C%E7%AB%AFpeer%E7%9A%84%E5%88%9D%E5%A7%8B%E9%9B%86%E3%80%90%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%2F%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%E3%80%91%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Edialer+%3A%3D+newDialState%28srv.StaticNodes%2C+srv.BootstrapNodes%2C+srv.ntab%2C+dynPeers%2C+srv.NetRestrict%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E6%E3%80%81%E5%90%AF%E5%8A%A8TCP%EF%BC%9A%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E9%83%A8%E5%88%86%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%BE%88%E9%87%8D%E8%A6%81%EF%BC%8C%E4%B8%8B%E9%9D%A2%E7%BB%86%E8%AE%B2%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+listen%2Fdial%0A%09if+srv.ListenAddr+%21%3D+%22%22+%7B%0A%09%09if+err+%3A%3D+srv.startListening%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E7%E3%80%81%E6%8A%8Ap2p%E7%9A%84%E6%9C%8D%E5%8A%A1run%E8%B5%B7%E6%9D%A5+%E3%80%90%E6%A0%B9%E6%8D%AE%E5%88%9D%E5%A7%8B%E9%9B%86%E3%80%91%E3%80%90%E6%B3%A8%E6%84%8F%E3%80%91%E8%AF%B7%E8%AE%B0%E4%BD%8F%E8%BF%99%E9%83%A8%E5%88%86%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%BE%88%E9%87%8D%E8%A6%81%EF%BC%8C%E4%B8%8B%E9%9D%A2%E7%BB%86%E8%AE%B2%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Ego+srv.run%28dialer%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3%3E%3Cspan+style%3D%22color%3A%23e579b6%3B%22%3EUDP%E5%90%AF%E5%8A%A8%3C%2Fspan%3E%EF%BC%9A%3C%2Fh3%3E+%0A++%3Cp%3E%E5%90%AF%E5%8A%A8UDP%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%85%B6%E5%AE%9E%E6%98%AF%E5%81%9A%E4%BA%86%E5%BE%88%E5%A4%9A%E4%BB%B6%E4%BA%8B%E7%9A%84%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAUDP%E5%AE%9E%E4%BE%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eudp+%3A%3D+%26amp%3Budp%7B%0A%09%09conn%3A++++++++c%2C%0A%09%09priv%3A++++++++cfg.PrivateKey%2C%0A%09%09netrestrict%3A+cfg.NetRestrict%2C%0A%09%09closing%3A+++++make%28chan+struct%7B%7D%29%2C%0A%09%09gotreply%3A++++make%28chan+reply%29%2C%0A%09%09addpending%3A++make%28chan+*pending%29%2C%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E2%E3%80%81%E5%88%9B%E5%BB%BATable%E5%AE%9E%E4%BE%8B%EF%BC%9A%EF%BC%88%E4%B8%80%E4%B8%AA%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8k-%E6%A1%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%EF%BC%89%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Etab%2C+err+%3A%3D+newTable%28udp%2C+PubkeyID%28%26amp%3Bcfg.PrivateKey.PublicKey%29%2C+realaddr%2C+cfg.NodeDBPath%2C+cfg.Bootnodes%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%9C%A8%E5%88%9B%E5%BB%BA%E8%BF%99%E4%B8%AAtable%E5%AE%9E%E4%BE%8B%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E5%88%86%E5%88%AB%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3Ea%E3%80%81%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%BA%86%E4%B8%80%E4%B8%AA%E6%93%8D%E4%BD%9ClvlDB%E7%9A%84%E5%AE%9E%E4%BE%8B%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Edb%2C+err+%3A%3D+newNodeDB%28nodeDBPath%2C+nodeDBVersion%2C+ourID%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Eb%E3%80%81%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%80%E4%B8%AAtable%E5%AF%B9%E8%B1%A1%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Etab+%3A%3D+%26amp%3BTable%7B%0A%09%09net%3A++++++++t%2C%0A%09%09db%3A+++++++++db%2C%0A%09%09self%3A+++++++NewNode%28ourID%2C+ourAddr.IP%2C+uint16%28ourAddr.Port%29%2C+uint16%28ourAddr.Port%29%29%2C%0A%09%09refreshReq%3A+make%28chan+chan+struct%7B%7D%29%2C%0A%09%09initDone%3A+++make%28chan+struct%7B%7D%29%2C%0A%09%09closeReq%3A+++make%28chan+struct%7B%7D%29%2C%0A%09%09closed%3A+++++make%28chan+struct%7B%7D%29%2C%0A%09%09rand%3A+++++++mrand.New%28mrand.NewSource%280%29%29%2C%0A%09%09ips%3A++++++++netutil.DistinctNetSet%7BSubnet%3A+tableSubnet%2C+Limit%3A+tableIPLimit%7D%2C%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Ec%E3%80%81%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF%E5%88%B0%E6%A1%B6%E7%9A%84tab.nursery%E6%95%B0%E7%BB%84%E4%B8%AD%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eif+err+%3A%3D+tab.setFallbackNodes%28bootnodes%29%3B+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Ed%E3%80%81%E5%8A%A0%E8%BD%BD%E9%83%A8%E5%88%86%E9%9A%8F%E6%9C%BA%E7%9A%84%E8%8A%82%E7%82%B9ID%E5%8F%8A%E6%89%80%E6%9C%89%E7%9A%84%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9Id%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Etab.seedRand%28%29%0Atab.loadSeedNodes%28%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Ee%E3%80%81%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%E5%88%B7%E6%A1%B6%E9%80%BB%E8%BE%91%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%09go+tab.loop%28%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%80%8C%E5%BC%82%E6%AD%A5%E5%88%B7%E6%A1%B6%E4%B8%AD%E5%8F%88%E5%88%86%E4%B8%BA%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%E3%80%90%E2%85%A0%E3%80%91%E6%AF%8F%E9%9A%9410%E7%A7%92%E9%92%9F%E5%88%B7%E5%BF%83%E8%B7%B3%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28tab+*Table%29+doRevalidate%28done+chan%26lt%3B-+struct%7B%7D%29+%7B%0A%09defer+func%28%29+%7B+done+%26lt%3B-+struct%7B%7D%7B%7D+%7D%28%29%0A%0A%09last%2C+bi+%3A%3D+tab.nodeToRevalidate%28%29%0A%09if+last+%3D%3D+nil+%7B%0A%09%09%2F%2F+No+non-empty+bucket+found.%0A%09%09return%0A%09%7D%0A%0A%09%2F%2F+Ping+the+selected+node+and+wait+for+a+pong.%0A%09err+%3A%3D+tab.net.ping%28last.ID%2C+last.addr%28%29%29%0A%0A%09tab.mutex.Lock%28%29%0A%09defer+tab.mutex.Unlock%28%29%0A%09b+%3A%3D+tab.buckets%5Bbi%5D%0A%09if+err+%3D%3D+nil+%7B%0A%09%09%2F%2F+The+node+responded%2C+move+it+to+the+front.%0A%09%09log.Trace%28%22Revalidated+node%22%2C+%22b%22%2C+bi%2C+%22id%22%2C+last.ID%29%0A%09%09b.bump%28last%29%0A%09%09return%0A%09%7D%0A%09%2F%2F+No+reply+received%2C+pick+a+replacement+or+delete+the+node+if+there+aren%27t%0A%09%2F%2F+any+replacements.%0A%09if+r+%3A%3D+tab.replace%28b%2C+last%29%3B+r+%21%3D+nil+%7B%0A%09%09log.Trace%28%22Replaced+dead+node%22%2C+%22b%22%2C+bi%2C+%22id%22%2C+last.ID%2C+%22ip%22%2C+last.IP%2C+%22r%22%2C+r.ID%2C+%22rip%22%2C+r.IP%29%0A%09%7D+else+%7B%0A%09%09log.Trace%28%22Removed+dead+node%22%2C+%22b%22%2C+bi%2C+%22id%22%2C+last.ID%2C+%22ip%22%2C+last.IP%29%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%85%88%E9%9A%8F%E6%9C%BA%E7%9A%84%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AA%E6%A1%B6%E5%B9%B6%E6%8B%BF%E5%87%BA%E5%AE%83%E7%9A%84entries%E9%98%9F%E5%88%97%E7%9A%84%E5%B0%BE%E5%85%83%E7%B4%A0%E5%8F%91%E8%B5%B7ping%E8%AF%B7%E6%B1%82%E3%80%82%E5%A6%82%E6%9E%9Cping%E6%88%90%E5%8A%9F%EF%BC%8C%E5%88%99%E6%8A%8A%E8%AF%A5%E5%85%83%E7%B4%A0%E7%A7%BB%E5%88%B0entries%E9%98%9F%E5%88%97%E5%A4%B4%EF%BC%9B%E5%90%A6%E5%88%99%EF%BC%8C%E5%88%A0%E9%99%A4%E8%AF%A5%E5%85%83%E7%B4%A0%EF%BC%8C%E5%B9%B6%E4%BB%8Ereplacements%E9%98%9F%E5%88%97%E9%9A%8F%E5%8D%B3%E4%B8%80%E4%B8%AA%E5%85%83%E7%B4%A0%E6%94%BE%E7%BD%AEentires%E9%98%9F%E5%88%97%E5%B0%BE%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E3%80%90%E2%85%A1%E3%80%91%E6%AF%8F%E9%9A%9430%E7%A7%92%E5%88%B7%E6%A1%B6%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28tab+*Table%29+doRefresh%28done+chan+struct%7B%7D%29+%7B%0A%09defer+close%28done%29%0A%0A%09%2F%2F+Load+nodes+from+the+database+and+insert%0A%09%2F%2F+them.+This+should+yield+a+few+previously+seen+nodes+that+are%0A%09%2F%2F+%28hopefully%29+still+alive.%0A%09tab.loadSeedNodes%28%29%0A%0A%09%2F%2F+Run+self+lookup+to+discover+new+neighbor+nodes.%0A%09tab.lookup%28tab.self.ID%2C+false%29%0A%0A%09%2F%2F+The+Kademlia+paper+specifies+that+the+bucket+refresh+should%0A%09%2F%2F+perform+a+lookup+in+the+least+recently+used+bucket.+We+cannot%0A%09%2F%2F+adhere+to+this+because+the+findnode+target+is+a+512bit+value%0A%09%2F%2F+%28not+hash-sized%29+and+it+is+not+easily+possible+to+generate+a%0A%09%2F%2F+sha3+preimage+that+falls+into+a+chosen+bucket.%0A%09%2F%2F+We+perform+a+few+lookups+with+a+random+target+instead.%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+3%3B+i%2B%2B+%7B%0A%09%09var+target+NodeID%0A%09%09crand.Read%28target%5B%3A%5D%29%0A%09%09tab.lookup%28target%2C+false%29%0A%09%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BA%EF%BC%8C%E5%85%88%E5%8A%A0%E8%BD%BD%E4%B8%80%E6%B3%A2%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E4%BF%A1%E6%81%AF%E5%85%88%E5%8E%BB%E5%88%B7%E4%B8%80%E6%B3%A2%E6%A1%B6%E6%8B%89%E5%9B%9E%E6%8D%AE%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E7%9A%84%E9%82%BB%E5%B1%85%E8%8A%82%E7%82%B9%EF%BC%9B%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%E7%84%B6%E5%90%8E+for+3+%E6%AC%A1%E5%BE%AA%E7%8E%AF%EF%BC%8C%E6%AF%8F%E6%AC%A1%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E9%9A%8F%E6%9C%BAnodeID%E5%8D%B3%EF%BC%9Atarget%EF%BC%8C%E5%86%8D%E6%A0%B9%E6%8D%AEtarget%E5%8E%BB%E5%88%B7%E6%A1%B6%3C%2Fspan%3E%E6%8B%89%E5%9B%9E%E8%B7%9D%E9%9A%8F%E6%9C%BAtarget%E8%8A%82%E7%82%B9%E7%9A%84%E9%82%BB%E5%B1%85%E8%8A%82%E7%82%B9%E3%80%82%E3%80%90%E5%85%B6%E4%B8%AD%E5%88%B7%E6%A1%B6%E5%9D%87%E6%98%AF%E8%B0%83%E7%94%A8%E4%BA%86+tab.lookup%28...%29+%E5%87%BD%E6%95%B0%E3%80%91%3C%2Fp%3E+%0A++%3Cp%3E3%E3%80%81%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%26nbsp%3B%26nbsp%3Bgo+udp.loop%28%29+%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%E5%9C%A8%E5%BA%95%E5%B1%82%E4%B8%BB%E8%A6%81%3Cstrong%3E%E7%BB%B4%E6%8A%A4%E4%B8%80%E4%B8%AA+plist+%E7%9A%84pending%E4%BF%A1%E6%81%AF%E9%98%9F%E5%88%97%3C%2Fstrong%3E+%EF%BC%8C%E9%80%9A%E8%BF%87%E4%B8%8B%E9%9D%A2%E4%B8%A4%E4%B8%AA%E6%93%8D%E4%BD%9C%E6%9D%A5%E7%BB%B4%E6%8A%A4%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E7%9B%91%E5%90%AC+p+%3A%3D+%26lt%3B-t.addpending+%E9%80%9A%E9%81%93%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E7%9B%91%E5%90%AC+r+%3A%3D+%26lt%3B-t.gotreply+%E9%80%9A%E9%81%93%26nbsp%3B%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E4%BB%A5%E4%B8%8A%E4%B8%A4%E4%B8%AA%E9%80%9A%E9%81%93%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%E5%9D%87%E7%94%B1%E4%B8%8B%E9%9D%A2%E7%AC%AC4%E7%82%B9%E7%9A%84packet%E7%9A%84%E5%9B%9E%E5%BA%94%E5%AE%9E%E7%8E%B0%E4%B8%AD%E5%86%99%E5%85%A5%EF%BC%9B%E5%9B%9E%E5%BA%94%E5%AE%9E%E7%8E%B0%E5%88%86%E5%88%AB%E4%B8%BA+%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%3Cstrong%3Eneighbors+%3C%2Fstrong%3E%3C%2Fspan%3E%E5%92%8C%3Cspan+style%3D%22color%3A%237c79e5%3B%22%3E%3Cstrong%3Epong%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E4%E3%80%81%E5%BC%82%E6%AD%A5%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%26nbsp%3Bgo+udp.readLoop%28...%29+%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%E6%AD%BB%E5%BE%AA%E7%8E%AF%E6%8E%A5%E6%94%B6+UDP+%E6%95%B0%E6%8D%AE%E5%8C%85%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3Et.conn.ReadFromUDP%28buf%29%3C%2Fstrong%3E+%E5%92%8C%26nbsp%3B%3Cstrong%3Et.handlePacket%28...%29%3C%2Fstrong%3E%E3%80%82%E5%85%B6%E4%B8%AD%3Cstrong%3Et.handlePacket%28...%29%3C%2Fstrong%3E%E5%BA%95%E5%B1%82%E6%98%AF%E8%B0%83%E7%94%A8%E4%BA%86packet%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%88%86%E5%88%AB%E6%9C%89%E5%9B%9B%E7%A7%8D%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%8D%B3%EF%BC%9Aping%E3%80%81pong%E3%80%81findnode%E3%80%81neighbors%E3%80%82%E5%AF%B9%E4%BA%8Epong%E5%92%8Cneighbors+%E4%BC%9A%E5%BE%80+%E7%AC%AC3%E7%82%B9%E7%9A%84%E9%82%A3%E4%B8%A4%E4%B8%AA%E9%80%9A%E9%81%93%E5%86%99%E5%85%A5%E4%BF%A1%E6%81%AF%E3%80%82%3C%2Fp%3E+%0A++%3Ch3%3E%3Cspan+style%3D%22color%3A%23e579b6%3B%22%3ETCP%E5%90%AF%E5%8A%A8%3C%2Fspan%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%EF%BC%9A%3C%2Fspan%3E%3C%2Fh3%3E+%0A++%3Ch3%3E%E4%B8%BB%E8%A6%81%E6%9C%89%EF%BC%9A%E5%90%AF%E5%8A%A8TCP%E7%9A%84Server+%E7%AB%AF%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E5%8F%AA%E6%9C%89%E6%9C%89%E8%BF%9C%E7%AB%AF%E7%9A%84client%E4%B8%8E%E6%9C%AC%E5%9C%B0%E7%9A%84server%E5%8F%91%E7%94%9F%E8%BF%9E%E6%8E%A5%EF%BC%8C%E5%B0%B1%E6%8A%8A%E8%BF%9E%E6%8E%A5%E5%AE%9E%E4%BE%8Bconn%E5%86%99%E5%85%A5%E5%90%AF%E5%8A%A8p2pServer%E4%B9%8B%E5%88%9D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E9%82%A3%E5%A0%86%E9%80%9A%E9%81%93%E4%B8%AD%E7%9A%84+%3C%2Fstrong%3E%3C%2Fspan%3E%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%3Cstrong%3Esrv.addpeer%3C%2Fstrong%3E%3C%2Fspan%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%26nbsp%3B%E4%B8%8E%26nbsp%3B%3C%2Fstrong%3E%3C%2Fspan%3E%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%3Cstrong%3Esrv.posthandshake%3C%2Fstrong%3E%3C%2Fspan%3E+%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E+%E9%80%9A%E9%81%93%3C%2Fstrong%3E%3C%2Fspan%3E%26nbsp%3B%E3%80%82%3C%2Fh3%3E+%0A++%3Ch2%3E%E3%80%90%E6%B3%A8%E6%84%8F%EF%BC%9A%E4%BD%BF%E7%94%A8k-bucket%E4%B8%AD%E5%88%9D%E8%AF%86%E9%9B%86%E7%9A%84%E8%8A%82%E7%82%B9%E5%B9%B6%E5%AF%B9%E8%BF%99%E4%BA%9B%E8%8A%82%E7%82%B9%E5%8F%91%E8%B5%B7TCP+%E7%9A%84client%E7%AB%AF%E7%9A%84%E8%BF%9E%E6%8E%A5%E6%98%AF%E5%9C%A8%E4%B8%8B%E9%9D%A2%E6%A0%B9%E6%8D%AE%E5%88%9D%E5%A7%8B%E9%9B%86%E5%8E%BBserver.run%E7%9A%84%E6%97%B6%E5%80%99%E9%82%A3%E9%87%8C%E9%9D%A2%E5%81%9A%E7%9A%84%E3%80%91%3C%2Fh2%3E+%0A++%3Cp%3E%E7%BB%88%E4%BA%8E%E5%88%B0%E4%BA%86%E4%BB%8A%E5%A4%A9%E7%9A%84%E9%87%8D%E5%A4%B4%E6%88%8F%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch2%3E%3Cspan+style%3D%22color%3A%23e579b6%3B%22%3E%3Cstrong%3Ego+srv.run%28dialer%29%3C%2Fstrong%3E%3C%2Fspan%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%EF%BC%9A%3C%2Fstrong%3E%3C%2Fspan%3E%3C%2Fh2%3E+%0A++%3Cp%3E%E6%A0%B9%E6%8D%AE%E5%88%9D%E5%A7%8B%E9%9B%86%EF%BC%88%E5%8D%B3%E9%9D%99%E6%80%81%E8%8A%82%E7%82%B9%E5%8F%8A%E5%90%AF%E5%8A%A8%E8%8A%82%E7%82%B9%EF%BC%89%E7%9A%84%E8%8A%82%E7%82%B9%E5%8E%BB%E6%8A%8Ap2p%E7%9A%84%E6%9C%8D%E5%8A%A1run%E8%B5%B7%E6%9D%A5%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%85%88%E5%88%9B%E5%BB%BA%E5%90%84%E7%A7%8D%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%E5%8F%8A%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0%E7%9A%84%E4%BB%BB%E5%8A%A1%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+starts+until+max+number+of+active+tasks+is+satisfied%0A%09startTasks+%3A%3D+func%28ts+%5B%5Dtask%29+%28rest+%5B%5Dtask%29+%7B%0A%09%09i+%3A%3D+0%0A%09%09for+%3B+len%28runningTasks%29+%26lt%3B+maxActiveDialTasks+%26amp%3B%26amp%3B+i+%26lt%3B+len%28ts%29%3B+i%2B%2B+%7B%0A%09%09%09t+%3A%3D+ts%5Bi%5D%0A%09%09%09srv.log.Trace%28%22New+dial+task%22%2C+%22task%22%2C+t%29%0A%09%09%09go+func%28%29+%7B+t.Do%28srv%29%3B+taskdone+%26lt%3B-+t+%7D%28%29%0A%09%09%09runningTasks+%3D+append%28runningTasks%2C+t%29%0A%09%09%7D%0A%09%09return+ts%5Bi%3A%5D%0A%09%7D%0A%09scheduleTasks+%3A%3D+func%28%29+%7B%0A%09%09%2F%2F+Start+from+queue+first.%0A%09%09queuedTasks+%3D+append%28queuedTasks%5B%3A0%5D%2C+startTasks%28queuedTasks%29...%29%0A%09%09%2F%2F+Query+dialer+for+new+tasks+and+start+as+many+as+possible+now.%0A%09%09if+len%28runningTasks%29+%26lt%3B+maxActiveDialTasks+%7B%0A%09%09%09nt+%3A%3D+dialstate.newTasks%28len%28runningTasks%29%2Blen%28queuedTasks%29%2C+peers%2C+time.Now%28%29%29%0A%09%09%09queuedTasks+%3D+append%28queuedTasks%2C+startTasks%28nt%29...%29%0A%09%09%7D%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%AF%B7%E6%B3%A8%E6%84%8F%E8%BF%99%E9%87%8C%E9%9D%A2%E7%9A%84%26nbsp%3Bt.Do%28srv%29%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%96%E6%9C%89%E5%87%A0%E4%B8%AA%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%9C%80%E4%B8%BB%E8%A6%81%E7%9A%84%E6%98%AF+%E8%B4%9F%E8%B4%A3%E5%90%91%E5%88%9D%E5%A7%8B%E9%9B%86%E5%8F%91%E8%B5%B7TCPclient%E8%BF%9E%E6%8E%A5%E7%9A%84+dialTask.Do%28+%29+%E5%92%8C+%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0%E7%9A%84+discoverTask.Do%28+%29%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5dialTask.Do%28+%29+%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E4%BC%9A%E5%85%88%E5%8E%BB%E8%BF%9E%E6%8E%A5%E5%85%A5%E5%8F%82%E7%9A%84%E5%88%9D%E5%A7%8B%E9%9B%86%E8%8A%82%E7%82%B9%EF%BC%8Ct.dial%28srv%2C+t.dest%29%EF%BC%9B%E5%A6%82%E6%9E%9C%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%B0%B1%E4%BC%9A%E6%A0%B9%E6%8D%AE%E8%AF%A5%E8%8A%82%E7%82%B9%E7%9A%84ID%E5%8E%BB%E5%81%9A%E5%88%B7%E6%A1%B6%E5%8A%A8%E4%BD%9C%EF%BC%9B%E5%8D%B3%E9%A6%96%E5%85%88%E5%8E%BB%E8%A7%A3%E6%9E%90%E8%AF%A5%E8%8A%82%E7%82%B9%26nbsp%3Bt.resolve%28...%29+%E5%9C%A8%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E9%87%8C%E9%9D%A2%E5%86%8D%E8%B0%83%E7%94%A8%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%88%B7%E6%A1%B6%26nbsp%3B%26nbsp%3Btab.lookup%28...%29%EF%BC%9B%E5%88%B7%E5%AE%8C%E6%A1%B6%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%86%8D%E6%8A%BD%E5%87%BA%E4%B8%80%E9%83%A8%E5%88%86%E8%8A%82%E7%82%B9%E9%9B%86%E5%86%8D%E5%8E%BB%E8%B0%83%E7%94%A8%E8%BF%9E%E6%8E%A5t.dial%28srv%2C+t.dest%29%E3%80%90%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E8%BF%99%E9%87%8C%E7%9A%84%E8%B0%83%E7%94%A8%E8%BF%9E%E6%8E%A5%EF%BC%8C%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E5%90%91%E4%BB%8E%E6%A1%B6%E4%B8%AD%E6%8A%BD%E5%87%BA%E7%9A%84%E8%8A%82%E7%82%B9%E9%9B%86%E5%8F%91%E8%B5%B7TCP+client%E7%9A%84%E8%BF%9E%E6%8E%A5%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%91%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0discoverTask.Do%28+%29%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E5%88%99%E6%98%AF%E7%9B%B4%E6%8E%A5%E6%A0%B9%E6%8D%AE%E5%88%9D%E5%A7%8B%E9%9B%86%E5%8E%BB%E5%81%9A%E5%88%B7%E6%A1%B6%E5%8A%A8%E4%BD%9C%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E2%E3%80%81%E5%A6%82%E6%9E%9C%E7%9B%91%E5%90%AC%E5%88%B0+%E4%B9%8B%E5%89%8D%E6%89%80%E8%AF%B4%E7%9A%84%26nbsp%3Bc+%3A%3D+%26lt%3B-srv.addpeer%E9%80%9A%E9%81%93+%E6%9C%89%E6%96%B0%E8%BF%9E%E6%8E%A5%E5%8A%A0%E5%85%A5%E7%9A%84%E8%AF%9D%E5%B0%B1%E6%A0%B9%E6%8D%AE%E8%AF%A5conn%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AApeer%EF%BC%9Ap+%3A%3D+newPeer%28c%2C+srv.Protocols%29%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+height%3D%22562%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20181014193736257%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+width%3D%22700%22%3E%3C%2Fp%3E+%0A++%3Cp%3E3%E3%80%81%E6%A0%B9%E6%8D%AE%E8%BF%99%E4%B8%AA%E6%96%B0%E5%88%9B%E5%BB%BA%E7%9A%84peer%E5%8E%BBrun%E7%9B%B8%E5%85%B3%E5%8A%A8%E4%BD%9C%EF%BC%9A%E3%80%90%3Cstrong%3E%E8%BF%99%E4%B8%80%E6%AD%A5%E7%9B%B8%E5%BD%93%E9%87%8D%E8%A6%81%3C%2Fstrong%3E%E3%80%91%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+height%3D%22542%22+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20181014193842752%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI1ODcwNjMz%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+width%3D%22722%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%E5%9C%A8%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E9%87%8C%E9%9D%A2%E5%86%8D%E5%8E%BB%E6%8A%8A%E4%B9%8B%E5%89%8D%E4%BB%8EService%E4%B8%AD%E6%94%B6%E9%9B%86%E8%B5%B7%E6%9D%A5%E7%9A%84Protocol%E5%88%B0p2pServer%E4%B8%AD%E7%9A%84protocol%E7%BB%99%E7%9C%9F%E6%AD%A3run%E8%B5%B7%E6%9D%A5%EF%BC%8C%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E8%B0%83%E7%94%A8%E4%BA%86+protocol%E7%9A%84Run%E6%96%B9%E6%B3%95%E3%80%90%3Cstrong%3E%E8%BF%98%E8%AE%B0%E7%9A%84%E8%BF%99%E9%87%8C%E9%9D%A2%E5%AF%B9ProtocolManager%E7%9A%84Handle%E6%96%B9%E6%B3%95%E5%81%9A%E4%BA%86%E5%9B%9E%E8%B0%83%E4%B9%88%EF%BC%9F%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96node%E8%8A%82%E7%82%B9%E9%83%A8%E5%88%86%E6%9C%89%E8%AE%B2%3C%2Fstrong%3E%E3%80%91%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E9%87%8C%E6%89%8D%E6%98%AF%E7%9C%9F%E6%AD%A3%E5%AF%B9pm.Handle%28%29+%E6%9C%89%E4%BD%9C%E7%94%A8%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%81%9A%E7%9A%84%E7%9B%AE%E7%9A%84%E5%B0%B1%E6%98%AF%EF%BC%8C%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%3Cstrong%3E%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%E5%85%88%E5%AE%9A%E4%B9%89%E4%BA%86%E4%BA%A4%E7%BB%99%E8%BF%9C%E7%82%B9%E8%8A%82%E7%82%B9%E5%8F%91%E8%B5%B7%E5%9B%9E%E8%B0%83%E6%9C%AC%E8%8A%82%E7%82%B9%E7%9A%84%E6%96%B9%E6%B3%95%E8%A2%AB%E5%86%85%E7%BD%AE%E5%9C%A8%E4%BA%86Protocol%E4%B8%AD%EF%BC%8C%E8%80%8C%E6%AF%8F%E5%BD%93%E6%96%B0%E7%9A%84%E8%BF%9C%E7%AB%AF%E8%8A%82%E7%82%B9%EF%BC%88+client+%E7%AB%AF%EF%BC%89%E5%92%8C%E6%9C%AC%E8%8A%82%E7%82%B9+%EF%BC%88Server%E7%AB%AF%EF%BC%89%E8%BF%9E%E6%8E%A5%E6%97%B6%EF%BC%8C%E5%B0%B1%E4%BC%9A%E5%AF%B9%E6%9C%AC%E8%8A%82%E7%82%B9%E5%8F%91%E8%B5%B7%E5%9B%9E%E8%B0%83%3C%2Fstrong%3E%3C%2Fspan%3E%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Cstrong%3E%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%E5%90%AF%E5%8A%A8%E5%90%84%E9%A1%B9%E6%9C%8D%E5%8A%A1%EF%BC%88%E5%90%AF%E5%8A%A8Service%EF%BC%89%EF%BC%9A%3C%2Fspan%3E%3C%2Fstrong%3E%3C%2Fh2%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E6%88%91%E4%BB%AC%E5%8F%AA%E6%89%93%E7%AE%97%E8%AE%B2%E5%90%AF%E5%8A%A8Ethereum%E6%9C%8D%E5%8A%A1%E9%83%A8%E5%88%86%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%92%8Ctx%E3%80%81Block%E5%90%8C%E6%AD%A5%E7%9B%B8%E5%85%B3%E7%9A%84%E9%83%BD%E6%98%AF%E5%86%99%E5%9C%A8%E8%BF%99%E9%87%8C%E7%9A%84%EF%BC%8C%E5%85%88%E4%B8%8A%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28s+*Ethereum%29+Start%28srvr+*p2p.Server%29+error+%7B%0A%09%2F%2F+Start+the+bloom+bits+servicing+goroutines%0A%09s.startBloomHandlers%28%29%0A%0A%09%2F%2F+Start+the+RPC+service%0A%09s.netRPCService+%3D+ethapi.NewPublicNetAPI%28srvr%2C+s.NetVersion%28%29%29%0A%0A%09%2F%2F+Figure+out+a+max+peers+count+based+on+the+server+limits%0A%09maxPeers+%3A%3D+srvr.MaxPeers%0A%09if+s.config.LightServ+%26gt%3B+0+%7B%0A%09%09if+s.config.LightPeers+%26gt%3B%3D+srvr.MaxPeers+%7B%0A%09%09%09return+fmt.Errorf%28%22invalid+peer+config%3A+light+peer+count+%28%25d%29+%26gt%3B%3D+total+peer+count+%28%25d%29%22%2C+s.config.LightPeers%2C+srvr.MaxPeers%29%0A%09%09%7D%0A%09%09maxPeers+-%3D+s.config.LightPeers%0A%09%7D%0A%09%2F%2F+Start+the+networking+layer+and+the+light+server+if+requested%0A%09s.protocolManager.Start%28maxPeers%29%0A%09if+s.lesServer+%21%3D+nil+%7B%0A%09%09s.lesServer.Start%28srvr%29%0A%09%7D%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BA%E6%9D%A5%EF%BC%8C%E5%85%B6%E5%AE%9E%E9%87%8C%E9%9D%A2%E5%81%9A%E4%BA%86%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AARPC%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E3%80%81%E5%90%AF%E5%8A%A8pm%E5%AE%9E%E4%BE%8B%E3%80%90%E8%B6%85%E9%87%8D%E8%A6%81%E3%80%91%E3%80%81%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%E7%9A%84%E8%AF%9D%E8%BF%98%E4%BC%9A%E5%90%AF%E5%8A%A8%E8%BD%BB%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%EF%BC%9B%E5%85%B6%E4%B8%AD%E6%88%91%E4%BB%AC%E4%B8%BB%E8%A6%81%E8%AE%B2%E5%90%AF%E5%8A%A8pm%E5%AE%9E%E4%BE%8B%E9%83%A8%E5%88%86%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28pm+*ProtocolManager%29+Start%28maxPeers+int%29+%7B%0A%09pm.maxPeers+%3D+maxPeers%0A%0A%09%2F%2F+broadcast+transactions%0A%09pm.txsCh+%3D+make%28chan+core.NewTxsEvent%2C+txChanSize%29%0A%09pm.txsSub+%3D+pm.txpool.SubscribeNewTxsEvent%28pm.txsCh%29%0A%09go+pm.txBroadcastLoop%28%29%0A%0A%09%2F%2F+broadcast+mined+blocks%0A%09pm.minedBlockSub+%3D+pm.eventMux.Subscribe%28core.NewMinedBlockEvent%7B%7D%29%0A%09go+pm.minedBroadcastLoop%28%29%0A%0A%09%2F%2F+start+sync+handlers%0A%09go+pm.syncer%28%29%0A%09go+pm.txsyncLoop%28%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E9%87%8C%E5%A4%B4%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E5%85%88%E6%B3%A8%E5%86%8C%E4%BA%86%E4%BA%A4%E6%98%93%E7%9B%91%E5%90%AC%EF%BC%8C%E6%8C%96%E7%9F%BF%E5%8C%BA%E5%9D%97%E7%9B%91%E5%90%AC%EF%BC%8C%E7%84%B6%E5%90%8E%E5%81%9A%E4%BA%86%E5%9B%9B%E4%B8%AA%E5%8D%8F%E7%A8%8B%EF%BC%8C%E5%88%86%E5%88%AB%E6%98%AF%E5%8D%95%E4%B8%AA%E5%B9%BF%E6%92%AD%E4%BA%A4%E6%98%93%E3%80%81%E5%8D%95%E4%B8%AA%E5%B9%BF%E6%92%AD%E5%8C%BA%E5%9D%97%E3%80%81%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E5%8C%BA%E5%9D%97%E3%80%81%E6%89%B9%E9%87%8F%E5%90%8C%E6%AD%A5%E4%BA%A4%E6%98%93%E7%AD%89%E5%9B%9B%E9%83%A8%E5%88%86%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%3Cstrong%3Ego+pm.txBroadcastLoop%28%29%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E6%8A%8A%E7%9B%91%E5%90%AC%E5%88%B0%E7%9A%84%E4%BA%A4%E6%98%93%E5%B9%BF%E6%92%AD%E4%B8%AA%E7%BC%93%E5%AD%98%E5%9C%A8%E6%9C%AC%E5%9C%B0pm%E7%9A%84peerSet%E4%B8%AD%E7%9A%84peer%E5%86%85%E9%83%A8%E7%9A%84%E4%BA%A4%E6%98%93%E9%98%9F%E5%88%97%E4%B8%AD%EF%BC%8C%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E5%81%9A%E4%BA%86%E4%B8%AA%E7%BC%93%E5%AD%98%EF%BC%8C%E5%B9%B6%E6%B2%A1%E6%9C%89%E5%8F%91%E8%B5%B7P2P%EF%BC%8C%E8%80%8C%E7%9C%9F%E6%AD%A3%E5%81%9AP2P%E5%8A%A8%E4%BD%9C%EF%BC%8C%E6%9C%89%E4%B9%8B%E5%89%8D%E6%89%80%E8%AF%B4%E7%9A%84%E5%9C%A8%E6%96%B0%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E6%9C%AC%E5%9C%B0%E6%97%B6%EF%BC%8C%E5%BE%80%E6%9C%AC%E5%9C%B0%E8%8A%82%E7%82%B9%E7%9A%84peerSet%E5%81%9A%E4%BA%86%E6%B3%A8%E5%86%8C%E4%B9%8B%E5%90%8E%E8%B5%B7%E7%9A%84%E4%B8%80%E4%B8%AA%E5%BC%82%E6%AD%A5%E5%8D%8F%E7%A8%8B%E5%AE%9E%E6%97%B6%E7%9A%84%E6%8A%8A%E8%BF%99%E4%B8%80%E6%AD%A5%E7%BC%93%E5%AD%98%E5%9C%A8%E6%9C%AC%E5%9C%B0%E7%9A%84%E4%BF%A1%E6%81%AF%E5%8F%91%E8%B5%B7%E7%9C%9F%E6%AD%A3%E7%9A%84p2p%E5%B9%BF%E6%92%AD%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E2%E3%80%81%3Cstrong%3Ego+pm.minedBroadcastLoop%28%29%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E9%81%93%E7%90%86%E5%92%8C%E7%9C%9F%E6%AD%A3p2p%E7%9A%84%E6%97%B6%E6%9C%BA%E5%92%8C%E4%B8%8A%E8%BF%B0%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%8F%AA%E6%98%AF%E5%BE%80%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E7%9A%84%E6%97%B6%E5%80%99%E5%88%86%E5%88%AB%E5%BE%80%E9%83%A8%E5%88%86peer%E7%BC%93%E5%AD%98%E4%BA%86block%EF%BC%8C%E5%BE%80%E5%85%A8%E9%83%A8peer%E7%BC%93%E5%AD%98%E4%BA%86blockHash%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E3%E3%80%81%3Cstrong%3Ego+pm.syncer%28%29%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E9%9D%A2%E5%85%88%E5%90%AF%E5%8A%A8fetcher%EF%BC%8C%E8%80%8C%E5%90%AF%E5%8A%A8fetcher%E5%85%B6%E5%AE%9E%E6%98%AF%E8%B0%83%E7%94%A8%E4%BA%86%E4%B8%80%E4%B8%AAfetcher%E7%9A%84loop%E5%87%BD%E6%95%B0%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%92%8C%E4%B9%8B%E5%89%8Dpm%E7%9A%84Handle%E4%B8%AD%E5%BA%95%E5%B1%82%E6%AD%BB%E5%BE%AA%E7%8E%AF%E5%A4%84%E7%90%86%E7%9A%84handleMsg%E5%87%BD%E6%95%B0%E7%9B%B8%E8%BE%85%E7%9B%B8%E6%88%90%E3%80%82%E7%84%B6%E5%90%8E%E8%AF%BB%E5%8F%96+pm.newPeerCh+%EF%BC%88%E5%9C%A8+protocol.Run%E4%B8%AD%E7%9A%84manager.newPeerCh+%26lt%3B-+peer+%E5%BE%80%E9%87%8C%E9%9D%A2%E6%94%BE%E5%80%BC%EF%BC%8C%E5%8F%8A%E6%AF%8F%E4%B8%AA%E6%96%B0%E5%8A%A0%E5%85%A5%E7%9A%84peer%E9%83%BD%E4%BC%9A%E8%A7%A6%E5%8F%91%EF%BC%89%E5%B9%B6%E6%A0%B9%E6%8D%AE%26lt%3B-pm.newPeerCh%E6%9C%89%E6%96%B0%E5%8A%A0%E5%85%A5%E8%8A%82%E7%82%B9%E6%97%B6%EF%BC%8C%E5%8E%BB%E5%88%A4%E6%96%AD%E6%9C%AC%E5%9C%B0pm.PeerSet%E4%B8%AD%E7%9A%84%E8%BF%9C%E7%AB%AFpeer%E5%AE%9E%E4%BE%8B%E4%B8%AA%E6%95%B0%E6%98%AF%E5%90%A6+%26gt%3B%3D+5+%E6%88%96%E8%80%85%E6%AF%8F10%E7%A7%92%E9%92%9F+%E8%A7%A6%E5%8F%91%E4%B8%80%E6%AC%A1%26nbsp%3B%26nbsp%3Bgo+pm.synchronise%28pm.peers.BestPeer%28%29%29+%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E9%87%8C%E9%9D%A2%E6%89%8D%E6%98%AF%E4%BD%BF%E7%94%A8%E4%BA%86+downloader+%E5%8E%BB%E5%90%8C%E6%AD%A5%E5%8C%BA%E5%9D%97%E5%B9%B6%E4%B8%94%E4%BC%9A%E5%9C%A8%E5%90%8C%E6%AD%A5%E5%AE%8C%E6%88%90%E5%90%8E%E6%8A%8A%E6%9C%AC%E5%9C%B0Chain%E4%B8%8A%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%9D%97%E7%9A%84hash+%E5%B9%BF%E6%92%AD%E5%88%B0%E5%85%B6%E4%BB%96peer%E7%BC%93%E5%AD%98%E4%B8%AD%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E4%E3%80%81%3Cstrong%3Ego+pm.txsyncLoop%28%29+%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E5%AE%9E%E6%97%B6%E7%9B%91%E5%90%AC%E6%9C%AC%26nbsp%3B%26lt%3B-pm.txsyncCh%E9%80%9A%E9%81%93+%E3%80%90%E5%86%85%E5%AE%B9%E5%9C%A8+pm%E7%9A%84Handle%E5%87%BD%E6%95%B0%E7%9A%84+pm.syncTransactions%28p%29+%E4%B8%AD%E8%A2%AB%E5%86%99%E5%85%A5%E3%80%91%E4%B8%AD%E7%9A%84txsync%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E9%87%8C%E9%9D%A2%E7%9A%84peerId%E5%8E%BB%E5%B9%BF%E6%92%ADtxs%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Cstrong%3E%3Cspan+style%3D%22color%3A%233399ea%3B%22%3E%E5%90%AF%E5%8A%A8RPC%E6%9C%8D%E5%8A%A1%E5%8F%8AAPIS%EF%BC%9A%3C%2Fspan%3E%3C%2Fstrong%3E%3C%2Fh2%3E+%0A++%3Cp%3E%E6%A0%B9%E6%8D%AE%E5%90%84%E9%A1%B9%E6%9C%8D%E5%8A%A1%EF%BC%8C%E9%80%90%E4%B8%AA%E6%8A%8A%E5%AF%B9%E5%BA%94%E7%9A%84RPC-API%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E8%B5%B7%E6%9D%A5%28%E5%A6%82+http%E3%80%81ws%E7%AD%89%E7%AD%89%29%E3%80%82%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Lastly+start+the+configured+RPC+interfaces%0A%09if+err+%3A%3D+n.startRPC%28services%29%3B+err+%21%3D+nil+%7B%0A%09%09for+_%2C+service+%3A%3D+range+services+%7B%0A%09%09%09service.Stop%28%29%0A%09%09%7D%0A%09%09running.Stop%28%29%0A%09%09return+err%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28n+*Node%29+startRPC%28services+map%5Breflect.Type%5DService%29+error+%7B%0A%09%2F%2F+Gather+all+the+possible+APIs+to+surface%0A%09apis+%3A%3D+n.apis%28%29%0A%09for+_%2C+service+%3A%3D+range+services+%7B%0A%09%09apis+%3D+append%28apis%2C+service.APIs%28%29...%29%0A%09%7D%0A%09%2F%2F+Start+the+various+API+endpoints%2C+terminating+all+in+case+of+errors%0A%09if+err+%3A%3D+n.startInProc%28apis%29%3B+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09if+err+%3A%3D+n.startIPC%28apis%29%3B+err+%21%3D+nil+%7B%0A%09%09n.stopInProc%28%29%0A%09%09return+err%0A%09%7D%0A%09if+err+%3A%3D+n.startHTTP%28n.httpEndpoint%2C+apis%2C+n.config.HTTPModules%2C+n.config.HTTPCors%2C+n.config.HTTPVirtualHosts%2C+n.config.HTTPTimeouts%29%3B+err+%21%3D+nil+%7B%0A%09%09n.stopIPC%28%29%0A%09%09n.stopInProc%28%29%0A%09%09return+err%0A%09%7D%0A%09if+err+%3A%3D+n.startWS%28n.wsEndpoint%2C+apis%2C+n.config.WSModules%2C+n.config.WSOrigins%2C+n.config.WSExposeAll%29%3B+err+%21%3D+nil+%7B%0A%09%09n.stopHTTP%28%29%0A%09%09n.stopIPC%28%29%0A%09%09n.stopInProc%28%29%0A%09%09return+err%0A%09%7D%0A%09%2F%2F+All+API+endpoints+started+successfully%0A%09n.rpcAPIs+%3D+apis%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E9%9D%A2%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%85%88%E6%94%B6%E9%9B%86%E5%90%84%E7%A7%8D%E6%9C%8D%E5%8A%A1%E4%B8%8A%E7%9A%84apis%E7%84%B6%E5%90%8E%E5%8E%BB%E5%90%AF%E5%8A%A8%E5%90%84%E7%A7%8DRPC%E6%9C%8D%E5%8A%A1%E3%80%82%3C%2Fp%3E+%0A++%3Ch1%3E%3Cstrong%3E%3Cspan+style%3D%22color%3A%23f33b45%3B%22%3E%E6%80%BB%E7%BB%93%EF%BC%9A%3C%2Fspan%3E%3C%2Fstrong%3E%3C%2Fh1%3E+%0A++%3Ch3%3E%3Cstrong%3E1%E3%80%81%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AF%E5%85%88%E5%9C%A8%E5%88%9D%E5%A7%8B%E5%8C%96node%E4%B8%AD%E5%9B%9E%E5%8E%BB%E5%81%9A%E5%AF%B9Protocol%E7%9A%84%E5%B0%81%E8%A3%85%E5%B9%B6%E4%B8%94%E5%AF%B9%E6%AF%8F%E4%B8%AA%E6%96%B0%E5%8A%A0%E5%85%A5%E6%9C%AC%E5%9C%B0%E7%9A%84%E8%8A%82%E7%82%B9%E8%BF%9B%E8%A1%8C%E5%AF%B9%E6%9C%AC%E8%8A%82%E7%82%B9%E7%9A%84%E5%9B%9E%E8%B0%83%E6%9D%A5%E5%81%9A%E5%88%B0%E5%B9%BF%E6%92%AD%E4%BA%A4%E6%98%93%E5%92%8C%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%80%8C%E8%BF%99%E4%B8%80%E6%AD%A5%E7%AE%97%E6%98%AF%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84%E6%B3%A8%E5%86%8C%E8%80%8C%E5%B7%B2%EF%BC%8C%E8%BF%98%E6%B2%A1%E6%9C%89%E7%9C%9F%E6%AD%A3%E8%B0%83%E7%94%A8%E3%80%82%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Ch3%3E%3Cstrong%3E%E7%84%B6%E5%90%8E%E5%9C%A8node%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%E6%89%8D%E4%BC%9A%E5%8F%91%E8%B5%B7%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%9B%9E%E8%B0%83%E8%B0%83%E7%94%A8%EF%BC%8CUDP%E7%AE%A1%E7%90%86%E4%BA%86%E8%8A%82%E7%82%B9%E5%8F%91%E7%8E%B0%E5%92%8CTable%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%B7%E6%A1%B6%E5%8A%A8%E4%BD%9C%EF%BC%9B%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Ch3%3E%3Cstrong%3E2%E3%80%81TCP%E8%B4%9F%E8%B4%A3%E5%90%AF%E5%8A%A8Server%E7%AB%AF%E5%B9%B6%E6%8A%8A%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%92%8C%E6%9C%AC%E5%9C%B0Server%E7%AB%AF%E8%BF%9E%E6%8E%A5%E7%9A%84conn%E5%B0%81%E8%A3%85%E6%88%90peer%E6%B3%A8%E5%86%8C%E5%88%B0%E6%9C%AC%E5%9C%B0%E4%B8%94%E8%A7%A6%E5%8F%91%E4%B9%8B%E5%89%8D%E7%9A%84handle%E5%9B%9E%E8%B0%83%EF%BC%9BTCP%E8%BF%98%E5%81%9A%E4%BA%86%EF%BC%8C%E6%A0%B9%E6%8D%AEk-bucket%E4%B8%AD%E6%8A%BD%E5%87%BA%E9%83%A8%E5%88%86%E8%8A%82%E7%82%B9%E5%8E%BB%E5%8F%91%E8%B5%B7%E8%BF%9E%E6%8E%A5%28%E8%BF%99%E6%97%B6%E5%80%99%E6%9C%AC%E5%9C%B0node%E7%9B%B8%E5%BD%93%E4%BA%8ETCP+client%29%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%E8%BF%99%E6%A0%B9%E6%8D%AE%E8%AF%A5peerID%E5%81%9A%E5%88%B7%E6%A1%B6%E5%8A%A8%E4%BD%9C%E7%84%B6%E5%90%8E%E5%86%8D%E6%AC%A1%E6%8A%BD%E5%87%BA%E9%83%A8%E5%88%86%E8%8A%82%E7%82%B9%E5%8F%91%E8%B5%B7%E8%BF%9E%E6%8E%A5%E3%80%82%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Ch3%3E3%E3%80%81%E5%90%AF%E5%8A%A8%E4%BA%86service+%E8%BF%99%E6%97%B6%E5%80%99%E4%BC%9A%E5%90%AF%E5%8A%A8pm%E5%8E%BB%E6%8A%8A%E4%BA%A4%E6%98%93%E5%8D%B3%E5%8C%BA%E5%9D%97%E7%BC%93%E5%AD%98%E5%88%B0%E4%B9%8B%E5%89%8D%E6%B3%A8%E5%86%8C%E5%9C%A8%E6%9C%AC%E5%9C%B0%E7%9A%84peer%E4%B8%AD%EF%BC%8C%E4%BA%A4%E7%94%B1Hnadle%E9%82%A3%E8%BE%B9%E5%9C%A8%E6%B3%A8%E5%86%8C%E9%87%8C%E9%9D%A2%E7%9A%84+%E5%BC%82%E6%AD%A5%E5%8D%8F%E7%A8%8B%E5%8E%BB%E5%AE%9E%E6%97%B6%E5%8F%91%E9%80%81P2P%E5%B9%BF%E6%92%AD%E3%80%82%E5%B9%B6%E4%B8%94%E4%BC%9A%E5%90%AF%E5%8A%A8fetcher+%E7%9A%84loop%E5%87%BD%E6%95%B0%E5%92%8C%E4%B9%8B%E5%89%8DHandle%E5%9B%9E%E8%B0%83%E9%87%8C%E9%9D%A2%E7%9A%84+handleMsg%E5%87%BD%E6%95%B0%E5%81%9A%E5%91%BC%E5%BA%94%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%9C%A8%E5%90%8E%E5%8F%B0%E7%9B%B8%E8%BE%85%E7%9B%B8%E6%88%90%E7%9A%84%E5%A4%84%E7%90%86%E4%B8%ADP2P%E7%9A%84%E4%BF%A1%E6%81%AF%E5%BE%80%E6%9D%A5%E3%80%82%E5%B9%B6%E5%90%AF%E5%8A%A8%E4%BA%86Downloader%E4%B8%80%E7%9B%B4%E5%9C%A8%E5%81%9A%E5%90%8C%E6%AD%A5%E3%80%82%3C%2Fh3%3E+%0A++%3Ch3%3E%3Cstrong%3E4%E3%80%81%E5%90%AF%E5%8A%A8%E4%BA%86%E5%90%84%E7%A7%8DRPC%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%B9%B6%E6%B3%A8%E5%86%8C%E4%BA%86%E5%90%84%E7%B1%BBAPIS%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Cp%3E%3Cstrong%3E%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E5%BC%80%E8%AF%B4%E4%B8%80%E8%AF%B4+fetcher%E5%92%8C+downloader%E9%83%A8%E5%88%86%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%9A%EF%BC%88%E5%BE%85%E7%BB%AD...%EF%BC%89%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E4%BB%8A%E5%A4%A9%E5%86%99%E4%BA%86%E4%B8%80%E5%A4%A9%E4%BA%86%E5%85%88%E5%86%99%E5%88%B0%E8%BF%99%E9%87%8C%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%BF%99%E9%87%8C%E9%9D%A2%E7%9A%84%E9%80%BB%E8%BE%91%E5%8F%88%E9%95%BF%E5%8F%88%E4%B8%80%E7%8E%AF%E5%A5%97%E4%B8%80%E7%8E%AF%E5%8D%81%E5%88%86%E7%9A%84%E9%9A%BE%E6%A2%B3%E7%90%86%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%87%E7%AB%A0%E8%BF%98%E6%B2%A1%E6%9C%89%E5%86%99%E5%AE%8C.......%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fqq_25870633%2Farticle%2Fdetails%2F82992805%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fqq_25870633%2Farticle%2Fdetails%2F82992805%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}