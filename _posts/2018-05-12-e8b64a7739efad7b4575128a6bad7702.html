---
layout: default
title: 从命令行开始解析生成创世块源码
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22markdown_views%22%3E+%0A++%3Ch1+id%3D%22%E5%88%9B%E5%BB%BA%E5%88%9B%E4%B8%96%E5%9D%97%E7%9A%84%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90%22%3E%E5%88%9B%E5%BB%BA%E5%88%9B%E4%B8%96%E5%9D%97%E7%9A%84%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90%3C%2Fh1%3E+%0A++%3Cp%3E%E5%9C%A8cmd%E7%9A%84geth%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84main.go%E4%B8%AD%3C%2Fp%3E+%0A++%3Cp%3Einit%E5%87%BD%E6%95%B0%E5%85%88%E4%BA%8Emain%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%81%9A%E5%91%BD%E4%BB%A4%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E6%9C%89%E4%B8%89%E4%B8%AA%E5%9C%B0%E6%96%B9%EF%BC%8Capp.Action%3Dgeth%2Capp.Commands%E4%B8%ADconsoleCommand%EF%BC%8C%E4%BB%A5%E5%8F%8AApp.Before%E6%8C%87%E5%90%91%E7%9A%84%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+init%28%29+%7B%0A++++%2F%2F+Initialize+the+CLI+app+and+start+Geth%0A++++app.Action+%3D+geth%0A++++app.HideVersion+%3D+true+%2F%2F+we+have+a+command+to+print+the+version%0A++++app.Copyright+%3D+%22Copyright+2013-2018+The+go-ethereum+Authors%22%0A++++app.Commands+%3D+%5B%5Dcli.Command%7B%0A++++++++%2F%2F+See+chaincmd.go%3A%0A++++++++initCommand%2C%0A++++++++importCommand%2C%0A++++++++exportCommand%2C%0A++++++++importPreimagesCommand%2C%0A++++++++exportPreimagesCommand%2C%0A++++++++copydbCommand%2C%0A++++++++removedbCommand%2C%0A++++++++dumpCommand%2C%0A++++++++%2F%2F+See+monitorcmd.go%3A%0A++++++++monitorCommand%2C%0A++++++++%2F%2F+See+accountcmd.go%3A%0A++++++++accountCommand%2C%0A++++++++walletCommand%2C%0A++++++++%2F%2F+See+consolecmd.go%3A%0A++++++++consoleCommand%2C%0A++++++++attachCommand%2C%0A++++++++javascriptCommand%2C%0A++++++++%2F%2F+See+misccmd.go%3A%0A++++++++makecacheCommand%2C%0A++++++++makedagCommand%2C%0A++++++++versionCommand%2C%0A++++++++bugCommand%2C%0A++++++++licenseCommand%2C%0A++++++++%2F%2F+See+config.go%0A++++++++dumpConfigCommand%2C%0A++++%7D%0A++++sort.Sort%28cli.CommandsByName%28app.Commands%29%29%0A%0A++++app.Flags+%3D+append%28app.Flags%2C+nodeFlags...%29%0A++++app.Flags+%3D+append%28app.Flags%2C+rpcFlags...%29%0A++++app.Flags+%3D+append%28app.Flags%2C+consoleFlags...%29%0A++++app.Flags+%3D+append%28app.Flags%2C+debug.Flags...%29%0A++++app.Flags+%3D+append%28app.Flags%2C+whisperFlags...%29%0A%0A++++app.Before+%3D+func%28ctx+*cli.Context%29+error+%7B%0A++++++++runtime.GOMAXPROCS%28runtime.NumCPU%28%29%29%0A++++++++if+err+%3A%3D+debug.Setup%28ctx%29%3B+err+%21%3D+nil+%7B%0A++++++++++++return+err%0A++++++++%7D%0A++++++++%2F%2F+Start+system+runtime+metrics+collection%0A++++++++go+metrics.CollectProcessMetrics%283+*+time.Second%29%0A%0A++++++++utils.SetupNetwork%28ctx%29%0A++++++++return+nil%0A++++%7D%0A%0A++++app.After+%3D+func%28ctx+*cli.Context%29+error+%7B%0A++++++++debug.Exit%28%29%0A++++++++console.Stdin.Close%28%29+%2F%2F+Resets+terminal+mode.%0A++++++++return+nil%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3Emain%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84%E5%86%85%E5%AE%B9%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%EF%BC%8C%E8%BF%99%E9%87%8C%E4%B8%8D%E5%A4%9A%E5%81%9A%E4%BB%BB%E4%BD%95%E8%A7%A3%E9%87%8A%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+main%28%29+%7B%0A++++if+err+%3A%3D+app.Run%28os.Args%29%3B+err+%21%3D+nil+%7B%0A++++++++fmt.Fprintln%28os.Stderr%2C+err%29%0A++++++++os.Exit%281%29%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E9%80%9A%E8%BF%87gopkg.in%2Furfave%2Fcli.v1%E5%8C%85%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E6%9D%A5%E8%A1%94%E6%8E%A5%E5%88%B0cmd%2Fgeth%2Fchaincmd%E5%8C%85%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%8CAPP%E5%8C%85%E4%B8%AD%E4%B8%ADHandleAction%E5%87%BD%E6%95%B0action%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%98%AF%E3%80%8Cfunc%28*Context%29+error%E3%80%8D%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%B0%86%E6%89%A7%E8%A1%8Ca%28context%29%E6%96%B9%E6%B3%95%EF%BC%8C%E9%82%A3%E4%B9%88%E6%AD%A4%E6%97%B6%E8%B0%83%E7%94%A8%E9%82%A3%E4%B8%AAAction%E5%91%A2%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%E5%89%8D%E9%9D%A2%E6%8F%90%E5%88%B0%E7%9A%84App.init%28%29%E5%88%9D%E5%A7%8B%E5%8C%96%E5%91%BD%E4%BB%A4%E6%97%B6%E7%9A%84initCommand%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E7%9C%8Bcmd%2Fgeth%2Fchaincmd%E4%B8%AD%E7%9A%84initCommand%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Evar+%28%0A++++initCommand+%3D+cli.Command%7B%0A++++++++Action%3A++++utils.MigrateFlags%28initGenesis%29%2C%0A++++++++Name%3A++++++%22init%22%2C%0A++++++++Usage%3A+++++%22Bootstrap+and+initialize+a+new+genesis+block%22%2C%0A++++++++ArgsUsage%3A+%22%26lt%3BgenesisPath%26gt%3B%22%2C%0A++++++++Flags%3A+%5B%5Dcli.Flag%7B%0A++++++++++++utils.DataDirFlag%2C%0A++++++++++++utils.LightModeFlag%2C%0A++++++++%7D%2C%0A++++++++Category%3A+%22BLOCKCHAIN+COMMANDS%22%2C%0A++++++++Description%3A+%60%0AThe+init+command+initializes+a+new+genesis+block+and+definition+for+the+network.%0AThis+is+a+destructive+action+and+changes+the+network+in+which+you+will+be%0Aparticipating.%0A%0AIt+expects+the+genesis+file+as+argument.%60%2C%0A++++%7D+++%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E5%85%81%E8%AE%B8%E4%BD%BF%E7%94%A8%E7%8E%B0%E6%9C%89%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8A%9F%E8%83%BD%E3%80%82%E5%BD%93%E6%89%80%E6%9C%89%E6%A0%87%E5%BF%97%E8%A2%AB%E8%BF%81%E7%A7%BB%E6%97%B6%EF%BC%8C%E8%AF%A5%E5%8A%9F%E8%83%BD%E5%8F%AF%E4%BB%A5%E8%A2%AB%E5%88%A0%E9%99%A4%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%BF%85%E9%A1%BB%E6%94%B9%E5%8F%98%E7%8E%B0%E6%9C%89%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8D%B3%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E6%A0%87%E5%BF%97%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+MigrateFlags%28action+func%28ctx+*cli.Context%29+error%29+func%28*cli.Context%29+error+%7B%0A++++return+func%28ctx+*cli.Context%29+error+%7B%0A++++++++for+_%2C+name+%3A%3D+range+ctx.FlagNames%28%29+%7B%0A++++++++++++if+ctx.IsSet%28name%29+%7B%0A++++++++++++++++ctx.GlobalSet%28name%2C+ctx.String%28name%29%29%0A++++++++++++%7D%0A++++++++%7D%0A++++++++return+action%28ctx%29%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%A0%B9%E6%8D%AE%E7%BB%99%E5%AE%9A%E7%9A%84JSon%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%9B%E4%B8%96%E5%9D%97%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+initGenesis%28ctx+*cli.Context%29+error+%7B%0A++++%2F%2F+Make+sure+we+have+a+valid+genesis+JSON%0A++++genesisPath+%3A%3D+ctx.Args%28%29.First%28%29%0A++++if+len%28genesisPath%29+%3D%3D+0+%7B%0A++++++++utils.Fatalf%28%22Must+supply+path+to+genesis+JSON+file%22%29%0A++++%7D%0A++++file%2C+err+%3A%3D+os.Open%28genesisPath%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++utils.Fatalf%28%22Failed+to+read+genesis+file%3A+%25v%22%2C+err%29%0A++++%7D%0A++++defer+file.Close%28%29%0A%0A++++genesis+%3A%3D+new%28core.Genesis%29%0A++++if+err+%3A%3D+json.NewDecoder%28file%29.Decode%28genesis%29%3B+err+%21%3D+nil+%7B%0A++++++++utils.Fatalf%28%22invalid+genesis+file%3A+%25v%22%2C+err%29%0A++++%7D%0A++++%2F%2F+Open+an+initialise+both+full+and+light+databases%0A++++stack+%3A%3D+makeFullNode%28ctx%29%0A++++for+_%2C+name+%3A%3D+range+%5B%5Dstring%7B%22chaindata%22%2C+%22lightchaindata%22%7D+%7B%0A++++++++chaindb%2C+err+%3A%3D+stack.OpenDatabase%28name%2C+0%2C+0%29%0A++++++++if+err+%21%3D+nil+%7B%0A++++++++++++utils.Fatalf%28%22Failed+to+open+database%3A+%25v%22%2C+err%29%0A++++++++%7D%0A++++++++_%2C+hash%2C+err+%3A%3D+core.SetupGenesisBlock%28chaindb%2C+genesis%29%0A++++++++if+err+%21%3D+nil+%7B%0A++++++++++++utils.Fatalf%28%22Failed+to+write+genesis+block%3A+%25v%22%2C+err%29%0A++++++++%7D%0A++++++++log.Info%28%22Successfully+wrote+genesis+state%22%2C+%22database%22%2C+name%2C+%22hash%22%2C+hash%29%0A++++%7D%0A++++return+nil%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%B0%86%E5%88%9D%E5%A7%8B%E5%88%9B%E4%B8%96%E5%9D%97%E5%AD%98%E5%82%A8%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Echaindb%2C+err+%3A%3D+stack.OpenDatabase%28name%2C+0%2C+0%29%0A++++++++if+err+%21%3D+nil+%7B%0A++++++++++++utils.Fatalf%28%22Failed+to+open+database%3A+%25v%22%2C+err%29%0A++++++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84Core%E5%B1%82%E6%AC%A1%E7%9A%84%E4%BB%A3%E7%A0%81%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Egenesis+%3A%3D+new%28core.Genesis%29%0A%0A_%2C+hash%2C+err+%3A%3D+core.SetupGenesisBlock%28chaindb%2C+genesis%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++utils.Fatalf%28%22Failed+to+write+genesis+block%3A+%25v%22%2C+err%29%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%88%9B%E4%B8%96%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Etype+Genesis+struct+%7B%0A++++Config+++++*params.ChainConfig+%60json%3A%22config%22%60%0A++++Nonce++++++uint64++++++++++++++%60json%3A%22nonce%22%60%0A++++Timestamp++uint64++++++++++++++%60json%3A%22timestamp%22%60%0A++++ExtraData++%5B%5Dbyte++++++++++++++%60json%3A%22extraData%22%60%0A++++GasLimit+++uint64++++++++++++++%60json%3A%22gasLimit%22+++gencodec%3A%22required%22%60%0A++++Difficulty+*big.Int++++++++++++%60json%3A%22difficulty%22+gencodec%3A%22required%22%60%0A++++Mixhash++++common.Hash+++++++++%60json%3A%22mixHash%22%60%0A++++Coinbase+++common.Address++++++%60json%3A%22coinbase%22%60%0A++++Alloc++++++GenesisAlloc++++++++%60json%3A%22alloc%22++++++gencodec%3A%22required%22%60%0A%0A++++%2F%2F+These+fields+are+used+for+consensus+tests.+Please+don%27t+use+them%0A++++%2F%2F+in+actual+genesis+blocks.%0A++++Number+++++uint64++++++%60json%3A%22number%22%60%0A++++GasUsed++++uint64++++++%60json%3A%22gasUsed%22%60%0A++++ParentHash+common.Hash+%60json%3A%22parentHash%22%60%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%A3%80%E6%9F%A5%E5%88%9B%E4%B8%96%E5%9D%97%E7%9A%84%E7%9B%B8%E5%85%B3%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%EF%BC%8C%E7%AC%A6%E5%90%88%E9%80%BB%E8%BE%91%E5%86%99%E5%88%9B%E4%B8%96%E5%9D%97%EF%BC%8C%E6%88%96%E8%80%85%E5%8F%8D%E9%A6%88%E6%8E%A7%E5%88%B6%E5%8F%B0%E7%9B%B8%E5%BA%94%E7%9A%84%E9%97%AE%E9%A2%98%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+SetupGenesisBlock%28db+ethdb.Database%2C+genesis+*Genesis%29+%28*params.ChainConfig%2C+common.Hash%2C+error%29+%7B%0A++++if+genesis+%21%3D+nil+%26amp%3B%26amp%3B+genesis.Config+%3D%3D+nil+%7B%0A++++++++return+params.AllProtocolChanges%2C+common.Hash%7B%7D%2C+errGenesisNoConfig%0A++++%7D%0A%0A++++%2F%2F+Just+commit+the+new+block+if+there+is+no+stored+genesis+block.%0A++++stored+%3A%3D+GetCanonicalHash%28db%2C+0%29+%2F%2F%E8%8E%B7%E5%8F%96genesis%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%97%0A++++if+%28stored+%3D%3D+common.Hash%7B%7D%29+%7B+%2F%2F%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E5%8C%BA%E5%9D%97+%E6%9C%80%E5%BC%80%E5%A7%8B%E5%90%AF%E5%8A%A8geth%E4%BC%9A%E8%BF%9B%E5%85%A5%E8%BF%99%E9%87%8C%E3%80%82%0A++++++++if+genesis+%3D%3D+nil+%7B+%0A++++++++++++%2F%2F%E5%A6%82%E6%9E%9Cgenesis%E6%98%AFnil+%E8%80%8C%E4%B8%94stored%E4%B9%9F%E6%98%AFnil+%E9%82%A3%E4%B9%88%E4%BD%BF%E7%94%A8%E4%B8%BB%E7%BD%91%E7%BB%9C%0A++++++++++++%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AFtest++dev++rinkeby+%E9%82%A3%E4%B9%88genesis%E4%B8%8D%E4%B8%BA%E7%A9%BA+%E4%BC%9A%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%90%84%E8%87%AA%E7%9A%84genesis%0A++++++++++++log.Info%28%22Writing+default+main-net+genesis+block%22%29%0A++++++++++++genesis+%3D+DefaultGenesisBlock%28%29%0A++++++++%7D+else+%7B+%2F%2F+%E5%90%A6%E5%88%99%E4%BD%BF%E7%94%A8%E9%85%8D%E7%BD%AE%E7%9A%84%E5%8C%BA%E5%9D%97%0A++++++++++++log.Info%28%22Writing+custom+genesis+block%22%29%0A++++++++%7D%0A++++++++%2F%2F+%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A++++++++block%2C+err+%3A%3D+genesis.Commit%28db%29%0A++++++++return+genesis.Config%2C+block.Hash%28%29%2C+err%0A++++%7D%0A%0A++++%2F%2F+Check+whether+the+genesis+block+is+already+written.%0A++++if+genesis+%21%3D+nil+%7B+%2F%2F%E5%A6%82%E6%9E%9Cgenesis%E5%AD%98%E5%9C%A8%E8%80%8C%E4%B8%94%E5%8C%BA%E5%9D%97%E4%B9%9F%E5%AD%98%E5%9C%A8+%E9%82%A3%E4%B9%88%E5%AF%B9%E6%AF%94%E8%BF%99%E4%B8%A4%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E7%9B%B8%E5%90%8C%0A++++++++block%2C+_+%3A%3D+genesis.ToBlock%28%29%0A++++++++hash+%3A%3D+block.Hash%28%29%0A++++++++if+hash+%21%3D+stored+%7B%0A++++++++++++return+genesis.Config%2C+block.Hash%28%29%2C+%26amp%3BGenesisMismatchError%7Bstored%2C+hash%7D%0A++++++++%7D%0A++++%7D%0A%0A++++%2F%2F+Get+the+existing+chain+configuration.%0A++++%2F%2F+%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84genesis%E9%85%8D%E7%BD%AE%0A++++newcfg+%3A%3D+genesis.configOrDefault%28stored%29%0A++++%2F%2F+%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%85%8D%E7%BD%AE%0A++++storedcfg%2C+err+%3A%3D+GetChainConfig%28db%2C+stored%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++if+err+%3D%3D+ErrChainConfigNotFound+%7B%0A++++++++++++%2F%2F+This+case+happens+if+a+genesis+write+was+interrupted.%0A++++++++++++log.Warn%28%22Found+genesis+block+without+chain+config%22%29%0A++++++++++++err+%3D+WriteChainConfig%28db%2C+stored%2C+newcfg%29%0A++++++++%7D%0A++++++++return+newcfg%2C+stored%2C+err%0A++++%7D%0A++++%2F%2F+Special+case%3A+don%27t+change+the+existing+config+of+a+non-mainnet+chain+if+no+new%0A++++%2F%2F+config+is+supplied.+These+chains+would+get+AllProtocolChanges+%28and+a+compat+error%29%0A++++%2F%2F+if+we+just+continued+here.%0A++++%2F%2F+%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E6%8F%90%E4%BE%9B%E6%96%B0%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E8%AF%B7%E4%B8%8D%E8%A6%81%E6%9B%B4%E6%94%B9%E9%9D%9E%E4%B8%BB%E7%BD%91%E9%93%BE%E7%9A%84%E7%8E%B0%E6%9C%89%E9%85%8D%E7%BD%AE%E3%80%82+%0A++++%2F%2F+%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%BB%A7%E7%BB%AD%E8%BF%99%E9%87%8C%EF%BC%8C%E8%BF%99%E4%BA%9B%E9%93%BE%E4%BC%9A%E5%BE%97%E5%88%B0AllProtocolChanges%EF%BC%88%E5%92%8Ccompat%E9%94%99%E8%AF%AF%EF%BC%89%E3%80%82%0A++++if+genesis+%3D%3D+nil+%26amp%3B%26amp%3B+stored+%21%3D+params.MainnetGenesisHash+%7B%0A++++++++return+storedcfg%2C+stored%2C+nil+++%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E7%A7%81%E6%9C%89%E9%93%BE%E6%8E%A5%E4%BC%9A%E4%BB%8E%E8%BF%99%E9%87%8C%E9%80%80%E5%87%BA%E3%80%82%0A++++%7D%0A%0A++++%2F%2F+Check+config+compatibility+and+write+the+config.+Compatibility+errors%0A++++%2F%2F+are+returned+to+the+caller+unless+we%27re+already+at+block+zero.%0A++++%2F%2F+%E6%A3%80%E6%9F%A5%E9%85%8D%E7%BD%AE%E7%9A%84%E5%85%BC%E5%AE%B9%E6%80%A7%2C%E9%99%A4%E9%9D%9E%E6%88%91%E4%BB%AC%E5%9C%A8%E5%8C%BA%E5%9D%970%2C%E5%90%A6%E5%88%99%E8%BF%94%E5%9B%9E%E5%85%BC%E5%AE%B9%E6%80%A7%E9%94%99%E8%AF%AF.%0A++++height+%3A%3D+GetBlockNumber%28db%2C+GetHeadHeaderHash%28db%29%29%0A++++if+height+%3D%3D+missingNumber+%7B%0A++++++++return+newcfg%2C+stored%2C+fmt.Errorf%28%22missing+block+number+for+head+header+hash%22%29%0A++++%7D%0A++++compatErr+%3A%3D+storedcfg.CheckCompatible%28newcfg%2C+height%29%0A++++%2F%2F+%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E5%B7%B2%E7%BB%8F%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E4%BA%86%2C%E9%82%A3%E4%B9%88%E5%B0%B1%E4%B8%8D%E8%83%BD%E6%9B%B4%E6%94%B9genesis%E9%85%8D%E7%BD%AE%E4%BA%86%0A++++if+compatErr+%21%3D+nil+%26amp%3B%26amp%3B+height+%21%3D+0+%26amp%3B%26amp%3B+compatErr.RewindTo+%21%3D+0+%7B%0A++++++++return+newcfg%2C+stored%2C+compatErr%0A++++%7D%0A++++%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E4%B8%BB%E7%BD%91%E7%BB%9C%E4%BC%9A%E4%BB%8E%E8%BF%99%E9%87%8C%E9%80%80%E5%87%BA%E3%80%82%0A++++return+newcfg%2C+stored%2C+WriteChainConfig%28db%2C+stored%2C+newcfg%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3EToBlock%2C+%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E4%BD%BF%E7%94%A8genesis%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%9F%BA%E4%BA%8E%E5%86%85%E5%AD%98%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E7%84%B6%E5%90%8E%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AAblock%E5%B9%B6%E8%BF%94%E5%9B%9E%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E%2F%2F+ToBlock+creates+the+block+and+state+of+a+genesis+specification.%0Afunc+%28g+*Genesis%29+ToBlock%28%29+%28*types.Block%2C+*state.StateDB%29+%7B%0A++++db%2C+_+%3A%3D+ethdb.NewMemDatabase%28%29%0A++++statedb%2C+_+%3A%3D+state.New%28common.Hash%7B%7D%2C+state.NewDatabase%28db%29%29%0A++++for+addr%2C+account+%3A%3D+range+g.Alloc+%7B%0A++++++++statedb.AddBalance%28addr%2C+account.Balance%29%0A++++++++statedb.SetCode%28addr%2C+account.Code%29%0A++++++++statedb.SetNonce%28addr%2C+account.Nonce%29%0A++++++++for+key%2C+value+%3A%3D+range+account.Storage+%7B%0A++++++++++++statedb.SetState%28addr%2C+key%2C+value%29%0A++++++++%7D%0A++++%7D%0A++++root+%3A%3D+statedb.IntermediateRoot%28false%29%0A++++head+%3A%3D+%26amp%3Btypes.Header%7B%0A++++++++Number%3A+++++new%28big.Int%29.SetUint64%28g.Number%29%2C%0A++++++++Nonce%3A++++++types.EncodeNonce%28g.Nonce%29%2C%0A++++++++Time%3A+++++++new%28big.Int%29.SetUint64%28g.Timestamp%29%2C%0A++++++++ParentHash%3A+g.ParentHash%2C%0A++++++++Extra%3A++++++g.ExtraData%2C%0A++++++++GasLimit%3A+++new%28big.Int%29.SetUint64%28g.GasLimit%29%2C%0A++++++++GasUsed%3A++++new%28big.Int%29.SetUint64%28g.GasUsed%29%2C%0A++++++++Difficulty%3A+g.Difficulty%2C%0A++++++++MixDigest%3A++g.Mixhash%2C%0A++++++++Coinbase%3A+++g.Coinbase%2C%0A++++++++Root%3A+++++++root%2C%0A++++%7D%0A++++if+g.GasLimit+%3D%3D+0+%7B%0A++++++++head.GasLimit+%3D+params.GenesisGasLimit%0A++++%7D%0A++++if+g.Difficulty+%3D%3D+nil+%7B%0A++++++++head.Difficulty+%3D+params.GenesisDifficulty%0A++++%7D%0A++++return+types.NewBlock%28head%2C+nil%2C+nil%2C+nil%29%2C+statedb%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3ECommit%E6%96%B9%E6%B3%95%E5%92%8CMustCommit%E6%96%B9%E6%B3%95%2C+Commit%E6%96%B9%E6%B3%95%E6%8A%8A%E7%BB%99%E5%AE%9A%E7%9A%84genesis%E7%9A%84block%E5%92%8Cstate%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C+%E8%BF%99%E4%B8%AAblock%E8%A2%AB%E8%AE%A4%E4%B8%BA%E6%98%AF%E8%A7%84%E8%8C%83%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%A4%B4%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E%2F%2F+Commit+writes+the+block+and+state+of+a+genesis+specification+to+the+database.%0A%2F%2F+The+block+is+committed+as+the+canonical+head+block.%0Afunc+%28g+*Genesis%29+Commit%28db+ethdb.Database%29+%28*types.Block%2C+error%29+%7B%0A++++block%2C+statedb+%3A%3D+g.ToBlock%28%29%0A++++if+block.Number%28%29.Sign%28%29+%21%3D+0+%7B%0A++++++++return+nil%2C+fmt.Errorf%28%22can%27t+commit+genesis+block+with+number+%26gt%3B+0%22%29%0A++++%7D%0A++++if+_%2C+err+%3A%3D+statedb.CommitTo%28db%2C+false%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+fmt.Errorf%28%22cannot+write+state%3A+%25v%22%2C+err%29%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5%E6%80%BB%E9%9A%BE%E5%BA%A6%0A++++if+err+%3A%3D+WriteTd%28db%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+g.Difficulty%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+err%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5%E5%8C%BA%E5%9D%97%0A++++if+err+%3A%3D+WriteBlock%28db%2C+block%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+err%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5%E5%8C%BA%E5%9D%97%E6%94%B6%E6%8D%AE%0A++++if+err+%3A%3D+WriteBlockReceipts%28db%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+nil%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+err%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5+++headerPrefix+%2B+num+%28uint64+big+endian%29+%2B+numSuffix+-%26gt%3B+hash%0A++++if+err+%3A%3D+WriteCanonicalHash%28db%2C+block.Hash%28%29%2C+block.NumberU64%28%29%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+err%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5++%22LastBlock%22+-%26gt%3B+hash%0A++++if+err+%3A%3D+WriteHeadBlockHash%28db%2C+block.Hash%28%29%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+err%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5+%22LastHeader%22+-%26gt%3B+hash%0A++++if+err+%3A%3D+WriteHeadHeaderHash%28db%2C+block.Hash%28%29%29%3B+err+%21%3D+nil+%7B%0A++++++++return+nil%2C+err%0A++++%7D%0A++++config+%3A%3D+g.Config%0A++++if+config+%3D%3D+nil+%7B%0A++++++++config+%3D+params.AllProtocolChanges%0A++++%7D%0A++++%2F%2F+%E5%86%99%E5%85%A5+ethereum-config-hash+-%26gt%3B+config%0A++++return+block%2C+WriteChainConfig%28db%2C+block.Hash%28%29%2C+config%29%0A%7D%0A%0A%2F%2F+MustCommit+writes+the+genesis+block+and+state+to+db%2C+panicking+on+error.%0A%2F%2F+The+block+is+committed+as+the+canonical+head+block.%0Afunc+%28g+*Genesis%29+MustCommit%28db+ethdb.Database%29+*types.Block+%7B%0A++++block%2C+err+%3A%3D+g.Commit%28db%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++panic%28err%29%0A++++%7D%0A++++return+block%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%94%E5%9B%9E%E5%90%84%E7%A7%8D%E6%A8%A1%E5%BC%8F%E7%9A%84%E9%BB%98%E8%AE%A4Genesis%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E%2F%2F+DefaultGenesisBlock+returns+the+Ethereum+main+net+genesis+block.%0Afunc+DefaultGenesisBlock%28%29+*Genesis+%7B%0A++++return+%26amp%3BGenesis%7B%0A++++++++Config%3A+++++params.MainnetChainConfig%2C%0A++++++++Nonce%3A++++++66%2C%0A++++++++ExtraData%3A++hexutil.MustDecode%28%220x11bbe8db4e347b4e8c937c1c8370e4b5ed33adb3db69cbdb7a38e1e50b1b82fa%22%29%2C%0A++++++++GasLimit%3A+++5000%2C%0A++++++++Difficulty%3A+big.NewInt%2817179869184%29%2C%0A++++++++Alloc%3A++++++decodePrealloc%28mainnetAllocData%29%2C%0A++++%7D%0A%7D%0A%0A%2F%2F+DefaultTestnetGenesisBlock+returns+the+Ropsten+network+genesis+block.%0Afunc+DefaultTestnetGenesisBlock%28%29+*Genesis+%7B%0A++++return+%26amp%3BGenesis%7B%0A++++++++Config%3A+++++params.TestnetChainConfig%2C%0A++++++++Nonce%3A++++++66%2C%0A++++++++ExtraData%3A++hexutil.MustDecode%28%220x3535353535353535353535353535353535353535353535353535353535353535%22%29%2C%0A++++++++GasLimit%3A+++16777216%2C%0A++++++++Difficulty%3A+big.NewInt%281048576%29%2C%0A++++++++Alloc%3A++++++decodePrealloc%28testnetAllocData%29%2C%0A++++%7D%0A%7D%0A%0A%2F%2F+DefaultRinkebyGenesisBlock+returns+the+Rinkeby+network+genesis+block.%0Afunc+DefaultRinkebyGenesisBlock%28%29+*Genesis+%7B%0A++++return+%26amp%3BGenesis%7B%0A++++++++Config%3A+++++params.RinkebyChainConfig%2C%0A++++++++Timestamp%3A++1492009146%2C%0A++++++++ExtraData%3A++hexutil.MustDecode%28%220x52657370656374206d7920617574686f7269746168207e452e436172746d616e42eb768f2244c8811c63729a21a3569731535f067ffc57839b00206d1ad20c69a1981b489f772031b279182d99e65703f0076e4812653aab85fca0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000%22%29%2C%0A++++++++GasLimit%3A+++4700000%2C%0A++++++++Difficulty%3A+big.NewInt%281%29%2C%0A++++++++Alloc%3A++++++decodePrealloc%28rinkebyAllocData%29%2C%0A++++%7D%0A%7D%0A%0A%2F%2F+DevGenesisBlock+returns+the+%27geth+--dev%27+genesis+block.%0Afunc+DevGenesisBlock%28%29+*Genesis+%7B%0A++++return+%26amp%3BGenesis%7B%0A++++++++Config%3A+++++params.AllProtocolChanges%2C%0A++++++++Nonce%3A++++++42%2C%0A++++++++GasLimit%3A+++4712388%2C%0A++++++++Difficulty%3A+big.NewInt%28131072%29%2C%0A++++++++Alloc%3A++++++decodePrealloc%28devAllocData%29%2C%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3+id%3D%22github%E5%9C%B0%E5%9D%80%22%3EGitHub%E5%9C%B0%E5%9D%80%EF%BC%9A%3C%2Fh3%3E+%0A++%3Cp%3E%3Ca+href%3D%22https%3A%2F%2Fgithub.com%2Fguoshijiang%2Fgo-ethereum-code-analysis%22+rel%3D%22nofollow%22%3Ehttps%3A%2F%2Fgithub.com%2Fguoshijiang%2Fgo-ethereum-code-analysis%3C%2Fa%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fmarkdown_views-ea0013b516.css%22%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fjiang_xinxing%2Farticle%2Fdetails%2F80289759%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fjiang_xinxing%2Farticle%2Fdetails%2F80289759%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}