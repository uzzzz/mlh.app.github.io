---
layout: default
title: 以太坊挖矿源码分析
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22article-copyright%22%3E%0A+++%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%EF%BC%9A%E6%9C%AC%E6%96%87%E4%B8%BA%E5%8D%9A%E4%B8%BB%E5%8E%9F%E5%88%9B%E6%96%87%E7%AB%A0%EF%BC%8C%E6%9C%AA%E7%BB%8F%E5%8D%9A%E4%B8%BB%E5%85%81%E8%AE%B8%E4%B8%8D%E5%BE%97%E8%BD%AC%E8%BD%BD%E3%80%82+https%3A%2F%2Fblog.csdn.net%2FTurkeyCock%2Farticle%2Fdetails%2F80586951+%0A+%3C%2Fdiv%3E+%0A+%3Cdiv+class%3D%22markdown_views+prism-atom-one-dark%22%3E+%0A++%3C%21--+flowchart+%E7%AE%AD%E5%A4%B4%E5%9B%BE%E6%A0%87+%E5%8B%BF%E5%88%A0+--%3E+%0A++%3Csvg+xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22+style%3D%22display%3A+none%3B%22%3E%0A+++%3Cpath+stroke-linecap%3D%22round%22+d%3D%22M5%2C0+0%2C2.5+5%2C5z%22+id%3D%22raphael-marker-block%22+style%3D%22-webkit-tap-highlight-color%3A+rgba%280%2C+0%2C+0%2C+0%29%3B%22%3E%3C%2Fpath%3E%0A++%3C%2Fsvg%3E+%0A++%3Cp%3E%E8%BF%99%E7%AF%87%E5%BC%80%E5%A7%8B%E7%A0%94%E7%A9%B6%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E6%8C%96%E7%9F%BF%E6%B5%81%E7%A8%8B%EF%BC%8C%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6%E5%8F%82%E8%A7%81%E4%B8%8B%E5%9B%BE%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180605204840626%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R1cmtleUNvY2s%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%E8%BF%99%E9%87%8C%E5%86%99%E5%9B%BE%E7%89%87%E6%8F%8F%E8%BF%B0%22%3E%3C%2Fp%3E+%0A++%3Cp%3E%E5%85%B6%E4%B8%AD%E6%B6%89%E5%8F%8A%E5%88%B0%E7%9A%84%E7%BB%84%E4%BB%B6%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%A7%81%E4%B8%8B%E9%9D%A2%E7%9A%84UML%E5%9B%BE%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180605203550313%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R1cmtleUNvY2s%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%E8%BF%99%E9%87%8C%E5%86%99%E5%9B%BE%E7%89%87%E6%8F%8F%E8%BF%B0%22%3E%3C%2Fp%3E+%0A++%3Ch1%3E%3Ca+id%3D%221_Miner_9%22%3E%3C%2Fa%3E1.+Miner%E5%90%AF%E5%8A%A8%E6%89%93%E5%8C%85%3C%2Fh1%3E+%0A++%3Cp%3E%E5%9C%A8eth+Service%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAMiner%E5%AE%9E%E4%BE%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Eeth.miner+%3D+miner.New%28eth%2C+eth.chainConfig%2C+eth.EventMux%28%29%2C+eth.engine%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E7%9C%8B%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AANew%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%A3%E7%A0%81%E4%BD%8D%E4%BA%8Eminer%2Fminer.go%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+New%28eth+Backend%2C+config+*params.ChainConfig%2C+mux+*event.TypeMux%2C+engine+consensus.Engine%29+*Miner+%7B%0A++++miner+%3A%3D+%26amp%3BMiner%7B%0A++++++++eth%3A++++++eth%2C%0A++++++++mux%3A++++++mux%2C%0A++++++++engine%3A+++engine%2C%0A++++++++worker%3A+++newWorker%28config%2C+engine%2C+common.Address%7B%7D%2C+eth%2C+mux%29%2C%0A++++++++canStart%3A+1%2C%0A++++%7D%0A++++miner.Register%28NewCpuAgent%28eth.BlockChain%28%29%2C+engine%29%29%0A++++go+miner.update%28%29%0A%0A++++return+miner%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%BB%A3%E7%A0%81%E5%88%86%E4%B8%BA3%E4%B8%AA%E9%83%A8%E5%88%86%EF%BC%9A%E5%88%9B%E5%BB%BAMiner%E5%AE%9E%E4%BE%8B%E3%80%81%E6%B3%A8%E5%86%8CAgent%E3%80%81%E7%AD%89%E5%BE%85%E5%8C%BA%E5%9D%97%E5%90%8C%E6%AD%A5%E5%AE%8C%E6%88%90%EF%BC%8C%E4%B8%8B%E9%9D%A2%E5%88%86%E5%88%AB%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2211_Miner_34%22%3E%3C%2Fa%3E1.1+%E5%88%9B%E5%BB%BAMiner%E5%AE%9E%E4%BE%8B%3C%2Fh2%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%80%E6%AD%A5%E6%9C%80%E4%B8%BB%E8%A6%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%98%AF%E8%B0%83%E7%94%A8newWorker%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAworker%E5%AE%9E%E4%BE%8B%EF%BC%8CMiner%E5%8F%AA%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8F%91%E8%B5%B7%E4%BA%BA%EF%BC%8C%E7%9C%9F%E6%AD%A3%E5%B9%B2%E6%B4%BB%E7%9A%84%E6%98%AFworker%E3%80%82%E7%9C%8B%E4%B8%80%E4%B8%8BnewWorker%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%A3%E7%A0%81%E4%BD%8D%E4%BA%8Eminer%2Fworker.go%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+newWorker%28config+*params.ChainConfig%2C+engine+consensus.Engine%2C+coinbase+common.Address%2C+eth+Backend%2C+mux+*event.TypeMux%29+*worker+%7B%0A++++worker+%3A%3D+%26amp%3Bworker%7B%0A++++++++config%3A+++++++++config%2C%0A++++++++engine%3A+++++++++engine%2C%0A++++++++eth%3A++++++++++++eth%2C%0A++++++++mux%3A++++++++++++mux%2C%0A++++++++txCh%3A+++++++++++make%28chan+core.TxPreEvent%2C+txChanSize%29%2C%0A++++++++chainHeadCh%3A++++make%28chan+core.ChainHeadEvent%2C+chainHeadChanSize%29%2C%0A++++++++chainSideCh%3A++++make%28chan+core.ChainSideEvent%2C+chainSideChanSize%29%2C%0A++++++++chainDb%3A++++++++eth.ChainDb%28%29%2C%0A++++++++recv%3A+++++++++++make%28chan+*Result%2C+resultQueueSize%29%2C%0A++++++++chain%3A++++++++++eth.BlockChain%28%29%2C%0A++++++++proc%3A+++++++++++eth.BlockChain%28%29.Validator%28%29%2C%0A++++++++possibleUncles%3A+make%28map%5Bcommon.Hash%5D*types.Block%29%2C%0A++++++++coinbase%3A+++++++coinbase%2C%0A++++++++agents%3A+++++++++make%28map%5BAgent%5Dstruct%7B%7D%29%2C%0A++++++++unconfirmed%3A++++newUnconfirmedBlocks%28eth.BlockChain%28%29%2C+miningLogAtDepth%29%2C%0A++++%7D%0A++++%2F%2F+Subscribe+TxPreEvent+for+tx+pool%0A++++worker.txSub+%3D+eth.TxPool%28%29.SubscribeTxPreEvent%28worker.txCh%29%0A++++%2F%2F+Subscribe+events+for+blockchain%0A++++worker.chainHeadSub+%3D+eth.BlockChain%28%29.SubscribeChainHeadEvent%28worker.chainHeadCh%29%0A++++worker.chainSideSub+%3D+eth.BlockChain%28%29.SubscribeChainSideEvent%28worker.chainSideCh%29%0A++++go+worker.update%28%29%0A%0A++++go+worker.wait%28%29%0A++++worker.commitNewWork%28%29%0A%0A++++return+worker%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E4%B8%80%E4%B8%AA%E6%AF%94%E8%BE%83%E9%87%8D%E8%A6%81%E7%9A%84%E5%AD%97%E6%AE%B5%E6%98%AFrecv%EF%BC%8C%E6%98%AF%E4%B8%80%E4%B8%AAchannel%E7%B1%BB%E5%9E%8B%EF%BC%8C%E7%94%A8%E4%BA%8E%E6%8E%A5%E6%94%B6%E4%BB%8EAgent%E9%82%A3%E8%BE%B9%E4%BC%A0%E8%BF%87%E6%9D%A5%E7%9A%84Result%E3%80%82%3Cbr%3E+%E5%90%8C%E6%97%B6%E8%BF%98%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AAgoroutine%E8%BF%90%E8%A1%8Cworker.wait%28%29%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%BB%E8%A6%81%E5%B0%B1%E6%98%AF%E7%9B%91%E5%90%ACrecv%EF%BC%8C%E6%8A%8A%E6%96%B0%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BB%8E%E8%80%8C%E6%9B%B4%E6%96%B0%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2212_Agent_72%22%3E%3C%2Fa%3E1.2+%E6%B3%A8%E5%86%8CAgent%3C%2Fh2%3E+%0A++%3Cp%3EAgent%E6%98%AF%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%AE%9A%E4%B9%89%E4%BD%8D%E4%BA%8Eminer%2Fworker.go%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Etype+Agent+interface+%7B%0A++++Work%28%29+chan%26lt%3B-+*Work%0A++++SetReturnCh%28chan%26lt%3B-+*Result%29%0A++++Stop%28%29%0A++++Start%28%29%0A++++GetHashRate%28%29+int64%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%85%B6%E4%B8%ADWork%28%29%E5%87%BD%E6%95%B0%E7%94%A8%E4%BA%8E%E8%8E%B7%E5%8F%96%E4%B8%80%E4%B8%AAchannel%EF%BC%8C%E5%BD%93worker%E4%BA%A7%E7%94%9F%E6%96%B0%E7%9A%84Work%E6%97%B6%E4%BC%9A%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%E5%8F%91%E9%80%81%E7%BB%99Agent%E3%80%82%3Cbr%3E+%E5%90%8C%E6%97%B6SetReturnCh%28%29%E5%87%BD%E6%95%B0%E7%94%A8%E4%BA%8E%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AAchannel%EF%BC%8C%E5%BD%93Agent%E8%BF%99%E8%BE%B9%E5%AE%8C%E6%88%90POW%E8%AE%A1%E7%AE%97%E5%90%8E%EF%BC%8C%E4%BC%9A%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AAchannel%E6%8A%8AResult%E5%8F%91%E9%80%81%E7%BB%99worker%E3%80%82%3Cbr%3E+CpuAgent%E6%98%AFAgent%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0%E7%B1%BB%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87NewCpuAgent%28%29%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AACpuAgent%E5%AE%9E%E4%BE%8B%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E6%98%AF%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8Miner%E7%9A%84Register%28%29%E5%87%BD%E6%95%B0%E5%AE%8C%E6%88%90Agent%E6%B3%A8%E5%86%8C%E7%9A%84%EF%BC%8C%E5%8F%82%E6%95%B0%E6%98%AF%E4%B8%80%E4%B8%AACpuAgent%E5%AE%9E%E4%BE%8B%E3%80%82%E7%9C%8B%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*Miner%29+Register%28agent+Agent%29+%7B%0A++++if+self.Mining%28%29+%7B%0A++++++++agent.Start%28%29%0A++++%7D%0A++++self.worker.register%28agent%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E7%BB%A7%E7%BB%AD%E8%B7%9F%E8%B8%AAworker%E7%9A%84register%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+register%28agent+Agent%29+%7B%0A++++self.mu.Lock%28%29%0A++++defer+self.mu.Unlock%28%29%0A++++self.agents%5Bagent%5D+%3D+struct%7B%7D%7B%7D%0A++++agent.SetReturnCh%28self.recv%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E8%BF%99%E9%87%8C%E9%A6%96%E5%85%88%E5%9C%A8%E4%B8%80%E4%B8%AAmap%E4%B8%AD%E8%AE%B0%E5%BD%95%E4%BA%86%E8%BF%99%E4%B8%AAAgent%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8SetReturnCh%28%29%E5%87%BD%E6%95%B0%E6%B3%A8%E5%86%8C%E4%BA%86%E4%B8%80%E4%B8%AA%E6%8E%A5%E6%94%B6channel%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2213__108%22%3E%3C%2Fa%3E1.3+%E7%AD%89%E5%BE%85%E5%8C%BA%E5%9D%97%E5%90%8C%E6%AD%A5%E5%AE%8C%E6%88%90%3C%2Fh2%3E+%0A++%3Cp%3E%E5%9C%A8%E5%BC%80%E5%A7%8B%E6%8C%96%E7%9F%BF%E4%B9%8B%E5%89%8D%EF%BC%8C%E9%A6%96%E5%85%88%E9%9C%80%E8%A6%81%E7%AD%89%E5%BE%85%E5%92%8C%E5%85%B6%E4%BB%96%E7%BB%93%E7%82%B9%E4%B9%8B%E9%97%B4%E5%AE%8C%E6%88%90%E5%8C%BA%E5%9D%97%E5%90%8C%E6%AD%A5%EF%BC%8C%E8%BF%99%E6%A0%B7%E6%89%8D%E8%83%BD%E5%9C%A8%E6%9C%80%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%8C%96%E7%9F%BF%E3%80%82%E5%9B%A0%E6%AD%A4%E8%BF%99%E9%87%8C%E5%90%AF%E5%8A%A8%E4%BA%86%E4%B8%80%E4%B8%AAgoroutine%E8%B0%83%E7%94%A8Miner.update%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*Miner%29+update%28%29+%7B%0A++++events+%3A%3D+self.mux.Subscribe%28downloader.StartEvent%7B%7D%2C+downloader.DoneEvent%7B%7D%2C+downloader.FailedEvent%7B%7D%29%0Aout%3A%0A++++for+ev+%3A%3D+range+events.Chan%28%29+%7B%0A++++++++switch+ev.Data.%28type%29+%7B%0A++++++++case+downloader.StartEvent%3A%0A++++++++++++atomic.StoreInt32%28%26amp%3Bself.canStart%2C+0%29%0A++++++++++++if+self.Mining%28%29+%7B%0A++++++++++++++++self.Stop%28%29%0A++++++++++++++++atomic.StoreInt32%28%26amp%3Bself.shouldStart%2C+1%29%0A++++++++++++++++log.Info%28%22Mining+aborted+due+to+sync%22%29%0A++++++++++++%7D%0A++++++++case+downloader.DoneEvent%2C+downloader.FailedEvent%3A%0A++++++++++++shouldStart+%3A%3D+atomic.LoadInt32%28%26amp%3Bself.shouldStart%29+%3D%3D+1%0A%0A++++++++++++atomic.StoreInt32%28%26amp%3Bself.canStart%2C+1%29%0A++++++++++++atomic.StoreInt32%28%26amp%3Bself.shouldStart%2C+0%29%0A++++++++++++if+shouldStart+%7B%0A++++++++++++++++self.Start%28self.coinbase%29%0A++++++++++++%7D%0A++++++++++++%2F%2F+unsubscribe.+we%27re+only+interested+in+this+event+once%0A++++++++++++events.Unsubscribe%28%29%0A++++++++++++%2F%2F+stop+immediately+and+ignore+all+further+pending+events%0A++++++++++++break+out%0A++++++++%7D%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E8%AE%A2%E9%98%85%E4%BA%86downloader%E7%9A%84StartEvent%E3%80%81DoneEvent%E3%80%81FailedEvent%E4%BA%8B%E4%BB%B6%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_141%22%3E%3C%2Fa%3E%3C%2Fh4%3E+%0A++%3Cul%3E+%0A+++%3Cli%3E%E5%BD%93%E6%94%B6%E5%88%B0StartEvent%E6%97%B6%EF%BC%8C%E4%BC%9A%E6%8A%8AcanStart%E7%BD%AE%E4%B8%BA0%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%8D%B3%E4%BD%BF%E4%BD%A0%E8%B0%83%E7%94%A8Miner%E7%9A%84Start%28%29%E5%87%BD%E6%95%B0%E4%B9%9F%E4%B8%8D%E4%BC%9A%E7%9C%9F%E6%AD%A3%E5%90%AF%E5%8A%A8%3C%2Fli%3E+%0A+++%3Cli%3E%E5%BD%93%E6%94%B6%E5%88%B0DoneEvent%E6%88%96%E8%80%85FailedEvent%E6%97%B6%EF%BC%8C%E5%B0%86canStart%E7%BD%AE%E4%B8%BA1%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8Miner%E7%9A%84Start%28%29%E5%87%BD%E6%95%B0%E5%90%AF%E5%8A%A8%E6%8C%96%E7%9F%BF%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Cp%3E%E5%80%BC%E5%BE%97%E6%B3%A8%E6%84%8F%E7%9A%84%E6%98%AF%EF%BC%8C%E6%94%B6%E5%88%B0downloader%E7%9A%84%E6%B6%88%E6%81%AF%E5%90%8E%E4%BC%9A%E7%AB%8B%E5%8D%B3%E5%81%9C%E6%AD%A2%E8%AE%A2%E9%98%85%E8%BF%99%E4%BA%9B%E6%B6%88%E6%81%AF%E5%B9%B6%E9%80%80%E5%87%BA%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E5%8F%AA%E4%BC%9A%E8%BF%90%E8%A1%8C%E4%B8%80%E6%AC%A1%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%8E%A5%E7%9D%80%E7%9C%8B%E4%B8%80%E4%B8%8BMiner%E7%9A%84Start%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*Miner%29+Start%28coinbase+common.Address%29+%7B%0A++++atomic.StoreInt32%28%26amp%3Bself.shouldStart%2C+1%29%0A++++self.SetEtherbase%28coinbase%29%0A%0A++++if+atomic.LoadInt32%28%26amp%3Bself.canStart%29+%3D%3D+0+%7B%0A++++++++log.Info%28%22Network+syncing%2C+will+start+miner+afterwards%22%29%0A++++++++return%0A++++%7D%0A++++atomic.StoreInt32%28%26amp%3Bself.mining%2C+1%29%0A%0A++++log.Info%28%22Starting+mining+operation%22%29%0A++++self.worker.start%28%29%0A++++self.worker.commitNewWork%28%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E8%BF%99%E9%87%8C%E4%BC%9A%E5%88%A4%E6%96%ADcanStart%E6%A0%87%E5%BF%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%90%8C%E6%AD%A5%E6%B2%A1%E6%9C%89%E5%AE%8C%E6%88%90%E7%9A%84%E8%AF%9D%E6%98%AF%E4%B8%8D%E4%BC%9A%E7%9C%9F%E6%AD%A3%E5%90%AF%E5%8A%A8%E7%9A%84%E3%80%82%3Cbr%3E+%E7%B4%A7%E6%8E%A5%E7%9D%80%E8%B0%83%E7%94%A8%E4%BA%86worker%E7%9A%84start%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%9C%80%E5%85%B3%E9%94%AE%E7%9A%84commitNewWork%28%29%E5%87%BD%E6%95%B0%E3%80%82%E6%88%91%E4%BB%AC%E5%85%88%E7%9C%8B%E4%B8%80%E4%B8%8Bstart%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+start%28%29+%7B%0A++++self.mu.Lock%28%29%0A++++defer+self.mu.Unlock%28%29%0A%0A++++atomic.StoreInt32%28%26amp%3Bself.mining%2C+1%29%0A%0A++++%2F%2F+spin+up+agents%0A++++for+agent+%3A%3D+range+self.agents+%7B%0A++++++++agent.Start%28%29%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E4%BC%9A%E9%81%8D%E5%8E%86%E6%89%80%E6%9C%89%E7%9A%84Agent%EF%BC%8C%E8%B0%83%E7%94%A8%E5%AE%83%E4%BB%AC%E7%9A%84Start%28%29%E5%87%BD%E6%95%B0%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E7%9C%8B%E4%B8%80%E4%B8%8BCpuAgent%E7%9A%84Start%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*CpuAgent%29+Start%28%29+%7B%0A++++if+%21atomic.CompareAndSwapInt32%28%26amp%3Bself.isMining%2C+0%2C+1%29+%7B%0A++++++++return+%2F%2F+agent+already+started%0A++++%7D%0A++++go+self.update%28%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%90%AF%E5%8A%A8%E4%BA%86%E4%B8%80%E4%B8%AAgoroutine%E8%B0%83%E7%94%A8update%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%BB%E8%A6%81%E4%BD%9C%E7%94%A8%E5%B0%B1%E6%98%AF%E6%8E%A5%E6%94%B6worker%E5%8F%91%E9%80%81%E8%BF%87%E6%9D%A5%E7%9A%84Work%E5%B9%B6%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%E4%BA%86%EF%BC%8C%E5%85%B7%E4%BD%93%E7%95%99%E5%BE%85%E7%AC%AC3%E8%8A%82%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch1%3E%3Ca+id%3D%222_workerWorkAgent_190%22%3E%3C%2Fa%3E2.+worker%E6%89%93%E5%8C%85%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%8F%91%E9%80%81Work%E7%BB%99Agent%3C%2Fh1%3E+%0A++%3Cp%3E%E5%88%9A%E5%88%9A%E6%8F%90%E5%88%B0%E4%BA%86commitNewWork%28%29%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%8C%E6%88%90%E4%B8%BB%E8%A6%81%E7%9A%84%E5%8C%BA%E5%9D%97%E6%89%93%E5%8C%85%E5%B7%A5%E4%BD%9C%E3%80%82%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E6%AF%94%E8%BE%83%E9%95%BF%EF%BC%8C%E5%88%86%E6%88%90%E5%87%A0%E6%AE%B5%E6%9D%A5%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2221__194%22%3E%3C%2Fa%3E2.1+%E5%88%9B%E5%BB%BA%E6%96%B0%E5%8C%BA%E5%9D%97%E5%A4%B4%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++parent+%3A%3D+self.chain.CurrentBlock%28%29%0A++++%E2%80%A6%E2%80%A6%0A%0A++++num+%3A%3D+parent.Number%28%29%0A++++header+%3A%3D+%26amp%3Btypes.Header%7B%0A++++++++ParentHash%3A+parent.Hash%28%29%2C%0A++++++++Number%3A+++++num.Add%28num%2C+common.Big1%29%2C%0A++++++++GasLimit%3A+++core.CalcGasLimit%28parent%29%2C%0A++++++++Extra%3A++++++self.extra%2C%0A++++++++Time%3A+++++++big.NewInt%28tstamp%29%2C%0A++++%7D%0A%0A++++if+atomic.LoadInt32%28%26amp%3Bself.mining%29+%3D%3D+1+%7B%0A++++++++header.Coinbase+%3D+self.coinbase%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E9%A6%96%E5%85%88%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%EF%BC%8C%E7%84%B6%E5%90%8E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAHeader%E7%BB%93%E6%9E%84%EF%BC%8C%E5%A1%AB%E5%85%85%E7%88%B6%E5%9D%97hash%E3%80%81%E5%8C%BA%E5%9D%97%E9%AB%98%E5%BA%A6%E3%80%81GasLimit%E3%80%81%E7%9F%BF%E5%B7%A5%E5%9C%B0%E5%9D%80%EF%BC%88Coinbase%EF%BC%89%E7%AD%89%E4%BF%A1%E6%81%AF%E3%80%82%3Cbr%3E+%E5%85%B6%E4%B8%ADGasLimit%E6%98%AF%E5%8C%BA%E5%9D%97%E4%B8%AD%E6%89%93%E5%8C%85%E7%9A%84%E4%BA%A4%E6%98%93%E6%B6%88%E8%80%97%E7%9A%84%E6%80%BBgas%E7%9A%84%E4%B8%8A%E9%99%90%EF%BC%8C%E9%80%9A%E8%BF%87CalcGasLimit%28%29%E5%87%BD%E6%95%B0%E8%AE%A1%E7%AE%97%E5%87%BA%E6%9D%A5%E3%80%82%E8%BF%99%E4%B8%AA%E5%80%BC%E6%98%AF%E6%AF%8F%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%83%BD%E4%BC%9A%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4%E7%9A%84%EF%BC%9A%E5%A6%82%E6%9E%9C%E4%B8%8A%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%B6%88%E8%80%97%E7%9A%84%E6%80%BBgas+%26lt%3B+gas+limit%E7%9A%842%2F3%EF%BC%8C%E5%88%99%E5%A2%9E%E5%A4%A7gas+limit%EF%BC%8C%E5%90%A6%E5%88%99%E5%87%8F%E5%B0%8Fgas+limit%E3%80%82%E9%80%9A%E8%BF%87%E8%BF%99%E7%A7%8D%E6%96%B9%E5%BC%8F%E5%8F%AF%E4%BB%A5%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4%E5%8C%BA%E5%9D%97%E7%9A%84%E5%A4%A7%E5%B0%8F%E3%80%82%3Cbr%3E+%E6%9C%89%E5%85%B4%E8%B6%A3%E5%8F%AF%E4%BB%A5%E5%88%B0core%2Fblock_validator.go%E4%B8%AD%E6%9F%A5%E9%98%85%E5%85%B7%E4%BD%93%E4%BB%A3%E7%A0%81%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2222__216%22%3E%3C%2Fa%3E2.2+%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++if+err+%3A%3D+self.engine.Prepare%28self.chain%2C+header%29%3B+err+%21%3D+nil+%7B%0A++++++++log.Error%28%22Failed+to+prepare+header+for+mining%22%2C+%22err%22%2C+err%29%0A++++++++return%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%B0%83%E7%94%A8%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%E7%9A%84Prepare%28%29%E5%87%BD%E6%95%B0%E3%80%82%E9%BB%98%E8%AE%A4%E4%BD%BF%E7%94%A8%E5%9F%BA%E4%BA%8EPOW%E7%AE%97%E6%B3%95%E7%9A%84Ethash%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E4%B8%80%E4%B8%8BEthash%E7%9A%84Prepare%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28ethash+*Ethash%29+Prepare%28chain+consensus.ChainReader%2C+header+*types.Header%29+error+%7B%0A++++parent+%3A%3D+chain.GetHeader%28header.ParentHash%2C+header.Number.Uint64%28%29-1%29%0A++++if+parent+%3D%3D+nil+%7B%0A++++++++return+consensus.ErrUnknownAncestor%0A++++%7D%0A++++header.Difficulty+%3D+ethash.CalcDifficulty%28chain%2C+header.Time.Uint64%28%29%2C+parent%29%0A++++return+nil%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E9%A6%96%E5%85%88%E8%8E%B7%E5%8F%96%E7%88%B6%E5%9D%97%E7%9A%84Header%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E5%85%B6%E4%B8%AD%E7%9A%84%E4%BF%A1%E6%81%AF%E8%AE%A1%E7%AE%97%E6%96%B0%E7%9A%84%E6%8C%96%E7%9F%BF%E9%9A%BE%E5%BA%A6%E5%80%BC%E3%80%82%E5%85%B7%E4%BD%93%E9%80%BB%E8%BE%91%E7%95%99%E5%BE%85%E5%88%86%E6%9E%90%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%E7%9A%84%E6%97%B6%E5%80%99%E5%86%8D%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2223_Work_236%22%3E%3C%2Fa%3E2.3+%E5%88%9B%E5%BB%BA%E6%96%B0Work%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++err+%3A%3D+self.makeCurrent%28parent%2C+header%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E7%9C%8B%E4%B8%80%E4%B8%8BmakeCurrent%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+makeCurrent%28parent+*types.Block%2C+header+*types.Header%29+error+%7B%0A++++state%2C+err+%3A%3D+self.chain.StateAt%28parent.Root%28%29%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++return+err%0A++++%7D%0A++++work+%3A%3D+%26amp%3BWork%7B%0A++++++++config%3A++++self.config%2C%0A++++++++signer%3A++++types.NewEIP155Signer%28self.config.ChainId%29%2C%0A++++++++state%3A+++++state%2C%0A++++++++ancestors%3A+set.New%28%29%2C%0A++++++++family%3A++++set.New%28%29%2C%0A++++++++uncles%3A++++set.New%28%29%2C%0A++++++++header%3A++++header%2C%0A++++++++createdAt%3A+time.Now%28%29%2C%0A++++%7D%0A%0A++++%2F%2F+when+08+is+processed+ancestors+contain+07+%28quick+block%29%0A++++for+_%2C+ancestor+%3A%3D+range+self.chain.GetBlocksFromHash%28parent.Hash%28%29%2C+7%29+%7B%0A++++++++for+_%2C+uncle+%3A%3D+range+ancestor.Uncles%28%29+%7B%0A++++++++++++work.family.Add%28uncle.Hash%28%29%29%0A++++++++%7D%0A++++++++work.family.Add%28ancestor.Hash%28%29%29%0A++++++++work.ancestors.Add%28ancestor.Hash%28%29%29%0A++++%7D%0A%0A++++%2F%2F+Keep+track+of+transactions+which+return+errors+so+they+can+be+removed%0A++++work.tcount+%3D+0%0A++++self.current+%3D+work%0A++++return+nil%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E9%A6%96%E5%85%88%E6%A0%B9%E6%8D%AE%E7%88%B6%E5%9D%97%E7%8A%B6%E6%80%81%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84StateDB%E5%AE%9E%E4%BE%8B%E3%80%82%3Cbr%3E+%E7%84%B6%E5%90%8E%E5%88%9B%E5%BB%BAWork%E5%AE%9E%E4%BE%8B%EF%BC%8C%E4%B8%BB%E8%A6%81%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%86%E5%AE%83%E7%9A%84state%E5%92%8Cheader%E5%AD%97%E6%AE%B5%E3%80%82%3Cbr%3E+%E6%8E%A5%E4%B8%8B%E6%9D%A5%E8%BF%98%E8%A6%81%E6%9B%B4%E6%96%B0Work%E4%B8%AD%E5%92%8C%E5%8F%94%E5%9D%97%EF%BC%88Uncle+Block%EF%BC%89%E7%9B%B8%E5%85%B3%E7%9A%84%E5%AD%97%E6%AE%B5%EF%BC%8C%E5%85%B3%E4%BA%8E%E5%8F%94%E5%9D%97%E5%8F%AF%E4%BB%A5%E5%8F%82%E8%A7%81%E4%B8%8B%E9%9D%A2%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%9A%3Cbr%3E+%3Ca+href%3D%22https%3A%2F%2Fblog.csdn.net%2Fsuperswords%2Farticle%2Fdetails%2F76445278%22+rel%3D%22nofollow%22%3Ehttps%3A%2F%2Fblog.csdn.net%2Fsuperswords%2Farticle%2Fdetails%2F76445278%3C%2Fa%3E%3C%2Fp%3E+%0A++%3Cp%3E%E6%9C%80%E5%90%8E%E6%8A%8A%E6%96%B0%E5%88%9B%E5%BB%BA%E7%9A%84Work%E5%AE%9E%E4%BE%8B%E8%B5%8B%E5%80%BC%E7%BB%99self.current%E5%AD%97%E6%AE%B5%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2224__280%22%3E%3C%2Fa%3E2.4+%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++work+%3A%3D+self.current%0A++++%E2%80%A6%E2%80%A6%0A++++pending%2C+err+%3A%3D+self.eth.TxPool%28%29.Pending%28%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++log.Error%28%22Failed+to+fetch+pending+transactions%22%2C+%22err%22%2C+err%29%0A++++++++return%0A++++%7D%0A++++txs+%3A%3D+types.NewTransactionsByPriceAndNonce%28self.current.signer%2C+pending%29%0A++++work.commitTransactions%28self.mux%2C+txs%2C+self.chain%2C+self.coinbase%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E9%A6%96%E5%85%88%E8%8E%B7%E5%8F%96txpool%E7%9A%84%E5%BE%85%E5%A4%84%E7%90%86%E4%BA%A4%E6%98%93%E5%88%97%E8%A1%A8%E7%9A%84%E4%B8%80%E4%B8%AA%E6%8B%B7%E8%B4%9D%EF%BC%8C%E7%84%B6%E5%90%8E%E5%B0%81%E8%A3%85%E8%BF%9B%E4%B8%80%E4%B8%AATransactionsByPriceAndNonce%E7%B1%BB%E5%9E%8B%E7%9A%84%E7%BB%93%E6%9E%84%E4%B8%AD%E3%80%82%E8%BF%99%E4%B8%AA%E7%BB%93%E6%9E%84%E4%B8%AD%E5%8C%85%E5%90%AB%E4%B8%80%E4%B8%AAheads%E5%AD%97%E6%AE%B5%EF%BC%8C%E6%8A%8A%E4%BA%A4%E6%98%93%E6%8C%89%E7%85%A7gas+price%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F%EF%BC%8C%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89%E5%8F%82%E8%A7%81%E4%BB%A5%E4%B8%8B%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Etype+TransactionsByPriceAndNonce+struct+%7B%0A++++txs++++map%5Bcommon.Address%5DTransactions+%2F%2F+Per+account+nonce-sorted+list+of+transactions%0A++++heads++TxByPrice+++++++++++++++++++++++%2F%2F+Next+transaction+for+each+unique+account+%28price+heap%29%0A++++signer+Signer++++++++++++++++++++++++++%2F%2F+Signer+for+the+set+of+transactions%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%B0%B1%E6%98%AF%E8%B0%83%E7%94%A8commitTransactions%28%29%E6%8A%8A%E4%BA%A4%E6%98%93%E6%8F%90%E4%BA%A4%E5%88%B0EVM%E5%8E%BB%E6%89%A7%E8%A1%8C%E4%BA%86%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28env+*Work%29+commitTransactions%28mux+*event.TypeMux%2C+txs+*types.TransactionsByPriceAndNonce%2C+bc+*core.BlockChain%2C+coinbase+common.Address%29+%7B%0A++++gp+%3A%3D+new%28core.GasPool%29.AddGas%28env.header.GasLimit%29%0A++++%E2%80%A6%E2%80%A6%0A%0A++++for+%7B%0A++++++++%2F%2F+If+we+don%27t+have+enough+gas+for+any+further+transactions+then+we%27re+done%0A++++++++if+gp.Gas%28%29+%26lt%3B+params.TxGas+%7B%0A++++++++++++log.Trace%28%22Not+enough+gas+for+further+transactions%22%2C+%22gp%22%2C+gp%29%0A++++++++++++break%0A++++++++%7D%0A++++++++%2F%2F+Retrieve+the+next+transaction+and+abort+if+all+done%0A++++++++tx+%3A%3D+txs.Peek%28%29%0A++++++++if+tx+%3D%3D+nil+%7B%0A++++++++++++break%0A++++++++%7D%0A++++++++%E2%80%A6%E2%80%A6%0A%0A++++++++from%2C+_+%3A%3D+types.Sender%28env.signer%2C+tx%29%0A++++++++%E2%80%A6%E2%80%A6%0A%0A++++++++%2F%2F+Start+executing+the+transaction%0A++++++++env.state.Prepare%28tx.Hash%28%29%2C+common.Hash%7B%7D%2C+env.tcount%29%0A++++++++err%2C+logs+%3A%3D+env.commitTransaction%28tx%2C+bc%2C+coinbase%2C+gp%29%0A++++++++switch+err+%7B%0A++++++++%E2%80%A6%E2%80%A6%0A%0A++++++++case+nil%3A%0A++++++++++++%2F%2F+Everything+ok%2C+collect+the+logs+and+shift+in+the+next+transaction+from+the+same+account%0A++++++++++++coalescedLogs+%3D+append%28coalescedLogs%2C+logs...%29%0A++++++++++++env.tcount%2B%2B%0A++++++++++++txs.Shift%28%29%0A++++++++%E2%80%A6%E2%80%A6%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3EGasPool%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AFuint64%E7%B1%BB%E5%9E%8B%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%80%BC%E4%B8%BAGasLimit%EF%BC%8C%E5%90%8E%E9%9D%A2%E6%AF%8F%E6%89%A7%E8%A1%8C%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E9%83%BD%E4%BC%9A%E9%80%92%E5%87%8F%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%8E%A5%E4%B8%8B%E6%9D%A5%E8%BF%9B%E5%85%A5%E5%BE%AA%E7%8E%AF%EF%BC%8C%E9%A6%96%E5%85%88%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E5%89%A9%E4%BD%99%E7%9A%84gas%E6%98%AF%E5%90%A6%E8%BF%98%E5%A4%9F%E6%89%A7%E8%A1%8C%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%A4%9F%E7%9A%84%E8%AF%9D%E5%B0%B1%E9%80%80%E5%87%BA%E5%BE%AA%E7%8E%AF%E3%80%82%3Cbr%3E+%E7%84%B6%E5%90%8E%E4%BB%8E%E4%BA%A4%E6%98%93%E5%88%97%E8%A1%A8%E4%B8%AD%E5%8F%96%E5%87%BA%E4%B8%80%E4%B8%AA%EF%BC%8C%E8%AE%A1%E7%AE%97%E5%87%BA%E5%8F%91%E9%80%81%E6%96%B9%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%BF%9B%E8%80%8C%E6%8F%90%E4%BA%A4%E7%BB%99EVM%E6%89%A7%E8%A1%8C%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%85%88%E7%9C%8B%E4%B8%80%E4%B8%8BPrepare%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E4%BB%A3%E7%A0%81%E4%BD%8D%E4%BA%8Ecore%2Fstate%2Fstatedb.go%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*StateDB%29+Prepare%28thash%2C+bhash+common.Hash%2C+ti+int%29+%7B%0A++++self.thash+%3D+thash%0A++++self.bhash+%3D+bhash%0A++++self.txIndex+%3D+ti%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%BB%85%E4%BB%85%E6%98%AF%E5%87%A0%E4%B8%AA%E8%B5%8B%E5%80%BC%E6%93%8D%E4%BD%9C%EF%BC%8C%E8%AE%B0%E5%BD%95%E4%BA%86%E4%BA%A4%E6%98%93%E7%9A%84hash%EF%BC%8C%E5%9D%97hash%E7%9B%AE%E5%89%8D%E4%B8%BA%E7%A9%BA%EF%BC%8CtxIndex%E8%A1%A8%E6%98%8E%E8%BF%99%E6%98%AF%E6%AD%A3%E5%9C%A8%E6%89%A7%E8%A1%8C%E7%9A%84%E7%AC%AC%E5%87%A0%E7%AC%94%E4%BA%A4%E6%98%93%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E6%8E%A5%E7%9D%80%E7%9C%8BcommitTransaction%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28env+*Work%29+commitTransaction%28tx+*types.Transaction%2C+bc+*core.BlockChain%2C+coinbase+common.Address%2C+gp+*core.GasPool%29+%28error%2C+%5B%5D*types.Log%29+%7B%0A++++snap+%3A%3D+env.state.Snapshot%28%29%0A%0A++++receipt%2C+_%2C+err+%3A%3D+core.ApplyTransaction%28env.config%2C+bc%2C+%26amp%3Bcoinbase%2C+gp%2C+env.state%2C+env.header%2C+tx%2C+%26amp%3Benv.header.GasUsed%2C+vm.Config%7B%7D%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++env.state.RevertToSnapshot%28snap%29%0A++++++++return+err%2C+nil%0A++++%7D%0A++++env.txs+%3D+append%28env.txs%2C+tx%29%0A++++env.receipts+%3D+append%28env.receipts%2C+receipt%29%0A%0A++++return+nil%2C+receipt.Logs%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E9%A6%96%E5%85%88%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81%E7%9A%84%E5%BF%AB%E7%85%A7%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8ApplyTransaction%28%29%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_368%22%3E%3C%2Fa%3E%3C%2Fh4%3E+%0A++%3Cul%3E+%0A+++%3Cli%3E%E5%A6%82%E6%9E%9C%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%88%99%E5%9B%9E%E6%BB%9A%E5%88%B0%E4%B9%8B%E5%89%8D%E7%9A%84%E5%BF%AB%E7%85%A7%E7%8A%B6%E6%80%81%E5%B9%B6%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%EF%BC%8C%E8%AF%A5%E8%B4%A6%E6%88%B7%E7%9A%84%E6%89%80%E6%9C%89%E5%90%8E%E7%BB%AD%E4%BA%A4%E6%98%93%E9%83%BD%E5%B0%86%E8%A2%AB%E8%B7%B3%E8%BF%87%EF%BC%88txs.Pop%28%29%EF%BC%89%3C%2Fli%3E+%0A+++%3Cli%3E%E5%A6%82%E6%9E%9C%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F%EF%BC%8C%E5%88%99%E8%AE%B0%E5%BD%95%E8%AF%A5%E4%BA%A4%E6%98%93%E4%BB%A5%E5%8F%8A%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E7%9A%84%E5%9B%9E%E6%89%A7%EF%BC%88receipt%EF%BC%89%E5%B9%B6%E8%BF%94%E5%9B%9E%EF%BC%8C%E7%84%B6%E5%90%8E%E7%A7%BB%E5%8A%A8%E5%88%B0%E4%B8%8B%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%EF%BC%88txs.Shift%28%29%EF%BC%89%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Ch2%3E%3Ca+id%3D%2225__372%22%3E%3C%2Fa%3E2.5+%E5%A4%84%E7%90%86%E5%8F%94%E5%9D%97%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3Evar+%28%0A++++++++uncles++++%5B%5D*types.Header%0A++++++++badUncles+%5B%5Dcommon.Hash%0A++++%29%0A++++for+hash%2C+uncle+%3A%3D+range+self.possibleUncles+%7B%0A++++++++if+len%28uncles%29+%3D%3D+2+%7B%0A++++++++++++break%0A++++++++%7D%0A++++++++if+err+%3A%3D+self.commitUncle%28work%2C+uncle.Header%28%29%29%3B+err+%21%3D+nil+%7B%0A++++++++++++log.Trace%28%22Bad+uncle+found+and+will+be+removed%22%2C+%22hash%22%2C+hash%29%0A++++++++++++log.Trace%28fmt.Sprint%28uncle%29%29%0A%0A++++++++++++badUncles+%3D+append%28badUncles%2C+hash%29%0A++++++++%7D+else+%7B%0A++++++++++++log.Debug%28%22Committing+new+uncle+to+block%22%2C+%22hash%22%2C+hash%29%0A++++++++++++uncles+%3D+append%28uncles%2C+uncle.Header%28%29%29%0A++++++++%7D%0A++++%7D%0A++++for+_%2C+hash+%3A%3D+range+badUncles+%7B%0A++++++++delete%28self.possibleUncles%2C+hash%29%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E9%81%8D%E5%8E%86%E6%89%80%E6%9C%89%E5%8F%94%E5%9D%97%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8commitUncle%28%29%E6%8A%8A%E5%8F%94%E5%9D%97header%E7%9A%84hash%E6%B7%BB%E5%8A%A0%E8%BF%9BWork.uncles%E9%9B%86%E5%90%88%E4%B8%AD%E3%80%82%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%A7%84%E5%AE%9A%E6%AF%8F%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%9C%80%E5%A4%9A%E6%89%93%E5%8C%852%E4%B8%AA%E5%8F%94%E5%9D%97%E7%9A%84header%EF%BC%8C%E6%AF%8F%E6%89%93%E5%8C%85%E4%B8%80%E4%B8%AA%E5%8F%94%E5%9D%97%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%BE%97%E6%8C%96%E7%9F%BF%E6%8A%A5%E9%85%AC%E7%9A%841%2F32%E3%80%82%E7%9C%8B%E4%B8%80%E4%B8%8BcommitUncle%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+commitUncle%28work+*Work%2C+uncle+*types.Header%29+error+%7B%0A++++hash+%3A%3D+uncle.Hash%28%29%0A++++if+work.uncles.Has%28hash%29+%7B%0A++++++++return+fmt.Errorf%28%22uncle+not+unique%22%29%0A++++%7D%0A++++if+%21work.ancestors.Has%28uncle.ParentHash%29+%7B%0A++++++++return+fmt.Errorf%28%22uncle%27s+parent+unknown+%28%25x%29%22%2C+uncle.ParentHash%5B0%3A4%5D%29%0A++++%7D%0A++++if+work.family.Has%28hash%29+%7B%0A++++++++return+fmt.Errorf%28%22uncle+already+in+family+%28%25x%29%22%2C+hash%29%0A++++%7D%0A++++work.uncles.Add%28uncle.Hash%28%29%29%0A++++return+nil%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E4%BC%9A%E7%94%A8%E4%B9%8B%E5%89%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%87%A0%E4%B8%AA%E9%9B%86%E5%90%88%E6%9D%A5%E9%AA%8C%E8%AF%81%E5%8F%94%E5%9D%97%E7%9A%84%E6%9C%89%E6%95%88%E6%80%A7%EF%BC%8C%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%A7%84%E5%AE%9A%E5%8F%94%E5%9D%97%E5%BF%85%E9%A1%BB%E6%98%AF%E4%B9%8B%E5%89%8D2%EF%BD%9E7%E5%B1%82%E7%9A%84%E7%A5%96%E5%85%88%E7%9A%84%E7%9B%B4%E6%8E%A5%E5%AD%90%E5%9D%97%E3%80%82%E5%A6%82%E6%9E%9C%E5%8F%91%E7%8E%B0%E5%8F%94%E5%9D%97%E6%97%A0%E6%95%88%EF%BC%8C%E4%BC%9A%E4%BB%8E%E9%9B%86%E5%90%88%E4%B8%AD%E5%89%94%E9%99%A4%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2226__415%22%3E%3C%2Fa%3E2.6+%E6%89%93%E5%8C%85%E6%96%B0%E5%8C%BA%E5%9D%97%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++if+work.Block%2C+err+%3D+self.engine.Finalize%28self.chain%2C+header%2C+work.state%2C+work.txs%2C+uncles%2C+work.receipts%29%3B+err+%21%3D+nil+%7B%0A++++++++log.Error%28%22Failed+to+finalize+block+for+sealing%22%2C+%22err%22%2C+err%29%0A++++++++return%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%B8%87%E4%BA%8B%E4%BF%B1%E5%A4%87%EF%BC%8C%E7%8E%B0%E5%9C%A8%E9%9C%80%E8%A6%81%E6%8A%8Aheader%E3%80%81txs%E3%80%81uncles%E3%80%81receipts%E9%80%81%E5%88%B0%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%E7%9A%84Finalize%28%29%E5%87%BD%E6%95%B0%E4%B8%AD%E7%94%9F%E6%88%90%E6%96%B0%E5%8C%BA%E5%9D%97%E3%80%82%3Cbr%3E+%E7%9C%8B%E4%B8%80%E4%B8%8BEthash%E7%9A%84Finalize%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28ethash+*Ethash%29+Finalize%28chain+consensus.ChainReader%2C+header+*types.Header%2C+state+*state.StateDB%2C+txs+%5B%5D*types.Transaction%2C+uncles+%5B%5D*types.Header%2C+receipts+%5B%5D*types.Receipt%29+%28*types.Block%2C+error%29+%7B%0A++++%2F%2F+Accumulate+any+block+and+uncle+rewards+and+commit+the+final+state+root%0A++++accumulateRewards%28chain.Config%28%29%2C+state%2C+header%2C+uncles%29%0A++++header.Root+%3D+state.IntermediateRoot%28chain.Config%28%29.IsEIP158%28header.Number%29%29%0A%0A++++%2F%2F+Header+seems+complete%2C+assemble+into+a+block+and+return%0A++++return+types.NewBlock%28header%2C+txs%2C+uncles%2C+receipts%29%2C+nil%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E4%B8%BB%E8%A6%81%E5%81%9A%E4%BA%863%E4%BB%B6%E4%BA%8B%EF%BC%8C%E4%BE%9D%E6%AC%A1%E5%BC%80%E5%A7%8B%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch3%3E%3Ca+id%3D%22261__436%22%3E%3C%2Fa%3E2.6.1+%E8%AE%A1%E7%AE%97%E6%8A%A5%E9%85%AC%3C%2Fh3%3E+%0A++%3Cp%3E%E6%A0%B9%E6%8D%AE%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E8%A7%84%E5%88%99%EF%BC%9A%3Cbr%3E+%E6%AF%8F%E6%8C%96%E5%87%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%BE%975%E4%B8%AA%E4%BB%A5%E5%A4%AA%E7%9A%84%E6%8A%A5%E9%85%AC%3Cbr%3E+%E6%AF%8F%E5%8C%85%E5%90%AB%E4%B8%80%E4%B8%AA%E5%8F%94%E5%9D%97%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%BE%97%E8%AF%A5%E5%9D%97%E6%8A%A5%E9%85%AC%E7%9A%841%2F32%3Cbr%3E+%E8%A2%AB%E5%8C%85%E5%90%AB%E7%9A%84%E5%8F%94%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E7%9F%BF%E5%B7%A5%E4%B9%9F%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%85%B6%E7%A5%96%E5%85%88%E6%89%80%E5%9C%A8%E7%9A%84%E5%B1%82%E6%95%B0%E4%BE%9D%E6%AC%A1%E9%80%92%E5%87%8F%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_442%22%3E%3C%2Fa%3E%3C%2Fh4%3E+%0A++%3Cul%3E+%0A+++%3Cli%3E%E9%97%B4%E9%9A%941%E5%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%E7%9A%847%2F8%3C%2Fli%3E+%0A+++%3Cli%3E%E9%97%B4%E9%9A%942%E5%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%E7%9A%846%2F8%3C%2Fli%3E+%0A+++%3Cli%3E%E9%97%B4%E9%9A%943%E5%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%E7%9A%845%2F8%3C%2Fli%3E+%0A+++%3Cli%3E%E9%97%B4%E9%9A%944%E5%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%E7%9A%844%2F8%3C%2Fli%3E+%0A+++%3Cli%3E%E9%97%B4%E9%9A%945%E5%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%E7%9A%843%2F8%3C%2Fli%3E+%0A+++%3Cli%3E%E9%97%B4%E9%9A%946%E5%B1%82%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%94%B6%E5%88%B0%E6%8A%A5%E9%85%AC%E7%9A%842%2F8%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Cp%3E%E7%9C%8B%E4%B8%80%E4%B8%8BaccumulateRewards%28%29%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%8C%89%E7%85%A7%E4%B8%8A%E9%9D%A2%E7%9A%84%E8%A7%84%E5%88%99%E6%9D%A5%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+accumulateRewards%28config+*params.ChainConfig%2C+state+*state.StateDB%2C+header+*types.Header%2C+uncles+%5B%5D*types.Header%29+%7B%0A++++%2F%2F+Select+the+correct+block+reward+based+on+chain+progression%0A++++blockReward+%3A%3D+FrontierBlockReward%0A++++if+config.IsByzantium%28header.Number%29+%7B%0A++++++++blockReward+%3D+ByzantiumBlockReward%0A++++%7D%0A++++%2F%2F+Accumulate+the+rewards+for+the+miner+and+any+included+uncles%0A++++reward+%3A%3D+new%28big.Int%29.Set%28blockReward%29%0A++++r+%3A%3D+new%28big.Int%29%0A++++for+_%2C+uncle+%3A%3D+range+uncles+%7B%0A++++++++r.Add%28uncle.Number%2C+big8%29%0A++++++++r.Sub%28r%2C+header.Number%29%0A++++++++r.Mul%28r%2C+blockReward%29%0A++++++++r.Div%28r%2C+big8%29%0A++++++++state.AddBalance%28uncle.Coinbase%2C+r%29%0A%0A++++++++r.Div%28blockReward%2C+big32%29%0A++++++++reward.Add%28reward%2C+r%29%0A++++%7D%0A++++state.AddBalance%28header.Coinbase%2C+reward%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%AAFrontierBlockReward%E5%AE%9A%E4%B9%89%E4%B8%BA5e%2B18+wei%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF5%E4%B8%AA%E4%BB%A5%E5%A4%AA%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3EFrontierBlockReward++++*big.Int+%3D+big.NewInt%285e%2B18%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3%3E%3Ca+id%3D%22262_MPT_478%22%3E%3C%2Fa%3E2.6.2+%E7%94%9F%E6%88%90MPT%E6%A0%B9%3C%2Fh3%3E+%0A++%3Cp%3EMPT%E5%85%A8%E7%A7%B0Merkle+Patricia+Trie%EF%BC%8C%E6%98%AF%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E7%9A%84%E4%B8%80%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%EF%BC%8C%E8%BF%99%E6%A3%B5%E6%A0%91%E7%9A%84%E6%A0%B9%E9%9C%80%E8%A6%81%E5%AD%98%E5%82%A8%E5%88%B0%E5%8C%BA%E5%9D%97%E5%A4%B4%E4%B8%AD%E3%80%82%E7%9C%8B%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AAIntermediateRoot%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28s+*StateDB%29+IntermediateRoot%28deleteEmptyObjects+bool%29+common.Hash+%7B%0A++++s.Finalise%28deleteEmptyObjects%29%0A++++return+s.trie.Hash%28%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%B0%83%E7%94%A8%E4%BA%86Trie%E6%8E%A5%E5%8F%A3%E7%9A%84Hash%28%29%E6%96%B9%E6%B3%95%E6%9D%A5%E8%8E%B7%E5%8F%96MPT%E7%9A%84%E6%A0%B9hash%EF%BC%8C%E5%85%B3%E4%BA%8EMPT%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%85%B7%E4%BD%93%E7%BB%86%E8%8A%82%E5%90%8E%E9%9D%A2%E4%BC%9A%E4%B8%93%E9%97%A8%E5%86%99%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch3%3E%3Ca+id%3D%22263__489%22%3E%3C%2Fa%3E2.6.3+%E7%94%9F%E6%88%90%E6%96%B0%E5%8C%BA%E5%9D%97%3C%2Fh3%3E+%0A++%3Cp%3E%E6%9C%80%E5%90%8E%E7%9C%8B%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AANewBlock%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+NewBlock%28header+*Header%2C+txs+%5B%5D*Transaction%2C+uncles+%5B%5D*Header%2C+receipts+%5B%5D*Receipt%29+*Block+%7B%0A++++b+%3A%3D+%26amp%3BBlock%7Bheader%3A+CopyHeader%28header%29%2C+td%3A+new%28big.Int%29%7D%0A%0A++++%2F%2F+TODO%3A+panic+if+len%28txs%29+%21%3D+len%28receipts%29%0A++++if+len%28txs%29+%3D%3D+0+%7B%0A++++++++b.header.TxHash+%3D+EmptyRootHash%0A++++%7D+else+%7B%0A++++++++b.header.TxHash+%3D+DeriveSha%28Transactions%28txs%29%29%0A++++++++b.transactions+%3D+make%28Transactions%2C+len%28txs%29%29%0A++++++++copy%28b.transactions%2C+txs%29%0A++++%7D%0A%0A++++if+len%28receipts%29+%3D%3D+0+%7B%0A++++++++b.header.ReceiptHash+%3D+EmptyRootHash%0A++++%7D+else+%7B%0A++++++++b.header.ReceiptHash+%3D+DeriveSha%28Receipts%28receipts%29%29%0A++++++++b.header.Bloom+%3D+CreateBloom%28receipts%29%0A++++%7D%0A%0A++++if+len%28uncles%29+%3D%3D+0+%7B%0A++++++++b.header.UncleHash+%3D+EmptyUncleHash%0A++++%7D+else+%7B%0A++++++++b.header.UncleHash+%3D+CalcUncleHash%28uncles%29%0A++++++++b.uncles+%3D+make%28%5B%5D*Header%2C+len%28uncles%29%29%0A++++++++for+i+%3A%3D+range+uncles+%7B%0A++++++++++++b.uncles%5Bi%5D+%3D+CopyHeader%28uncles%5Bi%5D%29%0A++++++++%7D%0A++++%7D%0A%0A++++return+b%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E4%B8%BB%E8%A6%81%E5%88%86%E4%B8%BA3%E4%B8%AA%E9%83%A8%E5%88%86%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_526%22%3E%3C%2Fa%3E%3C%2Fh4%3E+%0A++%3Cul%3E+%0A+++%3Cli%3E%E7%AC%AC1%E9%83%A8%E5%88%86%E6%8A%8A%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%E7%BB%84%E7%BB%87%E6%88%90%E4%B8%80%E4%B8%AAMPT%EF%BC%8C%E5%B9%B6%E8%AE%A1%E7%AE%97%E5%AE%83%E7%9A%84%E6%A0%B9hash%3C%2Fli%3E+%0A+++%3Cli%3E%E7%AC%AC2%E9%83%A8%E5%88%86%E6%8A%8A%E6%89%80%E6%9C%89%E5%9B%9E%E6%89%A7%E7%BB%84%E7%BB%87%E6%88%90%E4%B8%80%E4%B8%AAMPT%EF%BC%8C%E5%B9%B6%E8%AE%A1%E7%AE%97%E5%AE%83%E7%9A%84%E6%A0%B9hash%EF%BC%8C%E5%8F%A6%E5%A4%96%E8%BF%98%E4%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAbloom+filter%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%98%AF%E4%B8%BA%E4%BA%86%E5%8A%A0%E5%BF%AB%E6%9F%A5%E8%AF%A2%E9%80%9F%E5%BA%A6%3C%2Fli%3E+%0A+++%3Cli%3E%E7%AC%AC3%E9%83%A8%E5%88%86%E8%AE%A1%E7%AE%97%E5%8F%94%E5%9D%97%E5%A4%B4%E7%9A%84hash%EF%BC%8C%E5%90%8C%E6%97%B6%E6%8A%8A%E5%8F%94%E5%9D%97%E5%A4%B4%E6%8B%B7%E8%B4%9D%E8%BF%9B%E5%8C%BA%E5%9D%97%E5%A4%B4%E4%B8%AD%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Ch2%3E%3Ca+id%3D%2227_AgentWork_531%22%3E%3C%2Fa%3E2.7+%E5%90%91Agent%E6%8E%A8%E9%80%81Work%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++if+atomic.LoadInt32%28%26amp%3Bself.mining%29+%3D%3D+1+%7B%0A++++++++log.Info%28%22Commit+new+mining+work%22%2C+%22number%22%2C+work.Block.Number%28%29%2C+%22txs%22%2C+work.tcount%2C+%22uncles%22%2C+len%28uncles%29%2C+%22elapsed%22%2C+common.PrettyDuration%28time.Since%28tstart%29%29%29%0A++++++++self.unconfirmed.Shift%28work.Block.NumberU64%28%29+-+1%29%0A++++%7D%0A++++self.push%28work%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E4%B8%8A%E4%B8%80%E6%AD%A5%E5%B7%B2%E7%BB%8F%E7%94%9F%E6%88%90%E6%96%B0%E5%8C%BA%E5%9D%97%E4%BA%86%EF%BC%8C%E8%BF%99%E9%87%8C%E4%BC%9A%E5%85%88%E6%8A%8A%E5%AE%83%E6%94%BE%E8%BF%9B%E6%9C%AA%E7%BB%8F%E7%A1%AE%E8%AE%A4%E7%9A%84%E5%8C%BA%E5%9D%97%E5%88%97%E8%A1%A8unconfirmed%E4%B8%AD%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8push%28%29%E6%8A%8AWork%E6%8E%A8%E9%80%81%E7%BB%99Agent%E5%8E%BB%E5%81%9APOW%E8%AE%A1%E7%AE%97%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+push%28work+*Work%29+%7B%0A++++if+atomic.LoadInt32%28%26amp%3Bself.mining%29+%21%3D+1+%7B%0A++++++++return%0A++++%7D%0A++++for+agent+%3A%3D+range+self.agents+%7B%0A++++++++atomic.AddInt32%28%26amp%3Bself.atWork%2C+1%29%0A++++++++if+ch+%3A%3D+agent.Work%28%29%3B+ch+%21%3D+nil+%7B%0A++++++++++++ch+%26lt%3B-+work%0A++++++++%7D%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E4%BC%9A%E8%B0%83%E7%94%A8Agent%E7%9A%84Work%28%29%E5%87%BD%E6%95%B0%E8%8E%B7%E5%8F%96channel%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8A%8AWork%E6%8E%A8%E9%80%81%E5%88%B0channel%E4%B8%AD%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2228__555%22%3E%3C%2Fa%3E2.8+%E6%9B%B4%E6%96%B0%E5%BF%AB%E7%85%A7%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3Eself.updateSnapshot%28%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E7%9C%8B%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AAupdateSnapshot%28%29%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+updateSnapshot%28%29+%7B%0A++++self.snapshotMu.Lock%28%29%0A++++defer+self.snapshotMu.Unlock%28%29%0A%0A++++self.snapshotBlock+%3D+types.NewBlock%28%0A++++++++self.current.header%2C%0A++++++++self.current.txs%2C%0A++++++++nil%2C%0A++++++++self.current.receipts%2C%0A++++%29%0A++++self.snapshotState+%3D+self.current.state.Copy%28%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E7%94%A8%E5%90%8C%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%9B%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E4%BC%A0%E5%8F%94%E5%9D%97%E5%88%97%E8%A1%A8%E3%80%82%E5%88%9B%E5%BB%BA%E7%9A%84%E5%8C%BA%E5%9D%97%E8%B5%8B%E5%80%BC%E7%BB%99snapshotBlock%E5%AD%97%E6%AE%B5%EF%BC%8C%E5%90%8C%E6%97%B6%E6%8A%8A%E5%BD%93%E5%89%8D%E7%9A%84state%E4%B9%9F%E5%A4%8D%E5%88%B6%E4%BA%86%E4%B8%80%E4%BB%BD%E4%BD%9C%E4%B8%BA%E5%BF%AB%E7%85%A7%E3%80%82%3C%2Fp%3E+%0A++%3Ch1%3E%3Ca+id%3D%223_AgentPOWResult_576%22%3E%3C%2Fa%3E3.+Agent%E5%AE%8C%E6%88%90POW%E8%AE%A1%E7%AE%97%E5%90%8E%E8%BF%94%E5%9B%9EResult%3C%2Fh1%3E+%0A++%3Cp%3E%E5%89%8D%E9%9D%A21.3%E8%8A%82%E6%8F%90%E5%88%B0%E8%BF%87%EF%BC%8C%E8%B0%83%E7%94%A8CpuAgent%E7%9A%84Start%28%29%E5%87%BD%E6%95%B0%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AAgoroutine%E6%89%A7%E8%A1%8Cupdate%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E7%94%A8%E4%BA%8E%E7%9B%91%E5%90%AC%E6%8E%A8%E9%80%81%E8%BF%87%E6%9D%A5%E7%9A%84Work%E3%80%82%E6%88%91%E4%BB%AC%E5%85%88%E7%9C%8B%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AAupdate%28%29%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*CpuAgent%29+update%28%29+%7B%0Aout%3A%0A++++for+%7B%0A++++++++select+%7B%0A++++++++case+work+%3A%3D+%26lt%3B-self.workCh%3A%0A++++++++++++self.mu.Lock%28%29%0A++++++++++++if+self.quitCurrentOp+%21%3D+nil+%7B%0A++++++++++++++++close%28self.quitCurrentOp%29%0A++++++++++++%7D%0A++++++++++++self.quitCurrentOp+%3D+make%28chan+struct%7B%7D%29%0A++++++++++++go+self.mine%28work%2C+self.quitCurrentOp%29%0A++++++++++++self.mu.Unlock%28%29%0A++++++++case+%26lt%3B-self.stop%3A%0A++++++++++++self.mu.Lock%28%29%0A++++++++++++if+self.quitCurrentOp+%21%3D+nil+%7B%0A++++++++++++++++close%28self.quitCurrentOp%29%0A++++++++++++++++self.quitCurrentOp+%3D+nil%0A++++++++++++%7D%0A++++++++++++self.mu.Unlock%28%29%0A++++++++++++break+out%0A++++++++%7D%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E5%9C%A8%E6%8E%A5%E6%94%B6%E5%88%B0Work%E5%90%8E%EF%BC%8C%E4%BC%9A%E8%B5%B7%E4%B8%80%E4%B8%AAgoroutine%E8%B0%83%E7%94%A8mine%28%29%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*CpuAgent%29+mine%28work+*Work%2C+stop+%26lt%3B-chan+struct%7B%7D%29+%7B%0A++++if+result%2C+err+%3A%3D+self.engine.Seal%28self.chain%2C+work.Block%2C+stop%29%3B+result+%21%3D+nil+%7B%0A++++++++log.Info%28%22Successfully+sealed+new+block%22%2C+%22number%22%2C+result.Number%28%29%2C+%22hash%22%2C+result.Hash%28%29%29%0A++++++++self.returnCh+%26lt%3B-+%26amp%3BResult%7Bwork%2C+result%7D%0A++++%7D+else+%7B%0A++++++++if+err+%21%3D+nil+%7B%0A++++++++++++log.Warn%28%22Block+sealing+failed%22%2C+%22err%22%2C+err%29%0A++++++++%7D%0A++++++++self.returnCh+%26lt%3B-+nil%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%85%88%E8%B0%83%E7%94%A8%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%E7%9A%84Seal%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E8%BF%9B%E8%A1%8CPOW%E8%AE%A1%E7%AE%97%EF%BC%8C%E4%B8%8D%E6%96%AD%E4%BF%AE%E6%94%B9nonce%E5%80%BC%E7%9B%B4%E5%88%B0%E6%89%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%B0%8F%E4%BA%8E%E9%9A%BE%E5%BA%A6%E5%80%BC%E7%9A%84hash%E3%80%82%E5%A6%82%E6%9E%9C%E8%AE%A1%E7%AE%97%E5%AE%8C%E6%88%90%EF%BC%8C%E5%B0%B1%E8%AF%B4%E6%98%8E%E6%88%90%E5%8A%9F%E6%8C%96%E5%87%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E6%96%B0%E5%9D%97%EF%BC%8C%E6%88%91%E4%BB%AC%E8%8E%B7%E5%BE%97%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E5%B0%B1%E6%98%AF%E4%B8%80%E4%B8%AA%E6%9C%89%E6%95%88%E7%9A%84Block%E3%80%82%3Cbr%3E+%E6%8A%8AWork%E5%92%8CBlock%E7%BB%84%E7%BB%87%E6%88%90%E4%B8%80%E4%B8%AAResult%E7%BB%93%E6%9E%84%EF%BC%8C%E5%8F%91%E9%80%81%E7%BB%99%E4%B9%8B%E5%89%8D%E6%B3%A8%E5%86%8C%E8%BF%94%E5%9B%9Echannel%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AFworker%E3%80%82%3C%2Fp%3E+%0A++%3Ch1%3E%3Ca+id%3D%224_worker_621%22%3E%3C%2Fa%3E4.+worker%E5%AD%98%E5%82%A8%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%90%AF%E5%8A%A8%E4%B8%8B%E4%B8%80%E6%AC%A1%E6%89%93%E5%8C%85%3C%2Fh1%3E+%0A++%3Cp%3E%E8%BF%98%E8%AE%B0%E5%BE%971.1%E8%8A%82%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84recv%E5%AD%97%E6%AE%B5%E5%92%8Cworker.wait%28%29%E5%87%BD%E6%95%B0%E5%90%97%EF%BC%9F%E5%AE%83%E4%BB%AC%E5%B0%B1%E6%98%AF%E7%94%A8%E6%9D%A5%E6%8E%A5%E6%94%B6Agent%E5%8F%91%E8%BF%87%E6%9D%A5%E7%9A%84Result%E7%9A%84%E3%80%82%3Cbr%3E+%E5%85%88%E7%9C%8B%E4%B8%80%E4%B8%8Bwait%28%29%E5%87%BD%E6%95%B0%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28self+*worker%29+wait%28%29+%7B%0A++++for+%7B%0A++++++++mustCommitNewWork+%3A%3D+true%0A++++++++for+result+%3A%3D+range+self.recv+%7B%0A++++++++++++atomic.AddInt32%28%26amp%3Bself.atWork%2C+-1%29%0A%0A++++++++++++if+result+%3D%3D+nil+%7B%0A++++++++++++++++continue%0A++++++++++++%7D%0A++++++++++++block+%3A%3D+result.Block%0A++++++++++++work+%3A%3D+result.Work%0A++++%E2%80%A6%E2%80%A6%0A%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%98%AF%E4%B8%80%E4%B8%AA%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF%EF%BC%8C%E4%BB%8Erecv%E8%BF%99%E4%B8%AAchannel%E4%B8%AD%E8%AF%BB%E5%8F%96Result%EF%BC%8C%E8%8E%B7%E5%BE%97Work%E5%92%8CBlock%E3%80%82%3Cbr%3E+%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%88%91%E4%BB%AC%E5%88%86%E6%AE%B5%E8%A7%A3%E8%AF%BB%E5%85%B6%E4%BB%96%E9%83%A8%E5%88%86%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2241_Loghash_645%22%3E%3C%2Fa%3E4.1+%E4%BF%AE%E6%94%B9Log%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%9D%97hash%E5%80%BC%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++++++++++for+_%2C+r+%3A%3D+range+work.receipts+%7B%0A++++++++++++++++for+_%2C+l+%3A%3D+range+r.Logs+%7B%0A++++++++++++++++++++l.BlockHash+%3D+block.Hash%28%29%0A++++++++++++++++%7D%0A++++++++++++%7D%0A++++++++++++for+_%2C+log+%3A%3D+range+work.state.Logs%28%29+%7B%0A++++++++++++++++log.BlockHash+%3D+block.Hash%28%29%0A++++++++++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%AALog%E6%98%AF%E7%94%A8%E6%9D%A5%E8%AE%B0%E5%BD%95%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BA%A7%E7%94%9F%E7%9A%84event%E7%9A%84%E3%80%82%E7%94%B1%E4%BA%8E%E4%B9%8B%E5%89%8D%E5%8C%BA%E5%9D%97%E5%B0%9A%E6%9C%AA%E7%94%9F%E6%88%90%EF%BC%8C%E6%89%80%E4%BB%A5%E6%97%A0%E6%B3%95%E8%AE%A1%E7%AE%97%E5%8C%BA%E5%9D%97%E7%9A%84hash%E5%80%BC%EF%BC%8C%E7%8E%B0%E5%9C%A8%E5%B7%B2%E7%BB%8F%E7%94%9F%E6%88%90%E4%BA%86%EF%BC%8C%E5%9B%A0%E6%AD%A4%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%E6%AF%8F%E4%B8%AALog%E7%9A%84BlockHash%E5%AD%97%E6%AE%B5%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2242__658%22%3E%3C%2Fa%3E4.2+%E5%B0%86%E5%8C%BA%E5%9D%97%E5%92%8C%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++++++++++stat%2C+err+%3A%3D+self.chain.WriteBlockWithState%28block%2C+work.receipts%2C+work.state%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%AAWriteBlockWithState%28%29%E5%87%BD%E6%95%B0%E7%9A%84%E4%BB%A3%E7%A0%81%E9%9D%9E%E5%B8%B8%E9%95%BF%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%88%86%E6%AE%B5%E8%BF%9B%E8%A1%8C%E8%A7%A3%E8%AF%BB%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++ptd+%3A%3D+bc.GetTd%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29+%0A++++%E2%80%A6%E2%80%A6%0A%0A++++currentBlock+%3A%3D+bc.CurrentBlock%28%29%0A++++localTd+%3A%3D+bc.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%0A++++externTd+%3A%3D+new%28big.Int%29.Add%28block.Difficulty%28%29%2C+ptd%29%0A%0A++++%2F%2F+Irrelevant+of+the+canonical+status%2C+write+the+block+itself+to+the+database%0A++++if+err+%3A%3D+bc.hc.WriteTd%28block.Hash%28%29%2C+block.NumberU64%28%29%2C+externTd%29%3B+err+%21%3D+nil+%7B%0A++++++++return+NonStatTy%2C+err%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3ETd%E5%8D%B3%E6%80%BB%E9%9A%BE%E5%BA%A6%EF%BC%88Total+Difficulty%EF%BC%89%EF%BC%8C%E7%94%B1%E4%BA%8E%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%A6%81%E6%B1%82%E6%80%BB%E6%98%AF%E9%80%89%E6%8B%A9%E6%9C%80%E9%95%BF%EF%BC%88%E6%80%BB%E9%9A%BE%E5%BA%A6%E6%9C%80%E5%A4%A7%EF%BC%89%E7%9A%84%E9%93%BE%E4%BD%9C%E4%B8%BA%E4%B8%BB%E9%93%BE%EF%BC%8C%E9%80%9A%E8%BF%87%E6%AF%94%E8%BE%83%E8%BF%99%E4%B8%A4%E4%B8%AA%E5%80%BC%E5%B0%B1%E5%8F%AF%E4%BB%A5%E7%9F%A5%E9%81%93%E8%87%AA%E5%B7%B1%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E5%9D%97%E6%98%AF%E6%9C%89%E6%95%88%E5%9D%97%E8%BF%98%E6%98%AF%E5%8F%94%E5%9D%97%E3%80%82%E8%BF%99%E9%87%8C%E8%AE%A1%E7%AE%97%E5%87%BA%E4%BA%86%E9%93%BE%E4%B8%8A%E5%BD%93%E5%89%8D%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6localTd%E5%92%8C%E6%96%B0%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E6%89%80%E5%AF%B9%E5%BA%94%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6externTd%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++batch+%3A%3D+bc.db.NewBatch%28%29%0A++++rawdb.WriteBlock%28batch%2C+block%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E5%B0%86%E6%96%B0%E6%8C%96%E5%87%BA%E7%9A%84block%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++root%2C+err+%3A%3D+state.Commit%28bc.chainConfig.IsEIP158%28block.Number%28%29%29%29%0A++++if+err+%21%3D+nil+%7B%0A++++++++return+NonStatTy%2C+err%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E5%B0%86%E6%96%B0%E7%9A%84%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E5%88%B0MPT%E4%B8%AD%EF%BC%88%E7%BC%93%E5%AD%98%EF%BC%89%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++triedb+%3A%3D+bc.stateCache.TrieDB%28%29%0A%0A++++%2F%2F+If+we%27re+running+an+archive+node%2C+always+flush%0A++++if+bc.cacheConfig.Disabled+%7B%0A++++++++if+err+%3A%3D+triedb.Commit%28root%2C+false%29%3B+err+%21%3D+nil+%7B%0A++++++++++++return+NonStatTy%2C+err%0A++++++++%7D%0A++++%7D+else+%7B%0A++++++++%E2%80%A6%E2%80%A6%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E5%B0%86%E6%96%B0%E7%9A%84%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++rawdb.WriteReceipts%28batch%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+receipts%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E5%B0%86%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E7%9A%84%E5%9B%9E%E6%89%A7%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++reorg+%3A%3D+externTd.Cmp%28localTd%29+%26gt%3B+0%0A++++currentBlock+%3D+bc.CurrentBlock%28%29%0A++++if+%21reorg+%26amp%3B%26amp%3B+externTd.Cmp%28localTd%29+%3D%3D+0+%7B%0A++++++++%2F%2F+Split+same-difficulty+blocks+by+number%2C+then+at+random%0A++++++++reorg+%3D+block.NumberU64%28%29+%26lt%3B+currentBlock.NumberU64%28%29+%7C%7C+%28block.NumberU64%28%29+%3D%3D+currentBlock.NumberU64%28%29+%26amp%3B%26amp%3B+mrand.Float64%28%29+%26lt%3B+0.5%29%0A++++%7D%0A++++if+reorg+%7B%0A++++++++%2F%2F+Reorganise+the+chain+if+the+parent+is+not+the+head+block%0A++++++++if+block.ParentHash%28%29+%21%3D+currentBlock.Hash%28%29+%7B%0A++++++++++++if+err+%3A%3D+bc.reorg%28currentBlock%2C+block%29%3B+err+%21%3D+nil+%7B%0A++++++++++++++++return+NonStatTy%2C+err%0A++++++++++++%7D%0A++++++++%7D%0A++++++++%2F%2F+Write+the+positional+metadata+for+transaction%2Freceipt+lookups+and+preimages%0A++++++++rawdb.WriteTxLookupEntries%28batch%2C+block%29%0A++++++++rawdb.WritePreimages%28batch%2C+block.NumberU64%28%29%2C+state.Preimages%28%29%29%0A%0A++++++++status+%3D+CanonStatTy%0A++++%7D+else+%7B%0A++++++++status+%3D+SideStatTy%0A++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E9%A6%96%E5%85%88%E5%88%A4%E6%96%ADexternTd%E5%92%8ClocalTd%E7%9A%84%E5%A4%A7%E5%B0%8F%EF%BC%8C%E4%BC%9A%E5%87%BA%E7%8E%B03%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%9A%3C%2Fp%3E+%0A++%3Ch4%3E%3Ca+id%3D%22_730%22%3E%3C%2Fa%3E%3C%2Fh4%3E+%0A++%3Cul%3E+%0A+++%3Cli%3EexternTd+%26gt%3B+localTd%EF%BC%9A%E8%AF%B4%E6%98%8E%E6%96%B0%E6%8C%96%E5%87%BA%E7%9A%84%E5%8C%BA%E5%9D%97%E6%98%AF%E6%9C%89%E6%95%88%E5%9D%97%EF%BC%8C%E6%9C%89%E8%B5%84%E6%A0%BC%E4%BD%9C%E4%B8%BA%E9%93%BE%E5%A4%B4%3C%2Fli%3E+%0A+++%3Cli%3EexternTd+%26lt%3B+localTd%EF%BC%9A%E8%AF%B4%E6%98%8E%E5%B7%B2%E7%BB%8F%E6%9C%89%E4%BA%BA%E5%9C%A8%E4%BD%A0%E4%B9%8B%E5%89%8D%E6%8C%96%E5%87%BA%E4%BA%86%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%B8%94%E6%80%BB%E9%9A%BE%E5%BA%A6%E6%9B%B4%E9%AB%98%EF%BC%8C%E4%BD%A0%E6%8C%96%E5%87%BA%E7%9A%84%E6%98%AF%E5%8F%94%E5%9D%97%3C%2Fli%3E+%0A+++%3Cli%3EexternTd+%3D+localTd%EF%BC%9A%E8%AF%B4%E6%98%8E%E5%B7%B2%E7%BB%8F%E6%9C%89%E4%BA%BA%E5%9C%A8%E4%BD%A0%E4%B9%8B%E5%89%8D%E6%8C%96%E5%87%BA%E4%BA%86%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%B8%94%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%92%8C%E4%BD%A0%E7%9B%B8%E5%90%8C%E3%80%82%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%E5%BA%94%E8%AF%A5%E6%9E%81%E5%B0%91%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%87%BA%E7%8E%B0%E7%9A%84%E8%AF%9D%EF%BC%8C%E9%80%9A%E8%BF%87%E4%B8%80%E4%B8%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%9D%A5%E5%86%B3%E7%AD%96%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E6%8E%A5%E5%8F%97%E6%96%B0%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E5%9D%97%E4%BD%9C%E4%B8%BA%E9%93%BE%E5%A4%B4%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Cp%3E%E5%A6%82%E6%9E%9C%E5%86%B3%E5%AE%9A%E6%8E%A5%E5%8F%97%E6%96%B0%E6%8C%96%E5%87%BA%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BD%9C%E4%B8%BA%E9%93%BE%E5%A4%B4%EF%BC%8C%E5%88%99%E9%9C%80%E8%A6%81%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E9%93%BE%E5%A4%B4%E6%98%AF%E5%90%A6%E6%98%AF%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%9D%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E7%9A%84%E8%AF%9D%E9%9C%80%E8%A6%81%E8%BF%9B%E8%A1%8C%E9%87%8D%E7%BB%84%EF%BC%8C%E5%90%8C%E6%97%B6%E6%8A%8A%E7%8A%B6%E6%80%81%E8%AE%BE%E7%BD%AE%E4%B8%BACanonStatTy%E3%80%82%E5%90%A6%E5%88%99%E7%9A%84%E8%AF%9D%E6%8A%8A%E7%8A%B6%E6%80%81%E8%AE%BE%E7%BD%AE%E4%B8%BASideStatTy%E3%80%82%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3E++++if+status+%3D%3D+CanonStatTy+%7B%0A++++++++bc.insert%28block%29%0A++++%7D%0A++++bc.futureBlocks.Remove%28block.Hash%28%29%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%9C%80%E5%90%8E%E5%A6%82%E6%9E%9C%E5%8F%91%E7%8E%B0%E7%8A%B6%E6%80%81%E6%98%AFCanonStatTy%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%96%B0%E6%8C%96%E5%87%BA%E7%9A%84%E5%8C%BA%E5%9D%97%E6%98%AF%E6%9C%89%E6%95%88%E5%9D%97%EF%BC%8C%E6%8F%92%E5%85%A5%E6%96%B0%E5%8C%BA%E5%9D%97%E4%BD%9C%E4%B8%BA%E9%93%BE%E5%A4%B4%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2243_NewMinedBlockEvent_744%22%3E%3C%2Fa%3E4.3+%E5%8F%91%E9%80%81NewMinedBlockEvent%E4%BA%8B%E4%BB%B6%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++++++++++self.mux.Post%28core.NewMinedBlockEvent%7BBlock%3A+block%7D%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%8F%91%E9%80%81%E8%BF%99%E4%B8%AA%E4%BA%8B%E4%BB%B6%E6%98%AF%E4%B8%BA%E4%BA%86%E6%8A%8A%E6%96%B0%E6%8C%96%E5%87%BA%E7%9A%84%E5%8C%BA%E5%9D%97%E5%B9%BF%E6%92%AD%E7%BB%99%E5%85%B6%E4%BB%96%E7%BB%93%E7%82%B9%EF%BC%8C%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E4%BB%A3%E7%A0%81%E4%BD%8D%E4%BA%8Eeth%2Fhandler.go%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre%3E%3Ccode%3Efunc+%28pm+*ProtocolManager%29+minedBroadcastLoop%28%29+%7B%0A++++%2F%2F+automatically+stops+if+unsubscribe%0A++++for+obj+%3A%3D+range+pm.minedBlockSub.Chan%28%29+%7B%0A++++++++switch+ev+%3A%3D+obj.Data.%28type%29+%7B%0A++++++++case+core.NewMinedBlockEvent%3A%0A++++++++++++pm.BroadcastBlock%28ev.Block%2C+true%29++%2F%2F+First+propagate+block+to+peers%0A++++++++++++pm.BroadcastBlock%28ev.Block%2C+false%29+%2F%2F+Only+then+announce+to+the+rest%0A++++++++%7D%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch2%3E%3Ca+id%3D%2244_ChainEvent_761%22%3E%3C%2Fa%3E4.4+%E5%8F%91%E9%80%81ChainEvent%E4%BA%8B%E4%BB%B6%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++++++++++var+%28%0A++++++++++++++++events+%5B%5Dinterface%7B%7D%0A++++++++++++++++logs+++%3D+work.state.Logs%28%29%0A++++++++++++%29%0A++++++++++++events+%3D+append%28events%2C+core.ChainEvent%7BBlock%3A+block%2C+Hash%3A+block.Hash%28%29%2C+Logs%3A+logs%7D%29%0A++++++++++++if+stat+%3D%3D+core.CanonStatTy+%7B%0A++++++++++++++++events+%3D+append%28events%2C+core.ChainHeadEvent%7BBlock%3A+block%7D%29%0A++++++++++++%7D%0A++++++++++++self.chain.PostChainEvents%28events%2C+logs%29%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%90%9C%E4%BA%86%E4%B8%80%E4%B8%8B%E4%BC%BC%E4%B9%8E%E5%8F%AA%E6%9C%89filter%E8%AE%A2%E9%98%85%E4%BA%86%E8%BF%99%E4%B8%AA%E4%BA%8B%E4%BB%B6%EF%BC%8C%E7%AD%89%E4%BB%A5%E5%90%8E%E9%81%87%E5%88%B0%E4%BA%86%E5%86%8D%E5%88%86%E6%9E%90%E3%80%82%3C%2Fp%3E+%0A++%3Ch2%3E%3Ca+id%3D%2245__775%22%3E%3C%2Fa%3E4.5+%E5%90%AF%E5%8A%A8%E4%B8%8B%E4%B8%80%E6%AC%A1%E6%89%93%E5%8C%85%3C%2Fh2%3E+%0A++%3Cpre%3E%3Ccode%3E++++++++++++self.unconfirmed.Insert%28block.NumberU64%28%29%2C+block.Hash%28%29%29%0A%0A++++++++++++if+mustCommitNewWork+%7B%0A++++++++++++++++self.commitNewWork%28%29%0A++++++++++++%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E4%B8%AA%E6%AF%94%E8%BE%83%E7%AE%80%E5%8D%95%EF%BC%8C%E5%B0%B1%E6%98%AF%E6%9B%B4%E6%96%B0unconfirm%E5%88%97%E8%A1%A8%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E6%AC%A1%E8%B0%83%E7%94%A8commitNewWork%28%29%E5%90%AF%E5%8A%A8%E4%B8%8B%E4%B8%80%E6%AC%A1%E6%89%93%E5%8C%85%E3%80%82%3Cbr%3E+%E8%BF%99%E6%A0%B7%E5%B0%B1%E5%AE%8C%E6%88%90%E4%BA%86%E4%B8%80%E6%AC%A1%E5%AE%8C%E6%95%B4%E7%9A%84%E6%8C%96%E7%9F%BF%E6%B5%81%E7%A8%8B%EF%BC%8C%E5%9B%9E%E5%88%B0%E4%BA%86%E5%8E%9F%E7%82%B9%E3%80%82%E4%BB%A5Miner%E8%B0%83%E7%94%A8commitNewWork%28%29%E5%BC%80%E5%A7%8B%EF%BC%8C%E5%88%B0%E6%9C%80%E5%90%8Eworker%E5%86%8D%E6%AC%A1%E8%B0%83%E7%94%A8commitNewWork%28%29%E5%90%AF%E5%8A%A8%E4%B8%8B%E4%B8%80%E6%AC%A1%E6%89%93%E5%8C%85%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E8%87%B3%E6%AD%A4%EF%BC%8C%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%8C%96%E7%9F%BF%E7%9B%B8%E5%85%B3%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81%E5%B0%B1%E5%88%86%E6%9E%90%E5%AE%8C%E6%AF%95%E4%BA%86%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cfont+color%3D%22%23ff0000%22%3E%E6%9B%B4%E5%A4%9A%E6%96%87%E7%AB%A0%E6%AC%A2%E8%BF%8E%E5%85%B3%E6%B3%A8%E2%80%9C%E9%91%AB%E9%91%AB%E7%82%B9%E7%81%AF%E2%80%9D%E4%B8%93%E6%A0%8F%EF%BC%9A%3C%2Ffont%3E%3Ca+href%3D%22https%3A%2F%2Fblog.csdn.net%2Fturkeycock%2Farticle%2Fcategory%2F7669858%22+rel%3D%22nofollow%22%3Ehttps%3A%2F%2Fblog.csdn.net%2Fturkeycock%2Farticle%2Fcategory%2F7669858%3C%2Fa%3E%3Cbr%3E+%3Cfont+color%3D%22green%22%3E%E6%88%96%E5%85%B3%E6%B3%A8%E9%A3%9E%E4%B9%85%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%EF%BC%9A%3C%2Ffont%3E%3Cbr%3E+%3Cimg+src%3D%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F20181030102458644.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R1cmtleUNvY2s%3D%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22+alt%3D%22%E5%9C%A8%E8%BF%99%E9%87%8C%E6%8F%92%E5%85%A5%E5%9B%BE%E7%89%87%E6%8F%8F%E8%BF%B0%22%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A+%3Clink+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Fmdeditor%2Fmarkdown_views-7f770a53f2.css%22+rel%3D%22stylesheet%22%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FTurkeyCock%2Farticle%2Fdetails%2F80586951%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FTurkeyCock%2Farticle%2Fdetails%2F80586951%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}