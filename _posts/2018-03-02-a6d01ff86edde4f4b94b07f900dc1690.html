---
layout: default
title: 以太坊智能合约部署——一个简单的投票系统
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3E%E9%A6%96%E5%85%88%E5%9C%A8%3Ca+href%3D%22http%3A%2F%2Fremix.ethereum.org%22+rel%3D%22nofollow%22%3ERemix%3C%2Fa%3E%E4%B8%8A%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95%3C%2Fp%3E%0A++%3Cp%3E%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Epragma+solidity+%5E0.4.16%3B%0A%0A%2F%2F%2F+%40title+Voting+with+delegation.%0Acontract+Ballot+%7B%0A++++%2F%2F+This+declares+a+new+complex+type+which+will%0A++++%2F%2F+be+used+for+variables+later.%0A++++%2F%2F+It+will+represent+a+single+voter.%0A++++struct+Voter+%7B%0A++++++++uint+weight%3B+%2F%2F+weight+is+accumulated+by+delegation%0A++++++++bool+voted%3B++%2F%2F+if+true%2C+that+person+already+voted%0A++++++++address+delegate%3B+%2F%2F+person+delegated+to%0A++++++++uint+vote%3B+++%2F%2F+index+of+the+voted+proposal%0A++++%7D%0A%0A++++%2F%2F+This+is+a+type+for+a+single+proposal.%0A++++struct+Proposal+%7B%0A++++++++bytes32+name%3B+++%2F%2F+short+name+%28up+to+32+bytes%29%0A++++++++uint+voteCount%3B+%2F%2F+number+of+accumulated+votes%0A++++%7D%0A%0A++++address+public+chairperson%3B%0A%0A++++%2F%2F+This+declares+a+state+variable+that%0A++++%2F%2F+stores+a+%60Voter%60+struct+for+each+possible+address.%0A++++mapping%28address+%3D%26gt%3B+Voter%29+public+voters%3B%0A%0A++++%2F%2F+A+dynamically-sized+array+of+%60Proposal%60+structs.%0A++++Proposal%5B%5D+public+proposals%3B%0A%0A++++%2F%2F%2F+Create+a+new+ballot+to+choose+one+of+%60proposalNames%60.%0A++++function+Ballot%28bytes32%5B%5D+proposalNames%29+public+%7B%0A++++++++chairperson+%3D+msg.sender%3B%0A++++++++voters%5Bchairperson%5D.weight+%3D+1%3B%0A%0A++++++++%2F%2F+For+each+of+the+provided+proposal+names%2C%0A++++++++%2F%2F+create+a+new+proposal+object+and+add+it%0A++++++++%2F%2F+to+the+end+of+the+array.%0A++++++++for+%28uint+i+%3D+0%3B+i+%26lt%3B+proposalNames.length%3B+i%2B%2B%29+%7B%0A++++++++++++%2F%2F+%60Proposal%28%7B...%7D%29%60+creates+a+temporary%0A++++++++++++%2F%2F+Proposal+object+and+%60proposals.push%28...%29%60%0A++++++++++++%2F%2F+appends+it+to+the+end+of+%60proposals%60.%0A++++++++++++proposals.push%28Proposal%28%7B%0A++++++++++++++++name%3A+proposalNames%5Bi%5D%2C%0A++++++++++++++++voteCount%3A+0%0A++++++++++++%7D%29%29%3B%0A++++++++%7D%0A++++%7D%0A%0A++++%2F%2F+Give+%60voter%60+the+right+to+vote+on+this+ballot.%0A++++%2F%2F+May+only+be+called+by+%60chairperson%60.%0A++++function+giveRightToVote%28address+voter%29+public+%7B%0A++++++++%2F%2F+If+the+argument+of+%60require%60+evaluates+to+%60false%60%2C%0A++++++++%2F%2F+it+terminates+and+reverts+all+changes+to%0A++++++++%2F%2F+the+state+and+to+Ether+balances.+It+is+often%0A++++++++%2F%2F+a+good+idea+to+use+this+if+functions+are%0A++++++++%2F%2F+called+incorrectly.+But+watch+out%2C+this%0A++++++++%2F%2F+will+currently+also+consume+all+provided+gas%0A++++++++%2F%2F+%28this+is+planned+to+change+in+the+future%29.%0A++++++++require%28%0A++++++++++++%28msg.sender+%3D%3D+chairperson%29+%26amp%3B%26amp%3B%0A++++++++++++%21voters%5Bvoter%5D.voted+%26amp%3B%26amp%3B%0A++++++++++++%28voters%5Bvoter%5D.weight+%3D%3D+0%29%0A++++++++%29%3B%0A++++++++voters%5Bvoter%5D.weight+%3D+1%3B%0A++++%7D%0A%0A++++%2F%2F%2F+Delegate+your+vote+to+the+voter+%60to%60.%0A++++function+delegate%28address+to%29+public+%7B%0A++++++++%2F%2F+assigns+reference%0A++++++++Voter+storage+sender+%3D+voters%5Bmsg.sender%5D%3B%0A++++++++require%28%21sender.voted%29%3B%0A%0A++++++++%2F%2F+Self-delegation+is+not+allowed.%0A++++++++require%28to+%21%3D+msg.sender%29%3B%0A%0A++++++++%2F%2F+Forward+the+delegation+as+long+as%0A++++++++%2F%2F+%60to%60+also+delegated.%0A++++++++%2F%2F+In+general%2C+such+loops+are+very+dangerous%2C%0A++++++++%2F%2F+because+if+they+run+too+long%2C+they+might%0A++++++++%2F%2F+need+more+gas+than+is+available+in+a+block.%0A++++++++%2F%2F+In+this+case%2C+the+delegation+will+not+be+executed%2C%0A++++++++%2F%2F+but+in+other+situations%2C+such+loops+might%0A++++++++%2F%2F+cause+a+contract+to+get+%22stuck%22+completely.%0A++++++++while+%28voters%5Bto%5D.delegate+%21%3D+address%280%29%29+%7B%0A++++++++++++to+%3D+voters%5Bto%5D.delegate%3B%0A%0A++++++++++++%2F%2F+We+found+a+loop+in+the+delegation%2C+not+allowed.%0A++++++++++++require%28to+%21%3D+msg.sender%29%3B%0A++++++++%7D%0A%0A++++++++%2F%2F+Since+%60sender%60+is+a+reference%2C+this%0A++++++++%2F%2F+modifies+%60voters%5Bmsg.sender%5D.voted%60%0A++++++++sender.voted+%3D+true%3B%0A++++++++sender.delegate+%3D+to%3B%0A++++++++Voter+storage+delegate_+%3D+voters%5Bto%5D%3B%0A++++++++if+%28delegate_.voted%29+%7B%0A++++++++++++%2F%2F+If+the+delegate+already+voted%2C%0A++++++++++++%2F%2F+directly+add+to+the+number+of+votes%0A++++++++++++proposals%5Bdelegate_.vote%5D.voteCount+%2B%3D+sender.weight%3B%0A++++++++%7D+else+%7B%0A++++++++++++%2F%2F+If+the+delegate+did+not+vote+yet%2C%0A++++++++++++%2F%2F+add+to+her+weight.%0A++++++++++++delegate_.weight+%2B%3D+sender.weight%3B%0A++++++++%7D%0A++++%7D%0A%0A++++%2F%2F%2F+Give+your+vote+%28including+votes+delegated+to+you%29%0A++++%2F%2F%2F+to+proposal+%60proposals%5Bproposal%5D.name%60.%0A++++function+vote%28uint+proposal%29+public+%7B%0A++++++++Voter+storage+sender+%3D+voters%5Bmsg.sender%5D%3B%0A++++++++require%28%21sender.voted%29%3B%0A++++++++sender.voted+%3D+true%3B%0A++++++++sender.vote+%3D+proposal%3B%0A%0A++++++++%2F%2F+If+%60proposal%60+is+out+of+the+range+of+the+array%2C%0A++++++++%2F%2F+this+will+throw+automatically+and+revert+all%0A++++++++%2F%2F+changes.%0A++++++++proposals%5Bproposal%5D.voteCount+%2B%3D+sender.weight%3B%0A++++%7D%0A%0A++++%2F%2F%2F+%40dev+Computes+the+winning+proposal+taking+all%0A++++%2F%2F%2F+previous+votes+into+account.%0A++++function+winningProposal%28%29+public+view%0A++++++++++++returns+%28uint+winningProposal_%29%0A++++%7B%0A++++++++uint+winningVoteCount+%3D+0%3B%0A++++++++for+%28uint+p+%3D+0%3B+p+%26lt%3B+proposals.length%3B+p%2B%2B%29+%7B%0A++++++++++++if+%28proposals%5Bp%5D.voteCount+%26gt%3B+winningVoteCount%29+%7B%0A++++++++++++++++winningVoteCount+%3D+proposals%5Bp%5D.voteCount%3B%0A++++++++++++++++winningProposal_+%3D+p%3B%0A++++++++++++%7D%0A++++++++%7D%0A++++%7D%0A%0A++++%2F%2F+Calls+winningProposal%28%29+function+to+get+the+index%0A++++%2F%2F+of+the+winner+contained+in+the+proposals+array+and+then%0A++++%2F%2F+returns+the+name+of+the+winner%0A++++function+winnerName%28%29+public+view%0A++++++++++++returns+%28bytes32+winnerName_%29%0A++++%7B%0A++++++++winnerName_+%3D+proposals%5BwinningProposal%28%29%5D.name%3B%0A++++%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E7%82%B9%E5%87%BB%E7%BC%96%E8%AF%91%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180302190737116%3Fwatermark%2F2%2Ftext%2FaHR0cDovL2Jsb2cuY3Nkbi5uZXQvQ2hlbkppbmNoYW9f%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3C%2Fp%3E%0A++%3Cp%3E%E5%88%87%E6%8D%A2%E5%88%B0run%E6%A0%87%E7%AD%BE%E9%A1%B5%2C%E8%BE%93%E5%85%A5%E5%87%A0%E4%B8%AA%E6%8F%90%E6%A1%88%E5%90%8D%EF%BC%8Ccreate%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180302200511442%3Fwatermark%2F2%2Ftext%2FaHR0cDovL2Jsb2cuY3Nkbi5uZXQvQ2hlbkppbmNoYW9f%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E6%B5%8B%E8%AF%95giveRightToVote%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180302191550276%3Fwatermark%2F2%2Ftext%2FaHR0cDovL2Jsb2cuY3Nkbi5uZXQvQ2hlbkppbmNoYW9f%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E4%BB%8E%E4%B8%8A%E9%9D%A2%E5%A4%8D%E5%88%B6%E4%B8%80%E4%B8%AA%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B4%A6%E5%8F%B7%E7%9A%84%E5%9C%B0%E5%9D%80%EF%BC%8C%E7%B2%98%E8%B4%B4%E8%87%B3giveRightToVote%EF%BC%8C%E7%82%B9%E5%87%BB%E6%89%A7%E8%A1%8C%3C%2Fp%3E%0A++%3Cp%3E%E5%86%8D%E6%8A%8A%E8%AF%A5%E8%B4%A6%E5%8F%B7%E5%A4%8D%E5%88%B6%E8%87%B3voters%EF%BC%88%E8%93%9D%E8%89%B2%EF%BC%89+%EF%BC%8C%E7%82%B9%E5%87%BB%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180302192935541%3Fwatermark%2F2%2Ftext%2FaHR0cDovL2Jsb2cuY3Nkbi5uZXQvQ2hlbkppbmNoYW9f%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180302192950404%3Fwatermark%2F2%2Ftext%2FaHR0cDovL2Jsb2cuY3Nkbi5uZXQvQ2hlbkppbmNoYW9f%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E5%8F%AF%E5%8F%91%E7%8E%B0%E6%9D%83%E9%87%8D%EF%BC%88weigtht%EF%BC%89%E5%8F%91%E9%80%81%E5%8F%98%E5%8C%96%EF%BC%8C%E6%8E%88%E6%9D%83%E6%88%90%E5%8A%9F%3C%2Fp%3E%0A++%3Cp%3E%E5%85%B6%E4%BB%96%E5%8A%9F%E8%83%BD%E5%BE%85%E6%B5%8B%E8%AF%95%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FChenJinchao_%2Farticle%2Fdetails%2F79426271%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FChenJinchao_%2Farticle%2Fdetails%2F79426271%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}