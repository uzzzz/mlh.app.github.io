---
layout: default
title: 以太坊源码分析(31)eth-downloader-peer源码分析
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3Epeer%E6%A8%A1%E5%9D%97%E5%8C%85%E5%90%AB%E4%BA%86downloader%E4%BD%BF%E7%94%A8%E7%9A%84peer%E8%8A%82%E7%82%B9%EF%BC%8C%E5%B0%81%E8%A3%85%E4%BA%86%E5%90%9E%E5%90%90%E9%87%8F%EF%BC%8C%E6%98%AF%E5%90%A6%E7%A9%BA%E9%97%B2%EF%BC%8C%E5%B9%B6%E8%AE%B0%E5%BD%95%E4%BA%86%E4%B9%8B%E5%89%8D%E5%A4%B1%E8%B4%A5%E7%9A%84%E4%BF%A1%E6%81%AF%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E+%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%23%23+peer%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+peerConnection+represents+an+active+peer+from+which+hashes+and+blocks+are+retrieved.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btype+peerConnection+struct+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bid+string+%2F%2F+Unique+identifier+of+the+peer%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderIdle+int32+%2F%2F+Current+header+activity+state+of+the+peer+%28idle+%3D+0%2C+active+%3D+1%29+%E5%BD%93%E5%89%8D%E7%9A%84header%E8%8E%B7%E5%8F%96%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BblockIdle+int32+%2F%2F+Current+block+activity+state+of+the+peer+%28idle+%3D+0%2C+active+%3D+1%29%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%E5%BD%93%E5%89%8D%E7%9A%84%E5%8C%BA%E5%9D%97%E8%8E%B7%E5%8F%96%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptIdle+int32+%2F%2F+Current+receipt+activity+state+of+the+peer+%28idle+%3D+0%2C+active+%3D+1%29+%E5%BD%93%E5%89%8D%E7%9A%84%E6%94%B6%E6%8D%AE%E8%8E%B7%E5%8F%96%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateIdle+int32+%2F%2F+Current+node+data+activity+state+of+the+peer+%28idle+%3D+0%2C+active+%3D+1%29+%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E7%8A%B6%E6%80%81%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderThroughput+float64+%2F%2F+Number+of+headers+measured+to+be+retrievable+per+second%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%E8%AE%B0%E5%BD%95%E6%AF%8F%E7%A7%92%E8%83%BD%E5%A4%9F%E6%8E%A5%E6%94%B6%E5%A4%9A%E5%B0%91%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%A4%B4%E7%9A%84%E5%BA%A6%E9%87%8F%E5%80%BC%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BblockThroughput+float64+%2F%2F+Number+of+blocks+%28bodies%29+measured+to+be+retrievable+per+second+%2F%2F%E8%AE%B0%E5%BD%95%E6%AF%8F%E7%A7%92%E8%83%BD%E5%A4%9F%E6%8E%A5%E6%94%B6%E5%A4%9A%E5%B0%91%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E5%BA%A6%E9%87%8F%E5%80%BC%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptThroughput+float64+%2F%2F+Number+of+receipts+measured+to+be+retrievable+per+second+%E8%AE%B0%E5%BD%95%E6%AF%8F%E7%A7%92%E8%83%BD%E5%A4%9F%E6%8E%A5%E6%94%B6%E5%A4%9A%E5%B0%91%E4%B8%AA%E6%94%B6%E6%8D%AE%E7%9A%84%E5%BA%A6%E9%87%8F%E5%80%BC%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateThroughput+float64+%2F%2F+Number+of+node+data+pieces+measured+to+be+retrievable+per+second+%E8%AE%B0%E5%BD%95%E6%AF%8F%E7%A7%92%E8%83%BD%E5%A4%9F%E6%8E%A5%E6%94%B6%E5%A4%9A%E5%B0%91%E4%B8%AA%E8%B4%A6%E6%88%B7%E7%8A%B6%E6%80%81%E7%9A%84%E5%BA%A6%E9%87%8F%E5%80%BC%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brtt+time.Duration+%2F%2F+Request+round+trip+time+to+track+responsiveness+%28QoS%29+%E8%AF%B7%E6%B1%82%E5%9B%9E%E5%BA%94%E6%97%B6%E9%97%B4%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BheaderStarted+time.Time+%2F%2F+Time+instance+when+the+last+header+fetch+was+started%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%E8%AE%B0%E5%BD%95%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AAheader+fetch%E7%9A%84%E8%AF%B7%E6%B1%82%E6%97%B6%E9%97%B4%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BblockStarted+time.Time+%2F%2F+Time+instance+when+the+last+block+%28body%29+fetch+was+started%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BreceiptStarted+time.Time+%2F%2F+Time+instance+when+the+last+receipt+fetch+was+started%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BstateStarted+time.Time+%2F%2F+Time+instance+when+the+last+node+data+fetch+was+started%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blacking+map%5Bcommon.Hash%5Dstruct%7B%7D+%2F%2F+Set+of+hashes+not+to+request+%28didn%27t+have+previously%29+%E8%AE%B0%E5%BD%95%E7%9A%84Hash%E5%80%BC%E4%B8%8D%E4%BC%9A%E5%8E%BB%E8%AF%B7%E6%B1%82%EF%BC%8C%E4%B8%80%E8%88%AC%E6%98%AF%E5%9B%A0%E4%B8%BA%E4%B9%8B%E5%89%8D%E7%9A%84%E8%AF%B7%E6%B1%82%E5%A4%B1%E8%B4%A5%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer+Peer%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+eth%E7%9A%84peer%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bversion+int+%2F%2F+Eth+protocol+version+number+to+switch+strategies%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Blog+log.Logger+%2F%2F+Contextual+logger+to+add+extra+infos+to+peer+logs%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Block+sync.RWMutex%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E%3Cbr%3E+%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3EFetchXXX%3C%2Fp%3E+%0A++%3Cp%3EFetchHeaders+FetchBodies%E7%AD%89%E5%87%BD%E6%95%B0+%E4%B8%BB%E8%A6%81%E8%B0%83%E7%94%A8%E4%BA%86eth.peer%E7%9A%84%E5%8A%9F%E8%83%BD%E6%9D%A5%E8%BF%9B%E8%A1%8C%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E8%AF%B7%E6%B1%82%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+FetchHeaders+sends+a+header+retrieval+request+to+the+remote+peer.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28p+*peerConnection%29+FetchHeaders%28from+uint64%2C+count+int%29+error+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Sanity+check+the+protocol+version%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+p.version+%26lt%3B+62+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpanic%28fmt.Sprintf%28%22header+fetch+%5Beth%2F62%2B%5D+requested+on+eth%2F%25d%22%2C+p.version%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Short+circuit+if+the+peer+is+already+fetching%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21atomic.CompareAndSwapInt32%28%26amp%3Bp.headerIdle%2C+0%2C+1%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errAlreadyFetching%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.headerStarted+%3D+time.Now%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Issue+the+header+retrieval+request+%28absolut+upwards+without+gaps%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bgo+p.peer.RequestHeadersByNumber%28from%2C+count%2C+0%2C+false%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3ESetXXXIdle%E5%87%BD%E6%95%B0%3C%2Fp%3E+%0A++%3Cp%3ESetHeadersIdle%2C+SetBlocksIdle+%E7%AD%89%E5%87%BD%E6%95%B0+%E8%AE%BE%E7%BD%AEpeer%E7%9A%84%E7%8A%B6%E6%80%81%E4%B8%BA%E7%A9%BA%E9%97%B2%E7%8A%B6%E6%80%81%EF%BC%8C%E5%85%81%E8%AE%B8%E5%AE%83%E6%89%A7%E8%A1%8C%E6%96%B0%E7%9A%84%E8%AF%B7%E6%B1%82%E3%80%82+%E5%90%8C%E6%97%B6%E8%BF%98%E4%BC%9A%E9%80%9A%E8%BF%87%E6%9C%AC%E6%AC%A1%E4%BC%A0%E8%BE%93%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%9A%E5%B0%91%E6%9D%A5%E9%87%8D%E6%96%B0%E8%AF%84%E4%BC%B0%E9%93%BE%E8%B7%AF%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+SetHeadersIdle+sets+the+peer+to+idle%2C+allowing+it+to+execute+new+header+retrieval%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+requests.+Its+estimated+header+retrieval+throughput+is+updated+with+that+measured%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+just+now.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28p+*peerConnection%29+SetHeadersIdle%28delivered+int%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.setIdle%28p.headerStarted%2C+delivered%2C+%26amp%3Bp.headerThroughput%2C+%26amp%3Bp.headerIdle%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3EsetIdle%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+setIdle+sets+the+peer+to+idle%2C+allowing+it+to+execute+new+retrieval+requests.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Its+estimated+retrieval+throughput+is+updated+with+that+measured+just+now.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28p+*peerConnection%29+setIdle%28started+time.Time%2C+delivered+int%2C+throughput+*float64%2C+idle+*int32%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Irrelevant+of+the+scaling%2C+make+sure+the+peer+ends+up+idle%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+atomic.StoreInt32%28idle%2C+0%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.Lock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+p.lock.Unlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+If+nothing+was+delivered+%28hard+timeout+%2F+unavailable+data%29%2C+reduce+throughput+to+minimum%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+delivered+%3D%3D+0+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B*throughput+%3D+0%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Otherwise+update+the+throughput+with+a+new+measurement%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Belapsed+%3A%3D+time.Since%28started%29+%2B+1+%2F%2F+%2B1+%28ns%29+to+ensure+non-zero+divisor%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmeasured+%3A%3D+float64%28delivered%29+%2F+%28float64%28elapsed%29+%2F+float64%28time.Second%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+measurementImpact+%3D+0.1+%2C+%E6%96%B0%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F%3D%E8%80%81%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F*0.9+%2B+%E8%BF%99%E6%AC%A1%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F*0.1%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B*throughput+%3D+%281-measurementImpact%29*%28*throughput%29+%2B+measurementImpact*measured%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%9B%B4%E6%96%B0RTT%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.rtt+%3D+time.Duration%28%281-measurementImpact%29*float64%28p.rtt%29+%2B+measurementImpact*float64%28elapsed%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.log.Trace%28%22Peer+throughput+measurements+updated%22%2C%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%22hps%22%2C+p.headerThroughput%2C+%22bps%22%2C+p.blockThroughput%2C%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%22rps%22%2C+p.receiptThroughput%2C+%22sps%22%2C+p.stateThroughput%2C%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%22miss%22%2C+len%28p.lacking%29%2C+%22rtt%22%2C+p.rtt%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E+%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3EXXXCapacity%E5%87%BD%E6%95%B0%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%BF%94%E5%9B%9E%E5%BD%93%E5%89%8D%E7%9A%84%E9%93%BE%E6%8E%A5%E5%85%81%E8%AE%B8%E7%9A%84%E5%90%9E%E5%90%90%E9%87%8F%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+HeaderCapacity+retrieves+the+peers+header+download+allowance+based+on+its%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+previously+discovered+throughput.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28p+*peerConnection%29+HeaderCapacity%28targetRTT+time.Duration%29+int+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+p.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E8%BF%99%E9%87%8C%E6%9C%89%E7%82%B9%E5%A5%87%E6%80%AA%EF%BC%8CtargetRTT%E8%B6%8A%E5%A4%A7%EF%BC%8C%E8%AF%B7%E6%B1%82%E7%9A%84%E6%95%B0%E9%87%8F%E5%B0%B1%E8%B6%8A%E5%A4%9A%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+int%28math.Min%281%2Bmath.Max%281%2C+p.headerThroughput*float64%28targetRTT%29%2Ffloat64%28time.Second%29%29%2C+float64%28MaxHeaderFetch%29%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E+%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3ELacks+%E7%94%A8%E6%9D%A5%E6%A0%87%E8%AE%B0%E4%B8%8A%E6%AC%A1%E6%98%AF%E5%90%A6%E5%A4%B1%E8%B4%A5%EF%BC%8C%E4%BB%A5%E4%BE%BF%E4%B8%8B%E6%AC%A1%E5%90%8C%E6%A0%B7%E7%9A%84%E8%AF%B7%E6%B1%82%E4%B8%8D%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AApeer%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+MarkLacking+appends+a+new+entity+to+the+set+of+items+%28blocks%2C+receipts%2C+states%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+that+a+peer+is+known+not+to+have+%28i.e.+have+been+requested+before%29.+If+the%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+set+reaches+its+maximum+allowed+capacity%2C+items+are+randomly+dropped+off.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28p+*peerConnection%29+MarkLacking%28hash+common.Hash%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.Lock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+p.lock.Unlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+len%28p.lacking%29+%26gt%3B%3D+maxLackingHashes+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+drop+%3A%3D+range+p.lacking+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdelete%28p.lacking%2C+drop%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bbreak%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lacking%5Bhash%5D+%3D+struct%7B%7D%7B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Lacks+retrieves+whether+the+hash+of+a+blockchain+item+is+on+the+peers+lacking%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+list+%28i.e.+whether+we+know+that+the+peer+does+not+have+it%29.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28p+*peerConnection%29+Lacks%28hash+common.Hash%29+bool+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+p.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B_%2C+ok+%3A%3D+p.lacking%5Bhash%5D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+ok%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E+%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%23%23+peerSet%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+peerSet+represents+the+collection+of+active+peer+participating+in+the+chain%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+download+procedure.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btype+peerSet+struct+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeers+map%5Bstring%5D*peerConnection%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BnewPeerFeed+event.Feed%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3BpeerDropFeed+event.Feed%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Block+sync.RWMutex%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E+%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3ERegister+%E5%92%8C+UnRegister%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Register+injects+a+new+peer+into+the+working+set%2C+or+returns+an+error+if+the%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+peer+is+already+known.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+The+method+also+sets+the+starting+throughput+values+of+the+new+peer+to+the%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+average+of+all+existing+peers%2C+to+give+it+a+realistic+chance+of+being+used%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+for+data+retrievals.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28ps+*peerSet%29+Register%28p+*peerConnection%29+error+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Retrieve+the+current+median+RTT+as+a+sane+default%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.rtt+%3D+ps.medianRTT%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Register+the+new+peer+with+some+meaningful+defaults%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.Lock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+_%2C+ok+%3A%3D+ps.peers%5Bp.id%5D%3B+ok+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.Unlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errAlreadyRegistered%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+len%28ps.peers%29+%26gt%3B+0+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.headerThroughput%2C+p.blockThroughput%2C+p.receiptThroughput%2C+p.stateThroughput+%3D+0%2C+0%2C+0%2C+0%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+peer+%3A%3D+range+ps.peers+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.headerThroughput+%2B%3D+peer.headerThroughput%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.blockThroughput+%2B%3D+peer.blockThroughput%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.receiptThroughput+%2B%3D+peer.receiptThroughput%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.stateThroughput+%2B%3D+peer.stateThroughput%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bpeer.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.headerThroughput+%2F%3D+float64%28len%28ps.peers%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.blockThroughput+%2F%3D+float64%28len%28ps.peers%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.receiptThroughput+%2F%3D+float64%28len%28ps.peers%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.stateThroughput+%2F%3D+float64%28len%28ps.peers%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.peers%5Bp.id%5D+%3D+p%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.Unlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.newPeerFeed.Send%28p%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Unregister+removes+a+remote+peer+from+the+active+set%2C+disabling+any+further%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+actions+to%2Ffrom+that+particular+entity.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28ps+*peerSet%29+Unregister%28id+string%29+error+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.Lock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp%2C+ok+%3A%3D+ps.peers%5Bid%5D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+%21ok+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+ps.lock.Unlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+errNotRegistered%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdelete%28ps.peers%2C+id%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.Unlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.peerDropFeed.Send%28p%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+nil%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3EXXXIdlePeers%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+HeaderIdlePeers+retrieves+a+flat+list+of+all+the+currently+header-idle+peers%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+within+the+active+peer+set%2C+ordered+by+their+reputation.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28ps+*peerSet%29+HeaderIdlePeers%28%29+%28%5B%5D*peerConnection%2C+int%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bidle+%3A%3D+func%28p+*peerConnection%29+bool+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+atomic.LoadInt32%28%26amp%3Bp.headerIdle%29+%3D%3D+0%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bthroughput+%3A%3D+func%28p+*peerConnection%29+float64+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+p.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+p.headerThroughput%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+ps.idlePeers%2862%2C+64%2C+idle%2C+throughput%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+idlePeers+retrieves+a+flat+list+of+all+currently+idle+peers+satisfying+the%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+protocol+version+constraints%2C+using+the+provided+function+to+check+idleness.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+The+resulting+set+of+peers+are+sorted+by+their+measure+throughput.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28ps+*peerSet%29+idlePeers%28minProtocol%2C+maxProtocol+int%2C+idleCheck+func%28*peerConnection%29+bool%2C+throughput+func%28*peerConnection%29+float64%29+%28%5B%5D*peerConnection%2C+int%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+ps.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bidle%2C+total+%3A%3D+make%28%5B%5D*peerConnection%2C+0%2C+len%28ps.peers%29%29%2C+0%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+p+%3A%3D+range+ps.peers+%7B+%2F%2F%E9%A6%96%E5%85%88%E6%8A%BD%E5%8F%96idle%E7%9A%84peer%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+p.version+%26gt%3B%3D+minProtocol+%26amp%3B%26amp%3B+p.version+%26lt%3B%3D+maxProtocol+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+idleCheck%28p%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bidle+%3D+append%28idle%2C+p%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btotal%2B%2B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+i+%3A%3D+0%3B+i+%26lt%3B+len%28idle%29%3B+i%2B%2B+%7B+%2F%2F+%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%EF%BC%8C+%E4%BB%8E%E5%90%9E%E5%90%90%E9%87%8F%E5%A4%A7%E5%88%B0%E5%90%9E%E5%90%90%E9%87%8F%E5%B0%8F%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+j+%3A%3D+i+%2B+1%3B+j+%26lt%3B+len%28idle%29%3B+j%2B%2B+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+throughput%28idle%5Bi%5D%29+%26lt%3B+throughput%28idle%5Bj%5D%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bidle%5Bi%5D%2C+idle%5Bj%5D+%3D+idle%5Bj%5D%2C+idle%5Bi%5D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+idle%2C+total%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3EmedianRTT%2C%E6%B1%82%E5%BE%97peerset%E7%9A%84RTT%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0%EF%BC%8C%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+medianRTT+returns+the+median+RTT+of+te+peerset%2C+considering+only+the+tuning%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+peers+if+there+are+more+peers+available.%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfunc+%28ps+*peerSet%29+medianRTT%28%29+time.Duration+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Gather+all+the+currnetly+measured+round+trip+times%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bps.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bdefer+ps.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brtts+%3A%3D+make%28%5B%5Dfloat64%2C+0%2C+len%28ps.peers%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bfor+_%2C+p+%3A%3D+range+ps.peers+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.RLock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Brtts+%3D+append%28rtts%2C+float64%28p.rtt%29%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bp.lock.RUnlock%28%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bsort.Float64s%28rtts%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmedian+%3A%3D+rttMaxEstimate%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+qosTuningPeers+%26lt%3B%3D+len%28rtts%29+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmedian+%3D+time.Duration%28rtts%5BqosTuningPeers%2F2%5D%29+%2F%2F+Median+of+our+tuning+peers%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D+else+if+len%28rtts%29+%26gt%3B+0+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmedian+%3D+time.Duration%28rtts%5Blen%28rtts%29%2F2%5D%29+%2F%2F+Median+of+our+connected+peers+%28maintain+even+like+this+some+baseline+qos%29%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+Restrict+the+RTT+into+some+QoS+defaults%2C+irrelevant+of+true+RTT%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+median+%26lt%3B+rttMinEstimate+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmedian+%3D+rttMinEstimate%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bif+median+%26gt%3B+rttMaxEstimate+%7B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bmedian+%3D+rttMaxEstimate%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Breturn+median%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%7D%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%E8%BD%AC%E8%BD%BD%26nbsp%3B+%26nbsp%3B+%26nbsp%3B%26nbsp%3B%3Ca+href%3D%22https%3A%2F%2Fblog.csdn.net%2Fitcastcpp%2Farticle%2Fdetails%2F80305298%22+rel%3D%22nofollow%22%3E%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%2831%29eth-downloader-peer%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%3C%2Fa%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fzhichunqi%2Farticle%2Fdetails%2F81836188%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fzhichunqi%2Farticle%2Fdetails%2F81836188%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}