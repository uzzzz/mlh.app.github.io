---
layout: default
title: （六）Tensorflow的CNN模型构建
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-f57960eb32.css%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-f57960eb32.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22+id%3D%22content_views%22%3E+%0A++%3Ch3%3E%3Cstrong%3E%E5%88%A9%E7%94%A8tensorflow%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86%EF%BC%8C%E6%90%AD%E5%BB%BACNN%E7%BD%91%E7%BB%9C%EF%BC%882%E4%B8%AA%E5%8D%B7%E7%A7%AF%E5%B1%82%EF%BC%8C2%E4%B8%AA%E6%B1%A0%E5%8C%96%E5%B1%82%EF%BC%8C1%E4%B8%AA%E5%85%A8%E8%BF%9E%E6%8E%A5%E5%B1%82%EF%BC%89%EF%BC%8C%E5%AE%9E%E7%8E%B0%E4%BA%86%E4%BF%9D%E5%AD%98%E6%A8%A1%E5%9E%8B%EF%BC%8C%E6%96%AD%E7%82%B9%E7%BB%AD%E8%B7%91%E5%8A%9F%E8%83%BD%EF%BC%81%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Cp%3E%3Cspan+style%3D%22color%3A%23ffbb66%3B%22%3E%3Cstrong%3E1.%E4%BB%A3%E7%A0%81%E5%B1%95%E7%A4%BA%3C%2Fstrong%3E%3C%2Fspan%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-python%22%3Eimport+tensorflow+as+tf%0Afrom+tensorflow.examples.tutorials.mnist+import+input_data%0Aimport+os%0Aimport+math%0A%0An_times+%3D+100%0Amodel_save_path+%3D+r%22.%5Cmodel%22%0Amodel_name+%3D+%22model.ckpt%22%0Aiteration+%3D+0++++%23%E6%A8%A1%E5%9E%8B%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%BF%AD%E4%BB%A3%E6%AC%A1%E6%95%B0%0A%0Alearning_rate+%3D+0.001%0Abatch_size+%3D+100%0A%0Ainput_node+%3D+784%0Aoutput_node+%3D+10%0A%0Aimage_size+%3D+28%0Aimage_channels+%3D+1%0A%0Aconv1_deep+%3D+32%0Aconv1_size+%3D+5%0A%0Aconv2_deep+%3D+64%0Aconv2_size+%3D+5%0A%0Apool_size+%3D+2%0A%23+fc_size+%3D+512%0Adef+get_weights_variable%28shape%2Cname%29%3A%0A++++return+tf.get_variable%28name%3Dname%2Cinitializer%3Dtf.truncated_normal%28shape%3Dshape%2Cstddev%3D0.1%2Cseed%3D1%29%29%0A%0Adef+get_biase_variable%28shape%2Cname%29%3A%0A++++return+tf.get_variable%28name%3Dname%2Cinitializer%3Dtf.zeros%28shape%3Dshape%29%29%0A%0Adef+inference%28input_data%29%3A%0A++++%23reshape%E6%88%90%E5%8D%B7%E7%A7%AF%E7%BD%91%E7%BB%9C%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%0A++++input_data+%3D+tf.reshape%28input_data%2C%5Bbatch_size%2Cimage_size%2Cimage_size%2Cimage_channels%5D%29%0A++++%23%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8D%B7%E7%A7%AF%E5%B1%82%E5%9C%A8%E6%8E%A5%E4%B8%8A%E6%BF%80%E5%8A%B1%E5%B1%82%0A++++with+tf.variable_scope%28%22layer1-conv1%22%29%3A%0A++++++++conv1_kernel+%3D+%5Bconv1_size%2Cconv1_size%2Cimage_channels%2Cconv1_deep%5D+%23%E5%8D%B7%E7%A7%AF%E6%A0%B8%E7%9A%84%E5%A4%A7%E5%B0%8F%EF%BC%8C%EF%BC%8C%5B%E8%A1%8C%EF%BC%8C%E5%88%97%EF%BC%8C%E9%80%9A%E9%81%93%E6%95%B0%EF%BC%8C%E7%A5%9E%E7%BB%8F%E5%85%83%E6%95%B0%5D%0A++++++++conv1_weight+%3D+get_weights_variable%28conv1_kernel%2C%22conv1_kernel%22%29%0A++++++++conv1_biase+%3D+get_biase_variable%28%5Bconv1_deep%5D%2Cname%3D%22conv1_biase%22%29%0A++++++++%23strides%3D%5B1%2C1%2C1%2C1%5D%E7%AC%AC%E4%B8%80%E4%B8%AA1%E5%92%8C%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA1%E4%BB%A3%E8%A1%A8batch_size%EF%BC%8Cchannels%2C%E4%B8%80%E8%88%AC%E4%B8%8D%E4%BC%9A%E6%94%B9%E5%8F%98%EF%BC%81%0A++++++++conv1+%3D+tf.nn.conv2d%28input_data%2Cconv1_weight%2Cstrides%3D%5B1%2C1%2C1%2C1%5D%2Cpadding%3D%22SAME%22%29%0A++++++++conv1+%3D+tf.add%28tf.nn.relu%28conv1%29%2Cconv1_biase%29%0A++++%23%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%B1%A0%E5%8C%96%E5%B1%82%0A++++with+tf.variable_scope%28%22layer2-pool1%22%29%3A%0A++++++++pool_1+%3D+tf.nn.max_pool%28conv1%2Cksize%3D%5B1%2Cpool_size%2Cpool_size%2C1%5D%2Cstrides%3D%5B1%2C2%2C2%2C1%5D%2Cpadding%3D%22SAME%22%29%0A++++%23%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8D%B7%E7%A7%AF%E5%B1%82%E5%9C%A8%E6%8E%A5%E4%B8%8A%E6%BF%80%E5%8A%B1%E5%B1%82%0A++++with+tf.variable_scope%28%22layer3-conv2%22%29%3A%0A++++++++conv2_kernel+%3D+%5Bconv2_size%2Cconv2_size%2Cconv1_deep%2Cconv2_deep%5D+%23%E5%8D%B7%E7%A7%AF%E6%A0%B8%E7%9A%84%E5%A4%A7%E5%B0%8F%EF%BC%8C%EF%BC%8C%5B%E8%A1%8C%EF%BC%8C%E5%88%97%EF%BC%8C%E9%80%9A%E9%81%93%E6%95%B0%EF%BC%8C%E7%A5%9E%E7%BB%8F%E5%85%83%E6%95%B0%5D%0A++++++++conv2_weight+%3D+get_weights_variable%28conv2_kernel%2Cname%3D%22conv2_kernel%22%29%0A++++++++conv2_biase+%3D+get_biase_variable%28%5Bconv2_deep%5D%2Cname%3D%22conv2_biase%22%29%0A++++++++conv2+%3D+tf.nn.conv2d%28pool_1%2Cconv2_weight%2Cstrides%3D%5B1%2Cconv2_size%2Cconv2_size%2C1%5D%2Cpadding%3D%22SAME%22%29%0A++++++++conv2+%3D+tf.add%28tf.nn.relu%28conv2%29%2Cconv2_biase%29%0A++++%23%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%B1%A0%E5%8C%96%E5%B1%82%0A++++with+tf.variable_scope%28%22layer4-pool2%22%29%3A%0A++++++++pool_2+%3D+tf.nn.max_pool%28conv2%2Cksize%3D%5B1%2Cpool_size%2Cpool_size%2C1%5D%2Cstrides%3D%5B1%2C2%2C2%2C1%5D%2Cpadding%3D%22SAME%22%29%0A++++%23reshape%E6%88%90%E4%BA%8C%E7%BB%B4%E7%9F%A9%E9%98%B5batch_size*node%0A++++pool_shape+%3D+pool_2.get_shape%28%29.as_list%28%29%0A++++node+%3D+pool_shape%5B1%5D*pool_shape%5B2%5D*pool_shape%5B3%5D%0A++++reshaped+%3D+tf.reshape%28pool_2%2C%5Bbatch_size%2Cnode%5D%29%0A++++%23%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%85%A8%E8%BF%9E%E6%8E%A5%E5%B1%82%E5%9C%A8%E6%8E%A5%E4%B8%8A%E6%BF%80%E5%8A%B1%E5%B1%82%0A++++with+tf.variable_scope%28%22layer5%22%29%3A%0A++++++++fc_weight+%3D+get_weights_variable%28%5Bnode%2Coutput_node%5D%2Cname%3D%22fc_weight%22%29%0A++++++++fc_biase+%3D+get_biase_variable%28%5Boutput_node%5D%2Cname%3D%22fc_biase%22%29%0A++++++++fc_layer+%3D+tf.nn.relu%28tf.add%28tf.matmul%28reshaped%2Cfc_weight%29%2Cfc_biase%29%29%0A++++return+fc_layer%0A%0Adef+CNN_model%28%29%3A%0A++++%23%E8%BD%BD%E5%85%A5%E6%95%B0%E6%8D%AE%0A++++mnist+%3D+input_data.read_data_sets%28r%22C%3A%5CUsers%5CAdministrator%5CDesktop%5CAI_project%5Ctensorflow%5CMNIST_data%22%2Cone_hot%3DTrue%29%0A++++n_batch_train+%3D+math.ceil%28mnist.train.num_examples+%2F+batch_size%29%0A++++n_batch_test+%3D+math.ceil%28mnist.test.num_examples+%2F+batch_size%29%0A++++%23%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8Cplaceholder%0A++++x+%3D+tf.placeholder%28tf.float32%2C%5Bbatch_size%2Cinput_node%5D%2Cname%3D%22x_input%22%29%0A++++y+%3D+tf.placeholder%28tf.float32%2C%5Bbatch_size%2Coutput_node%5D%2Cname%3D%22y_output%22%29%0A++++%23%E4%BC%A0%E5%85%A5%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%0A++++result+%3D+inference%28x%29%0A++++%23%E5%AE%9A%E4%B9%89%E6%8D%9F%E5%A4%B1%E5%87%BD%E6%95%B0%E5%92%8C%E4%BC%98%E5%8C%96%E5%99%A8%0A++++loss+%3D+tf.reduce_mean%28tf.nn.softmax_cross_entropy_with_logits_v2%28labels%3Dy%2Clogits%3Dresult%2Cname%3D%22loss%22%29%29%0A++++train++%3D+tf.train.AdamOptimizer%28learning_rate%3Dlearning_rate%29.minimize%28loss%29%0A++++%23%E5%AF%B9%E7%BB%93%E6%9E%9C%E8%BF%9B%E8%A1%8C%E9%A2%84%E6%B5%8B%0A++++predation+%3D+tf.equal%28tf.argmax%28y%2Caxis%3D1%29%2Ctf.argmax%28result%2Caxis%3D1%29%29%0A++++accuary+%3D+tf.reduce_mean%28tf.cast%28predation%2Ctf.float32%29%29%0A++++%23%E5%AE%9A%E4%B9%89%E4%BF%9D%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%9A%84op%0A++++saver+%3D+tf.train.Saver%28%29%0A++++%23%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8F%98%E9%87%8F%0A++++init+%3D+tf.global_variables_initializer%28%29%0A++++%23%E8%BF%90%E7%94%A8session%E6%89%A7%E8%A1%8C%E5%9B%BE%E7%9A%84%E8%BF%90%E7%AE%97%0A++++with+tf.Session%28%29+as+sess%3A%0A++++++++sess.run%28init%29%0A++++++++%23%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9E%8B%0A++++++++if+os.path.exists%28os.path.join%28model_save_path%2Cmodel_name%29%29%3A%0A++++++++++++print%28+os.path.join%28model_save_path%2Cmodel_name%29%2B%22-%22%2Bstr%28iteration%29+%29%0A++++++++++++path+%3D+os.path.join%28model_save_path%2Cmodel_name%29%2B%22-%22%2Bstr%28iteration%29%0A++++++++++++%23+ckpt+%3D+tf.train.get_checkpoint_state%28%27.%2Fmodel%2F%27%29%0A++++++++++++%23+saver.restore%28sess%2C+ckpt.model_checkpoint_path%29%0A++++++++++++saver.restore%28sess%2Cpath%29%0A++++++++else%3A%0A++++++++++++os.mkdir%28model_save_path%29%0A++++++++++++writer+%3D+tf.summary.FileWriter%28%22.%2Fgraph%22%2C+sess.graph%29%0A++++++++++++writer.close%28%29%0A++++++++%23%E8%BF%9B%E8%A1%8C%E8%AE%AD%E7%BB%83%E5%92%8C%E6%B5%8B%E8%AF%95%0A++++++++for+i+in+range%28iteration%2Cn_times%29%3A%0A++++++++++++%23%E8%AE%AD%E7%BB%83%0A++++++++++++loss_total+%3D+0%0A++++++++++++for+_+in+range%28n_batch_train%29%3A%0A++++++++++++++++x_input%2Cy_input+%3D+mnist.train.next_batch%28batch_size%29%0A++++++++++++++++_%2Cl+%3D+sess.run%28%5Btrain%2Closs%5D%2Cfeed_dict%3D%7Bx%3Ax_input%2Cy%3Ay_input%7D%29%0A++++++++++++++++loss_total%2B%3Dl%0A++++++++++++%23%E6%B5%8B%E8%AF%95%0A++++++++++++accuary_total+%3D+0%0A++++++++++++for+_+in+range%28n_batch_test%29%3A%0A++++++++++++++++x_input%2Cy_input+%3D+mnist.test.next_batch%28batch_size%29%0A++++++++++++++++accuary_total%2B%3Dsess.run%28accuary%2Cfeed_dict%3D%7Bx%3Ax_input%2Cy%3Ay_input%7D%29%0A%0A++++++++++++print%28%22Iteration%3A%7B%7D%2Ctrain_loss%3A%7B%7D%2Caccuary%3A%7B%7D%22.format%28i%2C+loss_total+%2F+n_batch_train%2Caccuary_total+%2F+n_batch_test%29%29%0A++++++++++++%23%E4%BF%9D%E5%AD%98%E6%A8%A1%E5%9E%8B%EF%BC%8C%E9%98%B2%E6%AD%A2%E5%87%BA%E4%BA%8B%E6%95%85%2C%E6%AF%8F%E5%8D%81%E6%AC%A1%E8%BF%9B%E8%A1%8C%E4%BF%9D%E5%AD%98%E6%A8%A1%E5%9E%8B%0A++++++++++++if+i%252%3D%3D0%3A%0A++++++++++++++++saver.save%28sess%2Cos.path.join%28model_save_path%2Cmodel_name%29%2Cglobal_step%3Di%29%0A++++return%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cspan+style%3D%22color%3A%23ffbb66%3B%22%3E%3Cstrong%3E2.%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA%3C%2Fstrong%3E%3C%2Fspan%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-python%22%3EIteration%3A0%2Ctrain_loss%3A0.10074821015311913%2Caccuary%3A0.9765000128746033%0AIteration%3A1%2Ctrain_loss%3A0.06776840671642938%2Caccuary%3A0.9841000121831894%0AIteration%3A2%2Ctrain_loss%3A0.05306383292614059%2Caccuary%3A0.9825000113248825%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cspan+style%3D%22color%3A%23ffbb66%3B%22%3E%3Cstrong%3E3.%E6%80%BB%E7%BB%93%EF%BC%9A%3C%2Fstrong%3E%3C%2Fspan%3E%3C%2Fp%3E+%0A++%3Cp%3E%E9%9C%80%E8%A6%81%E7%89%B9%E5%88%AB%E6%B3%A8%E6%84%8F%EF%BC%8C%E5%8D%B7%E7%A7%AF%E6%A0%B8%E7%9A%84%E5%AE%9A%E4%B9%89%5B+kernel_size%2Ckernel_size%2C+channels%2C+kernel_deep+%5D%2C%E8%BE%93%E5%85%A5%E5%8D%B7%E7%A7%AF%E5%B1%82%E7%9A%84%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%3C%2Fp%3E+%0A++%3Cp%3E%5B+batch_size%2C+image_size%2Cimage_size%2Cimage_channels+%5D%2C+%E6%B1%A0%E5%8C%96%E5%B1%82%E7%9A%84%E5%AE%9A%E4%B9%89ksize%26nbsp%3B%3D+%5B1%2Cpool_size%2Cpool_size%2C1%5D+%2C%E4%BB%A5%E5%8F%8A%E5%85%A8%E8%BF%9E%E6%8E%A5%E5%B1%82%E7%9A%84reshape%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E" | url_decode}}