---
layout: default
title: 比特币bitcoin源码解析之重要流程详解
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22markdown_views%22%3E+%0A++%3Ch1+id%3D%221-%E9%87%8D%E8%A6%81%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3%22%3E1.+%E9%87%8D%E8%A6%81%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3%3C%2Fh1%3E+%0A++%3Ch2+id%3D%2211%E4%BA%A4%E6%98%93%22%3E1.1%E4%BA%A4%E6%98%93%3C%2Fh2%3E+%0A++%3Ch3+id%3D%22111-%E4%BA%A4%E6%98%93%E8%BF%9E%E6%8E%A5%E8%BE%93%E5%85%A5connectinputs%22%3E1.1.1+%E4%BA%A4%E6%98%93%E8%BF%9E%E6%8E%A5%E8%BE%93%E5%85%A5ConnectInputs%3C%2Fh3%3E+%0A++%3Cul%3E+%0A+++%3Cli%3ECtransaction%3A%3A+ConnectInputs%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B+%3Cbr%3E+%E5%AF%B9%E4%BA%A4%E6%98%93%E7%9A%84%E8%BE%93%E5%85%A5%E8%BF%9B%E8%A1%8C%E5%88%A4%E6%96%AD%EF%BC%8C%E5%B9%B6%E5%AF%B9%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E5%9C%A8%E5%AF%B9%E5%BA%94%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E7%B4%A2%E5%BC%95%E4%B8%AD%E8%BF%9B%E8%A1%8C%E5%8D%A0%E7%94%A8%EF%BC%88%E6%A0%87%E8%AE%B0%E4%B8%BA%E8%8A%B1%E8%B4%B9%EF%BC%89%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E4%BF%9D%E5%AD%98%E8%B5%B7%E6%9D%A5%E3%80%82%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-28d5f3322fa02984.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22Ctransaction%3A%3A+ConnectInputs%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%22+title%3D%22%22%3E%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E9%93%BE%E6%8E%A5%EF%BC%8C%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E5%8D%A0%E7%94%A8%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E7%9A%84%E8%8A%B1%E8%B4%B9%E6%A0%87%E8%AE%B0%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+CTransaction%3A%3AConnectInputs%28CTxDB%26amp%3B+txdb%2C+%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Emap%3C%2Fspan%3E%26lt%3Buint256%2C+CTxIndex%26gt%3B%3C%2Fspan%3E%26amp%3B+mapTestPool%2C+CDiskTxPos+posThisTx%2C+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nHeight%2C+int64%26amp%3B+nFees%2C+%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+fBlock%2C+%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+fMiner%2C+int64+nMinFee%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%8D%A0%E7%94%A8%E5%89%8D%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%8A%B1%E8%B4%B9%E6%8C%87%E9%92%88%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Take+over+previous+transactions%27+spent+pointers%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21IsCoinBase%28%29%29%0A++++%7B%0A++++++++int64+nValueIn+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+i+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B+i+%26lt%3B+vin.size%28%29%3B+i%2B%2B%29%0A++++++++%7B%0A++++++++++++COutPoint+prevout+%3D+vin%5Bi%5D.prevout%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Read+txindex%3C%2Fspan%3E%0A++++++++++++CTxIndex+txindex%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+fFound+%3D+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fMiner+%26amp%3B%26amp%3B+mapTestPool.count%28prevout.hash%29%29%0A++++++++++++%7B%0A++++++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Get+txindex+from+current+proposed+changes%3C%2Fspan%3E%0A++++++++++++++++txindex+%3D+mapTestPool%5Bprevout.hash%5D%3B%0A++++++++++++%7D%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eelse%3C%2Fspan%3E%0A++++++++++++%7B%0A++++++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Read+txindex+from+txdb%3C%2Fspan%3E%0A++++++++++++++++fFound+%3D+txdb.ReadTxIndex%28prevout.hash%2C+txindex%29%3B%0A++++++++++++%7D%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21fFound+%26amp%3B%26amp%3B+%28fBlock+%7C%7C+fMiner%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+fMiner+%3F+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E+%3A+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+prev+tx+%25s+index+entry+not+found%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%2C++prevout.hash.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Read+txPrev%3C%2Fspan%3E%0A++++++++++++CTransaction+txPrev%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21fFound+%7C%7C+txindex.pos+%3D%3D+CDiskTxPos%28%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%29%29%0A++++++++++++%7B%0A++++++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Get+prev+tx+from+single+transactions+in+memory%3C%2Fspan%3E%0A++++++++++++++++CRITICAL_BLOCK%28cs_mapTransactions%29%0A++++++++++++++++%7B%0A++++++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21mapTransactions.count%28prevout.hash%29%29%0A++++++++++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+mapTransactions+prev+not+found+%25s%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%2C++prevout.hash.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A++++++++++++++++++++txPrev+%3D+mapTransactions%5Bprevout.hash%5D%3B%0A++++++++++++++++%7D%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21fFound%29%0A++++++++++++++++++++txindex.vSpent.resize%28txPrev.vout.size%28%29%29%3B%0A++++++++++++%7D%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eelse%3C%2Fspan%3E%0A++++++++++++%7B%0A++++++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Get+prev+tx+from+disk%3C%2Fspan%3E%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21txPrev.ReadFromDisk%28txindex.pos%29%29%0A++++++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+ReadFromDisk+prev+tx+%25s+failed%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%2C++prevout.hash.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A++++++++++++%7D%0A%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28prevout.n+%26gt%3B%3D+txPrev.vout.size%28%29+%7C%7C+prevout.n+%26gt%3B%3D+txindex.vSpent.size%28%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+prevout.n+out+of+range+%25d+%25d+%25d%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%2C+prevout.n%2C+txPrev.vout.size%28%29%2C+txindex.vSpent.size%28%29%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+If+prev+is+coinbase%2C+check+that+it%27s+matured%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28txPrev.IsCoinBase%28%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28CBlockIndex*+pindex+%3D+pindexBest%3B+pindex+%26amp%3B%26amp%3B+nBestHeight+-+pindex-%26gt%3BnHeight+%26lt%3B+COINBASE_MATURITY-%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%3B+pindex+%3D+pindex-%26gt%3Bpprev%29%0A++++++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindex-%26gt%3BnBlockPos+%3D%3D+txindex.pos.nBlockPos+%26amp%3B%26amp%3B+pindex-%26gt%3BnFile+%3D%3D+txindex.pos.nFile%29%0A++++++++++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+tried+to+spend+coinbase+at+depth+%25d%22%3C%2Fspan%3E%2C+nBestHeight+-+pindex-%26gt%3BnHeight%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Verify+signature%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21VerifySignature%28txPrev%2C+*%3Cspan+class%3D%22hljs-keyword%22%3Ethis%3C%2Fspan%3E%2C+i%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+VerifySignature+failed%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+for+conflicts%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21txindex.vSpent%5Bprevout.n%5D.IsNull%28%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+fMiner+%3F+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E+%3A+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+prev+tx+already+used+at+%25s%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%2C+txindex.vSpent%5Bprevout.n%5D.ToString%28%29.c_str%28%29%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%A0%87%E8%AE%B0%E5%89%8D%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E7%B4%A2%E5%BC%95%E5%AF%B9%E5%BA%94%E7%9A%84%E8%8A%B1%E8%B4%B9%E6%A0%87%E8%AE%B0%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Mark+outpoints+as+spent%3C%2Fspan%3E%0A++++++++++++txindex.vSpent%5Bprevout.n%5D+%3D+posThisTx%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Write+back%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fBlock%29%0A++++++++++++++++txdb.UpdateTxIndex%28prevout.hash%2C+txindex%29%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eelse%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fMiner%29%0A++++++++++++++++mapTestPool%5Bprevout.hash%5D+%3D+txindex%3B%0A%0A++++++++++++nValueIn+%2B%3D+txPrev.vout%5Bprevout.n%5D.nValue%3B%0A++++++++%7D%0A%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Tally+transaction+fees%3C%2Fspan%3E%0A++++++++int64+nTxFee+%3D+nValueIn+-+GetValueOut%28%29%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28nTxFee+%26lt%3B+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+%25s+nTxFee+%26lt%3B+0%22%3C%2Fspan%3E%2C+GetHash%28%29.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28nTxFee+%26lt%3B+nMinFee%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A++++++++nFees+%2B%3D+nTxFee%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fBlock%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Add+transaction+to+disk+index%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21txdb.AddTxIndex%28*%3Cspan+class%3D%22hljs-keyword%22%3Ethis%3C%2Fspan%3E%2C+posThisTx%2C+nHeight%29%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22ConnectInputs%28%29+%3A+AddTxPos+failed%22%3C%2Fspan%3E%29%3B%0A++++%7D%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eelse%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fMiner%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E7%9F%BF%E5%B7%A5%EF%BC%8C%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E6%94%BE%E5%85%A5%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E6%B5%8B%E8%AF%95%E6%B1%A0%E4%B8%AD%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Add+transaction+to+test+pool%3C%2Fspan%3E%0A++++++++mapTestPool%5BGetHash%28%29%5D+%3D+CTxIndex%28CDiskTxPos%28%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%29%2C+vout.size%28%29%29%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3+id%3D%22112-%E4%BA%A4%E6%98%93%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5%E8%BE%93%E5%85%A5disconnectinputs%22%3E1.1.2+%E4%BA%A4%E6%98%93%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5%E8%BE%93%E5%85%A5DisconnectInputs%3C%2Fh3%3E+%0A++%3Cul%3E+%0A+++%3Cli%3ECtransaction%3A%3A+DisconnectInputs%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B+%3Cbr%3E+%E9%87%8A%E6%94%BE%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%85%A5%E5%8D%A0%E7%94%A8%E7%9A%84%E6%A0%87%E8%AE%B0%EF%BC%8C%E5%8D%B3%E6%98%AF%E9%87%8A%E6%94%BE%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E7%B4%A2%E5%BC%95%E4%B8%AD%E7%9A%84%E6%A0%87%E8%AE%B0%EF%BC%8C%E5%B9%B6%E5%B0%86%E4%BA%A4%E6%98%93%E4%BB%8E%E5%BA%93%E6%88%96%E8%80%85mapTestPool%E4%B8%AD%E8%BF%9B%E8%A1%8C%E7%A7%BB%E9%99%A4%E3%80%82%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-b609e1dfa9827c6c.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22Ctransaction%3A%3A+DisconnectInputs%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%22+title%3D%22%22%3E%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%3A%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cs%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%96%AD%E5%BC%80%E8%BF%9E%E6%8E%A5%E8%BE%93%E5%85%A5%EF%BC%8C%E5%B0%B1%E6%98%AF%E9%87%8A%E6%94%BE%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%85%A5%E7%9A%84%E5%8D%A0%E7%94%A8%EF%BC%9A%E5%8D%B3%E6%98%AF%E9%87%8A%E6%94%BE%E4%BA%A4%E6%98%93%E8%BE%93%E5%85%A5%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E7%B4%A2%E5%BC%95%E7%9A%84%E6%A0%87%E8%AE%B0%E5%8D%A0%E7%94%A8%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+CTransaction%3A%3ADisconnectInputs%28CTxDB%26amp%3B+txdb%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%94%BE%E5%BC%83%E6%88%96%E8%80%85%E8%AE%A9%E5%87%BA%E5%89%8D%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%8A%B1%E8%B4%B9%E6%A0%87%E8%AE%B0%E6%8C%87%E9%92%88%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Relinquish+previous+transactions%27+spent+pointers%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21IsCoinBase%28%29%29+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B8%81%E5%9F%BA%3C%2Fspan%3E%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eforeach%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+CTxIn%26amp%3B+txin%2C+vin%29%0A++++++++%7B%0A++++++++++++COutPoint+prevout+%3D+txin.prevout%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Get+prev+txindex+from+disk%3C%2Fspan%3E%0A++++++++++++CTxIndex+txindex%3B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E8%AF%BB%E5%8F%96%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E7%9A%84%E7%B4%A2%E5%BC%95%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21txdb.ReadTxIndex%28prevout.hash%2C+txindex%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22DisconnectInputs%28%29+%3A+ReadTxIndex+failed%22%3C%2Fspan%3E%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28prevout.n+%26gt%3B%3D+txindex.vSpent.size%28%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22DisconnectInputs%28%29+%3A+prevout.n+out+of+range%22%3C%2Fspan%3E%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Mark+outpoint+as+not+spent%3C%2Fspan%3E%0A++++++++++++txindex.vSpent%5Bprevout.n%5D.SetNull%28%29%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Write+back%3C%2Fspan%3E%0A++++++++++++txdb.UpdateTxIndex%28prevout.hash%2C+txindex%29%3B%0A++++++++%7D%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E4%BB%8E%E4%BA%A4%E6%98%93%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%E7%A7%BB%E9%99%A4%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Remove+transaction+from+index%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21txdb.EraseTxIndex%28*%3Cspan+class%3D%22hljs-keyword%22%3Ethis%3C%2Fspan%3E%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22DisconnectInputs%28%29+%3A+EraseTxPos+failed%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3+id%3D%22113-%E4%BA%A4%E6%98%93%E6%8E%A5%E5%8F%97%E5%A4%84%E7%90%86%22%3E1.1.3+%E4%BA%A4%E6%98%93%E6%8E%A5%E5%8F%97%E5%A4%84%E7%90%86%3C%2Fh3%3E+%0A++%3Cul%3E+%0A+++%3Cli%3ECTransaction%3A%3AAcceptTransaction%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B+%3Cbr%3E+%E5%88%A4%E6%96%AD%E4%BA%A4%E6%98%93%E8%83%BD%E4%B8%8D%E8%83%BD%E8%A2%AB%E6%8E%A5%E5%8F%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%83%BD%E6%8E%A5%E5%8F%97%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E6%94%BE%E5%85%A5%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E4%B8%ADmapTransactions%EF%BC%8CmapNextTx%E4%B8%AD%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-181ac7795b5141c2.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22CTransaction%3A%3AAcceptTransaction%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%22+title%3D%22%22%3E%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%3A%3C%2Fli%3E+%0A++%3C%2Ful%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E8%BF%99%E8%BE%B9%E4%BA%A4%E6%98%93%E8%83%BD%E4%B8%8D%E8%83%BD%E8%A2%AB%E6%8E%A5%E5%8F%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%83%BD%E6%8E%A5%E5%8F%97%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E6%94%BE%E5%85%A5%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E4%B8%ADmapTransactions%EF%BC%8CmapNextTx%E4%B8%AD%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+CTransaction%3A%3AAcceptTransaction%28CTxDB%26amp%3B+txdb%2C+%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+fCheckInputs%2C+%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E*+pfMissingInputs%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pfMissingInputs%29%0A++++++++*pfMissingInputs+%3D+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B8%81%E5%9F%BA%E4%BA%A4%E6%98%93%E4%BB%85%E4%BB%85%E5%9C%A8%E5%9D%97%E4%B8%AD%E6%9C%89%E6%95%88%EF%BC%8C%E5%B8%81%E5%9F%BA%E4%BA%A4%E6%98%93%E4%B8%8D%E8%83%BD%E5%81%9A%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E4%BA%A4%E6%98%93%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Coinbase+is+only+valid+in+a+block%2C+not+as+a+loose+transaction%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28IsCoinBase%28%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptTransaction%28%29+%3A+coinbase+as+individual+tx%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21CheckTransaction%28%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptTransaction%28%29+%3A+CheckTransaction+failed%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E6%98%AF%E5%90%A6%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E6%8E%A5%E6%94%B6%E5%88%B0%E8%BF%87%E4%BA%86%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Do+we+already+have+it%3F%3C%2Fspan%3E%0A++++uint256+hash+%3D+GetHash%28%29%3B%0A++++CRITICAL_BLOCK%28cs_mapTransactions%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28mapTransactions.count%28hash%29%29+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E5%86%85%E5%AD%98%E5%AF%B9%E8%B1%A1map%E4%B8%AD%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fCheckInputs%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28txdb.ContainsTx%28hash%29%29+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E4%BA%A4%E6%98%93db%E4%B8%AD%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%90%A6%E5%92%8C%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E5%AF%B9%E8%B1%A1%E5%88%97%E8%A1%A8%E5%86%B2%E7%AA%81%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+for+conflicts+with+in-memory+transactions%3C%2Fspan%3E%0A++++CTransaction*+ptxOld+%3D+NULL%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+i+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B+i+%26lt%3B+vin.size%28%29%3B+i%2B%2B%29%0A++++%7B%0A++++++++COutPoint+outpoint+%3D+vin%5Bi%5D.prevout%3B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%A0%B9%E6%8D%AE%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%85%A5%E4%BA%A4%E6%98%93%EF%BC%8C%E8%8E%B7%E5%BE%97%E5%AF%B9%E5%BA%94%E8%BE%93%E5%85%A5%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%87%BA%E4%BA%A4%E6%98%93%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28mapNextTx.count%28outpoint%29%29%0A++++++++%7B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Allow+replacing+with+a+newer+version+of+the+same+transaction%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+i+%3D%3D0+%E4%B8%BAcoinbase%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AFcoinbase%E5%8F%AF%E4%BB%A5%E6%9B%BF%E6%8D%A2%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28i+%21%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E7%9B%B8%E5%AF%B9%E4%BA%8E%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E6%9B%B4%E8%80%81%E7%9A%84%E4%BA%A4%E6%98%93%3C%2Fspan%3E%0A++++++++++++ptxOld+%3D+mapNextTx%5Boutpoint%5D.ptx%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21IsNewerThan%28*ptxOld%29%29+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%AF%94%E5%8E%9F%E6%9D%A5%E4%BA%A4%E6%98%93%E6%9B%B4%E6%96%B0%EF%BC%8C%E9%80%9A%E8%BF%87nSequences%E5%88%A4%E6%96%AD%3C%2Fspan%3E%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+i+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B+i+%26lt%3B+vin.size%28%29%3B+i%2B%2B%29%0A++++++++++++%7B%0A++++++++++++++++COutPoint+outpoint+%3D+vin%5Bi%5D.prevout%3B%0A++++++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E7%9A%84%E8%BE%93%E5%85%A5%E5%9C%A8%E5%86%85%E5%AD%98%E5%AF%B9%E8%B1%A1mapNextTx%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%87%BA%E5%A6%82%E6%9E%9C%E9%83%BD%E5%AD%98%E5%9C%A8%EF%BC%8C%E4%B8%94%E9%83%BD%E6%8C%87%E5%90%91%E5%8E%9F%E6%9D%A5%E8%80%81%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%8C%E5%88%99%E6%8E%A5%E6%94%B6%E6%AD%A4%E4%BA%A4%E6%98%93%3C%2Fspan%3E%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21mapNextTx.count%28outpoint%29+%7C%7C+mapNextTx%5Boutpoint%5D.ptx+%21%3D+ptxOld%29%0A++++++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A++++++++++++%7D%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ebreak%3C%2Fspan%3E%3B%0A++++++++%7D%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%AF%B9%E5%89%8D%E4%BA%A4%E6%98%93%E8%BF%9B%E8%A1%8C%E6%A0%A1%E9%AA%8C%E5%92%8C%E8%AE%BE%E7%BD%AE%E5%89%8D%E4%BA%A4%E6%98%93%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%87%BA%E4%B8%BA%E8%8A%B1%E8%B4%B9%E6%A0%87%E8%AE%B0%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+against+previous+transactions%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Emap%3C%2Fspan%3E%26lt%3Buint256%2C+CTxIndex%26gt%3B%3C%2Fspan%3E+mapUnused%3B%0A++++int64+nFees+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28fCheckInputs+%26amp%3B%26amp%3B+%21ConnectInputs%28txdb%2C+mapUnused%2C+CDiskTxPos%28%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%29%2C+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C+nFees%2C+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%2C+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%29%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pfMissingInputs%29%0A++++++++++++*pfMissingInputs+%3D+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptTransaction%28%29+%3A+ConnectInputs+failed+%25s%22%3C%2Fspan%3E%2C+hash.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E5%AD%98%E5%82%A8%E5%9C%A8%E5%86%85%E5%AD%98%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%80%81%E7%9A%84%E4%BA%A4%E6%98%93%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%99%E4%BB%8E%E5%86%85%E5%AD%98%E4%B8%AD%E5%B0%86%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%E7%A7%BB%E9%99%A4%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Store+transaction+in+memory%3C%2Fspan%3E%0A++++CRITICAL_BLOCK%28cs_mapTransactions%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28ptxOld%29%0A++++++++%7B%0A++++++++++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22mapTransaction.erase%28%25s%29+replacing+with+new+version%5Cn%22%3C%2Fspan%3E%2C+ptxOld-%26gt%3BGetHash%28%29.ToString%28%29.c_str%28%29%29%3B%0A++++++++++++mapTransactions.erase%28ptxOld-%26gt%3BGetHash%28%29%29%3B%0A++++++++%7D%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%BD%93%E5%89%8D%E4%BA%A4%E6%98%93%E5%AD%98%E5%82%A8%E5%88%B0%E5%86%85%E5%AD%98%E5%AF%B9%E8%B1%A1%E4%B8%AD%3C%2Fspan%3E%0A++++++++AddToMemoryPool%28%29%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E8%80%81%E7%9A%84%E4%BA%A4%E6%98%93%E5%AD%98%E5%9C%A8%EF%BC%8C%E5%88%99%E4%BB%8E%E9%92%B1%E5%8C%85%E4%B8%AD%E5%B0%86%E8%80%81%E7%9A%84%E4%BA%A4%E6%98%93%E7%A7%BB%E9%99%A4%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F%2F%2F%2F+are+we+sure+this+is+ok+when+loading+transactions+or+restoring+block+txes%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+If+updated%2C+erase+old+tx+from+wallet%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28ptxOld%29%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E4%BA%A4%E6%98%93%E4%BB%8E%E9%92%B1%E5%8C%85%E6%98%A0%E5%B0%84%E5%AF%B9%E8%B1%A1mapWallet%E4%B8%AD%E7%A7%BB%E9%99%A4%EF%BC%8C%E5%90%8C%E6%97%B6%E5%B0%86%E4%BA%A4%E6%98%93%E4%BB%8ECWalletDB%E4%B8%AD%E7%A7%BB%E9%99%A4%3C%2Fspan%3E%0A++++++++EraseFromWallet%28ptxOld-%26gt%3BGetHash%28%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptTransaction%28%29%3A+accepted+%25s%5Cn%22%3C%2Fspan%3E%2C+hash.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E6%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch2+id%3D%2212-%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%E8%8E%B7%E5%BE%97%22%3E1.2+%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%E8%8E%B7%E5%BE%97%3C%2Fh2%3E+%0A++%3Cp%3E%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%B9%E6%B3%95%E6%98%AF%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+objectivec%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%A0%B9%E6%8D%AE%E5%89%8D%E4%B8%80%E4%B8%AAblock%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%8E%B7%E5%8F%96%E4%B8%8B%E4%B8%80%E4%B8%AAblock%E8%8E%B7%E5%8F%96%E9%9C%80%E8%A6%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E++%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+GetNextWorkRequired%28%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E++CBlockIndex*+pindexLast%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E7%9C%8B%E6%BA%90%E7%A0%81%E6%9B%B4%E6%B8%85%E6%99%B0%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%98%AF%E4%BF%9D%E8%AF%81%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%9710%E5%88%86%E9%92%9F%E4%BA%A7%E7%94%9F%E4%B8%80%E4%B8%AA%EF%BC%8C14%E5%A4%A9%E6%9B%B4%E6%96%B0%E4%B8%80%E4%B8%8B%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%EF%BC%88%E5%8D%B3%E6%98%AF%E4%BA%A7%E7%94%9F2016%E5%8C%BA%E5%9D%97%E5%B0%B1%E8%A6%81%E6%9B%B4%E6%96%B0%E4%B8%80%E4%B8%8B%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%EF%BC%89%EF%BC%8C%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%A0%B9%E6%8D%AE%E5%89%8D%E4%B8%80%E4%B8%AAblock%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%8E%B7%E5%8F%96%E4%B8%8B%E4%B8%80%E4%B8%AAblock%E8%8E%B7%E5%8F%96%E9%9C%80%E8%A6%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+GetNextWorkRequired%28%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+CBlockIndex*+pindexLast%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nTargetTimespan+%3D+%3Cspan+class%3D%22hljs-number%22%3E14%3C%2Fspan%3E+*+%3Cspan+class%3D%22hljs-number%22%3E24%3C%2Fspan%3E+*+%3Cspan+class%3D%22hljs-number%22%3E60%3C%2Fspan%3E+*+%3Cspan+class%3D%22hljs-number%22%3E60%3C%2Fspan%3E%3B+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+two+weeks%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nTargetSpacing+%3D+%3Cspan+class%3D%22hljs-number%22%3E10%3C%2Fspan%3E+*+%3Cspan+class%3D%22hljs-number%22%3E60%3C%2Fspan%3E%3B+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+10%E5%88%86%E9%92%9F%E4%BA%A7%E7%94%9F%E4%B8%80%E4%B8%AAblock%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%AF%8F%E9%9A%942016%E4%B8%AA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%E5%B0%B1%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E8%AE%A1%E7%AE%97%E4%B8%80%E6%AC%A1%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nInterval+%3D+nTargetTimespan+%2F+nTargetSpacing%3B+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E4%B8%AD%E9%97%B4%E9%9A%94%E4%BA%86%E5%A4%9A%E5%B0%91%E4%B8%AAblock+2016%E4%B8%AA%E5%9D%97%3C%2Fspan%3E%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E8%AF%B4%E6%98%8E%E5%BD%93%E5%89%8D%E5%9D%97%E6%98%AF%E4%B8%80%E4%B8%AA%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%BD%93%E5%89%8D%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E4%B8%BA%E7%A9%BA%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Genesis+block%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindexLast+%3D%3D+NULL%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+bnProofOfWorkLimit.GetCompact%28%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E4%B8%8D%E7%AD%89%E4%BA%8E0%E4%B8%8D%E8%BF%9B%E8%A1%8C%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%E6%94%B9%E5%8F%98%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Only+change+once+per+interval%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%28pindexLast-%26gt%3BnHeight%2B%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%29+%25+nInterval+%21%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+pindexLast-%26gt%3BnBits%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%BE%80%E5%89%8D%E6%8E%A82016%E4%B8%AA%E5%8C%BA%E5%9D%97%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Go+back+by+what+we+want+to+be+14+days+worth+of+blocks%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+CBlockIndex*+pindexFirst+%3D+pindexLast%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+i+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B+pindexFirst+%26amp%3B%26amp%3B+i+%26lt%3B+nInterval-%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%3B+I%2B%2B%29%0A++++++++pindexFirst+%3D+pindexFirst-%26gt%3Bpprev%3B%0A++++assert%28pindexFirst%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4+%E5%87%8F%E5%8E%BB+%E4%BB%8E%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E5%90%91%E5%89%8D%E6%8E%A82016%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%BE%97%E5%88%B0%E5%8C%BA%E5%9D%97%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Limit+adjustment+step%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nActualTimespan+%3D+pindexLast-%26gt%3BnTime+-+pindexFirst-%26gt%3BnTime%3B%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22+nActualTimespan+%3D+%25d+before+bounds%5Cn%22%3C%2Fspan%3E%2C+nActualTimespan%29%3B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%8E%A7%E5%88%B6%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6%E8%B0%83%E6%95%B4%E7%9A%84%E8%B7%A8%E5%BA%A6%E4%B8%8D%E8%83%BD%E5%A4%AA%E5%A4%A7%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28nActualTimespan+%26lt%3B+nTargetTimespan%2F%3Cspan+class%3D%22hljs-number%22%3E4%3C%2Fspan%3E%29%0A++++++++nActualTimespan+%3D+nTargetTimespan%2F%3Cspan+class%3D%22hljs-number%22%3E4%3C%2Fspan%3E%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28nActualTimespan+%26gt%3B+nTargetTimespan*%3Cspan+class%3D%22hljs-number%22%3E4%3C%2Fspan%3E%29%0A++++++++nActualTimespan+%3D+nTargetTimespan*%3Cspan+class%3D%22hljs-number%22%3E4%3C%2Fspan%3E%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E9%87%8D%E6%96%B0%E7%9B%AE%E6%A0%87%E8%AE%A1%E7%AE%97%E9%9A%BE%E5%BA%A6%EF%BC%9A%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6+*+%E5%AE%9E%E9%99%852016%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%E9%97%B4%E9%9A%94+%2F+%E7%9B%AE%E6%A0%87%E6%97%B6%E9%97%B4%E8%B7%A8%E5%BA%A614%E5%A4%A9%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Retarget%3C%2Fspan%3E%0A++++CBigNum+bnNew%3B%0A++++bnNew.SetCompact%28pindexLast-%26gt%3BnBits%29%3B%0A++++bnNew+*%3D+nActualTimespan%3B%0A++++bnNew+%2F%3D+nTargetTimespan%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E8%AE%A1%E7%AE%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%EF%BC%88%E5%80%BC%E8%B6%8A%E5%A4%A7%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%9A%BE%E5%BA%A6%E8%B6%8A%E5%B0%8F%EF%BC%89%E5%B0%8F%E4%BA%8E%E5%BD%93%E5%89%8D%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28bnNew+%26gt%3B+bnProofOfWorkLimit%29%0A++++++++bnNew+%3D+bnProofOfWorkLimit%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F%2F+debug+print%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22%5Cn%5Cn%5CnGetNextWorkRequired+RETARGET+*****%5Cn%22%3C%2Fspan%3E%29%3B%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22nTargetTimespan+%3D+%25d+nActualTimespan+%3D+%25d%5Cn%22%3C%2Fspan%3E%2C+nTargetTimespan%2C+nActualTimespan%29%3B%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22Before%3A+%2508x+%25s%5Cn%22%3C%2Fspan%3E%2C+pindexLast-%26gt%3BnBits%2C+CBigNum%28%29.SetCompact%28pindexLast-%26gt%3BnBits%29.getuint256%28%29.ToString%28%29.c_str%28%29%29%3B%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22After%3A+%2508x+%25s%5Cn%22%3C%2Fspan%3E%2C+bnNew.GetCompact%28%29%2C+bnNew.getuint256%28%29.ToString%28%29.c_str%28%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+bnNew.GetCompact%28%29%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch2+id%3D%2213-%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%22%3E1.3+%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%88%9B%E5%BB%BA%E6%97%B6%E9%97%B4%3C%2Fh2%3E+%0A++%3Cp%3E%E5%9C%A8%E6%96%B0%E5%BB%BA%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E8%A6%81%E8%AE%BE%E7%BD%AE%E5%AF%B9%E5%BA%94%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E9%97%B4%EF%BC%8C%E7%94%B1%E4%BA%8E%E6%98%AFP2P%E7%9A%84%EF%BC%8C%E6%B2%A1%E6%9C%89%E4%B8%AD%E5%BF%83%E5%8C%96%E8%8A%82%E7%82%B9%E8%83%BD%E5%A4%9F%E8%8E%B7%E5%BE%97%E5%AF%B9%E5%BA%94%E7%9A%84%E6%97%B6%E9%97%B4%EF%BC%8C%E6%89%80%E4%BB%A5%E9%9C%80%E8%A6%81%E4%BB%8E%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E9%97%B4%E4%B8%AD%E5%8F%96%E4%B8%AD%E4%BD%8D%E6%95%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E5%92%8C%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%E5%8E%BB%E6%9C%80%E5%A4%A7%E5%80%BC%EF%BC%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BB%A3%E7%A0%81%E5%B0%B1%E6%98%AF%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+lasso%22%3Epblock%3Cspan+class%3D%22hljs-subst%22%3E-%26gt%3B%3C%2Fspan%3EnTime+%3Cspan+class%3D%22hljs-subst%22%3E%3D%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Emax%3C%2Fspan%3E%28%28pindexPrev+%3Cspan+class%3D%22hljs-subst%22%3E%3F%3C%2Fspan%3E+pindexPrev%3Cspan+class%3D%22hljs-subst%22%3E-%26gt%3B%3C%2Fspan%3EGetMedianTimePast%28%29%3Cspan+class%3D%22hljs-subst%22%3E%2B%3C%2Fspan%3E%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E+%3A+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%29%2C+GetAdjustedTime%28%29%29%3B%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch2+id%3D%2214-block%E6%8E%A5%E6%94%B6%E5%A4%84%E7%90%86%22%3E1.4+block%E6%8E%A5%E6%94%B6%E5%A4%84%E7%90%86%3C%2Fh2%3E+%0A++%3Ch3+id%3D%22141-%E5%8C%BA%E5%9D%97%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86%22%3E1.4.1+%E5%8C%BA%E5%9D%97%E8%BF%9E%E6%8E%A5%E5%A4%84%E7%90%86%3C%2Fh3%3E+%0A++%3Cp%3E%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%B9%E6%B3%95%E6%98%AF%3A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8E%A5%EF%BC%9A%E6%AF%8F%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E9%93%BE%E6%8E%A5%EF%BC%8C%E5%A2%9E%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E9%93%BE%E4%B8%AD%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+CBlock%3A%3AConnectBlock%28CTxDB%26amp%3B+txdb%2C+CBlockIndex*+pindex%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F%2F%2F+issue+here%3A+it+doesn%27t+know+the+version%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nTxPos+%3D+pindex-%26gt%3BnBlockPos+%2B+%3A%3AGetSerializeSize%28CBlock%28%29%2C+SER_DISK%29+-+%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E+%2B+GetSizeOfCompactSize%28vtx.size%28%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Emap%3C%2Fspan%3E%26lt%3Buint256%2C+CTxIndex%26gt%3B%3C%2Fspan%3E+mapUnused%3B%0A++++int64+nFees+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B%0A++++foreach%28CTransaction%26amp%3B+tx%2C+vtx%29%0A++++%7B%0A++++++++CDiskTxPos+posThisTx%28pindex-%26gt%3BnFile%2C+pindex-%26gt%3BnBlockPos%2C+nTxPos%29%3B%0A++++++++nTxPos+%2B%3D+%3A%3AGetSerializeSize%28tx%2C+SER_DISK%29%3B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%AF%B9%E6%AF%8F%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E8%BF%9B%E8%A1%8C%E8%BE%93%E5%85%A5%E9%93%BE%E6%8E%A5%E5%88%A4%E6%96%AD%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21tx.ConnectInputs%28txdb%2C+mapUnused%2C+posThisTx%2C+pindex-%26gt%3BnHeight%2C+nFees%2C+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%2C+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%29%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A++++%7D%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B8%81%E5%9F%BA%E4%BA%A4%E6%98%93%E4%B8%AD%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BE%93%E5%87%BA%E4%B8%8D%E8%83%BD%E5%A4%A7%E4%BA%8E%E6%95%B4%E4%B8%AA%E5%AF%B9%E5%BA%94%E7%9A%84%E5%A5%96%E5%8A%B1%2B%E4%BA%A4%E6%98%93%E6%89%8B%E7%BB%AD%E8%B4%B9%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28vtx%5B%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%5D.GetValueOut%28%29+%26gt%3B+GetBlockValue%28nFees%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Update+block+index+on+disk+without+changing+it+in+memory.%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+The+memory+index+structure+will+be+changed+after+the+db+commits.%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindex-%26gt%3Bpprev%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95+%E6%8C%82%E5%9C%A8+%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E4%B9%8B%E5%90%8E%3C%2Fspan%3E%0A++++++++CDiskBlockIndex+blockindexPrev%28pindex-%26gt%3Bpprev%29%3B%0A++++++++blockindexPrev.hashNext+%3D+pindex-%26gt%3BGetBlockHash%28%29%3B%0A++++++++txdb.WriteBlockIndex%28blockindexPrev%29%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E7%9B%91%E8%A7%86%E5%9C%A8block%E4%B8%AD%E5%93%AA%E4%BA%9B%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Watch+for+transactions+paying+to+me%3C%2Fspan%3E%0A++++foreach%28CTransaction%26amp%3B+tx%2C+vtx%29%0A++++++++AddToWalletIfMine%28tx%2C+%3Cspan+class%3D%22hljs-keyword%22%3Ethis%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-ea9a6bf4b9a644f6.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22image.png%22+title%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch3+id%3D%22142%E5%8C%BA%E5%9D%97%E5%88%86%E5%8F%89%E5%A4%84%E7%90%86%22%3E1.4.2%E5%8C%BA%E5%9D%97%E5%88%86%E5%8F%89%E5%A4%84%E7%90%86%3C%2Fh3%3E+%0A++%3Cp%3E%E6%96%B9%E6%B3%95%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E9%87%8D%E6%96%B0%E7%BB%84%E7%BB%87%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%A2%E5%BC%95%EF%BC%9A%E5%9B%A0%E4%B8%BA%E6%AD%A4%E6%97%B6%E5%B7%B2%E7%BB%8F%E5%87%BA%E7%8E%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E5%88%86%E5%8F%89%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+Reorganize%28CTxDB%26amp%3B+txdb%2C+CBlockIndex*+pindexNew%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22***+REORGANIZE+***%5Cn%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%89%BE%E5%88%B0%E5%8C%BA%E5%9D%97%E5%88%86%E5%8F%89%E7%82%B9%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Find+the+fork%3C%2Fspan%3E%0A++++CBlockIndex*+pfork+%3D+pindexBest%3B%0A++++CBlockIndex*+plonger+%3D+pindexNew%3B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%89%BE%E5%88%B0%E4%B8%BB%E9%93%BE%E5%92%8C%E5%88%86%E5%8F%89%E9%93%BE%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E5%8F%89%E7%82%B9%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ewhile%3C%2Fspan%3E+%28pfork+%21%3D+plonger%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21%28pfork+%3D+pfork-%26gt%3Bpprev%29%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+pfork-%26gt%3Bpprev+is+null%22%3C%2Fspan%3E%29%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ewhile%3C%2Fspan%3E+%28plonger-%26gt%3BnHeight+%26gt%3B+pfork-%26gt%3BnHeight%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21%28plonger+%3D+plonger-%26gt%3Bpprev%29%29%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+plonger-%26gt%3Bpprev+is+null%22%3C%2Fspan%3E%29%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%97%E4%B8%BE%E5%87%BA%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E8%AE%A4%E4%B8%BA%E7%9A%84%E6%9C%80%E9%95%BF%E9%93%BE%E4%B8%AD%EF%BC%88%E4%BB%8E%E5%BD%93%E5%89%8D%E6%9C%80%E9%95%BF%E9%93%BE%E5%88%B0%E4%BA%A4%E5%8F%89%E7%82%B9%EF%BC%89%E5%A4%B1%E5%8E%BB%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%9D%97%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+List+of+what+to+disconnect%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Evector%3C%2Fspan%3E%26lt%3BCBlockIndex*%26gt%3B%3C%2Fspan%3E+vDisconnect%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28CBlockIndex*+pindex+%3D+pindexBest%3B+pindex+%21%3D+pfork%3B+pindex+%3D+pindex-%26gt%3Bpprev%29%0A++++++++vDisconnect.push_back%28pindex%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E8%8E%B7%E5%8F%96%E9%9C%80%E8%A6%81%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%9D%97%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%87%AA%E5%B7%B1%E8%AE%A4%E4%B8%BA%E7%9A%84%E6%9C%80%E9%95%BF%E9%93%BE%E5%AE%9E%E9%99%85%E4%B8%8A%E4%B8%8D%E6%98%AF%E6%9C%80%E9%95%BF%E9%93%BE%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+List+of+what+to+connect%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Evector%3C%2Fspan%3E%26lt%3BCBlockIndex*%26gt%3B%3C%2Fspan%3E+vConnect%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28CBlockIndex*+pindex+%3D+pindexNew%3B+pindex+%21%3D+pfork%3B+pindex+%3D+pindex-%26gt%3Bpprev%29%0A++++++++vConnect.push_back%28pindex%29%3B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%9B%A0%E4%B8%BA%E4%B8%8A%E9%9D%A2%E6%94%BE%E5%85%A5%E7%9A%84%E6%97%B6%E5%80%99%E6%98%AF%E5%80%92%E7%9D%80%E6%94%BE%E7%9A%84%EF%BC%8C%E6%89%80%E4%BB%A5%E8%BF%99%E9%87%8C%E5%9C%A8%E5%B0%86%E8%BF%99%E4%B8%AA%E9%80%86%E5%BA%8F%EF%BC%8C%E5%BE%97%E5%88%B0%E6%AD%A3%E5%90%91%E7%9A%84%3C%2Fspan%3E%0A++++reverse%28vConnect.begin%28%29%2C+vConnect.end%28%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E9%87%8A%E6%94%BE%E6%96%AD%E9%93%BE%EF%BC%88%E4%BB%85%E4%BB%85%E9%87%8A%E6%94%BE%E5%AF%B9%E5%BA%94%E7%9A%84block%E9%93%BE%EF%BC%8C%E5%AF%B9%E5%BA%94%E7%9A%84block%E7%B4%A2%E5%BC%95%E9%93%BE%E8%BF%98%E6%B2%A1%E6%9C%89%E9%87%8A%E6%94%BE%EF%BC%89%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Disconnect+shorter+branch%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Evector%3C%2Fspan%3E%26lt%3BCTransaction%26gt%3B%3C%2Fspan%3E+vResurrect%3B%0A++++foreach%28CBlockIndex*+pindex%2C+vDisconnect%29%0A++++%7B%0A++++++++CBlock+block%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21block.ReadFromDisk%28pindex-%26gt%3BnFile%2C+pindex-%26gt%3BnBlockPos%2C+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%29%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+ReadFromDisk+for+disconnect+failed%22%3C%2Fspan%3E%29%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21block.DisconnectBlock%28txdb%2C+pindex%29%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+DisconnectBlock+failed%22%3C%2Fspan%3E%29%3B%0A%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E9%87%8A%E6%94%BE%E5%9D%97%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E6%94%BE%E5%85%A5vResurrect%EF%BC%8C%E7%AD%89%E5%BE%85%E5%A4%8D%E6%B4%BB%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Queue+memory+transactions+to+resurrect%3C%2Fspan%3E%0A++++++++foreach%28%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+CTransaction%26amp%3B+tx%2C+block.vtx%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21tx.IsCoinBase%28%29%29%0A++++++++++++++++vResurrect.push_back%28tx%29%3B%0A++++%7D%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E8%BF%9E%E6%8E%A5%E6%9C%80%E9%95%BF%E7%9A%84%E5%88%86%E6%94%AF%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Connect+longer+branch%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Evector%3C%2Fspan%3E%26lt%3BCTransaction%26gt%3B%3C%2Fspan%3E+vDelete%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+i+%3D+%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%3B+i+%26lt%3B+vConnect.size%28%29%3B+i%2B%2B%29%0A++++%7B%0A++++++++CBlockIndex*+pindex+%3D+vConnect%5Bi%5D%3B%0A++++++++CBlock+block%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21block.ReadFromDisk%28pindex-%26gt%3BnFile%2C+pindex-%26gt%3BnBlockPos%2C+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%29%29%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+ReadFromDisk+for+connect+failed%22%3C%2Fspan%3E%29%3B%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21block.ConnectBlock%28txdb%2C+pindex%29%29%0A++++++++%7B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9Cblock%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%E4%B9%8B%E5%90%8E%EF%BC%8C%E8%AF%B4%E6%98%8E%E8%BF%99%E4%B8%AAblock%E6%97%A0%E6%95%88%EF%BC%8C%E5%88%99%E5%88%A0%E9%99%A4%E8%BF%99%E5%9D%97%E4%B9%8B%E5%90%8E%E7%9A%84%E5%88%86%E6%94%AF%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Invalid+block%2C+delete+the+rest+of+this+branch%3C%2Fspan%3E%0A++++++++++++txdb.TxnAbort%28%29%3B%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Efor%3C%2Fspan%3E+%28%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+j+%3D+i%3B+j+%26lt%3B+vConnect.size%28%29%3B+j%2B%2B%29%0A++++++++++++%7B%0A++++++++++++++++CBlockIndex*+pindex+%3D+vConnect%5Bj%5D%3B%0A++++++++++++++++pindex-%26gt%3BEraseBlockFromDisk%28%29%3B%0A++++++++++++++++txdb.EraseBlockIndex%28pindex-%26gt%3BGetBlockHash%28%29%29%3B%0A++++++++++++++++mapBlockIndex.erase%28pindex-%26gt%3BGetBlockHash%28%29%29%3B%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Edelete%3C%2Fspan%3E+pindex%3B%0A++++++++++++%7D%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+ConnectBlock+failed%22%3C%2Fspan%3E%29%3B%0A++++++++%7D%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%8A%A0%E5%85%A5%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%9D%97%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E4%BB%8E%E5%AF%B9%E5%BA%94%E7%9A%84%E5%86%85%E5%AD%98%E4%B8%AD%E5%88%A0%E9%99%A4%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Queue+memory+transactions+to+delete%3C%2Fspan%3E%0A++++++++foreach%28%3Cspan+class%3D%22hljs-keyword%22%3Econst%3C%2Fspan%3E+CTransaction%26amp%3B+tx%2C+block.vtx%29%0A++++++++++++vDelete.push_back%28tx%29%3B%0A++++%7D%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%86%99%E5%85%A5%E6%9C%80%E9%95%BF%E9%93%BE%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21txdb.WriteHashBestChain%28pindexNew-%26gt%3BGetBlockHash%28%29%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22Reorganize%28%29+%3A+WriteHashBestChain+failed%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Commit+now+because+resurrecting+%E5%A4%8D%E6%B4%BBcould+take+some+time%3C%2Fspan%3E%0A++++txdb.TxnCommit%28%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E9%87%8A%E6%94%BE%E5%AF%B9%E5%BA%94%E7%9A%84%E5%9D%97%E7%B4%A2%E5%BC%95%E9%93%BE%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Disconnect+shorter+branch%3C%2Fspan%3E%0A++++foreach%28CBlockIndex*+pindex%2C+vDisconnect%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindex-%26gt%3Bpprev%29%0A++++++++++++pindex-%26gt%3Bpprev-%26gt%3Bpnext+%3D+NULL%3B+%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E8%A1%A8%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%9D%97%E6%B2%A1%E6%9C%89%E5%9C%A8%E4%B8%BB%E9%93%BE%E4%B8%8A%3C%2Fspan%3E%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%BD%A2%E6%88%90%E4%B8%80%E6%9D%A1%E4%B8%BB%E9%93%BE%E7%9A%84%E5%9D%97%E7%B4%A2%E5%BC%95%E9%93%BE%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Connect+longer+branch%3C%2Fspan%3E%0A++++foreach%28CBlockIndex*+pindex%2C+vConnect%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindex-%26gt%3Bpprev%29%0A++++++++++++pindex-%26gt%3Bpprev-%26gt%3Bpnext+%3D+pindex%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E4%BB%8E%E9%87%8A%E6%94%BE%E9%93%BE%E6%8E%A5%E7%9A%84%E5%88%86%E6%94%AF%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%8C%E5%B0%86%E8%BF%99%E4%BA%9B%E4%BA%A4%E6%98%93%E6%94%BE%E5%85%A5%E5%AF%B9%E5%BA%94%E7%9A%84%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E4%B8%AD%E5%BE%97%E5%88%B0%E5%A4%8D%E6%B4%BB%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Resurrect+memory+transactions+that+were+in+the+disconnected+branch%3C%2Fspan%3E%0A++++foreach%28CTransaction%26amp%3B+tx%2C+vResurrect%29%0A++++++++tx.AcceptTransaction%28txdb%2C+%3Cspan+class%3D%22hljs-keyword%22%3Efalse%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E4%BB%8E%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E4%B8%AD%E5%88%A0%E9%99%A4%E9%82%A3%E4%BA%9B%E5%B7%B2%E7%BB%8F%E5%9C%A8%E4%B8%BB%E9%93%BE%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Delete+redundant+memory+transactions+that+are+in+the+connected+branch%3C%2Fspan%3E%0A++++foreach%28CTransaction%26amp%3B+tx%2C+vDelete%29%0A++++++++tx.RemoveFromMemoryPool%28%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-aa008c743bce5616.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22Reorganize%E6%B5%81%E7%A8%8B%22+title%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch3+id%3D%22143%E5%B0%86%E5%8C%BA%E5%9D%97%E6%96%B0%E5%A2%9E%E5%88%B0%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E9%93%BE%E4%B8%AD%22%3E1.4.3%E5%B0%86%E5%8C%BA%E5%9D%97%E6%96%B0%E5%A2%9E%E5%88%B0%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E9%93%BE%E4%B8%AD%3C%2Fh3%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E5%A2%9E%E5%8A%A0%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E9%93%BE%E4%B8%ADmapBlockIndex%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+CBlock%3A%3AAddToBlockIndex%28%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nFile%2C+%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nBlockPos%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+for+duplicate%3C%2Fspan%3E%0A++++uint256+hash+%3D+GetHash%28%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28mapBlockIndex.count%28hash%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AddToBlockIndex%28%29+%3A+%25s+already+exists%22%3C%2Fspan%3E%2C+hash.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E14%3C%2Fspan%3E%29.c_str%28%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Construct+new+block+index+object%3C%2Fspan%3E%0A++++CBlockIndex*+pindexNew+%3D+%3Cspan+class%3D%22hljs-keyword%22%3Enew%3C%2Fspan%3E+CBlockIndex%28nFile%2C+nBlockPos%2C+*%3Cspan+class%3D%22hljs-keyword%22%3Ethis%3C%2Fspan%3E%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21pindexNew%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AddToBlockIndex%28%29+%3A+new+CBlockIndex+failed%22%3C%2Fspan%3E%29%3B%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Emap%3C%2Fspan%3E%26lt%3Buint256%2C+CBlockIndex*%26gt%3B%3C%2Fspan%3E%3A%3Aiterator+mi+%3D+mapBlockIndex.insert%28make_pair%28hash%2C+pindexNew%29%29.first%3B%0A++++pindexNew-%26gt%3BphashBlock+%3D+%26amp%3B%28%28*mi%29.first%29%3B%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Emap%3C%2Fspan%3E%26lt%3Buint256%2C+CBlockIndex*%26gt%3B%3C%2Fspan%3E%3A%3Aiterator+miPrev+%3D+mapBlockIndex.find%28hashPrevBlock%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28miPrev+%21%3D+mapBlockIndex.end%28%29%29%0A++++%7B%0A++++++++pindexNew-%26gt%3Bpprev+%3D+%28*miPrev%29.second%3B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A2%9E%E5%8A%A0%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E5%AF%B9%E5%BA%94%E7%9A%84%E9%AB%98%E5%BA%A6%3C%2Fspan%3E%0A++++++++pindexNew-%26gt%3BnHeight+%3D+pindexNew-%26gt%3Bpprev-%26gt%3BnHeight+%2B+%3Cspan+class%3D%22hljs-number%22%3E1%3C%2Fspan%3E%3B%0A++++%7D%0A%0A++++CTxDB+txdb%3B%0A++++txdb.TxnBegin%28%29%3B%0A++++txdb.WriteBlockIndex%28CDiskBlockIndex%28pindexNew%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%9B%B4%E6%96%B0%E6%9C%80%E9%95%BF%E9%93%BE%E5%AF%B9%E5%BA%94%E7%9A%84%E6%8C%87%E9%92%88%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+New+best%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E6%96%B0%E9%93%BE%E7%9A%84%E9%AB%98%E5%BA%A6%E5%B7%B2%E7%BB%8F%E8%B6%85%E8%BF%87%E4%B8%BB%E9%93%BE%E4%BA%86%EF%BC%88%E5%8D%B3%E6%98%AF%E6%96%B0%E9%93%BE%E5%88%B0%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%E7%9A%84%E9%95%BF%E5%BA%A6+%E5%A4%A7%E4%BA%8E+%E6%9C%AC%E8%8A%82%E7%82%B9%E8%AE%A4%E4%B8%BA%E7%9A%84%E6%9C%80%E9%95%BF%E9%93%BE%E5%88%B0%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%E7%9A%84%E9%95%BF%E5%BA%A6%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindexNew-%26gt%3BnHeight+%26gt%3B+nBestHeight%29%0A++++%7B%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E6%98%AF%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%3C%2Fspan%3E%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindexGenesisBlock+%3D%3D+NULL+%26amp%3B%26amp%3B+hash+%3D%3D+hashGenesisBlock%29%0A++++++++%7B%0A++++++++++++pindexGenesisBlock+%3D+pindexNew%3B%0A++++++++++++txdb.WriteHashBestChain%28hash%29%3B%0A++++++++%7D%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eelse%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28hashPrevBlock+%3D%3D+hashBestChain%29%0A++++++++%7B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%89%8D%E4%B8%80%E4%B8%AA%E5%9D%97%E6%98%AF%E6%9C%80%E9%95%BF%E7%9A%84%E9%93%BE%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Adding+to+current+best+branch%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21ConnectBlock%28txdb%2C+pindexNew%29+%7C%7C+%21txdb.WriteHashBestChain%28hash%29%29%0A++++++++++++%7B%0A++++++++++++++++txdb.TxnAbort%28%29%3B%0A++++++++++++++++pindexNew-%26gt%3BEraseBlockFromDisk%28%29%3B%0A++++++++++++++++mapBlockIndex.erase%28pindexNew-%26gt%3BGetBlockHash%28%29%29%3B%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Edelete%3C%2Fspan%3E+pindexNew%3B%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AddToBlockIndex%28%29+%3A+ConnectBlock+failed%22%3C%2Fspan%3E%29%3B%0A++++++++++++%7D%0A++++++++++++txdb.TxnCommit%28%29%3B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E5%9C%A8%E6%9C%80%E9%95%BF%E9%93%BE%E4%B8%AD%EF%BC%8C%E6%89%8D%E8%AE%BE%E7%BD%AE%E5%AF%B9%E5%BA%94%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E7%9A%84pnext%E5%AD%97%E6%AE%B5%EF%BC%8C%E5%B0%86%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E8%AE%BE%E7%BD%AE%E5%9C%A8%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E7%9A%84%E5%90%8E%E9%9D%A2%3C%2Fspan%3E%0A++++++++++++pindexNew-%26gt%3Bpprev-%26gt%3Bpnext+%3D+pindexNew%3B%0A%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A6%82%E6%9E%9C%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%97%E5%B7%B2%E7%BB%8F%E6%94%BE%E5%85%A5%E5%88%B0%E4%B8%BB%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%88%99%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BA%A4%E6%98%93%E5%BA%94%E8%AF%A5%E8%A6%81%E4%BB%8E%E6%9C%AC%E8%8A%82%E7%82%B9%E4%BF%9D%E5%AD%98%E7%9A%84%E4%BA%A4%E6%98%93%E5%86%85%E5%AD%98%E6%B1%A0%E4%B8%AD%E5%88%A0%E9%99%A4%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Delete+redundant+memory+transactions%3C%2Fspan%3E%0A++++++++++++foreach%28CTransaction%26amp%3B+tx%2C+vtx%29%0A++++++++++++++++tx.RemoveFromMemoryPool%28%29%3B%0A++++++++%7D%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eelse%3C%2Fspan%3E%0A++++++++%7B%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E6%97%A2%E4%B8%8D%E6%98%AF%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%B8%94%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E4%B9%9F%E4%B8%8D%E5%9C%A8%E6%9C%80%E9%95%BF%E4%B8%BB%E9%93%BE%E4%B8%8A%E7%9A%84%E6%83%85%E5%86%B5%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%86%8D%E5%8A%A0%E4%B8%8A%E6%96%B0%E5%8C%BA%E5%9D%97%E6%89%80%E5%9C%A8%E9%93%BE%E7%9A%84%E9%95%BF%E5%BA%A6%E5%A4%A7%E4%BA%8E%E6%9C%AC%E8%8A%82%E7%82%B9%E8%AE%A4%E4%B8%BA%E4%B8%BB%E9%93%BE%E7%9A%84%E9%95%BF%E5%BA%A6%EF%BC%8C%E6%89%80%E6%9C%89%E5%B0%86%E8%BF%9B%E8%A1%8C%E5%88%86%E5%8F%89%E5%A4%84%E7%90%86%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+New+best+branch%3C%2Fspan%3E%0A++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21Reorganize%28txdb%2C+pindexNew%29%29%0A++++++++++++%7B%0A++++++++++++++++txdb.TxnAbort%28%29%3B%0A++++++++++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AddToBlockIndex%28%29+%3A+Reorganize+failed%22%3C%2Fspan%3E%29%3B%0A++++++++++++%7D%0A++++++++%7D%0A%0A++++++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+New+best+link%3C%2Fspan%3E%0A++++++++hashBestChain+%3D+hash%3B%0A++++++++pindexBest+%3D+pindexNew%3B%0A++++++++nBestHeight+%3D+pindexBest-%26gt%3BnHeight%3B%0A++++++++nTransactionsUpdated%2B%2B%3B%0A++++++++%3Cspan+class%3D%22hljs-built_in%22%3Eprintf%3C%2Fspan%3E%28%3Cspan+class%3D%22hljs-string%22%3E%22AddToBlockIndex%3A+new+best%3D%25s+height%3D%25d%5Cn%22%3C%2Fspan%3E%2C+hashBestChain.ToString%28%29.substr%28%3Cspan+class%3D%22hljs-number%22%3E0%3C%2Fspan%3E%2C%3Cspan+class%3D%22hljs-number%22%3E14%3C%2Fspan%3E%29.c_str%28%29%2C+nBestHeight%29%3B%0A++++%7D%0A%0A++++txdb.TxnCommit%28%29%3B%0A++++txdb.Close%28%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E8%BD%AC%E6%92%AD%E9%82%A3%E4%BA%9B%E5%88%B0%E7%9B%AE%E5%89%8D%E4%B8%BA%E6%AD%A2%E8%BF%98%E6%B2%A1%E6%9C%89%E8%BF%9B%E5%85%A5block%E4%B8%AD%E7%9A%84%E9%92%B1%E5%8C%85%E4%BA%A4%E6%98%93%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Relay+wallet+transactions+that+haven%27t+gotten+in+yet%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28pindexNew+%3D%3D+pindexBest%29%0A++++++++RelayWalletTransactions%28%29%3B%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%9C%A8%E8%8A%82%E7%82%B9%E4%B9%8B%E9%97%B4%E8%BF%9B%E8%A1%8C%E8%BD%AC%E6%92%AD%3C%2Fspan%3E%0A%0A++++MainFrameRepaint%28%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-1fb4fd0dc10a310c.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22CBlock%3A%3AAddToBlockIndex%22+title%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch3+id%3D%22144%E5%8C%BA%E5%9D%97%E6%8E%A5%E5%8F%97%E5%A4%84%E7%90%86%22%3E1.4.4%E5%8C%BA%E5%9D%97%E6%8E%A5%E5%8F%97%E5%A4%84%E7%90%86%3C%2Fh3%3E+%0A++%3Cp%3E%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%B9%E6%B3%95%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22prettyprint%22%3E%3Ccode+class%3D%22language-C%2B%2B+hljs+cpp%22%3E%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%88%A4%E6%96%AD%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E8%83%BD%E5%A4%9F%E8%A2%AB%E6%8E%A5%E6%94%B6%3C%2Fspan%3E%0A%3Cspan+class%3D%22hljs-keyword%22%3Ebool%3C%2Fspan%3E+CBlock%3A%3AAcceptBlock%28%29%0A%7B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+for+duplicate%3C%2Fspan%3E%0A++++uint256+hash+%3D+GetHash%28%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28mapBlockIndex.count%28hash%29%29+%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptBlock%28%29+%3A+block+already+in+mapBlockIndex%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Get+prev+block+index%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-stl_container%22%3E%3Cspan+class%3D%22hljs-built_in%22%3Emap%3C%2Fspan%3E%26lt%3Buint256%2C+CBlockIndex*%26gt%3B%3C%2Fspan%3E%3A%3Aiterator+mi+%3D+mapBlockIndex.find%28hashPrevBlock%29%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28mi+%3D%3D+mapBlockIndex.end%28%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptBlock%28%29+%3A+prev+block+not+found%22%3C%2Fspan%3E%29%3B%0A++++CBlockIndex*+pindexPrev+%3D+%28*mi%29.second%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%BD%93%E5%89%8D%E5%9D%97%E5%88%9B%E5%BB%BA%E7%9A%84%E6%97%B6%E9%97%B4%E8%A6%81%E5%A4%A7%E4%BA%8E%E5%89%8D%E4%B8%80%E4%B8%AA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0%E6%97%B6%E9%97%B4%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+timestamp+against+prev%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28nTime+%26lt%3B%3D+pindexPrev-%26gt%3BGetMedianTimePast%28%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptBlock%28%29+%3A+block%27s+timestamp+is+too+early%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E6%A0%A1%E9%AA%8C%EF%BC%9A%E6%AF%8F%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%E8%87%AA%E5%B7%B1%E8%AE%A1%E7%AE%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Check+proof+of+work%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28nBits+%21%3D+GetNextWorkRequired%28pindexPrev%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptBlock%28%29+%3A+incorrect+proof+of+work%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+Write+block+to+history+file%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nFile%3B%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eunsigned%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Eint%3C%2Fspan%3E+nBlockPos%3B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%B0%86%E5%9D%97%E4%BF%A1%E6%81%AF%E5%86%99%E5%85%A5%E6%96%87%E4%BB%B6%E4%B8%AD%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21WriteToDisk%28%21fClient%2C+nFile%2C+nBlockPos%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptBlock%28%29+%3A+WriteToDisk+failed%22%3C%2Fspan%3E%29%3B%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%E5%A2%9E%E5%8A%A0%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84%E5%BF%AB%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28%21AddToBlockIndex%28nFile%2C+nBlockPos%29%29%0A++++++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+error%28%3Cspan+class%3D%22hljs-string%22%3E%22AcceptBlock%28%29+%3A+AddToBlockIndex+failed%22%3C%2Fspan%3E%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Eif%3C%2Fspan%3E+%28hashBestChain+%3D%3D+hash%29%0A++++++++RelayInventory%28CInv%28MSG_BLOCK%2C+hash%29%29%3B%0A%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%2F%2F+Add+atoms+to+user+reviews+for+coins+created%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+vector%26lt%3Bunsigned+char%26gt%3B+vchPubKey%3B%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+if+%28ExtractPubKey%28vtx%5B0%5D.vout%5B0%5D.scriptPubKey%2C+false%2C+vchPubKey%29%29%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%7B%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+unsigned+short+nAtom+%3D+GetRand%28USHRT_MAX+-+100%29+%2B+100%3B%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+vector%26lt%3Bunsigned+short%26gt%3B+vAtoms%281%2C+nAtom%29%3B%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+AddAtomsAndPropagate%28Hash%28vchPubKey.begin%28%29%2C+vchPubKey.end%28%29%29%2C+vAtoms%2C+true%29%3B%3C%2Fspan%3E%0A++++%3Cspan+class%3D%22hljs-comment%22%3E%2F%2F+%7D%3C%2Fspan%3E%0A%0A++++%3Cspan+class%3D%22hljs-keyword%22%3Ereturn%3C%2Fspan%3E+%3Cspan+class%3D%22hljs-keyword%22%3Etrue%3C%2Fspan%3E%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fupload-images.jianshu.io%2Fupload_images%2F11372892-7374fa05d85b3970.png%3FimageMogr2%2Fauto-orient%2Fstrip%257CimageView2%2F2%2Fw%2F1240%22+alt%3D%22CBlock%3A%3AAcceptBlock%22+title%3D%22%22%3E%3C%2Fp%3E+%0A++%3Ch1+id%3D%222-%E6%BA%90%E7%A0%81%E5%9C%B0%E5%9D%80%22%3E2.+%E6%BA%90%E7%A0%81%E5%9C%B0%E5%9D%80%3C%2Fh1%3E+%0A++%3Cp%3E%E6%88%91%E5%AF%B9%E6%AF%94%E7%89%B9%E5%B8%81bitcoin-0.1.0%E6%BA%90%E7%A0%81%E5%8A%A0%E4%BA%86%E8%AF%A6%E7%BB%86%E7%9A%84%E6%B3%A8%E9%87%8A%EF%BC%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%9C%B0%E5%9D%80%EF%BC%9A%3Ca+href%3D%22https%3A%2F%2Fgithub.com%2Flwjaiyjk%2Fbitcoin-comment-0.1.0.git%22+rel%3D%22nofollow%22+target%3D%22_blank%22%3Ehttps%3A%2F%2Fgithub.com%2Flwjaiyjk%2Fbitcoin-comment-0.1.0.git%3C%2Fa%3E%3C%2Fp%3E+%0A++%3Ch4+id%3D%22%E8%BD%AC%E8%BD%BD%E8%AF%B7%E8%AF%B4%E6%98%8E%E5%87%BA%E5%A4%84%22%3E%E8%BD%AC%E8%BD%BD%E8%AF%B7%E8%AF%B4%E6%98%8E%E5%87%BA%E5%A4%84%3C%2Fh4%3E+%0A+%3C%2Fdiv%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fmarkdown_views-ea0013b516.css%22%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fyujiak%2Farticle%2Fdetails%2F80101582%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fyujiak%2Farticle%2Fdetails%2F80101582%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}