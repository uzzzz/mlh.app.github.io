---
layout: default
title: Hardware tsc bug and core dump analyzation
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3ERecently+one+of+the+exadata+cell+node+experienced+reboot+multiple+times+without+any+load.+This+is+blocking+us+releasing+the+env+to+customer.%3C%2Fp%3E+%0A++%3Cp%3EKernel+is+4.1.12-61.47.1.el6uek.x86_64%3C%2Fp%3E+%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E+%0A++%3Cp%3EI+analyzed+all+6+vmcores+and+found+some+common+feature%2C+expired+timer+jiffies+are+quite+small+than+current+jiffies%2C+like+below%3A%3C%2Fp%3E+TVEC_BASES%5B2%5D%3A+ffff881ffda8eb40%0A++%3Cbr%3E+%26nbsp%3B+JIFFIES%0A++%3Cbr%3E+15605264118%0A++%3Cbr%3E+%26nbsp%3B+EXPIRES%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+TIMER_LIST%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+FUNCTION%0A++%3Cbr%3E+4320897356%26nbsp%3B+ffff88003786a408%26nbsp%3B+ffffffff8157d810+%26lt%3Bintel_pstate_timer_func%26gt%3B%0A++%3Cbr%3E+4320898348%26nbsp%3B+ffff8810af00fc48%26nbsp%3B+ffffffff810ed490+%26lt%3Bprocess_timeout%26gt%3B%0A++%3Cbr%3E+...%0A++%3Cbr%3E+4320898348%26nbsp%3B+ffff8810c7e63c48%26nbsp%3B+ffffffff810ed490+%26lt%3Bprocess_timeout%26gt%3B%0A++%3Cbr%3E+4321197994%26nbsp%3B+ffff881ffda8cee0%26nbsp%3B+ffffffff81045770+%26lt%3Bmce_timer_fn%26gt%3B%0A++%3Cbr%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E+%0A++%3Cp%3EAt+first%2C+I+can%27t+think+of+how+jiffies+jump+like+this%2C+even+with+nohz+enabled%2C+due+to+the+limit+of+max+idle+time%2C+jiffies+delta+is+quite+small.%3Cbr%3E%3C%2Fp%3E+Luckily%2C+I+found+below+log+on+2+vmcores%2C+it+showed+TSC+has+large+jump+from+its+last+value+and+lead+to+current+jiffies+jumped+large.+This+print+isn%27t+in+the+other+4+of+vmcores%2C+because+watchdog+timer+of+clocksource+cycle+through+all+cpus%2840+cpus+in+this+env%29%2C+it+may+not+always+have+opportunity+to+check+the+buggy+cpu+yet+before+the+softlockup.%0A++%3Cbr%3E%0A++%3Cbr%3E+%5B11277703.341052%5D+timekeeping+watchdog%3A+Marking+clocksource+%27tsc%27+as+unstable%2C+because+the+skew+is+too+large%3A%0A++%3Cbr%3E+%5B11277703.341054%5D%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+%27hpet%27+wd_now%3A+63896768+wd_last%3A+636c76a3+mask%3A+ffffffff%0A++%3Cbr%3E+%5B11277703.341056%5D%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+%27tsc%27+cs_now%3A+5a341a9f1c6ea0+cs_last%3A+2341a8dc79b74+mask%3A+ffffffffffffffff%0A++%3Cbr%3E%0A++%3Cbr%3E+In+__run_timers%2C+there+is+a+loop+to+process+all+the+expired+timers+until+current+jiffies%2C+with+a+delta+of+0x5800001154D32C+jiffies+the+loop+time+centainly+exceed+softlockup%27s+timeout.+So+we+see+below+output%3A%0A++%3Cbr%3E%0A++%3Cbr%3E+%5B+5062.020370%5D+NMI+watchdog%3A+BUG%3A+soft+lockup+-+CPU%2322+stuck+for+205s%21+%5Bswapper%2F22%3A0%5D%0A++%3Cbr%3E+%5B+5062.028896%5D+task%3A+ffff881ff17bd400+ti%3A+ffff881ff17e8000+task.ti%3A+ffff881ff17e8000%0A++%3Cbr%3E+%5B+5062.028897%5D+RIP%3A+0010%3A%5B%26lt%3Bffffffff810ed290%26gt%3B%5D+%5B%26lt%3Bffffffff810ed290%26gt%3B%5D+run_timer_softirq%2B0x1f0%2F0x380%0A++%3Cbr%3E+%5B+5062.028923%5D+Call+Trace%3A%0A++%3Cbr%3E+%5B+5062.028924%5D%26nbsp%3B+%26lt%3BIRQ%26gt%3B%0A++%3Cbr%3E+%5B+5062.028930%5D%26nbsp%3B+%5B%26lt%3Bffffffff8157d810%26gt%3B%5D+%3F+pid_param_set%2B0x120%2F0x120%0A++%3Cbr%3E+%5B+5062.028935%5D%26nbsp%3B+%5B%26lt%3Bffffffff8108871a%26gt%3B%5D+__do_softirq%2B0x10a%2F0x350%0A++%3Cbr%3E+%5B+5062.028938%5D%26nbsp%3B+%5B%26lt%3Bffffffff81088ad5%26gt%3B%5D+irq_exit%2B0x125%2F0x130%0A++%3Cbr%3E+%5B+5062.028941%5D%26nbsp%3B+%5B%26lt%3Bffffffff8105b9d4%26gt%3B%5D+%3F+native_apic_msr_eoi_write%2B0x14%2F0x20%0A++%3Cbr%3E+%5B+5062.028946%5D%26nbsp%3B+%5B%26lt%3Bffffffff816a0af6%26gt%3B%5D+smp_apic_timer_interrupt%2B0x46%2F0x60%0A++%3Cbr%3E+%5B+5062.028948%5D%26nbsp%3B+%5B%26lt%3Bffffffff8169ea3e%26gt%3B%5D+apic_timer_interrupt%2B0x6e%2F0x80%0A++%3Cbr%3E+%5B+5062.028949%5D%26nbsp%3B+%26lt%3BEOI%26gt%3B%0A++%3Cbr%3E+%5B+5062.028952%5D%26nbsp%3B+%5B%26lt%3Bffffffff8157e695%26gt%3B%5D+%3F+cpuidle_enter_state%2B0xc5%2F0x230%0A++%3Cbr%3E+%5B+5062.028954%5D%26nbsp%3B+%5B%26lt%3Bffffffff8157e665%26gt%3B%5D+%3F+cpuidle_enter_state%2B0x95%2F0x230%0A++%3Cbr%3E+%5B+5062.028956%5D%26nbsp%3B+%5B%26lt%3Bffffffff8157e817%26gt%3B%5D+cpuidle_enter%2B0x17%2F0x20%0A++%3Cbr%3E+%5B+5062.028959%5D%26nbsp%3B+%5B%26lt%3Bffffffff810c8eb4%26gt%3B%5D+cpuidle_idle_call%2B0xe4%2F0x1e0%0A++%3Cbr%3E+%5B+5062.028961%5D%26nbsp%3B+%5B%26lt%3Bffffffff810c91a5%26gt%3B%5D+cpu_idle_loop%2B0x1f5%2F0x220%0A++%3Cbr%3E+%5B+5062.028962%5D%26nbsp%3B+%5B%26lt%3Bffffffff810c91eb%26gt%3B%5D+%3F+cpu_startup_entry%2B0x1b%2F0x70%0A++%3Cbr%3E+%5B+5062.028964%5D%26nbsp%3B+%5B%26lt%3Bffffffff810c922f%26gt%3B%5D+cpu_startup_entry%2B0x5f%2F0x70%0A++%3Cbr%3E+%5B+5062.028966%5D%26nbsp%3B+%5B%26lt%3Bffffffff81052dab%26gt%3B%5D+start_secondary%2B0xbb%2F0xc0%0A++%3Cbr%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E+%0A++%3Cp%3EFinally+issue+disapper+after+they+replace+the+buggy+processor.+This+issue+should+not+exist+with+4.12+or+above+as+there+is+a+NOHZ+optimized+implementation+for+expired+timer+to+survive+and+drop+down+TSC+source.+I+also+suggest+they+add+%27notsc+lapic%3Dnotscdeadline%27+to+see+if+workaround+the+issue%2C+unluckily+they+will+not+try+it.%3Cbr%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fwangwoshida%2Farticle%2Fdetails%2F78467289%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fwangwoshida%2Farticle%2Fdetails%2F78467289%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}