---
layout: default
title: 深入区块链以太坊源码之挖矿
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22article-copyright%22%3E%0A+++%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%EF%BC%9A%E6%9C%AC%E6%96%87%E4%B8%BA%E5%8D%9A%E4%B8%BB%E5%8E%9F%E5%88%9B%E6%96%87%E7%AB%A0%EF%BC%8C%E6%9C%AA%E7%BB%8F%E5%8D%9A%E4%B8%BB%E5%85%81%E8%AE%B8%E4%B8%8D%E5%BE%97%E8%BD%AC%E8%BD%BD%E3%80%82+https%3A%2F%2Fblog.csdn.net%2FGrit_ICPC%2Farticle%2Fdetails%2F83961285+%0A+%3C%2Fdiv%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-d7e2a68c7c.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22+id%3D%22content_views%22%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22hljs+language-Go%22%3E%2F%2F+Miner+creates+blocks+and+searches+for+proof-of-work+values.%0Atype+Miner+struct+%7B%0A%09mux++++++*event.TypeMux%0A%09worker+++*worker%0A%09coinbase+common.Address%0A%09eth++++++Backend%0A%09engine+++consensus.Engine%0A%09exitCh+++chan+struct%7B%7D%0A%0A%09canStart++++int32+%2F%2F+can+start+indicates+whether+we+can+start+the+mining+operation%0A%09shouldStart+int32+%2F%2F+should+start+indicates+whether+we+should+start+after+sync%0A%7D%0A%0A%2F%2F%E6%8C%96%E7%9F%BF%E5%BC%80%E5%A7%8B%E5%89%8D%E9%9C%80%E8%A6%81%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84miner%0Afunc+New%28eth+Backend%2C+config+*params.ChainConfig%2C+mux+*event.TypeMux%2C+%0A%09engine+consensus.Engine%2C+recommit+time.Duration%2C+gasFloor%2C+%0A%09gasCeil+uint64%2C+isLocalBlock+func%28block+*types.Block%29+bool%29+*Miner+%7B%0A%09miner+%3A%3D+%26amp%3BMiner%7B%0A%09%09eth%3A++++++eth%2C%0A%09%09mux%3A++++++mux%2C%0A%09%09engine%3A+++engine%2C%0A%09%09exitCh%3A+++make%28chan+struct%7B%7D%29%2C%0A%09%09%2F%2F%E5%85%B7%E4%BD%93%E8%AF%A6%E6%83%85%E8%A7%81%E4%B8%8B%E9%9D%A2newWorker%E6%96%B9%E6%B3%95%0A%09%09worker%3A+++newWorker%28config%2C+engine%2C+eth%2C+mux%2C+recommit%2C+gasFloor%2C+gasCeil%2C+isLocalBlock%29%2C%0A%09%09canStart%3A+1%2C%0A%09%7D%0A%09%2F%2F%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B%E6%89%A7%E8%A1%8Cupdate%0A%09%2F*%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E5%A4%84%E4%BA%8E+%E5%8C%BA%E5%9D%97%E7%9A%84%E5%90%8C%E6%AD%A5%E4%B8%AD%EF%BC%8C%E5%88%99%E6%8C%96%E7%9F%BF%E7%9A%84%E6%93%8D%E4%BD%9C%E9%9C%80%E8%A6%81%E5%81%9C%E6%AD%A2%EF%BC%8C%0A%09%E7%9B%B4%E5%88%B0%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C%E7%BB%93%E6%9D%9F%EF%BC%88%E5%90%8C%E6%AD%A5%E6%88%90%E5%8A%9F%E6%88%96%E6%98%AF%E5%A4%B1%E8%B4%A5%EF%BC%89%EF%BC%8C%0A%09%E5%A6%82%E6%9E%9C%E5%8E%9F%E6%9D%A5%E5%B7%B2%E7%BB%8F%E6%89%A7%E8%A1%8C%E4%BA%86%E6%8C%96%E7%9F%BF%E6%93%8D%E4%BD%9C%E7%9A%84%EF%BC%8C%E5%88%99%E7%BB%A7%E7%BB%AD%E5%BC%80%E5%90%AF%E6%8C%96%E7%9F%BF%E6%93%8D%E4%BD%9C*%2F%0A%09go+miner.update%28%29%0A%0A%09return+miner%0A%7D%0A%0A%0Afunc+newWorker%28config+*params.ChainConfig%2C+engine+consensus.Engine%2C+eth+Backend%2C+mux+*event.TypeMux%2C+recommit+time.Duration%2C+gasFloor%2C+gasCeil+uint64%2C+isLocalBlock+func%28*types.Block%29+bool%29+*worker+%7B%0A%09%2F%2F%E6%9E%84%E9%80%A0worker%0A%09worker+%3A%3D+%26amp%3Bworker%7B%0A%09%09config%3A+++++++++++++config%2C%0A%09%09engine%3A+++++++++++++engine%2C%0A%09%09eth%3A++++++++++++++++eth%2C%0A%09%09mux%3A++++++++++++++++mux%2C%0A%09%09chain%3A++++++++++++++eth.BlockChain%28%29%2C%0A%09%09gasFloor%3A+++++++++++gasFloor%2C%0A%09%09gasCeil%3A++++++++++++gasCeil%2C%0A%09%09isLocalBlock%3A+++++++isLocalBlock%2C%0A%09%09localUncles%3A++++++++make%28map%5Bcommon.Hash%5D*types.Block%29%2C%0A%09%09remoteUncles%3A+++++++make%28map%5Bcommon.Hash%5D*types.Block%29%2C%0A%09%09unconfirmed%3A++++++++newUnconfirmedBlocks%28eth.BlockChain%28%29%2C+miningLogAtDepth%29%2C%0A%09%09pendingTasks%3A+++++++make%28map%5Bcommon.Hash%5D*task%29%2C%0A%09%09txsCh%3A++++++++++++++make%28chan+core.NewTxsEvent%2C+txChanSize%29%2C%0A%09%09chainHeadCh%3A++++++++make%28chan+core.ChainHeadEvent%2C+chainHeadChanSize%29%2C%0A%09%09chainSideCh%3A++++++++make%28chan+core.ChainSideEvent%2C+chainSideChanSize%29%2C%0A%09%09%0A%09%09%2F%2F%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84worker%E4%B8%AD%E6%9B%B4%E6%96%B0%E4%BA%86%E4%B8%8B%E9%9D%A2%E5%87%A0%E4%B8%AA%E9%80%9A%E9%81%93%0A%09%09newWorkCh%3A++++++++++make%28chan+*newWorkReq%29%2C%0A%09%09taskCh%3A+++++++++++++make%28chan+*task%29%2C%0A%09%09resultCh%3A+++++++++++make%28chan+*types.Block%2C+resultQueueSize%29%2C%0A%09%09exitCh%3A+++++++++++++make%28chan+struct%7B%7D%29%2C%0A%09%09startCh%3A++++++++++++make%28chan+struct%7B%7D%2C+1%29%2C%0A%09%09resubmitIntervalCh%3A+make%28chan+time.Duration%29%2C%0A%09%09resubmitAdjustCh%3A+++make%28chan+*intervalAdjust%2C+resubmitAdjustChanSize%29%2C%0A%09%7D%0A%09%2F%2F+Subscribe+NewTxsEvent+for+tx+pool%0A%09%2F%2F%E6%B3%A8%E5%86%8CTxsEvent%E4%BA%8B%E4%BB%B6%E5%88%B0tx+pool%E4%BA%A4%E6%98%93%E6%B1%A0%0A%09worker.txsSub+%3D+eth.TxPool%28%29.SubscribeNewTxsEvent%28worker.txsCh%29%0A%09%2F%2F+%E6%B3%A8%E5%86%8C%E4%BA%8B%E4%BB%B6%E5%88%B0tx+pool%E4%BA%A4%E6%98%93%E6%B1%A0%0A%09worker.chainHeadSub+%3D+eth.BlockChain%28%29.SubscribeChainHeadEvent%28worker.chainHeadCh%29%0A%09worker.chainSideSub+%3D+eth.BlockChain%28%29.SubscribeChainSideEvent%28worker.chainSideCh%29%0A%0A%09%2F%2F+Sanitize+recommit+interval+if+the+user-specified+one+is+too+short.%0A%09%2F%2F%E5%A6%82%E6%9E%9C%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9A%E7%9A%84%E9%97%B4%E9%9A%94%E5%A4%AA%E7%9F%AD%EF%BC%8C%E5%88%99%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE%E9%97%B4%E9%9A%94%E3%80%82%0A%09if+recommit+%26lt%3B+minRecommitInterval+%7B%0A%09%09log.Warn%28%22Sanitizing+miner+recommit+interval%22%2C+%22provided%22%2C+recommit%2C+%22updated%22%2C+minRecommitInterval%29%0A%09%09recommit+%3D+minRecommitInterval%0A%09%7D%0A%09%0A%09go+worker.mainLoop%28%29%0A%09%2F%2FnewWorkLoop+%E6%98%AF%E4%B8%80%E4%B8%AA%E4%B8%80%E7%9B%B4%E7%9B%91%E5%90%AC+startCh+%E4%B8%AD%E6%98%AF%E5%90%A6%E6%9C%89%E6%8C%96%E7%9F%BF%E4%BF%A1%E5%8F%B7%0A%09%2F%2F%28startCh%E7%9A%84%E4%BF%A1%E5%8F%B7%E7%94%B1+start%E5%87%BD%E6%95%B0%E6%94%BE%E7%BD%AE%E8%BF%9B%E5%8E%BB%E7%9A%84%EF%BC%8C%E8%A7%81%E4%B8%8B%E9%9D%A2%E7%9A%84start%E6%96%B9%E6%B3%95%29%0A%09go+worker.newWorkLoop%28recommit%29%0A%09go+worker.resultLoop%28%29%0A%09go+worker.taskLoop%28%29%0A%0A%09%2F%2F+Submit+first+work+to+initialize+pending+state.%0A%09worker.startCh+%26lt%3B-+struct%7B%7D%7B%7D%0A%0A%09return+worker%0A%7D%0A%0A%2F%2F+start+sets+the+running+status+as+1+and+triggers+new+work+submitting.%0Afunc+%28w+*worker%29+start%28%29+%7B%0A%09atomic.StoreInt32%28%26amp%3Bw.running%2C+1%29%0A%09w.startCh+%26lt%3B-+struct%7B%7D%7B%7D%0A%7D%0A%0A%0A%2F%2F+newWorkLoop+is+a+standalone+goroutine+to+submit+new+mining+work+upon+received+events.%0A%2F%2FnewWorkLoop%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%BB%E5%9F%BA%E4%BA%8E%E4%BA%8B%E4%BB%B6%E6%8E%A5%E6%94%B6%E5%86%8D%E6%8F%90%E4%BA%A4%E6%96%B0%E6%8C%96%E7%9F%BF%E5%B7%A5%E4%BD%9C%E7%9A%84%E7%BA%BF%E7%A8%8B%0Afunc+%28w+*worker%29+newWorkLoop%28recommit+time.Duration%29+%7B%0A%09var+%28%0A%09%09interrupt+++*int32%0A%09%09minRecommit+%3D+recommit+%2F%2F+minimal+resubmit+interval+specified+by+user.%0A%09%09timestamp+++int64++++++%2F%2F+timestamp+for+each+round+of+mining.%0A%09%29%0A%09%2F%2F+The+Timer+type+represents+a+single+event.%0A%09%2F%2F+When+the+Timer+expires%2C+the+current+time+will+be+sent+on+C%2C%0A%09timer+%3A%3D+time.NewTimer%280%29%0A%09%26lt%3B-timer.C+%2F%2F+discard+the+initial+tick%0A%0A%09%2F%2F+commit+aborts+in-flight+transaction+execution+with+given+signal+and+resubmits+a+new+one.%0A%09%0A%09%2F%2F%E6%8F%90%E4%BA%A4%E6%8C%96%E7%9F%BF%E8%AF%B7%E6%B1%82%E9%80%9A%E8%BF%87w.newWorkCh%E5%A4%84%E7%90%86%EF%BC%8C%E8%80%8CnewWorkCh%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E5%9C%A8%E5%9B%9B%E4%B8%AA%E5%8D%8F%E7%A8%8B%E4%B9%8B%E4%B8%80%E7%9A%84+worker.mainLoop%28%29%E4%B8%AD%E6%89%A7%E8%A1%8C%0A%09%2F%2F%E5%85%B7%E4%BD%93%E5%8F%AF%E4%BB%A5%E7%9C%8BmainLoop%E4%B8%AD%E7%9A%84case%0A%09commit+%3A%3D+func%28noempty+bool%2C+s+int32%29+%7B%0A%09%09if+interrupt+%21%3D+nil+%7B%0A%09%09%09atomic.StoreInt32%28interrupt%2C+s%29%0A%09%09%7D%0A%09%09interrupt+%3D+new%28int32%29%0A%09%09w.newWorkCh+%26lt%3B-+%26amp%3BnewWorkReq%7Binterrupt%3A+interrupt%2C+noempty%3A+noempty%2C+timestamp%3A+timestamp%7D%0A%09%09timer.Reset%28recommit%29%0A%09%09atomic.StoreInt32%28%26amp%3Bw.newTxs%2C+0%29%0A%09%7D%0A%09%2F%2F+recalcRecommit+recalculates+the+resubmitting+interval+upon+feedback.%0A%09%2F%2F%E9%87%8D%E6%96%B0%E8%AE%A1%E7%AE%97+%E9%87%8D%E6%8F%90%E4%BA%A4%E9%97%B4%E9%9A%94%E5%8F%8D%E9%A6%88%E6%97%B6%E9%97%B4%0A%09recalcRecommit+%3A%3D+func%28target+float64%2C+inc+bool%29+%7B%0A%09%09var+%28%0A%09%09%09prev+%3D+float64%28recommit.Nanoseconds%28%29%29%0A%09%09%09next+float64%0A%09%09%29%0A%09%09if+inc+%7B%0A%09%09%09next+%3D+prev*%281-intervalAdjustRatio%29+%2B+intervalAdjustRatio*%28target%2BintervalAdjustBias%29%0A%09%09%09%2F%2F+Recap+if+interval+is+larger+than+the+maximum+time+interval%0A%09%09%09if+next+%26gt%3B+float64%28maxRecommitInterval.Nanoseconds%28%29%29+%7B%0A%09%09%09%09next+%3D+float64%28maxRecommitInterval.Nanoseconds%28%29%29%0A%09%09%09%7D%0A%09%09%7D+else+%7B%0A%09%09%09next+%3D+prev*%281-intervalAdjustRatio%29+%2B+intervalAdjustRatio*%28target-intervalAdjustBias%29%0A%09%09%09%2F%2F+Recap+if+interval+is+less+than+the+user+specified+minimum%0A%09%09%09if+next+%26lt%3B+float64%28minRecommit.Nanoseconds%28%29%29+%7B%0A%09%09%09%09next+%3D+float64%28minRecommit.Nanoseconds%28%29%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09recommit+%3D+time.Duration%28int64%28next%29%29%0A%09%7D%0A%09%2F%2F+clearPending+cleans+the+stale+pending+tasks.%0A%09%2F%2F%E6%B8%85%E9%99%A4%E8%BF%87%E6%9C%9F%E7%9A%84pending%E4%BA%A4%E6%98%93%0A%09clearPending+%3A%3D+func%28number+uint64%29+%7B%0A%09%09w.pendingMu.Lock%28%29%0A%09%09for+h%2C+t+%3A%3D+range+w.pendingTasks+%7B%0A%09%09%09if+t.block.NumberU64%28%29%2BstaleThreshold+%26lt%3B%3D+number+%7B%0A%09%09%09%09delete%28w.pendingTasks%2C+h%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09w.pendingMu.Unlock%28%29%0A%09%7D%0A%0A%09for+%7B%0A%09%09select+%7B%0A%09%09%2F%2F%E5%BE%97%E5%88%B0%E6%8C%96%E7%9F%BF%E5%90%AF%E5%8A%A8%E4%BA%8B%E4%BB%B6%E5%B0%B1%E6%8F%90%E4%BA%A4%E4%B8%80%E4%B8%AA%E6%8C%96%E7%9F%BF%E4%BD%9C%E4%B8%9A+%E6%96%B9%E6%B3%95+commit%0A%09%09case+%26lt%3B-w.startCh%3A%0A%09%09%09clearPending%28w.chain.CurrentBlock%28%29.NumberU64%28%29%29%0A%09%09%09timestamp+%3D+time.Now%28%29.Unix%28%29%0A%09%09%09%2F%2Fcommit%E8%AF%B7%E6%B1%82%E5%AE%9E%E4%BD%93%E4%B8%BB%E8%A6%81%E6%98%AF%E9%80%9A%E8%BF%87+w.newWorkCh+%E8%BF%9B%E8%A1%8C%E4%BA%8B%E4%BB%B6%E7%9A%84%E4%BC%A0%E9%80%92%0A%09%09%09commit%28false%2C+commitInterruptNewHead%29%0A%0A%09%09case+head+%3A%3D+%26lt%3B-w.chainHeadCh%3A%0A%09%09%09clearPending%28head.Block.NumberU64%28%29%29%0A%09%09%09timestamp+%3D+time.Now%28%29.Unix%28%29%0A%09%09%09commit%28false%2C+commitInterruptNewHead%29%0A%0A%09%09case+%26lt%3B-timer.C%3A%0A%09%09%09%2F%2F+If+mining+is+running+resubmit+a+new+work+cycle+periodically+to+pull+in%0A%09%09%09%2F%2F+higher+priced+transactions.+Disable+this+overhead+for+pending+blocks.%0A%09%09%09if+w.isRunning%28%29+%26amp%3B%26amp%3B+%28w.config.Clique+%3D%3D+nil+%7C%7C+w.config.Clique.Period+%26gt%3B+0%29+%7B%0A%09%09%09%09%2F%2F+Short+circuit+if+no+new+transaction+arrives.%0A%09%09%09%09if+atomic.LoadInt32%28%26amp%3Bw.newTxs%29+%3D%3D+0+%7B%0A%09%09%09%09%09timer.Reset%28recommit%29%0A%09%09%09%09%09continue%0A%09%09%09%09%7D%0A%09%09%09%09commit%28true%2C+commitInterruptResubmit%29%0A%09%09%09%7D%0A%0A%09%09case+interval+%3A%3D+%26lt%3B-w.resubmitIntervalCh%3A%0A%09%09%09%2F%2F+Adjust+resubmit+interval+explicitly+by+user.%0A%09%09%09if+interval+%26lt%3B+minRecommitInterval+%7B%0A%09%09%09%09log.Warn%28%22Sanitizing+miner+recommit+interval%22%2C+%22provided%22%2C+interval%2C+%22updated%22%2C+minRecommitInterval%29%0A%09%09%09%09interval+%3D+minRecommitInterval%0A%09%09%09%7D%0A%09%09%09log.Info%28%22Miner+recommit+interval+update%22%2C+%22from%22%2C+minRecommit%2C+%22to%22%2C+interval%29%0A%09%09%09minRecommit%2C+recommit+%3D+interval%2C+interval%0A%0A%09%09%09if+w.resubmitHook+%21%3D+nil+%7B%0A%09%09%09%09w.resubmitHook%28minRecommit%2C+recommit%29%0A%09%09%09%7D%0A%0A%09%09case+adjust+%3A%3D+%26lt%3B-w.resubmitAdjustCh%3A%0A%09%09%09%2F%2F+Adjust+resubmit+interval+by+feedback.%0A%09%09%09if+adjust.inc+%7B%0A%09%09%09%09before+%3A%3D+recommit%0A%09%09%09%09recalcRecommit%28float64%28recommit.Nanoseconds%28%29%29%2Fadjust.ratio%2C+true%29%0A%09%09%09%09log.Trace%28%22Increase+miner+recommit+interval%22%2C+%22from%22%2C+before%2C+%22to%22%2C+recommit%29%0A%09%09%09%7D+else+%7B%0A%09%09%09%09before+%3A%3D+recommit%0A%09%09%09%09recalcRecommit%28float64%28minRecommit.Nanoseconds%28%29%29%2C+false%29%0A%09%09%09%09log.Trace%28%22Decrease+miner+recommit+interval%22%2C+%22from%22%2C+before%2C+%22to%22%2C+recommit%29%0A%09%09%09%7D%0A%0A%09%09%09if+w.resubmitHook+%21%3D+nil+%7B%0A%09%09%09%09w.resubmitHook%28minRecommit%2C+recommit%29%0A%09%09%09%7D%0A%0A%09%09case+%26lt%3B-w.exitCh%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%0A%0A%0A%2F%2FnewWorker%E4%B8%AD%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8D%8F%E7%A8%8B%0A%2F%2F+mainLoop+is+a+standalone+goroutine+to+regenerate+the+sealing+task+based+on+the+received+event.%0Afunc+%28w+*worker%29+mainLoop%28%29+%7B%0A%09defer+w.txsSub.Unsubscribe%28%29%0A%09defer+w.chainHeadSub.Unsubscribe%28%29%0A%09defer+w.chainSideSub.Unsubscribe%28%29%0A%0A%09for+%7B%0A%09%09select+%7B%0A%09%09%2F%2Fw.newWorkCh%E5%9C%A8%E9%87%8C%E5%A4%B4%E5%81%9A%E5%AE%9E%E6%97%B6%E7%9A%84%E7%9B%91%E5%90%AC%EF%BC%8C%E4%B8%80%E5%8F%91%E7%8E%B0%E6%9C%89%E5%86%85%E5%AE%B9%E5%B0%B1%E4%BC%9A%E6%8A%8A%E5%AE%83%E6%8F%90%E4%BA%A4%E7%BB%99%E4%B8%80%E4%B8%AA%E5%8F%AB%E5%81%9A++%0A%09%09%2F%2Fw.commitNewWork%28req.interrupt%2C+req.noempty%29+%E6%8C%96%E7%9F%BF%E4%BD%9C%E4%B8%9A%E6%8F%90%E4%BA%A4%E5%87%BD%E6%95%B0%0A%09%09case+req+%3A%3D+%26lt%3B-w.newWorkCh%3A%0A%09%09%09%2F%2FcommitNewWork%E6%96%B9%E6%B3%95%E5%8F%91%E5%B8%83work%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%B0%86worker%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84%E5%BD%93%E5%89%8D%E7%9A%84%E6%8C%96%E7%9F%BF%E4%BB%BB%E5%8A%A1%E5%8F%91%E5%B8%83%E5%88%B0%E7%AE%A1%E9%81%93%E9%98%9F%E5%88%97%E4%B8%AD+%0A%09%09%09%2F%2F%E5%86%8D%E5%85%B7%E4%BD%93%E5%8F%AF%E4%BB%A5%E7%9C%8B%E4%B8%8B%E9%9D%A2commitNewWork%E6%96%B9%E6%B3%95%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%0A%09%09%09w.commitNewWork%28req.interrupt%2C+req.noempty%2C+req.timestamp%29%0A%0A%09%09case+ev+%3A%3D+%26lt%3B-w.chainSideCh%3A%0A%09%09%09%2F%2F+Short+circuit+for+duplicate+side+blocks%0A%09%09%09if+_%2C+exist+%3A%3D+w.localUncles%5Bev.Block.Hash%28%29%5D%3B+exist+%7B%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%09if+_%2C+exist+%3A%3D+w.remoteUncles%5Bev.Block.Hash%28%29%5D%3B+exist+%7B%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%09%2F%2F+Add+side+block+to+possible+uncle+block+set+depending+on+the+author.%0A%09%09%09if+w.isLocalBlock+%21%3D+nil+%26amp%3B%26amp%3B+w.isLocalBlock%28ev.Block%29+%7B%0A%09%09%09%09w.localUncles%5Bev.Block.Hash%28%29%5D+%3D+ev.Block%0A%09%09%09%7D+else+%7B%0A%09%09%09%09w.remoteUncles%5Bev.Block.Hash%28%29%5D+%3D+ev.Block%0A%09%09%09%7D%0A%09%09%09%2F%2F+If+our+mining+block+contains+less+than+2+uncle+blocks%2C%0A%09%09%09%2F%2F+add+the+new+uncle+block+if+valid+and+regenerate+a+mining+block.%0A%09%09%09if+w.isRunning%28%29+%26amp%3B%26amp%3B+w.current+%21%3D+nil+%26amp%3B%26amp%3B+w.current.uncles.Cardinality%28%29+%26lt%3B+2+%7B%0A%09%09%09%09start+%3A%3D+time.Now%28%29%0A%09%09%09%09if+err+%3A%3D+w.commitUncle%28w.current%2C+ev.Block.Header%28%29%29%3B+err+%3D%3D+nil+%7B%0A%09%09%09%09%09var+uncles+%5B%5D*types.Header%0A%09%09%09%09%09w.current.uncles.Each%28func%28item+interface%7B%7D%29+bool+%7B%0A%09%09%09%09%09%09hash%2C+ok+%3A%3D+item.%28common.Hash%29%0A%09%09%09%09%09%09if+%21ok+%7B%0A%09%09%09%09%09%09%09return+false%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09uncle%2C+exist+%3A%3D+w.localUncles%5Bhash%5D%0A%09%09%09%09%09%09if+%21exist+%7B%0A%09%09%09%09%09%09%09uncle%2C+exist+%3D+w.remoteUncles%5Bhash%5D%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09if+%21exist+%7B%0A%09%09%09%09%09%09%09return+false%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09uncles+%3D+append%28uncles%2C+uncle.Header%28%29%29%0A%09%09%09%09%09%09return+false%0A%09%09%09%09%09%7D%29%0A%09%09%09%09%09w.commit%28uncles%2C+nil%2C+true%2C+start%29%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%0A%09%09case+ev+%3A%3D+%26lt%3B-w.txsCh%3A%0A%09%09%09%2F%2F+Apply+transactions+to+the+pending+state+if+we%27re+not+mining.%0A%09%09%09%2F%2F%0A%09%09%09%2F%2F+Note+all+transactions+received+may+not+be+continuous+with+transactions%0A%09%09%09%2F%2F+already+included+in+the+current+mining+block.+These+transactions+will%0A%09%09%09%2F%2F+be+automatically+eliminated.%0A%09%09%09if+%21w.isRunning%28%29+%26amp%3B%26amp%3B+w.current+%21%3D+nil+%7B%0A%09%09%09%09w.mu.RLock%28%29%0A%09%09%09%09coinbase+%3A%3D+w.coinbase%0A%09%09%09%09w.mu.RUnlock%28%29%0A%0A%09%09%09%09txs+%3A%3D+make%28map%5Bcommon.Address%5Dtypes.Transactions%29%0A%09%09%09%09for+_%2C+tx+%3A%3D+range+ev.Txs+%7B%0A%09%09%09%09%09acc%2C+_+%3A%3D+types.Sender%28w.current.signer%2C+tx%29%0A%09%09%09%09%09txs%5Bacc%5D+%3D+append%28txs%5Bacc%5D%2C+tx%29%0A%09%09%09%09%7D%0A%09%09%09%09txset+%3A%3D+types.NewTransactionsByPriceAndNonce%28w.current.signer%2C+txs%29%0A%09%09%09%09w.commitTransactions%28txset%2C+coinbase%2C+nil%29%0A%09%09%09%09w.updateSnapshot%28%29%0A%09%09%09%7D+else+%7B%0A%09%09%09%09%2F%2F+If+we%27re+mining%2C+but+nothing+is+being+processed%2C+wake+on+new+transactions%0A%09%09%09%09if+w.config.Clique+%21%3D+nil+%26amp%3B%26amp%3B+w.config.Clique.Period+%3D%3D+0+%7B%0A%09%09%09%09%09w.commitNewWork%28nil%2C+false%2C+time.Now%28%29.Unix%28%29%29%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%09atomic.AddInt32%28%26amp%3Bw.newTxs%2C+int32%28len%28ev.Txs%29%29%29%0A%0A%09%09%2F%2F+System+stopped%0A%09%09case+%26lt%3B-w.exitCh%3A%0A%09%09%09return%0A%09%09case+%26lt%3B-w.txsSub.Err%28%29%3A%0A%09%09%09return%0A%09%09case+%26lt%3B-w.chainHeadSub.Err%28%29%3A%0A%09%09%09return%0A%09%09case+%26lt%3B-w.chainSideSub.Err%28%29%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%0A%0A%0A%0A%0A%2F%2F+commitNewWork+generates+several+new+sealing+tasks+based+on+the+parent+block.%0A%2F%2F%E5%81%9A%E5%90%84%E7%A7%8D%E5%90%84%E6%A0%B7%E7%9A%84+block+%E9%A2%84%E5%A4%84%E7%90%86%E5%B7%A5%E4%BD%9C%EF%BC%8C%E5%88%B0%E6%96%B9%E6%B3%95%E7%9A%84%E6%9C%AB%E5%B0%BE+%E4%BA%A4%E4%BB%98%E7%BB%99%E4%BA%86%0A%2F%2Fw.commit%28uncles%2C+w.fullTaskHook%2C+true%2C+tstart%29%0Afunc+%28w+*worker%29+commitNewWork%28interrupt+*int32%2C+noempty+bool%2C+timestamp+int64%29+%7B%0A%09%0A%09...%2F%2Fblock+%E5%A4%84%E7%90%86%E5%B7%A5%E4%BD%9C%0A%09%0A%09%2F%2Fw.commit%E9%87%8C%E9%9D%A2%E6%98%AF%E5%85%88%E5%AF%B9%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%E5%85%88%E5%81%9A%E4%B8%80%E4%BA%9B%E5%A4%84%E7%90%86%E7%84%B6%E5%90%8E%E6%8A%8A+%E6%9E%84%E9%80%A0%E5%A5%BD%E7%9A%84+%E6%94%B6%E6%8D%AE+receipts%0A%09%2F%2F%E7%8A%B6%E6%80%81+state+%E5%8F%8A%E9%A2%84%E5%85%88%E6%89%93%E5%8C%85%E5%A5%BD%E7%9A%84block+%28%E9%87%8C%E5%A4%B4%E6%9C%89%E4%BA%9B%E5%86%85%E5%AE%B9%E9%9C%80%E8%A6%81%E7%9C%9F%E6%AD%A3%E6%8C%96%E7%9F%BF%E6%9D%A5%E5%9B%9E%E5%A1%AB%E7%9A%84%EF%BC%8C%0A%09%2F%2F%E6%AF%94%E5%A6%82+%E9%9A%8F%E6%9C%BA%E6%95%B0%E7%AD%89%29+%26nbsp%3B%E6%9E%84%E9%80%A0%E6%88%90%E4%B8%80%E4%B8%AA%E4%BB%BB%E5%8A%A1%E5%AE%9E%E4%BD%93+task+%E5%AF%B9%E8%B1%A1%E5%B9%B6%E6%8F%90%E4%BA%A4%E7%BB%99+w.taskCh+%E9%80%9A%E9%81%93+%0A%09w.commit%28uncles%2C+w.fullTaskHook%2C+true%2C+tstart%29%0A%7D%0A%0A%0A%2F%2F+commit+runs+any+post-transaction+state+modifications%2C+assembles+the+final+block%0A%2F%2F+and+commits+new+work+if+consensus+engine+is+running.%0A%2F%2F+%E7%BB%84%E8%A3%85receipts%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%B9%B6%E4%B8%94Finalize+%E5%87%BD%E6%95%B0%E6%89%93%E5%8C%85%E5%B0%81%E8%A3%85%E5%8C%BA%E5%9D%97%E5%A1%AB%E5%85%85%E5%85%B6%E4%B8%AD%E9%83%A8%E5%88%86%E6%95%B0%E6%8D%AE%0Afunc+%28w+*worker%29+commit%28uncles+%5B%5D*types.Header%2C+interval+func%28%29%2C+update+bool%2C+start+time.Time%29+error+%7B%0A%09%2F%2F+Deep+copy+receipts+here+to+avoid+interaction+between+different+tasks.%0A%09receipts+%3A%3D+make%28%5B%5D*types.Receipt%2C+len%28w.current.receipts%29%29%0A%09for+i%2C+l+%3A%3D+range+w.current.receipts+%7B%0A%09%09receipts%5Bi%5D+%3D+new%28types.Receipt%29%0A%09%09*receipts%5Bi%5D+%3D+*l%0A%09%7D%0A%09s+%3A%3D+w.current.state.Copy%28%29%0A%09block%2C+err+%3A%3D+w.engine.Finalize%28w.chain%2C+w.current.header%2C+s%2C+w.current.txs%2C+uncles%2C+w.current.receipts%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09if+w.isRunning%28%29+%7B%0A%09%09if+interval+%21%3D+nil+%7B%0A%09%09%09interval%28%29%0A%09%09%7D%0A%09%09select+%7B%0A%09%09%2F%2F%E7%BB%99%E5%87%BA%E5%8C%BA%E5%9D%97%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9E%84%E9%80%A0%E4%B8%80%E4%B8%AAtask%E5%AE%9E%E4%BD%93%EF%BC%8C%E4%BA%A4%E7%BB%99w.taskCh%0A%09%09case+w.taskCh+%26lt%3B-+%26amp%3Btask%7Breceipts%3A+receipts%2C+state%3A+s%2C+block%3A+block%2C+createdAt%3A+time.Now%28%29%7D%3A%0A%09%09%09w.unconfirmed.Shift%28block.NumberU64%28%29+-+1%29%0A%0A%09%09%09feesWei+%3A%3D+new%28big.Int%29%0A%09%09%09for+i%2C+tx+%3A%3D+range+block.Transactions%28%29+%7B%0A%09%09%09%09feesWei.Add%28feesWei%2C+new%28big.Int%29.Mul%28new%28big.Int%29.SetUint64%28receipts%5Bi%5D.GasUsed%29%2C+tx.GasPrice%28%29%29%29%0A%09%09%09%7D%0A%09%09%09feesEth+%3A%3D+new%28big.Float%29.Quo%28new%28big.Float%29.SetInt%28feesWei%29%2C+new%28big.Float%29.SetInt%28big.NewInt%28params.Ether%29%29%29%0A%0A%09%09%09log.Info%28%22Commit+new+mining+work%22%2C+%22number%22%2C+block.Number%28%29%2C+%22sealhash%22%2C+w.engine.SealHash%28block.Header%28%29%29%2C%0A%09%09%09%09%22uncles%22%2C+len%28uncles%29%2C+%22txs%22%2C+w.current.tcount%2C+%22gas%22%2C+block.GasUsed%28%29%2C+%22fees%22%2C+feesEth%2C+%22elapsed%22%2C+common.PrettyDuration%28time.Since%28start%29%29%29%0A%0A%09%09case+%26lt%3B-w.exitCh%3A%0A%09%09%09log.Info%28%22Worker+has+exited%22%29%0A%09%09%7D%0A%09%7D%0A%09if+update+%7B%0A%09%09w.updateSnapshot%28%29%0A%09%7D%0A%09return+nil%0A%7D%0A%0A%0A%2F%2FnewWorker%E6%96%B9%E6%B3%95%E4%B8%AD%E7%9A%84%E7%AC%AC%E5%9B%9B%E4%B8%AA%E5%8D%8F%E7%A8%8B%0A%0A%2F%2F+taskLoop+is+a+standalone+goroutine+to+fetch+sealing+task+from+the+generator+and%0A%2F%2F+push+them+to+consensus+engine.%0Afunc+%28w+*worker%29+taskLoop%28%29+%7B%0A%09var+%28%0A%09%09stopCh+chan+struct%7B%7D%0A%09%09prev+++common.Hash%0A%09%29%0A%0A%09%2F%2F+interrupt+aborts+the+in-flight+sealing+task.%0A%09interrupt+%3A%3D+func%28%29+%7B%0A%09%09if+stopCh+%21%3D+nil+%7B%0A%09%09%09close%28stopCh%29%0A%09%09%09stopCh+%3D+nil%0A%09%09%7D%0A%09%7D%0A%09for+%7B%0A%09%09select+%7B%0A%09%09%2F%2F%E7%9B%91%E5%90%AC%E8%BF%99%E4%B8%AAtaskCh%E9%80%9A%E9%81%93%E8%BF%87%E6%9D%A5%E7%9A%84+task+%E5%AE%9E%E4%BD%93%E4%B8%80%E6%9C%89%E5%B0%B1%E5%90%AF%E5%8A%A8%0A%09%09%2F%2F+seal%28%29+%E5%87%BD%E6%95%B0%E6%8A%8A%E8%BF%99%E4%BA%9B%E4%BF%A1%E6%81%AF+%E4%BA%A4%E7%94%B1%E5%BA%95%E5%B1%82%E7%9A%84%E5%85%B1%E8%AF%86%E5%B1%82%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%BB+%E5%81%9A%E7%9C%9F%E6%AD%A3%E7%9A%84%E6%8C%96%E7%9F%BF%0A%09%09case+task+%3A%3D+%26lt%3B-w.taskCh%3A%0A%09%09%09if+w.newTaskHook+%21%3D+nil+%7B%0A%09%09%09%09w.newTaskHook%28task%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Reject+duplicate+sealing+work+due+to+resubmitting.%0A%09%09%09sealHash+%3A%3D+w.engine.SealHash%28task.block.Header%28%29%29%0A%09%09%09if+sealHash+%3D%3D+prev+%7B%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%09%2F%2F+Interrupt+previous+sealing+operation%0A%09%09%09interrupt%28%29%0A%09%09%09stopCh%2C+prev+%3D+make%28chan+struct%7B%7D%29%2C+sealHash%0A%0A%09%09%09if+w.skipSealHook+%21%3D+nil+%26amp%3B%26amp%3B+w.skipSealHook%28task%29+%7B%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%09w.pendingMu.Lock%28%29%0A%09%09%09w.pendingTasks%5Bw.engine.SealHash%28task.block.Header%28%29%29%5D+%3D+task%0A%09%09%09w.pendingMu.Unlock%28%29%0A%09%09%09%2F%2F%E4%BD%BF%E7%94%A8%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E6%8E%88%E6%9D%83%E5%B0%81%E5%8D%B0%E5%8C%BA%E5%9D%97%0A%09%09%09if+err+%3A%3D+w.engine.Seal%28w.chain%2C+task.block%2C+w.resultCh%2C+stopCh%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09log.Warn%28%22Block+sealing+failed%22%2C+%22err%22%2C+err%29%0A%09%09%09%7D%0A%09%09case+%26lt%3B-w.exitCh%3A%0A%09%09%09interrupt%28%29%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%0A%0A%0A%0A%2F%2F+Seal+implements+consensus.Engine%2C+attempting+to+find+a+nonce+that+satisfies%0A%2F%2F+the+block%27s+difficulty+requirements.%0A%0A%2F%2F%E7%94%A8Engine.Seal%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E5%88%A9%E7%94%A8Engine%E5%AE%9E%E7%8E%B0%E4%BD%93%E7%9A%84%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E5%AF%B9%E4%BC%A0%E5%85%A5%E7%9A%84Block%E8%BF%9B%E8%A1%8C%E6%9C%80%E7%BB%88%E7%9A%84%E6%8E%88%E6%9D%83%EF%BC%8C%0A%2F%2F%E5%A6%82%E6%9E%9C%E6%88%90%E5%8A%9F%EF%BC%8C%E5%B0%B1%E5%B0%86Block%E5%90%8CWork%E4%B8%80%E8%B5%B7%E9%80%9A%E8%BF%87channel%E5%8F%91%E8%BF%98%E7%BB%99worker%EF%BC%8C%E9%82%A3%E8%BE%B9worker.wait%28%29%E4%BC%9A%E6%8E%A5%E6%94%B6%E5%B9%B6%E5%A4%84%E7%90%86%E3%80%82%0A%0A%2F*Seal%28%29%E5%87%BD%E6%95%B0%E5%8F%AF%E5%AF%B9%E4%B8%80%E4%B8%AA%E8%B0%83%E7%94%A8%E8%BF%87Finalize%28%29%E7%9A%84%E5%8C%BA%E5%9D%97%E8%BF%9B%E8%A1%8C%E6%8E%88%E6%9D%83%E6%88%96%E5%B0%81%E5%8D%B0%EF%BC%8C%0A%E5%B9%B6%E5%B0%86%E5%B0%81%E5%8D%B0%E8%BF%87%E7%A8%8B%E4%BA%A7%E7%94%9F%E7%9A%84%E4%B8%80%E4%BA%9B%E5%80%BC%E8%B5%8B%E4%BA%88%E5%8C%BA%E5%9D%97%E4%B8%AD%E5%89%A9%E4%BD%99%E5%B0%9A%E6%9C%AA%E8%B5%8B%E5%80%BC%E7%9A%84%E6%88%90%E5%91%98%28Header.Nonce%2C+Header.MixDigest%29%E3%80%82%0ASeal%28%29%E6%88%90%E5%8A%9F%E6%97%B6%E8%BF%94%E5%9B%9E%E7%9A%84%E5%8C%BA%E5%9D%97%E5%85%A8%E9%83%A8%E6%88%90%E5%91%98%E9%BD%90%E6%95%B4%EF%BC%8C%E5%8F%AF%E8%A7%86%E4%B8%BA%E4%B8%80%E4%B8%AA%E6%AD%A3%E5%B8%B8%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%8F%AF%E8%A2%AB%E5%B9%BF%E6%92%AD%E5%88%B0%E6%95%B4%E4%B8%AA%E7%BD%91%E7%BB%9C%E4%B8%AD%EF%BC%8C%0A%E4%B9%9F%E5%8F%AF%E4%BB%A5%E8%A2%AB%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E9%93%BE%E7%AD%89%E3%80%82%E6%89%80%E4%BB%A5%EF%BC%8C%E5%AF%B9%E4%BA%8E%E6%8C%96%E6%8E%98%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E6%9D%A5%E8%AF%B4%EF%BC%8C%E6%89%80%E6%9C%89%E7%9B%B8%E5%85%B3%E4%BB%A3%E7%A0%81%E9%87%8CEngine.Seal%28%29%E6%98%AF%E5%85%B6%E4%B8%AD%E6%9C%80%E9%87%8D%E8%A6%81%EF%BC%8C%0A%E4%B9%9F%E6%98%AF%E6%9C%80%E5%A4%8D%E6%9D%82%E7%9A%84%E4%B8%80%E6%AD%A5%E3%80%82*%2F%0A%0Afunc+%28ethash+*Ethash%29+Seal%28chain+consensus.ChainReader%2C+block+*types.Block%2C+results+chan%26lt%3B-+*types.Block%2C+stop+%26lt%3B-chan+struct%7B%7D%29+error+%7B%0A%09%2F%2F+If+we%27re+running+a+fake+PoW%2C+simply+return+a+0+nonce+immediately%0A%09if+ethash.config.PowMode+%3D%3D+ModeFake+%7C%7C+ethash.config.PowMode+%3D%3D+ModeFullFake+%7B%0A%09%09header+%3A%3D+block.Header%28%29%0A%09%09header.Nonce%2C+header.MixDigest+%3D+types.BlockNonce%7B%7D%2C+common.Hash%7B%7D%0A%09%09select+%7B%0A%09%09%2F%2F%E5%B0%81%E5%8D%B0%E5%8C%BA%E5%9D%97%E5%A4%B4%0A%09%09case+results+%26lt%3B-+block.WithSeal%28header%29%3A%0A%09%09default%3A%0A%09%09%09log.Warn%28%22Sealing+result+is+not+read+by+miner%22%2C+%22mode%22%2C+%22fake%22%2C+%22sealhash%22%2C+ethash.SealHash%28block.Header%28%29%29%29%0A%09%09%7D%0A%09%09return+nil%0A%09%7D%0A%09%2F%2F+If+we%27re+running+a+shared+PoW%2C+delegate+sealing+to+it%0A%09if+ethash.shared+%21%3D+nil+%7B%0A%09%09return+ethash.shared.Seal%28chain%2C+block%2C+results%2C+stop%29%0A%09%7D%0A%09%2F%2F+Create+a+runner+and+the+multiple+search+threads+it+directs%0A%09abort+%3A%3D+make%28chan+struct%7B%7D%29%0A%0A%09ethash.lock.Lock%28%29%0A%09threads+%3A%3D+ethash.threads%0A%09if+ethash.rand+%3D%3D+nil+%7B%0A%09%09seed%2C+err+%3A%3D+crand.Int%28crand.Reader%2C+big.NewInt%28math.MaxInt64%29%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09ethash.lock.Unlock%28%29%0A%09%09%09return+err%0A%09%09%7D%0A%09%09ethash.rand+%3D+rand.New%28rand.NewSource%28seed.Int64%28%29%29%29%0A%09%7D%0A%09ethash.lock.Unlock%28%29%0A%09if+threads+%3D%3D+0+%7B%0A%09%09threads+%3D+runtime.NumCPU%28%29%0A%09%7D%0A%09if+threads+%26lt%3B+0+%7B%0A%09%09threads+%3D+0+%2F%2F+Allows+disabling+local+mining+without+extra+logic+around+local%2Fremote%0A%09%7D%0A%09%2F%2F+Push+new+work+to+remote+sealer%0A%09if+ethash.workCh+%21%3D+nil+%7B%0A%09%09ethash.workCh+%26lt%3B-+%26amp%3BsealTask%7Bblock%3A+block%2C+results%3A+results%7D%0A%09%7D%0A%09var+%28%0A%09%09pend+++sync.WaitGroup%0A%09%09locals+%3D+make%28chan+*types.Block%29%0A%09%29%0A%09%2F*Ethash.Seal%28%29%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%E4%B8%AD%EF%BC%8C%E4%BC%9A%E4%BB%A5%E5%A4%9A%E7%BA%BF%E7%A8%8B%28goroutine%29%E7%9A%84%E6%96%B9%E5%BC%8F%E5%B9%B6%E8%A1%8C%E8%B0%83%E7%94%A8mine%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%0A%09%E7%BA%BF%E7%A8%8B%E4%B8%AA%E6%95%B0%E7%AD%89%E4%BA%8EEthash.threads%EF%BC%9B%E5%A6%82%E6%9E%9CEthash.threads%E8%A2%AB%E8%AE%BE%E4%B8%BA0%EF%BC%8C%0A%09%E5%88%99Ethash%E9%80%89%E6%8B%A9%E4%BB%A5%E6%9C%AC%E5%9C%B0CPU%E4%B8%AD%E7%9A%84%E6%80%BB%E6%A0%B8%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%BC%80%E5%90%AF%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%B8%AA%E6%95%B0%E3%80%82*%2F%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+threads%3B+i%2B%2B+%7B%0A%09%09pend.Add%281%29%0A%09%09go+func%28id+int%2C+nonce+uint64%29+%7B%0A%09%09%09defer+pend.Done%28%29%0A%09%09%09ethash.mine%28block%2C+id%2C+nonce%2C+abort%2C+locals%29%0A%09%09%7D%28i%2C+uint64%28ethash.rand.Int63%28%29%29%29%0A%09%7D%0A%09%2F%2F+Wait+until+sealing+is+terminated+or+a+nonce+is+found%0A%09go+func%28%29+%7B%0A%09%09var+result+*types.Block%0A%09%09select+%7B%0A%09%09case+%26lt%3B-stop%3A%0A%09%09%09%2F%2F+Outside+abort%2C+stop+all+miner+threads%0A%09%09%09close%28abort%29%0A%09%09case+result+%3D+%26lt%3B-locals%3A%0A%09%09%09%2F%2F+One+of+the+threads+found+a+block%2C+abort+all+others%0A%09%09%09select+%7B%0A%09%09%09%2F%2F%E6%8C%96%E5%87%BA%E5%8C%BA%E5%9D%97%E5%90%8E%E9%80%9A%E8%BF%87%E9%80%9A%E9%81%93%E8%BF%94%E5%9B%9E%E5%88%B0%E5%9B%9B%E4%B8%AA%E5%8D%8F%E7%A8%8B%E4%B8%AD%E7%9A%84+worker.resultLoop%28%29+%EF%BC%8C%E4%BB%8Ew.resultCh%E5%8F%96%E5%87%BA%EF%BC%8Cresults%E5%B0%B1%E6%98%AF%E5%85%B6%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%0A%09%09%09%09%2F%2F%E7%94%B1%E6%AD%A4%E8%BF%94%E5%9B%9E%E6%88%90%E5%8A%9F%E6%8C%96%E5%87%BA%E7%9A%84%E5%8C%BA%E5%9D%97%0A%09%09%09case+results+%26lt%3B-+result%3A%0A%09%09%09default%3A%0A%09%09%09%09log.Warn%28%22Sealing+result+is+not+read+by+miner%22%2C+%22mode%22%2C+%22local%22%2C+%22sealhash%22%2C+ethash.SealHash%28block.Header%28%29%29%29%0A%09%09%09%7D%0A%09%09%09close%28abort%29%0A%09%09case+%26lt%3B-ethash.update%3A%0A%09%09%09%2F%2F+Thread+count+was+changed+on+user+request%2C+restart%0A%09%09%09close%28abort%29%0A%09%09%09if+err+%3A%3D+ethash.Seal%28chain%2C+block%2C+results%2C+stop%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09log.Error%28%22Failed+to+restart+sealing+after+update%22%2C+%22err%22%2C+err%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+Wait+for+all+miners+to+terminate+and+return+the+block%0A%09%09pend.Wait%28%29%0A%09%7D%28%29%0A%09return+nil%0A%7D%0A%0A%0A%0A%2F%2F+mine+is+the+actual+proof-of-work+miner+that+searches+for+a+nonce+starting+from%0A%2F%2F+seed+that+results+in+correct+final+block+difficulty.%0A%2F%2F%E4%BD%BF%E7%94%A8%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E8%BF%9B%E8%A1%8C%E6%8C%96%E7%9F%BF%E6%93%8D%E4%BD%9C%0Afunc+%28ethash+*Ethash%29+mine%28block+*types.Block%2C+id+int%2C+seed+uint64%2C+abort+chan+struct%7B%7D%2C+found+chan+*types.Block%29+%7B%0A%09%2F%2F+Extract+some+data+from+the+header%0A%09%0A%09%2F*%0A%09%E8%BF%99%E9%87%8C%E8%AF%B4%E6%98%8E%E4%B8%80%E4%B8%8Bdataset%E7%9A%84%E7%94%B1%E6%9D%A5%EF%BC%9A%0A%09dataset%E6%98%AF%E6%A0%B9%E6%8D%AECache%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA1GB%E5%A4%A7%E5%B0%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86%E5%90%88DAG%28%E6%9C%89%E5%90%91%E9%9D%9E%E5%BE%AA%E7%8E%AF%E5%9B%BE%29%EF%BC%8C%0A%09%E5%AE%83%E6%98%AF%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E6%90%9C%E7%B4%A2%E7%A9%BA%E9%97%B4%EF%BC%8C%E6%8C%96%E7%9F%BF%E7%9A%84%E8%BF%87%E7%A8%8B%E5%B0%B1%E6%98%AF%E4%BB%8EDAG%E4%B8%AD%E9%9A%8F%E6%9C%BA%E9%80%89%E6%8B%A9%E5%85%83%E7%B4%A0%0A%09%28%E7%B1%BB%E4%BC%BC%E4%BA%8E%E6%AF%94%E7%89%B9%E5%B8%81%E6%8C%96%E7%9F%BF%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%90%88%E9%80%82Nonce%29%E5%86%8D%E8%BF%9B%E8%A1%8C%E5%93%88%E5%B8%8C%E8%BF%90%E7%AE%97%EF%BC%8C%0A%09%E5%8F%AF%E4%BB%A5%E4%BB%8ECache%E5%BF%AB%E9%80%9F%E8%AE%A1%E7%AE%97DAG%E6%8C%87%E5%AE%9A%E4%BD%8D%E7%BD%AE%E7%9A%84%E5%85%83%E7%B4%A0%EF%BC%8C%E8%BF%9B%E8%80%8C%E5%93%88%E5%B8%8C%E9%AA%8C%E8%AF%81%EF%BC%8C%E5%9B%A0%E6%AD%A4cache%E5%B0%B1%E6%98%AFethash%E9%9C%80%E8%A6%81%E7%9A%84%E7%BC%93%E5%AD%98%0A%0A%09%E9%82%A3%E4%B9%88cache%E5%8F%88%E6%98%AF%E6%80%8E%E4%B9%88%E6%9D%A5%E7%9A%84%E5%91%A2%EF%BC%9F%E5%AF%B9%E4%BA%8E%E6%AF%8F%E4%B8%80%E4%B8%AA%E5%9D%97%EF%BC%8C%E9%A6%96%E5%85%88%E8%AE%A1%E7%AE%97%E4%B8%80%E4%B8%AA%E7%A7%8D%E5%AD%90%28seed+%E6%8C%87%E7%9A%84%E6%98%AF%E5%8F%82%E6%95%B0%E4%B8%AD%E7%9A%84seed%29++%EF%BC%8C%0A%09%E8%BF%99%E4%B8%AA%E7%A7%8D%E5%AD%90%E5%85%88%E6%A0%B9%E6%8D%AEblock+number%E4%BB%A5%E5%8F%8Ablock+header%E8%AE%A1%E7%AE%97%E5%87%BA%E4%B8%80%E4%B8%AAseed%EF%BC%88%E7%A7%8D%E5%AD%90%E5%80%BC%EF%BC%89%0A%09%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E7%A7%8D%E5%AD%90%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA32M%E7%9A%84%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%8D%AE%E9%9B%86%EF%BC%88cache%EF%BC%89%0A%0A%09cache%E5%92%8CDAG%E6%AF%8F%E4%B8%AA%E5%91%A8%E6%9C%9F%281000%E4%B8%AA%E5%9D%97%29%E6%9B%B4%E6%96%B0%E4%B8%80%E6%AC%A1%0A%09*%2F%0A%09var+%28%0A%09%09header++%3D+block.Header%28%29%0A%09%09hash++++%3D+ethash.SealHash%28header%29.Bytes%28%29%0A%09%09target++%3D+new%28big.Int%29.Div%28two256%2C+header.Difficulty%29%0A%09%09number++%3D+header.Number.Uint64%28%29%0A%09%09%2F%2F---------------------------------%0A%09%09dataset+%3D+ethash.dataset%28number%2C+false%29%0A%09%29%0A%09%2F%2F+Start+generating+random+nonces+until+we+abort+or+find+a+good+one%0A%09var+%28%0A%09%09attempts+%3D+int64%280%29%0A%09%09nonce++++%3D+seed%0A%09%29%0A%09logger+%3A%3D+log.New%28%22miner%22%2C+id%29%0A%09logger.Trace%28%22Started+ethash+search+for+new+nonces%22%2C+%22seed%22%2C+seed%29%0A%09search%3A%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+%26lt%3B-abort%3A%0A%09%09%09%2F%2F+Mining+terminated%2C+update+stats+and+abort%0A%09%09%09logger.Trace%28%22Ethash+nonce+search+aborted%22%2C+%22attempts%22%2C+nonce-seed%29%0A%09%09%09ethash.hashrate.Mark%28attempts%29%0A%09%09%09break+search%0A%0A%09%09default%3A%0A%09%09%09%2F%2F+We+don%27t+have+to+update+hash+rate+on+every+nonce%2C+so+update+after+after+2%5EX+nonces%0A%09%09%09attempts%2B%2B%0A%09%09%09if+%28attempts+%25+%281+%26lt%3B%26lt%3B+15%29%29+%3D%3D+0+%7B%0A%09%09%09%09ethash.hashrate.Mark%28attempts%29%0A%09%09%09%09attempts+%3D+0%0A%09%09%09%7D%0A%09%09%09%2F%2F+Compute+the+PoW+value+of+this+nonce%0A%09%09%09%2F%2F%E8%BF%9B%E5%85%A5hashimotoFull%EF%BC%8C%E8%BF%9B%E8%A1%8C%E5%85%B7%E4%BD%93%E7%9A%84%E6%8C%96%E7%9F%BF%E8%BF%90%E7%AE%97%0A%09%09%09digest%2C+result+%3A%3D+hashimotoFull%28dataset.dataset%2C+hash%2C+nonce%29%0A%09%09%09%2F%2F%E8%BF%99%E9%87%8C%E7%9A%84target%E4%B8%BA%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%E6%98%AF+256%2Fdifficulty+%0A%09%09%09if+new%28big.Int%29.SetBytes%28result%29.Cmp%28target%29+%26lt%3B%3D+0+%7B%0A%09%09%09%09%2F%2F+Correct+nonce+found%2C+create+a+new+header+with+it%0A%09%09%09%09header+%3D+types.CopyHeader%28header%29%0A%09%09%09%09header.Nonce+%3D+types.EncodeNonce%28nonce%29%0A%09%09%09%09header.MixDigest+%3D+common.BytesToHash%28digest%29%0A%0A%09%09%09%09%2F%2F+Seal+and+return+a+block+%28if+still+needed%29%0A%09%09%09%09select+%7B%0A%09%09%09%09case+found+%26lt%3B-+block.WithSeal%28header%29%3A%0A%09%09%09%09%09logger.Trace%28%22Ethash+nonce+found+and+reported%22%2C+%22attempts%22%2C+nonce-seed%2C+%22nonce%22%2C+nonce%29%0A%09%09%09%09case+%26lt%3B-abort%3A%0A%09%09%09%09%09logger.Trace%28%22Ethash+nonce+found+but+discarded%22%2C+%22attempts%22%2C+nonce-seed%2C+%22nonce%22%2C+nonce%29%0A%09%09%09%09%7D%0A%09%09%09%09break+search%0A%09%09%09%7D%0A%09%09%09nonce%2B%2B%0A%09%09%7D%0A%09%7D%0A%09%2F%2F+Datasets+are+unmapped+in+a+finalizer.+Ensure+that+the+dataset+stays+live%0A%09%2F%2F+during+sealing+so+it%27s+not+unmapped+while+being+read.%0A%09runtime.KeepAlive%28dataset%29%0A%7D%0A%0A%0A%2F%2F+hashimotoFull+aggregates+data+from+the+full+dataset+%28using+the+full+in-memory%0A%2F%2F+dataset%29+in+order+to+produce+our+final+value+for+a+particular+header+hash+and%0A%2F%2F+nonce.%0A%2F*hashimotoFull%28%29%E5%A4%84%E4%BA%8E%E4%B8%80%E4%B8%AA%E5%BE%AA%E7%8E%AF%E4%B8%AD%E8%B0%83%E7%94%A8%E5%85%B6%E8%BF%9B%E8%A1%8C%E4%B8%80%E7%B3%BB%E5%88%97%E5%A4%8D%E6%9D%82%E8%BF%90%E7%AE%97+%E6%97%B6%E4%BC%A0%E5%85%A5%E7%9A%84hash%E3%80%81nonce%E3%80%81%0A%E5%B7%A8%E5%A4%A7%E7%9A%84%E8%BE%85%E5%8A%A9%E6%95%B0%E7%BB%84dataset%28%E4%B9%9F%E5%B0%B1%E6%98%AF%E6%88%91%E4%BB%AC%E8%AF%B4%E7%9A%84%E6%90%9C%E7%B4%A2%E6%88%96%E6%98%AF%E5%8C%B9%E9%85%8D%E7%A9%BA%E9%97%B4%29%EF%BC%8C%E4%BB%A5%E5%8F%8A%E7%BB%93%E6%9E%9C%E6%AF%94%E8%BE%83%E7%9A%84target%EF%BC%9B%0A%E4%B8%80%E6%97%A6%E5%AE%83%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%E7%AC%A6%E5%90%88%E6%9D%A1%E4%BB%B6%EF%BC%8C%E5%B0%B1%E5%A4%8D%E5%88%B6Header%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E8%B5%8B%E5%80%BCNonce%E3%80%81MixDigest%E5%B1%9E%E6%80%A7%EF%BC%8C%0A%E8%BF%94%E5%9B%9E%E7%BB%8F%E8%BF%87%E6%8E%88%E6%9D%83%E7%9A%84%E5%8C%BA%E5%9D%97*%2F%0A%0A%0Afunc+hashimotoFull%28dataset+%5B%5Duint32%2C+hash+%5B%5Dbyte%2C+nonce+uint64%29+%28%5B%5Dbyte%2C+%5B%5Dbyte%29+%7B%0A%09%2F%2F%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AAlookup%E5%87%BD%E6%95%B0%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%9C%A8%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%AD%E6%9F%A5%E6%89%BE%E6%95%B0%E6%8D%AE%0A%09lookup+%3A%3D+func%28index+uint32%29+%5B%5Duint32+%7B%0A%09%09offset+%3A%3D+index+*+hashWords++%2F%2FhashWords++++++++++%3D+16+%0A%09%09return+dataset%5Boffset+%3A+offset%2BhashWords%5D%0A%09%7D%0A%09%2F%2Fdataset%E6%95%B0%E6%8D%AE%E9%9B%86%E8%BF%9B%E8%A1%8C%E5%88%86%E5%89%B2%E8%AF%BB%E5%8F%96%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BC%A0%E7%BB%99hashimoto%E5%87%BD%E6%95%B0%0A%09return+hashimoto%28hash%2C+nonce%2C+uint64%28len%28dataset%29%29*4%2C+lookup%29%0A%7D%0A%0A%0A%0A%2F%2F+hashimoto+aggregates+data+from+the+full+dataset+in+order+to+produce+our+final%0A%2F%2F+value+for+a+particular+header+hash+and+nonce.%0A%0A%2F%2F%E5%9C%A8%E4%BC%A0%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86%E4%B8%AD%E9%80%9A%E8%BF%87hash%E5%92%8Cnonce%E5%80%BC%E8%AE%A1%E7%AE%97%E5%8A%A0%E5%AF%86%E5%80%BC%0Afunc+hashimoto%28hash+%5B%5Dbyte%2C+nonce+uint64%2C+size+uint64%2C+lookup+func%28index+uint32%29+%5B%5Duint32%29+%28%5B%5Dbyte%2C+%5B%5Dbyte%29+%7B%0A%09%2F%2F+Calculate+the+number+of+theoretical+rows+%28we+use+one+buffer+nonetheless%29%0A%09%2F%2Fsize+%3D+uint64%28len%28dataset%29%29*4%0A%09%2F%2F%E8%AE%A1%E7%AE%97%E6%95%B0%E6%8D%AE%E9%9B%86%E7%90%86%E8%AE%BA%E7%9A%84%E8%A1%8C%E6%95%B0%0A%09rows+%3A%3D+uint32%28size+%2F+mixBytes%29+++%2F%2FmixBytes+++++++++++%3D+128+++++%2F%2F+Width+of+mix%0A%0A%09%2F%2F+Combine+header%2Bnonce+into+a+64+byte+seed%0A%09%2F%2F%E5%90%88%E5%B9%B6header%E5%92%8Cnonce%E5%88%B0%E4%B8%80%E4%B8%AA40bytes%E7%9A%84seed%0A%09seed+%3A%3D+make%28%5B%5Dbyte%2C+40%29%0A%09copy%28seed%2C+hash%29%0A%0A%09binary.LittleEndian.PutUint64%28seed%5B32%3A%5D%2C+nonce%29%0A%09%2F%2F%2F+%E5%B0%86seed%E8%BF%9B%E8%A1%8CKeccak512%E5%8A%A0%E5%AF%86%0A%09seed+%3D+crypto.Keccak512%28seed%29%0A%09seedHead+%3A%3D+binary.LittleEndian.Uint32%28seed%29%0A%0A%09%2F%2F+Start+the+mix+with+replicated+seed%0A%09%2F%2F%E4%B8%8E%E9%87%8D%E6%96%B0%E6%9E%84%E9%80%A0%E7%9A%84seed%E6%B7%B7%E5%90%88+mixBytes%2F4+%0A%09mix+%3A%3D+make%28%5B%5Duint32%2C+mixBytes%2F4%29%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+len%28mix%29%3B+i%2B%2B+%7B%0A%09%09%2F%2F%E4%BB%8Eseed%E4%B8%AD%E5%8F%96%E5%85%83%E7%B4%A0%E5%88%B0%E9%95%BF%E5%BA%A6%E4%B8%BA32%E7%9A%84mix%E6%95%B0%E7%BB%84%0A%2F%2Fmix%E4%B8%AD%E4%BB%A5%E5%B0%8F%E7%AB%AF%E6%A0%BC%E5%BC%8F%E5%AD%98%E5%82%A8%28Little-Endian%29%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%BD%8E%E4%BD%8D%E5%AD%97%E8%8A%82%E6%8E%92%E6%94%BE%E5%9C%A8%E5%86%85%E5%AD%98%E7%9A%84%E4%BD%8E%E5%9C%B0%E5%9D%80%2C%E9%AB%98%E4%BD%8D%E5%AD%97%E8%8A%82%E6%8E%92%E6%94%BE%E5%9C%A8%E5%86%85%E5%AD%98%E7%9A%84%E9%AB%98%E5%9C%B0%E5%9D%80%E7%AB%AF%0A%09%09%2F%2F%E4%B8%80%E8%88%AC%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%83%BD%E6%98%AF%E5%B0%8F%E7%AB%AF%EF%BC%8C%E8%80%8C%E9%80%9A%E8%AE%AF%E5%8D%8F%E8%AE%AE%E6%98%AF%E5%A4%A7%E7%AB%AF%E7%9A%84%0A%2F*%0A%09unsigned+int+value+%3D+0x12345678+%E5%85%B6%E4%B8%AD%E6%9C%80%E9%AB%98%E4%BD%8D%E5%AD%97%E8%8A%82%E4%B8%BA12%EF%BC%8C%E6%9C%80%E4%BD%8E%E4%BD%8D%E4%B8%BA78%0A%09%E5%A4%A7%E7%AB%AF%E6%A0%BC%E5%BC%8F%0A++++++++---------------%0A++++++++buf%5B3%5D+%280x78%29+--+%E4%BD%8E%E4%BD%8D%0A++++++++buf%5B2%5D+%280x56%29%0A++++++++buf%5B1%5D+%280x34%29%0A++++++++buf%5B0%5D+%280x12%29+--+%E9%AB%98%E4%BD%8D%0A%09%0A%09%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%88%86%E5%91%A2%EF%BC%9F+%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%9C%A8%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E4%B8%AD%EF%BC%8C%0A%09%E6%88%91%E4%BB%AC%E6%98%AF%E4%BB%A5%E5%AD%97%E8%8A%82%E4%B8%BA%E5%8D%95%E4%BD%8D%E7%9A%84%EF%BC%8C%E6%AF%8F%E4%B8%AA%E5%9C%B0%E5%9D%80%E5%8D%95%E5%85%83%E9%83%BD%E5%AF%B9%E5%BA%94%E7%9D%80%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%EF%BC%8C%0A%09%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%E4%B8%BA8bit%E3%80%82%E4%BD%86%E6%98%AF%E5%9C%A8C%E8%AF%AD%E8%A8%80%E4%B8%AD%E9%99%A4%E4%BA%868bit%E7%9A%84char%E4%B9%8B%E5%A4%96%EF%BC%8C%0A%09%E8%BF%98%E6%9C%8916bit%E7%9A%84short%E5%9E%8B%EF%BC%8C32bit%E7%9A%84long%E5%9E%8B%EF%BC%88%E8%A6%81%E7%9C%8B%E5%85%B7%E4%BD%93%E7%9A%84%E7%BC%96%E8%AF%91%E5%99%A8%EF%BC%89%EF%BC%8C%0A%09%E5%8F%A6%E5%A4%96%EF%BC%8C%E5%AF%B9%E4%BA%8E%E4%BD%8D%E6%95%B0%E5%A4%A7%E4%BA%8E8%E4%BD%8D%E7%9A%84%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%8C%E4%BE%8B%E5%A6%8216%E4%BD%8D%E6%88%96%E8%80%8532%E4%BD%8D%E7%9A%84%E5%A4%84%E7%90%86%E5%99%A8%EF%BC%8C%0A%09%E7%94%B1%E4%BA%8E%E5%AF%84%E5%AD%98%E5%99%A8%E5%AE%BD%E5%BA%A6%E5%A4%A7%E4%BA%8E%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%EF%BC%8C%E9%82%A3%E4%B9%88%E5%BF%85%E7%84%B6%E5%AD%98%E5%9C%A8%E7%9D%80%E4%B8%80%E4%B8%AA%E5%A6%82%E6%9E%9C%E5%B0%86%E5%A4%9A%E4%B8%AA%E5%AD%97%E8%8A%82%E5%AE%89%E6%8E%92%E7%9A%84%E9%97%AE%E9%A2%98%E3%80%82%0A%09%E5%9B%A0%E6%AD%A4%E5%B0%B1%E5%AF%BC%E8%87%B4%E4%BA%86%E5%A4%A7%E7%AB%AF%E5%AD%98%E5%82%A8%E6%A8%A1%E5%BC%8F%E5%92%8C%E5%B0%8F%E7%AB%AF%E5%AD%98%E5%82%A8%E6%A8%A1%E5%BC%8F%E3%80%82%0A%0A*%2F%0A%0A%09%09mix%5Bi%5D+%3D+binary.LittleEndian.Uint32%28seed%5Bi%2516*4%3A%5D%29%0A%09%7D%0A%09%2F%2F+Mix+in+random+dataset+nodes%0A%09%2F%2F%E5%AE%9A%E4%B9%89tmp%EF%BC%8C%E4%B8%8Emix%E7%BB%93%E6%9E%84%E7%9B%B8%E5%90%8C%EF%BC%8C%E9%95%BF%E5%BA%A6%E7%9B%B8%E5%90%8C%0A%09temp+%3A%3D+make%28%5B%5Duint32%2C+len%28mix%29%29%0A%09%2F%2FloopAccesses+++++++%3D+64++++++%2F%2F+Number+of+accesses+in+hashimoto+loop%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+loopAccesses%3B+i%2B%2B+%7B%0A%09%09parent+%3A%3D+fnv%28uint32%28i%29%5EseedHead%2C+mix%5Bi%25len%28mix%29%5D%29+%25+rows%0A%09%09for+j+%3A%3D+uint32%280%29%3B+j+%26lt%3B+mixBytes%2FhashBytes%3B+j%2B%2B+%7B%0A%09%09%09copy%28temp%5Bj*hashWords%3A%5D%2C+lookup%282*parent%2Bj%29%29%0A%09%09%7D%0A%09%09%2F%2F%E5%B0%86mix%E4%B8%AD%E6%89%80%E6%9C%89%E5%85%83%E7%B4%A0%E9%83%BD%E4%B8%8Etemp%E4%B8%AD%E5%AF%B9%E5%BA%94%E4%BD%8D%E7%BD%AE%E7%9A%84%E5%85%83%E7%B4%A0%E8%BF%9B%E8%A1%8CFNV+hash%E8%BF%90%E7%AE%97%0A%09%09fnvHash%28mix%2C+temp%29%0A%09%7D%0A%09%2F%2F+Compress+mix%0A%09%2F%2F%E6%B7%B7%E6%B7%86mix%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+len%28mix%29%3B+i+%2B%3D+4+%7B%0A%0A%2F%2F+FNV%E8%83%BD%E5%BF%AB%E9%80%9Fhash%E5%A4%A7%E9%87%8F%E6%95%B0%E6%8D%AE%E5%B9%B6%E4%BF%9D%E6%8C%81%E8%BE%83%E5%B0%8F%E7%9A%84%E5%86%B2%E7%AA%81%E7%8E%87%EF%BC%8C%E5%AE%83%E7%9A%84%E9%AB%98%E5%BA%A6%E5%88%86%E6%95%A3%E4%BD%BF%E5%AE%83%E9%80%82%E7%94%A8%E4%BA%8Ehash%E4%B8%80%E4%BA%9B%E9%9D%9E%E5%B8%B8%E7%9B%B8%E8%BF%91%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A6%82url%EF%BC%8Cip%E7%AD%89%0A%2F%2F+FNV%E6%98%AF%E5%9F%BA%E4%BA%8E%E5%90%91%E9%87%8F%E2%80%9C%E5%BC%82%E6%88%96%E2%80%9D%E7%9A%84%E6%93%8D%E4%BD%9C%E6%9D%A5%E6%B7%B7%E6%B7%86mix%E6%95%B0%E7%BB%84%0A%09%09mix%5Bi%2F4%5D+%3D+fnv%28fnv%28fnv%28mix%5Bi%5D%2C+mix%5Bi%2B1%5D%29%2C+mix%5Bi%2B2%5D%29%2C+mix%5Bi%2B3%5D%29%0A%09%7D%0A%09%2F%2F%E4%BF%9D%E7%95%998%E4%B8%AA%E9%95%BF%E5%BA%A6mix%E6%9C%89%E6%95%88%E6%95%B0%E6%8D%AE%0A%09mix+%3D+mix%5B%3Alen%28mix%29%2F4%5D%0A%0A%09%2F%2F%E5%B0%86%E9%95%BF%E5%BA%A6%E4%B8%BA8%E7%9A%84mix%E5%88%86%E6%95%A3%E5%88%B032%E4%BD%8D%E7%9A%84digest%E4%B8%AD%E5%8E%BB%0A%09digest+%3A%3D+make%28%5B%5Dbyte%2C+common.HashLength%29%0A%09for+i%2C+val+%3A%3D+range+mix+%7B%0A%09%09binary.LittleEndian.PutUint32%28digest%5Bi*4%3A%5D%2C+val%29%0A%09%7D%0A%09return+digest%2C+crypto.Keccak256%28append%28seed%2C+digest...%29%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FGrit_ICPC%2Farticle%2Fdetails%2F83961285%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FGrit_ICPC%2Farticle%2Fdetails%2F83961285%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09if%28typeof+window.localStorage+%3D%3D%3D+%22object%22+%26%26+typeof+window.csdn.anonymousUserLimit+%3D%3D%3D+%22object%22%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09if%28%21window.csdn.anonymousUserLimit.judgment%28%29%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09%09window.csdn.anonymousUserLimit.Jumplogin%28%29%3B%0A%09%09%09%09%09%09%09%09%09%09%09%09return+false%3B%0A%09%09%09%09%09%09%09%09%09%09%09%7Delse+if%28%21currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09%09window.csdn.anonymousUserLimit.updata%28%29%3B%0A%09%09%09%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%09%09%09%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}