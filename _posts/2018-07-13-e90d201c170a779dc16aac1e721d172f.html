---
layout: default
title: 比特币源码分析--挖矿的实现
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e4c7a3727d.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%8C%96%E7%9F%BF%E5%BA%94%E8%AF%A5%E6%98%AF%E8%BF%91%E5%87%A0%E5%B9%B4%E9%9D%9E%E5%B8%B8%E6%B5%81%E8%A1%8C%E7%9A%84%E4%B8%80%E4%B8%AA%E5%90%8D%E8%AF%8D%E4%BA%86%EF%BC%8C%E9%80%9A%E8%BF%87%E5%89%8D%E9%9D%A2%E6%96%87%E7%AB%A0%E7%9A%84%E4%BB%8B%E7%BB%8D%E6%88%91%E4%BB%AC%E7%8E%B0%E5%9C%A8%E5%B7%B2%E7%BB%8F%E7%9F%A5%E9%81%93%E4%BA%86%EF%BC%9A%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%EF%BC%8C%E6%89%80%E8%B0%93%E7%9A%84%E6%8C%96%E7%9F%BF%E5%85%B6%E5%AE%9E%E6%98%AF%E7%B3%BB%E7%BB%9F%E9%80%9A%E8%BF%87%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95%E5%B0%B1%E2%80%9C%E7%94%B1%E8%B0%81%E6%9D%A5%E5%90%91%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E5%86%99%E5%85%A5%E5%8C%BA%E5%9D%97%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%A5%96%E5%8A%B1%E2%80%9D%E4%B8%80%E4%BA%8B%E8%BE%BE%E6%88%90%E4%B8%80%E8%87%B4%E7%9A%84%E8%BF%87%E7%A8%8B%E3%80%82%E6%9C%AC%E6%96%87%E9%80%9A%E8%BF%87%E5%88%86%E6%9E%90%E6%AF%94%E7%89%B9%E5%B8%81%E6%BA%90%E7%A0%81%EF%BC%8C%E4%BB%8E%E6%8A%80%E6%9C%AF%E8%A7%92%E5%BA%A6%E6%9D%A5%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8B%E6%8C%96%E7%9F%BF%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82%3C%2Fp%3E%0A++%3Ch1%3E1+%E6%8C%96%E7%9F%BF%E7%9A%84%E6%B5%81%E7%A8%8B%3C%2Fh1%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%AF%E4%BB%A5%E8%AF%B4%EF%BC%8C%E6%AF%94%E7%89%B9%E5%B8%81%E5%B0%B1%E6%98%AF%E9%9D%A0%E6%8C%96%E7%9F%BF%E6%9D%A5%E8%BF%90%E4%BD%9C%E7%9A%84%EF%BC%8C%E6%8C%96%E7%9F%BF%E4%B8%8D%E4%BB%85%E4%BF%9D%E8%AF%81%E6%AF%94%E7%89%B9%E5%B8%81%E4%BA%86%E6%AF%94%E7%89%B9%E5%B8%81%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%EF%BC%8C%E5%90%8C%E6%97%B6%E6%AF%94%E7%89%B9%E5%B8%81%E4%B9%9F%E6%98%AF%E9%80%9A%E8%BF%87%E6%8C%96%E7%9F%BF%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E5%8F%91%E8%A1%8C%E7%9A%84%EF%BC%8C%E5%85%88%E7%AE%80%E8%A6%81%E6%A6%82%E6%8B%AC%E4%B8%80%E4%B8%8B%E6%8C%96%E7%9F%BF%E6%B5%81%E7%A8%8B%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%E5%BD%93%E4%B8%80%E4%B8%AA%E7%9F%BF%E5%B7%A5%E6%94%B6%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B9%BF%E6%92%AD%E4%BB%A5%E5%90%8E%EF%BC%8C%E8%AF%81%E6%98%8E%E5%B7%B2%E7%BB%8F%E6%9C%89%E4%BA%BA%E6%8A%A2%E5%85%88%E4%B8%80%E6%AD%A5%E4%BA%86%EF%BC%8C%E7%9F%BF%E5%B7%A5%E5%AF%B9%E6%94%B6%E5%88%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%92%8C%E5%8C%BA%E5%9D%97%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E6%A0%A1%E9%AA%8C%E6%97%A0%E8%AF%AF%E5%90%8E%E5%B0%B1%E5%B0%86%E5%8C%BA%E5%9D%97%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%EF%BC%8C%E7%84%B6%E5%90%8E%E7%AB%8B%E5%88%BB%E6%8A%95%E5%85%A5%E5%88%B0%E6%8C%96%E6%8E%98%E4%B8%8B%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E7%AB%9E%E8%B5%9B%E4%B8%AD%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E7%9F%BF%E5%B7%A5%E4%BB%8E%E4%BA%A4%E6%98%93%E6%B1%A0%E4%B8%AD%E9%80%89%E6%8B%A9%E4%B8%80%E6%89%B9%E4%BA%A4%E6%98%93%E6%9E%84%E9%80%A0%E5%87%BA%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E7%94%9F%E6%88%90%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%EF%BC%88hash%E8%BF%90%E7%AE%97%EF%BC%8C%E6%8B%BC%E7%AE%97%E5%8A%9B%EF%BC%89%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%283%29+%E7%AE%97%E5%87%BA%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E5%90%8E%E7%AB%8B%E5%8D%B3%E5%B0%86%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%8C%BA%E5%9D%97%E5%B9%BF%E6%92%AD%E5%88%B0%E5%88%B0%E7%BD%91%E7%BB%9C%E4%B8%AD%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%284%29+%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%85%B6%E4%BB%96%E7%9A%84%E7%9F%BF%E5%B7%A5%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E9%AA%8C%E8%AF%81%E6%97%A0%E8%AF%AF%E5%90%8E%E4%B9%9F%E5%B0%86%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%85%B1%E8%AF%86%E5%AE%8C%E6%88%90%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%285%29+%E5%BC%80%E5%A7%8B%E4%B8%8B%E4%B8%80%E4%B8%AA%E6%8C%96%E7%9F%BF%E5%91%A8%E6%9C%9F%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch1%3E2+%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%3C%2Fh1%3E%0A++%3Ch2%3E2.1+%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%8F%98%E9%87%8F%3C%2Fh2%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%9C%A8%E5%88%86%E6%9E%90%E6%BA%90%E7%A0%81%E4%B9%8B%E5%89%8D%EF%BC%8C%E9%A6%96%E5%85%88%E4%BA%86%E8%A7%A3%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%8F%98%E9%87%8F%EF%BC%8C%E8%BF%99%E4%BA%9B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%8F%98%E9%87%8F%E5%AF%B9%E4%BA%8E%E7%90%86%E8%A7%A3%E5%8C%BA%E5%9D%97%E9%93%BE%E9%9D%9E%E5%B8%B8%E4%B9%8B%E9%87%8D%E8%A6%81%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.1.1+CBlockIndex%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%9B%A0%E4%B8%BA%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9C%89%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E5%88%86%E5%8F%89%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BB%8E%E9%80%BB%E8%BE%91%E4%B8%8A%E8%AE%B2%E5%AE%83%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%98%AF%E4%B8%80%E9%A2%97%E6%A0%91%EF%BC%8C%E5%87%BA%E7%8E%B0%E5%88%86%E5%8F%89%E6%97%B6%EF%BC%8C%E6%AF%8F%E6%9D%A1%E5%88%86%E5%8F%89%E5%AF%B9%E5%BA%94%E6%A0%91%E7%9A%84%E4%B8%80%E6%9D%A1%E5%88%86%E6%94%AF%E3%80%82%E5%9C%A8%E5%86%85%E5%AD%98%E4%B8%AD%E5%8C%BA%E5%9D%97%E9%93%BE%E6%98%AF%E7%94%B1CBlockIndex%E7%9A%84%E5%90%91%E9%87%8F%E6%9D%A5%E8%A1%A8%E7%A4%BA%E7%9A%84%E3%80%82%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eclass+CBlockIndex%0A%7B%0Apublic%3A%0A++++%2F%2F%21+pointer+to+the+hash+of+the+block%2C+if+any.+Memory+is+owned+by+this+CBlockIndex%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%E6%8C%87%E5%90%91%E5%8C%BA%E5%9D%97hash%E5%80%BC%E7%9A%84%E6%8C%87%E9%92%88%0A++++const+uint256*+phashBlock%3B%0A%0A++++%2F%2F%21+pointer+to+the+index+of+the+predecessor+of+this+block%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%E6%8C%87%E5%90%91%E4%B8%8A%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E6%8C%87%E9%92%88%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%8C%BA%E5%9D%97%E9%93%BE%E5%8F%AF%E8%83%BD%E5%AD%98%E5%9C%A8%E5%88%86%E5%8F%89%E7%9A%84%E6%83%85%E5%86%B5%EF%BC%8C%E6%89%80%E4%BB%A5%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%8F%AF%E8%83%BD%E6%9C%89%E5%A4%9A%E4%B8%AA%E6%8C%87%E9%92%88%E6%8C%87%E5%90%91%E5%AE%83%0A++++CBlockIndex*+pprev%3B%0A%0A++++%2F%2F%21+pointer+to+the+index+of+some+further+predecessor+of+this+block%0A++++%2F%2F+%E6%8C%87%E5%90%91+%E6%AD%A4%E5%8C%BA%E5%9D%97%E6%9B%B4%E8%BF%9C%E7%9A%84%E7%A5%96%E5%85%88%E7%9A%84%E6%8C%87%E9%92%88%0A++++CBlockIndex*+pskip%3B%0A%0A++++%2F%2F%21+height+of+the+entry+in+the+chain.+The+genesis+block+has+height+0%0A++++%2F%2F%E8%AF%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%EF%BC%8C%E4%BB%8E%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%E5%BC%80%E5%A7%8B%E7%AE%97%E8%B5%B7%0A++++int+nHeight%3B%0A%0A++++%2F%2F%21+Which+%23+file+this+block+is+stored+in+%28blk%3F%3F%3F%3F%3F.dat%29%0A++++%2F%2F%E5%AD%98%E5%82%A8%E6%9C%AC%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E6%AF%94%E5%A6%82%E7%AC%AC100%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%85%B6%E5%8C%BA%E5%9D%97%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E5%9C%A8blk100.data%E4%B8%AD%0A++++int+nFile%3B%0A%0A++++%2F%2F%21+Byte+offset+within+blk%3F%3F%3F%3F%3F.dat+where+this+block%27s+data+is+stored%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E5%8F%96%E5%9C%A8blk%3F%3F%3F%3F.data%E4%B8%AD%E7%9A%84%E5%81%8F%E7%A7%BB%E9%87%8F%0A++++unsigned+int+nDataPos%3B%0A%0A++++%2F%2F%21+Byte+offset+within+rev%3F%3F%3F%3F%3F.dat+where+this+block%27s+undo+data+is+stored%0A++++unsigned+int+nUndoPos%3B%0A%0A++++%2F%2F%21+%28memory+only%29+Total+amount+of+work+%28expected+number+of+hashes%29+in+the+chain+up+to+and+including+this+block%0A++++%2F%2F%E4%BB%8E%E5%88%9B%E5%A7%8B%E5%8C%BA%E5%9D%97%E5%88%B0%E6%9C%AC%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%AF%E7%A7%AF%E5%B7%A5%E4%BD%9C%E9%87%8F%0A++++arith_uint256+nChainWork%3B%0A%0A++++%2F%2F%21+Number+of+transactions+in+this+block.%0A++++%2F%2F%21+Note%3A+in+a+potential+headers-first+mode%2C+this+number+cannot+be+relied+upon%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%0A++++unsigned+int+nTx%3B%0A%0A++++%2F%2F%21+%28memory+only%29+Number+of+transactions+in+the+chain+up+to+and+including+this+block.%0A++++%2F%2F%21+This+value+will+be+non-zero+only+if+and+only+if+transactions+for+this+block+and+all+its+parents+are+available.%0A++++%2F%2F%21+Change+to+64-bit+type+when+necessary%3B+won%27t+happen+before+2030%0A++++%2F%2F%E4%BB%8E%E5%88%9B%E5%A7%8B%E5%8C%BA%E5%9D%97%E5%88%B0%E6%9C%AC%E5%8C%BA%E5%9D%97%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%E7%9A%84%E6%95%B0%E9%87%8F%EF%BC%8C%E5%8F%AA%E6%9C%89%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97%E4%BB%A5%E5%8F%8A%E5%AE%83%E6%89%80%E6%9C%89%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E6%97%B6%E8%BF%99%E4%B8%AA%E5%80%BC%E6%89%8D%E4%BC%9A%E9%9D%9E0%0A++++unsigned+int+nChainTx%3B%0A%0A++++%2F%2F%21+Verification+status+of+this+block.+See+enum+BlockStatus%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%0A++++uint32_t+nStatus%3B%0A%0A++++%2F%2F%21+block+header%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E5%A4%B4%0A++++int32_t+nVersion%3B%09%2F%2F%E7%89%88%E6%9C%AC%0A++++uint256+hashMerkleRoot%3B++%2F%2Fmerkel%E6%A0%91%E7%9A%84%E6%A0%91%E6%A0%B9%0A++++uint32_t+nTime%3B+%2F%2F%E6%97%B6%E9%97%B4%E6%88%B3%0A++++%2F%2F%E8%BF%99%E4%B8%A4%E4%B8%AA%E5%8F%98%E9%87%8F%E7%94%A8%E4%BA%8E%E8%AE%A1%E7%AE%97PoW%0A++++uint32_t+nBits%3B+%2F%2F%E9%9A%BE%E5%BA%A6%E4%BD%8D%0A++++uint32_t+nNonce%3B%0A%0A++++%2F%2F%21+%28memory+only%29+Sequential+id+assigned+to+distinguish+order+in+which+blocks+are+received.%0A++++int32_t+nSequenceId%3B%0A%0A++++%2F%2F%21+%28memory+only%29+Maximum+nTime+in+the+chain+up+to+and+including+this+block.%0A++++unsigned+int+nTimeMax%3B%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%8A%E9%9D%A2%E7%BB%93%E6%9E%84%E4%B8%AD%E7%9A%84nStatus%E8%A1%A8%E7%A4%BA%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%8C%E5%8C%BA%E5%9D%97%E5%8F%AF%E8%83%BD%E7%9A%84%E7%8A%B6%E6%80%81%E5%AE%9A%E4%B9%89%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eenum+BlockStatus%3A+uint32_t+%7B%0A++++%2F%2F%21+Unused.%0A++++BLOCK_VALID_UNKNOWN++++++%3D++++0%2C%0A%0A++++%2F%2F%21+Parsed%2C+version+ok%2C+hash+satisfies+claimed+PoW%2C+1+%26lt%3B%3D+vtx+count+%26lt%3B%3D+max%2C+timestamp+not+in+future%0A++++BLOCK_VALID_HEADER+++++++%3D++++1%2C%0A%0A++++%2F%2F%21+All+parent+headers+found%2C+difficulty+matches%2C+timestamp+%26gt%3B%3D+median+previous%2C+checkpoint.+Implies+all+parents%0A++++%2F%2F%21+are+also+at+least+TREE.%0A++++BLOCK_VALID_TREE+++++++++%3D++++2%2C%0A%0A++++%2F**%0A+++++*+Only+first+tx+is+coinbase%2C+2+%26lt%3B%3D+coinbase+input+script+length+%26lt%3B%3D+100%2C+transactions+valid%2C+no+duplicate+txids%2C%0A+++++*+sigops%2C+size%2C+merkle+root.+Implies+all+parents+are+at+least+TREE+but+not+necessarily+TRANSACTIONS.+When+all%0A+++++*+parent+blocks+also+have+TRANSACTIONS%2C+CBlockIndex%3A%3AnChainTx+will+be+set.%0A+++++*%2F%0A++++BLOCK_VALID_TRANSACTIONS+%3D++++3%2C%0A%0A++++%2F%2F%21+Outputs+do+not+overspend+inputs%2C+no+double+spends%2C+coinbase+output+ok%2C+no+immature+coinbase+spends%2C+BIP30.%0A++++%2F%2F%21+Implies+all+parents+are+also+at+least+CHAIN.%0A++++BLOCK_VALID_CHAIN++++++++%3D++++4%2C%0A%0A++++%2F%2F%21+Scripts+%26amp%3B+signatures+ok.+Implies+all+parents+are+also+at+least+SCRIPTS.%0A++++BLOCK_VALID_SCRIPTS++++++%3D++++5%2C%0A%0A++++%2F%2F%21+All+validity+bits.%0A++++BLOCK_VALID_MASK+++++++++%3D+++BLOCK_VALID_HEADER+%7C+BLOCK_VALID_TREE+%7C+BLOCK_VALID_TRANSACTIONS+%7C%0A+++++++++++++++++++++++++++++++++BLOCK_VALID_CHAIN+%7C+BLOCK_VALID_SCRIPTS%2C%0A%0A++++BLOCK_HAVE_DATA++++++++++%3D++++8%2C+%2F%2F%21%26lt%3B+full+block+available+in+blk*.dat%0A++++BLOCK_HAVE_UNDO++++++++++%3D+++16%2C+%2F%2F%21%26lt%3B+undo+data+available+in+rev*.dat%0A++++BLOCK_HAVE_MASK++++++++++%3D+++BLOCK_HAVE_DATA+%7C+BLOCK_HAVE_UNDO%2C%0A%0A++++BLOCK_FAILED_VALID+++++++%3D+++32%2C+%2F%2F%21%26lt%3B+stage+after+last+reached+validness+failed%0A++++BLOCK_FAILED_CHILD+++++++%3D+++64%2C+%2F%2F%21%26lt%3B+descends+from+failed+block%0A++++BLOCK_FAILED_MASK++++++++%3D+++BLOCK_FAILED_VALID+%7C+BLOCK_FAILED_CHILD%2C%0A%0A++++BLOCK_OPT_WITNESS+++++++%3D+++128%2C+%2F%2F%21%26lt%3B+block+data+in+blk*.data+was+received+with+a+witness-enforcing+client%0A%7D%3B%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+BLOCK_VALID_HEADER%EF%BC%9A%E5%8C%BA%E5%9D%97%E5%A4%B4%E6%A0%A1%E9%AA%8COK%EF%BC%8C%E5%8C%BA%E5%9D%97hash%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E7%AC%A6%E5%90%88%E9%A2%84%E6%9C%9F%EF%BC%8C%E4%BA%A4%E6%98%93%E6%95%B0%E4%BB%A5%E5%8F%8A%E7%89%88%E6%9C%AC%E5%8F%B7%E7%AD%89%E9%83%BD%E6%AD%A3%E7%A1%AE%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+BLOCK_VALID_TREE%EF%BC%9A%E5%8C%BA%E5%9D%97%E6%89%80%E6%9C%89%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E5%A4%B4%E9%83%A8%E9%83%BD%E5%B7%B2%E7%BB%8F%E6%89%BE%E5%88%B0%E4%BA%86%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AFBLOCK_VALID_TREE%EF%BC%8C%E5%88%99%E5%85%B6%E6%89%80%E6%9C%89%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E8%87%B3%E5%B0%91%E4%B9%9F%E6%98%AFBLOCK_VALID_TREE%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+BLOCK_VALID_TRANSACTIONS%EF%BC%9A%E5%8C%BA%E5%9D%97%E6%9C%89%E6%9C%89%E6%95%88%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%8C%E5%8D%B3%E6%9C%89%E4%B8%94%E4%BB%85%E6%9C%89%E4%B8%80%E7%AC%94coinbase%E4%BA%A4%E6%98%93%EF%BC%8Ccoinbase%E4%BA%A4%E6%98%93%E6%98%AF%E5%8C%BA%E5%9D%97%E4%B8%AD%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E3%80%82%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AFBLOCK_VALID_TRANSCATIONS%EF%BC%8C%E9%82%A3%E4%B9%88%E5%AE%83%E7%9A%84%E6%89%80%E6%9C%89%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E8%87%B3%E5%B0%91%E6%98%AFBLOCK_VALID_TREE%28%E5%B7%B2%E7%BB%8F%E6%94%B6%E5%88%B0%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BD%86%E6%98%AF%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%83%BD%E5%B0%9A%E6%9C%AA%E6%94%B6%E5%88%B0%29%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+BLOCK_VALID_CHAIN%EF%BC%9A%E4%BA%A4%E6%98%93%E7%9A%84%E8%BE%93%E5%87%BA%E6%B2%A1%E9%97%AE%E9%A2%98%EF%BC%8C%E6%B2%A1%E6%9C%89%E5%8F%8C%E8%8A%B1%E7%AD%89%E9%97%AE%E9%A2%98%E3%80%82%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AFBLOCK_VALID_CHAIN%EF%BC%8C%E5%88%99%E5%AE%83%E6%89%80%E6%9C%89%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E8%87%B3%E5%B0%91%E4%B9%9F%E6%98%AFBLOCK_VALID_CHAIN%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+BLOCK_VALID_SCRIPTS%EF%BC%9A%E4%BA%A4%E6%98%93%E8%84%9A%E6%9C%AC%E5%92%8C%E7%AD%BE%E5%90%8D%E6%B2%A1%E9%97%AE%E9%A2%98%E3%80%82%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%98%AFBLOCK_VALID_SCRIPTS%EF%BC%8C%E5%AE%83%E6%89%80%E6%9C%89%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E8%87%B3%E5%B0%91%E4%B9%9F%E6%98%AFBLOCK_VALID_SCRIPTS%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.1.2+%E6%9C%80%E9%95%BF%E9%93%BEchainActive%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E4%B8%AA%E5%B0%B1%E6%98%AF%E6%89%80%E8%B0%93%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E4%BA%86%EF%BC%8CchainActive%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BB%A3%E8%A1%A8%E7%9A%84%E6%98%AF%E5%BD%93%E5%89%8D%E6%9C%89%E6%9C%80%E5%A4%A7%E7%B4%AF%E8%AE%A1%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%88%86%E6%94%AF%E3%80%82%E8%BF%99%E4%B8%AA%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%9C%A8%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%E4%BB%8ElevelDB%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%8A%A0%E8%BD%BD%EF%BC%8C%E5%90%8E%E7%BB%AD%E5%9C%A8%E4%BB%8B%E7%BB%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%8A%A0%E8%BD%BD%E5%92%8C%E5%90%8C%E6%AD%A5%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E8%AF%A6%E7%BB%86%E8%AF%B4%E6%98%8E%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+chainActive%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%A6%82%E4%B8%8B%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F**+An+in-memory+indexed+chain+of+blocks.+*%2F%0Aclass+CChain+%7B%0Aprivate%3A%0A++++std%3A%3Avector%26lt%3BCBlockIndex*%26gt%3B+vChain%3B%0A%0Apublic%3A%0A++++%2F**+Returns+the+index+entry+for+the+genesis+block+of+this+chain%2C+or+nullptr+if+none.+*%2F%0A++++CBlockIndex+*Genesis%28%29+const+%7B%0A++++++++return+vChain.size%28%29+%26gt%3B+0+%3F+vChain%5B0%5D+%3A+nullptr%3B%0A++++%7D%0A%0A++++%2F**+Returns+the+index+entry+for+the+tip+of+this+chain%2C+or+nullptr+if+none.+*%2F%0A++++CBlockIndex+*Tip%28%29+const+%7B%0A++++++++return+vChain.size%28%29+%26gt%3B+0+%3F+vChain%5BvChain.size%28%29+-+1%5D+%3A+nullptr%3B%0A++++%7D%0A%0A++++%2F**+Returns+the+index+entry+at+a+particular+height+in+this+chain%2C+or+nullptr+if+no+such+height+exists.+*%2F%0A++++CBlockIndex+*operator%5B%5D%28int+nHeight%29+const+%7B%0A++++++++if+%28nHeight+%26lt%3B+0+%7C%7C+nHeight+%26gt%3B%3D+%28int%29vChain.size%28%29%29%0A++++++++++++return+nullptr%3B%0A++++++++return+vChain%5BnHeight%5D%3B%0A++++%7D%0A%0A++++%2F**+Compare+two+chains+efficiently.+*%2F%0A++++friend+bool+operator%3D%3D%28const+CChain+%26amp%3Ba%2C+const+CChain+%26amp%3Bb%29+%7B%0A++++++++return+a.vChain.size%28%29+%3D%3D+b.vChain.size%28%29+%26amp%3B%26amp%3B%0A+++++++++++++++a.vChain%5Ba.vChain.size%28%29+-+1%5D+%3D%3D+b.vChain%5Bb.vChain.size%28%29+-+1%5D%3B%0A++++%7D%0A%0A++++%2F**+Efficiently+check+whether+a+block+is+present+in+this+chain.+*%2F%0A++++bool+Contains%28const+CBlockIndex+*pindex%29+const+%7B%0A++++++++return+%28*this%29%5Bpindex-%26gt%3BnHeight%5D+%3D%3D+pindex%3B%0A++++%7D%0A%0A++++%2F**+Find+the+successor+of+a+block+in+this+chain%2C+or+nullptr+if+the+given+index+is+not+found+or+is+the+tip.+*%2F%0A++++CBlockIndex+*Next%28const+CBlockIndex+*pindex%29+const+%7B%0A++++++++if+%28Contains%28pindex%29%29%0A++++++++++++return+%28*this%29%5Bpindex-%26gt%3BnHeight+%2B+1%5D%3B%0A++++++++else%0A++++++++++++return+nullptr%3B%0A++++%7D%0A%0A++++%2F**+Return+the+maximal+height+in+the+chain.+Is+equal+to+chain.Tip%28%29+%3F+chain.Tip%28%29-%26gt%3BnHeight+%3A+-1.+*%2F%0A++++int+Height%28%29+const+%7B%0A++++++++return+vChain.size%28%29+-+1%3B%0A++++%7D%0A%0A++++%2F**+Set%2Finitialize+a+chain+with+a+given+tip.+*%2F%0A++++void+SetTip%28CBlockIndex+*pindex%29%3B%0A%0A++++%2F**+Return+a+CBlockLocator+that+refers+to+a+block+in+this+chain+%28by+default+the+tip%29.+*%2F%0A++++CBlockLocator+GetLocator%28const+CBlockIndex+*pindex+%3D+nullptr%29+const%3B%0A%0A++++%2F**+Find+the+last+common+block+between+this+chain+and+a+block+index+entry.+*%2F%0A++++const+CBlockIndex+*FindFork%28const+CBlockIndex+*pindex%29+const%3B%0A%0A++++%2F**+Find+the+earliest+block+with+timestamp+equal+or+greater+than+the+given.+*%2F%0A++++CBlockIndex*+FindEarliestAtLeast%28int64_t+nTime%29+const%3B%0A%7D%3B%0A%0A%23endif+%2F%2F+BITCOIN_CHAIN_H%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8CCChain%E5%85%B6%E5%AE%9E%E6%98%AF%E5%B0%86%E4%B8%80%E8%8A%82%E4%BB%8B%E7%BB%8D%E7%9A%84CBlockIndex%E5%B0%81%E8%A3%85%E5%9C%A8%E4%BA%86%E4%B8%80%E4%B8%AA%E5%90%91%E9%87%8F%E5%BD%93%E4%B8%AD%EF%BC%8C%E5%90%91%E9%87%8F%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%9D%97%E6%8C%89%E9%AB%98%E5%BA%A6%E6%8E%92%E5%BA%8F%EF%BC%88%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%E5%85%83%E7%B4%A0%E7%9A%84%E7%B4%A2%E5%BC%95%E5%B0%B1%E6%98%AF%E5%AF%B9%E5%BA%94%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%EF%BC%89%EF%BC%8C%E9%87%8D%E5%86%99%E4%BA%86%5B%5D%E8%BF%90%E7%AE%97%E7%AC%A6%EF%BC%8C%E6%96%B9%E4%BE%BF%E6%A3%80%E7%B4%A2%E5%88%B0%E4%BB%BB%E6%84%8F%E9%AB%98%E5%BA%A6%E7%9A%84%E5%8C%BA%E5%9D%97%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.1.3+CBlock%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%BB%A3%E8%A1%A8%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E7%BB%A7%E6%89%BF%E8%87%AACBlockHeader%EF%BC%8CCBlockHeader%E5%8C%85%E5%90%AB%E5%8C%BA%E5%9D%97%E5%A4%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E3%80%82%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eclass+CBlock+%3A+public+CBlockHeader%0A%7B%0Apublic%3A%0A++++%2F%2F+network+and+disk%0A++++std%3A%3Avector%26lt%3BCTransactionRef%26gt%3B+vtx%3B%0A%0A++++%2F%2F+memory+only%0A++++mutable+bool+fChecked%3B%0A%0A++++CBlock%28%29%0A++++%7B%0A++++++++SetNull%28%29%3B%0A++++%7D%0A%0A++++CBlock%28const+CBlockHeader+%26amp%3Bheader%29%0A++++%7B%0A++++++++SetNull%28%29%3B%0A++++++++*%28static_cast%26lt%3BCBlockHeader*%26gt%3B%28this%29%29+%3D+header%3B%0A++++%7D%0A%0A++++ADD_SERIALIZE_METHODS%3B%0A%0A++++template+%26lt%3Btypename+Stream%2C+typename+Operation%26gt%3B%0A++++inline+void+SerializationOp%28Stream%26amp%3B+s%2C+Operation+ser_action%29+%7B%0A++++++++READWRITEAS%28CBlockHeader%2C+*this%29%3B%0A++++++++READWRITE%28vtx%29%3B%0A++++%7D%0A%0A++++void+SetNull%28%29%0A++++%7B%0A++++++++CBlockHeader%3A%3ASetNull%28%29%3B%0A++++++++vtx.clear%28%29%3B%0A++++++++fChecked+%3D+false%3B%0A++++%7D%0A%0A++++CBlockHeader+GetBlockHeader%28%29+const%0A++++%7B%0A++++++++CBlockHeader+block%3B%0A++++++++block.nVersion+++++++%3D+nVersion%3B%0A++++++++block.hashPrevBlock++%3D+hashPrevBlock%3B%0A++++++++block.hashMerkleRoot+%3D+hashMerkleRoot%3B%0A++++++++block.nTime++++++++++%3D+nTime%3B%0A++++++++block.nBits++++++++++%3D+nBits%3B%0A++++++++block.nNonce+++++++++%3D+nNonce%3B%0A++++++++return+block%3B%0A++++%7D%0A%0A++++std%3A%3Astring+ToString%28%29+const%3B%0A%7D%3B%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%BB%93%E5%90%88%E4%BB%A3%E7%A0%81%E5%AF%B9%E6%AF%94%E4%B9%8B%E5%89%8D%E4%BB%8B%E7%BB%8D%E7%9A%84CBlockIndex%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E4%BA%8C%E8%80%85%E4%B8%BB%E8%A6%81%E7%9A%84%E5%BC%82%E5%90%8C%E5%9C%A8%E4%BA%8E%EF%BC%9ACBlock%E6%98%AF%E7%BA%AF%E6%95%B0%E6%8D%AE%EF%BC%88%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E5%92%8C%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%89%EF%BC%8C%E8%80%8CCBlockIndex%E5%88%99%E5%8C%85%E5%90%AB%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9B%B8%E5%85%B3%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%88%E4%BE%8B%E5%A6%82%E6%8C%87%E5%90%91%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E6%8C%87%E9%92%88%EF%BC%8C%E5%9C%A8%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E7%9A%84%E9%AB%98%E5%BA%A6%E7%AD%89%E7%AD%89%EF%BC%89%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.1.4+mapBlockIndex%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BB%A5%E5%8C%BA%E5%9D%97%E7%9A%84hash%E4%B8%BA%E9%94%AE%EF%BC%8C%E4%BB%A5%E5%AF%B9%E5%BA%94%E5%8C%BA%E5%9D%97%E7%9A%84CBlockIndex%E4%B8%BA%E5%80%BC%E7%9A%84%E4%B8%80%E4%B8%AA%E6%98%A0%E5%B0%84%E8%A1%A8%E3%80%82%E5%8C%85%E5%90%AB%E4%BA%86%E6%89%80%E6%9C%89%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%88%E5%BD%93%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9C%89%E5%88%86%E5%8F%89%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B8%8D%E5%85%89%E6%98%AF%E6%9C%80%E9%95%BF%E9%93%BE%EF%BC%8C%E6%89%80%E6%9C%89%E5%88%86%E5%8F%89%E4%B8%8A%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BF%A1%E6%81%AF%E4%B9%9F%E9%83%BD%E4%BC%9A%E5%9C%A8%E8%BF%99%E4%B8%AA%E6%98%A0%E5%B0%84%E8%A1%A8%E5%BD%93%E4%B8%AD%EF%BC%89%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E4%B8%AA%E6%98%A0%E5%B0%84%E8%A1%A8%E6%98%AF%E5%9C%A8%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%E4%BB%8ElevelDB%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%8A%A0%E8%BD%BD%E5%88%B0%E5%86%85%E5%AD%98%EF%BC%8C%E4%B9%8B%E5%90%8E%E5%8F%AA%E8%A6%81%E4%BB%8E%E7%BD%91%E7%BB%9C%E4%B8%8A%E6%94%B6%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%BF%AB%EF%BC%8C%E5%B0%B1%E4%BC%9A%E6%B7%BB%E5%8A%A0%E4%B8%80%E9%A1%B9%E5%88%B0%E8%BF%99%E4%B8%AA%E8%A1%A8%E4%B8%AD%EF%BC%8C%E5%9B%A0%E6%AD%A4%E8%BF%99%E4%B8%AA%E8%A1%A8%E5%8F%AA%E4%BC%9A%E4%B8%8D%E6%96%AD%E5%A2%9E%E5%A4%A7%EF%BC%8C%E4%B8%8D%E4%BC%9A%E5%8F%98%E5%B0%8F%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch3%3E2.1.5+mapBlocksUnlinked%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E4%B8%AA%E6%98%A0%E5%B0%84%E8%A1%A8%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E5%9C%A8%E6%94%B6%E5%88%B0%E4%B8%80%E4%B8%AA%E4%B8%A2%E5%A4%B1%E7%9A%84%E4%B8%AD%E9%97%B4%E5%8C%BA%E5%9D%97%E6%97%B6%EF%BC%8C%E8%83%BD%E5%BF%AB%E9%80%9F%E7%9A%84%E5%B0%86%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8E%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E9%9D%A2%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%85%B6%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BBA-%26gt%3BB%E8%A1%A8%E7%A4%BA%E5%8C%BA%E5%9D%97A%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E8%BF%98%E6%B2%A1%E6%94%B6%E5%88%B0%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8C%BA%E5%9D%97B%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B7%B2%E7%BB%8F%E6%94%B6%E5%88%B0%E4%BA%86%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%BE%8B1%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E5%81%87%E8%AE%BE%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%88%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%89%E4%B8%BAA%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E4%B9%8B%E5%90%8E%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%E5%92%8CC%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%283%29+%E5%8F%88%E8%BF%87%E4%BA%86%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97C%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%BF%99%E6%97%B6%E5%80%99mapBlocksUnlinked%E4%B8%AD%E5%B0%B1%E4%BC%9A%E6%96%B0%E5%8A%A0%E4%B8%80%E9%A1%B9%EF%BC%9AB-%26gt%3BC%EF%BC%9B%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%284%29+%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8EB%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%E4%B9%9F%E6%94%B6%E5%88%B0%E4%BA%86%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%B0%86B-%26gt%3BC%E4%BB%8E%E8%A1%A8%E4%B8%AD%E5%88%A0%E9%99%A4%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8C%BA%E5%9D%97B%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E6%88%90%E4%B8%BA%E6%96%B0%E9%A1%B6%E7%82%B9%E4%BA%86%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%BE%8B2%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E8%AE%BEA%E4%B8%BA%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%2CC%2CD%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%283%29+%E7%B4%A7%E6%8E%A5%E7%9D%80%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97D%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%284%29+%E6%AD%A4%E6%97%B6%E8%A1%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0B-%26gt%3BC%EF%BC%8CB-%26gt%3BD%EF%BC%8CC-%26gt%3BD%E7%9A%84%E8%A1%A8%E9%A1%B9%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%285%29+%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%B0%86B-%26gt%3BC%EF%BC%8CB-%26gt%3BD%E5%88%A0%E9%99%A4%EF%BC%8C%E5%B0%86B%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E6%88%90%E4%B8%BA%E6%96%B0%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8C%E8%A1%A8%E4%B8%AD%E5%8F%AA%E5%89%A9C-%26gt%3BD%E7%9A%84%E8%A1%A8%E9%A1%B9%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch3%3E2.1.6+setBlockIndexCandidates%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E9%9B%86%E5%90%88%EF%BC%8C%E9%9B%86%E5%90%88%E4%B8%AD%E5%8C%85%E5%90%AB%E4%BA%86%E6%89%80%E6%9C%89%E6%AF%94%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BD%93%E5%89%8D%E9%A1%B6%E7%82%B9%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9B%B4%E5%A4%9A%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%E9%9B%86%E5%90%88%EF%BC%8C%E6%AD%A4%E9%9B%86%E5%90%88%E4%B8%AD%E5%8C%85%E5%90%AB%E7%9A%84%E5%8C%BA%E5%9D%97%E5%B0%B1%E6%98%AF%E5%BB%B6%E9%95%BF%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E3%80%82%E4%B9%8B%E6%89%80%E4%BB%A5%E8%AF%B4%E8%BF%99%E4%BA%9B%E5%8C%BA%E5%9D%97%E6%97%B6%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%98%AF%E5%9B%A0%E4%B8%BA%E5%8F%AA%E6%98%AF%E5%9C%A8%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97%E5%A4%B4%E4%BB%A5%E5%90%8E%E5%AF%B9%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E5%81%9A%E4%BA%86%E6%A0%A1%E9%AA%8C%EF%BC%8C%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E8%83%BD%E7%94%A8%E6%9D%A5%E5%BB%B6%E9%95%BF%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E9%9C%80%E8%A6%81%E7%AD%89%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%E4%BB%A5%E5%90%8E%E6%89%8D%E8%83%BD%E7%A1%AE%E5%AE%9A%E3%80%82%E5%81%87%E5%A6%82%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E6%98%AF100%EF%BC%8C%E8%80%8C%E6%88%91%E4%BB%AC%E6%94%B6%E5%88%B0%E4%BA%86103%E5%8F%B7%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%98%E5%BE%97%E7%AD%89%E5%BE%85%E5%B9%B6%E4%B8%94%E6%A0%A1%E9%AA%8C%E4%B8%AD%E9%97%B4%E4%B8%A2%E5%A4%B1%E7%9A%84101%E5%92%8C102%E5%8F%B7%E5%8C%BA%E5%9D%97%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%BE%8B%E5%AD%90%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E8%AE%BE%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E6%98%AFA%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BE%9D%E6%AC%A1%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%EF%BC%8CC%EF%BC%8CD%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+A%26nbsp%3B+--%26nbsp%3B+B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%5C%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+%26nbsp%3B+%26nbsp%3BC+----+D%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+B%2CC%2CD%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%E6%A0%A1%E9%AA%8C%E6%B2%A1%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%8C%E6%AD%A4%E6%97%B6setBlockIndexCandidates%E4%B8%AD%E5%B0%86%E5%8C%85%E5%90%ABB%2CC%2CD%E4%B8%89%E4%B8%AA%E5%85%83%E7%B4%A0%EF%BC%8C%E5%81%87%E8%AE%BE%E5%8C%BA%E5%9D%97B%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%A4%A7%E4%BA%8E%E5%8C%BA%E5%9D%97C%E4%BD%86%E6%98%AF%E5%B0%8F%E4%BA%8E%E5%8C%BA%E5%9D%97D%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E8%AE%BE%E6%88%91%E4%BB%AC%E4%B9%8B%E5%90%8E%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%B0%86B%E5%81%9A%E4%B8%BA%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E6%96%B0%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%B0%86B%E4%BB%8E%E9%9B%86%E5%90%88%E4%B8%AD%E5%88%A0%E9%99%A4%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B9%9F%E8%A6%81%E5%B0%86C%E7%A7%BB%E9%99%A4%EF%BC%8C%E5%9B%A0%E4%B8%BAC%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%B0%8F%E4%BA%8EB%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%8E%A5%E7%9D%80%E5%8F%88%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97C%E5%92%8C%E5%8C%BA%E5%9D%97D%E7%9A%84%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8C%BA%E5%9D%97D%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8C%85%E5%90%AB%E9%9D%9E%E6%B3%95%E4%BA%A4%E6%98%93%EF%BC%8C%E5%88%99%E5%8C%BA%E5%9D%97C%E4%BE%9D%E7%84%B6%E4%BF%9D%E7%95%99%E5%9C%A8%E4%B8%8A%E6%96%87%E4%BB%8B%E7%BB%8D%E7%9A%84mapBlocksIndex%E6%98%A0%E5%B0%84%E8%A1%A8%E4%B8%AD%E5%B9%B6%E4%BF%9D%E5%AD%98%E5%9C%A8%E7%A3%81%E7%9B%98%E4%B8%8A%EF%BC%8C%E8%80%8CD%E4%BB%8EmapBlocksIndex%E4%B8%AD%E7%A7%BB%E9%99%A4%EF%BC%8C%E7%A3%81%E7%9B%98%E4%B8%8A%E4%B9%9F%E4%B8%8D%E4%BF%9D%E5%AD%98%EF%BC%8C%E5%90%8C%E6%97%B6D%E4%B9%9F%E9%9C%80%E8%A6%81%E4%BB%8EsetBlockIndexCandidates%E4%B8%AD%E5%88%A0%E9%99%A4%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch3%3E2.1.7+pindexBestHeader%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%EF%BC%8C%E6%8C%87%E5%90%91%E5%BD%93%E5%89%8D%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%E3%80%82%E5%9C%A8%E8%8A%82%E7%82%B9%E5%90%AF%E5%8A%A8%E4%BB%8Edb%E5%8A%A0%E8%BD%BD%E5%8C%BA%E5%9D%97%E9%93%BE%E6%97%B6%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E6%AF%8F%E5%BD%93%E6%94%B6%E5%88%B0%E4%B8%80%E4%B8%AA%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9B%B4%E5%A4%A7%E7%9A%84%E5%8C%BA%E5%9D%97%E6%97%B6%E6%9B%B4%E6%96%B0%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%B3%A8%E6%84%8F%E8%BF%99%E4%B8%AA%E5%8F%98%E9%87%8F%E5%92%8CchainActive%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E7%9A%84tip%28%29%E6%96%B9%E6%B3%95%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3BchainActive.tip%E8%BF%94%E5%9B%9E%E7%9A%84%E6%98%AF%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%A1%B6%E7%82%B9%E6%98%AF%E5%9C%A8%E6%94%B6%E5%88%B0%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%E5%B9%B6%E4%B8%94%E6%A0%A1%E9%AA%8C%E6%97%A0%E8%AF%AF%E5%90%8E%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E7%9A%84%EF%BC%8C%E8%80%8CpindexBestHeader%E6%8C%87%E5%90%91%E7%9A%84%E6%98%AF%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E7%9A%84%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%AF%A5%E5%8C%BA%E5%9D%97%E5%8F%AF%E8%83%BD%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8F%AA%E6%9C%89%E5%8C%BA%E5%9D%97%E5%A4%B4%E7%9A%84%E4%B8%8D%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%AF%94%E5%A6%82%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%88chainActive.tip%28%29%EF%BC%89%E6%98%AF100%EF%BC%8C%E7%84%B6%E5%90%8E%E8%8A%82%E7%82%B9%E5%8F%AF%E8%83%BD%E6%94%B6%E5%88%B0%E4%BA%86103%E5%8F%B7%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%88%99pindexBestHeader%E6%8C%87%E5%90%91%E7%9A%84%E5%B0%B1%E6%98%AF103%E5%A5%BD%E5%8C%BA%E5%9D%97%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch2%3E2.2+%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%3C%2Fh2%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%8A%E4%B8%80%E8%8A%82%E4%BB%8B%E7%BB%8D%E4%BA%86%E5%92%8C%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9B%B8%E5%85%B3%E7%9A%84%E4%B8%80%E4%BA%9B%E9%87%8D%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%8F%98%E9%87%8F%EF%BC%8C%E8%BF%99%E4%BA%9B%E5%9C%A8%E5%90%8E%E7%BB%AD%E7%9A%84%E5%AD%A6%E4%B9%A0%E4%B8%AD%E9%83%BD%E9%9C%80%E8%A6%81%E7%94%A8%E5%88%B0%EF%BC%8C%E5%9B%A0%E6%AD%A4%E8%AF%B7%E5%85%88%E8%AE%B0%E4%BD%8F%E4%BB%96%E4%BB%AC%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%8E%A5%E4%B8%8B%E6%9D%A5%E6%AD%A3%E5%BC%8F%E8%B8%8F%E4%B8%8A%E6%8C%96%E7%9F%BF%E4%B9%8B%E6%97%85%EF%BC%8C%E9%A6%96%E5%85%88%E4%BB%8E%E6%9E%84%E9%80%A0%E5%8C%BA%E5%9D%97%E5%BC%80%E5%A7%8B%E3%80%82%E5%BD%93%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E9%80%9A%E7%9F%A5%E5%90%8E%EF%BC%8C%E6%84%8F%E5%91%B3%E7%9D%80%E8%8A%82%E7%82%B9%E5%9C%A8%E8%BF%99%E4%B8%80%E8%BD%AE%E7%9A%84%E6%8C%96%E7%9F%BF%E7%AB%9E%E4%BA%89%E4%B8%AD%E5%A4%B1%E8%B4%A5%E4%BA%86%E3%80%82%E6%AD%A4%E6%97%B6%E8%8A%82%E7%82%B9%E5%AF%B9%E6%94%B6%E5%88%B0%E7%9A%84%E6%96%B0%E5%8C%BA%E5%9D%97%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%EF%BC%8C%E5%8C%85%E6%8B%AC%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%98%AF%E5%90%A6%E6%BB%A1%E8%B6%B3%EF%BC%8C%E6%98%AF%E5%90%A6%E6%9C%89%E9%9D%9E%E6%B3%95%E4%BA%A4%E6%98%93%E7%AD%89%E7%AD%89%EF%BC%8C%E9%AA%8C%E8%AF%81%E6%97%A0%E8%AF%AF%E5%90%8E%E8%8A%82%E7%82%B9%E5%B0%86%E5%8C%BA%E5%9D%97%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%B9%B6%E7%AB%8B%E5%88%BB%E5%BC%80%E5%A7%8B%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%BC%80%E5%A7%8B%E6%96%B0%E4%B8%80%E8%BD%AE%E7%9A%84%E6%8C%96%E7%9F%BF%E7%AB%9E%E8%B5%9B%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87bitcoin-cli+generatetoaddress%E5%91%BD%E4%BB%A4%E6%8C%96%E5%8F%96%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%88%91%E4%BB%AC%E7%9C%8B%E7%9C%8B%E8%BF%99%E4%B8%AA%E5%91%BD%E4%BB%A4%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%9A%84%E3%80%82%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Estatic+UniValue+generatetoaddress%28const+JSONRPCRequest%26amp%3B+request%29%0A%7B%0A++++if+%28request.fHelp+%7C%7C+request.params.size%28%29+%26lt%3B+2+%7C%7C+request.params.size%28%29+%26gt%3B+3%29%0A++++++++throw+std%3A%3Aruntime_error%28%0A++++++++++++%22generatetoaddress+nblocks+address+%28maxtries%29%5Cn%22%0A++++++++++++%22%5CnMine+blocks+immediately+to+a+specified+address+%28before+the+RPC+call+returns%29%5Cn%22%0A++++++++++++%22%5CnArguments%3A%5Cn%22%0A++++++++++++%221.+nblocks++++++%28numeric%2C+required%29+How+many+blocks+are+generated+immediately.%5Cn%22%0A++++++++++++%222.+address++++++%28string%2C+required%29+The+address+to+send+the+newly+generated+bitcoin+to.%5Cn%22%0A++++++++++++%223.+maxtries+++++%28numeric%2C+optional%29+How+many+iterations+to+try+%28default+%3D+1000000%29.%5Cn%22%0A++++++++++++%22%5CnResult%3A%5Cn%22%0A++++++++++++%22%5B+blockhashes+%5D+++++%28array%29+hashes+of+blocks+generated%5Cn%22%0A++++++++++++%22%5CnExamples%3A%5Cn%22%0A++++++++++++%22%5CnGenerate+11+blocks+to+myaddress%5Cn%22%0A++++++++++++%2B+HelpExampleCli%28%22generatetoaddress%22%2C+%2211+%5C%22myaddress%5C%22%22%29%0A++++++++%29%3B%0A%0A++++int+nGenerate+%3D+request.params%5B0%5D.get_int%28%29%3B%0A++++uint64_t+nMaxTries+%3D+1000000%3B%0A++++if+%28%21request.params%5B2%5D.isNull%28%29%29+%7B%0A++++++++nMaxTries+%3D+request.params%5B2%5D.get_int%28%29%3B%0A++++%7D%0A%0A++++CTxDestination+destination+%3D+DecodeDestination%28request.params%5B1%5D.get_str%28%29%29%3B%0A++++if+%28%21IsValidDestination%28destination%29%29+%7B%0A++++++++throw+JSONRPCError%28RPC_INVALID_ADDRESS_OR_KEY%2C+%22Error%3A+Invalid+address%22%29%3B%0A++++%7D%0A%0A++++std%3A%3Ashared_ptr%26lt%3BCReserveScript%26gt%3B+coinbaseScript+%3D+std%3A%3Amake_shared%26lt%3BCReserveScript%26gt%3B%28%29%3B%0A++++coinbaseScript-%26gt%3BreserveScript+%3D+GetScriptForDestination%28destination%29%3B%0A%0A++++return+generateBlocks%28coinbaseScript%2C+nGenerate%2C+nMaxTries%2C+false%29%3B+%2F%2F%E8%BF%99%E9%87%8C%E5%BC%80%E5%A7%8B%E7%94%9F%E6%88%90%E6%96%B0%E5%8C%BA%E5%9D%97%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%BB%A3%E7%A0%81%E7%9A%84%E6%9C%80%E5%90%8E%EF%BC%8C%E9%80%9A%E8%BF%87generateBlocks%E6%9D%A5%E7%94%9F%E6%88%90%E6%96%B0%E5%8C%BA%E5%9D%97%E3%80%82%E7%BB%A7%E7%BB%AD%E8%B7%9F%E8%BF%9B%E5%8E%BB%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3EUniValue+generateBlocks%28std%3A%3Ashared_ptr%26lt%3BCReserveScript%26gt%3B+coinbaseScript%2C+int+nGenerate%2C+uint64_t+nMaxTries%2C+bool+keepScript%29%0A%7B%0A++++static+const+int+nInnerLoopCount+%3D+0x10000%3B%0A++++int+nHeightEnd+%3D+0%3B%0A++++int+nHeight+%3D+0%3B%0A%0A++++%7B+++%2F%2F+Don%27t+keep+cs_main+locked%0A++++++++LOCK%28cs_main%29%3B%0A++++++++%2F%2F%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%AB%98%E5%BA%A6%0A++++++++nHeight+%3D+chainActive.Height%28%29%3B%0A++++++++%2F%2F%E6%8C%96%E7%9F%BF%E5%90%8E%E7%9A%84%E7%9B%AE%E6%A0%87%E9%AB%98%E5%BA%A6%EF%BC%8C%E4%BE%8B%E5%A6%82%E5%BD%93%E5%89%8D%E9%AB%98%E5%BA%A6100%EF%BC%8C%E6%80%BB%E5%85%B1%E6%8C%963%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%88%99%E7%9B%AE%E6%A0%87%E9%AB%98%E5%BA%A6%E5%B0%B1%E6%98%AF103%0A++++++++nHeightEnd+%3D+nHeight%2BnGenerate%3B%0A++++%7D%0A++++unsigned+int+nExtraNonce+%3D+0%3B%0A++++UniValue+blockHashes%28UniValue%3A%3AVARR%29%3B%0A++++%2F%2F%E5%BC%80%E5%A7%8B%E6%8C%96%E7%9F%BF%0A++++while+%28nHeight+%26lt%3B+nHeightEnd+%26amp%3B%26amp%3B+%21ShutdownRequested%28%29%29%0A++++%7B%0A++++++++%2F%2F%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%0A++++++++std%3A%3Aunique_ptr%26lt%3BCBlockTemplate%26gt%3B+pblocktemplate%28BlockAssembler%28Params%28%29%29.CreateNewBlock%28coinbaseScript-%26gt%3BreserveScript%29%29%3B%0A++++++++if+%28%21pblocktemplate.get%28%29%29%0A++++++++++++throw+JSONRPCError%28RPC_INTERNAL_ERROR%2C+%22Couldn%27t+create+new+block%22%29%3B%0A++++++++CBlock+*pblock+%3D+%26amp%3Bpblocktemplate-%26gt%3Bblock%3B%0A++++++++%7B%0A++++++++++++LOCK%28cs_main%29%3B%0A++++++++++++IncrementExtraNonce%28pblock%2C+chainActive.Tip%28%29%2C+nExtraNonce%29%3B%0A++++++++%7D%0A++++++++%2F%2F%E8%AE%A1%E7%AE%97PoW%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%EF%BC%8C%E6%8B%BC%E7%AE%97%E5%8A%9B%E7%9A%84%E5%9C%B0%E6%96%B9%E5%B0%B1%E5%9C%A8%E8%BF%99%E9%87%8C%0A++++++++while+%28nMaxTries+%26gt%3B+0+%26amp%3B%26amp%3B+pblock-%26gt%3BnNonce+%26lt%3B+nInnerLoopCount+%26amp%3B%26amp%3B+%21CheckProofOfWork%28pblock-%26gt%3BGetHash%28%29%2C+pblock-%26gt%3BnBits%2C+Params%28%29.GetConsensus%28%29%29%29+%7B%0A++++++++++++%2B%2Bpblock-%26gt%3BnNonce%3B%0A++++++++++++--nMaxTries%3B%0A++++++++%7D%0A++++++++if+%28nMaxTries+%3D%3D+0%29+%7B%0A++++++++++++break%3B%0A++++++++%7D%0A++++++++%2F%2F%E8%B6%85%E8%BF%87%E5%8D%95%E8%BD%AE%E5%BE%AA%E7%8E%AF%E7%9A%84%E4%B8%8A%E9%99%90%2865536%E6%AC%A1%29%EF%BC%8C%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B%0A++++++++if+%28pblock-%26gt%3BnNonce+%3D%3D+nInnerLoopCount%29+%7B%0A++++++++++++continue%3B%0A++++++++%7D%0A++++++++%0A++++++++%2F%2F%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%9D%97%0A++++++++std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B+shared_pblock+%3D+std%3A%3Amake_shared%26lt%3Bconst+CBlock%26gt%3B%28*pblock%29%3B%0A++++++++if+%28%21ProcessNewBlock%28Params%28%29%2C+shared_pblock%2C+true%2C+nullptr%29%29%0A++++++++++++throw+JSONRPCError%28RPC_INTERNAL_ERROR%2C+%22ProcessNewBlock%2C+block+not+accepted%22%29%3B%0A++++++++%2B%2BnHeight%3B%0A++++++++blockHashes.push_back%28pblock-%26gt%3BGetHash%28%29.GetHex%28%29%29%3B%0A%0A++++++++%2F%2Fmark+script+as+important+because+it+was+used+at+least+for+one+coinbase+output+if+the+script+came+from+the+wallet%0A++++++++if+%28keepScript%29%0A++++++++%7B%0A++++++++++++coinbaseScript-%26gt%3BKeepScript%28%29%3B%0A++++++++%7D%0A++++%7D%0A++++return+blockHashes%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%85%B6%E4%B8%AD%E6%9E%84%E9%80%A0%E6%96%B0%E5%8C%BA%E5%9D%97%E6%98%AF%E9%80%9A%E8%BF%87BlockAssembler.CreateNewBlock%E6%9D%A5%E5%81%9A%E7%9A%84%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Estd%3A%3Aunique_ptr%26lt%3BCBlockTemplate%26gt%3B+BlockAssembler%3A%3ACreateNewBlock%28const+CScript%26amp%3B+scriptPubKeyIn%2C+bool+fMineWitnessTx%29%0A%7B%0A++++int64_t+nTimeStart+%3D+GetTimeMicros%28%29%3B%0A%0A++++resetBlock%28%29%3B%0A%0A++++pblocktemplate.reset%28new+CBlockTemplate%28%29%29%3B%0A%0A++++if%28%21pblocktemplate.get%28%29%29%0A++++++++return+nullptr%3B%0A++++pblock+%3D+%26amp%3Bpblocktemplate-%26gt%3Bblock%3B+%2F%2F+pointer+for+convenience%0A%0A++++%2F%2F+Add+dummy+coinbase+tx+as+first+transaction%0A++++%2F%2F%E6%B7%BB%E5%8A%A0%E4%B8%80%E7%AC%94%E4%BC%AA%E4%BA%A4%E6%98%93%E4%BD%9C%E4%B8%BAcoinbase%E4%BA%A4%E6%98%93%EF%BC%8C%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E4%B8%AD%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E5%BF%85%E9%A1%BB%E6%98%AFcoinbase%E4%BA%A4%E6%98%93%EF%BC%8C%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%BD%8D%E7%BD%AE%E7%95%99%E7%BB%99coinbase%E4%BA%A4%E6%98%93%0A++++pblock-%26gt%3Bvtx.emplace_back%28%29%3B%0A++++pblocktemplate-%26gt%3BvTxFees.push_back%28-1%29%3B+%2F%2F+updated+at+end%0A++++pblocktemplate-%26gt%3BvTxSigOpsCost.push_back%28-1%29%3B+%2F%2F+updated+at+end%0A%0A++++LOCK2%28cs_main%2C+mempool.cs%29%3B%0A++++%2F%2F%E6%8B%BF%E5%88%B0%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8C%E4%BD%9C%E4%B8%BA%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%0A++++CBlockIndex*+pindexPrev+%3D+chainActive.Tip%28%29%3B%0A++++assert%28pindexPrev+%21%3D+nullptr%29%3B%0A++++%2F%2F%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%E6%98%AF%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E9%AB%98%E5%BA%A6%2B1%0A++++nHeight+%3D+pindexPrev-%26gt%3BnHeight+%2B+1%3B%0A%0A++++%2F%2F%E8%AE%A1%E7%AE%97%E5%8C%BA%E5%9D%97%E7%89%88%E6%9C%AC%0A++++pblock-%26gt%3BnVersion+%3D+ComputeBlockVersion%28pindexPrev%2C+chainparams.GetConsensus%28%29%29%3B%0A++++%2F%2F+-regtest+only%3A+allow+overriding+block.nVersion+with%0A++++%2F%2F+-blockversion%3DN+to+test+forking+scenarios%0A++++if+%28chainparams.MineBlocksOnDemand%28%29%29%0A++++++++pblock-%26gt%3BnVersion+%3D+gArgs.GetArg%28%22-blockversion%22%2C+pblock-%26gt%3BnVersion%29%3B%0A%0A++++%2F%2F%E8%AE%A1%E7%AE%97%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E9%97%B4%E6%88%B3%EF%BC%8C%E6%97%B6%E9%97%B4%E6%88%B3%E6%98%AF%E8%8A%82%E7%82%B9%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%E5%87%8F%E5%8E%BB%E4%B8%80%E4%B8%AA%E5%81%8F%E7%A7%BB%E5%80%BC%E5%BE%97%E5%88%B0%0A++++pblock-%26gt%3BnTime+%3D+GetAdjustedTime%28%29%3B%0A++++const+int64_t+nMedianTimePast+%3D+pindexPrev-%26gt%3BGetMedianTimePast%28%29%3B%0A%0A++++nLockTimeCutoff+%3D+%28STANDARD_LOCKTIME_VERIFY_FLAGS+%26amp%3B+LOCKTIME_MEDIAN_TIME_PAST%29%0A++++++++++++++++++++++%3F+nMedianTimePast%0A++++++++++++++++++++++%3A+pblock-%26gt%3BGetBlockTime%28%29%3B%0A%0A++++%2F%2F+Decide+whether+to+include+witness+transactions%0A++++%2F%2F+This+is+only+needed+in+case+the+witness+softfork+activation+is+reverted%0A++++%2F%2F+%28which+would+require+a+very+deep+reorganization%29+or+when%0A++++%2F%2F+-promiscuousmempoolflags+is+used.%0A++++%2F%2F+TODO%3A+replace+this+with+a+call+to+main+to+assess+validity+of+a+mempool%0A++++%2F%2F+transaction+%28which+in+most+cases+can+be+a+no-op%29.%0A++++fIncludeWitness+%3D+IsWitnessEnabled%28pindexPrev%2C+chainparams.GetConsensus%28%29%29+%26amp%3B%26amp%3B+fMineWitnessTx%3B%0A%0A++++int+nPackagesSelected+%3D+0%3B%0A++++int+nDescendantsUpdated+%3D+0%3B%0A++++%0A++++%2F%2F%E4%BB%8E%E4%BA%A4%E6%98%93%E6%B1%A0%E4%B8%AD%E9%80%89%E6%8B%A9%E4%B8%80%E6%89%B9%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E5%88%B0%E5%8C%BA%E5%9D%97%E4%B8%AD%EF%BC%88%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%B9%B6%E4%B8%8D%E4%BC%9A%E4%BB%8E%E4%BA%A4%E6%98%93%E6%8C%81%E4%B8%AD%E5%B0%86%E4%BA%A4%E6%98%93%E5%88%A0%E9%99%A4%EF%BC%8C%E5%88%A0%E9%99%A4%E9%9C%80%E8%A6%81%E7%AD%89%E5%8C%BA%E5%9D%97%E7%A1%AE%E8%AE%A4%E4%BB%A5%E5%90%8E%EF%BC%89%0A++++addPackageTxs%28nPackagesSelected%2C+nDescendantsUpdated%29%3B%0A%0A++++int64_t+nTime1+%3D+GetTimeMicros%28%29%3B%0A%0A++++nLastBlockTx+%3D+nBlockTx%3B%0A++++nLastBlockWeight+%3D+nBlockWeight%3B%0A%0A++++%2F%2F+Create+coinbase+transaction.%0A++++%2F%2F%E5%88%9B%E5%BB%BAcoinbase%E4%BA%A4%E6%98%93%0A++++CMutableTransaction+coinbaseTx%3B%0A++++coinbaseTx.vin.resize%281%29%3B%0A++++coinbaseTx.vin%5B0%5D.prevout.SetNull%28%29%3B%0A++++coinbaseTx.vout.resize%281%29%3B%0A++++coinbaseTx.vout%5B0%5D.scriptPubKey+%3D+scriptPubKeyIn%3B%0A++++%2F%2Fcoinbase%E4%BA%A4%E6%98%93%E7%9A%84%E8%BE%93%E5%87%BA%E5%AE%9E%E9%99%85%E4%B8%8A%E5%B0%B1%E6%98%AF%E7%BB%99%E7%9F%BF%E5%B7%A5%E7%9A%84%E5%A5%96%E5%8A%B1%EF%BC%9A%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%E8%B4%B9%E7%94%A8%E4%B9%8B%E5%92%8C%2B%E7%B3%BB%E7%BB%9F%E5%8F%91%E6%94%BE%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E5%A5%96%E5%8A%B1%0A++++coinbaseTx.vout%5B0%5D.nValue+%3D+nFees+%2B+GetBlockSubsidy%28nHeight%2C+chainparams.GetConsensus%28%29%29%3B%0A++++coinbaseTx.vin%5B0%5D.scriptSig+%3D+CScript%28%29+%26lt%3B%26lt%3B+nHeight+%26lt%3B%26lt%3B+OP_0%3B%0A++++pblock-%26gt%3Bvtx%5B0%5D+%3D+MakeTransactionRef%28std%3A%3Amove%28coinbaseTx%29%29%3B%0A++++pblocktemplate-%26gt%3BvchCoinbaseCommitment+%3D+GenerateCoinbaseCommitment%28*pblock%2C+pindexPrev%2C+chainparams.GetConsensus%28%29%29%3B%0A++++pblocktemplate-%26gt%3BvTxFees%5B0%5D+%3D+-nFees%3B%0A%0A++++LogPrintf%28%22CreateNewBlock%28%29%3A+block+weight%3A+%25u+txs%3A+%25u+fees%3A+%25ld+sigops+%25d%5Cn%22%2C+GetBlockWeight%28*pblock%29%2C+nBlockTx%2C+nFees%2C+nBlockSigOpsCost%29%3B%0A%0A++++%2F%2F+Fill+in+header%0A++++%2F%2F%E5%A1%AB%E5%85%85%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97hash%0A++++pblock-%26gt%3BhashPrevBlock++%3D+pindexPrev-%26gt%3BGetBlockHash%28%29%3B%0A++++UpdateTime%28pblock%2C+chainparams.GetConsensus%28%29%2C+pindexPrev%29%3B%0A++++%2F%2F%E8%AE%BE%E7%BD%AE%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BC%0A++++pblock-%26gt%3BnBits++++++++++%3D+GetNextWorkRequired%28pindexPrev%2C+pblock%2C+chainparams.GetConsensus%28%29%29%3B%0A++++%2F%2Fnonce%EF%BC%8C%E8%AE%A1%E7%AE%97%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%E7%9A%84%E6%97%B6%E5%80%99%E5%B0%B1%E6%98%AF%E6%8A%8A%E8%BF%99%E4%B8%AA%E5%80%BC%E4%B8%8D%E6%96%AD%E9%80%92%E5%A2%9E%E6%9D%A5%E7%AE%97hash%0A++++pblock-%26gt%3BnNonce+++++++++%3D+0%3B%0A++++pblocktemplate-%26gt%3BvTxSigOpsCost%5B0%5D+%3D+WITNESS_SCALE_FACTOR+*+GetLegacySigOpCount%28*pblock-%26gt%3Bvtx%5B0%5D%29%3B%0A%0A++++CValidationState+state%3B%0A++++if+%28%21TestBlockValidity%28state%2C+chainparams%2C+*pblock%2C+pindexPrev%2C+false%2C+false%29%29+%7B%0A++++++++throw+std%3A%3Aruntime_error%28strprintf%28%22%25s%3A+TestBlockValidity+failed%3A+%25s%22%2C+__func__%2C+FormatStateMessage%28state%29%29%29%3B%0A++++%7D%0A++++int64_t+nTime2+%3D+GetTimeMicros%28%29%3B%0A%0A++++LogPrint%28BCLog%3A%3ABENCH%2C+%22CreateNewBlock%28%29+packages%3A+%25.2fms+%28%25d+packages%2C+%25d+updated+descendants%29%2C+validity%3A+%25.2fms+%28total+%25.2fms%29%5Cn%22%2C+0.001+*+%28nTime1+-+nTimeStart%29%2C+nPackagesSelected%2C+nDescendantsUpdated%2C+0.001+*+%28nTime2+-+nTime1%29%2C+0.001+*+%28nTime2+-+nTimeStart%29%29%3B%0A%0A++++return+std%3A%3Amove%28pblocktemplate%29%3B%0A%7D%0A%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%85%B3%E9%94%AE%E7%9A%84%E5%9C%B0%E6%96%B9%E5%B7%B2%E7%BB%8F%E5%81%9A%E4%BA%86%E6%B3%A8%E9%87%8A%EF%BC%8C%E7%BB%93%E5%90%88%E4%BB%A3%E7%A0%81%E5%BE%88%E5%AE%B9%E6%98%93%E7%90%86%E8%A7%A3%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E6%9E%84%E9%80%A0%E8%BF%87%E7%A8%8B%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.2.1+%E7%9F%BF%E5%B7%A5%E5%A5%96%E5%8A%B1%E8%B4%B9%E7%9A%84%E8%AE%A1%E7%AE%97%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%8A%E9%9D%A2%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%88%91%E4%BB%AC%E7%9C%8B%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E5%BF%85%E9%A1%BB%E6%98%AFcoinbase%E4%BA%A4%E6%98%93%EF%BC%8Ccoibase%E4%BA%A4%E6%98%93%E6%98%AF%E4%B8%80%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%8C%E7%94%A8%E6%9D%A5%E5%A5%96%E5%8A%B1%E6%8C%96%E7%9F%BF%E7%9A%84%E7%9F%BF%E5%B7%A5%E3%80%82%E5%A5%96%E5%8A%B1%E8%B4%B9%E7%9A%84%E8%AE%A1%E7%AE%97%E6%96%B9%E6%B3%95%E4%BB%A3%E7%A0%81%E4%B8%AD%E5%B7%B2%E7%BB%8F%E7%9C%8B%E5%88%B0%E4%BA%86%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3EcoinbaseTx.vout%5B0%5D.nValue+%3D+nFees+%2B+GetBlockSubsidy%28nHeight%2C+chainparams.GetConsensus%28%29%29%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%A5%96%E5%8A%B1%E8%B4%B9%3D%E5%8C%BA%E5%9D%97%E4%B8%AD%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%E7%9A%84%E4%BA%A4%E6%98%93%E8%B4%B9+%2B+%E7%B3%BB%E7%BB%9F%E5%A5%96%E5%8A%B1%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%85%B6%E4%B8%AD%E4%BA%A4%E6%98%93%E8%B4%B9%E6%98%AF%E5%9C%A8%E4%BB%8E%E4%BA%A4%E6%98%93%E6%B1%A0%E4%B8%AD%E9%80%89%E6%8B%A9%E4%BA%A4%E6%98%93%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%8C%89%E4%BA%A4%E6%98%93%E8%B4%B9%E7%9A%84%E5%A4%9A%E5%B0%91%E9%80%89%E5%87%BA%E7%9A%84%E4%BA%A4%E6%98%93%E8%AE%A1%E7%AE%97%E4%B8%80%E4%B8%AA%E6%80%BB%E5%92%8C%EF%BC%88%E7%9F%BF%E5%B7%A5%E8%82%AF%E5%AE%9A%E4%BC%9A%E4%BC%98%E5%85%88%E9%80%89%E6%8B%A9%E4%BA%A4%E6%98%93%E8%B4%B9%E5%A4%9A%E7%9A%84%E4%BA%A4%E6%98%93%E8%BF%9B%E5%85%A5%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%B0%81%E4%B9%9F%E4%B8%8D%E4%BC%9A%E8%B7%9F%E9%92%B1%E8%BF%87%E4%B8%8D%E5%8E%BB%EF%BC%89%EF%BC%8C%E8%80%8C%E7%B3%BB%E7%BB%9F%E5%A5%96%E5%8A%B1%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E5%88%99%E6%98%AF%E9%9A%8F%E7%9D%80%E4%B8%80%E5%AE%9A%E7%9A%84%E6%97%B6%E9%97%B4%E6%9D%A5%E9%80%92%E5%87%8F%EF%BC%8C%E5%85%B7%E4%BD%93%E7%AE%97%E6%B3%95%E5%8F%82%E8%80%83%E4%B8%8B%E9%9D%A2%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3ECAmount+GetBlockSubsidy%28int+nHeight%2C+const+Consensus%3A%3AParams%26amp%3B+consensusParams%29%0A%7B%0A++++int+halvings+%3D+nHeight+%2F+consensusParams.nSubsidyHalvingInterval%3B%0A++++%2F%2F+Force+block+reward+to+zero+when+right+shift+is+undefined.%0A++++if+%28halvings+%26gt%3B%3D+64%29%0A++++++++return+0%3B%0A%0A++++CAmount+nSubsidy+%3D+50+*+COIN%3B%0A++++%2F%2F+Subsidy+is+cut+in+half+every+210%2C000+blocks+which+will+occur+approximately+every+4+years.%0A++++nSubsidy+%26gt%3B%26gt%3B%3D+halvings%3B%0A++++return+nSubsidy%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%AE%97%E6%B3%95%E9%9C%80%E8%A6%81%E6%A0%B9%E6%8D%AE%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%E5%80%BC%E6%9D%A5%E7%A1%AE%E5%AE%9A%E7%BB%99%E7%9F%BF%E5%B7%A5%E7%9A%84%E5%A5%96%E5%8A%B1%E8%B4%B9%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%A6%96%E5%85%88%E7%94%A8%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%E9%99%A4%E4%BB%A5nSubsidvHalvingInterval%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%80%BC%E4%B8%BA210000%EF%BC%88%E5%9C%A8chainparams.cpp%E4%B8%AD%E5%AE%9A%E4%B9%89%EF%BC%89%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%9B%B8%E9%99%A4%E7%9A%84%E7%BB%93%E6%9E%9C%E5%A4%A7%E4%BA%8E%E6%88%96%E7%AD%89%E4%BA%8E64%EF%BC%8C%E5%88%99%E5%A5%96%E5%8A%B1%E8%B4%B9%E4%B8%BA0%E3%80%82%E6%8D%A2%E5%8F%A5%E8%AF%9D%E8%AF%B4%EF%BC%8C%E5%BD%93%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%E8%B6%85%E8%BF%8764+*+210000%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E7%B3%BB%E7%BB%9F%E5%B0%86%E4%B8%8D%E4%BC%9A%E5%9C%A8%E6%9C%89%E5%A5%96%E5%8A%B1%E8%B4%B9%E3%80%82%E6%8C%89%E6%AF%94%E7%89%B9%E5%B8%81%E5%B9%B3%E5%9D%87%E6%AF%8F10%E5%88%86%E9%92%9F%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%AE%97%EF%BC%8C%E7%94%9F%E6%88%90%E7%AC%AC64+*+210000%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%9C%80%E8%A6%81%E5%A4%A7%E7%BA%A6255%E5%B9%B4%E7%9A%84%E6%97%B6%E9%97%B4%EF%BC%8C%E6%AF%94%E7%89%B9%E5%B8%81%E8%AF%9E%E7%94%9F%E4%BA%8E2009%E5%B9%B4%EF%BC%8C%E6%84%8F%E5%91%B3%E7%9D%80%E5%A4%A7%E7%BA%A6%E5%88%B02214%E5%B9%B4%E5%B7%A6%E5%8F%B3%EF%BC%8C%E6%8C%96%E7%9F%BF%E5%8F%AA%E8%83%BD%E5%BE%97%E5%88%B0%E4%BA%A4%E6%98%93%E8%B4%B9%EF%BC%8C%E4%B8%8D%E5%86%8D%E6%9C%89%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E5%A5%96%E5%8A%B1%E4%BA%A7%E7%94%9F%EF%BC%88%E6%AF%94%E7%89%B9%E5%B8%81%E7%94%A8%E5%AE%8C%E4%BA%86%EF%BC%89%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%E5%B0%8F%E4%BA%8E64+*+210000%EF%BC%8C%E5%88%99%E5%88%9D%E5%A7%8B%E6%97%B6%EF%BC%88%E4%BB%8E%E6%AF%94%E7%89%B9%E5%B8%81%E8%AF%9E%E7%94%9F%E5%BC%80%E5%A7%8B%E7%AE%97%E8%B5%B7%EF%BC%89%E7%B3%BB%E7%BB%9F%E5%A5%96%E5%8A%B1%E6%98%AF50%E4%B8%AA%E6%AF%94%E7%89%B9%E5%B8%81%EF%BC%8C%E7%84%B6%E5%90%8E%E6%AF%8F%E9%9A%9421000%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%A5%96%E5%8A%B1%E8%B4%B9%E5%87%8F%E5%8D%8A%EF%BC%8C%E6%8C%89%E6%AF%94%E7%89%B9%E5%B8%81%E5%B9%B3%E5%9D%8710%E5%88%86%E9%92%9F%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%AE%97%EF%BC%8C210000%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%9C%80%E8%A6%813.99%E5%B9%B4%EF%BC%88%E7%BA%A64%E5%B9%B4%E7%9A%84%E6%97%B6%E9%97%B4%EF%BC%89%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A%E4%B8%AD%E6%89%80%E8%AF%B4%E7%9A%84%E5%B9%B3%E5%9D%87%E6%AF%8F%E9%9A%944%E5%B9%B4%E5%A5%96%E5%8A%B1%E8%B4%B9%E5%87%8F%E5%8D%8A%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.2.2+%E5%B7%A5%E4%BD%9C%E9%87%8F%E9%9A%BE%E5%BA%A6%E7%9A%84%E8%AE%BE%E5%AE%9A%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%E4%B8%AD%E5%8C%85%E5%90%AB%E4%BA%86%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AE%A1%E7%AE%97%E7%9A%84%E9%9A%BE%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BC%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Epblock-%26gt%3BnBits++++++++++%3D+GetNextWorkRequired%28pindexPrev%2C+pblock%2C+chainparams.GetConsensus%28%29%29%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%88%91%E4%BB%AC%E7%9C%8B%E7%9C%8B%E8%BF%99%E4%B8%AA%E7%9B%AE%E6%A0%87%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%BE%E5%AE%9A%E5%87%BA%E6%9D%A5%E7%9A%84%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eunsigned+int+GetNextWorkRequired%28const+CBlockIndex*+pindexLast%2C+const+CBlockHeader+*pblock%2C+const+Consensus%3A%3AParams%26amp%3B+params%29%0A%7B%0A++++assert%28pindexLast+%21%3D+nullptr%29%3B%0A++++%2F%2F%E6%9E%81%E9%99%90%E9%9A%BE%E5%BA%A6%E5%80%BC%0A++++unsigned+int+nProofOfWorkLimit+%3D+UintToArith256%28params.powLimit%29.GetCompact%28%29%3B%0A%0A++++%2F%2F+Only+change+once+per+difficulty+adjustment+interval%0A++++%2F%2F%E8%B7%9D%E7%A6%BB%E4%B8%8A%E4%B8%80%E6%AC%A1%E9%9A%BE%E5%BA%A6%E8%B0%83%E6%95%B4%E6%98%AF%E5%90%A6%E8%BF%87%E4%BA%862016%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E5%B0%B1%E6%B2%BF%E7%94%A8%E7%94%A8%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%E7%9A%84%E9%9A%BE%E5%BA%A6%E5%80%BC%0A++++if+%28%28pindexLast-%26gt%3BnHeight%2B1%29+%25+params.DifficultyAdjustmentInterval%28%29+%21%3D+0%29%0A++++%7B%0A++++++++if+%28params.fPowAllowMinDifficultyBlocks%29%0A++++++++%7B%0A++++++++++++%2F%2F+Special+difficulty+rule+for+testnet%3A%0A++++++++++++%2F%2F+If+the+new+block%27s+timestamp+is+more+than+2*+10+minutes%0A++++++++++++%2F%2F+then+allow+mining+of+a+min-difficulty+block.%0A++++++++++++if+%28pblock-%26gt%3BGetBlockTime%28%29+%26gt%3B+pindexLast-%26gt%3BGetBlockTime%28%29+%2B+params.nPowTargetSpacing*2%29%0A++++++++++++++++return+nProofOfWorkLimit%3B%0A++++++++++++else%0A++++++++++++%7B%0A++++++++++++++++%2F%2F+Return+the+last+non-special-min-difficulty-rules-block%0A++++++++++++++++const+CBlockIndex*+pindex+%3D+pindexLast%3B%0A++++++++++++++++while+%28pindex-%26gt%3Bpprev+%26amp%3B%26amp%3B+pindex-%26gt%3BnHeight+%25+params.DifficultyAdjustmentInterval%28%29+%21%3D+0+%26amp%3B%26amp%3B+pindex-%26gt%3BnBits+%3D%3D+nProofOfWorkLimit%29%0A++++++++++++++++++++pindex+%3D+pindex-%26gt%3Bpprev%3B%0A++++++++++++++++return+pindex-%26gt%3BnBits%3B%0A++++++++++++%7D%0A++++++++%7D%0A++++++++return+pindexLast-%26gt%3BnBits%3B%0A++++%7D%0A%0A++++%2F%2F+Go+back+by+what+we+want+to+be+14+days+worth+of+blocks%0A++++%2F%2F%E8%B6%85%E8%BF%87%E4%BA%862016%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E9%9C%80%E8%A6%81%E9%87%8D%E6%96%B0%E8%B0%83%E6%95%B4%E4%B8%80%E6%AC%A1%E9%9A%BE%E5%BA%A6%0A++++int+nHeightFirst+%3D+pindexLast-%26gt%3BnHeight+-+%28params.DifficultyAdjustmentInterval%28%29-1%29%3B%0A++++assert%28nHeightFirst+%26gt%3B%3D+0%29%3B%0A++++const+CBlockIndex*+pindexFirst+%3D+pindexLast-%26gt%3BGetAncestor%28nHeightFirst%29%3B%0A++++assert%28pindexFirst%29%3B%0A%0A++++return+CalculateNextWorkRequired%28pindexLast%2C+pindexFirst-%26gt%3BGetBlockTime%28%29%2C+params%29%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Ch4%3E2.2.2.1+%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6%E5%80%BC%E7%9A%84%E8%87%AA%E5%8A%A8%E8%B0%83%E6%95%B4%26nbsp%3B+%26nbsp%3B%26nbsp%3B%3C%2Fh4%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%E9%A6%96%E5%85%88%E7%B3%BB%E7%BB%9F%E6%98%AF%E4%BB%A52016%E4%B8%AA%E5%8C%BA%E5%9D%97%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%9F%E6%9D%A5%E8%87%AA%E5%8A%A8%E8%BF%9B%E8%A1%8C%E9%9A%BE%E5%BA%A6%E8%B0%83%E6%95%B4%E7%9A%84%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%91%A8%E6%9C%9F%E5%80%BC%E6%A0%B9%E6%8D%AE%E5%A6%82%E4%B8%8B%E6%96%B9%E6%B3%95%E6%9D%A5%E7%A1%AE%E5%AE%9A%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eint64_t+DifficultyAdjustmentInterval%28%29+const+%7B+return+nPowTargetTimespan+%2F+nPowTargetSpacing%3B+%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%85%B6%E4%B8%ADnPowTargetTimeSpan%E5%92%8CnPowTargetSpacing%E7%9A%84%E5%AE%9A%E4%B9%89%E4%BD%8D%E4%BA%8Echainparams.cpp%E4%B8%AD%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Econsensus.nPowTargetTimespan+%3D+14+*+24+*+60+*+60%3B+%2F%2F+two+weeks%0Aconsensus.nPowTargetSpacing+%3D+10+*+60%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+nPowTargetTimeSpan%2FnPowTargetSpacing%3D2016%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%A6%82%E6%9E%9C%E4%BB%8E%E4%B8%8A%E4%B8%80%E6%AC%A1%E9%9A%BE%E5%BA%A6%E8%B0%83%E6%95%B4%E5%BC%80%E5%A7%8B%E7%AE%97%E8%B5%B7%EF%BC%8C%E6%96%B0%E7%94%9F%E6%88%90%E4%BA%862016%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%88%99%E8%BF%9B%E8%A1%8C%E4%B8%80%E6%AC%A1%E9%9A%BE%E5%BA%A6%E8%B0%83%E6%95%B4%EF%BC%8C%E8%B0%83%E6%95%B4%E7%9A%84%E6%96%B9%E6%B3%95%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eunsigned+int+CalculateNextWorkRequired%28const+CBlockIndex*+pindexLast%2C+int64_t+nFirstBlockTime%2C+const+Consensus%3A%3AParams%26amp%3B+params%29%0A%7B%0A++++if+%28params.fPowNoRetargeting%29%0A++++++++return+pindexLast-%26gt%3BnBits%3B%0A%0A++++%2F%2F+Limit+adjustment+step%0A++++%2F%2F%E8%AE%A1%E7%AE%97%E6%9C%80%E8%BF%91%E7%9A%842016%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%AE%9E%E9%99%85%E8%8A%B1%E8%B4%B9%E4%BA%86%E5%A4%9A%E9%95%BF%E6%97%B6%E9%97%B4%0A++++int64_t+nActualTimespan+%3D+pindexLast-%26gt%3BGetBlockTime%28%29+-+nFirstBlockTime%3B%0A%0A++++%2F%2F%E5%B0%86%E5%AE%9E%E9%99%85%E6%97%B6%E9%97%B4%E9%99%90%E5%88%B6%E5%9C%A83.5%E5%A4%A9-8%E5%91%A8%E5%86%85%EF%BC%8C%E4%BD%8E%E4%BA%8E3.5%E5%A4%A9%E7%9A%84%E6%8C%893.5%E5%A4%A9%E7%AE%97%EF%BC%8C%E9%AB%98%E4%BA%8E8%E5%91%A8%E7%9A%84%E6%8C%898%E5%91%A8%E7%AE%97%0A++++if+%28nActualTimespan+%26lt%3B+params.nPowTargetTimespan%2F4%29%0A++++++++nActualTimespan+%3D+params.nPowTargetTimespan%2F4%3B%0A++++if+%28nActualTimespan+%26gt%3B+params.nPowTargetTimespan*4%29%0A++++++++nActualTimespan+%3D+params.nPowTargetTimespan*4%3B%0A%0A++++%2F%2F+Retarget%0A++++%2F%2F%E9%87%8D%E6%96%B0%E8%AE%BE%E5%AE%9A%E9%9A%BE%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BC%0A++++const+arith_uint256+bnPowLimit+%3D+UintToArith256%28params.powLimit%29%3B%0A++++arith_uint256+bnNew%3B%0A++++bnNew.SetCompact%28pindexLast-%26gt%3BnBits%29%3B+%2F%2F%E6%97%A7%E7%9A%84%E9%9A%BE%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BC%0A++++bnNew+*%3D+nActualTimespan%3B%0A++++bnNew+%2F%3D+params.nPowTargetTimespan%3B%0A%0A++++if+%28bnNew+%26gt%3B+bnPowLimit%29%0A++++++++bnNew+%3D+bnPowLimit%3B%0A%0A++++return+bnNew.GetCompact%28%29%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%AE%BE%E6%96%B0%E7%9A%84%E9%9A%BE%E5%BA%A6%E5%80%BC%E4%B8%BAT%EF%BC%8C%E6%97%A7%E7%9A%84%E9%9A%BE%E5%BA%A6%E5%80%BC%E4%B8%BAO%EF%BC%8C%E6%9C%80%E8%BF%912016%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%AE%9E%E9%99%85%E8%80%97%E8%B4%B9%E6%97%B6%E9%97%B4%E4%B8%BADur%EF%BC%8C%E7%B3%BB%E7%BB%9F%E6%9C%9F%E6%9C%9B%E7%9A%84%E7%94%9F%E6%88%902016%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E9%97%B4%E6%98%AF20160%E5%88%86%E9%92%9F%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E6%AF%8F10%E5%88%86%E9%92%9F%E4%BA%A7%E7%94%9F%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%88%99%E6%A0%B9%E6%8D%AE%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180712213521412%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%98%E6%8D%A2%E4%B8%80%E4%B8%8B%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%85%AC%E5%BC%8F%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180712213314439%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E5%A6%82Dur%E5%B0%8F%E4%BA%8E20160%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E6%9C%80%E8%BF%912016%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E5%AE%9E%E9%99%85%E6%97%B6%E9%97%B4%E5%B0%8F%E4%BA%8E%E6%9C%9F%E6%9C%9B%E5%80%BC%EF%BC%88%E5%8C%BA%E5%9D%97%E5%87%BA%E7%9A%84%E5%A4%AA%E5%BF%AB%E4%BA%86%EF%BC%89%EF%BC%8C%E5%88%99%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6Target%E5%8F%98%E5%B0%8F%EF%BC%8C%E4%BB%8E%E8%80%8C%E6%B1%82%E8%A7%A3%E9%9A%BE%E5%BA%A6%E5%8F%98%E5%A4%A7%EF%BC%88%E6%B3%A8%E6%84%8F%E8%BF%99%E9%87%8C%E6%98%AF%E5%8F%8D%E6%AF%94%E5%85%B3%E7%B3%BB%EF%BC%8C%E5%80%BC%E8%B6%8A%E5%B0%8F%E9%9A%BE%E5%BA%A6%E8%B6%8A%E5%A4%A7%EF%BC%89%EF%BC%9B%E5%8F%8D%E8%BF%87%E6%9D%A5%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%80%E8%BF%912016%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E5%AE%9E%E9%99%85%E6%97%B6%E9%97%B4%E5%A4%A7%E4%BA%8E20160%EF%BC%88%E5%8C%BA%E5%9D%97%E5%87%BA%E7%9A%84%E5%A4%AA%E6%85%A2%E4%BA%86%EF%BC%89%EF%BC%8C%E5%88%99Target%E5%8F%98%E5%A4%A7%EF%BC%8C%E4%BB%8E%E8%80%8C%E6%B1%82%E8%A7%A3%E9%9A%BE%E5%BA%A6%E5%8F%98%E5%B0%8F%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%80%9A%E8%BF%87%E8%BF%99%E7%A7%8D%E5%AE%9A%E6%9C%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E6%95%B4%E9%9A%BE%E5%BA%A6%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%AF%94%E7%89%B9%E5%B8%81%E7%B3%BB%E7%BB%9F%E4%BF%9D%E8%AF%81%E4%BA%86%E5%B9%B3%E5%9D%87%E6%AF%8F10%E5%88%86%E9%92%9F%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E2.2.2.2+%E9%9A%BE%E5%BA%A6%E5%80%BC%E7%9A%84%E8%A1%A8%E7%A4%BA%3C%2Fh4%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8C%BA%E5%9D%97%E5%A4%B4%E7%9A%84%E9%9A%BE%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BCnBit%E6%98%AF%E4%B8%80%E4%B8%AA32%E4%BD%8D%EF%BC%884%E5%AD%97%E8%8A%82%EF%BC%89%E7%9A%84%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B4%E6%95%B0%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B4%E6%95%B0%E7%9A%84%E6%9C%80%E9%AB%98%E4%B8%80%E4%B8%AA%E5%AD%97%E8%8A%82%E4%BB%A3%E8%A1%A8%E5%B9%82%EF%BC%8C%E5%81%87%E8%AE%BE%E4%B8%BAP%EF%BC%8C%E5%90%8E%E4%B8%89%E4%B8%AA%E5%AD%97%E8%8A%82%E4%B8%BA%E7%B3%BB%E6%95%B0%EF%BC%8C%E5%81%87%E8%AE%BE%E4%B8%BAFactor%EF%BC%8C%E5%88%99%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6%E5%80%BCT%E6%9C%80%E7%BB%88%E8%A1%A8%E7%A4%BA%E4%B8%BA%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F201807122127281%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%9B%A0%E4%B8%BA%E6%98%AF%E6%8C%87%E6%95%B0%E7%BA%A7%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%A2%84%E6%83%B3%E5%88%B0%E6%9C%80%E7%BB%88%E7%9A%84%E9%9A%BE%E5%BA%A6%E5%80%BC%E6%98%AF%E9%9D%9E%E5%B8%B8%E5%A4%A7%E7%9A%84%EF%BC%8C%E6%AF%94%E5%A6%82%E6%AF%94%E7%89%B9%E5%B8%81%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E7%9A%84%E7%AC%AC277316%E5%8F%B7%E5%8C%BA%E5%9D%97%EF%BC%8CnBit%E7%9A%84%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BA16%E8%BF%9B%E5%88%B6%E4%B8%BA0x1903a30c%EF%BC%8C%E6%8C%89%E7%85%A7%E4%B8%8A%E9%9D%A2%E7%9A%84%E5%85%AC%E5%BC%8F%EF%BC%8C%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6T%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180712214207347%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%9C%80%E7%BB%88%E5%BE%97%E5%88%B0%E7%9A%84%E5%80%BC%E4%B8%BA22829202948393929850749706076701368331072452018388575715328%EF%BC%8C%E5%B0%86%E8%BF%99%E4%B8%AA%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BA16%E8%BF%9B%E5%88%B6%E5%90%8E%E5%B0%B1%E6%98%AF%E6%9C%80%E7%BB%88hash%E8%AE%A1%E7%AE%97%E7%9A%84%E7%9B%AE%E6%A0%87%E5%80%BC%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+0x0000000000000003A30C00000000000000000000000000000000000000000000%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%94%B1nBit%E7%94%9F%E6%88%90%E6%9C%80%E7%BB%88%E9%9A%BE%E5%BA%A6%E5%80%BC%E7%9A%84%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Earith_uint256%26amp%3B+arith_uint256%3A%3ASetCompact%28uint32_t+nCompact%2C+bool*+pfNegative%2C+bool*+pfOverflow%29%0A%7B%0A++++%2F%2FnBit%E5%8F%B3%E7%A7%BB3%E4%B8%AA%E5%AD%97%E8%8A%82%EF%BC%8C%E5%BE%97%E5%88%B0%E5%B9%82p%0A++++int+nSize+%3D+nCompact+%26gt%3B%26gt%3B+24%3B%0A++++%0A++++%2F%2F%E8%AE%A1%E7%AE%97%E7%B3%BB%E6%95%B0%0A++++uint32_t+nWord+%3D+nCompact+%26amp%3B+0x007fffff%3B%0A++++%0A++++%2F%2F%E5%B9%82p%26lt%3B%3D3%E7%9A%84%E9%9C%80%E8%A6%81%E8%B0%83%E6%95%B4%E4%B8%80%E4%B8%8B%EF%BC%8C%E5%90%A6%E5%88%99%E5%B9%82%E5%B0%B1%E6%98%AF8+*+%28p-3%29%0A++++if+%28nSize+%26lt%3B%3D+3%29+%7B%0A++++++++nWord+%26gt%3B%26gt%3B%3D+8+*+%283+-+nSize%29%3B%0A++++++++*this+%3D+nWord%3B%0A++++%7D+else+%7B%0A++++++++*this+%3D+nWord%3B%0A++++++++*this+%26lt%3B%26lt%3B%3D+8+*+%28nSize+-+3%29%3B%0A++++%7D%0A++++if+%28pfNegative%29%0A++++++++*pfNegative+%3D+nWord+%21%3D+0+%26amp%3B%26amp%3B+%28nCompact+%26amp%3B+0x00800000%29+%21%3D+0%3B%0A++++if+%28pfOverflow%29%0A++++++++*pfOverflow+%3D+nWord+%21%3D+0+%26amp%3B%26amp%3B+%28%28nSize+%26gt%3B+34%29+%7C%7C%0A+++++++++++++++++++++++++++++++++++++%28nWord+%26gt%3B+0xff+%26amp%3B%26amp%3B+nSize+%26gt%3B+33%29+%7C%7C%0A+++++++++++++++++++++++++++++++++++++%28nWord+%26gt%3B+0xffff+%26amp%3B%26amp%3B+nSize+%26gt%3B+32%29%29%3B%0A++++return+*this%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Ch2%3E2.3+%E8%AE%A1%E7%AE%97%E5%B7%A5%E4%BD%9C%E9%87%8F%3C%2Fh2%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%BB%8F%E8%BF%87%E4%B8%8A%E4%B8%80%E8%8A%82%E7%9A%84%E4%BB%8B%E7%BB%8D%EF%BC%8C%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E7%9F%A5%E9%81%93%E4%BA%86%E4%B8%80%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E6%98%AF%E5%A6%82%E4%BD%95%E6%9E%84%E9%80%A0%E7%9A%84%EF%BC%8C%E6%96%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%E7%9B%AE%E6%A0%87%E5%B7%A5%E4%BD%9C%E9%87%8F%E4%B9%9F%E5%B7%B2%E7%BB%8F%E7%A1%AE%E5%AE%9A%E5%B9%B6%E4%BF%9D%E5%AD%98%E5%9C%A8%E5%8C%BA%E5%9D%97%E7%9A%84nBit%E5%9F%9F%E5%BD%93%E4%B8%AD%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%B0%B1%E6%98%AF%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%EF%BC%8C%E6%AF%94%E6%8B%BC%E7%AE%97%E5%8A%9B%E7%9A%84%E6%97%B6%E5%80%99%E4%BA%86%EF%BC%8C%E5%9B%9E%E5%A4%B4%E5%86%8D%E6%9D%A5%E7%9C%8B%E7%9C%8B%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bwhile+%28nHeight+%26lt%3B+nHeightEnd+%26amp%3B%26amp%3B+%21ShutdownRequested%28%29%29%0A++++%7B%0A++++++++%2F%2F%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%0A++++++++std%3A%3Aunique_ptr%26lt%3BCBlockTemplate%26gt%3B+pblocktemplate%28BlockAssembler%28Params%28%29%29.CreateNewBlock%28coinbaseScript-%26gt%3BreserveScript%29%29%3B%0A++++++++if+%28%21pblocktemplate.get%28%29%29%0A++++++++++++throw+JSONRPCError%28RPC_INTERNAL_ERROR%2C+%22Couldn%27t+create+new+block%22%29%3B%0A++++++++CBlock+*pblock+%3D+%26amp%3Bpblocktemplate-%26gt%3Bblock%3B%0A++++++++%7B%0A++++++++++++LOCK%28cs_main%29%3B%0A++++++++++++IncrementExtraNonce%28pblock%2C+chainActive.Tip%28%29%2C+nExtraNonce%29%3B%0A++++++++%7D%0A++++++++%2F%2F%E8%AE%A1%E7%AE%97PoW%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%AF%81%E6%98%8E%EF%BC%8C%E6%8B%BC%E7%AE%97%E5%8A%9B%E7%9A%84%E5%9C%B0%E6%96%B9%E5%B0%B1%E5%9C%A8%E8%BF%99%E9%87%8C%0A++++++++while+%28nMaxTries+%26gt%3B+0+%26amp%3B%26amp%3B+pblock-%26gt%3BnNonce+%26lt%3B+nInnerLoopCount+%26amp%3B%26amp%3B+%21CheckProofOfWork%28pblock-%26gt%3BGetHash%28%29%2C+pblock-%26gt%3BnBits%2C+Params%28%29.GetConsensus%28%29%29%29+%7B%0A++++++++++++%2B%2Bpblock-%26gt%3BnNonce%3B%0A++++++++++++--nMaxTries%3B%0A++++++++%7D%0A++++++++if+%28nMaxTries+%3D%3D+0%29+%7B%0A++++++++++++break%3B%0A++++++++%7D%0A++++++++%2F%2F%E8%B6%85%E8%BF%87%E5%8D%95%E8%BD%AE%E5%BE%AA%E7%8E%AF%E7%9A%84%E4%B8%8A%E9%99%90%2865536%E6%AC%A1%29%EF%BC%8C%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B%0A++++++++if+%28pblock-%26gt%3BnNonce+%3D%3D+nInnerLoopCount%29+%7B%0A++++++++++++continue%3B%0A++++++++%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%B3%BB%E7%BB%9F%E4%BB%A5nInnerLoopCount%EF%BC%8865536%EF%BC%89%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%91%A8%E6%9C%9F%E8%AE%A1%E7%AE%97%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%8C%E8%AE%A1%E7%AE%97%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Ebool+CheckProofOfWork%28uint256+hash%2C+unsigned+int+nBits%2C+const+Consensus%3A%3AParams%26amp%3B+params%29%0A%7B%0A++++bool+fNegative%3B%0A++++bool+fOverflow%3B%0A++++arith_uint256+bnTarget%3B%0A%0A++++bnTarget.SetCompact%28nBits%2C+%26amp%3BfNegative%2C+%26amp%3BfOverflow%29%3B+%2F%2F%E5%B0%86nBits%E6%8C%89%E5%85%AC%E5%BC%8F%E7%94%9F%E6%88%90%E6%9C%80%E7%BB%88%E7%9A%84%E9%9A%BE%E5%BA%A6%E5%80%BC%0A%0A++++%2F%2F+Check+range%0A++++if+%28fNegative+%7C%7C+bnTarget+%3D%3D+0+%7C%7C+fOverflow+%7C%7C+bnTarget+%26gt%3B+UintToArith256%28params.powLimit%29%29%0A++++++++return+false%3B%0A%0A++++%2F%2F+Check+proof+of+work+matches+claimed+amount%0A++++if+%28UintToArith256%28hash%29+%26gt%3B+bnTarget%29%0A++++++++return+false%3B%0A%0A++++return+true%3B%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%AE%A1%E7%AE%97%E7%9A%84%E6%96%B9%E6%B3%95%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%9A%E6%8B%BF%E5%88%B0%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E7%9A%84hash%EF%BC%8C%E6%AF%94%E8%BE%83%E6%98%AF%E5%90%A6%E5%A4%A7%E4%BA%8E%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6%E5%80%BC%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%B0%8F%E4%BA%8E%E7%AD%89%E4%BA%8E%E7%9B%AE%E6%A0%87%E9%9A%BE%E5%BA%A6%E5%80%BC%E5%88%99%E5%AE%8C%E6%88%90%E5%B7%A5%E4%BD%9C%EF%BC%8C%E5%90%A6%E5%88%99%E9%9C%80%E8%A6%81%E6%8A%8A%E5%8C%BA%E5%9D%97%E7%9A%84nonce%E5%80%BC%2B1%E7%84%B6%E5%90%8E%E5%86%8D%E6%AC%A1%E8%AE%A1%E7%AE%97%E5%8C%BA%E5%9D%97%E5%A4%B4hash%EF%BC%8C%E5%A6%82%E6%AD%A4%E5%BE%AA%E7%8E%AF%E4%B8%8B%E5%8E%BB%E7%9B%B4%E5%88%B0%E5%BE%97%E5%88%B0%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6%E7%9A%84%E5%8C%BA%E5%9D%97hash%E4%B8%BA%E6%AD%A2%E3%80%82%3C%2Fp%3E%0A++%3Ch2%3E2.4+%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%BF%AB%3C%2Fh2%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%80%E6%97%A6%E8%AE%A1%E7%AE%97%E5%87%BA%E4%BA%86%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6%E7%9A%84%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%B0%B1%E8%A6%81%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%8A%8A%E6%96%B0%E5%8C%BA%E5%9D%97%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E9%80%9A%E8%BF%87P2P%E7%BD%91%E7%BB%9C%E5%B9%BF%E6%92%AD%E5%87%BA%E5%8E%BB%EF%BC%8C%E8%AE%A9%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E9%AA%8C%E8%AF%81%E6%9C%80%E7%BB%88%E8%BE%BE%E6%88%90%E5%85%B1%E8%AF%86%EF%BC%8C%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E8%8A%82%E7%82%B9%E6%9C%AC%E5%9C%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%88%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9%E8%BE%BE%E6%88%90%E5%85%B1%E8%AF%86%EF%BC%9A%E6%B2%A1%E9%94%99%EF%BC%8C%E4%BD%A0%E7%9A%84%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%B2%A1%E9%97%AE%E9%A2%98%EF%BC%8C%E6%88%91%E4%BB%AC%E6%89%BF%E8%AE%A4%E4%BD%A0%E5%BA%94%E8%AF%A5%E6%8B%BF%E5%88%B0%E6%AF%94%E7%89%B9%E5%B8%81%E5%A5%96%E5%8A%B1%EF%BC%89%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%86%8D%E6%AC%A1%E5%9B%9E%E5%A4%B4%E7%9C%8B%E4%B9%8B%E5%89%8D%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bwhile+%28nMaxTries+%26gt%3B+0+%26amp%3B%26amp%3B+pblock-%26gt%3BnNonce+%26lt%3B+nInnerLoopCount+%26amp%3B%26amp%3B+%21CheckProofOfWork%28pblock-%26gt%3BGetHash%28%29%2C+pblock-%26gt%3BnBits%2C+Params%28%29.GetConsensus%28%29%29%29+%7B%0A++++++++++++%2B%2Bpblock-%26gt%3BnNonce%3B%0A++++++++++++--nMaxTries%3B%0A++++++++%7D%0A++++++++if+%28nMaxTries+%3D%3D+0%29+%7B%0A++++++++++++break%3B%0A++++++++%7D%0A++++++++%2F%2F%E8%B6%85%E8%BF%87%E5%8D%95%E8%BD%AE%E5%BE%AA%E7%8E%AF%E7%9A%84%E4%B8%8A%E9%99%90%2865536%E6%AC%A1%29%EF%BC%8C%E6%9E%84%E9%80%A0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%87%8D%E6%96%B0%E5%BC%80%E5%A7%8B%0A++++++++if+%28pblock-%26gt%3BnNonce+%3D%3D+nInnerLoopCount%29+%7B%0A++++++++++++continue%3B%0A++++++++%7D%0A++++++++%0A++++++++%2F%2F%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%9D%97%0A++++++++std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B+shared_pblock+%3D+std%3A%3Amake_shared%26lt%3Bconst+CBlock%26gt%3B%28*pblock%29%3B%0A++++++++if+%28%21ProcessNewBlock%28Params%28%29%2C+shared_pblock%2C+true%2C+nullptr%29%29%0A++++++++++++throw+JSONRPCError%28RPC_INTERNAL_ERROR%2C+%22ProcessNewBlock%2C+block+not+accepted%22%29%3B%0A++++++++%2B%2BnHeight%3B%0A++++++++blockHashes.push_back%28pblock-%26gt%3BGetHash%28%29.GetHex%28%29%29%3B%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%80%E6%97%A6%E6%88%90%E5%8A%9F%E8%AE%A1%E7%AE%97%E5%87%BA%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%8C%E5%B0%86%E8%B7%B3%E5%87%BA%E5%BE%AA%E7%8E%AF%EF%BC%8C%E7%84%B6%E5%90%8E%E6%89%A7%E8%A1%8CProcessNewBlock%E6%9D%A5%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%A4%84%E7%90%86%E5%A4%B1%E8%B4%A5%EF%BC%8C%E6%8A%9B%E5%87%BA%E5%BC%82%E5%B8%B8%E5%91%8A%E7%9F%A5%E6%96%B0%E5%8C%BA%E5%9D%97%E6%B2%A1%E6%9C%89%E8%A2%AB%E6%8E%A5%E5%8F%97%EF%BC%8C%E5%90%A6%E5%88%99%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84hash%E5%80%BC%E4%BF%9D%E5%AD%98%E8%B5%B7%E6%9D%A5%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+ProcessNewBlock%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E9%9D%9E%E5%B8%B8%E9%87%8D%E8%A6%81%EF%BC%8C%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%85%B6%E6%B5%81%E7%A8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Ebool+ProcessNewBlock%28const+CChainParams%26amp%3B+chainparams%2C+const+std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B+pblock%2C+bool+fForceProcessing%2C+bool+*fNewBlock%29%0A%7B%0A++++AssertLockNotHeld%28cs_main%29%3B%0A%0A++++%7B%0A++++++++CBlockIndex+*pindex+%3D+nullptr%3B%0A++++++++if+%28fNewBlock%29+*fNewBlock+%3D+false%3B%0A++++++++CValidationState+state%3B%0A++++++++%2F%2F+Ensure+that+CheckBlock%28%29+passes+before+calling+AcceptBlock%2C+as%0A++++++++%2F%2F+belt-and-suspenders.%0A++++++++%2F%2F%E5%85%88%E5%AF%B9%E5%8C%BA%E5%9D%97%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5%0A++++++++bool+ret+%3D+CheckBlock%28*pblock%2C+state%2C+chainparams.GetConsensus%28%29%29%3B%0A%0A++++++++LOCK%28cs_main%29%3B%0A%0A++++++++if+%28ret%29+%7B%0A++++++++++++%2F%2F+Store+to+disk%0A++++++++++++%2F%2F%E4%B8%80%E7%B3%BB%E5%88%97%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E7%A1%AE%E8%AE%A4%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E5%90%88%E6%B3%95%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E5%AD%98%E5%85%A5%E7%A3%81%E7%9B%98%0A++++++++++++ret+%3D+g_chainstate.AcceptBlock%28pblock%2C+state%2C+chainparams%2C+%26amp%3Bpindex%2C+fForceProcessing%2C+nullptr%2C+fNewBlock%29%3B%0A++++++++%7D%0A++++++++if+%28%21ret%29+%7B%0A++++++++++++GetMainSignals%28%29.BlockChecked%28*pblock%2C+state%29%3B%0A++++++++++++return+error%28%22%25s%3A+AcceptBlock+FAILED+%28%25s%29%22%2C+__func__%2C+FormatStateMessage%28state%29%29%3B%0A++++++++%7D%0A++++%7D%0A%0A++++%2F%2F%E9%80%9A%E7%9F%A5UI%E5%B1%82%0A++++NotifyHeaderTip%28%29%3B%0A%0A++++CValidationState+state%3B+%2F%2F+Only+used+to+report+errors%2C+not+invalidity+-+ignore+it%0A++++%2F%2F%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%BB%B6%E9%95%BF%E6%9C%AC%E5%9C%B0%E6%9C%80%E9%95%BF%EF%BC%88%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%89%E9%93%BE%0A++++if+%28%21g_chainstate.ActivateBestChain%28state%2C+chainparams%2C+pblock%29%29%0A++++++++return+error%28%22%25s%3A+ActivateBestChain+failed+%28%25s%29%22%2C+__func__%2C+FormatStateMessage%28state%29%29%3B%0A%0A++++return+true%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%95%B4%E4%BD%93%E4%B8%8A%E7%9C%8B%E4%BC%BC%E4%B9%8E%E6%B5%81%E7%A8%8B%E5%BE%88%E7%AE%80%E5%8D%95%E7%9A%84%E4%B8%89%E6%AD%A5%E8%B5%B0%EF%BC%9A%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97-%26gt%3B%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%E5%AD%98%E5%85%A5%E7%A3%81%E7%9B%98-%26gt%3B%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E4%BD%86%E6%98%AF%E5%B1%95%E5%BC%80%E4%BB%A5%E5%90%8E%EF%BC%8C%E6%95%85%E4%BA%8B%E6%83%85%E8%8A%82%E5%85%B6%E5%AE%9E%E8%BF%98%E6%98%AF%E8%9B%AE%E5%A4%8D%E6%9D%82%EF%BC%8C%E9%9C%80%E8%A6%81%E4%B8%80%E7%82%B9%E4%B8%80%E7%82%B9%E6%B6%88%E5%8C%96%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.4.1+%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%96%B0%E6%9E%84%E9%80%A0%E7%9A%84%E5%8C%BA%E5%9D%97%E8%A6%81%E6%83%B3%E5%8A%A0%E5%85%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E8%A6%81%E8%BF%87%E7%9A%84%E7%AC%AC%E4%B8%80%E5%85%B3%E5%B0%B1%E6%98%AF%E5%9F%BA%E6%9C%AC%E7%9A%84%E5%8C%BA%E5%9D%97%E6%A3%80%E6%9F%A5%EF%BC%8C%E5%8C%85%E6%8B%AC%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%98%AF%E5%90%A6%E6%BB%A1%E8%B6%B3%EF%BC%8C%E7%AC%AC%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E6%98%AF%E5%90%A6%E6%98%AFcoinbase%E4%BA%A4%E6%98%93%EF%BC%8C%E6%98%AF%E5%90%A6%E5%8F%AA%E6%9C%89%E4%B8%80%E7%AC%94coinbase%E4%BA%A4%E6%98%93%EF%BC%8C%E4%BA%A4%E6%98%93%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8%E7%AD%89%E7%AD%89%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Ebool+CheckBlock%28const+CBlock%26amp%3B+block%2C+CValidationState%26amp%3B+state%2C+const+Consensus%3A%3AParams%26amp%3B+consensusParams%2C+bool+fCheckPOW%2C+bool+fCheckMerkleRoot%29%0A%7B%0A++++%2F%2F+These+are+checks+that+are+independent+of+context.%0A%0A++++if+%28block.fChecked%29%0A++++++++return+true%3B%0A%0A++++%2F%2F+Check+that+the+header+is+valid+%28particularly+PoW%29.++This+is+mostly%0A++++%2F%2F+redundant+with+the+call+in+AcceptBlockHeader.%0A++++%2F%2F%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%98%AF%E5%90%A6OK%0A++++if+%28%21CheckBlockHeader%28block%2C+state%2C+consensusParams%2C+fCheckPOW%29%29%0A++++++++return+false%3B%0A%0A++++%2F%2F+Check+the+merkle+root.%0A++++%2F%2F%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%E7%9A%84merkel%E6%A0%91%E7%9A%84hash%E5%80%BC%E6%98%AF%E5%90%A6%E4%B8%80%E8%87%B4%EF%BC%88%E7%A1%AE%E4%BF%9D%E4%BA%A4%E6%98%93%E6%B2%A1%E6%9C%89%E8%A2%AB%E7%AF%A1%E6%94%B9%E8%BF%87%EF%BC%89%0A++++if+%28fCheckMerkleRoot%29+%7B%0A++++++++bool+mutated%3B%0A++++++++uint256+hashMerkleRoot2+%3D+BlockMerkleRoot%28block%2C+%26amp%3Bmutated%29%3B%0A++++++++if+%28block.hashMerkleRoot+%21%3D+hashMerkleRoot2%29%0A++++++++++++return+state.DoS%28100%2C+false%2C+REJECT_INVALID%2C+%22bad-txnmrklroot%22%2C+true%2C+%22hashMerkleRoot+mismatch%22%29%3B%0A%0A++++++++%2F%2F+Check+for+merkle+tree+malleability+%28CVE-2012-2459%29%3A+repeating+sequences%0A++++++++%2F%2F+of+transactions+in+a+block+without+affecting+the+merkle+root+of+a+block%2C%0A++++++++%2F%2F+while+still+invalidating+it.%0A++++++++if+%28mutated%29%0A++++++++++++return+state.DoS%28100%2C+false%2C+REJECT_INVALID%2C+%22bad-txns-duplicate%22%2C+true%2C+%22duplicate+transaction%22%29%3B%0A++++%7D%0A%0A++++%2F%2F+All+potential-corruption+validation+must+be+done+before+we+do+any%0A++++%2F%2F+transaction+validation%2C+as+otherwise+we+may+mark+the+header+as+invalid%0A++++%2F%2F+because+we+receive+the+wrong+transactions+for+it.%0A++++%2F%2F+Note+that+witness+malleability+is+checked+in+ContextualCheckBlock%2C+so+no%0A++++%2F%2F+checks+that+use+witness+data+may+be+performed+here.%0A%0A++++%2F%2F+Size+limits%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E4%B8%AD%E4%BA%A4%E6%98%93%E7%9A%84%E6%95%B0%E9%87%8F%E6%98%AF%E5%90%A6%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6%0A++++if+%28block.vtx.empty%28%29+%7C%7C+block.vtx.size%28%29+*+WITNESS_SCALE_FACTOR+%26gt%3B+MAX_BLOCK_WEIGHT+%7C%7C+%3A%3AGetSerializeSize%28block%2C+SER_NETWORK%2C+PROTOCOL_VERSION+%7C+SERIALIZE_TRANSACTION_NO_WITNESS%29+*+WITNESS_SCALE_FACTOR+%26gt%3B+MAX_BLOCK_WEIGHT%29%0A++++++++return+state.DoS%28100%2C+false%2C+REJECT_INVALID%2C+%22bad-blk-length%22%2C+false%2C+%22size+limits+failed%22%29%3B%0A%0A++++%2F%2F+First+transaction+must+be+coinbase%2C+the+rest+must+not+be%0A++++%2F%2F%E7%AC%AC%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%E5%BF%85%E9%A1%BB%E6%98%AFcoinbase%E4%BA%A4%E6%98%93%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%8F%AA%E8%83%BD%E6%9C%89%E4%B8%80%E7%AC%94coinbase%E4%BA%A4%E6%98%93%0A++++if+%28block.vtx.empty%28%29+%7C%7C+%21block.vtx%5B0%5D-%26gt%3BIsCoinBase%28%29%29%0A++++++++return+state.DoS%28100%2C+false%2C+REJECT_INVALID%2C+%22bad-cb-missing%22%2C+false%2C+%22first+tx+is+not+coinbase%22%29%3B%0A++++for+%28unsigned+int+i+%3D+1%3B+i+%26lt%3B+block.vtx.size%28%29%3B+i%2B%2B%29%0A++++++++if+%28block.vtx%5Bi%5D-%26gt%3BIsCoinBase%28%29%29%0A++++++++++++return+state.DoS%28100%2C+false%2C+REJECT_INVALID%2C+%22bad-cb-multiple%22%2C+false%2C+%22more+than+one+coinbase%22%29%3B%0A%0A++++%2F%2F+Check+transactions%0A++++%2F%2F%E6%A3%80%E6%9F%A5%E6%AF%8F%E4%B8%80%E7%AC%94%E4%BA%A4%E6%98%93%0A++++for+%28const+auto%26amp%3B+tx+%3A+block.vtx%29%0A++++++++if+%28%21CheckTransaction%28*tx%2C+state%2C+false%29%29%0A++++++++++++return+state.Invalid%28false%2C+state.GetRejectCode%28%29%2C+state.GetRejectReason%28%29%2C%0A+++++++++++++++++++++++++++++++++strprintf%28%22Transaction+check+failed+%28tx+hash+%25s%29+%25s%22%2C+tx-%26gt%3BGetHash%28%29.ToString%28%29%2C+state.GetDebugMessage%28%29%29%29%3B%0A%0A++++unsigned+int+nSigOps+%3D+0%3B%0A++++for+%28const+auto%26amp%3B+tx+%3A+block.vtx%29%0A++++%7B%0A++++++++nSigOps+%2B%3D+GetLegacySigOpCount%28*tx%29%3B%0A++++%7D%0A++++if+%28nSigOps+*+WITNESS_SCALE_FACTOR+%26gt%3B+MAX_BLOCK_SIGOPS_COST%29%0A++++++++return+state.DoS%28100%2C+false%2C+REJECT_INVALID%2C+%22bad-blk-sigops%22%2C+false%2C+%22out-of-bounds+SigOpCount%22%29%3B%0A%0A++++if+%28fCheckPOW+%26amp%3B%26amp%3B+fCheckMerkleRoot%29%0A++++++++block.fChecked+%3D+true%3B%0A%0A++++return+true%3B%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%9C%89%E9%95%BF%E9%95%BF%E7%9A%84%E4%B8%80%E4%B8%B2%E6%A3%80%E6%9F%A5%E6%B8%85%E5%8D%95%EF%BC%8C%E4%BB%A3%E7%A0%81%E4%B8%AD%E5%B7%B2%E7%BB%8F%E5%81%9A%E4%BA%86%E6%B3%A8%E9%87%8A%EF%BC%8C%E5%BA%94%E8%AF%A5%E9%9D%9E%E5%B8%B8%E5%AE%B9%E6%98%93%E7%90%86%E8%A7%A3%E3%80%82%3C%2Fp%3E%0A++%3Ch3%3E2.4.2+%E5%8C%BA%E5%9D%97%E5%AD%98%E7%9B%98%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%AF%B9%E6%96%B0%E5%8C%BA%E5%9D%97%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5%E6%97%A0%E8%AF%AF%E5%90%8E%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E9%9C%80%E8%A6%81%E5%B0%86%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98%E5%88%B0%E7%A3%81%E7%9B%98%E4%B8%8A%EF%BC%8C%E8%BF%99%E4%B8%80%E6%AD%A5%E9%80%9A%E8%BF%87CChainState%3A%3AAcceptBlock%E6%9D%A5%E5%AE%8C%E6%88%90%EF%BC%8C%E6%95%B4%E4%B8%AA%E8%BF%87%E7%A8%8B%E8%BE%83%E4%B8%BA%E5%A4%8D%E6%9D%82%EF%BC%8C%E5%85%88%E6%9D%A5%E7%9C%8B%E7%9C%8B%E6%95%B4%E4%BD%93%E7%9A%84%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Ebool+CChainState%3A%3AAcceptBlock%28const+std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B%26amp%3B+pblock%2C+CValidationState%26amp%3B+state%2C+const+CChainParams%26amp%3B+chainparams%2C+CBlockIndex**+ppindex%2C+bool+fRequested%2C+const+CDiskBlockPos*+dbp%2C+bool*+fNewBlock%29%0A%7B%0A++++const+CBlock%26amp%3B+block+%3D+*pblock%3B%0A%0A++++if+%28fNewBlock%29+*fNewBlock+%3D+false%3B%0A++++AssertLockHeld%28cs_main%29%3B%0A%0A++++CBlockIndex+*pindexDummy+%3D+nullptr%3B%0A++++CBlockIndex+*%26amp%3Bpindex+%3D+ppindex+%3F+*ppindex+%3A+pindexDummy%3B%0A%0A++++%2F%2F%E6%A0%A1%E9%AA%8C%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E6%89%BE%E5%88%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%EF%BC%88CBlockIndex%EF%BC%89%2C%E6%B2%A1%E6%9C%89%E5%B0%B1%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%B9%B6%E5%8A%A0%E5%85%A5%E5%88%B0mapBlocksIndex%E6%98%A0%E5%B0%84%E8%A1%A8%E4%B8%AD%0A++++if+%28%21AcceptBlockHeader%28block%2C+state%2C+chainparams%2C+%26amp%3Bpindex%29%29%0A++++++++return+false%3B%0A%0A++++%2F%2F+Try+to+process+all+requested+blocks+that+we+don%27t+have%2C+but+only%0A++++%2F%2F+process+an+unrequested+block+if+it%27s+new+and+has+enough+work+to%0A++++%2F%2F+advance+our+tip%2C+and+isn%27t+too+many+blocks+ahead.%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%9C%A8%E7%A3%81%E7%9B%98%E4%B8%8A%0A++++bool+fAlreadyHave+%3D+pindex-%26gt%3BnStatus+%26amp%3B+BLOCK_HAVE_DATA%3B%0A++++%2F%2F%E6%96%B0%E5%8C%BA%E5%BF%AB%E6%98%AF%E5%90%A6%E6%9C%89%E6%9B%B4%E5%A4%9A%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%0A++++bool+fHasMoreOrSameWork+%3D+%28chainActive.Tip%28%29+%3F+pindex-%26gt%3BnChainWork+%26gt%3B%3D+chainActive.Tip%28%29-%26gt%3BnChainWork+%3A+true%29%3B%0A++++%2F%2F+Blocks+that+are+too+out-of-order+needlessly+limit+the+effectiveness+of%0A++++%2F%2F+pruning%2C+because+pruning+will+not+delete+block+files+that+contain+any%0A++++%2F%2F+blocks+which+are+too+close+in+height+to+the+tip.++Apply+this+test%0A++++%2F%2F+regardless+of+whether+pruning+is+enabled%3B+it+should+generally+be+safe+to%0A++++%2F%2F+not+process+unrequested+blocks.%0A++++%2F%2F%E6%98%AF%E5%90%A6%E6%98%AF%E4%B8%80%E4%B8%AA%E7%9B%B8%E9%9A%94%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%E5%A4%AA%E8%BF%9C%E7%9A%84%E5%8C%BA%E5%9D%97%0A++++bool+fTooFarAhead+%3D+%28pindex-%26gt%3BnHeight+%26gt%3B+int%28chainActive.Height%28%29+%2B+MIN_BLOCKS_TO_KEEP%29%29%3B%0A%0A++++%2F%2F+TODO%3A+Decouple+this+function+from+the+block+download+logic+by+removing+fRequested%0A++++%2F%2F+This+requires+some+new+chain+data+structure+to+efficiently+look+up+if+a%0A++++%2F%2F+block+is+in+a+chain+leading+to+a+candidate+for+best+tip%2C+despite+not%0A++++%2F%2F+being+such+a+candidate+itself.%0A%0A++++%2F%2F+TODO%3A+deal+better+with+return+value+and+error+conditions+for+duplicate%0A++++%2F%2F+and+unrequested+blocks.%0A++++%2F%2F%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%E5%B7%B2%E7%BB%8F%E5%9C%A8%E7%A3%81%E7%9B%98%E4%B8%8A%E4%BA%86%EF%BC%8C%E5%BF%BD%E7%95%A5%E9%9A%8F%E5%90%8E%E7%9A%84%E6%93%8D%E4%BD%9C%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%0A++++if+%28fAlreadyHave%29+return+true%3B%0A++++%2F%2F%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E4%BB%8E%E7%BD%91%E7%BB%9C%E6%94%B6%E5%88%B0%E7%9A%84%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%88%E6%96%B0%E6%9E%84%E9%80%A0%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%89%0A++++if+%28%21fRequested%29+%7B++%2F%2F+If+we+didn%27t+ask+for+it%3A%0A++++++++%2F%2F%E5%8C%BA%E5%9D%97%E4%B9%8B%E5%89%8D%E5%B7%B2%E7%BB%8F%E5%A4%84%E7%90%86%E8%BF%87%EF%BC%8C%E5%BF%BD%E7%95%A5%0A++++++++if+%28pindex-%26gt%3BnTx+%21%3D+0%29+return+true%3B++++%2F%2F+This+is+a+previously-processed+block+that+was+pruned%0A++++++++%2F%2F%E5%B7%A5%E4%BD%9C%E9%87%8F%E4%B8%8D%E5%A4%9F%EF%BC%8C%E5%BF%BD%E7%95%A5%0A++++++++if+%28%21fHasMoreOrSameWork%29+return+true%3B+%2F%2F+Don%27t+process+less-work+chains%0A++++++++%2F%2F%E5%A4%AA%E8%BF%9C%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%BF%BD%E7%95%A5%0A++++++++if+%28fTooFarAhead%29+return+true%3B++++++++%2F%2F+Block+height+is+too+high%0A%0A++++++++%2F%2F+Protect+against+DoS+attacks+from+low-work+chains.%0A++++++++%2F%2F+If+our+tip+is+behind%2C+a+peer+could+try+to+send+us%0A++++++++%2F%2F+low-work+blocks+on+a+fake+chain+that+we+would+never%0A++++++++%2F%2F+request%3B+don%27t+process+these.%0A++++++++if+%28pindex-%26gt%3BnChainWork+%26lt%3B+nMinimumChainWork%29+return+true%3B%0A++++%7D%0A++++if+%28fNewBlock%29+*fNewBlock+%3D+true%3B%0A%0A++++%2F%2F%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%A0%87%E8%AE%B0%E4%B8%BA%E6%97%A0%E6%95%88%EF%BC%88BLOCK_FAILED_VALID%EF%BC%89%2C%E5%B9%B6%E4%B8%94%E5%8A%A0%E5%85%A5%E5%88%B0%E8%84%8F%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%0A++++if+%28%21CheckBlock%28block%2C+state%2C+chainparams.GetConsensus%28%29%29+%7C%7C%0A++++++++%21ContextualCheckBlock%28block%2C+state%2C+chainparams.GetConsensus%28%29%2C+pindex-%26gt%3Bpprev%29%29+%7B%0A++++++++if+%28state.IsInvalid%28%29+%26amp%3B%26amp%3B+%21state.CorruptionPossible%28%29%29+%7B%0A++++++++++++pindex-%26gt%3BnStatus+%7C%3D+BLOCK_FAILED_VALID%3B%0A++++++++++++setDirtyBlockIndex.insert%28pindex%29%3B%0A++++++++%7D%0A++++++++return+error%28%22%25s%3A+%25s%22%2C+__func__%2C+FormatStateMessage%28state%29%29%3B%0A++++%7D%0A%0A++++%2F%2F+Header+is+valid%2Fhas+work%2C+merkle+tree+and+segwit+merkle+tree+are+good...RELAY+NOW%0A++++%2F%2F+%28but+if+it+does+not+build+on+our+best+tip%2C+let+the+SendMessages+loop+relay+it%29%0A++++if+%28%21IsInitialBlockDownload%28%29+%26amp%3B%26amp%3B+chainActive.Tip%28%29+%3D%3D+pindex-%26gt%3Bpprev%29%0A++++++++GetMainSignals%28%29.NewPoWValidBlock%28pindex%2C+pblock%29%3B%2F%2F%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%B9%BF%E6%92%AD%E5%88%B0%E7%BD%91%E7%BB%9C%E4%B8%AD%0A%0A++++%2F%2F+Write+block+to+history+file%0A++++try+%7B%0A++++++++%2F%2F%E5%B0%86%E5%8C%BA%E5%9D%97%E5%AD%98%E5%82%A8%E5%88%B0%E7%A3%81%E7%9B%98%E4%B8%8A%0A++++++++CDiskBlockPos+blockPos+%3D+SaveBlockToDisk%28block%2C+pindex-%26gt%3BnHeight%2C+chainparams%2C+dbp%29%3B%0A++++++++if+%28blockPos.IsNull%28%29%29+%7B%0A++++++++++++state.Error%28strprintf%28%22%25s%3A+Failed+to+find+position+to+write+new+block+to+disk%22%2C+__func__%29%29%3B%0A++++++++++++return+false%3B%0A++++++++%7D%0A++++++++%2F%2F%E6%A0%87%E8%AE%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B7%B2%E7%BB%8F%E6%8E%A5%E6%94%B6%E5%B9%B6%E4%B8%94%E6%A3%80%E6%9F%A5%E8%BF%87%E4%BA%86%EF%BC%88%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BABLOCK_VALID_TRANSACTIONS%EF%BC%89%0A++++++++if+%28%21ReceivedBlockTransactions%28block%2C+state%2C+pindex%2C+blockPos%2C+chainparams.GetConsensus%28%29%29%29%0A++++++++++++return+error%28%22AcceptBlock%28%29%3A+ReceivedBlockTransactions+failed%22%29%3B%0A++++%7D+catch+%28const+std%3A%3Aruntime_error%26amp%3B+e%29+%7B%0A++++++++return+AbortNode%28state%2C+std%3A%3Astring%28%22System+error%3A+%22%29+%2B+e.what%28%29%29%3B%0A++++%7D%0A%0A++++FlushStateToDisk%28chainparams%2C+state%2C+FlushStateMode%3A%3ANONE%29%3B%0A%0A++++CheckBlockIndex%28chainparams.GetConsensus%28%29%29%3B%0A%0A++++return+true%3B%0A%7D%0A%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%EF%BC%881%EF%BC%89%E6%A0%A1%E9%AA%8C%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E6%89%BE%E5%88%B0%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95CBlockIndex%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E4%B8%BA%E6%96%B0%E5%8C%BA%E5%9D%97%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%B4%A2%E5%BC%95%E5%B9%B6%E5%8A%A0%E5%85%A5%E5%88%B0mapBlocksIndex%E6%98%A0%E5%B0%84%E8%A1%A8%EF%BC%9B%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Ebool+CChainState%3A%3AAcceptBlockHeader%28const+CBlockHeader%26amp%3B+block%2C+CValidationState%26amp%3B+state%2C+const+CChainParams%26amp%3B+chainparams%2C+CBlockIndex**+ppindex%29+%7B%0A++++AssertLockHeld%28cs_main%29%3B%0A++++%2F%2F+Check+for+duplicate%0A++++%2F%2F%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97hash%E5%80%BC%0A++++uint256+hash+%3D+block.GetHash%28%29%3B%0A++++%2F%2F%E6%A3%80%E7%B4%A2mapBlockIndex%E7%B4%A2%E5%BC%95%E8%A1%A8%EF%BC%8C%E7%9C%8B%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%B7%B2%E7%BB%8F%E5%9C%A8%E8%A1%A8%E4%B8%AD%0A++++BlockMap%3A%3Aiterator+miSelf+%3D+mapBlockIndex.find%28hash%29%3B%0A++++CBlockIndex+*pindex+%3D+nullptr%3B%0A++++if+%28hash+%21%3D+chainparams.GetConsensus%28%29.hashGenesisBlock%29+%7B+%2F%2F%E9%9D%9E%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%0A++++++++if+%28miSelf+%21%3D+mapBlockIndex.end%28%29%29+%7B%0A++++++++++++%2F%2F+Block+header+is+already+known.%0A++++++++++++%2F%2F%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%E5%B7%B2%E7%BB%8F%E6%9C%89%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF%E4%BA%86%EF%BC%8C%E8%BF%94%E5%9B%9E%0A++++++++++++pindex+%3D+miSelf-%26gt%3Bsecond%3B%0A++++++++++++if+%28ppindex%29%0A++++++++++++++++*ppindex+%3D+pindex%3B%0A++++++++++++if+%28pindex-%26gt%3BnStatus+%26amp%3B+BLOCK_FAILED_MASK%29%0A++++++++++++++++return+state.Invalid%28%0A++++++++++++++++++++++++error%28%22%25s%3A+block+%25s+is+marked+invalid%22%2C+__func__%2C+hash.ToString%28%29%29%2C+0%2C%0A++++++++++++++++++++++++%22duplicate%22%29%3B%0A++++++++++++return+true%3B%0A++++++++%7D%0A%0A++++++++%2F%2F%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%98%AF%E5%90%A6OK%0A++++++++if+%28%21CheckBlockHeader%28block%2C+state%2C+chainparams.GetConsensus%28%29%29%29%0A++++++++++++return+error%28%22%25s%3A+Consensus%3A%3ACheckBlockHeader%3A+%25s%2C+%25s%22%2C+__func__%2C+hash.ToString%28%29%2C%0A+++++++++++++++++++++++++FormatStateMessage%28state%29%29%3B%0A%0A++++++++%2F%2F+Get+prev+block+index%0A++++++++%2F%2F%E4%BB%8E%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%E6%9F%A5%E6%89%BE%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%88%99%E5%87%BA%E9%94%99%E8%BF%94%E5%9B%9E%0A++++++++CBlockIndex+*pindexPrev+%3D+nullptr%3B%0A++++++++BlockMap%3A%3Aiterator+mi+%3D+mapBlockIndex.find%28block.hashPrevBlock%29%3B%0A++++++++if+%28mi+%3D%3D+mapBlockIndex.end%28%29%29%0A++++++++++++return+state.DoS%2810%2C+error%28%22%25s%3A+prev+block+not+found%22%2C+__func__%29%2C+0%2C%0A+++++++++++++++++++++++++++++%22prev-blk-not-found%22%29%3B%0A++++++++pindexPrev+%3D+%28*mi%29.second%3B%0A++++++++%2F%2F%E7%88%B6%E5%8C%BA%E5%9D%97%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%8C%E5%87%BA%E9%94%99%E8%BF%94%E5%9B%9E%0A++++++++if+%28pindexPrev-%26gt%3BnStatus+%26amp%3B+BLOCK_FAILED_MASK%29%0A++++++++++++return+state.DoS%28100%2C+error%28%22%25s%3A+prev+block+invalid%22%2C+__func__%29%2C+REJECT_INVALID%2C%0A+++++++++++++++++++++++++++++%22bad-prevblk%22%29%3B%0A++++++++if+%28%21ContextualCheckBlockHeader%28block%2C+state%2C+chainparams%2C+pindexPrev%2C+GetAdjustedTime%28%29%29%29%0A++++++++++++return+error%28%22%25s%3A+Consensus%3A%3AContextualCheckBlockHeader%3A+%25s%2C+%25s%22%2C+__func__%2C%0A+++++++++++++++++++++++++hash.ToString%28%29%2C+FormatStateMessage%28state%29%29%3B%0A%0A++++++++%2F%2F+If+the+previous+block+index+isn%27t+valid%2C+determine+if+it+descends+from+any+block+which%0A++++++++%2F%2F+has+been+found+invalid+%28g_failed_blocks%29%2C+then+mark+pindexPrev+and+any+blocks%0A++++++++%2F%2F+between+them+as+failed.%0A++++++++if+%28%21pindexPrev-%26gt%3BIsValid%28BLOCK_VALID_SCRIPTS%29%29+%7B%0A++++++++++++for+%28const+CBlockIndex+*failedit+%3A+m_failed_blocks%29+%7B%0A++++++++++++++++if+%28pindexPrev-%26gt%3BGetAncestor%28failedit-%26gt%3BnHeight%29+%3D%3D+failedit%29+%7B%0A++++++++++++++++++++assert%28failedit-%26gt%3BnStatus+%26amp%3B+BLOCK_FAILED_VALID%29%3B%0A++++++++++++++++++++CBlockIndex+*invalid_walk+%3D+pindexPrev%3B%0A++++++++++++++++++++while+%28invalid_walk+%21%3D+failedit%29+%7B%0A++++++++++++++++++++++++invalid_walk-%26gt%3BnStatus+%7C%3D+BLOCK_FAILED_CHILD%3B%0A++++++++++++++++++++++++setDirtyBlockIndex.insert%28invalid_walk%29%3B%0A++++++++++++++++++++++++invalid_walk+%3D+invalid_walk-%26gt%3Bpprev%3B%0A++++++++++++++++++++%7D%0A++++++++++++++++++++return+state.DoS%28100%2C+error%28%22%25s%3A+prev+block+invalid%22%2C+__func__%29%2C+REJECT_INVALID%2C%0A+++++++++++++++++++++++++++++++++++++%22bad-prevblk%22%29%3B%0A++++++++++++++++%7D%0A++++++++++++%7D%0A++++++++%7D%0A++++%7D%0A++++%2F%2F%E4%B8%BA%E6%96%B0%E5%8C%BA%E5%9D%97%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%0A++++if+%28pindex+%3D%3D+nullptr%29%0A++++++++pindex+%3D+AddToBlockIndex%28block%29%3B%0A%0A++++if+%28ppindex%29%0A++++++++*ppindex+%3D+pindex%3B%0A%0A++++CheckBlockIndex%28chainparams.GetConsensus%28%29%29%3B%0A%0A++++return+true%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%BB%E8%A6%81%E5%B0%B1%E6%98%AF%E5%81%9A%E4%B8%80%E4%BA%9B%E6%A3%80%E6%9F%A5%EF%BC%8C%E7%84%B6%E5%90%8E%E4%B8%BA%E6%96%B0%E5%8C%BA%E5%9D%97%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3ECBlockIndex*+CChainState%3A%3AAddToBlockIndex%28const+CBlockHeader%26amp%3B+block%29%0A%7B%0A++++AssertLockHeld%28cs_main%29%3B%0A%0A++++%2F%2F+Check+for+duplicate%0A++++uint256+hash+%3D+block.GetHash%28%29%3B%0A++++BlockMap%3A%3Aiterator+it+%3D+mapBlockIndex.find%28hash%29%3B%0A++++%2F%2F%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%E5%B7%B2%E7%BB%8F%E6%9C%89%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E4%BA%86%EF%BC%8C%E7%9B%B4%E6%8E%A5%E8%BF%94%E5%9B%9E%0A++++if+%28it+%21%3D+mapBlockIndex.end%28%29%29%0A++++++++return+it-%26gt%3Bsecond%3B%0A%0A++++%2F%2F+Construct+new+block+index+object%0A++++%2F%2F%E4%B8%BA%E5%8C%BA%E5%9D%97%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%B9%B6%E5%A1%AB%E5%85%85%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%0A++++CBlockIndex*+pindexNew+%3D+new+CBlockIndex%28block%29%3B%0A++++%2F%2F+We+assign+the+sequence+id+to+blocks+only+when+the+full+data+is+available%2C%0A++++%2F%2F+to+avoid+miners+withholding+blocks+but+broadcasting+headers%2C+to+get+a%0A++++%2F%2F+competitive+advantage.%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E7%9A%84%E5%BA%8F%E5%8F%B7%EF%BC%8C%E5%88%9D%E5%A7%8B%E4%B8%BA0%EF%BC%8C%E7%AD%89%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97%E5%AE%8C%E6%95%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E5%90%8E%E5%9C%A8%E7%A1%AE%E5%AE%9A%E8%AF%A5%E5%8C%BA%E5%9D%97%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%BA%8F%E5%88%97%E5%8F%B7%EF%BC%8C%E9%98%B2%E6%AD%A2%E6%81%B6%E6%84%8F%E7%9F%BF%E5%B7%A5%E9%80%9A%E8%BF%87%E5%8F%AA%E5%B9%BF%E6%92%AD%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E8%80%8C%E4%B8%8D%E5%8F%91%E9%80%81%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%E8%8E%B7%E5%8F%96%E7%89%B9%E6%9D%83%0A++++pindexNew-%26gt%3BnSequenceId+%3D+0%3B%0A++++%2F%2F%E5%B0%86%E7%B4%A2%E5%BC%95%E6%B7%BB%E5%8A%A0%E5%88%B0%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%0A++++BlockMap%3A%3Aiterator+mi+%3D+mapBlockIndex.insert%28std%3A%3Amake_pair%28hash%2C+pindexNew%29%29.first%3B%0A++++%2F%2F%E5%A1%AB%E5%85%85%E5%8C%BA%E5%9D%97hash%E5%80%BC%0A++++pindexNew-%26gt%3BphashBlock+%3D+%26amp%3B%28%28*mi%29.first%29%3B%0A++++BlockMap%3A%3Aiterator+miPrev+%3D+mapBlockIndex.find%28block.hashPrevBlock%29%3B%0A++++if+%28miPrev+%21%3D+mapBlockIndex.end%28%29%29%0A++++%7B%0A++++++++%2F%2F%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E6%8C%87%E9%92%88%0A++++++++pindexNew-%26gt%3Bpprev+%3D+%28*miPrev%29.second%3B%0A++++++++%2F%2F%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E9%AB%98%E5%BA%A6%0A++++++++pindexNew-%26gt%3BnHeight+%3D+pindexNew-%26gt%3Bpprev-%26gt%3BnHeight+%2B+1%3B%0A++++++++pindexNew-%26gt%3BBuildSkip%28%29%3B%0A++++%7D%0A++++pindexNew-%26gt%3BnTimeMax+%3D+%28pindexNew-%26gt%3Bpprev+%3F+std%3A%3Amax%28pindexNew-%26gt%3Bpprev-%26gt%3BnTimeMax%2C+pindexNew-%26gt%3BnTime%29+%3A+pindexNew-%26gt%3BnTime%29%3B%0A++++%2F%2F%E5%A1%AB%E5%85%85%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%AF%E7%A7%AF%E5%B7%A5%E4%BD%9C%E9%87%8F%0A++++pindexNew-%26gt%3BnChainWork+%3D+%28pindexNew-%26gt%3Bpprev+%3F+pindexNew-%26gt%3Bpprev-%26gt%3BnChainWork+%3A+0%29+%2B+GetBlockProof%28*pindexNew%29%3B%0A++++%2F%2F%E5%B0%86%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E5%8D%87%E7%BA%A7%E5%88%B0BLOCK_VALID_TREE%0A++++pindexNew-%26gt%3BRaiseValidity%28BLOCK_VALID_TREE%29%3B%0A++++%2F%2F%E5%A6%82%E6%9E%9C%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%AF%E7%A7%AF%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%AF%94%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E7%9A%84%E6%9C%80%E5%A4%A7%E7%B4%AF%E7%A7%AF%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%A4%A7%EF%BC%8C%E6%9B%B4%E6%96%B0%E4%B8%80%E4%B8%8BpindexBestHeader%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%0A++++if+%28pindexBestHeader+%3D%3D+nullptr+%7C%7C+pindexBestHeader-%26gt%3BnChainWork+%26lt%3B+pindexNew-%26gt%3BnChainWork%29%0A++++++++pindexBestHeader+%3D+pindexNew%3B%0A%0A++++setDirtyBlockIndex.insert%28pindexNew%29%3B%0A%0A++++return+pindexNew%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+OK%EF%BC%8C%E7%8E%B0%E5%9C%A8%E6%96%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%B7%B2%E7%BB%8F%E6%A0%A1%E9%AA%8C%E5%AE%8C%E6%88%90%EF%BC%8C%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%B4%A2%E5%BC%95%E4%B9%9F%E5%88%9B%E5%BB%BA%E5%A5%BD%E5%B9%B6%E4%B8%94%E5%8A%A0%E5%85%A5%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E8%A1%A8mapBlocksIndex%E4%B8%AD%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E7%A3%81%E7%9B%98%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8C%BA%E5%9D%97%E5%A4%B4%E6%A0%A1%E9%AA%8C%E6%97%A0%E8%AF%AF%E5%90%8E%EF%BC%8C%E6%96%B0%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%E9%9C%80%E8%A6%81%E4%BF%9D%E5%AD%98%E5%88%B0%E7%A3%81%E7%9B%98%E4%B8%AD%EF%BC%8C%E4%B9%8B%E5%89%8D%E7%9A%84%E4%BB%A3%E7%A0%81%E5%B7%B2%E7%BB%8F%E7%9C%8B%E5%88%B0%E8%BF%87%E8%BF%99%E6%98%AF%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84%E4%BA%86%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Btry+%7B%0A++++++++%2F%2F%E5%B0%86%E5%8C%BA%E5%9D%97%E5%AD%98%E5%82%A8%E5%88%B0%E7%A3%81%E7%9B%98%E4%B8%8A%0A++++++++CDiskBlockPos+blockPos+%3D+SaveBlockToDisk%28block%2C+pindex-%26gt%3BnHeight%2C+chainparams%2C+dbp%29%3B%0A++++++++if+%28blockPos.IsNull%28%29%29+%7B%0A++++++++++++state.Error%28strprintf%28%22%25s%3A+Failed+to+find+position+to+write+new+block+to+disk%22%2C+__func__%29%29%3B%0A++++++++++++return+false%3B%0A++++++++%7D%0A++++++++%2F%2F%E6%A0%87%E8%AE%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B7%B2%E7%BB%8F%E6%8E%A5%E6%94%B6%E5%B9%B6%E4%B8%94%E6%A3%80%E6%9F%A5%E8%BF%87%E4%BA%86%EF%BC%88%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E6%9B%B4%E6%96%B0%E4%B8%BABLOCK_VALID_TRANSACTIONS%EF%BC%89%0A++++++++if+%28%21ReceivedBlockTransactions%28block%2C+state%2C+pindex%2C+blockPos%2C+chainparams.GetConsensus%28%29%29%29%0A++++++++++++return+error%28%22AcceptBlock%28%29%3A+ReceivedBlockTransactions+failed%22%29%3B%0A++++%7D+catch+%28const+std%3A%3Aruntime_error%26amp%3B+e%29+%7B%0A++++++++return+AbortNode%28state%2C+std%3A%3Astring%28%22System+error%3A+%22%29+%2B+e.what%28%29%29%3B%0A++++%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%A6%96%E5%85%88%E8%B0%83%E7%94%A8SaveBlockToDisk%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%E5%AD%98%E7%9B%98%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B0%83%E7%94%A8ReceivedBlockTransactions%E6%A0%87%E8%AE%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B7%B2%E6%A0%A1%E9%AA%8C%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E5%8D%87%E7%BA%A7%E5%88%B0BLOCK_VALID_TRANSACTIONS%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F**+Mark+a+block+as+having+its+data+received+and+checked+%28up+to+BLOCK_VALID_TRANSACTIONS%29.+*%2F%0Abool+CChainState%3A%3AReceivedBlockTransactions%28const+CBlock+%26amp%3Bblock%2C+CValidationState%26amp%3B+state%2C+CBlockIndex+*pindexNew%2C+const+CDiskBlockPos%26amp%3B+pos%2C+const+Consensus%3A%3AParams%26amp%3B+consensusParams%29%0A%7B%0A++++%2F%2F%E5%A1%AB%E5%85%85%E5%8C%BA%E5%9D%97%E4%BF%A1%E6%81%AF%EF%BC%88%E4%BA%A4%E6%98%93%E6%95%B0%E9%87%8F%EF%BC%8C%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6%E5%BA%8F%E5%8F%B7%E7%AD%89%EF%BC%89%0A++++pindexNew-%26gt%3BnTx+%3D+block.vtx.size%28%29%3B%0A++++pindexNew-%26gt%3BnChainTx+%3D+0%3B%0A++++pindexNew-%26gt%3BnFile+%3D+pos.nFile%3B%0A++++pindexNew-%26gt%3BnDataPos+%3D+pos.nPos%3B%0A++++pindexNew-%26gt%3BnUndoPos+%3D+0%3B%0A%0A++++%2F%2F%E6%A0%87%E8%AE%B0%E6%88%91%E4%BB%AC%E5%B7%B2%E7%BB%8F%E6%94%B6%E5%88%B0%E5%B9%B6%E6%A0%A1%E9%AA%8C%E4%BA%86%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%0A++++pindexNew-%26gt%3BnStatus+%7C%3D+BLOCK_HAVE_DATA%3B%0A++++if+%28IsWitnessEnabled%28pindexNew-%26gt%3Bpprev%2C+consensusParams%29%29+%7B%0A++++++++pindexNew-%26gt%3BnStatus+%7C%3D+BLOCK_OPT_WITNESS%3B%0A++++%7D%0A%0A++++%2F%2F%E5%8C%BA%E5%9D%97%E7%8A%B6%E6%80%81%E5%8D%87%E7%BA%A7%E4%B8%BABLOCK_VALID_TRANSACTIONS%0A++++pindexNew-%26gt%3BRaiseValidity%28BLOCK_VALID_TRANSACTIONS%29%3B%0A++++setDirtyBlockIndex.insert%28pindexNew%29%3B%0A%0A++++if+%28pindexNew-%26gt%3Bpprev+%3D%3D+nullptr+%7C%7C+pindexNew-%26gt%3Bpprev-%26gt%3BnChainTx%29+%7B%0A++++++++%2F%2F+If+pindexNew+is+the+genesis+block+or+all+parents+are+BLOCK_VALID_TRANSACTIONS.%0A++++++++%2F%2F%E5%A6%82%E6%9E%9C%E6%98%AF%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%E6%88%96%E8%80%85%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E4%B8%BABLOCK_VALID_TRANSACTIONS%EF%BC%8C%E8%BF%9B%E5%85%A5%E6%AD%A4%E5%88%86%E6%94%AF%EF%BC%88%E5%AF%B9%E4%BA%8E%E6%9C%AC%E5%9C%B0%E6%8C%96%E5%88%B0%E7%9A%84%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%85%B6%E7%88%B6%E5%8C%BA%E5%9D%97%E4%B8%80%E5%AE%9A%E6%BB%A1%E8%B6%B3%E6%AD%A4%E6%9D%A1%E4%BB%B6%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BC%9A%E8%BF%9B%E5%85%A5%E8%AF%A5%E5%88%86%E6%94%AF%EF%BC%89%0A++++++++std%3A%3Adeque%26lt%3BCBlockIndex*%26gt%3B+queue%3B%0A++++++++queue.push_back%28pindexNew%29%3B%0A%0A++++++++%2F%2F+Recursively+process+any+descendant+blocks+that+now+may+be+eligible+to+be+connected.%0A++++++++%2F%2F%E8%BF%99%E9%87%8C%E9%80%92%E5%BD%92%E5%A4%84%E7%90%86mapBlockUnlinked%E3%80%82%E5%81%87%E8%AE%BE%E5%BD%93%E5%89%8DmapBlockUnlinked%E4%B8%AD%E5%AD%98%E5%9C%A8B-%26gt%3BC%EF%BC%8CB-%26gt%3BD%0A++++++++%2F%2F%E6%AD%A4%E6%97%B6%E6%94%B6%E5%88%B0%E4%BA%86B%E5%8C%BA%E5%9D%97%E7%9A%84%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%EF%BC%8CpindexNew%E6%8C%87%E5%90%91B%E5%8C%BA%E5%9D%97%E3%80%82%0A++++++++%2F%2F%E8%BF%99%E9%87%8C%E4%BC%9A%E4%BB%8EmapBlockUnlinked%E4%B8%AD%E9%80%92%E5%BD%92%E5%88%A0%E9%99%A4B-%26gt%3BC%E3%80%81B-%26gt%3BD%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%B0%86B%2CC%2CD%E5%8A%A0%E5%85%A5%E5%80%99%E9%80%89%E9%9B%86%E5%90%88setBlockIndexCandidates%E4%B8%AD%0A++++++++while+%28%21queue.empty%28%29%29+%7B%0A++++++++++++CBlockIndex+*pindex+%3D+queue.front%28%29%3B%0A++++++++++++queue.pop_front%28%29%3B%0A++++++++++++pindex-%26gt%3BnChainTx+%3D+%28pindex-%26gt%3Bpprev+%3F+pindex-%26gt%3Bpprev-%26gt%3BnChainTx+%3A+0%29+%2B+pindex-%26gt%3BnTx%3B%0A++++++++++++%7B%0A++++++++++++++++LOCK%28cs_nBlockSequenceId%29%3B%0A++++++++++++++++pindex-%26gt%3BnSequenceId+%3D+nBlockSequenceId%2B%2B%3B%0A++++++++++++%7D%0A++++++++++++%2F%2F%E5%AF%B9%E6%AF%94%E5%92%8C%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%8C%E6%AF%94%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%A4%A7%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%8A%A0%E5%85%A5%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%0A++++++++++++if+%28chainActive.Tip%28%29+%3D%3D+nullptr+%7C%7C+%21setBlockIndexCandidates.value_comp%28%29%28pindex%2C+chainActive.Tip%28%29%29%29+%7B%0A++++++++++++++++setBlockIndexCandidates.insert%28pindex%29%3B%0A++++++++++++%7D%0A++++++++++++%2F%2F%E4%BB%8EmapBlocksUnlinked%E4%B8%AD%E9%80%92%E5%BD%92%E5%88%A0%E9%99%A4%0A++++++++++++std%3A%3Apair%26lt%3Bstd%3A%3Amultimap%26lt%3BCBlockIndex*%2C+CBlockIndex*%26gt%3B%3A%3Aiterator%2C+std%3A%3Amultimap%26lt%3BCBlockIndex*%2C+CBlockIndex*%26gt%3B%3A%3Aiterator%26gt%3B+range+%3D+mapBlocksUnlinked.equal_range%28pindex%29%3B%0A++++++++++++while+%28range.first+%21%3D+range.second%29+%7B%0A++++++++++++++++std%3A%3Amultimap%26lt%3BCBlockIndex*%2C+CBlockIndex*%26gt%3B%3A%3Aiterator+it+%3D+range.first%3B%0A++++++++++++++++queue.push_back%28it-%26gt%3Bsecond%29%3B%0A++++++++++++++++range.first%2B%2B%3B%0A++++++++++++++++mapBlocksUnlinked.erase%28it%29%3B%0A++++++++++++%7D%0A++++++++%7D%0A++++%7D+else+%7B%0A++++++++%2F%2F%E5%A6%82%E6%9E%9C%E8%8A%82%E7%82%B9%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8F%AA%E6%9C%89%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E8%BF%98%E6%9C%AA%E6%94%B6%E5%88%B0%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%88%99%E5%8A%A0%E5%85%A5mapBlocksUnlinked%0A++++++++if+%28pindexNew-%26gt%3Bpprev+%26amp%3B%26amp%3B+pindexNew-%26gt%3Bpprev-%26gt%3BIsValid%28BLOCK_VALID_TREE%29%29+%7B%0A++++++++++++mapBlocksUnlinked.insert%28std%3A%3Amake_pair%28pindexNew-%26gt%3Bpprev%2C+pindexNew%29%29%3B%0A++++++++%7D%0A++++%7D%0A%0A++++return+true%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%8A%E9%9D%A2%E4%BB%A3%E7%A0%81%E6%9C%89%E5%87%A0%E7%82%B9%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B%28i%29%26nbsp%3B+%E5%A6%82%E6%9E%9C%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97C%E7%9A%84%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%BD%86%E6%98%AF%E5%AE%83%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97B%E5%8F%AA%E6%9C%89%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%88%99%E4%BC%9A%E5%9C%A8mapBlocksUnlinked%E8%A1%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%B8%80%E9%A1%B9B-%26gt%3BC%EF%BC%8C%E8%A1%A8%E7%A4%BA%E6%96%B0%E5%8C%BA%E5%9D%97C%E5%B7%B2%E7%BB%8F%E6%9C%89%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BD%86%E5%85%B6%E7%88%B6%E5%8C%BA%E5%9D%97%E5%B0%9A%E4%B8%8D%E5%AE%8C%E6%95%B4%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B%28ii%29+%E5%81%87%E8%AE%BE%E5%BD%93%E5%89%8DmapBlocksUnlinked%E8%A1%A8%E4%B8%AD%E5%8C%85%E5%90%ABB-%26gt%3BC%EF%BC%8C+B-%26gt%3BD%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%E6%94%B6%E5%88%B0%E4%BA%86B%EF%BC%8CC%EF%BC%8CD%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%8C%BA%E5%9D%97C%E5%92%8C%E5%8C%BA%E5%9D%97D%E9%83%BD%E4%BB%A5%E5%8C%BA%E5%9D%97B%E4%B8%BA%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%88%E5%8C%BA%E5%9D%97%E9%93%BE%E5%88%86%E5%8F%89%EF%BC%8C%E6%AF%94%E5%A6%82%E4%B8%A4%E4%B8%AA%E7%9F%BF%E5%B7%A5%E5%9C%A8%E5%87%A0%E4%B9%8E%E5%90%8C%E4%B8%80%E6%97%B6%E9%97%B4%E6%8C%96%E5%87%BA%E4%BA%86C%E5%92%8CD%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E4%BA%86C%E5%92%8CD%E7%9A%84%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%AD%A4%E6%97%B6mapBlocksUnlinked%E4%B8%AD%E5%B0%B1%E4%BC%9A%E5%AD%98%E5%9C%A8B-%26gt%3BC%EF%BC%8CB-%26gt%3BD%E4%B8%A4%E9%A1%B9%E3%80%82%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%E6%94%B6%E5%88%B0%E4%BA%86B%E5%8C%BA%E5%9D%97%E7%9A%84%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%B0%86B-%26gt%3BC%E5%92%8CB-%26gt%3BD%E7%A7%BB%E9%99%A4%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%B0%86B%E3%80%81C%E3%80%81D%E5%8A%A0%E5%85%A5%E5%88%B0setBlockIndexCandiates%E4%B8%AD%E4%BD%9C%E4%B8%BA%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%EF%BC%9B%3C%2Fp%3E%0A++%3Ch3%3E2.4.3+%E5%BB%B6%E9%95%BF%E5%8C%BA%E5%9D%97%E9%93%BE%3C%2Fh3%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%BB%8F%E8%BF%87%E4%B9%8B%E5%89%8D%E7%9A%84%E6%AD%A5%E9%AA%A4%EF%BC%8C%E6%96%B0%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E5%B7%B2%E7%BB%8F%E5%8A%A0%E5%85%A5%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%EF%BC%8C%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%B0%B1%E8%A6%81%E5%B0%9D%E8%AF%95%E5%8E%BB%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E4%BA%86%EF%BC%8CProcessNewBlock%E7%9A%84%E6%9C%80%E5%90%8E%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%BB%B6%E9%95%BF%E6%9C%AC%E5%9C%B0%E6%9C%80%E9%95%BF%EF%BC%88%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%89%E7%9A%84%E9%93%BE%0A++++if+%28%21g_chainstate.ActivateBestChain%28state%2C+chainparams%2C+pblock%29%29%0A++++++++return+error%28%22%25s%3A+ActivateBestChain+failed+%28%25s%29%22%2C+__func__%2C+FormatStateMessage%28state%29%29%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%80%9A%E8%BF%87ActivateBestChain%E6%9D%A5%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F**%0A+*+Make+the+best+chain+active%2C+in+multiple+steps.+The+result+is+either+failure%0A+*+or+an+activated+best+chain.+pblock+is+either+nullptr+or+a+pointer+to+a+block%0A+*+that+is+already+loaded+%28to+avoid+loading+it+again+from+disk%29.%0A+*%0A+*+ActivateBestChain+is+split+into+steps+%28see+ActivateBestChainStep%29+so+that%0A+*+we+avoid+holding+cs_main+for+an+extended+period+of+time%3B+the+length+of+this%0A+*+call+may+be+quite+long+during+reindexing+or+a+substantial+reorg.%0A+*%2F%0Abool+CChainState%3A%3AActivateBestChain%28CValidationState+%26amp%3Bstate%2C+const+CChainParams%26amp%3B+chainparams%2C+std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B+pblock%29+%7B%0A++++%2F%2F+Note+that+while+we%27re+often+called+here+from+ProcessNewBlock%2C+this+is%0A++++%2F%2F+far+from+a+guarantee.+Things+in+the+P2P%2FRPC+will+often+end+up+calling%0A++++%2F%2F+us+in+the+middle+of+ProcessNewBlock+-+do+not+assume+pblock+is+set%0A++++%2F%2F+sanely+for+performance+or+correctness%21%0A++++AssertLockNotHeld%28cs_main%29%3B%0A%0A++++CBlockIndex+*pindexMostWork+%3D+nullptr%3B%0A++++CBlockIndex+*pindexNewTip+%3D+nullptr%3B%0A++++int+nStopAtHeight+%3D+gArgs.GetArg%28%22-stopatheight%22%2C+DEFAULT_STOPATHEIGHT%29%3B%0A++++do+%7B%0A++++++++boost%3A%3Athis_thread%3A%3Ainterruption_point%28%29%3B%0A%0A++++++++if+%28GetMainSignals%28%29.CallbacksPending%28%29+%26gt%3B+10%29+%7B%0A++++++++++++%2F%2F+Block+until+the+validation+queue+drains.+This+should+largely%0A++++++++++++%2F%2F+never+happen+in+normal+operation%2C+however+may+happen+during%0A++++++++++++%2F%2F+reindex%2C+causing+memory+blowup+if+we+run+too+far+ahead.%0A++++++++++++SyncWithValidationInterfaceQueue%28%29%3B%0A++++++++%7D%0A%0A++++++++const+CBlockIndex+*pindexFork%3B%0A++++++++bool+fInitialDownload%3B%0A++++++++%7B%0A++++++++++++LOCK%28cs_main%29%3B%0A++++++++++++ConnectTrace+connectTrace%28mempool%29%3B+%2F%2F+Destructed+before+cs_main+is+unlocked%0A%0A++++++++++++%2F%2F%E6%8B%BF%E5%88%B0%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%0A++++++++++++CBlockIndex+*pindexOldTip+%3D+chainActive.Tip%28%29%3B%0A++++++++++++if+%28pindexMostWork+%3D%3D+nullptr%29+%7B%0A++++++++++++++++%2F%2F%E6%9F%A5%E6%89%BE%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9C%80%E5%A4%A7%E7%9A%84%E5%88%86%E6%94%AF%E7%9A%84%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%0A++++++++++++++++pindexMostWork+%3D+FindMostWorkChain%28%29%3B%0A++++++++++++%7D%0A%0A++++++++++++%2F%2F+Whether+we+have+anything+to+do+at+all.%0A++++++++++++%2F%2F%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BD%93%E5%89%8D%E7%9A%84%E9%A1%B6%E7%82%B9%E5%B7%B2%E7%BB%8F%E6%98%AF%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%8C%E4%B8%8D%E7%94%A8%E5%81%9A%E4%BB%BB%E4%BD%95%E4%BA%8B%E6%83%85%EF%BC%8C%E8%BF%94%E5%9B%9E%0A++++++++++++if+%28pindexMostWork+%3D%3D+nullptr+%7C%7C+pindexMostWork+%3D%3D+chainActive.Tip%28%29%29%0A++++++++++++++++return+true%3B%0A%0A++++++++++++bool+fInvalidFound+%3D+false%3B%0A++++++++++++std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B+nullBlockPtr%3B%0A++++++++++++%2F%2F%E5%B0%86%E6%89%BE%E5%88%B0%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9C%80%E5%A4%A7%E7%9A%84%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%0A++++++++++++if+%28%21ActivateBestChainStep%28state%2C+chainparams%2C+pindexMostWork%2C+pblock+%26amp%3B%26amp%3B+pblock-%26gt%3BGetHash%28%29+%3D%3D+pindexMostWork-%26gt%3BGetBlockHash%28%29+%3F+pblock+%3A+nullBlockPtr%2C+fInvalidFound%2C+connectTrace%29%29%0A++++++++++++++++return+false%3B%0A%0A++++++++++++if+%28fInvalidFound%29+%7B%0A++++++++++++++++%2F%2F+Wipe+cache%2C+we+may+need+another+branch+now.%0A++++++++++++++++pindexMostWork+%3D+nullptr%3B%0A++++++++++++%7D%0A++++++++++++pindexNewTip+%3D+chainActive.Tip%28%29%3B%0A++++++++++++pindexFork+%3D+chainActive.FindFork%28pindexOldTip%29%3B%0A++++++++++++fInitialDownload+%3D+IsInitialBlockDownload%28%29%3B%0A%0A++++++++++++for+%28const+PerBlockConnectTrace%26amp%3B+trace+%3A+connectTrace.GetBlocksConnected%28%29%29+%7B%0A++++++++++++++++assert%28trace.pblock+%26amp%3B%26amp%3B+trace.pindex%29%3B%0A++++++++++++++++GetMainSignals%28%29.BlockConnected%28trace.pblock%2C+trace.pindex%2C+trace.conflictedTxs%29%3B%0A++++++++++++%7D%0A%0A++++++++++++%2F%2F%E9%80%9A%E7%9F%A5%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9B%B4%E6%96%B0%0A++++++++++++%2F%2F+Notify+external+listeners+about+the+new+tip.%0A++++++++++++%2F%2F+Enqueue+while+holding+cs_main+to+ensure+that+UpdatedBlockTip+is+called+in+the+order+in+which+blocks+are+connected%0A++++++++++++GetMainSignals%28%29.UpdatedBlockTip%28pindexNewTip%2C+pindexFork%2C+fInitialDownload%29%3B%0A%0A++++++++++++%2F%2F+Always+notify+the+UI+if+a+new+block+tip+was+connected%0A++++++++++++if+%28pindexFork+%21%3D+pindexNewTip%29+%7B%0A++++++++++++++++uiInterface.NotifyBlockTip%28fInitialDownload%2C+pindexNewTip%29%3B%0A++++++++++++%7D%0A++++++++%7D%0A++++++++%2F%2F+When+we+reach+this+point%2C+we+switched+to+a+new+tip+%28stored+in+pindexNewTip%29.%0A%0A++++++++if+%28nStopAtHeight+%26amp%3B%26amp%3B+pindexNewTip+%26amp%3B%26amp%3B+pindexNewTip-%26gt%3BnHeight+%26gt%3B%3D+nStopAtHeight%29+StartShutdown%28%29%3B%0A%0A++++++++%2F%2F+We+check+shutdown+only+after+giving+ActivateBestChainStep+a+chance+to+run+once+so+that+we%0A++++++++%2F%2F+never+shutdown+before+connecting+the+genesis+block+during+LoadChainTip%28%29.+Previously+this%0A++++++++%2F%2F+caused+an+assert%28%29+failure+during+shutdown+in+such+cases+as+the+UTXO+DB+flushing+checks%0A++++++++%2F%2F+that+the+best+block+hash+is+non-null.%0A++++++++if+%28ShutdownRequested%28%29%29%0A++++++++++++break%3B%0A++++%7D+while+%28pindexNewTip+%21%3D+pindexMostWork%29%3B%0A++++CheckBlockIndex%28chainparams.GetConsensus%28%29%29%3B%0A%0A++++%2F%2F+Write+changes+periodically+to+disk%2C+after+relay.%0A++++if+%28%21FlushStateToDisk%28chainparams%2C+state%2C+FlushStateMode%3A%3APERIODIC%29%29+%7B%0A++++++++return+false%3B%0A++++%7D%0A%0A++++return+true%3B%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Ch4%3E2.4.3.1+%E6%9F%A5%E6%89%BE%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%88%86%E6%94%AF%3C%2Fh4%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%80%9A%E8%BF%87FindMostWorkChain%E6%9F%A5%E6%89%BE%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%80%83%E8%99%91%E4%B9%8B%E5%89%8D%E7%9A%84%E4%BE%8B%E5%AD%90%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E8%AE%BE%E5%BD%93%E5%89%8D%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%B7%E6%9C%89%E5%A6%82%E4%B8%8B%E5%BD%A2%E6%80%81%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%3Cspan+style%3D%22color%3A%23ff0000%3B%22%3EA%26nbsp%3B+%26nbsp%3B%E2%80%94%E2%80%94%26nbsp%3B+B%3C%2Fspan%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%5C%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%26nbsp%3BC%26nbsp%3B+%26nbsp%3B-------+D%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+B%E6%98%AF%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8CB%E5%92%8CC%E5%8C%BA%E5%9D%97%E9%83%BD%E4%BB%A5A%E4%B8%BA%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%88%E5%8F%AF%E8%83%BD%E6%9C%89%E4%B8%A4%E4%B8%AA%E7%9F%BF%E5%B7%A5%E5%87%A0%E4%B9%8E%E5%90%8C%E6%97%B6%E6%8C%96%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%E5%92%8CC%EF%BC%8C%E8%8A%82%E7%82%B9%E5%85%88%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%BB%A5%E5%8C%BA%E5%9D%97B%E6%9D%A5%E5%BB%B6%E9%95%BF%E4%BA%86%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%89%EF%BC%8C%E6%AD%A4%E6%97%B6%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97D%EF%BC%8CD%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E4%B8%BAC%EF%BC%8C%E5%9B%A0%E4%B8%BAD%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%A6%81%E6%AF%94B%E9%AB%98%EF%BC%8C%E5%9B%A0%E6%AD%A4%E8%8A%82%E7%82%B9%E9%9C%80%E8%A6%81%E5%88%87%E6%8D%A2%E6%9C%80%E9%95%BF%E9%93%BE%E5%88%B0A%E3%80%81C%E3%80%81D%EF%BC%8C%E5%85%B7%E4%BD%93%E5%81%9A%E6%B3%95%E6%98%AF%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%85%88%E4%BB%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E6%96%AD%E5%BC%80%E5%8C%BA%E5%9D%97B%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E5%9B%9E%E9%80%80%E5%88%B0%E5%8C%BA%E5%9D%97A%EF%BC%8C%E6%9C%80%E5%90%8E%E4%BE%9D%E6%AC%A1%E5%9C%A8%E8%BF%9E%E6%8E%A5%E5%8C%BA%E5%9D%97C%E5%92%8CD%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%9D%A5%E7%9C%8B%E7%9C%8B%E5%A6%82%E4%BD%95%E6%9F%A5%E6%89%BE%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F**%0A+*+Return+the+tip+of+the+chain+with+the+most+work+in+it%2C+that+isn%27t%0A+*+known+to+be+invalid+%28it%27s+however+far+from+certain+to+be+valid%29.%0A+*%2F%0ACBlockIndex*+CChainState%3A%3AFindMostWorkChain%28%29+%7B%0A++++do+%7B%0A++++++++CBlockIndex+*pindexNew+%3D+nullptr%3B%0A%0A++++++++%2F%2F+Find+the+best+candidate+header.%0A++++++++%2F%2F%E4%BB%8E%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%E6%89%BE%E5%88%B0%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9C%80%E5%A4%A7%E7%9A%84%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%0A++++++++%7B%0A++++++++++++std%3A%3Aset%26lt%3BCBlockIndex*%2C+CBlockIndexWorkComparator%26gt%3B%3A%3Areverse_iterator+it+%3D+setBlockIndexCandidates.rbegin%28%29%3B%0A++++++++++++if+%28it+%3D%3D+setBlockIndexCandidates.rend%28%29%29%0A++++++++++++++++return+nullptr%3B%0A++++++++++++pindexNew+%3D+*it%3B%0A++++++++%7D%0A%0A++++++++%2F%2F+Check+whether+all+blocks+on+the+path+between+the+currently+active+chain+and+the+candidate+are+valid.%0A++++++++%2F%2F+Just+going+until+the+active+chain+is+an+optimization%2C+as+we+know+all+blocks+in+it+are+valid+already.%0A++++++++CBlockIndex+*pindexTest+%3D+pindexNew%3B%0A++++++++bool+fInvalidAncestor+%3D+false%3B%0A++++++++%2F%2F%E4%BB%8E%E9%80%89%E5%87%BA%E7%9A%84%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E5%BC%80%E5%A7%8B%E5%9B%9E%E6%9C%94%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%9B%9E%E6%9C%94%E5%88%B0%E5%AD%98%E5%9C%A8%E4%BA%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E7%9A%84%E7%A5%96%E5%85%88%E5%8C%BA%E5%9D%97%E4%B8%BA%E6%AD%A2%E3%80%82%0A++++++++%2F%2F%E4%BE%8B%E5%A6%82%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E6%98%AFA%EF%BC%8C%E7%84%B6%E5%90%8E%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E6%8C%89%E5%B7%A5%E4%BD%9C%E9%87%8F%E4%BE%9D%E6%AC%A1%E6%98%AFB%EF%BC%8CC%EF%BC%8CD%EF%BC%8CB%E6%98%AFC%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%8CC%E6%98%AFD%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%8C%0A++++++++%2F%2F%E5%88%99%E4%BB%8ED%E5%BC%80%E5%A7%8B%E5%9B%9E%E6%9C%94%EF%BC%8C%E4%B8%80%E7%9B%B4%E5%88%B0%E5%8C%BA%E5%9D%97A%E4%B8%BA%E6%AD%A2%E3%80%82setBlockIndexCandidates%E4%B8%AD%E5%8C%85%E5%90%AB%26lt%3BB%2C+C%2C+D%26gt%3B%0A++++++++while+%28pindexTest+%26amp%3B%26amp%3B+%21chainActive.Contains%28pindexTest%29%29+%7B%0A++++++++++++assert%28pindexTest-%26gt%3BnChainTx+%7C%7C+pindexTest-%26gt%3BnHeight+%3D%3D+0%29%3B%0A%0A++++++++++++%2F%2F+Pruned+nodes+may+have+entries+in+setBlockIndexCandidates+for%0A++++++++++++%2F%2F+which+block+files+have+been+deleted.++Remove+those+as+candidates%0A++++++++++++%2F%2F+for+the+most+work+chain+if+we+come+across+them%3B+we+can%27t+switch%0A++++++++++++%2F%2F+to+a+chain+unless+we+have+all+the+non-active-chain+parent+blocks.%0A++++++++++++%2F%2F%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E6%98%AF%E4%B8%80%E4%B8%AA%E5%9D%8F%E5%8C%BA%E5%9D%97%0A++++++++++++bool+fFailedChain+%3D+pindexTest-%26gt%3BnStatus+%26amp%3B+BLOCK_FAILED_MASK%3B%0A++++++++++++%2F%2F%E6%98%AF%E5%90%A6%E5%B0%9A%E6%9C%AA%E6%94%B6%E5%88%B0%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%0A++++++++++++bool+fMissingData+%3D+%21%28pindexTest-%26gt%3BnStatus+%26amp%3B+BLOCK_HAVE_DATA%29%3B%0A++++++++++++if+%28fFailedChain+%7C%7C+fMissingData%29+%7B%0A++++++++++++++++%2F%2F+Candidate+chain+is+not+usable+%28either+invalid+or+missing+data%29%0A++++++++++++++++if+%28fFailedChain+%26amp%3B%26amp%3B+%28pindexBestInvalid+%3D%3D+nullptr+%7C%7C+pindexNew-%26gt%3BnChainWork+%26gt%3B+pindexBestInvalid-%26gt%3BnChainWork%29%29%0A++++++++++++++++++++pindexBestInvalid+%3D+pindexNew%3B%0A++++++++++++++++%2F%2F%E5%81%87%E8%AE%BE%E4%BB%8EA-%26gt%3BD%E7%9A%84%E8%B7%AF%E5%BE%84%E4%B8%8A%EF%BC%8C%E5%BD%93%E5%9B%9E%E6%9C%94%E5%88%B0%E5%8C%BA%E5%9D%97B%E6%97%B6%E5%8F%91%E7%8E%B0B%E7%9A%84%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%E5%B0%9A%E6%9C%AA%E6%94%B6%E5%88%B0%EF%BC%8C%E5%88%99%E5%90%91mapBlocksUnlinked%E4%B8%AD%E6%B7%BB%E5%8A%A0%26lt%3BB%2CC%26gt%3B%2C%26lt%3BC%2CD%26gt%3B%EF%BC%8C%0A++++++++++++++++%2F%2F%E5%90%8C%E6%97%B6%E5%B0%86B%E3%80%81C%E5%92%8CD%E4%BB%8E%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88setBlockIndexCandidates%E4%B8%AD%E7%A7%BB%E9%99%A4%0A++++++++++++++++CBlockIndex+*pindexFailed+%3D+pindexNew%3B%0A++++++++++++++++%2F%2F+Remove+the+entire+chain+from+the+set.%0A++++++++++++++++while+%28pindexTest+%21%3D+pindexFailed%29+%7B%0A++++++++++++++++++++if+%28fFailedChain%29+%7B%0A++++++++++++++++++++++++pindexFailed-%26gt%3BnStatus+%7C%3D+BLOCK_FAILED_CHILD%3B%0A++++++++++++++++++++%7D+else+if+%28fMissingData%29+%7B%0A++++++++++++++++++++++++%2F%2F+If+we%27re+missing+data%2C+then+add+back+to+mapBlocksUnlinked%2C%0A++++++++++++++++++++++++%2F%2F+so+that+if+the+block+arrives+in+the+future+we+can+try+adding%0A++++++++++++++++++++++++%2F%2F+to+setBlockIndexCandidates+again.%0A++++++++++++++++++++++++mapBlocksUnlinked.insert%28std%3A%3Amake_pair%28pindexFailed-%26gt%3Bpprev%2C+pindexFailed%29%29%3B%0A++++++++++++++++++++%7D%0A++++++++++++++++++++setBlockIndexCandidates.erase%28pindexFailed%29%3B%0A++++++++++++++++++++pindexFailed+%3D+pindexFailed-%26gt%3Bpprev%3B%0A++++++++++++++++%7D%0A++++++++++++++++setBlockIndexCandidates.erase%28pindexTest%29%3B%0A++++++++++++++++fInvalidAncestor+%3D+true%3B%0A++++++++++++++++%2F%2F%E8%B7%B3%E5%87%BA%E6%9C%AC%E8%BD%AE%E5%BE%AA%E7%8E%AF%0A++++++++++++++++break%3B%0A++++++++++++%7D%0A++++++++++++%2F%2F%E5%90%91%E5%89%8D%E5%9B%9E%E6%9C%94%E5%88%B0%E7%88%B6%E5%8C%BA%E5%9D%97%0A++++++++++++pindexTest+%3D+pindexTest-%26gt%3Bpprev%3B%0A++++++++%7D%0A++++++++if+%28%21fInvalidAncestor%29%0A++++++++++++return+pindexNew%3B%0A++++%7D+while%28true%29%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%B3%A8%E6%84%8F%E8%BF%99%E4%B8%AA%E7%AE%97%E6%B3%95%EF%BC%9A%E9%A6%96%E5%85%88%E6%98%AF%E4%BB%8E%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9C%80%E5%A4%A7%E7%9A%84%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E5%BC%80%E5%A7%8B%EF%BC%8C%E9%80%89%E5%AE%9A%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97B%5Bn%5D%EF%BC%8C%E7%84%B6%E5%90%8E%E6%B2%BF%E7%9D%80%E7%88%B6%E5%8C%BA%E5%9D%97%E5%90%91%E5%89%8D%E5%9B%9E%E6%9C%94%EF%BC%8C%E4%B8%80%E6%97%A6%E8%B7%AF%E5%BE%84%E4%B8%8A%E5%87%BA%E7%8E%B0%E6%9C%AA%E6%94%B6%E5%88%B0%E5%AE%8C%E6%95%B4%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8C%BA%E5%9D%97%28%E5%81%87%E8%AE%BE%E4%B8%BAB%5Bm%5D%EF%BC%8C+m+%26lt%3B+n%29%EF%BC%8C%E5%88%99%E5%B0%86B%5Bm%5D%E5%88%B0B%5Bn%5D%E5%85%A8%E9%83%A8%E4%BB%8E%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%E7%A7%BB%E9%99%A4%EF%BC%8C%E5%90%8C%E6%97%B6%E5%9C%A8mapBlockUnlinked%E4%B8%AD%E6%B7%BB%E5%8A%A0B%5Bm%5D-%26gt%3BB%5Bm%2B1%5D%EF%BC%8C....%EF%BC%8CB%5Bn-1%5D-%26gt%3BB%5Bn%5D%EF%BC%8C%E8%BF%99%E6%A0%B7%E7%9A%84%E7%9B%AE%E7%9A%84%E6%98%AF%E5%BD%93%E5%B0%86%E6%9D%A5%E6%94%B6%E5%88%B0%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97B%5Bm%5D%E4%BB%A5%E5%90%8E%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%87%8D%E6%96%B0%E5%B0%86B%5Bm%5D....B%5Bn%5D%E5%8A%A0%E5%85%A5%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E4%B8%AD%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%94%A8%E6%96%87%E5%AD%97%E8%AF%B4%E6%98%8E%E5%8F%AF%E8%83%BD%E4%B8%8D%E6%98%AF%E5%BE%88%E6%B8%85%E6%A5%9A%EF%BC%8C%E8%BF%99%E9%87%8C%E5%86%8D%E4%B8%BE%E4%B8%AA%E4%BE%8B%E5%AD%90%EF%BC%8C%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180713170901100%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%9B%BE%E4%B8%ADA%E4%B8%BA%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8C%E6%AD%A4%E6%97%B6%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%98%E5%9C%A8%E4%B8%89%E6%9D%A1%E5%88%86%E5%8F%89%EF%BC%9AG3-%26gt%3BA%EF%BC%8CF2-%26gt%3BA%EF%BC%8CE-%26gt%3BA%EF%BC%8C%E5%85%B6%E4%B8%AD%E5%B7%A5%E4%BD%9C%E9%87%8FG3%26gt%3BF2%26gt%3BE%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%AF%BB%E6%89%BE%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%88%86%E5%8F%89%E6%97%B6%EF%BC%8C%E5%85%88%E4%BB%8E%E5%80%99%E9%80%89%E9%9B%86%E5%90%88%E4%B8%AD%E7%9A%84G3%E5%BC%80%E5%A7%8B%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E4%BB%8EG3%E6%B2%BF%E7%9D%80%E7%88%B6%E5%8C%BA%E5%9D%97%E6%8C%87%E9%92%88%E5%9B%9E%E6%9C%94%EF%BC%8C%E5%BD%93%E5%9B%9E%E6%9C%94%E5%88%B0G1%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%91%E7%8E%B0G1%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%98%E6%B2%A1%E6%9C%89%E5%88%B0%EF%BC%88nStatus+%26amp%3B+BLOCK_HAVE_DATA%E4%B8%8D%E6%88%90%E7%AB%8B%EF%BC%89%EF%BC%8C%E4%BA%8E%E6%98%AF%E5%B0%86G3%E3%80%81G2%E3%80%81G1%E4%BB%8EsetBlockIndexCandidates%E4%B8%AD%E7%A7%BB%E9%99%A4%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%9C%A8mapBlocksUnlinked%E4%B8%AD%E6%B7%BB%E5%8A%A0%26lt%3BG2%2CG3%26gt%3B%2C%26lt%3BG1%2CG2%26gt%3B%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E7%84%B6%E5%90%8E%E9%80%89%E5%AE%9A%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%AC%A1%E5%B0%8F%E7%9A%84%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97F2%E8%BF%9B%E8%A1%8C%E5%90%8C%E6%A0%B7%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%E8%BF%99%E4%B8%80%E6%AC%A1%E7%94%B1%E4%BA%8E%E4%BB%8EF2-%26gt%3BA%E7%9A%84%E8%B7%AF%E5%BE%84%E4%B8%8A%E6%89%80%E6%9C%89%E7%9A%84%E5%8C%BA%E5%9D%97%E9%83%BD%E6%AD%A3%E5%B8%B8%E5%B9%B6%E4%B8%94%E9%83%BD%E6%9C%89%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BA%8E%E6%98%AFFindMostWorkChain%E8%BF%94%E5%9B%9E%E5%8C%BA%E5%9D%97F2%EF%BC%8C%E4%BB%8E%E8%80%8CF2-%26gt%3BF1-%26gt%3BA%E5%B0%B1%E6%98%AF%E6%9C%AC%E6%AC%A1%E6%89%BE%E5%88%B0%E7%9A%84%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%88%86%E5%8F%89%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%283%29+%E5%88%87%E6%8D%A2%E4%B8%BB%E9%93%BE%EF%BC%8C%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84F2-%26gt%3BF1-%26gt%3BA%E6%88%90%E4%B8%BA%E6%96%B0%E7%9A%84%E4%B8%BB%E9%93%BE%EF%BC%8CF2%E4%B8%BA%E6%96%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%8C%E5%B0%86%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%E7%9A%84F1%EF%BC%8CF2%E4%BB%A5%E5%8F%8A%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%B7%9F%E5%B0%8F%E7%9A%84E%E7%A7%BB%E9%99%A4%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%284%29+%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E5%90%8E%EF%BC%8C%E5%8C%BA%E5%9D%97G1%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%B0%E8%BE%BE%E4%BA%86%EF%BC%8C%E4%BA%8E%E6%98%AF%E9%80%92%E5%BD%92%E7%A7%BB%E9%99%A4mapBlocksUnlinked%E4%B8%AD%E7%9A%84%26lt%3BG1%2CG2%26gt%3B%2C%26lt%3BG2%2CG3%26gt%3B%E9%A1%B9%EF%BC%8C%E5%90%8C%E6%97%B6%E5%B0%86G1%EF%BC%8CG2%EF%BC%8CG3%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%285%29+%E8%BF%99%E4%B8%80%E6%AC%A1%E7%94%B1%E4%BA%8EG3%E7%9A%84%E5%B7%A5%E4%BD%9C%E9%87%8F%E6%9C%80%E5%A4%A7%EF%BC%8C%E5%88%87%E6%8D%A2%E5%88%B0G3-%26gt%3BA%E4%B8%BA%E6%96%B0%E7%9A%84%E4%B8%BB%E9%93%BE%EF%BC%8C%E5%B0%86%E5%8E%9F%E6%9D%A5%E4%B8%BB%E9%93%BE%E4%B8%8A%E7%9A%84F2%EF%BC%8CF1%E4%BB%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E6%96%AD%E5%BC%80%28DisconnectBlock%29%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E2.4.3.2+%E6%BF%80%E6%B4%BB%E6%9C%80%E9%95%BF%E9%93%BE%3C%2Fh4%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%BD%93FindMostWorkChain%E6%89%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%88%86%E6%94%AF%E5%90%8E%EF%BC%8C%E5%B0%B1%E9%9C%80%E8%A6%81%E5%B0%86%E4%B8%BB%E9%93%BE%E5%88%87%E6%8D%A2%E5%88%B0%E8%AF%A5%E5%88%86%E6%94%AF%E4%B8%8A%E3%80%82%E5%AD%98%E5%9C%A8%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BD%93%E5%89%8D%E5%B7%B2%E7%BB%8F%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%88%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E5%B7%B2%E7%BB%8F%E6%98%AF%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BA%86%EF%BC%89%EF%BC%8C%E4%BB%80%E4%B9%88%E9%83%BD%E4%B8%8D%E9%9C%80%E8%A6%81%E5%81%9A%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F%2F%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BD%93%E5%89%8D%E7%9A%84%E9%A1%B6%E7%82%B9%E5%B7%B2%E7%BB%8F%E6%98%AF%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%8C%E4%B8%8D%E7%94%A8%E5%81%9A%E4%BB%BB%E4%BD%95%E4%BA%8B%E6%83%85%EF%BC%8C%E8%BF%94%E5%9B%9E%0A++++++++++++if+%28pindexMostWork+%3D%3D+nullptr+%7C%7C+pindexMostWork+%3D%3D+chainActive.Tip%28%29%29%0A++++++++++++++++return+true%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E5%85%B6%E4%BB%96%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E8%B0%83%E7%94%A8ActivateBestChainStep%E6%9D%A5%E5%A4%84%E7%90%86%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F%2F%E5%B0%86%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%0A++++++++++++if+%28%21ActivateBestChainStep%28state%2C+chainparams%2C+pindexMostWork%2C+pblock+%26amp%3B%26amp%3B+pblock-%26gt%3BGetHash%28%29+%3D%3D+pindexMostWork-%26gt%3BGetBlockHash%28%29+%3F+pblock+%3A+nullBlockPtr%2C+fInvalidFound%2C+connectTrace%29%29%0A++++++++++++++++return+false%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%9D%A5%E7%9C%8B%E7%9C%8BActivateBestChainStep%E7%9A%84%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F**%0A+*+Try+to+make+some+progress+towards+making+pindexMostWork+the+active+block.%0A+*+pblock+is+either+nullptr+or+a+pointer+to+a+CBlock+corresponding+to+pindexMostWork.%0A+*%2F%0Abool+CChainState%3A%3AActivateBestChainStep%28CValidationState%26amp%3B+state%2C+const+CChainParams%26amp%3B+chainparams%2C+CBlockIndex*+pindexMostWork%2C+const+std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B%26amp%3B+pblock%2C+bool%26amp%3B+fInvalidFound%2C+ConnectTrace%26amp%3B+connectTrace%29%0A%7B%0A++++AssertLockHeld%28cs_main%29%3B%0A++++%2F%2F%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%0A++++const+CBlockIndex+*pindexOldTip+%3D+chainActive.Tip%28%29%3B%0A%0A++++%2F%2F%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9C%89%E5%88%86%E5%8F%89%EF%BC%8C%E6%89%BE%E5%88%B0%E5%88%86%E5%8F%89%E7%82%B9%0A++++const+CBlockIndex+*pindexFork+%3D+chainActive.FindFork%28pindexMostWork%29%3B%0A%0A++++%2F%2F+Disconnect+active+blocks+which+are+no+longer+in+the+best+chain.%0A++++%2F%2F%E4%BB%8E%E5%88%86%E5%8F%89%E7%82%B9%E5%88%B0%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BB%8E%E4%B8%BB%E9%93%BE%E4%B8%8A%E5%85%A8%E9%83%A8%E6%96%AD%E5%BC%80%0A++++bool+fBlocksDisconnected+%3D+false%3B%0A++++DisconnectedBlockTransactions+disconnectpool%3B%0A++++while+%28chainActive.Tip%28%29+%26amp%3B%26amp%3B+chainActive.Tip%28%29+%21%3D+pindexFork%29+%7B%0A++++++++if+%28%21DisconnectTip%28state%2C+chainparams%2C+%26amp%3Bdisconnectpool%29%29+%7B%0A++++++++++++%2F%2F+This+is+likely+a+fatal+error%2C+but+keep+the+mempool+consistent%2C%0A++++++++++++%2F%2F+just+in+case.+Only+remove+from+the+mempool+in+this+case.%0A++++++++++++%2F%2F%E6%96%AD%E5%BC%80%E5%8C%BA%E5%9D%97%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8F%91%E7%94%9F%E9%94%99%E8%AF%AF%EF%BC%8C%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%E4%BA%A4%E6%98%93%E6%B1%A0%0A++++++++++++UpdateMempoolForReorg%28disconnectpool%2C+false%29%3B%0A++++++++++++return+false%3B%0A++++++++%7D%0A++++++++fBlocksDisconnected+%3D+true%3B%0A++++%7D%0A%0A++++%2F%2F+Build+list+of+new+blocks+to+connect.%0A++++std%3A%3Avector%26lt%3BCBlockIndex*%26gt%3B+vpindexToConnect%3B%0A++++bool+fContinue+%3D+true%3B%0A++++int+nHeight+%3D+pindexFork+%3F+pindexFork-%26gt%3BnHeight+%3A+-1%3B%0A++++while+%28fContinue+%26amp%3B%26amp%3B+nHeight+%21%3D+pindexMostWork-%26gt%3BnHeight%29+%7B%0A++++++++%2F%2F+Don%27t+iterate+the+entire+list+of+potential+improvements+toward+the+best+tip%2C+as+we+likely+only+need%0A++++++++%2F%2F+a+few+blocks+along+the+way.%0A++++++++%2F%2F%E8%AE%A1%E7%AE%97%E5%87%BA%E9%9C%80%E8%A6%81%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E7%9A%84%E5%8C%BA%E5%9D%97%0A++++++++int+nTargetHeight+%3D+std%3A%3Amin%28nHeight+%2B+32%2C+pindexMostWork-%26gt%3BnHeight%29%3B%0A++++++++vpindexToConnect.clear%28%29%3B%0A++++++++vpindexToConnect.reserve%28nTargetHeight+-+nHeight%29%3B%0A++++++++CBlockIndex+*pindexIter+%3D+pindexMostWork-%26gt%3BGetAncestor%28nTargetHeight%29%3B%0A++++++++while+%28pindexIter+%26amp%3B%26amp%3B+pindexIter-%26gt%3BnHeight+%21%3D+nHeight%29+%7B%0A++++++++++++vpindexToConnect.push_back%28pindexIter%29%3B%0A++++++++++++pindexIter+%3D+pindexIter-%26gt%3Bpprev%3B%0A++++++++%7D%0A++++++++nHeight+%3D+nTargetHeight%3B%0A%0A++++++++%2F%2F+Connect+new+blocks.%0A++++++++%2F%2F%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%0A++++++++for+%28CBlockIndex+*pindexConnect+%3A+reverse_iterate%28vpindexToConnect%29%29+%7B%0A++++++++++++if+%28%21ConnectTip%28state%2C+chainparams%2C+pindexConnect%2C+pindexConnect+%3D%3D+pindexMostWork+%3F+pblock+%3A+std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B%28%29%2C+connectTrace%2C+disconnectpool%29%29+%7B%0A++++++++++++++++if+%28state.IsInvalid%28%29%29+%7B%0A++++++++++++++++++++%2F%2F+The+block+violates+a+consensus+rule.%0A++++++++++++++++++++if+%28%21state.CorruptionPossible%28%29%29%0A++++++++++++++++++++++++InvalidChainFound%28vpindexToConnect.back%28%29%29%3B%0A++++++++++++++++++++state+%3D+CValidationState%28%29%3B%0A++++++++++++++++++++fInvalidFound+%3D+true%3B%0A++++++++++++++++++++fContinue+%3D+false%3B%0A++++++++++++++++++++break%3B%0A++++++++++++++++%7D+else+%7B%0A++++++++++++++++++++%2F%2F+A+system+error+occurred+%28disk+space%2C+database+error%2C+...%29.%0A++++++++++++++++++++%2F%2F+Make+the+mempool+consistent+with+the+current+tip%2C+just+in+case%0A++++++++++++++++++++%2F%2F+any+observers+try+to+use+it+before+shutdown.%0A++++++++++++++++++++%2F%2F%E6%9B%B4%E6%96%B0%E5%86%85%E5%AD%98%E4%BA%A4%E6%98%93%E6%B1%A0%0A++++++++++++++++++++UpdateMempoolForReorg%28disconnectpool%2C+false%29%3B%0A++++++++++++++++++++return+false%3B%0A++++++++++++++++%7D%0A++++++++++++%7D+else+%7B%0A++++++++++++++++%2F%2F%E6%96%B0%E5%8C%BA%E5%9D%97%E6%88%90%E5%8A%9F%E6%B7%BB%E5%8A%A0%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%8C%E5%B0%86%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%E6%89%80%E6%9C%89%E6%AF%94%E6%96%B0%E5%8C%BA%E5%9D%97%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%B0%91%E7%9A%84%E5%8C%BA%E5%9D%97%E7%A7%BB%E9%99%A4%0A++++++++++++++++PruneBlockIndexCandidates%28%29%3B%0A++++++++++++++++if+%28%21pindexOldTip+%7C%7C+chainActive.Tip%28%29-%26gt%3BnChainWork+%26gt%3B+pindexOldTip-%26gt%3BnChainWork%29+%7B%0A++++++++++++++++++++%2F%2F+We%27re+in+a+better+position+than+we+were.+Return+temporarily+to+release+the+lock.%0A++++++++++++++++++++fContinue+%3D+false%3B%0A++++++++++++++++++++break%3B%0A++++++++++++++++%7D%0A++++++++++++%7D%0A++++++++%7D%0A++++%7D%0A%0A++++%2F%2F%E5%A6%82%E6%9E%9C%E6%9C%89%E6%96%AD%E5%BC%80%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E9%9C%80%E8%A6%81%E6%9B%B4%E6%96%B0%E4%B8%80%E4%B8%8B%E5%86%85%E5%AD%98%E4%BA%A4%E6%98%93%E6%B1%A0%0A++++if+%28fBlocksDisconnected%29+%7B%0A++++++++%2F%2F+If+any+blocks+were+disconnected%2C+disconnectpool+may+be+non+empty.++Add%0A++++++++%2F%2F+any+disconnected+transactions+back+to+the+mempool.%0A++++++++UpdateMempoolForReorg%28disconnectpool%2C+true%29%3B%0A++++%7D%0A++++mempool.check%28pcoinsTip.get%28%29%29%3B%0A%0A++++%2F%2F+Callbacks%2Fnotifications+for+a+new+best+chain.%0A++++if+%28fInvalidFound%29%0A++++++++CheckForkWarningConditionsOnNewFork%28vpindexToConnect.back%28%29%29%3B%0A++++else%0A++++++++CheckForkWarningConditions%28%29%3B%0A%0A++++return+true%3B%0A%7D%0A%0A%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E7%9A%84%E9%80%BB%E8%BE%91%E5%8F%AF%E4%BB%A5%E5%88%86%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5%E6%9D%A5%E8%AF%B4%E6%98%8E%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%28i%29+%E5%8C%BA%E5%9D%97%E9%93%BE%E6%B2%A1%E6%9C%89%E5%88%86%E5%8F%89%EF%BC%8C%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9B%B4%E6%8E%A5%E5%BB%B6%E9%95%BF%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%3Cspan+style%3D%22color%3A%23ff0000%3B%22%3EA%3C%2Fspan%3E+---+B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E8%AE%BE%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E4%B8%BAA%EF%BC%8CB%E6%98%AF%E6%89%BE%E5%88%B0%E7%9A%84%E5%85%B7%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%B0%86B%E8%B0%83%E7%94%A8ConnectTip%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E8%BF%9E%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%8CB%E6%88%90%E4%B8%BA%E6%96%B0%E7%9A%84%E9%A1%B6%E7%82%B9%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%28ii%29+%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%98%E5%9C%A8%E5%88%86%E5%8F%89%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E8%AE%BE%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E7%8A%B6%E6%80%81%E5%A6%82%E4%B8%8B%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%3Cspan+style%3D%22color%3A%23ff0000%3B%22%3EA+%E2%80%94%E2%80%94+B%3C%2Fspan%3E%26nbsp%3B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%26nbsp%3B%5C%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+C+--------+D%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E6%98%AFB%EF%BC%8C%E7%84%B6%E5%90%8E%E7%BB%8F%E8%BF%87%E6%9F%A5%E6%89%BE%E6%89%BE%E5%88%B0%E4%BA%86%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E7%9A%84%E5%8C%BA%E5%9D%97%E4%B8%BAD%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%AD%A4%E6%97%B6%E9%80%9A%E8%BF%87FindFork%E5%87%BD%E6%95%B0%EF%BC%8C%E6%89%BE%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%88%86%E5%8F%89%E7%82%B9%E5%8C%BA%E5%9D%97A%EF%BC%8C%E4%BA%8E%E6%98%AF%E5%B0%86%E5%8C%BA%E5%9D%97B%E4%BB%8E%E5%8C%BA%E5%9D%97%E9%93%BE%E6%96%AD%E5%BC%80%EF%BC%88DisconnectBlock%EF%BC%89%EF%BC%8C%E5%90%8C%E6%97%B6%E4%BE%9D%E6%AC%A1%E5%B0%86%E5%8C%BA%E5%9D%97C%E5%92%8CD%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%88ConnectTip%EF%BC%89%EF%BC%8CD%E6%88%90%E4%B8%BA%E4%BA%86%E6%96%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%EF%BC%8C%E4%BA%8E%E6%98%AF%E6%96%B0%E7%9A%84%E5%88%86%E6%94%AFA-C-D%E6%88%90%E4%B8%BA%E4%BA%86%E6%9C%80%E9%95%BF%E9%93%BE%E8%A2%AB%E6%BF%80%E6%B4%BB%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%9F%A5%E6%89%BE%E5%88%86%E5%8F%89%E7%82%B9%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%BAFindFork%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Econst+CBlockIndex+*CChain%3A%3AFindFork%28const+CBlockIndex+*pindex%29+const+%7B%0A++++if+%28pindex+%3D%3D+nullptr%29+%7B%0A++++++++return+nullptr%3B%0A++++%7D%0A++++%2F%2F%E6%89%BE%E5%88%B0%E5%88%86%E6%94%AF%E4%B8%8A%E5%92%8C%E5%BD%93%E5%89%8D%E4%B8%BB%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%E9%AB%98%E5%BA%A6%E7%9B%B8%E5%90%8C%E7%9A%84%E5%8C%BA%E5%9D%97P%0A++++if+%28pindex-%26gt%3BnHeight+%26gt%3B+Height%28%29%29%0A++++++++pindex+%3D+pindex-%26gt%3BGetAncestor%28Height%28%29%29%3B%0A++++%2F%2F%E4%BB%8E%E4%B8%8A%E4%B8%80%E6%AD%A5%E6%89%BE%E5%88%B0%E7%9A%84%E5%8C%BA%E5%9D%97P%E5%BC%80%E5%A7%8B%E5%90%91%E5%89%8D%E5%9B%9E%E6%9C%94%EF%BC%8C%E7%9B%B4%E5%88%B0%E6%89%BE%E5%88%B0%E4%B8%80%E4%B8%AA%E5%AD%98%E5%9C%A8%E4%BA%8E%E5%BD%93%E5%89%8D%E4%B8%BB%E9%93%BE%E4%B8%8A%E7%9A%84%E5%8C%BA%E5%9D%97%E4%B8%BA%E6%AD%A2%0A++++while+%28pindex+%26amp%3B%26amp%3B+%21Contains%28pindex%29%29%0A++++++++pindex+%3D+pindex-%26gt%3Bpprev%3B%0A++++return+pindex%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%AE%97%E6%B3%95%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%8C%E5%81%87%E8%AE%BE%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%3Cspan+style%3D%22color%3A%23ff0000%3B%22%3EA+%E2%80%94+B+%E2%80%94%26nbsp%3B+%26nbsp%3BF%3C%2Fspan%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+%26nbsp%3B%5C%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B+%26nbsp%3B+%26nbsp%3B+%26nbsp%3BC+--+D+------+E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+A-B-F%E6%98%AF%E5%BD%93%E5%89%8D%E4%B8%BB%E9%93%BE%EF%BC%8CA%E7%9A%84%E9%AB%98%E5%BA%A6%E4%B8%BA100%EF%BC%8CB%E4%B8%BA101%EF%BC%8CF%E4%B8%BA102%EF%BC%8C%E5%88%86%E5%8F%89C%EF%BC%8CD%EF%BC%8CE%E9%AB%98%E5%BA%A6%2C%E4%BE%9D%E6%AC%A1%E6%98%AF101%EF%BC%8C102%EF%BC%8C103%EF%BC%8C%E5%88%99%E9%A6%96%E5%85%88%E5%AE%9A%E4%BD%8D%E5%88%B0E%E7%9A%84%E7%A5%96%E5%85%88D%EF%BC%88%E5%9B%A0%E4%B8%BAD%E5%92%8C%E4%B8%BB%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97F%E5%85%B7%E6%9C%89%E7%9B%B8%E5%90%8C%E9%AB%98%E5%BA%A6%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BB%8ED%E5%BC%80%E5%A7%8B%E6%B2%BF%E7%9D%80%E7%88%B6%E5%8C%BA%E5%9D%97%E6%8C%87%E9%92%88%E5%9B%9E%E6%9C%94%E4%B8%80%E7%9B%B4%E5%88%B0A%EF%BC%8C%E4%BA%8E%E6%98%AF%E6%89%BE%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E5%88%86%E5%8F%89%E7%82%B9%E5%8C%BA%E5%9D%97A%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E2.4.4.3+%E8%8A%82%E7%82%B9%E9%97%B4%E7%9A%84%E4%BA%A4%E4%BA%92%3C%2Fh4%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E7%9B%AE%E5%89%8D%E4%B8%BA%E6%AD%A2%E6%88%91%E4%BB%AC%E5%88%86%E6%9E%90%E7%9A%84%E9%83%BD%E6%98%AF%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E6%8C%96%E5%88%B0%E5%8C%BA%E5%9D%97%E7%84%B6%E5%90%8E%E5%B0%86%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E8%BF%87%E7%A8%8B%E3%80%82%E8%8A%82%E7%82%B9%E6%8C%96%E5%87%BA%E5%8C%BA%E5%9D%97%E4%BB%A5%E5%90%8E%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%B9%BF%E6%92%AD%E5%88%B0%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%89%A9%E6%95%A3%E5%87%BA%E5%8E%BB%EF%BC%8C%E8%AE%A9%E5%85%A8%E7%BD%91%E5%AF%B9%E6%96%B0%E5%8C%BA%E5%9D%97%E8%BE%BE%E6%88%90%E5%85%B1%E8%AF%86%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E5%B9%BF%E6%92%AD%E5%8C%BA%E5%9D%97%E5%A4%B4%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B9%8B%E5%89%8D%E5%88%86%E6%9E%90AcceptBlock%E6%96%B9%E6%B3%95%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E6%9C%89%E4%B8%80%E6%AE%B5%E4%BB%A3%E7%A0%81%E6%88%91%E4%BB%AC%E6%B2%A1%E5%81%9A%E8%AF%B4%E6%98%8E%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F%2F+Header+is+valid%2Fhas+work%2C+merkle+tree+and+segwit+merkle+tree+are+good...RELAY+NOW%0A++++%2F%2F+%28but+if+it+does+not+build+on+our+best+tip%2C+let+the+SendMessages+loop+relay+it%29%0A++++if+%28%21IsInitialBlockDownload%28%29+%26amp%3B%26amp%3B+chainActive.Tip%28%29+%3D%3D+pindex-%26gt%3Bpprev%29%0A++++++++GetMainSignals%28%29.NewPoWValidBlock%28pindex%2C+pblock%29%3B%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%BD%93%E8%B0%83%E7%94%A8AcceptBlockHeader%E6%A0%A1%E9%AA%8C%E5%AE%8C%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E6%B2%A1%E6%9C%89%E9%94%99%E8%AF%AF%EF%BC%88%E5%B7%A5%E4%BD%9C%E9%87%8FOK%EF%BC%8Cmerkel%E6%A0%91%E7%9A%84hash%E6%AD%A3%E7%A1%AE...%EF%BC%89%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E5%B0%B1%E6%98%AF%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97%EF%BC%88%E5%AF%B9%E4%BA%8E%E6%96%B0%E6%8C%96%E5%88%B0%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%B8%80%E8%88%AC%E9%83%BD%E6%98%AF%E6%88%90%E7%AB%8B%E7%9A%84%EF%BC%89%EF%BC%8C%E5%88%99%E9%80%9A%E8%BF%87NewPowValidBlock%E5%B0%86%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%B9%BF%E6%92%AD%E5%87%BA%E5%8E%BB%EF%BC%8C%E6%9C%80%E7%BB%88%E8%B0%83%E7%94%A8PeerLogicValidation%3A%3ANewPoWValidBlock%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Evoid+PeerLogicValidation%3A%3ANewPoWValidBlock%28const+CBlockIndex+*pindex%2C+const+std%3A%3Ashared_ptr%26lt%3Bconst+CBlock%26gt%3B%26amp%3B+pblock%29+%7B%0A++++%2F%2F%E5%B0%86%E5%8C%BA%E5%9D%97%E5%A4%B4%E3%80%81%E5%8C%BA%E5%9D%97%E4%BA%A4%E6%98%93id%E6%89%93%E5%8C%85%E5%88%B0CBlockHeaderAndShortTxIDs%E4%B8%AD%0A++++std%3A%3Ashared_ptr%26lt%3Bconst+CBlockHeaderAndShortTxIDs%26gt%3B+pcmpctblock+%3D+std%3A%3Amake_shared%26lt%3Bconst+CBlockHeaderAndShortTxIDs%26gt%3B+%28*pblock%2C+true%29%3B%0A++++const+CNetMsgMaker+msgMaker%28PROTOCOL_VERSION%29%3B%0A%0A++++LOCK%28cs_main%29%3B%0A++++%0A++++%2F%2F%E6%9B%B4%E6%96%B0%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%0A++++static+int+nHighestFastAnnounce+%3D+0%3B%0A++++if+%28pindex-%26gt%3BnHeight+%26lt%3B%3D+nHighestFastAnnounce%29%0A++++++++return%3B%0A++++nHighestFastAnnounce+%3D+pindex-%26gt%3BnHeight%3B%0A%0A++++bool+fWitnessEnabled+%3D+IsWitnessEnabled%28pindex-%26gt%3Bpprev%2C+Params%28%29.GetConsensus%28%29%29%3B%0A++++uint256+hashBlock%28pblock-%26gt%3BGetHash%28%29%29%3B%0A%0A++++%7B%0A++++++++LOCK%28cs_most_recent_block%29%3B%0A++++++++most_recent_block_hash+%3D+hashBlock%3B%0A++++++++most_recent_block+%3D+pblock%3B%0A++++++++most_recent_compact_block+%3D+pcmpctblock%3B%0A++++++++fWitnessesPresentInMostRecentCompactBlock+%3D+fWitnessEnabled%3B%0A++++%7D%0A%0A++++%2F%2F%E5%AF%B9%E6%89%80%E6%9C%89%E7%9B%B8%E9%82%BB%E7%9A%84%E8%8A%82%E7%82%B9%E5%8F%91%E9%80%81CMPCTBLOCK%E6%B6%88%E6%81%AF%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%B9%BF%E6%92%AD%E5%87%BA%E5%8E%BB%0A++++connman-%26gt%3BForEachNode%28%5Bthis%2C+%26amp%3Bpcmpctblock%2C+pindex%2C+%26amp%3BmsgMaker%2C+fWitnessEnabled%2C+%26amp%3BhashBlock%5D%28CNode*+pnode%29+%7B%0A++++++++%2F%2F+TODO%3A+Avoid+the+repeated-serialization+here%0A++++++++if+%28pnode-%26gt%3BnVersion+%26lt%3B+INVALID_CB_NO_BAN_VERSION+%7C%7C+pnode-%26gt%3BfDisconnect%29%0A++++++++++++return%3B%0A++++++++ProcessBlockAvailability%28pnode-%26gt%3BGetId%28%29%29%3B%0A++++++++CNodeState+%26amp%3Bstate+%3D+*State%28pnode-%26gt%3BGetId%28%29%29%3B%0A++++++++%2F%2F+If+the+peer+has%2C+or+we+announced+to+them+the+previous+block+already%2C%0A++++++++%2F%2F+but+we+don%27t+think+they+have+this+one%2C+go+ahead+and+announce+it%0A++++++++%0A++++++++if+%28state.fPreferHeaderAndIDs+%26amp%3B%26amp%3B+%28%21fWitnessEnabled+%7C%7C+state.fWantsCmpctWitness%29+%26amp%3B%26amp%3B%0A++++++++++++%21PeerHasHeader%28%26amp%3Bstate%2C+pindex%29+%26amp%3B%26amp%3B+PeerHasHeader%28%26amp%3Bstate%2C+pindex-%26gt%3Bpprev%29%29+%7B%0A%0A++++++++++++LogPrint%28BCLog%3A%3ANET%2C+%22%25s+sending+header-and-ids+%25s+to+peer%3D%25d%5Cn%22%2C+%22PeerLogicValidation%3A%3ANewPoWValidBlock%22%2C%0A+++++++++++++++++++++hashBlock.ToString%28%29%2C+pnode-%26gt%3BGetId%28%29%29%3B%0A++++++++++++connman-%26gt%3BPushMessage%28pnode%2C+msgMaker.Make%28NetMsgType%3A%3ACMPCTBLOCK%2C+*pcmpctblock%29%29%3B%0A++++++++++++state.pindexBestHeaderSent+%3D+pindex%3B%0A++++++++%7D%0A++++%7D%29%3B%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%9C%80%E5%90%8E%E5%8F%91%E9%80%81CMPCTBLOCK%E6%B6%88%E6%81%AF%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%B9%BF%E6%92%AD%E5%87%BA%E5%8E%BB%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%B3%A8%E6%84%8F%E8%BF%99%E9%87%8C%E4%B9%8B%E6%89%80%E4%BB%A5%E4%B8%8D%E5%B9%BF%E6%92%AD%E5%AE%8C%E6%95%B4%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%80%8C%E5%8F%AA%E5%B9%BF%E6%92%AD%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%92%8C%E4%BA%A4%E6%98%93id%EF%BC%8C%E6%98%AF%E4%B8%BA%E4%BA%86%E8%8A%82%E7%9C%81%E5%B8%A6%E5%AE%BD%EF%BC%8C%E5%9B%A0%E4%B8%BA%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%E6%95%B0%E6%8D%AE%E9%87%8F%E6%98%AF%E5%BE%88%E5%8F%AF%E8%A7%82%E7%9A%84%EF%BC%8C%E5%A6%82%E6%9E%9C%E7%9B%B4%E6%8E%A5%E5%B9%BF%E6%92%AD%E6%95%B4%E4%B8%AA%E5%8C%BA%E5%9D%97%E4%BC%9A%E5%8D%A0%E7%94%A8%E5%BE%88%E5%A4%A7%E7%9A%84%E5%B8%A6%E5%AE%BD%EF%BC%8C%E6%8B%89%E4%BD%8E%E6%95%B4%E4%BD%93%E5%A4%84%E7%90%86%E9%80%9F%E5%BA%A6%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E8%8A%82%E7%82%B9%E6%8E%A5%E6%94%B6%E5%B9%BF%E6%92%AD%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E4%BC%9A%E6%94%B6%E5%88%B0CMPCTBLOCK%E5%B9%BF%E6%92%AD%E6%B6%88%E6%81%AF%EF%BC%8C%E6%9D%A5%E7%9C%8B%E7%9C%8B%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%B9%BF%E6%92%AD%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%E4%BB%A5%E5%90%8E%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E7%9A%84%EF%BC%8C%E4%BD%8D%E4%BA%8Enet_processing.cpp%E7%9A%84ProcessMessage%E4%B8%AD%EF%BC%8C%E8%BF%99%E9%87%8C%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%E6%AF%94%E8%BE%83%E5%A4%8D%E6%9D%82%EF%BC%8C%E6%9C%AC%E6%96%87%E5%8F%AA%E5%A4%A7%E6%A6%82%E6%8F%8F%E8%BF%B0%E4%B8%80%E4%B8%8B%E5%85%B3%E9%94%AE%E7%82%B9%EF%BC%8C%E8%AF%BB%E8%80%85%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E9%98%85%E8%AF%BBCMPCTBLOCK%E6%B6%88%E6%81%AF%E7%9A%84%E5%88%86%E6%94%AF%E5%AF%B9%E5%BA%94%E7%9A%84%E6%BA%90%E7%A0%81%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0CMPCTBLOCK%E6%B6%88%E6%81%AF%EF%BC%8C%E5%90%8C%E6%A0%B7%E4%BC%9A%E8%B0%83%E7%94%A8%E5%88%B0AcceptBlockHeader%E6%A0%A1%E9%AA%8C%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E6%AD%A3%E7%A1%AE%EF%BC%88%E5%B7%A5%E4%BD%9C%E9%87%8F%E3%80%81merkel%E6%A0%91hash%E7%AD%89%EF%BC%89%EF%BC%8C%E5%B0%B1%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E5%8A%A0%E5%85%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B9%8B%E5%90%8E%E8%8A%82%E7%82%B9%E4%BC%9A%E4%B8%BA%E6%96%B0%E5%8C%BA%E5%9D%97%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AAQueuedBlock%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E9%98%9F%E5%88%97%E4%B8%AD%EF%BC%8C%E7%AD%89%E5%BE%85%E5%8C%BA%E5%9D%97%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E7%9A%84%E5%88%B0%E6%9D%A5%EF%BC%8C%E5%BD%93%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E5%88%B0%E6%9D%A5%E6%97%B6%EF%BC%8C%E8%8A%82%E7%82%B9%E5%B0%86%E5%8F%97%E5%88%B0BLOCKTXN%E6%B6%88%E6%81%AF%EF%BC%8C%E8%BF%99%E6%9D%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%A4%84%E7%90%86%E5%A6%82%E4%B8%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3Eelse+if+%28strCommand+%3D%3D+NetMsgType%3A%3ABLOCKTXN+%26amp%3B%26amp%3B+%21fImporting+%26amp%3B%26amp%3B+%21fReindex%29+%2F%2F+Ignore+blocks+received+while+importing%0A%7B%0A++++BlockTransactions+resp%3B%0A++++vRecv+%26gt%3B%26gt%3B+resp%3B%0A%0A++++std%3A%3Ashared_ptr%26lt%3BCBlock%26gt%3B+pblock+%3D+std%3A%3Amake_shared%26lt%3BCBlock%26gt%3B%28%29%3B%0A++++bool+fBlockRead+%3D+false%3B%0A++++%7B%0A++++++++LOCK%28cs_main%29%3B%0A++++%0A++++++++%2F%2F%E4%BB%8E%E9%98%9F%E5%88%97%E4%B8%AD%E6%89%BE%E5%88%B0%E6%B6%88%E6%81%AF%E4%B8%AD%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84QueuedBlock%EF%BC%8C%E6%B2%A1%E6%9C%89%E6%89%BE%E5%88%B0%E5%88%99%E8%BF%94%E5%9B%9E%0A++++++++std%3A%3Amap%26lt%3Buint256%2C+std%3A%3Apair%26lt%3BNodeId%2C+std%3A%3Alist%26lt%3BQueuedBlock%26gt%3B%3A%3Aiterator%26gt%3B+%26gt%3B%3A%3Aiterator+it+%3D+mapBlocksInFlight.find%28resp.blockhash%29%3B%0A++++++++if+%28it+%3D%3D+mapBlocksInFlight.end%28%29+%7C%7C+%21it-%26gt%3Bsecond.second-%26gt%3BpartialBlock+%7C%7C%0A++++++++++++it-%26gt%3Bsecond.first+%21%3D+pfrom-%26gt%3BGetId%28%29%29+%7B%0A++++++++++++LogPrint%28BCLog%3A%3ANET%2C+%22Peer+%25d+sent+us+block+transactions+for+block+we+weren%27t+expecting%5Cn%22%2C+pfrom-%26gt%3BGetId%28%29%29%3B%0A++++++++++++return+true%3B%0A++++++++%7D%0A++++%0A++++++++%2F%2F%E5%A1%AB%E5%85%85%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF%0A++++++++PartiallyDownloadedBlock%26amp%3B+partialBlock+%3D+*it-%26gt%3Bsecond.second-%26gt%3BpartialBlock%3B%0A++++++++ReadStatus+status+%3D+partialBlock.FillBlock%28*pblock%2C+resp.txn%29%3B%0A++++++++if+%28status+%3D%3D+READ_STATUS_INVALID%29+%7B%0A++++++++++++MarkBlockAsReceived%28resp.blockhash%29%3B+%2F%2F+Reset+in-flight+state+in+case+of+whitelist%0A++++++++++++Misbehaving%28pfrom-%26gt%3BGetId%28%29%2C+100%2C+strprintf%28%22Peer+%25d+sent+us+invalid+compact+block%2Fnon-matching+block+transactions%5Cn%22%2C+pfrom-%26gt%3BGetId%28%29%29%29%3B%0A++++++++++++return+true%3B%0A++++++++%7D+else+if+%28status+%3D%3D+READ_STATUS_FAILED%29+%7B%0A++++++++++++%2F%2F+Might+have+collided%2C+fall+back+to+getdata+now+%3A%28%0A++++++++++++std%3A%3Avector%26lt%3BCInv%26gt%3B+invs%3B%0A++++++++++++invs.push_back%28CInv%28MSG_BLOCK+%7C+GetFetchFlags%28pfrom%29%2C+resp.blockhash%29%29%3B%0A++++++++++++connman-%26gt%3BPushMessage%28pfrom%2C+msgMaker.Make%28NetMsgType%3A%3AGETDATA%2C+invs%29%29%3B%0A++++++++%7D+else+%7B%0A++++++++++++%2F%2F+Block+is+either+okay%2C+or+possibly+we+received%0A++++++++++++%2F%2F+READ_STATUS_CHECKBLOCK_FAILED.%0A++++++++++++%2F%2F+Note+that+CheckBlock+can+only+fail+for+one+of+a+few+reasons%3A%0A++++++++++++%2F%2F+1.+bad-proof-of-work+%28impossible+here%2C+because+we%27ve+already%0A++++++++++++%2F%2F++++accepted+the+header%29%0A++++++++++++%2F%2F+2.+merkleroot+doesn%27t+match+the+transactions+given+%28already%0A++++++++++++%2F%2F++++caught+in+FillBlock+with+READ_STATUS_FAILED%2C+so%0A++++++++++++%2F%2F++++impossible+here%29%0A++++++++++++%2F%2F+3.+the+block+is+otherwise+invalid+%28eg+invalid+coinbase%2C%0A++++++++++++%2F%2F++++block+is+too+big%2C+too+many+legacy+sigops%2C+etc%29.%0A++++++++++++%2F%2F+So+if+CheckBlock+failed%2C+%233+is+the+only+possibility.%0A++++++++++++%2F%2F+Under+BIP+152%2C+we+don%27t+DoS-ban+unless+proof+of+work+is%0A++++++++++++%2F%2F+invalid+%28we+don%27t+require+all+the+stateless+checks+to+have%0A++++++++++++%2F%2F+been+run%29.++This+is+handled+below%2C+so+just+treat+this+as%0A++++++++++++%2F%2F+though+the+block+was+successfully+read%2C+and+rely+on+the%0A++++++++++++%2F%2F+handling+in+ProcessNewBlock+to+ensure+the+block+index+is%0A++++++++++++%2F%2F+updated%2C+reject+messages+go+out%2C+etc.%0A++++++++++++%2F%2F%E4%B8%80%E5%88%87%E6%AD%A3%E5%B8%B8%EF%BC%8C%E6%A0%87%E8%AE%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E5%B7%B2%E7%BB%8F%E6%94%B6%E5%88%B0%EF%BC%8C%E5%B0%86%E5%8C%BA%E5%9D%97%E5%AF%B9%E5%BA%94%E7%9A%84QueuedBlock%E4%BB%8E%E9%98%9F%E5%88%97%E4%B8%AD%E7%A7%BB%E9%99%A4%E6%8E%89%0A++++++++++++MarkBlockAsReceived%28resp.blockhash%29%3B+%2F%2F+it+is+now+an+empty+pointer%0A++++++++++++fBlockRead+%3D+true%3B%0A++++++++++++%2F%2F+mapBlockSource+is+only+used+for+sending+reject+messages+and+DoS+scores%2C%0A++++++++++++%2F%2F+so+the+race+between+here+and+cs_main+in+ProcessNewBlock+is+fine.%0A++++++++++++%2F%2F+BIP+152+permits+peers+to+relay+compact+blocks+after+validating%0A++++++++++++%2F%2F+the+header+only%3B+we+should+not+punish+peers+if+the+block+turns%0A++++++++++++%2F%2F+out+to+be+invalid.%0A++++++++++++mapBlockSource.emplace%28resp.blockhash%2C+std%3A%3Amake_pair%28pfrom-%26gt%3BGetId%28%29%2C+false%29%29%3B%0A++++++++%7D%0A++++%7D+%2F%2F+Don%27t+hold+cs_main+when+we+call+into+ProcessNewBlock%0A%0A++++%2F%2F%E5%A6%82%E6%9E%9C%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%B0%86%E6%94%B6%E5%88%B0%E7%9A%84%E4%BA%A4%E6%98%93%E5%A1%AB%E5%85%85%E5%88%B0%E5%8C%BA%E5%9D%97%E4%B8%AD%EF%BC%8C%E8%B0%83%E7%94%A8ProcessNewBlock%E5%A4%84%E7%90%86%E4%B9%8B%0A++++if+%28fBlockRead%29+%7B%0A++++++++bool+fNewBlock+%3D+false%3B%0A++++++++%2F%2F+Since+we+requested+this+block+%28it+was+in+mapBlocksInFlight%29%2C+force+it+to+be+processed%2C%0A++++++++%2F%2F+even+if+it+would+not+be+a+candidate+for+new+tip+%28missing+previous+block%2C+chain+not+long+enough%2C+etc%29%0A++++++++%2F%2F+This+bypasses+some+anti-DoS+logic+in+AcceptBlock+%28eg+to+prevent%0A++++++++%2F%2F+disk-space+attacks%29%2C+but+this+should+be+safe+due+to+the%0A++++++++%2F%2F+protections+in+the+compact+block+handler+--+see+related+comment%0A++++++++%2F%2F+in+compact+block+optimistic+reconstruction+handling.%0A++++++++%2F%2F%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%9D%97%0A++++++++ProcessNewBlock%28chainparams%2C+pblock%2C+%2F*fForceProcessing%3D*%2Ftrue%2C+%26amp%3BfNewBlock%29%3B%0A++++++++if+%28fNewBlock%29+%7B%0A++++++++++++pfrom-%26gt%3BnLastBlockTime+%3D+GetTime%28%29%3B%0A++++++++%7D+else+%7B%0A++++++++++++LOCK%28cs_main%29%3B%0A++++++++++++mapBlockSource.erase%28pblock-%26gt%3BGetHash%28%29%29%3B%0A++++++++%7D%0A++++%7D%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%EF%BC%8C%E6%9C%80%E7%BB%88%E4%B9%9F%E6%98%AF%E8%B0%83%E7%94%A8ProcessNewBlock%E6%9D%A5%E5%A4%84%E7%90%86%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%89%8D%E9%9D%A2%E5%87%A0%E8%8A%82%E5%B7%B2%E7%BB%8F%E8%8A%B1%E4%BA%86%E8%BE%83%E5%A4%A7%E7%AF%87%E5%B9%85%E6%9D%A5%E5%88%86%E6%9E%90%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%9C%80%E5%90%8E%E6%80%BB%E7%BB%93%E4%B8%80%E4%B8%8B%E8%BF%99%E9%87%8C%E7%9A%84%E6%97%B6%E5%BA%8F%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180712182934765%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cbr%3E%3C%2Fp%3E%0A++%3Ch2%3E2.5+PoW%E5%85%B1%E8%AF%86%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93%3C%2Fh2%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%9B%A0%E4%B8%BA%E5%85%B1%E8%AF%86%E6%98%AF%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E6%A0%B8%E5%BF%83%E6%89%80%E5%9C%A8%EF%BC%8C%E6%9C%AC%E8%8A%82%E9%80%9A%E8%BF%87%E4%BE%8B%E5%AD%90%E6%9D%A5%E6%BC%94%E7%A4%BA%E4%B8%80%E4%B8%8B%E4%B8%8A%E9%9D%A2%E4%BB%A3%E7%A0%81%E4%B8%AD%E8%BE%BE%E6%88%90%E5%85%B1%E8%AF%86%E7%9A%84%E8%BF%87%E7%A8%8B%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%81%87%E8%AE%BE%E4%B8%A4%E4%B8%AA%E8%8A%82%E7%82%B9N1%E5%92%8CN2%EF%BC%8C%E5%BD%93%E5%89%8D%E5%90%84%E8%87%AA%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E9%A1%B6%E7%82%B9%E9%83%BD%E6%98%AF%E5%8C%BA%E5%9D%97A%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180711161925325%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%9A%8F%E5%90%8E%EF%BC%8C%E5%81%87%E8%AE%BE%E4%B8%A4%E4%B8%AA%E7%9F%BF%E5%B7%A5%E9%83%BD%E4%BB%A5A%E4%B8%BA%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%87%A0%E4%B9%8E%E5%9C%A8%E5%90%8C%E4%B8%80%E6%97%B6%E9%97%B4%E6%8C%96%E5%87%BA%E4%BA%86%E5%8C%BA%E5%9D%97B%E5%92%8CC%EF%BC%8C%E7%84%B6%E5%90%8E%E8%8A%82%E7%82%B9P1%E5%85%88%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%EF%BC%8C%E5%B9%B6%E7%94%A8%E5%8C%BA%E5%9D%97B%E5%BB%B6%E9%95%BF%E4%BA%86%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E8%80%8C%E8%8A%82%E7%82%B9P2%E8%8A%82%E7%82%B9%E5%85%88%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97C%EF%BC%8C%E4%BA%8E%E6%98%AFP2%E8%8A%82%E7%82%B9%E7%94%A8%E5%8C%BA%E5%9D%97C%E5%BB%B6%E9%95%BF%E4%BA%86%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E4%BA%8E%E6%98%AF%E5%87%BA%E7%8E%B0%E4%BA%86%E5%88%86%E5%8F%89%EF%BC%8C%E4%B8%A4%E4%B8%AA%E8%8A%82%E7%82%B9%E5%90%84%E8%87%AA%E7%BB%B4%E6%8A%A4%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BC%80%E5%A7%8B%E4%B8%8D%E4%B8%80%E8%87%B4%E4%BA%86%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180711162647911%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%8D%E4%B9%85%E5%90%8E%EF%BC%8C%E8%8A%82%E7%82%B9P1%E4%B9%9F%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97C%EF%BC%8C%E8%80%8C%E8%8A%82%E7%82%B9P2%E6%94%B6%E5%88%B0%E4%BA%86%E5%8C%BA%E5%9D%97B%E3%80%82%E4%BA%8E%E6%98%AF%E8%8A%82%E7%82%B9P1%E6%89%A7%E8%A1%8CProcessNewBlock%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E4%B8%BA%E5%8C%BA%E5%9D%97C%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%EF%BC%8C%E5%90%8C%E6%97%B6%E5%B0%86%E5%8C%BA%E5%9D%97C%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%EF%BC%8C%E5%90%8C%E6%A0%B7%E7%9A%84%EF%BC%8C%E8%8A%82%E7%82%B9P2%E4%B9%9F%E4%B8%BA%E5%8C%BA%E5%9D%97B%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E5%8A%A0%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%B4%A2%E5%BC%95%E8%A1%A8%E4%B8%AD%EF%BC%8C%E5%B9%B6%E6%8A%8A%E5%8C%BA%E5%9D%97B%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F2018071117113216%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B9%8B%E5%90%8E%EF%BC%8C%E6%9C%89%E7%9F%BF%E5%B7%A5%E5%9C%A8%E5%8C%BA%E5%9D%97C%E7%9A%84%E5%9F%BA%E7%A1%80%E4%B8%8A%E6%8C%96%E5%87%BA%E4%BA%86%E6%96%B0%E5%8C%BA%E5%9D%97D%EF%BC%8C%E6%8C%89%E7%85%A7%E4%B9%8B%E5%89%8D%E4%BB%A3%E7%A0%81%E7%9A%84%E5%88%86%E6%9E%90%EF%BC%8CP2%E4%BC%9A%E6%8C%89%E5%A6%82%E4%B8%8B%E6%83%85%E5%86%B5%E5%A4%84%E7%90%86%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E4%B8%BA%E5%8C%BA%E5%9D%97D%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%B9%B6%E5%8A%A0%E5%85%A5%E7%B4%A2%E5%BC%95%E8%A1%A8%EF%BC%88AcceptBlockHeader%EF%BC%89%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%B0%86%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%85%A5%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%EF%BC%88AcceptBlock%EF%BC%89%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%BA%7BB%EF%BC%8CD%7D%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%89%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%E8%8A%82%E7%82%B9D%EF%BC%8C%E5%AF%BB%E6%89%BE%E5%88%86%E5%8F%89%E7%82%B9%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%B2%A1%E6%9C%89%E5%88%86%E5%8F%89%EF%BC%8C%E6%89%80%E4%BB%A5%E6%9C%80%E5%90%8E%E7%9B%B4%E6%8E%A5%E5%B0%86%E5%8C%BA%E5%9D%97D%E8%BF%9E%E6%8E%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%8C%E5%8C%BA%E5%9D%97D%E6%88%90%E4%B8%BA%E6%96%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E9%A1%B6%E7%82%B9%EF%BC%88ActivateBestChain%EF%BC%89%EF%BC%8C%E5%90%8C%E6%97%B6%E5%B0%86%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%E4%B8%AD%E7%9A%84%E5%8C%BA%E5%9D%97D%E4%BB%A5%E5%8F%8A%E6%89%80%E6%9C%89%E6%AF%94%E5%8C%BA%E5%9D%97D%E5%B7%A5%E4%BD%9C%E9%87%8F%E5%B0%8F%E7%9A%84%E5%8C%BA%E5%9D%97%E7%A7%BB%E9%99%A4%EF%BC%8C%E4%BA%8E%E6%98%AF%E5%80%99%E9%80%89%E9%9B%86%E5%90%88%E4%B8%BA%E7%A9%BA%EF%BC%9B%E6%9C%80%E7%BB%88%EF%BC%8C%E8%8A%82%E7%82%B9P2%E7%9A%84%E7%8A%B6%E6%80%81%E5%A6%82%E4%B8%8B%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F2018071117540819%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E8%80%8C%E8%8A%82%E7%82%B9P1%E6%94%B6%E5%88%B0%E5%8C%BA%E5%9D%97D%E4%BB%A5%E5%90%8E%E7%9A%84%E5%A4%84%E7%90%86%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E9%A6%96%E5%85%88%E4%B8%BA%E5%8C%BA%E5%9D%97D%E5%88%9B%E5%BB%BA%E5%8C%BA%E5%9D%97%E7%B4%A2%E5%BC%95%E5%B9%B6%E5%8A%A0%E5%85%A5%E5%88%B0%E7%B4%A2%E5%BC%95%E8%A1%A8%EF%BC%88AcceptBlockHeader%EF%BC%89%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%B0%86%E5%8C%BA%E5%9D%97D%E5%8A%A0%E5%85%A5%E5%88%B0%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%EF%BC%8C%E6%AD%A4%E6%97%B6%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E9%9B%86%E5%90%88%7B+C%2C+D+%7D+%28AcceptBlock%29%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97D%E6%8B%A5%E6%9C%89%E6%9C%80%E5%A4%A7%E5%B7%A5%E4%BD%9C%E9%87%8F%EF%BC%8C%E5%AF%BB%E6%89%BE%E5%88%86%E5%8F%89%E7%82%B9%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%8A%82%E7%82%B9P1%E5%AD%98%E5%9C%A8%E5%88%86%E5%8F%89%EF%BC%8C%E4%BA%8E%E6%98%AF%E5%83%8F%E4%B8%8B%E5%9B%BE%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180711190635549%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E6%97%A7%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E9%A1%B6%E7%82%B9%E5%8C%BA%E5%9D%97B%E5%B0%86%E8%A2%AB%E6%96%AD%E5%BC%80%EF%BC%8C%E5%8C%BA%E5%9D%97D%E5%92%8CC%E5%B0%86%E6%8C%82%E5%88%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%88ActivateBestChain%EF%BC%89%EF%BC%8C%E8%8A%82%E7%82%B9P1%E4%BB%8E%E5%8E%9F%E6%9D%A5%E7%9A%84%E4%B8%BB%E9%93%BEA-B%E5%88%87%E6%8D%A2%E5%88%B0%E6%96%B0%E7%9A%84%E6%9C%80%E9%95%BF%E9%93%BEA-C-D%EF%BC%8C%E8%8A%82%E7%82%B9P1%E5%92%8CP2%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E9%87%8D%E6%96%B0%E8%BE%BE%E6%88%90%E4%BA%86%E4%B8%80%E8%87%B4%EF%BC%9A%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180711192142849%3Fwatermark%2F2%2Ftext%2FaHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p0ZW10X3N3Mg%3D%3D%2Ffont%2F5a6L5L2T%2Ffontsize%2F400%2Ffill%2FI0JBQkFCMA%3D%3D%2Fdissolve%2F70%22+alt%3D%22%22%3E%3C%2Fp%3E%0A++%3Ch1%3E3+%E5%B0%8F%E7%BB%93%3C%2Fh1%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+PoW%E5%85%B1%E8%AF%86%E6%98%AF%E6%AF%94%E7%89%B9%E5%B8%81%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E6%A0%B8%E5%BF%83%E4%B9%8B%E4%B8%80%EF%BC%8C%E6%9C%AC%E6%96%87%E7%BB%93%E5%90%88%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BA%86%E6%AF%94%E7%89%B9%E5%B8%81%E9%80%9A%E8%BF%87PoW%E7%AE%97%E6%B3%95%E5%B0%B1%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E7%8A%B6%E6%80%81%E8%BE%BE%E6%88%90%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E7%9A%84%E8%BF%87%E7%A8%8B%E8%BF%9B%E8%A1%8C%E4%BA%86%E5%88%86%E6%9E%90%EF%BC%8C%E7%9C%8B%E4%BC%9A%E4%BA%86PoW%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%AF%B4%E6%AF%94%E7%89%B9%E5%B8%81%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E4%B8%80%E5%9D%97%E7%A1%AC%E9%AA%A8%E5%A4%B4%E5%B0%B1%E7%AE%97%E5%95%83%E4%B8%8B%E6%9D%A5%E4%BA%86%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%281%29+%E8%8A%82%E7%82%B9%E5%9F%BA%E4%BA%8E%E5%BD%93%E5%89%8D%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E6%9E%84%E9%80%A0%E5%87%BA%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%EF%BC%8C%E7%9F%BF%E5%B7%A5%E6%8C%96%E5%87%BA%E5%80%99%E9%80%89%E5%8C%BA%E5%9D%97%E7%9A%84%E5%A5%96%E5%8A%B1%E8%B4%B9%3D%E5%8C%BA%E5%9D%97%E5%8C%85%E5%90%AB%E7%9A%84%E4%BA%A4%E6%98%93%E7%9A%84%E4%BA%A4%E6%98%93%E8%B4%B9+%2B+%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E5%A5%96%E5%8A%B1%EF%BC%8C%E5%85%B6%E4%B8%AD%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%AF%94%E7%89%B9%E5%B8%81%E5%A5%96%E5%8A%B1%E5%88%9D%E5%A7%8B%E4%B8%BA50%E4%B8%AA%E6%AF%94%E7%89%B9%E5%B8%81%EF%BC%8C%E7%84%B6%E5%90%8E%E6%AF%8F%E4%BA%A7%E5%87%BA210000%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%88%E7%BA%A64%E5%B9%B4%EF%BC%89%E5%B0%B1%E5%87%8F%E5%8D%8A%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%282%29+%E8%8A%82%E7%82%B9%E9%80%9A%E8%BF%87%E4%B8%8D%E6%96%AD%E9%80%92%E5%A2%9E%E6%96%B0%E5%8C%BA%E5%9D%97%E5%A4%B4%E9%83%A8%E7%9A%84nonce%E5%80%BC%E8%AE%A1%E7%AE%97%E5%8C%BA%E5%9D%97%E5%A4%B4%E9%83%A8%E7%9A%84hash%EF%BC%8C%E7%9B%B4%E5%88%B0hash%E6%BB%A1%E8%B6%B3%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E9%9A%BE%E5%BA%A6%E7%9B%AE%E6%A0%87%E5%80%BC%E4%B8%BA%E6%AD%A2%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%283%29+%E8%8A%82%E7%82%B9%E7%94%A8%E6%96%B0%E5%8C%BA%E5%9D%97%E5%BB%B6%E9%95%BF%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%8C%E5%90%8C%E6%97%B6%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E5%B9%BF%E6%92%AD%E5%87%BA%E5%8E%BB%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%284%29+%E6%94%B6%E5%88%B0%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E8%8A%82%E7%82%B9%E6%A0%A1%E9%AA%8C%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%8C%BA%E5%9D%97%E5%8A%A0%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%285%29+%E5%88%86%E6%9E%90%E4%BA%86%E5%8C%BA%E5%9D%97%E9%93%BE%E5%88%86%E5%8F%89%E4%BB%A5%E5%8F%8A%E5%BD%93%E5%AD%98%E5%9C%A8%E5%88%86%E5%8F%89%E6%97%B6%E8%8A%82%E7%82%B9%E5%A6%82%E4%BD%95%E5%88%87%E6%8D%A2%E5%88%B0%E6%9C%80%E9%95%BF%E9%93%BE%E7%9A%84%EF%BC%9B%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B+%26nbsp%3B+%E5%8F%A6%E5%A4%96%E5%AD%A6%E4%B9%A0%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E9%9C%80%E8%A6%81%E7%90%86%E8%A7%A3%E6%9C%AC%E6%96%87%E5%BC%80%E5%A7%8B%E6%8F%90%E5%88%B0%E7%9A%84%E5%87%A0%E4%B8%AA%E5%92%8C%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9B%B8%E5%85%B3%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E5%8F%98%E9%87%8F%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%8C%E6%89%8D%E8%83%BD%E6%9B%B4%E5%A5%BD%E7%9A%84%E7%90%86%E8%A7%A3%E6%AF%94%E7%89%B9%E5%B8%81%E5%8C%BA%E5%9D%97%E9%93%BEPoW%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%9B%26nbsp%3B%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fztemt_sw2%2Farticle%2Fdetails%2F80958087%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fztemt_sw2%2Farticle%2Fdetails%2F80958087%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}