---
layout: default
title: 网络子系统87_veth实现
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cpre%3E%3Ccode+class%3D%22language-cpp%22%3E%2F%2F%E4%BD%BF%E7%94%A8veth%0A%2F%2F1.%E5%88%9B%E5%BB%BA%E4%B8%A4%E5%9D%97%E8%99%9A%E6%8B%9F%E7%BD%91%E5%8D%A1veth1%E3%80%81veth2%EF%BC%8C%E7%84%B6%E5%90%8E%E7%82%B9%E5%AF%B9%E7%82%B9%E8%BF%9E%E6%8E%A5%EF%BC%8C%E6%AD%A4%E5%90%8E%E4%B8%A4%E5%9D%97%E7%BD%91%E5%8D%A1%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%9A%E4%BA%92%E7%9B%B8%E5%8F%91%E9%80%81%E5%88%B0%E5%AF%B9%E6%96%B9%0A%24+ip+link+add+veth1+type+veth+peer+name+veth2%0A%0A%2F%2F2.%E5%88%9B%E5%BB%BA%E7%BD%91%E7%BB%9C%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4t1%0A%24+ip+netns+add+t1%0A%0A%2F%2F3.%E5%B0%86veth0%E5%8A%A0%E5%85%A5t1%EF%BC%8C%E6%AD%A4%E6%97%B6veth0%E4%BE%BF%E7%9C%8B%E4%B8%8D%E5%88%B0%E4%BA%86%EF%BC%8C%E5%9B%A0%E4%B8%BA%E8%A2%AB%E5%8A%A0%E5%85%A5%E5%88%B0%E5%85%B6%E4%BB%96%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%AD%E4%BA%86%0A%24+ip+link+set+veth0+netns+t1%0A%0A%2F%2F4.%E9%85%8D%E7%BD%AEveth0%E7%9A%84ip%E5%9C%B0%E5%9D%80%0A%24+ip+netns+exec+t1+ifconfig+eth0+192.168.1.200%2F24%0A%0A%2F%2F5.%E8%AE%BE%E7%BD%AEt1%E7%BD%91%E7%BB%9C%E7%9A%84%E9%BB%98%E8%AE%A4%E8%B7%AF%E7%94%B1%0A%24+ip+netns+exec+t1+route+add+default+gw+192.168.1.1%0A%0A%2F%2F6.%E6%AD%A4%E6%97%B6%E5%B0%86veth2%E5%8A%A0%E5%85%A5%E6%9C%AC%E5%9C%B0%E7%BD%91%E6%A1%A5%E4%B8%AD%EF%BC%8C%E4%BE%BF%E5%8F%AF%E4%BB%A5%E5%AE%9E%E7%8E%B0veth1%E5%9C%A8t1%E4%B8%AD%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C%E4%BA%86%EF%BC%8C%E8%BF%87%E7%A8%8B%E7%95%A5%EF%BC%8C%E5%8F%AF%E5%8F%82%E8%80%83docker%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4%0A%0A%0A%2F%2Fveth%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95%EF%BC%88drivers%2Fnet%2Fveth.c%EF%BC%89%0A%2F%2F%E5%90%91ip+link%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%0A1.1+static+__init+int+veth_init%28void%29%0A%7B%0A%09return+rtnl_link_register%28%26amp%3Bveth_link_ops%29%3B%0A%7D%0A%0A%2F%2F%E5%A4%84%E7%90%86ip+link%E5%91%BD%E4%BB%A4%0A2.1+static+struct+rtnl_link_ops+veth_link_ops+%3D+%7B%0A%09.kind%09%09%3D+DRV_NAME%2C%0A%09.priv_size%09%3D+sizeof%28struct+veth_priv%29%2C%0A%09.setup%09%09%3D+veth_setup%2C%0A%09.validate%09%3D+veth_validate%2C%0A%09.newlink%09%3D+veth_newlink%2C%0A%09.dellink%09%3D+veth_dellink%2C%0A%09.policy%09%09%3D+veth_policy%2C%0A%09.maxtype%09%3D+VETH_INFO_MAX%2C%0A%7D%3B%0A%0A%0A%2F%2F%E6%96%B0%E5%8A%A0%E5%85%A5%E4%B8%80%E6%9D%A1veth%E9%93%BE%E6%8E%A5%0A2.2+static+int+veth_newlink%28struct+net_device+*dev%2C%0A%09%09%09+struct+nlattr+*tb%5B%5D%2C+struct+nlattr+*data%5B%5D%29%0A%7B%0A%09int+err%3B%0A%09struct+net_device+*peer%3B%0A%09struct+veth_priv+*priv%3B%0A%09char+ifname%5BIFNAMSIZ%5D%3B%0A%09struct+nlattr+*peer_tb%5BIFLA_MAX+%2B+1%5D%2C+**tbp%3B%0A%0A%09+%2F%2F%E9%A6%96%E5%85%88%E5%88%9B%E5%BB%BA%E5%B9%B6%E6%B3%A8%E5%86%8Cpeer%0A%09if+%28data+%21%3D+NULL+%26amp%3B%26amp%3B+data%5BVETH_INFO_PEER%5D+%21%3D+NULL%29+%7B%0A%09%09struct+nlattr+*nla_peer%3B%0A%09%09%2F%2F%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%0A%09%09nla_peer+%3D+data%5BVETH_INFO_PEER%5D%3B%0A%09%09err+%3D+nla_parse%28peer_tb%2C+IFLA_MAX%2C%0A%09%09%09%09nla_data%28nla_peer%29+%2B+sizeof%28struct+ifinfomsg%29%2C%0A%09%09%09%09nla_len%28nla_peer%29+-+sizeof%28struct+ifinfomsg%29%2C%0A%09%09%09%09ifla_policy%29%3B%0A%09%09...%0A%09%7D+else%0A%09%09tbp+%3D+tb%3B%0A%0A%09%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96peer%0A%09...%0A%0A%09%2F%2F%E6%B3%A8%E5%86%8Cpeer%0A%09err+%3D+register_netdevice%28peer%29%3B%0A%09if+%28err+%26lt%3B+0%29%0A%09%09goto+err_register_peer%3B%0A%09%0A%0A%09%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96peer%E7%9A%84%E5%AF%B9%E7%AD%89%E7%AB%AF%0A%09...%0A%0A%09%2F%2F%E6%B3%A8%E5%86%8Cpeer%E7%9A%84%E5%AF%B9%E7%AD%89%E7%AB%AF%0A%09err+%3D+register_netdevice%28dev%29%3B%0A%09if+%28err+%26lt%3B+0%29%0A%09%09goto+err_register_dev%3B%0A%0A%09%2F%2F%E4%BA%92%E7%9B%B8%E5%B0%86peer%E4%BF%9D%E5%AD%98%E5%88%B0private%E4%B8%AD%EF%BC%8C%E5%9C%A8xmit%E7%9A%84%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8%0A%09priv+%3D+netdev_priv%28dev%29%3B%0A%09priv-%26gt%3Bpeer+%3D+peer%3B%0A%0A%09priv+%3D+netdev_priv%28peer%29%3B%0A%09priv-%26gt%3Bpeer+%3D+dev%3B%0A%09return+0%3B%0A%0Aerr_register_dev%3A%0Aerr_alloc_name%3A%0A%09unregister_netdevice%28peer%29%3B%0A%09return+err%3B%0A%0Aerr_register_peer%3A%0A%09free_netdev%28peer%29%3B%0A%09return+err%3B%0A%7D%0A%0A%0A%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96veth%E8%AE%BE%E5%A4%87%0A2.3+static+void+veth_setup%28struct+net_device+*dev%29%0A%7B%0A%09%2F%2F%E4%BB%A5%E5%A4%AA%E7%BD%91%E8%AE%BE%E5%A4%87%E7%9A%84%E9%80%9A%E7%94%A8%E5%88%9D%E5%A7%8B%E5%8C%96%0A%09ether_setup%28dev%29%3B%0A%0A%09%2F%2Fveth%E7%9A%84%E6%93%8D%E4%BD%9C%E5%88%97%E8%A1%A8%0A%09dev-%26gt%3Bnetdev_ops+%3D+%26amp%3Bveth_netdev_ops%3B%0A%09dev-%26gt%3Bethtool_ops+%3D+%26amp%3Bveth_ethtool_ops%3B%0A%09dev-%26gt%3Bfeatures+%7C%3D+NETIF_F_LLTX%3B%0A%09dev-%26gt%3Bdestructor+%3D+veth_dev_free%3B%0A%7D%0A%0A%2F%2F%E9%80%9A%E8%BF%87veth%E5%8F%91%E9%80%81skb%0A2.4+static+netdev_tx_t+veth_xmit%28struct+sk_buff+*skb%2C+struct+net_device+*dev%29%0A%7B%0A%09struct+net_device+*rcv+%3D+NULL%3B%0A%09struct+veth_priv+*priv%2C+*rcv_priv%3B%0A%09struct+veth_net_stats+*stats%2C+*rcv_stats%3B%0A%09int+length%2C+cpu%3B%0A%0A%09%2F%2F%E8%8E%B7%E5%8F%96%E5%AF%B9%E7%AD%89%E7%AB%AF%0A%09priv+%3D+netdev_priv%28dev%29%3B%0A%09rcv+%3D+priv-%26gt%3Bpeer%3B%0A%09rcv_priv+%3D+netdev_priv%28rcv%29%3B%0A%0A%09...%0A%0A%09%2F%2F%E8%AE%BE%E7%BD%AEskb%E7%9A%84%E8%AE%BE%E5%A4%87%E4%B8%BA%E5%AF%B9%E7%AD%89%E7%AB%AF%0A%09skb-%26gt%3Bpkt_type+%3D+PACKET_HOST%3B%0A%09skb-%26gt%3Bprotocol+%3D+eth_type_trans%28skb%2C+rcv%29%3B%0A%09if+%28dev-%26gt%3Bfeatures+%26amp%3B+NETIF_F_NO_CSUM%29%0A%09%09skb-%26gt%3Bip_summed+%3D+rcv_priv-%26gt%3Bip_summed%3B%0A%0A%09...%0A%09%2F%2F%E5%B0%86skb%E6%94%BE%E5%85%A5%E5%88%B0%E5%AF%B9%E7%AD%89%E7%AB%AF%E7%9A%84%E6%8E%A5%E6%94%B6%E9%98%9F%E5%88%97%E4%B8%AD%EF%BC%8C%E4%BB%8E%E6%AD%A4%E5%AE%8C%E6%88%90%E4%BA%86skb%E5%90%91%E5%AF%B9%E7%AD%89%E7%AB%AF%E7%9A%84%E5%8F%91%E9%80%81%0A%09netif_rx%28skb%29%3B%0A%09return+NETDEV_TX_OK%3B%0A%0Atx_drop%3A%0A%09kfree_skb%28skb%29%3B%0A%09stats-%26gt%3Btx_dropped%2B%2B%3B%0A%09return+NETDEV_TX_OK%3B%0A%0Arx_drop%3A%0A%09kfree_skb%28skb%29%3B%0A%09rcv_stats-%26gt%3Brx_dropped%2B%2B%3B%0A%09return+NETDEV_TX_OK%3B%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cbr%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fnerdx%2Farticle%2Fdetails%2F38561933%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fnerdx%2Farticle%2Fdetails%2F38561933%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}