---
layout: default
title: 深入区块链以太坊源码之p2p通信
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Cdiv+class%3D%22article-copyright%22%3E%0A+++%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%EF%BC%9A%E6%9C%AC%E6%96%87%E4%B8%BA%E5%8D%9A%E4%B8%BB%E5%8E%9F%E5%88%9B%E6%96%87%E7%AB%A0%EF%BC%8C%E6%9C%AA%E7%BB%8F%E5%8D%9A%E4%B8%BB%E5%85%81%E8%AE%B8%E4%B8%8D%E5%BE%97%E8%BD%AC%E8%BD%BD%E3%80%82+https%3A%2F%2Fblog.csdn.net%2FGrit_ICPC%2Farticle%2Fdetails%2F83961303+%0A+%3C%2Fdiv%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-d7e2a68c7c.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22+id%3D%22content_views%22%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22hljs+language-Go%22%3E%E4%B8%80%E3%80%81p2p%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%88%86%E4%B8%BA%E6%9C%89%E7%BB%93%E6%9E%84%E5%92%8C%E6%97%A0%E7%BB%93%E6%9E%84%E7%9A%84%E7%BD%91%E7%BB%9C%0A%09%E6%97%A0%E7%BB%93%E6%9E%84%E5%8C%96%E7%9A%84%EF%BC%9A%0A%09%09%E8%BF%99%E7%A7%8Dp2p%E7%BD%91%E7%BB%9C%E5%8D%B3%E6%9C%80%E6%99%AE%E9%80%9A%E7%9A%84%EF%BC%8C%E4%B8%8D%E5%AF%B9%E7%BB%93%E6%9E%84%E4%BD%9C%E7%89%B9%E5%88%AB%E8%AE%BE%E8%AE%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E3%80%82%0A%09%09%E4%BC%98%E7%82%B9%E6%98%AF%E7%BB%93%E6%9E%84%E7%AE%80%E5%8D%95%E6%98%93%E4%BA%8E%E7%BB%84%E5%BB%BA%EF%BC%8C%E7%BD%91%E7%BB%9C%E5%B1%80%E9%83%A8%E5%8C%BA%E5%9F%9F%E5%86%85%E4%B8%AA%E4%BD%93%E5%8F%AF%E4%BB%BB%E6%84%8F%E5%88%86%E5%B8%83%EF%BC%8C%0A%09%09%E5%8F%8D%E6%AD%A3%E6%AD%A4%E6%97%B6%E7%BD%91%E7%BB%9C%E7%BB%93%E6%9E%84%E5%AF%B9%E6%AD%A4%E4%B9%9F%E6%B2%A1%E6%9C%89%E9%99%90%E5%88%B6%EF%BC%9B%E7%89%B9%E5%88%AB%E6%98%AF%E5%9C%A8%E5%BA%94%E5%AF%B9%E5%A4%A7%E9%87%8F%E6%96%B0%E4%B8%AA%E4%BD%93%E5%8A%A0%0A%09%09%E5%85%A5%E7%BD%91%E7%BB%9C%E5%92%8C%E6%97%A7%E4%B8%AA%E4%BD%93%E7%A6%BB%E5%BC%80%E7%BD%91%E7%BB%9C%28%E2%80%9Cchurn%E2%80%9D%29%E6%97%B6%E5%AE%83%E7%9A%84%E8%A1%A8%E7%8E%B0%E9%9D%9E%E5%B8%B8%E7%A8%B3%E5%AE%9A%E3%80%82%0A%09%09%E7%BC%BA%E7%82%B9%E5%9C%A8%E4%BA%8E%E5%9C%A8%E8%AF%A5%E7%BD%91%E7%BB%9C%E4%B8%AD%E6%9F%A5%E6%89%BE%E6%95%B0%E6%8D%AE%E7%9A%84%E6%95%88%E7%8E%87%E5%A4%AA%E4%BD%8E%EF%BC%8C%E5%9B%A0%E4%B8%BA%E6%B2%A1%E6%9C%89%E9%A2%84%E7%9F%A5%E4%BF%A1%E6%81%AF%EF%BC%8C%0A%09%09%E6%89%80%E4%BB%A5%E5%BE%80%E5%BE%80%E9%9C%80%E8%A6%81%E5%B0%86%E6%9F%A5%E8%AF%A2%E8%AF%B7%E6%B1%82%E5%8F%91%E9%81%8D%E6%95%B4%E4%B8%AA%E7%BD%91%E7%BB%9C%28%E8%87%B3%E5%B0%91%E5%A4%A7%E5%A4%9A%E6%95%B0%E4%B8%AA%E4%BD%93%29%EF%BC%8C%0A%09%09%E8%BF%99%E4%BC%9A%E5%8D%A0%E7%94%A8%E5%BE%88%E5%A4%A7%E4%B8%80%E9%83%A8%E5%88%86%E7%BD%91%E7%BB%9C%E8%B5%84%E6%BA%90%EF%BC%8C%E5%B9%B6%E5%A4%A7%E5%A4%A7%E6%8B%96%E6%85%A2%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%85%B6%E4%BB%96%E4%B8%9A%E5%8A%A1%E8%BF%90%E8%A1%8C%E3%80%82%0A%0A%09%E7%BB%93%E6%9E%84%E5%8C%96%E7%9A%84%0A%09%09%E8%BF%99%E7%A7%8Dp2p%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E4%B8%AA%E4%BD%93%E5%88%86%E5%B8%83%E7%BB%8F%E8%BF%87%E7%B2%BE%E5%BF%83%E8%AE%BE%E8%AE%A1%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%9B%AE%E7%9A%84%E6%98%AF%E4%B8%BA%E4%BA%86%E6%8F%90%E9%AB%98%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E7%9A%84%E6%95%88%E7%8E%87%EF%BC%8C%0A%09%09%E9%99%8D%E4%BD%8E%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%B8%A6%E6%9D%A5%E7%9A%84%E8%B5%84%E6%BA%90%E6%B6%88%E8%80%97%E3%80%82%0A%09%E4%BB%A5%E5%A4%AA%E5%9D%8A%E9%87%87%E7%94%A8%E4%BA%86%E4%B8%8D%E9%9C%80%E8%A6%81%E7%BB%93%E6%9E%84%E5%8C%96%E7%9A%84%E7%BB%93%E6%9E%84%EF%BC%8C%E7%BB%8F%E8%BF%87%E6%94%B9%E8%BF%9B%E7%9A%84%E9%9D%9E%E7%BB%93%E6%9E%84%E5%8C%96%28%E6%AF%94%E5%A6%82%E8%AE%BE%E8%AE%A1%E5%A5%BD%E7%9B%B8%E9%82%BB%E4%B8%AA%E4%BD%93%E5%88%97%E8%A1%A8peerSet%E7%BB%93%E6%9E%84%29%0A%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B%E5%8F%AF%E4%BB%A5%E6%BB%A1%E8%B6%B3%E9%9C%80%E6%B1%82%EF%BC%9B%0A%0A%E4%BA%8C%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8Fhash%E8%A1%A8%EF%BC%88DHT%EF%BC%89%0A%E4%BF%9D%E5%AD%98%E6%95%B0%E6%8D%AE%0A%EF%BC%88%E4%BB%A5%E4%B8%8B%E5%8F%AA%E6%98%AF%E5%A4%A7%E8%87%B4%E5%8E%9F%E7%90%86%EF%BC%8C%E5%85%B7%E4%BD%93%E7%9A%84%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E5%8F%AF%E8%83%BD%E4%BC%9A%E6%9C%89%E5%B7%AE%E5%BC%82%EF%BC%89%0A%09%E5%BD%93%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E5%BE%97%E5%88%B0%E4%BA%86%E6%96%B0%E5%8A%A0%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%88K%2FV%EF%BC%89%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%85%88%E8%AE%A1%E7%AE%97%E8%87%AA%E5%B7%B1%E4%B8%8E%E6%96%B0%E6%95%B0%E6%8D%AE%E7%9A%84+key+%E4%B9%8B%E9%97%B4%E7%9A%84%E2%80%9C%E8%B7%9D%E7%A6%BB%E2%80%9D%EF%BC%9B%0A%E7%84%B6%E5%90%8E%E5%86%8D%E8%AE%A1%E7%AE%97%E5%AE%83%E6%89%80%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%B6%E5%AE%83%E8%8A%82%E7%82%B9%E4%B8%8E%E8%BF%99%E4%B8%AA+key+%E7%9A%84%E8%B7%9D%E7%A6%BB%E3%80%82%0A%E5%A6%82%E6%9E%9C%E8%AE%A1%E7%AE%97%E4%B8%8B%E6%9D%A5%EF%BC%8C%E8%87%AA%E5%B7%B1%E4%B8%8E+key+%E7%9A%84%E8%B7%9D%E7%A6%BB%E6%9C%80%E5%B0%8F%EF%BC%8C%E9%82%A3%E4%B9%88%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%B0%B1%E4%BF%9D%E6%8C%81%E5%9C%A8%E8%87%AA%E5%B7%B1%E8%BF%99%E9%87%8C%E3%80%82%0A%E5%90%A6%E5%88%99%E7%9A%84%E8%AF%9D%EF%BC%8C%E6%8A%8A%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%E8%BD%AC%E5%8F%91%E7%BB%99%E8%B7%9D%E7%A6%BB%E6%9C%80%E5%B0%8F%E7%9A%84%E8%8A%82%E7%82%B9%E3%80%82%0A%E6%94%B6%E5%88%B0%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E4%B9%9F%E9%87%87%E7%94%A8%E4%B8%8A%E8%BF%B0%E8%BF%87%E7%A8%8B%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%88%E9%80%92%E5%BD%92%E5%A4%84%E7%90%86%EF%BC%89%E3%80%82%0A%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%0A%EF%BC%88%E4%BB%A5%E4%B8%8B%E5%8F%AA%E6%98%AF%E5%A4%A7%E8%87%B4%E5%8E%9F%E7%90%86%EF%BC%8C%E5%85%B7%E4%BD%93%E7%9A%84%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E5%8F%AF%E8%83%BD%E4%BC%9A%E6%9C%89%E5%B7%AE%E5%BC%82%EF%BC%89%0A%09%E5%BD%93%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E6%8E%A5%E6%94%B6%E5%88%B0%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AF%B7%E6%B1%82%EF%BC%88key%EF%BC%89%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%85%88%E8%AE%A1%E7%AE%97%E8%87%AA%E5%B7%B1%E4%B8%8E+key+%E4%B9%8B%E9%97%B4%E7%9A%84%E2%80%9C%E8%B7%9D%E7%A6%BB%E2%80%9D%EF%BC%9B%0A%09%E7%84%B6%E5%90%8E%E5%86%8D%E8%AE%A1%E7%AE%97%E5%AE%83%E6%89%80%E7%9F%A5%E9%81%93%E7%9A%84%E5%85%B6%E5%AE%83%E8%8A%82%E7%82%B9%E4%B8%8E%E8%BF%99%E4%B8%AA+key+%E7%9A%84%E8%B7%9D%E7%A6%BB%E3%80%82%0A%E5%A6%82%E6%9E%9C%E8%AE%A1%E7%AE%97%E4%B8%8B%E6%9D%A5%EF%BC%8C%E8%87%AA%E5%B7%B1%E4%B8%8E+key+%E7%9A%84%E8%B7%9D%E7%A6%BB%E6%9C%80%E5%B0%8F%EF%BC%8C%E9%82%A3%E4%B9%88%E5%B0%B1%E5%9C%A8%E8%87%AA%E5%B7%B1%E8%BF%99%E9%87%8C%E6%89%BE%E6%9C%89%E6%B2%A1%E6%9C%89+key+%E5%AF%B9%E5%BA%94%E7%9A%84+value%E3%80%82%0A%E6%9C%89%E7%9A%84%E8%AF%9D%E5%B0%B1%E8%BF%94%E5%9B%9E+value%EF%BC%8C%E6%B2%A1%E6%9C%89%E7%9A%84%E8%AF%9D%E5%B0%B1%E6%8A%A5%E9%94%99%E3%80%82%0A%E5%90%A6%E5%88%99%E7%9A%84%E8%AF%9D%EF%BC%8C%E6%8A%8A%E8%BF%99%E4%B8%AA%E6%95%B0%E6%8D%AE%E8%BD%AC%E5%8F%91%E7%BB%99%E8%B7%9D%E7%A6%BB%E6%9C%80%E5%B0%8F%E7%9A%84%E8%8A%82%E7%82%B9%E3%80%82%0A%E6%94%B6%E5%88%B0%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9%EF%BC%8C%E4%B9%9F%E9%87%87%E7%94%A8%E4%B8%8A%E8%BF%B0%E8%BF%87%E7%A8%8B%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%88%E9%80%92%E5%BD%92%E5%A4%84%E7%90%86%EF%BC%89%E3%80%82%0A%0A%0A%0A%E4%B8%89%E3%80%81%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%ADp2p%E9%80%9A%E4%BF%A1%E7%9A%84%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97ProtocolManager%0A%0A%2Fgeth.go%0A%2F%2F+Start+creates+a+live+P2P+node+and+starts+running+it.%0Afunc+%28n+*Node%29+Start%28%29+error+%7B%0A%09return+n.node.Start%28%29%0A%7D%0A%0A%2F*%0A%09Protocol%3A%E5%AE%B9%E7%BA%B3%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%89%80%E8%A6%81%E6%B1%82%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%AD%89.%E5%B9%B6%E9%80%9A%E8%BF%87p2p.Server%7B%7D%E5%9C%A8%E6%96%B0%E8%BF%9E%E6%8E%A5%E5%BB%BA%E7%AB%8B%E5%90%8E%EF%BC%8C%E5%B0%86%E5%85%B6%E4%BC%A0%E9%80%92%E7%BB%99%E9%80%9A%E4%BF%A1%E5%AF%B9%E8%B1%A1peer%E3%80%82%0A%09Node.Start%28%29%E4%B8%AD%E9%A6%96%E5%85%88%E4%BC%9A%E5%88%9B%E5%BB%BAp2p.Server%7B%7D%EF%BC%8C%E6%AD%A4%E6%97%B6Server%E4%B8%AD%E7%9A%84Protocol%5B%5D%E8%BF%98%E6%98%AF%E7%A9%BA%E7%9A%84%EF%BC%9B%0A%09%E7%84%B6%E5%90%8E%E5%B0%86Node%E4%B8%AD%E8%BD%BD%E5%85%A5%E7%9A%84%E6%89%80%E6%9C%89%26lt%3BService%26gt%3B%E5%AE%9E%E7%8E%B0%E4%BD%93%E4%B8%AD%E7%9A%84Protocol%E9%83%BD%E6%94%B6%E9%9B%86%E8%B5%B7%E6%9D%A5%EF%BC%8C%0A%09%E4%B8%80%E5%B9%B6%E4%BA%A4%E7%BB%99Server%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%BD%9C%E4%B8%BAServer.Protocols%E5%88%97%E8%A1%A8%EF%BC%9B%E7%84%B6%E5%90%8E%E5%90%AF%E5%8A%A8Server%E5%AF%B9%E8%B1%A1%EF%BC%8C%0A%09%E5%B9%B6%E5%B0%86Server%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%E5%8E%BB%E9%80%90%E4%B8%80%E5%90%AF%E5%8A%A8%E6%AF%8F%E4%B8%AA%26lt%3BService%26gt%3B%E5%AE%9E%E7%8E%B0%E4%BD%93%E3%80%82%0A%0A*%2F%0A%2Fnode.go%0A%2F%2F+Start+create+a+live+P2P+node+and+starts+running+it.%0Afunc+%28n+*Node%29+Start%28%29+error+%7B%0A%09%0A%09...%0A%09%2F*%0A%09%09...%0A%09%09%E5%88%9D%E5%A7%8B%E5%8C%96serverConfig%0A%09*%2F%0A%09running+%3A%3D+%26amp%3Bp2p.Server%7BConfig%3A+n.serverConfig%7D%0A%09...%0A%09%2F%2F+Gather+the+protocols+and+start+the+freshly+assembled+P2P+server%0A%09for+_%2C+service+%3A%3D+range+services+%7B%0A%09%09running.Protocols+%3D+append%28running.Protocols%2C+service.Protocols%28%29...%29%0A%09%7D%0A%09if+err+%3A%3D+running.Start%28%29%3B+err+%21%3D+nil+%7B+%2F%2F%E8%A7%81%E4%B8%8B%E9%9D%A2%E7%9A%84%28srv+*Server%29Start%E6%96%B9%E6%B3%95%0A%09%09return+convertFileLockError%28err%29%0A%09%7D%0A%09%2F%2F+Start+each+of+the+services%0A%09started+%3A%3D+%5B%5Dreflect.Type%7B%7D%0A%09for+kind%2C+service+%3A%3D+range+services+%7B%0A%09%09%2F%2F+Start+the+next+service%2C+stopping+all+previous+upon+failure%0A%09%09%2F%2F%E5%90%AF%E5%8A%A8%E6%AF%8F%E4%B8%AAservices%E9%80%9A%E8%BF%87%E4%B8%8B%E9%9D%A2%E7%9A%84%E6%96%B9%E6%B3%95func+%28s+*Ethereum%29+Start%28srvr+*p2p.Server%29+error+%7B%0A%09%09if+err+%3A%3D+service.Start%28running%29%3B+err+%21%3D+nil+%7B%0A%09%09%09for+_%2C+kind+%3A%3D+range+started+%7B%0A%09%09%09%09services%5Bkind%5D.Stop%28%29%0A%09%09%09%7D%0A%09%09%09running.Stop%28%29%0A%0A%09%09%09return+err%0A%09%09%7D%0A%09%09...%0A%09%7D%0A%7D%0A%0A%0A%2F%2F+Start+starts+running+the+server.%0A%2F%2F+Servers+can+not+be+re-used+after+stopping.%0Afunc+%28srv+*Server%29+Start%28%29+%28err+error%29+%7B%0A%09srv.lock.Lock%28%29%0A%09%2F%2Fsrv.lock%E4%B8%BA%E4%BA%86%E9%81%BF%E5%85%8D%E5%A4%9A%E7%BA%BF%E7%A8%8B%E9%87%8D%E5%A4%8D%E5%90%AF%E5%8A%A8%0A%09defer+srv.lock.Unlock%28%29%0A%09if+srv.running+%7B%0A%09%09return+errors.New%28%22server+already+running%22%29%0A%09%7D%0A%09srv.running+%3D+true%0A%09srv.log+%3D+srv.Config.Logger%0A%09if+srv.log+%3D%3D+nil+%7B%0A%09%09srv.log+%3D+log.New%28%29%0A%09%7D%0A%09if+srv.NoDial+%26amp%3B%26amp%3B+srv.ListenAddr+%3D%3D+%22%22+%7B%0A%09%09srv.log.Warn%28%22P2P+server+will+be+useless%2C+neither+dialing+nor+listening%22%29%0A%09%7D%0A%0A%09%2F%2F+static+fields%0A%09if+srv.PrivateKey+%3D%3D+nil+%7B%0A%09%09return+fmt.Errorf%28%22Server.PrivateKey+must+be+set+to+a+non-nil+key%22%29%0A%09%7D%0A%09%2F%2FnewTransport%E4%BD%BF%E7%94%A8%E4%BA%86newRLPX%E4%BD%BF%E7%94%A8%E4%BA%86rlpx.go%E4%B8%AD%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E3%80%82%0A%09if+srv.newTransport+%3D%3D+nil+%7B%0A%09%09srv.newTransport+%3D+newRLPX%0A%09%7D%0A%0A%09if+srv.Dialer+%3D%3D+nil+%7B%0A%09%09srv.Dialer+%3D+TCPDialer%7B%26amp%3Bnet.Dialer%7BTimeout%3A+defaultDialTimeout%7D%7D%0A%09%7D%0A%09srv.quit+%3D+make%28chan+struct%7B%7D%29%0A%09srv.addpeer+%3D+make%28chan+*conn%29%0A%09srv.delpeer+%3D+make%28chan+peerDrop%29%0A%09srv.posthandshake+%3D+make%28chan+*conn%29%0A%09srv.addstatic+%3D+make%28chan+*enode.Node%29%0A%09srv.removestatic+%3D+make%28chan+*enode.Node%29%0A%09srv.addtrusted+%3D+make%28chan+*enode.Node%29%0A%09srv.removetrusted+%3D+make%28chan+*enode.Node%29%0A%09srv.peerOp+%3D+make%28chan+peerOpFunc%29%0A%09srv.peerOpDone+%3D+make%28chan+struct%7B%7D%29%0A%09%2F%2Fsrv.setupLocalNode%28%29%E8%BF%99%E9%87%8C%E4%B8%BB%E8%A6%81%E6%89%A7%E8%A1%8C%E6%8F%A1%E6%89%8B%0A%09if+err+%3A%3D+srv.setupLocalNode%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09if+srv.ListenAddr+%21%3D+%22%22+%7B%0A%09%09%2F%2F%E7%9B%91%E5%90%ACTCP%E7%AB%AF%E5%8F%A3--%26gt%3B%E7%94%A8%E4%BA%8E%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%EF%BC%8C%E5%9F%BA%E4%BA%8ERLPx%E5%8D%8F%E8%AE%AE%EF%BC%89%0A%09%09%2F%2F%E5%9C%A8setupListening%E4%B8%AD%E6%9C%89%E4%B8%AAgo+srv.listenLoop%28%29%E5%8E%BB%E7%9B%91%E5%90%AC%E6%9F%90%E4%B8%AA%E7%AB%AF%E5%8F%A3%E6%9C%89%E6%97%A0%E4%B8%BB%E5%8A%A8%E5%8F%91%E6%9D%A5%E7%9A%84IP%E8%BF%9E%E6%8E%A5%0A%0A%09%09if+err+%3A%3D+srv.setupListening%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%0A%09%2F%2F%E4%BE%A6%E5%90%ACUDP%E7%AB%AF%E5%8F%A3%EF%BC%88%E7%94%A8%E4%BA%8E%E7%BB%93%E7%82%B9%E5%8F%91%E7%8E%B0%E5%86%85%E9%83%A8%E4%BC%9A%E5%90%AF%E5%8A%A8goroutine%EF%BC%89%0A%09if+err+%3A%3D+srv.setupDiscovery%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%0A%09dynPeers+%3A%3D+srv.maxDialedConns%28%29%0A%09dialer+%3A%3D+newDialState%28srv.localnode.ID%28%29%2C+srv.StaticNodes%2C+srv.BootstrapNodes%2C+srv.ntab%2C+dynPeers%2C+srv.NetRestrict%29%0A%09srv.loopWG.Add%281%29%0A%09%2F%2F+%E5%90%AF%E5%8A%A8%E6%96%B0%E7%BA%BF%E7%A8%8B%E5%8F%91%E8%B5%B7TCP%E8%BF%9E%E6%8E%A5%E8%AF%B7%E6%B1%82%0A%0A%09%2F%2F%E5%9C%A8run%28%29%E5%87%BD%E6%95%B0%E4%B8%AD%EF%BC%8C%E7%9B%91%E5%90%ACsrv.addpeer%E9%80%9A%E9%81%93%E6%9C%89%E6%B2%A1%E6%9C%89%E4%BF%A1%E6%81%AF%E5%A6%82%E6%9E%9C%E6%9C%89%E8%BF%9C%E7%AB%AFpeer%E5%8F%91%E6%9D%A5%E8%BF%9E%E6%8E%A5%E8%AF%B7%E6%B1%82%EF%BC%8C%0A%09%2F%2F%E5%88%99%E8%B0%83%E7%94%A8Server.newPeer%28%29%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84peer%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E6%8A%8AServer.Protocols%E5%85%A8%E4%BA%A4%E7%BB%99peer%E3%80%82%0A%09%2F*%0A%09case+c+%3A%3D+%26lt%3B-srv.addpeer%3A%0A%09%09err+%3A%3D+srv.protoHandshakeChecks%28peers%2C+inboundCount%2C+c%29%0A%09%09if+err+%3D%3D+nil+%7B%0A%09%09%09%2F%2F+The+handshakes+are+done+and+it+passed+all+checks.%0A%09%09%09p+%3A%3D+newPeer%28c%2C+srv.Protocols%29%0A%09%09%7D%0A%09*%2F%0A%09go+srv.run%28dialer%29%0A%09return+nil%0A%7D%0A%0A%0A%2F%2F+Start+implements+node.Service%2C+starting+all+internal+goroutines+needed+by+the%0A%2F%2F+Ethereum+protocol+implementation.%0Afunc+%28s+*Ethereum%29+Start%28srvr+*p2p.Server%29+error+%7B%0A%09%2F%2F+Start+the+bloom+bits+servicing+goroutines%0A%09s.startBloomHandlers%28params.BloomBitsBlocks%29%0A%0A%09%2F%2F+Start+the+RPC+service%0A%09s.netRPCService+%3D+ethapi.NewPublicNetAPI%28srvr%2C+s.NetVersion%28%29%29%0A%0A%09%2F%2F+Figure+out+a+max+peers+count+based+on+the+server+limits%0A%09maxPeers+%3A%3D+srvr.MaxPeers%0A%09if+s.config.LightServ+%26gt%3B+0+%7B%0A%09%09if+s.config.LightPeers+%26gt%3B%3D+srvr.MaxPeers+%7B%0A%09%09%09return+fmt.Errorf%28%22invalid+peer+config%3A+light+peer+count+%28%25d%29+%26gt%3B%3D+total+peer+count+%28%25d%29%22%2C+s.config.LightPeers%2C+srvr.MaxPeers%29%0A%09%09%7D%0A%09%09maxPeers+-%3D+s.config.LightPeers%0A%09%7D%0A%09%2F%2F+Start+the+networking+layer+and+the+light+server+if+requested%0A%09s.protocolManager.Start%28maxPeers%29%0A%09if+s.lesServer+%21%3D+nil+%7B%0A%09%09s.lesServer.Start%28srvr%29%0A%09%7D%0A%09return+nil%0A%7D%0A%0A%2Feth%2Fhandler.go%0A%0Atype+ProtocolManager+struct+%7B%0A%09networkID+uint64%0A%0A%09fastSync++uint32+%2F%2F+Flag+whether+fast+sync+is+enabled+%28gets+disabled+if+we+already+have+blocks%29%0A%09acceptTxs+uint32+%2F%2F+Flag+whether+we%27re+considered+synchronised+%28enables+transaction+processing%29%0A%0A%09txpool++++++txPool%0A%09blockchain++*core.BlockChain%0A%09chainconfig+*params.ChainConfig%0A%09maxPeers++++int%0A%0A%09%2F%2FDownloader%E7%B1%BB%E5%9E%8B%E6%88%90%E5%91%98%E8%B4%9F%E8%B4%A3%E6%89%80%E6%9C%89%E5%90%91%E7%9B%B8%E9%82%BB%E4%B8%AA%E4%BD%93%E4%B8%BB%E5%8A%A8%E5%8F%91%E8%B5%B7%E7%9A%84%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B%E3%80%82%0A%09downloader+*downloader.Downloader%0A%09%2F%2FFetcher%E7%B1%BB%E5%9E%8B%E6%88%90%E5%91%98%E7%B4%AF%E7%A7%AF%E6%89%80%E6%9C%89%E5%85%B6%E4%BB%96%E4%B8%AA%E4%BD%93%E5%8F%91%E9%80%81%E6%9D%A5%E7%9A%84%E6%9C%89%E5%85%B3%E6%96%B0%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%A3%E5%B8%83%E6%B6%88%E6%81%AF%EF%BC%8C%E5%B9%B6%E5%9C%A8%E8%87%AA%E8%BA%AB%E5%AF%B9%E7%85%A7%E5%90%8E%E5%81%9A%E5%87%BA%E5%AE%89%E6%8E%92%0A%09fetcher++++*fetcher.Fetcher%0A%09%2F%2F%E7%94%A8%E6%9D%A5%E7%BC%93%E5%AD%98%E7%9B%B8%E9%82%BB%E4%B8%AA%E4%BD%93%E5%88%97%E8%A1%A8%EF%BC%8Cpeer%7B%7D%E8%A1%A8%E7%A4%BA%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E8%BF%9C%E7%AB%AF%E4%B8%AA%E4%BD%93%E3%80%82%0A%09peers++++++*peerSet%0A%0A%09SubProtocols+%5B%5Dp2p.Protocol%0A%0A%09eventMux++++++*event.TypeMux%0A%09txsCh+++++++++chan+core.NewTxsEvent%0A%09txsSub++++++++event.Subscription%0A%09minedBlockSub+*event.TypeMuxSubscription%0A%0A%09%0A%09%2F%2F%E9%80%9A%E8%BF%87%E5%90%84%E7%A7%8D%E9%80%9A%E9%81%93%28chan%29%E5%92%8C%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85%28subscription%29%E7%9A%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E6%8E%A5%E6%94%B6%E5%92%8C%E5%8F%91%E9%80%81%E5%8C%85%E6%8B%AC%E4%BA%A4%E6%98%93%E5%92%8C%E5%8C%BA%E5%9D%97%E5%9C%A8%E5%86%85%E7%9A%84%E6%95%B0%E6%8D%AE%E6%9B%B4%E6%96%B0%E3%80%82%0A%09%2F%2F%E5%BD%93%E7%84%B6%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%EF%BC%8C%E8%AE%A2%E9%98%85%E4%B9%9F%E5%BE%80%E5%BE%80%E5%88%A9%E7%94%A8%E9%80%9A%E9%81%93%E6%9D%A5%E5%AE%9E%E7%8E%B0%E4%BA%8B%E4%BB%B6%E9%80%9A%E7%9F%A5%E3%80%82%0A%0A%09%2F%2F+channels+for+fetcher%2C+syncer%2C+txsyncLoop%0A%09newPeerCh+++chan+*peer%0A%09txsyncCh++++chan+*txsync%0A%09quitSync++++chan+struct%7B%7D%0A%09noMorePeers+chan+struct%7B%7D%0A%0A%09%2F%2F+wait+group+is+used+for+graceful+shutdowns+during+downloading%0A%09%2F%2F+and+processing%0A%09wg+sync.WaitGroup%0A%7D%0A%0A%09Start%28%29%E5%87%BD%E6%95%B0%E6%98%AFProtocolManager%E7%9A%84%E5%90%AF%E5%8A%A8%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%9C%A8eth.Ethereum.Start%28%29%E4%B8%AD%E8%A2%AB%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E3%80%82%0AProtocolManager.Start%28%29%E4%BC%9A%E5%90%AF%E7%94%A84%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%BA%BF%E7%A8%8B%28goroutine%2C%E5%8D%8F%E7%A8%8B%29%E5%8E%BB%E5%88%86%E5%88%AB%E6%89%A7%E8%A1%8C4%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%0A%E8%BF%99%E4%B9%9F%E6%A0%87%E5%BF%97%E7%9D%80%E8%AF%A5%E4%BB%A5%E5%A4%AA%E5%9D%8A%E4%B8%AA%E4%BD%93p2p%E9%80%9A%E4%BF%A1%E7%9A%84%E5%85%A8%E9%9D%A2%E5%90%AF%E5%8A%A8%E3%80%82%0A%0A%0Afunc+%28pm+*ProtocolManager%29+Start%28maxPeers+int%29+%7B%0A%09pm.maxPeers+%3D+maxPeers%0A%0A%09%2F%2F+broadcast+transactions%0A%09%2F%2F%E5%B9%BF%E6%92%AD%E4%BA%A4%E6%98%93%E7%9A%84%E9%80%9A%E9%81%93%E3%80%82+txsCh%E4%BC%9A%E4%BD%9C%E4%B8%BAtxpool%E7%9A%84TxPreEvent%E8%AE%A2%E9%98%85%E9%80%9A%E9%81%93%E3%80%82%0A%09%2F%2Ftxpool%E6%9C%89%E4%BA%86%E8%BF%99%E7%A7%8D%E6%B6%88%E6%81%AF%E4%BC%9A%E9%80%9A%E7%9F%A5%E7%BB%99%E8%BF%99%E4%B8%AAtxsCh%E3%80%82+%E5%B9%BF%E6%92%AD%E4%BA%A4%E6%98%93%E7%9A%84goroutine%E4%BC%9A%E6%8A%8A%E8%BF%99%E4%B8%AA%E6%B6%88%E6%81%AF%E5%B9%BF%E6%92%AD%E5%87%BA%E5%8E%BB%E3%80%82%0A%09pm.txsCh+%3D+make%28chan+core.NewTxsEvent%2C+txChanSize%29%0A%09%2F%2F%E8%AE%A2%E9%98%85%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF%0A%09pm.txsSub+%3D+pm.txpool.SubscribeNewTxsEvent%28pm.txsCh%29%0A%09%0A%09go+pm.txBroadcastLoop%28%29%0A%0A%09%2F%2F%E8%AE%A2%E9%98%85%E6%8C%96%E7%9F%BF%E6%B6%88%E6%81%AF%E3%80%82%E5%BD%93%E6%96%B0%E7%9A%84Block%E8%A2%AB%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E4%BA%A7%E7%94%9F%E6%B6%88%E6%81%AF%0A%09%2F%2F+broadcast+mined+blocks%0A%09pm.minedBlockSub+%3D+pm.eventMux.Subscribe%28core.NewMinedBlockEvent%7B%7D%29%0A%09%2F%2F%E6%8C%96%E7%9F%BF%E5%B9%BF%E6%92%AD+goroutine+%E5%BD%93%E6%8C%96%E5%87%BA%E6%9D%A5%E7%9A%84%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E5%B0%BD%E5%BF%AB%E7%9A%84%E5%B9%BF%E6%92%AD%E5%88%B0%E7%BD%91%E7%BB%9C%E4%B8%8A%E9%9D%A2%E5%8E%BB%E3%80%82%0A%09go+pm.minedBroadcastLoop%28%29%0A%0A%09%2F%2F+start+sync+handlers%0A%09%2F%2F+%E5%90%8C%E6%AD%A5%E5%99%A8%E8%B4%9F%E8%B4%A3%E5%91%A8%E6%9C%9F%E6%80%A7%E5%9C%B0%E4%B8%8E%E7%BD%91%E7%BB%9C%E5%90%8C%E6%AD%A5%EF%BC%8C%E4%B8%8B%E8%BD%BD%E6%95%A3%E5%88%97%E5%92%8C%E5%9D%97%E4%BB%A5%E5%8F%8A%E5%A4%84%E7%90%86%E9%80%9A%E7%9F%A5%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F%E3%80%82%0A%09go+pm.syncer%28%29%0A%09%2F%2F+txsyncLoop%E8%B4%9F%E8%B4%A3%E6%AF%8F%E4%B8%AA%E6%96%B0%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%88%9D%E5%A7%8B%E4%BA%8B%E5%8A%A1%E5%90%8C%E6%AD%A5%E3%80%82+%E5%BD%93%E6%96%B0%E7%9A%84peer%E5%87%BA%E7%8E%B0%E6%97%B6%EF%BC%8C%0A%09%2F%2F+%E8%BD%AC%E5%8F%91%E6%89%80%E6%9C%89%E5%BD%93%E5%89%8D%E5%BE%85%E5%A4%84%E7%90%86%E7%9A%84%E4%BA%8B%E5%8A%A1%E3%80%82%E4%B8%BA%E4%BA%86%E6%9C%80%E5%B0%8F%E5%8C%96%E5%87%BA%E5%8F%A3%E5%B8%A6%E5%AE%BD%E4%BD%BF%E7%94%A8%EF%BC%8C%E6%88%91%E4%BB%AC%E4%B8%80%E6%AC%A1%E5%8F%AA%E5%8F%91%E9%80%81%E4%B8%80%E4%B8%AA%E5%B0%8F%E5%8C%85%E3%80%82%0A%09go+pm.txsyncLoop%28%29%0A%7D%0A%0A%2F%2FtxBroadcastLoop%28%29%E4%BC%9A%E5%9C%A8txCh%E9%80%9A%E9%81%93%E7%9A%84%E6%94%B6%E7%AB%AF%E6%8C%81%E7%BB%AD%E7%AD%89%E5%BE%85%EF%BC%8C%E4%B8%80%E6%97%A6%E6%8E%A5%E6%94%B6%E5%88%B0%E6%9C%89%E5%85%B3%E6%96%B0%E4%BA%A4%E6%98%93%E7%9A%84%E4%BA%8B%E4%BB%B6%EF%BC%8C%0A%09%2F%2F%E4%BC%9A%E7%AB%8B%E5%8D%B3%E8%B0%83%E7%94%A8BroadcastTx%28%29%E5%87%BD%E6%95%B0%E5%B9%BF%E6%92%AD%E7%BB%99%E9%82%A3%E4%BA%9B%E5%B0%9A%E6%97%A0%E8%AF%A5%E4%BA%A4%E6%98%93%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%9B%B8%E9%82%BB%E4%B8%AA%E4%BD%93%E3%80%82%0A%2F%2F------------------go+pm.txBroadcastLoop%28%29-----------------------%0Afunc+%28pm+*ProtocolManager%29+txBroadcastLoop%28%29+%7B%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+event+%3A%3D+%26lt%3B-pm.txsCh%3A%0A%09%09%09pm.BroadcastTxs%28event.Txs%29%0A%0A%09%09%2F%2F+Err%28%29+channel+will+be+closed+when+unsubscribing.%0A%09%09case+%26lt%3B-pm.txsSub.Err%28%29%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%0A%0A%0A%2F%2F+BroadcastTxs+will+propagate+a+batch+of+transactions+to+all+peers+which+are+not+known+to%0A%2F%2F+already+have+the+given+transaction.%0Afunc+%28pm+*ProtocolManager%29+BroadcastTxs%28txs+types.Transactions%29+%7B%0A%09var+txset+%3D+make%28map%5B*peer%5Dtypes.Transactions%29%0A%0A%09%2F%2F+Broadcast+transactions+to+a+batch+of+peers+not+knowing+about+it%0A%09for+_%2C+tx+%3A%3D+range+txs+%7B%0A%09%09peers+%3A%3D+pm.peers.PeersWithoutTx%28tx.Hash%28%29%29%0A%09%09for+_%2C+peer+%3A%3D+range+peers+%7B%0A%09%09%09txset%5Bpeer%5D+%3D+append%28txset%5Bpeer%5D%2C+tx%29%0A%09%09%7D%0A%09%09log.Trace%28%22Broadcast+transaction%22%2C+%22hash%22%2C+tx.Hash%28%29%2C+%22recipients%22%2C+len%28peers%29%29%0A%09%7D%0A%09%2F%2F+FIXME+include+this+again%3A+peers+%3D+peers%5B%3Aint%28math.Sqrt%28float64%28len%28peers%29%29%29%29%5D%0A%09for+peer%2C+txs+%3A%3D+range+txset+%7B%0A%09%09peer.AsyncSendTransactions%28txs%29%0A%09%7D%0A%7D%0A%0A%2F%2F+AsyncSendTransactions+queues+list+of+transactions+propagation+to+a+remote%0A%2F%2F+peer.+If+the+peer%27s+broadcast+queue+is+full%2C+the+event+is+silently+dropped.%0A%2F%2F+%E5%90%8C%E6%AD%A5Tx%E7%BB%99%E6%AF%8F%E4%B8%AA%E7%9B%B8%E9%82%BB%E6%9C%AA%E7%9F%A5Tx%E7%9A%84peer%0Afunc+%28p+*peer%29+AsyncSendTransactions%28txs+%5B%5D*types.Transaction%29+%7B%0A%09select+%7B%0A%09case+p.queuedTxs+%26lt%3B-+txs%3A%0A%09%09for+_%2C+tx+%3A%3D+range+txs+%7B%0A%09%09%09p.knownTxs.Add%28tx.Hash%28%29%29%0A%09%09%7D%0A%09default%3A%0A%09%09p.Log%28%29.Debug%28%22Dropping+transaction+propagation%22%2C+%22count%22%2C+len%28txs%29%29%0A%09%7D%0A%7D%0A%0A%2F%2F------------------go+pm.minedBroadcastLoop%28%29-----------------------%0A%0A%2F%2F+Mined+broadcast+loop%0A%2F%2F%E6%8C%96%E7%9F%BF%E4%B9%8B%E5%90%8E%E7%9A%84%E5%B9%BF%E6%92%AD%0Afunc+%28pm+*ProtocolManager%29+minedBroadcastLoop%28%29+%7B%0A%09%2F%2F+automatically+stops+if+unsubscribe%0A%09for+obj+%3A%3D+range+pm.minedBlockSub.Chan%28%29+%7B%0A%09%09%2F%2FData%E4%B8%BAinterface%7B%7D+%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%8E%A5%E5%8F%A3%E6%96%AD%E8%A8%80%E7%9A%84%E6%96%B9%E6%B3%95%E5%B0%86Data%E8%BD%AC%E5%8C%96%E4%B8%BA%E7%B1%BB%E5%9E%8BNewMinedBlockEvent%0A%09%09if+ev%2C+ok+%3A%3D+obj.Data.%28core.NewMinedBlockEvent%29%3B+ok+%7B%0A%09%09%09%2F%2FBroadcastBlock%E7%9A%84%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E4%B8%BAtrue%E6%97%B6%EF%BC%8C%E4%BC%9A%E5%B0%86%E6%95%B4%E4%B8%AA%E6%96%B0%E5%8C%BA%E5%9D%97%E4%BE%9D%E6%AC%A1%E5%8F%91%E7%BB%99%E7%9B%B8%E9%82%BB%E5%8C%BA%E5%9D%97%E4%B8%AD%E7%9A%84%E4%B8%80%E5%B0%8F%E9%83%A8%E5%88%86%EF%BC%9B%0A%09%09%09%2F%2F%E8%80%8C%E5%BD%93%E5%85%B6%E4%B8%BAfalse%E6%97%B6%EF%BC%8C%E4%BB%85%E4%BB%85%E5%B0%86%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84Hash%E5%80%BC%E5%92%8CNumber%E5%8F%91%E9%80%81%E7%BB%99%E6%89%80%E6%9C%89%E7%9B%B8%E9%82%BB%E5%88%97%E8%A1%A8%E3%80%82%0A%09%09%09pm.BroadcastBlock%28ev.Block%2C+true%29++%2F%2F+First+propagate+block+to+peers%0A%09%09%09pm.BroadcastBlock%28ev.Block%2C+false%29+%2F%2F+Only+then+announce+to+the+rest%0A%09%09%7D%0A%09%7D%0A%7D%0A%2F%2F---------------------------go+pm.syncer%28%29-----------------------------%0A%2F*%0A%09syncer%28%29%E9%A6%96%E5%85%88%E5%90%AF%E5%8A%A8fetcher%E6%88%90%E5%91%98%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%9B%E5%85%A5%E4%B8%80%E4%B8%AA%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF%EF%BC%8C%0A%09%E6%AF%8F%E6%AC%A1%E5%BE%AA%E7%8E%AF%E4%B8%AD%E9%83%BD%E4%BC%9A%E5%90%91%E7%9B%B8%E9%82%BBpeer%E5%88%97%E8%A1%A8%E4%B8%AD%E2%80%9C%E6%9C%80%E4%BC%98%E2%80%9D%E7%9A%84%E9%82%A3%E4%B8%AApeer%E4%BD%9C%E4%B8%80%E6%AC%A1%E5%8C%BA%E5%9D%97%E5%85%A8%E9%93%BE%E5%90%8C%E6%AD%A5%E3%80%82%0A%09%E5%8F%91%E8%B5%B7%E4%B8%8A%E8%BF%B0%E5%90%8C%E6%AD%A5%E7%9A%84%E7%90%86%E7%94%B1%E5%88%86%E4%B8%A4%E7%A7%8D%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%9C%89%E6%96%B0%E7%99%BB%E8%AE%B0%28%E5%8A%A0%E5%85%A5%29%E7%9A%84%E7%9B%B8%E9%82%BB%E4%B8%AA%E4%BD%93%EF%BC%8C%E5%88%99%E5%9C%A8%E6%95%B4%E4%B8%AApeer%E5%88%97%E8%A1%A8%E6%95%B0%E7%9B%AE%E5%A4%A7%E4%BA%8E5%E6%97%B6%EF%BC%8C%0A%09%E5%8F%91%E8%B5%B7%E4%B9%8B%EF%BC%9B%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E6%96%B0peer%E5%88%B0%E8%BE%BE%EF%BC%8C%E5%88%99%E4%BB%A510s%E4%B8%BA%E9%97%B4%E9%9A%94%E5%AE%9A%E6%97%B6%E7%9A%84%E5%8F%91%E8%B5%B7%E4%B9%8B%E3%80%82%0A%09%E8%BF%99%E9%87%8C%E6%89%80%E8%B0%93%22%E6%9C%80%E4%BC%98%22%E6%8C%87%E7%9A%84%E6%98%AFpeer%E4%B8%AD%E6%89%80%E7%BB%B4%E6%8A%A4%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84TotalDifficulty%28td%29%E6%9C%80%E9%AB%98%EF%BC%8C%0A%09%E7%94%B1%E4%BA%8ETd%E6%98%AF%E5%85%A8%E9%93%BE%E4%B8%AD%E4%BB%8E%E5%88%9B%E4%B8%96%E5%9D%97%E5%88%B0%E6%9C%80%E6%96%B0%E5%A4%B4%E5%9D%97%E7%9A%84Difficulty%E5%80%BC%E6%80%BB%E5%92%8C%EF%BC%8C%0A%09%E6%89%80%E4%BB%A5Td%E5%80%BC%E6%9C%80%E9%AB%98%E5%B0%B1%E6%84%8F%E5%91%B3%E7%9D%80%E5%AE%83%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E6%98%AF%E6%9C%80%E6%96%B0%E7%9A%84%EF%BC%8C%E8%B7%9F%E8%BF%99%E6%A0%B7%E7%9A%84peer%E4%BD%9C%E5%8C%BA%E5%9D%97%E5%85%A8%E9%93%BE%E5%90%8C%E6%AD%A5%EF%BC%8C%0A%09%E6%98%BE%E7%84%B6%E6%94%B9%E5%8A%A8%E9%87%8F%E6%98%AF%E6%9C%80%E5%B0%8F%E7%9A%84%EF%BC%8C%E6%AD%A4%E5%8D%B3%22%E6%9C%80%E4%BC%98%22%E3%80%82%0A*%2F%0A%2F%2F+syncer+is+responsible+for+periodically+synchronising+with+the+network%2C+both%0A%2F%2F+downloading+hashes+and+blocks+as+well+as+handling+the+announcement+handler.%0Afunc+%28pm+*ProtocolManager%29+syncer%28%29+%7B%0A%09%2F%2F+Start+and+ensure+cleanup+of+sync+mechanisms%0A%09%2F%2F%E5%90%AF%E5%8A%A8+fetcher%EF%BC%8C%E8%BE%85%E5%8A%A9%E5%90%8C%E6%AD%A5%E5%8C%BA%E5%9D%97%E6%95%B0%E6%8D%AE%0A%09pm.fetcher.Start%28%29%0A%09defer+pm.fetcher.Stop%28%29%0A%09defer+pm.downloader.Terminate%28%29%0A%0A%09%2F%2F+Wait+for+different+events+to+fire+synchronisation+operations%0A%09forceSync+%3A%3D+time.NewTicker%28forceSyncCycle%29%0A%09defer+forceSync.Stop%28%29%0A%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+%26lt%3B-pm.newPeerCh%3A%0A%09%09%09%2F%2F+Make+sure+we+have+peers+to+select+from%2C+then+sync%0A%09%09%09if+pm.peers.Len%28%29+%26lt%3B+minDesiredPeerCount+%7B%0A%09%09%09%09break%0A%09%09%09%7D%0A%09%09%09go+pm.synchronise%28pm.peers.BestPeer%28%29%29%0A%0A%09%09case+%26lt%3B-forceSync.C%3A%0A%09%09%09%2F%2F+Force+a+sync+even+if+not+enough+peers+are+present%0A%09%09%09go+pm.synchronise%28pm.peers.BestPeer%28%29%29%0A%0A%09%09case+%26lt%3B-pm.noMorePeers%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%0A%0A%2F%2F+Start+boots+up+the+announcement+based+synchroniser%2C+accepting+and+processing%0A%2F%2F+hash+notifications+and+block+fetches+until+termination+requested.%0Afunc+%28f+*Fetcher%29+Start%28%29+%7B%0A%09go+f.loop%28%29%0A%7D%0A%0A%2F%2F---------------------go.txsyncLoop%28%29---------------------%0A%2F%2F+txsyncLoop+takes+care+of+the+initial+transaction+sync+for+each+new%0A%2F%2F+connection.+When+a+new+peer+appears%2C+we+relay+all+currently+pending%0A%2F%2F+transactions.+In+order+to+minimise+egress+bandwidth+usage%2C+we+send%0A%2F%2F+the+transactions+in+small+packs+to+one+peer+at+a+time.%0A%2F*%E5%BD%93%E4%BB%8E%E7%BD%91%E7%BB%9C%E8%8A%82%E7%82%B9%E5%90%8C%E6%AD%A5%E8%BF%87%E6%9D%A5%E6%9C%80%E6%96%B0%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E5%90%8E%EF%BC%8C%E6%9C%AC%E5%9C%B0%E4%B9%9F%E4%BC%9A%E6%8A%8A%E6%96%B0%E5%90%8C%E6%AD%A5%E4%B8%8B%E6%9D%A5%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E5%B9%BF%E6%92%AD%E7%BB%99%E7%BD%91%E7%BB%9C%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E3%80%82%0A*%2F%0Afunc+%28pm+*ProtocolManager%29+txsyncLoop%28%29+%7B%0A%09var+%28%0A%09%09pending+%3D+make%28map%5Benode.ID%5D*txsync%29%0A%09%09sending+%3D+false+++++++++++++++%2F%2F+whether+a+send+is+active%0A%09%09pack++++%3D+new%28txsync%29+++++++++%2F%2F+the+pack+that+is+being+sent%0A%09%09done++++%3D+make%28chan+error%2C+1%29+%2F%2F+result+of+the+send%0A%09%29%0A%0A%09%2F%2F+send+starts+a+sending+a+pack+of+transactions+from+the+sync.%0A%09send+%3A%3D+func%28s+*txsync%29+%7B%0A%09%09%2F%2F+Fill+pack+with+transactions+up+to+the+target+size.%0A%09%09size+%3A%3D+common.StorageSize%280%29%0A%09%09pack.p+%3D+s.p%0A%09%09pack.txs+%3D+pack.txs%5B%3A0%5D%0A%09%09for+i+%3A%3D+0%3B+i+%26lt%3B+len%28s.txs%29+%26amp%3B%26amp%3B+size+%26lt%3B+txsyncPackSize%3B+i%2B%2B+%7B%0A%09%09%09pack.txs+%3D+append%28pack.txs%2C+s.txs%5Bi%5D%29%0A%09%09%09size+%2B%3D+s.txs%5Bi%5D.Size%28%29%0A%09%09%7D%0A%09%09%2F%2F+Remove+the+transactions+that+will+be+sent.%0A%09%09s.txs+%3D+s.txs%5B%3Acopy%28s.txs%2C+s.txs%5Blen%28pack.txs%29%3A%5D%29%5D%0A%09%09if+len%28s.txs%29+%3D%3D+0+%7B%0A%09%09%09delete%28pending%2C+s.p.ID%28%29%29%0A%09%09%7D%0A%09%09%2F%2F+Send+the+pack+in+the+background.%0A%09%09s.p.Log%28%29.Trace%28%22Sending+batch+of+transactions%22%2C+%22count%22%2C+len%28pack.txs%29%2C+%22bytes%22%2C+size%29%0A%09%09sending+%3D+true%0A%09%09go+func%28%29+%7B+done+%26lt%3B-+pack.p.SendTransactions%28pack.txs%29+%7D%28%29%0A%09%7D%0A%0A%09%2F%2F+pick+chooses+the+next+pending+sync.%0A%09pick+%3A%3D+func%28%29+*txsync+%7B%0A%09%09if+len%28pending%29+%3D%3D+0+%7B%0A%09%09%09return+nil%0A%09%09%7D%0A%09%09n+%3A%3D+rand.Intn%28len%28pending%29%29+%2B+1%0A%09%09for+_%2C+s+%3A%3D+range+pending+%7B%0A%09%09%09if+n--%3B+n+%3D%3D+0+%7B%0A%09%09%09%09return+s%0A%09%09%09%7D%0A%09%09%7D%0A%09%09return+nil%0A%09%7D%0A%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+s+%3A%3D+%26lt%3B-pm.txsyncCh%3A%0A%09%09%09pending%5Bs.p.ID%28%29%5D+%3D+s%0A%09%09%09if+%21sending+%7B%0A%09%09%09%09send%28s%29%0A%09%09%09%7D%0A%09%09case+err+%3A%3D+%26lt%3B-done%3A%0A%09%09%09sending+%3D+false%0A%09%09%09%2F%2F+Stop+tracking+peers+that+cause+send+failures.%0A%09%09%09if+err+%21%3D+nil+%7B%0A%09%09%09%09pack.p.Log%28%29.Debug%28%22Transaction+send+failed%22%2C+%22err%22%2C+err%29%0A%09%09%09%09delete%28pending%2C+pack.p.ID%28%29%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Schedule+the+next+send.%0A%09%09%09if+s+%3A%3D+pick%28%29%3B+s+%21%3D+nil+%7B%0A%09%09%09%09send%28s%29%0A%09%09%09%7D%0A%09%09case+%26lt%3B-pm.quitSync%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%0A%0A%0A%E5%9B%9B%E4%B8%AA%E7%AE%A1%E9%81%93%E4%B8%BB%E8%A6%81%E7%9A%84%E5%8A%9F%E8%83%BD%E9%83%BD%E6%98%AF%E5%9B%B4%E7%BB%95%E5%B9%BF%E6%92%AD%E5%92%8C%E5%90%8C%E6%AD%A5%E5%B1%95%E5%BC%80%E7%9A%84%0A%28%E5%B9%BF%E6%92%AD%E5%8C%BA%E5%9D%97%E3%80%81%E5%B9%BF%E6%92%AD%E4%BA%A4%E6%98%93%EF%BC%8C%E5%90%8C%E6%AD%A5%E5%88%B0%E5%8C%BA%E5%9D%97%E3%80%81%E5%90%8C%E6%AD%A5%E5%88%B0%E4%BA%A4%E6%98%93%EF%BC%8C%E5%86%8D%E5%B9%BF%E6%92%AD%E5%8C%BA%E5%9D%97%E3%80%81%E5%B9%BF%E6%92%AD%E4%BA%A4%E6%98%93%E3%80%82%29%0A%0A%0A%0A%2F*%0A%E5%AF%B9%E4%BA%8Epeer%E9%97%B4%E9%80%9A%E4%BF%A1%E8%80%8C%E8%A8%80%EF%BC%8C%E9%99%A4%E4%BA%86%E5%B7%B1%E6%96%B9%E9%9C%80%E8%A6%81%E4%B8%BB%E5%8A%A8%E5%90%91%E5%AF%B9%E6%96%B9peer%E5%8F%91%E8%B5%B7%E9%80%9A%E4%BF%A1%28%E6%AF%94%E5%A6%82Start%28%29%E4%B8%AD%E5%90%AF%E5%8A%A8%E7%9A%84%E5%9B%9B%E4%B8%AA%E7%8B%AC%E7%AB%8B%E6%B5%81%E7%A8%8B%29%E4%B9%8B%E5%A4%96%EF%BC%8C%0A%E8%BF%98%E9%9C%80%E8%A6%81%E4%B8%80%E7%A7%8D%E7%94%B1%E5%AF%B9%E6%96%B9peer%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%EF%BC%8C%E8%BF%99%E7%A7%8D%E4%BC%A0%E8%BE%93%E4%B8%8D%E4%BB%85%E4%BB%85%E6%98%AF%E7%94%B1%E5%AF%B9%E6%96%B9peer%E5%8F%91%E7%BB%99%E5%B7%B1%E6%96%B9%EF%BC%8C%0A%E6%9B%B4%E5%A4%9A%E7%9A%84%E7%94%A8%E6%B3%95%E6%98%AF%E5%AF%B9%E6%96%B9peer%E4%B8%BB%E5%8A%A8%E8%B0%83%E7%94%A8%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E8%AE%A9%E5%B7%B1%E6%96%B9%E5%8F%91%E7%BB%99%E5%AE%83%E4%BB%AC%E6%9F%90%E4%BA%9B%E7%89%B9%E5%AE%9A%E6%95%B0%E6%8D%AE%E3%80%82%E8%BF%99%E7%A7%8D%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F%EF%BC%8C%0A%E5%9C%A8%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%8A%E9%80%82%E5%90%88%E7%94%A8%E5%9B%9E%E8%B0%83%28callback%29%E6%9D%A5%E5%AE%9E%E7%8E%B0%E3%80%82%0A%0AProtocolManager.handle%28%29%E5%B0%B1%E6%98%AF%E8%BF%99%E6%A0%B7%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%83%E4%BC%9A%E5%9C%A8ProtocolManager%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E6%97%B6%EF%BC%8C%0A%E4%BB%A5%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E6%96%B9%E5%BC%8F%E2%80%9C%E5%9F%8B%E5%85%A5%E2%80%9D%E6%AF%8F%E4%B8%AAp2p.Protocol%E5%AF%B9%E8%B1%A1%E4%B8%AD%28%E5%AE%9E%E7%8E%B0%E4%BA%86Protocol.Run%28%29%E6%96%B9%E6%B3%95%29%E3%80%82%0A%E4%B9%8B%E5%90%8E%E6%AF%8F%E5%BD%93%E6%9C%89%E6%96%B0peer%E8%A6%81%E4%B8%8E%E5%B7%B1%E6%96%B9%E5%BB%BA%E7%AB%8B%E9%80%9A%E4%BF%A1%E6%97%B6%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%AF%B9%E6%96%B9%E8%83%BD%E5%A4%9F%E6%94%AF%E6%8C%81%E8%AF%A5Protocol%EF%BC%8C%0A%E9%82%A3%E4%B9%88%E5%8F%8C%E6%96%B9%E5%B0%B1%E5%8F%AF%E4%BB%A5%E9%A1%BA%E5%88%A9%E7%9A%84%E5%BB%BA%E7%AB%8B%E5%B9%B6%E5%BC%80%E5%A7%8B%E9%80%9A%E4%BF%A1%E3%80%82%E4%BB%A5%E4%B8%8B%E6%98%AFhandle%28%29%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BB%A3%E7%A0%81%EF%BC%9A%0A*%2F%0A%2F%2F+handle+is+the+callback+invoked+to+manage+the+life+cycle+of+an+eth+peer.+When%0A%2F%2F+this+function+terminates%2C+the+peer+is+disconnected.%0Afunc+%28pm+*ProtocolManager%29+handle%28p+*peer%29+error+%7B%0A%09%2F%2F+Ignore+maxPeers+if+this+is+a+trusted+peer%0A%09if+pm.peers.Len%28%29+%26gt%3B%3D+pm.maxPeers+%26amp%3B%26amp%3B+%21p.Peer.Info%28%29.Network.Trusted+%7B%0A%09%09return+p2p.DiscTooManyPeers%0A%09%7D%0A%09p.Log%28%29.Debug%28%22Ethereum+peer+connected%22%2C+%22name%22%2C+p.Name%28%29%29%0A%0A%09%2F%2F+Execute+the+Ethereum+handshake%0A%09var+%28%0A%09%09genesis+%3D+pm.blockchain.Genesis%28%29%0A%09%09head++++%3D+pm.blockchain.CurrentHeader%28%29%0A%09%09hash++++%3D+head.Hash%28%29%0A%09%09number++%3D+head.Number.Uint64%28%29%0A%09%09td++++++%3D+pm.blockchain.GetTd%28hash%2C+number%29%0A%09%29%0A%09%2F%2F%E6%8F%A1%E6%89%8B%EF%BC%8C%E4%B8%8E%E5%AF%B9%E6%96%B9peer%E6%B2%9F%E9%80%9A%E5%B7%B1%E6%96%B9%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E7%8A%B6%E6%80%81%0A%09if+err+%3A%3D+p.Handshake%28pm.networkID%2C+td%2C+hash%2C+genesis.Hash%28%29%29%3B+err+%21%3D+nil+%7B%0A%09%09p.Log%28%29.Debug%28%22Ethereum+handshake+failed%22%2C+%22err%22%2C+err%29%0A%09%09return+err%0A%09%7D%0A%09%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E8%AF%BB%E5%86%99%E9%80%9A%E9%81%93%EF%BC%8C%E7%94%A8%E4%BB%A5%E8%B7%9F%E5%AF%B9%E6%96%B9peer%E7%9B%B8%E4%BA%92%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E3%80%82%0A%09if+rw%2C+ok+%3A%3D+p.rw.%28*meteredMsgReadWriter%29%3B+ok+%7B%0A%09%09rw.Init%28p.version%29%0A%09%7D%0A%09%2F%2F+Register+the+peer+locally%0A%09%2F%2F%E6%B3%A8%E5%86%8C%E5%AF%B9%E6%96%B9peer%EF%BC%8C%E5%AD%98%E5%85%A5%E5%B7%B1%E6%96%B9peer%E5%88%97%E8%A1%A8%EF%BC%9B%E5%8F%AA%E6%9C%89handle%28%29%E5%87%BD%E6%95%B0%E9%80%80%E5%87%BA%E6%97%B6%EF%BC%8C%E6%89%8D%E4%BC%9A%E5%B0%86%E8%BF%99%E4%B8%AApeer%E7%A7%BB%E9%99%A4%E5%87%BA%E5%88%97%E8%A1%A8%E3%80%82%0A%09if+err+%3A%3D+pm.peers.Register%28p%29%3B+err+%21%3D+nil+%7B%0A%09%09p.Log%28%29.Error%28%22Ethereum+peer+registration+failed%22%2C+%22err%22%2C+err%29%0A%09%09return+err%0A%09%7D%0A%09defer+pm.removePeer%28p.id%29%0A%0A%09%2F%2FDownloader%E6%88%90%E5%91%98%E6%B3%A8%E5%86%8C%E8%BF%99%E4%B8%AA%E6%96%B0peer%EF%BC%9BDownloader%E4%BC%9A%E8%87%AA%E5%B7%B1%E7%BB%B4%E6%8A%A4%E4%B8%80%E4%B8%AA%E7%9B%B8%E9%82%BBpeer%E5%88%97%E8%A1%A8%E3%80%82%0A%09%2F%2F+Register+the+peer+in+the+downloader.+If+the+downloader+considers+it+banned%2C+we+disconnect%0A%09if+err+%3A%3D+pm.downloader.RegisterPeer%28p.id%2C+p.version%2C+p%29%3B+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09%2F%2F+Propagate+existing+transactions.+new+transactions+appearing%0A%09%2F%2F+after+this+will+be+sent+via+broadcasts.%0A%09%2F*%0A%09%E8%B0%83%E7%94%A8syncTransactions%28%29%EF%BC%8C%E7%94%A8%E5%BD%93%E5%89%8Dtxpool%E4%B8%AD%E6%96%B0%E7%B4%AF%E8%AE%A1%E7%9A%84tx%E5%AF%B9%E8%B1%A1%E7%BB%84%E8%A3%85%E6%88%90%E4%B8%80%E4%B8%AAtxsync%7B%7D%E5%AF%B9%E8%B1%A1%EF%BC%8C%0A%09%E6%8E%A8%E9%80%81%E5%88%B0%E5%86%85%E9%83%A8%E9%80%9A%E9%81%93txsyncCh%E3%80%82%E8%BF%98%E8%AE%B0%E5%BE%97Start%28%29%E5%90%AF%E5%8A%A8%E7%9A%84%E5%9B%9B%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B9%88%3F+%E5%85%B6%E4%B8%AD%E7%AC%AC%E5%9B%9B%E9%A1%B9txsyncLoop%28%29%0A%09%E4%B8%AD%E7%94%A8%E4%BB%A5%E7%AD%89%E5%BE%85txsync%7B%7D%E6%95%B0%E6%8D%AE%E7%9A%84%E9%80%9A%E9%81%93txsyncCh%EF%BC%8C%E6%AD%A3%E6%98%AF%E5%9C%A8%E8%BF%99%E9%87%8C%E8%A2%AB%E6%8E%A8%E5%85%A5txsync%7B%7D%E7%9A%84%E3%80%82%0A%09*%2F%0A%09pm.syncTransactions%28p%29%0A%0A%09%2F%2F+If+we%27re+DAO+hard-fork+aware%2C+validate+any+remote+peer+with+regard+to+the+hard-fork%0A%09if+daoBlock+%3A%3D+pm.chainconfig.DAOForkBlock%3B+daoBlock+%21%3D+nil+%7B%0A%09%09%2F%2F+Request+the+peer%27s+DAO+fork+header+for+extra-data+validation%0A%09%09if+err+%3A%3D+p.RequestHeadersByNumber%28daoBlock.Uint64%28%29%2C+1%2C+0%2C+false%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09%2F%2F+Start+a+timer+to+disconnect+if+the+peer+doesn%27t+reply+in+time%0A%09%09p.forkDrop+%3D+time.AfterFunc%28daoChallengeTimeout%2C+func%28%29+%7B%0A%09%09%09p.Log%28%29.Debug%28%22Timed+out+DAO+fork-check%2C+dropping%22%29%0A%09%09%09pm.removePeer%28p.id%29%0A%09%09%7D%29%0A%09%09%2F%2F+Make+sure+it%27s+cleaned+up+if+the+peer+dies+off%0A%09%09defer+func%28%29+%7B%0A%09%09%09if+p.forkDrop+%21%3D+nil+%7B%0A%09%09%09%09p.forkDrop.Stop%28%29%0A%09%09%09%09p.forkDrop+%3D+nil%0A%09%09%09%7D%0A%09%09%7D%28%29%0A%09%7D%0A%09%09%2F%2F%E5%9C%A8%E6%97%A0%E9%99%90%E5%BE%AA%E7%8E%AF%E4%B8%AD%E5%90%AF%E5%8A%A8handleMsg%28%29%EF%BC%8C%E5%BD%93%E5%AF%B9%E6%96%B9peer%E5%8F%91%E5%87%BA%E4%BB%BB%E4%BD%95msg%E6%97%B6%EF%BC%8C%0A%09%09%2F%2FhandleMsg%28%29%E5%8F%AF%E4%BB%A5%E6%8D%95%E6%8D%89%E7%9B%B8%E5%BA%94%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%B6%88%E6%81%AF%E5%B9%B6%E5%9C%A8%E5%B7%B1%E6%96%B9%E8%BF%9B%E8%A1%8C%E5%A4%84%E7%90%86%E3%80%82%0A%09%2F%2F+main+loop.+handle+incoming+messages.%0A%09for+%7B%0A%09%09if+err+%3A%3D+pm.handleMsg%28p%29%3B+err+%21%3D+nil+%7B%0A%09%09%09p.Log%28%29.Debug%28%22Ethereum+message+handling+failed%22%2C+%22err%22%2C+err%29%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%26nbsp%3B%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FGrit_ICPC%2Farticle%2Fdetails%2F83961303%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2FGrit_ICPC%2Farticle%2Fdetails%2F83961303%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09if%28typeof+window.localStorage+%3D%3D%3D+%22object%22+%26%26+typeof+window.csdn.anonymousUserLimit+%3D%3D%3D+%22object%22%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09if%28%21window.csdn.anonymousUserLimit.judgment%28%29%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09%09window.csdn.anonymousUserLimit.Jumplogin%28%29%3B%0A%09%09%09%09%09%09%09%09%09%09%09%09return+false%3B%0A%09%09%09%09%09%09%09%09%09%09%09%7Delse+if%28%21currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09%09window.csdn.anonymousUserLimit.updata%28%29%3B%0A%09%09%09%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%09%09%09%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}