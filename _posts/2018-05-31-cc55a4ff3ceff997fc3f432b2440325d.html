---
layout: default
title: 以太坊之Downloader同步区块流程
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E9%9A%8F%E7%9D%80%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E6%95%B0%E6%8D%AE%E8%B6%8A%E6%9D%A5%E8%B6%8A%E5%A4%9A%EF%BC%8C%E5%90%8C%E6%AD%A5%E4%B9%9F%E8%B6%8A%E6%9D%A5%E8%B6%8A%E6%85%A2%EF%BC%8C%E4%BD%BF%E7%94%A8full+sync+mode%E5%90%8C%E6%AD%A5%E7%9A%84%E8%AF%9D%E6%81%90%E6%80%95%E5%BE%97%E4%B8%80%E4%B8%A4%E4%B8%AA%E7%A4%BC%E6%8B%9C%E4%B9%9F%E4%B8%8D%E8%A7%81%E5%BE%97%E8%83%BD%E5%90%8C%E6%AD%A5%E5%AE%8C%E3%80%82%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%9C%89fast+sync+mode%EF%BC%8C%E6%89%BE%E4%BA%86%E4%BA%9B%E6%96%87%E7%AB%A0%E8%BF%98%E4%B8%8D%E6%98%AF%E5%BE%88%E6%98%8E%E7%99%BD%E5%85%B7%E4%BD%93%E5%86%85%E5%AE%B9%EF%BC%8C%E6%89%80%E4%BB%A5%E5%B0%9D%E8%AF%95%E7%9D%80%E7%9C%8B%E6%87%82%E5%86%99%E4%B8%8B%E6%9D%A5%EF%BC%8C%E5%A6%82%E6%9C%89%E9%94%99%E8%AF%AF%E4%B9%8B%E5%A4%84%E6%AC%A2%E8%BF%8E%E6%8C%87%E6%AD%A3%E3%80%82%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E5%85%B3%E4%BA%8Efast+sync+mode%E7%9A%84%E7%AE%97%E6%B3%95%EF%BC%8C%E6%98%AF%E5%9C%A8%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E4%B8%AD%E8%AE%B2%E8%BF%B0%E7%9A%84%EF%BC%8C%E7%9C%8B%E5%AE%8C%E4%BA%86%E4%B9%9F%E6%B2%A1%E7%9C%8B%E6%98%8E%E7%99%BD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%90%8C%E6%AD%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%9A%E5%B0%91%EF%BC%8C%E9%80%9F%E5%BA%A6%E4%BC%9A%E5%BF%AB%EF%BC%8C%E6%89%80%E4%BB%A5%E7%9C%8B%E7%9C%8B%E6%BA%90%E4%BB%A3%E7%A0%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%90%A7%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Ehttps%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fpull%2F1889%3C%2Fp%3E%0A++%3Ch2+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E5%9B%BE%E7%A4%BA%3C%2Fh2%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%3Cimg+src%3D%22https%3A%2F%2Fblog.uzzz.org%2F_p%3Fhttps%3A%2F%2Fimg-blog.csdn.net%2F20180606105323335%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E5%85%88%E5%A4%A7%E8%87%B4%E8%AE%B2%E4%B8%8B%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B%EF%BC%8C%E4%BB%A5%E6%96%B0%E5%8A%A0%E5%85%A5%E7%BD%91%E7%BB%9C%E7%9A%84%E8%8A%82%E7%82%B9A%E5%92%8C%E6%8C%96%E7%9F%BF%E8%8A%82%E7%82%B9B%E4%B8%BA%E4%BE%8B%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E1+%E4%B8%A4%E4%B8%AA%E8%8A%82%E7%82%B9%E5%85%88hadeshake%E5%90%8C%E6%AD%A5%E4%B8%8B%E5%90%84%E8%87%AA%E7%9A%84genesis%E3%80%81td%E3%80%81head%E7%AD%89%E4%BF%A1%E6%81%AF%3C%2Fp%3E%0A++%3Cp%3E2+%E8%BF%9E%E6%8E%A5%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E8%8A%82%E7%82%B9B%E5%8F%91%E9%80%81TxMsg%E6%B6%88%E6%81%AF%E6%8A%8A%E8%87%AA%E5%B7%B1%E7%9A%84txpool%E4%B8%AD%E7%9A%84tx%E5%90%8C%E6%AD%A5%E7%BB%99%E8%8A%82%E7%82%B9A%3C%2Fp%3E%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%E7%84%B6%E5%90%8E%E5%90%84%E8%87%AA%E5%BE%AA%E7%8E%AF%E7%9B%91%E5%90%AC%E5%AF%B9%E6%96%B9%E7%9A%84%E6%B6%88%E6%81%AF%3C%2Fp%3E%0A++%3Cp%3E3+%E8%8A%82%E7%82%B9A%E6%AD%A4%E6%97%B6%E4%BD%BF%E7%94%A8fast+sync%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%EF%BC%8C%E4%BE%9D%E6%AC%A1%E5%8F%91%E9%80%81GetBlockHeadersMsg%E3%80%81GetBlockBodiesMsg%E3%80%81GetReceiptsMsg%E3%80%81GetNodeDataMsg%E8%8E%B7%E5%8F%96block+header%E3%80%81block+body%E3%80%81receipt%E5%92%8Cstate%E6%95%B0%E6%8D%AE%3C%2Fp%3E%0A++%3Cp%3E4+%E8%8A%82%E7%82%B9B%E5%AF%B9%E5%BA%94%E7%9A%84%E8%BF%94%E5%9B%9EBlockHeadersMsg%E3%80%81BlockBodiesMsg%E3%80%81ReceiptsMsg%E3%80%81NodeDataMsg%3C%2Fp%3E%0A++%3Cp%3E5+%E8%8A%82%E7%82%B9A%E6%94%B6%E5%88%B0%E6%95%B0%E6%8D%AE%E6%8A%8Aheader%E5%92%8Cbody%E7%BB%84%E6%88%90block%E5%AD%98%E5%85%A5%E8%87%AA%E5%B7%B1%E7%9A%84leveldb%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E4%B8%80%E5%B9%B6%E5%AD%98%E5%85%A5receipts%E5%92%8Cstate%E6%95%B0%E6%8D%AE%3C%2Fp%3E%0A++%3Cp%3E6+%E8%8A%82%E7%82%B9B%E6%8C%96%E5%87%BAblock%E5%90%8E%E4%BC%9A%E5%90%91A%E5%90%8C%E6%AD%A5%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%8F%91%E9%80%81NewBlockMsg%E6%88%96%E8%80%85NewBlockHashesMsg%28%E5%8F%96%E5%86%B3%E4%BA%8E%E8%8A%82%E7%82%B9A%E4%BD%8D%E4%BA%8E%E8%8A%82%E7%82%B9B%E7%9A%84%E8%8A%82%E7%82%B9%E5%88%97%E8%A1%A8%E4%BD%8D%E7%BD%AE%EF%BC%89%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AFNewBlockMsg%EF%BC%8C%E9%82%A3%E4%B9%88%E8%8A%82%E7%82%B9A%E7%9B%B4%E6%8E%A5%E9%AA%8C%E8%AF%81%E5%AE%8C%E5%AD%98%E5%85%A5%E6%9C%AC%E5%9C%B0%EF%BC%9B%E5%A6%82%E6%9E%9C%E6%98%AFNewBlockHashesMsg%E8%8A%82%E7%82%B9A%E4%BC%9A%E4%BA%A4%E7%BB%99fetcher%E5%8E%BB%E8%8E%B7%E5%8F%96header%E5%92%8Cbody%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E7%BB%84%E7%BB%87%E6%88%90block%E5%AD%98%E5%85%A5%E6%9C%AC%E5%9C%B0%3C%2Fp%3E%0A++%3Ch2+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%3C%2Fh2%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E5%85%88%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B%E4%B8%80%E4%BA%9B%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Eheader%EF%BC%9A%E5%8C%BA%E5%9D%97%E7%9A%84%E5%A4%B4%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Ebody%EF%BC%9A%E5%8C%BA%E5%9D%97%E5%86%85%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Eblock%EF%BC%9A%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%BB%85%E5%8C%85%E5%90%AB%E5%8C%BA%E5%9D%97%E5%A4%B4%E5%92%8Cbody%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Ereceipt%EF%BC%9A%E5%90%88%E7%BA%A6%E6%89%A7%E8%A1%8C%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%8Clog%E5%B0%B1%E6%94%BE%E5%9C%A8%E8%BF%99%E9%87%8C%E3%80%82%E8%BF%99%E4%B8%AA%E9%BB%98%E8%AE%A4%E6%98%AF%E4%B8%8D%E5%B9%BF%E6%92%AD%E7%9A%84%E3%80%82fast+sync%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BC%9A%E6%9C%89%E8%8A%82%E7%82%B9%E5%8E%BB%E8%8E%B7%E5%8F%96%E3%80%82%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%88sync%E5%88%B0%E6%9C%80%E6%96%B0%E5%90%8E%EF%BC%89%E6%94%B6%E5%88%B0block%E5%90%8E%EF%BC%8C%E4%BC%9A%E6%89%A7%E8%A1%8Cblock%E5%86%85%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%EF%BC%8C%E5%B0%B1%E5%8F%AF%E4%BB%A5%E5%BE%97%E5%88%B0%E8%BF%99%E4%B8%AAreceipt%E4%BA%86%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Estatedb%EF%BC%9A%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81%EF%BC%8C%E5%82%A8%E5%AD%98%E6%89%80%E6%9C%89%E7%9A%84%E8%B4%A6%E5%8F%B7%E7%8A%B6%E6%80%81%EF%BC%8C%E4%BD%BF%E7%94%A8%E4%BA%86MPT%E6%A0%91%E5%AD%98%E5%82%A8%E3%80%82%E8%B7%9Freceipt%E4%B8%80%E6%A0%B7%EF%BC%8C%E4%B9%9F%E4%B8%8D%E5%B1%9E%E4%BA%8Eblock%E7%9A%84%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%8C%E5%B9%BF%E6%92%AD%E7%9A%84%E6%97%B6%E5%80%99%E4%B9%9F%E4%B8%8D%E5%B9%BF%E6%92%AD%E3%80%82%E5%8F%AA%E5%9C%A8fast+sync%E4%B8%8B%EF%BC%8C%E4%BC%9A%E4%BB%8E%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96%E3%80%82%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C%E7%9A%84%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0block%E6%89%A7%E8%A1%8C%E6%89%80%E6%9C%89%E7%9A%84%E4%BA%A4%E6%98%93%E7%9A%84%E6%97%B6%E5%80%99%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%94%9F%E6%88%90%E3%80%82%3C%2Fp%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E8%BF%99%E5%87%A0%E4%B8%AA%E6%95%B0%E6%8D%AE%E9%83%BD%E6%98%AF%E5%AD%98%E5%9C%A8%E8%8A%82%E7%82%B9%E7%9A%84leveldb%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%EF%BC%8C%E6%AD%A3%E5%B8%B8%E6%83%85%E5%86%B5%E4%B8%8B%E5%B9%BF%E6%92%AD%E7%9A%84%E5%9D%97%E6%98%AF%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%8C%85%E5%90%ABheader%E5%92%8Cbody%EF%BC%88%E6%89%80%E6%9C%89%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%89%3C%2Fp%3E%0A++%3Ch2+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E5%BC%80%E5%A7%8B%3C%2Fh2%3E%0A++%3Cp+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3E%E5%85%88%E4%BB%8E%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E7%9C%8B%E8%B5%B7%E6%9D%A5%E5%90%A7%EF%BC%8C%E5%89%8D%E9%9D%A2%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%9C%B0%E6%96%B9%E5%85%88%E4%B8%8D%E8%AE%B2%E4%BA%86%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%88%87%E5%85%A5%E6%AD%A3%E9%A2%98%EF%BC%9A%E5%A6%82%E6%9E%9C%E8%BF%90%E8%A1%8Cgeth%E4%B8%8D%E8%AE%BE%E7%BD%AE%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%EF%BC%8C%E9%BB%98%E8%AE%A4%E6%98%AFfast+mode%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+NewProtocolManager%28config+*params.ChainConfig%2C+mode+downloader.SyncMode%2C+networkId+uint64%2C+mux+*event.TypeMux%2C+txpool+txPool%2C+engine+consensus.Engine%2C+blockchain+*core.BlockChain%2C+chaindb+ethdb.Database%29+%28*ProtocolManager%2C+error%29+%7B%0A%09%0A%09%2F%2F+Figure+out+whether+to+allow+fast+sync+or+not%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AFfast+sync+mode%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%BD%93%E5%89%8Dblocknum%E5%A4%A7%E4%BA%8E0%EF%BC%8C%E5%88%87%E6%8D%A2%E4%B8%BAfull+sync%E6%A8%A1%E5%BC%8F%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E9%82%A3%E4%B9%88%E5%A6%82%E6%9E%9Csync%E4%BA%86%E4%B8%80%E6%AE%B5%E6%97%B6%E9%97%B4%E6%96%AD%E6%8E%89%E4%B9%8B%E5%90%8E%E5%86%8D%E9%87%8D%E6%96%B0sync%E6%98%AFfast+mode%E8%BF%98%E6%98%AFfull+mode%E5%91%A2%EF%BC%8C%E7%AD%94%E6%A1%88%E8%BF%98%E6%98%AFfast+mode%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E4%B8%BA%E4%BB%80%E4%B9%88%E5%91%A2%EF%BC%9F+%E5%90%8E%E9%9D%A2%E7%9C%8B%E5%88%B0%E4%BB%A3%E7%A0%81%E7%9A%84%E6%97%B6%E5%80%99%E5%86%8D%E8%AE%B2%E4%B8%80%E4%B8%8B%E5%90%A7%0A%09if+mode+%3D%3D+downloader.FastSync+%26amp%3B%26amp%3B+blockchain.CurrentBlock%28%29.NumberU64%28%29+%26gt%3B+0+%7B%0A%09%09log.Warn%28%22Blockchain+not+empty%2C+fast+sync+disabled%22%29%0A%09%09mode+%3D+downloader.FullSync%0A%09%7D%0A%09if+mode+%3D%3D+downloader.FastSync+%7B%0A%09%09manager.fastSync+%3D+uint32%281%29%0A%09%7D%0A%09%2F%2F+Initiate+a+sub-protocol+for+every+implemented+version+we+can+handle%0A%09manager.SubProtocols+%3D+make%28%5B%5Dp2p.Protocol%2C+0%2C+len%28ProtocolVersions%29%29%0A%09for+i%2C+version+%3A%3D+range+ProtocolVersions+%7B%0A%09%09%2F%2F+Skip+protocol+version+if+incompatible+with+the+mode+of+operation%0A%09%09if+mode+%3D%3D+downloader.FastSync+%26amp%3B%26amp%3B+version+%26lt%3B+eth63+%7B%0A%09%09%09continue%0A%09%09%7D%0A%09%09%2F%2F+Compatible%3B+initialise+the+sub-protocol%0A%09%09version+%3A%3D+version+%2F%2F+Closure+for+the+run%0A%09%09manager.SubProtocols+%3D+append%28manager.SubProtocols%2C+p2p.Protocol%7B%0A%09%09%09Name%3A++++ProtocolName%2C%0A%09%09%09Version%3A+version%2C%0A%09%09%09Length%3A++ProtocolLengths%5Bi%5D%2C%0A%09%09%09Run%3A+func%28p+*p2p.Peer%2C+rw+p2p.MsgReadWriter%29+error+%7B%0A%09%09%09%09peer+%3A%3D+manager.newPeer%28int%28version%29%2C+p%2C+rw%29%0A%09%09%09%09select+%7B%0A%09%09%09%09case+manager.newPeerCh+%26lt%3B-+peer%3A%0A%09%09%09%09%09manager.wg.Add%281%29%0A%09%09%09%09%09defer+manager.wg.Done%28%29%0A%09%09%09%09%09return+manager.handle%28peer%29%0A%09%09%09%09case+%26lt%3B-manager.quitSync%3A%0A%09%09%09%09%09return+p2p.DiscQuitting%0A%09%09%09%09%7D%0A%09%09%09%7D%2C%0A%09%09%09NodeInfo%3A+func%28%29+interface%7B%7D+%7B%0A%09%09%09%09return+manager.NodeInfo%28%29%0A%09%09%09%7D%2C%0A%09%09%09PeerInfo%3A+func%28id+discover.NodeID%29+interface%7B%7D+%7B%0A%09%09%09%09if+p+%3A%3D+manager.peers.Peer%28fmt.Sprintf%28%22%25x%22%2C+id%5B%3A8%5D%29%29%3B+p+%21%3D+nil+%7B%0A%09%09%09%09%09return+p.Info%28%29%0A%09%09%09%09%7D%0A%09%09%09%09return+nil%0A%09%09%09%7D%2C%0A%09%09%7D%29%0A%09%7D%0A%09%0A%09%2F%2F+Construct+the+different+synchronisation+mechanisms%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%88%9D%E5%A7%8B%E5%8C%96downloader%0A%09manager.downloader+%3D+downloader.New%28mode%2C+chaindb%2C+manager.eventMux%2C+blockchain%2C+nil%2C+manager.removePeer%29%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+validator%EF%BC%9A+%E9%AA%8C%E8%AF%81%E5%8C%BA%E5%9D%97%E5%A4%B4%0A%09validator+%3A%3D+func%28header+*types.Header%29+error+%7B%0A%09%09return+engine.VerifyHeader%28blockchain%2C+header%2C+true%29%0A%09%7D%0A%09heighter+%3A%3D+func%28%29+uint64+%7B%0A%09%09return+blockchain.CurrentBlock%28%29.NumberU64%28%29%0A%09%7D%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%B0%86%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5blockchain%0A%09inserter+%3A%3D+func%28blocks+types.Blocks%29+%28int%2C+error%29+%7B%0A%09%09%2F%2F+If+fast+sync+is+running%2C+deny+importing+weird+blocks%0A%09%09if+atomic.LoadUint32%28%26amp%3Bmanager.fastSync%29+%3D%3D+1+%7B%0A%09%09%09log.Warn%28%22Discarded+bad+propagated+block%22%2C+%22number%22%2C+blocks%5B0%5D.Number%28%29%2C+%22hash%22%2C+blocks%5B0%5D.Hash%28%29%29%0A%09%09%09return+0%2C+nil%0A%09%09%7D%0A%09%09atomic.StoreUint32%28%26amp%3Bmanager.acceptTxs%2C+1%29+%2F%2F+Mark+initial+sync+done+on+any+fetcher+import%0A%09%09return+manager.blockchain.InsertChain%28blocks%29%0A%09%7D%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%88%9D%E5%A7%8B%E5%8C%96fetcher%EF%BC%8C%E6%8A%8Adownloader%E3%80%81validator%E4%BD%9C%E4%B8%BAfetcher%E7%9A%84%E5%8F%82%E6%95%B0%0A%09manager.fetcher+%3D+fetcher.New%28blockchain.GetBlockByHash%2C+validator%2C+manager.BroadcastBlock%2C+heighter%2C+inserter%2C+manager.removePeer%29%0A%0A%09return+manager%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E6%9C%89%E6%96%B0%E7%9A%84%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%E6%88%90%E5%8A%9F%E5%90%8E%EF%BC%8C%E4%BC%9A%E5%9B%9E%E8%B0%83%E8%BF%99%E4%B8%AARun%E5%87%BD%E6%95%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E6%8A%8Apeer%E5%86%99%E5%85%A5%E5%88%B0manager.newPeerCh%E8%BF%99%E4%B8%AAchannel%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%E4%B9%8B%E5%89%8D%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%E6%9C%89%E4%B8%AAgoroutine%E4%B8%80%E7%9B%B4%E5%9C%A8%E7%9B%91%E5%90%AC%E8%BF%99%E4%B8%AAchannel%E7%9A%84%E6%95%B0%E6%8D%AE%3C%2Fp%3E%0A++%3Cp%3Eeth%2Fsync.go%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28pm+*ProtocolManager%29+syncer%28%29+%7B%0A%09...%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+%26lt%3B-pm.newPeerCh%3A%0A%09%09%09%2F%2F+Make+sure+we+have+peers+to+select+from%2C+then+sync%0A%09%09%09if+pm.peers.Len%28%29+%26lt%3B+minDesiredPeerCount+%7B%0A%09%09%09%09break%0A%09%09%09%7D%0A%09%09%09go+pm.synchronise%28pm.peers.BestPeer%28%29%29%0A%0A%09%09case+%26lt%3B-forceSync.C%3A%0A%09%09%09%2F%2F+Force+a+sync+even+if+not+enough+peers+are+present%0A%09%09%09go+pm.synchronise%28pm.peers.BestPeer%28%29%29%0A%0A%09%09case+%26lt%3B-pm.noMorePeers%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3Esyncer%EF%BC%88%EF%BC%89%E6%98%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%E7%9A%84%E4%B8%80%E4%B8%AAgoroutine%EF%BC%8C%E4%B8%80%E7%9B%B4%E7%9B%91%E5%90%AC%E6%98%AF%E5%90%A6%E6%9C%89%E6%96%B0%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%3C%2Fp%3E%0A++%3Ch2%3E%E5%BC%80%E5%A7%8B%E5%90%8C%E6%AD%A5%3C%2Fh2%3E%0A++%3Cp%3E%E7%9B%91%E5%90%AC%E5%88%B0%E4%BA%86%E6%9C%89%E6%96%B0%E8%8A%82%E7%82%B9%E8%BF%9E%E6%8E%A5%EF%BC%8CminDesiredPeerCount%E6%98%AF5%EF%BC%8C%E6%84%8F%E6%80%9D%E6%98%AF%E6%9C%895%E4%B8%AA%E8%BF%9E%E6%8E%A5%E4%BA%86%E5%86%8D%E5%BC%80%E5%A7%8Bsync%EF%BC%8CBestPeer%E6%98%AFtd%E6%9C%80%E9%AB%98%E7%9A%84peer%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%BB%8E%E6%9C%80%E9%95%BF%E9%93%BE%E7%9A%84%E8%8A%82%E7%82%B9%E5%BC%80%E5%A7%8B%E5%90%8C%E6%AD%A5%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%E5%A6%82%E6%9E%9C%E5%B7%B2%E7%BB%8F%E5%BC%80%E5%A7%8B%E5%90%8C%E6%AD%A5%E4%BA%86%E5%8F%88%E6%9C%89%E6%96%B0%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E8%BF%98%E4%BC%9A%E5%86%8D%E5%90%8C%E6%AD%A5%E5%90%97%EF%BC%8C%E7%AD%94%E6%A1%88%E6%98%AFno%EF%BC%8C%E5%90%8E%E9%9D%A2%E7%9C%8B%E4%BB%A3%E7%A0%81%E7%9A%84%E6%97%B6%E5%80%99%E8%AE%B2%E4%B8%80%E4%B8%8B%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28pm+*ProtocolManager%29+synchronise%28peer+*peer%29+%7B%0A%09%2F%2F+Run+the+sync+cycle%2C+and+disable+fast+sync+if+we%27ve+went+past+the+pivot+block%0A%09if+err+%3A%3D+pm.downloader.Synchronise%28peer.id%2C+pHead%2C+pTd%2C+mode%29%3B+err+%21%3D+nil+%7B%0A%09%09return%0A%09%7D%0A%09if+atomic.LoadUint32%28%26amp%3Bpm.fastSync%29+%3D%3D+1+%7B%0A%09%09log.Info%28%22Fast+sync+complete%2C+auto+disabling%22%29%0A%09%09atomic.StoreUint32%28%26amp%3Bpm.fastSync%2C+0%29%0A%09%7D%0A%09atomic.StoreUint32%28%26amp%3Bpm.acceptTxs%2C+1%29+%2F%2F+Mark+initial+sync+done%0A%09if+head+%3A%3D+pm.blockchain.CurrentBlock%28%29%3B+head.NumberU64%28%29+%26gt%3B+0+%7B%0A%09%09%2F%2F+We%27ve+completed+a+sync+cycle%2C+notify+all+peers+of+new+state.+This+path+is%0A%09%09%2F%2F+essential+in+star-topology+networks+where+a+gateway+node+needs+to+notify%0A%09%09%2F%2F+all+its+out-of-date+peers+of+the+availability+of+a+new+block.+This+failure%0A%09%09%2F%2F+scenario+will+most+often+crop+up+in+private+and+hackathon+networks+with%0A%09%09%2F%2F+degenerate+connectivity%2C+but+it+should+be+healthy+for+the+mainnet+too+to%0A%09%09%2F%2F+more+reliably+update+peers+or+the+local+TD+state.%0A%09%09go+pm.BroadcastBlock%28head%2C+false%29%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E5%86%8D%E8%B0%83%E7%94%A8%E5%88%B0eth%2Fdownloader%2Fdownloader.go%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+synchronise%28id+string%2C+hash+common.Hash%2C+td+*big.Int%2C+mode+SyncMode%29+error+%7B%0A%09%2F%2F+%E8%BF%99%E9%87%8C%E4%BF%9D%E8%AF%81%E6%AF%8F%E6%AC%A1%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAsync%E5%AE%9E%E4%BE%8B%E8%BF%90%E8%A1%8C%EF%BC%8C%E8%BF%99%E9%87%8C%E4%BF%9D%E8%AF%81%E4%BA%86%E5%90%8C%E6%97%B6%E5%8F%AA%E6%9C%89%E4%B8%80%E4%B8%AAsync%E5%9C%A8%E8%BF%9B%E8%A1%8C%0A%09%2F%2F+Make+sure+only+one+goroutine+is+ever+allowed+past+this+point+at+once%0A%09if+%21atomic.CompareAndSwapInt32%28%26amp%3Bd.synchronising%2C+0%2C+1%29+%7B%0A%09%09return+errBusy%0A%09%7D%0A%09defer+atomic.StoreInt32%28%26amp%3Bd.synchronising%2C+0%29%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B...%0A%09%2F%2F+Retrieve+the+origin+peer+and+initiate+the+downloading+process%0A%09p+%3A%3D+d.peers.Peer%28id%29%0A%09if+p+%3D%3D+nil+%7B%0A%09%09return+errUnknownPeer%0A%09%7D%0A%09return+d.syncWithPeer%28p%2C+hash%2C+td%29%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+syncWithPeer%28p+*peerConnection%2C+hash+common.Hash%2C+td+*big.Int%29+%28err+error%29+%7B%0A%09%2F%2F+Look+up+the+sync+boundaries%3A+the+common+ancestor+and+the+target+block%0A%09latest%2C+err+%3A%3D+d.fetchHeight%28p%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09height+%3A%3D+latest.Number.Uint64%28%29%0A%0A%09origin%2C+err+%3A%3D+d.findAncestor%28p%2C+height%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+err%0A%09%7D%0A%09d.syncStatsLock.Lock%28%29%0A%09if+d.syncStatsChainHeight+%26lt%3B%3D+origin+%7C%7C+d.syncStatsChainOrigin+%26gt%3B+origin+%7B%0A%09%09d.syncStatsChainOrigin+%3D+origin%0A%09%7D%0A%09d.syncStatsChainHeight+%3D+height%0A%09d.syncStatsLock.Unlock%28%29%0A%0A%09%2F%2F+Ensure+our+origin+point+is+below+any+fast+sync+pivot+point%0A%09pivot+%3A%3D+uint64%280%29%0A%09if+d.mode+%3D%3D+FastSync+%7B%0A%09%09if+height+%26lt%3B%3D+uint64%28fsMinFullBlocks%29+%7B%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9%E7%9A%84height%E5%B0%8F%E4%BA%8E64%EF%BC%8C%E5%88%99%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%E6%9B%B4%E6%96%B0%E4%B8%BA0%0A%09%09%09origin+%3D+0%0A%09%09%7D+else+%7B%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%90%A6%E5%88%99%E6%9B%B4%E6%96%B0pivot%E4%B8%BA%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9height-64%0A%09%09%09pivot+%3D+height+-+uint64%28fsMinFullBlocks%29%0A%09%09%09if+pivot+%26lt%3B%3D+origin+%7B%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9Cpivot%E5%B0%8F%E4%BA%8E%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%EF%BC%8C%E5%88%99%E6%9B%B4%E6%96%B0%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%E4%B8%BApivot%E7%9A%84%E5%89%8D%E4%B8%80%E4%B8%AA%0A%09%09%09%09origin+%3D+pivot+-+1%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%09d.committed+%3D+1%0A%09if+d.mode+%3D%3D+FastSync+%26amp%3B%26amp%3B+pivot+%21%3D+0+%7B%0A%09%09d.committed+%3D+0%0A%09%7D%0A%09%2F%2F+Initiate+the+sync+using+a+concurrent+header+and+content+retrieval+algorithm%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E6%9B%B4%E6%96%B0queue%E7%9A%84%E5%80%BC%E4%BB%8E%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%2B1%E5%BC%80%E5%A7%8B%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%A5%BD%E7%90%86%E8%A7%A3%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%BB%8E%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%E5%BC%80%E5%A7%8Bsync%E5%8C%BA%E5%9D%97%0A%09d.queue.Prepare%28origin%2B1%2C+d.mode%29%0A%09if+d.syncInitHook+%21%3D+nil+%7B%0A%09%09d.syncInitHook%28origin%2C+height%29%0A%09%7D%0A%0A%09fetchers+%3A%3D+%5B%5Dfunc%28%29+error%7B%0A%09%09func%28%29+error+%7B+return+d.fetchHeaders%28p%2C+origin%2B1%2C+pivot%29+%7D%2C+%2F%2F+Headers+are+always+retrieved%0A%09%09func%28%29+error+%7B+return+d.fetchBodies%28origin+%2B+1%29+%7D%2C++++++++++%2F%2F+Bodies+are+retrieved+during+normal+and+fast+sync%0A%09%09func%28%29+error+%7B+return+d.fetchReceipts%28origin+%2B+1%29+%7D%2C++++++++%2F%2F+Receipts+are+retrieved+during+fast+sync%0A%09%09func%28%29+error+%7B+return+d.processHeaders%28origin%2B1%2C+pivot%2C+td%29+%7D%2C%0A%09%7D%0A%09if+d.mode+%3D%3D+FastSync+%7B%0A%09%09fetchers+%3D+append%28fetchers%2C+func%28%29+error+%7B+return+d.processFastSyncContent%28latest%29+%7D%29%0A%09%7D+else+if+d.mode+%3D%3D+FullSync+%7B%0A%09%09fetchers+%3D+append%28fetchers%2C+d.processFullSyncContent%29%0A%09%7D%0A%09return+d.spawnSync%28fetchers%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+fetchHeight%28p%29%EF%BC%9A%E4%BB%8E%E8%8A%82%E7%82%B9p%E6%A0%B9%E6%8D%AEhead+hash%EF%BC%88%E5%BB%BA%E7%AB%8B%E8%8A%82%E7%82%B9handshake%E7%9A%84%E6%97%B6%E5%80%99%E8%8A%82%E7%82%B9p%E4%BC%A0%E8%BF%87%E6%9D%A5%E7%9A%84%E6%9C%80%E6%96%B0%E7%9A%84head+hash%EF%BC%89%E8%8E%B7%E5%8F%96header%EF%BC%8C%E5%8F%91%E9%80%81GetBlockHeadersMsg%E6%B6%88%E6%81%AF%EF%BC%8C%E8%8A%82%E7%82%B9p%E6%94%B6%E5%88%B0%E6%B6%88%E6%81%AF%E5%90%8E%E4%BB%8E%E8%87%AA%E5%B7%B1%E6%9C%AC%E5%9C%B0%E6%8B%BF%E5%88%B0header%E7%84%B6%E5%90%8E%E5%8F%91%E9%80%81BlockHeaderMsg%E6%B6%88%E6%81%AF%EF%BC%8C%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E4%B8%80%E7%9B%B4%E7%AD%89%E5%BE%85%E7%9F%A5%E9%81%93%E6%94%B6%E5%88%B0header%E7%9A%84%E6%B6%88%E6%81%AF%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E2+findAncestor%28p%29%EF%BC%9A%E4%BB%8E%E8%8A%82%E7%82%B9p%E5%AF%BB%E6%89%BE%E5%85%B1%E5%90%8C%E7%9A%84%E7%A5%96%E5%85%88header%E3%80%82%E4%B9%9F%E6%98%AF%E5%8F%91%E9%80%81GetBlockHeadersMsg%E6%B6%88%E6%81%AF%EF%BC%8C%E5%B8%A6%E7%9A%84%E5%8F%82%E6%95%B0%E6%98%AF%E7%AE%97%E5%87%BA%E6%9D%A5%E7%9A%84%E4%BB%8E%E6%9F%90%E4%B8%AA%E9%AB%98%E5%BA%A6%E6%8B%BF%E6%9F%90%E4%BA%9B%E6%95%B0%E9%87%8F%E7%9A%84headers%E3%80%82%E6%8B%BF%E5%88%B0headers%E5%90%8E%E4%BB%8E%E6%9C%80%E6%96%B0%E7%9A%84header%E5%BE%80%E5%89%8Dfor%E5%BE%AA%E7%8E%AF%EF%BC%8C%E7%9C%8B%E6%9C%AC%E5%9C%B0%E7%9A%84lightchain%E6%98%AF%E5%90%A6%E6%9C%89%E8%BF%99%E4%B8%AAheader%EF%BC%8C%E6%9C%89%E7%9A%84%E8%AF%9D%E5%B0%B1%E6%89%BE%E5%88%B0%E4%BA%86%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%E3%80%82%E5%A6%82%E6%9E%9C%E6%9C%AA%E6%89%BE%E5%88%B0%EF%BC%8C%E5%86%8D%E4%BB%8E%E5%88%9B%E4%B8%96%E5%BF%AB%E5%BC%80%E5%A7%8B%E4%BA%8C%E5%88%86%E6%B3%95%E6%9F%A5%E6%89%BE%E6%98%AF%E5%90%A6%E8%83%BD%E6%89%BE%E5%88%B0%E5%85%B1%E5%90%8C%E7%9A%84%E7%A5%96%E5%85%88%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%94%E5%9B%9E%E8%BF%99%E4%B8%AA%E5%85%B1%E5%90%8C%E7%9A%84%E7%A5%96%E5%85%88origin%EF%BC%88%E6%98%AFheader%EF%BC%89%3C%2Fp%3E%0A++%3Cp%3E3+%E6%8B%BF%E5%88%B0%E6%9C%80%E6%96%B0origin%E5%90%8E%EF%BC%8C%E6%9B%B4%E6%96%B0queue%E4%BB%8E%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%E5%BC%80%E5%A7%8Bsync%EF%BC%8C%E8%B0%83%E7%94%A8spawnSync%E5%BC%80%E5%A7%8B%E5%90%8C%E6%AD%A5%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+spawnSync%28fetchers+%5B%5Dfunc%28%29+error%29+error+%7B%0A%09errc+%3A%3D+make%28chan+error%2C+len%28fetchers%29%29%0A%09d.cancelWg.Add%28len%28fetchers%29%29%0A%09for+_%2C+fn+%3A%3D+range+fetchers+%7B%0A%09%09fn+%3A%3D+fn%0A%09%09go+func%28%29+%7B+defer+d.cancelWg.Done%28%29%3B+errc+%26lt%3B-+fn%28%29+%7D%28%29%0A%09%7D%0A%09%2F%2F+Wait+for+the+first+error%2C+then+terminate+the+others.%0A%09var+err+error%0A%09for+i+%3A%3D+0%3B+i+%26lt%3B+len%28fetchers%29%3B+i%2B%2B+%7B%0A%09%09if+i+%3D%3D+len%28fetchers%29-1+%7B%0A%09%09%09%2F%2F+Close+the+queue+when+all+fetchers+have+exited.%0A%09%09%09%2F%2F+This+will+cause+the+block+processor+to+end+when%0A%09%09%09%2F%2F+it+has+processed+the+queue.%0A%09%09%09d.queue.Close%28%29%0A%09%09%7D%0A%09%09if+err+%3D+%26lt%3B-errc%3B+err+%21%3D+nil+%7B%0A%09%09%09break%0A%09%09%7D%0A%09%7D%0A%09d.queue.Close%28%29%0A%09d.Cancel%28%29%0A%09return+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E6%98%AF%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E1+%E5%BE%AA%E7%8E%AF%E6%89%A7%E8%A1%8Cfetchers%EF%BC%8Cfetchers%E6%98%AF%E4%B8%8A%E9%9D%A2%E4%BC%A0%E8%BF%87%E6%9D%A5%E7%9A%84%E4%B8%80%E7%BB%84%E5%87%BD%E6%95%B0%EF%BC%8Cfetch+header%E3%80%81fetch+body%E3%80%81+fetch+receipt%E3%80%81process+header%E7%AD%89%3C%2Fp%3E%0A++%3Cp%3E2+%E7%84%B6%E5%90%8E%E7%AD%89%E5%BE%85%E8%AF%BB%E5%8F%96errc+channel%E5%86%85%E5%AE%B9%EF%BC%8C%E7%AD%89%E5%BE%85sync%E5%AE%8C%E6%88%90%E3%80%82%E6%B3%A8%E6%84%8F%E8%BF%99%E9%87%8Cerrc%E6%98%AF%E4%B8%80%E4%B8%AA%E7%BC%93%E5%86%B2channel%EF%BC%8C%E4%B8%AA%E6%95%B0%E4%B8%BAfetchers%E7%9A%84%E9%95%BF%E5%BA%A6%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%BC%9A%E7%AD%89%E5%BE%85fetchers%E4%B8%AD%E7%9A%84%E6%AF%8F%E4%B8%AA%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%88%90%E8%BF%94%E5%9B%9E%E3%80%82%3Cspan+style%3D%22color%3A%23ff0000%3B%22%3E%E6%89%80%E4%BB%A5%E8%BF%99%E9%87%8C%E5%AE%9E%E7%8E%B0%E4%BA%86pending%E7%9A%84%E6%95%88%E6%9E%9C%EF%BC%8C%E5%B0%B1%E6%98%AF%E4%B8%80%E7%9B%B4%E8%A6%81%E7%AD%89%E5%88%B0sync%E5%AE%8C%E6%88%90%E6%89%8D%E4%BC%9A%E7%BB%93%E6%9D%9Fsync%3C%2Fspan%3E%3C%2Fp%3E%0A++%3Cp%3E3+%E5%A6%82%E6%9E%9Cfast+sync%E7%9A%84%E8%AF%9D%EF%BC%8Cfetchers%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%98%AFprocessFastSyncContent%28%29%EF%BC%9Bfull+sync%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%9C%80%E5%90%8E%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0%E6%98%AFprocessFullSyncContent%28%29%3C%2Fp%3E%0A++%3Ch2%3E%E5%90%8C%E6%AD%A5State%3C%2Fh2%3E%0A++%3Cp%3Estate%E6%98%AF%E4%B8%96%E7%95%8C%E7%8A%B6%E6%80%81%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%9D%80%E6%89%80%E6%9C%89%E8%B4%A6%E6%88%B7%E7%9A%84%E4%BD%99%E9%A2%9D%E7%AD%89%E4%BF%A1%E6%81%AF%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+processFastSyncContent%28latest+*types.Header%29+error+%7B%0A%09%2F%2F+Start+syncing+state+of+the+reported+head+block.+This+should+get+us+most+of%0A%09%2F%2F+the+state+of+the+pivot+block.%0A%09stateSync+%3A%3D+d.syncState%28latest.Root%29%0A%09defer+stateSync.Cancel%28%29%0A%09go+func%28%29+%7B%0A%09%09if+err+%3A%3D+stateSync.Wait%28%29%3B+err+%21%3D+nil+%26amp%3B%26amp%3B+err+%21%3D+errCancelStateFetch+%7B%0A%09%09%09d.queue.Close%28%29+%2F%2F+wake+up+WaitResults%0A%09%09%7D%0A%09%7D%28%29%0A%09%2F%2F+Figure+out+the+ideal+pivot+block.+Note%2C+that+this+goalpost+may+move+if+the%0A%09%2F%2F+sync+takes+long+enough+for+the+chain+head+to+move+significantly.%0A%09pivot+%3A%3D+uint64%280%29%0A%09if+height+%3A%3D+latest.Number.Uint64%28%29%3B+height+%26gt%3B+uint64%28fsMinFullBlocks%29+%7B%0A%09%09pivot+%3D+height+-+uint64%28fsMinFullBlocks%29%0A%09%7D%0A%09%2F%2F+To+cater+for+moving+pivot+points%2C+track+the+pivot+block+and+subsequently%0A%09%2F%2F+accumulated+download+results+separately.%0A%09var+%28%0A%09%09oldPivot+*fetchResult+++%2F%2F+Locked+in+pivot+block%2C+might+change+eventually%0A%09%09oldTail++%5B%5D*fetchResult+%2F%2F+Downloaded+content+after+the+pivot%0A%09%29%0A%09for+%7B%0A%09%09%2F%2F+Wait+for+the+next+batch+of+downloaded+data+to+be+available%2C+and+if+the+pivot%0A%09%09%2F%2F+block+became+stale%2C+move+the+goalpost%0A%09%09results+%3A%3D+d.queue.Results%28oldPivot+%3D%3D+nil%29+%2F%2F+Block+if+we%27re+not+monitoring+pivot+staleness%0A%09%09if+len%28results%29+%3D%3D+0+%7B%0A%09%09%09%2F%2F+If+pivot+sync+is+done%2C+stop%0A%09%09%09if+oldPivot+%3D%3D+nil+%7B%0A%09%09%09%09return+stateSync.Cancel%28%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+If+sync+failed%2C+stop%0A%09%09%09select+%7B%0A%09%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09%09return+stateSync.Cancel%28%29%0A%09%09%09default%3A%0A%09%09%09%7D%0A%09%09%7D%0A%09%09if+d.chainInsertHook+%21%3D+nil+%7B%0A%09%09%09d.chainInsertHook%28results%29%0A%09%09%7D%0A%09%09if+oldPivot+%21%3D+nil+%7B%0A%09%09%09results+%3D+append%28append%28%5B%5D*fetchResult%7BoldPivot%7D%2C+oldTail...%29%2C+results...%29%0A%09%09%7D%0A%09%09%2F%2F+Split+around+the+pivot+block+and+process+the+two+sides+via+fast%2Ffull+sync%0A%09%09if+atomic.LoadInt32%28%26amp%3Bd.committed%29+%3D%3D+0+%7B%0A%09%09%09latest+%3D+results%5Blen%28results%29-1%5D.Header%0A%09%09%09if+height+%3A%3D+latest.Number.Uint64%28%29%3B+height+%26gt%3B+pivot%2B2*uint64%28fsMinFullBlocks%29+%7B%0A%09%09%09%09log.Warn%28%22Pivot+became+stale%2C+moving%22%2C+%22old%22%2C+pivot%2C+%22new%22%2C+height-uint64%28fsMinFullBlocks%29%29%0A%09%09%09%09pivot+%3D+height+-+uint64%28fsMinFullBlocks%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09P%2C+beforeP%2C+afterP+%3A%3D+splitAroundPivot%28pivot%2C+results%29%0A%09%09if+err+%3A%3D+d.commitFastSyncData%28beforeP%2C+stateSync%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09if+P+%21%3D+nil+%7B%0A%09%09%09%2F%2F+If+new+pivot+block+found%2C+cancel+old+state+retrieval+and+restart%0A%09%09%09if+oldPivot+%21%3D+P+%7B%0A%09%09%09%09stateSync.Cancel%28%29%0A%0A%09%09%09%09stateSync+%3D+d.syncState%28P.Header.Root%29%0A%09%09%09%09defer+stateSync.Cancel%28%29%0A%09%09%09%09go+func%28%29+%7B%0A%09%09%09%09%09if+err+%3A%3D+stateSync.Wait%28%29%3B+err+%21%3D+nil+%26amp%3B%26amp%3B+err+%21%3D+errCancelStateFetch+%7B%0A%09%09%09%09%09%09d.queue.Close%28%29+%2F%2F+wake+up+WaitResults%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%28%29%0A%09%09%09%09oldPivot+%3D+P%0A%09%09%09%7D%0A%09%09%09%2F%2F+Wait+for+completion%2C+occasionally+checking+for+pivot+staleness%0A%09%09%09select+%7B%0A%09%09%09case+%26lt%3B-stateSync.done%3A%0A%09%09%09%09if+stateSync.err+%21%3D+nil+%7B%0A%09%09%09%09%09return+stateSync.err%0A%09%09%09%09%7D%0A%09%09%09%09if+err+%3A%3D+d.commitPivotBlock%28P%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09%09return+err%0A%09%09%09%09%7D%0A%09%09%09%09oldPivot+%3D+nil%0A%0A%09%09%09case+%26lt%3B-time.After%28time.Second%29%3A%0A%09%09%09%09oldTail+%3D+afterP%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+Fast+sync+done%2C+pivot+commit+done%2C+full+import%0A%09%09if+err+%3A%3D+d.importBlockResults%28afterP%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+%E5%8F%82%E6%95%B0latest%E6%98%AF%E5%88%9A%E6%89%8D%E4%BB%8E%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84%E6%9C%80%E6%96%B0%E7%9A%84header%EF%BC%8C%3C%2Fp%3E%0A++%3Cp%3E2+syncState%E5%87%BD%E6%95%B0%E5%88%9B%E5%BB%BA%E4%BA%86stateSync%E7%BB%93%E6%9E%84%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%99%E5%88%B0channel+stateSyncStart%3C%2Fp%3E%0A++%3Cp%3E3+%E5%88%9D%E5%A7%8B%E5%8C%96%E5%88%9B%E5%BB%BAdownloader%E7%9A%84%E6%97%B6%E5%80%99%E5%88%9B%E5%BB%BA%E7%9A%84goroutine+statefetcher%28%29%E7%9B%91%E5%90%AC%E5%88%B0%E6%AD%A4channel%E6%9C%89%E6%95%B0%E6%8D%AE%E5%B0%B1%E5%BC%80%E5%A7%8B%E8%BF%9B%E8%A1%8Cstate+sync%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+stateFetcher%28%29+%7B%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+s+%3A%3D+%26lt%3B-d.stateSyncStart%3A%3Cspan+style%3D%22color%3A%23ff0000%3B%22%3E+%3C%2Fspan%3E%09%09%09for+next+%3A%3D+s%3B+next+%21%3D+nil%3B+%7B%0A%09%09%09%09next+%3D+d.runStateSync%28next%29%0A%09%09%09%7D%0A%09%09case+%26lt%3B-d.stateCh%3A%0A%09%09%09%2F%2F+Ignore+state+responses+while+no+sync+is+running.%0A%09%09case+%26lt%3B-d.quitCh%3A%0A%09%09%09return%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3Eeth%2Fdownloader%2Fstatesync.go%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3ErunStateSync%EF%BC%88%EF%BC%89%E5%88%9B%E5%BB%BA%E4%BA%86goroutine+s.run%EF%BC%88%EF%BC%89%EF%BC%8C%E5%86%85%E9%83%A8%E8%B0%83%E7%94%A8loop%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28s+*stateSync%29+loop%28%29+%28err+error%29+%7B%0A%09%2F%2F+Listen+for+new+peer+events+to+assign+tasks+to+them%0A%09newPeer+%3A%3D+make%28chan+*peerConnection%2C+1024%29%0A%09peerSub+%3A%3D+s.d.peers.SubscribeNewPeers%28newPeer%29%0A%09defer+peerSub.Unsubscribe%28%29%0A%09defer+func%28%29+%7B%0A%09%09cerr+%3A%3D+s.commit%28true%29%0A%09%09if+err+%3D%3D+nil+%7B%0A%09%09%09err+%3D+cerr%0A%09%09%7D%0A%09%7D%28%29%0A%0A%09%2F%2F+Keep+assigning+new+tasks+until+the+sync+completes+or+aborts%0A%09for+s.sched.Pending%28%29+%26gt%3B+0+%7B%0A%09%09if+err+%3D+s.commit%28false%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09s.assignTasks%28%29%0A%09%09%2F%2F+Tasks+assigned%2C+wait+for+something+to+happen%0A%09%09select+%7B%0A%09%09case+%26lt%3B-newPeer%3A%0A%09%09%09%2F%2F+New+peer+arrived%2C+try+to+assign+it+download+tasks%0A%0A%09%09case+%26lt%3B-s.cancel%3A%0A%09%09%09return+errCancelStateFetch%0A%0A%09%09case+%26lt%3B-s.d.cancelCh%3A%0A%09%09%09return+errCancelStateFetch%0A%0A%09%09case+req+%3A%3D+%26lt%3B-s.deliver%3A%0A%09%09%09%2F%2F+Response%2C+disconnect+or+timeout+triggered%2C+drop+the+peer+if+stalling%0A%09%09%09log.Trace%28%22Received+node+data+response%22%2C+%22peer%22%2C+req.peer.id%2C+%22count%22%2C+len%28req.response%29%2C+%22dropped%22%2C+req.dropped%2C+%22timeout%22%2C+%21req.dropped+%26amp%3B%26amp%3B+req.timedOut%28%29%29%0A%09%09%09if+len%28req.items%29+%26lt%3B%3D+2+%26amp%3B%26amp%3B+%21req.dropped+%26amp%3B%26amp%3B+req.timedOut%28%29+%7B%0A%09%09%09%09%2F%2F+2+items+are+the+minimum+requested%2C+if+even+that+times+out%2C+we%27ve+no+use+of%0A%09%09%09%09%2F%2F+this+peer+at+the+moment.%0A%09%09%09%09log.Warn%28%22Stalling+state+sync%2C+dropping+peer%22%2C+%22peer%22%2C+req.peer.id%29%0A%09%09%09%09s.d.dropPeer%28req.peer.id%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Process+all+the+received+blobs+and+check+for+stale+delivery%0A%09%09%09if+err+%3D+s.process%28req%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09log.Warn%28%22Node+data+write+error%22%2C+%22err%22%2C+err%29%0A%09%09%09%09return+err%0A%09%09%09%7D%0A%09%09%09req.peer.SetNodeDataIdle%28len%28req.response%29%29%0A%09%09%7D%0A%09%7D%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E8%BF%99%E6%AE%B5%E4%BB%A3%E7%A0%81%E4%BB%A5%E5%8F%8A%E5%AD%90%E5%87%BD%E6%95%B0assignTasks%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E1+%E4%BB%8E%E6%89%80%E6%9C%89%E7%A9%BA%E9%97%B2%E7%9A%84peer%E8%8A%82%E7%82%B9%E5%BC%80%E5%A7%8B%E8%8E%B7%E5%8F%96state%E7%8A%B6%E6%80%81%EF%BC%8C%E5%8F%91%E9%80%81GetNodeDataMsg%E6%95%B0%E6%8D%AE%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E2+%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0%E6%AD%A4%E6%B6%88%E6%81%AF%E5%90%8E%EF%BC%8C%E8%BF%94%E5%9B%9ENodeDataMsg%E5%8C%85%E6%8B%AC%E4%B8%80%E5%AE%9A%E6%95%B0%E9%87%8F%E7%9A%84state%E6%95%B0%E6%8D%AE%3C%2Fp%3E%0A++%3Cp%3E3+%E6%9C%AC%E8%8A%82%E7%82%B9%E6%94%B6%E5%88%B0NodeDataMsg%E5%90%8E%EF%BC%8C%E6%8A%8A%E6%95%B0%E6%8D%AE%E5%86%99%E5%88%B0channel+stateCh%3C%2Fp%3E%0A++%3Cp%3E4+runStateSync%EF%BC%88%EF%BC%89%E5%87%BD%E6%95%B0%E7%9B%91%E5%90%AC%E6%AD%A4channel%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%86%99%E5%85%A5finished%E7%BB%93%E6%9E%84%E5%86%85%EF%BC%88%E4%B9%9F%E6%98%AFstateReq%E7%B1%BB%E5%9E%8B%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E5%86%99%E5%85%A5channel+s.deliver%E4%B8%AD%3C%2Fp%3E%0A++%3Cp%3E5+%E5%88%9A%E6%89%8D%E5%8F%91%E9%80%81GetNodeDataMsg%E7%9A%84%E5%87%BD%E6%95%B0loop%EF%BC%88%EF%BC%89%E5%86%85%E5%9C%A8%E7%9B%91%E5%90%ACchannel+s.deliver%EF%BC%8C%E6%8B%BF%E5%88%B0%E6%95%B0%E6%8D%AE%E5%90%8E%E8%B0%83%E7%94%A8process%E5%87%BD%E6%95%B0%3C%2Fp%3E%0A++%3Cp%3E%EF%BC%88%E7%94%B1%E4%BA%8E%E4%BB%A3%E7%A0%81%E5%A4%AA%E5%A4%9A%EF%BC%8C%E6%9A%82%E4%B8%8D%E8%B4%B4%E4%B8%8A%E6%9D%A5%EF%BC%8C%E5%8F%AF%E4%BB%A5%E8%87%AA%E8%A1%8C%E5%88%B0%E4%BB%A3%E7%A0%81%E4%B8%AD%E6%A0%B9%E6%8D%AE%E5%87%BD%E6%95%B0%E5%90%8D%E6%90%9C%E7%B4%A2%E5%8D%B3%E5%8F%AF%EF%BC%89%3C%2Fp%3E%0A++%3Cp%3E6+procress%28%29%E5%87%BD%E6%95%B0%E5%A4%84%E7%90%86%E6%94%B6%E5%88%B0%E7%9A%84state%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%86%99%E5%85%A5%E6%9C%AC%E5%9C%B0%EF%BC%88%E5%85%88%E5%86%99%E5%85%A5memory%EF%BC%8C%E5%90%8E%E7%BB%ADCommit%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%80%E8%B5%B7%E5%86%99%E5%85%A5leveldb%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89%3C%2Fp%3E%0A++%3Cp%3E7+%E7%84%B6%E5%90%8E%E8%AE%BE%E7%BD%AEpeer%E4%B8%BAidle%E5%90%8E%E7%BB%AD%E7%BB%A7%E7%BB%AD%E8%AF%B7%E6%B1%82state%E6%95%B0%E6%8D%AE%3C%2Fp%3E%0A++%3Ch2%3E%E5%90%8C%E6%AD%A5Headers%3C%2Fh2%3E%0A++%3Cp%3E%E4%B8%8A%E9%9D%A2fetchers%E4%B8%AD%E8%B0%83%E7%94%A8fetchHeaders%E5%90%8C%E6%AD%A5header%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+fetchHeaders%28p+*peerConnection%2C+from+uint64%2C+pivot+uint64%29+error+%7B%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E9%BB%98%E8%AE%A4skeleton%E4%B8%BAtrue%EF%BC%8C%E8%A1%A8%E7%A4%BA%E5%85%88%E8%8E%B7%E5%8F%96%E9%AA%A8%E6%9E%B6%EF%BC%88%E9%97%B4%E9%9A%94%E7%9A%84headers%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%8D%E4%BB%8E%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%A1%AB%E5%85%85%E9%AA%A8%E6%9E%B6%E9%97%B4%E7%9A%84headers%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3Bskeleton+%3A%3D+true%0A%09getHeaders+%3A%3D+func%28from+uint64%29+%7B%0A%09%09request+%3D+time.Now%28%29%0A%0A%09%09ttl+%3D+d.requestTTL%28%29%0A%09%09timeout.Reset%28ttl%29%0A%0A%09%09if+skeleton+%7B%0A%09%09%09%2F%2F+%E7%9C%8B%E5%8F%82%E6%95%B0MaxHeaderFetch-1%EF%BC%88%E8%B7%B3%E8%B7%83%E7%9A%84%E8%B7%9D%E7%A6%BB%EF%BC%89%EF%BC%8C%E8%8E%B7%E5%8F%96%E7%9A%84header%E6%98%AF%E8%B7%B3%E8%B7%83%E7%9A%84%0A%09%09%09go+p.peer.RequestHeadersByNumber%28from%2Buint64%28MaxHeaderFetch%29-1%2C+MaxSkeletonSize%2C+MaxHeaderFetch-1%2C+false%29%0A%09%09%7D+else+%7B%0A%09%09%09%2F%2F+%E8%8E%B7%E5%8F%96%E9%AA%A8%E6%9E%B6%E5%AE%8C%E6%88%90%E6%88%96%E8%80%85%E5%A4%B1%E8%B4%A5%EF%BC%8C%E9%A1%BA%E5%BA%8F%E8%8E%B7%E5%8F%96headers%0A%09%09%09go+p.peer.RequestHeadersByNumber%28from%2C+MaxHeaderFetch%2C+0%2C+false%29%0A%09%09%7D%0A%09%7D%0A%09%2F%2F+Start+pulling+the+header+chain+skeleton+until+all+is+done%0A%09getHeaders%28from%29%0A%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09return+errCancelHeaderFetch%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E4%BB%8E%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96header%E5%90%8E%E4%BC%9A%E5%86%99%E5%88%B0channel+headerCh%0A%09%09case+packet+%3A%3D+%26lt%3B-d.headerCh%3A%0A%09%09%09%2F%2F+If+the+skeleton%27s+finished%2C+pull+any+remaining+head+headers+directly+from+the+origin%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E8%8E%B7%E5%8F%96skeleton%E5%AE%8C%E6%88%90%EF%BC%8C%E8%AE%BE%E7%BD%AEskeleton%E4%B8%BAfalse%EF%BC%8C%E9%A1%BA%E5%BA%8F%E8%8E%B7%E5%8F%96%0A%09%09%09if+packet.Items%28%29+%3D%3D+0+%26amp%3B%26amp%3B+skeleton+%7B%0A%09%09%09%09skeleton+%3D+false%0A%09%09%09%09getHeaders%28from%29%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%09%2F%2F+If+no+more+headers+are+inbound%2C+notify+the+content+fetchers+and+return%0A%09%09%09...%0A%09%09%09headers+%3A%3D+packet.%28*headerPack%29.headers%0A%0A%09%09%09%2F%2F+If+we+received+a+skeleton+batch%2C+resolve+internals+concurrently%0A%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%26nbsp%3B%2F%2F+%E5%A6%82%E6%9E%9C%E8%8E%B7%E5%8F%96%E4%BA%86%E4%B8%80%E4%BA%9Bheader%E7%9A%84%E9%AA%A8%E6%9E%B6%EF%BC%8C%E5%BC%80%E5%A7%8B%E5%A1%AB%E5%85%85%0A%09%09%09if+skeleton+%7B%0A%09%09%09%09filled%2C+proced%2C+err+%3A%3D+d.fillHeaderSkeleton%28from%2C+headers%29%0A%09%09%09%09if+err+%21%3D+nil+%7B%0A%09%09%09%09%09p.log.Debug%28%22Skeleton+chain+invalid%22%2C+%22err%22%2C+err%29%0A%09%09%09%09%09return+errInvalidChain%0A%09%09%09%09%7D%0A%09%09%09%09headers+%3D+filled%5Bproced%3A%5D%0A%09%09%09%09from+%2B%3D+uint64%28proced%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Insert+all+the+new+headers+and+fetch+the+next+batch%0A%09%09%09if+len%28headers%29+%26gt%3B+0+%7B%0A%09%09%09%09p.log.Trace%28%22Scheduling+new+headers%22%2C+%22count%22%2C+len%28headers%29%2C+%22from%22%2C+from%29%0A%09%09%09%09select+%7B%0A%09%09%09%09case+d.headerProcCh+%26lt%3B-+headers%3A%0A%09%09%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09%09%09return+errCancelHeaderFetch%0A%09%09%09%09%7D%0A%09%09%09%09from+%2B%3D+uint64%28len%28headers%29%29%0A%09%09%09%7D%0A%09%09%09getHeaders%28from%29%0A%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+%E5%85%88%E4%BB%8E%E5%BD%93%E5%89%8Dpeer%E8%8E%B7%E5%8F%96%E4%B8%80%E7%BB%84%E6%9C%89%E9%97%B4%E9%9A%94%E7%9A%84headers%EF%BC%8C%E7%A7%B0%E8%B0%93%E9%AA%A8%E6%9E%B6%3C%2Fp%3E%0A++%3Cp%3E2+%E7%84%B6%E5%90%8E%E6%89%BE%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%A1%AB%E5%85%85headers%E9%AA%A8%E6%9E%B6%E4%BD%BF%E8%BF%9E%E7%BB%AD%3C%2Fp%3E%0A++%3Cp%3E3+%E5%A1%AB%E5%85%85%E5%AE%8C%E6%AF%95%E5%90%8E%EF%BC%8Cheaders%E5%90%8E%E5%86%99%E5%85%A5channel+headerProcCh%EF%BC%88%E4%B8%8B%E9%9D%A2%E7%9A%84%E5%A4%84%E7%90%86headers%E4%B8%AD%E5%A4%84%E7%90%86%EF%BC%89%EF%BC%8C%E5%90%8C%E6%97%B6%E6%8A%8Afrom%E8%B5%8B%E5%80%BC%E4%B8%BA%E6%96%B0%E7%9A%84from%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%9B%E8%A1%8C%E4%B8%8B%E4%B8%80%E6%89%B9headers%E7%9A%84%E8%8E%B7%E5%8F%96%3C%2Fp%3E%0A++%3Ch2%3E%E5%A4%84%E7%90%86Headers%3C%2Fh2%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+processHeaders%28origin+uint64%2C+pivot+uint64%2C+td+*big.Int%29+error+%7B%0A%09for+%7B%0A%09%09select+%7B%0A%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09return+errCancelHeaderProcessing%0A%0A%09%09case+headers+%3A%3D+%26lt%3B-d.headerProcCh%3A%0A%09%09%09%2F%2F+Otherwise+split+the+chunk+of+headers+into+batches+and+process+them%0A%09%09%09gotHeaders+%3D+true%0A%0A%09%09%09for+len%28headers%29+%26gt%3B+0+%7B%0A%09%09%09%09%2F%2F+Terminate+if+something+failed+in+between+processing+chunks%0A%09%09%09%09select+%7B%0A%09%09%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09%09%09return+errCancelHeaderProcessing%0A%09%09%09%09default%3A%0A%09%09%09%09%7D%0A%09%09%09%09%2F%2F+Select+the+next+chunk+of+headers+to+import%0A%09%09%09%09limit+%3A%3D+maxHeadersProcess%0A%09%09%09%09if+limit+%26gt%3B+len%28headers%29+%7B%0A%09%09%09%09%09limit+%3D+len%28headers%29%0A%09%09%09%09%7D%0A%09%09%09%09chunk+%3A%3D+headers%5B%3Alimit%5D%0A%0A%09%09%09%09%2F%2F+In+case+of+header+only+syncing%2C+validate+the+chunk+immediately%0A%09%09%09%09if+d.mode+%3D%3D+FastSync+%7C%7C+d.mode+%3D%3D+LightSync+%7B%0A%09%09%09%09%09%2F%2F+Collect+the+yet+unknown+headers+to+mark+them+as+uncertain%0A%09%09%09%09%09unknown+%3A%3D+make%28%5B%5D*types.Header%2C+0%2C+len%28headers%29%29%0A%09%09%09%09%09for+_%2C+header+%3A%3D+range+chunk+%7B%0A%09%09%09%09%09%09if+%21d.lightchain.HasHeader%28header.Hash%28%29%2C+header.Number.Uint64%28%29%29+%7B%0A%09%09%09%09%09%09%09unknown+%3D+append%28unknown%2C+header%29%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%7D%0A%09%09%09%09%09%2F%2F+If+we%27re+importing+pure+headers%2C+verify+based+on+their+recentness%0A%09%09%09%09%09frequency+%3A%3D+fsHeaderCheckFrequency%0A%09%09%09%09%09if+chunk%5Blen%28chunk%29-1%5D.Number.Uint64%28%29%2Buint64%28fsHeaderForceVerify%29+%26gt%3B+pivot+%7B%0A%09%09%09%09%09%09frequency+%3D+1%0A%09%09%09%09%09%7D%0A%09%09%09%09%09if+n%2C+err+%3A%3D+d.lightchain.InsertHeaderChain%28chunk%2C+frequency%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09%09%09%2F%2F+If+some+headers+were+inserted%2C+add+them+too+to+the+rollback+list%0A%09%09%09%09%09%09if+n+%26gt%3B+0+%7B%0A%09%09%09%09%09%09%09rollback+%3D+append%28rollback%2C+chunk%5B%3An%5D...%29%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09log.Debug%28%22Invalid+header+encountered%22%2C+%22number%22%2C+chunk%5Bn%5D.Number%2C+%22hash%22%2C+chunk%5Bn%5D.Hash%28%29%2C+%22err%22%2C+err%29%0A%09%09%09%09%09%09return+errInvalidChain%0A%09%09%09%09%09%7D%0A%09%09%09%09%09%2F%2F+All+verifications+passed%2C+store+newly+found+uncertain+headers%0A%09%09%09%09%09rollback+%3D+append%28rollback%2C+unknown...%29%0A%09%09%09%09%09if+len%28rollback%29+%26gt%3B+fsHeaderSafetyNet+%7B%0A%09%09%09%09%09%09rollback+%3D+append%28rollback%5B%3A0%5D%2C+rollback%5Blen%28rollback%29-fsHeaderSafetyNet%3A%5D...%29%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%0A%09%09%09%09%2F%2F+Unless+we%27re+doing+light+chains%2C+schedule+the+headers+for+associated+content+retrieval%0A%09%09%09%09if+d.mode+%3D%3D+FullSync+%7C%7C+d.mode+%3D%3D+FastSync+%7B%0A%09%09%09%09%09%2F%2F+If+we%27ve+reached+the+allowed+number+of+pending+headers%2C+stall+a+bit%0A%09%09%09%09%09for+d.queue.PendingBlocks%28%29+%26gt%3B%3D+maxQueuedHeaders+%7C%7C+d.queue.PendingReceipts%28%29+%26gt%3B%3D+maxQueuedHeaders+%7B%0A%09%09%09%09%09%09select+%7B%0A%09%09%09%09%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09%09%09%09%09return+errCancelHeaderProcessing%0A%09%09%09%09%09%09case+%26lt%3B-time.After%28time.Second%29%3A%0A%09%09%09%09%09%09%7D%0A%09%09%09%09%09%7D%0A%09%09%09%09%09%2F%2F+Otherwise+insert+the+headers+for+content+retrieval%0A%09%09%09%09%09inserts+%3A%3D+d.queue.Schedule%28chunk%2C+origin%29%0A%09%09%09%09%09if+len%28inserts%29+%21%3D+len%28chunk%29+%7B%0A%09%09%09%09%09%09log.Debug%28%22Stale+headers%22%29%0A%09%09%09%09%09%09return+errBadPeer%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%0A%09%09%09%09headers+%3D+headers%5Blimit%3A%5D%0A%09%09%09%09origin+%2B%3D+uint64%28limit%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+%E6%94%B6%E5%88%B0headers%E5%90%8E%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AFfast%E6%88%96%E8%80%85light+sync%EF%BC%8C%E6%AF%8F1K%E4%B8%AAheader%E5%A4%84%E7%90%86%EF%BC%8C%E8%B0%83%E7%94%A8lightchain.InsertHeaderChain%28%29%E5%86%99%E5%85%A5header%E5%88%B0leveldb%E6%95%B0%E6%8D%AE%E5%BA%93%3C%2Fp%3E%0A++%3Cp%3E2+%E7%84%B6%E5%90%8E%E5%A6%82%E6%9E%9C%E5%BD%93%E5%89%8D%E6%98%AFfast%E6%88%96%E8%80%85full+sync%E6%A8%A1%E5%BC%8F%E5%90%8E%EF%BC%8Cd.queue.Schedule%28chunk%2C+origin%29%E8%B5%8B%E5%80%BCblockTaskPool%2FblockTaskQueue%E5%92%8CreceiptTaskPool%2FreceiptTaskQueue%EF%BC%88only+fast+%E6%A8%A1%E5%BC%8F%E4%B8%8B%EF%BC%89%EF%BC%8C%E4%BE%9B%E5%90%8E%E7%BB%AD%E5%90%8C%E6%AD%A5body%E5%92%8C%E5%90%8C%E6%AD%A5receipt%E4%BD%BF%E7%94%A8%3C%2Fp%3E%0A++%3Ch2%3E%E5%90%8C%E6%AD%A5Body%3C%2Fh2%3E%0A++%3Cp%3E%E4%B8%8A%E9%9D%A2fetchers%E4%B8%AD%E8%B0%83%E7%94%A8fetchBodies%E5%90%8C%E6%AD%A5body%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+fetchBodies%28from+uint64%29+error+%7B%0A%09log.Debug%28%22Downloading+block+bodies%22%2C+%22origin%22%2C+from%29%0A%0A%09var+%28%0A%09%09deliver+%3D+func%28packet+dataPack%29+%28int%2C+error%29+%7B%0A%09%09%09pack+%3A%3D+packet.%28*bodyPack%29%0A%09%09%09return+d.queue.DeliverBodies%28pack.peerId%2C+pack.transactions%2C+pack.uncles%29%0A%09%09%7D%0A%09%09expire+++%3D+func%28%29+map%5Bstring%5Dint+%7B+return+d.queue.ExpireBodies%28d.requestTTL%28%29%29+%7D%0A%09%09fetch++++%3D+func%28p+*peerConnection%2C+req+*fetchRequest%29+error+%7B+return+p.FetchBodies%28req%29+%7D%0A%09%09capacity+%3D+func%28p+*peerConnection%29+int+%7B+return+p.BlockCapacity%28d.requestRTT%28%29%29+%7D%0A%09%09setIdle++%3D+func%28p+*peerConnection%2C+accepted+int%29+%7B+p.SetBodiesIdle%28accepted%29+%7D%0A%09%29%0A%09err+%3A%3D+d.fetchParts%28errCancelBodyFetch%2C+d.bodyCh%2C+deliver%2C+d.bodyWakeCh%2C+expire%2C%0A%09%09d.queue.PendingBlocks%2C+d.queue.InFlightBlocks%2C+d.queue.ShouldThrottleBlocks%2C+d.queue.ReserveBodies%2C%0A%09%09d.bodyFetchHook%2C+fetch%2C+d.queue.CancelBodies%2C+capacity%2C+d.peers.BodyIdlePeers%2C+setIdle%2C+%22bodies%22%29%0A%0A%09log.Debug%28%22Block+body+download+terminated%22%2C+%22err%22%2C+err%29%0A%09return+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3EfetchParts%E7%9A%84%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91%EF%BC%9A%0A++%3Cbr%3E%0A++%3Cp%3E1+%E4%BB%8Epool%E4%B8%AD%E5%8F%96%E5%87%BA%E8%A6%81%E5%90%8C%E6%AD%A5%E7%9A%84body%3C%2Fp%3E%0A++%3Cp%3E2+%E8%B0%83%E7%94%A8fetch%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%B0%83%E7%94%A8%E8%BF%99%E9%87%8C%E7%9A%84FetchBodies%E4%BB%8E%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96body%EF%BC%8C%E5%8F%91%E9%80%81GetBlockBodiesMsg%E6%B6%88%E6%81%AF%3C%2Fp%3E%0A++%3Cp%3E3+%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%E5%90%8E%E5%8F%91%E5%9B%9E%E6%B6%88%E6%81%AFBlockBodiesMsg%EF%BC%8C%E5%86%99%E5%85%A5channel+bodyCh%3C%2Fp%3E%0A++%3Cp%3E4+%E6%94%B6%E5%88%B0channel+bodyCh%E7%9A%84%E6%95%B0%E6%8D%AE%E5%90%8E%EF%BC%8C%E8%B0%83%E7%94%A8deliver%E5%87%BD%E6%95%B0%3C%2Fp%3E%0A++%3Cp%3E%E6%89%80%E4%BB%A5%E6%8E%A5%E7%9D%80%E7%9C%8B%E4%B8%8Bdeliver%E5%87%BD%E6%95%B0%E4%B8%ADd.queue.DeliverReceipts%E7%9A%84%E4%BB%A3%E7%A0%81%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28q+*queue%29+DeliverBodies%28id+string%2C+txLists+%5B%5D%5B%5D*types.Transaction%2C+uncleLists+%5B%5D%5B%5D*types.Header%29+%28int%2C+error%29+%7B%0A%09q.lock.Lock%28%29%0A%09defer+q.lock.Unlock%28%29%0A%0A%09reconstruct+%3A%3D+func%28header+*types.Header%2C+index+int%2C+result+*fetchResult%29+error+%7B%0A%09%09if+types.DeriveSha%28types.Transactions%28txLists%5Bindex%5D%29%29+%21%3D+header.TxHash+%7C%7C+types.CalcUncleHash%28uncleLists%5Bindex%5D%29+%21%3D+header.UncleHash+%7B%0A%09%09%09return+errInvalidBody%0A%09%09%7D%0A%09%09result.Transactions+%3D+txLists%5Bindex%5D%0A%09%09result.Uncles+%3D+uncleLists%5Bindex%5D%0A%09%09return+nil%0A%09%7D%0A%09return+q.deliver%28id%2C+q.blockTaskPool%2C+q.blockTaskQueue%2C+q.blockPendPool%2C+q.blockDonePool%2C+bodyReqTimer%2C+len%28txLists%29%2C+reconstruct%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+%E8%BF%99%E9%87%8C%E7%94%A8%E5%88%B0%E4%BA%86%E5%A4%84%E7%90%86header%E6%97%B6%E4%B8%AD%E8%B5%8B%E5%80%BC%E7%9A%84blockTaskPool%E5%92%8CblockTaskQueue%3C%2Fp%3E%0A++%3Cp%3E2+q.deliver%E4%B8%AD%E7%94%A8%E5%88%B0%E4%BA%86%E8%BF%99%E9%87%8C%E5%AE%9A%E4%B9%89%E7%9A%84reconstruct%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8A%8Abody%E5%AD%98%E5%85%A5resultCache%E4%B8%AD%E7%9A%84Transactions%E5%92%8CUncles%3C%2Fp%3E%0A++%3Cp%3E3+%E4%B8%8B%E9%9D%A2%E5%A4%84%E7%90%86Content%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E7%94%A8%E5%88%B0%E8%BF%99%E4%B8%AATransactions%E5%92%8CUncles%3C%2Fp%3E%0A++%3Ch2%3E%E5%90%8C%E6%AD%A5Receipt%3C%2Fh2%3E%0A++%3Cp%3E%E4%B8%8A%E9%9D%A2fetchers%E4%B8%AD%E8%B0%83%E7%94%A8fetchReceipts%E5%90%8C%E6%AD%A5receipts%3Cbr%3E%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+fetchReceipts%28from+uint64%29+error+%7B%0A%09log.Debug%28%22Downloading+transaction+receipts%22%2C+%22origin%22%2C+from%29%0A%0A%09var+%28%0A%09%09deliver+%3D+func%28packet+dataPack%29+%28int%2C+error%29+%7B%0A%09%09%09pack+%3A%3D+packet.%28*receiptPack%29%0A%09%09%09return+d.queue.DeliverReceipts%28pack.peerId%2C+pack.receipts%29%0A%09%09%7D%0A%09%09expire+++%3D+func%28%29+map%5Bstring%5Dint+%7B+return+d.queue.ExpireReceipts%28d.requestTTL%28%29%29+%7D%0A%09%09fetch++++%3D+func%28p+*peerConnection%2C+req+*fetchRequest%29+error+%7B+return+p.FetchReceipts%28req%29+%7D%0A%09%09capacity+%3D+func%28p+*peerConnection%29+int+%7B+return+p.ReceiptCapacity%28d.requestRTT%28%29%29+%7D%0A%09%09setIdle++%3D+func%28p+*peerConnection%2C+accepted+int%29+%7B+p.SetReceiptsIdle%28accepted%29+%7D%0A%09%29%0A%09err+%3A%3D+d.fetchParts%28errCancelReceiptFetch%2C+d.receiptCh%2C+deliver%2C+d.receiptWakeCh%2C+expire%2C%0A%09%09d.queue.PendingReceipts%2C+d.queue.InFlightReceipts%2C+d.queue.ShouldThrottleReceipts%2C+d.queue.ReserveReceipts%2C%0A%09%09d.receiptFetchHook%2C+fetch%2C+d.queue.CancelReceipts%2C+capacity%2C+d.peers.ReceiptIdlePeers%2C+setIdle%2C+%22receipts%22%29%0A%0A%09log.Debug%28%22Transaction+receipt+download+terminated%22%2C+%22err%22%2C+err%29%0A%09return+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E4%BB%A3%E7%A0%81%E8%B7%9FfetchBodies%E4%B8%AD%E7%9A%84%E7%B1%BB%E4%BC%BC%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3E1+%E4%BB%8Epool%E4%B8%AD%E5%8F%96%E5%87%BA%E8%A6%81%E5%90%8C%E6%AD%A5%E7%9A%84receipts%3C%2Fp%3E%0A++%3Cp%3E2+%E8%B0%83%E7%94%A8fetch%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%B0%83%E7%94%A8%E8%BF%99%E9%87%8C%E7%9A%84FetchReceipts%E4%BB%8E%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96receipts%EF%BC%8C%E5%8F%91%E9%80%81GetReceiptsMsg%E6%B6%88%E6%81%AF%3C%2Fp%3E%0A++%3Cp%3E3+%E5%AF%B9%E7%AB%AF%E8%8A%82%E7%82%B9%E5%A4%84%E7%90%86%E5%AE%8C%E6%88%90%E5%90%8E%E5%8F%91%E5%9B%9E%E6%B6%88%E6%81%AFReceiptsMsg%EF%BC%8C%E5%86%99%E5%85%A5channel+receiptCh%3C%2Fp%3E%0A++%3Cp%3E4+%E6%94%B6%E5%88%B0channel+receiptCh%E7%9A%84%E6%95%B0%E6%8D%AE%E5%90%8E%EF%BC%8C%E8%B0%83%E7%94%A8deliver%E5%87%BD%E6%95%B0%3C%2Fp%3E%E7%9C%8B%E4%B8%8Bdeliver%E5%87%BD%E6%95%B0%E4%B8%AD%E7%9A%84d.queue.DeliverReceipts%E5%87%BD%E6%95%B0%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28q+*queue%29+DeliverReceipts%28id+string%2C+receiptList+%5B%5D%5B%5D*types.Receipt%29+%28int%2C+error%29+%7B%0A%09q.lock.Lock%28%29%0A%09defer+q.lock.Unlock%28%29%0A%0A%09reconstruct+%3A%3D+func%28header+*types.Header%2C+index+int%2C+result+*fetchResult%29+error+%7B%0A%09%09if+types.DeriveSha%28types.Receipts%28receiptList%5Bindex%5D%29%29+%21%3D+header.ReceiptHash+%7B%0A%09%09%09return+errInvalidReceipt%0A%09%09%7D%0A%09%09result.Receipts+%3D+receiptList%5Bindex%5D%0A%09%09return+nil%0A%09%7D%0A%09return+q.deliver%28id%2C+q.receiptTaskPool%2C+q.receiptTaskQueue%2C+q.receiptPendPool%2C+q.receiptDonePool%2C+receiptReqTimer%2C+len%28receiptList%29%2C+reconstruct%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+%E8%BF%99%E9%87%8C%E7%94%A8%E5%88%B0%E4%BA%86%E5%A4%84%E7%90%86header%E4%B8%AD%E7%9A%84receiptTaskPool%E5%92%8CreceiptTaskQueue%3C%2Fp%3E%0A++%3Cp%3E2+q.deliver%E4%B8%AD%E7%94%A8%E5%88%B0%E4%BA%86%E8%BF%99%E9%87%8C%E5%AE%9A%E4%B9%89%E7%9A%84reconstruct%E5%87%BD%E6%95%B0%EF%BC%8C%E6%8A%8Areceipts%E5%AD%98%E5%85%A5resultCache%E4%B8%AD%E7%9A%84Receipts%3C%2Fp%3E%0A++%3Cp%3E3+%E5%90%8E%E7%BB%AD%E5%A4%84%E7%90%86Content%E7%9A%84%E6%97%B6%E5%80%99%E6%8B%BF%E5%88%B0Receipts%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%E6%9C%AC%E5%9C%B0leveldb%3C%2Fp%3E%0A++%3Cdiv%3E%0A+++%3Ch2%3E%E5%A4%84%E7%90%86Content%3C%2Fh2%3E%0A+++%3Cp%3E%E8%BF%99%E9%87%8C%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E6%8A%8Ablock%E5%92%8Creceipts%E5%86%99%E5%85%A5%E6%9C%AC%E5%9C%B0%E7%9A%84leveldb%3C%2Fp%3E%0A+++%3Cp%3Efast+sync%E6%A8%A1%E5%BC%8F%E4%B8%8B%E8%B0%83%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0%E6%98%AFprocessFastSyncContent%3C%2Fp%3E%0A+++%3Cp%3Efull+sync%E6%A8%A1%E5%BC%8F%E4%B8%8B%E8%B0%83%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0%E6%98%AFprocessFullSyncContent%3C%2Fp%3E%0A+++%3Cp%3E%E5%85%88%E7%9C%8B%E4%B8%8Bfull%E6%A8%A1%E5%BC%8F%E4%B8%8BprocessFullSyncContent%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%9A%3C%2Fp%3E%0A+++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+processFullSyncContent%28%29+error+%7B%0A%09for+%7B%0A%09%09results+%3A%3D+d.queue.Results%28true%29%0A%09%09if+len%28results%29+%3D%3D+0+%7B%0A%09%09%09return+nil%0A%09%09%7D%0A%09%09if+d.chainInsertHook+%21%3D+nil+%7B%0A%09%09%09d.chainInsertHook%28results%29%0A%09%09%7D%0A%09%09if+err+%3A%3D+d.importBlockResults%28results%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A+++%3Cp%3E1+d.queue.Results%EF%BC%88%EF%BC%89%E5%87%BD%E6%95%B0%E4%BB%8E%E4%B8%8A%E9%9D%A2%E7%9A%84resultCache%E4%B8%AD%E6%8B%BF%E5%88%B0%E4%BF%9D%E5%AD%98%E7%9A%84%E5%86%85%E5%AE%B9%3C%2Fp%3E%0A+++%3Cp%3E2+improtBlockResults%EF%BC%88%EF%BC%89%E4%B8%AD%E6%A0%B9%E6%8D%AEresults%E7%9A%84header%EF%BC%8Cbody%E7%BB%84%E7%BB%87%E6%88%90block%EF%BC%8C%E7%84%B6%E5%90%8Ed.blockchain.InsertChain%28blocks%29%E5%86%99block%E5%88%B0%E6%9C%AC%E5%9C%B0%E7%9A%84leveldb%3C%2Fp%3E%E5%86%8D%E7%9C%8B%E4%B8%8Bfast+sync%E7%9A%84processFastSyncContent%E5%87%BD%E6%95%B0%EF%BC%9A%0A++%3C%2Fdiv%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28d+*Downloader%29+processFastSyncContent%28latest+*types.Header%29+error+%7B%0A%09%2F%2F+Start+syncing+state+of+the+reported+head+block.+This+should+get+us+most+of%0A%09%2F%2F+the+state+of+the+pivot+block.%0A%09stateSync+%3A%3D+d.syncState%28latest.Root%29%0A%09defer+stateSync.Cancel%28%29%0A%09go+func%28%29+%7B%0A%09%09if+err+%3A%3D+stateSync.Wait%28%29%3B+err+%21%3D+nil+%26amp%3B%26amp%3B+err+%21%3D+errCancelStateFetch+%7B%0A%09%09%09d.queue.Close%28%29+%2F%2F+wake+up+WaitResults%0A%09%09%7D%0A%09%7D%28%29%0A%09%2F%2F+Figure+out+the+ideal+pivot+block.+Note%2C+that+this+goalpost+may+move+if+the%0A%09%2F%2F+sync+takes+long+enough+for+the+chain+head+to+move+significantly.%0A%09pivot+%3A%3D+uint64%280%29%0A%09if+height+%3A%3D+latest.Number.Uint64%28%29%3B+height+%26gt%3B+uint64%28fsMinFullBlocks%29+%7B%0A%09%09pivot+%3D+height+-+uint64%28fsMinFullBlocks%29%0A%09%7D%0A%09%2F%2F+To+cater+for+moving+pivot+points%2C+track+the+pivot+block+and+subsequently%0A%09%2F%2F+accumulated+download+results+separately.%0A%09var+%28%0A%09%09oldPivot+*fetchResult+++%2F%2F+Locked+in+pivot+block%2C+might+change+eventually%0A%09%09oldTail++%5B%5D*fetchResult+%2F%2F+Downloaded+content+after+the+pivot%0A%09%29%0A%09for+%7B%0A%09%09%2F%2F+Wait+for+the+next+batch+of+downloaded+data+to+be+available%2C+and+if+the+pivot%0A%09%09%2F%2F+block+became+stale%2C+move+the+goalpost%0A%09%09results+%3A%3D+d.queue.Results%28oldPivot+%3D%3D+nil%29+%2F%2F+Block+if+we%27re+not+monitoring+pivot+staleness%0A%09%09if+len%28results%29+%3D%3D+0+%7B%0A%09%09%09%2F%2F+If+pivot+sync+is+done%2C+stop%0A%09%09%09if+oldPivot+%3D%3D+nil+%7B%0A%09%09%09%09return+stateSync.Cancel%28%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+If+sync+failed%2C+stop%0A%09%09%09select+%7B%0A%09%09%09case+%26lt%3B-d.cancelCh%3A%0A%09%09%09%09return+stateSync.Cancel%28%29%0A%09%09%09default%3A%0A%09%09%09%7D%0A%09%09%7D%0A%09%09if+d.chainInsertHook+%21%3D+nil+%7B%0A%09%09%09d.chainInsertHook%28results%29%0A%09%09%7D%0A%09%09if+oldPivot+%21%3D+nil+%7B%0A%09%09%09results+%3D+append%28append%28%5B%5D*fetchResult%7BoldPivot%7D%2C+oldTail...%29%2C+results...%29%0A%09%09%7D%0A%09%09%2F%2F+Split+around+the+pivot+block+and+process+the+two+sides+via+fast%2Ffull+sync%0A%09%09if+atomic.LoadInt32%28%26amp%3Bd.committed%29+%3D%3D+0+%7B%0A%09%09%09latest+%3D+results%5Blen%28results%29-1%5D.Header%0A%09%09%09if+height+%3A%3D+latest.Number.Uint64%28%29%3B+height+%26gt%3B+pivot%2B2*uint64%28fsMinFullBlocks%29+%7B%0A%09%09%09%09log.Warn%28%22Pivot+became+stale%2C+moving%22%2C+%22old%22%2C+pivot%2C+%22new%22%2C+height-uint64%28fsMinFullBlocks%29%29%0A%09%09%09%09pivot+%3D+height+-+uint64%28fsMinFullBlocks%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%09P%2C+beforeP%2C+afterP+%3A%3D+splitAroundPivot%28pivot%2C+results%29%0A%09%09if+err+%3A%3D+d.commitFastSyncData%28beforeP%2C+stateSync%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%09if+P+%21%3D+nil+%7B%0A%09%09%09%2F%2F+If+new+pivot+block+found%2C+cancel+old+state+retrieval+and+restart%0A%09%09%09if+oldPivot+%21%3D+P+%7B%0A%09%09%09%09stateSync.Cancel%28%29%0A%0A%09%09%09%09stateSync+%3D+d.syncState%28P.Header.Root%29%0A%09%09%09%09defer+stateSync.Cancel%28%29%0A%09%09%09%09go+func%28%29+%7B%0A%09%09%09%09%09if+err+%3A%3D+stateSync.Wait%28%29%3B+err+%21%3D+nil+%26amp%3B%26amp%3B+err+%21%3D+errCancelStateFetch+%7B%0A%09%09%09%09%09%09d.queue.Close%28%29+%2F%2F+wake+up+WaitResults%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%28%29%0A%09%09%09%09oldPivot+%3D+P%0A%09%09%09%7D%0A%09%09%09%2F%2F+Wait+for+completion%2C+occasionally+checking+for+pivot+staleness%0A%09%09%09select+%7B%0A%09%09%09case+%26lt%3B-stateSync.done%3A%0A%09%09%09%09if+stateSync.err+%21%3D+nil+%7B%0A%09%09%09%09%09return+stateSync.err%0A%09%09%09%09%7D%0A%09%09%09%09if+err+%3A%3D+d.commitPivotBlock%28P%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09%09return+err%0A%09%09%09%09%7D%0A%09%09%09%09oldPivot+%3D+nil%0A%0A%09%09%09case+%26lt%3B-time.After%28time.Second%29%3A%0A%09%09%09%09oldTail+%3D+afterP%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+Fast+sync+done%2C+pivot+commit+done%2C+full+import%0A%09%09if+err+%3A%3D+d.importBlockResults%28afterP%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E5%85%B6%E4%B8%ADcommitFastSyncData%E5%B0%B1%E6%98%AF%E7%BB%84%E7%BB%87headers%E3%80%81receipts%E5%92%8Cbody%E5%88%B0block%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%E6%9C%AC%E5%9C%B0leveldb%E4%B8%AD%EF%BC%8C%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%EF%BC%9A%3C%2Fp%3E%0A++%3Cp%3Ed.blockchain.InsertReceiptChain%28blocks%EF%BC%8C+receipts%29%EF%BC%8C%E8%BF%9E%E5%90%8Creceipt%E4%B8%80%E8%B5%B7%E5%86%99%E5%85%A5%E6%9C%AC%E5%9C%B0%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch2%3E%E5%90%8C%E6%AD%A5%E7%BB%93%E6%9D%9F%3C%2Fh2%3E%0A++%3Cp%3E%E5%86%8D%E7%9C%8B%E4%B8%8B%E4%B8%8A%E9%9D%A2%E8%AE%B2%E7%9A%84%E5%BC%80%E5%A7%8Bsync%E7%9A%84%E5%9C%B0%E6%96%B9%EF%BC%9A%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-html%22%3Efunc+%28pm+*ProtocolManager%29+synchronise%28peer+*peer%29+%7B%0A%09%2F%2F+Run+the+sync+cycle%2C+and+disable+fast+sync+if+we%27ve+went+past+the+pivot+block%0A%09if+err+%3A%3D+pm.downloader.Synchronise%28peer.id%2C+pHead%2C+pTd%2C+mode%29%3B+err+%21%3D+nil+%7B%0A%09%09return%0A%09%7D%0A%09if+atomic.LoadUint32%28%26amp%3Bpm.fastSync%29+%3D%3D+1+%7B%0A%09%09log.Info%28%22Fast+sync+complete%2C+auto+disabling%22%29%0A%09%09atomic.StoreUint32%28%26amp%3Bpm.fastSync%2C+0%29%0A%09%7D%0A%09atomic.StoreUint32%28%26amp%3Bpm.acceptTxs%2C+1%29+%2F%2F+Mark+initial+sync+done%0A%09if+head+%3A%3D+pm.blockchain.CurrentBlock%28%29%3B+head.NumberU64%28%29+%26gt%3B+0+%7B%0A%09%09%2F%2F+We%27ve+completed+a+sync+cycle%2C+notify+all+peers+of+new+state.+This+path+is%0A%09%09%2F%2F+essential+in+star-topology+networks+where+a+gateway+node+needs+to+notify%0A%09%09%2F%2F+all+its+out-of-date+peers+of+the+availability+of+a+new+block.+This+failure%0A%09%09%2F%2F+scenario+will+most+often+crop+up+in+private+and+hackathon+networks+with%0A%09%09%2F%2F+degenerate+connectivity%2C+but+it+should+be+healthy+for+the+mainnet+too+to%0A%09%09%2F%2F+more+reliably+update+peers+or+the+local+TD+state.%0A%09%09go+pm.BroadcastBlock%28head%2C+false%29%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E1+pm.downloader.Synchronise%28%29%E7%BB%93%E6%9D%9F%E7%9A%84%E6%97%B6%E5%80%99%E4%B9%9F%E5%B0%B1sync%E5%AE%8C%E6%88%90%E4%BA%86%3C%2Fp%3E%0A++%3Cp%3E2+pm.fastSync%E7%BD%AE%E4%B8%BA0%EF%BC%8C%E9%80%80%E5%87%BAfast+sync%E6%A8%A1%E5%BC%8F%E4%BA%86%3C%2Fp%3E%0A++%3Cp%3E3+%E6%8B%BF%E5%87%BA%E6%9C%80%E6%96%B0%E7%9A%84head%EF%BC%8C%E5%B9%BF%E6%92%AD%E8%87%AA%E5%B7%B1%E7%9A%84%E6%9C%80%E6%96%B0block%EF%BC%8C%E5%BC%80%E5%A7%8B%E5%88%B0%E6%AD%A3%E5%B8%B8%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E3%80%82%E4%B8%8B%E9%9D%A2%E5%86%8D%E5%86%99%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E8%AE%B2%E8%A7%A3%E4%B8%8B%E5%90%8C%E6%AD%A5%E5%AE%8C%E6%88%90%E4%B9%8B%E5%90%8E%E7%9A%84%E5%B7%A5%E4%BD%9C%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch2%3E%E6%80%BB%E7%BB%93%3C%2Fh2%3E%0A++%3Cp%3E1+%E8%8A%82%E7%82%B9%E5%90%8C%E6%AD%A5%E7%9A%84%E6%97%B6%E5%80%99%E9%BB%98%E8%AE%A4%E6%98%AFfast%E5%90%8C%E6%AD%A5%E6%A8%A1%E5%BC%8F%3C%2Fp%3E%0A++%3Cp%3E2+%E4%BB%A3%E7%A0%81%E4%B8%AD%E7%94%A8%E5%88%B0%E4%BA%86%E5%A4%A7%E9%87%8F%E7%9A%84go%E5%92%8Cchannel%E7%9A%84%E8%AF%BB%E5%86%99%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E9%80%9A%E4%BF%A1%EF%BC%8C%E8%BF%99%E4%B9%9F%E6%98%AFgo%E8%AF%AD%E8%A8%80%E7%9A%84%E4%BC%98%E5%8A%BF%E6%89%80%E5%9C%A8%EF%BC%8C%E5%BE%88%E6%96%B9%E4%BE%BF%3C%2Fp%3E%0A++%3Cp%3E3+fast+%E5%90%8C%E6%AD%A5%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BB%8Etd%E6%9C%80%E9%AB%98%E7%9A%84%E8%8A%82%E7%82%B9%E8%8E%B7%E5%8F%96header%E3%80%81body%E3%80%81receipt%E5%92%8Cstate%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%E6%9C%AC%E5%9C%B0%E7%9A%84leveldb%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%3C%2Fp%3E%0A++%3Cp%3E4+%E5%90%8C%E6%AD%A5%E5%88%B0%E6%9C%80%E6%96%B0%E4%B9%8B%E5%90%8E%E9%80%80%E5%87%BAfast+sync%E6%A8%A1%E5%BC%8F%3C%2Fp%3E%0A++%3Cp%3EFast%E6%A8%A1%E5%BC%8F%E5%BF%AB%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AF%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%90%8C%E6%AD%A5%E4%BA%86state%E6%95%B0%E6%8D%AE%E5%92%8Creceipt%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%8F%96%E4%BB%A3%E6%AF%94%E8%BE%83%E8%80%97%E6%97%B6%E7%9A%84%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%8C%E6%89%80%E4%BB%A5%E5%90%8C%E6%AD%A5%E8%A6%81%E6%AF%94full+mode%E8%A6%81%E5%BF%AB%E3%80%82%E5%8E%9F%E5%88%99%E4%B8%8Afast+sync%E5%90%8C%E6%AD%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A6%81%E6%AF%94full+sync%E5%90%8C%E6%AD%A5%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A6%81%E5%A4%9A%EF%BC%8C%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%EF%BC%88%3Cspan+style%3D%22color%3Argb%2851%2C51%2C51%29%3Bfont-family%3A%27-apple-system%27%2C+%27SF+UI+Text%27%2C+Arial%2C+%27PingFang+SC%27%2C+%27Hiragino+Sans+GB%27%2C+%27Microsoft+YaHei%27%2C+%27WenQuanYi+Micro+Hei%27%2C+sans-serif%3Bbackground-color%3Argb%28255%2C255%2C255%29%3B%22%3Ehttps%3A%2F%2Fgithub.com%2Fethereum%2Fgo-ethereum%2Fpull%2F1889%3C%2Fspan%3E%EF%BC%89%E5%86%99%E5%88%B0%E7%9A%84%E6%9C%80%E7%BB%88fast+sync%E6%95%B0%E6%8D%AE%E6%AF%94full+sync%E7%9A%84%E6%95%B0%E6%8D%AE%E5%B0%91%EF%BC%8C%E5%BA%94%E8%AF%A5%E6%98%AF%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%E7%9A%84%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%94%9F%E6%88%90%E7%9A%84%E6%95%B0%E6%8D%AE%E8%A6%81%E6%AF%94%E6%9C%80%E7%BB%88%E4%BD%BF%E7%94%A8%E7%9A%84%E5%A4%9A%E4%B8%80%E7%82%B9%3C%2Fp%3E%0A++%3Ch2%3E%3Cbr%3E%3C%2Fh2%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcsds319%2Farticle%2Fdetails%2F80519990%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcsds319%2Farticle%2Fdetails%2F80519990%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A+%3Ca+class%3D%22btn%22+href%3D%22https%3A%2F%2Fpassport.csdn.net%2Faccount%2Flogin%3Futm_source%3Dcsdn_blog_pc_more_login%22+target%3D%22_self%22+id%3D%22btn-lobinreadmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_557%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcsds319%2Farticle%2Fdetails%2F80519990%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_557%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcsds319%2Farticle%2Fdetails%2F80519990%2C%26quot%3B%7D%22%3E%E7%99%BB%E5%BD%95%E5%90%8E%E8%87%AA%E5%8A%A8%E5%B1%95%E5%BC%80%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}