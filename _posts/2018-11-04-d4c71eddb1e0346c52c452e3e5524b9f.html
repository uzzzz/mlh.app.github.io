---
layout: default
title: 以太坊源码解读（6）blockchain区块插入和校验分析
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-ef5913e0b5.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22+id%3D%22content_views%22%3E+%0A++%3Cp%3E%E4%BB%A5%E5%A4%AA%E5%9D%8Ablockchain%E7%9A%84%E7%AE%A1%E7%90%86%E4%BA%8B%E5%8A%A1%EF%BC%9A%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81blockchain%E6%A8%A1%E5%9D%97%E5%88%9D%E5%A7%8B%E5%8C%96%3Cbr%3E+2%E3%80%81blockchain%E6%A8%A1%E5%9D%97%E6%8F%92%E5%85%A5%E6%A0%A1%E9%AA%8C%E5%88%86%E6%9E%90%3Cbr%3E+3%E3%80%81blockchain%E6%A8%A1%E5%9D%97%E5%8C%BA%E5%9D%97%E9%93%BE%E5%88%86%E5%8F%89%E5%A4%84%E7%90%86%3Cbr%3E+4%E3%80%81blockchian%E6%A8%A1%E5%9D%97%E8%A7%84%E8%8C%83%E9%93%BE%E6%9B%B4%E6%96%B0%3C%2Fp%3E+%0A++%3Cp%3E%E4%B8%8A%E4%B8%80%E8%8A%82%E5%88%86%E6%9E%90%E4%BA%86blockchain%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%EF%BC%8C%E8%BF%99%E4%B8%80%E8%8A%82%E6%9D%A5%E5%88%86%E6%9E%90blockchain%E5%8C%BA%E5%9D%97%E7%9A%84%E6%8F%92%E5%85%A5%E5%92%8C%E6%A0%A1%E9%AA%8C%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E8%A7%84%E8%8C%83%E9%93%BE%E6%9B%B4%E6%96%B0%E3%80%82%3C%2Fp%3E+%0A++%3Ch3%3E%E4%B8%80%E3%80%81InsertChain%E5%87%BD%E6%95%B0%3C%2Fh3%3E+%0A++%3Cp%3E%3Cstrong%3E%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%EF%BC%9A%3C%2Fstrong%3E%E8%B0%83%E7%94%A8insertChain%E5%B0%86%E4%B8%80%E7%BB%84%E5%8C%BA%E5%9D%97%E6%8C%A8%E4%B8%AA%E5%B0%9D%E8%AF%95%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A7%84%E8%8C%83%E9%93%BE%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E5%8A%9F%E8%83%BD%EF%BC%9A%3C%2Fstrong%3E%3Cbr%3E+1%E3%80%81%E9%AA%8C%E8%AF%81%E6%AF%8F%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84header%EF%BC%9B%3Cbr%3E+2%E3%80%81%E9%AA%8C%E8%AF%81%E6%AF%8F%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84body%EF%BC%9B%3Cbr%3E+3%E3%80%81%E5%A4%84%E7%90%86%E9%AA%8C%E8%AF%81header%E5%92%8Cbody%E6%89%80%E4%BA%A7%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9B%3Cbr%3E+4%E3%80%81%E5%A6%82%E6%9E%9C%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87%EF%BC%8C%E5%AF%B9%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E7%8A%B6%E6%80%81%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%EF%BC%8C%E5%90%A6%E5%88%99%E9%80%80%E5%87%BA%EF%BC%9B%3Cbr%3E+5%E3%80%81%E5%A6%82%E6%9E%9C%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87%EF%BC%8C%E8%B0%83%E7%94%A8WriteBlockWithState%E5%B0%86%E7%AC%ACn%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%88%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%E5%88%86%E5%8F%89%E9%97%AE%E9%A2%98%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%AF%BC%E5%85%A5%E5%8C%BA%E5%9D%97%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eadmin.importChain%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E2%E3%80%81ProtocolManager.Downloader%E4%B8%BB%E5%8A%A8%E5%90%8C%E6%AD%A5%E5%8C%BA%E5%9D%97%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3EDownloader.synchronise%0A++++%E2%80%94%26gt%3B+Downloader.syncWithPeer%0A++++++++%E2%80%94%26gt%3B+Downloader.processFullSyncCotent%0A++++++++++++%E2%80%94%26gt%3B+Downloader.importBlockResults%0A++++++++++++++++%E2%80%94%26gt%3B+BlockChain.InsertChain%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E3%E3%80%81ProtocolManager.fetcher%E8%A2%AB%E5%8A%A8%E6%8E%A5%E5%8F%97%E5%85%B6%E4%BB%96%E8%8A%82%E7%82%B9%E5%8F%91%E6%9D%A5%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3EProtocolManager.fetcher.insert%0A++++%E2%80%94%26gt%3B+ProtocolManager.Downloader.BlockChain.InsertChain%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3%3EInsertChain%28chain+types.Blocks%29%E6%BA%90%E7%A0%81%3C%2Fh3%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28bc+*BlockChain%29+InsertChain%28chain+types.Blocks%29+%28int%2C+error%29+%7B%0A%09n%2C+events%2C+logs%2C+err+%3A%3D+bc.insertChain%28chain%29%0A%09bc.PostChainEvents%28events%2C+logs%29%0A%09return+n%2C+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3EInsertChain%E5%AE%9E%E9%99%85%E4%B8%8A%E8%B0%83%E7%94%A8%E7%9A%84%E6%98%AFinsertChain%28%29%EF%BC%8C%E7%84%B6%E5%90%8E%E5%B0%86%E5%AF%BC%E5%87%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%97%A5%E5%BF%97%E3%80%82insertChain%28%29%E5%87%BD%E6%95%B0%E4%BB%A3%E7%A0%81%E8%BF%98%E6%98%AF%E6%AF%94%E8%BE%83%E5%A4%9A%E7%9A%84%EF%BC%8C%E5%AE%83%E6%98%AF%E4%B8%8A%E8%BF%B05%E4%B8%AA%E5%8A%9F%E8%83%BD%E6%98%AF%E5%AE%9E%E9%99%85%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%EF%BC%8C%E5%8D%B3%EF%BC%9A%3Cbr%3E+1%E3%80%81%E9%AA%8C%E8%AF%81%E6%AF%8F%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84header%EF%BC%9B%3Cbr%3E+2%E3%80%81%E9%AA%8C%E8%AF%81%E6%AF%8F%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84body%EF%BC%9B%3Cbr%3E+3%E3%80%81%E5%A4%84%E7%90%86%E9%AA%8C%E8%AF%81header%E5%92%8Cbody%E6%89%80%E4%BA%A7%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9B%3Cbr%3E+4%E3%80%81%E5%A6%82%E6%9E%9C%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87%EF%BC%8C%E5%AF%B9%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E7%8A%B6%E6%80%81%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%EF%BC%8C%E5%90%A6%E5%88%99%E9%80%80%E5%87%BA%EF%BC%9B%3Cbr%3E+5%E3%80%81%E5%A6%82%E6%9E%9C%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87%EF%BC%8C%E8%B0%83%E7%94%A8WriteBlockWithState%E5%B0%86%E7%AC%ACn%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E9%93%BE%EF%BC%88%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%89%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%E5%88%86%E5%8F%89%E9%97%AE%E9%A2%98%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3Epart+1%26nbsp%3B+Pre-checks%EF%BC%8C%E4%BF%9D%E8%AF%81%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E9%93%BE%E6%98%AF%E6%9C%89%E5%BA%8F%E9%93%BE%E6%8E%A5%E7%9A%84%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28bc+*BlockChain%29+insertChain%28chain+types.Blocks%29+%28int%2C+%5B%5Dinterface%7B%7D%2C+%5B%5D*types.Log%2C+error%29+%7B%0A++++%2F%2F+Sanity+check+that+we+have+something+meaningful+to+import%0A++++if+len%28chain%29+%3D%3D+0+%7B%0A%09return+0%2C+nil%2C+nil%2C+nil%0A++++%7D%0A++++%2F%2F+%E9%80%90%E4%B8%AA%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E5%8F%B7%E6%98%AF%E5%90%A6%E8%BF%9E%E7%BB%AD%E4%BB%A5%E5%8F%8Ahash%E9%93%BE%E6%98%AF%E5%90%A6%E8%BF%9E%E7%BB%AD%0A++++for+i+%3A%3D+1%3B+i+%26lt%3B+len%28chain%29%3B+i%2B%2B+%7B%0A%09if+chain%5Bi%5D.NumberU64%28%29+%21%3D+chain%5Bi-1%5D.NumberU64%28%29%2B1+%7C%7C+chain%5Bi%5D.ParentHash%28%29+%21%3D+chain%5Bi-1%5D.Hash%28%29+%7B%0A%09++++%2F%2F+Chain+broke+ancestry%2C+log+a+message+%28programming+error%29+and+skip+insertion%0A%09++++log.Error%28%22Non+contiguous+block+insert%22%2C+%22number%22%2C+chain%5Bi%5D.Number%28%29%2C+%22hash%22%2C+chain%5Bi%5D.Hash%28%29%2C%0A%09%09%22parent%22%2C+chain%5Bi%5D.ParentHash%28%29%2C+%22prevnumber%22%2C+chain%5Bi-1%5D.Number%28%29%2C+%22prevhash%22%2C+chain%5Bi-1%5D.Hash%28%29%29%0A%0A%09++++return+0%2C+nil%2C+nil%2C+fmt.Errorf%28%22non+contiguous+insert%3A+item+%25d+is+%23%25d+%5B%25x%E2%80%A6%5D%2C+item+%25d+is+%23%25d+%5B%25x%E2%80%A6%5D+%28parent+%5B%25x%E2%80%A6%5D%29%22%2C+%0A++++++++++++i-1%2C+chain%5Bi-1%5D.NumberU64%28%29%2Cchain%5Bi-1%5D.Hash%28%29.Bytes%28%29%5B%3A4%5D%2C+i%2C+chain%5Bi%5D.NumberU64%28%29%2C+chain%5Bi%5D.Hash%28%29.Bytes%28%29%5B%3A4%5D%2C+%0A++++++++++++chain%5Bi%5D.ParentHash%28%29.Bytes%28%29%5B%3A4%5D%29%0A%09%7D%0A++++%7D%0A%0A++++%2F%2F+Pre-checks+passed%2C+start+the+full+block+imports%0A++++bc.wg.Add%281%29%0A++++defer+bc.wg.Done%28%29%0A%0A++++bc.chainmu.Lock%28%29%0A++++defer+bc.chainmu.Unlock%28%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E7%AD%89%E6%89%80%E6%9C%89%E6%A3%80%E9%AA%8C%E9%80%9A%E8%BF%87%E4%BB%A5%E5%90%8E%EF%BC%8C%E4%BD%BF%E7%94%A8go%E8%AF%AD%E8%A8%80%E7%9A%84waitGroup.Add%281%29%E6%9D%A5%E5%A2%9E%E5%8A%A0%E4%B8%80%E4%B8%AA%E9%9C%80%E8%A6%81%E7%AD%89%E5%BE%85%E7%9A%84goroutine%EF%BC%8CwaitGroup.Done%28%29%E6%9D%A5%E5%87%8F1%E3%80%82%E5%9C%A8%E5%B0%9A%E6%9C%AADone%28%29%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%85%B7%E6%9C%89waitGroup.wait%28%29%E7%9A%84%E5%87%BD%E6%95%B0%E5%B0%B1%E4%BC%9A%E5%81%9C%E6%AD%A2%EF%BC%8C%E7%AD%89%E5%BE%85%E6%9F%90%E5%A4%84%E7%9A%84waitGroup.Done%28%29%E6%89%A7%E8%A1%8C%E5%AE%8C%E6%89%8D%E8%83%BD%E6%89%A7%E8%A1%8C%E3%80%82%E8%BF%99%E9%87%8CwaitGroup.wait%28%29%E6%98%AF%E5%9C%A8blockchain.Stop%28%29%E5%87%BD%E6%95%B0%E9%87%8C%EF%BC%8C%E6%84%8F%E5%91%B3%E7%9D%80%E5%A6%82%E6%9E%9C%E5%9C%A8%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E7%AA%81%E7%84%B6%E6%9C%89%E4%BA%BA%E6%89%A7%E8%A1%8CStop%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E9%82%A3%E4%B9%88%E5%BF%85%E9%A1%BB%E8%A6%81%E7%AD%89insertChain%28%29%E6%89%A7%E8%A1%8C%E5%AE%8C%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3Epart+2%26nbsp%3B+%E9%AA%8C%E8%AF%81%E7%AC%ACn%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84header%E5%92%8Cbody%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%EF%BC%9A%3Cbr%3E+%26nbsp%3B%26nbsp%3B%26nbsp%3B+a.+headers%E5%88%87%E7%89%87%3Cbr%3E+%26nbsp%3B%26nbsp%3B%26nbsp%3B+b.+seals%E5%88%87%E7%89%87%EF%BC%88%E6%A3%80%E6%9F%A5headers%E5%88%87%E7%89%87%E9%87%8C%E7%9A%84%E6%AF%8F%E4%B8%AA%E7%B4%A2%E5%BC%95%E7%9A%84header%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E6%A3%80%E6%9F%A5%EF%BC%89%3Cbr%3E+%26nbsp%3B%26nbsp%3B%26nbsp%3B+c.+abort%E9%80%9A%E9%81%93%E5%92%8Cresults%E9%80%9A%E9%81%93%EF%BC%88%E5%89%8D%E8%80%85%E7%94%A8%E6%9D%A5%E4%BC%A0%E9%80%92%E9%80%80%E5%87%BA%E5%91%BD%E4%BB%A4%EF%BC%8C%E5%90%8E%E8%80%85%E7%94%A8%E6%9D%A5%E4%BC%A0%E9%80%92%E6%A3%80%E6%9F%A5%E7%BB%93%E6%9E%9C%EF%BC%89%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E++headers+%3A%3D+make%28%5B%5D*types.Header%2C+len%28chain%29%29%0A++seals+%3A%3D+make%28%5B%5Dbool%2C+len%28chain%29%29%0A%0A++for+i%2C+block+%3A%3D+range+chain+%7B%0A%09headers%5Bi%5D+%3D+block.Header%28%29%0A%09seals%5Bi%5D+%3D+true%0A++%7D%0A++abort%2C+results+%3A%3D+bc.engine.VerifyHeaders%28bc%2C+headers%2C+seals%29%0A++defer+close%28abort%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E7%9A%84bc.engine.VerifyHeaders%28%29%E6%98%AF%E4%B8%80%E4%B8%AA%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%89%80%E4%BB%A5%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E%E5%88%B0results%E9%80%9A%E9%81%93%E9%87%8C%EF%BC%8C%E8%BF%99%E6%98%AFgo%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E2%E3%80%81%E6%A3%80%E6%9F%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%80%A7%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E++%2F%2F+Iterate+over+the+blocks+and+insert+when+the+verifier+permits%0A++for+i%2C+block+%3A%3D+range+chain+%7B%0A%09%2F%2F+%E5%A6%82%E6%9E%9Cinset%E8%A2%AB%E5%8F%96%E6%B6%88%EF%BC%8C%E5%88%99%E9%80%80%E5%87%BA%E8%BF%9B%E7%A8%8B%0A%09if+atomic.LoadInt32%28%26amp%3Bbc.procInterrupt%29+%3D%3D+1+%7B%0A++++++++%09log.Debug%28%22Premature+abort+during+blocks+processing%22%29%0A%09%09break%0A%09%7D%0A%09%2F%2F+%E5%A6%82%E6%9E%9C%E5%8C%BA%E5%9D%97%E6%98%AFbad+block%EF%BC%8C%E7%9B%B4%E6%8E%A5return%0A%09if+BadHashes%5Bblock.Hash%28%29%5D+%7B%0A%09%09bc.reportBlock%28block%2C+nil%2C+ErrBlacklistedHash%29%0A%09%09return+i%2C+events%2C+coalescedLogs%2C+ErrBlacklistedHash%0A%09%7D%0A%09%2F%2F+Wait+for+the+block%27s+verification+to+complete%0A%09bstart+%3A%3D+time.Now%28%29%0A%0A%09err+%3A%3D+%26lt%3B-results%0A++++++++%2F%2F+%E5%A6%82%E6%9E%9Cresults%E8%A1%A8%E6%98%8E%E9%AA%8C%E8%AF%81%E9%80%9A%E8%BF%87%EF%BC%8C%E5%88%99%E8%BF%9B%E8%A1%8C%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%8C%E9%AA%8C%E8%AF%81%E5%8C%BA%E5%9D%97%0A%09if+err+%3D%3D+nil+%7B%0A%09%09err+%3D+bc.Validator%28%29.ValidateBody%28block%29%0A%09%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cstrong%3Eatomic.LoadInt32%28%26amp%3Bbc.procInterrupt%29%3C%2Fstrong%3E%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8E%9F%E5%AD%90%E5%8F%98%E9%87%8F%EF%BC%8C%E5%9C%A8Stop%28%29%E5%87%BD%E6%95%B0%E4%B8%AD%E4%BC%9A%E8%A2%AB%E8%AE%BE%E7%BD%AE%E6%88%901%E3%80%82%E4%B9%9F%E5%B0%B1%E6%98%AF%E8%AF%B4%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%89%E4%BA%BA%E8%B0%83%E7%94%A8Stop%28%29%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AF%A5%E5%80%BC%E4%BC%9A%E8%A2%AB%E8%AE%BE%E7%BD%AE%E6%88%901%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%99%E9%87%8C%E5%B0%B1%E4%BC%9A+break%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%A6%82%E6%9E%9C%E9%AA%8C%E8%AF%81%E5%A4%B1%E8%B4%A5%EF%BC%8C%E8%A6%81%E6%80%8E%E4%B9%88%E5%A4%84%E7%90%86%E8%BF%99%E4%BA%9B%E9%94%99%E8%AF%AF%EF%BC%9F%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E3.+%E5%A4%84%E7%90%86%E9%AA%8C%E8%AF%81header%E5%92%8Cbody%E6%89%80%E4%BA%A7%E7%94%9F%E7%9A%84%E9%94%99%E8%AF%AF%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%26nbsp%3B%26nbsp%3B%26nbsp%3B+a.+%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E5%B7%B2%E7%BB%8F%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%AD%98%E5%9C%A8%E7%9A%84%3Cbr%3E+%26nbsp%3B%26nbsp%3B%26nbsp%3B+b.+%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E6%98%AF%E6%9C%AA%E6%9D%A5%E5%8C%BA%E5%9D%97%3Cbr%3E+%26nbsp%3B%26nbsp%3B%26nbsp%3B+c.+%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E6%89%BE%E4%B8%8D%E5%88%B0%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E4%BD%86%E6%9C%AA%E6%9D%A5%E5%8C%BA%E5%9D%97%E5%88%97%E8%A1%A8%E4%B8%AD%E8%83%BD%E6%89%BE%E5%88%B0%E5%AE%83%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%3Cbr%3E+%26nbsp%3B%26nbsp%3B%26nbsp%3B+d.+%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%B8%80%E4%B8%AA%E7%B2%BE%E7%AE%80%E5%88%86%E6%94%AF%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Eswitch+%7B%0A%09case+err+%3D%3D+ErrKnownBlock%3A%0A%09++++%2F%2F+%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E5%B7%B2%E7%BB%8F%E5%AD%98%E5%9C%A8%E4%BA%8E%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%B9%B6%E4%B8%94%E8%A7%84%E8%8C%83%E9%93%BE%E5%A4%B4%E5%8C%BA%E5%9D%97%E5%8C%BA%E5%9D%97%E5%8F%B7%E5%A4%A7%E4%BA%8E%E8%AF%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E5%8C%BA%E5%9D%97%E5%8F%B7%EF%BC%8C%E7%9B%B4%E6%8E%A5%E5%BF%BD%E7%95%A5%0A%09++++if+bc.CurrentBlock%28%29.NumberU64%28%29+%26gt%3B%3D+block.NumberU64%28%29+%7B%0A%09%09stats.ignored%2B%2B%0A%09%09continue%0A++++++++++++%7D%0A%0A%09case+err+%3D%3D+consensus.ErrFutureBlock%3A%0A%09++++%2F%2F+%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E9%97%B4%E6%88%B3%E5%A4%A7%E4%BA%8E%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B415%E7%A7%92%EF%BC%8C%E5%88%99%E8%AE%A4%E4%B8%BA%E6%98%AF%E6%9C%AA%E6%9D%A5%E5%8C%BA%E5%9D%97%0A%09++++%2F%2F+%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%97%B6%E9%97%B4%E6%88%B3%E5%A4%A7%E4%BA%8E%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B430%E7%A7%92%EF%BC%8C%E5%88%99%E7%9B%B4%E6%8E%A5%E4%B8%A2%E5%BC%83%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%0A%09++++max+%3A%3D+big.NewInt%28time.Now%28%29.Unix%28%29+%2B+maxTimeFutureBlocks%29%0A%09++++if+block.Time%28%29.Cmp%28max%29+%26gt%3B+0+%7B%0A%09%09return+i%2C+events%2C+coalescedLogs%2C+fmt.Errorf%28%22future+block%3A+%25v+%26gt%3B+%25v%22%2C+block.Time%28%29%2C+max%29%0A%09++++%7D%0A%09++++bc.futureBlocks.Add%28block.Hash%28%29%2C+block%29%0A%09++++stats.queued%2B%2B%0A%09++++continue%0A%0A%09case+err+%3D%3D+consensus.ErrUnknownAncestor+%26amp%3B%26amp%3B+bc.futureBlocks.Contains%28block.ParentHash%28%29%29%3A%0A++++++++%2F%2F+%E6%95%B0%E6%8D%AE%E5%BA%93%E9%87%8C%E6%89%BE%E4%B8%8D%E5%88%B0%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%BD%86%E6%9C%AA%E6%9D%A5%E5%BE%85%E5%A4%84%E7%90%86%E7%BC%93%E5%86%B2%E9%87%8C%E6%9C%89%E7%88%B6%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%B0%B1%E5%B0%86%E5%AE%83%E6%94%BE%E5%85%A5%E6%9C%AA%E6%9D%A5%E5%BE%85%E5%A4%84%E7%90%86%E7%BC%93%E5%86%B2%E9%87%8C%0A%09++++bc.futureBlocks.Add%28block.Hash%28%29%2C+block%29%0A%09++++stats.queued%2B%2B%0A%09++++continue%0A%0A%09case+err+%3D%3D+consensus.ErrPrunedAncestor%3A%0A%09++++%2F%2F+%E7%88%B6%E5%8C%BA%E5%9D%97%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%B8%80%E6%9D%A1%E7%B2%BE%E7%AE%80%E5%88%86%E6%94%AF%E5%8C%BA%E5%9D%97%EF%BC%88%E7%B2%BE%E7%AE%80%E5%88%86%E6%94%AF%E5%8C%BA%E5%9D%97%E5%B0%B1%E6%98%AF%E4%B8%80%E4%BA%9B%E6%B2%A1%E6%9C%89state+root%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%89%0A%09++++%2F%2F+%E5%A6%82%E6%9E%9C%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%B0%8F%E4%BA%8E%E7%AD%89%E4%BA%8E%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%80%BC%EF%BC%8C%E5%8F%AA%E5%B0%86%E5%AE%83%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E4%B8%8D%E4%B8%8A%E8%A7%84%E8%8C%83%E9%93%BE%0A%09++++currentBlock+%3A%3D+bc.CurrentBlock%28%29%0A%09++++localTd+%3A%3D+bc.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%0A%09++++externTd+%3A%3D+new%28big.Int%29.Add%28bc.GetTd%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%2C+block.Difficulty%28%29%29%0A%09++++if+localTd.Cmp%28externTd%29+%26gt%3B+0+%7B%0A%09%09if+err+%3D+bc.WriteBlockWithoutState%28block%2C+externTd%29%3B+err+%21%3D+nil+%7B%0A%09%09++++return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%7D%0A%09%09continue%0A%09++++%7D%0A%09++++%2F%2F+%E5%A6%82%E6%9E%9C%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%80%BC%E5%A4%A7%E4%BA%8E%E6%88%96%E7%AD%89%E4%BA%8E%E8%A7%84%E8%8C%83%E9%93%BE%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%80%BC%EF%BC%8C%E5%B0%86%E8%BF%99%E4%B8%AA%E7%B2%BE%E7%AE%80%E9%93%BE%E6%8F%92%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%0A%09++++var+winner+%5B%5D*types.Block%0A%0A%09++++parent+%3A%3D+bc.GetBlock%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%0A%09++++for+%21bc.HasState%28parent.Root%28%29%29+%7B%0A%09%09winner+%3D+append%28winner%2C+parent%29%0A%09%09parent+%3D+bc.GetBlock%28parent.ParentHash%28%29%2C+parent.NumberU64%28%29-1%29%0A%09++++%7D%0A%09++++for+j+%3A%3D+0%3B+j+%26lt%3B+len%28winner%29%2F2%3B+j%2B%2B+%7B%0A%09%09winner%5Bj%5D%2C+winner%5Blen%28winner%29-1-j%5D+%3D+winner%5Blen%28winner%29-1-j%5D%2C+winner%5Bj%5D%0A%09++++%7D%0A%09++++%2F%2F+%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8insertChain%28%29%2C%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%EF%BC%8C%E8%80%8C%E6%98%AF%E6%8C%89%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%E5%AE%8C%E5%96%84%E7%B2%BE%E7%AE%80%E5%8C%BA%E5%9D%97%E7%9A%84state%0A%09++++bc.chainmu.Unlock%28%29%0A%09++++_%2C+evs%2C+logs%2C+err+%3A%3D+bc.insertChain%28winner%29%0A%09++++bc.chainmu.Lock%28%29%0A%09++++events%2C+coalescedLogs+%3D+evs%2C+logs%0A%0A%09++++if+err+%21%3D+nil+%7B%0A%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09++++%7D%0A%0A%09+case+err+%21%3D+nil%3A%0A++++++++++++%2F%2F+%E4%B8%8D%E5%B1%9E%E4%BA%8E%E4%B8%8A%E9%9D%A2%E5%9B%9B%E7%A7%8D%E9%94%99%E8%AF%AF%EF%BC%8C%E6%97%A0%E6%B3%95%E5%A4%84%E7%90%86%EF%BC%8C%E9%82%A3%E5%B0%B1%E7%9B%B4%E6%8E%A5return%0A%09++++bc.reportBlock%28block%2C+nil%2C+err%29%0A++%09++++return+i%2C+events%2C+coalescedLogs%2C+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cstrong%3E4.+%E5%A6%82%E6%9E%9C%E4%B8%8A%E9%9D%A2%E9%AA%8C%E8%AF%81%E5%9D%87%E9%80%9A%E8%BF%87%EF%BC%8C%E5%88%99%E5%AF%B9%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BA%A4%E6%98%93%E7%8A%B6%E6%80%81%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%EF%BC%8C%E5%90%A6%E5%88%99%E9%80%80%E5%87%BA%3C%2Fstrong%3E%3Cbr%3E+a.+%E4%BB%8E%E7%88%B6%E5%8C%BA%E5%9D%97%E8%AF%BB%E5%8F%96%E7%8A%B6%E6%80%81%3Cbr%3E+b.+%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%EF%BC%8C%E6%9B%B4%E6%96%B0%E7%8A%B6%E6%80%81%EF%BC%9Abc.processor.Process%28block%2C+state%2C+bc.vmConfig%29%3Cbr%3E+c.+%E5%AF%B9%E7%8A%B6%E6%80%81%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%EF%BC%8C%E7%9C%8B%E4%B8%8Eheader%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%A6%E5%8C%B9%E9%85%8D%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Create+a+new+statedb+using+the+parent+block+and+report+an%0A%2F%2F+error+if+it+fails.%0Avar+parent+*types.Block%0Aif+i+%3D%3D+0+%7B%0A++++parent+%3D+bc.GetBlock%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%0A%7D+else+%7B%0A++++parent+%3D+chain%5Bi-1%5D%0A%7D%0A%2F%2F+%E5%B0%86%E8%BF%99%E4%B8%AAblock%E7%9A%84%E7%88%B6%E4%BA%B2%E7%9A%84%E7%8A%B6%E6%80%81%E6%A0%91%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E8%AF%BB%E5%8F%96%E5%87%BA%E6%9D%A5%EF%BC%8C%E5%B9%B6%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%88%90StateDB%0Astate%2C+err+%3A%3D+state.New%28parent.Root%28%29%2C+bc.stateCache%29%0Aif+err+%21%3D+nil+%7B%0A++++return+i%2C+events%2C+coalescedLogs%2C+err%0A%7D%0A%2F%2F+Process+block+using+the+parent+state+as+reference+point.%0A%2F%2F+%E4%BD%BF%E7%94%A8%E5%BD%93%E5%89%8Dblcok%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%88new+state%EF%BC%89%EF%BC%8C%E8%8E%B7%E5%8F%96%E6%89%A7%E8%A1%8C%E7%BB%93%E6%9E%9C%EF%BC%88%E6%94%B6%E6%8D%AE%E5%88%97%E8%A1%A8%E5%92%8C%E6%97%A5%E5%BF%97%E5%88%97%E8%A1%A8%EF%BC%89%0A%2F%2F+%E5%A6%82%E6%9E%9C%E6%89%A7%E8%A1%8C%E6%88%90%E5%8A%9F%EF%BC%8Cstate%E4%BC%9A%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%0Areceipts%2C+logs%2C+usedGas%2C+err+%3A%3D+bc.processor.Process%28block%2C+state%2C+bc.vmConfig%29%0Aif+err+%21%3D+nil+%7B%0A++++bc.reportBlock%28block%2C+receipts%2C+err%29%0A++++return+i%2C+events%2C+coalescedLogs%2C+err%0A%7D%0A%2F%2F+Validate+the+state+using+the+default+validator%0A%2F%2F+%E9%AA%8C%E8%AF%81%E7%8A%B6%E6%80%81%EF%BC%9A%E7%94%A8%E4%B8%8A%E9%9D%A2%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%E5%90%8E%E5%BE%97%E5%88%B0%E7%9A%84%E5%85%A8%E6%96%B0%E7%8A%B6%E6%80%81%E5%AF%B9%E6%AF%94block%E4%B8%AD%E7%9A%84%E7%8A%B6%E6%80%81%E5%8F%82%E6%95%B0%0Aerr+%3D+bc.Validator%28%29.ValidateState%28block%2C+parent%2C+state%2C+receipts%2C+usedGas%29%0Aif+err+%21%3D+nil+%7B%0A++++bc.reportBlock%28block%2C+receipts%2C+err%29%0A++++return+i%2C+events%2C+coalescedLogs%2C+err%0A%7D%0Aproctime+%3A%3D+time.Since%28bstart%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cstrong%3E5%E3%80%81%E5%A6%82%E6%9E%9C%E9%AA%8C%E8%AF%81%E6%88%90%E5%8A%9F%EF%BC%8C%E8%B0%83%E7%94%A8WriteBlockWithState%E5%B0%86%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E7%84%B6%E5%90%8E%E5%86%99%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%E5%88%86%E5%8F%89%E9%97%AE%E9%A2%98%3C%2Fstrong%3E%3Cbr%3E+a.+%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%88%A4%E6%96%AD%E6%98%AF%E8%A7%84%E8%8C%83%E9%93%BE%E8%BF%98%E6%98%AF%E5%88%86%E5%8F%89%EF%BC%9Abc.WriteBlockWithState%28%29+%E2%80%94%26gt%3B+status%3Cbr%3E+b.+%E5%A6%82%E6%9E%9C%E6%98%AF%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E8%BE%93%E5%87%BA%E8%A7%84%E8%8C%83%E9%93%BE%E6%97%A5%E5%BF%97%EF%BC%8C%E6%B7%BB%E5%8A%A0ChainEvent%E4%BA%8B%E4%BB%B6%3Cbr%3E+c.+%E5%A6%82%E6%9E%9C%E6%98%AF%E5%88%86%E5%8F%89%EF%BC%8C%E5%88%99%E8%BE%93%E5%87%BA%E5%88%86%E5%8F%89%E6%97%A5%E5%BF%97%EF%BC%8C%E6%B7%BB%E5%8A%A0ChainSideEvent%E4%BA%8B%E4%BB%B6%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E%2F%2F+Write+the+block+to+the+chain+and+get+the+status.%0A%2F%2F+%E5%B0%86%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E8%8E%B7%E5%BE%97status%0Astatus%2C+err+%3A%3D+bc.WriteBlockWithState%28block%2C+receipts%2C+state%29%0Aif+err+%21%3D+nil+%7B%0A++++return+i%2C+events%2C+coalescedLogs%2C+err%0A%7D%0A%0Aswitch+status+%7B%0A++++case+CanonStatTy%3A+%2F%2F+%E5%A6%82%E6%9E%9C%E6%8F%92%E5%85%A5%E7%9A%84%E6%98%AF%E8%A7%84%E8%8C%83%E9%93%BE%0A++++log.Debug%28%22Inserted+new+block%22%2C+%22number%22%2C+block.Number%28%29%2C+%22hash%22%2C+block.Hash%28%29%2C+%22uncles%22%2C+len%28block.Uncles%28%29%29%2C%0A++++%22txs%22%2C+len%28block.Transactions%28%29%29%2C+%22gas%22%2C+block.GasUsed%28%29%2C+%22elapsed%22%2C+common.PrettyDuration%28time.Since%28bstart%29%29%29%0A%0A++++coalescedLogs+%3D+append%28coalescedLogs%2C+logs...%29%0A++++blockInsertTimer.UpdateSince%28bstart%29%0A++++events+%3D+append%28events%2C+ChainEvent%7Bblock%2C+block.Hash%28%29%2C+logs%7D%29%0A++++lastCanon+%3D+block%0A%0A++++%2F%2F+Only+count+canonical+blocks+for+GC+processing+time%0A++++bc.gcproc+%2B%3D+proctime%0A%0A++++case+SideStatTy%3A+%2F%2F+%E5%A6%82%E6%9E%9C%E6%8F%92%E5%85%A5%E7%9A%84%E6%98%AF%E5%88%86%E5%8F%89%0A++++log.Debug%28%22Inserted+forked+block%22%2C+%22number%22%2C+block.Number%28%29%2C+%22hash%22%2C+block.Hash%28%29%2C+%22diff%22%2C+block.Difficulty%28%29%2C+%22elapsed%22%2C%0A++++common.PrettyDuration%28time.Since%28bstart%29%29%2C+%22txs%22%2C+len%28block.Transactions%28%29%29%2C+%22gas%22%2C+block.GasUsed%28%29%2C+%22uncles%22%2C+len%28block.Uncles%28%29%29%29%0A%0A++++blockInsertTimer.UpdateSince%28bstart%29%0A++++events+%3D+append%28events%2C+ChainSideEvent%7Bblock%7D%29%0A%7D%0Astats.processed%2B%2B%0Astats.usedGas+%2B%3D+usedGas%0A%0Acache%2C+_+%3A%3D+bc.stateCache.TrieDB%28%29.Size%28%29%0Astats.report%28chain%2C+i%2C+cache%29%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%3Cstrong%3Epart+3+%E8%B7%B3%E5%87%BA%E5%BE%AA%E7%8E%AF%EF%BC%8C%E6%A3%80%E9%AA%8C%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E6%98%AF%E5%90%A6%E6%98%AF%E5%A4%B4%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%B9%B6%E6%8A%A5%E5%91%8A%E4%BA%8B%E4%BB%B6%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3E++%2F%2F+Append+a+single+chain+head+event+if+we%27ve+progressed+the+chain%0A++if+lastCanon+%21%3D+nil+%26amp%3B%26amp%3B+bc.CurrentBlock%28%29.Hash%28%29+%3D%3D+lastCanon.Hash%28%29+%7B%0A%09events+%3D+append%28events%2C+ChainHeadEvent%7BlastCanon%7D%29%0A++%7D%0A++return+0%2C+events%2C+coalescedLogs%2C+nil%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E5%87%BD%E6%95%B0%E6%9C%80%E5%90%8E%E8%BF%94%E5%9B%9E%E4%BA%86%E6%89%80%E6%9C%89%E7%9A%84%E4%BA%8B%E4%BB%B6%EF%BC%88%E4%B8%8A%E9%93%BE%E4%BA%8B%E4%BB%B6%E3%80%81%E5%88%86%E5%8F%89%E4%BA%8B%E4%BB%B6%E3%80%81%E5%A4%B4%E5%8C%BA%E5%9D%97%E4%BA%8B%E4%BB%B6%EF%BC%89%E4%BB%A5%E5%8F%8A%E6%89%80%E6%9C%89%E7%9A%84%E6%97%A5%E5%BF%97%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E6%80%9D%E8%80%83%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98%EF%BC%8C%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8F%92%E5%85%A5%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%9C%80%E8%A6%81%E8%BF%94%E5%9B%9E%E8%BF%99%E4%BA%9B%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%97%A5%E5%BF%97%EF%BC%9F%E7%94%A8%E4%BA%8E%E9%80%9A%E7%9F%A5%E7%BB%99%E8%AE%A2%E9%98%85%E4%BA%86%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%EF%BC%81%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E5%9C%A8blockchain%E7%B1%BB%E4%B8%AD%E6%9B%BE%E7%BB%8F%E7%9C%8B%E5%88%B0%E8%BF%87%E8%BF%99%E6%A0%B7%E7%9A%84%E5%AE%9A%E4%B9%89%EF%BC%9A%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3ErmLogsFeed++++event.Feed%0AchainFeed+++++event.Feed%0AchainSideFeed+event.Feed%0AchainHeadFeed+event.Feed%0AlogsFeed++++++event.Feed%0Ascope+++++++++event.SubscriptionScope%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87%3Cstrong%3Eevent.Feed%3C%2Fstrong%3E%E8%BF%99%E4%B8%AA%E6%A8%A1%E5%9D%97%E6%9D%A5%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6%E3%80%82%E4%BB%A5%E6%8F%92%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%E4%BA%8B%E4%BB%B6%E4%B8%BA%E4%BE%8B%EF%BC%8C%E5%AE%9E%E9%99%85%E4%B8%8A%EF%BC%8C%E5%9C%A8%E6%88%91%E4%BB%AC%E9%80%9A%E8%BF%87rpc%E5%AF%B9%E8%B1%A1%E8%B0%83%E7%94%A8%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E7%9A%84%E5%87%BD%E6%95%B0%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E9%9C%80%E8%A6%81%E5%8F%91%E5%B8%83%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%EF%BC%8C%E7%84%B6%E5%90%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%84%E4%BA%8Epending%E7%8A%B6%E6%80%81%E7%AD%89%E5%BE%85%E4%B8%8A%E9%93%BE%E3%80%82%E5%BD%93%E5%8C%85%E6%B6%B5%E8%BF%99%E4%B8%AA%E4%BA%A4%E6%98%93%E7%9A%84%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8Crpc%E5%AF%B9%E8%B1%A1%E7%BB%91%E5%AE%9A%E7%9A%84feed%E6%A8%A1%E5%9D%97%E5%B0%B1%E4%BC%9A%E4%BA%A7%E7%9C%8B%E8%BF%99%E4%B8%AA%E4%B8%8A%E9%93%BE%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%8C%BA%E5%9D%97%E4%B8%AD%E6%98%AF%E5%90%A6%E5%8C%85%E5%90%AB%E5%88%9A%E6%89%8D%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%89%E5%88%99%E5%88%B0%E7%9B%B8%E5%BA%94%E7%9A%84receipt%E4%B8%AD%E6%8B%BF%E5%88%B0%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC%EF%BC%8C%E5%86%8D%E5%8C%85%E8%A3%85%E6%88%90rpc%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%94%E5%9B%9E%E5%AE%A2%E6%88%B7%E7%AB%AF%E3%80%82%EF%BC%88Feed%E6%A8%A1%E5%9D%97%E6%88%91%E4%BB%AC%E4%BB%A5%E5%90%8E%E5%86%8D%E7%9C%8B%EF%BC%89%3C%2Fp%3E+%0A++%3Ch3%3E%3Cstrong%3E%E4%BA%8C%E3%80%81WriteBlockWithState%28%29%E5%87%BD%E6%95%B0%E8%AF%A6%E8%A7%A3%3C%2Fstrong%3E%3C%2Fh3%3E+%0A++%3Cp%3E%E4%B8%8A%E9%9D%A2%E7%AC%AC5%E6%AD%A5%E7%9A%84%E8%B0%83%E7%94%A8%EF%BC%8C%E5%8D%B3%E7%94%B1BlockChain.insertChain%28%29%E8%B0%83%E7%94%A8%EF%BC%8C%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%EF%BC%9A%E5%B0%86%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A7%84%E8%8C%83%E9%93%BE%3C%2Fp%3E+%0A++%3Cp%3E1%E3%80%81%E5%B0%86%E5%8C%BA%E5%9D%97%E6%80%BB%E9%9A%BE%E5%BA%A6%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%3Cbr%3E+2%E3%80%81%E5%B0%86%E5%8C%BA%E5%9D%97header%E5%92%8Cbody%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%3Cbr%3E+3%E3%80%81%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%A0%91%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%3Cbr%3E+4%E3%80%81%E5%B0%86%E5%8C%BA%E5%9D%97%E7%9A%84%E6%94%B6%E6%8D%AE%E5%88%97%E8%A1%A8%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%3Cbr%3E+5%E3%80%81%E5%B0%86%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%88%3Cem%3EBlockChain.insert%3C%2Fem%3E%EF%BC%89%EF%BC%8C%E5%90%8C%E6%97%B6%E5%A4%84%E7%90%86%E5%88%86%E5%8F%89%EF%BC%88%3Cem%3EBlockChain.reorg%3C%2Fem%3E%EF%BC%89%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28bc+*BlockChain%29+WriteBlockWithState%28block+*types.Block%2C+receipts+%5B%5D*types.Receipt%2C+state+*state.StateDB%29+%28status+WriteStatus%2C+err+error%29+%7B%0A%09bc.wg.Add%281%29%0A%09defer+bc.wg.Done%28%29%0A%0A%09%2F%2F+%E8%8E%B7%E5%8F%96%E7%88%B6%E5%8C%BA%E5%9D%97%E6%80%BB%E9%9A%BE%E5%BA%A6%0A%09ptd+%3A%3D+bc.GetTd%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%0A%09if+ptd+%3D%3D+nil+%7B%0A%09%09return+NonStatTy%2C+consensus.ErrUnknownAncestor%0A%09%7D%0A%09%2F%2F+Make+sure+no+inconsistent+state+is+leaked+during+insertion%0A%09bc.mu.Lock%28%29%0A%09defer+bc.mu.Unlock%28%29%0A++++++++%0A++++++++%2F%2F+%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%9C%AC%E5%9C%B0%E8%A7%84%E8%8C%83%E9%93%BE%E5%A4%B4%E5%8C%BA%E5%9D%97%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%0A%09currentBlock+%3A%3D+bc.CurrentBlock%28%29%0A%09localTd+%3A%3D+bc.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%0A++++++++%2F%2F+%E8%AE%A1%E7%AE%97%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%0A%09externTd+%3A%3D+new%28big.Int%29.Add%28block.Difficulty%28%29%2C+ptd%29%0A%0A%09%2F%2F+step+1+%E5%B0%86%E6%8F%92%E5%85%A5%E5%90%8E%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%27h%27%2B+num+%2B+hash+%2B+%27t%27%E4%BD%9C%E4%B8%BAkey%0A%09if+err+%3A%3D+bc.hc.WriteTd%28block.Hash%28%29%2C+block.NumberU64%28%29%2C+externTd%29%3B+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A++++++++%2F%2F+step+2+%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84Write%E6%8E%A5%E5%8F%A3%E5%B0%86block%EF%BC%88header%EF%BC%8Cbody%EF%BC%89%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A++++++++%2F%2F+header%E7%9A%84key%E4%B8%BA%EF%BC%9A%27h%27+%2B+num+%2B+hash%0A++++++++%2F%2F+body%E7%9A%84key%E4%B8%BA%EF%BC%9A%27b%27+%2B+num+%2Bhahs%0A%09rawdb.WriteBlock%28bc.db%2C+block%29%0A%0A++++++++%2F%2F+step+3+%E5%B0%86%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%A0%91%E5%86%85%E5%AE%B9%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A%09root%2C+err+%3A%3D+state.Commit%28bc.chainConfig.IsEIP158%28block.Number%28%29%29%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%09triedb+%3A%3D+bc.stateCache.TrieDB%28%29%0A%0A%09%2F%2F+If+we%27re+running+an+archive+node%2C+always+flush%0A%09if+bc.cacheConfig.Disabled+%7B%0A%09%09if+err+%3A%3D+triedb.Commit%28root%2C+false%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+NonStatTy%2C+err%0A%09%09%7D%0A%09%7D+else+%7B%0A%09%09%2F%2F+Full+but+not+archive+node%2C+do+proper+garbage+collection%0A%09%09triedb.Reference%28root%2C+common.Hash%7B%7D%29+%2F%2F+metadata+reference+to+keep+trie+alive%0A%09%09bc.triegc.Push%28root%2C+-float32%28block.NumberU64%28%29%29%29%0A%0A%09%09if+current+%3A%3D+block.NumberU64%28%29%3B+current+%26gt%3B+triesInMemory+%7B%0A%09%09%09%2F%2F+If+we+exceeded+our+memory+allowance%2C+flush+matured+singleton+nodes+to+disk%0A%09%09%09var+%28%0A%09%09%09%09nodes%2C+imgs+%3D+triedb.Size%28%29%0A%09%09%09%09limit+++++++%3D+common.StorageSize%28bc.cacheConfig.TrieNodeLimit%29+*+1024+*+1024%0A%09%09%09%29%0A%09%09%09if+nodes+%26gt%3B+limit+%7C%7C+imgs+%26gt%3B+4*1024*1024+%7B%0A%09%09%09%09triedb.Cap%28limit+-+ethdb.IdealBatchSize%29%0A%09%09%09%7D%0A%09%09%09%2F%2F+Find+the+next+state+trie+we+need+to+commit%0A%09%09%09header+%3A%3D+bc.GetHeaderByNumber%28current+-+triesInMemory%29%0A%09%09%09chosen+%3A%3D+header.Number.Uint64%28%29%0A%0A%09%09%09%2F%2F+If+we+exceeded+out+time+allowance%2C+flush+an+entire+trie+to+disk%0A%09%09%09if+bc.gcproc+%26gt%3B+bc.cacheConfig.TrieTimeLimit+%7B%0A%09%09%09%09%2F%2F+If+we%27re+exceeding+limits+but+haven%27t+reached+a+large+enough+memory+gap%2C%0A%09%09%09%09%2F%2F+warn+the+user+that+the+system+is+becoming+unstable.%0A%09%09%09%09if+chosen+%26lt%3B+lastWrite%2BtriesInMemory+%26amp%3B%26amp%3B+bc.gcproc+%26gt%3B%3D+2*bc.cacheConfig.TrieTimeLimit+%7B%0A%09%09%09%09%09log.Info%28%22State+in+memory+for+too+long%2C+committing%22%2C+%22time%22%2C+bc.gcproc%2C+%22allowance%22%2C+bc.cacheConfig.TrieTimeLimit%2C+%22optimum%22%2C+float64%28chosen-lastWrite%29%2FtriesInMemory%29%0A%09%09%09%09%7D%0A%09%09%09%09%2F%2F+Flush+an+entire+trie+and+restart+the+counters%0A%09%09%09%09triedb.Commit%28header.Root%2C+true%29%0A%09%09%09%09lastWrite+%3D+chosen%0A%09%09%09%09bc.gcproc+%3D+0%0A%09%09%09%7D%0A%09%09%09%2F%2F+Garbage+collect+anything+below+our+required+write+retention%0A%09%09%09for+%21bc.triegc.Empty%28%29+%7B%0A%09%09%09%09root%2C+number+%3A%3D+bc.triegc.Pop%28%29%0A%09%09%09%09if+uint64%28-number%29+%26gt%3B+chosen+%7B%0A%09%09%09%09%09bc.triegc.Push%28root%2C+number%29%0A%09%09%09%09%09break%0A%09%09%09%09%7D%0A%09%09%09%09triedb.Dereference%28root.%28common.Hash%29%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%0A%09%2F%2F+step+4+%E5%B0%86%E6%94%B6%E6%8D%AE%E5%86%85%E5%AE%B9%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A++++++++%2F%2F+%E4%BD%BF%E7%94%A8%27r%27+%2B+num+%2B+hash%E4%BD%9C%E4%B8%BAkey%EF%BC%8Creceipt%E5%88%97%E8%A1%A8%E7%9A%84RLP%E7%BC%96%E7%A0%81%E5%80%BC%E4%BD%9C%E4%B8%BAvalue%0A%09batch+%3A%3D+bc.db.NewBatch%28%29%0A%09rawdb.WriteReceipts%28batch%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+receipts%29%0A%0A++++++++%2F%2F+%E5%B0%86%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%0A%09%2F%2F+%E5%A6%82%E6%9E%9C%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E7%AD%89%E4%BA%8E%E6%9C%AC%E5%9C%B0%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8C%BA%E5%9D%97%E5%8F%B7%E5%B0%8F%E4%BA%8E%E6%88%96%E7%AD%89%E4%BA%8E%E5%BD%93%E5%89%8D%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E5%A4%B4%E5%8C%BA%E5%9D%97%E5%8F%B7%EF%BC%8C%E5%9D%87%E8%AE%A4%E4%B8%BA%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E6%89%80%E5%9C%A8%E5%88%86%E5%8F%89%E6%9B%B4%E6%9C%89%E6%95%88%EF%BC%8C%E9%9C%80%E8%A6%81%E5%A4%84%E7%90%86%E5%88%86%E5%8F%89%E5%B9%B6%E6%9B%B4%E6%96%B0%E8%A7%84%E8%8C%83%E9%93%BE%0A%09reorg+%3A%3D+externTd.Cmp%28localTd%29+%26gt%3B+0%0A%09currentBlock+%3D+bc.CurrentBlock%28%29%0A%09if+%21reorg+%26amp%3B%26amp%3B+externTd.Cmp%28localTd%29+%3D%3D+0+%7B%0A%09%09%2F%2F+Split+same-difficulty+blocks+by+number%2C+then+at+random%0A%09%09reorg+%3D+block.NumberU64%28%29+%26lt%3B+currentBlock.NumberU64%28%29+%7C%7C+%28block.NumberU64%28%29+%3D%3D+currentBlock.NumberU64%28%29+%26amp%3B%26amp%3B+mrand.Float64%28%29+%26lt%3B+0.5%29%0A%09%7D%0A+++++++++%0A++++++++%2F%2F+%E5%A6%82%E6%9E%9C%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%A4%A7%E4%BA%8E%E6%9C%AC%E5%9C%B0%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%EF%BC%8C%E9%82%A3Block%E5%BF%85%E5%AE%9A%E8%A6%81%E6%8F%92%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%0A++++++++%2F%2F+%E5%A6%82%E6%9E%9C%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%B0%8F%E9%9B%A8%E6%9C%AC%E5%9C%B0%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%EF%BC%8C%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E5%9C%A8%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%88%86%E5%8F%89%E4%B8%8A%EF%BC%8C%E4%B8%8D%E7%94%A8%E6%8F%92%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%0A%09if+reorg+%7B%0A%09%09%2F%2F+Reorganise+the+chain+if+the+parent+is+not+the+head+block%0A%09%09if+block.ParentHash%28%29+%21%3D+currentBlock.Hash%28%29+%7B%0A%09%09%09if+err+%3A%3D+bc.reorg%28currentBlock%2C+block%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09return+NonStatTy%2C+err%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+%E5%86%99%E5%85%A5%E4%BA%A4%E6%98%93%E6%9F%A5%E8%AF%A2%E5%85%A5%E5%8F%A3%E4%BF%A1%E6%81%AF%0A%09%09rawdb.WriteTxLookupEntries%28batch%2C+block%29%0A%09%09rawdb.WritePreimages%28batch%2C+block.NumberU64%28%29%2C+state.Preimages%28%29%29%0A%0A%09%09status+%3D+CanonStatTy%0A%09%7D+else+%7B%0A%09%09status+%3D+SideStatTy%0A%09%7D%0A++++++++%0A++++++++%2F%2F+%E5%B0%86batch%E6%95%B0%E6%8D%AE%E7%BC%93%E5%86%B2%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E8%B0%83%E7%94%A8batch%E7%9A%84Write%28%29%E6%96%B9%E6%B3%95%0A%09if+err+%3A%3D+batch.Write%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%0A%09%2F%2F+Set+new+head.%0A%09if+status+%3D%3D+CanonStatTy+%7B%0A++++++++++++++++%2F%2F+%E5%A6%82%E6%9E%9C%E8%BF%99%E4%B8%AA%E5%8C%BA%E5%9D%97%E5%8F%AF%E4%BB%A5%E6%8F%92%E5%85%A5%E6%9C%AC%E5%9C%B0%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E5%B0%B1%E5%B0%86%E5%AE%83%E6%8F%92%E5%85%A5%0A++++++++++++++++%2F%2F+step+1+%E6%9B%B4%E6%96%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%8A%E5%8C%BA%E5%9D%97%E5%8F%B7%E5%AF%B9%E5%BA%94%E7%9A%84hash%E5%80%BC%0A++++++++++++++++%2F%2F+step+2+%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E2%80%9CLastBlock%E2%80%9D%E7%9A%84%E5%80%BC%0A++++++++++++++++%2F%2F+step+3+%E6%9B%B4%E6%96%B0BlockChain%E7%9A%84CurrentBlock%0A++++++++++++++++%2F%2F+step+4+%E7%BA%A0%E6%AD%A3HeaderChain%E7%9A%84%E9%94%99%E8%AF%AF%E5%BB%B6%E4%BC%B8%0A%09%09bc.insert%28block%29%0A%09%7D%0A++++++++%2F%2F+%E4%BB%8EfutureBlock%E4%B8%AD%E5%88%A0%E9%99%A4%E5%88%9A%E6%89%8D%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%0A%09bc.futureBlocks.Remove%28block.Hash%28%29%29%0A%09return+status%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Cp%3E%E8%BF%99%E9%87%8C%E8%BF%98%E6%9C%89%E4%B8%80%E4%B8%AA%E6%98%AF%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%EF%BC%8C%E5%B0%B1%E6%98%AF%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E7%9A%84%E8%BF%99%E4%B8%AA%E5%BE%85%E6%8F%92%E5%85%A5%E5%8C%BA%E5%9D%97%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%A4%A7%E4%BA%8E%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E7%9A%84%EF%BC%8C%E6%9C%80%E7%90%86%E6%83%B3%E7%9A%84%E6%83%85%E5%86%B5%E5%B0%B1%E6%98%AF%E8%AF%A5%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E5%B0%B1%E6%98%AF%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E6%9C%80%E5%89%8D%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%B0%B1%E7%9B%B4%E6%8E%A5%E5%B0%86balock%E4%B8%8A%E9%93%BE%E5%B0%B1%E5%8F%AF%E4%BB%A5%E4%BA%86%E3%80%82%E4%BD%86%E6%98%AF%E6%9C%89%E4%B8%80%E7%A7%8D%E6%83%85%E5%86%B5%E6%98%AF%EF%BC%8C%E5%BE%85%E6%8F%92%E5%85%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E4%B8%8D%E6%98%AFcurrentBlock%EF%BC%8C%E6%9C%89%E5%8F%AF%E8%83%BD%E5%AE%83%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E6%98%AFcurrentBlock%E4%B9%8B%E5%89%8D%E7%9A%84%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%80%8C%E6%80%BB%E9%9A%BE%E5%BA%A6%E6%9B%B4%E5%A4%A7%E7%9A%84%E5%8E%9F%E5%9B%A0%E6%98%AF%E5%9B%A0%E4%B8%BAtd%28thisBlock%29+%26gt%3B+td%28currentBlock%29%E3%80%82%E8%BF%99%E5%B0%B1%E6%84%8F%E5%91%B3%E7%9D%80%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%BE%85%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8C%BA%E5%9D%97%E6%98%AF%E5%9C%A8%E5%8F%A6%E4%B8%80%E4%B8%AA%E5%88%86%E5%8F%89%E4%B8%8A%EF%BC%8C%E8%80%8C%E6%88%91%E4%BB%AC%E7%8E%B0%E5%9C%A8%E9%9C%80%E8%A6%81%E5%B0%86%E8%AF%A5%E5%88%86%E5%8F%89%E8%A7%86%E4%BD%9C%E6%96%B0%E7%9A%84%E8%A7%84%E8%8C%83%E9%93%BE%E3%80%82%E8%BF%99%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E8%B0%83%E7%94%A8BlockChain.reorg%28%29%E6%96%B9%E6%B3%95%E3%80%82%3C%2Fp%3E+%0A++%3Ch3%3E%E4%B8%89%E3%80%81reorg%28%29%E5%87%BD%E6%95%B0%3C%2Fh3%3E+%0A++%3Cp%3Ereorg%28%29%E5%87%BD%E6%95%B0%E7%9A%84%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%B0%B1%E6%98%AF%E5%A4%84%E7%90%86%E5%88%86%E5%8F%89%EF%BC%9A%E5%B0%86%E5%8E%9F%E6%9D%A5%E7%9A%84%E5%88%86%E5%8F%89%E9%93%BE%E8%AE%BE%E7%BD%AE%E6%88%90%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E5%B0%86%E6%97%A7%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%8A%E5%AD%98%E5%9C%A8%E4%BD%86%E6%96%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%8A%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF%E6%89%BE%E5%87%BA%E6%9D%A5%EF%BC%8C%E5%88%A0%E9%99%A4%E4%BB%96%E4%BB%AC%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%9F%A5%E8%AF%A2%E5%85%A5%E5%8F%A3%E4%BF%A1%E6%81%AF%E3%80%82%3C%2Fp%3E+%0A++%3Cp%3E%E5%8E%9F%E7%90%86%EF%BC%9A%3Cbr%3E+1%E3%80%81%E6%89%BE%E5%87%BA%E6%96%B0%E9%93%BE%E5%92%8C%E8%80%81%E9%93%BE%E7%9A%84%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%EF%BC%9B%3Cbr%3E+2%E3%80%81%E5%B0%86%E6%96%B0%E9%93%BE%E6%8F%92%E5%85%A5%E5%88%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%90%8C%E6%97%B6%E6%94%B6%E9%9B%86%E6%8F%92%E5%85%A5%E5%88%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%EF%BC%9B%3Cbr%3E+3%E3%80%81%E6%89%BE%E5%87%BA%E5%BE%85%E5%88%A0%E9%99%A4%E5%88%97%E8%A1%A8%E4%B8%AD%E7%9A%84%E9%82%A3%E4%BA%9B%E4%B8%8D%E5%9C%A8%E5%BE%85%E6%B7%BB%E5%8A%A0%E7%9A%84%E4%BA%A4%E6%98%93%E5%88%97%E8%A1%A8%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%8C%E5%B9%B6%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E5%88%A0%E9%99%A4%E5%AE%83%E4%BB%AC%E7%9A%84%E4%BA%A4%E6%98%93%E6%9F%A5%E8%AF%A2%E5%85%A5%E5%8F%A3%3Cbr%3E+4%E3%80%81%E5%90%91%E5%A4%96%E5%8F%91%E9%80%81%E5%8C%BA%E5%9D%97%E8%A2%AB%E9%87%8D%E6%96%B0%E7%BB%84%E7%BB%87%E7%9A%84%E4%BA%8B%E4%BB%B6%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4%E7%9A%84%E4%BA%8B%E4%BB%B6%3C%2Fp%3E+%0A++%3Cp%3E%3Cstrong%3E%E6%89%A7%E8%A1%8C%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E7%9A%84%E5%89%8D%E6%8F%90%E6%98%AF%EF%BC%9AnewBlock%E7%9A%84%E6%80%BB%E9%9A%BE%E5%BA%A6%E5%A4%A7%E4%BA%8EoldBlock%EF%BC%8C%E4%B8%94newBlock%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E4%B8%8D%E6%98%AFoldBlock%E3%80%82%3C%2Fstrong%3E%3C%2Fp%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28bc+*BlockChain%29+reorg%28oldBlock%2C+newBlock+*types.Block%29+error+%7B%0A%09var+%28%0A%09%09newChain++++types.Blocks%0A%09%09oldChain++++types.Blocks%0A%09%09commonBlock+*types.Block%0A%09%09deletedTxs++types.Transactions%0A%09%09deletedLogs+%5B%5D*types.Log%0A%09%09%2F%2F+collectLogs+collects+the+logs+that+were+generated+during+the%0A%09%09%2F%2F+processing+of+the+block+that+corresponds+with+the+given+hash.%0A%09%09%2F%2F+These+logs+are+later+announced+as+deleted.%0A%09%09collectLogs+%3D+func%28hash+common.Hash%29+%7B%0A%09%09%09%2F%2F+Coalesce+logs+and+set+%27Removed%27.%0A%09%09%09number+%3A%3D+bc.hc.GetBlockNumber%28hash%29%0A%09%09%09if+number+%3D%3D+nil+%7B%0A%09%09%09%09return%0A%09%09%09%7D%0A%09%09%09receipts+%3A%3D+rawdb.ReadReceipts%28bc.db%2C+hash%2C+*number%29%0A%09%09%09for+_%2C+receipt+%3A%3D+range+receipts+%7B%0A%09%09%09%09for+_%2C+log+%3A%3D+range+receipt.Logs+%7B%0A%09%09%09%09%09del+%3A%3D+*log%0A%09%09%09%09%09del.Removed+%3D+true%0A%09%09%09%09%09deletedLogs+%3D+append%28deletedLogs%2C+%26amp%3Bdel%29%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%7D%0A%09%29%0A%0A%09%2F%2F+%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E6%89%BE%E5%88%B0%E6%96%B0%E9%93%BE%E5%92%8C%E8%80%81%E9%93%BE%E7%9A%84%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%0A%09if+oldBlock.NumberU64%28%29+%26gt%3B+newBlock.NumberU64%28%29+%7B%0A%09%09%2F%2F+%E5%A6%82%E6%9E%9C%E8%80%81%E5%88%86%E6%94%AF%E6%AF%94%E5%BF%83%E5%88%86%E6%94%AF%E5%8C%BA%E5%9D%97%E9%AB%98%E5%BA%A6%E9%AB%98%EF%BC%8C%E5%88%99%E5%87%8F%E5%B0%91%E8%80%81%E5%88%86%E6%94%AF%E7%9B%B4%E5%88%B0%E4%B8%8E%E6%96%B0%E5%88%86%E6%94%AF%E9%AB%98%E5%BA%A6%E7%9B%B8%E5%90%8C%0A++++++++++++++++%2F%2F+%E5%B9%B6%E6%94%B6%E9%9B%86%E8%80%81%E5%88%86%E6%94%AF%E4%B8%8A%E7%9A%84%E4%BA%A4%E6%98%93%E5%92%8C%E6%97%A5%E5%BF%97%0A%09%09for+%3B+oldBlock+%21%3D+nil+%26amp%3B%26amp%3B+oldBlock.NumberU64%28%29+%21%3D+newBlock.NumberU64%28%29%3B+oldBlock+%3D+bc.GetBlock%28oldBlock.ParentHash%28%29%2C+oldBlock.NumberU64%28%29-1%29+%7B%0A%09%09%09oldChain+%3D+append%28oldChain%2C+oldBlock%29%0A%09%09%09deletedTxs+%3D+append%28deletedTxs%2C+oldBlock.Transactions%28%29...%29%0A%0A%09%09%09collectLogs%28oldBlock.Hash%28%29%29%0A%09%09%7D%0A%09%7D+else+%7B%0A%09%09%2F%2F+%E5%A6%82%E6%9E%9C%E6%96%B0%E5%88%86%E6%94%AF%E9%AB%98%E4%BA%8E%E8%80%81%E5%88%86%E6%94%AF%EF%BC%8C%E5%88%99%E5%87%8F%E5%B0%91%E6%96%B0%E5%88%86%E6%94%AF%0A%09%09for+%3B+newBlock+%21%3D+nil+%26amp%3B%26amp%3B+newBlock.NumberU64%28%29+%21%3D+oldBlock.NumberU64%28%29%3B+newBlock+%3D+bc.GetBlock%28newBlock.ParentHash%28%29%2C+newBlock.NumberU64%28%29-1%29+%7B%0A%09%09%09newChain+%3D+append%28newChain%2C+newBlock%29%0A%09%09%7D%0A%09%7D%0A%09if+oldBlock+%3D%3D+nil+%7B%0A%09%09return+fmt.Errorf%28%22Invalid+old+chain%22%29%0A%09%7D%0A%09if+newBlock+%3D%3D+nil+%7B%0A%09%09return+fmt.Errorf%28%22Invalid+new+chain%22%29%0A%09%7D%0A+%0A++++++++%2F%2F+%E7%AD%89%E5%88%B0%E5%85%B1%E5%90%8C%E9%AB%98%E5%BA%A6%E5%90%8E%EF%BC%8C%E5%8E%BB%E6%89%BE%E5%88%B0%E5%85%B1%E5%90%8C%E7%A5%96%E5%85%88%EF%BC%88%E5%85%B1%E5%90%8C%E5%9B%9E%E9%80%80%EF%BC%89%EF%BC%8C%E7%BB%A7%E7%BB%AD%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%92%8C%E4%BA%8B%E4%BB%B6%0A%09for+%7B%0A%09%09if+oldBlock.Hash%28%29+%3D%3D+newBlock.Hash%28%29+%7B%0A%09%09%09commonBlock+%3D+oldBlock%0A%09%09%09break%0A%09%09%7D%0A%0A%09%09oldChain+%3D+append%28oldChain%2C+oldBlock%29%0A%09%09newChain+%3D+append%28newChain%2C+newBlock%29%0A%09%09deletedTxs+%3D+append%28deletedTxs%2C+oldBlock.Transactions%28%29...%29%0A%09%09collectLogs%28oldBlock.Hash%28%29%29%0A%0A%09%09oldBlock%2C+newBlock+%3D+bc.GetBlock%28oldBlock.ParentHash%28%29%2C+oldBlock.NumberU64%28%29-1%29%2C+bc.GetBlock%28newBlock.ParentHash%28%29%2C+newBlock.NumberU64%28%29-1%29%0A%09%09if+oldBlock+%3D%3D+nil+%7B%0A%09%09%09return+fmt.Errorf%28%22Invalid+old+chain%22%29%0A%09%09%7D%0A%09%09if+newBlock+%3D%3D+nil+%7B%0A%09%09%09return+fmt.Errorf%28%22Invalid+new+chain%22%29%0A%09%09%7D%0A%09%7D%0A%0A%09%2F%2F+Ensure+the+user+sees+large+reorgs%0A++++++++%2F%2F+%E6%89%93%E5%8D%B0%E8%A7%84%E5%88%99%EF%BC%88%E4%B8%8D%E5%BD%B1%E5%93%8D%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%EF%BC%89%0A%09if+len%28oldChain%29+%26gt%3B+0+%26amp%3B%26amp%3B+len%28newChain%29+%26gt%3B+0+%7B%0A%09%09logFn+%3A%3D+log.Debug%0A%09%09if+len%28oldChain%29+%26gt%3B+63+%7B%0A%09%09%09logFn+%3D+log.Warn%0A%09%09%7D%0A%09%09logFn%28%22Chain+split+detected%22%2C+%22number%22%2C+commonBlock.Number%28%29%2C+%22hash%22%2C+commonBlock.Hash%28%29%2C%0A%09%09%09%22drop%22%2C+len%28oldChain%29%2C+%22dropfrom%22%2C+oldChain%5B0%5D.Hash%28%29%2C+%22add%22%2C+len%28newChain%29%2C+%22addfrom%22%2C+newChain%5B0%5D.Hash%28%29%29%0A%09%7D+else+%7B%0A%09%09log.Error%28%22Impossible+reorg%2C+please+file+an+issue%22%2C+%22oldnum%22%2C+oldBlock.Number%28%29%2C+%22oldhash%22%2C+oldBlock.Hash%28%29%2C+%22newnum%22%2C+newBlock.Number%28%29%2C+%22newhash%22%2C+newBlock.Hash%28%29%29%0A%09%7D%0A%0A%09%2F%2F+%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%B0%86%E6%96%B0%E9%93%BE%E6%8F%92%E5%85%A5%E5%88%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%90%8C%E6%97%B6%E6%94%B6%E9%9B%86%E6%8F%92%E5%85%A5%E5%88%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%0A%09for+i+%3A%3D+len%28newChain%29+-+1%3B+i+%26gt%3B%3D+0%3B+i--+%7B%0A%09%09%2F%2F+insert+the+block+in+the+canonical+way%2C+re-writing+history%0A%09%09bc.insert%28newChain%5Bi%5D%29%0A%09%09%2F%2F+%E6%8A%8A%E6%89%80%E6%9C%89%E6%96%B0%E5%88%86%E6%94%AF%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BA%A4%E6%98%93%E6%9F%A5%E8%AF%A2%E5%85%A5%E5%8F%A3%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A%09%09rawdb.WriteTxLookupEntries%28bc.db%2C+newChain%5Bi%5D%29%0A%09%09addedTxs+%3D+append%28addedTxs%2C+newChain%5Bi%5D.Transactions%28%29...%29%0A%09%7D%0A%09%2F%2F+%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E6%89%BE%E5%87%BA%E5%BE%85%E5%88%A0%E9%99%A4%E5%88%97%E8%A1%A8%E5%92%8C%E5%BE%85%E6%B7%BB%E5%8A%A0%E5%88%97%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%B7%AE%E5%BC%82%EF%BC%8C%E5%88%A0%E9%99%A4%E9%82%A3%E4%BA%9B%E4%B8%8D%E5%9C%A8%E6%96%B0%E9%93%BE%E4%B8%8A%E7%9A%84%E4%BA%A4%E6%98%93%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E6%9F%A5%E8%AF%A2%E5%85%A5%E5%8F%A3%0A%09diff+%3A%3D+types.TxDifference%28deletedTxs%2C+addedTxs%29%0A%09%2F%2F+When+transactions+get+deleted+from+the+database+that+means+the%0A%09%2F%2F+receipts+that+were+created+in+the+fork+must+also+be+deleted%0A%09batch+%3A%3D+bc.db.NewBatch%28%29%0A%09for+_%2C+tx+%3A%3D+range+diff+%7B%0A%09%09rawdb.DeleteTxLookupEntry%28batch%2C+tx.Hash%28%29%29%0A%09%7D%0A%09batch.Write%28%29%0A++++++%0A++++++++%2F%2F+%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E5%90%91%E5%A4%96%E5%8F%91%E9%80%81%E5%8C%BA%E5%9D%97%E8%A2%AB%E9%87%8D%E6%96%B0%E7%BB%84%E7%BB%87%E7%9A%84%E4%BA%8B%E4%BB%B6%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4%E4%BA%8B%E4%BB%B6%0A%09if+len%28deletedLogs%29+%26gt%3B+0+%7B%0A%09%09go+bc.rmLogsFeed.Send%28RemovedLogsEvent%7BdeletedLogs%7D%29%0A%09%7D%0A%09if+len%28oldChain%29+%26gt%3B+0+%7B%0A%09%09go+func%28%29+%7B%0A%09%09%09for+_%2C+block+%3A%3D+range+oldChain+%7B%0A%09%09%09%09bc.chainSideFeed.Send%28ChainSideEvent%7BBlock%3A+block%7D%29%0A%09%09%09%7D%0A%09%09%7D%28%29%0A%09%7D%0A%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3%3E%E5%9B%9B%E3%80%81insert%28%29%E5%87%BD%E6%95%B0%3C%2Fh3%3E+%0A++%3Cpre+class%3D%22has%22%3E%0A%3Ccode+class%3D%22language-Go%22%3Efunc+%28bc+*BlockChain%29+insert%28block+*types.Block%29+%7B%0A%09%2F%2F+%E8%AF%BB%E5%87%BA%E5%BE%85%E6%8F%92%E5%85%A5blcok%E7%9A%84%E5%8C%BA%E5%9D%97%E5%8F%B7%E5%AF%B9%E5%BA%94%E5%9C%A8%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%8A%E7%9A%84%E5%8C%BA%E5%9D%97hash%E5%80%BC%EF%BC%8C%E4%B8%8Eblock%E7%9A%84hash%E5%80%BC%E5%AF%B9%E6%AF%94%E7%9C%8B%E6%98%AF%E5%90%A6%E7%9B%B8%E7%AD%89%EF%BC%8C%E5%8D%B3%E5%88%A4%E6%96%ADHeaderChain%E5%BB%B6%E4%BC%B8%E6%98%AF%E5%90%A6%E6%AD%A3%E7%A1%AE%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%AD%A3%E7%A1%AE%EF%BC%8C%E5%90%8E%E9%9D%A2%E7%9F%AB%E6%AD%A3%0A%09updateHeads+%3A%3D+rawdb.ReadCanonicalHash%28bc.db%2C+block.NumberU64%28%29%29+%21%3D+block.Hash%28%29%0A%0A%09%2F%2F+%E6%9B%B4%E6%96%B0%E8%A7%84%E8%8C%83%E9%93%BE%E4%B8%8Ablock.number%E7%9A%84hash%E5%80%BC%E4%B8%BAblock.hash%0A%09rawdb.WriteCanonicalHash%28bc.db%2C+block.Hash%28%29%2C+block.NumberU64%28%29%29%0A++++++++%2F%2F+%E6%AD%A3%E5%BC%8F%E5%86%99%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%EF%BC%8C%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84LastBlock%0A%09rawdb.WriteHeadBlockHash%28bc.db%2C+block.Hash%28%29%29%0A++++++++%2F%2F+%E5%B0%86BlockChain%E4%B8%AD%E7%9A%84currentBlock%E6%9B%BF%E6%8D%A2%E6%88%90blcok%0A%09bc.currentBlock.Store%28block%29%0A%0A%09%2F%2F+If+the+block+is+better+than+our+head+or+is+on+a+different+chain%2C+force+update+heads%0A%09if+updateHeads+%7B%0A++++++++++++++++%2F%2F+%E5%B0%86headerChain%E7%9A%84%E5%A4%B4%E8%AE%BE%E7%BD%AE%E6%88%90%E5%BE%85%E6%8F%92%E5%85%A5%E8%A7%84%E8%8C%83%E9%93%BE%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8CBlockChain%E5%92%8CHeaderChain%E5%9C%A8%E6%AD%A4%E9%BD%90%E5%A4%B4%E5%B9%B6%E8%BF%9B%0A%09%09bc.hc.SetCurrentHeader%28block.Header%28%29%29%0A%09%09rawdb.WriteHeadFastBlockHash%28bc.db%2C+block.Hash%28%29%29%0A%0A%09%09bc.currentFastBlock.Store%28block%29%0A%09%7D%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E+%0A++%3Ch3%3E%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93%EF%BC%9A%3C%2Fh3%3E+%0A++%3Cp%3E%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E6%8F%92%E5%85%A5%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E6%B5%81%E7%A8%8B%EF%BC%9A%3Cbr%3E%3Cimg+alt%3D%22%22+class%3D%22has%22+src%3D%22https%3A%2F%2Fimg-blog.csdnimg.cn%2F20181104213004782.png%3Fx-oss-process%3Dimage%2Fwatermark%2Ctype_ZmFuZ3poZW5naGVpdGk%2Cshadow_10%2Ctext_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2xqOTAwOTEx%2Csize_16%2Ccolor_FFFFFF%2Ct_70%22%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Flj900911%2Farticle%2Fdetails%2F83622887%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Flj900911%2Farticle%2Fdetails%2F83622887%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E+%0A%3Cscript%3E%0A%09%09%09%09%09%09%28function%28%29%7B%0A%09%09%09%09%09%09%09function+setArticleH%28btnReadmore%2Cposi%29%7B%0A%09%09%09%09%09%09%09%09var+winH+%3D+%24%28window%29.height%28%29%3B%0A%09%09%09%09%09%09%09%09var+articleBox+%3D+%24%28%22div.article_content%22%29%3B%0A%09%09%09%09%09%09%09%09var+artH+%3D+articleBox.height%28%29%3B%0A%09%09%09%09%09%09%09%09if%28artH+%3E+winH*posi%29%7B%0A%09%09%09%09%09%09%09%09%09articleBox.css%28%7B%0A%09%09%09%09%09%09%09%09%09%09%27height%27%3AwinH*posi%2B%27px%27%2C%0A%09%09%09%09%09%09%09%09%09%09%27overflow%27%3A%27hidden%27%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%09btnReadmore.click%28function%28%29%7B%0A%09%09%09%09%09%09%09%09%09%09if%28typeof+window.localStorage+%3D%3D%3D+%22object%22+%26%26+typeof+window.csdn.anonymousUserLimit+%3D%3D%3D+%22object%22%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09if%28%21window.csdn.anonymousUserLimit.judgment%28%29%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09%09window.csdn.anonymousUserLimit.Jumplogin%28%29%3B%0A%09%09%09%09%09%09%09%09%09%09%09%09return+false%3B%0A%09%09%09%09%09%09%09%09%09%09%09%7Delse+if%28%21currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09%09%09%09window.csdn.anonymousUserLimit.updata%28%29%3B%0A%09%09%09%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%09%09%09%0A%09%09%09%09%09%09%09%09%09%09articleBox.removeAttr%28%22style%22%29%3B%0A%09%09%09%09%09%09%09%09%09%09%24%28this%29.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%09%7D%29%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09btnReadmore.parent%28%29.remove%28%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09var+btnReadmore+%3D+%24%28%22%23btn-readmore%22%29%3B%0A%09%09%09%09%09%09%09if%28btnReadmore.length%3E0%29%7B%0A%09%09%09%09%09%09%09%09if%28currentUserName%29%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C3%29%3B%0A%09%09%09%09%09%09%09%09%7Delse%7B%0A%09%09%09%09%09%09%09%09%09setArticleH%28btnReadmore%2C1.2%29%3B%0A%09%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%09%7D%0A%09%09%09%09%09%09%7D%29%28%29%0A%09%09%09%09%09%3C%2Fscript%3E" | url_decode}}