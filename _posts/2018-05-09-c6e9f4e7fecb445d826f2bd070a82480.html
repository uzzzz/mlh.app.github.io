---
layout: default
title: 以太坊源码深入分析（8）-- 以太坊核心BlockChain源码分析
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E%0A+++%E5%89%8D%E9%9D%A2%E5%87%A0%E8%8A%82%E9%83%BD%E5%9C%A8%E5%88%86%E6%9E%90%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%EF%BC%8C%E6%80%8E%E4%B9%88%E5%B9%BF%E6%92%AD%EF%BC%8C%E6%80%8E%E4%B9%88%E5%90%8C%E6%AD%A5%EF%BC%8C%E6%80%8E%E4%B9%88%E4%B8%8B%E8%BD%BD%E3%80%82%E8%BF%99%E4%B8%80%E8%8A%82%E8%AE%B2%E8%AE%B2%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E6%A0%B8%E5%BF%83%E6%A8%A1%E5%9D%97BlockChain%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E3%80%82%0A++%3Cbr%3E%0A++%3Cbr%3E%0A++%3Ch4%3E%E4%B8%80%EF%BC%8CBlockChain%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%3C%2Fh4%3E%0A++%3Cp%3EEthereum%E6%9C%8D%E5%8A%A1%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%E4%BC%9A%E8%B0%83%E7%94%A8core.SetupGenesisBlock%E6%9D%A5%E5%8A%A0%E8%BD%BD%E5%88%9B%E5%A7%8B%E5%8C%BA%E5%9D%97%E3%80%82%E9%A1%BE%E5%90%8D%E6%80%9D%E4%B9%89%EF%BC%8C%E5%88%9B%E5%A7%8B%E5%8C%BA%E5%9D%97%E5%B0%B1%E6%98%AF%E4%BB%A5%E5%A4%AA%E5%9D%8A%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8Cnumber%E5%80%BC%E4%B8%BA0%E3%80%82%E7%B4%A7%E6%8E%A5%E7%9D%80%E8%B0%83%E7%94%A8core.NewBlockChain%E6%9D%A5%E5%8A%A0%E8%BD%BD%E4%BB%A5%E5%A4%AA%E5%9D%8A%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E3%80%82%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+NewBlockChain%28db+ethdb.Database%2C+cacheConfig+*CacheConfig%2C+chainConfig+*params.ChainConfig%2C+engine+consensus.Engine%2C+vmConfig+vm.Config%29+%28*BlockChain%2C+error%29+%7B%0A%09if+cacheConfig+%3D%3D+nil+%7B%0A%09%09cacheConfig+%3D+%26amp%3BCacheConfig%7B%0A%09%09%09TrieNodeLimit%3A+256+*+1024+*+1024%2C%0A%09%09%09TrieTimeLimit%3A+5+*+time.Minute%2C%0A%09%09%7D%0A%09%7D%0A%09bodyCache%2C+_+%3A%3D+lru.New%28bodyCacheLimit%29%0A%09bodyRLPCache%2C+_+%3A%3D+lru.New%28bodyCacheLimit%29%0A%09blockCache%2C+_+%3A%3D+lru.New%28blockCacheLimit%29%0A%09futureBlocks%2C+_+%3A%3D+lru.New%28maxFutureBlocks%29%0A%09badBlocks%2C+_+%3A%3D+lru.New%28badBlockLimit%29%0A%0A%0A%09bc+%3A%3D+%26amp%3BBlockChain%7B%0A%09%09chainConfig%3A++chainConfig%2C%0A%09%09cacheConfig%3A++cacheConfig%2C%0A%09%09db%3A+++++++++++db%2C%0A%09%09triegc%3A+++++++prque.New%28%29%2C%0A%09%09stateCache%3A+++state.NewDatabase%28db%29%2C%0A%09%09quit%3A+++++++++make%28chan+struct%7B%7D%29%2C%0A%09%09bodyCache%3A++++bodyCache%2C%0A%09%09bodyRLPCache%3A+bodyRLPCache%2C%0A%09%09blockCache%3A+++blockCache%2C%0A%09%09futureBlocks%3A+futureBlocks%2C%0A%09%09engine%3A+++++++engine%2C%0A%09%09vmConfig%3A+++++vmConfig%2C%0A%09%09badBlocks%3A++++badBlocks%2C%0A%09%7D%0A%09bc.SetValidator%28NewBlockValidator%28chainConfig%2C+bc%2C+engine%29%29%0A%09bc.SetProcessor%28NewStateProcessor%28chainConfig%2C+bc%2C+engine%29%29%0A%0A%0A%09var+err+error%0A%09bc.hc%2C+err+%3D+NewHeaderChain%28db%2C+chainConfig%2C+engine%2C+bc.getProcInterrupt%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%09%7D%0A%09bc.genesisBlock+%3D+bc.GetBlockByNumber%280%29%0A%09if+bc.genesisBlock+%3D%3D+nil+%7B%0A%09%09return+nil%2C+ErrNoGenesis%0A%09%7D%0A%09if+err+%3A%3D+bc.loadLastState%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+err%0A%09%7D%0A%09%2F%2F+Check+the+current+state+of+the+block+hashes+and+make+sure+that+we+do+not+have+any+of+the+bad+blocks+in+our+chain%0A%09for+hash+%3A%3D+range+BadHashes+%7B%0A%09%09if+header+%3A%3D+bc.GetHeaderByHash%28hash%29%3B+header+%21%3D+nil+%7B%0A%09%09%09%2F%2F+get+the+canonical+block+corresponding+to+the+offending+header%27s+number%0A%09%09%09headerByNumber+%3A%3D+bc.GetHeaderByNumber%28header.Number.Uint64%28%29%29%0A%09%09%09%2F%2F+make+sure+the+headerByNumber+%28if+present%29+is+in+our+current+canonical+chain%0A%09%09%09if+headerByNumber+%21%3D+nil+%26amp%3B%26amp%3B+headerByNumber.Hash%28%29+%3D%3D+header.Hash%28%29+%7B%0A%09%09%09%09log.Error%28%22Found+bad+hash%2C+rewinding+chain%22%2C+%22number%22%2C+header.Number%2C+%22hash%22%2C+header.ParentHash%29%0A%09%09%09%09bc.SetHead%28header.Number.Uint64%28%29+-+1%29%0A%09%09%09%09log.Error%28%22Chain+rewind+was+successful%2C+resuming+normal+operation%22%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%09%2F%2F+Take+ownership+of+this+particular+state%0A%09go+bc.update%28%29%0A%09return+bc%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95%E5%81%9A%E4%BA%86%E8%BF%99%E4%B9%88%E5%87%A0%E4%BB%B6%E4%BA%8B%EF%BC%9A%0A++%3Cbr%3E1%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%90%84%E7%A7%8Dlru%E7%BC%93%E5%AD%98%28%E6%9C%80%E8%BF%91%E6%9C%80%E5%B0%91%E4%BD%BF%E7%94%A8%E7%9A%84%E7%AE%97%E6%B3%95%29%0A++%3Cbr%3E2%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96triegc%EF%BC%88%E7%94%A8%E4%BA%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%9A%84%E5%8C%BA%E5%9D%97number+%E5%AF%B9%E5%BA%94%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97%EF%BC%89%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96stateDb%EF%BC%8CNewBlockValidator%28%29%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8C%BA%E5%9D%97%E5%92%8C%E7%8A%B6%E6%80%81%E9%AA%8C%E8%AF%81%E5%99%A8%EF%BC%8CNewStateProcessor%28%29%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8C%BA%E5%9D%97%E7%8A%B6%E6%80%81%E5%A4%84%E7%90%86%E5%99%A8%0A++%3Cbr%3E3%EF%BC%8CNewHeaderChain%28%29%E5%88%9D%E5%A7%8B%E5%8C%96%E5%8C%BA%E5%9D%97%E5%A4%B4%E9%83%A8%E9%93%BE%0A++%3Cbr%3E4%EF%BC%8Cbc.genesisBlock+%3D+bc.GetBlockByNumber%280%29+%26nbsp%3B%E6%8B%BF%E5%88%B0%E7%AC%AC0%E4%B8%AA%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF%E5%88%9B%E4%B8%96%E5%8C%BA%E5%9D%97%0A++%3Cbr%3E5%EF%BC%8Cbc.loadLastState%28%29+%E5%8A%A0%E8%BD%BD%E6%9C%80%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%0A++%3Cbr%3E6%EF%BC%8C%E6%9F%A5%E6%89%BE%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%8A%E6%97%B6%E5%80%99%E6%9C%89%E7%A1%AC%E5%88%86%E5%8F%89%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%9C%89%E8%B0%83%E7%94%A8bc.SetHead%E5%9B%9E%E5%88%B0%E7%A1%AC%E5%88%86%E5%8F%89%E4%B9%8B%E5%89%8D%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%0A++%3Cbr%3E7%EF%BC%8Cgo+bc.update%28%29+%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86future+block%0A++%3Cbr%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E%E4%BA%8C%EF%BC%8C%E7%9C%8B%E7%9C%8Bbc.loadLastState%28%29%E6%96%B9%E6%B3%95%3C%2Fh4%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+%28bc+*BlockChain%29+loadLastState%28%29+error+%7B%0A%09%2F%2F+Restore+the+last+known+head+block%0A%09head+%3A%3D+GetHeadBlockHash%28bc.db%29%0A%09if+head+%3D%3D+%28common.Hash%7B%7D%29+%7B%0A%09%09%2F%2F+Corrupt+or+empty+database%2C+init+from+scratch%0A%09%09log.Warn%28%22Empty+database%2C+resetting+chain%22%29%0A%09%09return+bc.Reset%28%29%0A%09%7D%0A%09%2F%2F+Make+sure+the+entire+head+block+is+available%0A%09currentBlock+%3A%3D+bc.GetBlockByHash%28head%29%0A%09if+currentBlock+%3D%3D+nil+%7B%0A%09%09%2F%2F+Corrupt+or+empty+database%2C+init+from+scratch%0A%09%09log.Warn%28%22Head+block+missing%2C+resetting+chain%22%2C+%22hash%22%2C+head%29%0A%09%09return+bc.Reset%28%29%0A%09%7D%0A%09%2F%2F+Make+sure+the+state+associated+with+the+block+is+available%0A%09if+_%2C+err+%3A%3D+state.New%28currentBlock.Root%28%29%2C+bc.stateCache%29%3B+err+%21%3D+nil+%7B%0A%09%09%2F%2F+Dangling+block+without+a+state+associated%2C+init+from+scratch%0A%09%09log.Warn%28%22Head+state+missing%2C+repairing+chain%22%2C+%22number%22%2C+currentBlock.Number%28%29%2C+%22hash%22%2C+currentBlock.Hash%28%29%29%0A%09%09if+err+%3A%3D+bc.repair%28%C2%A4tBlock%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+err%0A%09%09%7D%0A%09%7D%0A%09%2F%2F+Everything+seems+to+be+fine%2C+set+as+the+head+block%0A%09bc.currentBlock.Store%28currentBlock%29%0A%0A%0A%09%2F%2F+Restore+the+last+known+head+header%0A%09currentHeader+%3A%3D+currentBlock.Header%28%29%0A%09if+head+%3A%3D+GetHeadHeaderHash%28bc.db%29%3B+head+%21%3D+%28common.Hash%7B%7D%29+%7B%0A%09%09if+header+%3A%3D+bc.GetHeaderByHash%28head%29%3B+header+%21%3D+nil+%7B%0A%09%09%09currentHeader+%3D+header%0A%09%09%7D%0A%09%7D%0A%09bc.hc.SetCurrentHeader%28currentHeader%29%0A%0A%0A%09%2F%2F+Restore+the+last+known+head+fast+block%0A%09bc.currentFastBlock.Store%28currentBlock%29%0A%09if+head+%3A%3D+GetHeadFastBlockHash%28bc.db%29%3B+head+%21%3D+%28common.Hash%7B%7D%29+%7B%0A%09%09if+block+%3A%3D+bc.GetBlockByHash%28head%29%3B+block+%21%3D+nil+%7B%0A%09%09%09bc.currentFastBlock.Store%28block%29%0A%09%09%7D%0A%09%7D%0A%0A%0A%09%2F%2F+Issue+a+status+log+for+the+user%0A%09currentFastBlock+%3A%3D+bc.CurrentFastBlock%28%29%0A%0A%0A%09headerTd+%3A%3D+bc.GetTd%28currentHeader.Hash%28%29%2C+currentHeader.Number.Uint64%28%29%29%0A%09blockTd+%3A%3D+bc.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%0A%09fastTd+%3A%3D+bc.GetTd%28currentFastBlock.Hash%28%29%2C+currentFastBlock.NumberU64%28%29%29%0A%0A%0A%09log.Info%28%22Loaded+most+recent+local+header%22%2C+%22number%22%2C+currentHeader.Number%2C+%22hash%22%2C+currentHeader.Hash%28%29%2C+%22td%22%2C+headerTd%29%0A%09log.Info%28%22Loaded+most+recent+local+full+block%22%2C+%22number%22%2C+currentBlock.Number%28%29%2C+%22hash%22%2C+currentBlock.Hash%28%29%2C+%22td%22%2C+blockTd%29%0A%09log.Info%28%22Loaded+most+recent+local+fast+block%22%2C+%22number%22%2C+currentFastBlock.Number%28%29%2C+%22hash%22%2C+currentFastBlock.Hash%28%29%2C+%22td%22%2C+fastTd%29%0A%0A%0A%09return+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E1%EF%BC%8C%E8%8E%B7%E5%8F%96%E5%88%B0%E6%9C%80%E6%96%B0%E5%8C%BA%E5%9D%97%E4%BB%A5%E5%8F%8A%E5%AE%83%E7%9A%84hash%0A++%3Cbr%3E2%EF%BC%8C%E4%BB%8EstateDb%E4%B8%AD%E6%89%93%E5%BC%80%E6%9C%80%E6%96%B0%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81trie%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%89%93%E5%BC%80%E5%A4%B1%E8%B4%A5%E8%B0%83%E7%94%A8bc.repair%28%26amp%3BcurrentBlock%29%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E4%BF%AE%E5%A4%8D%E3%80%82%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95%E5%B0%B1%E6%98%AF%E4%BB%8E%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E4%B8%80%E4%B8%AA%E4%B8%AA%E7%9A%84%E5%BE%80%E5%89%8D%E9%9D%A2%E6%89%BE%EF%BC%8C%E7%9B%B4%E5%88%B0%E6%89%BE%E5%88%B0%E5%A5%BD%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E7%84%B6%E5%90%8E%E8%B5%8B%E5%80%BC%E7%BB%99currentBlock%E3%80%82%0A++%3Cbr%3E3%EF%BC%8C%E8%8E%B7%E5%8F%96%E5%88%B0%E6%9C%80%E6%96%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%0A++%3Cbr%3E%0A++%3Cp%3E4%EF%BC%8C%E6%89%BE%E5%88%B0%E6%9C%80%E6%96%B0%E7%9A%84fast%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84block%EF%BC%8C%E5%B9%B6%E8%AE%BE%E7%BD%AEbc.currentFastBlock%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E%E4%B8%89%EF%BC%8C%E5%86%8D%E7%9C%8B%E7%9C%8B%E7%94%A8%E6%9D%A5%E5%9B%9E%E6%BB%9A%E5%8C%BA%E5%9D%97%E7%9A%84bc.SetHead%28%29%E6%96%B9%E6%B3%95%3C%2Fh4%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+%28bc+*BlockChain%29+SetHead%28head+uint64%29+error+%7B%0A%09log.Warn%28%22Rewinding+blockchain%22%2C+%22target%22%2C+head%29%0A%0A%0A%09bc.mu.Lock%28%29%0A%09defer+bc.mu.Unlock%28%29%0A%0A%0A%09%2F%2F+Rewind+the+header+chain%2C+deleting+all+block+bodies+until+then%0A%09delFn+%3A%3D+func%28hash+common.Hash%2C+num+uint64%29+%7B%0A%09%09DeleteBody%28bc.db%2C+hash%2C+num%29%0A%09%7D%0A%09bc.hc.SetHead%28head%2C+delFn%29%0A%09currentHeader+%3A%3D+bc.hc.CurrentHeader%28%29%0A%0A%0A%09%2F%2F+Clear+out+any+stale+content+from+the+caches%0A%09bc.bodyCache.Purge%28%29%0A%09bc.bodyRLPCache.Purge%28%29%0A%09bc.blockCache.Purge%28%29%0A%09bc.futureBlocks.Purge%28%29%0A%0A%0A%09%2F%2F+Rewind+the+block+chain%2C+ensuring+we+don%27t+end+up+with+a+stateless+head+block%0A%09if+currentBlock+%3A%3D+bc.CurrentBlock%28%29%3B+currentBlock+%21%3D+nil+%26amp%3B%26amp%3B+currentHeader.Number.Uint64%28%29+%26lt%3B+currentBlock.NumberU64%28%29+%7B%0A%09%09bc.currentBlock.Store%28bc.GetBlock%28currentHeader.Hash%28%29%2C+currentHeader.Number.Uint64%28%29%29%29%0A%09%7D%0A%09if+currentBlock+%3A%3D+bc.CurrentBlock%28%29%3B+currentBlock+%21%3D+nil+%7B%0A%09%09if+_%2C+err+%3A%3D+state.New%28currentBlock.Root%28%29%2C+bc.stateCache%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%2F%2F+Rewound+state+missing%2C+rolled+back+to+before+pivot%2C+reset+to+genesis%0A%09%09%09bc.currentBlock.Store%28bc.genesisBlock%29%0A%09%09%7D%0A%09%7D%0A%09%2F%2F+Rewind+the+fast+block+in+a+simpleton+way+to+the+target+head%0A%09if+currentFastBlock+%3A%3D+bc.CurrentFastBlock%28%29%3B+currentFastBlock+%21%3D+nil+%26amp%3B%26amp%3B+currentHeader.Number.Uint64%28%29+%26lt%3B+currentFastBlock.NumberU64%28%29+%7B%0A%09%09bc.currentFastBlock.Store%28bc.GetBlock%28currentHeader.Hash%28%29%2C+currentHeader.Number.Uint64%28%29%29%29%0A%09%7D%0A%09%2F%2F+If+either+blocks+reached+nil%2C+reset+to+the+genesis+state%0A%09if+currentBlock+%3A%3D+bc.CurrentBlock%28%29%3B+currentBlock+%3D%3D+nil+%7B%0A%09%09bc.currentBlock.Store%28bc.genesisBlock%29%0A%09%7D%0A%09if+currentFastBlock+%3A%3D+bc.CurrentFastBlock%28%29%3B+currentFastBlock+%3D%3D+nil+%7B%0A%09%09bc.currentFastBlock.Store%28bc.genesisBlock%29%0A%09%7D%0A%09currentBlock+%3A%3D+bc.CurrentBlock%28%29%0A%09currentFastBlock+%3A%3D+bc.CurrentFastBlock%28%29%0A%09if+err+%3A%3D+WriteHeadBlockHash%28bc.db%2C+currentBlock.Hash%28%29%29%3B+err+%21%3D+nil+%7B%0A%09%09log.Crit%28%22Failed+to+reset+head+full+block%22%2C+%22err%22%2C+err%29%0A%09%7D%0A%09if+err+%3A%3D+WriteHeadFastBlockHash%28bc.db%2C+currentFastBlock.Hash%28%29%29%3B+err+%21%3D+nil+%7B%0A%09%09log.Crit%28%22Failed+to+reset+head+fast+block%22%2C+%22err%22%2C+err%29%0A%09%7D%0A%09return+bc.loadLastState%28%29%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E1%EF%BC%8C%E9%A6%96%E5%85%88%E8%B0%83%E7%94%A8bc.hc.SetHead%28head%2C+delFn%29%EF%BC%8C%E5%9B%9E%E6%BB%9Ahead%E5%AF%B9%E5%BA%94%E7%9A%84%E5%8C%BA%E5%9D%97%E5%A4%B4%E3%80%82%E5%B9%B6%E6%B8%85%E9%99%A4%E4%B8%AD%E9%97%B4%E5%8C%BA%E5%9D%97%E5%A4%B4%E6%89%80%E6%9C%89%E7%9A%84%E6%95%B0%E6%8D%AE%E5%92%8C%E7%BC%93%E5%AD%98%E3%80%82%E8%AE%BE%E7%BD%AEhead%E4%B8%BA%E6%96%B0%E7%9A%84currentHeadr%E3%80%82%0A++%3Cbr%3E2%EF%BC%8C%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AEbc.currentBlock%EF%BC%8Cbc.currentFastBlock%0A++%3Cbr%3E3%EF%BC%8C%E8%B0%83%E7%94%A8bc.loadLastState%28%29%EF%BC%8C%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD%E7%8A%B6%E6%80%81%0A++%3Cbr%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E%E5%9B%9B%EF%BC%8C%E4%B9%8B%E5%89%8D%E5%88%86%E6%9E%90Downloader%E5%92%8CFetcher%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%9C%A8%E5%90%8C%E6%AD%A5%E5%AE%8C%E5%8C%BA%E5%9D%97%E5%90%8E%E4%BC%9A%E8%B0%83%E7%94%A8InsertChain%E6%96%B9%E6%B3%95%E6%8F%92%E5%85%A5%E5%88%B0%E6%9C%AC%E5%9C%B0BlockChain%E4%B8%AD%E3%80%82%E6%88%91%E4%BB%AC%E7%9C%8B%E7%9C%8BInsertChain%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84%3C%2Fh4%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+%28bc+*BlockChain%29+InsertChain%28chain+types.Blocks%29+%28int%2C+error%29+%7B%0A%09n%2C+events%2C+logs%2C+err+%3A%3D+bc.insertChain%28chain%29%0A%09bc.PostChainEvents%28events%2C+logs%29%0A%09return+n%2C+err%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cp%3E%E8%B0%83%E7%94%A8bc.insertChain%28chain%29%EF%BC%8C%E5%B9%B6%E5%B0%86%E6%8F%92%E5%85%A5%E7%9A%84%E7%BB%93%E6%9E%9C%E5%B9%BF%E6%92%AD%E7%BB%99%E8%AE%A2%E9%98%85%E4%BA%86blockChain%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%E3%80%82%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+%28bc+*BlockChain%29+insertChain%28chain+types.Blocks%29+%28int%2C+%5B%5Dinterface%7B%7D%2C+%5B%5D*types.Log%2C+error%29+%7B%0A%09%2F%2F+Do+a+sanity+check+that+the+provided+chain+is+actually+ordered+and+linked%0A%09for+i+%3A%3D+1%3B+i+%26lt%3B+len%28chain%29%3B+i%2B%2B+%7B%0A%09%09if+chain%5Bi%5D.NumberU64%28%29+%21%3D+chain%5Bi-1%5D.NumberU64%28%29%2B1+%7C%7C+chain%5Bi%5D.ParentHash%28%29+%21%3D+chain%5Bi-1%5D.Hash%28%29+%7B%0A%09%09%09%2F%2F+Chain+broke+ancestry%2C+log+a+messge+%28programming+error%29+and+skip+insertion%0A%09%09%09log.Error%28%22Non+contiguous+block+insert%22%2C+%22number%22%2C+chain%5Bi%5D.Number%28%29%2C+%22hash%22%2C+chain%5Bi%5D.Hash%28%29%2C%0A%09%09%09%09%22parent%22%2C+chain%5Bi%5D.ParentHash%28%29%2C+%22prevnumber%22%2C+chain%5Bi-1%5D.Number%28%29%2C+%22prevhash%22%2C+chain%5Bi-1%5D.Hash%28%29%29%0A%0A%0A%09%09%09return+0%2C+nil%2C+nil%2C+fmt.Errorf%28%22non+contiguous+insert%3A+item+%25d+is+%23%25d+%5B%25x%E2%80%A6%5D%2C+item+%25d+is+%23%25d+%5B%25x%E2%80%A6%5D+%28parent+%5B%25x%E2%80%A6%5D%29%22%2C+i-1%2C+chain%5Bi-1%5D.NumberU64%28%29%2C%0A%09%09%09%09chain%5Bi-1%5D.Hash%28%29.Bytes%28%29%5B%3A4%5D%2C+i%2C+chain%5Bi%5D.NumberU64%28%29%2C+chain%5Bi%5D.Hash%28%29.Bytes%28%29%5B%3A4%5D%2C+chain%5Bi%5D.ParentHash%28%29.Bytes%28%29%5B%3A4%5D%29%0A%09%09%7D%0A%09%7D%0A%09%2F%2F+Pre-checks+passed%2C+start+the+full+block+imports%0A%09bc.wg.Add%281%29%0A%09defer+bc.wg.Done%28%29%0A%0A%0A%09bc.chainmu.Lock%28%29%0A%09defer+bc.chainmu.Unlock%28%29%0A%0A%0A%09%2F%2F+A+queued+approach+to+delivering+events.+This+is+generally%0A%09%2F%2F+faster+than+direct+delivery+and+requires+much+less+mutex%0A%09%2F%2F+acquiring.%0A%09var+%28%0A%09%09stats+++++++++%3D+insertStats%7BstartTime%3A+mclock.Now%28%29%7D%0A%09%09events++++++++%3D+make%28%5B%5Dinterface%7B%7D%2C+0%2C+len%28chain%29%29%0A%09%09lastCanon+++++*types.Block%0A%09%09coalescedLogs+%5B%5D*types.Log%0A%09%29%0A%09%2F%2F+Start+the+parallel+header+verifier%0A%09headers+%3A%3D+make%28%5B%5D*types.Header%2C+len%28chain%29%29%0A%09seals+%3A%3D+make%28%5B%5Dbool%2C+len%28chain%29%29%0A%0A%0A%09for+i%2C+block+%3A%3D+range+chain+%7B%0A%09%09headers%5Bi%5D+%3D+block.Header%28%29%0A%09%09seals%5Bi%5D+%3D+true%0A%09%7D%0A%09abort%2C+results+%3A%3D+bc.engine.VerifyHeaders%28bc%2C+headers%2C+seals%29%0A%09defer+close%28abort%29%0A%0A%0A%09%2F%2F+Iterate+over+the+blocks+and+insert+when+the+verifier+permits%0A%09for+i%2C+block+%3A%3D+range+chain+%7B%0A%09%09%2F%2F+If+the+chain+is+terminating%2C+stop+processing+blocks%0A%09%09if+atomic.LoadInt32%28%26amp%3Bbc.procInterrupt%29+%3D%3D+1+%7B%0A%09%09%09log.Debug%28%22Premature+abort+during+blocks+processing%22%29%0A%09%09%09break%0A%09%09%7D%0A%09%09%2F%2F+If+the+header+is+a+banned+one%2C+straight+out+abort%0A%09%09if+BadHashes%5Bblock.Hash%28%29%5D+%7B%0A%09%09%09bc.reportBlock%28block%2C+nil%2C+ErrBlacklistedHash%29%0A%09%09%09return+i%2C+events%2C+coalescedLogs%2C+ErrBlacklistedHash%0A%09%09%7D%0A%09%09%2F%2F+Wait+for+the+block%27s+verification+to+complete%0A%09%09bstart+%3A%3D+time.Now%28%29%0A%0A%0A%09%09err+%3A%3D+%26lt%3B-results%0A%09%09if+err+%3D%3D+nil+%7B%0A%09%09%09err+%3D+bc.Validator%28%29.ValidateBody%28block%29%0A%09%09%7D%0A%09%09switch+%7B%0A%09%09case+err+%3D%3D+ErrKnownBlock%3A%0A%09%09%09%2F%2F+Block+and+state+both+already+known.+However+if+the+current+block+is+below%0A%09%09%09%2F%2F+this+number+we+did+a+rollback+and+we+should+reimport+it+nonetheless.%0A%09%09%09if+bc.CurrentBlock%28%29.NumberU64%28%29+%26gt%3B%3D+block.NumberU64%28%29+%7B%0A%09%09%09%09stats.ignored%2B%2B%0A%09%09%09%09continue%0A%09%09%09%7D%0A%0A%0A%09%09case+err+%3D%3D+consensus.ErrFutureBlock%3A%0A%09%09%09%2F%2F+Allow+up+to+MaxFuture+second+in+the+future+blocks.+If+this+limit+is+exceeded%0A%09%09%09%2F%2F+the+chain+is+discarded+and+processed+at+a+later+time+if+given.%0A%09%09%09max+%3A%3D+big.NewInt%28time.Now%28%29.Unix%28%29+%2B+maxTimeFutureBlocks%29%0A%09%09%09if+block.Time%28%29.Cmp%28max%29+%26gt%3B+0+%7B%0A%09%09%09%09return+i%2C+events%2C+coalescedLogs%2C+fmt.Errorf%28%22future+block%3A+%25v+%26gt%3B+%25v%22%2C+block.Time%28%29%2C+max%29%0A%09%09%09%7D%0A%09%09%09bc.futureBlocks.Add%28block.Hash%28%29%2C+block%29%0A%09%09%09stats.queued%2B%2B%0A%09%09%09continue%0A%0A%0A%09%09case+err+%3D%3D+consensus.ErrUnknownAncestor+%26amp%3B%26amp%3B+bc.futureBlocks.Contains%28block.ParentHash%28%29%29%3A%0A%09%09%09bc.futureBlocks.Add%28block.Hash%28%29%2C+block%29%0A%09%09%09stats.queued%2B%2B%0A%09%09%09continue%0A%0A%0A%09%09case+err+%3D%3D+consensus.ErrPrunedAncestor%3A%0A%09%09%09%2F%2F+Block+competing+with+the+canonical+chain%2C+store+in+the+db%2C+but+don%27t+process%0A%09%09%09%2F%2F+until+the+competitor+TD+goes+above+the+canonical+TD%0A%09%09%09currentBlock+%3A%3D+bc.CurrentBlock%28%29%0A%09%09%09localTd+%3A%3D+bc.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%0A%09%09%09externTd+%3A%3D+new%28big.Int%29.Add%28bc.GetTd%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%2C+block.Difficulty%28%29%29%0A%09%09%09if+localTd.Cmp%28externTd%29+%26gt%3B+0+%7B%0A%09%09%09%09if+err+%3D+bc.WriteBlockWithoutState%28block%2C+externTd%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%09%09%7D%0A%09%09%09%09continue%0A%09%09%09%7D%0A%09%09%09%2F%2F+Competitor+chain+beat+canonical%2C+gather+all+blocks+from+the+common+ancestor%0A%09%09%09var+winner+%5B%5D*types.Block%0A%0A%0A%09%09%09parent+%3A%3D+bc.GetBlock%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%0A%09%09%09for+%21bc.HasState%28parent.Root%28%29%29+%7B%0A%09%09%09%09winner+%3D+append%28winner%2C+parent%29%0A%09%09%09%09parent+%3D+bc.GetBlock%28parent.ParentHash%28%29%2C+parent.NumberU64%28%29-1%29%0A%09%09%09%7D%0A%09%09%09for+j+%3A%3D+0%3B+j+%26lt%3B+len%28winner%29%2F2%3B+j%2B%2B+%7B%0A%09%09%09%09winner%5Bj%5D%2C+winner%5Blen%28winner%29-1-j%5D+%3D+winner%5Blen%28winner%29-1-j%5D%2C+winner%5Bj%5D%0A%09%09%09%7D%0A%09%09%09%2F%2F+Import+all+the+pruned+blocks+to+make+the+state+available%0A%09%09%09bc.chainmu.Unlock%28%29%0A%09%09%09_%2C+evs%2C+logs%2C+err+%3A%3D+bc.insertChain%28winner%29%0A%09%09%09bc.chainmu.Lock%28%29%0A%09%09%09events%2C+coalescedLogs+%3D+evs%2C+logs%0A%0A%0A%09%09%09if+err+%21%3D+nil+%7B%0A%09%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%09%7D%0A%0A%0A%09%09case+err+%21%3D+nil%3A%0A%09%09%09bc.reportBlock%28block%2C+nil%2C+err%29%0A%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%7D%0A%09%09%2F%2F+Create+a+new+statedb+using+the+parent+block+and+report+an%0A%09%09%2F%2F+error+if+it+fails.%0A%09%09var+parent+*types.Block%0A%09%09if+i+%3D%3D+0+%7B%0A%09%09%09parent+%3D+bc.GetBlock%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%0A%09%09%7D+else+%7B%0A%09%09%09parent+%3D+chain%5Bi-1%5D%0A%09%09%7D%0A%09%09state%2C+err+%3A%3D+state.New%28parent.Root%28%29%2C+bc.stateCache%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%7D%0A%09%09%2F%2F+Process+block+using+the+parent+state+as+reference+point.%0A%09%09receipts%2C+logs%2C+usedGas%2C+err+%3A%3D+bc.processor.Process%28block%2C+state%2C+bc.vmConfig%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09bc.reportBlock%28block%2C+receipts%2C+err%29%0A%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%7D%0A%09%09%2F%2F+Validate+the+state+using+the+default+validator%0A%09%09err+%3D+bc.Validator%28%29.ValidateState%28block%2C+parent%2C+state%2C+receipts%2C+usedGas%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09bc.reportBlock%28block%2C+receipts%2C+err%29%0A%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%7D%0A%09%09proctime+%3A%3D+time.Since%28bstart%29%0A%0A%0A%09%09%2F%2F+Write+the+block+to+the+chain+and+get+the+status.%0A%09%09status%2C+err+%3A%3D+bc.WriteBlockWithState%28block%2C+receipts%2C+state%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09return+i%2C+events%2C+coalescedLogs%2C+err%0A%09%09%7D%0A%09%09switch+status+%7B%0A%09%09case+CanonStatTy%3A%0A%09%09%09log.Debug%28%22Inserted+new+block%22%2C+%22number%22%2C+block.Number%28%29%2C+%22hash%22%2C+block.Hash%28%29%2C+%22uncles%22%2C+len%28block.Uncles%28%29%29%2C%0A%09%09%09%09%22txs%22%2C+len%28block.Transactions%28%29%29%2C+%22gas%22%2C+block.GasUsed%28%29%2C+%22elapsed%22%2C+common.PrettyDuration%28time.Since%28bstart%29%29%29%0A%0A%0A%09%09%09coalescedLogs+%3D+append%28coalescedLogs%2C+logs...%29%0A%09%09%09blockInsertTimer.UpdateSince%28bstart%29%0A%09%09%09events+%3D+append%28events%2C+ChainEvent%7Bblock%2C+block.Hash%28%29%2C+logs%7D%29%0A%09%09%09lastCanon+%3D+block%0A%0A%0A%09%09%09%2F%2F+Only+count+canonical+blocks+for+GC+processing+time%0A%09%09%09bc.gcproc+%2B%3D+proctime%0A%0A%0A%09%09case+SideStatTy%3A%0A%09%09%09log.Debug%28%22Inserted+forked+block%22%2C+%22number%22%2C+block.Number%28%29%2C+%22hash%22%2C+block.Hash%28%29%2C+%22diff%22%2C+block.Difficulty%28%29%2C+%22elapsed%22%2C%0A%09%09%09%09common.PrettyDuration%28time.Since%28bstart%29%29%2C+%22txs%22%2C+len%28block.Transactions%28%29%29%2C+%22gas%22%2C+block.GasUsed%28%29%2C+%22uncles%22%2C+len%28block.Uncles%28%29%29%29%0A%0A%0A%09%09%09blockInsertTimer.UpdateSince%28bstart%29%0A%09%09%09events+%3D+append%28events%2C+ChainSideEvent%7Bblock%7D%29%0A%09%09%7D%0A%09%09stats.processed%2B%2B%0A%09%09stats.usedGas+%2B%3D+usedGas%0A%09%09stats.report%28chain%2C+i%2C+bc.stateCache.TrieDB%28%29.Size%28%29%29%0A%09%7D%0A%09%2F%2F+Append+a+single+chain+head+event+if+we%27ve+progressed+the+chain%0A%09if+lastCanon+%21%3D+nil+%26amp%3B%26amp%3B+bc.CurrentBlock%28%29.Hash%28%29+%3D%3D+lastCanon.Hash%28%29+%7B%0A%09%09events+%3D+append%28events%2C+ChainHeadEvent%7BlastCanon%7D%29%0A%09%7D%0A%09return+0%2C+events%2C+coalescedLogs%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E1%EF%BC%8C%E9%A6%96%E5%85%88%E7%A1%AE%E4%BF%9D%E6%8F%92%E5%85%A5%E7%9A%84blocks%E6%98%AF%E5%AE%89%E6%AC%A1%E5%BA%8F%E6%8E%92%E5%88%97%E7%9A%84%0A++%3Cbr%3E2%EF%BC%8C%E8%B0%83%E7%94%A8%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8Ebc.engine.VerifyHeaders%EF%BC%8C%E9%AA%8C%E8%AF%81%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E8%BF%99%E4%BA%9Bheaders%E3%80%82%EF%BC%88%E5%85%B1%E8%AF%86%E9%AA%8C%E8%AF%81%E6%98%AF%E4%B8%AA%E5%A4%8D%E6%9D%82%E7%9A%84%E4%BA%8B%E6%83%85%EF%BC%8C%E5%9C%A8%E8%AE%B2%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6%E7%9A%84%E6%97%B6%E5%80%99%E5%86%8D%E5%88%86%E6%9E%90%EF%BC%89%0A++%3Cbr%3E3%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%85%B1%E8%AF%86%E9%AA%8C%E8%AF%81%E6%B2%A1%E6%9C%89%E9%97%AE%E9%A2%98%EF%BC%8C%E5%86%8D%E8%B0%83%E7%94%A8bc.Validator%28%29.ValidateBody%28block%29%E9%AA%8C%E8%AF%81block%E7%9A%84Body%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E5%8F%AA%E9%AA%8C%E8%AF%81block%E7%9A%84%E5%8F%94%E5%8C%BA%E5%9D%97hash%E5%92%8C%E5%8C%BA%E5%9D%97%E4%BA%A4%E6%98%93%E5%88%97%E8%A1%A8%E7%9A%84hash%E3%80%82%0A++%3Cbr%3E4%EF%BC%8C%E6%A0%B9%E6%8D%AEValidateBody%E9%AA%8C%E8%AF%81%E7%BB%93%E6%9E%9C%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E8%BF%98%E6%B2%A1%E6%9C%89%E6%8F%92%E5%85%A5%E6%9C%AC%E5%9C%B0%E7%9A%84%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%BD%86%E6%98%AF%E5%85%B6%E7%88%B6%E5%8C%BA%E5%9D%97%E5%9C%A8bc.futureBlocks%E5%B0%B1%E5%8A%A0%E5%85%A5bc.futureBlocks%E3%80%82%E5%A6%82%E6%9E%9C%E7%88%B6%E5%8C%BA%E5%9D%97%E6%98%AF%E6%9C%AC%E5%9C%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E7%8A%B6%E6%80%81%EF%BC%8C%E5%B0%B1%E9%80%92%E5%BD%92%E8%B0%83%E7%94%A8bc.insertChain%28winner%29%EF%BC%8C%E7%9B%B4%E5%88%B0%E6%9C%89%E7%8A%B6%E6%80%81%E6%89%8D%E6%8F%92%E5%85%A5%E3%80%82%0A++%3Cbr%3E5%EF%BC%8C%E8%8E%B7%E5%BE%97%E7%88%B6%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%8C%E8%B0%83%E7%94%A8processor.Process%EF%BC%88%EF%BC%89%E5%A4%84%E7%90%86block%E7%9A%84%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%2C%E5%B9%B6%E7%94%9F%E6%88%90%E6%94%B6%E6%8D%AE%2C%E6%97%A5%E5%BF%97%E7%AD%89%E4%BF%A1%E6%81%AF%EF%BC%8C%E4%BA%A7%E7%94%9F%E6%9C%AC%E5%8C%BA%E5%9D%97%E7%9A%84%E7%8A%B6%E6%80%81%E3%80%82Process%28%29%E6%96%B9%E6%B3%95%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%BA%86Block%E9%87%8C%E9%9D%A2%E5%8C%85%E5%90%AB%E7%9A%84%E7%9A%84%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%EF%BC%8C%E6%A0%B9%E6%8D%AE%E4%BA%A4%E6%98%93%E7%9A%84%E8%BF%87%E7%A8%8B%E5%92%8C%E7%BB%93%E6%9E%9C%E7%94%9F%E6%88%90%E6%89%80%E6%9C%89%E4%BA%A4%E6%98%93%E7%9A%84%E6%94%B6%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF%E3%80%82%EF%BC%88fast%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%E6%98%AF%E5%90%8C%E6%AD%A5%E8%BF%87%E6%9D%A5%E7%9A%84%EF%BC%8Cfull%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%98%AF%E6%9C%AC%E5%9C%B0%E9%87%8D%E7%8E%B0%E4%BA%86%E4%BA%A4%E6%98%93%E5%B9%B6%E7%94%9F%E6%88%90%E4%BA%86%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%EF%BC%89%0A++%3Cbr%3E6%EF%BC%8C%E8%B0%83%E7%94%A8bc.Validator%28%29.ValidateState%EF%BC%8C%E5%AF%B9%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8C%BA%E5%9D%97%E4%BA%A4%E6%98%93%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%EF%BC%8C%E5%92%8C%E6%B6%88%E8%B4%B9%E7%9A%84gas%E4%BA%8E%E6%94%B6%E5%88%B0%E7%9A%84block%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%AF%B9%E6%AF%94%E9%AA%8C%E8%AF%81%E3%80%82%E5%AF%B9%E6%AF%94%E6%B6%88%E8%B4%B9%E7%9A%84gas%E6%98%AF%E5%90%A6%E4%B8%80%E6%A0%B7%EF%BC%8C%E5%AF%B9%E6%AF%94bloom%E6%98%AF%E5%90%A6%E4%B8%80%E8%87%B4%EF%BC%8C%E6%A0%B9%E6%8D%AE%E6%94%B6%E6%8D%AE%E7%94%9F%E6%88%90hash%E6%98%AF%E5%90%A6%E4%B8%80%E8%87%B4%EF%BC%8C%E5%AF%B9%E6%AF%94header.root%E5%92%8CstateDb%E7%9A%84merkle%E6%A0%91%E7%9A%84%E6%A0%B9hash%E6%98%AF%E5%90%A6%E4%B8%80%E8%87%B4%E3%80%82%0A++%3Cbr%3E7%EF%BC%8C%E8%B0%83%E7%94%A8bc.WriteBlockWithState%28block%2C+receipts%2C+state%29%EF%BC%8C%E5%B0%86block%E5%86%99%E5%85%A5%E5%88%B0%E6%9C%AC%E5%9C%B0%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%EF%BC%8C%E5%B9%B6%E8%BF%94%E5%9B%9Estatus%E3%80%82%E6%A0%B9%E6%8D%AEstatus%E5%88%A4%E6%96%AD%E6%8F%92%E5%85%A5%E7%9A%84%E6%98%AF%E4%B8%BB%E9%93%BE%E8%BF%98%E6%98%AFside%E9%93%BE%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E4%B8%BB%E9%93%BEbc.gcproc%E9%9C%80%E8%A6%81%E5%8A%A0%E4%B8%8A%E9%AA%8C%E8%AF%81%E8%8A%B1%E8%B4%B9%E7%9A%84%E6%97%B6%E9%97%B4%E3%80%82%0A++%3Cbr%3E%0A++%3Cp%3E8%EF%BC%8C%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%97%A5%E5%BF%97%E4%BF%A1%E6%81%AF%EF%BC%8C%E7%94%A8%E4%BA%8E%E9%80%9A%E7%9F%A5%E7%BB%99%E8%AE%A2%E9%98%85%E4%BA%86%E5%8C%BA%E5%9D%97%E6%8F%92%E5%85%A5%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%AF%B9%E8%B1%A1%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E%E4%BA%94%2C+%26nbsp%3B%E5%86%8D%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8Bbc.WriteBlockWithState%E6%98%AF%E6%80%8E%E4%B9%88%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9A%3C%2Fh4%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+%28bc+*BlockChain%29+WriteBlockWithState%28block+*types.Block%2C+receipts+%5B%5D*types.Receipt%2C+state+*state.StateDB%29+%28status+WriteStatus%2C+err+error%29+%7B%0A%09bc.wg.Add%281%29%0A%09defer+bc.wg.Done%28%29%0A%0A%0A%09%2F%2F+Calculate+the+total+difficulty+of+the+block%0A%09ptd+%3A%3D+bc.GetTd%28block.ParentHash%28%29%2C+block.NumberU64%28%29-1%29%0A%09if+ptd+%3D%3D+nil+%7B%0A%09%09return+NonStatTy%2C+consensus.ErrUnknownAncestor%0A%09%7D%0A%09%2F%2F+Make+sure+no+inconsistent+state+is+leaked+during+insertion%0A%09bc.mu.Lock%28%29%0A%09defer+bc.mu.Unlock%28%29%0A%0A%0A%09currentBlock+%3A%3D+bc.CurrentBlock%28%29%0A%09localTd+%3A%3D+bc.GetTd%28currentBlock.Hash%28%29%2C+currentBlock.NumberU64%28%29%29%0A%09externTd+%3A%3D+new%28big.Int%29.Add%28block.Difficulty%28%29%2C+ptd%29%0A%0A%0A%09%2F%2F+Irrelevant+of+the+canonical+status%2C+write+the+block+itself+to+the+database%0A%09if+err+%3A%3D+bc.hc.WriteTd%28block.Hash%28%29%2C+block.NumberU64%28%29%2C+externTd%29%3B+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%09%2F%2F+Write+other+block+data+using+a+batch.%0A%09batch+%3A%3D+bc.db.NewBatch%28%29%0A%09if+err+%3A%3D+WriteBlock%28batch%2C+block%29%3B+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%09root%2C+err+%3A%3D+state.Commit%28bc.chainConfig.IsEIP158%28block.Number%28%29%29%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%09triedb+%3A%3D+bc.stateCache.TrieDB%28%29%0A%0A%0A%09%2F%2F+If+we%27re+running+an+archive+node%2C+always+flush%0A%09if+bc.cacheConfig.Disabled+%7B%0A%09%09if+err+%3A%3D+triedb.Commit%28root%2C+false%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+NonStatTy%2C+err%0A%09%09%7D%0A%09%7D+else+%7B%0A%09%09%2F%2F+Full+but+not+archive+node%2C+do+proper+garbage+collection%0A%09%09triedb.Reference%28root%2C+common.Hash%7B%7D%29+%2F%2F+metadata+reference+to+keep+trie+alive%0A%09%09bc.triegc.Push%28root%2C+-float32%28block.NumberU64%28%29%29%29%0A%0A%0A%09%09if+current+%3A%3D+block.NumberU64%28%29%3B+current+%26gt%3B+triesInMemory+%7B%0A%09%09%09%2F%2F+Find+the+next+state+trie+we+need+to+commit%0A%09%09%09header+%3A%3D+bc.GetHeaderByNumber%28current+-+triesInMemory%29%0A%09%09%09chosen+%3A%3D+header.Number.Uint64%28%29%0A%0A%0A%09%09%09%2F%2F+Only+write+to+disk+if+we+exceeded+our+memory+allowance+*and*+also+have+at%0A%09%09%09%2F%2F+least+a+given+number+of+tries+gapped.%0A%09%09%09var+%28%0A%09%09%09%09size++%3D+triedb.Size%28%29%0A%09%09%09%09limit+%3D+common.StorageSize%28bc.cacheConfig.TrieNodeLimit%29+*+1024+*+1024%0A%09%09%09%29%0A%09%09%09if+size+%26gt%3B+limit+%7C%7C+bc.gcproc+%26gt%3B+bc.cacheConfig.TrieTimeLimit+%7B%0A%09%09%09%09%2F%2F+If+we%27re+exceeding+limits+but+haven%27t+reached+a+large+enough+memory+gap%2C%0A%09%09%09%09%2F%2F+warn+the+user+that+the+system+is+becoming+unstable.%0A%09%09%09%09if+chosen+%26lt%3B+lastWrite%2BtriesInMemory+%7B%0A%09%09%09%09%09switch+%7B%0A%09%09%09%09%09case+size+%26gt%3B%3D+2*limit%3A%0A%09%09%09%09%09%09log.Warn%28%22State+memory+usage+too+high%2C+committing%22%2C+%22size%22%2C+size%2C+%22limit%22%2C+limit%2C+%22optimum%22%2C+float64%28chosen-lastWrite%29%2FtriesInMemory%29%0A%09%09%09%09%09case+bc.gcproc+%26gt%3B%3D+2*bc.cacheConfig.TrieTimeLimit%3A%0A%09%09%09%09%09%09log.Info%28%22State+in+memory+for+too+long%2C+committing%22%2C+%22time%22%2C+bc.gcproc%2C+%22allowance%22%2C+bc.cacheConfig.TrieTimeLimit%2C+%22optimum%22%2C+float64%28chosen-lastWrite%29%2FtriesInMemory%29%0A%09%09%09%09%09%7D%0A%09%09%09%09%7D%0A%09%09%09%09%2F%2F+If+optimum+or+critical+limits+reached%2C+write+to+disk%0A%09%09%09%09if+chosen+%26gt%3B%3D+lastWrite%2BtriesInMemory+%7C%7C+size+%26gt%3B%3D+2*limit+%7C%7C+bc.gcproc+%26gt%3B%3D+2*bc.cacheConfig.TrieTimeLimit+%7B%0A%09%09%09%09%09triedb.Commit%28header.Root%2C+true%29%0A%09%09%09%09%09lastWrite+%3D+chosen%0A%09%09%09%09%09bc.gcproc+%3D+0%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%09%2F%2F+Garbage+collect+anything+below+our+required+write+retention%0A%09%09%09for+%21bc.triegc.Empty%28%29+%7B%0A%09%09%09%09root%2C+number+%3A%3D+bc.triegc.Pop%28%29%0A%09%09%09%09if+uint64%28-number%29+%26gt%3B+chosen+%7B%0A%09%09%09%09%09bc.triegc.Push%28root%2C+number%29%0A%09%09%09%09%09break%0A%09%09%09%09%7D%0A%09%09%09%09triedb.Dereference%28root.%28common.Hash%29%2C+common.Hash%7B%7D%29%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%09if+err+%3A%3D+WriteBlockReceipts%28batch%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+receipts%29%3B+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%09%2F%2F+If+the+total+difficulty+is+higher+than+our+known%2C+add+it+to+the+canonical+chain%0A%09%2F%2F+Second+clause+in+the+if+statement+reduces+the+vulnerability+to+selfish+mining.%0A%09%2F%2F+Please+refer+to+http%3A%2F%2Fwww.cs.cornell.edu%2F%7Eie53%2Fpublications%2FbtcProcFC.pdf%0A%09reorg+%3A%3D+externTd.Cmp%28localTd%29+%26gt%3B+0%0A%09currentBlock+%3D+bc.CurrentBlock%28%29%0A%09if+%21reorg+%26amp%3B%26amp%3B+externTd.Cmp%28localTd%29+%3D%3D+0+%7B%0A%09%09%2F%2F+Split+same-difficulty+blocks+by+number%2C+then+at+random%0A%09%09reorg+%3D+block.NumberU64%28%29+%26lt%3B+currentBlock.NumberU64%28%29+%7C%7C+%28block.NumberU64%28%29+%3D%3D+currentBlock.NumberU64%28%29+%26amp%3B%26amp%3B+mrand.Float64%28%29+%26lt%3B+0.5%29%0A%09%7D%0A%09if+reorg+%7B%0A%09%09%2F%2F+Reorganise+the+chain+if+the+parent+is+not+the+head+block%0A%09%09if+block.ParentHash%28%29+%21%3D+currentBlock.Hash%28%29+%7B%0A%09%09%09if+err+%3A%3D+bc.reorg%28currentBlock%2C+block%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09return+NonStatTy%2C+err%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+Write+the+positional+metadata+for+transaction+and+receipt+lookups%0A%09%09if+err+%3A%3D+WriteTxLookupEntries%28batch%2C+block%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+NonStatTy%2C+err%0A%09%09%7D%0A%09%09%2F%2F+Write+hash+preimages%0A%09%09if+err+%3A%3D+WritePreimages%28bc.db%2C+block.NumberU64%28%29%2C+state.Preimages%28%29%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+NonStatTy%2C+err%0A%09%09%7D%0A%09%09status+%3D+CanonStatTy%0A%09%7D+else+%7B%0A%09%09status+%3D+SideStatTy%0A%09%7D%0A%09if+err+%3A%3D+batch.Write%28%29%3B+err+%21%3D+nil+%7B%0A%09%09return+NonStatTy%2C+err%0A%09%7D%0A%0A%0A%09%2F%2F+Set+new+head.%0A%09if+status+%3D%3D+CanonStatTy+%7B%0A%09%09bc.insert%28block%29%0A%09%7D%0A%09bc.futureBlocks.Remove%28block.Hash%28%29%29%0A%09return+status%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E1%EF%BC%8C%E4%BB%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%88%B0parent%E7%9A%84td%E3%80%82%E5%8A%A0%E4%B8%8Ablock+%E7%9A%84difficulty%EF%BC%8C%E8%AE%A1%E7%AE%97%E6%96%B0%E7%9A%84total+difficulty%E5%80%BC%EF%BC%8C%E5%B9%B6%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%0A++%3Cbr%3E2%EF%BC%8C%E8%B0%83%E7%94%A8WriteBlock%28batch%2C+block%29+%E6%8A%8Ablock%E7%9A%84body%E5%92%8Cheader%E9%83%BD%E5%86%99%E5%88%B0%E6%95%B0%E6%8D%AE%E5%BA%93%0A++%3Cbr%3E3%EF%BC%8C%E8%B0%83%E7%94%A8state.Commit%28bc.chainConfig.IsEIP158%28block.Number%28%29%29%29%E6%8A%8A%E7%8A%B6%E6%80%81%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B9%B6%E8%8E%B7%E5%8F%96%E5%88%B0%E7%8A%B6%E6%80%81root%E3%80%82%0A++%3Cbr%3E4%EF%BC%8C%E6%8C%89%E8%A7%84%E5%88%99%E5%A4%84%E7%90%86bc.stateCache%E7%BC%93%E5%AD%98%EF%BC%8C%E5%B9%B6%E6%B8%85%E7%90%86%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%0A++%3Cbr%3E5%EF%BC%8C%E8%B0%83%E7%94%A8WriteBlockReceipts%EF%BC%8C%E6%8A%8A%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A++%3Cbr%3E6%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%8F%91%E7%8E%B0block%E7%9A%84%E7%88%B6%E5%8C%BA%E5%9D%97%E4%B8%8D%E6%98%AF%E6%9C%AC%E5%9C%B0%E5%BD%93%E5%89%8D%E6%9C%80%E6%96%B0%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%B0%83%E7%94%A8bc.reorg%28currentBlock%2C+block%29%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%96%B0%E5%8C%BA%E5%9D%97%E6%AF%94%E8%80%81%E5%8C%BA%E5%9D%97td%E9%AB%98%EF%BC%8C%E5%88%99%E6%8A%8A%E9%AB%98%E5%87%BA%E6%9D%A5%E7%9A%84%E5%8C%BA%E5%9D%97%E4%B8%80%E4%B8%80insert%E8%BF%9BblockChain%E3%80%82%0A++%3Cbr%3E7%EF%BC%8C%E8%B0%83%E7%94%A8WriteTxLookupEntries%EF%BC%8C%E6%A0%B9%E6%8D%AE%E4%BA%A4%E6%98%93hash%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%B4%A2%E5%BC%95%E3%80%82%E8%B0%83%E7%94%A8WritePreimages%EF%BC%8C%E6%8A%8APreimages%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8CPreimages%E5%9C%A8evm%E6%89%A7%E8%A1%8Csha3%E6%8C%87%E4%BB%A4%E6%97%B6%E4%BA%A7%E7%94%9F%E3%80%82%0A++%3Cbr%3E%0A++%3Cp%3E8%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%96%B0%E7%9A%84td%E5%A4%A7%E4%BA%8E%E6%88%96%E7%AD%89%E4%BA%8E%E6%9C%AC%E5%9C%B0td%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%98%AF%E4%B8%BB%E9%93%BE%E5%8C%BA%E5%9D%97%EF%BC%8C%E8%B0%83%E7%94%A8bc.insert%28block%29%EF%BC%8C%E6%9B%B4%E6%96%B0blockChain%E7%9A%84currentBlock%EF%BC%8CcurrentHeader%EF%BC%8CcurrentFastBolck%E7%AD%89%E4%BF%A1%E6%81%AF%E3%80%82%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E4%B8%BB%E9%93%BE%E5%8C%BA%E5%9D%97%E5%88%99%E4%B8%8D%E4%BC%9A%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Ch4%3E%E5%85%AD%EF%BC%8C%E5%9C%A8%E5%88%86%E6%9E%90Downloader%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%AA%E6%9C%89full%E6%A8%A1%E5%BC%8F%E6%89%8D%E4%BC%9A%E8%B0%83%E7%94%A8InsertChain%28%29%E6%96%B9%E6%B3%95%EF%BC%8C%E8%80%8Cfast%E6%A8%A1%E5%BC%8F%E6%98%AFInsertReceiptChain%28%29%E6%96%B9%E6%B3%95%E3%80%82%E6%88%91%E4%BB%AC%E6%9D%A5%E7%9C%8B%E7%9C%8BInsertReceiptChain%28%29%E6%96%B9%E6%B3%95%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%8C%E5%AE%83%E5%92%8CInsertChain%28%29%E6%96%B9%E6%B3%95%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%E3%80%82%3C%2Fh4%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Efunc+%28bc+*BlockChain%29+InsertReceiptChain%28blockChain+types.Blocks%2C+receiptChain+%5B%5Dtypes.Receipts%29+%28int%2C+error%29+%7B%0A%09bc.wg.Add%281%29%0A%09defer+bc.wg.Done%28%29%0A%0A%0A%09%2F%2F+Do+a+sanity+check+that+the+provided+chain+is+actually+ordered+and+linked%0A%09for+i+%3A%3D+1%3B+i+%26lt%3B+len%28blockChain%29%3B+i%2B%2B+%7B%0A%09%09if+blockChain%5Bi%5D.NumberU64%28%29+%21%3D+blockChain%5Bi-1%5D.NumberU64%28%29%2B1+%7C%7C+blockChain%5Bi%5D.ParentHash%28%29+%21%3D+blockChain%5Bi-1%5D.Hash%28%29+%7B%0A%09%09%09log.Error%28%22Non+contiguous+receipt+insert%22%2C+%22number%22%2C+blockChain%5Bi%5D.Number%28%29%2C+%22hash%22%2C+blockChain%5Bi%5D.Hash%28%29%2C+%22parent%22%2C+blockChain%5Bi%5D.ParentHash%28%29%2C%0A%09%09%09%09%22prevnumber%22%2C+blockChain%5Bi-1%5D.Number%28%29%2C+%22prevhash%22%2C+blockChain%5Bi-1%5D.Hash%28%29%29%0A%09%09%09return+0%2C+fmt.Errorf%28%22non+contiguous+insert%3A+item+%25d+is+%23%25d+%5B%25x%E2%80%A6%5D%2C+item+%25d+is+%23%25d+%5B%25x%E2%80%A6%5D+%28parent+%5B%25x%E2%80%A6%5D%29%22%2C+i-1%2C+blockChain%5Bi-1%5D.NumberU64%28%29%2C%0A%09%09%09%09blockChain%5Bi-1%5D.Hash%28%29.Bytes%28%29%5B%3A4%5D%2C+i%2C+blockChain%5Bi%5D.NumberU64%28%29%2C+blockChain%5Bi%5D.Hash%28%29.Bytes%28%29%5B%3A4%5D%2C+blockChain%5Bi%5D.ParentHash%28%29.Bytes%28%29%5B%3A4%5D%29%0A%09%09%7D%0A%09%7D%0A%0A%0A%09var+%28%0A%09%09stats+%3D+struct%7B+processed%2C+ignored+int32+%7D%7B%7D%0A%09%09start+%3D+time.Now%28%29%0A%09%09bytes+%3D+0%0A%09%09batch+%3D+bc.db.NewBatch%28%29%0A%09%29%0A%09for+i%2C+block+%3A%3D+range+blockChain+%7B%0A%09%09receipts+%3A%3D+receiptChain%5Bi%5D%0A%09%09%2F%2F+Short+circuit+insertion+if+shutting+down+or+processing+failed%0A%09%09if+atomic.LoadInt32%28%26amp%3Bbc.procInterrupt%29+%3D%3D+1+%7B%0A%09%09%09return+0%2C+nil%0A%09%09%7D%0A%09%09%2F%2F+Short+circuit+if+the+owner+header+is+unknown%0A%09%09if+%21bc.HasHeader%28block.Hash%28%29%2C+block.NumberU64%28%29%29+%7B%0A%09%09%09return+i%2C+fmt.Errorf%28%22containing+header+%23%25d+%5B%25x%E2%80%A6%5D+unknown%22%2C+block.Number%28%29%2C+block.Hash%28%29.Bytes%28%29%5B%3A4%5D%29%0A%09%09%7D%0A%09%09%2F%2F+Skip+if+the+entire+data+is+already+known%0A%09%09if+bc.HasBlock%28block.Hash%28%29%2C+block.NumberU64%28%29%29+%7B%0A%09%09%09stats.ignored%2B%2B%0A%09%09%09continue%0A%09%09%7D%0A%09%09%2F%2F+Compute+all+the+non-consensus+fields+of+the+receipts%0A%09%09SetReceiptsData%28bc.chainConfig%2C+block%2C+receipts%29%0A%09%09%2F%2F+Write+all+the+data+out+into+the+database%0A%09%09if+err+%3A%3D+WriteBody%28batch%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+block.Body%28%29%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+i%2C+fmt.Errorf%28%22failed+to+write+block+body%3A+%25v%22%2C+err%29%0A%09%09%7D%0A%09%09if+err+%3A%3D+WriteBlockReceipts%28batch%2C+block.Hash%28%29%2C+block.NumberU64%28%29%2C+receipts%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+i%2C+fmt.Errorf%28%22failed+to+write+block+receipts%3A+%25v%22%2C+err%29%0A%09%09%7D%0A%09%09if+err+%3A%3D+WriteTxLookupEntries%28batch%2C+block%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+i%2C+fmt.Errorf%28%22failed+to+write+lookup+metadata%3A+%25v%22%2C+err%29%0A%09%09%7D%0A%09%09stats.processed%2B%2B%0A%0A%0A%09%09if+batch.ValueSize%28%29+%26gt%3B%3D+ethdb.IdealBatchSize+%7B%0A%09%09%09if+err+%3A%3D+batch.Write%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09return+0%2C+err%0A%09%09%09%7D%0A%09%09%09bytes+%2B%3D+batch.ValueSize%28%29%0A%09%09%09batch.Reset%28%29%0A%09%09%7D%0A%09%7D%0A%09if+batch.ValueSize%28%29+%26gt%3B+0+%7B%0A%09%09bytes+%2B%3D+batch.ValueSize%28%29%0A%09%09if+err+%3A%3D+batch.Write%28%29%3B+err+%21%3D+nil+%7B%0A%09%09%09return+0%2C+err%0A%09%09%7D%0A%09%7D%0A%0A%0A%09%2F%2F+Update+the+head+fast+sync+block+if+better%0A%09bc.mu.Lock%28%29%0A%09head+%3A%3D+blockChain%5Blen%28blockChain%29-1%5D%0A%09if+td+%3A%3D+bc.GetTd%28head.Hash%28%29%2C+head.NumberU64%28%29%29%3B+td+%21%3D+nil+%7B+%2F%2F+Rewind+may+have+occurred%2C+skip+in+that+case%0A%09%09currentFastBlock+%3A%3D+bc.CurrentFastBlock%28%29%0A%09%09if+bc.GetTd%28currentFastBlock.Hash%28%29%2C+currentFastBlock.NumberU64%28%29%29.Cmp%28td%29+%26lt%3B+0+%7B%0A%09%09%09if+err+%3A%3D+WriteHeadFastBlockHash%28bc.db%2C+head.Hash%28%29%29%3B+err+%21%3D+nil+%7B%0A%09%09%09%09log.Crit%28%22Failed+to+update+head+fast+block+hash%22%2C+%22err%22%2C+err%29%0A%09%09%09%7D%0A%09%09%09bc.currentFastBlock.Store%28head%29%0A%09%09%7D%0A%09%7D%0A%09bc.mu.Unlock%28%29%0A%0A%0A%09log.Info%28%22Imported+new+block+receipts%22%2C%0A%09%09%22count%22%2C+stats.processed%2C%0A%09%09%22elapsed%22%2C+common.PrettyDuration%28time.Since%28start%29%29%2C%0A%09%09%22number%22%2C+head.Number%28%29%2C%0A%09%09%22hash%22%2C+head.Hash%28%29%2C%0A%09%09%22size%22%2C+common.StorageSize%28bytes%29%2C%0A%09%09%22ignored%22%2C+stats.ignored%29%0A%09return+0%2C+nil%0A%7D%3C%2Fcode%3E%3C%2Fpre%3E1%EF%BC%8C%E9%A6%96%E5%85%88%E7%A1%AE%E4%BF%9D%E6%8F%92%E5%85%A5%E7%9A%84blocks%E6%98%AF%E5%AE%89%E6%AC%A1%E5%BA%8F%E6%8E%92%E5%88%97%E7%9A%84%0A++%3Cbr%3E2%EF%BC%8C%E8%B0%83%E7%94%A8SetReceiptsData%28bc.chainConfig%2C+block%2C+receipts%29%E6%8A%8A%E6%94%B6%E5%88%B0%E7%9A%84%E4%BA%A4%E6%98%93%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%85%A5%E5%88%B0block%E4%B8%AD%0A++%3Cbr%3E3%EF%BC%8C%E8%B0%83%E7%94%A8WriteBody%28%29%EF%BC%8C%E6%8A%8Ablockbody%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A++%3Cbr%3E4%EF%BC%8C%E8%B0%83%E7%94%A8WriteBlockReceipts%28%29%EF%BC%8C%E6%8A%8A%E6%94%B6%E6%8D%AE%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%0A++%3Cbr%3E5%EF%BC%8C%E8%B0%83%E7%94%A8WriteTxLookupEntries%EF%BC%8C%E6%A0%B9%E6%8D%AE%E4%BA%A4%E6%98%93hash%E5%BB%BA%E7%AB%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%B4%A2%E5%BC%95%E3%80%82%0A++%3Cbr%3E6%EF%BC%8C%E6%9B%B4%E6%96%B0BlockChain%E7%9A%84currentFastBlock%E4%BF%A1%E6%81%AF%0A++%3Cbr%3E%0A++%3Cbr%3E%0A++%3Ch4%3E%E6%80%BB%E7%BB%93%3C%2Fh4%3EBlockChain%E6%A8%A1%E5%9D%97%E7%9A%84%E4%BB%A3%E7%A0%81%E4%B8%8D%E5%A4%9A%EF%BC%8C%E9%80%BB%E8%BE%91%E4%B9%9F%E4%B8%8D%E5%A4%8D%E6%9D%82%EF%BC%8C%E4%B8%8D%E5%83%8FDownloader%E5%92%8CFetcher+%E9%82%A3%E6%A0%B7%E4%B8%80%E5%A0%86goroutine%E6%BB%A1%E5%A4%A9%E9%A3%9E%EF%BC%8C%E5%BE%88%E5%A5%BD%E8%AF%BB%E3%80%82BlockChain%E6%A8%A1%E5%9D%97%E6%98%AF%E4%BB%A5%E5%A4%AA%E5%9D%8A%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E7%9A%84%E5%A4%A7%E9%9B%86%E5%90%88%EF%BC%8C%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E9%83%BD%E5%9C%A8%E8%BF%99%E9%87%8C%E6%B1%87%E9%9B%86%EF%BC%8C%E5%B9%B6%E5%9C%A8%E8%BF%99%E9%87%8C%E5%AF%B9%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E6%A0%A1%E9%AA%8C%EF%BC%8C%E6%8A%8A%E7%BB%93%E6%9E%9C%E5%86%99%E5%85%A5%E6%95%B0%E6%8D%AE%E5%BA%93%E3%80%82%E8%BF%99%E4%B8%AA%E6%A8%A1%E5%9D%97%E6%9C%80%E9%87%8D%E8%A6%81%E7%9A%84%E6%98%AF%E8%A6%81%E5%8C%BA%E5%88%86Full%E6%A8%A1%E5%BC%8F%E5%90%8C%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E5%92%8CFast%E6%A8%A1%E5%BC%8F%E5%A4%84%E7%90%86%E7%9A%84%E5%8C%BA%E5%88%AB%E3%80%82%E6%88%91%E4%BB%AC%E5%8F%91%E7%8E%B0Fast%E6%A8%A1%E5%BC%8F%E6%8A%8A%E6%9C%80%E8%80%97%E6%97%B6%E7%9A%84%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81%E5%92%8C%E4%BA%A4%E6%98%93%E5%9B%9E%E6%94%BE%E9%83%BD%E8%B7%B3%E8%BF%87%E4%BA%86%EF%BC%8C%E5%A4%A7%E5%A4%A7%E7%9A%84%E7%BC%A9%E5%87%8F%E4%BA%86%E5%90%8C%E6%AD%A5%E7%9A%84%E6%97%B6%E9%97%B4%EF%BC%8C%E5%90%8C%E6%97%B6%E4%B9%9F%E8%8A%82%E7%BA%A6%E4%BA%86%E8%AE%A1%E7%AE%97%E7%9A%84%E8%83%BD%E6%BA%90%E6%B6%88%E8%80%97%E3%80%82+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcj2094%2Farticle%2Fdetails%2F80258115%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcj2094%2Farticle%2Fdetails%2F80258115%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A+%3Ca+class%3D%22btn%22+href%3D%22https%3A%2F%2Fpassport.csdn.net%2Faccount%2Flogin%3Futm_source%3Dcsdn_blog_pc_more_login%22+target%3D%22_self%22+id%3D%22btn-lobinreadmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_557%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcj2094%2Farticle%2Fdetails%2F80258115%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_557%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fcj2094%2Farticle%2Fdetails%2F80258115%2C%26quot%3B%7D%22%3E%E7%99%BB%E5%BD%95%E5%90%8E%E8%87%AA%E5%8A%A8%E5%B1%95%E5%BC%80%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}