---
layout: default
title: 以太坊区块交易，虚拟机，合约源码分析视频教程
---

{{ "%3Cdiv+id%3D%22article_content%22+class%3D%22article_content+clearfix+csdn-tracking-statistics%22+data-pid%3D%22blog%22+data-mod%3D%22popu_307%22+data-dsm%3D%22post%22%3E+%0A+%3Clink+rel%3D%22stylesheet%22+href%3D%22https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fphoenix%2Ftemplate%2Fcss%2Fck_htmledit_views-e2445db1a8.css%22%3E+%0A+%3Cdiv+class%3D%22htmledit_views%22%3E+%0A++%3Cp%3E%3Ca+href%3D%22http%3A%2F%2Fv.youku.com%2Fv_show%2Fid_XMzYwOTUwNjYwMA%3D%3D.html%22+rel%3D%22nofollow%22%3E%E4%BA%A4%E6%98%93%EF%BC%8C%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%90%88%E7%BA%A6%EF%BC%8Cevm%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8A%3C%2Fa%3E%3C%2Fp%3E%0A++%3Cp%3E%3Ca+href%3D%22http%3A%2F%2Fv.youku.com%2Fv_show%2Fid_XMzYwOTUyODIwOA%3D%3D.html%22+rel%3D%22nofollow%22%3E%E4%BA%A4%E6%98%93%EF%BC%8C%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%90%88%E7%BA%A6%EF%BC%8Cevm%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%AD%3C%2Fa%3E%3C%2Fp%3E%0A++%3Cp%3E%3Ca+href%3D%22http%3A%2F%2Fv.youku.com%2Fv_show%2Fid_XMzYwOTk0MTk2OA%3D%3D.html%22+rel%3D%22nofollow%22%3E%E4%BA%A4%E6%98%93%EF%BC%8C%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%90%88%E7%BA%A6%EF%BC%8Cevm%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%8B%3C%2Fa%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E8%83%BD%E5%AD%A6%E5%88%B0%E4%BB%80%E4%B9%88%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E1.%E8%B0%81%E5%8F%91%E8%B5%B7%E4%BA%86%E4%BA%A4%E6%98%93%3F%3C%2Fp%3E%0A++%3Cp%3Eblockchain.go%E9%87%8C%E7%9A%84insertChain%28%3Cspan+style%3D%22font-size%3A12px%3Bfont-style%3Aitalic%3B%22%3E%E6%96%B9%E6%B3%95%E4%BC%9A%E6%89%A7%E8%A1%8C%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8F%92%E5%85%A5%2C%E5%B9%B6%E6%94%B6%E9%9B%86%E4%BA%8B%E4%BB%B6%E4%BF%A1%E6%81%AF%3C%2Fspan%3E%29%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E2%E4%BA%A4%E6%98%93%E6%9C%89%E5%93%AA%E4%BA%9B%E7%A7%8D%3F%E4%BA%A4%E6%98%93%E5%9C%A8%E5%93%AA%E9%87%8C%E6%89%A7%E8%A1%8C%3F%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E4%B8%80%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%A4%96%EF%BC%8C%3Cspan+style%3D%22font-family%3AHelvetica%2C+%27Hiragino+Sans+GB%27%2C+%27%E5%BE%AE%E8%BD%AF%E9%9B%85%E9%BB%91%27%2C+%27Microsoft+YaHei+UI%27%2C+SimSun%2C+SimHei%2C+arial%2C+sans-serif%3Bfont-size%3A14px%3Bcolor%3A%23000000%3Bfont-style%3Anormal%3Bfont-variant%3Anormal%3Bfont-weight%3Anormal%3Bletter-spacing%3Anormal%3Bline-height%3A25.6px%3Btext-indent%3A0px%3Btext-transform%3Anone%3Bword-spacing%3A0px%3B%22%3E%E6%89%A7%E8%A1%8C%E5%89%8D%E5%B0%86Transaction%E7%B1%BB%E5%9E%8B%E8%BD%AC%E5%8C%96%E6%88%90Message%3C%2Fspan%3E%EF%BC%8C%E5%88%9B%E5%BB%BAevm%E8%99%9A%E6%8B%9F%E6%9C%BA%EF%BC%8C%E8%AE%A1%E7%AE%97%E4%BA%A4%E6%98%93gas%E3%80%82%E8%BF%94%E5%9B%9E%E4%BA%A4%E6%98%93%E6%94%B6%E6%8D%AE%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3Cbr%3E%E4%BA%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%86%85%EF%BC%8C%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%EF%BC%8C%E5%88%9B%E5%BB%BA%E5%90%88%E7%BA%A6%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%90%88%E7%BA%A6%E6%8C%87%E4%BB%A4%E3%80%82%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E3%E5%8C%BA%E5%9D%97%E7%9A%84%E7%BB%93%E6%9E%84%E6%98%AF%E4%BB%80%E4%B9%88%E6%A0%B7%E5%AD%90%E7%9A%84%3F%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%E5%8F%82%E8%80%83%E6%BA%90%E7%A0%81%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E4%E6%80%8E%E6%A0%B7%E6%89%93%E5%8C%85%E5%8C%BA%E5%9D%97%E5%86%99%E5%85%A5%E5%8C%BA%E5%9D%97%E9%93%BE%E6%95%B0%E6%8D%AE%E5%BA%93%3C%2Fp%3E%0A++%3Cp%3E%3Cbr%3E%E6%8C%96%E7%9F%BF%E6%89%93%E5%8C%85%E5%8F%82%E7%9C%8B%E6%BA%90%E7%A0%81%3C%2Fp%3E%0A++%3Cp%3E5%E5%90%88%E7%BA%A6%E6%80%8E%E6%A0%B7%E6%89%A7%E8%A1%8C%3F%3C%2Fp%3E%0A++%3Cp%3E%E4%B8%80%E7%BC%96%E8%AF%91%E5%90%8E%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C%EF%BC%8C%E6%9C%89%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%3Cspan+style%3D%22color%3A%23808080%3B%22%3E%3Cspan+style%3D%22color%3A%23000000%3B%22%3E%E8%AE%A1%E7%AE%97gas%E6%B6%88%E8%80%97%EF%BC%8C%E8%BF%90%E8%A1%8C%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%E5%90%88%E7%BA%A6%3C%2Fspan%3E%3C%2Fspan%3E%3C%2Fp%3E%0A++%3Cp%3E%E4%BA%8C%E9%80%9A%E8%BF%87%E8%A7%A3%E9%87%8A%E5%99%A8%E8%BF%90%E8%A1%8C%E5%90%88%E7%BA%A6%EF%BC%8C%E8%A7%A3%E9%87%8A%E5%99%A8%E6%9C%894%E4%B8%AA%E5%87%BD%E6%95%B0%EF%BC%8C%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AE%A1%E7%AE%97gas%E6%B6%88%E8%80%97%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AE%A1%E7%AE%97%E5%A0%86%E6%A0%88%E5%A4%A7%E5%B0%8F%E5%87%BD%E6%95%B0%EF%BC%8C%E8%AE%A1%E7%AE%97%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F%E5%87%BD%E6%95%B0%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E4%BB%80%E4%B9%88%E6%98%AF%E5%8C%BA%E5%9D%97%EF%BC%8C%E5%8C%BA%E5%9D%97%E9%93%BE%3F%3C%2Fp%3E%0A++%3Cp%3E%E5%8C%BA%E5%9D%97%E6%98%AF%E4%B8%80%E4%B8%AA%E7%BB%93%E6%9E%84%E4%BD%93%EF%BC%8C%E5%9C%A8%E4%BB%A5%E5%A4%AA%E5%9D%8A%E9%87%8C%E5%8C%85%E5%90%AB%E5%8C%BA%E5%9D%97%E5%A4%B4%EF%BC%8C%E5%8F%94%E5%9D%97%E5%A4%B4%EF%BC%8C%E4%BA%A4%E6%98%93%E5%88%97%E8%A1%A8%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fimg-blog.csdn.net%2F20180516214736127%22+alt%3D%22%22%3E%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fimg-blog.csdn.net%2F20180516214813840%22+alt%3D%22%22%3E%3C%2Fp%3E%0A++%3Cp%3E%3Cimg+src%3D%22https%3A%2F%2Fimg-blog.csdn.net%2F20180516214823454%22+alt%3D%22%22%3E%3Cbr%3E%3C%2Fp%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3Epackage+core%0A%0Aimport+%28%0A%09%22math%2Fbig%22%0A%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcommon%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fconsensus%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcore%2Ftypes%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcore%2Fvm%22%0A%29%0A%2F%2F+ChainContext%E6%94%AF%E6%8C%81%E4%BB%8E%E4%BA%A4%E6%98%93%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84%E5%BD%93%E5%89%8D%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E6%A3%80%E7%B4%A2%E6%A0%87%E9%A2%98%E5%92%8C%E5%85%B1%E8%AF%86%E5%8F%82%E6%95%B0%E3%80%82%0A%2F%2F+ChainContext+supports+retrieving+headers+and+consensus+parameters+from+the%0A%2F%2F+current+blockchain+to+be+used+during+transaction+processing.%0Atype+ChainContext+interface+%7B%0A%09%2F%2F%E5%BC%95%E6%93%8E%E6%A3%80%E7%B4%A2%E9%93%BE%E7%9A%84%E5%85%B1%E8%AF%86%E5%BC%95%E6%93%8E%E3%80%82%0A%09%2F%2F+Engine+retrieves+the+chain%27s+consensus+engine.%0A%09Engine%28%29+consensus.Engine%0A%09%2F%2F+GetHeader%E8%BF%94%E5%9B%9E%E4%B8%8E%E5%AE%83%E4%BB%AC%E7%9A%84%E5%93%88%E5%B8%8C%E5%AF%B9%E5%BA%94%E7%9A%84%E5%93%88%E5%B8%8C%E3%80%82%0A%09%2F%2F+GetHeader+returns+the+hash+corresponding+to+their+hash.%0A%09GetHeader%28common.Hash%2C+uint64%29+*types.Header%0A%7D%0A%2F%2F+NewEVMContext%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E4%BB%A5%E7%94%A8%E4%BA%8EEVM%E3%80%82%0A%2F%2F+NewEVMContext+creates+a+new+context+for+use+in+the+EVM.%0Afunc+NewEVMContext%28msg+Message%2C+header+*types.Header%2C+chain+ChainContext%2C+author+*common.Address%29+vm.Context+%7B%0A%09%2F%2F+If+we+don%27t+have+an+explicit+author+%28i.e.+not+mining%29%2C+extract+from+the+header%0A%09%2F%2F%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E6%B2%A1%E6%9C%89%E6%98%8E%E7%A1%AE%E7%9A%84%E4%BD%9C%E8%80%85%EF%BC%88%E5%8D%B3%E4%B8%8D%E6%98%AF%E6%8C%96%E6%8E%98%EF%BC%89%EF%BC%8C%E8%AF%B7%E4%BB%8E%E6%A0%87%E9%A2%98%E4%B8%AD%E6%8F%90%E5%8F%96%0A%09var+beneficiary+common.Address%0A%09if+author+%3D%3D+nil+%7B%0A%09%09beneficiary%2C+_+%3D+chain.Engine%28%29.Author%28header%29+%2F%2F+Ignore+error%2C+we%27re+past+header+validation%0A%09%7D+else+%7B%0A%09%09beneficiary+%3D+*author%0A%09%7D%0A%09return+vm.Context%7B%0A%09%09CanTransfer%3A+CanTransfer%2C%0A%09%09Transfer%3A++++Transfer%2C%0A%09%09GetHash%3A+++++GetHashFn%28header%2C+chain%29%2C%0A%09%09Origin%3A++++++msg.From%28%29%2C%0A%09%09Coinbase%3A++++beneficiary%2C%0A%09%09BlockNumber%3A+new%28big.Int%29.Set%28header.Number%29%2C%0A%09%09Time%3A++++++++new%28big.Int%29.Set%28header.Time%29%2C%0A%09%09Difficulty%3A++new%28big.Int%29.Set%28header.Difficulty%29%2C%0A%09%09GasLimit%3A++++header.GasLimit%2C%0A%09%09GasPrice%3A++++new%28big.Int%29.Set%28msg.GasPrice%28%29%29%2C%0A%09%7D%0A%7D%0A%2F%2F+GetHashFn%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AAGetHashFunc%EF%BC%8C%E5%AE%83%E9%80%9A%E8%BF%87%E6%95%B0%E5%AD%97%E6%9D%A5%E6%A3%80%E7%B4%A2%E5%A4%B4%E9%83%A8%E5%93%88%E5%B8%8C%E5%80%BC%0A%2F%2F+GetHashFn+returns+a+GetHashFunc+which+retrieves+header+hashes+by+number%0Afunc+GetHashFn%28ref+*types.Header%2C+chain+ChainContext%29+func%28n+uint64%29+common.Hash+%7B%0A%09return+func%28n+uint64%29+common.Hash+%7B%0A%09%09for+header+%3A%3D+chain.GetHeader%28ref.ParentHash%2C+ref.Number.Uint64%28%29-1%29%3B+header+%21%3D+nil%3B+header+%3D+chain.GetHeader%28header.ParentHash%2C+header.Number.Uint64%28%29-1%29+%7B%0A%09%09%09if+header.Number.Uint64%28%29+%3D%3D+n+%7B%0A%09%09%09%09return+header.Hash%28%29%0A%09%09%09%7D%0A%09%09%7D%0A%0A%09%09return+common.Hash%7B%7D%0A%09%7D%0A%7D%0A%2F%2F%E5%8F%AF%E4%BB%A5%E8%BD%AC%E8%B4%A6%E6%A3%80%E6%9F%A5%E5%9C%B0%E5%9D%80%E5%B8%90%E6%88%B7%E4%B8%AD%E6%98%AF%E5%90%A6%E6%9C%89%E8%B6%B3%E5%A4%9F%E7%9A%84%E8%B5%84%E9%87%91%E8%BF%9B%E8%A1%8C%E8%BD%AC%E5%B8%90%E3%80%82%0A%2F%2F%E8%BF%99%E5%B9%B6%E6%B2%A1%E6%9C%89%E9%87%87%E5%8F%96%E5%BF%85%E8%A6%81%E7%9A%84%E6%8E%AA%E6%96%BD%E6%9D%A5%E7%A1%AE%E4%BF%9D%E4%BC%A0%E8%BE%93%E7%9A%84%E6%9C%89%E6%95%88%E6%80%A7%E3%80%82%0A%2F%2F+CanTransfer+checks+wether+there+are+enough+funds+in+the+address%27+account+to+make+a+transfer.%0A%2F%2F+This+does+not+take+the+necessary+gas+in+to+account+to+make+the+transfer+valid.%0Afunc+CanTransfer%28db+vm.StateDB%2C+addr+common.Address%2C+amount+*big.Int%29+bool+%7B%0A%09return+db.GetBalance%28addr%29.Cmp%28amount%29+%26gt%3B%3D+0%0A%7D%0A%2F%2F%E4%BC%A0%E8%BE%93%E4%BB%8E%E5%8F%91%E4%BB%B6%E4%BA%BA%E4%B8%AD%E6%89%A3%E9%99%A4%E9%87%91%E9%A2%9D%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84Db%E5%90%91%E6%94%B6%E4%BB%B6%E4%BA%BA%E6%B7%BB%E5%8A%A0%E9%87%91%E9%A2%9D%0A%2F%2F+Transfer+subtracts+amount+from+sender+and+adds+amount+to+recipient+using+the+given+Db%0Afunc+Transfer%28db+vm.StateDB%2C+sender%2C+recipient+common.Address%2C+amount+*big.Int%29+%7B%0A%09db.SubBalance%28sender%2C+amount%29%0A%09db.AddBalance%28recipient%2C+amount%29%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3E%2F%2F+Copyright+2014+The+go-ethereum+Authors%0A%2F%2F+This+file+is+part+of+the+go-ethereum+library.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+free+software%3A+you+can+redistribute+it+and%2For+modify%0A%2F%2F+it+under+the+terms+of+the+GNU+Lesser+General+Public+License+as+published+by%0A%2F%2F+the+Free+Software+Foundation%2C+either+version+3+of+the+License%2C+or%0A%2F%2F+%28at+your+option%29+any+later+version.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+distributed+in+the+hope+that+it+will+be+useful%2C%0A%2F%2F+but+WITHOUT+ANY+WARRANTY%3B+without+even+the+implied+warranty+of%0A%2F%2F+MERCHANTABILITY+or+FITNESS+FOR+A+PARTICULAR+PURPOSE.+See+the%0A%2F%2F+GNU+Lesser+General+Public+License+for+more+details.%0A%2F%2F%0A%2F%2F+You+should+have+received+a+copy+of+the+GNU+Lesser+General+Public+License%0A%2F%2F+along+with+the+go-ethereum+library.+If+not%2C+see+%26lt%3Bhttp%3A%2F%2Fwww.gnu.org%2Flicenses%2F%26gt%3B.%0A%0Apackage+vm%0A%0Aimport+%28%0A%09%22math%2Fbig%22%0A%09%22sync%2Fatomic%22%0A%09%22time%22%0A%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcommon%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcrypto%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fparams%22%0A%29%0A%2F%2F+emptyCodeHash%E7%94%B1create%E4%BD%BF%E7%94%A8%EF%BC%8C%E4%BB%A5%E7%A1%AE%E4%BF%9D%E4%B8%8D%E4%BC%9A%E9%83%A8%E7%BD%B2%E5%B7%B2%E9%83%A8%E7%BD%B2%E7%9A%84%E5%90%88%E5%90%8C%E5%9C%B0%E5%9D%80%EF%BC%88%E5%9C%A8%E5%B8%90%E6%88%B7%E6%8A%BD%E8%B1%A1%E5%90%8E%E7%9B%B8%E5%85%B3%EF%BC%89%E3%80%82%0A%2F%2F+emptyCodeHash+is+used+by+create+to+ensure+deployment+is+disallowed+to+already%0A%2F%2F+deployed+contract+addresses+%28relevant+after+the+account+abstraction%29.%0Avar+emptyCodeHash+%3D+crypto.Keccak256Hash%28nil%29%0A%0Atype+%28%0A%09CanTransferFunc+func%28StateDB%2C+common.Address%2C+*big.Int%29+bool%0A%09TransferFunc++++func%28StateDB%2C+common.Address%2C+common.Address%2C+*big.Int%29%0A%09%2F%2F+GetHashFunc+returns+the+nth+block+hash+in+the+blockchain%0A%09%2F%2F+and+is+used+by+the+BLOCKHASH+EVM+op+code.%0A%09%2F%2F+GetHashFunc%E8%BF%94%E5%9B%9E%E5%8C%BA%E5%9D%97%E9%93%BE%E4%B8%AD%E7%9A%84%E7%AC%ACn%E4%B8%AA%E5%9D%97%E5%93%88%E5%B8%8C%EF%BC%8C%E5%B9%B6%E7%94%B1BLOCKHASH+EVM%E6%93%8D%E4%BD%9C%E7%A0%81%E4%BD%BF%E7%94%A8%E3%80%82%0A%09GetHashFunc+func%28uint64%29+common.Hash%0A%29%0A%2F%2FEVM%E4%B8%AD%E6%89%A7%E8%A1%8C%E5%90%88%E7%BA%A6%28%E6%8C%87%E4%BB%A4%29%E7%9A%84%E5%87%BD%E6%95%B0%E6%98%AFrun%28%29%0A%2F%2F+run+runs+the+given+contract+and+takes+care+of+running+precompiles+with+a+fallback+to+the+byte+code+interpreter.%0Afunc+run%28evm+*EVM%2C+contract+*Contract%2C+input+%5B%5Dbyte%29+%28%5B%5Dbyte%2C+error%29+%7B%0A%09%2F%2F%E5%8F%AF%E8%A7%81%E5%A6%82%E6%9E%9C%E5%BE%85%E6%89%A7%E8%A1%8C%E7%9A%84Contract%E5%AF%B9%E8%B1%A1%E6%81%B0%E5%A5%BD%E5%B1%9E%E4%BA%8E%E4%B8%80%E7%BB%84%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%E5%90%88%E7%BA%A6%E9%9B%86%E5%90%88-%E6%AD%A4%E6%97%B6%E4%BB%A5%E6%8C%87%E4%BB%A4%E5%9C%B0%E5%9D%80CodeAddr%E4%B8%BA%E5%8C%B9%E9%85%8D%E9%A1%B9-%E9%82%A3%E4%B9%88%E5%AE%83%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%EF%BC%9B%0A%09%2F%2F+%E6%B2%A1%E6%9C%89%E7%BB%8F%E8%BF%87%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84Contract%EF%BC%8C%E6%89%8D%E4%BC%9A%E7%94%B1Interpreter%E8%A7%A3%E9%87%8A%E6%89%A7%E8%A1%8C%E3%80%82%0A%09%2F%2F+%E8%BF%99%E9%87%8C%E7%9A%84%22%E9%A2%84%E7%BC%96%E8%AF%91%22%EF%BC%8C%E5%8F%AF%E7%90%86%E8%A7%A3%E4%B8%BA%E4%B8%8D%E9%9C%80%E8%A6%81%E7%BC%96%E8%AF%91%28%E8%A7%A3%E9%87%8A%29%E6%8C%87%E4%BB%A4%28Code%29%E3%80%82%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%E5%90%88%E7%BA%A6%EF%BC%8C%E5%85%B6%E9%80%BB%E8%BE%91%E5%85%A8%E9%83%A8%E5%9B%BA%E5%AE%9A%E4%B8%94%E5%B7%B2%E7%9F%A5%EF%BC%8C%E6%89%80%E4%BB%A5%E6%89%A7%E8%A1%8C%E4%B8%AD%E4%B8%8D%E5%86%8D%E9%9C%80%E8%A6%81Code%EF%BC%8C%E4%BB%85%E9%9C%80Input%E5%8D%B3%E5%8F%AF%E3%80%82%0A%09if+contract.CodeAddr+%21%3D+nil+%7B%0A%09%09precompiles+%3A%3D+PrecompiledContractsHomestead%0A%09%09if+evm.ChainConfig%28%29.IsByzantium%28evm.BlockNumber%29+%7B%0A%09%09%09precompiles+%3D+PrecompiledContractsByzantium%0A%09%09%7D%0A%09%09if+p+%3A%3D+precompiles%5B*contract.CodeAddr%5D%3B+p+%21%3D+nil+%7B%2F%2F%E5%9C%A8%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E4%B8%AD%EF%BC%8C%E9%A2%84%E7%BC%96%E8%AF%91%E5%90%88%E7%BA%A6%E5%8F%AA%E9%9C%80%E5%AE%9E%E7%8E%B0%E4%B8%A4%E4%B8%AA%E6%96%B9%E6%B3%95Required%28%29%E5%92%8CRun%28%29%E5%8D%B3%E5%8F%AF%EF%BC%8C%E8%BF%99%E4%B8%A4%E6%96%B9%E6%B3%95%E4%BB%85%E9%9C%80%E4%B8%80%E4%B8%AA%E5%85%A5%E5%8F%82input%0A%09%09%09return+RunPrecompiledContract%28p%2C+input%2C+contract%29%0A%09%09%7D%0A%09%7D%0A%09return+evm.interpreter.Run%28contract%2C+input%29%2F%2F%E8%A7%A3%E9%87%8A%E5%99%A8Interpreter%E7%94%A8%E6%9D%A5%E6%89%A7%E8%A1%8C%28%E9%9D%9E%E9%A2%84%E7%BC%96%E8%AF%91%E7%9A%84%29%E5%90%88%E7%BA%A6%E6%8C%87%E4%BB%A4%0A%7D%0A%2F%2F+%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%BAEVM%E6%8F%90%E4%BE%9B%E8%BE%85%E5%8A%A9%E4%BF%A1%E6%81%AF%E3%80%82+%E4%B8%80%E6%97%A6%E6%8F%90%E4%BE%9B%EF%BC%8C%E4%B8%8D%E5%BA%94%E8%AF%A5%E4%BF%AE%E6%94%B9%E3%80%82%0A%2F%2F+Context+provides+the+EVM+with+auxiliary+information.+Once+provided%0A%2F%2F+it+shouldn%27t+be+modified.%0Atype+Context+struct+%7B%0A%09%2F%2F+CanTransfer+returns+whether+the+account+contains%0A%09%2F%2F+sufficient+ether+to+transfer+the+value%0A%09CanTransfer+CanTransferFunc%2F%2F+CanTransfer+%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E8%B4%A6%E6%88%B7%E6%98%AF%E5%90%A6%E6%9C%89%E8%B6%B3%E5%A4%9F%E7%9A%84ether%E7%94%A8%E6%9D%A5%E8%BD%AC%E8%B4%A6%0A%09%2F%2F+Transfer+transfers+ether+from+one+account+to+the+other%0A%09Transfer+TransferFunc%2F%2F+Transfer+%E7%94%A8%E6%9D%A5%E4%BB%8E%E4%B8%80%E4%B8%AA%E8%B4%A6%E6%88%B7%E7%BB%99%E5%8F%A6%E4%B8%80%E4%B8%AA%E8%B4%A6%E6%88%B7%E8%BD%AC%E8%B4%A6%0A%09%2F%2F+GetHash+returns+the+hash+corresponding+to+n%0A%09GetHash+GetHashFunc%2F%2F+GetHash%E7%94%A8%E6%9D%A5%E8%BF%94%E5%9B%9E%E5%85%A5%E5%8F%82n%E5%AF%B9%E5%BA%94%E7%9A%84hash%E5%80%BC%0A%0A%09%2F%2F+Message+information%0A%09Origin+++common.Address+%2F%2F+Provides+information+for+ORIGIN%2F%2F+%E7%94%A8%E6%9D%A5%E6%8F%90%E4%BE%9BOrigin%E7%9A%84%E4%BF%A1%E6%81%AF+sender%E7%9A%84%E5%9C%B0%E5%9D%80%0A%09GasPrice+*big.Int+++++++%2F%2F+Provides+information+for+GASPRICE%2F%2F+%E7%94%A8%E6%9D%A5%E6%8F%90%E4%BE%9BGasPrice%E4%BF%A1%E6%81%AF%0A%0A%09%2F%2F+Block+information%0A%09Coinbase++++common.Address+%2F%2F+Provides+information+for+COINBASE%0A%09GasLimit++++uint64+++++++++%2F%2F+Provides+information+for+GASLIMIT%0A%09BlockNumber+*big.Int+++++++%2F%2F+Provides+information+for+NUMBER%0A%09Time++++++++*big.Int+++++++%2F%2F+Provides+information+for+TIME%0A%09Difficulty++*big.Int+++++++%2F%2F+Provides+information+for+DIFFICULTY%0A%7D%0A%0A%2F%2F+EVM+is+the+Ethereum+Virtual+Machine+base+object+and+provides%0A%2F%2F+the+necessary+tools+to+run+a+contract+on+the+given+state+with%0A%2F%2F+the+provided+context.+It+should+be+noted+that+any+error%0A%2F%2F+generated+through+any+of+the+calls+should+be+considered+a%0A%2F%2F+revert-state-and-consume-all-gas+operation%2C+no+checks+on%0A%2F%2F+specific+errors+should+ever+be+performed.+The+interpreter+makes%0A%2F%2F+sure+that+any+errors+generated+are+to+be+considered+faulty+code.%0A%2F%2F%2F%2F+EVM%E6%98%AF%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E6%8F%90%E4%BE%9B%E5%BF%85%E8%A6%81%E7%9A%84%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%BB%A5%E4%BD%BF%E7%94%A8%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E8%BF%90%E8%A1%8C%E7%BB%99%E5%AE%9A%E7%8A%B6%E6%80%81%E7%9A%84%E5%90%88%E7%BA%A6%E3%80%82%0A%2F%2F+%E5%BA%94%E8%AF%A5%E6%8C%87%E5%87%BA%E7%9A%84%E6%98%AF%EF%BC%8C%E4%BB%BB%E4%BD%95%E8%B0%83%E7%94%A8%E4%BA%A7%E7%94%9F%E7%9A%84%E4%BB%BB%E4%BD%95%E9%94%99%E8%AF%AF%E9%83%BD%E5%BA%94%E8%AF%A5%E8%A2%AB%E8%AE%A4%E4%B8%BA%E6%98%AF%E4%B8%80%E7%A7%8D%E5%9B%9E%E6%BB%9A%E4%BF%AE%E6%94%B9%E7%8A%B6%E6%80%81%E5%92%8C%E6%B6%88%E8%80%97%E6%89%80%E6%9C%89GAS%E6%93%8D%E4%BD%9C%EF%BC%8C%0A%2F%2F+%E4%B8%8D%E5%BA%94%E8%AF%A5%E6%89%A7%E8%A1%8C%E5%AF%B9%E5%85%B7%E4%BD%93%E9%94%99%E8%AF%AF%E7%9A%84%E6%A3%80%E6%9F%A5%E3%80%82+%E8%A7%A3%E9%87%8A%E5%99%A8%E7%A1%AE%E4%BF%9D%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%BB%E4%BD%95%E9%94%99%E8%AF%AF%E9%83%BD%E8%A2%AB%E8%AE%A4%E4%B8%BA%E6%98%AF%E9%94%99%E8%AF%AF%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82%0A%2F%2F+The+EVM+should+never+be+reused+and+is+not+thread+safe.%0Atype+EVM+struct+%7B%0A%09%2F%2F+Context+provides+auxiliary+blockchain+related+information%0A%09Context%2F%2F%E6%90%BA%E5%B8%A6%E4%BA%86Transaction%E7%9A%84%E4%BF%A1%E6%81%AF%28GasPrice%2C+GasLimit%29%EF%BC%8CBlock%E7%9A%84%E4%BF%A1%E6%81%AF%28Number%2C+Difficulty%29%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%BD%AC%E5%B8%90%E5%87%BD%E6%95%B0%E7%AD%89%0A%09%2F%2F+StateDB+gives+access+to+the+underlying+state%0A%09StateDB+StateDB%2F%2FtateDB+%E6%8E%A5%E5%8F%A3%E6%98%AF%E9%92%88%E5%AF%B9state.StateDB+%E7%BB%93%E6%9E%84%E4%BD%93%E8%AE%BE%E8%AE%A1%E7%9A%84%E6%9C%AC%E5%9C%B0%E8%A1%8C%E4%B8%BA%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%8F%AF%E4%B8%BAEVM%E6%8F%90%E4%BE%9Bstatedb%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%0A%09%2F%2F+Depth+is+the+current+call+stack%0A%09%2F%2F+%E5%BD%93%E5%89%8D%E7%9A%84%E8%B0%83%E7%94%A8%E5%A0%86%E6%A0%88%0A%09depth+int%0A%0A%09%2F%2F+chainConfig+contains+information+about+the+current+chain%0A%09%2F%2F+%E5%8C%85%E5%90%AB%E4%BA%86%E5%BD%93%E5%89%8D%E7%9A%84%E5%8C%BA%E5%9D%97%E9%93%BE%E7%9A%84%E4%BF%A1%E6%81%AF%0A%09chainConfig+*params.ChainConfig%0A%09%2F%2F%E9%93%BE%E8%A7%84%E5%88%99%E5%8C%85%E5%90%AB%E5%BD%93%E5%89%8D%E6%97%B6%E6%9C%9F%E7%9A%84%E9%93%BE%E8%A7%84%E5%88%99%0A%09%2F%2F+chain+rules+contains+the+chain+rules+for+the+current+epoch%0A%09chainRules+params.Rules%0A%09%2F%2F%E7%94%A8%E4%BA%8E%E5%88%9D%E5%A7%8B%E5%8C%96evm%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%85%8D%E7%BD%AE%E9%80%89%E9%A1%B9%E3%80%82%0A%09%2F%2F+virtual+machine+configuration+options+used+to+initialise+the%0A%09%2F%2F+evm.%0A%09vmConfig+Config%0A%09%2F%2F%E5%85%A8%E5%B1%80%EF%BC%88%E5%9C%A8%E6%AD%A4%E4%B8%8A%E4%B8%8B%E6%96%87%E4%B8%AD%EF%BC%89%E5%9C%A8%E6%95%B4%E4%B8%AAtx%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%82%0A%09%2F%2F+global+%28to+this+context%29+ethereum+virtual+machine%0A%09%2F%2F+used+throughout+the+execution+of+the+tx.%0A%09interpreter+*Interpreter%2F%2F+Interpreter%E7%BB%93%E6%9E%84%E4%BD%93%E4%BD%9C%E4%B8%BA%E8%A7%A3%E9%87%8A%E5%99%A8%EF%BC%8C%E7%94%A8%E6%9D%A5%E8%A7%A3%E9%87%8A%E6%89%A7%E8%A1%8CEVM%E4%B8%AD%E5%90%88%E7%BA%A6%28Contract%29%E7%9A%84%E6%8C%87%E4%BB%A4%28Code%29%E3%80%82%0A%09%2F%2F%E4%B8%AD%E6%AD%A2%E7%94%A8%E4%BA%8E%E4%B8%AD%E6%AD%A2EVM%E8%B0%83%E7%94%A8%E6%93%8D%E4%BD%9C%0A%09%2F%2F%E6%B3%A8%E6%84%8F%EF%BC%9A%E5%BF%85%E9%A1%BB%E4%BB%A5%E5%8E%9F%E5%AD%90%E6%96%B9%E5%BC%8F%E8%AE%BE%E7%BD%AE%0A%09%2F%2F+abort+is+used+to+abort+the+EVM+calling+operations%0A%09%2F%2F+NOTE%3A+must+be+set+atomically%0A%09abort+int32%0A%09%2F%2F+callGasTemp%E4%BF%9D%E5%AD%98%E5%BD%93%E5%89%8D%E9%80%9A%E8%AF%9D%E5%8F%AF%E7%94%A8%E7%9A%84gas%E3%80%82+%E8%BF%99%E6%98%AF%E5%BF%85%E8%A6%81%E7%9A%84%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%8F%AF%E7%94%A8%E6%B0%94%E4%BD%93%E6%98%AF%E6%A0%B9%E6%8D%AE63%2F64%E8%A7%84%E5%88%99%E5%9C%A8gasCall+*%E4%B8%AD%E8%AE%A1%E7%AE%97%E7%9A%84%EF%BC%8C%E7%A8%8D%E5%90%8E%E5%9C%A8opCall+*%E4%B8%AD%E5%BA%94%E7%94%A8%E3%80%82%0A%09%2F%2F+callGasTemp+holds+the+gas+available+for+the+current+call.+This+is+needed+because+the%0A%09%2F%2F+available+gas+is+calculated+in+gasCall*+according+to+the+63%2F64+rule+and+later%0A%09%2F%2F+applied+in+opCall*.%0A%09callGasTemp+uint64%0A%7D%0A%2F%2F+NewEVM%E9%87%8D%E6%96%B0%E6%9E%84%E5%BB%BA%E6%96%B0%E7%9A%84EVM%E3%80%82+%E8%BF%94%E5%9B%9E%E7%9A%84EVM%E4%B8%8D%E6%98%AF%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%EF%BC%8C%E5%BA%94%E8%AF%A5%E5%8F%AA%E8%83%BD%E4%BD%BF%E7%94%A8*%E4%B8%80%E6%AC%A1*%E3%80%82%0A%2F%2F+NewEVM+retutrns+a+new+EVM+.+The+returned+EVM+is+not+thread+safe+and+should%0A%2F%2F+only+ever+be+used+*once*.%0Afunc+NewEVM%28ctx+Context%2C+statedb+StateDB%2C+chainConfig+*params.ChainConfig%2C+vmConfig+Config%29+*EVM+%7B%0A%09evm+%3A%3D+%26amp%3BEVM%7B%0A%09%09Context%3A+++++ctx%2C%0A%09%09StateDB%3A+++++statedb%2C%0A%09%09vmConfig%3A++++vmConfig%2C%0A%09%09chainConfig%3A+chainConfig%2C%0A%09%09chainRules%3A++chainConfig.Rules%28ctx.BlockNumber%29%2C%0A%09%7D%0A%0A%09evm.interpreter+%3D+NewInterpreter%28evm%2C+vmConfig%29%0A%09return+evm%0A%7D%0A%2F%2F%E5%8F%96%E6%B6%88%E4%BB%BB%E4%BD%95%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84EVM%E6%93%8D%E4%BD%9C%E3%80%82+%E8%BF%99%E5%8F%AF%E4%BB%A5%E5%90%8C%E6%97%B6%E8%B0%83%E7%94%A8%EF%BC%8C%E5%B9%B6%E4%B8%94%E5%A4%9A%E6%AC%A1%E8%B0%83%E7%94%A8%E6%98%AF%E5%AE%89%E5%85%A8%E7%9A%84%E3%80%82%0A%2F%2F+Cancel+cancels+any+running+EVM+operation.+This+may+be+called+concurrently+and%0A%2F%2F+it%27s+safe+to+be+called+multiple+times.%0Afunc+%28evm+*EVM%29+Cancel%28%29+%7B%0A%09atomic.StoreInt32%28%26amp%3Bevm.abort%2C+1%29%0A%7D%0A%2F%2FCall%E6%96%B9%E6%B3%95%2C+%E6%97%A0%E8%AE%BA%E6%88%91%E4%BB%AC%E8%BD%AC%E8%B4%A6%E6%88%96%E8%80%85%E6%98%AF%E6%89%A7%E8%A1%8C%E5%90%88%E7%BA%A6%E4%BB%A3%E7%A0%81%E9%83%BD%E4%BC%9A%E8%B0%83%E7%94%A8%E5%88%B0%E8%BF%99%E9%87%8C%EF%BC%8C+%E5%90%8C%E6%97%B6%E5%90%88%E7%BA%A6%E9%87%8C%E9%9D%A2%E7%9A%84call%E6%8C%87%E4%BB%A4%E4%B9%9F%E4%BC%9A%E6%89%A7%E8%A1%8C%E5%88%B0%E8%BF%99%E9%87%8C%E3%80%82%0A%2F%2F+Call+executes+the+contract+associated+with+the+addr+with+the+given+input+as%0A%2F%2F+parameters.+It+also+handles+any+necessary+value+transfer+required+and+takes%0A%2F%2F+the+necessary+steps+to+create+accounts+and+reverses+the+state+in+case+of+an%0A%2F%2F+execution+error+or+failed+value+transfer.%0A%2F%2F+Call+%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%99%E5%AE%9A%E7%9A%84input%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%E4%B8%8Eaddr%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E5%90%88%E7%BA%A6%E3%80%82%0A%2F%2F+%E5%AE%83%E8%BF%98%E5%A4%84%E7%90%86%E6%89%80%E9%9C%80%E7%9A%84%E4%BB%BB%E4%BD%95%E5%BF%85%E8%A6%81%E7%9A%84%E8%BD%AC%E8%B4%A6%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B9%B6%E9%87%87%E5%8F%96%E5%BF%85%E8%A6%81%E7%9A%84%E6%AD%A5%E9%AA%A4%E6%9D%A5%E5%88%9B%E5%BB%BA%E5%B8%90%E6%88%B7%0A%2F%2F+%E5%B9%B6%E5%9C%A8%E4%BB%BB%E6%84%8F%E9%94%99%E8%AF%AF%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%9B%9E%E6%BB%9A%E6%89%80%E5%81%9A%E7%9A%84%E6%93%8D%E4%BD%9C%E3%80%82%0Afunc+%28evm+*EVM%29+Call%28caller+ContractRef%2C+addr+common.Address%2C+input+%5B%5Dbyte%2C+gas+uint64%2C+value+*big.Int%29+%28ret+%5B%5Dbyte%2C+leftOverGas+uint64%2C+err+error%29+%7B%0A%09%2F%2F1%E6%A3%80%E6%9F%A5%E4%BA%A4%E6%98%93%0A%09if+evm.vmConfig.NoRecursion+%26amp%3B%26amp%3B+evm.depth+%26gt%3B+0+%7B%0A%09%09return+nil%2C+gas%2C+nil%0A%09%7D%0A%09%2F%2F++%E8%B0%83%E7%94%A8%E6%B7%B1%E5%BA%A6%E6%9C%80%E5%A4%9A1024%0A%09%2F%2F+Fail+if+we%27re+trying+to+execute+above+the+call+depth+limit%0A%09if+evm.depth+%26gt%3B+int%28params.CallCreateDepth%29+%7B%0A%09%09return+nil%2C+gas%2C+ErrDepth%0A%09%7D%0A%09%2F%2F+%E6%9F%A5%E7%9C%8B%E6%88%91%E4%BB%AC%E7%9A%84%E8%B4%A6%E6%88%B7%E6%98%AF%E5%90%A6%E6%9C%89%E8%B6%B3%E5%A4%9F%E7%9A%84%E9%87%91%E9%92%B1%E3%80%82%0A%09%2F%2F+Fail+if+we%27re+trying+to+transfer+more+than+the+available+balance%0A%09if+%21evm.Context.CanTransfer%28evm.StateDB%2C+caller.Address%28%29%2C+value%29+%7B%0A%09%09return+nil%2C+gas%2C+ErrInsufficientBalance%0A%09%7D%0A%0A%09var+%28%0A%09%09to+++++++%3D+AccountRef%28addr%29%0A%09%09snapshot+%3D+evm.StateDB.Snapshot%28%29%0A%09%29%0A%09if+%21evm.StateDB.Exist%28addr%29+%7B%2F%2F+%E6%9F%A5%E7%9C%8B%E6%8C%87%E5%AE%9A%E5%9C%B0%E5%9D%80%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8%0A%09%09%2F%2F+%E5%A6%82%E6%9E%9C%E5%9C%B0%E5%9D%80%E4%B8%8D%E5%AD%98%E5%9C%A8%EF%BC%8C%E6%9F%A5%E7%9C%8B%E6%98%AF%E5%90%A6%E6%98%AF+native+go%E7%9A%84%E5%90%88%E7%BA%A6%EF%BC%8C+native+go%E7%9A%84%E5%90%88%E7%BA%A6%E5%9C%A8%0A%09%09%2F%2F+contracts.go+%E6%96%87%E4%BB%B6%E9%87%8C%E9%9D%A2%0A%09%09precompiles+%3A%3D+PrecompiledContractsHomestead%0A%09%09if+evm.ChainConfig%28%29.IsByzantium%28evm.BlockNumber%29+%7B%0A%09%09%09precompiles+%3D+PrecompiledContractsByzantium%0A%09%09%7D%0A%09%09if+precompiles%5Baddr%5D+%3D%3D+nil+%26amp%3B%26amp%3B+evm.ChainConfig%28%29.IsEIP158%28evm.BlockNumber%29+%26amp%3B%26amp%3B+value.Sign%28%29+%3D%3D+0+%7B%0A%09%09%09%2F%2F+%E5%A6%82%E6%9E%9C%E4%B8%8D%E6%98%AF%E6%8C%87%E5%AE%9A%E7%9A%84%E5%90%88%E7%BA%A6%E5%9C%B0%E5%9D%80%EF%BC%8C+%E5%B9%B6%E4%B8%94value%E7%9A%84%E5%80%BC%E4%B8%BA0%E9%82%A3%E4%B9%88%E8%BF%94%E5%9B%9E%E6%AD%A3%E5%B8%B8%EF%BC%8C%E8%80%8C%E4%B8%94%E8%BF%99%E6%AC%A1%E8%B0%83%E7%94%A8%E6%B2%A1%E6%9C%89%E6%B6%88%E8%80%97Gas%0A%09%09%09return+nil%2C+gas%2C+nil%0A%09%09%7D%0A%09%09%2F%2F+%E8%B4%9F%E8%B4%A3%E5%9C%A8%E6%9C%AC%E5%9C%B0%E7%8A%B6%E6%80%81%E5%88%9B%E5%BB%BAaddr%0A%09%09evm.StateDB.CreateAccount%28addr%29%0A%09%7D%0A%09%2F%2F+2%E6%89%A7%E8%A1%8C%E8%BD%AC%E8%B4%A6%0A%09evm.Transfer%28evm.StateDB%2C+caller.Address%28%29%2C+to.Address%28%29%2C+value%29%0A%0A%09%2F%2F+Initialise+a+new+contract+and+set+the+code+that+is+to+be+used+by+the+EVM.%0A%09%2F%2F+The+contract+is+a+scoped+environment+for+this+execution+context+only.%0A%09%2F%2F3%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAContract%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%B6%E6%88%90%E5%91%98%E5%8F%98%E9%87%8Fcaller%2C+self%28addr%29%2C+value%E5%92%8Cgas%0A%09contract+%3A%3D+NewContract%28caller%2C+to%2C+value%2C+gas%29%0A%09%2F%2F4%E8%B5%8B%E5%80%BCContract%E5%AF%B9%E8%B1%A1%E7%9A%84Code%2C+CodeHash%2C+CodeAddr%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%0A%09contract.SetCallCode%28%26amp%3Baddr%2C+evm.StateDB.GetCodeHash%28addr%29%2C+evm.StateDB.GetCode%28addr%29%29%0A%0A%09start+%3A%3D+time.Now%28%29%0A%09%2F%2F%E4%BB%A5%E8%B0%83%E8%AF%95%E6%A8%A1%E5%BC%8F%E6%8D%95%E8%8E%B7%E8%B7%9F%E8%B8%AA%E5%99%A8%E5%BC%80%E5%A7%8B%2F%E7%BB%93%E6%9D%9F%E4%BA%8B%E4%BB%B6%0A%09%2F%2F+Capture+the+tracer+start%2Fend+events+in+debug+mode%0A%09if+evm.vmConfig.Debug+%26amp%3B%26amp%3B+evm.depth+%3D%3D+0+%7B%0A%09%09evm.vmConfig.Tracer.CaptureStart%28caller.Address%28%29%2C+addr%2C+false%2C+input%2C+gas%2C+value%29%0A%0A%09%09defer+func%28%29+%7B+%2F%2F+Lazy+evaluation+of+the+parameters%2F%2F%E6%87%92%E5%8A%A0%E8%BD%BD%E7%9A%84%E5%8F%82%E6%95%B0%E8%AF%84%E4%BC%B0%0A%09%09%09evm.vmConfig.Tracer.CaptureEnd%28ret%2C+gas-contract.Gas%2C+time.Since%28start%29%2C+err%29%0A%09%09%7D%28%29%0A%09%7D%0A%09%2F%2F5%E8%B0%83%E7%94%A8run%28%29%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E8%AF%A5%E5%90%88%E7%BA%A6%E7%9A%84%E6%8C%87%E4%BB%A4%EF%BC%8C%E6%9C%80%E5%90%8ECall%28%29%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%0A%09ret%2C+err+%3D+run%28evm%2C+contract%2C+input%29%0A%09%2F%2F%E5%BD%93EVM%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%E6%88%96%E8%AE%BE%E7%BD%AE%E4%B8%8A%E8%BF%B0%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E6%81%A2%E5%A4%8D%E5%BF%AB%E7%85%A7%E5%B9%B6%E6%B6%88%E8%80%97%E5%89%A9%E4%BD%99%E7%9A%84%E6%B0%94%E4%BD%93%E3%80%82+%E5%8F%A6%E5%A4%96%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E5%9C%A8%E5%AE%B6%E5%9B%AD%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B9%9F%E4%BB%A3%E8%A1%A8%E4%BA%86%E4%BB%A3%E7%A0%81%E5%AD%98%E5%82%A8%E7%93%A6%E6%96%AF%E9%94%99%E8%AF%AF%E3%80%82%0A%09%2F%2F+When+an+error+was+returned+by+the+EVM+or+when+setting+the+creation+code%0A%09%2F%2F+above+we+revert+to+the+snapshot+and+consume+any+gas+remaining.+Additionally%0A%09%2F%2F+when+we%27re+in+homestead+this+also+counts+for+code+storage+gas+errors.%0A%09if+err+%21%3D+nil+%7B%0A%09%09evm.StateDB.RevertToSnapshot%28snapshot%29%0A%09%09if+err+%21%3D+errExecutionReverted+%7B%0A%09%09%09%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E7%94%B1revert%E6%8C%87%E4%BB%A4%E8%A7%A6%E5%8F%91%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%8C%E5%9B%A0%E4%B8%BAICO%E4%B8%80%E8%88%AC%E8%AE%BE%E7%BD%AE%E4%BA%86%E4%BA%BA%E6%95%B0%E9%99%90%E5%88%B6%E6%88%96%E8%80%85%E8%B5%84%E9%87%91%E9%99%90%E5%88%B6%0A%09%09%09%2F%2F+%E5%9C%A8%E5%A4%A7%E5%AE%B6%E6%8A%A2%E8%B4%AD%E7%9A%84%E6%97%B6%E5%80%99%E5%BE%88%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%A7%A6%E5%8F%91%E8%BF%99%E4%BA%9B%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6%EF%BC%8C%E5%AF%BC%E8%87%B4%E8%A2%AB%E6%8A%BD%E8%B5%B0%E4%B8%8D%E5%B0%91%E9%92%B1%E3%80%82%E8%BF%99%E4%B8%AA%E6%97%B6%E5%80%99%0A%09%09%09%2F%2F+%E5%8F%88%E4%B8%8D%E8%83%BD%E8%AE%BE%E7%BD%AE%E6%AF%94%E8%BE%83%E4%BD%8E%E7%9A%84GasPrice%E5%92%8CGasLimit%E3%80%82%E5%9B%A0%E4%B8%BA%E8%A6%81%E9%80%9F%E5%BA%A6%E5%BF%AB%E3%80%82%0A%09%09%09%2F%2F+%E9%82%A3%E4%B9%88%E4%B8%8D%E4%BC%9A%E4%BD%BF%E7%94%A8%E5%89%A9%E4%B8%8B%E7%9A%84%E5%85%A8%E9%83%A8Gas%EF%BC%8C%E8%80%8C%E6%98%AF%E5%8F%AA%E4%BC%9A%E4%BD%BF%E7%94%A8%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E7%9A%84Gas%0A%09%09%09%2F%2F+%E4%B8%8D%E7%84%B6%E4%BC%9A%E8%A2%AB%E6%8A%BD%E8%B5%B0+GasLimit+*GasPrice%E7%9A%84%E9%92%B1%EF%BC%8C%E9%82%A3%E5%8F%AF%E4%B8%8D%E5%B0%91%E3%80%82%0A%09%09%09contract.UseGas%28contract.Gas%29%0A%09%09%7D%0A%09%7D%0A%09return+ret%2C+contract.Gas%2C+err%0A%7D%0A%2F%2F%E5%89%A9%E4%B8%8B%E7%9A%84%E4%B8%89%E4%B8%AA%E5%87%BD%E6%95%B0+CallCode%2C+DelegateCall%2C+%E5%92%8C+StaticCall%EF%BC%8C%E8%BF%99%E4%B8%89%E4%B8%AA%E5%87%BD%E6%95%B0%E4%B8%8D%E8%83%BD%E7%94%B1%E5%A4%96%E9%83%A8%E8%B0%83%E7%94%A8%EF%BC%8C%E5%8F%AA%E8%83%BD%E7%94%B1Opcode%E8%A7%A6%E5%8F%91%E3%80%82%0A%2F%2F+CallCode+executes+the+contract+associated+with+the+addr+with+the+given+input%0A%2F%2F+as+parameters.+It+also+handles+any+necessary+value+transfer+required+and+takes%0A%2F%2F+the+necessary+steps+to+create+accounts+and+reverses+the+state+in+case+of+an%0A%2F%2F+execution+error+or+failed+value+transfer.%0A%2F%2F%2F%2F+CallCode%E4%B8%8ECall%E4%B8%8D%E5%90%8C%E7%9A%84%E5%9C%B0%E6%96%B9%E5%9C%A8%E4%BA%8E%E5%AE%83%E4%BD%BF%E7%94%A8caller%E7%9A%84context%E6%9D%A5%E6%89%A7%E8%A1%8C%E7%BB%99%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82%0A%2F%2F+CallCode+differs+from+Call+in+the+sense+that+it+executes+the+given+address%27%0A%2F%2F+code+with+the+caller+as+context.%0Afunc+%28evm+*EVM%29+CallCode%28caller+ContractRef%2C+addr+common.Address%2C+input+%5B%5Dbyte%2C+gas+uint64%2C+value+*big.Int%29+%28ret+%5B%5Dbyte%2C+leftOverGas+uint64%2C+err+error%29+%7B%0A%09if+evm.vmConfig.NoRecursion+%26amp%3B%26amp%3B+evm.depth+%26gt%3B+0+%7B%0A%09%09return+nil%2C+gas%2C+nil%0A%09%7D%0A%09%2F%2F%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E8%AF%95%E5%9B%BE%E5%9C%A8%E9%80%9A%E8%AF%9D%E6%B7%B1%E5%BA%A6%E9%99%90%E5%88%B6%E4%BB%A5%E4%B8%8A%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%88%99%E4%BC%9A%E5%A4%B1%E8%B4%A5%0A%09%2F%2F+Fail+if+we%27re+trying+to+execute+above+the+call+depth+limit%0A%09if+evm.depth+%26gt%3B+int%28params.CallCreateDepth%29+%7B%0A%09%09return+nil%2C+gas%2C+ErrDepth%0A%09%7D%2F%2F%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E5%B0%9D%E8%AF%95%E4%BC%A0%E8%BE%93%E7%9A%84%E5%8F%AF%E7%94%A8%E4%BD%99%E9%A2%9D%E8%B6%85%E8%BF%87%E4%BA%86%EF%BC%8C%E5%88%99%E5%A4%B1%E8%B4%A5%0A%09%2F%2F+Fail+if+we%27re+trying+to+transfer+more+than+the+available+balance%0A%09if+%21evm.CanTransfer%28evm.StateDB%2C+caller.Address%28%29%2C+value%29+%7B%0A%09%09return+nil%2C+gas%2C+ErrInsufficientBalance%0A%09%7D%0A%0A%09var+%28%0A%09%09snapshot+%3D+evm.StateDB.Snapshot%28%29%0A%09%09to+++++++%3D+AccountRef%28caller.Address%28%29%29%2F%2F%E8%BF%99%E9%87%8C%E6%98%AF%E6%9C%80%E4%B8%8D%E5%90%8C%E7%9A%84%E5%9C%B0%E6%96%B9+to%E7%9A%84%E5%9C%B0%E5%9D%80%E8%A2%AB%E4%BF%AE%E6%94%B9%E4%B8%BAcaller%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BA%86+%E8%80%8C%E4%B8%94%E6%B2%A1%E6%9C%89%E8%BD%AC%E8%B4%A6%E7%9A%84%E8%A1%8C%E4%B8%BA%0A%09%29%0A%09%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%A5%91%E7%BA%A6%E5%B9%B6%E8%AE%BE%E7%BD%AEE%E5%B0%86%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E8%AF%A5%E5%A5%91%E7%BA%A6%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BB%85%E9%99%90%E4%BA%8E%E6%AD%A4%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E8%A7%A3%E9%87%8A%E3%80%82%0A%09%2F%2F+initialise+a+new+contract+and+set+the+code+that+is+to+be+used+by+the%0A%09%2F%2F+E+The+contract+is+a+scoped+evmironment+for+this+execution+context%0A%09%2F%2F+only.%0A%09contract+%3A%3D+NewContract%28caller%2C+to%2C+value%2C+gas%29%0A%09contract.SetCallCode%28%26amp%3Baddr%2C+evm.StateDB.GetCodeHash%28addr%29%2C+evm.StateDB.GetCode%28addr%29%29%0A%0A%09ret%2C+err+%3D+run%28evm%2C+contract%2C+input%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09evm.StateDB.RevertToSnapshot%28snapshot%29%0A%09%09if+err+%21%3D+errExecutionReverted+%7B%0A%09%09%09contract.UseGas%28contract.Gas%29%0A%09%09%7D%0A%09%7D%0A%09return+ret%2C+contract.Gas%2C+err%0A%7D%0A%2F%2F+DelegateCall+%E5%92%8C+CallCode%E4%B8%8D%E5%90%8C%E7%9A%84%E5%9C%B0%E6%96%B9%E5%9C%A8%E4%BA%8E+caller%E8%A2%AB%E8%AE%BE%E7%BD%AE%E4%B8%BA+caller%E7%9A%84caller%0A%2F%2F+DelegateCall+executes+the+contract+associated+with+the+addr+with+the+given+input%0A%2F%2F+as+parameters.+It+reverses+the+state+in+case+of+an+execution+error.%0A%2F%2F%0A%2F%2F+DelegateCall+differs+from+CallCode+in+the+sense+that+it+executes+the+given+address%27%0A%2F%2F+code+with+the+caller+as+context+and+the+caller+is+set+to+the+caller+of+the+caller.%0A%2F%2F+DelegateCall%E4%BB%A5%E7%BB%99%E5%AE%9A%E8%BE%93%E5%85%A5%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%E6%89%A7%E8%A1%8C%E4%B8%8Eaddr%E5%85%B3%E8%81%94%E7%9A%84%E5%90%88%E5%90%8C%E3%80%82+%E5%AE%83%E5%9C%A8%E6%89%A7%E8%A1%8C%E9%94%99%E8%AF%AF%E7%9A%84%E6%83%85%E5%86%B5%E4%B8%8B%E5%8F%8D%E8%BD%AC%E7%8A%B6%E6%80%81%E3%80%82%0A%2F%2F+DelegateCall%E4%B8%8ECallCode%E7%9A%84%E4%B8%8D%E5%90%8C%E4%B9%8B%E5%A4%84%E5%9C%A8%E4%BA%8E%EF%BC%8C%E5%AE%83%E4%BB%A5%E5%91%BC%E5%8F%AB%E8%80%85%E4%BD%9C%E4%B8%BA%E4%B8%8A%E4%B8%8B%E6%96%87%E6%89%A7%E8%A1%8C%E7%BB%99%E5%AE%9A%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BB%A3%E7%A0%81%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%91%BC%E5%8F%AB%E8%80%85%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%91%BC%E5%8F%AB%E8%80%85%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85%E3%80%82%0Afunc+%28evm+*EVM%29+DelegateCall%28caller+ContractRef%2C+addr+common.Address%2C+input+%5B%5Dbyte%2C+gas+uint64%29+%28ret+%5B%5Dbyte%2C+leftOverGas+uint64%2C+err+error%29+%7B%0A%09if+evm.vmConfig.NoRecursion+%26amp%3B%26amp%3B+evm.depth+%26gt%3B+0+%7B%0A%09%09return+nil%2C+gas%2C+nil%0A%09%7D%0A%09%2F%2F+Fail+if+we%27re+trying+to+execute+above+the+call+depth+limit%0A%09if+evm.depth+%26gt%3B+int%28params.CallCreateDepth%29+%7B%0A%09%09return+nil%2C+gas%2C+ErrDepth%0A%09%7D%0A%0A%09var+%28%0A%09%09snapshot+%3D+evm.StateDB.Snapshot%28%29%0A%09%09to+++++++%3D+AccountRef%28caller.Address%28%29%29%0A%09%29%0A%09%2F%2F+%E6%A0%87%E8%AF%86%E4%B8%BAAsDelete%28%29%0A%09%2F%2F+Initialise+a+new+contract+and+make+initialise+the+delegate+values%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%90%88%E7%BA%A6%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A7%94%E6%89%98%E5%80%BC%0A%09contract+%3A%3D+NewContract%28caller%2C+to%2C+nil%2C+gas%29.AsDelegate%28%29%0A%09contract.SetCallCode%28%26amp%3Baddr%2C+evm.StateDB.GetCodeHash%28addr%29%2C+evm.StateDB.GetCode%28addr%29%29%0A%0A%09ret%2C+err+%3D+run%28evm%2C+contract%2C+input%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09evm.StateDB.RevertToSnapshot%28snapshot%29%0A%09%09if+err+%21%3D+errExecutionReverted+%7B%0A%09%09%09contract.UseGas%28contract.Gas%29%0A%09%09%7D%0A%09%7D%0A%09return+ret%2C+contract.Gas%2C+err%0A%7D%0A%2F%2F+StaticCall%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%99%E5%AE%9A%E8%BE%93%E5%85%A5%E7%9A%84addr%E7%9B%B8%E5%85%B3%E8%81%94%E7%9A%84%E5%90%88%E5%90%8C%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0%EF%BC%8C%E5%90%8C%E6%97%B6%E7%A6%81%E6%AD%A2%E5%9C%A8%E8%B0%83%E7%94%A8%E6%9C%9F%E9%97%B4%E5%AF%B9%E7%8A%B6%E6%80%81%E8%BF%9B%E8%A1%8C%E4%BB%BB%E4%BD%95%E4%BF%AE%E6%94%B9%E3%80%82%0A%2F%2F%E8%AF%95%E5%9B%BE%E6%89%A7%E8%A1%8C%E6%AD%A4%E7%B1%BB%E4%BF%AE%E6%94%B9%E7%9A%84%E6%93%8D%E4%BD%9C%E7%A0%81%E5%B0%86%E5%AF%BC%E8%87%B4%E5%BC%82%E5%B8%B8%EF%BC%8C%E8%80%8C%E4%B8%8D%E6%98%AF%E6%89%A7%E8%A1%8C%E4%BF%AE%E6%94%B9%E3%80%82%0A%2F%2F+StaticCall+executes+the+contract+associated+with+the+addr+with+the+given+input%0A%2F%2F+as+parameters+while+disallowing+any+modifications+to+the+state+during+the+call.%0A%2F%2F+Opcodes+that+attempt+to+perform+such+modifications+will+result+in+exceptions%0A%2F%2F+instead+of+performing+the+modifications.%0A%2F%2F+StaticCall%E4%B8%8D%E5%85%81%E8%AE%B8%E6%89%A7%E8%A1%8C%E4%BB%BB%E4%BD%95%E4%BF%AE%E6%94%B9%E7%8A%B6%E6%80%81%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%8C%0Afunc+%28evm+*EVM%29+StaticCall%28caller+ContractRef%2C+addr+common.Address%2C+input+%5B%5Dbyte%2C+gas+uint64%29+%28ret+%5B%5Dbyte%2C+leftOverGas+uint64%2C+err+error%29+%7B%0A%09if+evm.vmConfig.NoRecursion+%26amp%3B%26amp%3B+evm.depth+%26gt%3B+0+%7B%0A%09%09return+nil%2C+gas%2C+nil%0A%09%7D%0A%09%2F%2F%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E8%AF%95%E5%9B%BE%E5%9C%A8%E9%80%9A%E8%AF%9D%E6%B7%B1%E5%BA%A6%E9%99%90%E5%88%B6%E4%BB%A5%E4%B8%8A%E6%89%A7%E8%A1%8C%EF%BC%8C%E5%88%99%E4%BC%9A%E5%A4%B1%E8%B4%A5%0A%09%2F%2F+Fail+if+we%27re+trying+to+execute+above+the+call+depth+limit%0A%09if+evm.depth+%26gt%3B+int%28params.CallCreateDepth%29+%7B%0A%09%09return+nil%2C+gas%2C+ErrDepth%0A%09%7D%0A%09%2F%2F%E7%A1%AE%E4%BF%9Dreadonly%E5%8F%AA%E5%9C%A8%E6%88%91%E4%BB%AC%E4%B8%8D%E6%98%AF%E5%8F%AA%E8%AF%BB%E7%9A%84%E6%97%B6%E5%80%99%E6%89%8D%E8%A2%AB%E8%AE%BE%E7%BD%AE%EF%BC%8C%E4%BD%86%E6%98%AF%E8%BF%99%E4%B9%9F%E7%A1%AE%E4%BF%9Dreadonly%E6%A0%87%E5%BF%97%E4%B8%8D%E4%BC%9A%E8%A2%AB%E5%88%A0%E9%99%A4%E4%BB%A5%E7%94%A8%E4%BA%8E%E5%AD%90%E8%B0%83%E7%94%A8%E3%80%82%0A%09%2F%2F+Make+sure+the+readonly+is+only+set+if+we+aren%27t+in+readonly+yet%0A%09%2F%2F+this+makes+also+sure+that+the+readonly+flag+isn%27t+removed+for%0A%09%2F%2F+child+calls.%0A%09if+%21evm.interpreter.readOnly+%7B%0A%09%09evm.interpreter.readOnly+%3D+true%0A%09%09defer+func%28%29+%7B+evm.interpreter.readOnly+%3D+false+%7D%28%29%0A%09%7D%0A%0A%09var+%28%0A%09%09to+++++++%3D+AccountRef%28addr%29%0A%09%09snapshot+%3D+evm.StateDB.Snapshot%28%29%0A%09%29%0A%09%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%90%88%E7%BA%A6%E5%B9%B6%E8%AE%BE%E7%BD%AEEVM%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82+%E8%AF%A5%E5%90%88%E5%90%8C%E4%BB%85%E9%99%90%E4%BA%8E%E6%AD%A4%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E7%8E%AF%E5%A2%83%E3%80%82%0A%09%2F%2F+Initialise+a+new+contract+and+set+the+code+that+is+to+be+used+by+the%0A%09%2F%2F+EVM.+The+contract+is+a+scoped+environment+for+this+execution+context%0A%09%2F%2F+only.%0A%09contract+%3A%3D+NewContract%28caller%2C+to%2C+new%28big.Int%29%2C+gas%29%0A%09contract.SetCallCode%28%26amp%3Baddr%2C+evm.StateDB.GetCodeHash%28addr%29%2C+evm.StateDB.GetCode%28addr%29%29%0A%09%2F%2F%E5%BD%93EVM%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%E6%88%96%E8%AE%BE%E7%BD%AE%E4%B8%8A%E8%BF%B0%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E6%81%A2%E5%A4%8D%E5%BF%AB%E7%85%A7%E5%B9%B6%E6%B6%88%E8%80%97%E5%89%A9%E4%BD%99%E7%9A%84%E6%B0%94%E4%BD%93%E3%80%82+%E5%8F%A6%E5%A4%96%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E5%9C%A8Homestead%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B9%9F%E4%BB%A3%E8%A1%A8%E4%BA%86%E4%BB%A3%E7%A0%81%E5%AD%98%E5%82%A8%E7%93%A6%E6%96%AF%E9%94%99%E8%AF%AF%E3%80%82%0A%09%2F%2F+When+an+error+was+returned+by+the+EVM+or+when+setting+the+creation+code%0A%09%2F%2F+above+we+revert+to+the+snapshot+and+consume+any+gas+remaining.+Additionally%0A%09%2F%2F+when+we%27re+in+Homestead+this+also+counts+for+code+storage+gas+errors.%0A%09ret%2C+err+%3D+run%28evm%2C+contract%2C+input%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09evm.StateDB.RevertToSnapshot%28snapshot%29%0A%09%09if+err+%21%3D+errExecutionReverted+%7B%0A%09%09%09contract.UseGas%28contract.Gas%29%0A%09%09%7D%0A%09%7D%0A%09return+ret%2C+contract.Gas%2C+err%0A%7D%0A%2F%2F%E5%90%88%E7%BA%A6%E5%88%9B%E5%BB%BA+Create+%E4%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%90%88%E7%BA%A6%E3%80%82%0A%2F%2F+Create+creates+a+new+contract+using+code+as+deployment+code.%0Afunc+%28evm+*EVM%29+Create%28caller+ContractRef%2C+code+%5B%5Dbyte%2C+gas+uint64%2C+value+*big.Int%29+%28ret+%5B%5Dbyte%2C+contractAddr+common.Address%2C+leftOverGas+uint64%2C+err+error%29+%7B%0A%2F%2F1%E6%A3%80%E6%9F%A5%E4%BA%A4%E6%98%93%0A%09%2F%2F+Depth+check+execution.+Fail+if+we%27re+trying+to+execute+above+the%0A%09%2F%2F+limit.%0A%09%2F%2F%E6%B7%B1%E5%BA%A6%E6%A3%80%E6%9F%A5%E6%89%A7%E8%A1%8C%E3%80%82+%E5%A6%82%E6%9E%9C%E6%88%91%E4%BB%AC%E8%AF%95%E5%9B%BE%E8%B6%85%E5%87%BA%E9%99%90%E5%88%B6%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5%E3%80%82%0A%09if+evm.depth+%26gt%3B+int%28params.CallCreateDepth%29+%7B%0A%09%09return+nil%2C+common.Address%7B%7D%2C+gas%2C+ErrDepth%0A%09%7D%0A%09if+%21evm.CanTransfer%28evm.StateDB%2C+caller.Address%28%29%2C+value%29+%7B%0A%09%09return+nil%2C+common.Address%7B%7D%2C+gas%2C+ErrInsufficientBalance%0A%09%7D%0A%09%2F%2F+%E7%A1%AE%E4%BF%9D%E7%89%B9%E5%AE%9A%E7%9A%84%E5%9C%B0%E5%9D%80%E6%B2%A1%E6%9C%89%E5%90%88%E7%BA%A6%E5%AD%98%E5%9C%A8%0A%09%2F%2F+Ensure+there%27s+no+existing+contract+already+at+the+designated+address%0A%09nonce+%3A%3D+evm.StateDB.GetNonce%28caller.Address%28%29%29%0A%09evm.StateDB.SetNonce%28caller.Address%28%29%2C+nonce%2B1%29%0A%2F%2F2%E6%96%B0%E5%9C%B0%E5%9D%80contractAddr%EF%BC%8C%E4%BD%9C%E4%B8%BA%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%85%A5%E6%96%B9%E5%9C%B0%E5%9D%80%EF%BC%8C%E4%BA%A6%E4%BD%9C%E4%B8%BAContract%E7%9A%84self%E5%9C%B0%E5%9D%80%EF%BC%9B%0A%09contractAddr+%3D+crypto.CreateAddress%28caller.Address%28%29%2C+nonce%29%0A%09contractHash+%3A%3D+evm.StateDB.GetCodeHash%28contractAddr%29%0A%09if+evm.StateDB.GetNonce%28contractAddr%29+%21%3D+0+%7C%7C+%28contractHash+%21%3D+%28common.Hash%7B%7D%29+%26amp%3B%26amp%3B+contractHash+%21%3D+emptyCodeHash%29+%7B%0A%09%09return+nil%2C+common.Address%7B%7D%2C+0%2C+ErrContractAddressCollision%0A%09%7D%0A%09%2F%2F+Create+a+new+account+on+the+state%0A%09snapshot+%3A%3D+evm.StateDB.Snapshot%28%29%2F%2F%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAStateDB%E7%9A%84%E5%BF%AB%E7%85%A7%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9B%9E%E6%BB%9A%0A%09evm.StateDB.CreateAccount%28contractAddr%29%2F%2F%E5%88%9B%E5%BB%BA%E8%B4%A6%E6%88%B7%0A%09if+evm.ChainConfig%28%29.IsEIP158%28evm.BlockNumber%29+%7B%0A%09%09evm.StateDB.SetNonce%28contractAddr%2C+1%29%2F%2F%E8%AE%BE%E7%BD%AEnonce%0A%09%7D%0A%09%2F%2F3%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%0A%09evm.Transfer%28evm.StateDB%2C+caller.Address%28%29%2C+contractAddr%2C+value%29%2F%2F%E8%BD%AC%E8%B4%A6%0A%09%2F%2F%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%A5%91%E7%BA%A6%E5%B9%B6%E8%AE%BE%E7%BD%AEE%E5%B0%86%E4%BD%BF%E7%94%A8%E7%9A%84%E4%BB%A3%E7%A0%81%E8%AF%A5%E5%A5%91%E7%BA%A6%E6%98%AF%E4%B8%80%E4%B8%AA%E4%BB%85%E9%99%90%E4%BA%8E%E6%AD%A4%E6%89%A7%E8%A1%8C%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BD%9C%E7%94%A8%E5%9F%9F%E8%A7%A3%E9%87%8A%E3%80%82%0A%09%2F%2F+initialise+a+new+contract+and+set+the+code+that+is+to+be+used+by+the%0A%09%2F%2F+E+The+contract+is+a+scoped+evmironment+for+this+execution+context%0A%09%2F%2F+only.%0A%09%2F%2F4%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAContract%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%B6%E6%88%90%E5%91%98%E5%8F%98%E9%87%8Fcaller%2C+self%28addr%29%2C+value%E5%92%8Cga%0A%09contract+%3A%3D+NewContract%28caller%2C+AccountRef%28contractAddr%29%2C+value%2C+gas%29%0A%09%2F%2F%295%E8%B5%8B%E5%80%BCContract%E5%AF%B9%E8%B1%A1%E7%9A%84Code%2C+CodeHash%2C+CodeAddr%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%2F%2Fdb%E4%B8%AD%E5%B0%9A%E6%97%A0%E4%B8%8E%E8%AF%A5%E5%9C%B0%E5%9D%80%E7%9B%B8%E5%85%B3%E7%9A%84Code%E4%BF%A1%E6%81%AF%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BC%9A%E5%B0%86%E7%B1%BB%E5%9E%8B%E4%B8%BA%5B%5Dbyte%E7%9A%84%E5%85%A5%E5%8F%82code%EF%BC%8C%E8%B5%8B%E5%80%BC%E4%BA%88Contract%E5%AF%B9%E8%B1%A1%E7%9A%84Code%E6%88%90%E5%91%98%0A%09contract.SetCallCode%28%26amp%3BcontractAddr%2C+crypto.Keccak256Hash%28code%29%2C+code%29%0A%0A%09if+evm.vmConfig.NoRecursion+%26amp%3B%26amp%3B+evm.depth+%26gt%3B+0+%7B%0A%09%09return+nil%2C+contractAddr%2C+gas%2C+nil%0A%09%7D%0A%0A%09if+evm.vmConfig.Debug+%26amp%3B%26amp%3B+evm.depth+%3D%3D+0+%7B%0A%09%09evm.vmConfig.Tracer.CaptureStart%28caller.Address%28%29%2C+contractAddr%2C+true%2C+code%2C+gas%2C+value%29%0A%09%7D%0A%09start+%3A%3D+time.Now%28%29%0A%2F%2F6%E8%B0%83%E7%94%A8run%28%29%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E8%AF%A5%E5%90%88%E7%BA%A6%E7%9A%84%E6%8C%87%E4%BB%A4%0A%09ret%2C+err+%3D+run%28evm%2C+contract%2C+nil%29+%2F%2F%E6%89%A7%E8%A1%8C%E5%90%88%E7%BA%A6%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BB%A3%E7%A0%81%0A%09%2F%2F+%E6%A3%80%E6%9F%A5%E5%88%9D%E5%A7%8B%E5%8C%96%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81%E7%9A%84%E9%95%BF%E5%BA%A6%E4%B8%8D%E8%B6%85%E8%BF%87%E9%99%90%E5%88%B6%0A%09%2F%2F+check+whether+the+max+code+size+has+been+exceeded%0A%09maxCodeSizeExceeded+%3A%3D+evm.ChainConfig%28%29.IsEIP158%28evm.BlockNumber%29+%26amp%3B%26amp%3B+len%28ret%29+%26gt%3B+params.MaxCodeSize%0A%09%2F%2F+if+the+contract+creation+ran+successfully+and+no+errors+were+returned%0A%09%2F%2F+calculate+the+gas+required+to+store+the+code.+If+the+code+could+not%0A%09%2F%2F+be+stored+due+to+not+enough+gas+set+an+error+and+let+it+be+handled%0A%09%2F%2F+by+the+error+checking+condition+below.%0A%09%2F%2F%E5%A6%82%E6%9E%9C%E5%90%88%E5%90%8C%E5%88%9B%E5%BB%BA%E6%88%90%E5%8A%9F%E5%B9%B6%E4%B8%94%E6%B2%A1%E6%9C%89%E9%94%99%E8%AF%AF%E8%BF%94%E5%9B%9E%EF%BC%8C%E5%88%99%E8%AE%A1%E7%AE%97%E5%AD%98%E5%82%A8%E4%BB%A3%E7%A0%81%E6%89%80%E9%9C%80%E7%9A%84GAS%E3%80%82+%E5%A6%82%E6%9E%9C%E7%94%B1%E4%BA%8E%E6%B2%A1%E6%9C%89%E8%B6%B3%E5%A4%9F%E7%9A%84GAS%E8%80%8C%E5%AF%BC%E8%87%B4%E4%BB%A3%E7%A0%81%E4%B8%8D%E8%83%BD%E8%A2%AB%E5%AD%98%E5%82%A8%E8%AE%BE%E7%BD%AE%E9%94%99%E8%AF%AF%EF%BC%8C%E5%B9%B6%E9%80%9A%E8%BF%87%E4%B8%8B%E9%9D%A2%E7%9A%84%E9%94%99%E8%AF%AF%E6%A3%80%E6%9F%A5%E6%9D%A1%E4%BB%B6%E6%9D%A5%E5%A4%84%E7%90%86%E3%80%82%0A%09if+err+%3D%3D+nil+%26amp%3B%26amp%3B+%21maxCodeSizeExceeded+%7B%0A%09%09createDataGas+%3A%3D+uint64%28len%28ret%29%29+*+params.CreateDataGas%0A%09%09if+contract.UseGas%28createDataGas%29+%7B%0A%09%09%09evm.StateDB.SetCode%28contractAddr%2C+ret%29%0A%09%09%7D+else+%7B%0A%09%09%09err+%3D+ErrCodeStoreOutOfGas%0A%09%09%7D%0A%09%7D%0A%09%2F%2F%E5%BD%93EVM%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%E6%88%96%E8%AE%BE%E7%BD%AE%E4%B8%8A%E8%BF%B0%E5%88%9B%E5%BB%BA%E4%BB%A3%E7%A0%81%E6%97%B6%EF%BC%8C%E6%88%91%E4%BB%AC%E6%81%A2%E5%A4%8D%E5%BF%AB%E7%85%A7%E5%B9%B6%E6%B6%88%E8%80%97%E5%89%A9%E4%BD%99%E7%9A%84%E6%B0%94%E4%BD%93%E3%80%82+%E5%8F%A6%E5%A4%96%EF%BC%8C%E5%BD%93%E6%88%91%E4%BB%AC%E5%9C%A8%E5%AE%B6%E5%9B%AD%E6%97%B6%EF%BC%8C%E8%BF%99%E4%B9%9F%E4%BB%A3%E8%A1%A8%E4%BA%86%E4%BB%A3%E7%A0%81%E5%AD%98%E5%82%A8%E7%93%A6%E6%96%AF%E9%94%99%E8%AF%AF%E3%80%82%0A%09%2F%2F+When+an+error+was+returned+by+the+EVM+or+when+setting+the+creation+code%0A%09%2F%2F+above+we+revert+to+the+snapshot+and+consume+any+gas+remaining.+Additionally%0A%09%2F%2F+when+we%27re+in+homestead+this+also+counts+for+code+storage+gas+errors.%0A%09%2F%2F+%E5%BD%93%E9%94%99%E8%AF%AF%E8%BF%94%E5%9B%9E%E6%88%91%E4%BB%AC%E5%9B%9E%E6%BB%9A%E4%BF%AE%E6%94%B9%EF%BC%8C%0A%09if+maxCodeSizeExceeded+%7C%7C+%28err+%21%3D+nil+%26amp%3B%26amp%3B+%28evm.ChainConfig%28%29.IsHomestead%28evm.BlockNumber%29+%7C%7C+err+%21%3D+ErrCodeStoreOutOfGas%29%29+%7B%0A%09%09evm.StateDB.RevertToSnapshot%28snapshot%29%0A%09%09if+err+%21%3D+errExecutionReverted+%7B%0A%09%09%09contract.UseGas%28contract.Gas%29%0A%09%09%7D%0A%09%7D%2F%2F%E5%A6%82%E6%9E%9C%E5%9C%A8err%E4%BB%8D%E7%84%B6%E4%B8%BA%E7%A9%BA%E6%97%B6%E5%90%88%E5%90%8C%E4%BB%A3%E7%A0%81%E5%A4%A7%E5%B0%8F%E8%B6%85%E8%BF%87%E6%9C%80%E5%A4%A7%E5%80%BC%EF%BC%8C%E5%88%99%E5%88%86%E9%85%8Derr%E3%80%82%0A%09%2F%2F+Assign+err+if+contract+code+size+exceeds+the+max+while+the+err+is+still+empty.%0A%09if+maxCodeSizeExceeded+%26amp%3B%26amp%3B+err+%3D%3D+nil+%7B%0A%09%09err+%3D+errMaxCodeSizeExceeded%0A%09%7D%0A%09if+evm.vmConfig.Debug+%26amp%3B%26amp%3B+evm.depth+%3D%3D+0+%7B%0A%09%09evm.vmConfig.Tracer.CaptureEnd%28ret%2C+gas-contract.Gas%2C+time.Since%28start%29%2C+err%29%0A%09%7D%0A%09%2F%2F7%E5%B0%86%E6%9C%AC%E6%AC%A1%E6%89%A7%E8%A1%8C%E5%90%88%E7%BA%A6%E7%9A%84%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%EF%BC%8C%E4%BD%9C%E4%B8%BAcontractAddr%E6%89%80%E5%AF%B9%E5%BA%94%E8%B4%A6%E6%88%B7%28stateObject%E5%AF%B9%E8%B1%A1%29%E7%9A%84Code%E5%82%A8%E5%AD%98%E8%B5%B7%E6%9D%A5%EF%BC%8C%E4%BB%A5%E5%A4%87%E4%B8%8B%E6%AC%A1%E8%B0%83%E7%94%A8%E3%80%82%0A%09return+ret%2C+contractAddr%2C+contract.Gas%2C+err%0A%7D%0A%2F%2F+ChainConfig%E8%BF%94%E5%9B%9E%E7%8E%AF%E5%A2%83%E7%9A%84%E9%93%BE%E9%85%8D%E7%BD%AE%0A%2F%2F+ChainConfig+returns+the+environment%27s+chain+configuration%0Afunc+%28evm+*EVM%29+ChainConfig%28%29+*params.ChainConfig+%7B+return+evm.chainConfig+%7D%0A%2F%2F%E8%A7%A3%E9%87%8A%E5%99%A8%E8%BF%94%E5%9B%9EEVM%E8%A7%A3%E9%87%8A%E5%99%A8%0A%2F%2F+Interpreter+returns+the+EVM+interpreter%0Afunc+%28evm+*EVM%29+Interpreter%28%29+*Interpreter+%7B+return+evm.interpreter+%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3E%2F%2F+Copyright+2015+The+go-ethereum+Authors%0A%2F%2F+This+file+is+part+of+the+go-ethereum+library.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+free+software%3A+you+can+redistribute+it+and%2For+modify%0A%2F%2F+it+under+the+terms+of+the+GNU+Lesser+General+Public+License+as+published+by%0A%2F%2F+the+Free+Software+Foundation%2C+either+version+3+of+the+License%2C+or%0A%2F%2F+%28at+your+option%29+any+later+version.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+distributed+in+the+hope+that+it+will+be+useful%2C%0A%2F%2F+but+WITHOUT+ANY+WARRANTY%3B+without+even+the+implied+warranty+of%0A%2F%2F+MERCHANTABILITY+or+FITNESS+FOR+A+PARTICULAR+PURPOSE.+See+the%0A%2F%2F+GNU+Lesser+General+Public+License+for+more+details.%0A%2F%2F%0A%2F%2F+You+should+have+received+a+copy+of+the+GNU+Lesser+General+Public+License%0A%2F%2F+along+with+the+go-ethereum+library.+If+not%2C+see+%26lt%3Bhttp%3A%2F%2Fwww.gnu.org%2Flicenses%2F%26gt%3B.%0A%0Apackage+vm%0A%0Aimport+%28%0A%09%22math%2Fbig%22%0A%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcommon%22%0A%29%0A%2F%2Fcontract+%E4%BB%A3%E8%A1%A8%E4%BA%86%E4%BB%A5%E5%A4%AA%E5%9D%8A+state+database%E9%87%8C%E9%9D%A2%E7%9A%84%E4%B8%80%E4%B8%AA%E5%90%88%E7%BA%A6%E3%80%82%E5%8C%85%E5%90%AB%E4%BA%86%E5%90%88%E7%BA%A6%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%B0%83%E7%94%A8%E5%8F%82%E6%95%B0%E3%80%82%0A%2F%2F+ContractRef+is+a+reference+to+the+contract%27s+backing+object%0A%2F%2F+ContractRef%E6%98%AF%E5%AF%B9%E5%90%88%E5%90%8C%E6%94%AF%E6%8C%81%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%BC%95%E7%94%A8%0Atype+ContractRef+interface+%7B%0A%09Address%28%29+common.Address%0A%7D%0A%0A%2F%2F+AccountRef%E5%AE%9E%E7%8E%B0ContractRef%E3%80%82%0A%2F%2F+EVM%E5%88%9D%E5%A7%8B%E5%8C%96%E6%9C%9F%E9%97%B4%E4%BD%BF%E7%94%A8%E5%B8%90%E6%88%B7%E5%BC%95%E7%94%A8%EF%BC%8C%E4%B8%BB%E8%A6%81%E7%94%A8%E4%BA%8E%E8%8E%B7%E5%8F%96%E5%9C%B0%E5%9D%80%E3%80%82+%E5%88%A0%E9%99%A4%E8%BF%99%E4%B8%AA%E5%AF%B9%E8%B1%A1%E8%AF%81%E6%98%8E%E6%98%AF%E5%9B%B0%E9%9A%BE%E7%9A%84%EF%BC%8C%E5%9B%A0%E4%B8%BA%E7%BC%93%E5%AD%98%E7%9A%84%E8%B7%B3%E8%BD%AC%E7%9B%AE%E7%9A%84%E5%9C%B0%0A%2F%2F%E6%98%AF%E4%BB%8E%E4%BD%9C%E4%B8%BAContractRef%E7%9A%84%E7%88%B6%E5%90%88%E5%90%8C%EF%BC%88%E5%8D%B3%E8%B0%83%E7%94%A8%E8%80%85%EF%BC%89%E8%8E%B7%E5%8F%96%E7%9A%84%E3%80%82%0A%2F%2F+AccountRef+implements+ContractRef.%0A%2F%2F%0A%2F%2F+Account+references+are+used+during+EVM+initialisation+and%0A%2F%2F+it%27s+primary+use+is+to+fetch+addresses.+Removing+this+object%0A%2F%2F+proves+difficult+because+of+the+cached+jump+destinations+which%0A%2F%2F+are+fetched+from+the+parent+contract+%28i.e.+the+caller%29%2C+which%0A%2F%2F+is+a+ContractRef.%0Atype+AccountRef+common.Address%0A%2F%2F+Address%E5%B0%86AccountRef%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%9C%B0%E5%9D%80%0A%2F%2F+Address+casts+AccountRef+to+a+Address%0Afunc+%28ar+AccountRef%29+Address%28%29+common.Address+%7B+return+%28common.Address%29%28ar%29+%7D%0A%2F%2F%E5%90%88%E7%BA%A6%E4%BB%A3%E8%A1%A8%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%BB%A5%E5%A4%AA%E5%9D%8A%E5%90%88%E7%BA%A6%E3%80%82+%E5%AE%83%E5%8C%85%E5%90%AB%E5%90%88%E5%90%8C%E4%BB%A3%E7%A0%81%EF%BC%8C%E8%B0%83%E7%94%A8%E5%8F%82%E6%95%B0%E3%80%82+%E5%90%88%E5%90%8C%E5%AE%9E%E6%96%BDContractRef%0A%2F%2F+Contract+represents+an+ethereum+contract+in+the+state+database.+It+contains%0A%2F%2F+the+the+contract+code%2C+calling+arguments.+Contract+implements+ContractRef%0Atype+Contract+struct+%7B%0A%09%2F%2F+CallerAddress%E6%98%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E6%AD%A4%E5%90%88%E5%90%8C%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85%E7%9A%84%E7%BB%93%E6%9E%9C%E3%80%82+%E4%BD%86%E6%98%AF%EF%BC%8C%E5%BD%93%E2%80%9C%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95%E2%80%9D%E8%A2%AB%E5%A7%94%E6%89%98%E6%97%B6%EF%BC%8C%E8%AF%A5%E5%80%BC%E9%9C%80%E8%A6%81%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%BA%E8%B0%83%E7%94%A8%E8%80%85%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85%E7%9A%84%E5%80%BC%E3%80%82%0A%09%2F%2F+CallerAddress+is+the+result+of+the+caller+which+initialised+this%0A%09%2F%2F+contract.+However+when+the+%22call+method%22+is+delegated+this+value%0A%09%2F%2F+needs+to+be+initialised+to+that+of+the+caller%27s+caller.%0A%09%2F%2F+CallerAddress%E6%98%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%99%E4%B8%AA%E5%90%88%E7%BA%A6%E7%9A%84%E4%BA%BA%E3%80%82+%E5%A6%82%E6%9E%9C%E6%98%AFdelegate%EF%BC%8C%E8%BF%99%E4%B8%AA%E5%80%BC%E8%A2%AB%E8%AE%BE%E7%BD%AE%E4%B8%BA%E8%B0%83%E7%94%A8%E8%80%85%E7%9A%84%E8%B0%83%E7%94%A8%E8%80%85%E3%80%82%0A%09CallerAddress+common.Address%0A%09caller++++++++ContractRef%2F%2Fcaller%E6%98%AF%E8%BD%AC%E5%B8%90%E8%BD%AC%E5%87%BA%E6%96%B9%E5%9C%B0%E5%9D%80%28%E8%B4%A6%E6%88%B7%29%0A%09self++++++++++ContractRef%2F%2Fself%E6%98%AF%E8%BD%AC%E5%85%A5%E6%96%B9%E5%9C%B0%E5%9D%80%0A%0A%09jumpdests+destinations+%2F%2F+result+of+JUMPDEST+analysis.+JUMPDEST%E6%8C%87%E4%BB%A4%E7%9A%84%E5%88%86%E6%9E%90%0A%0A%09Code+++++%5B%5Dbyte+%2F%2F%E4%BB%A3%E7%A0%81%EF%BC%8C%E6%8C%87%E4%BB%A4%E6%95%B0%E7%BB%84%EF%BC%8C%E5%85%B6%E4%B8%AD%E6%AF%8F%E4%B8%80%E4%B8%AAbyte%E9%83%BD%E5%AF%B9%E5%BA%94%E4%BA%8E%E4%B8%80%E4%B8%AA%E9%A2%84%E5%AE%9A%E4%B9%89%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4%0A%09CodeHash+common.Hash%2F%2F%E4%BB%A3%E7%A0%81%E7%9A%84HASH%EF%BC%8CCode%E7%9A%84RLP%E5%93%88%E5%B8%8C%E5%80%BC%0A%09CodeAddr+*common.Address%2F%2F%E4%BB%A3%E7%A0%81%E5%9C%B0%E5%9D%80%0A%09Input++++%5B%5Dbyte+%2F%2F+%E5%85%A5%E5%8F%82%EF%BC%8C%E6%95%B0%E6%8D%AE%E6%95%B0%E7%BB%84%EF%BC%8C%E6%98%AF%E6%8C%87%E4%BB%A4%E6%89%80%E6%93%8D%E4%BD%9C%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86%E5%90%88%0A%0A%09Gas+++uint64%2F%2F+%E5%90%88%E7%BA%A6%E8%BF%98%E6%9C%89%E5%A4%9A%E5%B0%91Gas%0A%09value+*big.Int%0A%0A%09Args+%5B%5Dbyte%2F%2F%E6%98%AF%E5%8F%82%E6%95%B0%0A%0A%09DelegateCall+bool%0A%7D%0A%2F%2F+NewContract%E8%BF%94%E5%9B%9E%E6%89%A7%E8%A1%8CEVM%E7%9A%84%E6%96%B0%E5%90%88%E7%BA%A6%E7%8E%AF%E5%A2%83%0A%2F%2F+NewContract+returns+a+new+contract+environment+for+the+execution+of+EVM.%0Afunc+NewContract%28caller+ContractRef%2C+object+ContractRef%2C+value+*big.Int%2C+gas+uint64%29+*Contract+%7B%0A%09c+%3A%3D+%26amp%3BContract%7BCallerAddress%3A+caller.Address%28%29%2C+caller%3A+caller%2C+self%3A+object%2C+Args%3A+nil%7D%0A%0A%09if+parent%2C+ok+%3A%3D+caller.%28*Contract%29%3B+ok+%7B%0A%09%09%2F%2F+%E5%A6%82%E6%9E%9C+caller+%E6%98%AF%E4%B8%80%E4%B8%AA%E5%90%88%E7%BA%A6%EF%BC%8C%E8%AF%B4%E6%98%8E%E6%98%AF%E5%90%88%E7%BA%A6%E8%B0%83%E7%94%A8%E4%BA%86%E6%88%91%E4%BB%AC%E3%80%82+jumpdests%E8%AE%BE%E7%BD%AE%E4%B8%BAcaller%E7%9A%84jumpdests%0A%09%09%2F%2F+Reuse+JUMPDEST+analysis+from+parent+context+if+available.%0A%09%09c.jumpdests+%3D+parent.jumpdests%0A%09%7D+else+%7B%0A%09%09c.jumpdests+%3D+make%28destinations%29%0A%09%7D%0A%0A%09%2F%2F+Gas+should+be+a+pointer+so+it+can+safely+be+reduced+through+the+run%0A%09%2F%2F+This+pointer+will+be+off+the+state+transition%0A%09c.Gas+%3D+gas%0A%09%2F%2F+ensures+a+value+is+set%0A%09c.value+%3D+value%0A%0A%09return+c%0A%7D%0A%2F%2FAsDelegate%E5%B0%86%E5%90%88%E7%BA%A6%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%A7%94%E6%89%98%E8%B0%83%E7%94%A8%E5%B9%B6%E8%BF%94%E5%9B%9E%E5%BD%93%E5%89%8D%E5%90%88%E5%90%8C%EF%BC%88%E7%94%A8%E4%BA%8E%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%EF%BC%89%0A%2F%2F+AsDelegate+sets+the+contract+to+be+a+delegate+call+and+returns+the+current%0A%2F%2F+contract+%28for+chaining+calls%29%0Afunc+%28c+*Contract%29+AsDelegate%28%29+*Contract+%7B%0A%09c.DelegateCall+%3D+true%0A%09%2F%2F+NOTE%3A+caller+must%2C+at+all+times+be+a+contract.+It+should+never+happen%0A%09%2F%2F+that+caller+is+something+other+than+a+Contract.%0A%09parent+%3A%3D+c.caller.%28*Contract%29%0A%09c.CallerAddress+%3D+parent.CallerAddress%0A%09c.value+%3D+parent.value%0A%0A%09return+c%0A%7D%0A%2F%2FGetOp+%E7%94%A8%E6%9D%A5%E8%8E%B7%E5%8F%96%E4%B8%8B%E4%B8%80%E8%B7%B3%E6%8C%87%E4%BB%A4%0A%2F%2F+GetOp+returns+the+n%27th+element+in+the+contract%27s+byte+array%0Afunc+%28c+*Contract%29+GetOp%28n+uint64%29+OpCode+%7B%0A%09return+OpCode%28c.GetByte%28n%29%29%0A%7D%0A%0A%2F%2F+GetByte+returns+the+n%27th+byte+in+the+contract%27s+byte+array%0Afunc+%28c+*Contract%29+GetByte%28n+uint64%29+byte+%7B%0A%09if+n+%26lt%3B+uint64%28len%28c.Code%29%29+%7B%0A%09%09return+c.Code%5Bn%5D%0A%09%7D%0A%0A%09return+0%0A%7D%0A%0A%2F%2F+Caller+returns+the+caller+of+the+contract.%0A%2F%2F%0A%2F%2F+Caller+will+recursively+call+caller+when+the+contract+is+a+delegate%0A%2F%2F+call%2C+including+that+of+caller%27s+caller.%0Afunc+%28c+*Contract%29+Caller%28%29+common.Address+%7B%0A%09return+c.CallerAddress%0A%7D%0A%2F%2FUseGas%E4%BD%BF%E7%94%A8Gas%E3%80%82%0A%2F%2F+UseGas+attempts+the+use+gas+and+subtracts+it+and+returns+true+on+success%0Afunc+%28c+*Contract%29+UseGas%28gas+uint64%29+%28ok+bool%29+%7B%0A%09if+c.Gas+%26lt%3B+gas+%7B%0A%09%09return+false%0A%09%7D%0A%09c.Gas+-%3D+gas%0A%09return+true%0A%7D%0A%2F%2F%E5%BD%93Contract%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AAContractRef%E6%8E%A5%E5%8F%A3%E5%87%BA%E7%8E%B0%E6%97%B6%EF%BC%8C%E5%AE%83%E8%BF%94%E5%9B%9E%E7%9A%84%E5%9C%B0%E5%9D%80%E5%B0%B1%E6%98%AF%E5%AE%83%E7%9A%84self%E5%9C%B0%E5%9D%80%0A%2F%2F+Address+returns+the+contracts+address%0Afunc+%28c+*Contract%29+Address%28%29+common.Address+%7B%0A%09return+c.self.Address%28%29%0A%7D%0A%0A%2F%2F+Value+returns+the+contracts+value+%28sent+to+it+from+it%27s+caller%29%0Afunc+%28c+*Contract%29+Value%28%29+*big.Int+%7B%0A%09return+c.value%0A%7D%0A%2F%2FSetCode+%EF%BC%8CSetCallCode+%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%A0%81%E3%80%82%0A%2F%2F+SetCode+sets+the+code+to+the+contract%0Afunc+%28self+*Contract%29+SetCode%28hash+common.Hash%2C+code+%5B%5Dbyte%29+%7B%0A%09self.Code+%3D+code%0A%09self.CodeHash+%3D+hash%0A%7D%0A%0A%2F%2F+SetCallCode+sets+the+code+of+the+contract+and+address+of+the+backing+data%0A%2F%2F+object%0Afunc+%28self+*Contract%29+SetCallCode%28addr+*common.Address%2C+hash+common.Hash%2C+code+%5B%5Dbyte%29+%7B%0A%09self.Code+%3D+code%0A%09self.CodeHash+%3D+hash%0A%09self.CodeAddr+%3D+addr%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3E%2F%2F+Copyright+2015+The+go-ethereum+Authors%0A%2F%2F+This+file+is+part+of+the+go-ethereum+library.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+free+software%3A+you+can+redistribute+it+and%2For+modify%0A%2F%2F+it+under+the+terms+of+the+GNU+Lesser+General+Public+License+as+published+by%0A%2F%2F+the+Free+Software+Foundation%2C+either+version+3+of+the+License%2C+or%0A%2F%2F+%28at+your+option%29+any+later+version.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+distributed+in+the+hope+that+it+will+be+useful%2C%0A%2F%2F+but+WITHOUT+ANY+WARRANTY%3B+without+even+the+implied+warranty+of%0A%2F%2F+MERCHANTABILITY+or+FITNESS+FOR+A+PARTICULAR+PURPOSE.+See+the%0A%2F%2F+GNU+Lesser+General+Public+License+for+more+details.%0A%2F%2F%0A%2F%2F+You+should+have+received+a+copy+of+the+GNU+Lesser+General+Public+License%0A%2F%2F+along+with+the+go-ethereum+library.+If+not%2C+see+%26lt%3Bhttp%3A%2F%2Fwww.gnu.org%2Flicenses%2F%26gt%3B.%0A%0Apackage+core%0A%0Aimport+%28%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcommon%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fconsensus%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fconsensus%2Fmisc%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcore%2Fstate%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcore%2Ftypes%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcore%2Fvm%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcrypto%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fparams%22%0A%29%0A%2F%2F%E6%89%A7%E8%A1%8Ctx%E7%9A%84%E5%85%A5%E5%8F%A3%E5%87%BD%E6%95%B0%E6%98%AFStateProcessor%E7%9A%84Process%28%29%E5%87%BD%E6%95%B0%0A%2F%2F+StateProcessor+is+a+basic+Processor%2C+which+takes+care+of+transitioning%0A%2F%2F+state+from+one+point+to+another.%0A%2F%2FStateTransition%E6%98%AF%E7%94%A8%E6%9D%A5%E5%A4%84%E7%90%86%E4%B8%80%E4%B8%AA%E4%B8%80%E4%B8%AA%E7%9A%84%E4%BA%A4%E6%98%93%E7%9A%84%E3%80%82%E9%82%A3%E4%B9%88StateProcessor%E5%B0%B1%E6%98%AF%E7%94%A8%E6%9D%A5%E5%A4%84%E7%90%86%E5%8C%BA%E5%9D%97%E7%BA%A7%E5%88%AB%E7%9A%84%E4%BA%A4%E6%98%93%E7%9A%84%E3%80%82%0A%2F%2F+StateProcessor+implements+Processor.%0Atype+StateProcessor+struct+%7B%0A%09config+*params.ChainConfig+%2F%2F+Chain+configuration+options%0A%09bc+++++*BlockChain+++++++++%2F%2F+Canonical+block+chain%0A%09engine+consensus.Engine++++%2F%2F+Consensus+engine+used+for+block+rewards%0A%7D%0A%2F%2F+NewStateProcessor%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84StateProcessor%E3%80%82%0A%2F%2F+NewStateProcessor+initialises+a+new+StateProcessor.%0Afunc+NewStateProcessor%28config+*params.ChainConfig%2C+bc+*BlockChain%2C+engine+consensus.Engine%29+*StateProcessor+%7B%0A%09return+%26amp%3BStateProcessor%7B%0A%09%09config%3A+config%2C%0A%09%09bc%3A+++++bc%2C%0A%09%09engine%3A+engine%2C%0A%09%7D%0A%7D%0A%2F%2FProcess%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%96%B9%E6%B3%95%E4%BC%9A%E8%A2%ABblockchain%E8%B0%83%E7%94%A8%E3%80%82%0A%2F%2F+Process+processes+the+state+changes+according+to+the+Ethereum+rules+by+running%0A%2F%2F+the+transaction+messages+using+the+statedb+and+applying+any+rewards+to+both%0A%2F%2F+the+processor+%28coinbase%29+and+any+included+uncles.%0A%2F%2F+Process+%E6%A0%B9%E6%8D%AE%E4%BB%A5%E5%A4%AA%E5%9D%8A%E8%A7%84%E5%88%99%E8%BF%90%E8%A1%8C%E4%BA%A4%E6%98%93%E4%BF%A1%E6%81%AF%E6%9D%A5%E5%AF%B9statedb%E8%BF%9B%E8%A1%8C%E7%8A%B6%E6%80%81%E6%94%B9%E5%8F%98%EF%BC%8C%E4%BB%A5%E5%8F%8A%E5%A5%96%E5%8A%B1%E6%8C%96%E7%9F%BF%E8%80%85%E6%88%96%E8%80%85%E6%98%AF%E5%85%B6%E4%BB%96%E7%9A%84%E5%8F%94%E7%88%B6%E8%8A%82%E7%82%B9%E3%80%82%0A%2F%2F+Process+returns+the+receipts+and+logs+accumulated+during+the+process+and%0A%2F%2F+returns+the+amount+of+gas+that+was+used+in+the+process.+If+any+of+the%0A%2F%2F+transactions+failed+to+execute+due+to+insufficient+gas+it+will+return+an+error.%0A%2F%2F+Process%E8%BF%94%E5%9B%9E%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%B4%AF%E8%AE%A1%E7%9A%84%E6%94%B6%E6%8D%AE%E5%92%8C%E6%97%A5%E5%BF%97%EF%BC%8C%E5%B9%B6%E8%BF%94%E5%9B%9E%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%9A%84Gas%E3%80%82+%E5%A6%82%E6%9E%9C%E7%94%B1%E4%BA%8EGas%E4%B8%8D%E8%B6%B3%E8%80%8C%E5%AF%BC%E8%87%B4%E4%BB%BB%E4%BD%95%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%B0%86%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%E3%80%82%0Afunc+%28p+*StateProcessor%29+Process%28block+*types.Block%2C+statedb+*state.StateDB%2C+cfg+vm.Config%29+%28types.Receipts%2C+%5B%5D*types.Log%2C+uint64%2C+error%29+%7B%0A%09var+%28%0A%09%09receipts+types.Receipts%0A%09%09usedGas++%3D+new%28uint64%29%0A%09%09header+++%3D+block.Header%28%29%0A%09%09allLogs++%5B%5D*types.Log%0A%09%09%2F%2FGasPool%E5%AF%B9%E8%B1%A1%E6%98%AF%E5%9C%A8%E4%B8%80%E4%B8%AABlock%E6%89%A7%E8%A1%8C%E5%BC%80%E5%A7%8B%E6%97%B6%E5%88%9B%E5%BB%BA%EF%BC%8C%E5%B9%B6%E5%9C%A8%E8%AF%A5Block%E5%86%85%E6%89%80%E6%9C%89tx%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%85%B1%E4%BA%AB%EF%BC%8C%E5%AF%B9%E4%BA%8E%E4%B8%80%E4%B8%AAtx%E7%9A%84%E6%89%A7%E8%A1%8C%E5%8F%AF%E8%A7%86%E4%B8%BA%E2%80%9C%E5%85%A8%E5%B1%80%E2%80%9D%E5%AD%98%E5%82%A8%E5%AF%B9%E8%B1%A1%EF%BC%9B%0A%09%09gp+++++++%3D+new%28GasPool%29.AddGas%28block.GasLimit%28%29%29%2F%2FGasPool+%E7%B1%BB%E5%9E%8B%E5%85%B6%E5%AE%9E%E5%B0%B1%E6%98%AFbig.Int%E3%80%82%E5%9C%A8%E4%B8%80%E4%B8%AABlock%E7%9A%84%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B%28%E5%8D%B3%E5%85%B6%E6%89%80%E6%9C%89tx%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%29%E4%B8%AD%EF%BC%8CGasPool+%E7%9A%84%E5%80%BC%E8%83%BD%E5%A4%9F%E5%91%8A%E8%AF%89%E4%BD%A0%EF%BC%8C%E5%89%A9%E4%B8%8B%E8%BF%98%E6%9C%89%E5%A4%9A%E5%B0%91Gas%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E3%80%82%0A%09%09%2F%2F+%E5%9C%A8%E6%AF%8F%E4%B8%80%E4%B8%AAtx%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8CEthereum+%E8%BF%98%E8%AE%BE%E8%AE%A1%E4%BA%86%E5%81%BF%E9%80%80%28refund%29%E7%8E%AF%E8%8A%82%EF%BC%8C%E6%89%80%E5%81%BF%E9%80%80%E7%9A%84Gas%E6%95%B0%E9%87%8F%E4%B9%9F%E4%BC%9A%E5%8A%A0%E5%88%B0%E8%BF%99%E4%B8%AAGasPool%E9%87%8C%E3%80%82%0A%09%29%0A%09%2F%2F+Mutate+the+the+block+and+state+according+to+any+hard-fork+specs%0A%09%2F%2F+DAO+%E4%BA%8B%E4%BB%B6%E7%9A%84%E7%A1%AC%E5%88%86%E5%8F%89%E5%A4%84%E7%90%86%0A%09if+p.config.DAOForkSupport+%26amp%3B%26amp%3B+p.config.DAOForkBlock+%21%3D+nil+%26amp%3B%26amp%3B+p.config.DAOForkBlock.Cmp%28block.Number%28%29%29+%3D%3D+0+%7B%0A%09%09misc.ApplyDAOHardFork%28statedb%29%0A%09%7D%0A%09%2F%2FProcess%28%29%E5%87%BD%E6%95%B0%E7%9A%84%E6%A0%B8%E5%BF%83%E6%98%AF%E4%B8%80%E4%B8%AAfor%E5%BE%AA%E7%8E%AF%EF%BC%8C%E5%AE%83%E5%B0%86Block%E9%87%8C%E7%9A%84%E6%89%80%E6%9C%89tx%E9%80%90%E4%B8%AA%E9%81%8D%E5%8E%86%E6%89%A7%E8%A1%8C%E3%80%82%0A%09%2F%2F+%E5%85%B7%E4%BD%93%E7%9A%84%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0%E5%8F%ABApplyTransaction%28%29%EF%BC%8C%E5%AE%83%E6%AF%8F%E6%AC%A1%E6%89%A7%E8%A1%8Ctx%2C+%E4%BC%9A%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E6%94%B6%E6%8D%AE%28Receipt%29%E5%AF%B9%E8%B1%A1%E3%80%82%0A%09%2F%2F+Iterate+over+and+process+the+individual+transactions%E8%BF%AD%E4%BB%A3%E5%B9%B6%E5%A4%84%E7%90%86%E4%B8%AA%E4%BA%BA%E4%BA%A4%E6%98%93%0A%09for+i%2C+tx+%3A%3D+range+block.Transactions%28%29+%7B%0A%09%09statedb.Prepare%28tx.Hash%28%29%2C+block.Hash%28%29%2C+i%29%2F%2F%E8%AE%BE%E7%BD%AEtransaction+hash+%E5%92%8Cblock+hash%E5%BD%93%E5%89%8D%E7%9A%84%E4%BA%A4%E6%98%93%E7%9A%84index%0A%09%09receipt%2C+_%2C+err+%3A%3D+ApplyTransaction%28p.config%2C+p.bc%2C+nil%2C+gp%2C+statedb%2C+header%2C+tx%2C+usedGas%2C+cfg%29%0A%09%09if+err+%21%3D+nil+%7B%0A%09%09%09return+nil%2C+nil%2C+0%2C+err%0A%09%09%7D%0A%09%09receipts+%3D+append%28receipts%2C+receipt%29%0A%09%09allLogs+%3D+append%28allLogs%2C+receipt.Logs...%29%0A%09%7D%2F%2F%E5%AE%8C%E6%88%90%E5%9D%97%EF%BC%8C%E5%BA%94%E7%94%A8%E4%BB%BB%E4%BD%95%E5%BC%95%E6%93%8E%E7%89%B9%E5%AE%9A%E7%9A%84%E9%A2%9D%E5%A4%96%E7%89%B9%E6%80%A7%EF%BC%88%E4%BE%8B%E5%A6%82%E5%9D%97%E5%A5%96%E5%8A%B1%EF%BC%89%0A%09%2F%2F+Finalize+the+block%2C+applying+any+consensus+engine+specific+extras+%28e.g.+block+rewards%29%0A%09p.engine.Finalize%28p.bc%2C+header%2C+statedb%2C+block.Transactions%28%29%2C+block.Uncles%28%29%2C+receipts%29%0A%09%2F%2F+%E8%BF%94%E5%9B%9E%E6%94%B6%E6%8D%AE+%E6%97%A5%E5%BF%97+%E6%80%BB%E7%9A%84Gas%E4%BD%BF%E7%94%A8%E9%87%8F%E5%92%8Cnil%0A%09return+receipts%2C+allLogs%2C+*usedGas%2C+nil%0A%7D%0A%2F%2FApplyTransaction%28%29%E9%A6%96%E5%85%88%E6%A0%B9%E6%8D%AE%E8%BE%93%E5%85%A5%E5%8F%82%E6%95%B0%E5%88%86%E5%88%AB%E5%B0%81%E8%A3%85%E5%87%BA%E4%B8%80%E4%B8%AAMessage%E5%AF%B9%E8%B1%A1%E5%92%8C%E4%B8%80%E4%B8%AAEVM%E5%AF%B9%E8%B1%A1%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8A%A0%E4%B8%8A%E4%B8%80%E4%B8%AA%E4%BC%A0%E5%85%A5%E7%9A%84GasPool%E7%B1%BB%E5%9E%8B%E5%8F%98%E9%87%8F%EF%BC%8C%E7%94%B1TransitionDb%28%29%E5%87%BD%E6%95%B0%E5%AE%8C%E6%88%90tx%E7%9A%84%E6%89%A7%E8%A1%8C%EF%BC%8C%0A%2F%2F+%E5%BE%85TransitionDb%28%29%E8%BF%94%E5%9B%9E%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%94%B6%E6%8D%AEReceipt%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%9C%80%E5%90%8E%E8%BF%94%E5%9B%9E%E8%AF%A5Recetip%E5%AF%B9%E8%B1%A1%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%95%B4%E4%B8%AAtx%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E6%89%80%E6%B6%88%E8%80%97Gas%E6%95%B0%E9%87%8F%E3%80%82%0A%2F%2F+ApplyTransaction+attempts+to+apply+a+transaction+to+the+given+state+database%0A%2F%2F+and+uses+the+input+parameters+for+its+environment.+It+returns+the+receipt%0A%2F%2F+for+the+transaction%2C+gas+used+and+an+error+if+the+transaction+failed%2C%0A%2F%2F+indicating+the+block+was+invalid.%0A%2F%2FApplyTransaction%E5%B0%9D%E8%AF%95%E5%B0%86%E4%BA%A4%E6%98%93%E5%BA%94%E7%94%A8%E4%BA%8E%E7%BB%99%E5%AE%9A%E7%9A%84%E7%8A%B6%E6%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E5%85%B6%E7%8E%AF%E5%A2%83%E7%9A%84%E8%BE%93%E5%85%A5%E5%8F%82%E6%95%B0%E3%80%82%0A%2F%2F%E5%AE%83%E8%BF%94%E5%9B%9E%E4%BA%A4%E6%98%93%E7%9A%84%E6%94%B6%E6%8D%AE%EF%BC%8C%E4%BD%BF%E7%94%A8%E7%9A%84Gas%E5%92%8C%E9%94%99%E8%AF%AF%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%BA%A4%E6%98%93%E5%A4%B1%E8%B4%A5%EF%BC%8C%E8%A1%A8%E6%98%8E%E5%9D%97%E6%98%AF%E6%97%A0%E6%95%88%E7%9A%84%E3%80%82%0A%0Afunc+ApplyTransaction%28config+*params.ChainConfig%2C+bc+*BlockChain%2C+author+*common.Address%2C+gp+*GasPool%2C+statedb+*state.StateDB%2C+header+*types.Header%2C+tx+*types.Transaction%2C+usedGas+*uint64%2C+cfg+vm.Config%29+%28*types.Receipt%2C+uint64%2C+error%29+%7B%0A%09%2F%2F+%E6%8A%8A%E4%BA%A4%E6%98%93%E8%BD%AC%E6%8D%A2%E6%88%90Message%0A%09%2F%2F+%E8%BF%99%E9%87%8C%E5%A6%82%E4%BD%95%E9%AA%8C%E8%AF%81%E6%B6%88%E6%81%AF%E7%A1%AE%E5%AE%9E%E6%98%AFSender%E5%8F%91%E9%80%81%E7%9A%84%E3%80%82+TODO%0A%09%2F%2F+1Message%E7%94%B1%E6%AD%A4%E6%AC%A1%E5%BE%85%E6%89%A7%E8%A1%8C%E7%9A%84tx%E5%AF%B9%E8%B1%A1%E8%BD%AC%E5%8C%96%E8%80%8C%E6%9D%A5%EF%BC%8C%E5%B9%B6%E6%90%BA%E5%B8%A6%E4%BA%86%E8%A7%A3%E6%9E%90%E5%87%BA%E7%9A%84tx%E7%9A%84%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%87%BA%E6%96%B9%E5%9C%B0%E5%9D%80%EF%BC%8C%E5%B1%9E%E4%BA%8E%E5%BE%85%E5%A4%84%E7%90%86%E7%9A%84%E6%95%B0%E6%8D%AE%E5%AF%B9%E8%B1%A1%0A%09msg%2C+err+%3A%3D+tx.AsMessage%28types.MakeSigner%28config%2C+header.Number%29%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+0%2C+err%0A%09%7D%0A%09%2F%2F+Create+a+new+context+to+be+used+in+the+EVM+environment%0A%09%2F%2F+%E6%AF%8F%E4%B8%80%E4%B8%AA%E4%BA%A4%E6%98%93%E9%83%BD%E5%88%9B%E5%BB%BA%E4%BA%86%E6%96%B0%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%8E%AF%E5%A2%83%E3%80%82%0A%09context+%3A%3D+NewEVMContext%28msg%2C+header%2C+bc%2C+author%29%0A%09%2F%2F%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E7%8E%AF%E5%A2%83%EF%BC%8C%E5%AE%83%E5%8C%85%E5%90%AB%E6%9C%89%E5%85%B3%E4%BA%8B%E5%8A%A1%E5%92%8C%E8%B0%83%E7%94%A8%E6%9C%BA%E5%88%B6%E7%9A%84%E6%89%80%E6%9C%89%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E3%80%82%0A%09%2F%2F+Create+a+new+environment+which+holds+all+relevant+information%0A%09%2F%2F+about+the+transaction+and+calling+mechanisms.%0A%09%2F%2FEVM+%E4%BD%9C%E4%B8%BAEthereum%E4%B8%96%E7%95%8C%E9%87%8C%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%28Virtual+Machine%29%EF%BC%8C%E4%BD%9C%E4%B8%BA%E6%AD%A4%E6%AC%A1tx%E7%9A%84%E5%AE%9E%E9%99%85%E6%89%A7%E8%A1%8C%E8%80%85%EF%BC%8C%E5%AE%8C%E6%88%90%E8%BD%AC%E5%B8%90%E5%92%8C%E5%90%88%E7%BA%A6%28Contract%29%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C%E3%80%82%0A%09vmenv+%3A%3D+vm.NewEVM%28context%2C+statedb%2C+config%2C+cfg%29%0A%09%2F%2F%E5%B0%86%E4%BA%A4%E6%98%93%E5%BA%94%E7%94%A8%E5%88%B0%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81%EF%BC%88%E5%8C%85%E5%90%AB%E5%9C%A8env%E4%B8%AD%EF%BC%89%0A%09%2F%2F+Apply+the+transaction+to+the+current+state+%28included+in+the+env%29%0A%09_%2C+gas%2C+failed%2C+err+%3A%3D+ApplyMessage%28vmenv%2C+msg%2C+gp%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+0%2C+err%0A%09%7D%0A%09%2F%2F+Update+the+state+with+pending+changes%0A%09%2F%2F+%E6%B1%82%E5%BE%97%E4%B8%AD%E9%97%B4%E7%8A%B6%E6%80%81%0A%09var+root+%5B%5Dbyte%0A%09if+config.IsByzantium%28header.Number%29+%7B%0A%09%09statedb.Finalise%28true%29%0A%09%7D+else+%7B%0A%09%09root+%3D+statedb.IntermediateRoot%28config.IsEIP158%28header.Number%29%29.Bytes%28%29%0A%09%7D%0A%09*usedGas+%2B%3D+gas%0A%0A%09%2F%2F+Create+a+new+receipt+for+the+transaction%2C+storing+the+intermediate+root+and+gas+used+by+the+tx%0A%09%2F%2F+based+on+the+eip+phase%2C+we%27re+passing+wether+the+root+touch-delete+accounts.%0A%09%2F%2F+%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%94%B6%E6%8D%AE%2C+%E7%94%A8%E6%9D%A5%E5%AD%98%E5%82%A8%E4%B8%AD%E9%97%B4%E7%8A%B6%E6%80%81%E7%9A%84root%2C+%E4%BB%A5%E5%8F%8A%E4%BA%A4%E6%98%93%E4%BD%BF%E7%94%A8%E7%9A%84gas%0A%09receipt+%3A%3D+types.NewReceipt%28root%2C+failed%2C+*usedGas%29%0A%09receipt.TxHash+%3D+tx.Hash%28%29%0A%09receipt.GasUsed+%3D+gas%0A%09%2F%2F+if+the+transaction+created+a+contract%2C+store+the+creation+address+in+the+receipt.%0A%09%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E5%88%9B%E5%BB%BA%E5%90%88%E7%BA%A6%E7%9A%84%E4%BA%A4%E6%98%93.%E9%82%A3%E4%B9%88%E6%88%91%E4%BB%AC%E6%8A%8A%E5%88%9B%E5%BB%BA%E5%9C%B0%E5%9D%80%E5%AD%98%E5%82%A8%E5%88%B0%E6%94%B6%E6%8D%AE%E9%87%8C%E9%9D%A2.%0A%09if+msg.To%28%29+%3D%3D+nil+%7B%0A%09receipt.ContractAddress+%3D+crypto.CreateAddress%28vmenv.Context.Origin%2C+tx.Nonce%28%29%29%0A%7D%0A%09%2F%2F+Set+the+receipt+logs+and+create+a+bloom+for+filtering%0A%09%2F%2F+%E6%8B%BF%E5%88%B0%E6%89%80%E6%9C%89%E7%9A%84%E6%97%A5%E5%BF%97%E5%B9%B6%E5%88%9B%E5%BB%BA%E6%97%A5%E5%BF%97%E7%9A%84%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8.%0A%09receipt.Logs+%3D+statedb.GetLogs%28tx.Hash%28%29%29%0A%09receipt.Bloom+%3D+types.CreateBloom%28types.Receipts%7Breceipt%7D%29%0A%0A%09return+receipt%2C+gas%2C+err%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cbr%3E%0A++%3Cpre%3E%3Ccode+class%3D%22language-plain%22%3E%2F%2F+Copyright+2014+The+go-ethereum+Authors%0A%2F%2F+This+file+is+part+of+the+go-ethereum+library.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+free+software%3A+you+can+redistribute+it+and%2For+modify%0A%2F%2F+it+under+the+terms+of+the+GNU+Lesser+General+Public+License+as+published+by%0A%2F%2F+the+Free+Software+Foundation%2C+either+version+3+of+the+License%2C+or%0A%2F%2F+%28at+your+option%29+any+later+version.%0A%2F%2F%0A%2F%2F+The+go-ethereum+library+is+distributed+in+the+hope+that+it+will+be+useful%2C%0A%2F%2F+but+WITHOUT+ANY+WARRANTY%3B+without+even+the+implied+warranty+of%0A%2F%2F+MERCHANTABILITY+or+FITNESS+FOR+A+PARTICULAR+PURPOSE.+See+the%0A%2F%2F+GNU+Lesser+General+Public+License+for+more+details.%0A%2F%2F%0A%2F%2F+You+should+have+received+a+copy+of+the+GNU+Lesser+General+Public+License%0A%2F%2F+along+with+the+go-ethereum+library.+If+not%2C+see+%26lt%3Bhttp%3A%2F%2Fwww.gnu.org%2Flicenses%2F%26gt%3B.%0A%0Apackage+core%0A%0Aimport+%28%0A%09%22errors%22%0A%09%22math%22%0A%09%22math%2Fbig%22%0A%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcommon%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fcore%2Fvm%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Flog%22%0A%09%22github.com%2Fethereum%2Fgo-ethereum%2Fparams%22%0A%29%0A%0Avar+%28%0A%09errInsufficientBalanceForGas+%3D+errors.New%28%22insufficient+balance+to+pay+for+gas%22%29%0A%29%0A%0A%2F*%0AThe+State+Transitioning+Model%0A%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E6%A8%A1%E5%9E%8B%0AA+state+transition+is+a+change+made+when+a+transaction+is+applied+to+the+current+world+state%0A%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2+%E6%98%AF%E6%8C%87%E7%94%A8%E5%BD%93%E5%89%8D%E7%9A%84world+state%E6%9D%A5%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%EF%BC%8C%E5%B9%B6%E6%94%B9%E5%8F%98%E5%BD%93%E5%89%8D%E7%9A%84world+state%0AThe+state+transitioning+model+does+all+all+the+necessary+work+to+work+out+a+valid+new+state+root.%0A%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%81%9A%E4%BA%86%E6%89%80%E6%9C%89%E6%89%80%E9%9C%80%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%9D%A5%E4%BA%A7%E7%94%9F%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E6%9C%89%E6%95%88%E7%9A%84state+root%0A1%29+Nonce+handling++Nonce+%E5%A4%84%E7%90%86%0A2%29+Pre+pay+gas+++++%E9%A2%84%E5%85%88%E6%94%AF%E4%BB%98Gas%0A3%29+Create+a+new+state+object+if+the+recipient+is+%5C0*32+%E5%A6%82%E6%9E%9C%E6%8E%A5%E6%94%B6%E4%BA%BA%E6%98%AF%E7%A9%BA%EF%BC%8C%E9%82%A3%E4%B9%88%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84state+object%0A4%29+Value+transfer++%E8%BD%AC%E8%B4%A6%0A%3D%3D+If+contract+creation+%3D%3D%0A++4a%29+Attempt+to+run+transaction+data+%E5%B0%9D%E8%AF%95%E8%BF%90%E8%A1%8C%E8%BE%93%E5%85%A5%E7%9A%84%E6%95%B0%E6%8D%AE%0A++4b%29+If+valid%2C+use+result+as+code+for+the+new+state+object+%E5%A6%82%E6%9E%9C%E6%9C%89%E6%95%88%EF%BC%8C%E9%82%A3%E4%B9%88%E7%94%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%BB%93%E6%9E%9C%E4%BD%9C%E4%B8%BA%E6%96%B0%E7%9A%84state+object%E7%9A%84code%0A%3D%3D+end+%3D%3D%0A5%29+Run+Script+section+%E8%BF%90%E8%A1%8C%E8%84%9A%E6%9C%AC%E9%83%A8%E5%88%86%0A6%29+Derive+new+state+root+%E5%AF%BC%E5%87%BA%E6%96%B0%E7%9A%84state+root%0A*%2F%0Atype+StateTransition+struct+%7B%0A%09gp+++++++++*GasPool+++%2F%2F%E7%94%A8%E6%9D%A5%E8%BF%BD%E8%B8%AA%E5%8C%BA%E5%9D%97%E5%86%85%E9%83%A8%E7%9A%84Gas%E7%9A%84%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5%0A%09msg++++++++Message%09%09%2F%2F+Message+Call%0A%09gas++++++++uint64%2F%2Fgas%E8%A1%A8%E7%A4%BA%E5%8D%B3%E6%97%B6%E5%8F%AF%E7%94%A8Gas%E6%95%B0%E9%87%8F%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%80%BC%E5%9D%87%E4%B8%BA0%0A%09gasPrice+++*big.Int%09%09%2F%2F+gas%E7%9A%84%E4%BB%B7%E6%A0%BC%0A%09initialGas+*big.Int%09%09%2F%2F+%E6%9C%80%E5%BC%80%E5%A7%8B%E7%9A%84gas%E5%88%9D%E5%A7%8B%E5%80%BC%E5%9D%87%E4%B8%BA0%0A%09value++++++*big.Int%09%09%2F%2F+%E8%BD%AC%E8%B4%A6%E7%9A%84%E5%80%BC%0A%09data+++++++%5B%5Dbyte%09%09%2F%2F+%E8%BE%93%E5%85%A5%E6%95%B0%E6%8D%AE%0A%09state++++++vm.StateDB%09%2F%2F+StateDB%0A%09evm++++++++*vm.EVM%09%09%2F%2F+%E8%99%9A%E6%8B%9F%E6%9C%BA%0A%7D%0A%0A%2F%2F+Message+represents+a+message+sent+to+a+contract.%0Atype+Message+interface+%7B%0A%09From%28%29+common.Address%0A%09%2F%2FFromFrontier%28%29+%28common.Address%2C+error%29%0A%09To%28%29+*common.Address%0A%0A%09GasPrice%28%29+*big.Int%0A%09Gas%28%29+uint64%0A%09Value%28%29+*big.Int%0A%0A%09Nonce%28%29+uint64%0A%09CheckNonce%28%29+bool%0A%09Data%28%29+%5B%5Dbyte%0A%7D%0A%2F%2F%E5%85%B3%E4%BA%8Eg0%E7%9A%84%E8%AE%A1%E7%AE%97%EF%BC%8C%E5%9C%A8%E9%BB%84%E7%9A%AE%E4%B9%A6%E4%B8%8A%E7%94%B1%E8%AF%A6%E7%BB%86%E7%9A%84%E4%BB%8B%E7%BB%8D+%E5%92%8C%E9%BB%84%E7%9A%AE%E4%B9%A6%E6%9C%89%E4%B8%80%E5%AE%9A%E5%87%BA%E5%85%A5%E7%9A%84%E9%83%A8%E5%88%86%E5%9C%A8%E4%BA%8Eif+contractCreation+%26amp%3B%26amp%3B+homestead%0A%2F%2F+%7Bigas.SetUint64%28params.TxGasContractCreation%29+%E8%BF%99%E6%98%AF%E5%9B%A0%E4%B8%BA+Gtxcreate%2BGtransaction+%3D+TxGasContractCreation%0A%2F%2F+IntrinsicGas+computes+the+%27intrinsic+gas%27+for+a+message+with+the+given+data.%0Afunc+IntrinsicGas%28data+%5B%5Dbyte%2C+contractCreation%2C+homestead+bool%29+%28uint64%2C+error%29+%7B%0A%09%2F%2F+Set+the+starting+gas+for+the+raw+transaction%0A%09var+gas+uint64%0A%09if+contractCreation+%26amp%3B%26amp%3B+homestead+%7B%0A%09%09gas+%3D+params.TxGasContractCreation%0A%09%7D+else+%7B%0A%09%09gas+%3D+params.TxGas%0A%09%7D%0A%09%2F%2F%E9%80%9A%E8%BF%87%E4%BA%A4%E6%98%93%E6%95%B0%E6%8D%AE%E9%87%8F%E6%9D%A5%E6%8F%90%E5%8F%96%E6%89%80%E9%9C%80%E7%9A%84%E6%B0%94%E4%BD%93%0A%09%2F%2F+Bump+the+required+gas+by+the+amount+of+transactional+data%0A%09if+len%28data%29+%26gt%3B+0+%7B%0A%09%09%2F%2F+Zero+and+non-zero+bytes+are+priced+differently%0A%09%09%2F%2F%E9%9B%B6%E5%92%8C%E9%9D%9E%E9%9B%B6%E5%AD%97%E8%8A%82%E7%9A%84%E4%BB%B7%E6%A0%BC%E4%B8%8D%E5%90%8C%0A%09%09var+nz+uint64%0A%09%09for+_%2C+byt+%3A%3D+range+data+%7B%0A%09%09%09if+byt+%21%3D+0+%7B%0A%09%09%09%09nz%2B%2B%0A%09%09%09%7D%0A%09%09%7D%0A%09%09%2F%2F+Make+sure+we+don%27t+exceed+uint64+for+all+data+combinations%0A%09%09%2F%2F%E7%A1%AE%E4%BF%9D%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E7%BB%84%E5%90%88%E9%83%BD%E4%B8%8D%E8%B6%85%E8%BF%87uint64%0A%09%09if+%28math.MaxUint64-gas%29%2Fparams.TxDataNonZeroGas+%26lt%3B+nz+%7B%0A%09%09%09return+0%2C+vm.ErrOutOfGas%0A%09%09%7D%0A%09%09gas+%2B%3D+nz+*+params.TxDataNonZeroGas%0A%0A%09%09z+%3A%3D+uint64%28len%28data%29%29+-+nz%0A%09%09if+%28math.MaxUint64-gas%29%2Fparams.TxDataZeroGas+%26lt%3B+z+%7B%0A%09%09%09return+0%2C+vm.ErrOutOfGas%0A%09%09%7D%0A%09%09gas+%2B%3D+z+*+params.TxDataZeroGas%0A%09%7D%0A%09return+gas%2C+nil%0A%7D%0A+%2F%2F+New+State+Transition+initialises+and+returns+a+new+state+transition+object.%0A%2F%2F+NewStateTransition%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B9%B6%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%AF%B9%E8%B1%A1%E3%80%82%0A%2F%2F+NewStateTransition+initialises+and+returns+a+new+state+transition+object.%0Afunc+NewStateTransition%28evm+*vm.EVM%2C+msg+Message%2C+gp+*GasPool%29+*StateTransition+%7B%0A%09return+%26amp%3BStateTransition%7B%0A%09%09gp%3A+++++++gp%2C%0A%09%09evm%3A++++++evm%2C%0A%09%09msg%3A++++++msg%2C%0A%09%09gasPrice%3A+msg.GasPrice%28%29%2C%0A%09%09value%3A++++msg.Value%28%29%2C%0A%09%09data%3A+++++msg.Data%28%29%2C%0A%09%09state%3A++++evm.StateDB%2C%0A%09%7D%0A%7D%0A%0A%2F%2F+ApplyMessage+computes+the+new+state+by+applying+the+given+message%0A%2F%2F+against+the+old+state+within+the+environment.%0A%2F%2F+ApplyMessage+%E9%80%9A%E8%BF%87%E5%BA%94%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84Message+%E5%92%8C%E7%8A%B6%E6%80%81%E6%9D%A5%E7%94%9F%E6%88%90%E6%96%B0%E7%9A%84%E7%8A%B6%E6%80%81%0A%2F%2F+ApplyMessage+returns+the+bytes+returned+by+any+EVM+execution+%28if+it+took+place%29%2C%0A%2F%2F+the+gas+used+%28which+includes+gas+refunds%29+and+an+error+if+it+failed.+An+error+always%0A%2F%2F+indicates+a+core+error+meaning+that+the+message+would+always+fail+for+that+particular%0A%2F%2F+state+and+would+never+be+accepted+within+a+block.%0A%2F%2F+ApplyMessage%E8%BF%94%E5%9B%9E%E7%94%B1%E4%BB%BB%E4%BD%95EVM%E6%89%A7%E8%A1%8C%EF%BC%88%E5%A6%82%E6%9E%9C%E5%8F%91%E7%94%9F%EF%BC%89%E8%BF%94%E5%9B%9E%E7%9A%84%E5%AD%97%E8%8A%82%EF%BC%8C%0A%2F%2F+%E4%BD%BF%E7%94%A8%E7%9A%84Gas%EF%BC%88%E5%8C%85%E6%8B%ACGas%E9%80%80%E6%AC%BE%EF%BC%89%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%A4%B1%E8%B4%A5%E5%88%99%E8%BF%94%E5%9B%9E%E9%94%99%E8%AF%AF%E3%80%82+%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E6%80%BB%E6%98%AF%E8%A1%A8%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%A0%B8%E5%BF%83%E9%94%99%E8%AF%AF%EF%BC%8C%0A%2F%2F+%E6%84%8F%E5%91%B3%E7%9D%80%E8%BF%99%E4%B8%AA%E6%B6%88%E6%81%AF%E5%AF%B9%E4%BA%8E%E8%BF%99%E4%B8%AA%E7%89%B9%E5%AE%9A%E7%9A%84%E7%8A%B6%E6%80%81%E5%B0%86%E6%80%BB%E6%98%AF%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%B9%B6%E4%B8%94%E6%B0%B8%E8%BF%9C%E4%B8%8D%E4%BC%9A%E5%9C%A8%E4%B8%80%E4%B8%AA%E5%9D%97%E4%B8%AD%E8%A2%AB%E6%8E%A5%E5%8F%97%E3%80%82%0Afunc+ApplyMessage%28evm+*vm.EVM%2C+msg+Message%2C+gp+*GasPool%29+%28%5B%5Dbyte%2C+uint64%2C+bool%2C+error%29+%7B%0A%09return+NewStateTransition%28evm%2C+msg%2C+gp%29.TransitionDb%28%29%0A%7D%0A%0Afunc+%28st+*StateTransition%29+from%28%29+vm.AccountRef+%7B%0A%09f+%3A%3D+st.msg.From%28%29%0A%09if+%21st.state.Exist%28f%29+%7B%0A%09%09st.state.CreateAccount%28f%29%0A%09%7D%0A%09return+vm.AccountRef%28f%29%0A%7D%0A%0Afunc+%28st+*StateTransition%29+to%28%29+vm.AccountRef+%7B%0A%09if+st.msg+%3D%3D+nil+%7B%0A%09%09return+vm.AccountRef%7B%7D%0A%09%7D%0A%09to+%3A%3D+st.msg.To%28%29%0A%09if+to+%3D%3D+nil+%7B%0A%09%09return+vm.AccountRef%7B%7D+%2F%2F+contract+creation%0A%09%7D%0A%0A%09reference+%3A%3D+vm.AccountRef%28*to%29%0A%09if+%21st.state.Exist%28*to%29+%7B%0A%09%09st.state.CreateAccount%28*to%29%0A%09%7D%0A%09return+reference%0A%7D%0A%0Afunc+%28st+*StateTransition%29+useGas%28amount+uint64%29+error+%7B%0A%09if+st.gas+%26lt%3B+amount+%7B%0A%09%09return+vm.ErrOutOfGas%0A%09%7D%0A%09st.gas+-%3D+amount%0A%0A%09return+nil%0A%7D%0A%2F%2FbuyGas%EF%BC%8C+%E5%AE%9E%E7%8E%B0Gas%E7%9A%84%E9%A2%84%E6%89%A3%E8%B4%B9%EF%BC%8C+%E9%A6%96%E5%85%88%E5%B0%B1%E6%89%A3%E9%99%A4%E4%BD%A0%E7%9A%84GasLimit+*+GasPrice%E7%9A%84%E9%92%B1%E3%80%82+%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E8%AE%A1%E7%AE%97%E5%AE%8C%E7%9A%84%E7%8A%B6%E6%80%81%E5%9C%A8%E9%80%80%E8%BF%98%E4%B8%80%E9%83%A8%E5%88%86%E3%80%82%0Afunc+%28st+*StateTransition%29+buyGas%28%29+error+%7B%0A%09var+%28%0A%09%09state++%3D+st.state%0A%09%09sender+%3D+st.from%28%29%0A%09%29%0A%09mgval+%3A%3D+new%28big.Int%29.Mul%28new%28big.Int%29.SetUint64%28st.msg.Gas%28%29%29%2C+st.gasPrice%29%0A%09if+state.GetBalance%28sender.Address%28%29%29.Cmp%28mgval%29+%26lt%3B+0+%7B%0A%09%09return+errInsufficientBalanceForGas%0A%09%7D%0A%09if+err+%3A%3D+st.gp.SubGas%28st.msg.Gas%28%29%29%3B+err+%21%3D+nil+%7B%2F%2F+%E4%BB%8E%E5%8C%BA%E5%9D%97%E7%9A%84gaspool%E9%87%8C%E9%9D%A2%E5%87%8F%E5%8E%BB%EF%BC%8C+%E5%9B%A0%E4%B8%BA%E5%8C%BA%E5%9D%97%E6%98%AF%E7%94%B1GasLimit%E9%99%90%E5%88%B6%E6%95%B4%E4%B8%AA%E5%8C%BA%E5%9D%97%E7%9A%84Gas%E4%BD%BF%E7%94%A8%E7%9A%84%E3%80%82%0A%09%09return+err%0A%09%7D%0A%09st.gas+%2B%3D+st.msg.Gas%28%29%0A%0A%09st.initialGas+%3D+st.msg.Gas%28%29%0A%0A%09state.SubBalance%28sender.Address%28%29%2C+mgval%29%0A%09%2F%2F+%E4%BB%8E%E8%B4%A6%E5%8F%B7%E9%87%8C%E9%9D%A2%E5%87%8F%E5%8E%BB+GasLimit+*+GasPrice%0A%09return+nil%0A%7D%0A%2F%2F%E6%89%A7%E8%A1%8C%E5%89%8D%E7%9A%84%E6%A3%80%E6%9F%A5%0Afunc+%28st+*StateTransition%29+preCheck%28%29+error+%7B%0A%09msg+%3A%3D+st.msg%0A%09sender+%3A%3D+st.from%28%29%0A%0A%09%2F%2F+Make+sure+this+transaction%27s+nonce+is+correct%0A%09if+msg.CheckNonce%28%29+%7B%0A%09%09nonce+%3A%3D+st.state.GetNonce%28sender.Address%28%29%29%0A%09%09%2F%2F+%E5%BD%93%E5%89%8D%E6%9C%AC%E5%9C%B0%E7%9A%84nonce+%E9%9C%80%E8%A6%81%E5%92%8C+msg%E7%9A%84Nonce%E4%B8%80%E6%A0%B7+%E4%B8%8D%E7%84%B6%E5%B0%B1%E6%98%AF%E7%8A%B6%E6%80%81%E4%B8%8D%E5%90%8C%E6%AD%A5%E4%BA%86%E3%80%82%0A%09%09if+nonce+%26lt%3B+msg.Nonce%28%29+%7B%0A%09%09%09return+ErrNonceTooHigh%0A%09%09%7D+else+if+nonce+%26gt%3B+msg.Nonce%28%29+%7B%0A%09%09%09return+ErrNonceTooLow%0A%09%09%7D%0A%09%7D%0A%09return+st.buyGas%28%29%0A%7D%0A%2F%2F+TransitionDb%E5%B0%86%E9%80%9A%E8%BF%87%E5%BA%94%E7%94%A8%E5%BD%93%E5%89%8D%E6%B6%88%E6%81%AF%E5%B9%B6%E8%BF%94%E5%9B%9E%E5%8C%85%E5%90%AB%E4%BD%BF%E7%94%A8%E8%BF%87%E7%9A%84%E6%B0%94%E4%BD%93%E7%9A%84%E7%BB%93%E6%9E%9C%E6%9D%A5%E8%BD%AC%E6%8D%A2%E7%8A%B6%E6%80%81%E3%80%82+%E5%A6%82%E6%9E%9C%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%AE%83%E4%BC%9A%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E9%94%99%E8%AF%AF%E3%80%82+%E9%94%99%E8%AF%AF%E8%A1%A8%E7%A4%BA%E5%85%B1%E8%AF%86%E9%97%AE%E9%A2%98%E3%80%82%0A%2F%2F+TransitionDb+will+transition+the+state+by+applying+the+current+message+and%0A%2F%2F+returning+the+result+including+the+the+used+gas.+It+returns+an+error+if+it%0A%2F%2F+failed.+An+error+indicates+a+consensus+issue.%0Afunc+%28st+*StateTransition%29+TransitionDb%28%29+%28ret+%5B%5Dbyte%2C+usedGas+uint64%2C+failed+bool%2C+err+error%29+%7B%0A%09if+err+%3D+st.preCheck%28%29%3B+err+%21%3D+nil+%7B%2F%2F%E8%B4%AD%E4%B9%B0Gas%E3%80%82%E9%A6%96%E5%85%88%E4%BB%8E%E4%BA%A4%E6%98%93%E7%9A%84%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%87%BA%E6%96%B9%E8%B4%A6%E6%88%B7%E6%89%A3%E9%99%A4%E4%B8%80%E7%AC%94Ether%EF%BC%8C%E8%B4%B9%E7%94%A8%E7%AD%89%E4%BA%8Etx.data.GasLimit+*+tx.data.Price%EF%BC%9B%0A%09%2F%2F+%E5%90%8C%E6%97%B6+st.initialGas+%3D+st.gas+%3D+tx.data.GasLimit%EF%BC%9B%E7%84%B6%E5%90%8E%28GasPool%29+gp+-%3D+st.gas%E3%80%82%0A%09%09return%0A%09%7D%0A%09msg+%3A%3D+st.msg%0A%09sender+%3A%3D+st.from%28%29+%2F%2F+err+checked+in+preCheck%E5%9C%A8%E6%A3%80%E6%9F%A5%E5%89%8D%E6%A3%80%E6%9F%A5%E9%94%99%E8%AF%AF%0A%0A%09homestead+%3A%3D+st.evm.ChainConfig%28%29.IsHomestead%28st.evm.BlockNumber%29%0A%09contractCreation+%3A%3D+msg.To%28%29+%3D%3D+nil+%2F%2F+%E5%A6%82%E6%9E%9Cmsg.To%E6%98%AFnil+%E9%82%A3%E4%B9%88%E8%AE%A4%E4%B8%BA%E6%98%AF%E4%B8%80%E4%B8%AA%E5%90%88%E7%BA%A6%E5%88%9B%E5%BB%BA%0A%09%2F%2F+%E8%AE%A1%E7%AE%97%E6%9C%80%E5%BC%80%E5%A7%8B%E7%9A%84Gas++g0%0A%09%2F%2F+Pay+intrinsic+gas%0A%09%2F%2F%E8%AE%A1%E7%AE%97tx%E7%9A%84%E5%9B%BA%E6%9C%89Gas%E6%B6%88%E8%80%97+-+intrinsicGas%E3%80%82%E5%AE%83%E5%88%86%E4%B8%BA%E4%B8%A4%E4%B8%AA%E9%83%A8%E5%88%86%EF%BC%8C%E6%AF%8F%E4%B8%80%E4%B8%AAtx%E9%A2%84%E8%AE%BE%E7%9A%84%E6%B6%88%E8%80%97%E9%87%8F%EF%BC%8C%E8%BF%99%E4%B8%AA%E6%B6%88%E8%80%97%E9%87%8F%E8%BF%98%E5%9B%A0tx%E6%98%AF%E5%90%A6%E5%90%AB%E6%9C%89%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%85%A5%E6%96%B9%E5%9C%B0%E5%9D%80%E8%80%8C%E7%95%A5%E6%9C%89%E4%B8%8D%E5%90%8C%EF%BC%9B%0A%09%2F%2F+%E4%BB%A5%E5%8F%8A%E9%92%88%E5%AF%B9tx.data.Payload%E7%9A%84Gas%E6%B6%88%E8%80%97%EF%BC%8CPayload%E7%B1%BB%E5%9E%8B%E6%98%AF%5B%5Dbyte%EF%BC%8C%E5%85%B3%E4%BA%8E%E5%AE%83%E7%9A%84%E5%9B%BA%E6%9C%89%E6%B6%88%E8%80%97%E4%BE%9D%E8%B5%96%E4%BA%8E%5B%5Dbyte%E4%B8%AD%E9%9D%9E0%E5%AD%97%E8%8A%82%E5%92%8C0%E5%AD%97%E8%8A%82%E7%9A%84%E9%95%BF%E5%BA%A6%E3%80%82%0A%09%2F%2F+%E6%9C%80%E7%BB%88%EF%BC%8Cst.gas+-%3D+intrinsicGas%0A%09gas%2C+err+%3A%3D+IntrinsicGas%28st.data%2C+contractCreation%2C+homestead%29%0A%09if+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+0%2C+false%2C+err%0A%09%7D%0A%09if+err+%3D+st.useGas%28gas%29%3B+err+%21%3D+nil+%7B%0A%09%09return+nil%2C+0%2C+false%2C+err%0A%09%7D%0A%0A%09var+%28%0A%09%09evm+%3D+st.evm%0A%09%09%2F%2F+vm%E9%94%99%E8%AF%AF%E4%B8%8D%E4%BC%9A%E5%BD%B1%E5%93%8D%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%8C%E5%9B%A0%E6%AD%A4%E4%B8%8D%E4%BC%9A%E5%88%86%E9%85%8D%E7%BB%99err%EF%BC%8C%E9%99%A4%E9%9D%9E%E5%B9%B3%E8%A1%A1%E9%94%99%E8%AF%AF%E4%B8%8D%E8%B6%B3%E3%80%82%0A%09%09%2F%2F+vm+errors+do+not+effect+consensus+and+are+therefor%0A%09%09%2F%2F+not+assigned+to+err%2C+except+for+insufficient+balance%0A%09%09%2F%2F+error.%0A%09%09vmerr+error%0A%09%29%0A%09%2F%2FEVM%E6%89%A7%E8%A1%8C%E3%80%82%E5%A6%82%E6%9E%9C%E4%BA%A4%E6%98%93%E7%9A%84%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%85%A5%E6%96%B9%E5%9C%B0%E5%9D%80%28tx.data.Recipient%29%E4%B8%BA%E7%A9%BA%EF%BC%8C%E8%B0%83%E7%94%A8EVM%E7%9A%84Create%28%29%E5%87%BD%E6%95%B0%EF%BC%9B%0A%09%2F%2F+%E5%90%A6%E5%88%99%EF%BC%8C%E8%B0%83%E7%94%A8Call%28%29%E5%87%BD%E6%95%B0%E3%80%82%E6%97%A0%E8%AE%BA%E5%93%AA%E4%B8%AA%E5%87%BD%E6%95%B0%E8%BF%94%E5%9B%9E%E5%90%8E%EF%BC%8C%E6%9B%B4%E6%96%B0st.gas%E3%80%82%0A%09if+contractCreation+%7B+%2F%2F%E5%A6%82%E6%9E%9C%E6%98%AF%E5%90%88%E7%BA%A6%E5%88%9B%E5%BB%BA%EF%BC%8C+%E9%82%A3%E4%B9%88%E8%B0%83%E7%94%A8evm%E7%9A%84Create%E6%96%B9%E6%B3%95%0A%09%09ret%2C+_%2C+st.gas%2C+vmerr+%3D+evm.Create%28sender%2C+st.data%2C+st.gas%2C+st.value%29%0A%09%7D+else+%7B%0A%09%09%2F%2F+%E5%A6%82%E6%9E%9C%E6%98%AF%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E3%80%82%E9%82%A3%E4%B9%88%E9%A6%96%E5%85%88%E8%AE%BE%E7%BD%AEsender%E7%9A%84nonce%E3%80%82%0A%09%09%2F%2F+Increment+the+nonce+for+the+next+transaction%0A%09%09st.state.SetNonce%28sender.Address%28%29%2C+st.state.GetNonce%28sender.Address%28%29%29%2B1%29%0A%09%09ret%2C+st.gas%2C+vmerr+%3D+evm.Call%28sender%2C+st.to%28%29.Address%28%29%2C+st.data%2C+st.gas%2C+st.value%29%0A%09%7D%0A%09if+vmerr+%21%3D+nil+%7B%0A%09%09log.Debug%28%22VM+returned+with+error%22%2C+%22err%22%2C+vmerr%29%0A%09%09%2F%2F%E5%94%AF%E4%B8%80%E5%8F%AF%E8%83%BD%E7%9A%84%E5%85%B1%E8%AF%86%E9%94%99%E8%AF%AF%E6%98%AF%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89%E8%B6%B3%E5%A4%9F%E7%9A%84%E4%BD%99%E9%A2%9D%E6%9D%A5%E5%AE%8C%E6%88%90%E8%BD%AC%E7%A7%BB%EF%BC%8C+%E7%AC%AC%E4%B8%80%E7%AC%94%E4%BD%99%E9%A2%9D%E8%BD%AC%E8%B4%A6%E5%8F%AF%E8%83%BD%E6%B0%B8%E8%BF%9C%E4%B8%8D%E4%BC%9A%E5%A4%B1%E8%B4%A5%E3%80%82%0A%09%09%2F%2F+The+only+possible+consensus-error+would+be+if+there+wasn%27t%0A%09%09%2F%2F+sufficient+balance+to+make+the+transfer+happen.+The+first%0A%09%09%2F%2F+balance+transfer+may+never+fail.%0A%09%09if+vmerr+%3D%3D+vm.ErrInsufficientBalance+%7B%0A%09%09%09return+nil%2C+0%2C+false%2C+vmerr%0A%09%09%7D%0A%09%7D%0A%09%2F%2Fnew%28big.Int%29.Set%28st.gasUsed%28%29%29++%E8%AE%A1%E7%AE%97%E8%A2%AB%E4%BD%BF%E7%94%A8%E7%9A%84Gas%E6%95%B0%E9%87%8F%0A%09%2F%2F4%E8%AE%A1%E7%AE%97%E6%9C%AC%E6%AC%A1%E6%89%A7%E8%A1%8C%E4%BA%A4%E6%98%93%E7%9A%84%E5%AE%9E%E9%99%85Gas%E6%B6%88%E8%80%97%EF%BC%9A+requiredGas+%3D+st.initialGas+-+st.gas%0A%09%2F%2F%E5%81%BF%E9%80%80Gas%E3%80%82%E5%AE%83%E5%8C%85%E6%8B%AC%E4%B8%A4%E4%B8%AA%E9%83%A8%E5%88%86%EF%BC%9A%E9%A6%96%E5%85%88%E5%B0%86%E5%89%A9%E4%BD%99st.gas+%E6%8A%98%E7%AE%97%E6%88%90Ether%EF%BC%8C%E5%BD%92%E8%BF%98%E7%BB%99%E4%BA%A4%E6%98%93%E7%9A%84%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%87%BA%E6%96%B9%E8%B4%A6%E6%88%B7%EF%BC%9B%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9F%BA%E4%BA%8E%E5%AE%9E%E9%99%85%E6%B6%88%E8%80%97%E9%87%8FrequiredGas%EF%BC%8C%0A%09%2F%2F+%E7%B3%BB%E7%BB%9F%E6%8F%90%E4%BE%9B%E4%B8%80%E5%AE%9A%E7%9A%84%E8%A1%A5%E5%81%BF%EF%BC%8C%E6%95%B0%E9%87%8F%E4%B8%BArefundGas%E3%80%82refundGas+%E6%89%80%E6%8A%98%E7%AE%97%E7%9A%84Ether%E4%BC%9A%E8%A2%AB%E7%AB%8B%E5%8D%B3%E5%8A%A0%E5%9C%A8%28%E8%BD%AC%E5%B8%90%29%E8%BD%AC%E5%87%BA%E6%96%B9%E8%B4%A6%E6%88%B7%E4%B8%8A%EF%BC%8C%0A%09%2F%2F+%E5%90%8C%E6%97%B6st.gas+%2B%3D+refundGas%EF%BC%8Cgp+%2B%3D+st.gas%EF%BC%8C%E5%8D%B3%E5%89%A9%E4%BD%99%E7%9A%84Gas%E5%8A%A0%E4%B8%8A%E7%B3%BB%E7%BB%9F%E8%A1%A5%E5%81%BF%E7%9A%84Gas%EF%BC%8C%E8%A2%AB%E4%B8%80%E8%B5%B7%E5%BD%92%E5%B9%B6%E8%BF%9BGasPool%EF%BC%8C%E4%BE%9B%E4%B9%8B%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%A7%E8%A1%8C%E4%BD%BF%E7%94%A8%E3%80%82%0A%09st.refundGas%28%29%2F%2F%E8%AE%A1%E7%AE%97Gas%E7%9A%84%E9%80%80%E8%B4%B9+%E4%BC%9A%E5%A2%9E%E5%8A%A0%E5%88%B0+st.gas%E4%B8%8A%E9%9D%A2%E3%80%82+%E6%89%80%E4%BB%A5%E7%9F%BF%E5%B7%A5%E6%8B%BF%E5%88%B0%E7%9A%84%E6%98%AF%E9%80%80%E7%A8%8E%E5%90%8E%E7%9A%84%0A%2F%2F6%E5%A5%96%E5%8A%B1%E6%89%80%E5%B1%9E%E5%8C%BA%E5%9D%97%E7%9A%84%E6%8C%96%E6%8E%98%E8%80%85%EF%BC%9A%E7%B3%BB%E7%BB%9F%E7%BB%99%E6%89%80%E5%B1%9E%E5%8C%BA%E5%9D%97%E7%9A%84%E4%BD%9C%E8%80%85%EF%BC%8C%E4%BA%A6%E5%8D%B3%E6%8C%96%E6%8E%98%E8%80%85%E8%B4%A6%E6%88%B7%EF%BC%8C%E5%A2%9E%E5%8A%A0%E4%B8%80%E7%AC%94%E9%87%91%E9%A2%9D%EF%BC%8C%E6%95%B0%E9%A2%9D%E7%AD%89%E4%BA%8E+st.data%2CPrice+*+%28st.initialGas+-+st.gas%29%E3%80%82%0A%2F%2F+%E6%B3%A8%E6%84%8F%EF%BC%8C%E8%BF%99%E9%87%8C%E7%9A%84st.gas%E5%9C%A8%E6%AD%A5%E9%AA%A45%E4%B8%AD%E8%A2%AB%E5%8A%A0%E4%B8%8A%E4%BA%86refundGas%2C+%E6%89%80%E4%BB%A5%E8%BF%99%E7%AC%94%E5%A5%96%E5%8A%B1%E9%87%91%E6%89%80%E5%AF%B9%E5%BA%94%E7%9A%84Gas%EF%BC%8C%E5%85%B6%E6%95%B0%E9%87%8F%E5%B0%8F%E4%BA%8E%E8%AF%A5%E4%BA%A4%E6%98%93%E5%AE%9E%E9%99%85%E6%B6%88%E8%80%97%E9%87%8FrequiredGas%E3%80%82%0A%09st.state.AddBalance%28st.evm.Coinbase%2C+new%28big.Int%29.Mul%28new%28big.Int%29.SetUint64%28st.gasUsed%28%29%29%2C+st.gasPrice%29%29%0A%09%2F%2Fst.state.AddBalance%28st.evm.Coinbase%2C+new%28big.Int%29.Mul%28st.gasUsed%28%29%2C+st.gasPrice%29%29+%2F%2F+%E7%BB%99%E7%9F%BF%E5%B7%A5%E5%A2%9E%E5%8A%A0%E6%94%B6%E5%85%A5%E3%80%82%0A%09%2F%2F+requiredGas%E5%92%8CgasUsed%E7%9A%84%E5%8C%BA%E5%88%AB%E4%B8%80%E4%B8%AA%E6%98%AF%E6%B2%A1%E6%9C%89%E9%80%80%E7%A8%8E%E7%9A%84%EF%BC%8C+%E4%B8%80%E4%B8%AA%E6%98%AF%E9%80%80%E7%A8%8E%E4%BA%86%E7%9A%84%E3%80%82%0A%09%2F%2F+%E7%9C%8B%E4%B8%8A%E9%9D%A2%E7%9A%84%E8%B0%83%E7%94%A8+ApplyMessage%E7%9B%B4%E6%8E%A5%E4%B8%A2%E5%BC%83%E4%BA%86requiredGas%2C+%E8%AF%B4%E6%98%8E%E8%BF%94%E5%9B%9E%E7%9A%84%E6%98%AF%E9%80%80%E7%A8%8E%E4%BA%86%E7%9A%84%E3%80%82%0A%09return+ret%2C+st.gasUsed%28%29%2C+vmerr+%21%3D+nil%2C+err%0A%7D%0A%2F%2F%E9%80%80%E7%A8%8E%EF%BC%8C%E9%80%80%E7%A8%8E%E6%98%AF%E4%B8%BA%E4%BA%86%E5%A5%96%E5%8A%B1%E5%A4%A7%E5%AE%B6%E8%BF%90%E8%A1%8C%E4%B8%80%E4%BA%9B%E8%83%BD%E5%A4%9F%E5%87%8F%E8%BD%BB%E5%8C%BA%E5%9D%97%E9%93%BE%E8%B4%9F%E6%8B%85%E7%9A%84%E6%8C%87%E4%BB%A4%EF%BC%8C+%E6%AF%94%E5%A6%82%E6%B8%85%E7%A9%BA%E8%B4%A6%E6%88%B7%E7%9A%84storage.+%E6%88%96%E8%80%85%E6%98%AF%E8%BF%90%E8%A1%8Csuicide%E5%91%BD%E4%BB%A4%E6%9D%A5%E6%B8%85%E7%A9%BA%E8%B4%A6%E5%8F%B7%E3%80%82%0Afunc+%28st+*StateTransition%29+refundGas%28%29+%7B%0A%09%2F%2F%E9%80%80%E7%A8%8E%E7%9A%84%E6%80%BB%E9%87%91%E9%A2%9D%E4%B8%8D%E4%BC%9A%E8%B6%85%E8%BF%87%E7%94%A8%E6%88%B7Gas%E6%80%BB%E4%BD%BF%E7%94%A8%E7%9A%841%2F2%E3%80%82%0A%09%2F%2F+Apply+refund+counter%2C+capped+to+half+of+the+used+gas.%0A%09refund+%3A%3D+st.gasUsed%28%29+%2F+2%0A%09if+refund+%26gt%3B+st.state.GetRefund%28%29+%7B%0A%09%09refund+%3D+st.state.GetRefund%28%29%0A%09%7D%0A%09st.gas+%2B%3D+refund%0A%09%2F%2F%E8%BF%94%E5%9B%9E%E5%89%A9%E4%BD%99%E6%B0%94%E4%BD%93%E7%9A%84ETH%EF%BC%8C%E4%BB%A5%E5%8E%9F%E5%A7%8B%E9%80%9F%E7%8E%87%E4%BA%A4%E6%8D%A2%E3%80%82%0A%09%2F%2F+Return+ETH+for+remaining+gas%2C+exchanged+at+the+original+rate.%0A%09sender+%3A%3D+st.from%28%29%0A%0A%09remaining+%3A%3D+new%28big.Int%29.Mul%28new%28big.Int%29.SetUint64%28st.gas%29%2C+st.gasPrice%29%0A%09%2F%2F+%E7%94%A8%E6%88%B7%E8%BF%98%E5%89%A9%E4%B8%8B%E7%9A%84Gas%E8%BF%98%E5%9B%9E%E5%8E%BB%E3%80%82%0A%09st.state.AddBalance%28sender.Address%28%29%2C+remaining%29%0A%0A%09%2F%2F+Also+return+remaining+gas+to+the+block+gas+counter+so+it+is%0A%09%2F%2F+available+for+the+next+transaction.%0A%09%2F%2F+%E5%90%8C%E6%97%B6%E4%B9%9F%E6%8A%8A%E9%80%80%E7%A8%8E%E7%9A%84%E9%92%B1%E8%BF%98%E7%BB%99gaspool%E7%BB%99%E4%B8%8B%E4%B8%AA%E4%BA%A4%E6%98%93%E8%85%BE%E7%82%B9Gas%E7%A9%BA%E9%97%B4%E3%80%82%0A%09st.gp.AddGas%28st.gas%29%0A%7D%0A%2F%2F+gasUsed%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E6%89%80%E7%94%A8%E7%9A%84%E6%B0%94%E4%BD%93%E9%87%8F%E3%80%82%0A%2F%2F+gasUsed+returns+the+amount+of+gas+used+up+by+the+state+transition.%0Afunc+%28st+*StateTransition%29+gasUsed%28%29+uint64+%7B%0A%09return+st.initialGas+-+st.gas%0A%7D%0A%3C%2Fcode%3E%3C%2Fpre%3E%0A++%3Cbr%3E%0A++%3Cp%3E%E6%9C%AC%E6%96%87%E7%AB%A0%E7%89%88%E6%9D%83%E5%BD%92xiaowenwe%40gmail.com%E6%89%80%E6%9C%89%EF%BC%8C%E8%8B%A5%E6%83%B3%E8%BD%AC%E8%BD%BD%E8%AF%B7%E8%81%94%E7%B3%BB%E4%BD%9C%E8%80%85%E6%8E%88%E6%9D%83%EF%BC%8C%E6%9C%AA%E7%BB%8F%E6%8E%88%E6%9D%83%EF%BC%8C%E7%A6%81%E6%AD%A2%E8%BD%AC%E8%BD%BD%EF%BC%8C%E5%A6%82%E8%8B%A5%E5%8F%91%E7%8E%B0%EF%BC%8C%E5%B0%86%E9%80%9A%E8%BF%87%E4%B8%AA%E4%BA%BA%E5%BE%8B%E5%B8%88%E4%BB%A5%E4%BE%B5%E7%8A%AF%E3%80%8A%E4%B8%AD%E5%8D%8E%E4%BA%BA%E6%B0%91%E5%85%B1%E5%92%8C%E5%9B%BD%E8%91%97%E4%BD%9C%E6%9D%83%E6%B3%95%E3%80%8B%E8%B5%B7%E8%AF%89%EF%BC%88%E5%A5%89%E9%99%AA%E5%88%B0%E5%BA%95%EF%BC%89%EF%BC%8C%E6%8E%88%E6%9D%83%E8%BD%AC%E8%BD%BD%E4%B9%9F%E8%AF%B7%E6%B3%A8%E6%98%8E%E5%8E%9F%E5%87%BA%E5%A4%84%E3%80%82%3Cbr%3E%3C%2Fp%3E%0A++%3Cp%3E%E8%B5%9E%E5%8A%A999%E5%85%83%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%BE%97miner%E5%8C%85%E5%AE%8C%E6%95%B4Xmind%EF%BC%8C%E8%B5%9E%E5%8A%A9199%E5%85%83%E5%8F%AF%E4%BB%A5%E8%8E%B7%E5%BE%97miner%E5%8C%85%E5%AE%8C%E6%95%B4%E7%BF%BB%E8%AF%91%E6%BA%90%E7%A0%81%EF%BC%8C%E6%AC%A2%E8%BF%8E%E7%95%99%E8%A8%80%E3%80%82%E6%8C%89%E7%95%99%E8%A8%80%E5%86%B3%E5%AE%9A%E5%88%86%E6%9E%90%E6%A8%A1%E5%9D%97%E9%A1%BA%E5%BA%8F%E3%80%82%3C%2Fp%3E%0A++%3Cimg+src%3D%22https%3A%2F%2Fimg-blog.csdn.net%2F20180504101629731%22+alt%3D%22%22%3E%0A++%3Cbr%3E%0A++%3Cbr%3E%0A++%3Cbr%3E%0A++%3Cp%3E%3Cbr%3E%3C%2Fp%3E+%0A+%3C%2Fdiv%3E+%0A%3C%2Fdiv%3E+%0A%3Cdiv+class%3D%22hide-article-box+text-center%22%3E+%0A+%3Ca+class%3D%22btn+btn-red-hollow%22+id%3D%22btn-readmore%22+data-track-view%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fqq_18252955%2Farticle%2Fdetails%2F80332891%2C%26quot%3B%7D%22+data-track-click%3D%22%7B%26quot%3Bmod%26quot%3B%3A%26quot%3Bpopu_376%26quot%3B%2C%26quot%3Bcon%26quot%3B%3A%26quot%3B%2Chttps%3A%2F%2Fblog.csdn.net%2Fqq_18252955%2Farticle%2Fdetails%2F80332891%2C%26quot%3B%7D%22%3E%E9%98%85%E8%AF%BB%E6%9B%B4%E5%A4%9A%3C%2Fa%3E+%0A%3C%2Fdiv%3E" | url_decode}}